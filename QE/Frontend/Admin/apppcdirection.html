<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Qwota App</title>

  <!-- üì± PWA Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Qwota">
  <meta name="msapplication-TileColor" content="#1f2937">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Icones PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

  <!-- Scripts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="icon" href="/favicon" type="image/x-icon" />

  <!-- Script commun -->
  <script src="/common.js"></script>

  <!-- Feuille de style principale - Theme Dark Organise -->
  <link rel="stylesheet" href="/base.css">

  <style>
    /* ================================================================
       SCROLLBARS PERSONNALISEES - Style discret et moderne
       ================================================================ */

    /* Scrollbar pour tous les √©l√©ments */
    * {
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.15) transparent;
    }

    /* Webkit scrollbar (Chrome, Safari, Edge) */
    *::-webkit-scrollbar {
      width: 3px;
      height: 3px;
    }

    *::-webkit-scrollbar-track {
      background: transparent;
    }

    *::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.15);
      border-radius: 0;
      transition: background 0.2s ease;
    }

    *::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.25);
    }

    /* Scrollbar pour les iframes */
    iframe::-webkit-scrollbar {
      width: 3px;
      height: 3px;
    }

    iframe::-webkit-scrollbar-track {
      background: transparent;
    }

    iframe::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.15);
      border-radius: 0;
      transition: background 0.2s ease;
    }

    iframe::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.25);
    }

    /* ================================================================
       MOBILE OPTIMIZATIONS - Comportement Safari iOS
       ================================================================ */

    /* D√©sactiver le comportement Safari iOS qui cache les barres */
    html {
      overflow: hidden;
      height: 100%;
      position: fixed;
      width: 100%;
    }

    /* Permettre les swipes horizontaux mais emp√™cher le zoom */
    * {
      touch-action: pan-y pinch-zoom !important;
    }

    html, body {
      touch-action: pan-y pinch-zoom !important;
      -webkit-touch-callout: none !important;
      -webkit-user-select: none !important;
      -khtml-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      user-select: none !important;
      -webkit-text-size-adjust: 100% !important;
      -moz-text-size-adjust: 100% !important;
      -ms-text-size-adjust: 100% !important;
      text-size-adjust: 100% !important;
    }

    /* Permettre tous les types de touch sur le conteneur principal pour le swipe */
    #app-content {
      touch-action: auto !important;
    }

    /* Permettre la s√©lection de texte dans les inputs et textarea seulement */
    input, textarea, select {
      -webkit-user-select: text !important;
      -khtml-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      user-select: text !important;
      touch-action: manipulation !important;
    }

    /* Emp√™cher le zoom sur double-tap pour boutons et liens */
    a, button {
      touch-action: manipulation !important;
    }

    /* Forcer les headers √† rester fixes sur iOS */
    @supports (-webkit-touch-callout: none) {
      .mobile-header-top,
      .mobile-header-bottom {
        position: fixed !important;
        -webkit-transform: translate3d(0, 0, 0);
        transform: translate3d(0, 0, 0);
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }

      .mobile-header-top {
        top: 0 !important;
      }

      /* Emp√™cher Safari de cacher la barre du bas */
      .mobile-header-bottom,
      .md\\:hidden.fixed.bottom-0 {
        bottom: 0 !important;
        position: fixed !important;
      }
    }

    /* Emp√™cher le zoom avec les gestes */
    @media (max-width: 768px) {
      html {
        -webkit-text-size-adjust: none !important;
        -moz-text-size-adjust: none !important;
        -ms-text-size-adjust: none !important;
        text-size-adjust: none !important;
      }

      body {
        -webkit-text-size-adjust: none !important;
        -moz-text-size-adjust: none !important;
        -ms-text-size-adjust: none !important;
        text-size-adjust: none !important;
        overflow-x: hidden !important;
      }
    }

    /* ================================================================
       LAYOUT PRINCIPAL - Architecture SPA
       ================================================================ */

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow: hidden;
      height: 100%;
      width: 100%;
      position: fixed;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: none;
      -webkit-overscroll-behavior: none;
    }

    /* Conteneur principal de l'app */
    #app-container {
      display: flex;
      min-height: 100vh;
    }

    /* ================================================================
       SIDEBAR - Style Qwota Lite (Copie exacte)
       ================================================================ */

    /* SIDEBAR */
    .sidebar {
      width: 80px;
      background: rgba(20, 30, 50, 0.95);
      border-right: 1px solid rgba(96, 165, 250, 0.2);
      display: flex;
      flex-direction: column;
      transition: width 0.25s ease;
      overflow: hidden;
      z-index: 10000;
      position: fixed;
      top: 90px;
      left: 0;
      height: calc(100vh - 90px);
      box-shadow: 4px 0 24px rgba(0, 0, 0, 0.3);
    }

    .sidebar.expanded {
      width: 260px;
    }

    /* Toggle button */
    .sidebar-toggle {
      width: 100%;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.4);
      border: none;
      color: #94a3b8;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 1px solid rgba(51, 65, 85, 0.4);
      flex-shrink: 0;
      position: relative;
    }

    .sidebar-toggle:hover {
      background: rgba(96, 165, 250, 0.12);
      color: #60a5fa;
      box-shadow: 0 2px 8px rgba(96, 165, 250, 0.15);
    }

    .sidebar-toggle i {
      font-size: 18px;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .sidebar.expanded .sidebar-toggle i {
      transform: rotate(180deg);
    }

    .sidebar-toggle::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%) scaleX(0);
      width: 80%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #60a5fa, transparent);
      transition: transform 0.3s ease;
    }

    .sidebar-toggle:hover::before {
      transform: translateX(-50%) scaleX(1);
    }

    .sidebar-nav {
      flex: 1;
      padding: 6px 0 6px 0;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .sidebar.expanded .sidebar-nav {
      padding: 12px 0 6px 0;
      gap: 2px;
    }

    /* Scrollbar styling */
    .sidebar-nav::-webkit-scrollbar {
      width: 2px;
    }

    .sidebar-nav::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar-nav::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.3);
      border-radius: 1px;
    }

    .sidebar-nav::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.5);
    }

    .nav-section {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 6px;
    }

    .sidebar.expanded .nav-section {
      gap: 6px;
      margin-bottom: 0;
    }

    .nav-section-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #94a3b8;
      padding: 10px 12px 4px 12px;
      white-space: nowrap;
      display: none;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .sidebar.expanded .nav-section-title {
      display: block;
    }

    /* Ajouter un s√©parateur visuel entre sections quand menu ferm√© */
    .sidebar:not(.expanded) .nav-section:not(:first-child):not(.nav-section-collapsible)::before {
      content: '';
      display: block;
      width: 32px;
      height: 1px;
      background: rgba(148, 163, 184, 0.2);
      margin: 8px auto;
    }

    /* Cacher les sections collapsibles (Gestion Entrepreneur, Outils) quand menu ferm√© */
    .sidebar:not(.expanded) .nav-section-collapsible {
      display: none !important;
    }

    .nav-item {
      width: 48px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      color: #94a3b8;
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      position: relative;
      border-radius: 8px;
      border: none;
      margin: 0 auto;
      background: transparent;
    }

    .sidebar.expanded .nav-item {
      width: calc(100% - 20px);
      justify-content: flex-start;
      padding: 0 10px;
      margin: 0 10px;
      gap: 10px;
      position: relative;
    }

    /* Cadenas pour les items d√©sactiv√©s - UNIQUEMENT DANS LE SIDEBAR */
    .sidebar .nav-item .nav-lock-icon {
      margin-left: auto;
      font-size: 0.75rem;
      color: #64748b;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sidebar.expanded .nav-item .nav-lock-icon {
      opacity: 1;
    }

    .sidebar .nav-item:not([style*="pointer-events: none"]) .nav-lock-icon {
      display: none;
    }

    .nav-item:hover {
      background: rgba(96, 165, 250, 0.1);
      color: #e2e8f0;
    }

    .nav-item.active {
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.15) 0%, rgba(96, 165, 250, 0.08) 100%);
      color: #60a5fa;
      box-shadow: inset 3px 0 0 0 #60a5fa;
      border-radius: 12px;
    }

    .sidebar.expanded .nav-item.active {
      box-shadow: inset 3px 0 0 0 #60a5fa;
    }

    .nav-item.active .nav-icon {
      color: #60a5fa;
    }

    .nav-item.active .nav-label {
      color: #60a5fa;
      font-weight: 600;
    }

    .nav-icon {
      font-size: 17px;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .nav-icon svg {
      width: 17px;
      height: 17px;
    }

    .nav-icon i {
      font-size: 17px;
    }

    /* Nav label (cach√© quand sidebar ferm√©) */
    .nav-label {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      width: 0;
      overflow: hidden;
      transition: opacity 0.25s ease, width 0.25s ease;
    }

    .sidebar.expanded .nav-label {
      opacity: 1;
      width: auto;
    }

    /* TOOLTIP (cach√© quand sidebar ouvert) */
    .tooltip {
      position: fixed;
      left: 80px;
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      color: #f1f5f9;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.5);
      z-index: 999999;
      visibility: hidden;
      border: 1px solid rgba(96, 165, 250, 0.2);
      transform: translateX(-4px);
    }

    .nav-item:hover .tooltip {
      opacity: 1;
      visibility: visible;
      transform: translateX(0);
    }

    /* Cacher tooltips quand sidebar ouvert */
    .sidebar.expanded .tooltip {
      display: none;
    }

    /* Sidebar footer */
    .sidebar-footer {
      width: 100%;
      border-top: 1px solid rgba(51, 65, 85, 0.3);
      padding: 12px 0;
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: rgba(15, 23, 42, 0.6);
    }

    .sidebar-footer-content {
      width: 100%;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
    }

    .sidebar.expanded .sidebar-footer-content {
      width: calc(100% - 20px);
      margin: 0 10px;
      padding-left: 8px;
      justify-content: flex-start;
      gap: 12px;
    }

    .sidebar-footer-logo {
      width: 32px;
      height: 32px;
      object-fit: contain;
      flex-shrink: 0;
      margin: 0 auto;
    }

    .sidebar.expanded .sidebar-footer-logo {
      margin: 0;
    }

    .sidebar-footer-text {
      font-size: 12px;
      font-weight: 600;
      color: #94a3b8;
      white-space: nowrap;
      opacity: 0;
      width: 0;
      overflow: hidden;
      transition: opacity 0.25s ease, width 0.25s ease;
    }

    .sidebar.expanded .sidebar-footer-text {
      opacity: 1;
      width: auto;
    }

    /* Sidebar overlay (mobile) */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9998;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sidebar-overlay.show {
      display: block;
      opacity: 1;
    }

    /* ================================================================
       HEADER FIXE
       ================================================================ */

    #app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 90px;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(24px) saturate(180%);
      -webkit-backdrop-filter: blur(24px) saturate(180%);
      border-bottom: 1px solid rgba(96, 165, 250, 0.15);
      z-index: 30;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    #app-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(96, 165, 250, 0.5) 50%, transparent);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 2.5rem;
    }

    .header-logo {
      height: 54px;
      width: auto;
      object-fit: contain;
      filter: drop-shadow(0 4px 8px rgba(96, 165, 250, 0.3));
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .header-logo:hover {
      transform: scale(1.03) translateY(-1px);
      filter: drop-shadow(0 6px 12px rgba(96, 165, 250, 0.5));
    }

    .header-account {
      position: relative;
      margin-right: 0.5rem;
    }

    .account-btn {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      padding: 0.5rem 1.5rem 0.5rem 1.5rem;
      background: rgba(30, 41, 59, 0.4);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1.5px solid rgba(96, 165, 250, 0.15);
      border-radius: 48px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:
        0 4px 16px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.08),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
      min-width: 270px;
      height: 58px;
      position: relative;
      overflow: hidden;
    }

    .account-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(96, 165, 250, 0.1), transparent);
      transition: left 0.6s ease;
    }

    .account-btn:hover::before {
      left: 100%;
    }

    .account-btn:hover {
      background: rgba(51, 65, 85, 0.6);
      border-color: rgba(96, 165, 250, 0.4);
      box-shadow:
        0 8px 32px rgba(96, 165, 250, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.12),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }

    .account-avatar {
      position: relative;
      width: 32px;
      height: 32px;
      min-width: 32px;
      min-height: 32px;
      border-radius: 50%;
      overflow: visible;
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 0 0 1.5px rgba(96, 165, 250, 0.2),
        0 2px 4px rgba(96, 165, 250, 0.2);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .account-btn:hover .account-avatar {
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 0 0 1.5px rgba(96, 165, 250, 0.35),
        0 2px 8px rgba(96, 165, 250, 0.35);
      transform: scale(1.08) rotate(5deg);
    }

    .account-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .account-avatar i {
      font-size: 16px;
      color: white;
    }

    .account-info-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
      min-width: 0;
    }

    .account-name-row {
      display: flex;
      align-items: center;
    }

    .account-info {
      color: #f1f5f9;
      font-size: 0.8125rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }

    .account-meta-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .account-role {
      font-size: 0.6875rem;
      color: #94a3b8;
      font-weight: 500;
      white-space: nowrap;
      line-height: 1;
    }

    .account-level {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.6875rem;
      line-height: 1;
    }

    .account-level i {
      font-size: 0.625rem;
      color: #fbbf24;
    }

    .account-level span {
      color: #60a5fa;
      font-weight: 600;
    }

    .account-xp-bar {
      height: 3px;
      background: rgba(51, 65, 85, 0.8);
      border-radius: 1.5px;
      overflow: hidden;
      width: 100%;
      margin-top: 0.125rem;
    }

    .account-xp-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
      transition: width 0.5s ease;
      border-radius: 1.5px;
    }

    .account-chevron {
      color: #94a3b8;
      font-size: 0.75rem;
      transition: transform 0.3s ease;
      margin-left: auto;
      flex-shrink: 0;
    }

    .account-btn:hover .account-chevron {
      transform: rotate(180deg);
    }

    .account-dropdown {
      position: absolute;
      top: calc(100% + 0.5rem);
      right: 0;
      min-width: 250px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
    }

    .account-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    /* Header simple du dropdown */
    .dropdown-header-simple {
      padding: 1rem;
      border-bottom: 1px solid #334155;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .dropdown-user-info {
      flex: 1;
    }

    .dropdown-username {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 0.25rem;
    }

    .dropdown-role {
      font-size: 0.875rem;
      color: #94a3b8;
      font-weight: 500;
    }

    .dropdown-avatar-container {
      flex-shrink: 0;
      margin-right: 0.75rem;
    }

    .dropdown-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-darker);
      border: 2px solid var(--border-dark);
      overflow: hidden;
      position: relative;
    }

    .dropdown-avatar i {
      font-size: 1.5rem;
      color: var(--text-gray);
    }

    .dropdown-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .dropdown-grade-badge-img {
      width: 50px;
      height: 50px;
      object-fit: contain;
      flex-shrink: 0;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      color: #cbd5e1;
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
    }

    .dropdown-item:hover {
      background: rgba(96, 165, 250, 0.1);
      color: #60a5fa;
    }

    .dropdown-item.logout {
      color: #ef4444;
      border-top: 1px solid #334155;
    }

    .dropdown-item.logout:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* ================================================================
       MODAL STATISTIQUES
       ================================================================ */
    .stats-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(8px);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 2rem 1rem;
    }

    .stats-modal.active {
      display: flex;
    }

    .stats-modal-content {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border-radius: 20px;
      width: 100%;
      max-width: 800px;
      max-height: 75vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(96, 165, 250, 0.2);
      display: flex;
      flex-direction: column;
    }

    .stats-modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(96, 165, 250, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(82, 113, 255, 0.05));
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .stats-modal-header h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .stats-modal-header i {
      color: var(--primary-blue);
    }

    .stats-modal-close {
      background: transparent;
      border: none;
      color: var(--text-gray);
      font-size: 1.5rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .stats-modal-close:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .stats-modal-body {
      padding: 0 1.5rem 1.5rem 1.5rem;
      overflow-y: auto;
      flex: 1;
    }

    .stats-section {
      margin-bottom: 1.5rem;
      padding: 1rem;
      border-radius: 8px;
    }

    .stats-section-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .stats-section-title i {
      color: var(--primary-blue);
    }

    /* Structure unifi√©e - Une seule grande card */
    .stats-unified-card {
      padding: 2rem;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 16px;
      border: 1px solid rgba(96, 165, 250, 0.2);
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    /* Photo et nom */
    .stats-profile-header {
      display: flex;
      align-items: center;
      gap: 3rem;
    }

    /* Conteneur sans background */
    .stats-profile-photo-banner {
      position: relative;
      flex-shrink: 0;
      margin-left: 1rem;
    }

    .stats-profile-photo-wrapper {
      position: relative;
      display: inline-block;
    }

    .stats-profile-photo-container {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      overflow: visible;
      flex-shrink: 0;
      z-index: 2;
      border: 4px solid #60a5fa;
      box-shadow: 0 0 20px rgba(96, 165, 250, 0.5), 0 0 40px rgba(82, 113, 255, 0.3);
    }

    /* Direction n'a pas de contours de grade pour les statistiques */

    .stats-profile-photo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 50%;
    }

    /* Direction n'a pas de contours de grade */

    /* ================================================================
       DIRECTION N'A PAS DE CONTOURS DE GRADE
       ================================================================ */


    /* Banni√®re classique avec extr√©mit√©s coup√©es */
    .stats-photo-level-banner {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      z-index: 3;
      white-space: nowrap;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .stats-profile-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    /* Ligne avec nom et XP */
    .stats-name-xp-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .stats-name-xp-row h3 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-light);
    }

    /* Nom du grade dans la section du haut */
    .stats-grade-name-display {
      font-size: 0.95rem;
      font-weight: 600;
      color: #60a5fa;
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
    }

    .stats-xp-text-inline {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-gray);
      white-space: nowrap;
    }

    /* Barre XP */
    .stats-xp-bar {
      height: 8px;
      background: rgba(51, 65, 85, 0.5);
      border-radius: 10px;
      overflow: hidden;
      width: 100%;
    }

    .stats-xp-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      border-radius: 10px;
      transition: width 0.6s ease;
      box-shadow: 0 0 10px rgba(96, 165, 250, 0.5);
    }

    /* Section grade actuel avec s√©parateur */
    .stats-current-grade-section {
      padding-top: 1.5rem;
      border-top: 1px solid rgba(96, 165, 250, 0.2);
    }

    /* Grade actuel */
    .stats-current-grade {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .stats-grade-image {
      width: 100px;
      height: 100px;
      object-fit: contain;
      flex-shrink: 0;
    }

    .stats-grade-details {
      flex: 1;
    }

    .stats-grade-name {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary-blue);
      margin-bottom: 0.5rem;
    }

    .stats-grade-level {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-gray);
    }

    .stats-grade-level i {
      color: #f59e0b;
    }

    /* Vers prochain grade section */
    .stats-next-grade-section {
      padding-top: 1.5rem;
      border-top: 1px solid rgba(96, 165, 250, 0.2);
    }

    .stats-subsection-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* XP Card */
    .stats-xp-card {
      padding: 1.5rem;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 16px;
      border: 1px solid rgba(96, 165, 250, 0.2);
    }

    .stats-xp-text {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 1rem;
      text-align: center;
    }

    .stats-xp-bar {
      height: 12px;
      background: rgba(51, 65, 85, 0.5);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 0.75rem;
    }

    .stats-xp-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      border-radius: 10px;
      transition: width 0.6s ease;
      box-shadow: 0 0 15px rgba(96, 165, 250, 0.6);
    }

    .stats-xp-percentage {
      text-align: center;
      font-size: 0.875rem;
      color: var(--text-gray);
      font-weight: 600;
    }

    /* Next Grade Card */
    .stats-next-grade-card {
      padding: 1.5rem;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 16px;
      border: 1px solid rgba(96, 165, 250, 0.2);
    }

    .stats-next-grade-content {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .stats-grade-badge-left,
    .stats-grade-badge-right {
      width: 70px;
      height: 70px;
      flex-shrink: 0;
    }

    .stats-grade-badge-left img,
    .stats-grade-badge-right img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .stats-next-grade-info {
      flex: 1;
    }

    .stats-next-grade-levels {
      display: flex;
      justify-content: space-between;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 0.5rem;
    }

    .stats-next-grade-bar {
      height: 10px;
      background: rgba(51, 65, 85, 0.5);
      border-radius: 10px;
      overflow: hidden;
    }

    .stats-next-grade-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-green), #10b981);
      border-radius: 10px;
      transition: width 0.6s ease;
      box-shadow: 0 0 10px rgba(52, 211, 153, 0.5);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }


    /* Category Title */
    .stats-category-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-light);
      margin: 1.5rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid rgba(96, 165, 250, 0.3);
    }

    /* Badges Header with Expand Button */
    .badges-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .badges-expand-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(96, 165, 250, 0.1);
      border: 1px solid rgba(96, 165, 250, 0.3);
      border-radius: 8px;
      color: var(--text-light);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .badges-expand-btn:hover {
      background: rgba(96, 165, 250, 0.2);
      border-color: rgba(96, 165, 250, 0.5);
    }

    .badges-expand-btn i {
      transition: transform 0.3s ease;
    }

    .badges-expand-btn.expanded i {
      transform: rotate(180deg);
    }

    /* Top 5 Badges Container */
    .badges-top-container {
      margin-bottom: 0.5rem;
      padding: 1rem;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.5);
    }

    .top-badges-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(96, 165, 250, 0.2);
    }

    /* Ic√¥nes plus petites dans la section Top 5 (case m√™me taille) */
    .badges-top-container .badge-image {
      width: 50px;
      height: 50px;
    }

    .badges-top-container .badge-emoji {
      font-size: 2.75rem !important;
      width: 50px;
      height: 50px;
    }

    .top-badges-title i {
      color: #fbbf24;
    }

    /* Badges Container - Multiple Rarity Sections */
    .badges-grid {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-bottom: 0;
      padding-bottom: 0;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transform: scaleY(0);
      transform-origin: top;
      transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                  opacity 0.4s ease-in-out,
                  transform 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                  margin-top 0.4s ease-in-out;
      margin-top: 0;
    }

    .badges-grid.show {
      max-height: 3000px;
      opacity: 1;
      transform: scaleY(1);
      margin-top: 1rem;
      padding-bottom: 2rem;
      overflow: visible;
    }

    /* Rarity Section */
    .rarity-section {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 1rem;
      border-radius: 8px;
      transition: background-color 0.3s ease;
      overflow: visible;
    }

    /* Alternance de couleurs: une section sur deux a un fond fonc√© */
    .rarity-section:nth-child(even) {
      background: rgba(15, 23, 42, 0.5);
    }

    .rarity-section-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .rarity-section-title .badge-rarity {
      font-size: 0.875rem;
      padding: 0.35rem 0.75rem;
    }

    .rarity-badge-count {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-gray);
      background: rgba(30, 41, 59, 0.5);
      padding: 0.15rem 0.5rem;
      border-radius: 12px;
    }

    /* Horizontal Scroll Container per Rarity */
    .badges-horizontal-scroll {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 0.5rem;
      padding-bottom: 1rem;
      margin-bottom: 0;
      scroll-behavior: smooth;
      height: auto;
      cursor: grab;
    }

    .badges-horizontal-scroll * {
      cursor: grab !important;
    }

    .badges-horizontal-scroll .badge-info-icon,
    .badges-horizontal-scroll .badge-info-icon * {
      cursor: pointer !important;
    }

    .badges-horizontal-scroll::-webkit-scrollbar {
      height: 6px;
    }

    .badges-horizontal-scroll::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.3);
      border-radius: 3px;
    }

    .badges-horizontal-scroll::-webkit-scrollbar-thumb {
      background: rgba(96, 165, 250, 0.5);
      border-radius: 3px;
    }

    .badges-horizontal-scroll::-webkit-scrollbar-thumb:hover {
      background: rgba(96, 165, 250, 0.7);
    }

    .badge-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: rgba(30, 41, 59, 0.4);
      border-radius: 10px;
      border: 2px solid rgba(96, 165, 250, 0.3);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      width: 100px;
      height: 100px;
      flex-shrink: 0;
      box-sizing: border-box;
    }

    .badge-item:hover {
      border-color: rgba(96, 165, 250, 0.6);
      box-shadow: 0 4px 15px rgba(96, 165, 250, 0.4);
      background: rgba(30, 41, 59, 0.5);
    }

    .badge-image {
      width: 65px;
      height: 65px;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      flex-shrink: 0;
    }

    .badge-emoji {
      font-size: 3.5rem !important;
      line-height: 1;
      width: 65px;
      height: 65px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    /* Badge Count (x2, x3, etc.) - M√äME POSITION QUE GAMIFICATION.HTML */
    .badge-count {
      position: absolute;
      top: 0.75rem;
      right: 1rem;
      background: transparent;
      color: #fbbf24;
      padding: 0;
      font-size: 1rem;
      font-weight: 900;
      z-index: 5;
      text-shadow:
        0 2px 8px rgba(251, 191, 36, 0.3),
        2px 2px 4px rgba(0, 0, 0, 0.8),
        -1px -1px 2px rgba(0, 0, 0, 0.6),
        0 4px 12px rgba(0, 0, 0, 0.5);
      letter-spacing: 1px;
      -webkit-text-stroke: 0.5px white;
      text-stroke: 0.5px white;
      paint-order: stroke fill;
      filter: drop-shadow(2px 4px 6px rgba(0, 0, 0, 0.7));
    }

    /* Badge Info Icon - EN HAUT √Ä GAUCHE */
    .badge-info-icon {
      position: absolute;
      top: 0.35rem;
      left: 0.35rem;
      width: 16px;
      height: 16px;
      background: rgba(96, 165, 250, 0.2);
      border: 1px solid rgba(96, 165, 250, 0.4);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.45rem;
      color: var(--primary-blue);
      cursor: help;
      transition: all 0.3s ease;
      opacity: 1 !important;
      z-index: 10;
    }

    .badge-info-icon:hover {
      background: rgba(96, 165, 250, 0.4);
      border-color: var(--primary-blue);
      transform: scale(1.15);
    }

    .badge-item:has(.badge-info-icon:hover) {
      z-index: 100000 !important;
    }

    /* Tooltip pour les descriptions */
    .badge-tooltip {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 0.5rem;
      background: var(--bg-card);
      border: 1px solid var(--border-dark);
      border-radius: 8px;
      padding: 0.75rem;
      width: 200px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
      opacity: 0 !important;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 999999 !important;
      pointer-events: none;
    }

    /* Le PREMIER badge de chaque ligne ‚Üí tooltip √† GAUCHE */
    .badges-horizontal-scroll > .badge-item:first-child .badge-tooltip {
      left: 0 !important;
      right: auto !important;
      transform: translateX(0) !important;
    }

    /* TOUS les autres tooltips sont centr√©s */

    .badge-info-icon:hover .badge-tooltip {
      opacity: 1 !important;
      visibility: visible;
    }

    .badge-tooltip * {
      opacity: 1 !important;
    }

    .tooltip-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 0.25rem;
    }

    .tooltip-description {
      font-size: 0.6rem;
      color: var(--text-gray);
      line-height: 1.4;
    }

    .tooltip-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border-dark);
    }

    .tooltip-footer .badge-xp {
      font-size: 0.625rem;
      font-weight: 600;
      color: var(--primary-blue);
    }

    .badge-rarity {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-top: 0.15rem;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      letter-spacing: 0.5px;
    }

    .badge-rarity.commun {
      background: rgba(129, 140, 248, 0.2);
      color: #818cf8;
    }

    .badge-rarity.rare {
      background: rgba(96, 165, 250, 0.2);
      color: #60a5fa;
    }

    .badge-rarity.legendaire {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    .badge-rarity.mythique {
      background: rgba(244, 114, 182, 0.2);
      color: #f472b6;
    }

    .badge-rarity.epique {
      background: rgba(167, 139, 250, 0.2);
      color: #a78bfa;
    }

    .badge-rarity.anti-badge {
      background: rgba(248, 113, 113, 0.2);
      color: #f87171;
    }

    .no-badges-message {
      text-align: center;
      padding: 2rem;
      color: var(--text-gray);
      font-size: 0.875rem;
    }

    /* Stats Tables Grid - 2 colonnes */
    .stats-tables-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    /* Stats Table */
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(30, 41, 59, 0.3);
      border-radius: 8px;
      overflow: hidden;
    }

    .stats-table tbody tr {
      border-bottom: 1px solid rgba(96, 165, 250, 0.1);
    }

    .stats-table tbody tr:last-child {
      border-bottom: none;
    }

    .stats-table tbody tr:hover {
      background: rgba(30, 41, 59, 0.5);
    }

    .stats-table td {
      padding: 1rem 1.5rem;
      background: rgba(15, 23, 42, 0.5);
    }

    .stats-table td.stat-label {
      font-size: 0.875rem;
      color: var(--text-gray);
      font-weight: 500;
      width: 60%;
    }

    .stats-table td.stat-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-light);
      text-align: right;
      width: 40%;
    }

    /* CTA Button */
    .stats-cta {
      margin-top: 1rem;
      text-align: center;
    }

    .stats-cta-button {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
    }

    .stats-cta-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(59, 130, 246, 0.5);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .stats-modal-content {
        max-width: 95%;
      }

      .stats-grid,
      .stats-tables-grid {
        grid-template-columns: 1fr;
      }

      .badges-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        max-height: 250px;
      }

      .badge-item {
        padding: 0.5rem;
      }

      .badge-image {
        width: 35px;
        height: 35px;
      }

      .badge-emoji {
        font-size: 1.75rem !important;
      }

      .stats-grade-card,
      .stats-next-grade-content {
        flex-direction: column;
        text-align: center;
      }
    }

    /* ================================================================
       ZONE DE CONTENU DYNAMIQUE
       ================================================================ */

    #app-content {
      margin-left: 80px;
      margin-top: 90px;
      min-height: calc(100vh - 90px);
      width: calc(100% - 80px);
      padding: 0;
      transition: margin-left 0.25s ease, width 0.25s ease;
      background: #0f172a;
      overflow: hidden;
    }

    body.sidebar-expanded #app-content {
      margin-left: 260px;
      width: calc(100% - 260px);
    }

    /* PC: Une seule iframe normale */
    #page-iframe {
      width: 100%;
      height: calc(100vh - 90px);
      border: none;
      display: block;
    }

    /* Mobile: Iframes multiples pour swipe */
    .page-iframe-mobile {
      width: 100%;
      height: calc(100vh - 70px);
      border: none;
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: auto;
      transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      will-change: transform;
      display: none;
    }

    /* D√©sactiver la transition pendant le swipe actif */
    .page-iframe-mobile.swiping {
      transition: none;
    }

    /* Zones de swipe sur les bords */
    .swipe-zone {
      display: none;
      position: fixed;
      top: 0;
      height: 100vh;
      width: 1.75rem; /* 28px */
      z-index: 999999;
      pointer-events: auto;
      background: transparent;
    }

    #swipe-zone-left {
      left: 0;
    }

    #swipe-zone-right {
      right: 0;
    }

    @media (max-width: 768px) {
      .swipe-zone {
        display: block;
      }
    }

    /* Overlay pour suivre le swipe une fois activ√© */
    #swipe-overlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 11;
      pointer-events: none;
    }

    #swipe-overlay.swiping-active {
      pointer-events: auto;
    }

    @media (max-width: 768px) {
      #swipe-overlay {
        display: block;
      }
    }

    /* Animation de transition entre pages */
    .page-transition-enter {
      animation: fadeSlideIn 0.3s ease-out;
    }

    @keyframes fadeSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ================================================================
       HEADER MOBILE TOP - Style app-shell
       ================================================================ */

    .mobile-header-top {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 40;
      background: #1e293b;
      height: 64px;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    /* Mobile header icons */
    .mobile-settings-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: #475569;
      cursor: pointer;
      flex-shrink: 0;
    }

    .mobile-settings-icon i {
      color: white;
      font-size: 16px;
    }

    .mobile-profile-icon {
      width: 36px !important;
      height: 36px !important;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      flex-shrink: 0;
    }

    .mobile-profile-icon img {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
      border-radius: 50%;
    }

    .mobile-profile-icon i {
      color: white;
      font-size: 32px !important;
      width: 32px !important;
      height: 32px !important;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mobile-logo-container {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .mobile-logo-container img {
      height: 32px;
      width: auto;
      object-fit: contain;
    }

    .mobile-profile-container {
      position: relative;
    }

    .mobile-profile-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      min-width: 200px;
      z-index: 50;
      opacity: 0;
      transform: translateY(-10px) scale(0.95);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }

    .mobile-profile-dropdown.show {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }

    .mobile-profile-header {
      padding: 12px 16px;
    }

    .mobile-profile-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mobile-username {
      color: #f1f5f9;
      font-weight: 600;
      font-size: 14px;
    }

    .mobile-role {
      color: #94a3b8;
      font-size: 12px;
    }

    .mobile-profile-divider {
      height: 1px;
      background: #334155;
      margin: 0 8px;
    }

    .mobile-logout-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 12px 16px !important;
      color: #f87171;
      font-size: 14px !important;
      background: transparent;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .mobile-logout-btn:hover {
      background: rgba(248, 113, 113, 0.1);
    }

    /* ================================================================
       BOTTOM NAVIGATION MOBILE - Style app-shell
       ================================================================ */

    .mobile-header-bottom {
      display: none;
    }

    .case-container {
      position: relative;
      transition: all 0.7s ease-in-out;
    }

    .icon-container {
      transition: all 0.7s ease-in-out;
      transform-origin: center;
    }

    .icon-container.selected {
      transform: scale(1.2) translateY(-8px);
    }

    .icon-title {
      opacity: 0;
      transform: translateY(8px);
      transition: all 0.7s ease-in-out;
    }

    .icon-title.show {
      opacity: 1;
      transform: translateY(0);
    }

    .icon-container i {
      transition: none;
    }

    /* Case s√©lectionn√©e plus large */
    .flex-2 {
      flex: 1.5;
    }

    /* Alignement sp√©cial quand aucune ic√¥ne n'est s√©lectionn√©e */
    .case-container.no-selection {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    .hidden {
      display: none;
    }

    /* ================================================================
       RESPONSIVE - MOBILE
       ================================================================ */

    @media (max-width: 768px) {
      /* Cacher le sidebar sur mobile */
      .sidebar {
        display: none;
      }

      /* Cacher le header PC */
      #app-header {
        display: none;
      }

      /* Afficher les headers mobile */
      .mobile-header-top {
        display: flex;
      }

      .mobile-header-bottom {
        display: block;
      }

      /* Ajuster le contenu pour les headers mobile */
      #app-content {
        margin-left: 0;
        margin-top: 64px;
        margin-bottom: 96px;
        width: 100%;
        padding: 0;
        min-height: calc(100vh - 160px);
        height: calc(100vh - 160px);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
      }

      /* Cacher l'iframe PC et afficher les iframes mobile */
      #page-iframe {
        display: none !important;
      }

      .page-iframe-mobile {
        height: calc(100vh - 160px);
        width: 100%;
      }

      /* Cacher les scrollbars sur mobile */
      .page-iframe-mobile::-webkit-scrollbar {
        display: none;
      }

      .page-iframe-mobile {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      #app-content {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      #app-content::-webkit-scrollbar {
        display: none;
      }

      /* R√®gle additionnelle avec sp√©cificit√© plus √©lev√©e pour mobile logout btn */
      button.mobile-logout-btn {
        padding: 12px 16px !important;
        font-size: 14px !important;
      }
    }

    /* ================================================================
       LOADING STATE
       ================================================================ */

    .loading-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 3rem;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #334155;
      border-top-color: #60a5fa;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ================================================================
       FULLSCREEN LOADING OVERLAY - Mobile uniquement
       ================================================================ */

    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    #loading-overlay.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .loading-content {
      text-align: center;
      padding: 2rem;
    }

    .loading-logo {
      width: 120px;
      height: 120px;
      margin: 0 auto 2rem;
    }

    .loading-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .loading-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #f1f5f9;
      margin-bottom: 0.5rem;
    }

    .loading-subtitle {
      font-size: 1rem;
      color: #94a3b8;
      margin-bottom: 2rem;
    }

    .loading-progress-container {
      width: 280px;
      margin: 0 auto;
    }

    .loading-progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(51, 65, 85, 0.5);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 0.75rem;
    }

    .loading-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #60a5fa 0%, #3b82f6 100%);
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s ease;
      box-shadow: 0 0 10px rgba(96, 165, 250, 0.5);
    }

    .loading-progress-text {
      font-size: 0.875rem;
      color: #60a5fa;
      font-weight: 600;
    }

    /* Afficher sur desktop aussi */
    @media (min-width: 769px) {
      #loading-overlay {
        display: flex;
      }
    }

    /* ================================================================
       CHAT SUPPORT - Ic√¥ne flottante et fen√™tre de chat (PC uniquement)
       ================================================================ */

    /* Bouton flottant du chat */
    #chat-support-btn {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      background: #60a5fa;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(96, 165, 250, 0.4);
      transition: all 0.3s ease;
      z-index: 9998;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }

    #chat-support-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(96, 165, 250, 0.6);
    }

    #chat-support-btn i {
      font-size: 24px;
      color: white;
    }

    /* Badge de notification */
    #chat-notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ef4444;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      border: 2px solid #1f2937;
    }

    #chat-notification-badge.show {
      display: flex;
    }

    /* Fen√™tre de chat */
    #chat-support-window {
      position: fixed;
      bottom: 100px;
      right: 2rem;
      width: 400px;
      height: 550px;
      background: rgba(30, 41, 59, 0.98);
      border-radius: 16px;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
      display: none;
      flex-direction: column;
      z-index: 9999;
      border: 1px solid rgba(148, 163, 184, 0.2);
      backdrop-filter: blur(10px);
    }

    #chat-support-window.show {
      display: flex;
    }

    /* Header du chat */
    .chat-header {
      background: #60a5fa;
      padding: 1rem 1.5rem;
      border-radius: 16px 16px 0 0;
    }

    .chat-header-content {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .chat-header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-header-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.9);
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-text {
      font-weight: 500;
    }

    .status-separator {
      opacity: 0.6;
    }

    .status-response {
      opacity: 0.8;
    }

    .chat-header-close {
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 20px;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      transition: background 0.2s ease;
    }

    .chat-header-close:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Zone des messages */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: rgba(51, 65, 85, 0.3);
      border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.4);
      border-radius: 10px;
    }

    /* Message bubble */
    .chat-message {
      display: flex;
      flex-direction: column;
      max-width: 80%;
    }

    .chat-message.user {
      align-self: flex-end;
    }

    .chat-message.admin {
      align-self: flex-start;
    }

    .chat-message-bubble {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      word-wrap: break-word;
    }

    .chat-message.user .chat-message-bubble {
      background: #60a5fa;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .chat-message.admin .chat-message-bubble {
      background: rgba(51, 65, 85, 0.6);
      color: rgba(226, 232, 240, 0.95);
      border-bottom-left-radius: 4px;
    }

    .chat-message-time {
      font-size: 0.75rem;
      color: rgba(148, 163, 184, 0.7);
      margin-top: 0.25rem;
      padding: 0 0.5rem;
    }

    .chat-message.user .chat-message-time {
      text-align: right;
    }

    .chat-message.admin .chat-message-time {
      text-align: left;
    }

    /* Zone d'input */
    .chat-input-container {
      padding: 1rem;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.6);
      border-radius: 0 0 16px 16px;
    }

    .chat-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chat-input {
      flex: 1;
      background: rgba(51, 65, 85, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      color: rgba(226, 232, 240, 0.95);
      font-size: 0.9375rem;
      resize: none;
      max-height: 100px;
      min-height: 42px;
      font-family: inherit;
      width: 100%;
    }

    .chat-input:focus {
      outline: none;
      border-color: #60a5fa;
      background: rgba(51, 65, 85, 0.8);
    }

    .chat-input::placeholder {
      color: rgba(148, 163, 184, 0.6);
    }

    .chat-send-btn {
      background: transparent;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      color: #60a5fa;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .chat-send-btn:hover {
      background: rgba(96, 165, 250, 0.1);
      color: #60a5fa;
    }

    .chat-send-btn:active {
      transform: scale(0.9);
    }

    .chat-send-btn i {
      font-size: 18px;
    }

    .chat-attach-btn {
      background: transparent;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      color: rgba(148, 163, 184, 0.7);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .chat-attach-btn:hover {
      background: rgba(148, 163, 184, 0.1);
      color: rgba(148, 163, 184, 0.9);
    }

    .chat-attach-btn:active {
      transform: scale(0.9);
    }

    .chat-attach-btn i {
      font-size: 18px;
    }

    .chat-file-preview {
      padding: 0.4rem 0.5rem;
      background: rgba(15, 23, 42, 0.4);
      border-radius: 8px 8px 0 0;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      overflow-x: auto;
      overflow-y: hidden;
      max-height: 40px;
      margin-bottom: 0.25rem;
    }

    .chat-file-preview::-webkit-scrollbar {
      height: 3px;
    }

    .chat-file-preview::-webkit-scrollbar-track {
      background: rgba(148, 163, 184, 0.1);
      border-radius: 2px;
    }

    .chat-file-preview::-webkit-scrollbar-thumb {
      background: rgba(96, 165, 250, 0.5);
      border-radius: 2px;
    }

    .chat-file-preview::-webkit-scrollbar-thumb:hover {
      background: rgba(96, 165, 250, 0.7);
    }

    .chat-file-item {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.2rem 0.4rem;
      background: rgba(96, 165, 250, 0.12);
      border-radius: 4px;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .chat-file-preview img {
      width: 20px;
      height: 20px;
      object-fit: cover;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .chat-file-info {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      flex-direction: row;
    }

    .chat-file-name {
      font-size: 0.65rem;
      color: rgba(226, 232, 240, 0.85);
      font-weight: 400;
      white-space: nowrap;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-file-remove {
      background: transparent;
      border: none;
      color: rgba(226, 232, 240, 0.5);
      width: 14px;
      height: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .chat-file-remove:hover {
      color: #ef4444;
    }

    .chat-message-image {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .chat-message-image:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Masquer sur mobile */
    @media (max-width: 768px) {
      #chat-support-btn,
      #chat-support-window {
        display: none !important;
      }
    }

    /* ================================================================
       BADGE DE NOTIFICATION EMPLOY√âS
       ================================================================ */
    .notification-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
      border-radius: 10px;
    }

    /* Ajuster la position pour le sidebar r√©duit */
    .sidebar:not(.expanded) .notification-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      margin-left: 0;
      min-width: 18px;
      height: 18px;
      font-size: 0.65rem;
      display: inline-flex !important;
    }

    /* Retirer le nav-label du flux quand sidebar ferm√© pour √©viter d√©calage */
    .sidebar:not(.expanded) .nav-label {
      position: absolute;
      width: 0;
      height: 0;
      overflow: visible;
      pointer-events: none;
    }

    /* Le badge reste cliquable m√™me si nav-label est hors du flux */
    .sidebar:not(.expanded) .nav-label .notification-badge {
      pointer-events: auto;
    }

    /* Cacher les cadenas quand sidebar ferm√© (d√©j√† g√©r√© mais on s'assure) */
    .sidebar:not(.expanded) .nav-lock-icon {
      display: none !important;
    }
  </style>
</head>
<body class="sidebar-expanded">

  <!-- √âcran de chargement fullscreen (mobile uniquement) -->
  <div id="loading-overlay">
    <div class="loading-content">
      <!-- Logo anim√© qui tourne -->
      <div class="loading-logo">
        <img src="https://i.ibb.co/1fzHGQWw/TES-MUTE-TH-O-6.png" alt="Qwota">
      </div>

      <!-- Texte -->
      <h2 class="loading-title">Chargement de Qwota</h2>
      <p class="loading-subtitle">Pr√©paration de votre espace de travail...</p>

      <!-- Barre de progression -->
      <div class="loading-progress-container">
        <div class="loading-progress-bar">
          <div id="loading-progress-fill" class="loading-progress-fill"></div>
        </div>
        <div id="loading-progress-text" class="loading-progress-text">0%</div>
      </div>
    </div>
  </div>

  <!-- ================================================================
       NOUVEAU: Spinner de navigation entre pages (petit et fluide)
       ================================================================ -->
  <div id="page-loading-spinner" style="display: none; position: fixed; top: 90px; left: 260px; right: 0; bottom: 0; background: #0f172a; z-index: 9999; align-items: center; justify-content: center;">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
      <!-- Spinner SVG anim√© -->
      <svg width="64" height="64" viewBox="0 0 64 64" style="animation: spin 0.8s linear infinite;">
        <circle cx="32" cy="32" r="28" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="6"/>
        <circle cx="32" cy="32" r="28" fill="none" stroke="#3b82f6" stroke-width="6" stroke-dasharray="140" stroke-dashoffset="40" stroke-linecap="round" style="transform-origin: center; transform: rotate(-90deg);"/>
      </svg>
      <div style="margin-top: 16px; font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500; text-align: center;">Chargement...</div>
    </div>
  </div>

  <!-- Container principal de l'app - style inline pour garantir invisibilite immediate -->
  <div id="app-container" style="opacity: 0;">

    <!-- Sidebar - Style Qwota Lite -->
    <aside class="sidebar expanded">
      <!-- Toggle button -->
      <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-chevron-right"></i>
      </button>

      <nav class="sidebar-nav">
        <!-- Section Param√®tre -->
        <div class="nav-section">
          <div class="nav-section-title">Param√®tre</div>
          <a href="#/parametredirection" class="nav-item" data-page="parametredirection">
            <span class="nav-icon">
              <i class="fas fa-user-cog"></i>
            </span>
            <span class="nav-label">Param√®tres</span>
            <span class="tooltip">Param√®tres</span>
          </a>
          <a href="#/parametreadmin" class="nav-item" data-page="parametreadmin">
            <span class="nav-icon">
              <i class="fas fa-users"></i>
            </span>
            <span class="nav-label">Utilisateurs</span>
            <span class="tooltip">Utilisateurs</span>
          </a>
        </div>

        <!-- Section G√©n√©ral -->
        <div class="nav-section">
          <div class="nav-section-title">G√©n√©ral</div>
          <a href="#/dashboard" class="nav-item active" data-page="dashboard">
            <span class="nav-icon">
              <i class="fas fa-chart-bar"></i>
            </span>
            <span class="nav-label">Dashboard</span>
            <span class="tooltip">Dashboard</span>
          </a>
          <!-- RPO avec sous-menu -->
          <div class="nav-item-collapsible">
            <div class="nav-item" onclick="toggleRPOSection()" style="cursor: pointer;">
              <span class="nav-icon">
                <i class="fas fa-calendar-check"></i>
              </span>
              <span class="nav-label" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <span>RPO</span>
                <i class="fas fa-chevron-down" id="rpo-chevron" style="font-size: 0.75rem; transition: transform 0.3s ease;"></i>
              </span>
            </div>
            <div id="rpo-content" style="display: none; padding-left: 1rem; flex-direction: column; gap: 6px; margin-top: 6px;">
              <a href="#/direction_rpo" class="nav-item" data-page="direction_rpo" style="padding: 0.625rem 0.75rem;">
                <span class="nav-icon">
                  <i class="fas fa-calendar-alt" style="font-size: 0.875rem;"></i>
                </span>
                <span class="nav-label" style="font-size: 0.875rem;">Mon RPO</span>
                <span class="tooltip">Mon RPO (Direction)</span>
              </a>
              <a href="#/coach_rpo" class="nav-item" data-page="coach_rpo" style="padding: 0.625rem 0.75rem;">
                <span class="nav-icon">
                  <i class="fas fa-user-tie" style="font-size: 0.875rem;"></i>
                </span>
                <span class="nav-label" style="font-size: 0.875rem;">RPO Coach</span>
                <span class="tooltip">RPO Coach</span>
              </a>
            </div>
          </div>
          <a href="#/centralevue" class="nav-item" data-page="centralevue">
            <span class="nav-icon">
              <i class="fas fa-building"></i>
            </span>
            <span class="nav-label">La Centrale</span>
            <span class="tooltip">La Centrale</span>
          </a>
          <a href="#/badgeassignment" class="nav-item" data-page="badgeassignment">
            <span class="nav-icon">
              <i class="fas fa-trophy"></i>
            </span>
            <span class="nav-label">Niveaux & Troph√©es</span>
            <span class="tooltip">Niveaux & Troph√©es</span>
          </a>
          <a href="#/coach_plaintes" class="nav-item" data-page="coach_plaintes" id="nav-plaintes">
            <span class="nav-icon">
              <i class="fas fa-exclamation-triangle"></i>
            </span>
            <span class="nav-label" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
              <span>Gestion de Plaintes</span>
              <span id="plaintes-notification-badge" class="notification-badge" style="display: none; margin-left: auto;">0</span>
            </span>
            <span class="tooltip">Gestion de Plaintes</span>
          </a>
        </div>

        <!-- Section Gestion Comptable -->
        <div class="nav-section">
          <div class="nav-section-title">Gestion Comptable</div>
          <a href="#/employes" class="nav-item" data-page="employes" id="nav-employes" style="position: relative;">
            <span class="nav-icon">
              <i class="fas fa-users"></i>
            </span>
            <span class="nav-label" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
              <span>Employ√©s</span>
              <span id="employes-notification-badge" class="notification-badge" style="display: none; margin-left: auto;">0</span>
            </span>
            <span class="tooltip">Employ√©s</span>
          </a>
          <a href="#/direction_facturation" class="nav-item" data-page="direction_facturation" id="nav-direction-facturation" style="position: relative;">
            <span class="nav-icon">
              <i class="fas fa-file-invoice-dollar"></i>
            </span>
            <span class="nav-label" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
              <span>Facturation QE</span>
              <span id="facturation-notification-badge" class="notification-badge" style="display: none; margin-left: auto;">0</span>
            </span>
            <span class="tooltip">Facturation QE</span>
          </a>
        </div>

        <!-- Section Gestion Entrepreneur (Collapsible) -->
        <div class="nav-section nav-section-collapsible" id="nav-section-gestion">
          <div class="nav-section-title" onclick="toggleGestionSection()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <span>Gestion Entrepreneur</span>
            <i class="fas fa-chevron-down" id="gestion-chevron" style="transition: transform 0.3s ease;"></i>
          </div>
          <div id="gestion-content" style="display: none; flex-direction: column; gap: 6px; margin-top: 6px;">
          <a href="#/rpo" class="nav-item" data-page="rpo">
            <span class="nav-icon">
              <i class="fas fa-calendar-alt"></i>
            </span>
            <span class="nav-label">RPO</span>
            <span class="tooltip">RPO</span>
          </a>
          <a href="#/travaux" class="nav-item" data-page="travaux">
            <span class="nav-icon">
              <i class="fas fa-chart-line"></i>
            </span>
            <span class="nav-label">Ventes</span>
            <span class="tooltip">Ventes</span>
          </a>
          <a href="#/gestionemployes" class="nav-item" data-page="gestionemployes" id="nav-employes-gestion" style="position: relative;">
            <span class="nav-icon">
              <i class="fas fa-users"></i>
            </span>
            <span class="nav-label" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
              <span>Employ√©s</span>
              <span id="employes-notification-badge-gestion" class="notification-badge" style="display: none; margin-left: auto;">0</span>
            </span>
            <span class="tooltip">Employ√©s</span>
          </a>
          <a href="#/facturationqe" class="nav-item" data-page="facturationqe" id="nav-facturationqe-gestion" style="position: relative;">
            <span class="nav-icon">
              <i class="fas fa-file-invoice-dollar"></i>
            </span>
            <span class="nav-label" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
              <span>Facturation QE</span>
              <span id="facturation-notification-badge-gestion" class="notification-badge" style="display: none; margin-left: auto;">0</span>
            </span>
            <span class="tooltip">Facturation QE</span>
          </a>
          <a href="#/avis" class="nav-item" data-page="avis">
            <span class="nav-icon">
              <i class="fas fa-star"></i>
            </span>
            <span class="nav-label">Avis clients</span>
            <span class="tooltip">Avis clients</span>
          </a>
          </div>
        </div>

        <!-- Section Outils (Collapsible) -->
        <div class="nav-section nav-section-collapsible" id="nav-section-outils">
          <div class="nav-section-title" onclick="toggleOutilsSection()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <span>Outils</span>
            <i class="fas fa-chevron-down" id="outils-chevron" style="transition: transform 0.3s ease;"></i>
          </div>
          <div id="outils-content" style="display: none; flex-direction: column; gap: 6px; margin-top: 6px;">
            <a href="#/calculateur" class="nav-item" data-page="calculateur">
              <span class="nav-icon">
                <i class="fas fa-calculator"></i>
              </span>
              <span class="nav-label">Calculateur</span>
              <span class="tooltip">Calculateur</span>
            </a>
            <a href="#/soumissions" class="nav-item" data-page="soumissions">
              <span class="nav-icon">
                <i class="fas fa-file-text"></i>
              </span>
              <span class="nav-label">Soumission</span>
              <span class="tooltip">Soumission</span>
            </a>
            <a href="#/gqp" class="nav-item" data-page="gqp">
              <span class="nav-icon">
                <i class="fas fa-clipboard-list"></i>
              </span>
              <span class="nav-label">GQP de travaux</span>
              <span class="tooltip">GQP de travaux</span>
            </a>
            <a href="#/facture" class="nav-item" data-page="facture">
              <span class="nav-icon">
                <i class="fas fa-file-invoice"></i>
              </span>
              <span class="nav-label">Facturation client</span>
              <span class="tooltip">Facturation client</span>
            </a>
          </div>
        </div>
      </nav>

      <!-- Sidebar Footer -->
      <div class="sidebar-footer">
        <div class="sidebar-footer-content">
          <img src="https://i.ibb.co/CKYppwJD/Design-sans-titre-95.png" alt="QE" class="sidebar-footer-logo">
          <span class="sidebar-footer-text">Qualit√© √âtudiants</span>
        </div>
      </div>
    </aside>

    <!-- Overlay pour sidebar mobile -->
    <div class="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

    <!-- Header desktop fixe -->
    <header id="app-header">
      <div class="header-left">
        <img src="https://i.ibb.co/XfvCg4tN/Sans-titre-500-x-170-px-13.png" alt="Logo" class="header-logo">
      </div>

      <div class="header-account">
        <button class="account-btn" onclick="toggleAccountDropdown()">
          <div class="account-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="account-info-wrapper">
            <div class="account-name-row">
              <div class="account-info" id="account-username">Chargement...</div>
            </div>
            <div class="account-meta-row">
              <div class="account-role" id="account-role">Direction</div>
            </div>
          </div>
          <i class="fas fa-chevron-down account-chevron"></i>
        </button>

        <div class="account-dropdown" id="account-dropdown">
          <!-- Header simple avec photo, nom et role -->
          <div class="dropdown-header-simple" style="border-bottom: 1px solid #334155;">
            <div class="dropdown-avatar-container">
              <div class="dropdown-avatar" id="dropdown-avatar">
                <i class="fas fa-user"></i>
              </div>
            </div>
            <div class="dropdown-user-info">
              <div class="dropdown-username" id="dropdown-username">Chargement...</div>
              <div class="dropdown-role" id="dropdown-role">Direction</div>
            </div>
          </div>

          <!-- Boutons -->
          <button class="dropdown-item" onclick="navigateTo('parametredirection')">
            <i class="fas fa-user-cog"></i>
            <span>Param√®tres</span>
          </button>
          <button class="dropdown-item" onclick="navigateTo('parametreadmin')">
            <i class="fas fa-users"></i>
            <span>Utilisateurs</span>
          </button>
          <button class="dropdown-item logout" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Se deconnecter</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Header Mobile Top - Style app-shell -->
    <div class="mobile-header-top md:hidden">
      <div class="mobile-settings-icon" onclick="router.loadPage('connection')">
        <i class="fas fa-cog text-white"></i>
      </div>
      <div class="mobile-logo-container">
        <img src="https://i.ibb.co/XfvCg4tN/Sans-titre-500-x-170-px-13.png" alt="Logo" class="h-8">
      </div>
      <div class="mobile-profile-container">
        <div class="mobile-profile-icon" onclick="toggleMobileProfileMenu()">
          <i class="fas fa-user text-white"></i>
        </div>
        <div id="mobile-profile-dropdown" class="mobile-profile-dropdown hidden">
          <div class="mobile-profile-header">
            <div class="mobile-profile-info">
              <div class="mobile-username" id="mobile-username">Utilisateur</div>
              <div class="mobile-role" id="mobile-role">Admin</div>
            </div>
          </div>
          <div class="mobile-profile-divider"></div>
          <button onclick="logout()" class="mobile-logout-btn">
            <i class="fas fa-sign-out-alt"></i>
            <span>Se d√©connecter</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Zone de contenu dynamique -->
    <main id="app-content">
      <!-- Zones de swipe sur les bords (MOBILE SEULEMENT) -->
      <div id="swipe-zone-left" class="swipe-zone"></div>
      <div id="swipe-zone-right" class="swipe-zone"></div>

      <!-- Overlay pour suivre le swipe une fois activ√© -->
      <div id="swipe-overlay"></div>

      <!-- PC: Une seule iframe qui change de src -->
      <iframe id="page-iframe" src="/dashboard" style="display: block;"></iframe>

      <!-- MOBILE: Iframes multiples pour swipe fluide (cach√©es sur PC) -->
      <iframe id="iframe-rpo" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-travaux" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-dashboard" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-outils" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-gestions" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-connection" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-centralevue" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-centraleadmin" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-gamification" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-calcul" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-soumissions" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-gqp" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-facture" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-gestionemployes" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-facturationqe" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-direction-facturation" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-avis" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-centrale" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-dashboardcoach" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-parametrecoach" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-employes" class="page-iframe-mobile" src="" style="display: none;"></iframe>
      <iframe id="iframe-coach_plaintes" class="page-iframe-mobile" src="" style="display: none;"></iframe>
    </main>

    <!-- Chat Support (PC uniquement) - DISABLED FOR DIRECTION -->
    <!-- Bouton flottant
    <div id="chat-support-btn" onclick="toggleChatWindow()">
      <i class="fas fa-comments"></i>
      <span id="chat-notification-badge">0</span>
    </div>
    -->

    <!-- Fen√™tre de chat -->
    <div id="chat-support-window">
      <!-- Header -->
      <div class="chat-header">
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
          <!-- Logo avec statut -->
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="position: relative;">
              <img src="https://i.ibb.co/R4Bq6WVh/TES-MUTE-TH-O-10.png" alt="Qwota" style="
                width: 50px;
                height: 50px;
                border-radius: 50%;
                object-fit: cover;
              ">
              <div style="
                position: absolute;
                bottom: 2px;
                right: 2px;
                width: 12px;
                height: 12px;
                background: #10b981;
                border-radius: 50%;
                border: 2px solid #60a5fa;
              "></div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
              <span style="
                color: white;
                font-size: 1.125rem;
                font-weight: 600;
              ">Support Qwota</span>
              <span style="
                color: rgba(226, 232, 240, 0.85);
                font-size: 0.75rem;
                font-weight: 500;
              ">R√©ponse dans l'heure</span>
            </div>
          </div>

          <!-- Bouton fermer -->
          <button class="chat-header-close" onclick="toggleChatWindow()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <!-- Messages -->
      <div class="chat-messages" id="chat-messages">
        <!-- Les messages seront ajout√©s ici dynamiquement -->
      </div>

      <!-- Input -->
      <div class="chat-input-container">
        <div id="chat-file-preview" class="chat-file-preview" style="display: none;"></div>
        <div class="chat-input-wrapper">
          <input type="file" id="chat-file-input" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
          <textarea
            id="chat-input"
            class="chat-input"
            placeholder="Tapez votre message..."
            rows="1"
            onkeydown="handleChatInputKeydown(event)"
          ></textarea>
          <button class="chat-attach-btn" onclick="document.getElementById('chat-file-input').click()" title="Joindre une image">
            <i class="fas fa-paperclip"></i>
          </button>
          <button class="chat-send-btn" onclick="sendChatMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Bottom Navigation Mobile - Style app-shell -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 z-50 mobile-header-bottom">
      <div class="bg-slate-800 h-24 shadow-2xl relative" style="filter: drop-shadow(0 -8px 18px rgba(59, 130, 246, 0.2));">
        <!-- 5 ic√¥nes r√©parties -->
        <div class="absolute top-1.5 left-0 right-0 flex justify-center">
          <div class="flex items-center w-full h-full">
            <!-- Case 1 - RPO -->
            <div class="flex-1 case-container flex justify-center items-center h-full">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-indigo-600 flex items-center justify-center shadow-lg cursor-pointer icon-container" onclick="router.loadPage('rpo')">
                <i class="fas fa-calendar-alt text-sm text-white"></i>
              </div>
            </div>
            <!-- S√©parateur 1 -->
            <div class="w-px h-8 bg-slate-400 opacity-30"></div>
            <!-- Case 2 - Travaux -->
            <div class="flex-1 case-container flex justify-center items-center h-full">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center shadow-lg cursor-pointer icon-container" onclick="router.loadPage('travaux')">
                <i class="fas fa-chart-line text-sm text-white"></i>
              </div>
            </div>
            <!-- S√©parateur 2 -->
            <div class="w-px h-8 bg-slate-400 opacity-30"></div>
            <!-- Case 3 (centrale - Dashboard) -->
            <div class="flex-2 case-container flex flex-col justify-center items-center h-full">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-xl cursor-pointer icon-container" onclick="router.loadPage('dashboard')">
                <i class="fas fa-chart-bar text-xl text-white"></i>
              </div>
            </div>
            <!-- S√©parateur 3 -->
            <div class="w-px h-8 bg-slate-400 opacity-30"></div>
            <!-- Case 4 - Outils -->
            <div class="flex-1 case-container flex justify-center items-center h-full">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center shadow-lg cursor-pointer icon-container" onclick="router.loadPage('outils')">
                <i class="fas fa-tools text-sm text-white"></i>
              </div>
            </div>
            <!-- S√©parateur 4 -->
            <div class="w-px h-8 bg-slate-400 opacity-30"></div>
            <!-- Case 5 - Gestions -->
            <div class="flex-1 case-container flex justify-center items-center h-full">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center shadow-lg cursor-pointer icon-container" onclick="router.loadPage('gestions')">
                <i class="fas fa-briefcase text-sm text-white"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================================================================
       MODAL STATISTIQUES GAMIFICATION
       ================================================================ -->
  <div id="stats-modal" class="stats-modal">
    <div class="stats-modal-content">
      <!-- Header du modal -->
      <div class="stats-modal-header">
        <h2><i class="fas fa-chart-line"></i> Statistiques de Progression</h2>
        <button class="stats-modal-close" onclick="closeStatsModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Contenu du modal -->
      <div class="stats-modal-body">
        <!-- SECTION 1: PROFIL COMPLET (Photo + Nom + Grade + Progression) -->
        <div class="stats-section">
          <div class="stats-unified-card">
            <!-- Photo et Info avec XP -->
            <div class="stats-profile-header">
              <div class="stats-profile-photo-banner">
                <div class="stats-profile-photo-wrapper">
                  <div class="stats-profile-photo-container">
                    <img id="stats-profile-photo" src="" alt="Photo de profil" class="stats-profile-photo">
                  </div>
                  <div class="stats-photo-level-banner">
                    <span>Niv. <span id="stats-photo-level-text">1</span></span>
                  </div>
                </div>
              </div>
              <div class="stats-profile-info">
                <div class="stats-name-xp-row">
                  <div style="display: flex; align-items: baseline; gap: 1rem;">
                    <h3 id="stats-username">Username</h3>
                    <div class="stats-grade-name-display" id="stats-grade-name-display">D√©marrage</div>
                  </div>
                  <div class="stats-xp-text-inline">
                    <span id="stats-xp-current">0</span> / <span id="stats-xp-next">100</span> XP
                    <span class="stats-xp-percentage" id="stats-xp-percentage">(0%)</span>
                  </div>
                </div>

                <!-- Barre XP sous le nom -->
                <div class="stats-xp-bar">
                  <div class="stats-xp-fill" id="stats-xp-fill" style="width: 0%"></div>
                </div>
              </div>
            </div>

            <!-- Vers Prochain Grade -->
            <div class="stats-next-grade-section">
              <h4 class="stats-subsection-title">Vers Prochain Grade</h4>
              <div class="stats-next-grade-content">
                <div class="stats-grade-badge-left">
                  <img id="stats-current-grade-badge" src="" alt="Grade actuel">
                </div>
                <div class="stats-next-grade-info">
                  <div class="stats-next-grade-levels">
                    <span id="stats-current-level-text">Niv 1</span>
                    <span id="stats-next-level-text">Niv 2</span>
                  </div>
                  <div class="stats-next-grade-bar">
                    <div class="stats-next-grade-fill" id="stats-next-grade-fill" style="width: 0%"></div>
                  </div>
                </div>
                <div class="stats-grade-badge-right">
                  <img id="stats-next-grade-badge" src="" alt="Prochain grade">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECTION 2: MES BADGES -->
        <div class="stats-section">
          <div class="badges-header">
            <h3 class="stats-section-title"><i class="fas fa-medal"></i> Mes Badges</h3>
            <button class="badges-expand-btn" id="badges-expand-btn" onclick="toggleBadgesSection()">
              <span id="badges-expand-text">Voir tous</span>
              <i class="fas fa-chevron-down" id="badges-expand-icon"></i>
            </button>
          </div>

          <!-- Top 5 badges (visible par d√©faut) -->
          <div class="badges-top-container" id="badges-top-container">
            <div class="top-badges-title">
              <i class="fas fa-trophy"></i>
              <span>5 Meilleurs Badges</span>
            </div>
            <div class="badges-horizontal-scroll" id="stats-badges-top">
              <!-- Les 5 meilleurs badges seront charg√©s ici -->
              <div class="no-badges-message">Chargement des badges...</div>
            </div>
          </div>

          <!-- Tous les badges par raret√© (cach√© par d√©faut avec animation) -->
          <div class="badges-grid" id="stats-badges-grid">
            <!-- Les badges seront charg√©s ici par JavaScript -->
          </div>
        </div>

        <!-- SECTION 3: STATISTIQUES COMPL√àTES -->
        <div class="stats-section">
          <h3 class="stats-section-title"><i class="fas fa-chart-bar"></i> Toutes mes Statistiques</h3>

          <!-- Toutes les stats -->
          <div class="stats-tables-grid">
            <table class="stats-table">
              <tbody>
                <tr>
                  <td class="stat-label">XP Total</td>
                  <td class="stat-value" id="stats-total-xp">0</td>
                </tr>
              </tbody>
            </table>
            <table class="stats-table">
              <tbody>
                <tr>
                  <td class="stat-label">Badges</td>
                  <td class="stat-value" id="stats-badges">0</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="stats-tables-grid">
            <table class="stats-table">
              <tbody>
                <tr>
                  <td class="stat-label">Dollars ($) vendu</td>
                  <td class="stat-value" id="stats-ca-actuel">0 $</td>
                </tr>
                <tr>
                  <td class="stat-label">Contrats sign√©s</td>
                  <td class="stat-value" id="stats-contrats-signes">0</td>
                </tr>
                <tr>
                  <td class="stat-label">Satisfaction</td>
                  <td class="stat-value" id="stats-satisfaction">0</td>
                </tr>
                <tr>
                  <td class="stat-label">Contrat moyen</td>
                  <td class="stat-value" id="stats-contrat-moyen">0 $</td>
                </tr>
              </tbody>
            </table>
            <table class="stats-table">
              <tbody>
                <tr>
                  <td class="stat-label">Taux marketing</td>
                  <td class="stat-value" id="stats-taux-marketing">0%</td>
                </tr>
                <tr>
                  <td class="stat-label">Taux de vente</td>
                  <td class="stat-value" id="stats-taux-vente">0%</td>
                </tr>
                <tr>
                  <td class="stat-label">Productivit√©/h</td>
                  <td class="stat-value" id="stats-prod-horaire">0 $/h</td>
                </tr>
                <tr>
                  <td class="stat-label">H de P√ÄP</td>
                  <td class="stat-value" id="stats-heures-pap">0 h</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================================================================
       ROUTER JAVASCRIPT - Navigation SPA
       ================================================================ -->

  <script>
    // Configuration du router
    const router = {
      currentPage: null,

      // Map des routes vers les URLs FastAPI
      routes: {
        'parametredirection': '/parametredirection',
        'parametreadmin': '/parametreadmin',
        'badgeassignment': '/badge_assignment',
        'centralevue': '/centralevue',
        'centraleadmin': '/centraleadmin',
        'dashboard': '/dashboard?dashboardType=qualite-etudiants',
        'direction_rpo': '/direction_rpo',
        'coach_rpo': '/coach_rpo',
        'coach_plaintes': '/coach_plaintes',
        'rpo': '/rpo',
        'travaux': '/travaux',
        'gestionemployes': '/gestionemployes',
        'facturationqe': '/facturationqe?page=status',
        'direction_facturation': '/direction_facturation',
        'avis': '/avis',
        'calculateur': '/calcul',
        'soumissions': '/soumissions',
        'gqp': '/gqp',
        'facture': '/facture',
        'employes': '/coach_validation_employes',
        'facturation': '/direction_facturation',
        'suivicoach': '/suivicoach'
      },

      // Charger une page (diff√©rent pour PC et mobile)
      loadPage(pageName) {
        const url = this.routes[pageName];

        if (!url) {
          console.error(`[APPPC] Route non trouvee pour: ${pageName}`);
          return;
        }

        console.log(`[APPPC] Navigation vers ${pageName}`);

        // PC: Utiliser une seule iframe qui change de src
        if (window.innerWidth > 768) {
          const iframe = document.getElementById('page-iframe');
          if (iframe) {
            // V√©rifier si on doit charger la page (src vide ou diff√©rent)
            const srcAttr = iframe.getAttribute('src');
            const needsLoading = !srcAttr || srcAttr === '' || srcAttr === 'about:blank';

            if (needsLoading || srcAttr !== url) {
              // ‚ö° CACHER L'IFRAME IMM√âDIATEMENT pour √©viter le flash
              iframe.style.opacity = '0';

              // ‚ö° AFFICHER le spinner IMM√âDIATEMENT (pas de d√©lai)
              // MAIS seulement si le loading-overlay principal n'est pas visible (pas au premier lancement)
              const pageSpinner = document.getElementById('page-loading-spinner');
              const loadingOverlay = document.getElementById('loading-overlay');
              const isInitialLoad = loadingOverlay && !loadingOverlay.classList.contains('hidden');

              // ‚ö° Ajuster la position du spinner selon la sidebar (desktop vs mobile)
              if (pageSpinner && !isInitialLoad) {
                const sidebar = document.querySelector('.sidebar');
                const sidebarWidth = sidebar && sidebar.classList.contains('expanded') ? '260px' : '80px';

                // Desktop: √† c√¥t√© de la sidebar
                pageSpinner.style.left = sidebarWidth;
                pageSpinner.style.top = '90px';

                // Afficher le spinner pour la navigation entre pages
                pageSpinner.style.display = 'flex';
                console.log(`[APPPC] üîÑ Spinner affich√© pour ${pageName}`);
              }

              // Charger la page
              iframe.src = url;

              // Cacher le spinner quand la page est charg√©e (avec d√©lai de 500ms)
              iframe.addEventListener('load', function onLoad() {
                setTimeout(() => {
                  if (pageSpinner) {
                    pageSpinner.style.display = 'none';
                    console.log(`[APPPC] ‚úÖ Spinner cach√© - ${pageName} charg√©`);
                  }
                  // Remettre l'iframe visible
                  iframe.style.opacity = '1';
                }, 500);
                iframe.removeEventListener('load', onLoad);
              });
            }
          }
        }
        // MOBILE: Utiliser le syst√®me multi-iframes pour swipe fluide
        else {
          // Cacher toutes les iframes mobile
          document.querySelectorAll('.page-iframe-mobile').forEach(iframe => {
            iframe.style.display = 'none';
          });

          // Afficher l'iframe correspondante
          const targetIframe = document.getElementById(`iframe-${pageName}`);
          if (targetIframe) {
            console.log(`[APPPC] Navigation vers ${pageName} - src actuel: "${targetIframe.src}"`);

            // Si l'iframe n'a pas encore de src (pages √† la demande), la charger
            if (!targetIframe.src || targetIframe.src === window.location.href || targetIframe.src === '') {
              console.log(`[APPPC] ‚è≥ Chargement initial de ${pageName}: ${url}`);
              targetIframe.src = url;

              // Injecter CSS pour cacher les scrollbars quand l'iframe est charg√©e
              targetIframe.addEventListener('load', function() {
                hideScrollbarsInIframe(targetIframe);
              });
            } else {
              console.log(`[APPPC] ‚úÖ Page ${pageName} d√©j√† charg√©e - affichage instantan√©`);
            }
            targetIframe.style.display = 'block';
          } else {
            console.error(`[APPPC] Iframe non trouv√©e pour: ${pageName}`);
          }
        }

        // Mettre a jour le menu actif
        this.updateActiveMenu(pageName);
        this.currentPage = pageName;

        // Activer l'animation de l'ic√¥ne correspondante dans le bottom navigation
        if (typeof setActiveNavIcon === 'function') {
          setActiveNavIcon(pageName);
        }
      },

      // Mettre a jour le menu actif
      updateActiveMenu(pageName) {
        // Retirer imm√©diatement tous les active pour √©viter les transitions
        document.querySelectorAll('.menu-item').forEach(item => {
          item.classList.remove('active');
        });
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });

        // Puis ajouter la classe active au bon √©l√©ment (SEULEMENT LE PREMIER trouv√© pour √©viter les doublons)
        let menuItemFound = false;
        document.querySelectorAll('.menu-item').forEach(item => {
          if (item.dataset.page === pageName && !menuItemFound) {
            item.classList.add('active');
            menuItemFound = true;
          }
        });

        let navItemFound = false;
        document.querySelectorAll('.nav-item').forEach(item => {
          if (item.dataset.page === pageName && !navItemFound) {
            item.classList.add('active');
            navItemFound = true;
          }
        });
      },

      // Initialiser le router
      init() {
        // Gerer les changements de hash
        window.addEventListener('hashchange', () => {
          const page = location.hash.slice(2) || 'dashboard';
          this.loadPage(page);
        });

        // Gerer les clics sur les liens du menu
        document.querySelectorAll('.nav-item').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();

            const page = link.dataset.page;
            if (page) {
              location.hash = `#/${page}`;
            }
          });
        });

        // Direction n'a pas de guide - toujours charger dashboard au refresh
        const checkGuideAndLoadInitialPage = async () => {
          // ‚ö° TOUJOURS forcer le dashboard au chargement/refresh (comme apppc et apppc coach)
          location.hash = '#/dashboard';
          this.loadPage('dashboard');

          // Initialiser l'ic√¥ne s√©lectionn√©e au chargement
          setTimeout(() => {
            if (typeof setActiveNavIcon === 'function') {
              setActiveNavIcon('dashboard');
            }
          }, 300);
        };

        checkGuideAndLoadInitialPage();

        // √âcouter les messages de connexion Gmail (pour popup)
        window.addEventListener('message', (event) => {
          if (event.data && event.data.type === 'gmail_connected') {
            console.log('[APPPC] Gmail connected via postMessage');
            this.loadPage('connection');
            location.hash = '#/connection';
          }
          // √âcouter les messages de mise √† jour du badge employ√©s
          if (event.data && event.data.type === 'updateEmployesBadge') {
            console.log('[APPPC Direction] Mise √† jour badge employ√©s via postMessage');
            loadEmployesEnAttenteCount();
          }
          // √âcouter les messages de mise √† jour du badge inactivations comptable
          if (event.data && event.data.type === 'updateInactivationsComptableBadge') {
            console.log('[APPPC Direction] Mise √† jour badge inactivations via postMessage');
            loadEmployesEnAttenteCount(); // Le badge employ√©s inclut aussi les inactivations c√¥t√© Direction
          }
          // √âcouter les messages de mise √† jour du badge facturation
          if (event.data && event.data.type === 'updateFacturationBadge') {
            console.log('[APPPC Direction] Mise √† jour badge facturation via postMessage');
            loadFacturationEnAttenteCount();
          }
          // √âcouter les messages de mise √† jour du badge remboursements
          if (event.data && event.data.type === 'UPDATE_REMBOURSEMENT_NOTIFICATIONS') {
            console.log('[APPPC Direction] Mise √† jour badge remboursements via postMessage');
            loadFacturationEnAttenteCount();
          }
          // √âcouter les messages de r√©solution de plaintes
          if (event.data && event.data.type === 'plainte-resolved') {
            console.log('[APPPC Direction] Plainte r√©solue - mise √† jour du badge');
            loadPlaintesCount();
          }
        });

        // V√©rifier p√©riodiquement localStorage pour d√©tection de connexion Gmail (pour PWA)
        setInterval(() => {
          const gmailConnected = localStorage.getItem('gmail_connected');
          if (gmailConnected) {
            console.log('[APPPC] Gmail connected via localStorage');
            localStorage.removeItem('gmail_connected');
            this.loadPage('connection');
            location.hash = '#/connection';
          }
        }, 500);
      }
    };

    // ‚ö° Exposer le router √† window pour que les iframes puissent y acc√©der
    window.router = router;

    // ================================================================
    // FONCTIONS UTILITAIRES
    // ================================================================

    // Fonction pour cacher les scrollbars dans une iframe (sur mobile uniquement)
    function hideScrollbarsInIframe(iframe) {
      if (window.innerWidth > 768) return; // Seulement sur mobile

      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

        // Cr√©er un style tag pour cacher les scrollbars
        const style = iframeDoc.createElement('style');
        style.textContent = `
          /* Cacher les scrollbars sur mobile */
          * {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
          }

          *::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
          }

          html, body {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
          }

          html::-webkit-scrollbar,
          body::-webkit-scrollbar {
            display: none !important;
          }
        `;

        iframeDoc.head.appendChild(style);
        console.log('[APPPC] Scrollbars cach√©es dans iframe');
      } catch (e) {
        console.warn('[APPPC] Impossible de modifier iframe (cross-origin):', e.message);
      }
    }

    // Navigation programmatique
    function navigateTo(page) {
      location.hash = `#/${page}`;
      toggleAccountDropdown(); // Fermer le dropdown
    }

    // Toggle dropdown compte
    function toggleAccountDropdown() {
      const dropdown = document.getElementById('account-dropdown');
      dropdown.classList.toggle('show');
    }

    // Toggle section Gestion
    function toggleGestionSection() {
      const content = document.getElementById('gestion-content');
      const chevron = document.getElementById('gestion-chevron');
      if (content.style.display === 'none' || !content.style.display) {
        content.style.display = 'flex';
        chevron.style.transform = 'rotate(180deg)';
      } else {
        content.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
      }
    }

    // Toggle section Outils
    function toggleOutilsSection() {
      const content = document.getElementById('outils-content');
      const chevron = document.getElementById('outils-chevron');
      if (content.style.display === 'none' || !content.style.display) {
        content.style.display = 'flex';
        chevron.style.transform = 'rotate(180deg)';
      } else {
        content.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
      }
    }

    // Toggle section RPO
    function toggleRPOSection() {
      const content = document.getElementById('rpo-content');
      const chevron = document.getElementById('rpo-chevron');
      if (content.style.display === 'none' || !content.style.display) {
        content.style.display = 'flex';
        chevron.style.transform = 'rotate(180deg)';
      } else {
        content.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
      }
    }

    // Toggle section Gestion Entrepreneur
    function toggleGestionSection() {
      const content = document.getElementById('gestion-content');
      const chevron = document.getElementById('gestion-chevron');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.style.transform = 'rotate(180deg)';
      } else {
        content.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
      }
    }

    // Toggle sidebar mobile
    function toggleMobileSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      sidebar.classList.toggle('mobile-open');
      overlay.classList.toggle('show');
    }

    // Toggle sidebar (ouvrir/fermer)
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      sidebar.classList.toggle('expanded');
      document.body.classList.toggle('sidebar-expanded');
    }

    // Ajouter les cadenas aux √©l√©ments du menu - UNIQUEMENT DANS LE SIDEBAR
    function addLockIconsToDisabledItems() {
      document.querySelectorAll('.sidebar .nav-item').forEach(item => {
        // V√©rifier si l'√©l√©ment n'a pas d√©j√† un cadenas
        if (!item.querySelector('.nav-lock-icon')) {
          const lockIcon = document.createElement('i');
          lockIcon.className = 'fas fa-lock nav-lock-icon';
          item.appendChild(lockIcon);
        }
      });
    }

    // Navigation active state - Style Qwota Lite
    document.addEventListener('DOMContentLoaded', function() {
      // Ajouter les cadenas au chargement
      addLockIconsToDisabledItems();

      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
          const pageName = this.getAttribute('data-page');

          if (pageName) {
            // Update active state
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');
          }
        });
      });
    });

    // Fermer dropdown si clic en dehors
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('account-dropdown');
      const accountBtn = document.querySelector('.account-btn');
      if (!accountBtn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.remove('show');
      }
    });

    // Fonction logout
    function logout() {
      // Supprimer toutes les donn√©es de session
      localStorage.removeItem('username');
      localStorage.removeItem('role');
      localStorage.removeItem('qwotaCredentials'); // Supprimer les credentials "me rappeler de moi"
      localStorage.removeItem('sidebarCollapsed');
      localStorage.removeItem('gmail_connected');

      // Nettoyer tout le localStorage pour une d√©connexion compl√®te
      // localStorage.clear(); // Alternative: tout effacer (comment√© pour garder certaines pr√©f√©rences)

      // Forcer un rechargement complet de la page de login depuis le serveur
      window.location.href = '/login?t=' + new Date().getTime();
    }

    // Charger les infos utilisateur
    async function loadUserInfo() {
      const username = localStorage.getItem('username') || 'Utilisateur';
      const role = 'Direction'; // Toujours "Direction" pour cette page

      // Header PC
      const accountUsername = document.getElementById('account-username');
      const accountRole = document.getElementById('account-role');
      const dropdownUsername = document.getElementById('dropdown-username');
      const dropdownRole = document.getElementById('dropdown-role');

      // Charger pr√©nom et nom depuis l'API
      try {
        const response = await fetch(`/api/user/profile?username=${username}`);
        console.log('Profile API response status:', response.status);

        if (response.ok) {
          const data = await response.json();
          console.log('Profile data:', data);

          if (data.success && data.user) {
            const firstName = data.user.first_name || '';
            const lastName = data.user.last_name || '';
            const displayName = firstName && lastName ? `${firstName} ${lastName}` : username;

            console.log('Display name:', displayName);
            console.log('accountUsername element:', accountUsername);
            console.log('dropdownUsername element:', dropdownUsername);

            // Mettre √† jour les √©l√©ments avec pr√©nom nom
            if (accountUsername) {
              accountUsername.textContent = displayName;
              console.log('Updated accountUsername to:', displayName);
            }
            if (dropdownUsername) {
              dropdownUsername.textContent = displayName;
              console.log('Updated dropdownUsername to:', displayName);
            }
          } else {
            // Fallback au username si pas de donn√©es
            console.log('No user data in response, using username');
            if (accountUsername) accountUsername.textContent = username;
            if (dropdownUsername) dropdownUsername.textContent = username;
          }
        } else {
          // Fallback au username en cas d'erreur
          console.log('Response not OK, using username');
          if (accountUsername) accountUsername.textContent = username;
          if (dropdownUsername) dropdownUsername.textContent = username;
        }
      } catch (error) {
        console.error('Error loading user profile:', error);
        // Fallback au username en cas d'erreur
        if (accountUsername) accountUsername.textContent = username;
        if (dropdownUsername) dropdownUsername.textContent = username;
      }

      // D√©finir le r√¥le (reste inchang√©)
      if (accountRole) accountRole.textContent = role;
      if (dropdownRole) dropdownRole.textContent = role;

      // Mobile header
      const mobileUsername = document.getElementById('mobile-username');
      const mobileRole = document.getElementById('mobile-role');

      if (mobileUsername) mobileUsername.textContent = username;
      if (mobileRole) mobileRole.textContent = role;

      // Charger la photo de profil pour le dropdown et le header
      loadProfilePhotoForHeader(username);

      // Charger les donn√©es de gamification
      loadGamificationData(username);
    }

    // Fonction pour charger la photo de profil dans le header et dropdown
    async function loadProfilePhotoForHeader(username) {
      try {
        const response = await fetch(`/api/get-profile-photo/${username}`);
        if (response.ok) {
          const data = await response.json();
          if (data.photoUrl) {
            // Mettre √† jour l'avatar du header
            const accountAvatar = document.querySelector('.account-avatar');
            if (accountAvatar) {
              accountAvatar.innerHTML = `<img src="${data.photoUrl}" alt="Photo de profil">`;
              accountAvatar.classList.add('has-photo');
            }

            // Mettre √† jour l'avatar du dropdown
            const dropdownAvatar = document.getElementById('dropdown-avatar');
            if (dropdownAvatar) {
              dropdownAvatar.innerHTML = `<img src="${data.photoUrl}" alt="Photo de profil">`;
            }
          }
        }
      } catch (error) {
        console.log('Aucune photo de profil trouv√©e pour le header');
      }

      // FORCER la mise √† jour du nom apr√®s le chargement de la photo
      // Car quelque chose semble √©craser le nom
      // Utiliser setTimeout pour s'assurer que la mise √† jour se fait APRES tout le reste
      try {
        const profileResponse = await fetch(`/api/user/profile?username=${username}`);
        if (profileResponse.ok) {
          const profileData = await profileResponse.json();
          if (profileData.success && profileData.user) {
            const firstName = profileData.user.first_name || '';
            const lastName = profileData.user.last_name || '';
            const displayName = firstName && lastName ? `${firstName} ${lastName}` : username;

            // Utiliser setTimeout pour forcer la mise √† jour APR√àS tous les autres scripts
            setTimeout(() => {
              const accountUsername = document.getElementById('account-username');
              const dropdownUsername = document.getElementById('dropdown-username');

              if (accountUsername) {
                accountUsername.textContent = displayName;
                console.log('FORCED update (with setTimeout) of accountUsername to:', displayName);
              }
              if (dropdownUsername) {
                dropdownUsername.textContent = displayName;
                console.log('FORCED update (with setTimeout) of dropdownUsername to:', displayName);
              }
            }, 500); // Attendre 500ms pour que tout soit charg√©
          }
        }
      } catch (error) {
        console.error('Error forcing name update:', error);
      }
    }

    // Charger les donn√©es de gamification
    // Variable globale pour stocker les donn√©es gamification
    let globalGamificationData = null;

    async function loadGamificationData(username) {
      try {
        const response = await fetch(`/api/gamification/profile/${username}`);
        const data = await response.json();

        if (data.status === 'success' && data.profile) {
          const profile = data.profile;
          globalGamificationData = profile; // Stocker globalement

          const gradeImageMap = {
            'D√©marrage': 'https://i.ibb.co/v6PRQ6RX/2.png',
            'Apprenti': 'https://i.ibb.co/CpT20JQK/3.png',
            'Pilier': 'https://i.ibb.co/ksw5bZnH/4.png',
            'Expert': 'https://i.ibb.co/HfDN4YV2/5.png',
            'Ma√Ætre': 'https://i.ibb.co/YTbb1Bpw/6.png',
            'H√©ros': 'https://i.ibb.co/q322mLQd/8.png',
            'Prestige': 'https://i.ibb.co/k2fNLV6S/9.png'
          };

          // Grades levels
          const gradeLevels = [
            { name: 'D√©marrage', minLevel: 1, maxLevel: 1 },
            { name: 'Apprenti', minLevel: 2, maxLevel: 10 },
            { name: 'Pilier', minLevel: 11, maxLevel: 30 },
            { name: 'Expert', minLevel: 31, maxLevel: 50 },
            { name: 'Ma√Ætre', minLevel: 51, maxLevel: 75 },
            { name: 'H√©ros', minLevel: 76, maxLevel: 90 },
            { name: 'Prestige', minLevel: 91, maxLevel: 100 }
          ];

          // Direction n'a pas de contour de grade sur l'avatar

          // Mettre √† jour la barre XP du header
          const xpFill = document.getElementById('account-xp-fill');
          if (xpFill) {
            xpFill.style.width = `${profile.progress_percentage}%`;
          }

          // Mettre √† jour le niveau dans le header
          const levelText = document.getElementById('account-level-text');
          if (levelText && profile.level) {
            levelText.textContent = `Niv. ${profile.level}`;
          }

          // Mettre √† jour le badge de grade dans le dropdown
          const dropdownGradeBadge = document.getElementById('dropdown-grade-badge');
          if (dropdownGradeBadge && profile.category) {
            const gradeImage = gradeImageMap[profile.category];
            if (gradeImage) {
              dropdownGradeBadge.src = gradeImage;
            }
          }
        }
      } catch (error) {
        console.error('Erreur chargement gamification:', error);
      }
    }

    // === FONCTIONS MODAL STATISTIQUES ===

    async function openStatsModal(username = null) {
      const modal = document.getElementById('stats-modal');
      if (!modal) return;

      // Si aucun username fourni, utiliser l'utilisateur connect√©
      const targetUsername = username || localStorage.getItem('username');

      // Charger les donn√©es de gamification pour l'utilisateur cible
      try {
        const response = await fetch(`/api/gamification/profile/${targetUsername}`);
        const data = await response.json();

        if (data.status === 'success') {
          modal.classList.add('active');
          populateStatsModal(data.profile, targetUsername);
        } else {
          alert('Erreur lors du chargement du profil');
        }
      } catch (error) {
        console.error('Erreur chargement profil:', error);
        alert('Erreur lors du chargement du profil');
      }
    }

    function closeStatsModal() {
      const modal = document.getElementById('stats-modal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // Toggle badges section (expand/collapse)
    function toggleBadgesSection() {
      const badgesGrid = document.getElementById('stats-badges-grid');
      const expandBtn = document.getElementById('badges-expand-btn');
      const expandText = document.getElementById('badges-expand-text');
      const expandIcon = document.getElementById('badges-expand-icon');

      if (badgesGrid.classList.contains('show')) {
        // Collapse: cacher les sections par raret√© (top 5 reste visible)
        badgesGrid.classList.remove('show');
        expandBtn.classList.remove('expanded');
        expandText.textContent = 'Voir tous';
        expandIcon.classList.remove('fa-chevron-up');
        expandIcon.classList.add('fa-chevron-down');
      } else {
        // Expand: montrer toutes les sections par raret√© (top 5 reste visible)
        badgesGrid.classList.add('show');
        expandBtn.classList.add('expanded');
        expandText.textContent = 'R√©duire';
        expandIcon.classList.remove('fa-chevron-down');
        expandIcon.classList.add('fa-chevron-up');
      }
    }

    async function populateStatsModal(profile, targetUsername = null) {
      // Utiliser le username pass√© en param√®tre ou celui du localStorage
      const username = targetUsername || localStorage.getItem('username');
      const role = localStorage.getItem('role');

      const gradeImageMap = {
        'D√©marrage': 'https://i.ibb.co/v6PRQ6RX/2.png',
        'Apprenti': 'https://i.ibb.co/CpT20JQK/3.png',
        'Pilier': 'https://i.ibb.co/ksw5bZnH/4.png',
        'Expert': 'https://i.ibb.co/HfDN4YV2/5.png',
        'Ma√Ætre': 'https://i.ibb.co/YTbb1Bpw/6.png',
        'H√©ros': 'https://i.ibb.co/q322mLQd/8.png',
        'Prestige': 'https://i.ibb.co/k2fNLV6S/9.png'
      };

      const gradeLevels = [
        { name: 'D√©marrage', minLevel: 1, maxLevel: 1 },
        { name: 'Apprenti', minLevel: 2, maxLevel: 10 },
        { name: 'Pilier', minLevel: 11, maxLevel: 30 },
        { name: 'Expert', minLevel: 31, maxLevel: 50 },
        { name: 'Ma√Ætre', minLevel: 51, maxLevel: 75 },
        { name: 'H√©ros', minLevel: 76, maxLevel: 90 },
        { name: 'Prestige', minLevel: 91, maxLevel: 100 }
      ];

      // Profil
      document.getElementById('stats-username').textContent = username;

      // Photo de profil
      try {
        const photoResponse = await fetch(`/api/get-profile-photo/${username}`);
        const photoData = await photoResponse.json();
        const statsPhoto = document.getElementById('stats-profile-photo');
        if (photoData.success && photoData.photoUrl) {
          statsPhoto.src = photoData.photoUrl;
        } else {
          const initial = username.charAt(0).toUpperCase();
          statsPhoto.src = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%2360a5fa" width="100" height="100"/><text x="50" y="50" font-size="50" text-anchor="middle" dy=".3em" fill="white">${initial}</text></svg>`;
        }
      } catch (error) {
        console.error('Erreur photo:', error);
      }

      // Nom du grade dans la section du haut
      document.getElementById('stats-grade-name-display').textContent = profile.category;

      // Niveau sur le badge photo
      document.getElementById('stats-photo-level-text').textContent = profile.level;

      // Direction n'a pas de contour de grade sur la photo

      // XP
      document.getElementById('stats-xp-current').textContent = profile.xp_progress;
      document.getElementById('stats-xp-next').textContent = profile.xp_for_next_level;
      document.getElementById('stats-xp-fill').style.width = `${profile.progress_percentage}%`;
      document.getElementById('stats-xp-percentage').textContent = `${Math.round(profile.progress_percentage)}%`;

      // Progression vers prochain grade
      const currentLevel = profile.level;
      const currentGradeIndex = gradeLevels.findIndex(g => currentLevel >= g.minLevel && currentLevel <= g.maxLevel);
      const currentGrade = gradeLevels[currentGradeIndex];

      if (currentGrade) {
        document.getElementById('stats-current-grade-badge').src = gradeImageMap[currentGrade.name];

        if (currentGrade.name === 'Prestige') {
          document.getElementById('stats-current-level-text').textContent = `Niv ${currentLevel}`;
          document.getElementById('stats-next-level-text').innerHTML = '<span style="color: var(--primary-gold);">Max</span>';
          document.getElementById('stats-next-grade-fill').style.width = '100%';
          document.getElementById('stats-next-grade-badge').src = gradeImageMap['Prestige'];
        } else {
          const nextGrade = gradeLevels[currentGradeIndex + 1];
          const nextGradeLevel = nextGrade.minLevel;

          document.getElementById('stats-next-grade-badge').src = gradeImageMap[nextGrade.name];
          document.getElementById('stats-current-level-text').textContent = `Niv ${currentLevel}`;
          document.getElementById('stats-next-level-text').textContent = `Niv ${nextGradeLevel}`;

          const levelsInCurrentGrade = currentGrade.maxLevel - currentGrade.minLevel + 1;
          const levelProgress = currentLevel - currentGrade.minLevel;
          const progressPercentage = (levelProgress / levelsInCurrentGrade) * 100;
          document.getElementById('stats-next-grade-fill').style.width = `${progressPercentage}%`;
        }
      }

      // Stats principales
      document.getElementById('stats-total-xp').textContent = profile.total_xp || 0;
      document.getElementById('stats-badges').textContent = profile.badges_count || 0;

      // Stats Business - Fetch from /api/entrepreneurs
      try {
        const entrepreneurResponse = await fetch('/api/entrepreneurs');
        if (entrepreneurResponse.ok) {
          const entrepreneurs = await entrepreneurResponse.json();
          const currentEntrepreneur = entrepreneurs.find(e => e.username === username);

          if (currentEntrepreneur) {
            // CA Actuel
            document.getElementById('stats-ca-actuel').textContent = `${(currentEntrepreneur.ca_actuel || 0).toLocaleString()} $`;

            // Contrats sign√©s
            document.getElementById('stats-contrats-signes').textContent = currentEntrepreneur.soumissions_signees || 0;

            // Satisfaction
            document.getElementById('stats-satisfaction').textContent = (currentEntrepreneur.etoiles || 0).toFixed(1);

            // Contrat moyen
            document.getElementById('stats-contrat-moyen').textContent = `${(currentEntrepreneur.contrat_moyen || 0).toLocaleString()} $`;

            // Taux marketing
            document.getElementById('stats-taux-marketing').textContent = `${(currentEntrepreneur.taux_marketing || 0).toFixed(2)}`;

            // Taux de vente
            document.getElementById('stats-taux-vente').textContent = `${Math.round((currentEntrepreneur.taux_vente || 0) * 10) / 10}%`;

            // Productivit√© horaire
            document.getElementById('stats-prod-horaire').textContent = `${(currentEntrepreneur.prod_horaire || 0).toLocaleString()} $/h`;

            // Heures de P√ÄP
            document.getElementById('stats-heures-pap').textContent = `${(currentEntrepreneur.heures_pap || 0).toFixed(1)} h`;
          } else {
            // Utilisateur non trouv√©, mettre des valeurs par d√©faut
            document.getElementById('stats-ca-actuel').textContent = '0 $';
            document.getElementById('stats-contrats-signes').textContent = '0';
            document.getElementById('stats-satisfaction').textContent = '0.0';
            document.getElementById('stats-contrat-moyen').textContent = '0 $';
            document.getElementById('stats-taux-marketing').textContent = '0%';
            document.getElementById('stats-taux-vente').textContent = '0%';
            document.getElementById('stats-prod-horaire').textContent = '0 $/h';
            document.getElementById('stats-heures-pap').textContent = '0.0 h';
          }
        }
      } catch (error) {
        console.error('Erreur chargement stats business:', error);
        // En cas d'erreur, mettre des valeurs par d√©faut
        document.getElementById('stats-ca-actuel').textContent = '0 $';
        document.getElementById('stats-contrats-signes').textContent = '0';
        document.getElementById('stats-satisfaction').textContent = '0.0';
        document.getElementById('stats-contrat-moyen').textContent = '0 $';
        document.getElementById('stats-taux-marketing').textContent = '0%';
        document.getElementById('stats-taux-vente').textContent = '0%';
        document.getElementById('stats-prod-horaire').textContent = '0 $/h';
        document.getElementById('stats-heures-pap').textContent = '0.0 h';
      }

      // Charger les badges obtenus - Utiliser le bon endpoint
      try {
        const badgesResponse = await fetch(`/api/gamification/badges/user/${username}`);
        if (badgesResponse.ok) {
          const badgesData = await badgesResponse.json();
          const badgesGrid = document.getElementById('stats-badges-grid');

          console.log('Badges response:', badgesData);

          let badges = [];

          // Format attendu: {status: 'success', badges: [...]}
          if (badgesData.badges && Array.isArray(badgesData.badges)) {
            badges = badgesData.badges;
          } else if (Array.isArray(badgesData)) {
            badges = badgesData;
          }

          console.log('Badges trouv√©s:', badges.length);
          if (badges.length > 0) {
            console.log('Premier badge:', badges[0]);
          }

          if (badges.length > 0) {
            // Fonction helper pour cr√©er un badge item
            const createBadgeItem = (badge, showRarity = false) => {
              const badgeItem = document.createElement('div');
              badgeItem.className = 'badge-item';

              const imageUrl = badge.image_url || badge.icon_url || '';
              const emoji = badge.image || badge.icon || badge.emoji || '';
              const badgeName = badge.name || badge.badge_name || badge.title || 'Badge';
              const rarity = badge.rarity || badge.rarete || 'Commun';
              const description = badge.description || 'Aucune description disponible';
              const xpBonus = badge.xp_bonus || badge.xp || 0;
              const badgeCount = badge.count || 1;

              // PRIORISER image_url (PNG) sur icon (emoji) - M√äME LOGIQUE QUE GAMIFICATION.HTML
              let imageHTML = '';
              if (imageUrl && typeof imageUrl === 'string' && (imageUrl.startsWith('http') || imageUrl.startsWith('/static/'))) {
                // Priorit√© 1: PNG/URL dans image_url (externe ou local)
                imageHTML = `<img src="${imageUrl}" alt="${badgeName}" class="badge-image">`;
              } else if (emoji && typeof emoji === 'string' && (emoji.startsWith('http') || emoji.startsWith('/static/'))) {
                // Priorit√© 2: URL ou chemin local dans le champ icon/emoji
                imageHTML = `<img src="${emoji}" alt="${badgeName}" class="badge-image">`;
              } else if (emoji && typeof emoji === 'string' && emoji.endsWith('.png')) {
                // Priorit√© 3: Fichier PNG sans pr√©fixe /static/
                imageHTML = `<img src="/static/badges/${emoji}" alt="${badgeName}" class="badge-image">`;
              } else if (emoji && typeof emoji === 'string') {
                // Priorit√© 4: Emoji (texte/unicode)
                imageHTML = `<div class="badge-emoji">${emoji}</div>`;
              } else {
                // Fallback: pas d'image disponible
                imageHTML = `<div class="badge-emoji">üèÖ</div>`;
              }

              // Normaliser la raret√© pour la classe CSS
              const rarityClass = rarity.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]/g, '-');

              const rarityHTML = showRarity ? `<div class="badge-rarity ${rarityClass}">${rarity}</div>` : '';
              const countHTML = badgeCount > 1 ? `<div class="badge-count">x${badgeCount}</div>` : '';

              badgeItem.innerHTML = `
                ${countHTML}
                ${imageHTML}
                ${rarityHTML}
                <div class="badge-info-icon">
                  <i class="fas fa-info"></i>
                  <div class="badge-tooltip">
                    <div class="tooltip-title">${badgeName}</div>
                    <div class="tooltip-description">${description}</div>
                  </div>
                </div>
              `;
              return badgeItem;
            };

            // Grouper les badges par raret√© - M√äME ORDRE QUE GAMIFICATION.HTML
            const rarityOrderDisplay = ['Commun', 'Rare', 'L√©gendaire', 'Mythique', '√âpique', 'Anti-Badge'];
            const rarityOrderTop5 = ['Mythique', '√âpique', 'L√©gendaire', 'Rare', 'Commun']; // Pour TOP 5 (meilleurs d'abord)
            const badgesByRarity = {};

            // Initialiser les cat√©gories
            rarityOrderDisplay.forEach(r => badgesByRarity[r] = []);

            // Grouper les badges
            badges.forEach(badge => {
              const rarity = badge.rarity || badge.rarete || 'Commun';
              if (!badgesByRarity[rarity]) {
                badgesByRarity[rarity] = [];
              }
              badgesByRarity[rarity].push(badge);
            });

            // === TOP 5 MEILLEURS BADGES (par raret√© - du meilleur au pire) ===
            const topBadgesContainer = document.getElementById('stats-badges-top');
            topBadgesContainer.innerHTML = '';

            const topBadges = [];
            rarityOrderTop5.forEach(rarity => {
              const rarityBadges = badgesByRarity[rarity];
              if (rarityBadges && rarityBadges.length > 0) {
                topBadges.push(...rarityBadges);
              }
            });

            // Prendre les 5 premiers (les plus rares)
            const top5 = topBadges.slice(0, 5);
            if (top5.length > 0) {
              top5.forEach(badge => {
                topBadgesContainer.appendChild(createBadgeItem(badge, true)); // Afficher la raret√©
              });
            } else {
              topBadgesContainer.innerHTML = '<div class="no-badges-message">Aucun badge</div>';
            }

            // === TOUS LES BADGES PAR RARET√â (cach√© par d√©faut) - DU PIRE AU MEILLEUR ===
            badgesGrid.innerHTML = '';

            rarityOrderDisplay.forEach(rarity => {
              const rarityBadges = badgesByRarity[rarity];
              if (rarityBadges && rarityBadges.length > 0) {
                // TRIER PAR COUNT (du plus grand au plus petit: x4, x3, x2, x1)
                const sortedBadges = rarityBadges.sort((a, b) => {
                  const countA = a.count || 1;
                  const countB = b.count || 1;
                  return countB - countA; // Ordre d√©croissant
                });

                const rarityClass = rarity.toLowerCase()
                  .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                  .replace(/[^a-z0-9]/g, '-');

                const raritySection = document.createElement('div');
                raritySection.className = 'rarity-section';

                const rarityTitle = document.createElement('div');
                rarityTitle.className = 'rarity-section-title';
                rarityTitle.innerHTML = `
                  <span class="badge-rarity ${rarityClass}">${rarity}</span>
                  <span class="rarity-badge-count">${sortedBadges.length}</span>
                `;
                raritySection.appendChild(rarityTitle);

                const scrollContainer = document.createElement('div');
                scrollContainer.className = 'badges-horizontal-scroll';

                sortedBadges.forEach(badge => {
                  scrollContainer.appendChild(createBadgeItem(badge));
                });

                raritySection.appendChild(scrollContainer);
                badgesGrid.appendChild(raritySection);
              }
            });
          } else {
            document.getElementById('stats-badges-top').innerHTML = '<div class="no-badges-message">Aucun badge obtenu pour le moment</div>';
            badgesGrid.innerHTML = ''; // Laisser vide si aucun badge
          }

          // Activer le drag-to-scroll sur tous les containers horizontaux
          document.querySelectorAll('.badges-horizontal-scroll').forEach(container => {
            let isDown = false;
            let startX;
            let scrollLeft;
            let isDragging = false;

            container.addEventListener('mousedown', (e) => {
              // Ne pas commencer le drag si on clique sur un bouton ou lien
              if (e.target.closest('button') || e.target.closest('a')) return;

              isDown = true;
              isDragging = false;
              container.style.cursor = 'grabbing';
              container.style.userSelect = 'none';
              startX = e.pageX - container.offsetLeft;
              scrollLeft = container.scrollLeft;
            });

            container.addEventListener('mouseleave', () => {
              isDown = false;
              container.style.cursor = 'grab';
              container.style.userSelect = 'auto';
            });

            container.addEventListener('mouseup', (e) => {
              isDown = false;
              container.style.cursor = 'grab';
              container.style.userSelect = 'auto';

              // Emp√™cher le clic si on a drag
              if (isDragging) {
                e.preventDefault();
                e.stopPropagation();
              }
              isDragging = false;
            });

            container.addEventListener('mousemove', (e) => {
              if (!isDown) return;
              e.preventDefault();
              isDragging = true;
              const x = e.pageX - container.offsetLeft;
              const walk = (x - startX) * 1.5; // Vitesse de scroll plus fluide
              container.scrollLeft = scrollLeft - walk;
            });

            // Bloquer les clics sur les badges pendant le drag
            container.addEventListener('click', (e) => {
              if (isDragging) {
                e.preventDefault();
                e.stopPropagation();
              }
            }, true);

            // D√©finir le curseur initial
            container.style.cursor = 'grab';
            container.style.scrollBehavior = 'auto';
          });
        }
      } catch (error) {
        console.error('Erreur chargement badges:', error);
        document.getElementById('stats-badges-grid').innerHTML = '<div class="no-badges-message">Erreur de chargement des badges</div>';
      }
    }

    // Fermer le modal en cliquant sur le fond
    document.addEventListener('click', (e) => {
      const modal = document.getElementById('stats-modal');
      if (e.target === modal) {
        closeStatsModal();
      }
    });

    // ================================================================
    // MOBILE PROFILE MENU
    // ================================================================

    // Toggle mobile profile dropdown
    function toggleMobileProfileMenu() {
      const dropdown = document.getElementById('mobile-profile-dropdown');
      if (dropdown) {
        dropdown.classList.toggle('hidden');
        dropdown.classList.toggle('show');
      }
    }

    // Fermer le dropdown mobile si on clique ailleurs
    document.addEventListener('click', function(event) {
      const container = document.querySelector('.mobile-profile-container');
      const dropdown = document.getElementById('mobile-profile-dropdown');

      if (container && dropdown && !container.contains(event.target)) {
        dropdown.classList.add('hidden');
        dropdown.classList.remove('show');
      }
    });

    // ================================================================
    // BOTTOM NAVIGATION ANIMATIONS - Exact comme app-shell.html
    // ================================================================

    // Variable pour tracker l'ic√¥ne s√©lectionn√©e
    if (typeof window.selectedIcon === 'undefined') {
      window.selectedIcon = null;
    }

    // Fonction pour s√©lectionner une ic√¥ne avec animations
    function selectIcon(iconNumber, title) {
      window.selectedIcon = iconNumber;

      // Donn√©es des ic√¥nes
      const icons = [
        { id: 1, title: 'RPO' },
        { id: 2, title: 'Travaux' },
        { id: 3, title: 'Dashboard' },
        { id: 4, title: 'Outils' },
        { id: 5, title: 'Gestions' }
      ];

      // Trouver les conteneurs des ic√¥nes
      const containers = document.querySelectorAll('.case-container');
      const iconContainers = document.querySelectorAll('.icon-container');
      const iconElements = document.querySelectorAll('.icon-container i');
      const titleElements = document.querySelectorAll('.icon-title');

      containers.forEach((container, index) => {
        const iconId = index + 1;
        const isSelected = iconId === window.selectedIcon;
        const iconContainer = iconContainers[index];
        const iconElement = iconElements[index];

        // Animer le conteneur de la case
        if (isSelected) {
          container.className = 'flex-2 case-container flex flex-col justify-center items-center h-full';
        } else {
          container.className = 'flex-1 case-container flex justify-center items-center h-full';
        }

        // Animer l'ic√¥ne avec transform
        if (isSelected) {
          iconContainer.classList.add('selected');
          iconContainer.classList.remove('shadow-lg');
          iconContainer.classList.add('shadow-xl');
          iconElement.classList.remove('text-sm');
          iconElement.classList.add('text-xl');
        } else {
          iconContainer.classList.remove('selected');
          iconContainer.classList.remove('shadow-xl');
          iconContainer.classList.add('shadow-lg');
          iconElement.classList.remove('text-xl');
          iconElement.classList.add('text-sm');
        }
      });

      // G√©rer les titres
      titleElements.forEach(title => title.remove());

      // Ajouter le nouveau titre pour l'ic√¥ne s√©lectionn√©e
      const selectedContainer = containers[iconNumber - 1];
      if (selectedContainer) {
        const titleSpan = document.createElement('span');
        titleSpan.className = 'text-xs font-medium mt-1 icon-title show';
        titleSpan.style.color = '#ffffff';
        titleSpan.textContent = icons[iconNumber - 1].title;
        selectedContainer.appendChild(titleSpan);
      }

      console.log(`Ic√¥ne ${iconNumber} s√©lectionn√©e: ${icons[iconNumber - 1].title}`);
    }

    // Fonction pour d√©s√©lectionner toutes les ic√¥nes
    function deselectAllIcons() {
      const iconContainers = document.querySelectorAll('.icon-container');
      const containers = document.querySelectorAll('.case-container');
      const iconElements = document.querySelectorAll('.icon-container i');
      const titleElements = document.querySelectorAll('.icon-title');

      iconContainers.forEach((iconContainer) => {
        iconContainer.classList.remove('selected');
        iconContainer.classList.remove('shadow-xl');
        iconContainer.classList.add('shadow-lg');
        iconContainer.style.transform = '';
      });

      containers.forEach((container) => {
        container.className = 'flex-1 case-container flex justify-center items-center h-full';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
      });

      iconElements.forEach((iconElement) => {
        iconElement.classList.remove('text-xl');
        iconElement.classList.add('text-sm');
      });

      titleElements.forEach(title => title.remove());
      window.selectedIcon = null;

      console.log('Toutes les ic√¥nes d√©s√©lectionn√©es');
    }

    // Fonction pour mapper les pages aux ic√¥nes
    function setActiveNavIcon(page) {
      const pageMapping = {
        'rpo': 1,
        'travaux': 2,
        'dashboard': 3,
        'outils': 4,
        'gestions': 5
      };

      // Pages qui ne correspondent √† aucune ic√¥ne de navigation
      const noIconPages = ['connection', 'login'];

      if (noIconPages.includes(page)) {
        deselectAllIcons();
        return;
      }

      const iconNumber = pageMapping[page] || 3;
      const titles = ['RPO', 'Travaux', 'Dashboard', 'Calcul', 'Soumissions'];
      selectIcon(iconNumber, titles[iconNumber - 1]);
    }

    // ================================================================
    // TOOLTIP PERSONNALISE POUR MENU
    // ================================================================

    function initMenuTooltips() {
      // Les tooltips sont maintenant g√©r√©s par CSS uniquement (style Qwota Lite)
      // Cette fonction reste pour compatibilit√© mais ne fait rien
    }

    // Fonction pour charger le compteur d'employ√©s en attente pour Gestion Entrepreneur
    // Utilise la m√™me logique que coach: compte "En attente de validation" pour tous les entrepreneurs
    async function loadEmployesEnAttenteCount() {
      try {
        // Utiliser l'API entrepreneurs qui retourne les counts pour tous
        const response = await fetch('/api/users/entrepreneurs');

        if (response.ok) {
          const data = await response.json();
          let totalCountCoach = 0;
          let totalCountComptable = 0;

          if (data.entrepreneurs) {
            data.entrepreneurs.forEach(entrepreneur => {
              totalCountCoach += entrepreneur.pending_employes_count || 0;
              totalCountComptable += entrepreneur.pending_employes_comptable_count || 0;
            });
          }

          // Mettre √† jour le badge Gestion Entrepreneur (statuts coach: En attente de validation)
          const badgeGestion = document.getElementById('employes-notification-badge-gestion');
          if (badgeGestion) {
            if (totalCountCoach > 0) {
              badgeGestion.textContent = totalCountCoach;
              badgeGestion.style.display = 'inline-flex';
            } else {
              badgeGestion.style.display = 'none';
            }
          }

          // Mettre √† jour le badge Gestion Comptable (statuts comptable: En attente comptable)
          const badgeComptable = document.getElementById('employes-notification-badge');
          if (badgeComptable) {
            if (totalCountComptable > 0) {
              badgeComptable.textContent = totalCountComptable;
              badgeComptable.style.display = 'inline-flex';
            } else {
              badgeComptable.style.display = 'none';
            }
          }
        }
      } catch (error) {
        console.error('Erreur chargement compteur employ√©s:', error);
      }
    }

    // Fonction pour charger le compteur de plaintes non r√©gl√©es (pour direction)
    async function loadPlaintesCount() {
      try {
        const response = await fetch('/api/plaintes/count/all');

        if (response.ok) {
          const data = await response.json();
          const count = data.count || 0;

          // Mettre √† jour les deux badges (principal et gestion)
          const badges = [
            document.getElementById('plaintes-notification-badge'),
            document.getElementById('plaintes-notification-badge-gestion')
          ];

          badges.forEach(badge => {
            if (badge) {
              if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-flex';
              } else {
                badge.style.display = 'none';
              }
            }
          });
        }
      } catch (error) {
        console.error('Erreur chargement compteur plaintes:', error);
      }
    }

    // Fonction pour charger le compteur de facturations en attente pour Gestion Entrepreneur et Gestion Comptable
    // Gestion Entrepreneur: compte "traitement" (pareil que coach)
    // Gestion Comptable: compte "attente_comptable"
    async function loadFacturationEnAttenteCount() {
      try {
        // Utiliser l'API entrepreneurs qui retourne les counts pour tous
        const response = await fetch('/api/users/entrepreneurs');

        if (response.ok) {
          const data = await response.json();
          let totalCountCoach = 0;
          let totalCountComptable = 0;

          if (data.entrepreneurs) {
            data.entrepreneurs.forEach(entrepreneur => {
              totalCountCoach += entrepreneur.pending_facturations_count || 0;
              totalCountComptable += entrepreneur.pending_facturations_comptable_count || 0;
            });
          }

          // Mettre √† jour le badge Gestion Entrepreneur (statuts coach: traitement)
          const badgeGestion = document.getElementById('facturation-notification-badge-gestion');
          if (badgeGestion) {
            if (totalCountCoach > 0) {
              badgeGestion.textContent = totalCountCoach;
              badgeGestion.style.display = 'inline-flex';
            } else {
              badgeGestion.style.display = 'none';
            }
          }

          // Mettre √† jour le badge Gestion Comptable (statuts comptable: attente_comptable)
          const badgeComptable = document.getElementById('facturation-notification-badge');
          if (badgeComptable) {
            if (totalCountComptable > 0) {
              badgeComptable.textContent = totalCountComptable;
              badgeComptable.style.display = 'inline-flex';
            } else {
              badgeComptable.style.display = 'none';
            }
          }
        }
      } catch (error) {
        console.error('Erreur chargement compteur facturation:', error);
      }
    }

    // ================================================================
    // PR√âCHARGEMENT DU PLAN D'AFFAIRES
    // ================================================================

    async function preloadBusinessPlanData() {
      try {
        const username = window.username || localStorage.getItem('username');
        if (!username) return;

        // Pr√©charger les objectifs et m√©triques en parall√®le
        const [objectifsRes, metricsRes] = await Promise.all([
          fetch(`/api/direction/team-objectifs?direction_username=${username}`),
          fetch(`/api/direction/team-metrics?direction_username=${username}`)
        ]);

        const [objectifsData, metricsData] = await Promise.all([
          objectifsRes.json(),
          metricsRes.json()
        ]);

        // Stocker en cache pour acc√®s rapide dans le RPO
        if (objectifsData.success) {
          sessionStorage.setItem('cached_direction_objectifs', JSON.stringify(objectifsData));
        }
        if (metricsData.success) {
          sessionStorage.setItem('cached_direction_metrics', JSON.stringify(metricsData));
        }

      } catch (error) {
        // Ignorer les erreurs de pr√©chargement
      }
    }

    // ================================================================
    // INITIALISATION
    // ================================================================

    document.addEventListener('DOMContentLoaded', () => {
      router.init();
      loadUserInfo();
      initMenuTooltips();

      // Charger le compteur d'employ√©s en attente pour la direction
      loadEmployesEnAttenteCount();

      // Charger le compteur de facturations en attente pour la direction
      loadFacturationEnAttenteCount();

      // Charger le compteur de plaintes non r√©gl√©es pour la direction
      loadPlaintesCount();

      // √âcouter les messages des iframes pour mise √† jour instantan√©e du badge plaintes
      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'plainte-resolved') {
          console.log('[APPPC DIRECTION] Plainte r√©solue - mise √† jour du badge');
          loadPlaintesCount();
        }
      });

      // Heartbeat pour tracker les utilisateurs en ligne
      function sendHeartbeat() {
        const username = window.username || localStorage.getItem('username');
        if (username) {
          fetch('/api/users/heartbeat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username })
          }).catch(() => {});
        }
      }
      sendHeartbeat();
      setInterval(sendHeartbeat, 15000);

      // D√©connexion imm√©diate quand l'utilisateur quitte la page
      window.addEventListener('beforeunload', () => {
        const username = window.username || localStorage.getItem('username');
        if (username) {
          navigator.sendBeacon('/api/users/disconnect', JSON.stringify({ username }));
        }
      });

      // PR√âCHARGER les donn√©es du plan d'affaires pour que le RPO se charge plus vite
      preloadBusinessPlanData();

      console.log('[LAUNCH] Qwota SPA initialized');

      // ================================================================
      // SYST√àME DE CHARGEMENT - Desktop & Mobile
      // ================================================================

      // DESKTOP: Pr√©charger TOUTES les pages avant de cacher l'√©cran de chargement
      if (window.innerWidth > 768) {
        console.log('[DESKTOP] üöÄ D√âMARRAGE DU PR√âCHARGEMENT COMPLET');

        const loadingOverlay = document.getElementById('loading-overlay');
        const appContainer = document.getElementById('app-container');
        const progressFill = document.getElementById('loading-progress-fill');
        const progressText = document.getElementById('loading-progress-text');

        // Initialiser la progression √† 0%
        if (progressFill) progressFill.style.width = '0%';
        if (progressText) progressText.textContent = '0%';

        // Pages √† pr√©charger pour Direction - TOUTES LES 19 PAGES (ordre de priorit√©)
        const pagesToPreload = [
          // PRIORIT√â 1: Pages principales Direction
          { id: 'iframe-dashboard', url: '/dashboard?dashboardType=qualite-etudiants', name: 'Dashboard', priority: 1 },
          { id: 'iframe-employes', url: '/coach_validation_employes', name: 'Validation Employ√©s', priority: 1 },
          { id: 'iframe-direction-facturation', url: '/direction_facturation', name: 'Facturation Direction', priority: 1 },

          // PRIORIT√â 2: RPO et gestion
          { id: 'iframe-rpo', url: '/direction_rpo', name: 'RPO Direction', priority: 2 },
          { id: 'iframe-gestionemployes', url: '/gestionemployes', name: 'Gestion Employ√©s', priority: 2 },
          { id: 'iframe-facturationqe', url: '/facturationqe?page=status', name: 'Facturation QE', priority: 2 },

          // PRIORIT√â 3: Outils
          { id: 'iframe-calcul', url: '/calcul', name: 'Calculateur', priority: 3 },
          { id: 'iframe-soumissions', url: '/soumissions', name: 'Soumissions', priority: 3 },
          { id: 'iframe-gqp', url: '/gqp', name: 'GQP', priority: 3 },
          { id: 'iframe-facture', url: '/facture', name: 'Facture', priority: 3 },

          // PRIORIT√â 4: Param√®tres et autres pages
          { id: 'iframe-connection', url: '/parametredirection', name: 'Param√®tres Direction', priority: 4 },
          { id: 'iframe-centralevue', url: '/centralevue', name: 'Centrale Vue', priority: 4 },
          { id: 'iframe-avis', url: '/avis', name: 'Avis', priority: 4 },
          { id: 'iframe-travaux', url: '/travaux', name: 'Ventes', priority: 4 },

          // PRIORIT√â 4: centraleadmin (page admin accessible via bouton dans centralevue)
          { id: 'iframe-centraleadmin', url: '/centraleadmin', name: 'Centrale Admin', priority: 4 },

          // PRIORIT√â 5: Pages suppl√©mentaires (utilisent page-iframe car pas d'iframe d√©di√©e)
          { useMainIframe: true, url: '/parametreadmin', name: 'Utilisateurs', priority: 5 },
          { useMainIframe: true, url: '/badge_assignment', name: 'Badges', priority: 5 },
          { useMainIframe: true, url: '/coach_rpo', name: 'RPO Coach', priority: 5 },
          { useMainIframe: true, url: '/suivicoach', name: 'Suivi Coach', priority: 5 },
          { useMainIframe: true, url: '/rpo', name: 'RPO Entrepreneur', priority: 5 }
        ];

        let loadedCount = 0;
        const totalPages = pagesToPreload.length;

        console.log(`[DESKTOP] üìã Total de pages √† pr√©charger: ${totalPages} pages`);

        // Fonction pour cacher l'√©cran de chargement
        const hideLoadingScreen = () => {
          console.log('[DESKTOP] üéâ TOUTES LES PAGES PR√âCHARG√âES');
          setTimeout(() => {
            if (loadingOverlay) {
              loadingOverlay.classList.add('hidden');
            }
            if (appContainer) {
              appContainer.classList.add('loaded');
              appContainer.style.opacity = '1';
            }
            console.log('[DESKTOP] ‚úÖ √âcran de chargement masqu√© - app pr√™te');
          }, 500); // D√©lai pour voir 100%
        };

        // Charger les pages par batch (4 √† la fois pour optimiser)
        const BATCH_SIZE = 4;
        let currentBatchIndex = 0;
        let nextBatchScheduled = false; // ‚ö° FLAG pour √©viter les appels multiples

        function loadNextBatch() {
          const startIndex = currentBatchIndex * BATCH_SIZE;
          const endIndex = Math.min(startIndex + BATCH_SIZE, totalPages);

          if (startIndex >= totalPages) {
            console.log(`[DESKTOP] üéâ Pr√©chargement termin√© (${loadedCount}/${totalPages})`);
            hideLoadingScreen();
            return;
          }

          const batch = pagesToPreload.slice(startIndex, endIndex);
          console.log(`[DESKTOP] üì¶ Chargement batch ${currentBatchIndex + 1} (${batch.length} pages)...`);

          let batchCompleted = 0;
          nextBatchScheduled = false; // ‚ö° R√©initialiser le flag pour ce batch

          batch.forEach((page) => {
            // Pour les pages qui utilisent la main iframe (page-iframe)
            if (page.useMainIframe) {
              console.log(`[DESKTOP] ‚è≥ [P${page.priority}]: ${page.name} (main iframe)`);

              const mainIframe = document.getElementById('page-iframe');
              if (mainIframe) {
                // Cr√©er une iframe temporaire pour pr√©charger cette page
                const tempIframe = document.createElement('iframe');
                tempIframe.style.display = 'block';
                tempIframe.style.visibility = 'visible';
                tempIframe.style.position = 'fixed';
                tempIframe.style.top = '-9999px';
                tempIframe.style.left = '-9999px';
                tempIframe.style.zIndex = '-9999';
                tempIframe.style.pointerEvents = 'none';
                document.body.appendChild(tempIframe);

                tempIframe.addEventListener('load', function onPageLoad() {
                  loadedCount++;
                  batchCompleted++;
                  console.log(`[DESKTOP] ‚úì (${loadedCount}/${totalPages}): ${page.name}`);

                  // Mettre √† jour la progression
                  const progress = Math.round((loadedCount / totalPages) * 100);
                  if (progressFill) progressFill.style.width = `${progress}%`;
                  if (progressText) progressText.textContent = `${progress}%`;

                  // Attendre que tous les scripts/CSS se chargent
                  setTimeout(() => {
                    document.body.removeChild(tempIframe);

                    // ‚ö° Charger le prochain batch une seule fois
                    if (batchCompleted === batch.length && !nextBatchScheduled) {
                      nextBatchScheduled = true;
                      currentBatchIndex++;
                      setTimeout(() => loadNextBatch(), 200);
                    }
                  }, 500);
                });

                tempIframe.src = page.url;
              }
            }
            // Pour les pages avec iframe d√©di√©e
            else {
              const iframe = document.getElementById(page.id);

              if (iframe) {
                console.log(`[DESKTOP] ‚è≥ [P${page.priority}]: ${page.name}`);

                // Rendre l'iframe visible mais hors √©cran pour forcer le chargement complet
                iframe.style.display = 'block';
                iframe.style.visibility = 'visible';
                iframe.style.position = 'fixed';
                iframe.style.top = '-9999px';
                iframe.style.left = '-9999px';
                iframe.style.zIndex = '-9999';
                iframe.style.pointerEvents = 'none';

                // Charger la page
                iframe.src = page.url;

                iframe.addEventListener('load', function onPageLoad() {
                  loadedCount++;
                  batchCompleted++;
                  console.log(`[DESKTOP] ‚úì (${loadedCount}/${totalPages}): ${page.name}`);

                  // Mettre √† jour la progression
                  const progress = Math.round((loadedCount / totalPages) * 100);
                  if (progressFill) progressFill.style.width = `${progress}%`;
                  if (progressText) progressText.textContent = `${progress}%`;

                  // Attendre 500ms apr√®s le load pour que tous les scripts/CSS se chargent
                  setTimeout(() => {
                    // Re-cacher l'iframe (elle reste en cache)
                    iframe.style.display = 'none';
                    iframe.style.visibility = '';
                    iframe.style.position = '';
                    iframe.style.top = '';
                    iframe.style.left = '';
                    iframe.style.zIndex = '';
                    iframe.style.pointerEvents = '';

                    // ‚ö° Charger le prochain batch une seule fois
                    if (batchCompleted === batch.length && !nextBatchScheduled) {
                      nextBatchScheduled = true;
                      currentBatchIndex++;
                      setTimeout(() => loadNextBatch(), 200);
                    }
                  }, 500);

                  // Retirer le listener
                  iframe.removeEventListener('load', onPageLoad);
                });
              } else {
                console.error(`[DESKTOP] ‚ùå Iframe non trouv√©e: ${page.id}`);
                batchCompleted++;
                // ‚ö° G√©rer le cas o√π l'iframe n'existe pas
                if (batchCompleted === batch.length && !nextBatchScheduled) {
                  nextBatchScheduled = true;
                  currentBatchIndex++;
                  setTimeout(() => loadNextBatch(), 200);
                }
              }
            }
          });
        }

        // D√©marrer le pr√©chargement
        loadNextBatch();
      }
      // MOBILE: Pr√©charger les pages principales et cacher les scrollbars
      else if (window.innerWidth <= 768) {
        console.log('[MOBILE] üöÄ D√âMARRAGE DU PR√âCHARGEMENT DE TOUTES LES PAGES');
        let loadedPages = 0;

        // Fonction pour mettre √† jour la barre de progression
        const updateLoadingProgress = (loaded, total) => {
          const percentage = Math.round((loaded / total) * 100);
          const progressFill = document.getElementById('loading-progress-fill');
          const progressText = document.getElementById('loading-progress-text');

          if (progressFill && progressText) {
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}%`;
          }
        };

        // Fonction pour masquer l'√©cran de chargement
        const hideLoadingScreen = () => {
          const loadingOverlay = document.getElementById('loading-overlay');
          const appContainer = document.getElementById('app-container');

          if (loadingOverlay) {
            console.log('[DIRECTION] üéâ Masquage de l\'√©cran de chargement');
            setTimeout(() => {
              loadingOverlay.classList.add('hidden');

              // Afficher le conteneur de l'app
              if (appContainer) {
                appContainer.classList.add('loaded');
                appContainer.style.opacity = '1';
              }
            }, 500); // Petit d√©lai pour voir 100%
          }
        };

        // Pages √† pr√©charger sur mobile - ordre prioritaire pour chargement optimal
        const pagesToPreload = [
          // Navigation principale (priorit√© haute)
          { id: 'iframe-outils', url: '/outilsmobile', name: 'Outils Mobile' },
          { id: 'iframe-gestions', url: '/gestionsmobile', name: 'Gestions Mobile' },
          { id: 'iframe-rpo', url: '/rpo', name: 'RPO' },
          { id: 'iframe-travaux', url: '/travaux', name: 'Travaux' },
          { id: 'iframe-centralevue', url: '/centralevue', name: 'Centrale Vue' },
          { id: 'iframe-gamification', url: '/gamification', name: 'Gamification' },
          // Sous-pages Outils (tr√®s utilis√©es - priorit√© haute)
          { id: 'iframe-calcul', url: '/calcul', name: 'Calcul' },
          { id: 'iframe-soumissions', url: '/soumissions', name: 'Cr√©er Soumission' },
          { id: 'iframe-gqp', url: '/gqp', name: 'GQP' },
          { id: 'iframe-facture', url: '/facture', name: 'Facture' },
          // Sous-pages Gestions (priorit√© moyenne)
          { id: 'iframe-gestionemployes', url: '/gestionemployes', name: 'Gestion Employ√©s' },
          { id: 'iframe-facturationqe', url: '/facturationqe?page=status', name: 'Facturation QE' },
          { id: 'iframe-direction-facturation', url: '/direction_facturation', name: 'Direction Facturation' },
          { id: 'iframe-avis', url: '/avis', name: 'Avis' },
          { id: 'iframe-centrale', url: '/centrale', name: 'Centrale' }
        ];

        // Calculer le total (dashboard + toutes les pages)
        const totalPages = 1 + pagesToPreload.length;
        console.log(`[MOBILE] üìã Total de pages √† pr√©charger: ${totalPages} (dashboard + ${pagesToPreload.length} autres)`);

        // Dashboard en premier (page par d√©faut)
        const dashboardIframe = document.getElementById('iframe-dashboard');
        if (dashboardIframe) {
          console.log('[MOBILE] ‚è≥ Chargement de: dashboard');
          dashboardIframe.src = '/dashboard?dashboardType=qualite-etudiants';
          dashboardIframe.style.display = 'block';
          dashboardIframe.addEventListener('load', function() {
            hideScrollbarsInIframe(dashboardIframe);
            loadedPages++;
            updateLoadingProgress(loadedPages, totalPages);
            console.log(`[MOBILE] ‚úÖ Page charg√©e (${loadedPages}/${totalPages}): dashboard`);
            if (loadedPages === totalPages) {
              console.log('[MOBILE] üéâ TOUTES LES PAGES SONT PR√âCHARG√âES ET PR√äTES!');
              hideLoadingScreen();
            }
          });
        }

        pagesToPreload.forEach((page, index) => {
          const iframe = document.getElementById(page.id);
          if (iframe) {
            console.log(`[MOBILE] ‚è≥ Chargement (${index + 1}/${pagesToPreload.length}): ${page.name} (${page.url})`);
            iframe.src = page.url;
            iframe.addEventListener('load', function() {
              hideScrollbarsInIframe(iframe);
              loadedPages++;
              updateLoadingProgress(loadedPages, totalPages);
              console.log(`[MOBILE] ‚úÖ Page charg√©e (${loadedPages}/${totalPages}): ${page.name}`);

              // Quand toutes les pages sont charg√©es
              if (loadedPages === totalPages) {
                console.log('[MOBILE] üéâ TOUTES LES PAGES SONT PR√âCHARG√âES ET PR√äTES!');
                hideLoadingScreen();
              }
            });
          } else {
            console.error(`[MOBILE] ‚ùå Iframe non trouv√©e: ${page.id}`);
          }
        });
      }

      // ===== SWIPE NAVIGATION SUR MOBILE AVEC ANIMATION FLUIDE =====
      if (window.innerWidth <= 768) {
        console.log('[SWIPE] Initialisation de la navigation par swipe avec animation fluide');

        const swipeOverlay = document.getElementById('swipe-overlay');
        const appContent = document.getElementById('app-content');

        if (!swipeOverlay) {
          console.error('[SWIPE] Overlay non trouv√©!');
          return;
        }

        // Ordre des pages pour la navigation par swipe
        const pageOrder = ['rpo', 'travaux', 'dashboard', 'outils', 'gestions'];

        // Variables pour le swipe
        let touchStartX = 0;
        let touchStartY = 0;
        let currentX = 0;
        let isSwiping = false;
        let currentIframe = null;
        let nextIframe = null;
        let swipeDirection = null;
        let touchId = null;

        const swipeThreshold = 30; // Seuil pour valider le swipe (en pixels) - r√©duit pour mobile
        const screenWidth = window.innerWidth;

        const swipeZoneLeft = document.getElementById('swipe-zone-left');
        const swipeZoneRight = document.getElementById('swipe-zone-right');

        // Fonction pour setup une zone
        function setupZone(zone) {
          zone.addEventListener('touchstart', function(e) {
            if (isSwiping) return;

            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            currentX = touchStartX;

            console.log('[SWIPE] üéØ Touch sur zone √† x:', touchStartX.toFixed(0), 'y:', touchStartY.toFixed(0));
          }, { passive: true });

          zone.addEventListener('touchmove', function(e) {
            const touch = e.touches[0];
            currentX = touch.clientX;
            const currentY = touch.clientY;

            const deltaX = currentX - touchStartX;
            const deltaY = currentY - touchStartY;
            const absDeltaX = Math.abs(deltaX);
            const absDeltaY = Math.abs(deltaY);

            // Si pas encore en swipe
            if (!isSwiping) {
              // Si trop vertical, abandonner
              if (absDeltaY > absDeltaX * 1.5) {
                return;
              }

              // Attendre mouvement horizontal
              if (absDeltaX < 25) return;

              // OK, swipe activ√©
              isSwiping = true;
              swipeDirection = deltaX > 0 ? 'right' : 'left';

              console.log('[SWIPE] ‚úÖ Swipe activ√©:', swipeDirection);

              e.preventDefault();

              // ACTIVER l'overlay
              swipeOverlay.classList.add('swiping-active');

              const currentPage = router.currentPage || 'dashboard';
              currentIframe = document.getElementById(`iframe-${currentPage}`);
              const currentIndex = pageOrder.indexOf(currentPage);

              // D√©terminer la page suivante
              let targetPage = null;
              if (swipeDirection === 'right' && currentIndex > 0) {
                targetPage = pageOrder[currentIndex - 1];
              } else if (swipeDirection === 'left' && currentIndex < pageOrder.length - 1) {
                targetPage = pageOrder[currentIndex + 1];
              }

              if (targetPage) {
                nextIframe = document.getElementById(`iframe-${targetPage}`);
                if (nextIframe) {
                  nextIframe.style.display = 'block';
                  if (swipeDirection === 'right') {
                    nextIframe.style.transform = 'translateX(-100%)';
                  } else {
                    nextIframe.style.transform = 'translateX(100%)';
                  }
                }
              }

              // D√©sactiver les transitions
              if (currentIframe) currentIframe.classList.add('swiping');
              if (nextIframe) nextIframe.classList.add('swiping');
            }

            // Animer si swipe actif
            if (isSwiping && nextIframe) {
              e.preventDefault();

              const limitedDeltaX = Math.max(-screenWidth, Math.min(screenWidth, deltaX));

              if (currentIframe) {
                currentIframe.style.transform = `translateX(${limitedDeltaX}px)`;
              }

              if (swipeDirection === 'right') {
                nextIframe.style.transform = `translateX(${-screenWidth + limitedDeltaX}px)`;
              } else {
                nextIframe.style.transform = `translateX(${screenWidth + limitedDeltaX}px)`;
              }
            }
          }, { passive: false });
        }

        // Setup les deux zones
        setupZone(swipeZoneLeft);
        setupZone(swipeZoneRight);

        console.log('[SWIPE] ‚úÖ Zones de swipe 1.25rem activ√©es');

        // L'overlay capture les mouvements SEULEMENT pendant un swipe actif
        swipeOverlay.addEventListener('touchmove', function(e) {
          if (!isSwiping || !nextIframe) return;

          e.preventDefault(); // Bloquer le scroll seulement pendant le swipe

          currentX = e.changedTouches[0].clientX;
          const deltaX = currentX - touchStartX;
          const limitedDeltaX = Math.max(-screenWidth, Math.min(screenWidth, deltaX));

          // D√©placer les pages en suivant le doigt
          if (currentIframe) {
            currentIframe.style.transform = `translateX(${limitedDeltaX}px)`;
          }

          if (swipeDirection === 'right') {
            nextIframe.style.transform = `translateX(${-screenWidth + limitedDeltaX}px)`;
          } else {
            nextIframe.style.transform = `translateX(${screenWidth + limitedDeltaX}px)`;
          }
        }, { passive: false });

        // D√©tecter la fin du touch
        document.addEventListener('touchend', function(e) {
          if (!isSwiping) {
            return;
          }

          // D√âSACTIVER l'overlay
          swipeOverlay.classList.remove('swiping-active');

          const deltaX = currentX - touchStartX;
          const absDeltaX = Math.abs(deltaX);

          // R√©activer les transitions
          if (currentIframe) currentIframe.classList.remove('swiping');
          if (nextIframe) nextIframe.classList.remove('swiping');

          // V√©rifier si le swipe doit √™tre valid√©
          if (absDeltaX > swipeThreshold && nextIframe) {
            // Swipe valid√© - compl√©ter l'animation
            if (currentIframe) {
              if (swipeDirection === 'right') {
                currentIframe.style.transform = 'translateX(100%)';
              } else {
                currentIframe.style.transform = 'translateX(-100%)';
              }
            }

            nextIframe.style.transform = 'translateX(0)';

            // Changer de page apr√®s l'animation
            setTimeout(() => {
              const currentPage = router.currentPage || 'dashboard';
              const currentIndex = pageOrder.indexOf(currentPage);

              let targetPage = null;
              if (swipeDirection === 'right' && currentIndex > 0) {
                targetPage = pageOrder[currentIndex - 1];
              } else if (swipeDirection === 'left' && currentIndex < pageOrder.length - 1) {
                targetPage = pageOrder[currentIndex + 1];
              }

              if (targetPage) {
                // Cacher l'ancienne page
                if (currentIframe) {
                  currentIframe.style.display = 'none';
                  currentIframe.style.transform = 'translateX(0)';
                }

                router.currentPage = targetPage;
                location.hash = `#/${targetPage}`;
                router.updateActiveMenu(targetPage);

                if (typeof setActiveNavIcon === 'function') {
                  setActiveNavIcon(targetPage);
                }
              }
            }, 300);

          } else {
            // Swipe annul√© - revenir √† la position initiale
            if (currentIframe) {
              currentIframe.style.transform = 'translateX(0)';
            }

            if (nextIframe) {
              if (swipeDirection === 'right') {
                nextIframe.style.transform = 'translateX(-100%)';
              } else {
                nextIframe.style.transform = 'translateX(100%)';
              }

              // Capturer nextIframe dans une variable locale pour le setTimeout
              const iframeToHide = nextIframe;

              // Cacher la page suivante apr√®s l'animation
              setTimeout(() => {
                iframeToHide.style.display = 'none';
                iframeToHide.style.transform = 'translateX(0)';
              }, 300);
            }
          }

          // R√©initialiser les √©tats
          isSwiping = false;
          nextIframe = null;
        }, { passive: true });

        console.log('[SWIPE] ‚úÖ Navigation par swipe fluide activ√©e - Pages:', pageOrder.join(' ‚Üí '));
      }
    });

    // ================================================================
    // CHAT SUPPORT - Gestion du chat en temps r√©el
    // ================================================================

    let chatInterval = null;

    // Toggle chat window
    function toggleChatWindow() {
      const chatWindow = document.getElementById('chat-support-window');
      chatWindow.classList.toggle('show');

      if (chatWindow.classList.contains('show')) {
        // Afficher le nom d'utilisateur dans le header
        const username = window.username || localStorage.getItem('username');
        const chatUsernameEl = document.getElementById('chat-username');
        if (chatUsernameEl && username) {
          chatUsernameEl.textContent = username;
        }

        // Charger les messages quand on ouvre le chat
        loadChatMessages();
        // D√©marrer le polling
        if (!chatInterval) {
          chatInterval = setInterval(loadChatMessages, 3000); // Actualiser toutes les 3 secondes
        }
      } else {
        // Arr√™ter le polling quand on ferme
        if (chatInterval) {
          clearInterval(chatInterval);
          chatInterval = null;
        }
      }
    }

    // Charger les messages de l'utilisateur
    async function loadChatMessages() {
      const username = window.username || localStorage.getItem('username');
      if (!username) return;

      try {
        const response = await fetch(`/api/support/messages/${username}`);
        if (response.ok) {
          const data = await response.json();
          displayChatMessages(data.messages);
        }
      } catch (error) {
        console.error('[CHAT] Erreur chargement messages:', error);
      }
    }

    // Afficher les messages dans l'interface
    function displayChatMessages(messages) {
      const chatMessages = document.getElementById('chat-messages');
      chatMessages.innerHTML = '';

      // Si aucun message, afficher le message de bienvenue
      if (messages.length === 0) {
        const welcomeDiv = document.createElement('div');
        welcomeDiv.style.cssText = `
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          height: 100%;
          text-align: center;
          padding: 2rem;
        `;
        welcomeDiv.innerHTML = `
          <div style="
            background: #60a5fa;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
          ">
            <i class="fas fa-headset" style="font-size: 28px; color: white;"></i>
          </div>
          <h3 style="
            color: rgba(226, 232, 240, 0.95);
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
          ">Bienvenue sur le support Qwota</h3>
          <p style="
            color: rgba(148, 163, 184, 0.8);
            font-size: 0.9375rem;
            line-height: 1.6;
            max-width: 280px;
          ">
            Posez vos questions, on vous r√©pond rapidement
          </p>
        `;
        chatMessages.appendChild(welcomeDiv);
        return;
      }

      // Afficher les messages
      messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${msg.is_admin ? 'admin' : 'user'}`;

        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'chat-message-bubble';
        bubbleDiv.textContent = msg.message;

        // Si le message a une image attach√©e
        if (msg.attachment_path && msg.attachment_type === 'image') {
          const imgElement = document.createElement('img');
          imgElement.className = 'chat-message-image';
          imgElement.src = `/cloud/${msg.attachment_path}`;
          imgElement.alt = 'Image attach√©e';
          imgElement.onclick = () => window.open(`/cloud/${msg.attachment_path}`, '_blank');
          bubbleDiv.appendChild(imgElement);
        }

        const timeDiv = document.createElement('div');
        timeDiv.className = 'chat-message-time';
        const msgDate = new Date(msg.created_at);
        timeDiv.textContent = msgDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

        messageDiv.appendChild(bubbleDiv);
        messageDiv.appendChild(timeDiv);
        chatMessages.appendChild(messageDiv);
      });

      // Scroll vers le bas
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Variable globale pour stocker les fichiers s√©lectionn√©s
    let selectedFiles = [];

    // Envoyer un message
    async function sendChatMessage() {
      const username = window.username || localStorage.getItem('username');
      if (!username) return;

      const input = document.getElementById('chat-input');
      const message = input.value.trim();

      if (!message && selectedFiles.length === 0) return;

      try {
        // Si des fichiers sont s√©lectionn√©s, les envoyer un par un
        if (selectedFiles.length > 0) {
          for (const file of selectedFiles) {
            const formData = new FormData();
            formData.append('username', username);
            formData.append('message', message || 'Image envoy√©e');
            formData.append('file', file);

            const response = await fetch('/api/support/upload-attachment', {
              method: 'POST',
              body: formData
            });

            if (!response.ok) {
              console.error('[CHAT] Erreur envoi fichier:', file.name);
            }
          }

          input.value = '';
          input.style.height = 'auto';
          clearFileSelection();
          await loadChatMessages();
        } else {
          // Envoi normal sans fichier
          const response = await fetch('/api/support/send-message', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              username: username,
              message: message,
              is_admin: 0
            })
          });

          if (response.ok) {
            input.value = '';
            input.style.height = 'auto';
            await loadChatMessages();
          } else {
            console.error('[CHAT] Erreur envoi message');
          }
        }
      } catch (error) {
        console.error('[CHAT] Erreur:', error);
      }
    }

    // G√©rer la s√©lection de fichier
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      // V√©rifier que c'est une image
      if (!file.type.startsWith('image/')) {
        alert('Seules les images sont accept√©es');
        return;
      }

      // V√©rifier la taille (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('L\'image est trop volumineuse (max 5MB)');
        return;
      }

      // Ajouter le fichier au tableau
      const fileIndex = selectedFiles.length;
      selectedFiles.push(file);

      // Cr√©er une pr√©visualisation
      const reader = new FileReader();
      reader.onload = function(e) {
        const previewContainer = document.getElementById('chat-file-preview');

        // Ajouter le fichier √† droite (ne pas remplacer)
        const fileItemHTML = `
          <div class="chat-file-item" data-file-index="${fileIndex}">
            <img src="${e.target.result}" alt="Preview">
            <div class="chat-file-info">
              <div class="chat-file-name">${file.name}</div>
              <button class="chat-file-remove" onclick="removeFile(${fileIndex})" title="Retirer">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        `;
        previewContainer.insertAdjacentHTML('beforeend', fileItemHTML);
        previewContainer.style.display = 'flex';
      };
      reader.readAsDataURL(file);

      // R√©initialiser l'input pour permettre de s√©lectionner √† nouveau
      event.target.value = '';
    }

    // Retirer un fichier sp√©cifique
    function removeFile(index) {
      // Retirer du tableau
      selectedFiles.splice(index, 1);

      // Retirer l'√©l√©ment visuel
      const previewContainer = document.getElementById('chat-file-preview');
      const items = previewContainer.querySelectorAll('.chat-file-item');

      if (items[index]) {
        items[index].remove();
      }

      // Mettre √† jour les index des fichiers restants
      const remainingItems = previewContainer.querySelectorAll('.chat-file-item');
      remainingItems.forEach((item, newIndex) => {
        item.setAttribute('data-file-index', newIndex);
        const removeBtn = item.querySelector('.chat-file-remove');
        if (removeBtn) {
          removeBtn.setAttribute('onclick', `removeFile(${newIndex})`);
        }
      });

      // Cacher le conteneur si vide
      if (selectedFiles.length === 0) {
        previewContainer.style.display = 'none';
      }
    }

    // Effacer tous les fichiers
    function clearFileSelection() {
      selectedFiles = [];
      const fileInput = document.getElementById('chat-file-input');
      const previewContainer = document.getElementById('chat-file-preview');

      if (fileInput) fileInput.value = '';
      if (previewContainer) {
        previewContainer.innerHTML = '';
        previewContainer.style.display = 'none';
      }
    }

    // G√©rer Enter pour envoyer (Shift+Enter pour nouvelle ligne)
    function handleChatInputKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage();
      }
    }

    // Auto-resize du textarea
    document.addEventListener('DOMContentLoaded', () => {
      const chatInput = document.getElementById('chat-input');
      if (chatInput) {
        chatInput.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });
      }

    });
  </script>

</body>
</html>
