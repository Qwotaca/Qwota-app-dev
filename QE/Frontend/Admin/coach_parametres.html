<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Param√®tres - Coach</title>

  <!-- üì± PWA Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Qwota">
  <meta name="msapplication-TileColor" content="#1f2937">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Ic√¥nes PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

  <!-- Scripts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link rel="icon" href="/favicon" type="image/x-icon" />

  <!-- Script commun -->
  <script src="/common.js"></script>

  <!-- Feuille de style principale - Th√®me Dark -->
  <link rel="stylesheet" href="/base.css">

  <style>
    .profile-container {
      width: 100%;
    }

    .profile-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-dark-medium);
      border: 1px solid var(--border-dark);
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 2rem;
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid var(--border-dark);
    }

    .profile-photo-wrapper {
      position: relative;
      width: 120px;
      height: 120px;
    }

    .profile-photo {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary-blue);
      background: var(--bg-darker);
    }

    .profile-photo-placeholder {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-blue) 0%, #1e40af 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: white;
      font-weight: 600;
      border: 3px solid var(--primary-blue);
    }

    .photo-upload-btn {
      position: absolute;
      bottom: 0;
      right: 0;
      background: var(--primary-blue);
      color: white;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 3px solid var(--bg-card);
      transition: all 0.3s ease;
    }

    .photo-upload-btn:hover {
      background: #1e40af;
      transform: scale(1.1);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 0.5rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: rgba(15, 23, 42, 0.6);
      border: 2px solid var(--border-dark);
      border-radius: 8px;
      color: var(--text-light);
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }

    .form-input:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }

    .save-btn {
      background: linear-gradient(135deg, var(--primary-blue) 0%, #1e40af 100%);
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.4);
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Photo Menu Dropdown */
    #photo-menu-dropdown {
      position: absolute;
      bottom: -10px;
      left: 100%;
      margin-left: 10px;
      background: var(--bg-card);
      border: 1px solid var(--border-dark);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      min-width: 260px;
    }

    #photo-menu-dropdown.hidden {
      display: none;
    }

    #photo-menu-dropdown button {
      width: 100%;
      text-align: left;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s ease;
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text-light);
    }

    #photo-menu-dropdown button:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    #photo-menu-dropdown button:not(:last-child) {
      border-bottom: 1px solid var(--border-dark);
    }

    /* Modal styles */
    .modal {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.8);
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 2rem;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }

    #photo-editor-canvas {
      border: 1px solid var(--border-dark);
      cursor: move;
      background: #000;
    }

    @media (max-width: 768px) {
      .main-content {
        padding: 1rem !important;
      }

      .profile-container h1 {
        font-size: 1.75rem !important;
      }

      .profile-container .text-xl {
        font-size: 0.95rem !important;
      }

      .profile-container .mb-10 {
        margin-bottom: 1.5rem !important;
      }

      .profile-card {
        padding: 1.25rem;
        margin-bottom: 1rem;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      /* Profile header: photo + nom sur la meme ligne */
      .profile-header {
        flex-direction: row !important;
        text-align: left;
        gap: 1rem;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
        align-items: center;
      }

      /* Info section: colonne sans le bouton modifier */
      .profile-header > div[style*="flex: 1"] {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 0.25rem !important;
      }

      /* Cacher le bouton modifier dans le header (on le montre apres section title) */
      .profile-header #editBtn {
        display: none !important;
      }

      /* Photo plus petite */
      .profile-photo-wrapper {
        width: 70px !important;
        height: 70px !important;
        flex-shrink: 0;
      }

      .profile-photo-wrapper > div > div[style*="width: 120px"] {
        width: 70px !important;
        height: 70px !important;
      }

      .profile-photo-wrapper .text-5xl {
        font-size: 1.75rem !important;
      }

      /* Bouton camera plus petit sur mobile */
      #photo-menu-btn {
        width: 28px !important;
        height: 28px !important;
        font-size: 0.7rem !important;
      }

      #profileName {
        font-size: 1.25rem !important;
        margin-bottom: 0.25rem !important;
      }

      /* Bouton modifier mobile visible apres section title */
      #editBtnMobile {
        display: inline-flex !important;
        align-items: center !important;
      }

      .section-title {
        font-size: 0.95rem !important;
        margin-bottom: 0.75rem;
        justify-content: space-between;
        align-items: center;
      }

      .form-group {
        margin-bottom: 0.75rem;
      }

      .form-row {
        gap: 0.75rem !important;
      }

      #photo-menu-dropdown {
        left: 0 !important;
        transform: none;
        bottom: auto !important;
        top: 100% !important;
        margin-left: 0 !important;
        margin-top: 8px !important;
      }

      .modal-content {
        width: 95%;
        padding: 1.25rem;
      }
    }

    /* Google Places Autocomplete Styling - Dark Theme */
    /* Conteneur principal des suggestions Google */
    .pac-container {
      background: #1e293b !important;
      border: 1px solid rgb(71, 85, 105) !important;
      border-radius: 12px !important;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4) !important;
      margin-top: 4px !important;
      z-index: 50 !important;
    }

    /* Items individuels des suggestions */
    .pac-item {
      background: #1e293b !important;
      color: #e2e8f0 !important;
      border-top: 1px solid rgb(71, 85, 105) !important;
      padding: 12px 16px !important;
      font-size: 14px !important;
      cursor: pointer !important;
      transition: background-color 0.2s ease !important;
    }

    /* Premier item sans bordure du haut */
    .pac-item:first-child {
      border-top: none !important;
      border-top-left-radius: 12px !important;
      border-top-right-radius: 12px !important;
    }

    /* Dernier item avec coins arrondis */
    .pac-item:last-child {
      border-bottom-left-radius: 12px !important;
      border-bottom-right-radius: 12px !important;
    }

    /* Hover sur les suggestions */
    .pac-item:hover,
    .pac-item-selected {
      background: #3b82f6 !important;
      color: white !important;
    }

    /* Masquer l'ic√¥ne de localisation */
    .pac-icon {
      display: none !important;
    }

    /* Texte de l'adresse principale */
    .pac-item-query {
      color: #e2e8f0 !important;
      font-weight: 600 !important;
    }

    /* Texte secondaire (ville, province) */
    .pac-matched {
      color: #94a3b8 !important;
      font-weight: 400 !important;
    }

    /* S√©parateur entre adresse principale et secondaire */
    .pac-item-query .pac-matched {
      color: #3b82f6 !important;
      font-weight: 600 !important;
    }

    /* Hover sur les √©l√©ments de texte */
    .pac-item:hover .pac-item-query,
    .pac-item-selected .pac-item-query {
      color: white !important;
    }

    .pac-item:hover .pac-matched,
    .pac-item-selected .pac-matched {
      color: white !important;
    }

    /* Logo Google en bas */
    .pac-logo::after {
      background: #1e293b !important;
      border-top: 1px solid rgb(71, 85, 105) !important;
    }

    /* Container au-dessus du modal */
    .pac-container.pac-logo {
      border-bottom-left-radius: 12px !important;
      border-bottom-right-radius: 12px !important;
    }

    /* Limiter √† 3 suggestions maximum */
    .pac-item:nth-child(n+4) {
      display: none !important;
    }
  </style>
</head>
<body class="min-h-screen" style="margin: 0; padding: 0;">

  <!-- Contenu principal -->
  <div class="main-content w-full" style="width: 100%; padding: 2rem;">
    <div class="profile-container">

    <!-- Header -->
    <div class="mb-10 mt-5 md:mt-0">
      <div class="relative">
        <h1 class="text-4xl font-bold mb-3">
          Param√®tres du Profil
        </h1>
        <span class="absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-blue-600 to-blue-400 rounded-full"></span>
        <div class="flex items-center justify-between">
          <p class="text-xl font-medium">
            <span>G√©rer vos informations personnelles</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Carte de profil -->
    <div class="profile-card">
      <div class="profile-header">
        <div class="profile-photo-wrapper">
          <div id="profile-photo-display" class="relative">
            <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 4px solid var(--primary-blue); display: flex; align-items: center; justify-content: center; background: var(--bg-dark);">
              <img id="profile-photo-image" src="" alt="Photo de profil" class="w-full h-full object-cover hidden" />
              <div id="profile-photo-placeholder" class="flex flex-col items-center justify-center">
                <i class="fas fa-user text-5xl" style="color: var(--text-gray);"></i>
              </div>
            </div>
            <button id="photo-menu-btn" class="absolute bottom-0 right-0 w-10 h-10 rounded-full flex items-center justify-center" style="background: var(--primary-blue); color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
              <i class="fas fa-camera"></i>
            </button>

            <!-- Menu dropdown pour la photo -->
            <div id="photo-menu-dropdown" class="hidden">
              <button id="camera-photo-option">
                <i class="fas fa-camera" style="color: var(--primary-green);"></i>
                <span>Prendre une photo</span>
              </button>
              <button id="upload-photo-option">
                <i class="fas fa-upload" style="color: var(--primary-blue);"></i>
                <span>Modifier photo de profil</span>
              </button>
            </div>
          </div>

          <input type="file" id="profile-photo-input" accept="image/*" class="hidden" />
          <input type="file" id="camera-capture-input" accept="image/*" capture="environment" class="hidden" />
        </div>
        <div style="flex: 1; display: flex; justify-content: space-between; align-items: flex-start;">
          <div>
            <h2 class="text-2xl font-bold mb-2" id="profileName">Coach</h2>
            <span class="inline-block mt-2 px-3 py-1 bg-blue-900/30 text-blue-400 rounded-full text-sm font-medium">
              <i class="fas fa-user-shield mr-1"></i> Coach
            </span>
          </div>
          <button id="editBtn" class="btn-primary" type="button" onclick="toggleEditMode()">
            <i class="fas fa-edit"></i>
            Modifier
          </button>
        </div>
      </div>

      <div class="section-title">
        <span><i class="fas fa-user"></i> Informations Personnelles</span>
        <button id="editBtnMobile" class="btn-primary" type="button" onclick="toggleEditMode()" style="display: none; font-size: 0.85rem; padding: 0.5rem 1rem;">
          <i class="fas fa-edit"></i>
          Modifier
        </button>
      </div>

      <form id="profileForm">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="prenom">
              <i class="fas fa-user mr-1"></i> Pr√©nom
            </label>
            <input type="text" id="prenom" class="form-input" placeholder="Votre pr√©nom" disabled />
          </div>

          <div class="form-group">
            <label class="form-label" for="nom">
              <i class="fas fa-user mr-1"></i> Nom
            </label>
            <input type="text" id="nom" class="form-input" placeholder="Votre nom" disabled />
          </div>
        </div>
      </form>
    </div>

    </div>
  </div>

  <!-- Modal d'√©dition de photo de profil -->
  <div id="photo-editor-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center" style="background: rgba(0,0,0,0.8);">
    <div class="card p-6 w-full max-w-md mx-4">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold" style="color: var(--text-light);">Modifier la photo de profil</h3>
        <button id="close-editor-btn" class="text-2xl" style="color: var(--text-gray);">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="flex flex-col items-center gap-4">
        <!-- Canvas pour l'√©dition -->
        <div class="relative">
          <canvas id="photo-editor-canvas" width="300" height="300" class="rounded-lg" style="border: 1px solid var(--border-dark); max-width: 100%;"></canvas>
        </div>

        <!-- Contr√¥le de zoom -->
        <div class="w-full">
          <label class="text-sm mb-2 block" style="color: var(--text-gray);">
            <i class="fas fa-search-plus mr-2"></i>
            Zoom
          </label>
          <input type="range" id="zoom-slider" min="1" max="3" step="0.1" value="1" class="w-full" />
        </div>

        <!-- Boutons d'action -->
        <div class="flex gap-3 w-full">
          <button id="cancel-editor-btn" class="btn-secondary flex-1">Annuler</button>
          <button id="save-editor-btn" class="btn-primary flex-1">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de choix cam√©ra -->
  <div id="camera-choice-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center" style="background: rgba(0,0,0,0.8);">
    <div class="card p-6 w-full max-w-md mx-4">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold" style="color: var(--text-light);">Prendre une photo</h3>
        <button id="close-choice-modal-btn" class="text-2xl" style="color: var(--text-gray);">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <p class="text-sm mb-6" style="color: var(--text-gray);">
        Choisissez comment vous souhaitez prendre votre photo
      </p>

      <div class="grid grid-cols-1 gap-4">
        <!-- Option Cam√©ra PC -->
        <button id="use-pc-camera-btn" class="p-6 rounded-lg border-2 transition-all hover:border-blue-500" style="background: var(--bg-dark); border-color: var(--border-dark);">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background: rgba(59, 130, 246, 0.2);">
              <i class="fas fa-desktop text-2xl" style="color: var(--primary-blue);"></i>
            </div>
            <div class="text-left">
              <h4 class="font-semibold mb-1" style="color: var(--text-light);">Cam√©ra PC</h4>
              <p class="text-sm" style="color: var(--text-gray);">Utiliser la webcam de votre ordinateur</p>
            </div>
          </div>
        </button>

        <!-- Option Mobile avec QR -->
        <button id="use-mobile-qr-btn" class="p-6 rounded-lg border-2 transition-all hover:border-blue-500" style="background: var(--bg-dark); border-color: var(--border-dark);">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background: rgba(34, 197, 94, 0.2);">
              <i class="fas fa-mobile-alt text-2xl" style="color: var(--primary-green);"></i>
            </div>
            <div class="text-left">
              <h4 class="font-semibold mb-1" style="color: var(--text-light);">Mobile (QR Code)</h4>
              <p class="text-sm" style="color: var(--text-gray);">Scanner un QR code avec votre t√©l√©phone</p>
            </div>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal cam√©ra PC -->
  <div id="camera-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center" style="background: rgba(0,0,0,0.95);">
    <div class="w-full h-full flex flex-col items-center justify-center p-4">
      <div class="w-full max-w-lg">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold" style="color: var(--text-light);">Cam√©ra PC</h3>
          <button id="close-camera-btn" class="text-2xl" style="color: var(--text-gray);">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="relative rounded-lg overflow-hidden" style="background: #000;">
          <video id="camera-video" autoplay playsinline class="w-full" style="max-height: 60vh;"></video>
          <canvas id="camera-canvas" class="hidden"></canvas>
        </div>

        <div class="flex gap-3 mt-4">
          <button id="cancel-camera-btn" class="btn-secondary flex-1">Annuler</button>
          <button id="capture-photo-btn" class="btn-primary flex-1">
            <i class="fas fa-camera mr-2"></i>Capturer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal QR Code Mobile -->
  <div id="qr-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center" style="background: rgba(0,0,0,0.8);">
    <div class="card p-6 w-full max-w-md mx-4">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold" style="color: var(--text-light);">Scanner le QR Code</h3>
        <button id="close-qr-modal-btn" class="text-2xl" style="color: var(--text-gray);">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="text-center">
        <p class="text-sm mb-6" style="color: var(--text-gray);">
          Scannez ce QR code avec votre t√©l√©phone pour prendre une photo
        </p>

        <div id="qrcode-container" class="flex justify-center mb-6 p-4 rounded-lg" style="background: white;">
          <!-- Le QR code sera g√©n√©r√© ici -->
        </div>

        <div class="flex items-center justify-center gap-2 mb-4">
          <div class="spinner-border" style="display: none;" id="qr-waiting-spinner"></div>
          <p class="text-sm" style="color: var(--text-gray);" id="qr-status-text">
            En attente de la photo...
          </p>
        </div>

        <button id="cancel-qr-btn" class="btn-secondary w-full">Annuler</button>
      </div>
    </div>
  </div>

  <script>
    // Fonction pour afficher les notifications (style calcul)
    function showNotification(message, type = 'success') {
      const notificationEl = document.createElement('div');
      notificationEl.textContent = type === 'success' ? '‚úì ' + message : '‚úó ' + message;
      notificationEl.style.cssText = `position:fixed;top:10px;right:10px;background:${type === 'success' ? '#5271ff' : '#ef4444'};color:white;padding:12px 20px;border-radius:8px;font-size:14px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.3);`;
      document.body.appendChild(notificationEl);
      setTimeout(() => notificationEl.remove(), 2000);
    }
  </script>

  <script>
    let currentUsername = null;
    let profilePhotoUrl = null;
    let isEditMode = false;

    // Toggle du mode √©dition
    function toggleEditMode() {
      isEditMode = !isEditMode;
      const btn = document.getElementById('editBtn');
      const btnMobile = document.getElementById('editBtnMobile');
      const inputs = document.querySelectorAll('#profileForm input');

      if (isEditMode) {
        inputs.forEach(input => input.disabled = false);
        btn.innerHTML = '<i class="fas fa-save"></i> Enregistrer';
        btn.onclick = saveProfile;
        if (btnMobile) { btnMobile.innerHTML = '<i class="fas fa-save"></i> Enregistrer'; btnMobile.onclick = saveProfile; }
      } else {
        inputs.forEach(input => input.disabled = true);
        btn.innerHTML = '<i class="fas fa-edit"></i> Modifier';
        btn.onclick = toggleEditMode;
        if (btnMobile) { btnMobile.innerHTML = '<i class="fas fa-edit"></i> Modifier'; btnMobile.onclick = toggleEditMode; }
      }
    }

    // Sauvegarder le profil
    async function saveProfile() {
      const profileData = {
        username: currentUsername,
        prenom: document.getElementById('prenom').value.trim(),
        nom: document.getElementById('nom').value.trim()
      };

      try {
        const response = await fetch('/api/profile/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(profileData)
        });

        const data = await response.json();

        if (data.success) {
          showNotification('Profil mis √† jour avec succ√®s', 'success');
          await loadProfile(); // Recharger pour mettre √† jour l'affichage

          // Revenir en mode lecture - d√©sactiver les inputs et changer le bouton
          const btn = document.getElementById('editBtn');
          const btnMobile = document.getElementById('editBtnMobile');
          const inputs = document.querySelectorAll('#profileForm input');
          inputs.forEach(input => input.disabled = true);
          btn.innerHTML = '<i class="fas fa-edit"></i> Modifier';
          btn.onclick = toggleEditMode;
          if (btnMobile) { btnMobile.innerHTML = '<i class="fas fa-edit"></i> Modifier'; btnMobile.onclick = toggleEditMode; }
          isEditMode = false;
        } else {
          showNotification('Erreur: ' + data.error, 'error');
        }
      } catch (error) {
        console.error('Erreur mise √† jour profil:', error);
        showNotification('Erreur lors de la mise √† jour', 'error');
      }
    }

    // Charger les informations du profil
    async function loadProfile() {
      try {
        currentUsername = localStorage.getItem('username');

        if (!currentUsername) {
          console.error('Aucun utilisateur connect√©');
          return;
        }

        const response = await fetch(`/api/profile/${currentUsername}`);
        const data = await response.json();

        if (data.success) {
          const profile = data.profile;

          // Mettre √† jour les champs
          document.getElementById('prenom').value = profile.prenom || '';
          document.getElementById('nom').value = profile.nom || '';

          // Mettre √† jour le header
          const fullName = [profile.prenom, profile.nom].filter(Boolean).join(' ') || 'Coach';
          document.getElementById('profileName').textContent = fullName;
          // Mettre √† jour la photo
          if (profile.photo_url) {
            profilePhotoUrl = profile.photo_url;
            const img = document.getElementById('profile-photo-image');
            const placeholder = document.getElementById('profile-photo-placeholder');
            img.src = profile.photo_url;
            img.classList.remove('hidden');
            placeholder.classList.add('hidden');
          }
        }
      } catch (error) {
        console.error('Erreur chargement profil:', error);
      }
    }

    // Charger le profil au d√©marrage
    loadProfile();
  </script>

  <script>
    // ===========================================
    // GESTION PHOTO DE PROFIL (style connect_agenda)
    // ===========================================

    // Toast notification function
    function showToast(message, type = 'info') {
      let toastContainer = document.getElementById('toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.cssText = `
          position: fixed;
          top: 2rem;
          right: 2rem;
          z-index: 99999;
          display: flex;
          flex-direction: column;
          gap: 1rem;
        `;
        document.body.appendChild(toastContainer);
      }

      const toast = document.createElement('div');
      toast.className = 'custom-toast';

      const config = {
        success: {
          icon: 'fa-check-circle',
          color: '#10b981',
          bg: 'rgba(16, 185, 129, 0.1)'
        },
        error: {
          icon: 'fa-exclamation-circle',
          color: '#ef4444',
          bg: 'rgba(239, 68, 68, 0.1)'
        },
        info: {
          icon: 'fa-info-circle',
          color: '#3b82f6',
          bg: 'rgba(59, 130, 246, 0.1)'
        }
      };

      const toastConfig = config[type] || config.info;

      toast.innerHTML = `
        <div style="
          background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
          border: 2px solid ${toastConfig.color};
          border-radius: 16px;
          padding: 1.25rem 1.5rem;
          min-width: 350px;
          max-width: 450px;
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), 0 0 100px ${toastConfig.color}33;
          display: flex;
          align-items: center;
          gap: 1rem;
          backdrop-filter: blur(20px);
          animation: slideInRight 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        ">
          <div style="
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: ${toastConfig.bg};
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
          ">
            <i class="fas ${toastConfig.icon}" style="
              font-size: 1.5rem;
              color: ${toastConfig.color};
            "></i>
          </div>
          <p style="
            color: var(--text-light);
            font-weight: 500;
            font-size: 1rem;
            flex: 1;
          ">${message}</p>
          <button onclick="this.parentElement.parentElement.remove()" style="
            background: transparent;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
          " onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.color='var(--text-light)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-gray)'">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;

      toastContainer.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
        setTimeout(() => toast.remove(), 400);
      }, 4000);
    }

    // Add keyframe animations for toast
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes slideInRight {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(toastStyle);

// Gestion de la photo de profil avec √©diteur circulaire
document.addEventListener("DOMContentLoaded", function() {
  const photoInput = document.getElementById("profile-photo-input");
  const cameraInput = document.getElementById("camera-capture-input");
  const photoMenuBtn = document.getElementById("photo-menu-btn");
  const photoMenuDropdown = document.getElementById("photo-menu-dropdown");
  const uploadPhotoOption = document.getElementById("upload-photo-option");
  const cameraPhotoOption = document.getElementById("camera-photo-option");
  const profilePhotoImage = document.getElementById("profile-photo-image");
  const profilePhotoPlaceholder = document.getElementById("profile-photo-placeholder");

  // Modal et √©diteur
  const editorModal = document.getElementById("photo-editor-modal");
  const closeEditorBtn = document.getElementById("close-editor-btn");
  const cancelEditorBtn = document.getElementById("cancel-editor-btn");
  const saveEditorBtn = document.getElementById("save-editor-btn");
  const canvas = document.getElementById("photo-editor-canvas");
  const ctx = canvas.getContext("2d");
  const zoomSlider = document.getElementById("zoom-slider");

  let currentImage = null;
  let imageScale = 1;
  let imageX = 0;
  let imageY = 0;
  let isDragging = false;
  let startX, startY;

  // D√©tection mobile
  const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;

  // Toggle menu dropdown
  photoMenuBtn.addEventListener("click", (e) => {
    e.stopPropagation();

    // Sur mobile, ouvrir directement le s√©lecteur de fichiers natif
    if (isMobileDevice) {
      photoInput.click();
    } else {
      // Sur desktop, afficher le menu
      photoMenuDropdown.classList.toggle("hidden");
    }
  });

  // Fermer le menu en cliquant ailleurs
  document.addEventListener("click", () => {
    photoMenuDropdown.classList.add("hidden");
  });

  // Option: Modifier photo
  uploadPhotoOption.addEventListener("click", () => {
    photoMenuDropdown.classList.add("hidden");
    photoInput.click();
  });

  // Variable pour stocker le stream de la cam√©ra
  let cameraStream = null;
  let qrCheckInterval = null;
  let currentSessionId = null;

  // Option: Prendre photo - Ouvrir le modal de choix
  cameraPhotoOption.addEventListener("click", () => {
    photoMenuDropdown.classList.add("hidden");
    document.getElementById("camera-choice-modal").classList.remove("hidden");
  });

  // Fermer le modal de choix
  document.getElementById("close-choice-modal-btn").addEventListener("click", () => {
    document.getElementById("camera-choice-modal").classList.add("hidden");
  });

  // Choix cam√©ra PC
  document.getElementById("use-pc-camera-btn").addEventListener("click", async () => {
    document.getElementById("camera-choice-modal").classList.add("hidden");
    await openCamera();
  });

  // Choix QR Code Mobile
  document.getElementById("use-mobile-qr-btn").addEventListener("click", () => {
    document.getElementById("camera-choice-modal").classList.add("hidden");
    openQRModal();
  });

  // Fonction pour ouvrir la cam√©ra
  async function openCamera() {
    const cameraModal = document.getElementById("camera-modal");
    const video = document.getElementById("camera-video");

    try {
      // Demander l'acc√®s √† la cam√©ra (pr√©f√©rence pour la cam√©ra frontale sur mobile)
      cameraStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false
      });

      video.srcObject = cameraStream;
      cameraModal.classList.remove("hidden");
    } catch (error) {
      console.error("Erreur d'acc√®s √† la cam√©ra:", error);
      showToast("Impossible d'acc√©der √† la cam√©ra", "error");
    }
  }

  // Fonction pour arr√™ter la cam√©ra
  function stopCamera() {
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
      cameraStream = null;
    }
    document.getElementById("camera-modal").classList.add("hidden");
  }

  // Bouton fermer cam√©ra
  document.getElementById("close-camera-btn").addEventListener("click", stopCamera);
  document.getElementById("cancel-camera-btn").addEventListener("click", stopCamera);

  // Bouton capturer photo
  document.getElementById("capture-photo-btn").addEventListener("click", () => {
    const video = document.getElementById("camera-video");
    const canvas = document.getElementById("camera-canvas");
    const ctx = canvas.getContext("2d");

    // D√©finir la taille du canvas bas√©e sur la vid√©o
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    // Dessiner l'image de la vid√©o sur le canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Convertir en blob et traiter comme un fichier
    canvas.toBlob((blob) => {
      stopCamera();

      // Cr√©er un objet File depuis le blob
      const file = new File([blob], "camera-photo.jpg", { type: "image/jpeg" });
      handleImageFile(file);
    }, "image/jpeg", 0.95);
  });

  // Fonction pour ouvrir le modal QR
  function openQRModal() {
    const qrModal = document.getElementById("qr-modal");
    const qrcodeContainer = document.getElementById("qrcode-container");

    // G√©n√©rer un ID de session unique
    currentSessionId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substring(7);

    // Nettoyer le container QR
    qrcodeContainer.innerHTML = '';

    // Utiliser l'adresse IP locale pour que le mobile puisse se connecter
    const hostname = window.location.hostname;
    const port = window.location.port;
    const protocol = window.location.protocol;

    // Si on est sur localhost, utiliser l'IP locale
    let baseUrl;
    if (hostname === 'localhost' || hostname === '127.0.0.1') {
      baseUrl = `${protocol}//192.168.2.231:${port}`;
    } else {
      baseUrl = window.location.origin;
    }

    const mobileUrl = `${baseUrl}/mobile-camera?session=${currentSessionId}&username=${encodeURIComponent(username)}`;

    // G√©n√©rer le QR code
    new QRCode(qrcodeContainer, {
      text: mobileUrl,
      width: 256,
      height: 256,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });

    // Afficher le modal
    qrModal.classList.remove("hidden");

    // Commencer √† v√©rifier si une photo a √©t√© upload√©e
    startPhotoPolling();
  }

  // Fonction pour d√©marrer le polling avec SSE
  function startPhotoPolling() {
    // Arr√™ter tout polling existant
    if (qrCheckInterval) {
      qrCheckInterval.close();
      qrCheckInterval = null;
    }

    // Utiliser Server-Sent Events pour recevoir la notification
    const eventSource = new EventSource(`/api/wait-mobile-photo/${currentSessionId}`);

    eventSource.onmessage = async (event) => {
      try {
        const data = JSON.parse(event.data);

        if (data.photo) {
          // Photo re√ßue!
          eventSource.close();
          stopPhotoPolling();

          // Convertir la base64 en blob
          const photoBlob = await fetch(data.photo).then(r => r.blob());
          const file = new File([photoBlob], "mobile-photo.jpg", { type: "image/jpeg" });

          // Traiter la photo
          handleImageFile(file);
        }
      } catch (error) {
        console.error("Erreur lors du traitement de la photo:", error);
      }
    };

    eventSource.onerror = (error) => {
      console.error("Erreur SSE:", error);
      eventSource.close();
    };

    // Stocker la r√©f√©rence
    qrCheckInterval = eventSource;
  }

  // Fonction pour arr√™ter le polling
  function stopPhotoPolling() {
    if (qrCheckInterval) {
      if (qrCheckInterval.close) {
        qrCheckInterval.close();
      }
      qrCheckInterval = null;
    }
    document.getElementById("qr-modal").classList.add("hidden");
    currentSessionId = null;
  }

  // Boutons fermer/annuler QR modal
  document.getElementById("close-qr-modal-btn").addEventListener("click", stopPhotoPolling);
  document.getElementById("cancel-qr-btn").addEventListener("click", stopPhotoPolling);

  // Fonction commune pour traiter une image
  function handleImageFile(file) {
    if (file && file.type.startsWith("image/")) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          currentImage = img;
          imageScale = 1;

          // Centrer l'image
          const canvasSize = canvas.width;
          const minScale = canvasSize / Math.min(img.width, img.height);
          imageScale = minScale;
          imageX = (canvasSize - img.width * imageScale) / 2;
          imageY = (canvasSize - img.height * imageScale) / 2;

          zoomSlider.value = 1;

          // Ouvrir le modal
          editorModal.classList.remove("hidden");
          drawImage();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  }

  // Quand une image est s√©lectionn√©e (upload)
  photoInput.addEventListener("change", function(e) {
    const file = e.target.files[0];
    handleImageFile(file);
  });

  // Quand une photo est prise avec la cam√©ra
  cameraInput.addEventListener("change", function(e) {
    const file = e.target.files[0];
    handleImageFile(file);
  });

  // Fermer le modal
  function closeModal() {
    editorModal.classList.add("hidden");
    photoInput.value = "";
    currentImage = null;
  }

  closeEditorBtn.addEventListener("click", closeModal);
  cancelEditorBtn.addEventListener("click", closeModal);

  // Fonction pour contraindre la position de l'image (toujours couvrir le canvas)
  function constrainImagePosition() {
    const canvasSize = canvas.width;
    const scaledWidth = currentImage.width * imageScale;
    const scaledHeight = currentImage.height * imageScale;

    // L'image doit toujours couvrir le canvas enti√®rement
    // Limite √† droite/bas (l'image ne peut pas laisser d'espace vide)
    const maxX = 0;
    const maxY = 0;
    // Limite √† gauche/haut (l'image ne peut pas laisser d'espace vide)
    const minX = canvasSize - scaledWidth;
    const minY = canvasSize - scaledHeight;

    // Contraindre X
    if (imageX > maxX) imageX = maxX;
    if (imageX < minX) imageX = minX;

    // Contraindre Y
    if (imageY > maxY) imageY = maxY;
    if (imageY < minY) imageY = minY;
  }

  // Zoom avec le slider
  zoomSlider.addEventListener("input", function(e) {
    if (!currentImage) return;

    const canvasSize = canvas.width;
    const minScale = canvasSize / Math.min(currentImage.width, currentImage.height);
    const newScale = minScale * parseFloat(e.target.value);

    // Ajuster la position pour garder le centre
    const centerX = canvasSize / 2;
    const centerY = canvasSize / 2;
    const imageCenterX = imageX + (currentImage.width * imageScale) / 2;
    const imageCenterY = imageY + (currentImage.height * imageScale) / 2;

    imageX = centerX - (imageCenterX - imageX) * (newScale / imageScale);
    imageY = centerY - (imageCenterY - imageY) * (newScale / imageScale);
    imageScale = newScale;

    // Contraindre la position apr√®s le zoom
    constrainImagePosition();

    drawImage();
  });

  // Drag pour d√©placer l'image
  canvas.addEventListener("mousedown", function(e) {
    isDragging = true;
    startX = e.offsetX;
    startY = e.offsetY;
  });

  canvas.addEventListener("mousemove", function(e) {
    if (!isDragging || !currentImage) return;

    const dx = e.offsetX - startX;
    const dy = e.offsetY - startY;

    imageX += dx;
    imageY += dy;

    // Contraindre la position
    constrainImagePosition();

    startX = e.offsetX;
    startY = e.offsetY;

    drawImage();
  });

  canvas.addEventListener("mouseup", () => {
    isDragging = false;
  });

  canvas.addEventListener("mouseleave", () => {
    isDragging = false;
  });

  // Support tactile pour mobile
  canvas.addEventListener("touchstart", function(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    isDragging = true;
    startX = touch.clientX - rect.left;
    startY = touch.clientY - rect.top;
  });

  canvas.addEventListener("touchmove", function(e) {
    if (!isDragging || !currentImage) return;
    e.preventDefault();

    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const currentX = touch.clientX - rect.left;
    const currentY = touch.clientY - rect.top;

    const dx = currentX - startX;
    const dy = currentY - startY;

    imageX += dx;
    imageY += dy;

    // Contraindre la position
    constrainImagePosition();

    startX = currentX;
    startY = currentY;

    drawImage();
  });

  canvas.addEventListener("touchend", () => {
    isDragging = false;
  });

  // Dessiner l'image avec masque circulaire
  function drawImage() {
    if (!currentImage) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Dessiner l'image
    ctx.save();
    ctx.drawImage(currentImage, imageX, imageY, currentImage.width * imageScale, currentImage.height * imageScale);
    ctx.restore();

    // Appliquer un masque circulaire (overlay sombre avec cercle transparent)
    ctx.save();
    ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = canvas.width / 2;

    ctx.globalCompositeOperation = "destination-out";
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();

    // Dessiner le contour du cercle
    ctx.strokeStyle = "#60a5fa";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.stroke();
  }

  // Sauvegarder la photo cropp√©e
  saveEditorBtn.addEventListener("click", async () => {
    if (!currentImage) return;

    const originalText = saveEditorBtn.innerHTML;

    try {
      saveEditorBtn.disabled = true;
      saveEditorBtn.innerHTML = '<span class="spinner"></span> Sauvegarde...';

      // Cr√©er un canvas temporaire pour le crop circulaire
      const tempCanvas = document.createElement("canvas");
      const tempCtx = tempCanvas.getContext("2d");
      const size = canvas.width;
      tempCanvas.width = size;
      tempCanvas.height = size;

      // Dessiner l'image cropp√©e en cercle
      tempCtx.save();
      tempCtx.beginPath();
      tempCtx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
      tempCtx.clip();
      tempCtx.drawImage(currentImage, imageX, imageY, currentImage.width * imageScale, currentImage.height * imageScale);
      tempCtx.restore();

      // Convertir en base64
      const photoDataUrl = tempCanvas.toDataURL("image/png");

      // Sauvegarder via l'API
      const response = await fetch('/api/save-profile-photo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: username,
          photoData: photoDataUrl
        })
      });

      if (!response.ok) throw new Error(`Erreur ${response.status}`);

      // Afficher la photo
      profilePhotoImage.src = photoDataUrl;
      profilePhotoImage.classList.remove("hidden");
      profilePhotoPlaceholder.style.display = "none";

      // Mettre √† jour la photo dans le header
      updateHeaderProfilePhoto(photoDataUrl);

      // Fermer le modal
      closeModal();

      showToast("Photo de profil sauvegard√©e avec succ√®s", "success");

    } catch (error) {
      showToast("Une erreur s'est produite lors de la sauvegarde", "error");
      console.error(error);
    } finally {
      saveEditorBtn.disabled = false;
      saveEditorBtn.innerHTML = originalText;
    }
  });

  // Charger la photo existante au d√©marrage
  loadExistingProfilePhoto();

  async function loadExistingProfilePhoto() {
    try {
      const response = await fetch(`/api/get-profile-photo/${window.username}`);
      if (response.ok) {
        const data = await response.json();
        if (data.photoUrl) {
          profilePhotoImage.src = data.photoUrl;
          profilePhotoImage.classList.remove("hidden");
          profilePhotoPlaceholder.style.display = "none";

          // Mettre √† jour la photo dans le header
          updateHeaderProfilePhoto(data.photoUrl);
        }
      }
    } catch (error) {
      console.log("Aucune photo de profil existante trouv√©e");
    }
  }

  // Fonction pour mettre √† jour la photo dans le header
  function updateHeaderProfilePhoto(photoUrl) {
    console.log('üñºÔ∏è Mise √† jour de la photo de profil dans le header:', photoUrl);

    // Si on est dans un iframe, mettre √† jour le header de la page parent (apppc.html)
    if (window.parent && window.parent !== window) {
      try {
        const parentDoc = window.parent.document;

        // Desktop account avatar (dans le bouton header du parent)
        const accountAvatar = parentDoc.querySelector('.account-avatar img');
        if (accountAvatar) {
          accountAvatar.src = photoUrl;
          console.log('[OK] Desktop account avatar mis √† jour (parent)');
        }

        // Mobile profile icon (dans le header mobile du parent)
        const mobileProfileIcon = parentDoc.querySelector('.mobile-profile-icon');
        if (mobileProfileIcon) {
          mobileProfileIcon.innerHTML = `<img src="${photoUrl}" alt="Photo de profil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
          console.log('[OK] Mobile profile icon mis √† jour (parent)');
        }
      } catch (e) {
        console.log('[WARN] Impossible d\'acc√©der au parent (CORS):', e.message);
      }
    }

    // Aussi mettre √† jour localement si les √©l√©ments existent dans cette page
    const mobileProfileIcon = document.querySelector('.mobile-profile-icon');
    if (mobileProfileIcon) {
      mobileProfileIcon.innerHTML = `<img src="${photoUrl}" alt="Photo de profil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
      console.log('[OK] Mobile profile icon mis √† jour (local)');
    }

    const accountAvatar = document.querySelector('.account-avatar');
    if (accountAvatar) {
      const img = accountAvatar.querySelector('img');
      if (img) {
        img.src = photoUrl;
      } else {
        accountAvatar.innerHTML = `<img src="${photoUrl}" alt="Photo de profil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
      }
      console.log('[OK] Desktop account avatar mis √† jour (local)');
    }
  }
});
  </script>

  <script>
    // ===========================================
    // FORMATAGE AUTOMATIQUE DU T√âL√âPHONE (000-000-0000)
    // ===========================================
    const telephoneInput = document.getElementById('telephone');

    if (telephoneInput) {
      telephoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Garder seulement les chiffres
        let formattedValue = '';

        if (value.length > 0) {
          formattedValue = value.substring(0, 3);
        }
        if (value.length >= 4) {
          formattedValue += '-' + value.substring(3, 6);
        }
        if (value.length >= 7) {
          formattedValue += '-' + value.substring(6, 10);
        }

        e.target.value = formattedValue;
      });

      telephoneInput.addEventListener('keydown', function(e) {
        // Si l'utilisateur appuie sur Backspace ou Delete
        if (e.key === 'Backspace' || e.key === 'Delete') {
          const cursorPos = e.target.selectionStart;
          const value = e.target.value;

          // Si on supprime un tiret, supprimer aussi le chiffre avant
          if (cursorPos > 0 && value[cursorPos - 1] === '-') {
            e.preventDefault();
            const newValue = value.substring(0, cursorPos - 2) + value.substring(cursorPos);
            e.target.value = newValue;
            e.target.setSelectionRange(cursorPos - 2, cursorPos - 2);

            // Re-d√©clencher l'√©v√©nement input pour reformater
            const inputEvent = new Event('input', { bubbles: true });
            e.target.dispatchEvent(inputEvent);
          }
        }
      });
    }
  </script>

  <!-- Google Maps Autocomplete pour adresse -->
  <script>
    // Variable globale pour tracker si une adresse Google a √©t√© s√©lectionn√©e
    window.googleAddressSelected = false;

    window.initAddressAutocomplete = function() {
      const input = document.getElementById('adresse');
      if (!input) return;

      // Forcer la d√©sactivation de l'autocomplete navigateur
      input.setAttribute('autocomplete', 'new-password');
      input.setAttribute('autocorrect', 'off');
      input.setAttribute('autocapitalize', 'off');
      input.setAttribute('spellcheck', 'false');

      const autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['address'],
        componentRestrictions: { country: 'ca' }
      });

      // Repositionner le dropdown Google pour qu'il s'aligne avec le champ input sur mobile
      function repositionGoogleDropdown() {
        const pacContainer = document.querySelector('.pac-container');
        if (pacContainer && window.innerWidth <= 768) {
          const inputRect = input.getBoundingClientRect();
          pacContainer.style.left = inputRect.left + 'px';
          pacContainer.style.width = inputRect.width + 'px';
          pacContainer.style.maxWidth = inputRect.width + 'px';
        }
      }

      // Observer pour d√©tecter l'apparition du dropdown
      const observer = new MutationObserver(() => {
        repositionGoogleDropdown();
      });

      // Observer les changements sur le body pour d√©tecter le dropdown
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });

      // Repositionner aussi sur input et focus
      input.addEventListener('input', () => {
        window.googleAddressSelected = false;
        // R√©appliquer les attributs anti-autocomplete
        input.setAttribute('autocomplete', 'new-password');
        setTimeout(repositionGoogleDropdown, 50);
      });

      input.addEventListener('focus', () => {
        input.setAttribute('autocomplete', 'new-password');
        input.removeAttribute('readonly');
        setTimeout(repositionGoogleDropdown, 50);
      });

      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
          console.log("Adresse invalide");
          window.googleAddressSelected = false;
          return;
        }

        // Marquer qu'une adresse Google a √©t√© s√©lectionn√©e
        window.googleAddressSelected = true;

        const components = place.address_components;
        let streetNumber = '';
        let route = '';
        let city = '';
        let province = '';
        let postalCode = '';

        components.forEach(component => {
          const types = component.types;

          if (types.includes('street_number')) {
            streetNumber = component.long_name;
          }
          if (types.includes('route')) {
            route = component.long_name;
          }
          if (types.includes('locality')) {
            city = component.long_name;
          }
          if (types.includes('administrative_area_level_1')) {
            province = component.short_name;
          }
          if (types.includes('postal_code')) {
            postalCode = component.long_name;
          }
        });

        const fullAddress = `${streetNumber} ${route}, ${city}, ${province} ${postalCode}`;
        input.value = fullAddress.trim();
      });
    };
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZDi-RMHDdA4l-4sv_5H8GhsUAYXV4DVE&libraries=places&callback=initAddressAutocomplete&language=fr&region=CA"
    async
    defer
  ></script>

</body>
</html>
