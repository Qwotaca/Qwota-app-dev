<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Validation Employ√©s - Coach</title>

  <!-- üì± PWA Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Qwota">
  <meta name="msapplication-TileColor" content="#1f2937">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Ic√¥nes PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

  <!-- Scripts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="icon" href="/favicon" type="image/x-icon" />

  <!-- Script commun -->
  <script src="/common.js"></script>

  <!-- Feuille de style principale - Th√®me Dark -->
  <link rel="stylesheet" href="/base.css">

  <style>
    /* Container principal */
    .validation-container {
      width: 100%;
      padding: 2rem;
    }

    /* Header */
    .page-header {
      margin-bottom: 2rem;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .page-title i {
      color: var(--primary-blue);
    }

    .page-subtitle {
      font-size: 1rem;
      color: var(--text-gray);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-top: 2rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid rgba(71, 85, 105, 0.3);
    }

    .tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      color: var(--text-gray);
      font-weight: 600;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
    }

    .tab:hover {
      color: var(--text-light);
    }

    .tab.active {
      color: #60a5fa;
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Stats cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-dark);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--shadow-dark-medium);
    }

    .stat-card-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .stat-card-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: white;
    }

    .stat-card-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-gray);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-card-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-light);
    }

    /* Table */
    .table-container {
      background: var(--bg-card);
      border: 1px solid var(--border-dark);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow-dark-medium);
      max-height: none !important;
      height: 850px !important;
    }

    .table-header {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(51, 65, 85, 0.8) 100%);
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-dark);
    }

    .table-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .table-body {
      padding: 1.5rem;
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead th {
      text-align: left;
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-gray);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--border-dark);
    }

    tbody tr {
      border-bottom: 1px solid rgba(71, 85, 105, 0.2);
      transition: background-color 0.2s ease;
    }

    tbody tr:hover {
      background-color: rgba(59, 130, 246, 0.05);
    }

    tbody tr:last-child {
      border-bottom: none;
    }

    tbody td {
      padding: 1rem;
      font-size: 0.875rem;
      color: var(--text-light);
    }

    /* Badges */
    .entrepreneur-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.375rem 0.75rem;
      background: rgba(96, 165, 250, 0.1);
      border: 1px solid rgba(96, 165, 250, 0.3);
      border-radius: 8px;
      color: var(--primary-blue);
      font-size: 0.875rem;
      font-weight: 500;
    }

    .entrepreneur-badge i {
      font-size: 0.75rem;
    }

    /* Dropdown Styles */
    .coach-dropdown-container {
      margin-bottom: 2rem;
    }

    .coach-dropdown {
      position: relative;
      width: 350px;
    }

    .coach-dropdown-toggle {
      background: var(--bg-sidebar);
      border: 2px solid var(--border-dark);
      border-radius: 12px;
      padding: 1rem 3rem 1rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      color: var(--text-light);
      font-size: 15px;
      gap: 0.5rem;
      position: relative;
    }

    /* Input invisible pour le curseur */
    .coach-dropdown-toggle input.search-input {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-light);
      font-size: 15px;
      font-weight: 500;
      padding: 0 3rem 0 1rem;
      opacity: 0;
      pointer-events: none;
      caret-color: var(--text-light);
    }

    .coach-dropdown-toggle.active input.search-input {
      opacity: 1;
      pointer-events: all;
    }

    .coach-dropdown-toggle.active .placeholder {
      opacity: 0;
    }

    .coach-dropdown-toggle:hover {
      border-color: var(--primary-blue);
    }

    .coach-dropdown-toggle.active {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .coach-dropdown-toggle .selected-text {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 500;
    }

    .coach-dropdown-toggle .chevron {
      position: absolute;
      right: 1rem;
      transition: transform 0.3s ease;
    }

    .coach-dropdown-toggle.active .chevron {
      transform: rotate(180deg);
    }

    .coach-dropdown-menu {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      background: var(--bg-card);
      border: 2px solid var(--border-dark);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      z-index: 10000;
      max-height: 320px;
      overflow: hidden;
      opacity: 0;
      transform: translateY(-10px);
      pointer-events: none;
      transition: all 0.3s ease;
    }

    .coach-dropdown-options-container {
      max-height: 220px;
      overflow-y: auto;
      padding: 0;
      margin: 0;
    }

    .coach-dropdown-options-container::-webkit-scrollbar {
      width: 3px;
    }

    .coach-dropdown-options-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .coach-dropdown-options-container::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.3);
      border-radius: 10px;
    }

    .coach-dropdown-options-container::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.5);
    }

    .coach-dropdown-menu.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }

    .coach-dropdown-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(71, 85, 105, 0.2);
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: transparent;
    }

    .coach-dropdown-option:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    .coach-dropdown-option:last-child {
      border-bottom: none;
    }

    .coach-dropdown-option i {
      color: var(--primary-blue);
      font-size: 1.1rem;
    }

    /* Boutons d'action */
    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn-validate {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .btn-validate:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      transform: translateY(-2px);
    }

    .btn-refuse {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .btn-refuse:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      transform: translateY(-2px);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-gray);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 1.125rem;
    }

    /* Loading state */
    .loading-shimmer {
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ============================================
       SOUS-TABS EMPLOY√âS / MESSAGES
       ============================================ */
    .subtab {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      background: transparent;
      border: none;
      color: var(--text-gray);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .subtab:hover {
      color: var(--text-light);
    }

    .subtab.active {
      color: #60a5fa;
    }

    .subtab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0.5rem;
      right: 0.5rem;
      height: 2px;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      border-radius: 2px;
    }

    .subtab-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      background: rgba(96, 165, 250, 0.2);
      color: #60a5fa;
      font-size: 0.7rem;
      font-weight: 700;
      border-radius: 10px;
    }

    .subtab-count.urgent {
      background: #ef4444;
      color: white;
      animation: pulse-badge 2s infinite;
    }

    @keyframes pulse-badge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* ============================================
       LISTE MESSAGES - STYLE CHAT
       ============================================ */
    .message-card {
      background: rgba(23, 32, 51, 0.6);
      border: 1px solid var(--border-dark);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .message-card:hover {
      border-color: rgba(239, 68, 68, 0.4);
      background: rgba(23, 32, 51, 0.8);
      transform: translateX(4px);
    }

    .message-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .message-card-entrepreneur {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .message-card-entrepreneur .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .message-card-entrepreneur .name {
      font-weight: 600;
      color: var(--text-light);
    }

    .message-card-date {
      font-size: 0.75rem;
      color: var(--text-gray);
    }

    .message-card-employe {
      font-size: 0.85rem;
      color: #ef4444;
      margin-bottom: 0.5rem;
    }

    .message-card-preview {
      font-size: 0.85rem;
      color: var(--text-gray);
      line-height: 1.4;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .message-card-preview i {
      color: #ef4444;
      margin-top: 2px;
    }

    .message-card-count {
      font-size: 0.75rem;
      color: #ef4444;
      margin-top: 0.5rem;
      font-weight: 500;
    }

    /* VUE CONVERSATION */
    .conversation-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 1rem;
    }

    .conversation-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-dark);
      margin-bottom: 1rem;
    }

    .conversation-back-btn {
      background: transparent;
      border: none;
      color: var(--text-gray);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .conversation-back-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-light);
    }

    .conversation-messages {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0;
    }

    .chat-message {
      display: flex;
      flex-direction: column;
      margin-bottom: 0.75rem;
    }

    .chat-message.from-comptable {
      align-items: flex-end;
    }

    .chat-message.from-entrepreneur {
      align-items: flex-start;
    }

    .chat-bubble {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 16px;
    }

    .chat-message.from-comptable .chat-bubble {
      background: rgba(59, 130, 246, 0.2);
      border-bottom-right-radius: 4px;
    }

    .chat-message.from-entrepreneur .chat-bubble {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-bottom-left-radius: 4px;
    }

    .chat-bubble .sender {
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
      font-weight: 600;
    }

    .chat-message.from-comptable .chat-bubble .sender {
      color: #60a5fa;
    }

    .chat-message.from-entrepreneur .chat-bubble .sender {
      color: #ef4444;
    }

    .chat-bubble .text {
      color: var(--text-light);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .chat-bubble .time {
      font-size: 0.65rem;
      color: var(--text-gray);
      margin-top: 0.25rem;
      text-align: right;
    }

    .chat-input-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: rgba(30, 41, 59, 0.4);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.1);
    }

    .chat-textarea {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-light);
      font-size: 0.9rem;
      resize: none;
      outline: none;
      padding: 0.25rem;
      max-height: 100px;
      font-family: inherit;
    }

    .chat-textarea::placeholder {
      color: var(--text-gray);
    }

    .btn-envoyer-chat {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .btn-envoyer-chat:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    /* Bouton Info Employ√© dans header conversation */
    .btn-info-employe {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.75rem;
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      color: #60a5fa;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-info-employe:hover {
      background: rgba(59, 130, 246, 0.25);
      border-color: rgba(59, 130, 246, 0.5);
    }

    /* Info rows pour modal info employ√© */
    .info-section {
      margin-bottom: 1.25rem;
    }

    .info-section:last-child {
      margin-bottom: 0;
    }

    .info-section-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: #60a5fa;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(96, 165, 250, 0.2);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.08);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--text-gray);
      font-size: 0.85rem;
    }

    .info-value {
      color: var(--text-light);
      font-size: 0.85rem;
      font-weight: 500;
      text-align: right;
      max-width: 60%;
    }

    .info-value.highlight {
      color: #60a5fa;
    }

    .info-value.warning {
      color: #ef4444;
    }

    .info-value.success {
      color: #10b981;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .validation-container {
        padding: 1rem;
      }

      .page-title {
        font-size: 1.5rem;
      }

      .stats-container {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 0.8rem;
      }

      thead th, tbody td {
        padding: 0.5rem;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn-validate, .btn-refuse {
        width: 100%;
        justify-content: center;
      }
    }

    /* Bouton copier */
    .btn-copy {
      background: rgba(96, 165, 250, 0.1);
      border: 1px solid rgba(96, 165, 250, 0.3);
      border-radius: 6px;
      padding: 0.25rem 0.5rem;
      color: #60a5fa;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      flex-shrink: 0;
    }

    .btn-copy:hover {
      background: rgba(96, 165, 250, 0.2);
      border-color: rgba(96, 165, 250, 0.5);
      transform: translateY(-1px);
    }

    .btn-copy.copied {
      background: rgba(34, 197, 94, 0.1);
      border-color: rgba(34, 197, 94, 0.4);
      color: #22c55e;
      animation: copyPulse 0.3s ease;
    }

    .btn-copy i {
      font-size: 0.7rem;
    }

    /* Animation de copie */
    @keyframes copyPulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    /* Custom Checkbox Styles */
    .custom-checkbox {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(96, 165, 250, 0.3);
      border-radius: 6px;
      background: var(--bg-sidebar);
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
      outline: none;
    }

    .custom-checkbox:hover {
      border-color: rgba(96, 165, 250, 0.6);
      background: rgba(96, 165, 250, 0.05);
      transform: scale(1.1);
    }

    .custom-checkbox:checked {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #3b82f6;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
    }

    .custom-checkbox:checked::after {
      content: '\f00c';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 12px;
    }

    .custom-checkbox:indeterminate {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      border-color: #8b5cf6;
    }

    .custom-checkbox:indeterminate::after {
      content: '\f068';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 10px;
    }

    .custom-checkbox:focus {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    /* Barre d'actions flottante */
    .action-bar-fin-emploi {
      display: none;
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 0.98) 100%);
      border: 1px solid rgba(96, 165, 250, 0.3);
      border-radius: 16px;
      padding: 1rem 1.5rem;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(96, 165, 250, 0.1);
      z-index: 1000;
      backdrop-filter: blur(10px);
      align-items: center;
      gap: 1rem;
    }

    .action-bar-fin-emploi.visible {
      display: flex;
      animation: slideUpBar 0.3s ease forwards;
    }

    @keyframes slideUpBar {
      from {
        opacity: 0;
        bottom: 0;
      }
      to {
        opacity: 1;
        bottom: 2rem;
      }
    }

    /* Custom Calendar */
    .custom-calendar {
      position: absolute;
      width: 280px;
      top: 100%;
      margin-top: 4px;
      left: 0;
      background: #1a2332;
      border: 2px solid var(--border-dark);
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      padding: 16px;
      z-index: 9999 !important;
    }

    .custom-calendar.hidden {
      display: none;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .calendar-month-year {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-light);
    }

    .calendar-nav-btn {
      background: #172033 !important;
      color: #60a5fa !important;
      border: 2px solid var(--border-dark) !important;
      width: 30px !important;
      height: 30px !important;
      border-radius: 50% !important;
      cursor: pointer !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-size: 16px !important;
      padding: 0 !important;
      transition: all 0.2s ease !important;
    }

    .calendar-nav-btn:hover {
      background: #3b82f6 !important;
      color: white !important;
      border-color: #3b82f6 !important;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .calendar-weekday {
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-gray);
      padding: 4px 0;
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: var(--text-light);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: transparent;
      border: 1px solid transparent;
    }

    .calendar-day:hover:not(.disabled):not(.other-month) {
      background: rgba(59, 130, 246, 0.1);
      border-color: #60a5fa;
    }

    .calendar-day.selected {
      background: #3b82f6;
      color: white;
    }

    .calendar-day.today {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
      border: 1px solid #60a5fa;
      font-weight: 600;
    }

    .calendar-day.disabled {
      color: var(--text-gray);
      opacity: 0.3;
      cursor: not-allowed;
    }

    .calendar-day.other-month {
      opacity: 0.3;
      color: var(--text-gray);
    }

    /* Animation de succ√®s pour la validation d'employ√© */
    @keyframes successFadeIn {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes checkmarkDraw {
      0% {
        stroke-dashoffset: 100;
      }
      100% {
        stroke-dashoffset: 0;
      }
    }

    .success-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: successFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .success-content {
      text-align: center;
      color: white;
      animation: successFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
    }

    .success-checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      margin: 0 auto 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
    }

    .success-checkmark svg {
      stroke: white;
      stroke-width: 3;
      stroke-dasharray: 100;
      stroke-dashoffset: 100;
      animation: checkmarkDraw 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.4s forwards;
    }
  </style>
</head>

<body class="min-h-screen" style="margin: 0; padding: 0; background: var(--bg-dark);">

  <div class="validation-container">
    <!-- Header -->
    <div class="mb-10" style="margin-top: 2rem;">
      <div class="relative">
        <h1 class="text-4xl font-bold mb-3">
          Gestion des Employ√©s
        </h1>
        <span class="absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-blue-600 to-blue-400 rounded-full"></span>
        <div class="flex items-center justify-between mt-6">
          <p class="text-xl font-medium" style="color: var(--text-gray);">Validez ou refusez les employ√©s en attente d'activation</p>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('general')" data-tab="general">
        <i class="fas fa-users" style="margin-right: 0.5rem;"></i>G√©n√©ral
      </button>
      <button class="tab" onclick="switchTab('historique')" data-tab="historique">
        <i class="fas fa-users" style="margin-right: 0.5rem;"></i>Tous les employ√©s
      </button>
    </div>

    <!-- Vue G√©n√©ral -->
    <div id="general-view" class="tab-content active">
    <!-- Layout 2 colonnes -->
    <div style="display: flex; gap: 1.5rem; align-items: stretch; height: 850px;">

      <!-- Colonne gauche: Table principale -->
      <div class="table-container" style="flex: 1; height: 850px; display: flex; flex-direction: column;">
        <div class="table-header" style="flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;">
          <h2>
            <i class="fas fa-list"></i>
            Liste des employ√©s en attente
          </h2>
          <!-- Sous-tabs Employ√©s / Messages -->
          <div style="display: flex; align-items: center; gap: 0;">
            <button id="subtab-employes" class="subtab active" onclick="switchSubTab('employes')">
              <i class="fas fa-user-clock"></i>
              <span>Employ√©s</span>
              <span id="employes-count-badge" class="subtab-count">0</span>
            </button>
            <button id="subtab-messages" class="subtab" onclick="switchSubTab('messages')">
              <i class="fas fa-envelope"></i>
              <span>Messages</span>
              <span id="messages-count-badge" class="subtab-count urgent" style="display: none;">0</span>
            </button>
          </div>
        </div>
        <div class="table-body" style="flex: 1; min-height: 0; overflow-y: auto;">
          <!-- Vue Employ√©s -->
          <div id="employes-view" style="height: 100%;">
            <div id="loading-state" class="empty-state loading-shimmer" style="height: 100%;">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Chargement des employ√©s...</p>
            </div>
            <div id="empty-state" class="empty-state" style="display: none; height: 100%;">
              <i class="fas fa-check-circle"></i>
              <p>Aucun employ√© en attente de validation</p>
            </div>
            <table id="employees-table" style="display: none; width: 100%;">
              <thead>
                <tr>
                  <th>Entrepreneur</th>
                  <th>Employ√©</th>
                  <th>Poste</th>
                  <th>Type</th>
                  <th>Date</th>
                  <th style="text-align: center;">Actions</th>
                </tr>
              </thead>
              <tbody id="employees-tbody">
              </tbody>
            </table>
          </div>

          <!-- Vue Messages -->
          <div id="messages-view" style="height: 100%; display: none;">
            <div id="messages-loading" class="empty-state loading-shimmer" style="height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Chargement des messages...</p>
            </div>
            <div id="messages-empty" class="empty-state" style="display: none; height: 100%; flex-direction: column; align-items: center; justify-content: center;">
              <i class="fas fa-inbox"></i>
              <p>Aucun message en attente</p>
            </div>
            <div id="messages-list" style="display: none; padding: 0.5rem; overflow-y: auto; height: 100%;"></div>
            <div id="conversation-view" style="display: none; height: 100%;"></div>
          </div>
        </div>
      </div>

      <!-- Colonne droite: Stats + 5 derniers valid√©s -->
      <div style="width: 340px; height: 850px; display: flex; flex-direction: column; gap: 0.75rem;">

        <!-- Employ√©s total -->
        <div style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 10px; padding: 0.875rem 1rem; display: flex; align-items: center; gap: 0.75rem;">
          <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(59, 130, 246, 0.15); display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-users" style="color: #60a5fa; font-size: 0.9rem;"></i>
          </div>
          <div style="flex: 1;">
            <div style="font-size: 0.7rem; font-weight: 500; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.3px;">Employ√©s total</div>
            <div id="stat-total" style="font-size: 1.25rem; font-weight: 700; color: var(--text-light); margin-top: 1px;">0</div>
          </div>
        </div>

        <!-- Section En attente -->
        <div style="font-size: 0.7rem; font-weight: 600; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.5px; padding-left: 0.25rem; margin-top: 0.5rem;">
          <i class="fas fa-clock" style="margin-right: 0.4rem; color: #f59e0b;"></i>En attente - √Ä traiter
        </div>

        <!-- Cards en attente -->
        <div style="display: grid; grid-template-columns: 1fr; gap: 0.5rem;">
          <!-- Validation en attente -->
          <div style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 10px; padding: 0.875rem 1rem; display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(245, 158, 11, 0.15); display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-user-clock" style="color: #f59e0b; font-size: 0.9rem;"></i>
            </div>
            <div style="flex: 1;">
              <div style="font-size: 0.7rem; font-weight: 500; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.3px;">Validation</div>
              <div id="stat-pending" style="font-size: 1.25rem; font-weight: 700; color: var(--text-light); margin-top: 1px;">0</div>
            </div>
          </div>

          <!-- Fin d'emploi en attente -->
          <div style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 10px; padding: 0.875rem 1rem; display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(239, 68, 68, 0.15); display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-user-minus" style="color: #ef4444; font-size: 0.9rem;"></i>
            </div>
            <div style="flex: 1;">
              <div style="font-size: 0.7rem; font-weight: 500; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.3px;">Fin d'emploi</div>
              <div id="stat-fin-emploi" style="font-size: 1.25rem; font-weight: 700; color: var(--text-light); margin-top: 1px;">0</div>
            </div>
          </div>

          <!-- R√©activation en attente -->
          <div style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 10px; padding: 0.875rem 1rem; display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(168, 85, 247, 0.15); display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-user-plus" style="color: #a855f7; font-size: 0.9rem;"></i>
            </div>
            <div style="flex: 1;">
              <div style="font-size: 0.7rem; font-weight: 500; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.3px;">R√©activation</div>
              <div id="stat-reactivations" style="font-size: 1.25rem; font-weight: 700; color: var(--text-light); margin-top: 1px;">0</div>
            </div>
          </div>

          <!-- Modification en attente -->
          <div style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 10px; padding: 0.875rem 1rem; display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(139, 92, 246, 0.15); display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-user-edit" style="color: #8b5cf6; font-size: 0.9rem;"></i>
            </div>
            <div style="flex: 1;">
              <div style="font-size: 0.7rem; font-weight: 500; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.3px;">Modification</div>
              <div id="stat-modifications" style="font-size: 1.25rem; font-weight: 700; color: var(--text-light); margin-top: 1px;">0</div>
            </div>
          </div>
        </div>

      </div>
    </div>
    </div>

    <!-- Vue Tous les employ√©s -->
    <div id="historique-view" class="tab-content">
      <div style="display: flex; flex-direction: column; gap: 1.5rem;">

        <!-- Table Employ√©s Actifs -->
        <div class="table-container" style="display: flex; flex-direction: column;">
          <div class="table-header" style="display: flex; flex-direction: column; gap: 1rem;">
            <h2>
              <i class="fas fa-user-check" style="color: #10b981;"></i>
              Employ√©s actifs
              <span id="compteur-tous-actifs" style="font-size: 0.8rem; color: var(--text-gray); font-weight: 400; margin-left: 0.5rem;">(0)</span>
            </h2>
            <!-- Filtres -->
            <div style="display: flex; gap: 0.75rem; align-items: end; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 200px;">
                <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Recherche</label>
                <input type="text" id="tous-actifs-search" placeholder="Nom, entrepreneur, poste, taux horaire..." onkeyup="filterTousActifs()" class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light); height: 48px;">
              </div>
              <button onclick="resetFiltersActifs()" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; padding: 0.5rem 1rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; height: 48px;">
                <i class="fas fa-times"></i>
                R√©initialiser
              </button>
            </div>
          </div>
          <div class="table-body" style="max-height: 400px; overflow-y: auto;">
            <div id="tous-actifs-loading" class="empty-state loading-shimmer">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Chargement...</p>
            </div>
            <table id="tous-actifs-table" style="display: none;">
              <thead>
                <tr>
                  <th>Entrepreneur</th>
                  <th>Employ√©</th>
                  <th>Poste</th>
                  <th>Taux horaire</th>
                  <th>Action</th>
                  <th style="width: 50px; text-align: center;">
                    <input type="checkbox" id="select-all-actifs" onchange="toggleSelectAllActifs(this)" class="custom-checkbox">
                  </th>
                </tr>
              </thead>
              <tbody id="tous-actifs-tbody">
              </tbody>
            </table>
          </div>
        </div>

        <!-- Table Employ√©s Termin√©s -->
        <div class="table-container" style="display: flex; flex-direction: column;">
          <div class="table-header" style="display: flex; flex-direction: column; gap: 1rem;">
            <h2>
              <i class="fas fa-user-times" style="color: #ef4444;"></i>
              Employ√©s termin√©s
              <span id="compteur-tous-termines" style="font-size: 0.8rem; color: var(--text-gray); font-weight: 400; margin-left: 0.5rem;">(0)</span>
            </h2>
            <!-- Filtres -->
            <div style="display: flex; gap: 0.75rem; align-items: end; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 200px;">
                <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Recherche</label>
                <input type="text" id="tous-termines-search" placeholder="Nom, entrepreneur, poste, motif, taux horaire..." onkeyup="filterTousTermines()" class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light); height: 48px;">
              </div>
              <button onclick="resetFiltersTermines()" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; padding: 0.5rem 1rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; height: 48px;">
                <i class="fas fa-times"></i>
                R√©initialiser
              </button>
            </div>
          </div>
          <div class="table-body" style="max-height: 400px; overflow-y: auto;">
            <div id="tous-termines-loading" class="empty-state loading-shimmer">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Chargement...</p>
            </div>
            <table id="tous-termines-table" style="display: none;">
              <thead>
                <tr>
                  <th>Entrepreneur</th>
                  <th>Employ√©</th>
                  <th>Poste</th>
                  <th>Motif</th>
                  <th>Date fin d'emploi</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="tous-termines-tbody">
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- Barre d'actions flottante pour fin d'emploi -->
  <div id="action-bar-fin-emploi" class="action-bar-fin-emploi">
    <span id="selection-count" style="color: var(--text-light); font-weight: 600; font-size: 0.9rem; display: flex; align-items: center;">
      <i class="fas fa-check-circle" style="color: #3b82f6; margin-right: 0.5rem;"></i>
      <span id="count-selected">0</span>&nbsp;employ√©(s) s√©lectionn√©(s)
    </span>
    <button onclick="ouvrirModalFinEmploi()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; color: white; padding: 0.6rem 1.2rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; height: 40px;">
      <i class="fas fa-user-times"></i>
      Mettre fin √† l'emploi
    </button>
    <button onclick="deselectionnerTout()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.6rem 1.2rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; height: 40px;">
      <i class="fas fa-times"></i>
      Annuler
    </button>
  </div>

  <!-- Modal Fin d'emploi avec message -->
  <div id="modal-fin-emploi" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 550px; height: auto;">
      <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <div style="width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-user-times" style="color: white; font-size: 1.5rem;"></i>
          </div>
          <div>
            <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700; color: white;">Mettre fin √† l'emploi</h3>
            <p id="modal-fin-emploi-subtitle" style="margin: 0; font-size: 0.85rem; color: rgba(255, 255, 255, 0.8);">0 employ√©(s) s√©lectionn√©(s)</p>
          </div>
        </div>
        <button onclick="fermerModalFinEmploi()" style="background: rgba(255,255,255,0.1); border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-times" style="color: white; font-size: 1rem;"></i>
        </button>
      </div>
      <div class="modal-body" style="padding: 1.5rem;">
        <!-- Liste des employ√©s s√©lectionn√©s -->
        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; font-size: 0.9rem; font-weight: 600; color: var(--text-light); margin-bottom: 0.75rem;">
            <i class="fas fa-users" style="margin-right: 0.5rem; color: #ef4444;"></i>
            Employ√©s concern√©s
          </label>
          <div id="liste-employes-fin" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 1rem; max-height: 150px; overflow-y: auto;">
            <!-- Liste dynamique -->
          </div>
        </div>

        <!-- Motif de fin d'emploi -->
        <div class="mb-4">
          <label for="motif-fin-emploi-comptable" class="block mb-2" style="color: var(--text-light); font-weight: 500;">
            Motif de fin d'emploi <span style="color: #ef4444;">*</span>
          </label>
          <select id="motif-fin-emploi-comptable" style="display: none;">
            <option value="">S√©lectionner un motif</option>
            <option value="Manque de travail">Manque de travail</option>
            <option value="Fin de saison">Fin de saison</option>
            <option value="D√©part volontaire">D√©part volontaire</option>
            <option value="D√©part volontaire : retour aux √©tudes">D√©part volontaire : retour aux √©tudes</option>
            <option value="D√©part volontaire : Vers un autre emploi">D√©part volontaire : Vers un autre emploi</option>
            <option value="Cong√©di√© dans les 3 premiers mois : Manquement disciplinaire">Cong√©di√© dans les 3 premiers mois : Manquement disciplinaire</option>
            <option value="Cong√©di√© dans les 3 premiers mois : Manque comp√©tence">Cong√©di√© dans les 3 premiers mois : Manque comp√©tence</option>
            <option value="Ne s'est jamais pr√©sent√©">Ne s'est jamais pr√©sent√©</option>
            <option value="Cong√© parental">Cong√© parental</option>
          </select>
          <div class="custom-select" data-target="motif-fin-emploi-comptable">
            <div class="custom-select-button" tabindex="0">
              <span class="custom-select-text">S√©lectionner un motif</span>
              <span class="custom-select-arrow">‚ñº</span>
            </div>
            <div class="custom-select-dropdown">
              <div class="custom-select-option selected" data-value="">S√©lectionner un motif</div>
              <div class="custom-select-option" data-value="Manque de travail">Manque de travail</div>
              <div class="custom-select-option" data-value="Fin de saison">Fin de saison</div>
              <div class="custom-select-option" data-value="D√©part volontaire">D√©part volontaire</div>
              <div class="custom-select-option" data-value="D√©part volontaire : retour aux √©tudes">D√©part volontaire : retour aux √©tudes</div>
              <div class="custom-select-option" data-value="D√©part volontaire : Vers un autre emploi">D√©part volontaire : Vers un autre emploi</div>
              <div class="custom-select-option" data-value="Cong√©di√© dans les 3 premiers mois : Manquement disciplinaire">Cong√©di√© dans les 3 premiers mois : Manquement disciplinaire</div>
              <div class="custom-select-option" data-value="Cong√©di√© dans les 3 premiers mois : Manque comp√©tence">Cong√©di√© dans les 3 premiers mois : Manque comp√©tence</div>
              <div class="custom-select-option" data-value="Ne s'est jamais pr√©sent√©">Ne s'est jamais pr√©sent√©</div>
              <div class="custom-select-option" data-value="Cong√© parental">Cong√© parental</div>
            </div>
          </div>
        </div>

        <!-- Justificatif -->
        <div class="mb-4">
          <label for="justificatif-fin-emploi-comptable" class="block mb-2" style="color: var(--text-light); font-weight: 500;">
            Justificatif
          </label>
          <textarea id="justificatif-fin-emploi-comptable" class="form-input w-full" rows="5" placeholder="Entrez les d√©tails ou justifications..." style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-light); padding: 0.75rem; border-radius: 8px; resize: none;"></textarea>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1rem 1.5rem; border-top: 1px solid var(--border-dark);">
        <button onclick="fermerModalFinEmploi()" class="btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;">
          <i class="fas fa-times"></i>
          Refuser
        </button>
        <button onclick="confirmerFinEmploi()" class="btn-primary" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;">
          <i class="fas fa-check"></i>
          Valider
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Info Employ√© -->
  <div id="employee-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <div id="modal-avatar" style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.25rem;"></div>
          <div>
            <h3 id="modal-title" style="margin: 0; font-size: 1.25rem; font-weight: 700; color: white;"></h3>
            <p id="modal-subtitle" style="margin: 0; font-size: 0.85rem; color: rgba(148, 163, 184, 0.8);"></p>
          </div>
        </div>
        <button onclick="closeModal()" style="background: rgba(255,255,255,0.1); border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-times" style="color: white; font-size: 1rem;"></i>
        </button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Contenu dynamique -->
      </div>
      <div class="modal-footer" id="modal-footer">
        <!-- Boutons dynamiques -->
      </div>
    </div>
  </div>

  <!-- Modal Refus avec Raison -->
  <div id="modalRefusEmploye" class="modal-refus-employe" style="display: none;">
    <div class="modal-refus-backdrop" onclick="fermerModalRefusEmploye()"></div>
    <div class="modal-refus-content">
      <div class="modal-refus-header">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          <i class="fas fa-times-circle" style="color: #ef4444; font-size: 1.5rem;"></i>
          <h2 style="margin: 0; color: white; font-size: 1.25rem;" id="modalRefusTitre">Refuser</h2>
        </div>
        <button onclick="fermerModalRefusEmploye()" style="background: rgba(255,255,255,0.1); border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-times" style="color: white;"></i>
        </button>
      </div>
      <div class="modal-refus-body">
        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <i class="fas fa-user" style="color: #ef4444;"></i>
            <span style="color: #ef4444; font-weight: 600;" id="modalRefusNomEmploye">-</span>
          </div>
          <div style="color: var(--text-gray); font-size: 0.85rem;" id="modalRefusTypeAction">-</div>
        </div>
        <p style="color: var(--text-gray); margin-bottom: 1rem; font-size: 0.9rem;">
          Veuillez indiquer la raison du refus. Cette information sera transmise √† l'entrepreneur.
        </p>
        <div>
          <label style="color: var(--text-light); font-weight: 500; margin-bottom: 0.5rem; display: block;">
            Raison du refus <span style="color: #ef4444;">*</span>
          </label>
          <textarea
            id="raisonRefusEmploye"
            placeholder="Expliquez la raison du refus..."
            rows="4"
            style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.5); color: var(--text-light); font-size: 0.9rem; resize: vertical;"
          ></textarea>
        </div>
      </div>
      <div class="modal-refus-footer">
        <button class="btn-primary" style="background: rgba(100, 116, 139, 0.3) !important;" onclick="fermerModalRefusEmploye()">
          <i class="fas fa-arrow-left"></i> Annuler
        </button>
        <button class="btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;" onclick="confirmerRefusEmploye()">
          <i class="fas fa-times"></i> Confirmer le refus
        </button>
      </div>
    </div>
  </div>

  <style>
    /* Modal Refus avec Raison */
    .modal-refus-employe {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 100001;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-refus-employe .modal-refus-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
    }

    .modal-refus-employe .modal-refus-content {
      position: relative;
      background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 30px rgba(239, 68, 68, 0.1);
      animation: modalSlideIn 0.3s ease-out;
    }

    .modal-refus-employe .modal-refus-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      background: rgba(239, 68, 68, 0.1);
      border-bottom: 1px solid rgba(239, 68, 68, 0.2);
    }

    .modal-refus-employe .modal-refus-body {
      padding: 1.5rem;
    }

    .modal-refus-employe .modal-refus-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      background: rgba(15, 23, 42, 0.5);
      border-top: 1px solid rgba(148, 163, 184, 0.1);
    }
    /* Styles pour la recherche d'historique */
    #historique-search:hover {
      border-color: var(--primary-blue);
    }
    #historique-search:focus {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }
    #historique-search::placeholder {
      color: var(--text-gray);
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease;
    }
    .modal-overlay-opaque {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      animation: fadeIn 0.2s ease;
    }
    .viewer-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.9);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
    }
    .viewer-close:hover {
      background: rgba(220, 38, 38, 1);
      transform: scale(1.1);
    }
    .viewer-content {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: auto;
    }
    .modal-content {
      position: relative;
      background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 20px;
      width: 95vw;
      max-width: 1200px;
      height: auto;
      max-height: 95vh;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease;
    }
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-body {
      padding: 0.75rem 1rem;
      overflow-y: auto;
    }
    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }
    .info-section {
      margin-bottom: 0.75rem;
    }
    .info-section-title {
      font-size: 0.65rem;
      font-weight: 600;
      color: rgba(148, 163, 184, 0.7);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.4rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.25rem;
    }
    .info-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      padding: 0.5rem;
    }
    .info-label {
      font-size: 0.65rem;
      color: rgba(148, 163, 184, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 0.15rem;
    }
    .info-value {
      font-size: 0.8rem;
      font-weight: 600;
      color: white;
    }
    .info-item.full-width {
      grid-column: span 2;
    }
    .btn-modal {
      padding: 0.625rem 1.25rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
    }
    .btn-modal-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    .btn-modal-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    .btn-modal-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .btn-modal-success:hover {
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    .btn-modal-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    .btn-modal-danger:hover {
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
    .btn-info {
      background: rgba(96, 165, 250, 0.15);
      border: 1px solid rgba(96, 165, 250, 0.3);
      color: #60a5fa;
      padding: 0.4rem 0.75rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: all 0.2s ease;
    }
    .btn-info:hover {
      background: rgba(96, 165, 250, 0.25);
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>

  <script>
    let employesEnAttente = [];
    let inactivationsEnAttente = [];
    let reactivationsEnAttente = [];
    let modificationsEnAttente = [];
    let statsData = { total: 0, pending: 0, finEmploi: 0 };
    let derniersValides = [];
    let allEmployesData = {}; // Stockage des donn√©es compl√®tes
    let historiqueComplet = []; // Stockage de l'historique pour filtrage

    // Fonction pour afficher l'animation de succ√®s
    function showSuccessAnimation(message) {
      const overlay = document.createElement('div');
      overlay.className = 'success-overlay';
      overlay.innerHTML = `
        <div class="success-content">
          <div class="success-checkmark">
            <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
              <path d="M8 20 L16 28 L32 12" stroke="white" stroke-width="3"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">${message}</h2>
        </div>
      `;

      document.body.appendChild(overlay);

      // Supprimer l'overlay apr√®s l'animation
      setTimeout(() => {
        overlay.remove();
      }, 1500);
    }

    // Fonction pour copier le texte dans le presse-papiers
    function copierTexte(texte, btnElement) {
      navigator.clipboard.writeText(texte).then(() => {
        // Changer l'apparence du bouton
        const icon = btnElement.querySelector('i');
        const originalIcon = icon.className;

        btnElement.classList.add('copied');
        icon.className = 'fas fa-check';

        // Revenir √† l'√©tat original apr√®s 1 seconde
        setTimeout(() => {
          btnElement.classList.remove('copied');
          icon.className = originalIcon;
        }, 1000);
      }).catch(err => {
        console.error('Erreur lors de la copie:', err);
      });
    }

    // ========== MODAL REFUS AVEC RAISON ==========
    let refusContext = {
      entrepreneur: null,
      employeId: null,
      employeNom: null,
      typeAction: null // 'employe', 'inactivation', 'reactivation', 'modification'
    };

    function ouvrirModalRefusEmploye(entrepreneur, employeId, employeNom, typeAction) {
      refusContext = { entrepreneur, employeId, employeNom, typeAction };

      // Mettre √† jour le contenu du modal
      document.getElementById('modalRefusNomEmploye').textContent = employeNom;

      let typeLabel = '';
      switch(typeAction) {
        case 'employe':
          typeLabel = 'Refus de validation d\'employ√©';
          break;
        case 'inactivation':
          typeLabel = 'Refus de fin d\'emploi';
          break;
        case 'reactivation':
          typeLabel = 'Refus de r√©activation';
          break;
        case 'modification':
          typeLabel = 'Refus de modification';
          break;
      }
      document.getElementById('modalRefusTypeAction').textContent = typeLabel;

      // Vider le textarea
      document.getElementById('raisonRefusEmploye').value = '';

      // Afficher le modal
      document.getElementById('modalRefusEmploye').style.display = 'flex';
    }

    function fermerModalRefusEmploye() {
      document.getElementById('modalRefusEmploye').style.display = 'none';
      refusContext = { entrepreneur: null, employeId: null, employeNom: null, typeAction: null };
    }

    async function confirmerRefusEmploye() {
      const raison = document.getElementById('raisonRefusEmploye').value.trim();

      if (!raison) {
        showErrorNotification('Veuillez indiquer une raison pour le refus');
        document.getElementById('raisonRefusEmploye').focus();
        return;
      }

      const { entrepreneur, employeId, employeNom, typeAction } = refusContext;

      let url = '';
      let successMessage = '';

      switch(typeAction) {
        case 'employe':
          url = `/api/employes/${entrepreneur}/refuser/${employeId}`;
          successMessage = `L'employ√© "${employeNom}" a √©t√© refus√©`;
          break;
        case 'inactivation':
          url = `/api/employes/${entrepreneur}/refuser-inactivation/${employeId}`;
          successMessage = `La demande de fin d'emploi pour "${employeNom}" a √©t√© refus√©e`;
          break;
        case 'reactivation':
          // Utiliser l'endpoint selon le r√¥le
          const userRole = localStorage.getItem('userRole');
          url = (userRole === 'coach')
            ? `/api/coach/reactivations/refuser/${entrepreneur}/${employeId}`
            : `/api/comptable/reactivations/refuser/${entrepreneur}/${employeId}`;
          successMessage = `La demande de r√©activation pour "${employeNom}" a √©t√© refus√©e`;
          break;
        case 'modification':
          url = `/api/employes/${entrepreneur}/refuser-modification/${employeId}`;
          successMessage = `La demande de modification pour "${employeNom}" a √©t√© refus√©e`;
          break;
      }

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ motif_refus: raison })
        });

        if (!response.ok) {
          throw new Error('Erreur lors du refus');
        }

        // Fermer le modal
        fermerModalRefusEmploye();

        // Recharger la liste
        await loadEmployesEnAttente();

        // Notifier le parent pour mettre √† jour le badge
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
        }

        showSuccessMessage(successMessage);

      } catch (error) {
        console.error('Erreur:', error);
        showErrorNotification('Erreur lors du refus');
      }
    }

    // ========== SYST√àME DE SOUS-TABS EMPLOY√âS / MESSAGES ==========
    let messagesRefusEnAttente = [];
    let currentConversationRefus = null;

    function switchSubTab(tab) {
      // Mettre √† jour les boutons
      document.getElementById('subtab-employes').classList.toggle('active', tab === 'employes');
      document.getElementById('subtab-messages').classList.toggle('active', tab === 'messages');

      // Afficher/masquer les vues
      document.getElementById('employes-view').style.display = tab === 'employes' ? 'block' : 'none';
      document.getElementById('messages-view').style.display = tab === 'messages' ? 'block' : 'none';

      // Si on passe aux messages, charger la liste
      if (tab === 'messages') {
        afficherListeMessagesRefus();
      }
    }

    // Charger les messages de refus en attente
    async function chargerMessagesRefusEnAttente() {
      try {
        const response = await fetch('/api/comptable/messages-refus-employes');
        if (!response.ok) {
          throw new Error('Erreur lors du chargement des messages');
        }

        const data = await response.json();
        messagesRefusEnAttente = data.messages || [];

        // Mettre √† jour le badge
        const count = messagesRefusEnAttente.length;
        const badge = document.getElementById('messages-count-badge');
        if (badge) {
          badge.textContent = count;
          badge.style.display = count > 0 ? 'inline-flex' : 'none';
        }

      } catch (error) {
        console.error('[Coach Validation] Erreur chargement messages refus:', error);
      }
    }

    // Afficher la liste des messages de refus
    function afficherListeMessagesRefus() {
      const loadingEl = document.getElementById('messages-loading');
      const emptyEl = document.getElementById('messages-empty');
      const listEl = document.getElementById('messages-list');
      const convEl = document.getElementById('conversation-view');

      // Cacher la conversation et le loading si ouverts
      convEl.style.display = 'none';
      loadingEl.style.display = 'none';

      if (messagesRefusEnAttente.length === 0) {
        emptyEl.style.display = 'flex';
        listEl.style.display = 'none';
        return;
      }

      emptyEl.style.display = 'none';
      listEl.style.display = 'block';

      listEl.innerHTML = messagesRefusEnAttente.map((msg, index) => {
        const initiales = msg.entrepreneur.substring(0, 2).toUpperCase();
        const dernierMessage = msg.conversation && msg.conversation.length > 0
          ? msg.conversation[msg.conversation.length - 1].message
          : 'Aucun message';
        const nombreMessages = msg.conversation ? msg.conversation.filter(m => m.de === 'entrepreneur').length : 0;

        return `
          <div class="message-card" onclick="afficherConversationRefusComptable(${index})">
            <div class="message-card-header">
              <div class="message-card-entrepreneur">
                <div class="avatar">${initiales}</div>
                <span class="name">${msg.entrepreneur}</span>
              </div>
              <span class="message-card-date">${new Date(msg.dernierUpdate).toLocaleString('fr-CA')}</span>
            </div>
            <div class="message-card-employe">
              <i class="fas fa-user"></i> ${msg.employeNom}
            </div>
            <div class="message-card-preview">
              <i class="fas fa-comment"></i>
              <span>${dernierMessage.substring(0, 100)}${dernierMessage.length > 100 ? '...' : ''}</span>
            </div>
            ${nombreMessages > 0 ? `<div class="message-card-count">${nombreMessages} r√©ponse${nombreMessages > 1 ? 's' : ''} de l'entrepreneur</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // Afficher une conversation de refus
    async function afficherConversationRefusComptable(index) {
      const msgData = messagesRefusEnAttente[index];
      currentConversationRefus = {
        entrepreneur: msgData.entrepreneur,
        employeId: msgData.employeId,
        employeNom: msgData.employeNom,
        employe: msgData.employe || {}
      };

      const listEl = document.getElementById('messages-list');
      const convEl = document.getElementById('conversation-view');
      const loadingEl = document.getElementById('messages-loading');

      listEl.style.display = 'none';
      loadingEl.style.display = 'flex';

      try {
        // Charger la conversation fra√Æche
        const response = await fetch(`/api/employes/${msgData.entrepreneur}/refus-conversation/${msgData.employeId}`);
        const data = await response.json();
        const conversation = data.conversation || [];

        loadingEl.style.display = 'none';
        convEl.style.display = 'block';
        convEl.innerHTML = `
          <div class="conversation-container">
            <div class="conversation-header">
              <button class="conversation-back-btn" onclick="retourListeMessagesRefus()">
                <i class="fas fa-arrow-left"></i>
              </button>
              <div style="flex: 1;">
                <div style="font-weight: 600; color: var(--text-light);">${msgData.employeNom}</div>
                <div style="font-size: 0.8rem; color: var(--text-gray);">
                  <i class="fas fa-user-tie"></i> ${msgData.entrepreneur}
                </div>
              </div>
              <button class="btn-info-employe" onclick="afficherInfoEmployeConversation()">
                <i class="fas fa-info-circle"></i>
                Info employ√©
              </button>
            </div>

            <div class="conversation-messages" id="conversation-messages-container">
              ${conversation.map(msg => `
                <div class="chat-message ${msg.de === 'comptable' ? 'from-comptable' : 'from-entrepreneur'}">
                  <div class="chat-bubble">
                    <div class="sender">${msg.de === 'comptable' ? 'Vous (Direction)' : msgData.entrepreneur}</div>
                    <div class="text">${msg.message}</div>
                    <div class="time">${new Date(msg.date).toLocaleString('fr-CA')}</div>
                  </div>
                </div>
              `).join('')}
            </div>

            <div class="chat-input-container">
              <textarea
                id="chat-message-input-refus"
                placeholder="Votre r√©ponse..."
                rows="1"
                class="chat-textarea"
                onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); envoyerMessageRefusComptable(); }"
              ></textarea>
              <button class="btn-envoyer-chat" onclick="envoyerMessageRefusComptable()" title="Envoyer">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        `;

        // Scroller vers le bas
        const messagesContainer = document.getElementById('conversation-messages-container');
        if (messagesContainer) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

      } catch (error) {
        console.error('[Coach Validation] Erreur conversation:', error);
        loadingEl.style.display = 'none';
        retourListeMessagesRefus();
      }
    }

    // Afficher le modal info employ√© depuis la conversation
    function afficherInfoEmployeConversation() {
      const emp = currentConversationRefus.employe || {};
      const initiales = (emp.nom || '?').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'modal-info-employe-conv';
      modal.style.display = 'flex';
      modal.style.zIndex = '100002';
      modal.onclick = (e) => { if (e.target === modal) fermerInfoEmployeConversation(); };

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px; width: 95%; height: auto;">
          <div class="modal-header">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.25rem;">${initiales}</div>
              <div>
                <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700; color: white;">${emp.nom || 'Employ√©'}</h3>
                <p style="margin: 0; font-size: 0.85rem; color: rgba(148, 163, 184, 0.8);">${emp.posteService || emp.poste || 'Poste non d√©fini'}</p>
              </div>
            </div>
            <button onclick="fermerInfoEmployeConversation()" style="background: rgba(255,255,255,0.1); border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-times" style="color: white; font-size: 1rem;"></i>
            </button>
          </div>
          <div class="modal-body" style="padding: 1.5rem; height: auto; max-height: none;">
            <!-- Layout 2 colonnes -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
              <!-- Colonne gauche -->
              <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <!-- Box Identit√© -->
                <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 0.75rem;">
                  <div style="font-size: 0.75rem; font-weight: 600; color: rgba(96, 165, 250, 0.9); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.6rem;">
                    <i class="fas fa-user"></i> Identit√©
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem;">
                    <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500;">Nom complet</div>
                    <button class="btn-copy" onclick="copierTexte('${(emp.nom || '-').replace(/'/g, "\\'")}', this)">
                      <i class="fas fa-copy"></i> Copier
                    </button>
                  </div>
                  <div style="font-weight: 600; color: #fff; font-size: 1.05rem; margin-bottom: 0.5rem;">${emp.nom || '-'}</div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <div>
                      <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500;">Genre</div>
                      <div style="font-weight: 500; color: #cbd5e1; font-size: 0.95rem;">${emp.genre || '-'}</div>
                    </div>
                    <div>
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500;">NAS</div>
                        <button class="btn-copy" onclick="copierTexte('${emp.nas || '-'}', this)" style="padding: 0.15rem 0.4rem; font-size: 0.65rem;">
                          <i class="fas fa-copy"></i>
                        </button>
                      </div>
                      <div style="font-weight: 500; color: #60a5fa; font-size: 0.95rem;">${emp.nas || '-'}</div>
                    </div>
                  </div>
                </div>

                <!-- Box Contact -->
                <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 8px; padding: 0.75rem;">
                  <div style="font-size: 0.75rem; font-weight: 600; color: rgba(148, 163, 184, 0.7); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.6rem;">
                    <i class="fas fa-phone"></i> Contact
                  </div>
                  <div style="margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                      <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500;">Courriel</div>
                      <button class="btn-copy" onclick="copierTexte('${emp.courriel || '-'}', this)">
                        <i class="fas fa-copy"></i> Copier
                      </button>
                    </div>
                    <div style="font-weight: 500; color: #cbd5e1; font-size: 0.95rem;">${emp.courriel || '-'}</div>
                  </div>
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                      <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500;">T√©l√©phone</div>
                      <button class="btn-copy" onclick="copierTexte('${emp.telephone || '-'}', this)">
                        <i class="fas fa-copy"></i> Copier
                      </button>
                    </div>
                    <div style="font-weight: 500; color: #cbd5e1; font-size: 0.95rem;">${emp.telephone || '-'}</div>
                  </div>
                </div>
              </div>

              <!-- Colonne droite -->
              <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <!-- Box Adresse -->
                <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 8px; padding: 0.75rem;">
                  <div style="font-size: 0.75rem; font-weight: 600; color: rgba(148, 163, 184, 0.7); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.6rem;">
                    <i class="fas fa-map-marker-alt"></i> Adresse
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                    <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500;">Adresse compl√®te</div>
                    <button class="btn-copy" onclick="copierTexte('${(emp.adresse || '-').replace(/'/g, "\\'")}${emp.appartement && emp.appartement !== '-' ? ', App. ' + emp.appartement : ''}, ${emp.ville || ''} ${emp.codePostal || ''}', this)">
                      <i class="fas fa-copy"></i> Copier
                    </button>
                  </div>
                  <div style="font-weight: 500; color: #cbd5e1; font-size: 0.95rem; margin-bottom: 0.3rem;">${emp.adresse || '-'}${emp.appartement && emp.appartement !== '-' ? ', App. ' + emp.appartement : ''}</div>
                  <div style="font-weight: 500; color: #94a3b8; font-size: 0.9rem;">${emp.ville || '-'}, ${emp.codePostal || '-'}</div>
                </div>

                <!-- Box Emploi -->
                <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 0.75rem;">
                  <div style="font-size: 0.75rem; font-weight: 600; color: rgba(16, 185, 129, 0.9); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.6rem;">
                    <i class="fas fa-briefcase"></i> Emploi
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <div>
                      <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500;">Poste</div>
                      <div style="font-weight: 600; color: #10b981; font-size: 0.95rem;">${emp.posteService || emp.poste || '-'}</div>
                    </div>
                    <div>
                      <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500;">Taux horaire</div>
                      <div style="font-weight: 600; color: #10b981; font-size: 0.95rem;">${emp.tauxHoraire ? emp.tauxHoraire + ' $/h' : '-'}</div>
                    </div>
                    <div>
                      <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500;">Date d√©but</div>
                      <div style="font-weight: 500; color: #cbd5e1; font-size: 0.95rem;">${emp.datePremiere || '-'}</div>
                    </div>
                    <div>
                      <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500;">Date candidature</div>
                      <div style="font-weight: 500; color: #cbd5e1; font-size: 0.95rem;">${emp.dateCandidature || '-'}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            ${emp.motif_refus_comptable || emp.motif_refus_coach ? `
              <!-- Box Motif de refus - pleine largeur -->
              <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 0.75rem; margin-top: 0.75rem;">
                <div style="font-size: 0.75rem; font-weight: 600; color: rgba(239, 68, 68, 0.9); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.6rem;">
                  <i class="fas fa-exclamation-triangle"></i> Motif de refus
                </div>
                <div style="display: grid; grid-template-columns: ${emp.motif_refus_comptable && emp.motif_refus_coach ? '1fr 1fr' : '1fr'}; gap: 1rem;">
                  ${emp.motif_refus_comptable ? `
                    <div>
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                        <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500;">Par comptable</div>
                        <button class="btn-copy" onclick="copierTexte('${(emp.motif_refus_comptable || '-').replace(/'/g, "\\'")}', this)">
                          <i class="fas fa-copy"></i> Copier
                        </button>
                      </div>
                      <div style="font-weight: 600; color: #ef4444; font-size: 0.95rem;">${emp.motif_refus_comptable}</div>
                      <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.6); margin-top: 0.25rem;">${emp.date_refus_comptable || ''}</div>
                    </div>
                  ` : ''}
                  ${emp.motif_refus_coach ? `
                    <div>
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                        <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500;">Par coach</div>
                        <button class="btn-copy" onclick="copierTexte('${(emp.motif_refus_coach || '-').replace(/'/g, "\\'")}', this)">
                          <i class="fas fa-copy"></i> Copier
                        </button>
                      </div>
                      <div style="font-weight: 600; color: #ef4444; font-size: 0.95rem;">${emp.motif_refus_coach}</div>
                      <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.6); margin-top: 0.25rem;">${emp.date_refus_coach || ''}</div>
                    </div>
                  ` : ''}
                </div>
              </div>
            ` : ''}
          </div>
          <div class="modal-footer" style="justify-content: flex-end;">
            <button class="btn-primary" onclick="fermerInfoEmployeConversation()" style="background: rgba(100, 116, 139, 0.3) !important;">
              <i class="fas fa-times"></i> Fermer
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    // Fermer le modal info employ√©
    function fermerInfoEmployeConversation() {
      const modal = document.getElementById('modal-info-employe-conv');
      if (modal) modal.remove();
    }

    // Retourner √† la liste des messages
    function retourListeMessagesRefus() {
      document.getElementById('conversation-view').style.display = 'none';
      currentConversationRefus = null;
      afficherListeMessagesRefus();
    }

    // Envoyer un message dans la conversation de refus
    async function envoyerMessageRefusComptable() {
      if (!currentConversationRefus) return;

      const input = document.getElementById('chat-message-input-refus');
      const message = input.value.trim();

      if (!message) return;

      try {
        const response = await fetch(`/api/employes/${currentConversationRefus.entrepreneur}/refus-conversation/${currentConversationRefus.employeId}/message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, de: 'comptable' })
        });

        if (!response.ok) {
          throw new Error('Erreur lors de l\'envoi');
        }

        // Vider l'input
        input.value = '';

        // Recharger les messages
        await chargerMessagesRefusEnAttente();

        // R√©afficher la conversation
        const index = messagesRefusEnAttente.findIndex(m =>
          m.entrepreneur === currentConversationRefus.entrepreneur &&
          m.employeId === currentConversationRefus.employeId
        );
        if (index >= 0) {
          afficherConversationRefusComptable(index);
        }

      } catch (error) {
        console.error('[Coach Validation] Erreur envoi message:', error);
        showErrorNotification('Erreur lors de l\'envoi du message');
      }
    }

    // Charger les employ√©s en attente comptable (valid√©s par coach), inactivations, r√©activations ET modifications
    async function loadEmployesEnAttente() {
      try {
        // Charger les validations, inactivations, r√©activations et modifications en parall√®le
        const [responseEmployes, responseInactivations, responseReactivations, responseModifications] = await Promise.all([
          fetch('/api/comptable/employes-en-attente/liste'),
          fetch('/api/comptable/inactivations-en-attente/liste'),
          fetch('/api/comptable/reactivations-en-attente/liste'),
          fetch('/api/comptable/modifications-en-attente/liste')
        ]);

        if (!responseEmployes.ok) {
          throw new Error('Erreur lors du chargement des employ√©s');
        }

        const dataEmployes = await responseEmployes.json();
        employesEnAttente = (dataEmployes.employes || []).map(emp => ({
          ...emp,
          requestType: 'validation' // Marquer comme demande de validation
        }));

        // Charger les inactivations si disponibles
        if (responseInactivations.ok) {
          const dataInactivations = await responseInactivations.json();
          inactivationsEnAttente = (dataInactivations.inactivations || []).map(emp => ({
            ...emp,
            requestType: 'inactivation' // Marquer comme demande d'inactivation
          }));
        }

        // Charger les r√©activations si disponibles
        if (responseReactivations.ok) {
          const dataReactivations = await responseReactivations.json();
          reactivationsEnAttente = (dataReactivations.reactivations || []).map(emp => ({
            ...emp,
            requestType: 'reactivation' // Marquer comme demande de r√©activation
          }));
        }

        // Charger les modifications si disponibles
        if (responseModifications.ok) {
          const dataModifications = await responseModifications.json();
          console.log('Raw modifications data:', dataModifications);
          modificationsEnAttente = (dataModifications.modifications || []).map(emp => ({
            ...emp,
            requestType: 'modification' // Marquer comme demande de modification
          }));
        } else {
          console.error('Erreur chargement modifications:', responseModifications.status, responseModifications.statusText);
        }

        console.log('Employ√©s en attente comptable charg√©s:', employesEnAttente);
        console.log('Inactivations en attente comptable charg√©es:', inactivationsEnAttente);
        console.log('R√©activations en attente comptable charg√©es:', reactivationsEnAttente);
        console.log('Modifications en attente comptable charg√©es:', modificationsEnAttente);
        console.log('Total allRequests:', [...employesEnAttente, ...inactivationsEnAttente, ...reactivationsEnAttente, ...modificationsEnAttente].length);

        // Mettre √† jour les stats
        updateStats();

        // Afficher tous les employ√©s (validations + inactivations)
        displayEmployes();

      } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('loading-state').innerHTML = `
          <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
          <p>Erreur lors du chargement des employ√©s</p>
        `;
      }
    }

    // Charger les statistiques globales
    async function loadStats() {
      try {
        const response = await fetch('/api/coach/employes/stats');
        if (response.ok) {
          const data = await response.json();
          statsData = data;
          document.getElementById('stat-total').textContent = data.total || 0;
          document.getElementById('stat-fin-emploi').textContent = data.finEmploi || 0;
        }
      } catch (error) {
        console.error('Erreur chargement stats:', error);
      }
    }

    // Formatter la date
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      if (date.toDateString() === today.toDateString()) {
        return "Aujourd'hui";
      } else if (date.toDateString() === yesterday.toDateString()) {
        return 'Hier';
      } else {
        return date.toLocaleDateString('fr-CA', { day: 'numeric', month: 'short' });
      }
    }

    // Changer d'onglet
    function switchTab(tabName) {
      // Mettre √† jour les boutons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        }
      });

      // Mettre √† jour le contenu
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      if (tabName === 'general') {
        document.getElementById('general-view').classList.add('active');
      } else if (tabName === 'historique') {
        document.getElementById('historique-view').classList.add('active');
        loadTousLesEmployes();
      }
    }

    // Variables pour stocker tous les employ√©s
    let tousActifsData = [];
    let tousTerminesData = [];

    // Charger tous les employ√©s (actifs et termin√©s de tous les entrepreneurs)
    async function loadTousLesEmployes() {
      // Charger les actifs
      const loadingActifs = document.getElementById('tous-actifs-loading');
      const tableActifs = document.getElementById('tous-actifs-table');

      // Charger les termin√©s
      const loadingTermines = document.getElementById('tous-termines-loading');
      const tableTermines = document.getElementById('tous-termines-table');

      loadingActifs.style.display = 'block';
      tableActifs.style.display = 'none';
      loadingTermines.style.display = 'block';
      tableTermines.style.display = 'none';

      try {
        const response = await fetch('/api/direction/tous-employes');
        if (!response.ok) {
          throw new Error('Erreur lors du chargement');
        }

        const data = await response.json();
        tousActifsData = data.actifs || [];
        tousTerminesData = data.termines || [];

        // Afficher les actifs
        displayTousActifs(tousActifsData);

        // Afficher les termin√©s
        displayTousTermines(tousTerminesData);

      } catch (error) {
        console.error('Erreur chargement tous les employ√©s:', error);
        loadingActifs.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i><p>Erreur lors du chargement</p>';
        loadingTermines.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i><p>Erreur lors du chargement</p>';
      }
    }

    // Afficher les employ√©s actifs
    function displayTousActifs(employes) {
      const table = document.getElementById('tous-actifs-table');
      const tbody = document.getElementById('tous-actifs-tbody');
      const loading = document.getElementById('tous-actifs-loading');
      const compteur = document.getElementById('compteur-tous-actifs');

      compteur.textContent = `(${employes.length})`;

      if (employes.length === 0) {
        table.style.display = 'none';
        loading.style.display = 'block';
        loading.innerHTML = '<i class="fas fa-inbox" style="color: var(--text-gray);"></i><p>Aucun employ√© actif</p>';
        return;
      }

      loading.style.display = 'none';
      table.style.display = 'table';
      tbody.innerHTML = '';

      employes.forEach((emp, index) => {
        const empId = `actif_${index}_${Date.now()}`;
        allEmployesData[empId] = emp;

        const photoHtml = emp.entrepreneurPhoto
          ? `<img src="${emp.entrepreneurPhoto}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(16, 185, 129, 0.3);">`
          : `<div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.75rem;">${emp.entrepreneur ? emp.entrepreneur.charAt(0).toUpperCase() : '?'}</div>`;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              ${photoHtml}
              <span style="font-weight: 600; color: white;">${emp.entrepreneur || '-'}</span>
            </div>
          </td>
          <td style="font-weight: 600; color: white;">${emp.nom || '-'}</td>
          <td>${emp.poste || emp.posteService || '-'}</td>
          <td>${emp.tauxHoraire ? parseFloat(emp.tauxHoraire).toFixed(2) + ' $' : '-'}</td>
          <td>
            <button class="btn-info" onclick="showEmployeeInfo(allEmployesData['${empId}'], true)">
              <i class="fas fa-info-circle"></i>
              Info
            </button>
          </td>
          <td style="text-align: center;">
            <input type="checkbox" class="employe-actif-checkbox custom-checkbox"
              data-emp-id="${emp.id}"
              data-emp-nom="${(emp.nom || '').replace(/"/g, '&quot;')}"
              data-entrepreneur="${(emp.entrepreneur || '').replace(/"/g, '&quot;')}"
              data-entrepreneur-username="${(emp.entrepreneurUsername || '').replace(/"/g, '&quot;')}"
              onchange="updateActionBarFinEmploi()">
          </td>
        `;
        tbody.appendChild(row);
      });

      // R√©initialiser le checkbox "select all"
      const selectAllCheckbox = document.getElementById('select-all-actifs');
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
      updateActionBarFinEmploi();
    }

    // Afficher les employ√©s termin√©s
    function displayTousTermines(employes) {
      const table = document.getElementById('tous-termines-table');
      const tbody = document.getElementById('tous-termines-tbody');
      const loading = document.getElementById('tous-termines-loading');
      const compteur = document.getElementById('compteur-tous-termines');

      compteur.textContent = `(${employes.length})`;

      if (employes.length === 0) {
        table.style.display = 'none';
        loading.style.display = 'block';
        loading.innerHTML = '<i class="fas fa-inbox" style="color: var(--text-gray);"></i><p>Aucun employ√© termin√©</p>';
        return;
      }

      loading.style.display = 'none';
      table.style.display = 'table';
      tbody.innerHTML = '';

      employes.forEach((emp, index) => {
        const empId = `termine_${index}_${Date.now()}`;
        allEmployesData[empId] = emp;

        const photoHtml = emp.entrepreneurPhoto
          ? `<img src="${emp.entrepreneurPhoto}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(239, 68, 68, 0.3);">`
          : `<div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.75rem;">${emp.entrepreneur ? emp.entrepreneur.charAt(0).toUpperCase() : '?'}</div>`;

        // Debug: afficher les champs de date disponibles
        console.log(`Employee ${emp.nom}: dateFinEmploi=${emp.dateFinEmploi}, date_fin_emploi=${emp.date_fin_emploi}, date_inactivation=${emp.date_inactivation}, dateFinEmploi pr√©sent:`, 'dateFinEmploi' in emp);

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              ${photoHtml}
              <span style="font-weight: 600; color: white;">${emp.entrepreneur || '-'}</span>
            </div>
          </td>
          <td style="font-weight: 600; color: white;">${emp.nom || '-'}</td>
          <td>${emp.poste || emp.posteService || '-'}</td>
          <td>${emp.motif_fin_emploi || emp.motif_inactivation || '-'}</td>
          <td>${emp.dateFinEmploi || emp.date_fin_emploi || emp.date_inactivation || '-'}</td>
          <td>
            <button class="btn-info" onclick="showEmployeeInfo(allEmployesData['${empId}'], true)">
              <i class="fas fa-info-circle"></i>
              Info
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Filtrer les employ√©s actifs
    function filterTousActifs() {
      const searchValue = document.getElementById('tous-actifs-search').value.toLowerCase().trim();

      const filtered = tousActifsData.filter(emp => {
        // Filtre par recherche
        if (searchValue) {
          const entrepreneur = (emp.entrepreneur || '').toLowerCase();
          const nom = (emp.nom || '').toLowerCase();
          const poste = (emp.poste || emp.posteService || '').toLowerCase();
          const tauxHoraire = (emp.tauxHoraire || '').toString().toLowerCase();
          if (!entrepreneur.includes(searchValue) && !nom.includes(searchValue) &&
              !poste.includes(searchValue) && !tauxHoraire.includes(searchValue)) {
            return false;
          }
        }

        return true;
      });

      displayTousActifs(filtered);
    }

    // Filtrer les employ√©s termin√©s
    function filterTousTermines() {
      const searchValue = document.getElementById('tous-termines-search').value.toLowerCase().trim();

      const filtered = tousTerminesData.filter(emp => {
        // Filtre par recherche
        if (searchValue) {
          const entrepreneur = (emp.entrepreneur || '').toLowerCase();
          const nom = (emp.nom || '').toLowerCase();
          const poste = (emp.poste || emp.posteService || '').toLowerCase();
          const motif = (emp.motif_fin_emploi || emp.motif_inactivation || '').toLowerCase();
          const tauxHoraire = (emp.tauxHoraire || '').toString().toLowerCase();
          if (!entrepreneur.includes(searchValue) && !nom.includes(searchValue) &&
              !poste.includes(searchValue) && !motif.includes(searchValue) && !tauxHoraire.includes(searchValue)) {
            return false;
          }
        }

        return true;
      });

      displayTousTermines(filtered);
    }

    // Anciennes fonctions pour compatibilit√© (peuvent √™tre supprim√©es plus tard)
    function toggleTypeFilterDropdown() {
      // Plus utilis√©
    }

    function selectTypeFilter(value, label) {
      // Plus utilis√©
      event.target.closest('.dropdown-secondary-option').classList.add('selected');

      // Fermer le dropdown
      document.getElementById('type-filter-dropdown').classList.remove('active');
      document.getElementById('type-filter-menu').classList.remove('show');
      document.querySelector('#type-filter-dropdown .fa-chevron-down').style.transform = 'rotate(0deg)';

      // Appliquer le filtre
      filterHistorique();
    }

    // Fermer le dropdown si on clique ailleurs
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#type-filter-dropdown') && !e.target.closest('#type-filter-menu')) {
        const menu = document.getElementById('type-filter-menu');
        const dropdown = document.getElementById('type-filter-dropdown');
        if (menu && dropdown) {
          menu.classList.remove('show');
          dropdown.classList.remove('active');
          const chevron = dropdown.querySelector('.fa-chevron-down');
          if (chevron) chevron.style.transform = 'rotate(0deg)';
        }
      }
    });

    // Mettre √† jour les statistiques
    function updateStats() {
      const pendingCount = employesEnAttente.length; // Activations seulement
      const inactivationsCount = inactivationsEnAttente.length;
      const reactivationsCount = reactivationsEnAttente.length;
      const modificationsCount = modificationsEnAttente.length;
      document.getElementById('stat-pending').textContent = pendingCount;
      document.getElementById('stat-fin-emploi').textContent = inactivationsCount;
      document.getElementById('stat-reactivations').textContent = reactivationsCount;
      document.getElementById('stat-modifications').textContent = modificationsCount;
    }

    // Afficher les employ√©s dans le tableau (validations + inactivations + modifications)
    function displayEmployes() {
      const loadingState = document.getElementById('loading-state');
      const emptyState = document.getElementById('empty-state');
      const table = document.getElementById('employees-table');
      const tbody = document.getElementById('employees-tbody');

      loadingState.style.display = 'none';

      // Fusionner validations, inactivations, r√©activations et modifications pour affichage unique
      const allRequests = [...employesEnAttente, ...inactivationsEnAttente, ...reactivationsEnAttente, ...modificationsEnAttente];

      if (allRequests.length === 0) {
        emptyState.style.display = 'block';
        table.style.display = 'none';
        return;
      }

      emptyState.style.display = 'none';
      table.style.display = 'table';

      tbody.innerHTML = '';

      allRequests.forEach(employe => {
        // Stocker les donn√©es compl√®tes pour le modal
        const empId = employe.id || `emp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        allEmployesData[empId] = employe;

        // D√©terminer le type de demande
        const isInactivation = employe.requestType === 'inactivation';
        const isReactivation = employe.requestType === 'reactivation';
        const isModification = employe.requestType === 'modification';

        let borderColor, bgGradient, btnColor, btnIcon, dateField, typeBadge;

        if (isReactivation) {
          borderColor = 'rgba(16, 185, 129, 0.3)';
          bgGradient = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
          btnColor = '#10b981';
          btnIcon = 'fa-user-check';
          dateField = employe.date_demande_reactivation || '-';
          typeBadge = `<span style="display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.75rem; background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 6px; color: #10b981; font-size: 0.8rem; font-weight: 600;"><i class="fas fa-user-check" style="font-size: 0.7rem;"></i> R√©activation</span>`;
        } else if (isInactivation) {
          borderColor = 'rgba(239, 68, 68, 0.3)';
          bgGradient = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
          btnColor = '#ef4444';
          btnIcon = 'fa-user-times';
          dateField = employe.date_demande_inactivation ? employe.date_demande_inactivation.split(' ')[0] : '-';
          typeBadge = `<span style="display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.75rem; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; color: #ef4444; font-size: 0.8rem; font-weight: 600;"><i class="fas fa-user-times" style="font-size: 0.7rem;"></i> Fin d'emploi</span>`;
        } else if (isModification) {
          borderColor = 'rgba(139, 92, 246, 0.3)';
          bgGradient = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
          btnColor = '#8b5cf6';
          btnIcon = 'fa-user-edit';
          dateField = employe.date_validation_coach_modification || employe.date_demande_modification || '-';
          typeBadge = `<span style="display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.75rem; background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 6px; color: #8b5cf6; font-size: 0.8rem; font-weight: 600;"><i class="fas fa-user-edit" style="font-size: 0.7rem;"></i> Modification</span>`;
        } else {
          borderColor = 'rgba(59, 130, 246, 0.3)';
          bgGradient = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
          btnColor = '#f59e0b';
          btnIcon = 'fa-eye';
          dateField = employe.dateCandidature || '-';
          typeBadge = `<span style="display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.75rem; background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 6px; color: #f59e0b; font-size: 0.8rem; font-weight: 600;"><i class="fas fa-user-plus" style="font-size: 0.7rem;"></i> Activation</span>`;
        }

        // Photo de profil de l'entrepreneur (comme dans historique)
        const photoHtml = employe.entrepreneurPhoto
          ? `<img src="${employe.entrepreneurPhoto}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid ${borderColor};">`
          : `<div style="width: 32px; height: 32px; border-radius: 50%; background: ${bgGradient}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.75rem;">${employe.entrepreneur ? employe.entrepreneur.charAt(0).toUpperCase() : '?'}</div>`;

        // D√©terminer la fonction onclick selon le type
        let onclickFn;
        if (isReactivation) {
          onclickFn = `showReactivationInfo(allEmployesData['${empId}'])`;
        } else if (isInactivation) {
          onclickFn = `showInactivationInfo(allEmployesData['${empId}'])`;
        } else if (isModification) {
          onclickFn = `showModificationInfo(allEmployesData['${empId}'])`;
        } else {
          onclickFn = `showEmployeeInfo(allEmployesData['${empId}'], false)`;
        }

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              ${photoHtml}
              <span style="font-weight: 600; color: white;">${employe.entrepreneur || '-'}</span>
            </div>
          </td>
          <td style="font-weight: 600; color: white;">${employe.nom || '-'}</td>
          <td>${employe.poste || '-'}</td>
          <td>${typeBadge}</td>
          <td>${dateField}</td>
          <td style="text-align: center;">
            <button class="btn-primary" style="background-color: ${btnColor} !important;" onclick="${onclickFn}">
              <i class="fas ${btnIcon}" style="margin-right: 0.5rem;"></i>
              V√©rifier
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // V√©rifier un employ√© (ouvre une page de d√©tail ou modal)
    function verifierEmploye(entrepreneur, employeId, employeNom) {
      // Rediriger vers la page de v√©rification de l'employ√©
      window.location.href = `/coach_verification_employe?entrepreneur=${entrepreneur}&id=${employeId}`;
    }

    // Valider un employ√© (validation comptable finale)
    async function validerEmploye(entrepreneur, employeId, employeNom) {
      try {
        const response = await fetch(`/api/employes/${entrepreneur}/valider-comptable/${employeId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error('Erreur lors de la validation');
        }

        const result = await response.json();
        console.log('Validation comptable r√©ussie:', result);

        // Recharger la liste
        await loadEmployesEnAttente();

        // Notifier le parent pour mettre √† jour le badge imm√©diatement
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
        }

        // Afficher un message de succ√®s
        showSuccessMessage(`L'employ√© "${employeNom}" a √©t√© valid√© et activ√© avec succ√®s`);

      } catch (error) {
        console.error('Erreur:', error);
        showErrorNotification('Erreur lors de la validation de l\'employ√©');
      }
    }

    // Refuser un employ√© (ouvre le modal avec raison)
    function refuserEmploye(entrepreneur, employeId, employeNom) {
      ouvrirModalRefusEmploye(entrepreneur, employeId, employeNom, 'employe');
    }

    // Afficher une notification (succ√®s ou erreur)
    function showNotification(message, type = 'success') {
      const isSuccess = type === 'success';
      const bgGradient = isSuccess
        ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)'
        : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
      const shadowColor = isSuccess
        ? 'rgba(16, 185, 129, 0.4)'
        : 'rgba(239, 68, 68, 0.4)';
      const icon = isSuccess ? 'fa-check-circle' : 'fa-exclamation-circle';

      const messageEl = document.createElement('div');
      messageEl.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: ${bgGradient};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px ${shadowColor};
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      `;
      messageEl.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${message}</span>
      `;

      document.body.appendChild(messageEl);

      setTimeout(() => {
        messageEl.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => messageEl.remove(), 300);
      }, 3000);
    }

    // Fonction pour afficher un message de succ√®s (r√©trocompatibilit√©)
    function showSuccessMessage(message) {
      showNotification(message, 'success');
    }

    // Fonction pour afficher un message d'erreur
    function showErrorNotification(message) {
      showNotification(message, 'error');
    }

    // ========== FONCTIONS INACTIVATIONS (COMPTABLE) ==========

    // Afficher les infos d'une demande d'inactivation
    function showInactivationInfo(employeeData) {
      const emp = employeeData;

      // Avatar
      const avatar = document.getElementById('modal-avatar');
      const initial = emp.nom ? emp.nom.charAt(0).toUpperCase() : '?';
      avatar.textContent = initial;
      avatar.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';

      // Titre et sous-titre
      document.getElementById('modal-title').textContent = emp.nom || 'Employ√© inconnu';
      document.getElementById('modal-subtitle').textContent = 'Demande de fin d\'emploi - ' + (emp.poste || 'Poste non d√©fini');

      // Rendre le modal plus compact
      const modalContent = document.querySelector('.modal-content');
      modalContent.style.maxWidth = '500px';
      modalContent.style.width = 'auto';
      modalContent.style.setProperty('height', 'auto', 'important');

      // Corps du modal
      const modalBody = document.getElementById('modal-body');
      modalBody.style.setProperty('height', 'auto', 'important');
      modalBody.style.setProperty('max-height', 'none', 'important');
      modalBody.innerHTML = `
        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
          <div style="display: flex; align-items: center; gap: 0.6rem; color: #ef4444; font-weight: 600; margin-bottom: 0.5rem; font-size: 1rem;">
            <i class="fas fa-exclamation-triangle" style="font-size: 1.1rem;"></i>
            Demande de fin d'emploi
          </div>
          <p style="color: #cbd5e1; font-size: 1rem; margin: 0; line-height: 1.3;">
            L'entrepreneur <strong>${emp.entrepreneur}</strong> souhaite mettre fin √† l'emploi de cet employ√©.
          </p>
        </div>

        <div style="background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
          <div style="font-size: 0.75rem; font-weight: 600; color: rgba(239, 68, 68, 0.7); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.6rem;">
            <i class="fas fa-exclamation-triangle"></i>
            Raison de la fin d'emploi
          </div>
          <div style="margin-bottom: 0.6rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
              <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500; opacity: 0.6;">Motif:</div>
              <button class="btn-copy" onclick="copierTexte('${(emp.motif_inactivation || '-').replace(/'/g, "\\'")}', this)">
                <i class="fas fa-copy"></i> Copier
              </button>
            </div>
            <div style="font-weight: 600; color: #ef4444; font-size: 1.05rem;">${emp.motif_inactivation || '-'}</div>
          </div>
          <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
              <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500; opacity: 0.6;">Justificatif:</div>
              <button class="btn-copy" onclick="copierTexte('${(emp.justificatif_inactivation || '-').replace(/'/g, "\\'")}', this)">
                <i class="fas fa-copy"></i> Copier
              </button>
            </div>
            <div style="white-space: pre-wrap; color: #cbd5e1; font-size: 1rem; line-height: 1.4;">${emp.justificatif_inactivation || '-'}</div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <!-- Colonne gauche: Informations de l'entrepreneur -->
          <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 8px; padding: 0.75rem;">
            <div style="font-size: 0.75rem; font-weight: 600; color: rgba(148, 163, 184, 0.7); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.6rem;">
              <i class="fas fa-user-tie"></i>
              Informations de l'entrepreneur
            </div>
            <div style="margin-bottom: 0.6rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500; opacity: 0.4;">Nom complet:</div>
                <button class="btn-copy" onclick="copierTexte('${(emp.entrepreneur || '-').replace(/'/g, "\\'")}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </div>
              <div style="font-weight: 500; color: #fff; font-size: 0.875rem;">${emp.entrepreneur || '-'}</div>
            </div>
            <div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500; opacity: 0.4;">D√©partement:</div>
                <button class="btn-copy" onclick="copierTexte('${emp.entrepreneurDepartment || '0'}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </div>
              <div style="color: #cbd5e1; font-size: 0.875rem;">${emp.entrepreneurDepartment || '0'}</div>
            </div>
          </div>

          <!-- Colonne droite: Informations de l'employ√© -->
          <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; padding: 0.75rem;">
            <div style="font-size: 0.75rem; font-weight: 600; color: rgba(245, 158, 11, 0.9); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.6rem;">
              <i class="fas fa-user"></i>
              Informations de l'employ√©
            </div>
            <div style="margin-bottom: 0.6rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500; opacity: 0.4;">Nom complet:</div>
                <button class="btn-copy" onclick="copierTexte('${(emp.nom || '-').replace(/'/g, "\\'")}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </div>
              <div style="font-weight: 500; color: #fff; font-size: 0.875rem;">${emp.nom || '-'}</div>
            </div>
            <div style="margin-bottom: 0.6rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500; opacity: 0.4;">Date de derni√®re journ√©e:</div>
                <button class="btn-copy" onclick="copierTexte('${(emp.dateFinEmploi || '-').replace(/'/g, "\\'")}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </div>
              <div style="color: #cbd5e1; font-size: 0.875rem;">${emp.dateFinEmploi || '-'}</div>
            </div>
            <div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                <div style="font-size: 0.8rem; color: rgba(148, 163, 184, 0.7); font-weight: 500; opacity: 0.4;">Taux horaire:</div>
                <button class="btn-copy" onclick="copierTexte('${emp.tauxHoraire ? (emp.tauxHoraire + " $/h").replace(/'/g, "\\'") : "-"}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </div>
              <div style="color: #cbd5e1; font-size: 0.875rem;">${emp.tauxHoraire ? emp.tauxHoraire + ' $/h' : '-'}</div>
            </div>
          </div>
        </div>
      `;

      // Footer avec boutons d'action
      const modalFooter = document.getElementById('modal-footer');
      modalFooter.innerHTML = `
        <button class="btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;" onclick="closeModal(); refuserInactivation('${emp.entrepreneurUsername || emp.entrepreneur}', '${emp.id}', '${emp.nom}')">
          <i class="fas fa-times"></i>
          Refuser
        </button>
        <button class="btn-primary" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;" onclick="closeModal(); validerInactivation('${emp.entrepreneurUsername || emp.entrepreneur}', '${emp.id}', '${emp.nom}')">
          <i class="fas fa-check"></i>
          Valider
        </button>
      `;

      openModal();
    }

    // Valider une inactivation (coach ou comptable selon le r√¥le)
    async function validerInactivation(entrepreneur, employeId, employeNom) {
      try {
        // D√©terminer l'endpoint selon le r√¥le
        const userRole = localStorage.getItem('userRole');
        const endpoint = (userRole === 'coach')
          ? `/api/employes/${entrepreneur}/valider-inactivation/${employeId}`
          : `/api/employes/${entrepreneur}/valider-inactivation-comptable/${employeId}`;

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error('Erreur lors de la validation');
        }

        // Recharger la liste (inclut les validations ET inactivations)
        await loadEmployesEnAttente();

        // Mettre √† jour les statistiques imm√©diatement
        await loadStats();

        // Notifier le parent pour mettre √† jour le badge
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
        }

        // Afficher un message de succ√®s
        showSuccessMessage(`Fin d'emploi valid√©e avec succ√®s!`);

      } catch (error) {
        console.error('Erreur:', error);
        showErrorNotification('Erreur lors de la validation de l\'inactivation');
      }
    }

    // Refuser une inactivation (ouvre le modal avec raison)
    function refuserInactivation(entrepreneur, employeId, employeNom) {
      ouvrirModalRefusEmploye(entrepreneur, employeId, employeNom, 'inactivation');
    }

    // ========== FONCTIONS R√âACTIVATIONS (COMPTABLE) ==========

    // Afficher les infos d'une demande de r√©activation
    function showReactivationInfo(employeeData) {
      const emp = employeeData;

      // R√©cup√©rer les anciennes donn√©es (avant inactivation) et nouvelles donn√©es (r√©activation)
      const anciennes = emp.anciennes_donnees_reactivation || emp.anciennes_donnees || {};
      const nouvelles = emp.nouvelles_donnees_reactivation || emp.nouvelles_donnees || emp;

      // Ajuster la taille du modal pour height auto (m√™me que modification)
      const modalContent = document.querySelector('.modal-content');
      modalContent.style.maxWidth = '1100px';
      modalContent.style.width = '95vw';
      modalContent.style.setProperty('height', 'auto', 'important');
      modalContent.style.setProperty('max-height', '90vh', 'important');

      // Corps du modal - ajuster height
      const modalBodyEl = document.getElementById('modal-body');
      modalBodyEl.style.setProperty('height', 'auto', 'important');
      modalBodyEl.style.setProperty('max-height', 'none', 'important');
      modalBodyEl.style.overflow = 'auto';

      // Avatar
      const avatar = document.getElementById('modal-avatar');
      const initial = emp.nom ? emp.nom.charAt(0).toUpperCase() : '?';
      avatar.textContent = initial;
      avatar.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';

      // Titre et sous-titre
      const nomComplet = emp.nom || 'Employ√© inconnu';
      document.getElementById('modal-title').textContent = nomComplet;
      document.getElementById('modal-subtitle').textContent = 'Demande de r√©activation - ' + (emp.poste || emp.posteService || 'Poste non d√©fini');

      // Fonction helper pour cr√©er une ligne avec marquage si modifi√© et bouton copier
      // forceModified: true pour toujours marquer comme modifi√© (taux horaire, date premi√®re journ√©e)
      function createRow(label, valeur, ancienneValeur, showBorder = true, forceModified = false) {
        const val = valeur || '-';
        const anc = ancienneValeur || '-';
        const valNorm = (val || '').toString().trim().toLowerCase();
        const ancNorm = (anc || '').toString().trim().toLowerCase();
        const isModified = forceModified || (valNorm !== ancNorm && ancienneValeur);
        const valEscaped = String(val).replace(/'/g, "\\'").replace(/"/g, '&quot;');

        const borderStyle = showBorder ? 'border-bottom: 1px dashed rgba(148, 163, 184, 0.1);' : '';
        const modifClass = isModified ? 'modifie' : '';
        const modifBadge = isModified ? '<span class="modif-badge" style="margin-left: 0.5rem;">Modifi√©</span>' : '';

        return `
          <div class="validationModif-row ${modifClass}" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; ${borderStyle}">
            <span class="text-sm validationModif-label" style="color: rgba(148, 163, 184, 0.7); display: flex; align-items: center;">${label}${modifBadge}</span>
            <span style="display: flex; align-items: center; gap: 0.5rem;">
              <span class="text-sm font-medium" style="color: #f1f5f9;">${val}</span>
              <button class="btn-copy" onclick="copierTexte('${valEscaped}', this)">
                <i class="fas fa-copy"></i>
              </button>
            </span>
          </div>
        `;
      }

      // Corps du modal avec grid 2 colonnes comme modification
      const modalBody = document.getElementById('modal-body');
      modalBody.innerHTML = `
        <style>
          .validationModif-row.modifie {
            background: rgba(245, 158, 11, 0.15) !important;
            border-radius: 6px;
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
          }
          .validationModif-row.modifie .validationModif-label {
            color: #f59e0b !important;
            font-weight: 600 !important;
          }
          .validationModif-row.modifie span:not(.validationModif-label):not(.modif-badge):not(.btn-copy) {
            color: #fbbf24 !important;
            font-weight: 600 !important;
          }
          .modif-badge {
            display: inline-flex;
            background: rgba(245, 158, 11, 0.3);
            color: #f59e0b;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
          }
        </style>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <!-- Colonne gauche -->
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <!-- Section: Informations de l'entrepreneur -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-briefcase" style="color: #f59e0b;"></i>
                Informations de l'entrepreneur
              </div>
              ${createRow('Poste', nouvelles.posteService || nouvelles.poste || emp.posteService || emp.poste, anciennes.posteService || anciennes.poste)}
              ${createRow('D√©partement', nouvelles.departement || emp.entrepreneurDepartment || emp.departement || '0', anciennes.departement || '0')}
              ${(() => {
                const tauxNouveau = (nouvelles.tauxHoraire || emp.tauxHoraire) ? parseFloat(nouvelles.tauxHoraire || emp.tauxHoraire).toFixed(2) + ' $' : '-';
                const tauxAncien = anciennes.tauxHoraire ? parseFloat(anciennes.tauxHoraire).toFixed(2) + ' $' : '-';
                const tauxModifie = tauxNouveau !== tauxAncien;
                // Afficher la date de changement si le taux horaire a √©t√© modifi√©
                const dateChangement = emp.date_demande_reactivation || '';
                const dateFormatee = dateChangement ? dateChangement.split(' ')[0] : '';
                const labelTaux = tauxModifie && dateFormatee ? 'Taux horaire (chang√© le ' + dateFormatee + ')' : 'Taux horaire';
                return createRow(labelTaux, tauxNouveau, tauxAncien, true, true);
              })()}
              ${createRow('Date premi√®re journ√©e', nouvelles.datePremiere || emp.datePremiere, anciennes.datePremiere, false, true)}
            </div>

            <!-- Section: Contact -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-phone" style="color: #10b981;"></i>
                Contact
              </div>
              ${createRow('Courriel', nouvelles.courriel || emp.courriel, anciennes.courriel)}
              ${createRow('T√©l√©phone', nouvelles.telephone || emp.telephone, anciennes.telephone, false)}
            </div>
          </div>

          <!-- Colonne droite -->
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <!-- Section: Informations de l'employ√© -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-user" style="color: #60a5fa;"></i>
                Informations de l'employ√©
              </div>
              ${createRow('Nom complet', nouvelles.nom || emp.nom, anciennes.nom)}
              ${createRow('Genre', nouvelles.genre || emp.genre, anciennes.genre)}
              ${createRow('Date de naissance', nouvelles.dateNaissance || emp.dateNaissance, anciennes.dateNaissance)}
              ${createRow('NAS', nouvelles.nas || emp.nas, anciennes.nas, false)}
            </div>

            <!-- Section: Adresse d√©taill√©e -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-map-marker-alt" style="color: #8b5cf6;"></i>
                Adresse d√©taill√©e
              </div>
              ${createRow('Adresse', nouvelles.adresse || emp.adresse, anciennes.adresse)}
              ${createRow('Ville', nouvelles.ville || emp.ville, anciennes.ville)}
              ${createRow('Code postal', nouvelles.codePostal || emp.codePostal, anciennes.codePostal, false)}
            </div>
          </div>
        </div>

        <!-- Section: Documents (pleine largeur) -->
        ${(() => {
          const entrepreneur = emp.entrepreneurUsername || emp.entrepreneur;
          // Pour r√©activation, les documents peuvent √™tre dans plusieurs sources avec variations de noms
          const specimenDoc = emp.specimenCheque || emp.specimen || nouvelles.specimenCheque || nouvelles.specimen || anciennes.specimenCheque || anciennes.specimen;
          const certificatDoc = emp.certificatSecurite || emp.certificat || nouvelles.certificatSecurite || nouvelles.certificat || anciennes.certificatSecurite || anciennes.certificat;
          const carteDoc = emp.carteAssurance || emp.carte || nouvelles.carteAssurance || nouvelles.carte || anciennes.carteAssurance || anciennes.carte;

          // Les documents sont toujours "modifi√©s" lors d'une r√©activation car ils sont re-t√©l√©charg√©s
          // On les consid√®re toujours comme modifi√©s s'ils existent
          const specimenModifie = !!specimenDoc;
          const certificatModifie = !!certificatDoc;
          const carteModifie = !!carteDoc;

          function createDocLink(doc) {
            if (doc) {
              const url = "/api/employes/" + entrepreneur + "/documents/" + emp.id + "/" + doc;
              return '<div style="display: flex; gap: 0.5rem; align-items: center;">' +
                '<a href="#" onclick="ouvrirDocumentViewer(\'' + url + '\'); return false;" style="display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; padding: 0.375rem 0.75rem; border-radius: 9999px; background: rgba(96, 165, 250, 0.15); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); text-decoration: none;"><i class="fas fa-eye"></i> Voir</a>' +
                '<a href="' + url + '" download style="display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; padding: 0.375rem 0.75rem; border-radius: 9999px; background: rgba(16, 185, 129, 0.15); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); text-decoration: none;"><i class="fas fa-download"></i></a>' +
              '</div>';
            } else {
              return '<span style="color: rgba(148, 163, 184, 0.5);">Aucun</span>';
            }
          }

          function createDocRow(label, doc, isModified) {
            const modifClass = isModified ? 'validationModif-row modifie' : '';
            const bgStyle = isModified ? 'background: rgba(245, 158, 11, 0.15); border-radius: 6px; padding: 0.5rem;' : '';
            const labelStyle = isModified ? 'color: #f59e0b; font-weight: 600;' : 'color: rgba(148, 163, 184, 0.7);';
            const modifBadge = isModified ? '<span class="modif-badge" style="margin-left: 0.5rem;">Modifi√©</span>' : '';

            return '<div class="' + modifClass + '" style="display: flex; flex-direction: column; align-items: center; padding: 0.5rem 0; ' + bgStyle + '">' +
              '<span style="font-size: 0.75rem; margin-bottom: 0.5rem; display: flex; align-items: center; ' + labelStyle + '">' + label + modifBadge + '</span>' +
              createDocLink(doc) +
            '</div>';
          }

          return '<div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem; margin-top: 1rem;">' +
            '<div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">' +
              '<i class="fas fa-file-alt" style="color: #60a5fa;"></i>' +
              'Documents' +
            '</div>' +
            '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">' +
              createDocRow('Sp√©cimen ch√®que', specimenDoc, specimenModifie) +
              createDocRow('Certificat s√©curit√©', certificatDoc, certificatModifie) +
              createDocRow('Carte assurance maladie', carteDoc, carteModifie) +
            '</div>' +
          '</div>';
        })()}
      `;

      // Footer avec boutons d'action
      const modalFooter = document.getElementById('modal-footer');
      const nomEscaped = nomComplet.replace(/'/g, "\\'");
      modalFooter.innerHTML = `
        <button class="btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;" onclick="closeModal(); refuserReactivation('${emp.entrepreneurUsername || emp.entrepreneur}', '${emp.id}', '${nomEscaped}')">
          <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
          Refuser
        </button>
        <button class="btn-primary" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;" onclick="closeModal(); validerReactivation('${emp.entrepreneurUsername || emp.entrepreneur}', '${emp.id}', '${nomEscaped}')">
          <i class="fas fa-check" style="margin-right: 0.5rem;"></i>
          Valider
        </button>
      `;

      openModal();
    }

    // Valider une r√©activation (coach ou comptable selon le r√¥le)
    async function validerReactivation(entrepreneur, employeId, employeNom) {
      try {
        // D√©terminer l'endpoint selon le r√¥le
        const userRole = localStorage.getItem('userRole');
        const endpoint = (userRole === 'coach')
          ? `/api/coach/reactivations/valider/${entrepreneur}/${employeId}`
          : `/api/comptable/reactivations/valider/${entrepreneur}/${employeId}`;

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error('Erreur lors de la validation');
        }

        // Recharger la liste
        await loadEmployesEnAttente();

        // Mettre √† jour les statistiques imm√©diatement
        await loadStats();

        // Notifier le parent pour mettre √† jour le badge
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
        }

        showSuccessMessage(`L'employ√© "${employeNom}" a √©t√© r√©activ√© avec succ√®s`);

      } catch (error) {
        console.error('Erreur:', error);
        showErrorNotification('Erreur lors de la validation de la r√©activation');
      }
    }

    // Refuser une r√©activation (ouvre le modal avec raison)
    function refuserReactivation(entrepreneur, employeId, employeNom) {
      ouvrirModalRefusEmploye(entrepreneur, employeId, employeNom, 'reactivation');
    }

    // Afficher les infos d'une modification (comptable) - m√™me style que coach
    function showModificationInfo(employeeData) {
      const emp = employeeData;
      const anciennes = emp.anciennes_donnees || {};
      const nouvelles = emp.nouvelles_donnees || {};

      // Ajuster la taille du modal pour height auto
      const modalContent = document.querySelector('.modal-content');
      modalContent.style.maxWidth = '1100px';
      modalContent.style.width = '95vw';
      modalContent.style.setProperty('height', 'auto', 'important');
      modalContent.style.setProperty('max-height', '90vh', 'important');

      // Corps du modal - ajuster height
      const modalBodyEl = document.getElementById('modal-body');
      modalBodyEl.style.setProperty('height', 'auto', 'important');
      modalBodyEl.style.setProperty('max-height', 'none', 'important');
      modalBodyEl.style.overflow = 'auto';

      // Avatar - violet pour modification
      const avatar = document.getElementById('modal-avatar');
      const initial = emp.nom ? emp.nom.charAt(0).toUpperCase() : (emp.prenom ? emp.prenom.charAt(0).toUpperCase() : '?');
      avatar.textContent = initial;
      avatar.style.background = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';

      // Titre et sous-titre
      const nomComplet = emp.nom || `${emp.prenom || ''} ${emp.nomFamille || ''}`.trim() || 'Employ√© inconnu';
      document.getElementById('modal-title').textContent = nomComplet;
      document.getElementById('modal-subtitle').textContent = 'V√©rifier les modifications - ' + (emp.poste || emp.posteService || 'Poste non d√©fini');

      // Fonction helper pour cr√©er une ligne avec marquage si modifi√© et bouton copier
      function createRow(label, nouvelleVal, ancienneVal, showBorder = true) {
        const nouvelle = nouvelleVal || '-';
        const ancienne = ancienneVal || '-';
        const nouvelleNorm = (nouvelle || '').toString().trim().toLowerCase();
        const ancienneNorm = (ancienne || '').toString().trim().toLowerCase();
        const isModified = nouvelleNorm !== ancienneNorm;
        const valEscaped = String(nouvelle).replace(/'/g, "\\'").replace(/"/g, '&quot;');

        const borderStyle = showBorder ? 'border-bottom: 1px dashed rgba(148, 163, 184, 0.1);' : '';
        const modifClass = isModified ? 'modifie' : '';
        const modifBadge = isModified ? '<span class="modif-badge" style="margin-left: 0.5rem;">Modifi√©</span>' : '';

        return `
          <div class="validationModif-row ${modifClass}" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; ${borderStyle}">
            <span class="text-sm validationModif-label" style="color: rgba(148, 163, 184, 0.7); display: flex; align-items: center;">${label}${modifBadge}</span>
            <span style="display: flex; align-items: center; gap: 0.5rem;">
              <span class="text-sm font-medium" style="color: #f1f5f9;">${nouvelle}</span>
              <button class="btn-copy" onclick="copierTexte('${valEscaped}', this)">
                <i class="fas fa-copy"></i>
              </button>
            </span>
          </div>
        `;
      }

      // Corps du modal avec grid 2 colonnes comme coach
      const modalBody = document.getElementById('modal-body');
      modalBody.innerHTML = `
        <style>
          .validationModif-row.modifie {
            background: rgba(245, 158, 11, 0.15) !important;
            border-radius: 6px;
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
          }
          .validationModif-row.modifie .validationModif-label {
            color: #f59e0b !important;
            font-weight: 600 !important;
          }
          .validationModif-row.modifie span:not(.validationModif-label):not(.modif-badge):not(.btn-copy) {
            color: #fbbf24 !important;
            font-weight: 600 !important;
          }
          .modif-badge {
            display: inline-flex;
            background: rgba(245, 158, 11, 0.3);
            color: #f59e0b;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
          }
        </style>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <!-- Colonne gauche -->
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <!-- Section: Informations de l'entrepreneur -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-briefcase" style="color: #f59e0b;"></i>
                Informations de l'entrepreneur
              </div>
              ${createRow('Poste', nouvelles.posteService || nouvelles.poste, anciennes.posteService || anciennes.poste)}
              ${createRow('D√©partement', nouvelles.departement || emp.entrepreneurDepartment || '0', anciennes.departement || '0')}
              ${(() => {
                const tauxNouveau = nouvelles.tauxHoraire ? parseFloat(nouvelles.tauxHoraire).toFixed(2) + ' $' : '-';
                const tauxAncien = anciennes.tauxHoraire ? parseFloat(anciennes.tauxHoraire).toFixed(2) + ' $' : '-';
                const tauxModifie = tauxNouveau !== tauxAncien;
                // Afficher la date de changement si le taux horaire a √©t√© modifi√©
                const dateChangement = emp.date_demande_modification || emp.date_validation_coach_modification || '';
                const dateFormatee = dateChangement ? dateChangement.split(' ')[0] : '';
                const labelTaux = tauxModifie && dateFormatee ? 'Taux horaire (chang√© le ' + dateFormatee + ')' : 'Taux horaire';
                return createRow(labelTaux, tauxNouveau, tauxAncien);
              })()}
              ${createRow('Date premi√®re journ√©e', nouvelles.datePremiere || nouvelles.datePremierePaie, anciennes.datePremiere || anciennes.datePremierePaie, false)}
            </div>

            <!-- Section: Contact -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-phone" style="color: #10b981;"></i>
                Contact
              </div>
              ${createRow('Courriel', nouvelles.courriel, anciennes.courriel)}
              ${createRow('T√©l√©phone', nouvelles.telephone, anciennes.telephone, false)}
            </div>
          </div>

          <!-- Colonne droite -->
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <!-- Section: Informations de l'employ√© -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-user" style="color: #60a5fa;"></i>
                Informations de l'employ√©
              </div>
              ${createRow('Nom complet', nouvelles.nom, anciennes.nom)}
              ${createRow('Genre', nouvelles.genre, anciennes.genre)}
              ${createRow('Date de naissance', nouvelles.dateNaissance, anciennes.dateNaissance)}
              ${createRow('NAS', nouvelles.nas, anciennes.nas, false)}
            </div>

            <!-- Section: Adresse d√©taill√©e -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-map-marker-alt" style="color: #8b5cf6;"></i>
                Adresse d√©taill√©e
              </div>
              ${createRow('Adresse', nouvelles.adresse, anciennes.adresse)}
              ${createRow('Ville', nouvelles.ville, anciennes.ville)}
              ${createRow('Code postal', nouvelles.codePostal, anciennes.codePostal, false)}
            </div>
          </div>
        </div>

        <!-- Section: Documents (pleine largeur) -->
        ${(() => {
          const entrepreneur = emp.entrepreneurUsername || emp.entrepreneur;
          // R√©cup√©rer les documents avec toutes les variations de noms possibles
          const specimenDoc = nouvelles.specimenCheque || nouvelles.specimen || emp.specimenCheque || emp.specimen || anciennes.specimenCheque || anciennes.specimen;
          const certificatDoc = nouvelles.certificatSecurite || nouvelles.certificat || emp.certificatSecurite || emp.certificat || anciennes.certificatSecurite || anciennes.certificat;
          const carteDoc = nouvelles.carteAssurance || nouvelles.carte || emp.carteAssurance || emp.carte || anciennes.carteAssurance || anciennes.carte;

          // V√©rifier si les documents ont √©t√© modifi√©s (comparer anciennes vs nouvelles)
          const ancienSpecimen = anciennes.specimenCheque || anciennes.specimen;
          const nouveauSpecimen = nouvelles.specimenCheque || nouvelles.specimen;
          const ancienCertificat = anciennes.certificatSecurite || anciennes.certificat;
          const nouveauCertificat = nouvelles.certificatSecurite || nouvelles.certificat;
          const ancienneCarte = anciennes.carteAssurance || anciennes.carte;
          const nouvelleCarte = nouvelles.carteAssurance || nouvelles.carte;
          const specimenModifie = nouveauSpecimen && nouveauSpecimen !== ancienSpecimen;
          const certificatModifie = nouveauCertificat && nouveauCertificat !== ancienCertificat;
          const carteModifie = nouvelleCarte && nouvelleCarte !== ancienneCarte;

          function createDocLink(doc) {
            if (doc) {
              const url = "/api/employes/" + entrepreneur + "/documents/" + emp.id + "/" + doc;
              return '<div style="display: flex; gap: 0.5rem; align-items: center;">' +
                '<a href="#" onclick="ouvrirDocumentViewer(\'' + url + '\'); return false;" style="display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; padding: 0.375rem 0.75rem; border-radius: 9999px; background: rgba(96, 165, 250, 0.15); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); text-decoration: none;"><i class="fas fa-eye"></i> Voir</a>' +
                '<a href="' + url + '" download style="display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; padding: 0.375rem 0.75rem; border-radius: 9999px; background: rgba(16, 185, 129, 0.15); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); text-decoration: none;"><i class="fas fa-download"></i></a>' +
              '</div>';
            } else {
              return '<span style="color: rgba(148, 163, 184, 0.5);">Aucun</span>';
            }
          }

          function createDocRow(label, doc, isModified) {
            const modifClass = isModified ? 'validationModif-row modifie' : '';
            const bgStyle = isModified ? 'background: rgba(245, 158, 11, 0.15); border-radius: 6px; padding: 0.5rem;' : '';
            const labelStyle = isModified ? 'color: #f59e0b; font-weight: 600;' : 'color: rgba(148, 163, 184, 0.7);';
            const modifBadge = isModified ? '<span class="modif-badge" style="margin-left: 0.5rem;">Modifi√©</span>' : '';

            return '<div class="' + modifClass + '" style="display: flex; flex-direction: column; align-items: center; padding: 0.5rem 0; ' + bgStyle + '">' +
              '<span style="font-size: 0.75rem; margin-bottom: 0.5rem; display: flex; align-items: center; ' + labelStyle + '">' + label + modifBadge + '</span>' +
              createDocLink(doc) +
            '</div>';
          }

          return '<div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem; margin-top: 1rem;">' +
            '<div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">' +
              '<i class="fas fa-file-alt" style="color: #60a5fa;"></i>' +
              'Documents' +
            '</div>' +
            '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">' +
              createDocRow('Sp√©cimen ch√®que', specimenDoc, specimenModifie) +
              createDocRow('Certificat s√©curit√©', certificatDoc, certificatModifie) +
              createDocRow('Carte assurance maladie', carteDoc, carteModifie) +
            '</div>' +
          '</div>';
        })()}
      `;

      // Footer avec boutons d'action - m√™me style que coach
      const modalFooter = document.getElementById('modal-footer');
      modalFooter.innerHTML = `
        <button class="btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;" onclick="closeModal(); refuserModification('${emp.entrepreneurUsername || emp.entrepreneur}', '${emp.id}', '${nomComplet.replace(/'/g, "\\'")}')">
          <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
          Refuser
        </button>
        <button class="btn-primary" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;" onclick="closeModal(); validerModification('${emp.entrepreneurUsername || emp.entrepreneur}', '${emp.id}', '${nomComplet.replace(/'/g, "\\'")}')">
          <i class="fas fa-check" style="margin-right: 0.5rem;"></i>
          Valider
        </button>
      `;

      openModal();
    }

    // Valider une modification (comptable - validation finale)
    async function validerModification(entrepreneur, employeId, employeNom) {
      try {
        const response = await fetch(`/api/employes/${entrepreneur}/valider-modification-comptable/${employeId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error('Erreur lors de la validation');
        }

        // Recharger la liste
        await loadEmployesEnAttente();

        // Notifier le parent pour mettre √† jour le badge
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
        }

        showSuccessMessage(`La modification de "${employeNom}" a √©t√© valid√©e avec succ√®s`);

      } catch (error) {
        console.error('Erreur:', error);
        showErrorNotification('Erreur lors de la validation de la modification');
      }
    }

    // Refuser une modification (ouvre le modal avec raison)
    function refuserModification(entrepreneur, employeId, employeNom) {
      ouvrirModalRefusEmploye(entrepreneur, employeId, employeNom, 'modification');
    }

    // Modal de confirmation personnalis√©
    function showConfirmModal(message, onConfirm, onCancel) {
      // Cr√©er l'overlay
      const overlay = document.createElement('div');
      overlay.id = 'confirm-overlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
      `;

      // Cr√©er le modal
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border-radius: 16px;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        animation: scaleIn 0.2s ease;
      `;

      modal.innerHTML = `
        <div style="text-align: center; margin-bottom: 1.5rem;">
          <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
            <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; color: white;"></i>
          </div>
          <h3 style="color: white; font-size: 1.25rem; margin-bottom: 0.5rem;">Confirmation</h3>
          <p style="color: #94a3b8; font-size: 0.95rem; line-height: 1.5;">${message}</p>
        </div>
        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button id="confirm-cancel" class="btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important; flex: 1;">
            <i class="fas fa-times"></i>
            Refuser
          </button>
          <button id="confirm-ok" class="btn-primary" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important; flex: 1;">
            <i class="fas fa-check"></i>
            Valider
          </button>
        </div>
      `;

      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      // Ajouter les styles d'animation
      const styleEl = document.createElement('style');
      styleEl.id = 'confirm-modal-styles';
      styleEl.textContent = `
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes scaleIn {
          from { transform: scale(0.9); opacity: 0; }
          to { transform: scale(1); opacity: 1; }
        }
      `;
      document.head.appendChild(styleEl);

      // Gestionnaires d'√©v√©nements
      const closeModal = () => {
        overlay.remove();
        const styles = document.getElementById('confirm-modal-styles');
        if (styles) styles.remove();
      };

      document.getElementById('confirm-cancel').addEventListener('click', () => {
        closeModal();
        if (onCancel) onCancel();
      });

      document.getElementById('confirm-ok').addEventListener('click', () => {
        closeModal();
        if (onConfirm) onConfirm();
      });

      // Fermer si on clique sur l'overlay
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          closeModal();
          if (onCancel) onCancel();
        }
      });
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      loadEmployesEnAttente();
      loadStats();
      chargerMessagesRefusEnAttente();

      // Recharger toutes les 30 secondes
      setInterval(() => {
        loadEmployesEnAttente();
        loadStats();
        chargerMessagesRefusEnAttente();
      }, 30000);
    });

    // ========== FONCTIONS MODAL ==========

    // Ouvrir le modal
    function openModal() {
      document.getElementById('employee-modal').style.display = 'flex';
      document.body.style.overflow = 'hidden'; // Emp√™cher le scroll
    }

    // Fermer le modal
    function closeModal() {
      document.getElementById('employee-modal').style.display = 'none';
      document.body.style.overflow = ''; // R√©activer le scroll
    }

    // Fonction pour ouvrir le visualiseur de document (centraleadmin style)
    function ouvrirDocumentViewer(url) {
      console.log('[VIEWER] Tentative ouverture:', url);
      const viewerModal = document.getElementById('centraleViewerModal');
      const viewerContent = document.getElementById('centraleViewerContent');
      console.log('[VIEWER] Modal trouv√©:', !!viewerModal, 'Content trouv√©:', !!viewerContent);

      if (!viewerModal || !viewerContent) {
        console.error('[VIEWER] √âl√©ments manquants! Modal:', viewerModal, 'Content:', viewerContent);
        alert('Erreur: Le visualiseur de documents n\'est pas disponible. Veuillez t√©l√©charger le fichier.');
        return;
      }

      viewerContent.innerHTML = '';
      const ext = url.split('.').pop().toLowerCase();

      if (['png', 'jpg', 'jpeg', 'gif'].includes(ext)) {
        const img = document.createElement('img');
        img.src = url;
        img.style.maxWidth = '100%';
        img.style.maxHeight = '85vh';
        img.style.objectFit = 'contain';
        viewerContent.appendChild(img);
      } else {
        const iframe = document.createElement('iframe');
        iframe.src = url;
        iframe.style.width = '100%';
        iframe.style.height = '85vh';
        iframe.style.border = 'none';
        viewerContent.appendChild(iframe);
      }

      viewerModal.style.display = 'flex';
      console.log('[VIEWER] Modal affich√©');
    }

    // Alias pour compatibilit√© avec gestionemployes
    window.openFileModal = ouvrirDocumentViewer;

    // Fonction pour fermer le visualiseur de document
    function fermerDocumentViewer() {
      const viewerModal = document.getElementById('centraleViewerModal');
      const viewerContent = document.getElementById('centraleViewerContent');

      if (viewerModal) viewerModal.style.display = 'none';
      if (viewerContent) viewerContent.innerHTML = '';
    }

    // Alias pour compatibilit√©
    window.closeFileModal = fermerDocumentViewer;

    // Fermer le modal si on clique en dehors
    document.getElementById('employee-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    // Afficher les infos de l'historique selon le type d'action
    function showHistoryInfo(employeeData) {
      const emp = employeeData;

      // D√©terminer le type d'action pour le style
      const isInactif = emp.action === 'Inactif';
      const isRefuse = emp.action === 'Refus√©';

      // Avatar
      const avatar = document.getElementById('modal-avatar');
      const initial = emp.nom ? emp.nom.charAt(0).toUpperCase() : '?';
      avatar.textContent = initial;

      // Couleur de l'avatar selon le type
      if (isInactif) {
        avatar.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
      } else if (isRefuse) {
        avatar.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
      } else {
        avatar.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
      }

      // Titre et sous-titre
      document.getElementById('modal-title').textContent = emp.nom || 'Employ√© inconnu';
      const statusText = isInactif ? 'Inactif' : isRefuse ? 'Refus√©' : 'Actif';
      document.getElementById('modal-subtitle').textContent = `${emp.poste || 'Poste non d√©fini'} - ${statusText}`;

      // Corps du modal
      const modalBody = document.getElementById('modal-body');

      // Section de statut
      let statusSection = '';
      if (isInactif) {
        statusSection = `
          <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; color: #f59e0b; font-weight: 600; margin-bottom: 0.5rem;">
              <i class="fas fa-user-times"></i>
              Employ√© inactif
            </div>
            <p style="color: #94a3b8; font-size: 0.9rem; margin: 0;">
              Cet employ√© a √©t√© rendu inactif par la Direction.
            </p>
          </div>
        `;
      } else if (isRefuse) {
        statusSection = `
          <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; color: #ef4444; font-weight: 600; margin-bottom: 0.5rem;">
              <i class="fas fa-times-circle"></i>
              Candidature refus√©e
            </div>
            <p style="color: #94a3b8; font-size: 0.9rem; margin: 0;">
              Cette candidature a √©t√© refus√©e par la Direction.
            </p>
          </div>
        `;
      } else {
        statusSection = `
          <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; color: #10b981; font-weight: 600; margin-bottom: 0.5rem;">
              <i class="fas fa-check-circle"></i>
              Employ√© actif
            </div>
            <p style="color: #94a3b8; font-size: 0.9rem; margin: 0;">
              Cet employ√© a √©t√© valid√© et activ√© par la Direction.
            </p>
          </div>
        `;
      }

      // Section motif d'inactivation (si applicable)
      let motifSection = '';
      if (isInactif && (emp.motif_inactivation || emp.justificatif_inactivation)) {
        motifSection = `
          <div class="info-section" style="background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 10px; padding: 1rem;">
            <div class="info-section-title" style="color: #f59e0b;">
              <i class="fas fa-file-alt"></i>
              Motif de fin d'emploi
            </div>
            <div class="info-grid">
              <div class="info-item" style="grid-column: 1 / -1;">
                <div class="info-label">Motif</div>
                <div class="info-value" style="font-weight: 600; color: #f59e0b;">${emp.motif_inactivation || '-'}</div>
              </div>
              <div class="info-item" style="grid-column: 1 / -1;">
                <div class="info-label">Justificatif</div>
                <div class="info-value" style="white-space: pre-wrap;">${emp.justificatif_inactivation || '-'}</div>
              </div>
            </div>
          </div>
        `;
      }

      // Section motif de refus (si applicable)
      if (isRefuse && emp.motif_refus) {
        motifSection = `
          <div class="info-section" style="background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 10px; padding: 1rem;">
            <div class="info-section-title" style="color: #ef4444;">
              <i class="fas fa-file-alt"></i>
              Motif de refus
            </div>
            <div class="info-grid">
              <div class="info-item" style="grid-column: span 2;">
                <div class="info-label">Motif</div>
                <div class="info-value" style="font-weight: 600; color: #ef4444;">${emp.motif_refus || '-'}</div>
              </div>
            </div>
          </div>
        `;
      }

      modalBody.innerHTML = `
        ${statusSection}

        <div class="info-section">
          <div class="info-section-title">
            <i class="fas fa-user"></i>
            Informations personnelles
          </div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Nom complet</div>
              <div class="info-value">${emp.nom || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Genre</div>
              <div class="info-value">${emp.genre || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Courriel</div>
              <div class="info-value">${emp.courriel || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">T√©l√©phone</div>
              <div class="info-value">${emp.telephone || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">NAS</div>
              <div class="info-value" style="font-family: monospace;">${emp.nas || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Poste</div>
              <div class="info-value">${emp.poste || emp.posteService || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Taux horaire</div>
              <div class="info-value">${emp.tauxHoraire ? emp.tauxHoraire + ' $/h' : '-'}</div>
            </div>
          </div>
        </div>

        <div class="info-section">
          <div class="info-section-title">
            <i class="fas fa-map-marker-alt"></i>
            Adresse
          </div>
          <div class="info-grid">
            <div class="info-item" style="grid-column: span 2;">
              <div class="info-label">Adresse</div>
              <div class="info-value">${emp.adresse || '-'}${emp.appartement && emp.appartement !== '-' ? ', App. ' + emp.appartement : ''}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Ville</div>
              <div class="info-value">${emp.ville || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Code postal</div>
              <div class="info-value">${emp.codePostal || '-'}</div>
            </div>
          </div>
        </div>

        <div class="info-section">
          <div class="info-section-title">
            <i class="fas fa-calendar-alt"></i>
            Dates
          </div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Premi√®re journ√©e</div>
              <div class="info-value">${emp.datePremiere || '-'}</div>
            </div>
          </div>
        </div>

        ${motifSection}
      `;

      // Footer sans boutons d'action (c'est un historique)
      const modalFooter = document.getElementById('modal-footer');
      modalFooter.innerHTML = `
        <button class="btn-primary" style="background: rgba(255, 255, 255, 0.1) !important;" onclick="closeModal()">
          <i class="fas fa-times"></i>
          Fermer
        </button>
      `;

      openModal();
    }

    // Afficher les infos d'un employ√© dans le modal (activation - premi√®re fois)
    function showEmployeeInfo(employeeData, isHistorique = false) {
      const emp = employeeData;

      // Ajuster la taille du modal
      const modalContent = document.querySelector('.modal-content');
      modalContent.style.maxWidth = '1100px';
      modalContent.style.width = '95vw';
      modalContent.style.setProperty('height', 'auto', 'important');
      modalContent.style.setProperty('max-height', '90vh', 'important');

      // Corps du modal - ajuster height
      const modalBodyEl = document.getElementById('modal-body');
      modalBodyEl.style.setProperty('height', 'auto', 'important');
      modalBodyEl.style.setProperty('max-height', 'none', 'important');
      modalBodyEl.style.overflow = 'auto';

      // Avatar - orange pour activation
      const avatar = document.getElementById('modal-avatar');
      const initial = emp.nom ? emp.nom.charAt(0).toUpperCase() : '?';
      avatar.textContent = initial;
      avatar.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';

      // Titre et sous-titre
      const nomComplet = emp.nom || 'Employ√© inconnu';
      document.getElementById('modal-title').textContent = nomComplet;
      document.getElementById('modal-subtitle').textContent = 'Nouvelle activation - ' + (emp.poste || emp.posteService || 'Poste non d√©fini');

      // Fonction helper pour cr√©er une ligne avec bouton copier
      function createRow(label, valeur, showBorder = true) {
        const val = valeur || '-';
        const valEscaped = String(val).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const borderStyle = showBorder ? 'border-bottom: 1px dashed rgba(148, 163, 184, 0.1);' : '';
        return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; ' + borderStyle + '">' +
          '<span class="text-sm" style="color: rgba(148, 163, 184, 0.7);">' + label + '</span>' +
          '<span style="display: flex; align-items: center; gap: 0.5rem;">' +
            '<span class="text-sm font-medium" style="color: #f1f5f9;">' + val + '</span>' +
            '<button class="btn-copy" onclick="copierTexte(\'' + valEscaped + '\', this)">' +
              '<i class="fas fa-copy"></i>' +
            '</button>' +
          '</span>' +
        '</div>';
      }

      // Corps du modal avec grid 2 colonnes
      const modalBody = document.getElementById('modal-body');

      // Construire la section documents
      const entrepreneur = emp.entrepreneurUsername || emp.entrepreneur;
      const specimenDoc = emp.specimenCheque || emp.specimen;
      const certificatDoc = emp.certificatSecurite || emp.certificat;
      const carteDoc = emp.carteAssurance || emp.carte;

      function createDocLink(doc) {
        if (doc) {
          const url = '/api/employes/' + entrepreneur + '/documents/' + emp.id + '/' + doc;
          return '<div style="display: flex; gap: 0.5rem; align-items: center;">' +
            '<a href="#" onclick="ouvrirDocumentViewer(\'' + url + '\'); return false;" style="display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; padding: 0.375rem 0.75rem; border-radius: 9999px; background: rgba(96, 165, 250, 0.15); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); text-decoration: none;"><i class="fas fa-eye"></i> Voir</a>' +
            '<a href="' + url + '" download style="display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; padding: 0.375rem 0.75rem; border-radius: 9999px; background: rgba(16, 185, 129, 0.15); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); text-decoration: none;"><i class="fas fa-download"></i></a>' +
          '</div>';
        } else {
          return '<span style="color: rgba(148, 163, 184, 0.5);">Aucun</span>';
        }
      }

      function createDocRow(label, doc) {
        return '<div style="display: flex; flex-direction: column; align-items: center; padding: 0.5rem 0;">' +
          '<span style="font-size: 0.75rem; margin-bottom: 0.5rem; color: rgba(148, 163, 184, 0.7);">' + label + '</span>' +
          createDocLink(doc) +
        '</div>';
      }

      const tauxFormate = emp.tauxHoraire ? parseFloat(emp.tauxHoraire).toFixed(2) + ' $' : '-';

      // V√©rifier si l'employ√© est termin√©
      const isTermine = emp.dateFinEmploi || emp.date_fin_emploi || emp.date_inactivation || emp.motif_fin_emploi || emp.motif_inactivation;
      const dateLabel = isTermine ? 'Date fin d\'emploi' : 'Date premi√®re journ√©e';
      const dateValue = isTermine ? (emp.dateFinEmploi || emp.date_fin_emploi || emp.date_inactivation || '-') : emp.datePremiere;

      modalBody.innerHTML =
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">' +
          '<!-- Colonne gauche -->' +
          '<div style="display: flex; flex-direction: column; gap: 1rem;">' +
            '<!-- Section: Informations de l\'entrepreneur -->' +
            '<div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">' +
              '<div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">' +
                '<i class="fas fa-briefcase" style="color: #f59e0b;"></i>' +
                'Informations de l\'entrepreneur' +
              '</div>' +
              createRow('Entrepreneur', emp.entrepreneur) +
              createRow('Poste', emp.posteService || emp.poste) +
              createRow('D√©partement', emp.entrepreneurDepartment || emp.departement || '0') +
              createRow('Taux horaire', tauxFormate) +
              createRow(dateLabel, dateValue, false) +
            '</div>' +
            '<!-- Section: Contact -->' +
            '<div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">' +
              '<div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">' +
                '<i class="fas fa-phone" style="color: #10b981;"></i>' +
                'Contact' +
              '</div>' +
              createRow('Courriel', emp.courriel) +
              createRow('T√©l√©phone', emp.telephone, false) +
            '</div>' +
          '</div>' +
          '<!-- Colonne droite -->' +
          '<div style="display: flex; flex-direction: column; gap: 1rem;">' +
            '<!-- Section: Informations de l\'employ√© -->' +
            '<div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">' +
              '<div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">' +
                '<i class="fas fa-user" style="color: #60a5fa;"></i>' +
                'Informations de l\'employ√©' +
              '</div>' +
              createRow('Nom complet', emp.nom) +
              createRow('Genre', emp.genre) +
              createRow('Date de naissance', emp.dateNaissance) +
              createRow('NAS', emp.nas, false) +
            '</div>' +
            '<!-- Section: Adresse d√©taill√©e -->' +
            '<div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">' +
              '<div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">' +
                '<i class="fas fa-map-marker-alt" style="color: #8b5cf6;"></i>' +
                'Adresse d√©taill√©e' +
              '</div>' +
              createRow('Adresse', emp.adresse) +
              createRow('Ville', emp.ville) +
              createRow('Code postal', emp.codePostal, false) +
            '</div>' +
          '</div>' +
        '</div>' +
        '<!-- Section: Documents (pleine largeur) -->' +
        '<div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem; margin-top: 1rem;">' +
          '<div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">' +
            '<i class="fas fa-file-alt" style="color: #60a5fa;"></i>' +
            'Documents' +
          '</div>' +
          '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">' +
            createDocRow('Sp√©cimen ch√®que', specimenDoc) +
            createDocRow('Certificat s√©curit√©', certificatDoc) +
            createDocRow('Carte assurance maladie', carteDoc) +
          '</div>' +
        '</div>';

      // Footer avec boutons d'action
      const modalFooter = document.getElementById('modal-footer');
      const nomEscaped = nomComplet.replace(/'/g, "\\'");

      if (isHistorique) {
        modalFooter.innerHTML =
          '<button class="btn-primary" style="background: rgba(255, 255, 255, 0.1) !important; border: 1px solid rgba(148, 163, 184, 0.2);" onclick="closeModal()">' +
            '<i class="fas fa-times" style="margin-right: 0.5rem;"></i>' +
            'Fermer' +
          '</button>';
      } else {
        modalFooter.innerHTML =
          '<button class="btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;" onclick="closeModal(); refuserEmploye(\'' + (emp.entrepreneurUsername || emp.entrepreneur) + '\', \'' + emp.id + '\', \'' + nomEscaped + '\')">' +
            '<i class="fas fa-times" style="margin-right: 0.5rem;"></i>' +
            'Refuser' +
          '</button>' +
          '<button class="btn-primary" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;" onclick="closeModal(); validerEmploye(\'' + (emp.entrepreneurUsername || emp.entrepreneur) + '\', \'' + emp.id + '\', \'' + nomEscaped + '\')">' +
            '<i class="fas fa-check" style="margin-right: 0.5rem;"></i>' +
            'Valider' +
          '</button>';
      }

      openModal();
    }

    // Obtenir la couleur du statut
    function getStatusColor(statut) {
      if (!statut) return '#94a3b8';
      const s = statut.toLowerCase();
      if (s.includes('actif') && !s.includes('inactif')) return '#10b981';
      if (s.includes('attente')) return '#f59e0b';
      if (s.includes('inactif') || s.includes('refus')) return '#ef4444';
      return '#94a3b8';
    }

    // Animations CSS
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);

    // ===== FONCTIONS POUR FIN D'EMPLOI MULTIPLE =====

    // Toggle s√©lection de tous les employ√©s actifs
    function toggleSelectAllActifs(checkbox) {
      const checkboxes = document.querySelectorAll('.employe-actif-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
      });
      updateActionBarFinEmploi();
    }

    // Mettre √† jour la barre d'actions
    function updateActionBarFinEmploi() {
      const checkboxes = document.querySelectorAll('.employe-actif-checkbox');
      const checked = Array.from(checkboxes).filter(cb => cb.checked);
      const count = checked.length;

      const actionBar = document.getElementById('action-bar-fin-emploi');
      const countSpan = document.getElementById('count-selected');

      if (count > 0) {
        actionBar.classList.add('visible');
        countSpan.textContent = count;
      } else {
        actionBar.classList.remove('visible');
      }

      // Mettre √† jour l'√©tat de la checkbox "Tout s√©lectionner"
      const selectAll = document.getElementById('select-all-actifs');
      if (selectAll) {
        if (count === 0) {
          selectAll.checked = false;
          selectAll.indeterminate = false;
        } else if (count === checkboxes.length) {
          selectAll.checked = true;
          selectAll.indeterminate = false;
        } else {
          selectAll.checked = false;
          selectAll.indeterminate = true;
        }
      }
    }

    // D√©s√©lectionner tout
    function deselectionnerTout() {
      const checkboxes = document.querySelectorAll('.employe-actif-checkbox');
      checkboxes.forEach(cb => cb.checked = false);
      const selectAll = document.getElementById('select-all-actifs');
      if (selectAll) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      }
      updateActionBarFinEmploi();
    }

    // Ouvrir le modal de fin d'emploi
    function ouvrirModalFinEmploi() {
      const checkboxes = document.querySelectorAll('.employe-actif-checkbox:checked');
      const count = checkboxes.length;

      if (count === 0) return;

      // Mettre √† jour le sous-titre
      document.getElementById('modal-fin-emploi-subtitle').textContent = `${count} employ√©(s) s√©lectionn√©(s)`;

      // Construire la liste des employ√©s
      const listeContainer = document.getElementById('liste-employes-fin');
      listeContainer.innerHTML = '';

      checkboxes.forEach(cb => {
        const empNom = cb.dataset.empNom;
        const entrepreneur = cb.dataset.entrepreneur;

        const item = document.createElement('div');
        item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid rgba(239, 68, 68, 0.2);';
        item.innerHTML = `
          <span style="font-weight: 600; color: var(--text-light);">${empNom}</span>
          <span style="font-size: 0.85rem; color: var(--text-gray);">${entrepreneur}</span>
        `;
        listeContainer.appendChild(item);
      });

      // R√©initialiser les champs
      resetCustomSelectFinEmploi();
      document.getElementById('justificatif-fin-emploi-comptable').value = '';

      // Afficher le modal
      document.getElementById('modal-fin-emploi').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    // Fermer le modal de fin d'emploi
    function fermerModalFinEmploi() {
      document.getElementById('modal-fin-emploi').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Confirmer la fin d'emploi
    async function confirmerFinEmploi() {
      const motif = document.getElementById('motif-fin-emploi-comptable').value;
      const justificatif = document.getElementById('justificatif-fin-emploi-comptable').value.trim();

      if (!motif) {
        alert('Veuillez s√©lectionner un motif de fin d\'emploi.');
        return;
      }

      const checkboxes = document.querySelectorAll('.employe-actif-checkbox:checked');
      if (checkboxes.length === 0) {
        fermerModalFinEmploi();
        return;
      }

      // Collecter les donn√©es des employ√©s s√©lectionn√©s
      const employesATerminer = [];
      checkboxes.forEach(cb => {
        employesATerminer.push({
          id: cb.dataset.empId,
          nom: cb.dataset.empNom,
          entrepreneur: cb.dataset.entrepreneur,
          entrepreneurUsername: cb.dataset.entrepreneurUsername
        });
      });

      try {
        const response = await fetch('/api/comptable/fin-emploi-multiple', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            employes: employesATerminer,
            motif: motif,
            justificatif: justificatif
          })
        });

        if (response.ok) {
          const result = await response.json();
          showNotification(`${result.count} employ√©(s) mis en fin d'emploi avec succ√®s`, 'success');

          // Fermer le modal et d√©cocher tout
          fermerModalFinEmploi();
          deselectionnerTout();

          // Recharger la liste
          loadTousLesEmployes();
        } else {
          const error = await response.json();
          showNotification('Erreur: ' + (error.detail || 'Erreur lors de la fin d\'emploi'), 'error');
        }
      } catch (error) {
        console.error('Erreur lors de la fin d\'emploi:', error);
        showNotification('Erreur de connexion', 'error');
      }
    }

    // ===== CUSTOM SELECT POUR MOTIF FIN D'EMPLOI =====
    function initCustomSelectFinEmploi() {
      const customSelect = document.querySelector('#modal-fin-emploi .custom-select');
      if (!customSelect) return;

      const button = customSelect.querySelector('.custom-select-button');
      const dropdown = customSelect.querySelector('.custom-select-dropdown');
      const textElement = customSelect.querySelector('.custom-select-text');
      const hiddenSelect = document.getElementById('motif-fin-emploi-comptable');

      // Toggle dropdown on button click
      button.addEventListener('click', (e) => {
        e.stopPropagation();
        // Fermer les autres dropdowns
        document.querySelectorAll('.custom-select').forEach(select => {
          if (select !== customSelect) {
            select.classList.remove('open');
          }
        });
        customSelect.classList.toggle('open');
      });

      // Handle option selection
      dropdown.querySelectorAll('.custom-select-option').forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const value = option.dataset.value;
          const text = option.textContent;

          // Update hidden select
          hiddenSelect.value = value;

          // Update text
          textElement.textContent = text;

          // Update selected class
          dropdown.querySelectorAll('.custom-select-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          option.classList.add('selected');

          // Close dropdown
          customSelect.classList.remove('open');
        });
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.custom-select')) {
          customSelect.classList.remove('open');
        }
      });
    }

    // R√©initialiser le custom select
    function resetCustomSelectFinEmploi() {
      const customSelect = document.querySelector('#modal-fin-emploi .custom-select');
      if (!customSelect) return;

      const textElement = customSelect.querySelector('.custom-select-text');
      const dropdown = customSelect.querySelector('.custom-select-dropdown');
      const hiddenSelect = document.getElementById('motif-fin-emploi-comptable');

      // Reset value
      hiddenSelect.value = '';
      textElement.textContent = 'S√©lectionner un motif';

      // Reset selected class
      dropdown.querySelectorAll('.custom-select-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.value === '') {
          opt.classList.add('selected');
        }
      });

      // Close dropdown
      customSelect.classList.remove('open');
    }

    // Initialiser au chargement
    document.addEventListener('DOMContentLoaded', initCustomSelectFinEmploi);

    // Initialiser le viewer modal (centraleadmin style)
    document.addEventListener('DOMContentLoaded', () => {
      const closeViewer = document.getElementById('closeViewer');
      if (closeViewer) {
        closeViewer.addEventListener('click', fermerDocumentViewer);
      }

      // Initialiser les calendriers
      if (document.getElementById('filter-date-start-actifs')) {
        new CustomCalendar('filter-date-start-actifs', 'calendar-filter-date-start-actifs', filterTousActifs);
      }
      if (document.getElementById('filter-date-end-actifs')) {
        new CustomCalendar('filter-date-end-actifs', 'calendar-filter-date-end-actifs', filterTousActifs);
      }
      if (document.getElementById('filter-date-start-termines')) {
        new CustomCalendar('filter-date-start-termines', 'calendar-filter-date-start-termines', filterTousTermines);
      }
      if (document.getElementById('filter-date-end-termines')) {
        new CustomCalendar('filter-date-end-termines', 'calendar-filter-date-end-termines', filterTousTermines);
      }
    });

    // Classe CustomCalendar
    class CustomCalendar {
      static instances = [];

      constructor(inputId, calendarId, onChangeCallback) {
        this.inputElement = document.getElementById(inputId);
        this.calendarElement = document.getElementById(calendarId);
        this.onChangeCallback = onChangeCallback;
        this.currentDate = new Date();
        this.selectedDate = null;
        this.inputElement.value = '';

        this.monthNames = [
          'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
          'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
        ];

        this.dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

        CustomCalendar.instances.push(this);
        this.init();
      }

      init() {
        this.inputElement.addEventListener('click', (e) => {
          e.stopPropagation();
          this.showCalendar();
        });

        document.addEventListener('click', (e) => {
          if (!this.calendarElement.contains(e.target) && e.target !== this.inputElement) {
            this.hideCalendar();
          }
        });
      }

      showCalendar() {
        CustomCalendar.instances.forEach(instance => {
          if (instance !== this) {
            instance.hideCalendar();
          }
        });

        this.calendarElement.classList.remove('hidden');
        this.calendarElement.style.setProperty('display', 'block', 'important');
        this.renderCalendar();
      }

      hideCalendar() {
        this.calendarElement.classList.add('hidden');
      }

      renderCalendar() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const prevLastDay = new Date(year, month, 0);

        const firstDayWeek = firstDay.getDay();
        const lastDateMonth = lastDay.getDate();
        const prevLastDateMonth = prevLastDay.getDate();

        let calendarHTML = `
          <div class="calendar-header">
            <button class="calendar-nav-btn" onclick="event.stopPropagation(); this.closest('.custom-calendar').__calendar.prevMonth()">‚Äπ</button>
            <div class="calendar-month-year">${this.monthNames[month]} ${year}</div>
            <button class="calendar-nav-btn" onclick="event.stopPropagation(); this.closest('.custom-calendar').__calendar.nextMonth()">‚Ä∫</button>
          </div>
          <div class="calendar-weekdays">
        `;

        this.dayNames.forEach(day => {
          calendarHTML += `<div class="calendar-weekday">${day}</div>`;
        });

        calendarHTML += '</div><div class="calendar-days">';

        for (let i = firstDayWeek - 1; i >= 0; i--) {
          const day = prevLastDateMonth - i;
          calendarHTML += `<div class="calendar-day other-month">${day}</div>`;
        }

        const today = new Date();
        for (let day = 1; day <= lastDateMonth; day++) {
          const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
          const isSelected = this.selectedDate && day === this.selectedDate.getDate() &&
                            month === this.selectedDate.getMonth() && year === this.selectedDate.getFullYear();

          let classes = 'calendar-day';
          if (isToday) classes += ' today';
          if (isSelected) classes += ' selected';

          calendarHTML += `<div class="${classes}" onclick="event.stopPropagation(); this.closest('.custom-calendar').__calendar.selectDate(${year}, ${month}, ${day})">${day}</div>`;
        }

        const remainingDays = 42 - (firstDayWeek + lastDateMonth);
        for (let day = 1; day <= remainingDays; day++) {
          calendarHTML += `<div class="calendar-day other-month">${day}</div>`;
        }

        calendarHTML += '</div>';
        this.calendarElement.innerHTML = calendarHTML;
        this.calendarElement.__calendar = this;
      }

      prevMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
        this.renderCalendar();
      }

      nextMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
        this.renderCalendar();
      }

      selectDate(year, month, day) {
        this.selectedDate = new Date(year, month, day);
        const formattedDate = this.formatDate(this.selectedDate);
        this.inputElement.value = formattedDate;
        this.hideCalendar();
        if (this.onChangeCallback) {
          this.onChangeCallback();
        }
      }

      formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${day}/${month}/${year}`;
      }

      parseDate(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.split('/');
        if (parts.length !== 3) return null;
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        return new Date(year, month, day);
      }

      reset() {
        this.selectedDate = null;
        this.inputElement.value = '';
        this.currentDate = new Date();
      }
    }

    // Fonction helper pour parser les dates DD/MM/YYYY
    function parseDate(dateStr) {
      if (!dateStr) return null;
      const parts = dateStr.split('/');
      if (parts.length !== 3) return null;
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1;
      const year = parseInt(parts[2], 10);
      return new Date(year, month, day);
    }

    // Fonction de r√©initialisation des filtres actifs
    function resetFiltersActifs() {
      document.getElementById('tous-actifs-search').value = '';
      filterTousActifs();
    }

    // Fonction de r√©initialisation des filtres termin√©s
    function resetFiltersTermines() {
      document.getElementById('tous-termines-search').value = '';
      filterTousTermines();
    }
  </script>

  <!-- Modal viewer (centraleadmin style) -->
  <div id="centraleViewerModal" class="modal-overlay-opaque" style="display: none;">
    <div class="modal-content" style="max-width: 90vw; max-height: 90vh; position: relative;">
      <button id="closeViewer" class="viewer-close">
        <i class="fas fa-times"></i>
      </button>
      <div id="centraleViewerContent" class="viewer-content"></div>
    </div>
  </div>
</body>
</html>
