<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Facturation QE - Direction</title>

  <!-- PWA Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Qwota">
  <meta name="msapplication-TileColor" content="#1f2937">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Icônes PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

  <!-- Scripts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="icon" href="/favicon" type="image/x-icon" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

  <!-- Script commun -->
  <script src="/common.js"></script>

  <!-- Feuille de style principale - Thème Dark -->
  <link rel="stylesheet" href="/base.css">

  <style>
    /* Container principal */
    .validation-container {
      width: 100%;
      padding: 2rem;
    }

    /* Header */
    .page-header {
      margin-bottom: 2rem;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .page-title i {
      color: var(--primary-blue);
    }

    .page-subtitle {
      font-size: 1rem;
      color: var(--text-gray);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-top: 2rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid rgba(71, 85, 105, 0.3);
    }

    .tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      color: var(--text-gray);
      font-weight: 600;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
    }

    .tab:hover {
      color: var(--text-light);
    }

    .tab.active {
      color: #60a5fa;
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Table */
    .table-container {
      background: var(--bg-card);
      border: 1px solid var(--border-dark);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow-dark-medium);
      max-height: none !important;
      height: 850px !important;
    }

    .table-header {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(51, 65, 85, 0.8) 100%);
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-dark);
    }

    .table-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .table-body {
      padding: 1.5rem;
      box-sizing: border-box;
    }

    /* Container pour scroll horizontal avec scrollbar en haut */
    .table-scroll-container {
      width: 100%;
      overflow-x: auto;
      transform: rotateX(180deg);
      margin-top: -1rem;
      padding-top: 0;
    }

    .table-scroll-container::-webkit-scrollbar {
      height: 6px;
    }

    .table-scroll-container::-webkit-scrollbar-track {
      background: rgba(100, 116, 139, 0.2);
      border-radius: 3px;
    }

    .table-scroll-container::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.6);
      border-radius: 3px;
      cursor: grab;
    }

    .table-scroll-container::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.8);
    }

    .table-scroll-container table {
      transform: rotateX(180deg);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: max-content;
    }

    thead th {
      text-align: left;
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-gray);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--border-dark);
      white-space: nowrap;
      cursor: grab;
      user-select: none;
    }

    thead th:active {
      cursor: grabbing;
    }

    tbody tr {
      border-bottom: 1px solid rgba(71, 85, 105, 0.2);
      transition: background-color 0.2s ease;
    }

    tbody tr:hover {
      background-color: rgba(59, 130, 246, 0.05);
    }

    tbody tr:last-child {
      border-bottom: none;
    }

    tbody td {
      padding: 1rem;
      font-size: 0.875rem;
      color: var(--text-light);
      white-space: nowrap;
    }

    /* Badges */
    .entrepreneur-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.375rem 0.75rem;
      background: rgba(96, 165, 250, 0.1);
      border: 1px solid rgba(96, 165, 250, 0.3);
      border-radius: 8px;
      color: var(--primary-blue);
      font-size: 0.875rem;
      font-weight: 500;
    }

    .entrepreneur-badge i {
      font-size: 0.75rem;
    }

    /* Type badges */
    .type-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .type-badge.depot {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .type-badge.paiement-final {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .type-badge.autres {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
    }

    .type-badge.remboursement {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    /* Custom Checkbox Styles */
    .custom-checkbox {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(96, 165, 250, 0.3);
      border-radius: 6px;
      background: var(--bg-sidebar);
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
      outline: none;
    }

    .custom-checkbox:hover {
      border-color: rgba(96, 165, 250, 0.6);
      background: rgba(96, 165, 250, 0.05);
      transform: scale(1.1);
    }

    .custom-checkbox:checked {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #3b82f6;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
    }

    .custom-checkbox:checked::after {
      content: '\f00c';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 12px;
    }

    .custom-checkbox:indeterminate {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      border-color: #8b5cf6;
    }

    .custom-checkbox:indeterminate::after {
      content: '\f068';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 10px;
    }

    .custom-checkbox:focus {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    /* Custom Calendar Styles */
    .custom-calendar {
      position: absolute;
      width: 280px;
      top: 100%;
      margin-top: 4px;
      left: 0;
      background: #1a2332;
      border: 2px solid var(--border-dark);
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      padding: 16px;
      z-index: 9999 !important;
    }

    .custom-calendar.hidden {
      display: none;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .calendar-nav-btn {
      background: #172033 !important;
      color: #60a5fa !important;
      border: 2px solid var(--border-dark) !important;
      width: 30px !important;
      height: 30px !important;
      border-radius: 50% !important;
      cursor: pointer !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-size: 16px !important;
      padding: 0 !important;
      transition: all 0.2s ease !important;
    }

    .calendar-nav-btn:hover {
      background: #3b82f6 !important;
      color: white !important;
      border-color: #3b82f6 !important;
    }

    .calendar-month-year {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-light);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .calendar-day-header {
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-gray);
      padding: 8px 4px;
    }

    .calendar-day {
      text-align: center;
      padding: 8px 4px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 14px;
      color: var(--text-light);
      transition: all 0.2s ease;
    }

    .calendar-day:hover {
      background: #172033;
    }

    .calendar-day.selected {
      background: #3b82f6;
      color: white;
    }

    .calendar-day.today {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
      border: 1px solid #60a5fa;
      font-weight: 600;
    }

    .calendar-day.other-month {
      color: #6b7280;
    }

    /* Custom Dropdown Styles */
    .custom-dropdown {
      position: relative;
      width: 100%;
    }

    .dropdown-button {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      color: var(--text-light);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .dropdown-button:hover {
      background: rgba(30, 41, 59, 0.8);
      border-color: rgba(96, 165, 250, 0.4);
    }

    .dropdown-button i {
      font-size: 0.75rem;
      color: var(--text-gray);
      transition: transform 0.2s ease;
    }

    .dropdown-button.open i {
      transform: rotate(180deg);
    }

    .dropdown-menu {
      position: absolute;
      top: calc(100% + 0.5rem);
      left: 0;
      right: 0;
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: none;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .dropdown-menu.show {
      display: block;
      animation: dropdownFadeIn 0.2s ease;
    }

    @keyframes dropdownFadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      color: var(--text-light);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary-blue);
    }

    .dropdown-item i {
      font-size: 0.75rem;
      color: transparent;
      transition: color 0.2s ease;
    }

    .dropdown-item.active i {
      color: var(--primary-blue);
    }

    .dropdown-item.active {
      background: rgba(59, 130, 246, 0.05);
      color: var(--primary-blue);
    }

    /* Boutons d'action */
    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn-validate {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .btn-validate:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      transform: translateY(-2px);
    }

    .btn-refuse {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .btn-refuse:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      transform: translateY(-2px);
    }

    .btn-view {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    .btn-view:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      transform: translateY(-2px);
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
      transform: translateY(-2px);
    }

    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-gray);
      width: 100%;
      min-height: 200px;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 1.125rem;
    }

    /* Loading state */
    .loading-shimmer {
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .validation-container {
        padding: 1rem;
      }

      .page-title {
        font-size: 1.5rem;
      }

      table {
        font-size: 0.8rem;
      }

      thead th, tbody td {
        padding: 0.5rem;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn-validate, .btn-refuse, .btn-view {
        width: 100%;
        justify-content: center;
      }
    }

    /* ============================================
       MODAL DÉTAILS TRAITEMENT - DIRECTION
       ============================================ */
    .modal-details-traitement {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-details-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
    }

    .modal-details-content {
      position: relative;
      background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 20px;
      max-width: 1100px;
      width: 95vw;
      height: auto !important;
      max-height: 90vh !important;
      overflow: auto;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      background: rgba(15, 23, 42, 0.5);
      border-bottom: 1px solid #94a3b81a;
    }

    .modal-header-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .modal-header-title i {
      font-size: 1.5rem;
      color: var(--text-light);
    }

    .modal-header-title h2 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-light);
    }

    .modal-close-btn {
      background: rgba(239, 68, 68, 0.2);
      border: none;
      border-radius: 10px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f87171;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-close-btn:hover {
      background: rgba(239, 68, 68, 0.4);
      transform: scale(1.1);
    }

    .modal-details-body {
      flex: 1;
      padding: 2rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    /* Section entrepreneur en haut (pleine largeur) */
    .modal-section.entrepreneur-section {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: 12px;
      padding: 1.5rem;
      overflow: hidden;
      width: 100%;
    }

    /* Container pour les sections client et paiement (50/50) */
    .modal-bottom-sections {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      flex: 1;
      overflow: hidden;
    }

    /* Sections du modal */
    .modal-section {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: 12px;
      padding: 1.5rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-section:last-child {
      margin-bottom: 0;
    }

    .modal-section-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: #94a3b8;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .modal-section-title i {
      font-size: 1rem;
    }

    .modal-info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      gap: 0.75rem;
    }

    .modal-info-row:not(:last-child) {
      border-bottom: 1px dashed rgba(148, 163, 184, 0.1);
    }

    .modal-info-label {
      color: #64748b;
      font-size: 0.875rem;
      flex-shrink: 0;
    }

    .modal-info-value {
      color: var(--text-light);
      font-weight: 500;
      font-size: 0.9rem;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    /* Bouton copier */
    .btn-copy {
      background: rgba(96, 165, 250, 0.1);
      border: 1px solid rgba(96, 165, 250, 0.3);
      border-radius: 6px;
      padding: 0.25rem 0.5rem;
      color: #60a5fa;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      flex-shrink: 0;
    }

    .btn-copy:hover {
      background: rgba(96, 165, 250, 0.2);
      border-color: rgba(96, 165, 250, 0.5);
      transform: translateY(-1px);
    }

    .btn-copy.copied {
      background: rgba(34, 197, 94, 0.1);
      border-color: rgba(34, 197, 94, 0.4);
      color: #22c55e;
    }

    .btn-copy i {
      font-size: 0.7rem;
    }

    /* Animation de copie */
    @keyframes copyPulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    .btn-copy.copied {
      animation: copyPulse 0.3s ease;
    }

    .modal-info-value.highlight {
      color: #22c55e;
      font-weight: 600;
    }

    /* Input montant modifiable */
    .montant-editable {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 6px;
      padding: 0.4rem 0.6rem;
      color: #22c55e;
      font-weight: 600;
      font-size: 0.95rem;
      width: 115px;
      text-align: right;
      transition: all 0.2s ease;
    }

    .montant-editable:focus {
      outline: none;
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.15);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }

    .montant-editable:hover {
      border-color: rgba(34, 197, 94, 0.5);
    }

    .modal-info-value.warning {
      color: #fb923c;
    }

    /* Lien cliquable */
    .modal-link {
      color: #60a5fa;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: all 0.2s ease;
    }

    .modal-link:hover {
      color: #93c5fd;
      text-decoration: underline;
    }

    /* Bouton voir soumission */
    .modal-voir-soumission {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.2) 0%, rgba(59, 130, 246, 0.15) 100%);
      border: 1px solid rgba(96, 165, 250, 0.4);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      color: #60a5fa;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-voir-soumission:hover {
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.3) 0%, rgba(59, 130, 246, 0.25) 100%);
      transform: translateY(-1px);
    }

    .modal-details-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1.5rem 2rem;
      background: rgba(15, 23, 42, 0.5);
      border-top: 1px solid rgba(148, 163, 184, 0.1);
      flex-shrink: 0;
    }

    .modal-details-footer .btn {
      padding: 0.625rem 1.25rem;
      border-radius: 10px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-details-footer .btn-refuser {
      background: linear-gradient(135deg, #475569 0%, #334155 100%) !important;
      border: none !important;
      color: white !important;
    }

    .modal-details-footer .btn-refuser:hover {
      transform: translateY(-2px);
      background: linear-gradient(135deg, #64748b 0%, #475569 100%) !important;
      box-shadow: 0 4px 12px rgba(71, 85, 105, 0.4);
    }

    /* Style par défaut pour accepter (vert) */
    .modal-details-footer .btn-accepter {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;
      border: none !important;
      color: white !important;
    }

    .modal-details-footer .btn-accepter:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }

    /* Style orange pour dépôt */
    .modal-details-footer .btn-accepter.depot-style {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
    }

    .modal-details-footer .btn-accepter.depot-style:hover {
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }

    /* Style vert pour paiement final */
    .modal-details-footer .btn-accepter.paiement-final-style {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;
    }

    .modal-details-footer .btn-accepter.paiement-final-style:hover {
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }

    /* Style violet pour autres */
    .modal-details-footer .btn-accepter.autres-style {
      background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%) !important;
    }

    .modal-details-footer .btn-accepter.autres-style:hover {
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
    }

    /* Style rouge pour remboursement */
    .modal-details-footer .btn-accepter.remboursement-style {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
    }

    .modal-details-footer .btn-accepter.remboursement-style:hover {
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    /* Modal Soumission PDF */
    .modal-soumission {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 100001;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
    }

    .modal-soumission.active {
      display: flex;
    }

    .modal-soumission-content {
      background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 20px;
      width: 95%;
      max-width: 1000px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .modal-soumission-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      background: rgba(15, 23, 42, 0.5);
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .modal-soumission-header h3 {
      margin: 0;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .modal-soumission-body {
      padding: 1rem;
      height: 70vh;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--border-dark);
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    /* ============================================
       OVERLAY DE CHARGEMENT - DIRECTION
       ============================================ */
    .loading-overlay-direction {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 999999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .loading-overlay-direction.active {
      opacity: 1;
      visibility: visible;
    }

    .loading-overlay-direction .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(59, 130, 246, 0.2);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-overlay-direction .loading-text {
      margin-top: 1rem;
      color: var(--text-light);
      font-size: 1rem;
      font-weight: 500;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast Success */
    .toast-success-direction {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.4);
      z-index: 999999;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transform: translateX(150%);
      transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .toast-success-direction.active {
      transform: translateX(0);
    }

    .toast-success-direction i {
      font-size: 1.25rem;
    }

    .toast-success-direction .toast-content h4 {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .toast-success-direction .toast-content p {
      margin: 0.25rem 0 0 0;
      font-size: 0.8rem;
      opacity: 0.9;
    }

    /* ============================================
       MODAL REFUS AVEC RAISON
       ============================================ */
    .modal-refus {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 100000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-refus-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
    }

    .modal-refus-content {
      position: relative;
      background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 30px rgba(239, 68, 68, 0.1);
      animation: modalSlideIn 0.3s ease-out;
    }

    .modal-refus-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      background: rgba(239, 68, 68, 0.1);
      border-bottom: 1px solid rgba(239, 68, 68, 0.2);
    }

    .modal-refus-body {
      padding: 1.5rem;
    }

    .modal-refus-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      background: rgba(15, 23, 42, 0.5);
      border-top: 1px solid rgba(148, 163, 184, 0.1);
    }

    .btn-annuler {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      background: rgba(100, 116, 139, 0.2);
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 10px;
      color: var(--text-gray);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-annuler:hover {
      background: rgba(100, 116, 139, 0.3);
      color: var(--text-light);
    }

    .btn-confirmer-refus {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .btn-confirmer-refus:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .btn-confirmer-refus:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* ============================================
       MODAL SUPPRESSION PERSONNALISÉ
       ============================================ */
    .modal-suppression {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 100000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-suppression-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
    }

    .modal-suppression-content {
      position: relative;
      background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 20px;
      width: 90%;
      max-width: 450px;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 30px rgba(239, 68, 68, 0.1);
      animation: modalSlideIn 0.3s ease-out;
    }

    .modal-suppression-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      background: rgba(239, 68, 68, 0.1);
      border-bottom: 1px solid rgba(239, 68, 68, 0.2);
    }

    .modal-suppression-header .modal-header-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .modal-suppression-header .modal-header-title i {
      color: #ef4444;
      font-size: 1.25rem;
    }

    .modal-suppression-header .modal-header-title h2 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-light);
    }

    .modal-suppression-body {
      padding: 1.5rem;
    }

    .modal-suppression-body .suppression-info {
      background: rgba(239, 68, 68, 0.05);
      border: 1px solid rgba(239, 68, 68, 0.15);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .modal-suppression-body .suppression-info-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .modal-suppression-body .suppression-info-row:last-child {
      border-bottom: none;
    }

    .modal-suppression-body .suppression-info-label {
      color: var(--text-gray);
      font-size: 0.85rem;
    }

    .modal-suppression-body .suppression-info-value {
      color: var(--text-light);
      font-weight: 500;
      font-size: 0.85rem;
    }

    .modal-suppression-body .suppression-warning {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 10px;
      color: #fca5a5;
      font-size: 0.85rem;
    }

    .modal-suppression-body .suppression-warning i {
      color: #ef4444;
    }

    .modal-suppression-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      background: rgba(15, 23, 42, 0.5);
      border-top: 1px solid rgba(148, 163, 184, 0.1);
    }

    .btn-confirmer-suppression {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .btn-confirmer-suppression:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    /* ============================================
       SOUS-TABS PAIEMENTS / MESSAGES
       ============================================ */
    .subtab {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      background: transparent;
      border: none;
      color: var(--text-gray);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .subtab:hover {
      color: var(--text-light);
    }

    .subtab.active {
      color: #60a5fa;
    }

    .subtab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0.5rem;
      right: 0.5rem;
      height: 2px;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      border-radius: 2px;
    }

    .subtab-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      background: rgba(96, 165, 250, 0.2);
      color: #60a5fa;
      font-size: 0.7rem;
      font-weight: 700;
      border-radius: 10px;
    }

    .subtab-count.urgent {
      background: #ef4444;
      color: white;
      animation: pulse-badge 2s infinite;
    }

    @keyframes pulse-badge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .subtab-content {
      display: block;
    }

    /* ============================================
       LISTE MESSAGES - STYLE CHAT ENTREPRENEUR
       ============================================ */
    .message-card {
      background: rgba(23, 32, 51, 0.6);
      border: 1px solid var(--border-dark);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .message-card:hover {
      border-color: rgba(239, 68, 68, 0.4);
      background: rgba(23, 32, 51, 0.8);
      transform: translateX(4px);
    }

    .message-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .message-card-entrepreneur {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .message-card-entrepreneur .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .message-card-entrepreneur .name {
      font-weight: 600;
      color: var(--text-light);
    }

    .message-card-date {
      font-size: 0.75rem;
      color: var(--text-gray);
    }

    .message-card-soumission {
      font-size: 0.85rem;
      color: #60a5fa;
      margin-bottom: 0.5rem;
    }

    .message-card-preview {
      font-size: 0.85rem;
      color: var(--text-gray);
      line-height: 1.4;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .message-card-preview i {
      color: #ef4444;
      margin-top: 2px;
    }

    .message-card-count {
      font-size: 0.75rem;
      color: #ef4444;
      margin-top: 0.5rem;
      font-weight: 500;
    }

    /* ============================================
       VUE CONVERSATION - STYLE ENTREPRENEUR
       ============================================ */
    .conversation-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 1rem;
    }

    .conversation-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-dark);
      margin-bottom: 1rem;
    }

    .conversation-back-btn {
      background: transparent;
      border: none;
      color: #60a5fa;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .conversation-back-btn:hover {
      background: rgba(96, 165, 250, 0.1);
    }

    .conversation-entrepreneur-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .conversation-entrepreneur-info .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1rem;
    }

    .conversation-entrepreneur-info .details h3 {
      color: var(--text-light);
      font-size: 1rem;
      font-weight: 600;
      margin: 0;
    }

    .conversation-entrepreneur-info .details span {
      color: #60a5fa;
      font-size: 0.85rem;
    }

    /* Bouton Info Client */
    .btn-info-client {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
    }

    .btn-info-client:hover {
      background: rgba(16, 185, 129, 0.25);
      border-color: rgba(16, 185, 129, 0.5);
    }

    .btn-info-client i {
      font-size: 1rem;
    }

    /* Bouton Info Paiement */
    .btn-info-paiement {
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #3b82f6;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
    }

    .btn-info-paiement:hover {
      background: rgba(59, 130, 246, 0.25);
      border-color: rgba(59, 130, 246, 0.5);
    }

    .btn-info-paiement i {
      font-size: 1rem;
    }

    /* Modal Info Client */
    .client-info-grid {
      display: grid;
      gap: 1rem;
    }

    .client-info-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      padding: 0.75rem;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 8px;
      border: 1px solid var(--border-dark);
    }

    .client-info-item label {
      color: #94a3b8;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .client-info-item label i {
      color: #60a5fa;
      width: 14px;
    }

    .client-info-item span {
      color: var(--text-light);
      font-size: 0.95rem;
    }

    /* Modal overlay pour popup Info client */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: var(--bg-dark);
      border: 1px solid var(--border-dark);
      border-radius: 0;
      width: 100vw;
      height: 100vh;
      max-width: none;
      max-height: none;
      overflow-y: auto;
      box-shadow: none;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-dark);
    }

    .modal-header h3 {
      color: var(--text-light);
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .modal-header h3 i {
      color: #10b981;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: #94a3b8;
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .modal-body {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .conversation-messages {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0;
    }

    .chat-message {
      display: flex;
      flex-direction: column;
      margin-bottom: 0.75rem;
    }

    .chat-message.from-comptable {
      align-items: flex-end;
    }

    .chat-message.from-entrepreneur {
      align-items: flex-start;
    }

    .chat-bubble {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 16px;
    }

    .chat-message.from-comptable .chat-bubble {
      background: rgba(59, 130, 246, 0.2);
      border-bottom-right-radius: 4px;
    }

    .chat-message.from-entrepreneur .chat-bubble {
      background: rgba(23, 32, 51, 0.8);
      border: 1px solid var(--border-dark);
      border-bottom-left-radius: 4px;
    }

    .chat-bubble .sender {
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
    }

    .chat-message.from-comptable .chat-bubble .sender {
      color: #60a5fa;
    }

    .chat-message.from-entrepreneur .chat-bubble .sender {
      color: #ef4444;
    }

    .chat-bubble .text {
      color: var(--text-light);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .chat-bubble .time {
      font-size: 0.65rem;
      color: var(--text-gray);
      margin-top: 0.25rem;
      text-align: right;
    }

    /* Zone de saisie style chat - comme entrepreneur */
    .chat-input-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: rgba(30, 41, 59, 0.4);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.1);
    }

    .chat-textarea {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-light);
      font-size: 0.9rem;
      resize: none;
      outline: none;
      padding: 0.25rem;
      max-height: 100px;
    }

    .chat-textarea::placeholder {
      color: var(--text-gray);
    }

    .btn-envoyer-chat {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .btn-envoyer-chat:hover {
      color: #10b981;
      transform: scale(1.1);
    }
  </style>
</head>

<body class="min-h-screen" style="margin: 0; padding: 0; background: var(--bg-dark);">

  <!-- Overlay de chargement -->
  <div id="loadingOverlayDirection" class="loading-overlay-direction">
    <div class="spinner"></div>
    <div class="loading-text">Traitement en cours...</div>
  </div>

  <!-- Toast de succès -->
  <div id="toastSuccessDirection" class="toast-success-direction">
    <i class="fas fa-check-circle"></i>
    <div class="toast-content">
      <h4 id="toastTitle">Succès</h4>
      <p id="toastMessage">Paiement traité avec succès</p>
    </div>
  </div>

  <div class="validation-container">
    <!-- Header -->
    <div class="mb-10" style="margin-top: 2rem;">
      <div class="relative">
        <h1 class="text-4xl font-bold mb-3">
          Facturation QE
        </h1>
        <span class="absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-blue-600 to-blue-400 rounded-full"></span>
        <div class="flex items-center justify-between mt-6">
          <p class="text-xl font-medium" style="color: var(--text-gray);">Validez ou refusez les paiements en attente de traitement</p>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('general')" data-tab="general">
        <i class="fas fa-file-invoice-dollar" style="margin-right: 0.5rem;"></i>Général
      </button>
      <button class="tab" onclick="switchTab('tableau')" data-tab="tableau">
        <i class="fas fa-table" style="margin-right: 0.5rem;"></i>Tableau
      </button>
    </div>

    <!-- Vue Général -->
    <div id="general-view" class="tab-content active">
    <!-- Layout 2 colonnes -->
    <div style="display: flex; gap: 1.5rem; align-items: stretch; height: 850px;">

      <!-- Colonne gauche: Table principale -->
      <div class="table-container" style="flex: 1; height: 850px; display: flex; flex-direction: column;">
        <div class="table-header" style="flex-shrink: 0;">
          <!-- Sous-tabs Paiements / Messages -->
          <div style="display: flex; align-items: center; gap: 0;">
            <button id="subtab-paiements" class="subtab active" onclick="switchSubTab('paiements')">
              <i class="fas fa-file-invoice-dollar"></i>
              <span>Paiements</span>
              <span id="paiements-count-badge" class="subtab-count">0</span>
            </button>
            <button id="subtab-messages" class="subtab" onclick="switchSubTab('messages')">
              <i class="fas fa-envelope"></i>
              <span>Messages</span>
              <span id="messages-count-badge" class="subtab-count urgent" style="display: none;">0</span>
            </button>
          </div>
        </div>

        <!-- Filtres -->
        <div id="filters-bar" class="filters-bar" style="padding: 1rem 1.5rem; background: rgba(15, 23, 42, 0.6); border-bottom: 1px solid rgba(148, 163, 184, 0.1); display: flex; gap: 1rem; align-items: center; flex-shrink: 0;">
          <div class="filter-group" style="flex: 1;">
            <label style="display: block; font-size: 0.875rem; color: var(--text-gray); margin-bottom: 0.5rem;">
              <i class="fas fa-filter"></i> Type de paiement
            </label>
            <div class="custom-dropdown" id="dropdown-type">
              <button class="dropdown-button" onclick="toggleDropdown('type')">
                <span id="selected-type">Tous les types</span>
                <i class="fas fa-chevron-down"></i>
              </button>
              <div class="dropdown-menu" id="menu-type">
                <div class="dropdown-item active" onclick="selectFilter('type', 'tous', 'Tous les types')">
                  <i class="fas fa-check"></i>
                  <span>Tous les types</span>
                </div>
                <div class="dropdown-item" onclick="selectFilter('type', 'depot', 'Dépôt')">
                  <i class="fas fa-check"></i>
                  <span>Dépôt</span>
                </div>
                <div class="dropdown-item" onclick="selectFilter('type', 'paiement_final', 'Paiement final')">
                  <i class="fas fa-check"></i>
                  <span>Paiement final</span>
                </div>
                <div class="dropdown-item" onclick="selectFilter('type', 'un_seul_paiement', 'Un seul paiement')">
                  <i class="fas fa-check"></i>
                  <span>Un seul paiement</span>
                </div>
                <div class="dropdown-item" onclick="selectFilter('type', 'paiement_partiel', 'Paiement partiel')">
                  <i class="fas fa-check"></i>
                  <span>Paiement partiel</span>
                </div>
                <div class="dropdown-item" onclick="selectFilter('type', 'remboursement', 'Remboursement')">
                  <i class="fas fa-check"></i>
                  <span>Remboursement</span>
                </div>
              </div>
            </div>
          </div>

          <div class="filter-group" style="flex: 1;">
            <label style="display: block; font-size: 0.875rem; color: var(--text-gray); margin-bottom: 0.5rem;">
              <i class="fas fa-wallet"></i> Méthode de paiement
            </label>
            <div class="custom-dropdown" id="dropdown-methode">
              <button class="dropdown-button" onclick="toggleDropdown('methode')">
                <span id="selected-methode">Virement</span>
                <i class="fas fa-chevron-down"></i>
              </button>
              <div class="dropdown-menu" id="menu-methode">
                <div class="dropdown-item active" onclick="selectFilter('methode', 'virement', 'Virement')">
                  <i class="fas fa-check"></i>
                  <span>Virement</span>
                </div>
                <div class="dropdown-item" onclick="selectFilter('methode', 'cheque', 'Chèque')">
                  <i class="fas fa-check"></i>
                  <span>Chèque</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Vue Paiements -->
        <div id="paiements-view" class="subtab-content" style="flex: 1; min-height: 0; overflow-y: auto;">
          <div class="table-body" style="height: 100%;">
            <div id="loading-state" class="empty-state loading-shimmer" style="height: 100%;">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Chargement des paiements...</p>
            </div>
            <div id="empty-state" class="empty-state" style="display: none; height: 100%;">
              <i class="fas fa-check-circle"></i>
              <p>Aucun paiement en attente de traitement</p>
            </div>
            <div class="table-scroll-container" id="payments-scroll-container">
              <table id="payments-table" style="display: none; width: 100%;">
                <thead id="payments-thead">
                  <tr>
                    <th style="width: 50px; text-align: center;"></th>
                    <th>Entrepreneur</th>
                    <th>Client</th>
                    <th>N° Soumission</th>
                    <th>Type</th>
                    <th>Montant</th>
                    <th>Date</th>
                    <th style="text-align: center;">Actions</th>
                  </tr>
                </thead>
                <tbody id="payments-tbody">
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Vue Messages -->
        <div id="messages-view" class="subtab-content" style="flex: 1; min-height: 0; overflow-y: auto; display: none;">
          <div class="table-body" style="height: 100%;">
            <div id="messages-loading" class="empty-state loading-shimmer" style="height: 100%;">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Chargement des messages...</p>
            </div>
            <div id="messages-empty" class="empty-state" style="display: none; height: 100%;">
              <i class="fas fa-inbox"></i>
              <p>Aucun message en attente</p>
            </div>
            <div id="messages-list" style="display: none; padding: 0.5rem;"></div>
            <div id="conversation-view" style="display: none; height: 100%;"></div>
          </div>
        </div>
      </div>

      <!-- Colonne droite: Stats + 5 derniers traités -->
      <div style="width: 340px; height: 850px; display: flex; flex-direction: column; gap: 0.75rem;">

        <!-- Total en traitement -->
        <div style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 10px; padding: 0.875rem 1rem; display: flex; align-items: center; gap: 0.75rem;">
          <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(59, 130, 246, 0.15); display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-file-invoice-dollar" style="color: #60a5fa; font-size: 0.9rem;"></i>
          </div>
          <div style="flex: 1;">
            <div style="font-size: 0.7rem; font-weight: 500; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.3px;">Total en traitement</div>
            <div id="stat-total" style="font-size: 1.25rem; font-weight: 700; color: var(--text-light); margin-top: 1px;">0</div>
          </div>
        </div>

        <!-- Section Par type -->
        <div style="font-size: 0.7rem; font-weight: 600; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.5px; padding-left: 0.25rem; margin-top: 0.5rem;">
          <i class="fas fa-chart-pie" style="margin-right: 0.4rem; color: #60a5fa;"></i>Par type de paiement
        </div>

        <!-- Cards par type -->
        <div style="display: grid; grid-template-columns: 1fr; gap: 0.5rem;">
          <!-- Dépôts -->
          <div style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 10px; padding: 0.875rem 1rem; display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(245, 158, 11, 0.15); display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-hand-holding-dollar" style="color: #f59e0b; font-size: 0.9rem;"></i>
            </div>
            <div style="flex: 1;">
              <div style="font-size: 0.7rem; font-weight: 500; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.3px;">Dépôts</div>
              <div id="stat-depots" style="font-size: 1.25rem; font-weight: 700; color: var(--text-light); margin-top: 1px;">0</div>
            </div>
          </div>

          <!-- Paiements finaux -->
          <div style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 10px; padding: 0.875rem 1rem; display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(34, 197, 94, 0.15); display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-check-circle" style="color: #22c55e; font-size: 0.9rem;"></i>
            </div>
            <div style="flex: 1;">
              <div style="font-size: 0.7rem; font-weight: 500; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.3px;">Paiements finaux</div>
              <div id="stat-paiements-finaux" style="font-size: 1.25rem; font-weight: 700; color: var(--text-light); margin-top: 1px;">0</div>
            </div>
          </div>

          <!-- Autres paiements -->
          <div style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 10px; padding: 0.875rem 1rem; display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(168, 85, 247, 0.15); display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-plus-circle" style="color: #a855f7; font-size: 0.9rem;"></i>
            </div>
            <div style="flex: 1;">
              <div style="font-size: 0.7rem; font-weight: 500; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.3px;">Autres paiements</div>
              <div id="stat-autres" style="font-size: 1.25rem; font-weight: 700; color: var(--text-light); margin-top: 1px;">0</div>
            </div>
          </div>

          <!-- Remboursements -->
          <div style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 10px; padding: 0.875rem 1rem; display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(239, 68, 68, 0.15); display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-undo" style="color: #ef4444; font-size: 0.9rem;"></i>
            </div>
            <div style="flex: 1;">
              <div style="font-size: 0.7rem; font-weight: 500; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.3px;">Remboursements</div>
              <div id="stat-remboursements" style="font-size: 1.25rem; font-weight: 700; color: var(--text-light); margin-top: 1px;">0</div>
            </div>
          </div>
        </div>

        <!-- Section 5 derniers traités -->
        <div style="font-size: 0.7rem; font-weight: 600; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.5px; padding-left: 0.25rem; margin-top: 1rem;">
          <i class="fas fa-history" style="margin-right: 0.4rem; color: #60a5fa;"></i>Derniers traités
        </div>

        <!-- Container des derniers traités -->
        <div id="derniers-traites" style="display: flex; flex-direction: column; gap: 0.5rem; flex: 1; overflow-y: auto; min-height: 0;">
          <!-- Contenu dynamique chargé par chargerDerniersTraites() -->
        </div>

      </div>
    </div>
    </div>

    <!-- Vue Tableau par Périodes -->
    <div id="tableau-view" class="tab-content">
      <!-- Section Rapprochement QBO -->
      <div class="box" style="margin-bottom: 1.5rem;">
        <div class="box-header">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="box-header-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
              <i class="fas fa-calculator"></i>
            </div>
            <div>
              <h3 class="box-header-title">Rapprochement QBO</h3>
              <p class="box-header-subtitle">Tableau récapitulatif des transactions</p>
            </div>
          </div>
        </div>
        <div class="box-body" style="padding: 0; position: relative; overflow: hidden;">
          <!-- Barre de filtres pour Rapprochement QBO -->
          <div style="background: var(--bg-hover); border-bottom: 1px solid var(--border-dark); padding: 1rem;">
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: end;">
              <div style="flex: 1; min-width: 250px;">
                <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-gray); margin-bottom: 0.35rem; text-transform: uppercase; letter-spacing: 0.5px;">
                  <i class="fas fa-search" style="margin-right: 0.25rem;"></i> Recherche
                </label>
                <input type="text" id="filter-search-rapprochement" placeholder="Entrepreneur, client, N° soumission..." onkeyup="applyFiltersRapprochement()" style="width: 100%; padding: 0.5rem 0.75rem; background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 6px; color: var(--text-light); font-size: 0.85rem;">
              </div>
              <div style="min-width: 180px;">
                <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-gray); margin-bottom: 0.35rem; text-transform: uppercase; letter-spacing: 0.5px;">
                  <i class="fas fa-tag" style="margin-right: 0.25rem;"></i> Type
                </label>
                <select id="filter-type-rapprochement" style="display: none;">
                  <option value="">Tous les types</option>
                  <option value="depot">Dépôt</option>
                  <option value="paiement_final">Paiement final</option>
                  <option value="autres_paiements">Autre</option>
                </select>
                <div class="custom-select" data-target="filter-type-rapprochement">
                  <div class="custom-select-button" tabindex="0">
                    <span class="custom-select-text">Tous les types</span>
                    <span class="custom-select-arrow">▼</span>
                  </div>
                  <div class="custom-select-dropdown">
                    <div class="custom-select-option selected" data-value="">Tous les types</div>
                    <div class="custom-select-option" data-value="depot">Dépôt</div>
                    <div class="custom-select-option" data-value="paiement_final">Paiement final</div>
                    <div class="custom-select-option" data-value="autres_paiements">Autre</div>
                  </div>
                </div>
              </div>
              <div style="min-width: 170px;">
                <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Date début</label>
                <div class="custom-date-container" style="position: relative;">
                  <input type="text" id="filter-date-start-rapprochement" class="w-full p-2 text-sm rounded-lg cursor-pointer" placeholder="Sélectionner une date" readonly autocomplete="off" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);">
                  <div class="custom-calendar hidden" id="calendar-filter-date-start">
                    <!-- Calendar content will be generated here -->
                  </div>
                </div>
              </div>
              <div style="min-width: 170px;">
                <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Date fin</label>
                <div class="custom-date-container" style="position: relative;">
                  <input type="text" id="filter-date-end-rapprochement" class="w-full p-2 text-sm rounded-lg cursor-pointer" placeholder="Sélectionner une date" readonly autocomplete="off" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);">
                  <div class="custom-calendar hidden" id="calendar-filter-date-end">
                    <!-- Calendar content will be generated here -->
                  </div>
                </div>
              </div>
              <button onclick="resetFiltersRapprochement()" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; padding: 0.5rem 1rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; height: 48px;">
                <i class="fas fa-times"></i>
                Réinitialiser
              </button>
            </div>
          </div>

          <!-- Barre d'actions (cachée par défaut, visible quand au moins 1 checkbox est cochée) -->
          <div id="action-bar" style="display: none; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-bottom: 1px solid var(--border-dark); padding: 0.75rem 1rem; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <span id="selected-count" style="color: #60a5fa; font-weight: 600; font-size: 0.9rem;">0 sélectionné(s)</span>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="retournerGeneral()" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;">
                <i class="fas fa-arrow-left"></i>
                Retourner à Général
              </button>
              <button onclick="exporterSelection()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;">
                <i class="fas fa-file-export"></i>
                Exporter
              </button>
              <button onclick="deplacerSelection()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;">
                <i class="fas fa-arrow-right"></i>
                Déplacer
              </button>
              <button onclick="supprimerSelection()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;">
                <i class="fas fa-trash"></i>
                Supprimer
              </button>
            </div>
          </div>

          <div id="rapprochement-loading" class="empty-state loading-shimmer">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Chargement des données...</p>
          </div>
          <div id="rapprochement-empty" class="empty-state" style="display: none;">
            <i class="fas fa-inbox"></i>
            <p>Aucune donnée disponible</p>
          </div>
          <div id="rapprochement-content" style="display: none; max-height: 500px; overflow-y: auto;">
            <table style="width: 100%;">
              <thead style="position: sticky; top: 0; z-index: 10; background: var(--bg-card);">
                <tr style="border-bottom: 2px solid var(--border-dark);">
                  <th style="padding: 0.75rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: var(--text-gray); background: var(--bg-card);">Date</th>
                  <th style="padding: 0.75rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: var(--text-gray); background: var(--bg-card);">Entrepreneur</th>
                  <th style="padding: 0.75rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: var(--text-gray); background: var(--bg-card);">Client</th>
                  <th style="padding: 0.75rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: var(--text-gray); background: var(--bg-card);">N° Soumission</th>
                  <th style="padding: 0.75rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: var(--text-gray); background: var(--bg-card);">Type</th>
                  <th style="padding: 0.75rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: var(--text-gray); background: var(--bg-card);">Montant</th>
                  <th style="padding: 0.75rem 1.5rem; text-align: center; font-size: 0.85rem; font-weight: 600; color: var(--text-gray); background: var(--bg-card); width: 80px;">
                    <input type="checkbox" id="select-all-rapprochement" onchange="toggleSelectAll(this)" class="custom-checkbox">
                  </th>
                </tr>
              </thead>
              <tbody id="rapprochement-tbody">
                <!-- Les données seront générées dynamiquement -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Section Tableau des paiements par période -->
      <div class="box">
        <div class="box-header">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="box-header-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
              <i class="fas fa-table"></i>
            </div>
            <div>
              <h3 class="box-header-title">Tableau des paiements par période</h3>
              <p class="box-header-subtitle">Périodes de 2 semaines</p>
            </div>
          </div>
        </div>
        <div class="box-body" style="padding: 0;">
          <!-- Barre de filtres pour Tableau des périodes -->
          <div style="background: var(--bg-hover); border-bottom: 1px solid var(--border-dark); padding: 1rem;">
            <div style="display: flex; gap: 0.75rem; align-items: end;">
              <div style="flex: 1;">
                <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Recherche</label>
                <input type="text" id="filter-search-periodes" placeholder="Entrepreneur, client..." onkeyup="applyFiltersPeriodes()" class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);">
              </div>
              <div style="min-width: 150px;">
                <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Type</label>
                <select id="filter-type-periodes" style="display: none;">
                  <option value="">Tous les types</option>
                  <option value="depot">Dépôt</option>
                  <option value="paiement_final">Paiement final</option>
                  <option value="autres_paiements">Autre</option>
                </select>
                <div class="custom-select" data-target="filter-type-periodes">
                  <div class="custom-select-button" tabindex="0">
                    <span class="custom-select-text">Tous les types</span>
                    <span class="custom-select-arrow">▼</span>
                  </div>
                  <div class="custom-select-dropdown">
                    <div class="custom-select-option selected" data-value="">Tous les types</div>
                    <div class="custom-select-option" data-value="depot">Dépôt</div>
                    <div class="custom-select-option" data-value="paiement_final">Paiement final</div>
                    <div class="custom-select-option" data-value="autres_paiements">Autre</div>
                  </div>
                </div>
              </div>
              <div style="min-width: 350px;">
                <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Période</label>
                <select id="filter-periode-periodes" style="display: none;">
                  <option value="">Toutes les périodes</option>
                  <!-- Sera rempli dynamiquement -->
                </select>
                <div class="custom-select" data-target="filter-periode-periodes">
                  <div class="custom-select-button" tabindex="0">
                    <span class="custom-select-text">Toutes les périodes</span>
                    <span class="custom-select-arrow">▼</span>
                  </div>
                  <div class="custom-select-dropdown" id="periode-dropdown-options">
                    <div class="custom-select-option selected" data-value="">Toutes les périodes</div>
                    <!-- Sera rempli dynamiquement -->
                  </div>
                </div>
              </div>
              <button onclick="resetFiltersPeriodes()" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; padding: 0.5rem 1rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; height: 48px; margin-left: auto;">
                <i class="fas fa-times"></i>
                Réinitialiser
              </button>
            </div>
          </div>

          <div style="padding: 1rem;">
          <div id="tableau-loading" class="empty-state loading-shimmer" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Chargement des données...</p>
          </div>
          <div id="tableau-empty" class="empty-state" style="display: none;">
            <i class="fas fa-inbox"></i>
            <p>Aucune donnée disponible</p>
          </div>
          <div id="periodes-container">
            <!-- Périodes générées dynamiquement -->
          </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Détails Traitement Direction -->
  <div id="modalDetailsTraitement" class="modal-details-traitement" style="display: none;">
    <div class="modal-details-backdrop" onclick="fermerModal()"></div>
    <div class="modal-details-content">
      <div class="modal-details-header">
        <div class="modal-header-title">
          <i id="modalHeaderIcon" class="fas fa-file-invoice-dollar"></i>
          <h2 id="modalHeaderTitle">Détails du paiement</h2>
        </div>
        <button class="modal-close-btn" onclick="fermerModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-details-body" id="modalDetailsBody">
        <!-- Contenu dynamique -->
      </div>

      <div class="modal-details-footer">
        <button class="btn btn-secondary" onclick="refuserPaiement()">
          <i class="fas fa-times mr-2"></i>Refuser
        </button>
        <button id="btnAccepterPaiement" class="btn btn-primary btn-accepter" onclick="validerPaiement()">
          <i class="fas fa-check mr-2"></i>Valider
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Refus avec Raison -->
  <div id="modalRefus" class="modal-refus" style="display: none;">
    <div class="modal-refus-backdrop" onclick="fermerModalRefus()"></div>
    <div class="modal-refus-content">
      <div class="modal-refus-header">
        <div class="modal-header-title">
          <i class="fas fa-times-circle" style="color: #ef4444;"></i>
          <h2>Refuser le paiement</h2>
        </div>
        <button class="modal-close-btn" onclick="fermerModalRefus()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-refus-body">
        <p style="color: var(--text-gray); margin-bottom: 1rem;">
          Veuillez indiquer la raison du refus. Cette information sera transmise à l'entrepreneur.
        </p>
        <div class="form-group">
          <label for="raisonRefus" style="color: var(--text-light); font-weight: 500; margin-bottom: 0.5rem; display: block;">
            Raison du refus <span style="color: #ef4444;">*</span>
          </label>
          <textarea
            id="raisonRefus"
            placeholder="Ex: Montant incorrect, justificatif manquant, etc."
            rows="4"
            style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.5); color: var(--text-light); font-size: 0.9rem; resize: vertical;"
          ></textarea>
        </div>
      </div>
      <div class="modal-refus-footer">
        <button class="btn-annuler" onclick="fermerModalRefus()">
          <i class="fas fa-arrow-left"></i> Annuler
        </button>
        <button class="btn-confirmer-refus" onclick="confirmerRefus()">
          <i class="fas fa-times"></i> Confirmer le refus
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Suppression Personnalisé -->
  <div id="modalSuppression" class="modal-suppression" style="display: none;">
    <div class="modal-suppression-backdrop" onclick="fermerModalSuppression()"></div>
    <div class="modal-suppression-content">
      <div class="modal-suppression-header">
        <div class="modal-header-title">
          <i class="fas fa-trash-alt"></i>
          <h2>Supprimer le paiement</h2>
        </div>
        <button class="modal-close-btn" onclick="fermerModalSuppression()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-suppression-body">
        <div class="suppression-info">
          <div class="suppression-info-row">
            <span class="suppression-info-label">Client</span>
            <span class="suppression-info-value" id="suppression-client">-</span>
          </div>
          <div class="suppression-info-row">
            <span class="suppression-info-label">Type</span>
            <span class="suppression-info-value" id="suppression-type">-</span>
          </div>
          <div class="suppression-info-row">
            <span class="suppression-info-label">Montant</span>
            <span class="suppression-info-value" id="suppression-montant">-</span>
          </div>
          <div class="suppression-info-row">
            <span class="suppression-info-label">N° Soumission</span>
            <span class="suppression-info-value" id="suppression-soumission">-</span>
          </div>
        </div>
        <div class="suppression-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <span>Cette action est irréversible. Le paiement sera définitivement supprimé.</span>
        </div>
      </div>
      <div class="modal-suppression-footer">
        <button class="btn-annuler" onclick="fermerModalSuppression()">
          <i class="fas fa-arrow-left"></i> Annuler
        </button>
        <button class="btn-confirmer-suppression" onclick="confirmerSuppression()">
          <i class="fas fa-trash"></i> Supprimer
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Soumission PDF -->
  <div id="soumissionModal" class="modal-soumission">
    <div class="modal-soumission-content">
      <div class="modal-soumission-header">
        <h3><i class="fas fa-file-pdf"></i> Soumission</h3>
        <button class="modal-close-btn" onclick="fermerSoumissionModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-soumission-body" id="soumissionContent">
        <!-- PDF sera affiché ici -->
      </div>
    </div>
  </div>

  <script>
    // Variables globales
    let currentPayment = null;
    let allPayments = [];
    let messagesEnAttente = [];

    // Fonction pour formater le statut de façon lisible
    function formaterStatut(statut, type = null) {
      // Pour le dépôt (côté direction)
      if (type === 'depot') {
        if (statut === 'traite_attente_final' || statut === 'traite') {
          return 'Dépôt traité';
        }
        if (statut === 'attente_comptable') {
          return 'À valider'; // En attente de validation direction
        }
        if (statut === 'traitement') {
          return 'En attente coach'; // Coach n'a pas encore validé
        }
      }
      // Pour le paiement final (côté direction)
      if (type === 'paiement_final') {
        if (statut === 'traite') {
          return 'Traité';
        }
        if (statut === 'attente_comptable') {
          return 'À valider'; // En attente de validation direction
        }
        if (statut === 'traitement') {
          return 'À traiter'; // En attente que le coach valide
        }
      }
      // Fallback générique
      const statutsMap = {
        'traitement': 'À traiter',
        'attente_comptable': 'À valider',
        'traite': 'Traité',
        'traite_attente_final': 'Dépôt traité',
        'refuse': 'Refusé',
        'non_envoye': 'Non envoyé'
      };
      return statutsMap[statut] || statut || 'N/A';
    }

    // Fonction pour changer de tab
    function switchTab(tabName) {
      // Update tabs
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

      // Update views
      document.querySelectorAll('.tab-content').forEach(v => v.classList.remove('active'));
      document.getElementById(`${tabName}-view`).classList.add('active');

      // Charger les données si tableau
      if (tabName === 'tableau') {
        chargerTableauPeriodes();
      }
    }

    // Charger les paiements en traitement pour tous les entrepreneurs
    async function chargerPaiementsEnTraitement() {
      try {
        const response = await fetch('/api/comptable/facturation-en-traitement/liste');

        if (!response.ok) {
          throw new Error('Erreur lors du chargement');
        }

        const data = await response.json();
        allPayments = data.paiements || [];

        // Mettre à jour les stats
        document.getElementById('stat-total').textContent = allPayments.length;
        document.getElementById('stat-depots').textContent = allPayments.filter(p => p.type === 'depot').length;
        document.getElementById('stat-paiements-finaux').textContent = allPayments.filter(p => p.type === 'paiement_final').length;
        document.getElementById('stat-autres').textContent = allPayments.filter(p => p.type === 'autres_paiements').length;
        document.getElementById('stat-remboursements').textContent = allPayments.filter(p => p.type === 'remboursement').length;

        // Mettre à jour le badge des paiements dans les sous-tabs
        document.getElementById('paiements-count-badge').textContent = allPayments.length;

        // Appliquer les filtres par défaut (virement)
        applyFilters();

      } catch (error) {
        console.error('[Direction Facturation] Erreur:', error);
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('empty-state').style.display = 'flex';
      }
    }

    // ===== FILTRES =====
    let currentFilters = {
      type: 'tous',
      methode: 'virement'  // Par défaut virement
    };

    // Toggle dropdown menu
    function toggleDropdown(filterType) {
      const menu = document.getElementById(`menu-${filterType}`);
      const button = document.getElementById(`dropdown-${filterType}`).querySelector('.dropdown-button');
      const isOpen = menu.classList.contains('show');

      // Fermer tous les autres dropdowns
      document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
      document.querySelectorAll('.dropdown-button').forEach(b => b.classList.remove('open'));

      if (!isOpen) {
        menu.classList.add('show');
        button.classList.add('open');
      }
    }

    // Fermer les dropdowns si on clique ailleurs
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.custom-dropdown')) {
        document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
        document.querySelectorAll('.dropdown-button').forEach(b => b.classList.remove('open'));
      }
    });

    // Sélectionner un filtre
    function selectFilter(filterType, value, label) {
      // Mettre à jour le filtre actuel
      currentFilters[filterType] = value;

      // Mettre à jour l'affichage
      document.getElementById(`selected-${filterType}`).textContent = label;

      // Mettre à jour les classes active
      const menu = document.getElementById(`menu-${filterType}`);
      menu.querySelectorAll('.dropdown-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.closest('.dropdown-item').classList.add('active');

      // Fermer le dropdown
      menu.classList.remove('show');
      document.getElementById(`dropdown-${filterType}`).querySelector('.dropdown-button').classList.remove('open');

      // Appliquer les filtres
      applyFilters();
    }

    // Réinitialiser les filtres
    function resetFilters() {
      currentFilters = {
        type: 'tous',
        methode: 'tous'
      };

      // Réinitialiser l'affichage
      document.getElementById('selected-type').textContent = 'Tous les types';
      document.getElementById('selected-methode').textContent = 'Toutes les méthodes';

      // Réinitialiser les classes active
      document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.querySelectorAll('.dropdown-item').forEach((item, index) => {
          item.classList.remove('active');
          if (index === 0) item.classList.add('active');
        });
      });

      // Réafficher tous les paiements
      afficherPaiements(allPayments);
    }

    // Appliquer les filtres
    function applyFilters() {
      let filtered = allPayments;

      // Filtre par type
      if (currentFilters.type !== 'tous') {
        filtered = filtered.filter(p => {
          if (currentFilters.type === 'depot') {
            return p.type === 'depot';
          } else if (currentFilters.type === 'paiement_final') {
            return p.type === 'paiement_final';
          } else if (currentFilters.type === 'un_seul_paiement') {
            return p.type === 'autres_paiements' &&
                   (p.typePaiementAutres === 'un_seul_paiement' ||
                    (!p.typePaiementAutres && (p.statutDepot === 'non_envoye' || !p.statutDepot)));
          } else if (currentFilters.type === 'paiement_partiel') {
            return p.type === 'autres_paiements' &&
                   (p.typePaiementAutres === 'paiement_partiel' ||
                    (!p.typePaiementAutres && p.statutDepot && p.statutDepot !== 'non_envoye'));
          }
          return true;
        });
      }

      // Filtre par méthode
      if (currentFilters.methode !== 'tous') {
        filtered = filtered.filter(p => {
          const methode = (p.methode || '').toLowerCase();
          if (currentFilters.methode === 'virement') {
            return methode === 'virement';
          } else if (currentFilters.methode === 'cheque') {
            // Accepter cheque et chèque (avec ou sans accent)
            return methode === 'cheque' || methode === 'chèque';
          }
          return true;
        });
      }

      // Afficher les résultats filtrés
      afficherPaiements(filtered);
    }

    // Afficher les paiements dans le tableau
    function afficherPaiements(paiements) {
      const loadingState = document.getElementById('loading-state');
      const emptyState = document.getElementById('empty-state');
      const table = document.getElementById('payments-table');
      const tbody = document.getElementById('payments-tbody');

      loadingState.style.display = 'none';

      if (paiements.length === 0) {
        emptyState.style.display = 'flex';
        table.style.display = 'none';
        return;
      }

      emptyState.style.display = 'none';
      table.style.display = 'table';

      tbody.innerHTML = paiements.map(p => {
        const typeClass = p.type === 'depot' ? 'depot' : (p.type === 'paiement_final' ? 'paiement-final' : (p.type === 'remboursement' ? 'remboursement' : 'autres'));
        let typeLabel = p.type === 'depot' ? 'Dépôt' : (p.type === 'paiement_final' ? 'Paiement final' : (p.type === 'remboursement' ? 'Remboursement' : 'Autre'));
        // Pour les autres paiements, afficher le type spécifique
        if (p.type === 'autres_paiements') {
          // FALLBACK: Si typePaiementAutres est absent, déduire selon statutDepot
          let typeAutres = p.typePaiementAutres;
          if (!typeAutres) {
            const statutDepot = p.statutDepot || 'non_envoye';
            typeAutres = (statutDepot === 'non_envoye') ? 'un_seul_paiement' : 'paiement_partiel';
          }
          typeLabel = typeAutres === 'un_seul_paiement' ? 'Un seul paiement' : 'Paiement partiel';
        }

        // Photo de l'entrepreneur (comme dans coach_validation_employes)
        const photoHtml = p.entrepreneurPhoto
          ? `<img src="${p.entrepreneurPhoto}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(59, 130, 246, 0.3);">`
          : `<div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.75rem;">${p.entrepreneur ? p.entrepreneur.charAt(0).toUpperCase() : '?'}</div>`;

        return `
          <tr>
            <td style="text-align: center;">
              <button class="btn-danger" onclick='ouvrirModalSuppression(${JSON.stringify(p).replace(/'/g, "\\'")})' title="Supprimer ce paiement" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;">
                <i class="fas fa-trash"></i>
              </button>
            </td>
            <td>
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                ${photoHtml}
                <span style="font-weight: 500; color: var(--text-light);">${p.entrepreneur || 'N/A'}</span>
              </div>
            </td>
            <td>${p.client || 'N/A'}</td>
            <td style="font-weight: 600; color: #60a5fa;">${p.numeroSoumission || 'N/A'}</td>
            <td>
              <span class="type-badge ${typeClass}">
                ${typeLabel}
              </span>
            </td>
            <td style="font-weight: 600;">${p.type === 'remboursement' ? '-' + (p.montant || '0,00 $') : (p.montant || '0,00 $')}</td>
            <td style="color: var(--text-gray);">${p.date || 'N/A'}</td>
            <td>
              <div class="action-buttons" style="justify-content: center;">
                <button class="btn-primary" onclick='ouvrirDetails(${JSON.stringify(p).replace(/'/g, "\\'")})'>
                  <i class="fas fa-search"></i> Vérifier
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Ouvrir le modal de détails avec toutes les informations
    async function ouvrirDetails(paiement) {
      currentPayment = paiement;
      console.log('[Direction] Ouverture modal pour:', paiement);

      const modalBody = document.getElementById('modalDetailsBody');

      // Récupérer les données complètes depuis l'API
      let detailsComplets = {};
      try {
        const responseStatuts = await fetch(`/api/facturationqe/client/${paiement.entrepreneurUsername}/${paiement.numeroSoumission}/statuts`);
        if (responseStatuts.ok) {
          detailsComplets = await responseStatuts.json();
          console.log('[Direction] Détails statuts:', detailsComplets);
        }
      } catch (error) {
        console.error('[Direction] Erreur récupération données:', error);
      }

      let contentHTML = '';

      // Section Entrepreneur (pleine largeur en haut)
      const entrepreneurPhotoHtml = paiement.entrepreneurPhoto
        ? `<img src="${paiement.entrepreneurPhoto}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(59, 130, 246, 0.3);">`
        : `<div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.75rem;">${paiement.entrepreneur ? paiement.entrepreneur.charAt(0).toUpperCase() : '?'}</div>`;

      contentHTML += `
        <div class="modal-section entrepreneur-section">
          <div class="modal-section-title">
            <i class="fas fa-hard-hat" style="color: #3b82f6;"></i>
            Entrepreneur
          </div>
          <div class="modal-info-row">
            <span class="modal-info-label">Entrepreneur</span>
            <span class="modal-info-value" style="display: flex; align-items: center; gap: 0.5rem;">
              ${entrepreneurPhotoHtml}
              ${paiement.entrepreneur || 'N/A'}
            </span>
          </div>
        </div>
      `;

      // Container pour les sections 50/50
      contentHTML += `<div class="modal-bottom-sections">`;

      // Section Client (gauche)
      contentHTML += `
        <div class="modal-section">
          <div class="modal-section-title">
            <i class="fas fa-user" style="color: #60a5fa;"></i>
            Informations client
          </div>
          <div class="modal-info-row">
            <span class="modal-info-label">Nom complet</span>
            <span class="modal-info-value">${paiement.client || 'Client inconnu'}</span>
          </div>
          <div class="modal-info-row">
            <span class="modal-info-label">N° Soumission</span>
            <span class="modal-info-value" style="color: #60a5fa;">${paiement.numeroSoumission || 'N/A'}</span>
          </div>
          ${paiement.telephone ? `
          <div class="modal-info-row">
            <span class="modal-info-label">Téléphone</span>
            <span class="modal-info-value">${paiement.telephone}</span>
          </div>` : ''}
          ${paiement.adresse ? `
          <div class="modal-info-row">
            <span class="modal-info-label">Adresse</span>
            <span class="modal-info-value">${paiement.adresse}</span>
          </div>` : ''}
          ${paiement.totalTravaux ? `
          <div class="modal-info-row">
            <span class="modal-info-label">Total travaux</span>
            <span class="modal-info-value highlight">${paiement.totalTravaux}</span>
          </div>` : ''}
          <div class="modal-info-row">
            <span class="modal-info-label">Soumission</span>
            <button class="modal-voir-soumission" onclick="ouvrirSoumission('${paiement.entrepreneurUsername}', '${paiement.numeroSoumission}')">
              <i class="fas fa-file-alt"></i>
              Voir la soumission
            </button>
          </div>
        </div>
      `;

      // Afficher UNIQUEMENT la section correspondant au type de paiement cliqué
      const typePaiement = paiement.type;
      console.log('[Direction] Type de paiement:', typePaiement);

      // Section Dépôt - seulement si c'est le type cliqué (droite)
      if (typePaiement === 'depot' && detailsComplets.depot) {
        const depot = detailsComplets.depot;
        contentHTML += `
          <div class="modal-section">
            <div class="modal-section-title">
              <i class="fas fa-piggy-bank" style="color: #22c55e;"></i>
              Dépôt
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Nom complet</span>
              <span class="modal-info-value">
                <span>${paiement.client || 'Client inconnu'}</span>
                <button class="btn-copy" onclick="copierTexte('${paiement.client || 'Client inconnu'}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Montant</span>
              <span class="modal-info-value highlight">
                <input type="text" class="montant-editable" id="montant-depot" value="${depot.montant || ''}" data-type="depot" data-original="${depot.montant || ''}">
                <button class="btn-copy" onclick="copierTexte(document.getElementById('montant-depot').value, this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Date</span>
              <span class="modal-info-value">
                <span>${depot.date || 'N/A'}</span>
                <button class="btn-copy" onclick="copierTexte('${depot.date || 'N/A'}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Méthode</span>
              <span class="modal-info-value">
                <span>${depot.methode || 'N/A'}</span>
                <button class="btn-copy" onclick="copierTexte('${depot.methode || 'N/A'}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>
            ${depot.lienVirement ? `
            <div class="modal-info-row">
              <span class="modal-info-label">Lien virement</span>
              <span class="modal-info-value">
                <a href="${depot.lienVirement.startsWith('http') ? depot.lienVirement : 'https://' + depot.lienVirement}" target="_blank" class="modal-link">
                  <i class="fas fa-external-link-alt"></i>
                  ${depot.lienVirement}
                </a>
                <button class="btn-copy" onclick="copierTexte('${depot.lienVirement}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>` : ''}
            ${depot.motDePasse ? `
            <div class="modal-info-row">
              <span class="modal-info-label">Mot de passe</span>
              <span class="modal-info-value">
                <span>${depot.motDePasse}</span>
                <button class="btn-copy" onclick="copierTexte('${depot.motDePasse}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>` : ''}
            ${depot.methode === 'chèque' && depot.numeroCheque ? `
            <div class="modal-info-row">
              <span class="modal-info-label">N° Chèque</span>
              <span class="modal-info-value" style="color: #10b981; font-weight: 600;">${depot.numeroCheque}</span>
            </div>` : ''}
            ${depot.methode === 'chèque' ? `
            <div class="modal-info-row">
              <span class="modal-info-label">Chèque</span>
              <button class="modal-voir-soumission" onclick="ouvrirPhotosChequeDirection('${paiement.entrepreneurUsername}', '${paiement.numeroSoumission}', 'depot')">
                <i class="fas fa-images"></i>
                Voir le chèque
              </button>
            </div>` : ''}
          </div>
        `;
      }

      // Section Paiement Final - seulement si c'est le type cliqué
      if (typePaiement === 'paiement_final' && detailsComplets.paiementFinal && detailsComplets.paiementFinal.montant) {
        const pf = detailsComplets.paiementFinal;
        contentHTML += `
          <div class="modal-section">
            <div class="modal-section-title">
              <i class="fas fa-credit-card" style="color: #a855f7;"></i>
              Paiement Final
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Nom complet</span>
              <span class="modal-info-value">
                <span>${paiement.client || 'Client inconnu'}</span>
                <button class="btn-copy" onclick="copierTexte('${paiement.client || 'Client inconnu'}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Montant</span>
              <span class="modal-info-value highlight">
                <input type="text" class="montant-editable" id="montant-paiement-final" value="${pf.montant || ''}" data-type="paiement_final" data-original="${pf.montant || ''}">
                <button class="btn-copy" onclick="copierTexte(document.getElementById('montant-paiement-final').value, this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Date</span>
              <span class="modal-info-value">
                <span>${pf.date || 'N/A'}</span>
                <button class="btn-copy" onclick="copierTexte('${pf.date || 'N/A'}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Méthode</span>
              <span class="modal-info-value">
                <span>${pf.methode || 'N/A'}</span>
                <button class="btn-copy" onclick="copierTexte('${pf.methode || 'N/A'}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>
            ${pf.lienVirement ? `
            <div class="modal-info-row">
              <span class="modal-info-label">Lien virement</span>
              <span class="modal-info-value">
                <a href="${pf.lienVirement.startsWith('http') ? pf.lienVirement : 'https://' + pf.lienVirement}" target="_blank" class="modal-link">
                  <i class="fas fa-external-link-alt"></i>
                  ${pf.lienVirement}
                </a>
                <button class="btn-copy" onclick="copierTexte('${pf.lienVirement}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>` : ''}
            ${pf.motDePasse ? `
            <div class="modal-info-row">
              <span class="modal-info-label">Mot de passe</span>
              <span class="modal-info-value">
                <span>${pf.motDePasse}</span>
                <button class="btn-copy" onclick="copierTexte('${pf.motDePasse}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>` : ''}
            ${pf.methode === 'chèque' && pf.numeroCheque ? `
            <div class="modal-info-row">
              <span class="modal-info-label">N° Chèque</span>
              <span class="modal-info-value" style="color: #10b981; font-weight: 600;">${pf.numeroCheque}</span>
            </div>` : ''}
            ${pf.methode === 'chèque' ? `
            <div class="modal-info-row">
              <span class="modal-info-label">Chèque</span>
              <button class="modal-voir-soumission" onclick="ouvrirPhotosChequeDirection('${paiement.entrepreneurUsername}', '${paiement.numeroSoumission}', 'paiement_final')">
                <i class="fas fa-images"></i>
                Voir le chèque
              </button>
            </div>` : ''}
          </div>
        `;
      }

      // Section Autres Paiements - seulement si c'est le type cliqué (paiement partiel ou un seul paiement)
      if (typePaiement === 'autres_paiements' && detailsComplets.autresPaiements && detailsComplets.autresPaiements.length > 0) {
        // Trouver le paiement spécifique qui est en attente_comptable
        const paiementsEnAttente = detailsComplets.autresPaiements.filter(ap => ap.statut === 'attente_comptable');
        const paiementsAAfficher = paiementsEnAttente.length > 0 ? paiementsEnAttente : detailsComplets.autresPaiements;

        paiementsAAfficher.forEach((ap, index) => {
          // FALLBACK: Si typePaiementAutres est absent, déduire selon statutDepot
          let typeAutres = ap.typePaiementAutres;
          if (!typeAutres) {
            const statutDepot = detailsComplets.statutDepot || 'non_envoye';
            typeAutres = (statutDepot === 'non_envoye') ? 'un_seul_paiement' : 'paiement_partiel';
            console.log('[FALLBACK DIRECTION] typePaiementAutres déduit:', typeAutres, '(statutDepot:', statutDepot, ')');
          }
          const typePaiementLabel = typeAutres === 'un_seul_paiement' ? 'Paiement complet' : `Paiement partiel ${index + 1}`;
          contentHTML += `
            <div class="modal-section">
              <div class="modal-section-title">
                <i class="fas fa-coins" style="color: #fbbf24;"></i>
                ${typePaiementLabel}
              </div>
              <div class="modal-info-row">
                <span class="modal-info-label">Nom complet</span>
                <span class="modal-info-value">
                  <span>${paiement.client || 'Client inconnu'}</span>
                  <button class="btn-copy" onclick="copierTexte('${paiement.client || 'Client inconnu'}', this)">
                    <i class="fas fa-copy"></i> Copier
                  </button>
                </span>
              </div>
              <div class="modal-info-row">
                <span class="modal-info-label">Montant</span>
                <span class="modal-info-value highlight">
                  <input type="text" class="montant-editable" id="montant-autres-${index}" value="${ap.montant || ''}" data-type="autres_paiements" data-index="${index}" data-original="${ap.montant || ''}">
                  <button class="btn-copy" onclick="copierTexte(document.getElementById('montant-autres-${index}').value, this)">
                    <i class="fas fa-copy"></i> Copier
                  </button>
                </span>
              </div>
              <div class="modal-info-row">
                <span class="modal-info-label">Date</span>
                <span class="modal-info-value">
                  <span>${ap.date || 'N/A'}</span>
                  <button class="btn-copy" onclick="copierTexte('${ap.date || 'N/A'}', this)">
                    <i class="fas fa-copy"></i> Copier
                  </button>
                </span>
              </div>
              <div class="modal-info-row">
                <span class="modal-info-label">Méthode</span>
                <span class="modal-info-value">
                  <span>${ap.methode || 'N/A'}</span>
                  <button class="btn-copy" onclick="copierTexte('${ap.methode || 'N/A'}', this)">
                    <i class="fas fa-copy"></i> Copier
                  </button>
                </span>
              </div>
              ${ap.lienVirement ? `
              <div class="modal-info-row">
                <span class="modal-info-label">Lien virement</span>
                <span class="modal-info-value">
                  <a href="${ap.lienVirement.startsWith('http') ? ap.lienVirement : 'https://' + ap.lienVirement}" target="_blank" class="modal-link">
                    <i class="fas fa-external-link-alt"></i>
                    ${ap.lienVirement}
                  </a>
                  <button class="btn-copy" onclick="copierTexte('${ap.lienVirement}', this)">
                    <i class="fas fa-copy"></i> Copier
                  </button>
                </span>
              </div>` : ''}
              ${ap.motDePasse ? `
              <div class="modal-info-row">
                <span class="modal-info-label">Mot de passe</span>
                <span class="modal-info-value">
                  <span>${ap.motDePasse}</span>
                  <button class="btn-copy" onclick="copierTexte('${ap.motDePasse}', this)">
                    <i class="fas fa-copy"></i> Copier
                  </button>
                </span>
              </div>` : ''}
              ${ap.methode === 'chèque' && ap.numeroCheque ? `
              <div class="modal-info-row">
                <span class="modal-info-label">N° Chèque</span>
                <span class="modal-info-value" style="color: #10b981; font-weight: 600;">${ap.numeroCheque}</span>
              </div>` : ''}
              ${ap.methode === 'chèque' ? `
              <div class="modal-info-row">
                <span class="modal-info-label">Chèque</span>
                <button class="modal-voir-soumission" onclick="ouvrirPhotosChequeDirection('${paiement.entrepreneurUsername}', '${paiement.numeroSoumission}', 'autre_paiement_${index + 1}')">
                  <i class="fas fa-images"></i>
                  Voir le chèque
                </button>
              </div>` : ''}
            </div>
          `;
        });
      }

      // Section Remboursement - seulement si c'est le type cliqué (droite)
      if (typePaiement === 'remboursement') {
        contentHTML += `
          <div class="modal-section">
            <div class="modal-section-title">
              <i class="fas fa-undo" style="color: #ef4444;"></i>
              Remboursement
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Nom complet</span>
              <span class="modal-info-value">
                <span>${paiement.client || 'Client inconnu'}</span>
                <button class="btn-copy" onclick="copierTexte('${paiement.client || 'Client inconnu'}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">N° Département</span>
              <span class="modal-info-value">
                <span>0</span>
                <button class="btn-copy" onclick="copierTexte('0', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Montant à rembourser</span>
              <span class="modal-info-value highlight">
                <span>-${paiement.montant || 'N/A'}</span>
                <button class="btn-copy" onclick="copierTexte('-${paiement.montant || 'N/A'}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Courriel pour le virement</span>
              <span class="modal-info-value">
                <span>${paiement.courriel || 'N/A'}</span>
                <button class="btn-copy" onclick="copierTexte('${paiement.courriel || 'N/A'}', this)">
                  <i class="fas fa-copy"></i> Copier
                </button>
              </span>
            </div>
          </div>
        `;
      }

      // Fermer le container modal-bottom-sections
      contentHTML += `</div>`;

      modalBody.innerHTML = contentHTML;

      // Initialiser le formatage des inputs montant
      initMontantInputs();

      // Appliquer le style selon le type de paiement
      const btnAccepter = document.getElementById('btnAccepterPaiement');
      const headerIcon = document.getElementById('modalHeaderIcon');
      const headerTitle = document.getElementById('modalHeaderTitle');

      btnAccepter.classList.remove('depot-style', 'paiement-final-style', 'autres-style', 'remboursement-style');

      if (typePaiement === 'depot') {
        btnAccepter.classList.add('depot-style');
        headerIcon.className = 'fas fa-piggy-bank';
        headerIcon.style.color = '#f59e0b';
        headerTitle.textContent = 'Validation dépôt';
      } else if (typePaiement === 'paiement-final') {
        btnAccepter.classList.add('paiement-final-style');
        headerIcon.className = 'fas fa-check-circle';
        headerIcon.style.color = '#22c55e';
        headerTitle.textContent = 'Validation paiement final';
      } else if (typePaiement === 'remboursement') {
        btnAccepter.classList.add('remboursement-style');
        headerIcon.className = 'fas fa-undo';
        headerIcon.style.color = '#ef4444';
        headerTitle.textContent = 'Validation remboursement';
      } else if (typePaiement === 'autres') {
        btnAccepter.classList.add('autres-style');
        headerIcon.className = 'fas fa-money-bill-wave';
        headerIcon.style.color = '#a855f7';
        headerTitle.textContent = 'Validation autre paiement';
      } else {
        headerIcon.className = 'fas fa-file-invoice-dollar';
        headerIcon.style.color = '#60a5fa';
        headerTitle.textContent = 'Détails du paiement';
      }

      // Afficher le modal et bloquer le scroll de la page
      document.getElementById('modalDetailsTraitement').style.display = 'flex';
      document.body.style.overflow = 'hidden';
      document.documentElement.style.overflow = 'hidden';
      // Bloquer aussi le scroll du parent si dans un iframe
      if (window.parent && window.parent !== window) {
        try {
          window.parent.document.body.style.overflow = 'hidden';
          window.parent.document.documentElement.style.overflow = 'hidden';
        } catch(e) {}
      }
    }

    // Fonction pour copier le texte dans le presse-papiers
    function copierTexte(texte, btnElement) {
      // Nettoyer le texte (enlever le $ et les espaces pour copier juste le nombre)
      const texteNettoye = texte.replace(/\s/g, '').replace('$', '').trim();
      navigator.clipboard.writeText(texteNettoye).then(() => {
        // Changer l'apparence du bouton
        const icon = btnElement.querySelector('i');
        const originalIcon = icon.className;

        btnElement.classList.add('copied');
        icon.className = 'fas fa-check';

        // Revenir à l'état original après 1 seconde
        setTimeout(() => {
          btnElement.classList.remove('copied');
          icon.className = originalIcon;
        }, 1000);
      }).catch(err => {
        console.error('Erreur lors de la copie:', err);
      });
    }

    // Formater un montant en format "1 000,00 $"
    function formaterMontant(valeur) {
      // Nettoyer la valeur (garder que chiffres, virgule et point)
      let nombre = valeur.replace(/[^\d,.-]/g, '').replace(',', '.');
      let num = parseFloat(nombre);
      if (isNaN(num)) return valeur;

      // Formater avec espace comme séparateur de milliers et virgule pour décimales
      let formatted = num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
      return formatted + ' $';
    }

    // Déformater un montant pour l'édition (retirer espaces et $)
    function deformaterMontant(valeur) {
      return valeur.replace(/\s/g, '').replace('$', '').replace(',', '.').trim();
    }

    // Initialiser les événements sur les inputs montant
    function initMontantInputs() {
      document.querySelectorAll('.montant-editable').forEach(input => {
        // Au focus: afficher version éditable (sans espaces ni $)
        input.addEventListener('focus', function() {
          let val = deformaterMontant(this.value);
          // Remettre la virgule pour l'affichage
          this.value = val.replace('.', ',');
        });

        // Au blur: formater avec espaces et $
        input.addEventListener('blur', function() {
          if (this.value.trim()) {
            this.value = formaterMontant(this.value);
          }
        });

        // Formater la valeur initiale si pas déjà formatée
        if (input.value && !input.value.includes('$')) {
          input.value = formaterMontant(input.value);
        }
      });
    }

    // Ouvrir la soumission PDF
    async function ouvrirSoumission(username, numeroSoumission) {
      try {
        const response = await fetch(`/soumissions_signees_facturation_qe/${username}`);
        if (response.ok) {
          const clients = await response.json();
          const client = clients.find(c => c.num === numeroSoumission);
          if (client && client.pdfUrl) {
            const modal = document.getElementById('soumissionModal');
            const content = document.getElementById('soumissionContent');
            content.innerHTML = `
              <div style="width: 100%; height: 100%; background: #1a1a1a; border-radius: 8px; overflow: auto;">
                <iframe src="${client.pdfUrl}"
                        type="application/pdf"
                        style="width: 100%; height: 100%; border: none; display: block;">
                  <p style="padding: 20px; color: var(--text-light);">
                    Impossible d'afficher le PDF.
                    <a href="${client.pdfUrl}" target="_blank" style="color: #3b82f6; text-decoration: underline;">
                      Cliquez ici pour l'ouvrir dans un nouvel onglet
                    </a>
                  </p>
                </iframe>
              </div>
            `;
            modal.classList.add('active');
          } else {
            alert('Aucune soumission PDF disponible pour ce client');
          }
        }
      } catch (error) {
        console.error('[Direction] Erreur récupération soumission:', error);
        alert('Erreur lors de la récupération de la soumission');
      }
    }

    // Fermer le modal soumission
    function fermerSoumissionModal() {
      document.getElementById('soumissionModal').classList.remove('active');
    }

    // Ouvrir les photos du chèque dans un popup (version Direction)
    async function ouvrirPhotosChequeDirection(username, numeroSoumission, typePaiement) {
      try {
        // Récupérer les détails complets depuis l'API
        const responseStatuts = await fetch(`/api/facturationqe/client/${username}/${numeroSoumission}/statuts`);
        if (!responseStatuts.ok) {
          throw new Error('Erreur lors de la récupération des statuts');
        }

        const detailsComplets = await responseStatuts.json();
        console.log('[MODAL CHEQUE DIRECTION] Details complets:', detailsComplets);
        let paiementData = null;

        // Récupérer les bonnes données selon le type de paiement
        if (typePaiement === 'depot') {
          paiementData = detailsComplets.depot;
        } else if (typePaiement === 'paiement_final') {
          paiementData = detailsComplets.paiementFinal;
        } else if (typePaiement.startsWith('autre_paiement_')) {
          const index = parseInt(typePaiement.replace('autre_paiement_', '')) - 1;
          paiementData = detailsComplets.autresPaiements?.[index];
        }

        if (!paiementData) {
          alert('Aucune donnée de paiement disponible');
          return;
        }

        // Essayer différents noms de champs pour les photos
        const photoRecto = paiementData.photoRecto || paiementData.photo_recto || paiementData.recto;
        const photoVerso = paiementData.photoVerso || paiementData.photo_verso || paiementData.verso;

        if (!photoRecto && !photoVerso) {
          alert('Aucune photo de chèque disponible pour ce paiement');
          return;
        }

        // Utiliser le modal soumission pour afficher les photos
        const modal = document.getElementById('soumissionModal');
        const content = document.getElementById('soumissionContent');

        if (modal && content) {
          // Afficher les photos dans le modal avec fond bleu foncé
          content.innerHTML = `
            <div style="width: 100%; background: #0f1629; border-radius: 8px; padding: 20px;">
              <h2 style="color: var(--text-light); margin-bottom: 20px; text-align: center; font-size: 1.5rem;">
                <i class="fas fa-money-check-alt mr-2" style="color: #10b981;"></i>Photos du chèque
              </h2>
              <div style="display: grid; grid-template-columns: ${photoRecto && photoVerso ? '1fr 1fr' : '1fr'}; gap: 20px; max-height: 70vh; overflow: auto;">
                ${photoRecto ? `
                <div>
                  <h3 style="color: var(--text-light); margin-bottom: 10px; text-align: center;">
                    <i class="fas fa-image mr-2" style="color: #10b981;"></i>Recto
                  </h3>
                  <img src="${photoRecto}" alt="Recto du chèque"
                       style="width: 100%; border-radius: 8px; cursor: pointer; border: 2px solid rgba(16, 185, 129, 0.3);"
                       onclick="window.open('${photoRecto}', '_blank')">
                </div>` : ''}
                ${photoVerso ? `
                <div>
                  <h3 style="color: var(--text-light); margin-bottom: 10px; text-align: center;">
                    <i class="fas fa-image mr-2" style="color: #10b981;"></i>Verso
                  </h3>
                  <img src="${photoVerso}" alt="Verso du chèque"
                       style="width: 100%; border-radius: 8px; cursor: pointer; border: 2px solid rgba(16, 185, 129, 0.3);"
                       onclick="window.open('${photoVerso}', '_blank')">
                </div>` : ''}
              </div>
              <p style="text-align: center; color: var(--text-gray); margin-top: 15px; font-size: 0.9rem;">
                Cliquez sur une image pour l'ouvrir en grand
              </p>
            </div>
          `;
          modal.classList.add('active');
        }
      } catch (error) {
        console.error('[Direction] Erreur récupération photos chèque:', error);
        alert('Erreur lors de la récupération des photos du chèque');
      }
    }

    // Fermer le modal
    function fermerModal() {
      document.getElementById('modalDetailsTraitement').style.display = 'none';
      // Restaurer le scroll
      document.body.style.overflow = '';
      document.documentElement.style.overflow = '';
      // Restaurer aussi le scroll du parent si dans un iframe
      if (window.parent && window.parent !== window) {
        try {
          window.parent.document.body.style.overflow = '';
          window.parent.document.documentElement.style.overflow = '';
        } catch(e) {}
      }
      currentPayment = null;
    }

    // Valider un paiement
    async function validerPaiement() {
      if (!currentPayment) return;

      // Récupérer le montant modifié si applicable
      let montantModifie = null;
      const typePaiement = currentPayment.type;

      if (typePaiement === 'depot') {
        const input = document.getElementById('montant-depot');
        if (input) montantModifie = input.value;
      } else if (typePaiement === 'paiement_final') {
        const input = document.getElementById('montant-paiement-final');
        if (input) montantModifie = input.value;
      } else if (typePaiement === 'autres_paiements') {
        const input = document.querySelector('.montant-editable[data-type="autres_paiements"]');
        if (input) montantModifie = input.value;
      }

      // Nettoyer et reformater le montant pour le backend (format: "1000,00 $")
      if (montantModifie) {
        // Enlever les espaces mais garder le format avec virgule et $
        montantModifie = montantModifie.replace(/\s/g, '');
        // S'assurer que le format est correct
        if (!montantModifie.includes('$')) {
          montantModifie = montantModifie.replace('.', ',') + ' $';
        }
      }

      // Ajouter le montant modifié au paiement si différent
      // Normaliser les deux montants pour la comparaison (enlever espaces)
      const montantOriginalNormalise = (currentPayment.montant || '').replace(/\s/g, '');
      const montantModifieNormalise = (montantModifie || '').replace(/\s/g, '');

      if (montantModifie && montantModifieNormalise !== montantOriginalNormalise) {
        currentPayment.montantModifie = montantModifie;
        console.log('[DIRECTION] Montant modifié:', montantModifie, '(original:', currentPayment.montant, ')');
      }

      await traiterPaiement(currentPayment, 'valider');
      fermerModal();
    }

    // Refuser un paiement - ouvrir le popup de raison
    function refuserPaiement() {
      if (!currentPayment) return;
      // Ouvrir le modal de refus avec raison
      document.getElementById('modalRefus').style.display = 'flex';
      document.getElementById('raisonRefus').value = '';
      document.getElementById('raisonRefus').focus();
    }

    // Fermer le modal de refus
    function fermerModalRefus() {
      document.getElementById('modalRefus').style.display = 'none';
      document.getElementById('raisonRefus').value = '';
    }

    // Confirmer le refus avec la raison
    async function confirmerRefus() {
      const raison = document.getElementById('raisonRefus').value.trim();

      if (!raison) {
        alert('Veuillez indiquer une raison pour le refus.');
        document.getElementById('raisonRefus').focus();
        return;
      }

      // IMPORTANT: Sauvegarder currentPayment AVANT de fermer les modals
      const paiementARefuser = currentPayment;

      // Fermer le modal de refus
      fermerModalRefus();
      // Fermer le modal de détails
      fermerModal();

      // Traiter le refus avec la raison (utiliser la copie sauvegardée)
      await traiterPaiement(paiementARefuser, 'refuser', raison);
    }

    // Valider directement depuis le tableau
    async function validerDirectement(paiement) {
      await traiterPaiement(paiement, 'valider');
    }

    // Refuser directement depuis le tableau
    async function refuserDirectement(paiement) {
      await traiterPaiement(paiement, 'refuser');
    }

    // Afficher l'overlay de chargement
    function showLoadingOverlay(message = 'Traitement en cours...') {
      const overlay = document.getElementById('loadingOverlayDirection');
      const textEl = overlay.querySelector('.loading-text');
      if (textEl) textEl.textContent = message;
      overlay.classList.add('active');
    }

    // Cacher l'overlay de chargement
    function hideLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlayDirection');
      overlay.classList.remove('active');
    }

    // Afficher le toast de succès
    function showSuccessToast(title, message) {
      const toast = document.getElementById('toastSuccessDirection');
      const titleEl = document.getElementById('toastTitle');
      const messageEl = document.getElementById('toastMessage');

      if (titleEl) titleEl.textContent = title;
      if (messageEl) messageEl.textContent = message;

      toast.classList.add('active');

      setTimeout(() => {
        toast.classList.remove('active');
      }, 3500);
    }

    // Traiter un paiement (valider ou refuser)
    async function traiterPaiement(paiement, action, raison = null) {
      // Afficher l'overlay de chargement
      const loadingText = action === 'valider' ? 'Validation en cours...' : 'Refus en cours...';
      showLoadingOverlay(loadingText);

      try {
        const endpoint = action === 'valider'
          ? `/api/comptable/facturation/${paiement.entrepreneurUsername}/${paiement.numeroSoumission}/valider`
          : `/api/comptable/facturation/${paiement.entrepreneurUsername}/${paiement.numeroSoumission}/refuser`;

        // Pour les autres_paiements, inclure l'index
        const requestBody = { type: paiement.type };
        if (paiement.type === 'autres_paiements' && paiement.index !== undefined) {
          requestBody.index = paiement.index;
        }

        // Ajouter le montant modifié si présent
        if (paiement.montantModifie) {
          requestBody.montantModifie = paiement.montantModifie;
          console.log('[DIRECTION] Envoi montant modifié au backend:', paiement.montantModifie);
        }

        // Ajouter la raison et le nom si c'est un refus
        if (action === 'refuser' && raison) {
          requestBody.raison = raison;
          // Récupérer le nom de celui qui refuse via l'API
          const loggedInUsername = localStorage.getItem('username') || '';
          try {
            const userInfoResponse = await fetch(`/api/user/info/${loggedInUsername}`);
            if (userInfoResponse.ok) {
              const userInfo = await userInfoResponse.json();
              requestBody.nomRefuseur = `${userInfo.prenom || ''} ${userInfo.nom || ''}`.trim() || loggedInUsername || 'Direction';
            } else {
              requestBody.nomRefuseur = loggedInUsername || 'Direction';
            }
          } catch (e) {
            requestBody.nomRefuseur = loggedInUsername || 'Direction';
          }
        }

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          throw new Error('Erreur lors du traitement');
        }

        // Rafraîchir la liste
        await chargerPaiementsEnTraitement();
        await chargerDerniersTraites();

        // Recharger le tableau de rapprochement QBO
        await chargerTableauPeriodes();

        // Notifier le parent
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'updateFacturationBadge' }, '*');
        }

        // Cacher l'overlay et afficher le toast de succès
        hideLoadingOverlay();
        const toastTitle = action === 'valider' ? 'Validé' : 'Refusé';
        const toastMessage = action === 'valider'
          ? 'Le paiement a été validé avec succès.'
          : 'Le paiement a été refusé.';
        showSuccessToast(toastTitle, toastMessage);

      } catch (error) {
        console.error('[Direction Facturation] Erreur traitement:', error);
        hideLoadingOverlay();
        alert('Erreur lors du traitement du paiement');
      }
    }

    // Vérifier si un paiement est déjà dans une période
    function isPaiementInPeriode(paiement) {
      if (!window.periodePaiements) return false;

      for (const periodeId in window.periodePaiements) {
        const paiements = window.periodePaiements[periodeId] || [];
        const found = paiements.find(p =>
          p.date === paiement.date &&
          p.numeroSoumission === paiement.numeroSoumission &&
          p.type === paiement.type &&
          p.montant === paiement.montant
        );
        if (found) return true;
      }
      return false;
    }

    // Charger les 5 derniers traités
    async function chargerDerniersTraites() {
      try {
        const response = await fetch('/api/comptable/facturation/historique?limit=5');

        if (!response.ok) {
          throw new Error('Erreur lors du chargement');
        }

        const data = await response.json();
        let historique = data.historique || [];

        // Filtrer les paiements déjà dans les périodes
        historique = historique.filter(p => !isPaiementInPeriode(p));

        const container = document.getElementById('derniers-traites');

        // Vérifier si le container existe (il n'existe que dans la vue Général)
        if (!container) {
          // Pas d'erreur, c'est normal si on est dans une autre vue
          return;
        }

        if (historique.length === 0) {
          container.innerHTML = `
            <div style="color: var(--text-gray); font-size: 0.8rem; text-align: center; padding: 1rem;">
              Aucun historique
            </div>
          `;
          return;
        }

        container.innerHTML = historique.map(h => {
          const statusColor = h.statut === 'valide' ? '#22c55e' : '#ef4444';
          const statusIcon = h.statut === 'valide' ? 'check-circle' : 'times-circle';
          const montantDisplay = h.type === 'remboursement' ? `-${h.montant}` : h.montant;

          return `
            <div style="padding: 0.5rem 0.75rem; border-bottom: 1px solid rgba(71, 85, 105, 0.2); display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-${statusIcon}" style="color: ${statusColor}; font-size: 0.75rem;"></i>
              <div style="flex: 1; min-width: 0;">
                <div style="font-size: 0.75rem; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${h.entrepreneur} - ${h.numeroSoumission}</div>
                <div style="font-size: 0.65rem; color: var(--text-gray);">${h.date || ''}</div>
              </div>
              <div style="font-size: 0.7rem; font-weight: 600; color: ${statusColor};">${montantDisplay}</div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('[Direction Facturation] Erreur historique:', error);
      }
    }

    // Charger le tableau par périodes (2 semaines)
    async function chargerTableauPeriodes() {
      try {
        // Éléments de chargement pour Rapprochement QBO
        const rapprochementLoading = document.getElementById('rapprochement-loading');
        const rapprochementEmpty = document.getElementById('rapprochement-empty');
        const rapprochementContent = document.getElementById('rapprochement-content');

        // Éléments de chargement pour Tableau périodes
        const tableauLoading = document.getElementById('tableau-loading');
        const tableauEmpty = document.getElementById('tableau-empty');
        const periodesContainer = document.getElementById('periodes-container');

        // Afficher les états de chargement
        rapprochementLoading.style.display = 'flex';
        rapprochementEmpty.style.display = 'none';
        rapprochementContent.style.display = 'none';

        tableauLoading.style.display = 'flex';
        tableauEmpty.style.display = 'none';

        const response = await fetch('/api/comptable/facturation/historique?limit=500');

        if (!response.ok) {
          throw new Error('Erreur lors du chargement');
        }

        const data = await response.json();
        let historique = data.historique || [];

        // Masquer les chargements
        rapprochementLoading.style.display = 'none';
        tableauLoading.style.display = 'none';

        // Générer les périodes de 2 semaines depuis le 12 janvier 2025 jusqu'à 1 an après
        const periodes = genererPeriodes();

        // Remplir le conteneur des périodes (toujours vides)
        periodesContainer.innerHTML = periodes.map(periode => {
          return `
            <div style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 10px; margin-bottom: 1rem; overflow: hidden;">
              <div class="periode-header" onclick="togglePeriode('${periode.id}')" style="padding: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s ease;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <i class="fas fa-chevron-right periode-icon" id="icon-${periode.id}" style="color: #60a5fa; transition: transform 0.3s ease;"></i>
                  <div>
                    <div style="font-weight: 600; font-size: 1rem; color: var(--text-light);">${periode.label}</div>
                    <div style="font-size: 0.8rem; color: var(--text-gray); margin-top: 0.25rem;">${periode.dates}</div>
                  </div>
                </div>
                <div id="count-${periode.id}" style="background: rgba(148, 163, 184, 0.1); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 20px; padding: 0.25rem 0.75rem; font-size: 0.85rem; font-weight: 600; color: var(--text-gray);">
                  0 paiement
                </div>
              </div>
              <div class="periode-content" id="content-${periode.id}" style="display: none; border-top: 1px solid var(--border-dark);">
                <div class="empty-state">
                  <i class="fas fa-inbox"></i>
                  <p>Aucun paiement pour cette période</p>
                </div>
              </div>
            </div>
          `;
        }).join('');

        // Stocker les données des périodes
        window.periodesData = periodes;

        // Peupler le select de filtrage des périodes
        populatePeriodeSelect();

        // Réinitialiser les custom selects pour inclure les nouvelles options de périodes
        initCustomSelectFiltres();

        // Charger les périodes sauvegardées APRÈS que les éléments DOM soient créés
        console.log('[Direction Facturation] Chargement des périodes depuis le backend...');
        await loadPeriodesFromBackend();

        // Maintenant filtrer l'historique pour retirer les paiements qui sont dans les périodes
        historique = historique.filter(p => !isPaiementInPeriode(p));

        // Mettre à jour le tableau de rapprochement avec les paiements filtrés
        const rapprochementTbody = document.getElementById('rapprochement-tbody');
        if (historique.length === 0) {
          rapprochementEmpty.style.display = 'flex';
          rapprochementContent.style.display = 'none';
        } else {
          rapprochementContent.style.display = 'block';
          rapprochementEmpty.style.display = 'none';

          rapprochementTbody.innerHTML = historique.map((h, index) => {
            const typeClass = h.type === 'depot' ? 'depot' : (h.type === 'paiement_final' ? 'paiement-final' : (h.type === 'remboursement' ? 'remboursement' : 'autres'));
            const typeLabel = h.type === 'depot' ? 'Dépôt' : (h.type === 'paiement_final' ? 'Paiement final' : (h.type === 'remboursement' ? 'Remboursement' : 'Autre'));

            const avatarHtml = h.entrepreneurPhoto
              ? `<img src="${h.entrepreneurPhoto}" style="width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(59, 130, 246, 0.3);">`
              : `<div style="width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.7rem;">${h.entrepreneur ? h.entrepreneur.charAt(0).toUpperCase() : '?'}</div>`;

            return `
              <tr data-payment-index="${index}">
                <td style="padding: 0.75rem; color: var(--text-gray); font-size: 0.85rem;">${h.date || 'N/A'}</td>
                <td style="padding: 0.75rem;">
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    ${avatarHtml}
                    <span style="font-weight: 500; color: var(--text-light); font-size: 0.85rem;">${h.entrepreneur || 'N/A'}</span>
                  </div>
                </td>
                <td style="padding: 0.75rem; font-size: 0.85rem; color: var(--text-light);">${h.client || 'N/A'}</td>
                <td style="padding: 0.75rem; font-weight: 600; color: #60a5fa; font-size: 0.85rem;">${h.numeroSoumission || 'N/A'}</td>
                <td style="padding: 0.75rem;">
                  <span class="type-badge ${typeClass}" style="font-size: 0.75rem;">
                    ${typeLabel}
                  </span>
                </td>
                <td style="padding: 0.75rem; font-weight: 600; font-size: 0.85rem; color: var(--text-light);">${h.type === 'remboursement' ? '-' + (h.montant || '0,00 $') : (h.montant || '0,00 $')}</td>
                <td style="padding: 0.75rem 1.5rem; text-align: center;">
                  <input type="checkbox" class="payment-checkbox custom-checkbox" data-payment-index="${index}" onchange="updateActionBar()">
                </td>
              </tr>
            `;
          }).join('');
        }

        // Stocker les données de l'historique filtré
        window.historiqueData = historique;

      } catch (error) {
        console.error('[Direction Facturation] Erreur tableau périodes:', error);
        document.getElementById('tableau-loading').style.display = 'none';
        document.getElementById('tableau-empty').style.display = 'flex';
      }
    }

    // Rafraîchir uniquement le tableau Rapprochement QBO avec filtrage
    async function refreshRapprochementTable() {
      try {
        const response = await fetch('/api/comptable/facturation/historique?limit=500');
        if (!response.ok) {
          throw new Error('Erreur lors du chargement');
        }

        const data = await response.json();
        let historique = data.historique || [];

        // Filtrer les paiements déjà dans les périodes
        historique = historique.filter(p => !isPaiementInPeriode(p));

        const rapprochementTbody = document.getElementById('rapprochement-tbody');
        const rapprochementEmpty = document.getElementById('rapprochement-empty');
        const rapprochementContent = document.getElementById('rapprochement-content');

        if (historique.length === 0) {
          rapprochementEmpty.style.display = 'flex';
          rapprochementContent.style.display = 'none';
          return;
        }

        rapprochementContent.style.display = 'block';
        rapprochementEmpty.style.display = 'none';

        rapprochementTbody.innerHTML = historique.map((h, index) => {
          const typeClass = h.type === 'depot' ? 'depot' : (h.type === 'paiement_final' ? 'paiement-final' : (h.type === 'remboursement' ? 'remboursement' : 'autres'));
          const typeLabel = h.type === 'depot' ? 'Dépôt' : (h.type === 'paiement_final' ? 'Paiement final' : (h.type === 'remboursement' ? 'Remboursement' : 'Autre'));

          const avatarHtml = h.entrepreneurPhoto
            ? `<img src="${h.entrepreneurPhoto}" style="width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(59, 130, 246, 0.3);">`
            : `<div style="width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.7rem;">${h.entrepreneur ? h.entrepreneur.charAt(0).toUpperCase() : '?'}</div>`;

          return `
            <tr data-payment-index="${index}">
              <td style="padding: 0.75rem; color: var(--text-gray); font-size: 0.85rem;">${h.date || 'N/A'}</td>
              <td style="padding: 0.75rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  ${avatarHtml}
                  <span style="font-weight: 500; color: var(--text-light); font-size: 0.85rem;">${h.entrepreneur || 'N/A'}</span>
                </div>
              </td>
              <td style="padding: 0.75rem; font-size: 0.85rem; color: var(--text-light);">${h.client || 'N/A'}</td>
              <td style="padding: 0.75rem; font-weight: 600; color: #60a5fa; font-size: 0.85rem;">${h.numeroSoumission || 'N/A'}</td>
              <td style="padding: 0.75rem;">
                <span class="type-badge ${typeClass}" style="font-size: 0.75rem;">
                  ${typeLabel}
                </span>
              </td>
              <td style="padding: 0.75rem; font-weight: 600; font-size: 0.85rem; color: var(--text-light);">${h.type === 'remboursement' ? '-' + (h.montant || '0,00 $') : (h.montant || '0,00 $')}</td>
              <td style="padding: 0.75rem 1.5rem; text-align: center;">
                <input type="checkbox" class="payment-checkbox custom-checkbox" data-payment-index="${index}" onchange="updateActionBar()">
              </td>
            </tr>
          `;
        }).join('');

        // Mettre à jour window.historiqueData
        window.historiqueData = historique;

      } catch (error) {
        console.error('[Direction Facturation] Erreur refresh rapprochement:', error);
      }
    }

    // Générer les périodes de 2 semaines (du 12 janv 2026 au 15 janv 2027)
    function genererPeriodes() {
      const periodes = [];

      // Période 0 - Toute l'année 2025 (pas de semaines spécifiques)
      periodes.push({
        id: 'periode-0',
        label: 'Période 0',
        dates: '2025',
        debut: new Date(2025, 0, 1),  // 1er janvier 2025
        fin: new Date(2025, 11, 31)   // 31 décembre 2025
      });

      const dateDebut = new Date(2026, 0, 12); // 12 janvier 2026
      const dateFin = new Date(2027, 0, 15); // 15 janvier 2027

      let current = new Date(dateDebut);
      let periodeNum = 1;

      while (current < dateFin) {
        const debut = new Date(current);
        const fin = new Date(current);
        fin.setDate(fin.getDate() + 13); // 2 semaines (14 jours - 1)

        if (fin > dateFin) {
          fin.setTime(dateFin.getTime());
        }

        const mois = ['Janv', 'Févr', 'Mars', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sept', 'Oct', 'Nov', 'Déc'];
        const debutStr = `${debut.getDate()} ${mois[debut.getMonth()]}`;
        const finStr = `${fin.getDate()} ${mois[fin.getMonth()]} ${fin.getFullYear()}`;

        periodes.push({
          id: `periode-${periodeNum}`,
          label: `Période ${periodeNum}`,
          dates: `${debutStr} - ${finStr}`,
          debut: debut,
          fin: fin
        });

        current.setDate(current.getDate() + 14);
        periodeNum++;
      }

      return periodes;
    }

    // Toggle l'affichage d'une période
    // ============================================
    // GESTION DES CHECKBOXES ET ACTIONS
    // ============================================

    // Toggle toutes les checkboxes
    function toggleSelectAll(checkbox) {
      const checkboxes = document.querySelectorAll('.payment-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
      });
      updateActionBar();
    }

    // Mettre à jour la barre d'actions selon les sélections
    function updateActionBar() {
      const checkboxes = document.querySelectorAll('.payment-checkbox');
      const checked = Array.from(checkboxes).filter(cb => cb.checked);
      const count = checked.length;

      const actionBar = document.getElementById('action-bar');
      const selectedCount = document.getElementById('selected-count');
      const selectAll = document.getElementById('select-all-rapprochement');

      // Mettre à jour le texte du compteur
      selectedCount.textContent = count === 0 ? '0 sélectionné' : count === 1 ? '1 sélectionné' : `${count} sélectionnés`;

      // Afficher/cacher la barre d'actions
      actionBar.style.display = count > 0 ? 'flex' : 'none';

      // Mettre à jour l'état de la checkbox "Tout sélectionner"
      if (count === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (count === checkboxes.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      }
    }

    // Obtenir les paiements sélectionnés
    function getSelectedPayments() {
      const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
      return Array.from(checkboxes).map(cb => {
        const index = parseInt(cb.dataset.paymentIndex);
        return window.historiqueData[index];
      });
    }

    // Exporter les paiements sélectionnés en XLSX avec couleurs (3 colonnes: Entrepreneur, Client, Montant)
    function exporterSelection() {
      const selected = getSelectedPayments();
      if (selected.length === 0) {
        alert('Aucun paiement sélectionné');
        return;
      }

      // Préparer les données pour le fichier XLSX
      const data = [
        ['Entrepreneur', 'Client', 'Montant']  // En-têtes
      ];

      // Ajouter les lignes de données
      selected.forEach(p => {
        // Convertir le montant en nombre
        let montantNumeric = 0;
        if (p.montant) {
          // Extraire le nombre du format "431,16 $"
          const montantStr = p.montant.replace(/\s/g, '').replace('$', '').replace(',', '.');
          montantNumeric = parseFloat(montantStr) || 0;

          // Si c'est un remboursement, rendre négatif
          if (p.type === 'remboursement') {
            montantNumeric = -montantNumeric;
          }
        }

        data.push([
          p.entrepreneur || '',
          p.client || '',
          montantNumeric
        ]);
      });

      // Créer le workbook et la feuille
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);

      // Définir la largeur des colonnes (en caractères)
      ws['!cols'] = [
        { wch: 30 },  // Colonne A (Entrepreneur) - 30 caractères
        { wch: 30 },  // Colonne B (Client) - 30 caractères
        { wch: 20 }   // Colonne C (Montant) - 20 caractères
      ];

      // Style pour les en-têtes (fond vert #4CAF50, texte blanc, gras)
      const headerStyle = {
        fill: { fgColor: { rgb: "4CAF50" } },
        font: { bold: true, color: { rgb: "FFFFFF" } },
        alignment: { horizontal: "center", vertical: "center" }
      };

      // Appliquer le style aux cellules d'en-tête A1, B1, C1
      ['A1', 'B1', 'C1'].forEach(cell => {
        if (ws[cell]) {
          ws[cell].s = headerStyle;
        }
      });

      // Appliquer le format devise à la colonne Montant (colonne C)
      // Format: #,##0.00 $ (nombre avec 2 décimales et symbole $)
      for (let row = 2; row <= data.length; row++) {
        const cellRef = `C${row}`;
        if (ws[cellRef]) {
          ws[cellRef].t = 'n';  // Type numérique
          ws[cellRef].z = '#,##0.00 $';  // Format devise
        }
      }

      // Ajouter la feuille au workbook
      XLSX.utils.book_append_sheet(wb, ws, 'Paiements');

      // Générer et télécharger le fichier XLSX
      XLSX.writeFile(wb, `paiements_export_${new Date().toISOString().split('T')[0]}.xlsx`);

      showSuccessToast('Export réussi', `${selected.length} paiement(s) exporté(s) en Excel`);
    }

    // Déplacer les paiements sélectionnés vers une période
    function deplacerSelection() {
      const selected = getSelectedPayments();
      if (selected.length === 0) {
        alert('Aucun paiement sélectionné');
        return;
      }

      // Créer un modal pour sélectionner la période
      const periodesData = window.periodesData || [];
      if (periodesData.length === 0) {
        alert('Aucune période disponible');
        return;
      }

      // Variable pour stocker la période sélectionnée
      window.selectedPeriodeId = null;

      // Désactiver le scroll du body
      document.body.style.overflow = 'hidden';

      const modalHtml = `
        <div id="deplacer-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow: hidden;">
          <div class="box" style="max-width: 1200px; width: 90%; margin: 0; max-height: none; overflow: visible;" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="box-header" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.25rem;">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="box-header-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">
                  <i class="fas fa-arrow-right" style="font-size: 0.9rem;"></i>
                </div>
                <div>
                  <h3 class="box-header-title" style="font-size: 1rem; margin: 0;">Déplacer vers une période</h3>
                  <p class="box-header-subtitle" style="font-size: 0.8rem; margin: 0;">${selected.length} paiement(s) sélectionné(s)</p>
                </div>
              </div>
              <button onclick="fermerModalDeplacer()" style="background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 1.2rem; padding: 0.25rem; transition: color 0.2s;" onmouseover="this.style.color='var(--text-light)'" onmouseout="this.style.color='var(--text-gray)'">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <!-- Body -->
            <div class="box-body" style="padding: 1rem;">
              <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.65rem;">
                ${periodesData.map(p => `
                  <div class="periode-option" data-periode-id="${p.id}" onclick="selectPeriodeOption('${p.id}')" style="background: var(--bg-sidebar); border: 2px solid var(--border-dark); border-radius: 8px; padding: 0.65rem; cursor: pointer; transition: all 0.2s;">
                    <div style="font-weight: 600; color: var(--text-light); margin-bottom: 0.15rem; font-size: 0.85rem;">${p.label}</div>
                    <div style="font-size: 0.75rem; color: var(--text-gray);">${p.dates}</div>
                  </div>
                `).join('')}
              </div>
            </div>

            <!-- Footer -->
            <div class="box-footer" style="display: flex; gap: 0.65rem; justify-content: flex-end; padding: 1rem 1.25rem;">
              <button onclick="fermerModalDeplacer()" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                <i class="fas fa-times"></i>
                Annuler
              </button>
              <button onclick="confirmerDeplacement()" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                <i class="fas fa-check"></i>
                Confirmer
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    // Retourner les paiements sélectionnés à Général (retirer du Rapprochement QBO)
    async function retournerGeneral() {
      const selected = getSelectedPayments();
      if (selected.length === 0) {
        alert('Aucun paiement sélectionné');
        return;
      }

      // Confirmation
      if (!confirm(`Retourner ${selected.length} paiement(s) à Général ?\n\nLes paiements seront retirés du Rapprochement QBO et reviendront dans la liste Général pour validation.`)) {
        return;
      }

      try {
        // Préparer les données pour l'API
        const paiementsData = selected.map(p => ({
          entrepreneurUsername: p.entrepreneurUsername,
          numeroSoumission: p.numeroSoumission,
          type: p.type,
          index: p.index !== undefined ? p.index : null
        }));

        const response = await fetch('/api/comptable/facturation/retourner-general', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paiements: paiementsData })
        });

        if (!response.ok) {
          throw new Error('Erreur lors du retour à Général');
        }

        const result = await response.json();

        // Rafraîchir les tableaux
        await chargerPaiementsEnTraitement();
        await refreshRapprochementTable();

        // Décocher toutes les checkboxes
        document.querySelectorAll('.payment-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('select-all-rapprochement').checked = false;
        updateActionBar();

        showSuccessToast('Retour effectué', `${result.removed} paiement(s) retourné(s) à Général`);

      } catch (error) {
        console.error('[Direction Facturation] Erreur retour général:', error);
        alert('Erreur lors du retour à Général');
      }
    }

    // Sélectionner une période dans le modal
    function selectPeriodeOption(periodeId) {
      // Retirer la sélection de toutes les options
      document.querySelectorAll('.periode-option').forEach(opt => {
        opt.style.borderColor = 'var(--border-dark)';
        opt.style.background = 'var(--bg-sidebar)';
      });

      // Sélectionner l'option cliquée
      const selectedOption = document.querySelector(`[data-periode-id="${periodeId}"]`);
      if (selectedOption) {
        selectedOption.style.borderColor = '#3b82f6';
        selectedOption.style.background = 'rgba(59, 130, 246, 0.1)';
        window.selectedPeriodeId = periodeId;
      }
    }

    // Fermer le modal de déplacement
    function fermerModalDeplacer() {
      document.body.style.overflow = '';
      const modal = document.getElementById('deplacer-modal');
      if (modal) {
        modal.remove();
      }
    }

    // Confirmer le déplacement
    async function confirmerDeplacement() {
      // Éviter les clics multiples
      if (window.isConfirming) {
        return;
      }

      if (!window.selectedPeriodeId) {
        alert('Veuillez sélectionner une période');
        return;
      }

      // Marquer comme en cours de traitement
      window.isConfirming = true;

      // Désactiver le bouton
      const confirmBtn = document.querySelector('#modal-deplacer button[onclick="confirmerDeplacement()"]');
      if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.style.opacity = '0.5';
        confirmBtn.style.cursor = 'not-allowed';
      }

      // Fermer immédiatement le modal pour éviter les clics multiples
      fermerModalDeplacer();

      // Effectuer le déplacement
      await moveToPeriode(window.selectedPeriodeId);

      // Réinitialiser le flag
      window.isConfirming = false;

      // Réactiver le bouton
      if (confirmBtn) {
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
        confirmBtn.style.cursor = 'pointer';
      }
    }

    // Déplacer les paiements sélectionnés vers une période spécifique
    async function savePeriodesToBackend() {
      try {
        const response = await fetch('/api/comptable/facturation/periodes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ periodes: window.periodePaiements || {} })
        });

        if (!response.ok) {
          throw new Error('Erreur lors de la sauvegarde');
        }

        console.log('[Périodes] Sauvegarde réussie');
      } catch (error) {
        console.error('[Périodes] Erreur sauvegarde:', error);
      }
    }

    async function loadPeriodesFromBackend() {
      try {
        const response = await fetch('/api/comptable/facturation/periodes');

        if (!response.ok) {
          throw new Error('Erreur lors du chargement');
        }

        const data = await response.json();
        console.log('[Périodes] Données reçues du backend:', data);
        if (data.success && data.periodes) {
          window.periodePaiements = data.periodes;
          console.log('[Périodes] window.periodePaiements défini:', window.periodePaiements);

          // Les éléments DOM sont maintenant disponibles, mettre à jour l'affichage
          Object.keys(data.periodes).forEach(periodeId => {
            const countDiv = document.getElementById(`count-${periodeId}`);
            const contentDiv = document.getElementById(`content-${periodeId}`);

            if (countDiv && contentDiv) {
              updatePeriodeDisplay(periodeId);
            } else {
              console.warn(`[Périodes] Éléments DOM non trouvés pour période ${periodeId}`);
            }
          });

          console.log('[Périodes] Chargement réussi:', Object.keys(data.periodes).length, 'période(s)');
        }
      } catch (error) {
        console.error('[Périodes] Erreur chargement:', error);
      }
    }

    async function moveToPeriode(periodeId) {
      const selected = getSelectedPayments();

      // Initialiser le tableau des paiements de la période si nécessaire
      if (!window.periodePaiements) {
        window.periodePaiements = {};
      }
      if (!window.periodePaiements[periodeId]) {
        window.periodePaiements[periodeId] = [];
      }

      // Ajouter les paiements sélectionnés
      window.periodePaiements[periodeId].push(...selected);

      // Sauvegarder dans le backend
      await savePeriodesToBackend();

      // Mettre à jour l'affichage de la période
      updatePeriodeDisplay(periodeId);

      // Rafraîchir le tableau "Rapprochement QBO" pour retirer les paiements déplacés
      await refreshRapprochementTable();

      // Décocher toutes les checkboxes
      document.querySelectorAll('.payment-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('select-all-rapprochement').checked = false;
      updateActionBar();

      showSuccessToast('Déplacement réussi', `${selected.length} paiement(s) déplacé(s)`);
    }

    // Stocker les paiements par période
    if (!window.periodePaiements) {
      window.periodePaiements = {};
    }

    function updatePeriodeDisplay(periodeId) {
      const contentDiv = document.getElementById(`content-${periodeId}`);
      const countDiv = document.getElementById(`count-${periodeId}`);
      const paiements = window.periodePaiements[periodeId] || [];

      // Mettre à jour le compteur
      const count = paiements.length;
      countDiv.textContent = count === 0 ? '0 paiement' : count === 1 ? '1 paiement' : `${count} paiements`;
      countDiv.style.background = count > 0 ? 'rgba(96, 165, 250, 0.2)' : 'rgba(148, 163, 184, 0.1)';
      countDiv.style.borderColor = count > 0 ? 'rgba(96, 165, 250, 0.4)' : 'rgba(148, 163, 184, 0.2)';
      countDiv.style.color = count > 0 ? '#60a5fa' : 'var(--text-gray)';

      if (count === 0) {
        contentDiv.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <p>Aucun paiement pour cette période</p>
          </div>
        `;
      } else {
        contentDiv.innerHTML = `
          <div style="padding: 0.75rem;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: rgba(59, 130, 246, 0.05); border-bottom: 2px solid var(--border-dark);">
                  <th style="padding: 0.65rem; text-align: left; font-weight: 600; color: var(--text-gray); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Date</th>
                  <th style="padding: 0.65rem; text-align: left; font-weight: 600; color: var(--text-gray); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Entrepreneur</th>
                  <th style="padding: 0.65rem; text-align: left; font-weight: 600; color: var(--text-gray); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Client</th>
                  <th style="padding: 0.65rem; text-align: left; font-weight: 600; color: var(--text-gray); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">N° Soumission</th>
                  <th style="padding: 0.65rem; text-align: left; font-weight: 600; color: var(--text-gray); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Type</th>
                  <th style="padding: 0.65rem; text-align: left; font-weight: 600; color: var(--text-gray); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Montant</th>
                  <th style="padding: 0.65rem; text-align: center; font-weight: 600; color: var(--text-gray); font-size: 0.75rem; width: 60px;"></th>
                </tr>
              </thead>
              <tbody>
                ${paiements.map((p, index) => {
                  const typeClass = p.type === 'depot' ? 'depot' : (p.type === 'paiement_final' ? 'paiement-final' : (p.type === 'remboursement' ? 'remboursement' : 'autres'));
                  const typeLabel = p.type === 'depot' ? 'Dépôt' : (p.type === 'paiement_final' ? 'Paiement final' : (p.type === 'remboursement' ? 'Remboursement' : 'Autre'));

                  const avatarHtml = p.entrepreneurPhoto
                    ? `<img src="${p.entrepreneurPhoto}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(59, 130, 246, 0.3);">`
                    : `<div style="width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.65rem;">${p.entrepreneur ? p.entrepreneur.charAt(0).toUpperCase() : '?'}</div>`;

                  return `
                    <tr style="transition: background 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.03)'" onmouseout="this.style.background=''">
                      <td style="padding: 0.65rem; color: var(--text-light); font-size: 0.8rem;">${p.date || 'N/A'}</td>
                      <td style="padding: 0.65rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                          ${avatarHtml}
                          <span style="font-weight: 500; color: var(--text-light); font-size: 0.8rem;">${p.entrepreneur || 'N/A'}</span>
                        </div>
                      </td>
                      <td style="padding: 0.65rem; font-weight: 600; color: var(--text-light); font-size: 0.85rem;">${p.client || 'N/A'}</td>
                      <td style="padding: 0.65rem; font-weight: 600; color: #60a5fa; font-size: 0.8rem;">${p.numeroSoumission || 'N/A'}</td>
                      <td style="padding: 0.65rem;">
                        <span class="type-badge ${typeClass}" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">${typeLabel}</span>
                      </td>
                      <td style="padding: 0.65rem; font-weight: 600; color: var(--text-light); font-size: 0.85rem;">${p.type === 'remboursement' ? '-' + (p.montant || '0,00 $') : (p.montant || '0,00 $')}</td>
                      <td style="padding: 0.65rem; text-align: center;">
                        <button onclick="removePaymentFromPeriode('${periodeId}', ${index})" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 5px; padding: 0.3rem 0.45rem; color: #ef4444; cursor: pointer; transition: all 0.2s;">
                          <i class="fas fa-times" style="font-size: 0.75rem;"></i>
                        </button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
      }

      // Ouvrir automatiquement la période si elle contient des paiements
      if (count > 0 && contentDiv.style.display === 'none') {
        togglePeriode(periodeId);
      }
    }

    async function removePaymentFromPeriode(periodeId, paymentIndex) {
      if (window.periodePaiements[periodeId]) {
        window.periodePaiements[periodeId].splice(paymentIndex, 1);
        updatePeriodeDisplay(periodeId);

        // Sauvegarder les changements dans le backend
        await savePeriodesToBackend();

        // Rafraîchir le tableau "Rapprochement QBO" pour remettre le paiement retiré
        await refreshRapprochementTable();
      }
    }

    // Variable pour stocker le paiement à supprimer
    let paiementASupprimer = null;

    // Ouvrir le modal de suppression personnalisé
    function ouvrirModalSuppression(paiement) {
      paiementASupprimer = paiement;

      // Remplir les informations du modal
      document.getElementById('suppression-client').textContent = paiement.client || 'N/A';
      document.getElementById('suppression-type').textContent = formatTypeLabel(paiement.type);
      document.getElementById('suppression-montant').textContent = paiement.type === 'remboursement' ? '-' + (paiement.montant || '0,00 $') : (paiement.montant || '0,00 $');
      document.getElementById('suppression-soumission').textContent = paiement.numeroSoumission || 'N/A';

      // Afficher le modal
      document.getElementById('modalSuppression').style.display = 'flex';
    }

    // Fermer le modal de suppression
    function fermerModalSuppression() {
      document.getElementById('modalSuppression').style.display = 'none';
      paiementASupprimer = null;
    }

    // Formater le type de paiement pour l'affichage
    function formatTypeLabel(type) {
      const labels = {
        'depot': 'Dépôt',
        'paiement_final': 'Paiement final',
        'autres_paiements': 'Paiement partiel',
        'remboursement': 'Remboursement'
      };
      return labels[type] || type;
    }

    // Confirmer et exécuter la suppression (simple ou multiple)
    async function confirmerSuppression() {
      // Si c'est une suppression multiple (depuis le tableau Rapprochement QBO)
      if (indicesASupprimer.length > 0) {
        await executerSuppressionMultiple();
        return;
      }

      // Suppression simple
      if (!paiementASupprimer) return;

      try {
        const response = await fetch('/api/comptable/facturation/supprimer-complet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            entrepreneurUsername: paiementASupprimer.entrepreneurUsername,
            numeroSoumission: paiementASupprimer.numeroSoumission,
            type: paiementASupprimer.type,
            index: paiementASupprimer.index
          })
        });

        if (response.ok) {
          fermerModalSuppression();
          showSuccessToast('Suppression réussie', 'Le paiement a été supprimé');
          // Rafraîchir la liste des paiements
          await chargerPaiementsEnTraitement();
          // Rafraîchir aussi le tableau Rapprochement QBO si on est sur cet onglet
          if (window.historiqueData) {
            await refreshRapprochementTable();
          }
        } else {
          const error = await response.json();
          showErrorToast('Erreur', error.detail || 'Impossible de supprimer le paiement');
        }
      } catch (error) {
        console.error('[Direction Facturation] Erreur suppression complète:', error);
        showErrorToast('Erreur', 'Erreur lors de la suppression');
      }
    }

    // Fonction showErrorToast si elle n'existe pas
    function showErrorToast(title, message) {
      // Utiliser la même logique que showSuccessToast mais en rouge
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3);
        z-index: 100001;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        animation: slideInRight 0.3s ease-out;
      `;
      toast.innerHTML = `
        <i class="fas fa-times-circle" style="font-size: 1.25rem;"></i>
        <div>
          <div style="font-weight: 600;">${title}</div>
          <div style="font-size: 0.85rem; opacity: 0.9;">${message}</div>
        </div>
      `;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease-out forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Variable pour stocker les indices à supprimer (pour suppression multiple)
    let indicesASupprimer = [];

    // Ouvrir le modal de suppression multiple
    function ouvrirModalSuppressionMultiple() {
      const selected = getSelectedPayments();
      if (selected.length === 0) {
        showErrorToast('Attention', 'Aucun paiement sélectionné');
        return;
      }

      // Récupérer les indices des paiements sélectionnés
      const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
      indicesASupprimer = Array.from(checkboxes).map(cb => parseInt(cb.dataset.paymentIndex)).sort((a, b) => b - a);

      // Remplir les informations du modal
      document.getElementById('suppression-client').textContent = `${selected.length} paiement(s) sélectionné(s)`;
      document.getElementById('suppression-type').textContent = '-';
      document.getElementById('suppression-montant').textContent = '-';
      document.getElementById('suppression-soumission').textContent = '-';

      // Afficher le modal
      document.getElementById('modalSuppression').style.display = 'flex';
    }

    // Supprimer les paiements sélectionnés (suppression complète: fichiers + historique)
    async function supprimerSelection() {
      ouvrirModalSuppressionMultiple();
    }

    // Exécuter la suppression multiple (appelé depuis confirmerSuppression si indicesASupprimer non vide)
    async function executerSuppressionMultiple() {
      if (indicesASupprimer.length === 0) return;

      try {
        let supprimesCount = 0;

        // Supprimer chaque paiement via l'API de suppression complète
        for (const index of indicesASupprimer) {
          const p = window.historiqueData[index];
          const response = await fetch('/api/comptable/facturation/supprimer-complet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              entrepreneurUsername: p.entrepreneurUsername,
              numeroSoumission: p.numeroSoumission,
              type: p.type,
              index: p.index
            })
          });

          if (response.ok) {
            supprimesCount++;
          }
        }

        if (supprimesCount > 0) {
          // Supprimer les paiements de window.historiqueData
          indicesASupprimer.forEach(index => {
            window.historiqueData.splice(index, 1);
          });

          // Rafraîchir le tableau Rapprochement QBO
          await refreshRapprochementTable();
          // Rafraîchir aussi la vue générale
          await chargerPaiementsEnTraitement();

          showSuccessToast('Suppression réussie', `${supprimesCount} paiement(s) supprimé(s)`);
        } else {
          showErrorToast('Erreur', 'Aucun paiement n\'a pu être supprimé');
        }
      } catch (error) {
        console.error('[Direction Facturation] Erreur suppression:', error);
        showErrorToast('Erreur', 'Erreur lors de la suppression');
      } finally {
        indicesASupprimer = [];
        fermerModalSuppression();
      }
    }

    function togglePeriode(periodeId) {
      const content = document.getElementById(`content-${periodeId}`);
      const icon = document.getElementById(`icon-${periodeId}`);

      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(90deg)';
      } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
      }
    }

    // ============================================
    // SYSTÈME DE FILTRES
    // ============================================

    // Fonction pour parser un montant (retire les espaces, $, et remplace , par .)
    function parseMontant(montantStr) {
      if (!montantStr) return 0;
      return parseFloat(montantStr.replace(/\s/g, '').replace('$', '').replace(',', '.')) || 0;
    }

    // Fonction pour parser une date au format DD/MM/YYYY
    function parseDate(dateStr) {
      if (!dateStr || dateStr === 'N/A') return null;
      const parts = dateStr.split('/');
      if (parts.length !== 3) return null;
      return new Date(parts[2], parts[1] - 1, parts[0]);
    }

    // Filtre un paiement selon les critères
    function matchesFilters(paiement, filters) {
      // Filtre par recherche textuelle
      if (filters.search) {
        const search = filters.search.toLowerCase();
        const entrepreneur = (paiement.entrepreneur || '').toLowerCase();
        const client = (paiement.client || '').toLowerCase();
        const numeroSoumission = (paiement.numeroSoumission || '').toLowerCase();

        if (!entrepreneur.includes(search) && !client.includes(search) && !numeroSoumission.includes(search)) {
          return false;
        }
      }

      // Filtre par type
      if (filters.type && paiement.type !== filters.type) {
        return false;
      }

      // Filtre par date début
      if (filters.dateStart) {
        const paiementDate = parseDate(paiement.date);
        const filterDateStart = parseDate(filters.dateStart);
        if (!paiementDate || !filterDateStart || paiementDate < filterDateStart) {
          return false;
        }
      }

      // Filtre par date fin
      if (filters.dateEnd) {
        const paiementDate = parseDate(paiement.date);
        const filterDateEnd = parseDate(filters.dateEnd);
        if (!paiementDate || !filterDateEnd || paiementDate > filterDateEnd) {
          return false;
        }
      }

      // Filtre par montant min
      if (filters.montantMin !== null && filters.montantMin !== '') {
        const montant = parseMontant(paiement.montant);
        if (montant < parseFloat(filters.montantMin)) {
          return false;
        }
      }

      // Filtre par montant max
      if (filters.montantMax !== null && filters.montantMax !== '') {
        const montant = parseMontant(paiement.montant);
        if (montant > parseFloat(filters.montantMax)) {
          return false;
        }
      }

      return true;
    }

    // Appliquer les filtres pour Rapprochement QBO
    function applyFiltersRapprochement() {
      const filters = {
        search: document.getElementById('filter-search-rapprochement').value,
        type: document.getElementById('filter-type-rapprochement').value,
        dateStart: document.getElementById('filter-date-start-rapprochement').value,
        dateEnd: document.getElementById('filter-date-end-rapprochement').value
      };

      const rapprochementTbody = document.getElementById('rapprochement-tbody');
      const rows = rapprochementTbody.getElementsByTagName('tr');

      let visibleCount = 0;
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const index = parseInt(row.dataset.paymentIndex);
        const paiement = window.historiqueData[index];

        if (paiement && matchesFilters(paiement, filters)) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      }

      // Afficher message si aucun résultat
      const rapprochementEmpty = document.getElementById('rapprochement-empty');
      const rapprochementContent = document.getElementById('rapprochement-content');
      if (visibleCount === 0 && window.historiqueData && window.historiqueData.length > 0) {
        rapprochementContent.style.display = 'none';
        rapprochementEmpty.style.display = 'flex';
        rapprochementEmpty.innerHTML = '<i class="fas fa-filter"></i><p>Aucun résultat ne correspond aux filtres</p>';
      } else if (visibleCount > 0) {
        rapprochementContent.style.display = 'block';
        rapprochementEmpty.style.display = 'none';
      }
    }

    // Réinitialiser les filtres pour Rapprochement QBO
    function resetFiltersRapprochement() {
      document.getElementById('filter-search-rapprochement').value = '';
      document.getElementById('filter-type-rapprochement').value = '';
      document.getElementById('filter-date-start-rapprochement').value = '';
      document.getElementById('filter-date-end-rapprochement').value = '';

      // Réinitialiser le custom select visuellement
      const customSelect = document.querySelector('[data-target="filter-type-rapprochement"]');
      if (customSelect) {
        const textElement = customSelect.querySelector('.custom-select-text');
        const dropdown = customSelect.querySelector('.custom-select-dropdown');

        textElement.textContent = 'Tous les types';

        // Réinitialiser la classe selected
        dropdown.querySelectorAll('.custom-select-option').forEach(opt => {
          opt.classList.remove('selected');
          if (opt.getAttribute('data-value') === '') {
            opt.classList.add('selected');
          }
        });
      }

      applyFiltersRapprochement();
    }

    // Appliquer les filtres pour Tableau des périodes
    function applyFiltersPeriodes() {
      const filters = {
        search: document.getElementById('filter-search-periodes').value,
        type: document.getElementById('filter-type-periodes').value,
        periodeSpecific: document.getElementById('filter-periode-periodes').value
      };

      // Filtrer chaque période
      Object.keys(window.periodePaiements || {}).forEach(periodeId => {
        const paiements = window.periodePaiements[periodeId];

        // Si on filtre par période spécifique et ce n'est pas la bonne, cacher la période
        if (filters.periodeSpecific && periodeId !== filters.periodeSpecific) {
          const periodeDiv = document.getElementById(`content-${periodeId}`)?.parentElement;
          if (periodeDiv) periodeDiv.style.display = 'none';
          return;
        }

        // Filtrer les paiements de cette période
        let filteredPaiements = paiements;
        if (filters.search || filters.type) {
          filteredPaiements = paiements.filter(p => matchesFilters(p, filters));
        }

        // Mettre à jour l'affichage de la période avec les paiements filtrés
        const contentDiv = document.getElementById(`content-${periodeId}`);
        const countDiv = document.getElementById(`count-${periodeId}`);
        const periodeDiv = contentDiv?.parentElement;

        if (periodeDiv) {
          periodeDiv.style.display = '';
        }

        if (filteredPaiements.length === 0 && paiements.length > 0) {
          // Il y a des paiements mais aucun ne passe le filtre
          if (contentDiv) {
            contentDiv.innerHTML = `
              <div class="empty-state">
                <i class="fas fa-filter"></i>
                <p>Aucun paiement ne correspond aux filtres</p>
              </div>
            `;
          }
          if (countDiv) {
            countDiv.textContent = '0 paiement (filtré)';
            countDiv.style.background = 'rgba(148, 163, 184, 0.1)';
            countDiv.style.borderColor = 'rgba(148, 163, 184, 0.2)';
            countDiv.style.color = 'var(--text-gray)';
          }
        } else {
          // Mettre à jour l'affichage normal avec les paiements filtrés
          updatePeriodeDisplayFiltered(periodeId, filteredPaiements);
        }
      });
    }

    // Version de updatePeriodeDisplay qui accepte une liste filtrée de paiements
    function updatePeriodeDisplayFiltered(periodeId, paiements) {
      const contentDiv = document.getElementById(`content-${periodeId}`);
      const countDiv = document.getElementById(`count-${periodeId}`);

      // Mettre à jour le compteur
      const count = paiements.length;
      countDiv.textContent = count === 0 ? '0 paiement' : count === 1 ? '1 paiement' : `${count} paiements`;
      countDiv.style.background = count > 0 ? 'rgba(96, 165, 250, 0.2)' : 'rgba(148, 163, 184, 0.1)';
      countDiv.style.borderColor = count > 0 ? 'rgba(96, 165, 250, 0.4)' : 'rgba(148, 163, 184, 0.2)';
      countDiv.style.color = count > 0 ? '#60a5fa' : 'var(--text-gray)';

      if (count === 0) {
        contentDiv.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <p>Aucun paiement pour cette période</p>
          </div>
        `;
      } else {
        contentDiv.innerHTML = `
          <div style="padding: 0.75rem;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: rgba(59, 130, 246, 0.05); border-bottom: 2px solid var(--border-dark);">
                  <th style="padding: 0.65rem; text-align: left; font-weight: 600; color: var(--text-gray); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Date</th>
                  <th style="padding: 0.65rem; text-align: left; font-weight: 600; color: var(--text-gray); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Entrepreneur</th>
                  <th style="padding: 0.65rem; text-align: left; font-weight: 600; color: var(--text-gray); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Client</th>
                  <th style="padding: 0.65rem; text-align: left; font-weight: 600; color: var(--text-gray); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">N° Soumission</th>
                  <th style="padding: 0.65rem; text-align: left; font-weight: 600; color: var(--text-gray); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Type</th>
                  <th style="padding: 0.65rem; text-align: left; font-weight: 600; color: var(--text-gray); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Montant</th>
                  <th style="padding: 0.65rem; text-align: center; font-weight: 600; color: var(--text-gray); font-size: 0.75rem; width: 60px;"></th>
                </tr>
              </thead>
              <tbody>
                ${paiements.map((p, index) => {
                  const typeClass = p.type === 'depot' ? 'depot' : (p.type === 'paiement_final' ? 'paiement-final' : (p.type === 'remboursement' ? 'remboursement' : 'autres'));
                  const typeLabel = p.type === 'depot' ? 'Dépôt' : (p.type === 'paiement_final' ? 'Paiement final' : (p.type === 'remboursement' ? 'Remboursement' : 'Autre'));

                  const avatarHtml = p.entrepreneurPhoto
                    ? `<img src="${p.entrepreneurPhoto}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(59, 130, 246, 0.3);">`
                    : `<div style="width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.65rem;">${p.entrepreneur ? p.entrepreneur.charAt(0).toUpperCase() : '?'}</div>`;

                  // Trouver l'index réel dans window.periodePaiements[periodeId]
                  const realIndex = window.periodePaiements[periodeId].indexOf(p);

                  return `
                    <tr style="transition: background 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.03)'" onmouseout="this.style.background=''">
                      <td style="padding: 0.65rem; color: var(--text-light); font-size: 0.8rem;">${p.date || 'N/A'}</td>
                      <td style="padding: 0.65rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                          ${avatarHtml}
                          <span style="font-weight: 500; color: var(--text-light); font-size: 0.8rem;">${p.entrepreneur || 'N/A'}</span>
                        </div>
                      </td>
                      <td style="padding: 0.65rem; font-weight: 600; color: var(--text-light); font-size: 0.85rem;">${p.client || 'N/A'}</td>
                      <td style="padding: 0.65rem; font-weight: 600; color: #60a5fa; font-size: 0.8rem;">${p.numeroSoumission || 'N/A'}</td>
                      <td style="padding: 0.65rem;">
                        <span class="type-badge ${typeClass}" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">${typeLabel}</span>
                      </td>
                      <td style="padding: 0.65rem; font-weight: 600; color: var(--text-light); font-size: 0.85rem;">${p.type === 'remboursement' ? '-' + (p.montant || '0,00 $') : (p.montant || '0,00 $')}</td>
                      <td style="padding: 0.65rem; text-align: center;">
                        <button onclick="removePaymentFromPeriode('${periodeId}', ${realIndex})" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 5px; padding: 0.3rem 0.45rem; color: #ef4444; cursor: pointer; transition: all 0.2s;">
                          <i class="fas fa-times" style="font-size: 0.75rem;"></i>
                        </button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
    }

    // Réinitialiser les filtres pour Tableau des périodes
    function resetFiltersPeriodes() {
      document.getElementById('filter-search-periodes').value = '';
      document.getElementById('filter-type-periodes').value = '';
      document.getElementById('filter-periode-periodes').value = '';

      // Réinitialiser les custom selects visuellement
      const customSelectType = document.querySelector('[data-target="filter-type-periodes"]');
      if (customSelectType) {
        const textElement = customSelectType.querySelector('.custom-select-text');
        const dropdown = customSelectType.querySelector('.custom-select-dropdown');
        textElement.textContent = 'Tous les types';
        dropdown.querySelectorAll('.custom-select-option').forEach(opt => {
          opt.classList.remove('selected');
          if (opt.getAttribute('data-value') === '') {
            opt.classList.add('selected');
          }
        });
      }

      const customSelectPeriode = document.querySelector('[data-target="filter-periode-periodes"]');
      if (customSelectPeriode) {
        const textElement = customSelectPeriode.querySelector('.custom-select-text');
        const dropdown = customSelectPeriode.querySelector('.custom-select-dropdown');
        textElement.textContent = 'Toutes les périodes';
        dropdown.querySelectorAll('.custom-select-option').forEach(opt => {
          opt.classList.remove('selected');
          if (opt.getAttribute('data-value') === '') {
            opt.classList.add('selected');
          }
        });
      }

      // Réafficher toutes les périodes normalement
      Object.keys(window.periodePaiements || {}).forEach(periodeId => {
        updatePeriodeDisplay(periodeId);
        const periodeDiv = document.getElementById(`content-${periodeId}`)?.parentElement;
        if (periodeDiv) periodeDiv.style.display = '';
      });
    }

    // Peupler le select des périodes spécifiques
    function populatePeriodeSelect() {
      const select = document.getElementById('filter-periode-periodes');
      const dropdown = document.getElementById('periode-dropdown-options');
      if (!select || !dropdown || !window.periodesData) return;

      // Garder l'option "Toutes les périodes" dans le select caché
      select.innerHTML = '<option value="">Toutes les périodes</option>';

      // Garder l'option "Toutes les périodes" dans le dropdown personnalisé
      dropdown.innerHTML = '<div class="custom-select-option selected" data-value="">Toutes les périodes</div>';

      // Ajouter chaque période
      window.periodesData.forEach(periode => {
        // Ajouter au select caché
        const option = document.createElement('option');
        option.value = periode.id;
        option.textContent = `${periode.label} (${periode.dates})`;
        select.appendChild(option);

        // Ajouter au dropdown personnalisé
        const optionDiv = document.createElement('div');
        optionDiv.className = 'custom-select-option';
        optionDiv.setAttribute('data-value', periode.id);
        optionDiv.textContent = `${periode.label} (${periode.dates})`;
        dropdown.appendChild(optionDiv);
      });
    }

    // ============================================
    // INITIALISATION CUSTOM SELECT FILTRES
    // ============================================

    function initCustomSelectFiltres() {
      // Initialiser tous les custom-select
      document.querySelectorAll('.custom-select').forEach(customSelect => {
        const targetId = customSelect.getAttribute('data-target');
        const button = customSelect.querySelector('.custom-select-button');
        const dropdown = customSelect.querySelector('.custom-select-dropdown');
        const textElement = customSelect.querySelector('.custom-select-text');
        const hiddenSelect = document.getElementById(targetId);

        if (!button || !dropdown || !textElement || !hiddenSelect) return;

        // Toggle dropdown on button click
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          // Fermer les autres dropdowns
          document.querySelectorAll('.custom-select').forEach(select => {
            if (select !== customSelect) {
              select.classList.remove('open');
            }
          });
          customSelect.classList.toggle('open');
        });

        // Handle option selection
        dropdown.querySelectorAll('.custom-select-option').forEach(option => {
          option.addEventListener('click', (e) => {
            e.stopPropagation();

            const value = option.getAttribute('data-value');
            const text = option.textContent;

            // Update visual select
            textElement.textContent = text;

            // Update hidden select
            hiddenSelect.value = value;

            // Update selected class
            dropdown.querySelectorAll('.custom-select-option').forEach(opt => {
              opt.classList.remove('selected');
            });
            option.classList.add('selected');

            // Close dropdown
            customSelect.classList.remove('open');

            // Trigger appropriate filter update based on the select
            if (targetId === 'filter-type-rapprochement') {
              applyFiltersRapprochement();
            } else if (targetId === 'filter-type-periodes' || targetId === 'filter-periode-periodes') {
              applyFiltersPeriodes();
            }
          });
        });

        // Keyboard navigation
        button.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            customSelect.classList.toggle('open');
          }
        });
      });

      // Close all dropdowns when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.custom-select')) {
          document.querySelectorAll('.custom-select').forEach(select => {
            select.classList.remove('open');
          });
        }
      });
    }

    // ============================================
    // SYSTÈME DE SOUS-TABS PAIEMENTS / MESSAGES
    // ============================================

    let currentSubTab = 'paiements';
    let currentConversation = null; // Pour stocker entrepreneur/numeroSoumission actuel

    // Basculer entre sous-tabs
    function switchSubTab(tab) {
      currentSubTab = tab;

      // Mettre à jour les boutons
      document.getElementById('subtab-paiements').classList.toggle('active', tab === 'paiements');
      document.getElementById('subtab-messages').classList.toggle('active', tab === 'messages');

      // Afficher/Masquer les vues
      document.getElementById('paiements-view').style.display = tab === 'paiements' ? 'block' : 'none';
      document.getElementById('messages-view').style.display = tab === 'messages' ? 'block' : 'none';

      // Afficher/Masquer les filtres (seulement pour paiements)
      const filtersBar = document.getElementById('filters-bar');
      if (filtersBar) {
        filtersBar.style.display = tab === 'paiements' ? 'flex' : 'none';
      }

      // Si on passe aux messages, charger la liste
      if (tab === 'messages') {
        afficherListeMessages();
      }
    }

    // Charger les messages en attente (nouveaux messages de entrepreneurs)
    async function chargerMessagesEnAttente() {
      try {
        const response = await fetch('/api/comptable/messages-en-attente');

        if (!response.ok) {
          throw new Error('Erreur lors du chargement des messages');
        }

        const data = await response.json();
        messagesEnAttente = data.messages || [];

        // Mettre à jour le badge du sous-tab Messages
        const count = messagesEnAttente.length;
        const badge = document.getElementById('messages-count-badge');
        if (count > 0) {
          badge.style.display = 'inline-flex';
          badge.textContent = count > 99 ? '99+' : count;
        } else {
          badge.style.display = 'none';
        }

        // Mettre à jour le badge Paiements aussi
        document.getElementById('paiements-count-badge').textContent = allPayments.length;

      } catch (error) {
        console.error('[Direction Facturation] Erreur chargement messages:', error);
      }
    }

    // Afficher la liste des messages dans la vue intégrée
    function afficherListeMessages() {
      const loadingEl = document.getElementById('messages-loading');
      const emptyEl = document.getElementById('messages-empty');
      const listEl = document.getElementById('messages-list');
      const conversationEl = document.getElementById('conversation-view');

      // Cacher la conversation si ouverte
      conversationEl.style.display = 'none';

      if (messagesEnAttente.length === 0) {
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'flex';
        listEl.style.display = 'none';
        return;
      }

      loadingEl.style.display = 'none';
      emptyEl.style.display = 'none';
      listEl.style.display = 'block';

      listEl.innerHTML = messagesEnAttente.map((msg, index) => {
        const nomComplet = msg.entrepreneurNomComplet || msg.entrepreneur;
        const avatarHtml = msg.entrepreneurPhoto
          ? `<img src="${msg.entrepreneurPhoto}" class="avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`
          : `<div class="avatar">${nomComplet.charAt(0).toUpperCase()}</div>`;

        return `
          <div class="message-card" onclick="afficherConversationAvecInfos(${index})">
            <div class="message-card-header">
              <div class="message-card-entrepreneur">
                ${avatarHtml}
                <span class="name">${nomComplet}</span>
              </div>
              <span class="message-card-date">${new Date(msg.date).toLocaleString('fr-CA')}</span>
            </div>
            <div class="message-card-soumission">
              <i class="fas fa-hashtag" style="margin-right: 0.25rem;"></i>${msg.numeroSoumission}
            </div>
            <div class="message-card-preview">
              <i class="fas fa-comment"></i>
              <span>${msg.dernierMessage}</span>
            </div>
            <div class="message-card-count">
              ${msg.nombreMessages} message${msg.nombreMessages > 1 ? 's' : ''} en attente
            </div>
          </div>
        `;
      }).join('');
    }

    // Nouvelle fonction pour afficher conversation avec toutes les infos (photo, nom complet, client info)
    async function afficherConversationAvecInfos(index) {
      const msgData = messagesEnAttente[index];
      if (!msgData) return;

      const entrepreneur = msgData.entrepreneur;
      const numeroSoumission = msgData.numeroSoumission;
      const nomComplet = msgData.entrepreneurNomComplet || entrepreneur;
      const photo = msgData.entrepreneurPhoto;
      const clientInfo = msgData.clientInfo || {};
      const paiementInfo = msgData.paiementInfo || {};

      // Stocker les infos pour utilisation dans envoyerMessageConversation
      currentConversation = {
        entrepreneur,
        numeroSoumission,
        nomComplet,
        photo,
        clientInfo,
        paiementInfo
      };

      const listEl = document.getElementById('messages-list');
      const conversationEl = document.getElementById('conversation-view');
      const loadingEl = document.getElementById('messages-loading');

      try {
        listEl.style.display = 'none';
        loadingEl.style.display = 'flex';

        const response = await fetch(`/api/facturationqe/client/${entrepreneur}/${numeroSoumission}/conversation`);

        if (!response.ok) {
          throw new Error('Erreur lors du chargement de la conversation');
        }

        const data = await response.json();
        const conversation = data.conversation || [];

        loadingEl.style.display = 'none';
        conversationEl.style.display = 'block';

        // Avatar HTML avec vraie photo ou initiale
        const avatarHtml = photo
          ? `<img src="${photo}" class="avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">`
          : `<div class="avatar">${nomComplet.charAt(0).toUpperCase()}</div>`;

        conversationEl.innerHTML = `
          <div class="conversation-container">
            <div class="conversation-header">
              <button class="conversation-back-btn" onclick="retourListeMessages()">
                <i class="fas fa-arrow-left"></i>
                <span>Retour</span>
              </button>
              <div class="conversation-entrepreneur-info">
                ${avatarHtml}
                <div class="details">
                  <h3>${nomComplet}</h3>
                  <span><i class="fas fa-hashtag"></i> ${numeroSoumission}</span>
                </div>
              </div>
              <button class="btn-info-paiement" onclick="afficherInfoPaiement()" title="Information paiement">
                <i class="fas fa-credit-card"></i>
                <span>Info paiement</span>
              </button>
              <button class="btn-info-client" onclick="afficherInfoClient()" title="Information client">
                <i class="fas fa-user-circle"></i>
                <span>Info client</span>
              </button>
            </div>

            <div class="conversation-messages" id="conversation-messages-container">
              ${conversation.map(msg => `
                <div class="chat-message ${msg.de === 'comptable' ? 'from-comptable' : 'from-entrepreneur'}">
                  <div class="chat-bubble">
                    <div class="sender">${msg.de === 'comptable' ? 'Comptable' : nomComplet}</div>
                    <div class="text">${msg.message}</div>
                    <div class="time">${new Date(msg.date).toLocaleString('fr-CA')}</div>
                  </div>
                </div>
              `).join('')}
            </div>

            <div class="chat-input-container">
              <textarea
                id="chat-message-input"
                placeholder="Votre message..."
                rows="1"
                class="chat-textarea"
                onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); envoyerMessageConversation(); }"
              ></textarea>
              <button class="btn-envoyer-chat" onclick="envoyerMessageConversation()" title="Envoyer le message">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        `;

        // Scroller vers le bas des messages
        const messagesContainer = document.getElementById('conversation-messages-container');
        if (messagesContainer) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

      } catch (error) {
        console.error('[Direction Facturation] Erreur conversation:', error);
        loadingEl.style.display = 'none';
        alert('Erreur lors du chargement de la conversation');
        retourListeMessages();
      }
    }

    // Afficher le modal d'info client
    function afficherInfoClient() {
      if (!currentConversation || !currentConversation.clientInfo) {
        alert('Aucune information client disponible');
        return;
      }

      const client = currentConversation.clientInfo;
      // Récupérer le nom avec fallback (API utilise clientPrenom/clientNom)
      const prenom = client.clientPrenom || client.prenom || '';
      const nom = client.clientNom || client.nom || '';
      const nomComplet = `${prenom} ${nom}`.trim() || 'N/A';

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'modal-info-client';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 450px; height: auto !important; border-radius: 12px;">
          <div class="modal-header">
            <h3><i class="fas fa-user-circle"></i> Information client</h3>
            <button class="modal-close" onclick="fermerModalInfoClient()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body" style="padding: 1.5rem;">
            <div class="client-info-grid">
              <div class="client-info-item">
                <label><i class="fas fa-user"></i> Nom complet</label>
                <span>${nomComplet}</span>
              </div>
              <div class="client-info-item">
                <label><i class="fas fa-hashtag"></i> Soumission</label>
                <span>${currentConversation.numeroSoumission}</span>
              </div>
              <div class="client-info-item">
                <label><i class="fas fa-dollar-sign"></i> Prix</label>
                <span>${client.prix || 'N/A'}</span>
              </div>
              <div class="client-info-item">
                <label><i class="fas fa-map-marker-alt"></i> Adresse</label>
                <span>${client.adresse || 'N/A'}</span>
              </div>
              <div class="client-info-item">
                <label><i class="fas fa-phone"></i> Téléphone</label>
                <span>${client.telephone || 'N/A'}</span>
              </div>
              <div class="client-info-item">
                <label><i class="fas fa-envelope"></i> Courriel</label>
                <span>${client.courriel || 'N/A'}</span>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Bloquer le scroll en arrière-plan
      document.body.style.overflow = 'hidden';

      // Fermer en cliquant sur l'overlay
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          fermerModalInfoClient();
        }
      });
    }

    // Fermer le modal d'info client
    function fermerModalInfoClient() {
      const modal = document.getElementById('modal-info-client');
      if (modal) {
        modal.remove();
        // Restaurer le scroll
        document.body.style.overflow = '';
      }
    }

    // Afficher le modal d'info paiement
    function afficherInfoPaiement() {
      if (!currentConversation || !currentConversation.paiementInfo) {
        alert('Aucune information de paiement disponible');
        return;
      }

      const paiement = currentConversation.paiementInfo;

      // Formater la méthode de paiement
      const getMethodeLabel = (methode) => {
        const labels = {
          'virement': 'Virement Interac',
          'cheque': 'Chèque',
          'comptant': 'Comptant',
          'carte': 'Carte de crédit'
        };
        return labels[methode] || methode || 'N/A';
      };

      // Déterminer le type de paiement (Dépôt par défaut car c'est un paiement depot)
      const typePaiement = 'Dépôt';

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'modal-info-paiement';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; height: auto !important; border-radius: 12px;">
          <div class="modal-header">
            <h3><i class="fas fa-credit-card"></i> Information paiement</h3>
            <button class="modal-close" onclick="fermerModalInfoPaiement()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body" style="padding: 1.5rem;">
            <div class="client-info-grid">
              <div class="client-info-item">
                <label><i class="fas fa-tag"></i> Type de paiement</label>
                <span style="font-weight: 600; color: #8b5cf6;">${typePaiement}</span>
              </div>
              <div class="client-info-item">
                <label><i class="fas fa-dollar-sign"></i> Montant</label>
                <span style="font-size: 1.2rem; font-weight: 600; color: #10b981;">${paiement.montant || 'N/A'}</span>
              </div>
              <div class="client-info-item">
                <label><i class="fas fa-calendar"></i> Date du paiement</label>
                <span>${paiement.date || 'N/A'}</span>
              </div>
              <div class="client-info-item">
                <label><i class="fas fa-wallet"></i> Méthode de paiement</label>
                <span>${getMethodeLabel(paiement.methode)}</span>
              </div>
              ${paiement.lienVirement ? `
              <div class="client-info-item">
                <label><i class="fas fa-link"></i> Lien de virement</label>
                <a href="${paiement.lienVirement.startsWith('http') ? paiement.lienVirement : 'https://' + paiement.lienVirement}" target="_blank" style="color: #3b82f6; word-break: break-all;">${paiement.lienVirement}</a>
              </div>
              ` : ''}
              ${paiement.motDePasse ? `
              <div class="client-info-item">
                <label><i class="fas fa-key"></i> Mot de passe</label>
                <span style="font-family: monospace; background: rgba(15, 23, 42, 0.5); padding: 0.25rem 0.5rem; border-radius: 4px;">${paiement.motDePasse}</span>
              </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Bloquer le scroll en arrière-plan
      document.body.style.overflow = 'hidden';

      // Fermer en cliquant sur l'overlay
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          fermerModalInfoPaiement();
        }
      });
    }

    // Fermer le modal d'info paiement
    function fermerModalInfoPaiement() {
      const modal = document.getElementById('modal-info-paiement');
      if (modal) {
        modal.remove();
        // Restaurer le scroll
        document.body.style.overflow = '';
      }
    }

    // Afficher une conversation spécifique dans la vue intégrée (ancienne fonction pour compatibilité)
    async function afficherConversation(entrepreneur, numeroSoumission) {
      const listEl = document.getElementById('messages-list');
      const conversationEl = document.getElementById('conversation-view');
      const loadingEl = document.getElementById('messages-loading');

      currentConversation = { entrepreneur, numeroSoumission };

      try {
        listEl.style.display = 'none';
        loadingEl.style.display = 'flex';

        const response = await fetch(`/api/facturationqe/client/${entrepreneur}/${numeroSoumission}/conversation`);

        if (!response.ok) {
          throw new Error('Erreur lors du chargement de la conversation');
        }

        const data = await response.json();
        const conversation = data.conversation || [];

        loadingEl.style.display = 'none';
        conversationEl.style.display = 'block';

        conversationEl.innerHTML = `
          <div class="conversation-container">
            <div class="conversation-header">
              <button class="conversation-back-btn" onclick="retourListeMessages()">
                <i class="fas fa-arrow-left"></i>
                <span>Retour</span>
              </button>
              <div class="conversation-entrepreneur-info">
                <div class="avatar">${entrepreneur.charAt(0).toUpperCase()}</div>
                <div class="details">
                  <h3>${entrepreneur}</h3>
                  <span><i class="fas fa-hashtag"></i> ${numeroSoumission}</span>
                </div>
              </div>
            </div>

            <div class="conversation-messages" id="conversation-messages-container">
              ${conversation.map(msg => `
                <div class="chat-message ${msg.de === 'comptable' ? 'from-comptable' : 'from-entrepreneur'}">
                  <div class="chat-bubble">
                    <div class="sender">${msg.de === 'comptable' ? 'Comptable' : entrepreneur}</div>
                    <div class="text">${msg.message}</div>
                    <div class="time">${new Date(msg.date).toLocaleString('fr-CA')}</div>
                  </div>
                </div>
              `).join('')}
            </div>

            <div class="chat-input-container">
              <textarea
                id="chat-message-input"
                placeholder="Votre message..."
                rows="1"
                class="chat-textarea"
                onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); envoyerMessageConversation(); }"
              ></textarea>
              <button class="btn-envoyer-chat" onclick="envoyerMessageConversation()" title="Envoyer le message">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        `;

        // Scroller vers le bas des messages
        const messagesContainer = document.getElementById('conversation-messages-container');
        if (messagesContainer) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

      } catch (error) {
        console.error('[Direction Facturation] Erreur conversation:', error);
        loadingEl.style.display = 'none';
        alert('Erreur lors du chargement de la conversation');
        retourListeMessages();
      }
    }

    // Recharger la conversation en gardant les infos (nom complet, photo)
    async function rechargerConversationAvecInfos() {
      if (!currentConversation) return;

      const { entrepreneur, numeroSoumission, nomComplet, photo, clientInfo, paiementInfo } = currentConversation;
      const conversationEl = document.getElementById('conversation-view');

      try {
        const response = await fetch(`/api/facturationqe/client/${entrepreneur}/${numeroSoumission}/conversation`);
        if (!response.ok) throw new Error('Erreur lors du chargement');

        const data = await response.json();
        const conversation = data.conversation || [];

        // Avatar HTML avec vraie photo ou initiale
        const displayName = nomComplet || entrepreneur;
        const avatarHtml = photo
          ? `<img src="${photo}" class="avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">`
          : `<div class="avatar">${displayName.charAt(0).toUpperCase()}</div>`;

        conversationEl.innerHTML = `
          <div class="conversation-container">
            <div class="conversation-header">
              <button class="conversation-back-btn" onclick="retourListeMessages()">
                <i class="fas fa-arrow-left"></i>
                <span>Retour</span>
              </button>
              <div class="conversation-entrepreneur-info">
                ${avatarHtml}
                <div class="details">
                  <h3>${displayName}</h3>
                  <span><i class="fas fa-hashtag"></i> ${numeroSoumission}</span>
                </div>
              </div>
              <button class="btn-info-paiement" onclick="afficherInfoPaiement()" title="Information paiement">
                <i class="fas fa-credit-card"></i>
                <span>Info paiement</span>
              </button>
              <button class="btn-info-client" onclick="afficherInfoClient()" title="Information client">
                <i class="fas fa-user-circle"></i>
                <span>Info client</span>
              </button>
            </div>

            <div class="conversation-messages" id="conversation-messages-container">
              ${conversation.map(msg => `
                <div class="chat-message ${msg.de === 'comptable' ? 'from-comptable' : 'from-entrepreneur'}">
                  <div class="chat-bubble">
                    <div class="sender">${msg.de === 'comptable' ? 'Comptable' : displayName}</div>
                    <div class="text">${msg.message}</div>
                    <div class="time">${new Date(msg.date).toLocaleString('fr-CA')}</div>
                  </div>
                </div>
              `).join('')}
            </div>

            <div class="chat-input-container">
              <textarea
                id="chat-message-input"
                placeholder="Votre message..."
                rows="1"
                class="chat-textarea"
                onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); envoyerMessageConversation(); }"
              ></textarea>
              <button class="btn-envoyer-chat" onclick="envoyerMessageConversation()" title="Envoyer le message">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        `;

        // Scroller vers le bas des messages
        const messagesContainer = document.getElementById('conversation-messages-container');
        if (messagesContainer) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      } catch (error) {
        console.error('[Direction Facturation] Erreur rechargement conversation:', error);
      }
    }

    // Retourner à la liste des messages
    function retourListeMessages() {
      currentConversation = null;
      document.getElementById('conversation-view').style.display = 'none';
      afficherListeMessages();
    }

    // Envoyer un message dans la conversation intégrée
    async function envoyerMessageConversation() {
      if (!currentConversation) return;

      const input = document.getElementById('chat-message-input');
      const message = input.value.trim();

      if (!message) return;

      try {
        const response = await fetch(`/api/facturationqe/client/${currentConversation.entrepreneur}/${currentConversation.numeroSoumission}/message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, de: 'comptable' })
        });

        if (!response.ok) {
          throw new Error('Erreur lors de l\'envoi');
        }

        // Recharger la conversation en gardant les infos (nom complet, photo)
        await rechargerConversationAvecInfos();

        // Recharger les messages en attente
        await chargerMessagesEnAttente();

      } catch (error) {
        console.error('[Direction Facturation] Erreur envoi message:', error);
        alert('Erreur lors de l\'envoi du message');
      }
    }

    // Anciennes fonctions pour compatibilité avec le modal (si utilisé ailleurs)
    function ouvrirMessagesAttente() {
      switchSubTab('messages');
    }

    async function voirConversationRefus(entrepreneur, numeroSoumission) {
      switchSubTab('messages');
      await afficherConversation(entrepreneur, numeroSoumission);
    }

    async function envoyerReponseComptable(entrepreneur, numeroSoumission) {
      const input = document.getElementById('reponse-message');
      const message = input.value.trim();

      if (!message) return;

      try {
        const response = await fetch(`/api/facturationqe/client/${entrepreneur}/${numeroSoumission}/message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, de: 'comptable' })
        });

        if (!response.ok) {
          throw new Error('Erreur lors de l\'envoi');
        }

        await voirConversationRefus(entrepreneur, numeroSoumission);
        await chargerMessagesEnAttente();

      } catch (error) {
        console.error('[Direction Facturation] Erreur envoi message:', error);
        alert('Erreur lors de l\'envoi du message');
      }
    }

    // Classe CustomCalendar pour les filtres de dates
    class CustomCalendar {
      static instances = [];

      constructor(inputId, calendarId) {
        this.inputElement = document.getElementById(inputId);
        this.calendarElement = document.getElementById(calendarId);
        this.currentDate = new Date();
        this.selectedDate = null;

        // Ne PAS définir de date par défaut - laisser vide
        this.inputElement.value = '';

        this.monthNames = [
          'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
          'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'
        ];

        this.dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

        // Ajouter cette instance à la liste
        CustomCalendar.instances.push(this);

        this.init();
      }

      init() {
        this.inputElement.addEventListener('click', () => {
          this.toggleCalendar();
        });

        document.addEventListener('click', (e) => {
          if (!e.target.closest('.custom-date-container')) {
            this.hideCalendar();
          }
        });

        this.renderCalendar();
      }

      toggleCalendar() {
        if (this.calendarElement.classList.contains('hidden')) {
          this.showCalendar();
        } else {
          this.hideCalendar();
        }
      }

      showCalendar() {
        // Fermer tous les autres calendriers
        CustomCalendar.instances.forEach(instance => {
          if (instance !== this) {
            instance.hideCalendar();
          }
        });

        this.calendarElement.classList.remove('hidden');
        this.calendarElement.style.setProperty('display', 'block', 'important');
        this.renderCalendar();
      }

      hideCalendar() {
        this.calendarElement.classList.add('hidden');
        this.calendarElement.style.display = 'none';
      }

      renderCalendar() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();

        this.calendarElement.innerHTML = `
          <div class="calendar-header">
            <button type="button" class="calendar-nav-btn">‹</button>
            <div class="calendar-month-year">${this.monthNames[month]} ${year}</div>
            <button type="button" class="calendar-nav-btn">›</button>
          </div>
          <div class="calendar-grid">
            ${this.renderDayHeaders()}
            ${this.renderDays()}
          </div>
        `;

        this.calendarElement.calendar = this;

        // Ajouter les event listeners pour les boutons de navigation
        const prevBtn = this.calendarElement.querySelector('.calendar-nav-btn:first-child');
        const nextBtn = this.calendarElement.querySelector('.calendar-nav-btn:last-child');

        prevBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.previousMonth();
        });

        nextBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.nextMonth();
        });
      }

      renderDayHeaders() {
        return this.dayNames.map(day =>
          `<div class="calendar-day-header">${day}</div>`
        ).join('');
      }

      renderDays() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = firstDay.getDay();

        let daysHTML = '';

        // Jours du mois précédent
        const prevMonth = new Date(year, month - 1, 0);
        for (let i = startingDay - 1; i >= 0; i--) {
          const day = prevMonth.getDate() - i;
          daysHTML += `<div class="calendar-day other-month">${day}</div>`;
        }

        // Jours du mois actuel
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          let classes = 'calendar-day';

          if (this.selectedDate && this.isSameDay(date, this.selectedDate)) {
            classes += ' selected';
          } else if (this.isSameDay(date, today)) {
            classes += ' today';
          }

          daysHTML += `<div class="${classes}" onclick="this.closest('.custom-calendar').calendar.selectDate(${year}, ${month}, ${day})">${day}</div>`;
        }

        // Jours du mois suivant pour compléter la grille
        const totalCells = Math.ceil((startingDay + daysInMonth) / 7) * 7;
        const remainingCells = totalCells - (startingDay + daysInMonth);
        for (let day = 1; day <= remainingCells; day++) {
          daysHTML += `<div class="calendar-day other-month">${day}</div>`;
        }

        return daysHTML;
      }

      selectDate(year, month, day) {
        this.selectedDate = new Date(year, month, day);
        const formattedDate = this.formatDate(this.selectedDate);
        this.inputElement.value = formattedDate;
        this.hideCalendar();

        // Déclencher l'événement change pour les filtres
        applyFiltersRapprochement();
      }

      formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${day}/${month}/${year}`;
      }

      isSameDay(date1, date2) {
        return date1.getFullYear() === date2.getFullYear() &&
               date1.getMonth() === date2.getMonth() &&
               date1.getDate() === date2.getDate();
      }

      previousMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
        this.renderCalendar();
      }

      nextMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
        this.renderCalendar();
      }
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', async () => {
      // Initialiser le custom select des filtres
      initCustomSelectFiltres();

      // Initialiser les calendriers personnalisés
      new CustomCalendar('filter-date-start-rapprochement', 'calendar-filter-date-start');
      new CustomCalendar('filter-date-end-rapprochement', 'calendar-filter-date-end');

      // Charger les périodes d'abord (cela charge aussi le tableau Rapprochement QBO avec filtrage)
      await chargerTableauPeriodes();

      // Ensuite charger le reste
      chargerPaiementsEnTraitement();
      chargerMessagesEnAttente();
      chargerDerniersTraites();

      // Drag-to-scroll pour le tableau des paiements
      const scrollContainer = document.getElementById('payments-scroll-container');
      if (scrollContainer) {
        let isDown = false;
        let startX;
        let scrollLeft;

        scrollContainer.addEventListener('mousedown', (e) => {
          // Ne pas activer si on clique sur un bouton
          if (e.target.closest('button')) return;
          isDown = true;
          scrollContainer.style.cursor = 'grabbing';
          startX = e.pageX - scrollContainer.offsetLeft;
          scrollLeft = scrollContainer.scrollLeft;
        });

        scrollContainer.addEventListener('mouseleave', () => {
          isDown = false;
          scrollContainer.style.cursor = '';
        });

        scrollContainer.addEventListener('mouseup', () => {
          isDown = false;
          scrollContainer.style.cursor = '';
        });

        scrollContainer.addEventListener('mousemove', (e) => {
          if (!isDown) return;
          e.preventDefault();
          const x = e.pageX - scrollContainer.offsetLeft;
          const walk = (x - startX) * 2;
          scrollContainer.scrollLeft = scrollLeft - walk;
        });
      }
    });

    // Fermer modal avec Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        fermerModal();
      }
    });

    // Fermer modal soumission en cliquant à l'extérieur
    document.getElementById('soumissionModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-soumission')) {
        fermerSoumissionModal();
      }
    });
  </script>

</body>
</html>
