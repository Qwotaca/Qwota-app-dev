<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>RPO - Direction Qwota</title>

  <!-- PWA Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Qwota">
  <meta name="msapplication-TileColor" content="#1f2937">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Icones PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

  <!-- Scripts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="icon" href="/favicon" type="image/x-icon" />

  <!-- Script commun -->
  <script src="/common.js"></script>

  <!-- Feuille de style principale - Theme Dark -->
  <link rel="stylesheet" href="/base.css">

  <!-- Entrepreneur Selector -->
  <link rel="stylesheet" href="/entrepreneur-selector.css">

<style>
/* Override anti-flash for direction viewing their own data */
body.direction-viewing-own-data .main-content,
body.direction-viewing-own-data #main-content,
body.direction-viewing-own-data #main-content-wrapper,
body.direction-viewing-own-data main {
  opacity: 1 !important;
  pointer-events: all !important;
}

body.direction-viewing-own-data #coach-entrepreneur-selector,
body.direction-viewing-own-data #coach-selector-backdrop {
  display: none !important;
}

/* Main content */
.main-content {
  padding: 2rem;
  max-width: 1600px;
  margin: 0 auto;
}

#main-content {
  padding: 2rem;
  padding-bottom: 20rem !important;
}

/* Animation bulle pour le modal RPO - sort du bouton */
@keyframes bubbleIn {
  0% {
    transform: scale(0);
    opacity: 0;
  }
  60% {
    transform: scale(1.08);
    opacity: 1;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

@keyframes bubbleOut {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  40% {
    transform: scale(1.05);
    opacity: 1;
  }
  100% {
    transform: scale(0);
    opacity: 0;
  }
}

.bubble-in {
  animation: bubbleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.bubble-out {
  animation: bubbleOut 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* Animations fade-in */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.fade-in-up {
  animation: fadeInUp 0.6s ease-out forwards;
}

/* Animation de succès */
@keyframes successFadeIn {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes checkmarkDraw {
  0% {
    stroke-dashoffset: 100;
  }
  100% {
    stroke-dashoffset: 0;
  }
}

.success-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(10px);
  z-index: 100000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.success-content {
  text-align: center;
  color: white;
  animation: successFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
}

.success-checkmark {
  width: 80px;
  height: 80px;
  margin: 0 auto 1.5rem;
  background: rgba(34, 197, 94, 0.2);
  border: 3px solid #22c55e;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.success-checkmark svg {
  width: 40px;
  height: 40px;
}

.success-checkmark path {
  stroke-dasharray: 100;
  stroke-dashoffset: 100;
  animation: checkmarkDraw 0.8s ease-out 0.3s forwards;
}

/* Header de la page - Style Dashboard */
.page-header {
  margin-bottom: 2.5rem;
}

.page-header h1 {
  font-size: 2.25rem;
  font-weight: 700;
  color: var(--text-light);
  margin-bottom: 0.75rem;
  position: relative;
  display: inline-block;
}

.page-header .title-underline {
  position: absolute;
  bottom: -0.5rem;
  left: 0;
  width: 5rem;
  height: 0.25rem;
  background: linear-gradient(to right, #3b82f6, #60a5fa);
  border-radius: 9999px;
}

.page-header .header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
  margin-right: 0 !important;
  padding: 0 !important;
  max-width: 100% !important;
  height: auto !important;
}

.page-header p {
  color: var(--text-gray);
  font-size: 1.25rem;
  font-weight: 500;
}

/* Responsive */
@media (max-width: 768px) {
  .page-header h1 {
    font-size: 1.875rem;
  }

  .page-header p {
    font-size: 1rem;
  }
}

/* Onglets Navigation */
.tab-spacing {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.btn-primary, .btn-secondary {
  padding: 0.75rem 1.5rem;
  border-radius: 0.75rem;
  font-weight: 600;
  font-size: 1rem;
  transition: all 0.3s ease;
  border: 2px solid transparent;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.btn-secondary {
  background: rgba(51, 65, 85, 0.5);
  color: var(--text-gray);
  border: 2px solid rgba(51, 65, 85, 0.8);
}

.btn-secondary:hover {
  background: rgba(51, 65, 85, 0.7);
  border-color: rgba(96, 165, 250, 0.5);
  color: var(--text-light);
}

/* Pages content */
.page-content {
  display: none;
}

.page-content.active {
  display: block;
}

/* To-Do List Styles */
.todo-columns {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.todo-column {
  background: var(--bg-card);
  border: 1px solid rgba(51, 65, 85, 0.5);
  border-radius: 1rem;
  height: 300px;
  display: flex;
  flex-direction: column;
}

.todo-column-tasks {
  flex: 1;
  overflow-y: auto;
  margin-bottom: 1rem;
  padding-right: 0.5rem;
}

/* Scrollbar discret */
.todo-column-tasks::-webkit-scrollbar {
  width: 6px;
}

.todo-column-tasks::-webkit-scrollbar-track {
  background: rgba(51, 65, 85, 0.2);
  border-radius: 3px;
}

.todo-column-tasks::-webkit-scrollbar-thumb {
  background: rgba(96, 165, 250, 0.3);
  border-radius: 3px;
}

.todo-column-tasks::-webkit-scrollbar-thumb:hover {
  background: rgba(96, 165, 250, 0.5);
}

.todo-column-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid rgba(51, 65, 85, 0.5);
}

.todo-column-title {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text-light);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.todo-item {
  background: rgba(51, 65, 85, 0.3);
  border: 1px solid rgba(51, 65, 85, 0.6);
  border-radius: 0.5rem;
  padding: 0.5rem;
  margin-bottom: 0.5rem;
  cursor: default;
  transition: all 0.3s ease;
}

.todo-item:hover {
  background: rgba(51, 65, 85, 0.5);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.todo-item-title {
  font-weight: 600;
  color: var(--text-light);
  margin-bottom: 0;
  font-size: 0.875rem;
}

.todo-item-meta {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  font-size: 0.75rem;
  color: var(--text-gray);
}

.todo-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 0.5rem;
  font-size: 0.75rem;
  font-weight: 600;
}

.badge-propulsion {
  background: rgba(59, 130, 246, 0.2);
  color: #60a5fa;
  border: 1px solid rgba(59, 130, 246, 0.3);
}

.badge-facturation {
  background: rgba(16, 185, 129, 0.2);
  color: #34d399;
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.btn-add-task {
  width: 100%;
  padding: 0.75rem;
  background: rgba(96, 165, 250, 0.1);
  border: 2px dashed rgba(96, 165, 250, 0.3);
  border-radius: 0.75rem;
  color: var(--primary-blue);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-add-task:hover {
  background: rgba(96, 165, 250, 0.2);
  border-color: rgba(96, 165, 250, 0.5);
}

/* Table Styles - Modern Table (from base.css) */
.table-container-rpo {
  border-radius: 16px;
  overflow: hidden;
  background: var(--bg-card);
  box-shadow: var(--shadow-dark);
  border: 1px solid var(--border-dark);
  margin-top: 1rem;
  height: 600px;
  overflow-y: auto;
}

/* Tbody scrollable avec header fixe */
.modern-table tbody {
  display: block;
  overflow-y: visible;
}

.modern-table thead,
.modern-table tbody tr {
  display: table;
  width: 100%;
  table-layout: fixed;
}

/* Scroll bar styling - 3px sur tbody uniquement */
.modern-table tbody::-webkit-scrollbar {
  width: 3px;
}

.modern-table tbody::-webkit-scrollbar-track {
  background: transparent;
}

.modern-table tbody::-webkit-scrollbar-thumb {
  background: rgba(148, 163, 184, 0.5);
  border-radius: 1px;
}

.modern-table tbody::-webkit-scrollbar-thumb:hover {
  background: rgba(148, 163, 184, 0.7);
}

/* Modern Table Styling - Dark Theme */
.modern-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: transparent;
}

.modern-table thead {
  background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
  position: sticky;
  top: 0;
  z-index: 10;
}

.modern-table th {
  padding: 1rem 1.5rem;
  text-align: left;
  font-size: 0.75rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.025em;
  color: var(--text-gray);
  border-bottom: 2px solid var(--border-dark);
  position: sticky;
  top: 0;
  z-index: 10;
  background: #263140;
}

.modern-table th:first-child {
  border-top-left-radius: 12px;
}

.modern-table th:last-child {
  border-top-right-radius: 12px;
}

.modern-table tbody tr {
  border-bottom: 1px solid rgba(51, 65, 85, 0.5);
}

.modern-table tbody tr:hover {
  background: rgba(59, 130, 246, 0.1);
}

.modern-table td {
  padding: 1.25rem 1.5rem;
  font-size: 0.875rem;
  color: var(--text-gray);
  vertical-align: top;
}

.modern-table tbody tr:last-child td:first-child {
  border-bottom-left-radius: 12px;
}

.modern-table tbody tr:last-child td:last-child {
  border-bottom-right-radius: 12px;
}

/* Empty State */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  color: var(--text-gray);
}

/* Empty State dans le tableau seulement */
.modern-table .empty-state {
  height: 550px;
}

.empty-state i {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-state p {
  font-size: 1rem;
  margin: 0;
}

/* Modal Styles */
.modal-header {
  position: sticky;
  top: 0;
  background: var(--bg-card);
  border-bottom: 2px solid rgba(51, 65, 85, 0.5);
  padding: 1.5rem 0;
  margin: 0 0 1rem 0;
  z-index: 10;
}

.modal-body {
  padding: 0rem 0rem;
  overflow-y: auto;
  max-height: calc(90vh - 120px);
}

.modal-footer {
  position: sticky;
  bottom: 0;
  background: var(--bg-card);
  border-top: 2px solid rgba(51, 65, 85, 0.5);
  padding: 1.5rem 0;
  margin: 1rem 0 0 0;
  z-index: 10;
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
}

.modal-footer button {
  width: auto;
  padding: 0.75rem 1.5rem;
}

/* Dashboard Calendar Styles */
.dashboard-calendar-container {
  position: relative;
  width: 100%;
}

.dashboard-date-display {
  width: 100%;
  padding: 0.75rem;
  background: rgba(51, 65, 85, 0.3);
  border: 1px solid rgba(51, 65, 85, 0.6);
  border-radius: 0.5rem;
  color: var(--text-light);
  cursor: pointer;
  padding-right: 2.5rem;
  transition: all 0.2s ease;
}

.dashboard-date-display:hover {
  border-color: rgba(96, 165, 250, 0.5);
}

.dashboard-date-icon {
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-gray);
  cursor: pointer;
  transition: all 0.2s ease;
  z-index: 3;
}

.dashboard-date-icon:hover {
  color: var(--primary-blue);
  transform: translateY(-50%) scale(1.1);
}

.dashboard-calendar {
  position: absolute;
  bottom: 100% !important;
  top: auto !important;
  left: 0;
  right: 0;
  z-index: 1000;
  background: var(--bg-card);
  border: 2px solid rgba(51, 65, 85, 0.5);
  border-radius: 0.5rem;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  margin-bottom: 0.5rem !important;
  margin-top: 0 !important;
  padding: 0.75rem;
  min-width: 280px;
}

.dashboard-calendar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.75rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid rgba(51, 65, 85, 0.5);
}

.dashboard-calendar-title {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--text-light);
  text-align: center;
  flex: 1;
}

.dashboard-calendar-nav {
  background: none;
  border: none;
  color: var(--text-gray);
  cursor: pointer;
  padding: 0.375rem;
  border-radius: 0.25rem;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 1.75rem;
  height: 1.75rem;
}

.dashboard-calendar-nav:hover {
  background: var(--primary-blue);
  color: white;
  transform: scale(1.1);
}

.dashboard-calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.125rem;
  margin-bottom: 0.375rem;
}

.dashboard-calendar-weekdays span {
  text-align: center;
  font-size: 0.625rem;
  font-weight: 600;
  color: var(--text-gray);
  padding: 0.25rem 0;
  text-transform: uppercase;
}

.dashboard-calendar-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.125rem;
}

.dashboard-calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  border-radius: 0.25rem;
  cursor: pointer;
  transition: all 0.2s ease;
  color: var(--text-light);
  background: transparent;
  border: 1px solid transparent;
  min-height: 32px;
}

.dashboard-calendar-day:hover {
  background: var(--primary-blue);
  color: white;
  transform: scale(1.1);
}

.dashboard-calendar-day.selected {
  background: var(--primary-blue);
  color: white;
  font-weight: 600;
  box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3);
}

.dashboard-calendar-day.today {
  background: rgba(96, 165, 250, 0.2);
  border-color: var(--primary-blue);
  font-weight: 600;
}

.dashboard-calendar-day.today:hover {
  background: var(--primary-blue);
  color: white;
}

.dashboard-calendar-day.other-month {
  color: var(--text-gray);
  opacity: 0.4;
}

.dashboard-calendar-day.other-month:hover {
  background: rgba(148, 163, 184, 0.1);
  transform: none;
}

.hidden {
  display: none;
}

/* Disabled textarea styling */
textarea:disabled,
input:disabled,
select:disabled {
  opacity: 0.5 !important;
  cursor: not-allowed !important;
  background: rgba(51, 65, 85, 0.2) !important;
}

/* Read-only table styling */
.table-readonly {
  opacity: 0.7;
  pointer-events: none;
}

/* ================================================================
   RPO - TABLEAU SUIVI HEBDOMADAIRE ENTREPRENEURS (V2 - CLEAN)
   ================================================================ */

/* Scroll container horizontal only */
.rpo-scroll-horizontal {
  width: 100%;
  overflow-x: auto;
  overflow-y: visible;
}

.rpo-scroll-horizontal::-webkit-scrollbar {
  height: 6px;
}

.rpo-scroll-horizontal::-webkit-scrollbar-track {
  background: rgba(148, 163, 184, 0.1);
  border-radius: 3px;
}

.rpo-scroll-horizontal::-webkit-scrollbar-thumb {
  background: rgba(148, 163, 184, 0.4);
  border-radius: 3px;
}

.rpo-scroll-horizontal::-webkit-scrollbar-thumb:hover {
  background: rgba(148, 163, 184, 0.6);
}

/* Table structure */
.rpo-weekly-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  min-width: fit-content;
}

/* Sticky header */
.rpo-table-head {
  position: sticky;
  top: 0;
  background: #0f172a;
  z-index: 20;
}

.rpo-header-row th {
  padding: 12px;
  text-align: left;
  font-weight: 600;
  color: var(--text-light);
  background: #0f172a;
  border-bottom: 2px solid rgba(96, 165, 250, 0.3);
  height: 50px;
  cursor: grab;
  user-select: none;
}

.rpo-header-row th:active {
  cursor: grabbing;
}

/* Sticky date column */
.rpo-col-date {
  position: sticky !important;
  left: 0 !important;
  background: #0f172a !important;
  z-index: 25 !important;
  width: 170px !important;
  min-width: 170px !important;
  max-width: 170px !important;
}

/* Standard columns (170px) */
.rpo-col-standard {
  width: 170px;
  min-width: 170px;
  max-width: 170px;
}

/* Wide columns (prend la largeur disponible) */
.rpo-col-wide {
  width: auto;
  min-width: 200px;
}

/* Table body */
.rpo-table-body tr {
  border-bottom: 1px solid rgba(51, 65, 85, 0.5);
  height: 65px;
}

.rpo-table-body tr:hover {
  background: rgba(59, 130, 246, 0.1) !important;
}

.rpo-table-body td {
  padding: 8px;
  vertical-align: middle;
  height: 65px;
}

/* Sticky date cells in body */
.rpo-table-body td:first-child {
  position: sticky !important;
  left: 0 !important;
  background: #0f172a !important;
  z-index: 15 !important;
}

.rpo-table-body tr:hover td:first-child {
  background: #1e293b !important;
}

/* RPO Dropdowns */
.rpo-dropdown {
  width: 100%;
  height: 48px;
  padding: 10px 12px;
  background: rgba(51, 65, 85, 0.3);
  border: 1px solid rgba(51, 65, 85, 0.6);
  border-radius: 6px;
  font-size: 0.875rem;
  position: relative;
  display: flex;
  align-items: center;
  cursor: pointer;
}

.rpo-dropdown:hover {
  border-color: var(--primary-blue);
  background: rgba(51, 65, 85, 0.5);
}

.rpo-dropdown-text {
  color: var(--text-light);
  flex: 1;
}

.rpo-dropdown-icon {
  color: var(--text-gray);
  font-size: 0.7rem;
  margin-left: auto;
}

.rpo-dropdown.active .rpo-dropdown-icon {
  transform: rotate(180deg);
}

.rpo-dropdown-menu {
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  right: 0;
  background: var(--bg-card);
  border: 2px solid var(--border-dark);
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
  z-index: 100000;
  max-height: 200px;
  overflow-y: auto;
}

.rpo-dropdown-item {
  padding: 10px 12px;
  cursor: pointer;
  color: var(--text-light);
  font-size: 0.875rem;
  border-bottom: 1px solid rgba(71, 85, 105, 0.2);
}

.rpo-dropdown-item:last-child {
  border-bottom: none;
}

.rpo-dropdown-item:hover {
  background: rgba(59, 130, 246, 0.15) !important;
}

/* RPO Textareas */
.rpo-textarea {
  width: 100%;
  height: 48px;
  padding: 10px 12px;
  background: rgba(51, 65, 85, 0.3);
  border: 1px solid rgba(51, 65, 85, 0.6);
  border-radius: 6px;
  color: var(--text-light);
  font-size: 0.875rem;
  resize: none;
  font-family: inherit;
  line-height: 1.4;
}

.rpo-textarea:focus {
  outline: none;
  border-color: var(--primary-blue);
  background: rgba(51, 65, 85, 0.5);
  box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
}

.rpo-textarea::placeholder {
  color: var(--text-gray);
  opacity: 0.6;
}

/* Bouton Enregistrer Global */
.btn-save-all {
  padding: 10px 20px;
  background: var(--primary-blue);
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
  margin-left: 12px;
}

.btn-save-all:hover {
  background: #2563eb;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.btn-save-all:active {
  transform: translateY(0);
}

.btn-save-all:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn-save-all i {
  font-size: 0.875rem;
}

/* Month Filter Dropdown Styles */
.month-filter-option:hover {
  background: rgba(59, 130, 246, 0.15) !important;
}

.rpo-month-filter-dropdown.active .fa-chevron-down {
  transform: rotate(180deg);
}

/* ==================== PLAN D'AFFAIRE STYLES (STATISTIQUES) ==================== */

/* Glass card */
.glass-card {
  background: var(--bg-card);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  box-shadow: var(--shadow-dark-medium);
  border: 1px solid var(--border-dark);
  position: relative;
  overflow: hidden;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.glass-card:hover {
  box-shadow: var(--shadow-dark-strong);
  border-color: var(--border-dark);
}

/* Plan scroll container */
.plan-scroll-container {
  cursor: grab;
  user-select: none;
}

.plan-scroll-container:active {
  cursor: grabbing;
}

.plan-scroll-container::-webkit-scrollbar {
  width: 4px;
  height: 4px;
}

.plan-scroll-container::-webkit-scrollbar-track {
  background: transparent;
}

.plan-scroll-container::-webkit-scrollbar-thumb {
  background: rgba(96, 165, 250, 0.2);
  border-radius: 2px;
}

.plan-scroll-container::-webkit-scrollbar-thumb:hover {
  background: rgba(96, 165, 250, 0.4);
}

/* Plan table */
.plan-table {
  font-size: 0.75rem;
}

/* Headers sticky */
.plan-th-sticky {
  position: sticky;
  z-index: 110;
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  padding: 12px 8px;
  text-align: center;
  font-weight: 600;
  font-size: 0.75rem;
  color: var(--text-light);
  border-bottom: 2px solid var(--border-dark);
  box-shadow: 2px 0 12px rgba(0, 0, 0, 0.5);
  white-space: nowrap;
  min-width: 60px;
}

.plan-th-group {
  padding: 12px 8px;
  text-align: center;
  font-weight: 600;
  font-size: 0.75rem;
  color: var(--text-light);
  border-bottom: 2px solid var(--border-dark);
}

.plan-th-sub {
  padding: 8px 6px;
  text-align: center;
  font-weight: 500;
  font-size: 0.65rem;
  color: var(--text-gray);
  border-bottom: 2px solid var(--border-dark);
  min-width: 80px;
}

.plan-header-cell {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  white-space: nowrap;
}

/* Body cells */
.plan-td {
  padding: 10px 8px;
  text-align: center;
  font-size: 0.75rem;
  color: var(--text-gray);
  border-bottom: 1px solid rgba(30, 41, 59, 0.5);
  transition: background 0.2s ease;
  min-width: 80px;
}

.plan-td:hover {
  background: rgba(96, 165, 250, 0.05);
}

/* Colonnes "Réel" plus larges */
.plan-td-reel {
  min-width: 120px !important;
  font-weight: 600;
}

.plan-td-sticky {
  position: sticky;
  z-index: 10;
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  padding: 10px 8px;
  text-align: center;
  font-size: 0.75rem;
  color: var(--text-light);
  font-weight: 600;
  border-bottom: 1px solid rgba(30, 41, 59, 0.5);
  box-shadow: 2px 0 8px rgba(0, 0, 0, 0.4);
  white-space: nowrap;
  min-width: 60px;
  max-width: 120px;
}

.plan-td-prev {
  font-weight: 500;
  color: rgba(148, 163, 184, 0.7);
}

.plan-row {
  transition: background 0.2s ease;
}

.plan-row:hover {
  background: rgba(96, 165, 250, 0.02);
}

/* Plan footer */
.plan-td-footer {
  padding: 12px 8px;
  text-align: center;
  font-size: 0.8rem;
  font-weight: 700;
  color: var(--text-light);
}

/* Custom select for month filter */
.custom-select {
  position: relative;
  width: 100%;
}

.custom-select-button {
  background: rgba(30, 41, 59, 0.6);
  border: 1px solid var(--border-dark);
  border-radius: 8px;
  padding: 8px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  transition: all 0.2s ease;
  min-height: 40px;
}

.custom-select-button:hover {
  background: rgba(30, 41, 59, 0.8);
  border-color: var(--primary-blue);
}

.custom-select-text {
  color: var(--text-light);
  font-size: 0.875rem;
  font-weight: 500;
}

.custom-select-arrow {
  color: var(--text-gray);
  font-size: 0.75rem;
  transition: transform 0.2s ease;
}

.custom-select-dropdown {
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  right: 0;
  background: var(--bg-card);
  border: 1px solid var(--border-dark);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  max-height: 300px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
}

.custom-select-option {
  padding: 10px 12px;
  cursor: pointer;
  transition: background 0.2s ease;
  font-size: 0.875rem;
  color: var(--text-light);
  border-bottom: 1px solid rgba(51, 65, 85, 0.3);
  border-radius: 0 !important;
}

.custom-select-option:first-child {
  border-radius: 0 !important;
}

.custom-select-option:last-child {
  border-bottom: none;
  border-radius: 0 !important;
}

.custom-select-option:hover {
  background: rgba(96, 165, 250, 0.1);
}

.custom-select-option.selected {
  background: rgba(96, 165, 250, 0.15);
  font-weight: 600;
  color: var(--primary-blue);
}

/* Plan header dropdowns (desktop only) */
.plan-header-dropdowns-desktop {
  display: flex;
}

@media (max-width: 1024px) {
  .plan-header-dropdowns-desktop {
    display: none;
  }
}

/* ========== BOUTON "CRÉER MON PLAN D'AFFAIRES" ========== */
#create-business-plan-btn {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  border: 2px solid rgba(59, 130, 246, 0.3);
  padding: 1.5rem 2rem;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 2rem;
  box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.3);
}

#create-business-plan-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px 0 rgba(59, 130, 246, 0.4);
  border-color: rgba(59, 130, 246, 0.5);
}

#create-business-plan-btn:active {
  transform: translateY(0);
}

/* ========== POPUP CRÉATION PLAN D'AFFAIRES ========== */
#business-plan-popup {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(15, 23, 42, 0.9);
  backdrop-filter: blur(8px);
  z-index: 99999;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  overflow-y: auto;
}

#business-plan-popup.active {
  display: flex;
}

.business-plan-modal {
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 16px;
  max-width: 800px;
  width: 100%;
  max-height: 90vh;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.business-plan-header {
  padding: 2rem;
  border-bottom: 1px solid rgba(59, 130, 246, 0.1);
  position: sticky;
  top: 0;
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  z-index: 10;
}

.business-plan-body {
  padding: 2rem;
  max-height: 60vh;
  overflow-y: auto;
}

.business-plan-section {
  margin-bottom: 2rem;
}

.business-plan-section h3 {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--primary-blue);
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.entrepreneur-input-row {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 1rem;
  margin-bottom: 0.75rem;
  align-items: center;
}

.entrepreneur-label {
  font-size: 0.9rem;
  color: var(--text-gray);
  font-weight: 500;
}

.business-plan-input {
  background: rgba(30, 41, 59, 0.5);
  border: 1px solid var(--border-dark);
  border-radius: 8px;
  padding: 0.75rem 1rem;
  color: var(--text-light);
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.business-plan-input:focus {
  outline: none;
  border-color: var(--primary-blue);
  background: rgba(30, 41, 59, 0.7);
}

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
}

.metric-input-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.metric-input-group label {
  font-size: 0.85rem;
  color: var(--text-gray);
  font-weight: 500;
}

.business-plan-footer {
  padding: 1.5rem 2rem;
  border-top: 1px solid rgba(59, 130, 246, 0.1);
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
  position: sticky;
  bottom: 0;
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
}

/* Scrollbar pour le body du modal */
.business-plan-body::-webkit-scrollbar {
  width: 6px;
}

.business-plan-body::-webkit-scrollbar-track {
  background: rgba(30, 41, 59, 0.3);
  border-radius: 10px;
}

.business-plan-body::-webkit-scrollbar-thumb {
  background: rgba(148, 163, 184, 0.5);
  border-radius: 10px;
}

.business-plan-body::-webkit-scrollbar-thumb:hover {
  background: rgba(148, 163, 184, 0.7);
}

</style>

</head>
<body>

  <!-- Spinner de chargement lors du changement de coach (fullscreen) -->
  <div id="coach-loading-spinner" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0f172a; z-index: 9999; align-items: center; justify-content: center;">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
      <!-- Spinner SVG animé -->
      <svg width="64" height="64" viewBox="0 0 64 64" style="animation: spin 0.8s linear infinite;">
        <circle cx="32" cy="32" r="28" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="6"/>
        <circle cx="32" cy="32" r="28" fill="none" stroke="#3b82f6" stroke-width="6" stroke-dasharray="140" stroke-dashoffset="40" stroke-linecap="round" style="transform-origin: center; transform: rotate(-90deg);"/>
      </svg>
      <div style="margin-top: 16px; font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500; text-align: center;">Chargement du coach...</div>
    </div>
  </div>

  <!-- Sidebar -->
  <aside id="sidebar" data-role="direction" class="sidebar fixed top-0 left-0 z-40 md:translate-x-0 -translate-x-full transition-transform duration-300"></aside>

  <!-- Contenu principal -->
  <main id="main-content" class="pt-20 md:pt-6 w-full" style="width: 100%; padding: 2rem;">

    <!-- Header de la page -->
    <div class="page-header fade-in-up">
      <h1 class="text-4xl font-bold mb-3">
        RPO Direction
        <div class="title-underline"></div>
      </h1>

      <div class="header-content mt-4">
        <p>Gestion du Rapport de Production Opérationnelle</p>
      </div>
    </div>

    <!-- Navigation Onglets -->
    <div class="mb-8 fade-in-up" style="animation-delay: 0.1s; position: relative; z-index: 10000; pointer-events: auto;">
      <div class="tab-spacing" style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; gap: 1rem;">
          <button id="todolist-tab" class="btn-primary">
            <i class="fas fa-tasks"></i>To-Do List
          </button>
          <button id="rpo-tab" class="btn-secondary">
            <i class="fas fa-chart-line"></i>RPO - Direction
          </button>
          <button id="stats-tab" class="btn-secondary">
            <i class="fas fa-chart-bar"></i>Statistiques
          </button>
        </div>

        <!-- Dropdown filtre tâches (visible seulement dans To-Do List) -->
        <div id="tasks-filter-dropdown" style="position: relative; display: none;">
          <div class="dropdown-secondary" id="tasks-filter-toggle" onclick="toggleTasksFilterDropdown()" style="min-width: 180px; cursor: pointer;">
            <span id="tasks-filter-selected">Mes tâches</span>
            <i class="fas fa-chevron-down" style="font-size: 0.75rem; color: var(--text-gray);"></i>
          </div>
          <div class="dropdown-secondary-menu" id="tasks-filter-menu" style="display: none;">
            <div class="dropdown-secondary-option" onclick="selectTasksFilter('my')">
              <i class="fas fa-user" style="margin-right: 0.5rem; color: #3b82f6;"></i>
              <span>Mes tâches</span>
            </div>
            <div class="dropdown-secondary-option" onclick="selectTasksFilter('all')">
              <i class="fas fa-users" style="margin-right: 0.5rem; color: #8b5cf6;"></i>
              <span>Toutes les tâches</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Page To-Do List -->
    <div id="todolist" class="page-content active">

      <!-- 3 Colonnes pour les tâches -->
      <div class="todo-columns">

        <!-- Colonne Urgent -->
        <div class="todo-column">
          <div class="box-header">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div class="box-header-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                <i class="fas fa-exclamation-circle" style=""></i>
              </div>
              <h3 class="box-header-title">Cette semaine</h3>
            </div>
            <span class="todo-badge badge-propulsion" id="urgent-count">0</span>
          </div>
          <div class="box-body" style="flex: 1; overflow-y: auto;">
            <div id="urgent-tasks"></div>
          </div>
        </div>

        <!-- Colonne Important -->
        <div class="todo-column">
          <div class="box-header">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div class="box-header-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <i class="fas fa-star" style=""></i>
              </div>
              <h3 class="box-header-title">Semaine prochaine</h3>
            </div>
            <span class="todo-badge badge-propulsion" id="important-count">0</span>
          </div>
          <div class="box-body" style="flex: 1; overflow-y: auto;">
            <div id="important-tasks"></div>
          </div>
        </div>

        <!-- Colonne Ce qui s'en vient -->
        <div class="todo-column">
          <div class="box-header">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div class="box-header-icon" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);">
                <i class="fas fa-clock" style=""></i>
              </div>
              <h3 class="box-header-title">Ce qui s'en vient</h3>
            </div>
            <span class="todo-badge badge-propulsion" id="upcoming-count">0</span>
          </div>
          <div class="box-body" style="flex: 1; overflow-y: auto;">
            <div id="upcoming-tasks"></div>
          </div>
        </div>

      </div>

      <!-- Tableau Responsabilités & Vision → Objectifs -->
      <div style="background: var(--bg-card); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; margin-top: 2rem;">
        <div class="box-header">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="box-header-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
              <i class="fas fa-table" style=""></i>
            </div>
            <h3 class="box-header-title">Responsabilités & Vision → Objectifs</h3>
          </div>
          <div style="display: flex; gap: 0.75rem;">
            <button class="btn-secondary" onclick="openHistoryModal()" style="display: flex; align-items: center; gap: 0.5rem; white-space: nowrap;">
              <i class="fas fa-history"></i>
              <span>Historique</span>
            </button>
            <button id="add-task-btn" class="btn-primary" onclick="openTaskModal()" style="display: flex; align-items: center; gap: 0.5rem; white-space: nowrap;">
              <i class="fas fa-plus"></i>
              <span>Ajouter une tâche</span>
            </button>
          </div>
        </div>

        <div class="box-body">
          <!-- Barre de recherche et filtres -->
          <div class="search-container" style="display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
            <!-- Champ de recherche -->
            <div style="position: relative; flex: 1; min-width: 250px; max-width: 350px;">
              <i class="fas fa-search" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-gray); font-size: 0.9rem; z-index: 1;"></i>
              <input type="text" id="table-search" placeholder="Rechercher une tâche..." oninput="filterTasks()" class="search-field-input" style="
                width: 100%;
                padding: 12px 16px 12px 42px;
                border: 2px solid var(--border-dark);
                border-radius: 12px;
                background: var(--bg-card);
                color: var(--text-light);
                font-size: 0.9rem;
                min-height: 48px;
                transition: all 0.3s ease;
                outline: none;
              ">
            </div>

            <!-- Dropdown personnalisé pour le tri -->
            <div style="min-width: 240px; position: relative;">
              <div class="dropdown-secondary" id="sort-filter-dropdown" onclick="toggleSortFilterDropdown()" style="width: 100% !important;">
                <span id="sort-filter-selected">Plus récente</span>
                <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 0.75rem; color: var(--text-gray); transition: transform 0.2s ease;"></i>
              </div>
              <div class="dropdown-secondary-menu" id="sort-filter-menu">
                <div class="dropdown-secondary-option selected" onclick="selectSortFilter('recent', 'Plus récente')">Plus récente</div>
                <div class="dropdown-secondary-option" onclick="selectSortFilter('oldest', 'Moins récente')">Moins récente</div>
                <div class="dropdown-secondary-option" onclick="selectSortFilter('title-asc', 'Titre (A-Z)')">Titre (A-Z)</div>
                <div class="dropdown-secondary-option" onclick="selectSortFilter('title-desc', 'Titre (Z-A)')">Titre (Z-A)</div>
                <div class="dropdown-secondary-option" onclick="selectSortFilter('date-asc', 'Date (croissante)')">Date (croissante)</div>
                <div class="dropdown-secondary-option" onclick="selectSortFilter('date-desc', 'Date (décroissante)')">Date (décroissante)</div>
              </div>
              <input type="hidden" id="sort-select" value="recent">
            </div>
          </div>

          <div class="table-container-rpo">
            <table class="modern-table">
              <thead>
                <tr>
                  <th style="width: 20%; text-align: left !important;">Tâches</th>
                  <th style="width: 15%; text-align: left !important;">Attribué à</th>
                  <th style="width: 12%; text-align: left !important;">Catégorie</th>
                  <th style="width: 12%; text-align: left !important;">Date</th>
                  <th style="width: 26%; text-align: left !important;">Détails</th>
                  <th style="width: 15%; text-align: center !important;">Actions</th>
                </tr>
              </thead>
              <tbody id="tasks-table-body">
                <!-- Les tâches seront ajoutées ici dynamiquement -->
              </tbody>
            </table>
          </div>
        </div>

      </div>

    </div>

    <!-- Page RPO - Coach -->
    <div id="rpo" class="page-content">

      <!-- Section MACRO / MICRO / Problème -->
      <div id="resume-section-container" style="background: var(--bg-card); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; margin-bottom: 2rem;">
        <!-- Badge "Cette semaine" -->
        <div id="current-week-badge" style="display: none; margin: 1rem 1rem 0 1rem; padding: 0.75rem 1rem; border-radius: 0.5rem; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: 2px solid rgba(245, 158, 11, 0.3);">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <i class="fas fa-calendar-week" style="color: white; font-size: 1.25rem;"></i>
              <div>
                <div style="color: white; font-weight: 700; font-size: 1rem;">Cette semaine</div>
                <div id="current-week-date-range" style="color: rgba(255, 255, 255, 0.9); font-size: 0.85rem; margin-top: 0.125rem;"></div>
              </div>
            </div>
            <div id="current-week-status" style="color: white; font-weight: 600; font-size: 0.9rem;">
              <i class="fas fa-exclamation-circle"></i>À remplir
            </div>
          </div>
        </div>

        <div class="box-header">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="box-header-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
              <i class="fas fa-clipboard-check"></i>
            </div>
            <h3 class="box-header-title">Résumé hebdomadaire</h3>
          </div>

          <div style="display: flex; align-items: center; gap: 1rem;">
            <!-- Dropdown personnalisé pour la sélection de semaine (MACRO/MICRO/Problème) -->
            <div class="dropdown-secondary" id="resume-week-dropdown" onclick="toggleResumeWeekDropdown()" style="position: relative;">
              <span id="resume-week-dropdown-text">Semaine 1 - 2026</span>
              <i class="fas fa-chevron-down" style="color: var(--text-gray); font-size: 0.75rem;"></i>
              <div class="dropdown-secondary-menu" id="resume-week-dropdown-menu" style="display: none;">
                <!-- Les options seront ajoutées dynamiquement par JavaScript -->
              </div>
            </div>

            <button id="resume-action-btn" onclick="openResumeModal()" class="btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-edit"></i>
              <span>Remplir mon résumé</span>
            </button>
          </div>
        </div>

        <div class="box-body">
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <!-- MACRO -->
            <div>
              <label id="macro-label" style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">
                <i class="fas fa-chart-line"></i>MACRO
              </label>
              <div id="macro-content-display" style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-gray); font-size: 0.875rem; min-height: 6rem; font-style: italic; white-space: pre-wrap;">Aucune donnée</div>
            </div>

            <!-- Plan de match -->
            <div>
              <label id="micro-label" style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">
                <i class="fas fa-tasks"></i>Plan de match
              </label>
              <div id="micro-content-display" style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-gray); font-size: 0.875rem; min-height: 6rem; font-style: italic; white-space: pre-wrap;">Aucune donnée</div>
            </div>

            <!-- Problème de la semaine -->
            <div>
              <label id="problem-label" style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">
                <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>Problème de la semaine
              </label>
              <div id="problem-content-display" style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 65, 0.6); border-radius: 0.5rem; color: var(--text-gray); font-size: 0.875rem; min-height: 6rem; font-style: italic; white-space: pre-wrap;">Aucune donnée</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section MICRO - Tableau hebdomadaire -->
      <div style="background: var(--bg-card); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem;">
        <!-- Titre et dropdown sur la même ligne -->
        <div class="box-header">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="box-header-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
              <i class="fas fa-chalkboard-teacher"></i>
            </div>
            <h3 class="box-header-title">Suivi hebdomadaire des coachs</h3>
          </div>

          <div style="display: flex; align-items: center; gap: 1rem;">
            <!-- Bouton Enregistrer (à gauche) -->
            <button id="save-all-btn" onclick="saveAllEntrepreneurWeeklyData()" class="btn-save-all" style="display: none;">
              <i class="fas fa-save"></i>Enregistrer
            </button>

            <!-- Badge du coach sélectionné avec filtre mois -->
            <div id="selected-coach-badge" style="display: none; position: relative; border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 10px; padding: 0.75rem 1.25rem; align-items: center; gap: 1rem; background: rgba(139, 92, 246, 0.05);">
              <!-- Bulle de chat RPO -->
              <button onclick="openCoachRpoModal(this)" style="position: absolute; top: -10px; left: -10px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: 2px solid rgba(255, 255, 255, 0.9); border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4); transition: all 0.3s ease; z-index: 10;" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 6px 16px rgba(139, 92, 246, 0.6)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.4)'">
                <i class="fas fa-comment-dots" style="color: white; font-size: 0.9rem;"></i>
              </button>
              <!-- Coach Info -->
              <div style="display: flex; align-items: center; gap: 0.5rem; padding-right: 1rem; border-right: 1px solid rgba(139, 92, 246, 0.2);">
                <i class="fas fa-chalkboard-teacher" style="color: #8b5cf6; font-size: 1.1rem;"></i>
                <span style="color: var(--text-gray); font-size: 0.85rem;">Coach:</span>
                <span id="selected-coach-name" style="color: var(--text-light); font-weight: 600; font-size: 0.95rem;"></span>
              </div>

              <!-- Filtre Mois -->
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-calendar-alt" style="color: #3b82f6; font-size: 0.95rem;"></i>
                <span style="color: var(--text-gray); font-size: 0.85rem;">Mois:</span>
                <div class="rpo-month-filter-dropdown" onclick="toggleMonthFilterDropdown()" style="position: relative; cursor: pointer;">
                  <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; background: var(--bg-card); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; padding: 0.4rem 0.75rem; min-width: 140px;">
                    <span id="selected-month-label" style="color: var(--text-light); font-size: 0.9rem; font-weight: 500;">Janvier</span>
                    <i class="fas fa-chevron-down" style="color: var(--text-gray); font-size: 0.75rem; transition: transform 0.2s;"></i>
                  </div>
                  <div id="month-filter-menu" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: #1e293b; border: 1px solid var(--border-light); border-radius: 8px; padding: 0.5rem; min-width: 180px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; max-height: 350px; overflow-y: auto;">
                    <div class="month-filter-option" onclick="selectMonthFilter(event, '01', 'Janvier')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">
                      Janvier
                    </div>
                    <div class="month-filter-option" onclick="selectMonthFilter(event, '02', 'Février')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">
                      Février
                    </div>
                    <div class="month-filter-option" onclick="selectMonthFilter(event, '03', 'Mars')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">
                      Mars
                    </div>
                    <div class="month-filter-option" onclick="selectMonthFilter(event, '04', 'Avril')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">
                      Avril
                    </div>
                    <div class="month-filter-option" onclick="selectMonthFilter(event, '05', 'Mai')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">
                      Mai
                    </div>
                    <div class="month-filter-option" onclick="selectMonthFilter(event, '06', 'Juin')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">
                      Juin
                    </div>
                    <div class="month-filter-option" onclick="selectMonthFilter(event, '07', 'Juillet')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">
                      Juillet
                    </div>
                    <div class="month-filter-option" onclick="selectMonthFilter(event, '08', 'Août')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">
                      Août
                    </div>
                    <div class="month-filter-option" onclick="selectMonthFilter(event, '09', 'Septembre')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">
                      Septembre
                    </div>
                    <div class="month-filter-option" onclick="selectMonthFilter(event, '10', 'Octobre')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">
                      Octobre
                    </div>
                  </div>
                </div>
              </div>

              <!-- Bouton Clear -->
              <button onclick="clearCoachSelection()" style="background: transparent; border: none; color: var(--text-gray); cursor: pointer; padding: 0.35rem; font-size: 1rem; margin-left: 0.25rem;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='var(--text-gray)'">
                <i class="fas fa-times-circle"></i>
              </button>
            </div>

            <!-- Bouton Enregistrer - masqué par défaut -->
            <button id="save-coach-btn" onclick="saveCoachWeeklyData()" class="btn-success" style="display: none; margin-right: 0.5rem;">
              <i class="fas fa-save"></i>Enregistrer les modifications
            </button>

            <!-- Bouton Sélectionner un coach -->
            <button id="suivi-action-btn" onclick="openCoachSelectionModal()" class="btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-user-graduate"></i>
              <span>Sélectionner un coach</span>
            </button>
          </div>
        </div>

        <div class="box-body">
          <!-- Message par défaut quand aucun coach n'est sélectionné -->
          <div id="no-coach-message" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; text-align: center;">
            <i class="fas fa-chalkboard-teacher" style="font-size: 3rem; color: rgba(100, 116, 139, 0.3); margin-bottom: 1rem;"></i>
            <p style="color: var(--text-gray); font-size: 1rem; margin: 0;">Sélectionner un coach pour voir le suivi hebdomadaire</p>
          </div>

          <!-- Tableau RPO Coachs - Version simplifiée -->
          <div id="coach-table-container" class="rpo-scroll-horizontal" style="display: none;">
            <table class="rpo-weekly-table" id="rpo-coach-table">
              <thead class="rpo-table-head">
                <tr class="rpo-header-row">
                  <th class="rpo-col-date" style="vertical-align: middle; border-right: 2px solid rgba(96, 165, 250, 0.3);">Semaine</th>
                  <th class="rpo-col-wide">Notes hebdomadaires</th>
                </tr>
              </thead>
              <tbody id="weekly-coach-table-body" class="rpo-table-body">
                <!-- Les données seront ajoutées ici dynamiquement -->
              </tbody>
            </table>
          </div>
        </div>

      </div>

    </div>

    <!-- Page Statistiques -->
    <div id="stats" class="page-content">

      <!-- Plan d'affaire global de l'équipe -->
      <div id="stats-plan-affaire">
        <div class="glass-card shadow">
          <div class="flex items-center justify-between px-6" style="background: var(--bg-card); border-bottom: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem 1rem 0 0; min-height: 80px;">
            <div class="flex items-center gap-3">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: #10b981; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-calendar-week" style="font-size: 1.5rem; color: white;"></i>
              </div>
              <h3 class="text-2xl font-bold" style="color: var(--text-light);">
                Plan d'affaire - Qualité Étudiant
              </h3>
            </div>
            <!-- Dropdown mois sur desktop -->
            <div class="flex items-center gap-2 plan-header-dropdowns-desktop">
              <div class="custom-select" id="statsMonthSelectorDesktop" style="width: 180px;">
                <div class="custom-select-button">
                  <span class="custom-select-text">Tout l'année</span>
                  <span class="custom-select-arrow">▼</span>
                </div>
                <div class="custom-select-dropdown" style="display: none;">
                  <div class="custom-select-option selected" data-value="all">Tout l'année</div>
                  <div class="custom-select-option" data-value="2026-1">Janvier</div>
                  <div class="custom-select-option" data-value="2026-2">Février</div>
                  <div class="custom-select-option" data-value="2026-3">Mars</div>
                  <div class="custom-select-option" data-value="2026-4">Avril</div>
                  <div class="custom-select-option" data-value="2026-5">Mai</div>
                  <div class="custom-select-option" data-value="2026-6">Juin</div>
                  <div class="custom-select-option" data-value="2026-7">Juillet</div>
                  <div class="custom-select-option" data-value="2026-8">Août</div>
                  <div class="custom-select-option" data-value="2026-9">Septembre</div>
                  <div class="custom-select-option" data-value="2026-10">Octobre</div>
                </div>
              </div>
            </div>
          </div>

          <div class="p-8">
            <!-- Bouton Créer Mon Plan D'Affaires (affiché quand tout est à 0) -->
            <div id="create-business-plan-btn" style="display: none; cursor: pointer; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(96, 165, 250, 0.05)); border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 2rem; transition: all 0.3s ease;" onclick="openBusinessPlanPopup()" onmouseover="this.style.background='linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(96, 165, 250, 0.1))'; this.style.borderColor='rgba(59, 130, 246, 0.5)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(59, 130, 246, 0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(96, 165, 250, 0.05))'; this.style.borderColor='rgba(59, 130, 246, 0.3)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              <div style="display: flex; align-items: center; justify-content: center; gap: 1rem;">
                <div style="background: linear-gradient(135deg, #60a5fa, #3b82f6); width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                  <i class="fas fa-chart-line" style="font-size: 1.7rem; color: white;"></i>
                </div>
                <div style="text-align: left; flex: 1;">
                  <div style="font-size: 1.35rem; font-weight: 700; color: white; margin-bottom: 0.35rem;">
                    Créer mon plan d'affaires
                  </div>
                  <div style="font-size: 0.95rem; color: rgba(203, 213, 225, 0.9);">
                    Définissez les prévisions de votre équipe et les métriques moyennes
                  </div>
                </div>
                <i class="fas fa-arrow-right" style="font-size: 1.3rem; color: var(--primary-blue);"></i>
              </div>
            </div>

            <!-- Moyennes et objectif de l'équipe -->
            <div id="team-metrics-cards" class="mb-6" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
              <!-- Objectif de vente total -->
              <div class="rounded-lg p-4" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark);">
                <div class="text-xs mb-2" style="color: var(--text-gray);">
                  <span>Objectif Vente Équipe</span>
                </div>
                <div id="team-objectif-total" class="text-sm font-semibold" style="color: var(--primary-blue);">
                  <span id="team-objectif-value" style="display: none;">0,00 $</span>
                  <div id="team-objectif-placeholder" style="display: block; color: var(--text-gray); font-size: 0.7rem; font-weight: 400; margin-top: 0.25rem;">
                    <i class="fas fa-exclamation-circle"></i> Non défini
                  </div>
                </div>
              </div>

              <!-- Contrat moyen -->
              <div class="rounded-lg p-4" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark);">
                <div class="text-xs mb-2" style="color: var(--text-gray);">
                  <span>CM Moyen Équipe</span>
                </div>
                <div id="team-cm-avg" class="text-sm font-semibold" style="color: var(--primary-blue);">
                  <span id="coach-cm-value" style="display: none;">0,00 $</span>
                  <div id="coach-cm-placeholder" style="display: block; color: var(--text-gray); font-size: 0.7rem; font-weight: 400; margin-top: 0.25rem;">
                    <i class="fas fa-exclamation-circle"></i> Non défini
                  </div>
                </div>
              </div>

              <!-- Ratio Marketing moyen -->
              <div class="rounded-lg p-4" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark);">
                <div class="text-xs mb-2" style="color: var(--text-gray);">
                  <span>Ratio Marketing Moyen</span>
                </div>
                <div id="team-ratio-mktg-avg" class="text-sm font-semibold" style="color: var(--primary-blue);">
                  <span id="coach-ratio-value" style="display: none;">0%</span>
                  <div id="coach-ratio-placeholder" style="display: block; color: var(--text-gray); font-size: 0.7rem; font-weight: 400; margin-top: 0.25rem;">
                    <i class="fas fa-exclamation-circle"></i> Non défini
                  </div>
                </div>
              </div>

              <!-- Taux de vente moyen -->
              <div class="rounded-lg p-4" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark);">
                <div class="text-xs mb-2" style="color: var(--text-gray);">
                  <span>Taux de Vente Moyen</span>
                </div>
                <div id="team-taux-vente-avg" class="text-sm font-semibold" style="color: var(--primary-blue);">
                  <span id="coach-taux-value" style="display: none;">0%</span>
                  <div id="coach-taux-placeholder" style="display: block; color: var(--text-gray); font-size: 0.7rem; font-weight: 400; margin-top: 0.25rem;">
                    <i class="fas fa-exclamation-circle"></i> Non défini
                  </div>
                </div>
              </div>
            </div>

            <!-- Bouton Modifier Le Plan Complet (affiché quand des données existent) -->
            <div id="edit-business-plan-btn" style="display: none; margin-bottom: 1.5rem; text-align: right;">
              <button onclick="openBusinessPlanPopup()" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: var(--primary-blue); padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 500;" onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'; this.style.borderColor='rgba(59, 130, 246, 0.5)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'; this.style.borderColor='rgba(59, 130, 246, 0.3)'">
                <i class="fas fa-edit"></i>
                <span>Modifier le plan complet</span>
              </button>
            </div>

            <!-- Tableau scrollable -->
            <div class="plan-scroll-container" style="overflow: auto visible; position: relative; border-radius: 14px; border: 1px solid var(--border-dark); cursor: grab; user-select: auto;">
              <table class="plan-table" style="width: 100%; min-width: 2400px; border-collapse: separate; border-spacing: 0;">
                <!-- En-tête sticky -->
                <thead style="position: sticky; top: 0; background: #0f172a;">
                  <!-- Ligne 1: Groupes principaux -->
                  <tr>
                    <th rowspan="2" class="plan-th-sticky" style="left: 0; width: 180px; min-width: 180px; max-width: 180px;">
                      <div class="plan-header-cell">Semaine</div>
                    </th>

                    <!-- H. Marketing -->
                    <th colspan="5" class="plan-th-group" style="background: linear-gradient(135deg, rgba(96, 165, 250, 0.15), rgba(96, 165, 250, 0.05)); border-left: 2px solid rgba(96, 165, 250, 0.3);">
                      <div class="plan-header-cell">
                        <i class="fas fa-bullhorn mr-1"></i>H. Marketing
                      </div>
                    </th>

                    <!-- Estimations -->
                    <th colspan="6" class="plan-th-group" style="background: linear-gradient(135deg, rgba(52, 211, 153, 0.15), rgba(52, 211, 153, 0.05)); border-left: 2px solid rgba(52, 211, 153, 0.3);">
                      <div class="plan-header-cell">
                        <i class="fas fa-file-alt mr-1"></i>Estimations
                      </div>
                    </th>

                    <!-- Contrats -->
                    <th colspan="5" class="plan-th-group" style="background: linear-gradient(135deg, rgba(251, 146, 60, 0.15), rgba(251, 146, 60, 0.05)); border-left: 2px solid rgba(251, 146, 60, 0.3);">
                      <div class="plan-header-cell">
                        <i class="fas fa-handshake mr-1"></i>Contrats
                      </div>
                    </th>

                    <!-- $ Signés -->
                    <th colspan="5" class="plan-th-group" style="background: linear-gradient(135deg, rgba(244, 114, 182, 0.15), rgba(244, 114, 182, 0.05)); border-left: 2px solid rgba(244, 114, 182, 0.3);">
                      <div class="plan-header-cell">
                        <i class="fas fa-dollar-sign mr-1"></i>$ Signés
                      </div>
                    </th>

                    <!-- % Objectif -->
                    <th colspan="3" class="plan-th-group" style="background: linear-gradient(135deg, rgba(167, 139, 250, 0.35), rgba(167, 139, 250, 0.20)); border-left: 2px solid rgba(167, 139, 250, 0.3);">
                      <div class="plan-header-cell" style="font-weight: 800; font-size: 1.05em;">
                        <i class="fas fa-bullseye mr-1"></i>% Objectif
                      </div>
                    </th>

                    <!-- Production -->
                    <th colspan="6" class="plan-th-group" style="background: linear-gradient(135deg, rgba(45, 212, 191, 0.15), rgba(45, 212, 191, 0.05)); border-left: 2px solid rgba(45, 212, 191, 0.3);">
                      <div class="plan-header-cell">
                        <i class="fas fa-cogs mr-1"></i>Production
                      </div>
                    </th>
                  </tr>

                  <!-- Ligne 2: Sous-colonnes -->
                  <tr>
                    <!-- H. Marketing -->
                    <th class="plan-th-sub" style="background: rgba(96, 165, 250, 0.08); min-width: 110px;">Objectif</th>
                    <th class="plan-th-sub" style="background: rgba(96, 165, 250, 0.08); min-width: 140px;">Réel</th>
                    <th class="plan-th-sub" style="background: rgba(96, 165, 250, 0.08); min-width: 110px;">Cumul Obj.</th>
                    <th class="plan-th-sub" style="background: rgba(96, 165, 250, 0.08); min-width: 110px;">Cumul Réel</th>
                    <th class="plan-th-sub" style="background: rgba(96, 165, 250, 0.08); min-width: 110px;">Tendance</th>
                    <!-- Estimations -->
                    <th class="plan-th-sub" style="background: rgba(52, 211, 153, 0.08); min-width: 110px;">Objectif</th>
                    <th class="plan-th-sub" style="background: rgba(52, 211, 153, 0.08); min-width: 140px;">Réel</th>
                    <th class="plan-th-sub" style="background: rgba(52, 211, 153, 0.08); min-width: 110px;">Cumul Obj.</th>
                    <th class="plan-th-sub" style="background: rgba(52, 211, 153, 0.08); min-width: 110px;">Cumul Réel</th>
                    <th class="plan-th-sub" style="background: rgba(52, 211, 153, 0.08); min-width: 110px;">Tendance</th>
                    <th class="plan-th-sub" style="background: rgba(52, 211, 153, 0.08); min-width: 110px;">Ratio Mktg</th>
                    <!-- Contrats -->
                    <th class="plan-th-sub" style="background: rgba(251, 146, 60, 0.08); min-width: 110px;">Objectif</th>
                    <th class="plan-th-sub" style="background: rgba(251, 146, 60, 0.08); min-width: 140px;">Réel</th>
                    <th class="plan-th-sub" style="background: rgba(251, 146, 60, 0.08); min-width: 110px;">Cumul Obj.</th>
                    <th class="plan-th-sub" style="background: rgba(251, 146, 60, 0.08); min-width: 110px;">Cumul Réel</th>
                    <th class="plan-th-sub" style="background: rgba(251, 146, 60, 0.08); min-width: 110px;">Tendance</th>
                    <!-- $ Signés -->
                    <th class="plan-th-sub" style="background: rgba(244, 114, 182, 0.08); min-width: 110px;">Objectif</th>
                    <th class="plan-th-sub" style="background: rgba(244, 114, 182, 0.08); min-width: 140px;">Réel</th>
                    <th class="plan-th-sub" style="background: rgba(244, 114, 182, 0.08); min-width: 110px;">Cumul Obj.</th>
                    <th class="plan-th-sub" style="background: rgba(244, 114, 182, 0.08); min-width: 110px;">Cumul Réel</th>
                    <th class="plan-th-sub" style="background: rgba(244, 114, 182, 0.08); min-width: 110px;">Tendance</th>
                    <!-- % Objectif -->
                    <th class="plan-th-sub" style="background: rgba(167, 139, 250, 0.25); font-weight: 700; min-width: 110px;">Sem.</th>
                    <th class="plan-th-sub" style="background: rgba(167, 139, 250, 0.25); font-weight: 700; min-width: 110px;">Cumul</th>
                    <th class="plan-th-sub" style="background: rgba(167, 139, 250, 0.25); font-weight: 700; min-width: 110px;">TV %</th>
                    <!-- Production -->
                    <th class="plan-th-sub" style="background: rgba(45, 212, 191, 0.08); min-width: 110px;">Objectif</th>
                    <th class="plan-th-sub" style="background: rgba(45, 212, 191, 0.08); min-width: 140px;">Réel</th>
                    <th class="plan-th-sub" style="background: rgba(45, 212, 191, 0.08); min-width: 110px;">Cumul Obj.</th>
                    <th class="plan-th-sub" style="background: rgba(45, 212, 191, 0.08); min-width: 110px;">Cumul Réel</th>
                    <th class="plan-th-sub" style="background: rgba(45, 212, 191, 0.08); min-width: 110px;">Tendance</th>
                    <th class="plan-th-sub" style="background: rgba(45, 212, 191, 0.08); min-width: 110px;">%</th>
                  </tr>
                </thead>

                <!-- Corps du tableau -->
                <tbody id="stats-plan-weeks-body">
                  <!-- Les lignes seront générées dynamiquement -->
                </tbody>

                <!-- Footer avec totaux -->
                <tfoot style="position: sticky; bottom: 0; background: #0f172a; z-index: 100;">
                  <tr style="border-top: 3px solid var(--primary-blue);">
                    <td class="plan-td-sticky" style="font-weight: 700; font-size: 0.85rem; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); left: 0;">TOTAL</td>

                    <!-- H. Marketing Totaux -->
                    <td class="plan-td plan-td-footer" style="background: rgba(96, 165, 250, 0.08);"><span id="total-mktg-prev">0 h</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(96, 165, 250, 0.12);"><span id="total-mktg-reel">0 h</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(96, 165, 250, 0.08);">-</td>
                    <td class="plan-td plan-td-footer" style="background: rgba(96, 165, 250, 0.08);"><span id="total-mktg-cumul">0 h</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(96, 165, 250, 0.08);">-</td>

                    <!-- Estimations Totaux -->
                    <td class="plan-td plan-td-footer" style="background: rgba(52, 211, 153, 0.08);"><span id="total-estim-prev">0</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(52, 211, 153, 0.12);"><span id="total-estim-reel">0</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(52, 211, 153, 0.08);">-</td>
                    <td class="plan-td plan-td-footer" style="background: rgba(52, 211, 153, 0.08);"><span id="total-estim-cumul">0</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(52, 211, 153, 0.08);">-</td>
                    <td class="plan-td plan-td-footer" style="background: rgba(52, 211, 153, 0.05);"><span id="total-ratio">0.00</span></td>

                    <!-- Contrats Totaux -->
                    <td class="plan-td plan-td-footer" style="background: rgba(251, 146, 60, 0.08);"><span id="total-contrat-prev">0</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(251, 146, 60, 0.12);"><span id="total-contrat-reel">0</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(251, 146, 60, 0.08);">-</td>
                    <td class="plan-td plan-td-footer" style="background: rgba(251, 146, 60, 0.08);"><span id="total-contrat-cumul">0</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(251, 146, 60, 0.08);">-</td>

                    <!-- $ Signés Totaux -->
                    <td class="plan-td plan-td-footer" style="background: rgba(244, 114, 182, 0.08);"><span id="total-dollar-prev">0 $</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(244, 114, 182, 0.12);"><span id="total-dollar-reel">0 $</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(244, 114, 182, 0.08);">-</td>
                    <td class="plan-td plan-td-footer" style="background: rgba(244, 114, 182, 0.08);"><span id="total-dollar-cumul">0 $</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(244, 114, 182, 0.08);">-</td>

                    <!-- % Objectif -->
                    <td class="plan-td plan-td-footer" style="background: rgba(167, 139, 250, 0.18);"><span id="total-pct-sem">0.0%</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(167, 139, 250, 0.12);"><span id="total-pct-cumul">0.00%</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(167, 139, 250, 0.18);">-</td>

                    <!-- Production Totaux -->
                    <td class="plan-td plan-td-footer" style="background: rgba(45, 212, 191, 0.08);"><span id="total-prod-vise">0 $</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(45, 212, 191, 0.12);"><span id="total-prod-reel">0 $</span></td>
                    <td class="plan-td plan-td-footer" style="background: rgba(45, 212, 191, 0.08);">-</td>
                    <td class="plan-td plan-td-footer" style="background: rgba(45, 212, 191, 0.08);">-</td>
                    <td class="plan-td plan-td-footer" style="background: rgba(45, 212, 191, 0.08);">-</td>
                    <td class="plan-td plan-td-footer" style="background: rgba(45, 212, 191, 0.08);"><span id="total-prod-pct">0%</span></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>

  </main>

  <!-- Modal pour créer/modifier une tâche -->
  <div id="task-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 99999; align-items: center; justify-content: center;">
    <div style="background: var(--bg-card); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; padding: 0rem 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; height: 85vh;">

      <!-- Header Sticky -->
      <div class="modal-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h3 class="text-2xl font-bold" style="color: var(--text-light);">
            <i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i><span id="modal-title">Nouvelle tâche</span>
          </h3>
          <button onclick="closeTaskModal()" style="color: var(--text-gray); font-size: 1.5rem; cursor: pointer; background: none; border: none;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <!-- Body Scrollable -->
      <div class="modal-body">
        <form id="task-form" onsubmit="saveTask(event)">

          <div style="margin-bottom: 1rem; margin-top: 1rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-heading" style="margin-right: 0.5rem;"></i>Titre de la tâche
            </label>
            <input type="text" id="task-title" required
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light);"
              placeholder="Ex: Réserver le chalet">
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-users" style="margin-right: 0.5rem;"></i>Attribué à
            </label>

            <!-- Dropdown -->
            <div style="position: relative;">
              <div class="dropdown-secondary" id="task-assignee-toggle" onclick="toggleAssigneeDropdown()" style="width: 100% !important; flex-wrap: nowrap; gap: 0.5rem; height: 50px; padding: 0.5rem 0.75rem; background: #172033 !important; overflow: hidden;">
                <!-- Selected users display (inside toggle) -->
                <div id="selected-users-container" style="display: flex; flex-wrap: nowrap; gap: 0.35rem; flex: 1; min-width: 0; overflow-x: auto; overflow-y: hidden; scrollbar-width: thin; scrollbar-color: rgba(148, 163, 184, 0.3) transparent; align-items: center; max-height: 100%;">
                  <span id="assignee-placeholder" style="color: var(--text-gray);">Sélectionner des personnes...</span>
                </div>
                <i class="fas fa-chevron-down" style="flex-shrink: 0; font-size: 0.75rem; color: var(--text-gray); transition: transform 0.2s ease;"></i>
              </div>

              <div class="dropdown-secondary-menu" id="task-assignee-menu" style="max-height: 400px; overflow-y: auto;">

                <!-- Search input -->
                <div style="padding: 0.75rem; border-bottom: 1px solid rgba(51, 65, 85, 0.6); position: sticky; top: 0; background: #172033 !important; z-index: 1;">
                  <input type="text" id="assignee-search" placeholder="Rechercher..."
                    style="width: 100%; padding: 0.5rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.375rem; color: var(--text-light);">
                </div>

                <!-- Users list -->
                <div id="assignee-users-list">
                  <!-- Users will be loaded here -->
                  <div style="text-align: center; padding: 2rem; color: var(--text-gray);">
                    <i class="fas fa-spinner fa-spin"></i> Chargement...
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-tag" style="margin-right: 0.5rem;"></i>Catégorie
            </label>
            <input type="text" id="task-category"
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light);"
              placeholder="Ex: Propulsion, Facturation, Marketing...">
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-calendar" style="margin-right: 0.5rem;"></i>Date de fin
            </label>
            <div class="dashboard-calendar-container">
              <input type="text" id="task-date" class="dashboard-date-display" readonly placeholder="Sélectionner une date" onclick="openTaskCalendar()">
              <i class="fas fa-calendar dashboard-date-icon" onclick="toggleTaskCalendar()"></i>
              <div class="dashboard-calendar hidden" id="taskCalendar">
                <div class="dashboard-calendar-header">
                  <button type="button" class="dashboard-calendar-nav" onclick="changeTaskMonth(-1)">
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <span class="dashboard-calendar-title" id="taskCalendarTitle">Mars 2024</span>
                  <button type="button" class="dashboard-calendar-nav" onclick="changeTaskMonth(1)">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
                <div class="dashboard-calendar-weekdays">
                  <span>Dim</span><span>Lun</span><span>Mar</span><span>Mer</span><span>Jeu</span><span>Ven</span><span>Sam</span>
                </div>
                <div class="dashboard-calendar-days" id="taskCalendarDays"></div>
              </div>
            </div>
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-align-left" style="margin-right: 0.5rem;"></i>Détails
            </label>
            <textarea id="task-details" rows="3"
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light); resize: none;"
              placeholder="Détails de la tâche..."></textarea>
          </div>

          <input type="hidden" id="task-id">

        </form>
      </div>

      <!-- Footer Sticky -->
      <div class="modal-footer">
        <button type="button" onclick="closeTaskModal()" class="btn-secondary">
          <i class="fas fa-times" style="margin-right: 0.5rem;"></i>Annuler
        </button>
        <button type="submit" form="task-form" class="btn-primary">
          <i class="fas fa-save" style="margin-right: 0.5rem;"></i>Enregistrer
        </button>
      </div>

    </div>
  </div>

  <!-- Modal RPO Complet Coach -->
  <div id="coach-rpo-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-card); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; padding: 0; max-width: 98%; width: 1400px; max-height: 95vh; overflow: hidden; display: flex; flex-direction: column;">

      <!-- Header avec bouton fermer -->
      <div style="padding: 1.5rem 2rem; border-bottom: 2px solid rgba(139, 92, 246, 0.3); background: rgba(15, 23, 42, 0.8); display: flex; justify-content: space-between; align-items: center;">
        <h2 id="coach-rpo-modal-title" style="color: var(--text-light); font-size: 1.5rem; font-weight: 700; margin: 0;">
          <i class="fas fa-chalkboard-teacher" style="color: #8b5cf6;"></i>
          RPO Coach - <span id="coach-rpo-name"></span>
        </h2>
        <button onclick="closeCoachRpoModal()" style="background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 1.5rem; padding: 0; width: 2rem; height: 2rem;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Contenu du modal -->
      <div style="padding: 1rem 1.5rem; overflow-y: auto; flex: 1; display: flex; flex-direction: column;">
        <!-- Section MACRO/MICRO/PROBLÈME (Compact) -->
        <div style="background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <h3 style="color: var(--text-light); font-size: 1rem; font-weight: 600; margin: 0;">
              <i class="fas fa-bullseye" style="color: #8b5cf6;"></i> Résumé Hebdomadaire
            </h3>

            <!-- Sélecteur de semaine -->
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span id="coach-current-week-badge" style="display: none; background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.15)); border: 1px solid #fbbf24; border-radius: 6px; padding: 0.25rem 0.5rem; color: #fbbf24; font-size: 0.75rem; font-weight: 600; white-space: nowrap;">
                Semaine actuelle
              </span>
              <div style="position: relative;">
                <button id="coach-week-selector-btn" onclick="toggleCoachWeekDropdown()" class="dropdown-secondary" style="min-width: 160px;">
                  <span id="coach-selected-week-text">Sélectionner une semaine</span>
                  <i class="fas fa-chevron-down"></i>
                </button>
                <div id="coach-week-dropdown" class="dropdown-secondary-menu" style="min-width: 160px;">
                  <!-- Options de semaines générées par JS -->
                </div>
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
            <!-- MACRO -->
            <div>
              <label style="display: block; color: var(--text-light); margin-bottom: 0.3rem; font-weight: 600; font-size: 0.75rem;">
                <i class="fas fa-mountain" style="color: #10b981;"></i> MACRO
              </label>
              <div id="coach-macro-display" style="background: var(--bg-dark); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 6px; padding: 0.5rem; color: var(--text-gray); min-height: 40px; font-size: 0.85rem; max-height: 60px; overflow-y: auto;">
                -
              </div>
            </div>

            <!-- Plan de la semaine -->
            <div>
              <label style="display: block; color: var(--text-light); margin-bottom: 0.3rem; font-weight: 600; font-size: 0.75rem;">
                <i class="fas fa-tasks" style="color: #3b82f6;"></i> Plan de la semaine
              </label>
              <div id="coach-micro-display" style="background: var(--bg-dark); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 6px; padding: 0.5rem; color: var(--text-gray); min-height: 40px; font-size: 0.85rem; max-height: 60px; overflow-y: auto;">
                -
              </div>
            </div>

            <!-- Problème de la semaine -->
            <div>
              <label style="display: block; color: var(--text-light); margin-bottom: 0.3rem; font-weight: 600; font-size: 0.75rem;">
                <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Problème de la semaine
              </label>
              <div id="coach-problem-display" style="background: var(--bg-dark); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 6px; padding: 0.5rem; color: var(--text-gray); min-height: 40px; font-size: 0.85rem; max-height: 60px; overflow-y: auto;">
                -
              </div>
            </div>
          </div>
        </div>

        <!-- Tableau de suivi des entrepreneurs -->
        <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <h3 style="color: var(--text-light); font-size: 1rem; font-weight: 600; margin: 0;">
              <i class="fas fa-users" style="color: #60a5fa;"></i> Suivi des Entrepreneurs
            </h3>
            <!-- Filtre entrepreneur -->
            <div style="position: relative;">
              <button id="coach-entrepreneur-filter-btn" onclick="toggleCoachEntrepreneurFilter()" class="dropdown-secondary">
                <span id="coach-entrepreneur-filter-text">Tous les entrepreneurs</span>
                <i class="fas fa-chevron-down"></i>
              </button>
              <div id="coach-entrepreneur-filter-dropdown" class="dropdown-secondary-menu">
                <!-- Options générées par JS -->
              </div>
            </div>
          </div>
          <div id="coach-entrepreneurs-table" style="overflow-x: auto; flex: 1;">
            <!-- Tableau généré par JS -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal RPO Complet Entrepreneur - Vide -->
  <div id="rpo-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-card); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; padding: 0; max-width: 98%; width: 1550px; max-height: 95vh; overflow: hidden; display: flex; flex-direction: column;">

      <!-- Header avec bouton fermer -->
      <div style="padding: 1.5rem 2rem; border-bottom: 2px solid rgba(96, 165, 250, 0.3); background: rgba(15, 23, 42, 0.8); display: flex; justify-content: space-between; align-items: center;">
        <h2 id="rpo-modal-title" style="color: var(--text-light); font-size: 1.5rem; font-weight: 700; margin: 0;">
          <i class="fas fa-chart-line" style="color: #60a5fa;"></i>
          RPO - <span id="entrepreneur-name-display"></span>
        </h2>
        <button onclick="closeRpoModal()" style="color: var(--text-gray); font-size: 1.5rem; cursor: pointer; background: none; border: none; transition: color 0.2s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='var(--text-gray)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Body avec section hebdomadaire -->
      <div id="rpo-modal-table-container" style="padding: 0; overflow-y: auto; flex: 1; background: var(--bg-card);">

        <!-- Section hebdomadaire complète (copie de rpo.html) -->
        <div id="weekly-section-container-modal" class="flex flex-col" style="border: 1px solid rgba(51, 65, 85, 0.5); overflow: hidden; margin: 0;">

          <!-- Header avec titre, dropdown mois et boutons -->
          <div class="flex items-center justify-between px-6" style="background: var(--bg-card); border-radius: 1rem 1rem 0 0; min-height: 80px; border-bottom: 1px solid rgba(51, 65, 85, 0.5);">
            <div class="flex items-center gap-3">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: #06b6d4; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-calendar-week" style="font-size: 1.5rem; color: white;"></i>
              </div>
              <h3 class="text-2xl font-bold" style="color: var(--text-light);">
                <span id="currentMonthLabel-modal">Objectifs et résultats hebdomadaires - Janvier 2026</span>
              </h3>
            </div>
            <div class="flex items-center gap-3">
              <div class="dropdown-with-label">
                <label class="dropdown-label">Mois</label>
                <div class="custom-select" id="monthSelector-modal" style="width: 180px; position: relative;">
                  <div class="custom-select-button" style="position: relative; cursor: pointer;" onclick="toggleModalMonthDropdown(event)">
                    <span class="custom-select-text" id="monthSelector-modal-text" style="pointer-events: none;">Janvier 2026</span>
                    <span class="custom-select-arrow" style="pointer-events: none;">▼</span>
                  </div>
                  <div id="monthSelector-modal-dropdown" style="position: absolute !important; z-index: 100001 !important; display: none; min-width: 180px; background: var(--bg-card); border: 1px solid rgba(51, 65, 85, 0.8); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); max-height: 200px; overflow-y: auto; overflow-x: hidden;">
                    <!-- Les options seront remplies dynamiquement par populateModalMonthDropdown() -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Contenu -->
          <div class="p-6" style="background: var(--bg-card);">

            <!-- Boutons de navigation -->
            <div class="flex items-center justify-between mb-6">
              <div class="tab-spacing">
                <button id="objectifsBtn-modal" class="btn-primary" style="padding: 4px 12px !important; font-size: 0.875rem !important;">
                  Objectifs de la semaine
                </button>
                <button id="resumeBtn-modal" class="btn-secondary" style="padding: 4px 12px !important; font-size: 0.875rem !important;">
                  Résumé de la semaine
                </button>
              </div>
            </div>

            <!-- Grille des semaines - Objectifs -->
            <div id="objectifsTable-modal" class="overflow-x-auto">
              <p style="color: var(--text-gray); text-align: center; padding: 2rem;">
                Chargement des données...
              </p>
            </div>

            <!-- Grille des semaines - Résumé -->
            <div id="resumeTable-modal" class="overflow-x-auto hidden">
              <p style="color: var(--text-gray); text-align: center; padding: 2rem;">
                Chargement des données...
              </p>
            </div>

          </div>
        </div>

      </div>

    </div>
  </div>

  <!-- Modal pour ajouter/modifier une entrée hebdomadaire entrepreneur -->
  <div id="entrepreneur-weekly-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 99999; align-items: center; justify-content: center;">
    <div style="background: var(--bg-card); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; padding: 0rem 2rem; max-width: 800px; width: 90%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">

      <!-- Header Sticky -->
      <div class="modal-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h3 class="text-2xl font-bold" style="color: var(--text-light);">
            <i class="fas fa-user-edit"></i><span id="modal-entrepreneur-title">Nouvelle entrée hebdomadaire</span>
          </h3>
          <button onclick="closeEntrepreneurWeeklyModal()" style="color: var(--text-gray); font-size: 1.5rem; cursor: pointer; background: none; border: none;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <!-- Body Scrollable -->
      <div class="modal-body">
        <form id="entrepreneur-weekly-form" onsubmit="saveEntrepreneurWeekly(event)">

          <!-- Date -->
          <div style="margin-bottom: 1rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-calendar"></i>Date
            </label>
            <input type="date" id="ew-date" required
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light);">
          </div>

          <!-- Atteint son objectif -->
          <div style="margin-bottom: 1rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-bullseye"></i>Atteint son objectif?
            </label>
            <select id="ew-objectif"
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light);">
              <option value="Oui">Oui</option>
              <option value="Non">Non</option>
              <option value="Partiellement">Partiellement</option>
            </select>
          </div>

          <!-- Problème de la semaine -->
          <div style="margin-bottom: 1rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-exclamation-circle"></i>Problème de la semaine
            </label>
            <textarea id="ew-probleme" rows="2"
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light); resize: vertical;"
              placeholder="Ex: Manque de leads qualifiés"></textarea>
          </div>

          <!-- Racine du problème -->
          <div style="margin-bottom: 1rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-search"></i>Racine du problème
            </label>
            <textarea id="ew-racine" rows="2"
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light); resize: vertical;"
              placeholder="Ex: Manque de prospection régulière"></textarea>
          </div>

          <!-- Source du problème -->
          <div style="margin-bottom: 1rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-project-diagram"></i>Source du problème
            </label>
            <input type="text" id="ew-source"
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light);"
              placeholder="Ex: ENGAGEMENT, CONFIANCE, COMPÉTENCE, PARESSE">
          </div>

          <!-- Type de coaching -->
          <div style="margin-bottom: 1rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-chalkboard-teacher"></i>Type de coaching
            </label>
            <select id="ew-coaching"
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light);">
              <option value="Directif">Directif</option>
              <option value="Coaching">Coaching</option>
              <option value="Support">Support</option>
              <option value="Directif/Coaching">Directif/Coaching</option>
              <option value="Coaching/Support">Coaching/Support</option>
            </select>
          </div>

          <!-- Plan de match cette semaine -->
          <div style="margin-bottom: 1rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-tasks"></i>Plan de match cette semaine
            </label>
            <textarea id="ew-plan" rows="3"
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light); resize: vertical;"
              placeholder="Actions concrètes pour la semaine..."></textarea>
          </div>

          <input type="hidden" id="ew-id">

        </form>
      </div>

      <!-- Footer Sticky -->
      <div class="modal-footer">
        <button type="button" onclick="closeEntrepreneurWeeklyModal()" class="btn-secondary">
          <i class="fas fa-times"></i>Annuler
        </button>
        <button type="submit" form="entrepreneur-weekly-form" class="btn-primary">
          <i class="fas fa-save"></i>Enregistrer
        </button>
      </div>

    </div>
  </div>

  <!-- Modal pour remplir le résumé hebdomadaire (MACRO/MICRO/Problème) -->
  <div id="resume-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 99999; align-items: center; justify-content: center;">
    <div style="background: var(--bg-card); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; padding: 0rem 2rem; max-width: 700px; width: 90%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">

      <!-- Header Sticky -->
      <div class="modal-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h3 class="text-2xl font-bold" style="color: var(--text-light); display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-clipboard-check" style="color: #10b981;"></i>Remplir mon résumé hebdomadaire
          </h3>
          <button onclick="closeResumeModal()" style="color: var(--text-gray); font-size: 1.5rem; cursor: pointer; background: none; border: none;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <!-- Body Scrollable -->
      <div class="modal-body">
        <form id="resume-form" onsubmit="saveResumeData(event)">

          <!-- MACRO -->
          <div style="margin-bottom: 1.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-chart-line" style="color: #10b981;"></i>MACRO
            </label>
            <textarea id="modal-macro-content" rows="4"
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light); resize: none;"
              placeholder="Décrivez vos objectifs macro pour cette semaine..."></textarea>
          </div>

          <!-- Plan de match -->
          <div style="margin-bottom: 1.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-tasks" style="color: #3b82f6;"></i>Plan de match
            </label>
            <textarea id="modal-micro-content" rows="4"
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light); resize: none;"
              placeholder="Décrivez votre plan de match pour cette semaine..."></textarea>
          </div>

          <!-- Problème de la semaine -->
          <div style="margin-bottom: 1.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>Problème de la semaine
            </label>
            <textarea id="modal-problem-content" rows="4"
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light); resize: none;"
              placeholder="Décrivez les problèmes rencontrés cette semaine..."></textarea>
          </div>

        </form>
      </div>

      <!-- Footer Sticky -->
      <div class="modal-footer">
        <button type="button" onclick="closeResumeModal()" class="btn-secondary">
          <i class="fas fa-times"></i>Annuler
        </button>
        <button type="submit" form="resume-form" class="btn-primary">
          <i class="fas fa-save"></i>Enregistrer
        </button>
      </div>

    </div>
  </div>

  <!-- Modal Sélection Coach -->
  <div id="coach-selection-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 99999; align-items: center; justify-content: center;">
    <div style="background: var(--bg-card); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; padding: 2rem; max-width: 500px; width: 90%; max-height: 70vh; overflow: hidden; display: flex; flex-direction: column;">

      <!-- Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 style="color: var(--text-light); margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-chalkboard-teacher" style="color: #8b5cf6;"></i>
          Sélectionner un coach
        </h3>
        <button onclick="closeCoachSelectionModal()" style="color: var(--text-gray); font-size: 1.5rem; cursor: pointer; background: none; border: none;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Body -->
      <div style="overflow-y: auto; flex: 1;">
        <div id="coach-selection-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
          <!-- Les coachs seront ajoutés ici -->
        </div>

        <!-- Message si aucun coach -->
        <div id="no-coach-selection-message" style="display: none; text-align: center; padding: 2rem; color: var(--text-gray);">
          <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
          <p style="margin: 0; font-style: italic;">Aucun coach disponible</p>
        </div>
      </div>

    </div>
  </div>

  <!-- Modal Suivi Entrepreneur -->
  <div id="suivi-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 99999; align-items: center; justify-content: center;">
    <div style="background: var(--bg-card); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; padding: 0rem 2rem; max-width: 800px; width: 90%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">

      <!-- Header Sticky -->
      <div class="modal-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h3 class="text-2xl font-bold" style="color: var(--text-light);">
            <i class="fas fa-user-check" style="color: #10b981;"></i>Suivi de <span id="suivi-entrepreneur-name"></span>
          </h3>
          <button onclick="closeSuiviModal()" style="color: var(--text-gray); font-size: 1.5rem; cursor: pointer; background: none; border: none;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <!-- Body Scrollable -->
      <div class="modal-body">

        <!-- Données RPO de l'entrepreneur -->
        <div id="entrepreneur-rpo-data" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1.5rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
            <i class="fas fa-chart-line" style="color: #10b981;"></i>
            <h4 style="color: var(--text-light); margin: 0; font-weight: 600; font-size: 1rem;">RPO de l'entrepreneur cette semaine</h4>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <!-- H de Marketing -->
            <div style="background: rgba(23, 32, 51, 0.5); padding: 0.75rem; border-radius: 0.5rem;">
              <div style="color: var(--text-gray); font-size: 0.75rem; margin-bottom: 0.25rem;">H de Marketing</div>
              <div id="rpo-h-marketing" style="color: var(--text-light); font-weight: 600; font-size: 1.1rem;">-</div>
            </div>

            <!-- Estimations -->
            <div style="background: rgba(23, 32, 51, 0.5); padding: 0.75rem; border-radius: 0.5rem;">
              <div style="color: var(--text-gray); font-size: 0.75rem; margin-bottom: 0.25rem;">Estimations</div>
              <div id="rpo-estimation" style="color: var(--text-light); font-weight: 600; font-size: 1.1rem;">0</div>
            </div>

            <!-- Contrats -->
            <div style="background: rgba(23, 32, 51, 0.5); padding: 0.75rem; border-radius: 0.5rem;">
              <div style="color: var(--text-gray); font-size: 0.75rem; margin-bottom: 0.25rem;">Contrats</div>
              <div id="rpo-contract" style="color: var(--text-light); font-weight: 600; font-size: 1.1rem;">0</div>
            </div>

            <!-- $ Vendu -->
            <div style="background: rgba(23, 32, 51, 0.5); padding: 0.75rem; border-radius: 0.5rem;">
              <div style="color: var(--text-gray); font-size: 0.75rem; margin-bottom: 0.25rem;">$ Vendu</div>
              <div id="rpo-dollar" style="color: var(--text-light); font-weight: 600; font-size: 1.1rem;">0 $</div>
            </div>
          </div>

          <!-- Commentaire (Problème et Focus) -->
          <div style="margin-top: 1rem; background: rgba(23, 32, 51, 0.5); padding: 0.75rem; border-radius: 0.5rem;">
            <div style="color: var(--text-gray); font-size: 0.75rem; margin-bottom: 0.5rem;">Commentaire de l'entrepreneur</div>
            <div id="rpo-commentaire" style="color: var(--text-light); font-size: 0.9rem; line-height: 1.5;">-</div>
          </div>
        </div>

        <form id="suivi-form" onsubmit="saveSuiviData(event)">

          <!-- Objectifs -->
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 1rem; font-weight: 600; font-size: 1.1rem;">
              <i class="fas fa-bullseye" style="color: #10b981;"></i>Objectifs
            </label>

            <!-- HPAP -->
            <div style="margin-bottom: 1rem; position: relative;">
              <label style="display: block; color: var(--text-gray); margin-bottom: 0.5rem; font-size: 0.9rem;">
                HPAP
              </label>
              <input type="hidden" id="suivi-objectif-hpap" value="">
              <div class="dropdown-secondary" id="objectif-hpap-dropdown" onclick="toggleObjectifHpapDropdown()" style="width: 100% !important; background: #172033 !important;">
                <span id="objectif-hpap-selected">-</span>
                <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 0.75rem; color: var(--text-gray); transition: transform 0.2s ease;"></i>
              </div>
              <div class="dropdown-secondary-menu" id="objectif-hpap-menu" style="background: #172033 !important;">
                <div class="dropdown-secondary-option" onclick="selectObjectifHpap('', '-')">-</div>
                <div class="dropdown-secondary-option" onclick="selectObjectifHpap('Oui', 'Oui')">Oui</div>
                <div class="dropdown-secondary-option" onclick="selectObjectifHpap('Non', 'Non')">Non</div>
                <div class="dropdown-secondary-option" onclick="selectObjectifHpap('Partiellement', 'Partiellement')">Partiellement</div>
              </div>
            </div>

            <!-- Estims -->
            <div style="margin-bottom: 1rem; position: relative;">
              <label style="display: block; color: var(--text-gray); margin-bottom: 0.5rem; font-size: 0.9rem;">
                Estimations
              </label>
              <input type="hidden" id="suivi-objectif-estims" value="">
              <div class="dropdown-secondary" id="objectif-estims-dropdown" onclick="toggleObjectifEstimsDropdown()" style="width: 100% !important; background: #172033 !important;">
                <span id="objectif-estims-selected">-</span>
                <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 0.75rem; color: var(--text-gray); transition: transform 0.2s ease;"></i>
              </div>
              <div class="dropdown-secondary-menu" id="objectif-estims-menu" style="background: #172033 !important;">
                <div class="dropdown-secondary-option" onclick="selectObjectifEstims('', '-')">-</div>
                <div class="dropdown-secondary-option" onclick="selectObjectifEstims('Oui', 'Oui')">Oui</div>
                <div class="dropdown-secondary-option" onclick="selectObjectifEstims('Non', 'Non')">Non</div>
                <div class="dropdown-secondary-option" onclick="selectObjectifEstims('Partiellement', 'Partiellement')">Partiellement</div>
              </div>
            </div>

            <!-- $vendu -->
            <div style="margin-bottom: 0rem; position: relative;">
              <label style="display: block; color: var(--text-gray); margin-bottom: 0.5rem; font-size: 0.9rem;">
                $ Vendu
              </label>
              <input type="hidden" id="suivi-objectif-vendu" value="">
              <div class="dropdown-secondary" id="objectif-vendu-dropdown" onclick="toggleObjectifVenduDropdown()" style="width: 100% !important; background: #172033 !important;">
                <span id="objectif-vendu-selected">-</span>
                <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 0.75rem; color: var(--text-gray); transition: transform 0.2s ease;"></i>
              </div>
              <div class="dropdown-secondary-menu" id="objectif-vendu-menu" style="background: #172033 !important;">
                <div class="dropdown-secondary-option" onclick="selectObjectifVendu('', '-')">-</div>
                <div class="dropdown-secondary-option" onclick="selectObjectifVendu('Oui', 'Oui')">Oui</div>
                <div class="dropdown-secondary-option" onclick="selectObjectifVendu('Non', 'Non')">Non</div>
                <div class="dropdown-secondary-option" onclick="selectObjectifVendu('Partiellement', 'Partiellement')">Partiellement</div>
              </div>
            </div>
          </div>

          <!-- Problème de la semaine -->
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i>Problème de la semaine
            </label>
            <textarea id="suivi-probleme" rows="3"
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light); resize: none;"
              placeholder="Décrivez le problème rencontré..."></textarea>
          </div>

          <!-- Racine du problème -->
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-search" style="color: #8b5cf6;"></i>Racine du problème
            </label>
            <textarea id="suivi-racine" rows="3"
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light); resize: none;"
              placeholder="Identifiez la racine du problème..."></textarea>
          </div>

          <!-- Source du problème -->
          <div style="margin-bottom: 1.5rem; position: relative;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-map-marker-alt" style="color: #ef4444;"></i>Source du problème
            </label>
            <input type="hidden" id="suivi-source" value="">
            <div class="dropdown-secondary" id="source-dropdown" onclick="toggleSourceDropdown()" style="width: 100% !important; background: #172033 !important;">
              <span id="source-selected">Sélectionner...</span>
              <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 0.75rem; color: var(--text-gray); transition: transform 0.2s ease;"></i>
            </div>
            <div class="dropdown-secondary-menu" id="source-menu" style="background: #172033 !important;">
              <div class="dropdown-secondary-option" onclick="selectSource('', 'Sélectionner...')">Sélectionner...</div>
              <div class="dropdown-secondary-option" onclick="selectSource('Engagement - Confiance', 'Engagement - Confiance')">Engagement - Confiance</div>
              <div class="dropdown-secondary-option" onclick="selectSource('Engagement - Paresse', 'Engagement - Paresse')">Engagement - Paresse</div>
              <div class="dropdown-secondary-option" onclick="selectSource('Compétence', 'Compétence')">Compétence</div>
            </div>
          </div>

          <!-- Type de coaching -->
          <div style="margin-bottom: 1.5rem; position: relative;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-chalkboard-teacher" style="color: #06b6d4;"></i>Type de coaching
            </label>
            <input type="hidden" id="suivi-type-coaching" value="">
            <div class="dropdown-secondary" id="type-coaching-dropdown" onclick="toggleTypeCoachingDropdown()" style="width: 100% !important; background: #172033 !important;">
              <span id="type-coaching-selected">Sélectionner...</span>
              <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 0.75rem; color: var(--text-gray); transition: transform 0.2s ease;"></i>
            </div>
            <div class="dropdown-secondary-menu" id="type-coaching-menu" style="background: #172033 !important;">
              <div class="dropdown-secondary-option" onclick="selectTypeCoaching('', 'Sélectionner...')">Sélectionner...</div>
              <div class="dropdown-secondary-option" onclick="selectTypeCoaching('Motivation', 'Motivation')">Motivation</div>
              <div class="dropdown-secondary-option" onclick="selectTypeCoaching('Stratégie', 'Stratégie')">Stratégie</div>
              <div class="dropdown-secondary-option" onclick="selectTypeCoaching('Technique', 'Technique')">Technique</div>
            </div>
          </div>

          <!-- Plan de match cette semaine -->
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
              <i class="fas fa-clipboard-list" style="color: #10b981;"></i>Plan de match cette semaine
            </label>
            <textarea id="suivi-plan" rows="4"
              style="width: 100%; padding: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; color: var(--text-light); resize: none;"
              placeholder="Décrivez le plan d'action pour la semaine..."></textarea>
          </div>

        </form>
      </div>

      <!-- Footer Sticky -->
      <div class="modal-footer">
        <button type="button" onclick="closeSuiviModal()" class="btn-secondary">
          <i class="fas fa-times"></i>Annuler
        </button>
        <button type="submit" form="suivi-form" class="btn-primary">
          <i class="fas fa-save"></i>Enregistrer
        </button>
      </div>

    </div>
  </div>

<script>
// Variables globales
let coachUsername = '';
let currentPage = 'todolist';
let selectedEntrepreneurUsername = '';
let selectedEntrepreneurDisplayName = '';

// ==================== CALENDRIER DASHBOARD ====================
let taskCurrentDate = new Date();
let taskSelectedDate = null;

const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
  'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

// Ouvrir/fermer le calendrier
window.toggleTaskCalendar = function() {
  const calendar = document.getElementById('taskCalendar');
  if (calendar.classList.contains('hidden')) {
    calendar.classList.remove('hidden');
    renderTaskCalendar();
  } else {
    calendar.classList.add('hidden');
  }
};

window.openTaskCalendar = function() {
  const calendar = document.getElementById('taskCalendar');
  if (calendar.classList.contains('hidden')) {
    calendar.classList.remove('hidden');
    renderTaskCalendar();
  }
};

// Changer de mois
window.changeTaskMonth = function(direction) {
  taskCurrentDate.setMonth(taskCurrentDate.getMonth() + direction);
  renderTaskCalendar();
};

/**
 * Afficher un popup avec le texte complet
 */
function showTextPopup(title, text) {
  const existingPopup = document.getElementById('text-popup-overlay');
  if (existingPopup) existingPopup.remove();

  const overlay = document.createElement('div');
  overlay.id = 'text-popup-overlay';
  overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000000; display: flex; align-items: center; justify-content: center; padding: 20px;';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };

  const popup = document.createElement('div');
  popup.style.cssText = 'background: var(--bg-card, #1e293b); border-radius: 12px; padding: 20px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);';
  popup.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h3 style="color: var(--text-light, #e2e8f0); font-size: 1.1rem; font-weight: 600; margin: 0;">${title}</h3>
      <button onclick="this.closest('#text-popup-overlay').remove()" style="background: none; border: none; color: var(--text-gray, #94a3b8); cursor: pointer; font-size: 1.5rem; line-height: 1;">&times;</button>
    </div>
    <p style="color: var(--text-light, #e2e8f0); font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap; margin: 0;">${text}</p>
  `;

  overlay.appendChild(popup);
  document.body.appendChild(overlay);
}

// Générer le calendrier
function renderTaskCalendar() {
  const calendarDays = document.getElementById('taskCalendarDays');
  const calendarTitle = document.getElementById('taskCalendarTitle');

  if (!calendarDays || !calendarTitle) return;

  calendarTitle.textContent = `${monthNames[taskCurrentDate.getMonth()]} ${taskCurrentDate.getFullYear()}`;

  const firstDay = new Date(taskCurrentDate.getFullYear(), taskCurrentDate.getMonth(), 1);
  const lastDay = new Date(taskCurrentDate.getFullYear(), taskCurrentDate.getMonth() + 1, 0);
  const firstDayOfWeek = firstDay.getDay();
  const today = new Date();

  calendarDays.innerHTML = '';

  // Jours du mois précédent
  for (let i = firstDayOfWeek - 1; i >= 0; i--) {
    const prevDate = new Date(firstDay);
    prevDate.setDate(prevDate.getDate() - (i + 1));
    const dayElement = createTaskDayElement(prevDate, true, today);
    calendarDays.appendChild(dayElement);
  }

  // Jours du mois actuel
  for (let day = 1; day <= lastDay.getDate(); day++) {
    const date = new Date(taskCurrentDate.getFullYear(), taskCurrentDate.getMonth(), day);
    const dayElement = createTaskDayElement(date, false, today);
    calendarDays.appendChild(dayElement);
  }

  // Jours du mois suivant
  const totalCells = calendarDays.children.length;
  const remainingCells = 42 - totalCells;
  for (let day = 1; day <= remainingCells; day++) {
    const nextDate = new Date(taskCurrentDate.getFullYear(), taskCurrentDate.getMonth() + 1, day);
    const dayElement = createTaskDayElement(nextDate, true, today);
    calendarDays.appendChild(dayElement);
  }
}

// Créer un élément jour
function createTaskDayElement(date, isOtherMonth, today) {
  const dayElement = document.createElement('div');
  dayElement.className = 'dashboard-calendar-day';
  dayElement.textContent = date.getDate();

  if (isOtherMonth) {
    dayElement.classList.add('other-month');
  }

  if (date.toDateString() === today.toDateString()) {
    dayElement.classList.add('today');
  }

  const currentInput = document.getElementById('task-date');
  if (currentInput && currentInput.value) {
    const inputDate = parseTaskDisplayDate(currentInput.value);
    if (inputDate && date.toDateString() === inputDate.toDateString()) {
      dayElement.classList.add('selected');
    }
  }

  dayElement.addEventListener('click', function() {
    selectTaskDate(date);
  });

  return dayElement;
}

// Sélectionner une date
function selectTaskDate(date) {
  const input = document.getElementById('task-date');
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const formattedDateDisplay = `${day}/${month}/${year}`;
  const formattedDateISO = `${year}-${month}-${day}`;

  input.value = formattedDateISO; // Format ISO pour stockage
  input.setAttribute('data-display', formattedDateDisplay); // Format français pour affichage
  taskSelectedDate = date;

  document.getElementById('taskCalendar').classList.add('hidden');
  
}

// Parser une date d'affichage
function parseTaskDisplayDate(dateStr) {
  if (!dateStr) return null;
  // Format ISO YYYY-MM-DD
  const parts = dateStr.split('-');
  if (parts.length === 3) {
    return new Date(parts[0], parts[1] - 1, parts[2]);
  }
  return null;
}

// Fermer le calendrier si on clique ailleurs
document.addEventListener('click', function(e) {
  const calendar = document.getElementById('taskCalendar');
  const container = e.target.closest('.dashboard-calendar-container');

  if (calendar && !calendar.classList.contains('hidden') && !container) {
    calendar.classList.add('hidden');
  }
});

// ==================== FIN CALENDRIER ====================

// ==================== DROPDOWN PERSONNALISÉ POUR LE TRI ====================

// Toggle dropdown
window.toggleSortFilterDropdown = function() {
  const dropdown = document.getElementById('sort-filter-dropdown');
  const menu = document.getElementById('sort-filter-menu');

  dropdown.classList.toggle('active');
  menu.classList.toggle('show');
};

// Sélectionner une option de tri
window.selectSortFilter = function(value, label) {
  // Mettre à jour le texte affiché
  document.getElementById('sort-filter-selected').textContent = label;

  // Mettre à jour le champ caché
  document.getElementById('sort-select').value = value;

  // Mettre à jour la classe selected
  document.querySelectorAll('#sort-filter-menu .dropdown-secondary-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  event.target.classList.add('selected');

  // Fermer le dropdown
  document.getElementById('sort-filter-dropdown').classList.remove('active');
  document.getElementById('sort-filter-menu').classList.remove('show');

  // Appliquer le tri
  sortTasks();
};

// Fermer le dropdown si on clique ailleurs
document.addEventListener('click', function(e) {
  const dropdown = document.getElementById('sort-filter-dropdown');
  const menu = document.getElementById('sort-filter-menu');

  if (dropdown && menu && !e.target.closest('#sort-filter-dropdown') && !e.target.closest('#sort-filter-menu')) {
    dropdown.classList.remove('active');
    menu.classList.remove('show');
  }
});

// ==================== FIN DROPDOWN ====================

// Fonction pour changer de page/onglet
function showPage(pageName) {
  

  // Masquer toutes les pages
  document.querySelectorAll('.page-content').forEach(page => {
    page.classList.remove('active');
  });

  // Réinitialiser tous les boutons à secondaire
  document.querySelectorAll('.tab-spacing button').forEach(btn => {
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-secondary');
  });

  // Afficher la page sélectionnée
  const selectedPage = document.getElementById(pageName);
  if (selectedPage) {
    selectedPage.classList.add('active');
  }

  // Mettre le bouton correspondant en primary
  const selectedBtn = document.getElementById(pageName + '-tab');
  if (selectedBtn) {
    selectedBtn.classList.remove('btn-secondary');
    selectedBtn.classList.add('btn-primary');
  }

  currentPage = pageName;

  // Afficher/cacher le dropdown de filtre selon la page
  const tasksFilterDropdown = document.getElementById('tasks-filter-dropdown');
  if (tasksFilterDropdown) {
    if (pageName === 'todolist') {
      tasksFilterDropdown.style.display = 'block';
    } else {
      tasksFilterDropdown.style.display = 'none';
    }
  }

  // Pré-charger le plan d'affaire dès qu'on affiche la page RPO
  if (pageName === 'rpo' && coachUsername) {
    // Pré-charger en arrière-plan pour que Statistiques soit instantané
    setTimeout(async () => {
      console.log('[PRELOAD] Pré-chargement plan affaire direction...');
      await updateTeamObjectifDisplay();
      await updateTeamMetricsDisplay();
      await checkAndToggleBusinessPlanView();
      await initTeamPlan();
      console.log('[PRELOAD] Plan affaire prêt!');
    }, 100);
  }

  // Initialiser le plan d'affaire quand on affiche la page stats (déjà chargé si on vient de RPO)
  if (pageName === 'stats' && coachUsername) {
    setTimeout(async () => {
      await updateTeamObjectifDisplay();
      await updateTeamMetricsDisplay();
      await checkAndToggleBusinessPlanView();
      // Réinitialiser si besoin (au cas où les données ont changé)
      await initTeamPlan();
    }, 100);
  }
}

// Récupérer le username selon le rôle
document.addEventListener('DOMContentLoaded', async function() {
  const userRole = localStorage.getItem('userRole');

  // Pour les direction : utiliser leur propre username (comme les coachs)
  if (userRole === 'direction') {
    coachUsername = localStorage.getItem('username') || '';
    
    // Ajouter la classe pour afficher le contenu immédiatement (pas de sélecteur)
    document.body.classList.add('direction-viewing-own-data');
  } else {
    // Fallback: essayer de récupérer depuis l'URL
    const urlParams = new URLSearchParams(window.location.search);
    coachUsername = urlParams.get('user') || '';
  }

  // Charger la sidebar
  if (typeof loadSidebar === 'function') {
    loadSidebar();
  }

  // Afficher la première page par défaut
  showPage('todolist');

  // Attacher les event listeners aux boutons de navigation
  document.getElementById('todolist-tab')?.addEventListener('click', () => showPage('todolist'));
  document.getElementById('rpo-tab')?.addEventListener('click', () => showPage('rpo'));
  document.getElementById('stats-tab')?.addEventListener('click', () => showPage('stats'));

  // Charger les tâches et l'historique au démarrage SEULEMENT si on a un username
  if (coachUsername) {
    loadTasks();
    loadTaskHistory();
  }
});

// ==================== GESTION DES TÂCHES ====================

let tasks = [];
let selectedAssignees = []; // Tableau pour stocker les utilisateurs sélectionnés
let availableUsers = []; // Tous les coaches et direction disponibles
let currentTasksFilter = 'my'; // 'my' ou 'all'

// ==================== FILTRE TÂCHES ====================

function toggleTasksFilterDropdown() {
  const menu = document.getElementById('tasks-filter-menu');
  const toggle = document.getElementById('tasks-filter-toggle');
  const chevron = toggle.querySelector('.fa-chevron-down');

  if (menu.style.display === 'none' || !menu.style.display) {
    menu.style.display = 'block';
    chevron.style.transform = 'rotate(180deg)';
  } else {
    menu.style.display = 'none';
    chevron.style.transform = 'rotate(0deg)';
  }
}

function selectTasksFilter(filter) {
  currentTasksFilter = filter;
  const selectedText = document.getElementById('tasks-filter-selected');

  if (filter === 'my') {
    selectedText.textContent = 'Mes tâches';
  } else {
    selectedText.textContent = 'Toutes les tâches';
  }

  // Fermer le dropdown
  document.getElementById('tasks-filter-menu').style.display = 'none';
  document.getElementById('tasks-filter-toggle').querySelector('.fa-chevron-down').style.transform = 'rotate(0deg)';

  // Recharger les tâches avec le nouveau filtre
  loadTasks();
}

// Fermer le dropdown si on clique ailleurs
document.addEventListener('click', function(event) {
  const dropdown = document.getElementById('tasks-filter-dropdown');
  if (dropdown && !dropdown.contains(event.target)) {
    const menu = document.getElementById('tasks-filter-menu');
    if (menu) {
      menu.style.display = 'none';
      const chevron = document.getElementById('tasks-filter-toggle')?.querySelector('.fa-chevron-down');
      if (chevron) chevron.style.transform = 'rotate(0deg)';
    }
  }
});

// ==================== MULTI-SELECT ASSIGNEE DROPDOWN ====================

// Charger tous les coaches et direction au chargement du modal
async function loadAvailableAssignees() {
  try {
    // Charger les coaches
    const coachesResponse = await fetch('/api/users/coaches');
    const coachesData = await coachesResponse.json();

    // Charger les direction
    const directionResponse = await fetch('/api/users/direction');
    const directionData = await directionResponse.json();

    // Charger info de l'utilisateur actuel
    const currentUserResponse = await fetch('/api/user-info');
    const currentUserData = await currentUserResponse.json();

    availableUsers = [];

    // Ajouter "Moi-même" en premier
    if (currentUserData.success) {
      availableUsers.push({
        username: currentUserData.username,
        firstName: currentUserData.first_name || '',
        lastName: currentUserData.last_name || '',
        role: currentUserData.role,
        isSelf: true
      });
    }

    // Ajouter les coaches (sauf si c'est l'utilisateur actuel)
    if (coachesData.success && coachesData.coaches) {
      coachesData.coaches.forEach(coach => {
        if (coach.username !== currentUserData.username) {
          availableUsers.push({
            username: coach.username,
            firstName: coach.prenom || '',
            lastName: coach.nom || '',
            role: 'coach'
          });
        }
      });
    }

    // Ajouter les direction (sauf si c'est l'utilisateur actuel)
    if (directionData.success && directionData.users) {
      directionData.users.forEach(dir => {
        if (dir.username !== currentUserData.username) {
          availableUsers.push({
            username: dir.username,
            firstName: dir.first_name || '',
            lastName: dir.last_name || '',
            role: 'direction'
          });
        }
      });
    }

    
    renderAssigneesList();
  } catch (error) {
    console.error('[ASSIGNEES] Error loading users:', error);
    document.getElementById('assignee-users-list').innerHTML = `
      <div style="text-align: center; padding: 2rem; color: var(--primary-red);">
        <i class="fas fa-exclamation-triangle"></i> Erreur de chargement
      </div>
    `;
  }
}

// Fonction pour obtenir l'avatar d'un utilisateur
async function getUserAvatarForTask(username, role) {
  const isCoach = role === 'coach';
  const gradientColor = isCoach ? '#8b5cf6, #7c3aed' : '#3b82f6, #2563eb';
  const iconClass = isCoach ? 'chalkboard-teacher' : 'user-tie';

  try {
    const response = await fetch(`/api/get-profile-photo/${username}`);
    if (response.ok) {
      const data = await response.json();
      if (data.photoUrl) {
        return `
          <div style="width: 32px; height: 32px; border-radius: 50%; overflow: hidden; flex-shrink: 0;">
            <img src="${data.photoUrl}" alt="${username}" style="width: 100%; height: 100%; object-fit: cover;" />
          </div>
        `;
      }
    }
  } catch (error) {
    // Photo non disponible, utiliser l'icône
  }

  // Fallback: icône
  return `
    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, ${gradientColor}); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
      <i class="fas fa-${iconClass}" style="color: white; font-size: 14px;"></i>
    </div>
  `;
}

// Afficher la liste des utilisateurs dans le dropdown
async function renderAssigneesList() {
  const listContainer = document.getElementById('assignee-users-list');

  if (availableUsers.length === 0) {
    listContainer.innerHTML = `
      <div style="text-align: center; padding: 2rem; color: var(--text-gray);">
        <i class="fas fa-users-slash"></i>
        <p style="margin-top: 0.5rem;">Aucun utilisateur trouvé</p>
      </div>
    `;
    return;
  }

  listContainer.innerHTML = '';

  // Charger tous les avatars en parallèle
  const avatarPromises = availableUsers.map(user => getUserAvatarForTask(user.username, user.role));
  const avatars = await Promise.all(avatarPromises);

  availableUsers.forEach((user, index) => {
    const displayName = user.isSelf
      ? 'Moi-même'
      : (user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : user.username);

    const isSelected = selectedAssignees.some(u => u.username === user.username);
    const roleLabel = user.role === 'coach' ? 'Coach' : 'Direction';
    const roleColor = user.role === 'coach' ? '#8b5cf6' : '#3b82f6';

    const userItem = document.createElement('div');
    userItem.className = 'dropdown-secondary-option assignee-user-item';
    userItem.dataset.username = user.username;

    // Ajouter assignee-selected class si sélectionné (pas "selected" pour éviter le style bleu)
    if (isSelected) {
      userItem.classList.add('assignee-selected');
    }

    userItem.style.cssText = `
      display: flex !important;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem !important;
    `;

    userItem.innerHTML = `
      ${avatars[index]}
      <div style="flex: 1; min-width: 0;">
        <div style="color: var(--text-light); font-weight: 500; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
          ${displayName}
        </div>
        <div style="color: var(--text-gray); font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
          <span style="color: ${roleColor};">${roleLabel}</span>
          ${!user.isSelf ? `<span style="color: var(--text-muted);">• ${user.username}</span>` : ''}
        </div>
      </div>
      <div style="flex-shrink: 0;">
        ${isSelected ? `<i class="fas fa-check-circle" style="color: ${roleColor}; font-size: 1.25rem;"></i>` : `<i class="far fa-circle" style="color: var(--text-gray); font-size: 1.25rem;"></i>`}
      </div>
    `;

    userItem.addEventListener('click', function(e) {
      e.stopPropagation();
      toggleAssignee(user);
    });

    listContainer.appendChild(userItem);

    // Ajouter un séparateur après "Moi-même"
    if (user.isSelf && availableUsers.length > 1) {
      const separator = document.createElement('div');
      separator.style.cssText = `
        height: 1px;
        background: rgba(51, 65, 85, 0.6);
        margin: 0.5rem 0;
      `;
      listContainer.appendChild(separator);
    }
  });
}

// Toggle sélection d'un utilisateur
function toggleAssignee(user) {
  const index = selectedAssignees.findIndex(u => u.username === user.username);

  if (index > -1) {
    // Désélectionner
    selectedAssignees.splice(index, 1);
  } else {
    // Sélectionner
    selectedAssignees.push(user);
  }

  renderAssigneesList();
  updateSelectedBadges();
}

// Mettre à jour l'affichage des badges sélectionnés
async function updateSelectedBadges() {
  const container = document.getElementById('selected-users-container');
  let placeholder = document.getElementById('assignee-placeholder');

  // Clear container
  container.innerHTML = '';

  if (selectedAssignees.length === 0) {
    // Recreate and show the placeholder when no users selected
    if (!placeholder) {
      placeholder = document.createElement('span');
      placeholder.id = 'assignee-placeholder';
      placeholder.style.color = 'var(--text-gray)';
    }
    placeholder.textContent = 'Sélectionner des personnes...';
    placeholder.style.display = 'block';
    container.appendChild(placeholder);
    return;
  }

  // Load avatars in parallel
  const avatarPromises = selectedAssignees.map(user => getUserAvatarForTask(user.username, user.role));
  const avatars = await Promise.all(avatarPromises);

  selectedAssignees.forEach((user, index) => {
    const displayName = user.isSelf
      ? 'Moi-même'
      : (user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : user.username);

    const roleColor = user.role === 'coach' ? '#8b5cf6' : '#3b82f6';

    const badge = document.createElement('div');
    badge.style.cssText = `
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.5rem;
      background: rgba(${user.role === 'coach' ? '139, 92, 246' : '59, 130, 246'}, 0.15);
      border: 1px solid ${roleColor};
      border-radius: 0.75rem;
      color: var(--text-light);
      font-size: 0.75rem;
      flex-shrink: 0;
      max-height: 32px;
      white-space: nowrap;
    `;

    badge.innerHTML = `
      <div style="width: 20px; height: 20px; border-radius: 50%; overflow: hidden; flex-shrink: 0;">
        ${avatars[index].replace(/32px/g, '20px').replace(/14px/g, '10px').replace(/24px/g, '20px').replace(/11px/g, '10px')}
      </div>
      <span style="line-height: 1;">${displayName}</span>
      <button type="button" onclick="event.stopPropagation(); removeAssignee('${user.username}')" style="background: none; border: none; color: var(--text-gray); cursor: pointer; padding: 0; margin-left: 0.15rem; display: flex; align-items: center; font-size: 0.7rem;">
        <i class="fas fa-times"></i>
      </button>
    `;

    container.appendChild(badge);
  });
}

// Retirer un utilisateur sélectionné
function removeAssignee(username) {
  selectedAssignees = selectedAssignees.filter(u => u.username !== username);
  renderAssigneesList();
  updateSelectedBadges();
}

// Toggle dropdown function (appelée par onclick dans le HTML)
function toggleAssigneeDropdown() {
  const menu = document.getElementById('task-assignee-menu');
  const isOpen = menu.style.display === 'block';

  // Fermer tous les autres dropdowns
  document.querySelectorAll('.dropdown-secondary-menu').forEach(m => {
    if (m !== menu) m.style.display = 'none';
  });

  menu.style.display = isOpen ? 'none' : 'block';

  // Charger les utilisateurs si pas encore chargé
  if (!isOpen && availableUsers.length === 0) {
    loadAvailableAssignees();
  }
}

// Setup event listeners
document.addEventListener('DOMContentLoaded', function() {
  const search = document.getElementById('assignee-search');

  // Search
  if (search) {
    search.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase().trim();
      const items = document.querySelectorAll('.assignee-user-item');

      items.forEach(item => {
        const username = item.dataset.username.toLowerCase();
        const text = item.textContent.toLowerCase();

        if (searchTerm === '' || text.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    });

    search.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  }

  // Fermer le dropdown en cliquant ailleurs
  document.addEventListener('click', function(e) {
    const menu = document.getElementById('task-assignee-menu');
    const toggle = document.getElementById('task-assignee-toggle');

    if (menu && !menu.contains(e.target) && !toggle.contains(e.target)) {
      menu.style.display = 'none';
    }
  });
});

// Calculer automatiquement la priorité en fonction de la date
function calculatePriority(dateString) {
  if (!dateString) return 'upcoming';

  const taskDate = new Date(dateString);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  taskDate.setHours(0, 0, 0, 0);

  const diffTime = taskDate - today;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

  // Urgent: 3 prochains jours
  if (diffDays <= 3) {
    return 'urgent';
  }
  // Important: 1 semaine (7 jours)
  else if (diffDays <= 7) {
    return 'important';
  }
  // Ce qui s'en vient: 2 semaines (14 jours) et plus
  else {
    return 'upcoming';
  }
}

// Ouvrir le modal pour créer/modifier une tâche
async function openTaskModal(priority = null, taskId = null) {
  const modal = document.getElementById('task-modal');
  const form = document.getElementById('task-form');

  // Bloquer le scroll du body
  document.body.style.overflow = 'hidden';

  // Réinitialiser le formulaire
  form.reset();
  selectedAssignees = []; // Réinitialiser les assignés

  // Charger les utilisateurs disponibles si ce n'est pas déjà fait
  if (availableUsers.length === 0) {
    await loadAvailableAssignees();
  }

  const modalTitle = document.getElementById('modal-title');
  if (!modalTitle) {
    console.error('[TASK MODAL] modal-title element not found');
  }

  if (taskId) {
    // Mode édition
    const task = tasks.find(t => t.id === taskId);
    if (task) {
      if (modalTitle) modalTitle.textContent = 'Modifier la tâche';
      document.getElementById('task-id').value = task.id;
      document.getElementById('task-title').value = task.title;
      document.getElementById('task-category').value = task.category;
      document.getElementById('task-date').value = task.date || '';

      // Restaurer les assignés
      if (task.assignedUsers && Array.isArray(task.assignedUsers)) {
        selectedAssignees = task.assignedUsers.map(assignedUser => {
          // Trouver l'utilisateur complet dans availableUsers
          const user = availableUsers.find(u => u.username === assignedUser.username);
          return user || assignedUser; // Fallback sur les données de la tâche si l'utilisateur n'est plus disponible
        });
        await updateSelectedBadges();
      }

      document.getElementById('task-details').value = task.details || '';
    }
  } else {
    // Mode création
    if (modalTitle) modalTitle.textContent = 'Nouvelle tâche';
    document.getElementById('task-id').value = '';
    await updateSelectedBadges(); // Vider l'affichage des badges
  }

  modal.style.display = 'flex';
}

// Fermer le modal
function closeTaskModal() {
  document.getElementById('task-modal').style.display = 'none';
  // Réactiver le scroll du body
  document.body.style.overflow = 'auto';
}

// Récupérer les informations de l'utilisateur actuel
async function getCurrentUserInfo() {
  const username = localStorage.getItem('username');
  try {
    const response = await fetch(`/api/get-user-info/${username}`);
    if (response.ok) {
      const data = await response.json();
      return {
        username: username,
        firstName: data.prenom || '',
        lastName: data.nom || ''
      };
    }
  } catch (error) {
    console.error('[TASK] Erreur récupération infos utilisateur:', error);
  }
  return { username, firstName: '', lastName: '' };
}

// Sauvegarder une tâche
async function saveTask(event) {
  event.preventDefault();

  const taskId = document.getElementById('task-id').value;
  const taskDate = document.getElementById('task-date').value;

  // Récupérer les infos de l'utilisateur actuel
  const currentUser = await getCurrentUserInfo();
  const createdByName = currentUser.firstName && currentUser.lastName
    ? `${currentUser.firstName} ${currentUser.lastName}`
    : currentUser.username;

  const task = {
    id: taskId || Date.now().toString(),
    title: document.getElementById('task-title').value,
    assignedUsers: selectedAssignees.map(u => ({
      username: u.username,
      firstName: u.firstName,
      lastName: u.lastName,
      role: u.role
    })), // Sauvegarder les utilisateurs assignés
    assigned: selectedAssignees.map(u => {
      const displayName = u.firstName && u.lastName ? `${u.firstName} ${u.lastName}` : u.username;
      return displayName;
    }).join(', '), // Pour compatibilité avec l'ancien format (affichage)
    category: document.getElementById('task-category').value,
    date: taskDate,
    details: document.getElementById('task-details').value,
    priority: calculatePriority(taskDate),  // Calcul automatique de la priorité
    created_at: taskId ? (tasks.find(t => t.id === taskId)?.created_at || new Date().toISOString()) : new Date().toISOString(),
    created_by: taskId ? (tasks.find(t => t.id === taskId)?.created_by || createdByName) : createdByName  // Conserver le créateur original lors de la modification
  };

  try {
    const response = await fetch('/api/coach/tasks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        coach_username: coachUsername,
        task: task
      })
    });

    if (response.ok) {
      
      closeTaskModal();
      await loadTasks();
    } else {
      console.error('[TASK] Erreur lors de la sauvegarde');
    }
  } catch (error) {
    console.error('[TASK] Erreur:', error);
  }
}

// Charger toutes les tâches
async function loadTasks() {
  try {
    // Direction voit toutes les tâches de tous les utilisateurs
    const response = await fetch(`/api/coach/tasks?coach_username=${coachUsername}&include_all=true`);
    if (response.ok) {
      const data = await response.json();
      let allTasks = data.tasks || [];

      // Filtrer selon le filtre actif
      if (currentTasksFilter === 'my') {
        // Ne montrer que les tâches assignées à l'utilisateur actuel
        tasks = allTasks.filter(task => {
          if (task.assignedUsers && Array.isArray(task.assignedUsers)) {
            return task.assignedUsers.some(user => user.username === coachUsername);
          } else if (task.assigned) {
            // Fallback: vérifier dans le champ assigned (string)
            return task.assigned.includes(coachUsername);
          }
          return false;
        });
      } else {
        // Montrer toutes les tâches
        tasks = allTasks;
      }

      renderTasks();
    }
  } catch (error) {
    console.error('[TASK] Erreur chargement:', error);
    tasks = [];
    renderTasks();
  }
}

// Afficher les tâches dans l'interface
function renderTasks() {
  // Vider les colonnes
  document.getElementById('urgent-tasks').innerHTML = '';
  document.getElementById('important-tasks').innerHTML = '';
  document.getElementById('upcoming-tasks').innerHTML = '';

  // Compter les tâches par priorité
  const counts = { urgent: 0, important: 0, upcoming: 0 };

  // Afficher les tâches dans les colonnes
  tasks.forEach(task => {
    const taskEl = createTaskElement(task);
    const container = document.getElementById(`${task.priority}-tasks`);
    if (container) {
      container.appendChild(taskEl);
      counts[task.priority]++;
    }
  });

  // Afficher "Aucune tâche" si une colonne est vide
  ['urgent', 'important', 'upcoming'].forEach(priority => {
    const container = document.getElementById(`${priority}-tasks`);
    if (counts[priority] === 0) {
      const emptyState = document.createElement('div');
      emptyState.className = 'empty-state empty-state-column';
      emptyState.innerHTML = `
        <i class="fas fa-clipboard-list"></i>
        <p>Aucune tâche présentement</p>
      `;
      container.appendChild(emptyState);
    }
  });

  // Mettre à jour les compteurs
  document.getElementById('urgent-count').textContent = counts.urgent;
  document.getElementById('important-count').textContent = counts.important;
  document.getElementById('upcoming-count').textContent = counts.upcoming;

  // Afficher dans le tableau
  renderTasksTable();
}

// Créer un élément de tâche pour les colonnes
function createTaskElement(task) {
  const div = document.createElement('div');
  div.className = 'todo-item';
  div.dataset.taskId = task.id;

  const userRole = localStorage.getItem('userRole');
  const isDirectionUser = userRole === 'direction';
  const isCoachUser = userRole === 'coach';

  // Generate action buttons - both Direction and Coaches can manage tasks
  let actionButtons = `
    <button onclick="completeTask('${task.id}')" style="padding: 0.5rem; background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 0.5rem; color: #22c55e; cursor: pointer; font-size: 0.875rem;">
      <i class="fas fa-check" style=""></i>
    </button>
  `;

  // Show Edit and Delete buttons for both Direction and Coach users
  if (isDirectionUser || isCoachUser) {
    actionButtons += `
      <button onclick="openTaskModal('${task.priority}', '${task.id}')" style="padding: 0.5rem; background: rgba(96, 165, 250, 0.2); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 0.5rem; color: #60a5fa; cursor: pointer; font-size: 0.875rem;">
        <i class="fas fa-edit" style=""></i>
      </button>
      <button onclick="deleteTask('${task.id}')" style="padding: 0.5rem; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem; color: #ef4444; cursor: pointer; font-size: 0.875rem;">
        <i class="fas fa-trash" style=""></i>
      </button>
    `;
  }

  div.innerHTML = `
    <div style="position: relative;">
      <div class="todo-item-title">${task.title}</div>
      <button onclick="showTaskDetails('${task.id.replace(/'/g, "\\'")}', '${task.title.replace(/'/g, "\\'")}', '${(task.details || 'Aucun détail').replace(/'/g, "\\'").replace(/\n/g, '\\n')}')" style="position: absolute; top: 0; right: 0; padding: 0.25rem 0.5rem; background: rgba(96, 165, 250, 0.2); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 0.5rem; color: #60a5fa; cursor: pointer; font-size: 0.75rem;">
        <i class="fas fa-info-circle" style=""></i>
      </button>
    </div>
    <div class="todo-item-meta">
      ${task.assigned ? `<span><i class="fas fa-user mr-1" style=""></i>${task.assigned}</span>` : ''}
      ${task.date ? `<span><i class="fas fa-calendar mr-1" style=""></i>${formatDate(task.date)}</span>` : ''}
    </div>
    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; justify-content: space-between; align-items: center;">
      ${task.created_by ? `<span style="font-weight: 700; color: #8b5cf6; font-size: 0.875rem;">Créé par ${task.created_by}</span>` : '<span></span>'}
      <div style="display: flex; gap: 0.5rem;">
        ${actionButtons}
      </div>
    </div>
  `;

  return div;
}

// Afficher les tâches dans le tableau
function renderTasksTable(tasksToRender = null) {
  const tbody = document.getElementById('tasks-table-body');
  tbody.innerHTML = '';

  const displayTasks = tasksToRender || tasks;

  if (displayTasks.length === 0) {
    // Afficher l'état vide
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td colspan="6" class="empty-state">
        <i class="fas fa-clipboard-list"></i>
        <p>Aucune tâche présentement</p>
      </td>
    `;
    tbody.appendChild(tr);
    return;
  }

  displayTasks.forEach(task => {
    const tr = document.createElement('tr');
    // Déterminer la classe du badge selon la catégorie
    let badgeClass = 'badge-facturation'; // Défaut
    const categoryLower = (task.category || '').toLowerCase();
    if (categoryLower.includes('propulsion')) {
      badgeClass = 'badge-propulsion';
    } else if (categoryLower.includes('facturation')) {
      badgeClass = 'badge-facturation';
    } else if (categoryLower.includes('marketing')) {
      badgeClass = 'badge-marketing';
    }

    // Tronquer les détails si trop longs
    const maxLength = 50;
    const details = task.details || '-';
    const truncatedDetails = details.length > maxLength ? details.substring(0, maxLength) + '...' : details;
    const hasLongDetails = details.length > maxLength && details !== '-';

    tr.innerHTML = `
      <td style="width: 20%; font-weight: 600; color: var(--text-light); text-align: left !important;">${task.title}</td>
      <td style="width: 15%; text-align: left !important;">${task.assigned || '-'}</td>
      <td style="width: 12%; text-align: left !important;"><span class="todo-badge ${badgeClass}">${task.category ? task.category.charAt(0).toUpperCase() + task.category.slice(1) : '-'}</span></td>
      <td style="width: 12%; text-align: left !important;">${task.date ? formatDate(task.date) : '-'}</td>
      <td style="width: 26%; text-align: left !important;">
        ${truncatedDetails}
        ${hasLongDetails ? `<button onclick="showTaskDetails('${task.id.replace(/'/g, "\\'")}', '${task.title.replace(/'/g, "\\'")}', '${details.replace(/'/g, "\\'").replace(/\n/g, '\\n')}')" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: rgba(96, 165, 250, 0.2); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 0.5rem; color: #60a5fa; cursor: pointer; font-size: 0.75rem;"><i class="fas fa-info-circle"></i></button>` : ''}
      </td>
      <td style="width: 15%; text-align: center !important;">
        <button onclick="completeTask('${task.id}')" style="padding: 0.5rem; background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 0.5rem; color: #22c55e; cursor: pointer; margin-right: 0.25rem;">
          <i class="fas fa-check"></i>
        </button>
        <button onclick="openTaskModal('${task.priority}', '${task.id}')" style="padding: 0.5rem; background: rgba(96, 165, 250, 0.2); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 0.5rem; color: #60a5fa; cursor: pointer; margin-right: 0.25rem;">
          <i class="fas fa-edit"></i>
        </button>
        <button onclick="deleteTask('${task.id}')" style="padding: 0.5rem; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem; color: #ef4444; cursor: pointer;">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

// Filtrer les tâches
function filterTasks() {
  const searchQuery = document.getElementById('table-search').value.toLowerCase();

  let filtered = tasks.filter(task => {
    // Filtre de recherche
    const matchesSearch = task.title.toLowerCase().includes(searchQuery) ||
                          (task.assigned && task.assigned.toLowerCase().includes(searchQuery)) ||
                          (task.details && task.details.toLowerCase().includes(searchQuery));

    return matchesSearch;
  });

  // Appliquer le tri actuel
  const sortValue = document.getElementById('sort-select').value;
  filtered = applySorting(filtered, sortValue);

  renderTasksTable(filtered);
}

// Trier les tâches
function sortTasks() {
  filterTasks(); // Réappliquer les filtres avec le nouveau tri
}

// Appliquer le tri aux tâches
function applySorting(tasksArray, sortValue) {
  const sorted = [...tasksArray];

  switch(sortValue) {
    case 'recent':
      sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      break;
    case 'oldest':
      sorted.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      break;
    case 'title-asc':
      sorted.sort((a, b) => a.title.localeCompare(b.title));
      break;
    case 'title-desc':
      sorted.sort((a, b) => b.title.localeCompare(a.title));
      break;
    case 'date-asc':
      sorted.sort((a, b) => {
        if (!a.date) return 1;
        if (!b.date) return -1;
        return new Date(a.date) - new Date(b.date);
      });
      break;
    case 'date-desc':
      sorted.sort((a, b) => {
        if (!a.date) return 1;
        if (!b.date) return -1;
        return new Date(b.date) - new Date(a.date);
      });
      break;
    default:
      sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
  }

  return sorted;
}

// Afficher un pop-up de confirmation
function showConfirmModal(message, onConfirm) {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `;

  modal.innerHTML = `
    <div style="background: var(--bg-card); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; padding: 2rem; max-width: 400px; width: 90%;">
      <div style="margin-bottom: 1.5rem;">
        <h3 style="color: var(--text-light); margin: 0 0 1rem 0; font-size: 1.125rem; text-align: center;">Confirmation</h3>
        <p style="color: var(--text-gray); margin: 0; line-height: 1.6; text-align: center;">${message}</p>
      </div>
      <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
        <button id="cancel-btn" style="padding: 0.625rem 1.25rem; background: rgba(100, 116, 139, 0.2); border: 1px solid rgba(100, 116, 139, 0.3); border-radius: 0.5rem; color: var(--text-gray); cursor: pointer; font-weight: 500;">
          Annuler
        </button>
        <button id="confirm-btn" style="padding: 0.625rem 1.25rem; background: rgba(96, 165, 250, 0.2); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 0.5rem; color: #60a5fa; cursor: pointer; font-weight: 500;">
          Confirmer
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  const cancelBtn = modal.querySelector('#cancel-btn');
  const confirmBtn = modal.querySelector('#confirm-btn');

  cancelBtn.onclick = () => modal.remove();
  confirmBtn.onclick = () => {
    modal.remove();
    onConfirm();
  };

  // Fermer en cliquant sur le fond
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

// Supprimer une tâche
async function deleteTask(taskId) {
  showConfirmModal('Êtes-vous sûr de vouloir supprimer cette tâche ?', async () => {
    try {
      const response = await fetch('/api/coach/tasks', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          coach_username: coachUsername,
          task_id: taskId
        })
      });

      if (response.ok) {
        
        await loadTasks();
      }
    } catch (error) {
      console.error('[TASK] Erreur suppression:', error);
    }
  });
}

// Terminer une tâche
async function completeTask(taskId) {
  showConfirmModal('Marquer cette tâche comme terminée ?', async () => {
    try {
      const response = await fetch('/api/coach/tasks/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          coach_username: coachUsername,
          task_id: taskId
        })
      });

      if (response.ok) {
        
        await loadTasks();
        await loadTaskHistory();
      }
    } catch (error) {
      console.error('[TASK] Erreur terminer tâche:', error);
    }
  });
}

// Ouvrir la modal d'historique
async function openHistoryModal() {
  try {
    // Direction voit l'historique de tout le monde
    const response = await fetch(`/api/coach/tasks/history?coach_username=${coachUsername}&include_all=true`);
    if (!response.ok) {
      console.error('[TASK] Erreur de réponse historique:', response.status);
      return;
    }

    const data = await response.json();
    // S'assurer que c'est un tableau
    const history = Array.isArray(data) ? data : (data.history || []);

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 2rem;';

    let historyHTML = '';
    if (history.length === 0) {
      historyHTML = '<p style="color: var(--text-gray); text-align: center; padding: 2rem;">Aucune tâche complétée dans l\'historique</p>';
    } else {
      historyHTML = history.map(task => {
        const completedDate = task.completed_at ? new Date(task.completed_at).toLocaleDateString('fr-CA', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          timeZone: 'America/Toronto'
        }) : '';

        return `
          <div style="padding: 1rem; margin-bottom: 0.75rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 0.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: var(--text-light); margin-bottom: 0.5rem; font-size: 1rem;">${task.title}</div>
                ${task.details ? `<div style="color: var(--text-gray); font-size: 0.875rem; margin-bottom: 0.5rem;">${task.details}</div>` : ''}
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.75rem; color: var(--text-gray);">
                  <span><i class="fas fa-check-circle mr-1" style="color: #10b981;"></i>Complétée le ${completedDate}</span>
                  ${task.assigned ? `<span><i class="fas fa-user mr-1"></i>${task.assigned}</span>` : ''}
                  ${task.created_by ? `<span><i class="fas fa-user-edit mr-1"></i>Créée par ${task.created_by}</span>` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    modal.innerHTML = `
      <div style="background: var(--bg-card); border-radius: 1rem; max-width: 800px; width: 100%; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);">
        <div style="padding: 1.5rem; border-bottom: 2px solid rgba(51, 65, 85, 0.5); display: flex; justify-content: space-between; align-items: center;">
          <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-light); margin: 0;">
            <i class="fas fa-history"></i>Historique des tâches complétées
          </h2>
          <button onclick="this.closest('.modal-overlay').remove()" style="background: transparent; border: none; color: var(--text-gray); cursor: pointer; font-size: 1.5rem; padding: 0.5rem;">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div style="padding: 1.5rem; overflow-y: auto; flex: 1;">
          ${historyHTML}
        </div>
      </div>
    `;

    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });

    document.body.appendChild(modal);
  } catch (error) {
    console.error('[TASK] Erreur ouverture historique:', error);
  }
}

// Charger l'historique des tâches complétées (fonction simplifiée pour mise à jour automatique)
async function loadTaskHistory() {
  // Cette fonction ne fait plus rien car l'historique s'ouvre via modal
  // On la garde pour compatibilité
}

// Afficher les détails complets d'une tâche
function showTaskDetails(taskId, taskTitle, taskDetails) {
  // Trouver la tâche complète dans le tableau tasks
  const task = tasks.find(t => t.id === taskId);
  if (!task) {
    console.error('[TASK] Tâche non trouvée:', taskId);
    return;
  }

  // Déterminer la classe de badge pour la catégorie
  const categoryMap = {
    'marketing': 'todo-badge-marketing',
    'ventes': 'todo-badge-ventes',
    'operations': 'todo-badge-operations',
    'strategie': 'todo-badge-strategie'
  };
  const badgeClass = categoryMap[task.category] || 'todo-badge-autre';

  // Fonction pour obtenir les initiales d'un nom
  const getInitials = (name) => {
    if (!name) return '?';
    const parts = name.trim().split(' ');
    if (parts.length >= 2) {
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }
    return name.substring(0, 2).toUpperCase();
  };

  // Fonction pour créer un avatar avec photo ou initiales
  const createAvatar = (username, name, size = '1.5rem', fontSize = '0.75rem') => {
    const initials = getInitials(name);
    const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'];
    const colorIndex = name.length % colors.length;
    const bgColor = colors[colorIndex];

    // Utiliser le timestamp actuel pour éviter le cache
    const timestamp = Date.now();

    return `
      <div class="user-avatar" data-username="${username || ''}" style="width: ${size}; height: ${size}; border-radius: 50%; background: ${bgColor}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: ${fontSize}; flex-shrink: 0; overflow: hidden; position: relative;">
        ${username ? `<img src="/cloud/signatures/${username}/profile_photo_${username}.png?v=${timestamp}" onerror="this.style.display='none'" style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;">` : ''}
        <span class="avatar-initials" style="position: relative; z-index: 1;">${initials}</span>
      </div>
    `;
  };

  // Générer les avatars pour les utilisateurs assignés
  let assignedHTML = '';
  if (task.assignedUsers && task.assignedUsers.length > 0) {
    // Si on a les informations détaillées des utilisateurs
    const avatarsHTML = task.assignedUsers.map(user => {
      const username = user.username || '';
      const name = user.name || user.username || 'Inconnu';
      return `
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          ${createAvatar(username, name, '1.5rem', '0.75rem')}
          <span style="color: var(--text-light); font-size: 0.875rem; font-weight: 500;">${name}</span>
        </div>
      `;
    }).join('');
    assignedHTML = avatarsHTML;
  } else if (task.assigned && task.assigned !== '-') {
    // Fallback: juste les noms sans usernames
    const assignedNames = task.assigned.split(',').map(n => n.trim());
    const avatarsHTML = assignedNames.map(name => {
      return `
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          ${createAvatar('', name, '1.5rem', '0.75rem')}
          <span style="color: var(--text-light); font-size: 0.875rem; font-weight: 500;">${name}</span>
        </div>
      `;
    }).join('');
    assignedHTML = avatarsHTML;
  } else {
    assignedHTML = '<span style="color: var(--text-gray); font-size: 0.875rem;">Non assigné</span>';
  }

  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
  `;

  modal.innerHTML = `
    <div style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 1rem; padding: 0; max-width: 650px; width: 90%; max-height: 85vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
      <!-- Header -->
      <div style="background: rgba(96, 165, 250, 0.1); border-bottom: 1px solid rgba(96, 165, 250, 0.2); padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="color: var(--text-light); margin: 0; font-size: 1.375rem; display: flex; align-items: center; gap: 0.75rem; font-weight: 700;">
          <i class="fas fa-clipboard-list" style="color: #60a5fa;"></i>
          <span>Détails de la tâche</span>
        </h3>
        <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; cursor: pointer; font-size: 1.25rem; padding: 0.5rem; width: 2.5rem; height: 2.5rem; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Content -->
      <div style="padding: 1.5rem; overflow-y: auto; max-height: calc(85vh - 120px);">
        <!-- Créé par (en haut) -->
        ${task.created_by ? `
        <div style="background: rgba(139, 92, 246, 0.08); border: 1px solid rgba(139, 92, 246, 0.25); border-radius: 0.5rem; padding: 0.625rem 0.875rem; margin-bottom: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-user-plus" style="color: #a78bfa; font-size: 0.75rem;"></i>
          ${createAvatar(task.created_by_username || '', task.created_by, '1.5rem', '0.75rem')}
          <span style="color: #c4b5fd; font-size: 0.875rem; font-weight: 600;">Créé par ${task.created_by}</span>
        </div>
        ` : ''}

        <!-- Titre -->
        <div style="background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1rem;">
          <label style="display: block; color: #60a5fa; margin-bottom: 0.75rem; font-weight: 700; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">
            <i class="fas fa-heading" style="margin-right: 0.5rem;"></i>Titre
          </label>
          <div style="color: var(--text-light); font-size: 1.125rem; font-weight: 600; line-height: 1.4;">${task.title}</div>
        </div>

        <!-- Informations principales -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
          <!-- Catégorie -->
          <div style="background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 0.75rem; padding: 1.25rem;">
            <label style="display: block; color: #60a5fa; margin-bottom: 0.75rem; font-weight: 700; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">
              <i class="fas fa-tag" style="margin-right: 0.5rem;"></i>Catégorie
            </label>
            <div>
              <span class="todo-badge ${badgeClass}" style="display: inline-block; font-size: 0.875rem; padding: 0.5rem 0.75rem; border-radius: 0.5rem;">
                ${task.category ? task.category.charAt(0).toUpperCase() + task.category.slice(1) : 'Non définie'}
              </span>
            </div>
          </div>

          <!-- Date de fin -->
          <div style="background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 0.75rem; padding: 1.25rem;">
            <label style="display: block; color: #60a5fa; margin-bottom: 0.75rem; font-weight: 700; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">
              <i class="fas fa-calendar-alt" style="margin-right: 0.5rem;"></i>Date de fin
            </label>
            <div style="color: var(--text-light); font-size: 1rem; font-weight: 600;">
              ${task.date ? formatDate(task.date) : '<span style="color: var(--text-gray);">Non définie</span>'}
            </div>
          </div>
        </div>

        <!-- Assigné à -->
        <div style="background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1rem;">
          <label style="display: block; color: #60a5fa; margin-bottom: 0.75rem; font-weight: 700; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">
            <i class="fas fa-users" style="margin-right: 0.5rem;"></i>Assigné à
          </label>
          <div>
            ${assignedHTML}
          </div>
        </div>

        <!-- Détails -->
        ${task.details && task.details.trim() ? `
        <div style="background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 0.75rem; padding: 1.25rem;">
          <label style="display: block; color: #60a5fa; margin-bottom: 0.75rem; font-weight: 700; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">
            <i class="fas fa-align-left" style="margin-right: 0.5rem;"></i>Détails
          </label>
          <div style="color: var(--text-light); line-height: 1.7; white-space: pre-wrap; font-size: 0.95rem;">${task.details}</div>
        </div>
        ` : `
        <div style="background: rgba(30, 41, 59, 0.3); border: 1px solid rgba(51, 65, 85, 0.3); border-radius: 0.75rem; padding: 1.25rem;">
          <label style="display: block; color: var(--text-gray); margin-bottom: 0.75rem; font-weight: 700; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">
            <i class="fas fa-align-left" style="margin-right: 0.5rem;"></i>Détails
          </label>
          <div style="color: var(--text-gray); font-style: italic; font-size: 0.95rem;">Aucun détail fourni</div>
        </div>
        `}
      </div>
    </div>
  `;

  // Fermer le modal en cliquant sur le fond
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.remove();
    }
  });

  document.body.appendChild(modal);
}

// Formater une date
function formatDate(dateStr) {
  if (!dateStr) return '-';
  // Parse la date en UTC pour éviter les problèmes de timezone
  const parts = dateStr.split('-');
  const date = new Date(parts[0], parts[1] - 1, parts[2]);
  const options = { day: 'numeric', month: 'long' };
  const formattedDate = date.toLocaleDateString('fr-CA', options);
  return `pour le ${formattedDate}`;
}

// ==================== GESTION DES PROBLÈMES HEBDOMADAIRES ====================

// Initialiser la semaine actuelle
function initWeekSelector() {
  const weekSelector = document.getElementById('week-selector');
  if (!weekSelector) return;

  // Définir la semaine actuelle par défaut
  const today = new Date();
  const year = today.getFullYear();
  const weekNumber = getWeekNumber(today);
  weekSelector.value = `${year}-W${String(weekNumber).padStart(2, '0')}`;

  // Charger les données de la semaine actuelle
  loadWeeklyProblem();
}

// Obtenir le numéro de semaine
function getWeekNumber(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

// Charger le problème de la semaine
async function loadWeeklyProblem() {
  const weekSelector = document.getElementById('week-selector');
  if (!weekSelector) {
    console.warn('[RPO] week-selector not found - skipping loadWeeklyProblem');
    return;
  }

  const weekValue = weekSelector.value; // Format: "2024-W12"

  if (!weekValue) return;

  try {
    const response = await fetch(`/api/coach/weekly-problem?coach_username=${coachUsername}&week=${weekValue}`);
    if (response.ok) {
      const data = await response.json();

      if (data.success && data.problem) {
        document.getElementById('problem-description').value = data.problem.description || '';
        document.getElementById('problem-impact').value = data.problem.impact || '';
        document.getElementById('problem-solution').value = data.problem.solution || '';
        
      } else {
        // Vider les champs si aucune donnée
        document.getElementById('problem-description').value = '';
        document.getElementById('problem-impact').value = '';
        document.getElementById('problem-solution').value = '';
        
      }
    }
  } catch (error) {
    console.error('[RPO] Erreur chargement problème:', error);
  }
}

// Sauvegarder le problème de la semaine
async function saveWeeklyProblem() {
  const weekSelector = document.getElementById('week-selector');
  const weekValue = weekSelector.value;

  if (!weekValue) {
    alert('Veuillez sélectionner une semaine');
    return;
  }

  const problemData = {
    coach_username: coachUsername,
    week: weekValue,
    description: document.getElementById('problem-description').value,
    impact: document.getElementById('problem-impact').value,
    solution: document.getElementById('problem-solution').value
  };

  try {
    const response = await fetch('/api/coach/weekly-problem', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(problemData)
    });

    if (response.ok) {
      
      alert('Problème de la semaine enregistré avec succès!');
    } else {
      console.error('[RPO] Erreur lors de la sauvegarde');
      alert('Erreur lors de la sauvegarde');
    }
  } catch (error) {
    console.error('[RPO] Erreur:', error);
    alert('Erreur lors de la sauvegarde');
  }
}

// Ouvrir le modal de résumé hebdomadaire
function openResumeModal() {
  // Pré-remplir le modal avec les données actuelles depuis les divs
  const macroDisplay = document.getElementById('macro-content-display');
  const microDisplay = document.getElementById('micro-content-display');
  const problemDisplay = document.getElementById('problem-content-display');

  document.getElementById('modal-macro-content').value = macroDisplay.textContent.trim() === 'Aucune donnée' ? '' : macroDisplay.textContent;
  document.getElementById('modal-micro-content').value = microDisplay.textContent.trim() === 'Aucune donnée' ? '' : microDisplay.textContent;
  document.getElementById('modal-problem-content').value = problemDisplay.textContent.trim() === 'Aucune donnée' ? '' : problemDisplay.textContent;

  // Afficher le modal
  const modal = document.getElementById('resume-modal');
  modal.style.display = 'flex';
}

// Fermer le modal de résumé hebdomadaire
function closeResumeModal() {
  const modal = document.getElementById('resume-modal');
  modal.style.display = 'none';
}

// Ouvrir le modal de suivi pour un entrepreneur
async function openSuiviModal(username, displayName) {
  selectedEntrepreneurUsername = username;
  selectedEntrepreneurDisplayName = displayName;

  // Mettre à jour le titre du modal
  document.getElementById('suivi-entrepreneur-name').textContent = displayName;

  // Réinitialiser le formulaire
  document.getElementById('suivi-form').reset();

  // Réinitialiser les dropdowns personnalisés
  selectObjectifHpap('', '-');
  selectObjectifEstims('', '-');
  selectObjectifVendu('', '-');
  selectSource('', 'Sélectionner...');
  selectTypeCoaching('', 'Sélectionner...');

  // Charger les données RPO de l'entrepreneur
  await loadEntrepreneurRPOData(username);

  // Ouvrir le modal
  const modal = document.getElementById('suivi-modal');
  modal.style.display = 'flex';
}

// Charger les données RPO de l'entrepreneur pour la semaine sélectionnée
async function loadEntrepreneurRPOData(username) {
  try {
    // Récupérer le fichier RPO de l'entrepreneur
    const response = await fetch(`/api/rpo/${username}`);
    if (!response.ok) {
      
      return;
    }

    const rpoData = await response.json();

    // Convertir le format de semaine (ex: "2026-W01" -> mois -2, semaine 1 en janvier)
    const weekParts = selectedWeekValue.split('-W');
    const year = parseInt(weekParts[0]);
    const weekNum = parseInt(weekParts[1]);

    // Calculer le mois relatif à partir de la semaine ISO
    const monthIndex = getMonthIndexFromWeek(year, weekNum);
    const weekOfMonth = getWeekOfMonthFromWeek(year, weekNum);

    

    // Accéder aux données hebdomadaires
    const weeklyData = rpoData?.weekly?.[monthIndex]?.[weekOfMonth];

    if (weeklyData) {
      // Afficher les données dans le modal
      document.getElementById('rpo-h-marketing').textContent = weeklyData.h_marketing || '-';
      document.getElementById('rpo-estimation').textContent = weeklyData.estimation || '0';
      document.getElementById('rpo-contract').textContent = weeklyData.contract || '0';
      document.getElementById('rpo-dollar').textContent = weeklyData.dollar ? `${weeklyData.dollar} $` : '0 $';
      document.getElementById('rpo-commentaire').textContent = weeklyData.commentaire || '-';

      
    } else {
      // Réinitialiser si pas de données
      document.getElementById('rpo-h-marketing').textContent = '-';
      document.getElementById('rpo-estimation').textContent = '0';
      document.getElementById('rpo-contract').textContent = '0';
      document.getElementById('rpo-dollar').textContent = '0 $';
      document.getElementById('rpo-commentaire').textContent = 'Aucune donnée RPO pour cette semaine';

      
    }
  } catch (error) {
    console.error('[RPO] Erreur chargement données:', error);
    document.getElementById('rpo-commentaire').textContent = 'Erreur de chargement des données RPO';
  }
}

// Fonction helper pour calculer le mois relatif à partir de la semaine ISO
function getMonthIndexFromWeek(year, weekNum) {
  const date = getDateFromWeek(year, weekNum);
  const currentMonth = new Date().getMonth();
  const targetMonth = date.getMonth();

  // Calculer la différence de mois (peut être négative pour les mois passés)
  let diff = targetMonth - currentMonth;

  // Ajuster pour les années différentes
  if (date.getFullYear() !== new Date().getFullYear()) {
    diff += (date.getFullYear() - new Date().getFullYear()) * 12;
  }

  return diff;
}

// Fonction helper pour calculer la semaine du mois à partir de la semaine ISO
function getWeekOfMonthFromWeek(year, weekNum) {
  const date = getDateFromWeek(year, weekNum);
  const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
  const dayOfMonth = date.getDate();

  // Calculer la semaine du mois (1-5)
  return Math.ceil((dayOfMonth + firstDayOfMonth.getDay()) / 7);
}

// Fermer le modal de suivi
function closeSuiviModal() {
  const modal = document.getElementById('suivi-modal');
  modal.style.display = 'none';
  selectedEntrepreneurUsername = '';
  selectedEntrepreneurDisplayName = '';
}

// === Fonctions pour les dropdowns du formulaire de suivi ===

// HPAP
function toggleObjectifHpapDropdown() {
  const dropdown = document.getElementById('objectif-hpap-dropdown');
  const menu = document.getElementById('objectif-hpap-menu');
  dropdown.classList.toggle('active');
  menu.classList.toggle('show');
}

function selectObjectifHpap(value, label) {
  document.getElementById('suivi-objectif-hpap').value = value;
  document.getElementById('objectif-hpap-selected').textContent = label;
  document.getElementById('objectif-hpap-dropdown').classList.remove('active');
  document.getElementById('objectif-hpap-menu').classList.remove('show');
}

// Estims
function toggleObjectifEstimsDropdown() {
  const dropdown = document.getElementById('objectif-estims-dropdown');
  const menu = document.getElementById('objectif-estims-menu');
  dropdown.classList.toggle('active');
  menu.classList.toggle('show');
}

function selectObjectifEstims(value, label) {
  document.getElementById('suivi-objectif-estims').value = value;
  document.getElementById('objectif-estims-selected').textContent = label;
  document.getElementById('objectif-estims-dropdown').classList.remove('active');
  document.getElementById('objectif-estims-menu').classList.remove('show');
}

// Vendu
function toggleObjectifVenduDropdown() {
  const dropdown = document.getElementById('objectif-vendu-dropdown');
  const menu = document.getElementById('objectif-vendu-menu');
  dropdown.classList.toggle('active');
  menu.classList.toggle('show');
}

function selectObjectifVendu(value, label) {
  document.getElementById('suivi-objectif-vendu').value = value;
  document.getElementById('objectif-vendu-selected').textContent = label;
  document.getElementById('objectif-vendu-dropdown').classList.remove('active');
  document.getElementById('objectif-vendu-menu').classList.remove('show');
}

// Source du problème
function toggleSourceDropdown() {
  const dropdown = document.getElementById('source-dropdown');
  const menu = document.getElementById('source-menu');
  dropdown.classList.toggle('active');
  menu.classList.toggle('show');
}

function selectSource(value, label) {
  document.getElementById('suivi-source').value = value;
  document.getElementById('source-selected').textContent = label;
  document.getElementById('source-dropdown').classList.remove('active');
  document.getElementById('source-menu').classList.remove('show');
}

// Type de coaching
function toggleTypeCoachingDropdown() {
  const dropdown = document.getElementById('type-coaching-dropdown');
  const menu = document.getElementById('type-coaching-menu');
  dropdown.classList.toggle('active');
  menu.classList.toggle('show');
}

function selectTypeCoaching(value, label) {
  document.getElementById('suivi-type-coaching').value = value;
  document.getElementById('type-coaching-selected').textContent = label;
  document.getElementById('type-coaching-dropdown').classList.remove('active');
  document.getElementById('type-coaching-menu').classList.remove('show');
}

// Sauvegarder les données de suivi
async function saveSuiviData(event) {
  event.preventDefault();

  const button = event.submitter || document.querySelector('#suivi-form + .modal-footer .btn-primary');
  const originalText = button.innerHTML;

  // Désactiver le bouton et afficher le spinner
  button.disabled = true;
  button.style.opacity = '0.6';
  button.style.cursor = 'not-allowed';
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Enregistrement...';

  const data = {
    coach_username: coachUsername,
    week: selectedWeekValue,
    entrepreneur_username: selectedEntrepreneurUsername,
    objectif_hpap: document.getElementById('suivi-objectif-hpap').value,
    objectif_estims: document.getElementById('suivi-objectif-estims').value,
    objectif_vendu: document.getElementById('suivi-objectif-vendu').value,
    probleme_semaine: document.getElementById('suivi-probleme').value,
    racine_probleme: document.getElementById('suivi-racine').value,
    source_probleme: document.getElementById('suivi-source').value,
    type_coaching: document.getElementById('suivi-type-coaching').value,
    plan_match: document.getElementById('suivi-plan').value,
    id: `${selectedEntrepreneurUsername}_${selectedWeekValue}_${Date.now()}`
  };

  try {
    const [response] = await Promise.all([
      fetch('/api/coach/weekly-entrepreneur-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }),
      new Promise(resolve => setTimeout(resolve, 500))
    ]);

    if (response.ok) {
      // Fermer le modal
      closeSuiviModal();

      // Recharger les données du tableau
      await loadWeeklyEntrepreneurData();

      // Afficher un message de succès
      
    } else {
      console.error('[SUIVI] Erreur lors de l\'enregistrement');
      alert('Erreur lors de l\'enregistrement du suivi');
    }
  } catch (error) {
    console.error('[SUIVI] Erreur:', error);
    alert('Erreur lors de l\'enregistrement du suivi');
  } finally {
    // Réactiver le bouton
    button.disabled = false;
    button.style.opacity = '1';
    button.style.cursor = 'pointer';
    button.innerHTML = originalText;
  }
}

// Sauvegarder les données du résumé depuis le modal
async function saveResumeData(event) {
  event.preventDefault();

  const button = event.submitter || document.querySelector('#resume-form + .modal-footer .btn-primary');
  const originalText = button.innerHTML;

  // Désactiver le bouton et afficher le spinner
  button.disabled = true;
  button.style.opacity = '0.6';
  button.style.cursor = 'not-allowed';
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Enregistrement...';

  const data = {
    direction_username: coachUsername,
    week: selectedWeekValue,
    macro: document.getElementById('modal-macro-content').value,
    micro: document.getElementById('modal-micro-content').value,
    problem: document.getElementById('modal-problem-content').value
  };

  try {
    // Délai minimum pour afficher le spinner
    const [response] = await Promise.all([
      fetch('/api/direction/macro-micro-problem', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }),
      new Promise(resolve => setTimeout(resolve, 500))
    ]);

    if (response.ok) {
      

      // Mettre à jour les divs d'affichage
      const macroDisplay = document.getElementById('macro-content-display');
      const microDisplay = document.getElementById('micro-content-display');
      const problemDisplay = document.getElementById('problem-content-display');

      macroDisplay.textContent = data.macro || 'Aucune donnée';
      macroDisplay.style.color = data.macro ? 'var(--text-light)' : 'var(--text-gray)';
      macroDisplay.style.fontStyle = data.macro ? 'normal' : 'italic';

      microDisplay.textContent = data.micro || 'Aucune donnée';
      microDisplay.style.color = data.micro ? 'var(--text-light)' : 'var(--text-gray)';
      microDisplay.style.fontStyle = data.micro ? 'normal' : 'italic';

      problemDisplay.textContent = data.problem || 'Aucune donnée';
      problemDisplay.style.color = data.problem ? 'var(--text-light)' : 'var(--text-gray)';
      problemDisplay.style.fontStyle = data.problem ? 'normal' : 'italic';

      // Mettre à jour le badge instantanément si c'est la semaine actuelle
      const currentWeekValue = getCurrentWeekValue();
      const isCurrentWeek = selectedWeekValue === currentWeekValue;
      const isFilled = !!(data.macro && data.micro && data.problem);
      updateCurrentWeekBadge(isCurrentWeek, isFilled);

      // Mettre à jour le bouton d'action
      updateResumeActionButton(!!data.macro, !!data.micro, !!data.problem);

      // Afficher succès
      button.innerHTML = '<i class="fas fa-check"></i>Enregistré!';

      // Fermer le modal après un court délai
      setTimeout(() => {
        closeResumeModal();
        button.innerHTML = originalText;
        button.disabled = false;
        button.style.opacity = '1';
        button.style.cursor = 'pointer';
      }, 1000);
    } else {
      throw new Error('Erreur lors de la sauvegarde');
    }
  } catch (error) {
    console.error('[RPO] Erreur:', error);
    alert('Erreur lors de la sauvegarde');
    button.innerHTML = originalText;
    button.disabled = false;
    button.style.opacity = '1';
    button.style.cursor = 'pointer';
  }
}

// Sauvegarder MACRO, MICRO et Problème
async function saveMacroMicroProblem() {
  const button = document.getElementById('resume-edit-btn');
  const originalText = button.innerHTML;

  // Désactiver le bouton et changer l'apparence
  button.disabled = true;
  button.style.opacity = '0.6';
  button.style.cursor = 'not-allowed';
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Enregistrement...';

  const data = {
    direction_username: coachUsername,
    week: selectedWeekValue,
    macro: document.getElementById('macro-content').value,
    micro: document.getElementById('micro-content').value,
    problem: document.getElementById('problem-content').value
  };

  try {
    // Délai minimum pour afficher le spinner
    const [response] = await Promise.all([
      fetch('/api/direction/macro-micro-problem', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }),
      new Promise(resolve => setTimeout(resolve, 500)) // Délai minimum de 500ms
    ]);

    if (response.ok) {
      
      button.innerHTML = '<i class="fas fa-check"></i>Enregistré!';
      setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
        button.style.opacity = '1';
        button.style.cursor = 'pointer';
      }, 2000);
    } else {
      throw new Error('Erreur lors de la sauvegarde');
    }
  } catch (error) {
    console.error('[RPO] Erreur:', error);
    alert('Erreur lors de la sauvegarde');
    button.innerHTML = originalText;
    button.disabled = false;
    button.style.opacity = '1';
    button.style.cursor = 'pointer';
  }
}

// Mettre à jour l'option de la semaine actuelle dans le dropdown
function updateCurrentWeekDropdownOption(isFilled) {
  const option = document.getElementById('current-week-dropdown-option');
  if (!option) return;

  const currentWeekLabel = getCurrentWeekLabelLong();

  if (isFilled) {
    // Vert - Complété
    option.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1))';
    option.style.borderLeft = '3px solid #10b981';
    option.style.color = '#10b981';
    option.innerHTML = `
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <span>${currentWeekLabel}</span>
        <span style="font-size: 0.75rem; opacity: 0.8;">Cette semaine - Complété</span>
      </div>
    `;
  } else {
    // Jaune - À remplir
    option.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(217, 119, 6, 0.1))';
    option.style.borderLeft = '3px solid #f59e0b';
    option.style.color = '#f59e0b';
    option.innerHTML = `
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <span>${currentWeekLabel}</span>
        <span style="font-size: 0.75rem; opacity: 0.8;">Cette semaine - À remplir</span>
      </div>
    `;
  }
}

// Mettre à jour le badge "Cette semaine"
function updateCurrentWeekBadge(isCurrentWeek, isFilled) {
  const badge = document.getElementById('current-week-badge');
  const dateRange = document.getElementById('current-week-date-range');
  const status = document.getElementById('current-week-status');
  const container = document.getElementById('resume-section-container');

  if (!badge || !dateRange || !status || !container) return;

  if (isCurrentWeek) {
    // Afficher le badge pour la semaine actuelle
    badge.style.display = 'block';
    dateRange.textContent = getCurrentWeekLabelLong();

    if (isFilled) {
      // Vert - Complété
      badge.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
      badge.style.borderColor = 'rgba(16, 185, 129, 0.3)';
      container.style.borderColor = 'rgba(16, 185, 129, 0.4)';
      status.innerHTML = '<i class="fas fa-check-circle"></i>Complété';
    } else {
      // Jaune - À remplir
      badge.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
      badge.style.borderColor = 'rgba(245, 158, 11, 0.3)';
      container.style.borderColor = 'rgba(245, 158, 11, 0.4)';
      status.innerHTML = '<i class="fas fa-exclamation-circle"></i>À remplir';
    }
  } else {
    // Masquer le badge pour les autres semaines
    badge.style.display = 'none';
    container.style.borderColor = 'rgba(51, 65, 85, 0.5)';
  }
}

// Mettre à jour le bouton d'action selon l'état des données
function updateResumeActionButton(hasMacro, hasMicro, hasProblem) {
  const button = document.getElementById('resume-action-btn');
  if (!button) return;

  // Si les trois champs sont remplis, afficher "Modifier" avec btn-secondary
  if (hasMacro && hasMicro && hasProblem) {
    button.innerHTML = '<i class="fas fa-edit"></i><span>Modifier</span>';
    button.className = 'btn-secondary';
  } else {
    button.innerHTML = '<i class="fas fa-edit"></i><span>Remplir mon résumé</span>';
    button.className = 'btn-primary';
  }
}

// Charger MACRO, MICRO et Problème pour la semaine sélectionnée
async function loadMacroMicroProblem() {
  if (!selectedWeekValue) {
    
    return;
  }

  try {
    const response = await fetch(`/api/direction/macro-micro-problem?direction_username=${coachUsername}&week=${selectedWeekValue}`);
    if (response.ok) {
      const data = await response.json();
      

      // Remplir les divs d'affichage avec les données
      const macroDisplay = document.getElementById('macro-content-display');
      const microDisplay = document.getElementById('micro-content-display');
      const problemDisplay = document.getElementById('problem-content-display');

      macroDisplay.textContent = data.macro || 'Aucune donnée';
      macroDisplay.style.color = data.macro ? 'var(--text-light)' : 'var(--text-gray)';
      macroDisplay.style.fontStyle = data.macro ? 'normal' : 'italic';
      macroDisplay.style.opacity = data.macro ? '0.7' : '1';

      microDisplay.textContent = data.micro || 'Aucune donnée';
      microDisplay.style.color = data.micro ? 'var(--text-light)' : 'var(--text-gray)';
      microDisplay.style.fontStyle = data.micro ? 'normal' : 'italic';
      microDisplay.style.opacity = data.micro ? '0.7' : '1';

      problemDisplay.textContent = data.problem || 'Aucune donnée';
      problemDisplay.style.color = data.problem ? 'var(--text-light)' : 'var(--text-gray)';
      problemDisplay.style.fontStyle = data.problem ? 'normal' : 'italic';
      problemDisplay.style.opacity = data.problem ? '0.7' : '1';

      // Réduire l'opacité des labels quand les données sont remplies
      const macroLabel = document.getElementById('macro-label');
      const microLabel = document.getElementById('micro-label');
      const problemLabel = document.getElementById('problem-label');

      if (macroLabel) macroLabel.style.opacity = data.macro ? '0.6' : '1';
      if (microLabel) microLabel.style.opacity = data.micro ? '0.6' : '1';
      if (problemLabel) problemLabel.style.opacity = data.problem ? '0.6' : '1';

      // Mettre à jour le badge si c'est la semaine actuelle
      const currentWeekValue = getCurrentWeekValue();
      const isCurrentWeek = selectedWeekValue === currentWeekValue;
      const isFilled = !!(data.macro && data.micro && data.problem);
      updateCurrentWeekBadge(isCurrentWeek, isFilled);

      // Mettre à jour l'option dans le dropdown si c'est la semaine actuelle
      if (isCurrentWeek) {
        updateCurrentWeekDropdownOption(isFilled);
      }

      // Mettre à jour le bouton d'action
      updateResumeActionButton(!!data.macro, !!data.micro, !!data.problem);
    } else {
      
      // Afficher "Aucune donnée" dans les divs
      const macroDisplay = document.getElementById('macro-content-display');
      const microDisplay = document.getElementById('micro-content-display');
      const problemDisplay = document.getElementById('problem-content-display');

      macroDisplay.textContent = 'Aucune donnée';
      macroDisplay.style.color = 'var(--text-gray)';
      macroDisplay.style.fontStyle = 'italic';
      macroDisplay.style.opacity = '1';

      microDisplay.textContent = 'Aucune donnée';
      microDisplay.style.color = 'var(--text-gray)';
      microDisplay.style.fontStyle = 'italic';
      microDisplay.style.opacity = '1';

      problemDisplay.textContent = 'Aucune donnée';
      problemDisplay.style.color = 'var(--text-gray)';
      problemDisplay.style.fontStyle = 'italic';
      problemDisplay.style.opacity = '1';

      // Réinitialiser l'opacité des labels
      const macroLabel = document.getElementById('macro-label');
      const microLabel = document.getElementById('micro-label');
      const problemLabel = document.getElementById('problem-label');

      if (macroLabel) macroLabel.style.opacity = '1';
      if (microLabel) microLabel.style.opacity = '1';
      if (problemLabel) problemLabel.style.opacity = '1';

      // Mettre à jour le badge si c'est la semaine actuelle
      const currentWeekValue = getCurrentWeekValue();
      const isCurrentWeek = selectedWeekValue === currentWeekValue;
      updateCurrentWeekBadge(isCurrentWeek, false);

      // Mettre à jour l'option dans le dropdown si c'est la semaine actuelle
      if (isCurrentWeek) {
        updateCurrentWeekDropdownOption(false);
      }

      // Mettre à jour le bouton d'action
      updateResumeActionButton(false, false, false);
    }
  } catch (error) {
    console.error('[RPO] Erreur lors du chargement:', error);
    // Afficher "Aucune donnée" en cas d'erreur
    const macroDisplay = document.getElementById('macro-content-display');
    const microDisplay = document.getElementById('micro-content-display');
    const problemDisplay = document.getElementById('problem-content-display');

    macroDisplay.textContent = 'Aucune donnée';
    macroDisplay.style.color = 'var(--text-gray)';
    macroDisplay.style.fontStyle = 'italic';
    macroDisplay.style.opacity = '1';

    microDisplay.textContent = 'Aucune donnée';
    microDisplay.style.color = 'var(--text-gray)';
    microDisplay.style.fontStyle = 'italic';
    microDisplay.style.opacity = '1';

    problemDisplay.textContent = 'Aucune donnée';
    problemDisplay.style.color = 'var(--text-gray)';
    problemDisplay.style.fontStyle = 'italic';
    problemDisplay.style.opacity = '1';

    // Réinitialiser l'opacité des labels
    const macroLabel = document.getElementById('macro-label');
    const microLabel = document.getElementById('micro-label');
    const problemLabel = document.getElementById('problem-label');

    if (macroLabel) macroLabel.style.opacity = '1';
    if (microLabel) microLabel.style.opacity = '1';
    if (problemLabel) problemLabel.style.opacity = '1';

    // Mettre à jour le bouton d'action
    updateResumeActionButton(false, false, false);
  }
}

// Charger le sélecteur de semaine au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
  // Attendre un court instant pour s'assurer que tout est chargé
  setTimeout(() => {
    initWeekSelector();
    initWeekSelectorTable();
    initResumeWeekSelector();
    // Le tableau est caché par défaut, pas besoin de le rendre
  }, 500);
});

// ==================== GESTION RPO HEBDOMADAIRE ENTREPRENEURS ====================

let entrepreneurWeeklyData = [];
let coachWeeklyData = [];

// Variable globale pour stocker la semaine sélectionnée
let selectedWeekValue = '';

// Initialiser le sélecteur de semaine du tableau (custom dropdown)
function initWeekSelectorTable() {
  const weekDropdownMenu = document.getElementById('week-dropdown-menu');
  const weekDropdownText = document.getElementById('week-dropdown-text');
  if (!weekDropdownMenu || !weekDropdownText) return;

  // Initialiser allWeeksData si ce n'est pas déjà fait
  initializeAllWeeksData();

  // Remplir le dropdown avec les semaines de allWeeksData
  weekDropdownMenu.innerHTML = '';
  let firstWeekValue = '';
  let firstWeekLabel = '';

  allWeeksData.forEach((week, index) => {
    const option = document.createElement('div');
    option.className = 'dropdown-secondary-option';
    option.textContent = week.label;
    option.onclick = (e) => {
      e.stopPropagation();
      selectWeek(week.value, week.label);
    };
    weekDropdownMenu.appendChild(option);

    // La première semaine de 2026 (index 1, car index 0 = Décembre 2025)
    if (index === 1) {
      firstWeekValue = week.value;
      firstWeekLabel = week.label;
    }
  });

  // Sélectionner la première semaine de 2026 par défaut
  selectedWeekValue = firstWeekValue;
  weekDropdownText.textContent = firstWeekLabel;

  // Charger les données de la semaine sélectionnée (tableau ET MACRO/MICRO/Problème)
  loadWeeklyEntrepreneurData();
  loadMacroMicroProblem();

  // Initialiser l'état read-only pour le tableau
  const tableContainer = document.getElementById('suivi-table-container');
  if (tableContainer) {
    tableContainer.classList.add('table-readonly');
  }
}

// Initialiser le sélecteur de semaine pour Résumé hebdomadaire (MACRO/MICRO/Problème)
function initResumeWeekSelector() {
  const weekDropdownMenu = document.getElementById('resume-week-dropdown-menu');
  const weekDropdownText = document.getElementById('resume-week-dropdown-text');
  if (!weekDropdownMenu || !weekDropdownText) return;

  const monthNames = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin',
                      'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];

  weekDropdownMenu.innerHTML = '';

  // ===== SEMAINE ACTUELLE (dynamique basée sur la date du jour) =====
  const currentWeekLabel = getCurrentWeekLabelLong();
  const currentWeekValue = getCurrentWeekValue();

  // Déterminer si la semaine actuelle est remplie (on charge les données de manière synchrone si disponibles)
  // Pour l'instant, on affiche toujours "À remplir" et ça sera mis à jour après le chargement
  const currentOption = document.createElement('div');
  currentOption.className = 'dropdown-secondary-option';
  currentOption.id = 'current-week-dropdown-option'; // ID pour pouvoir le mettre à jour après

  // Style jaune pour "Cette semaine - À remplir"
  currentOption.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(217, 119, 6, 0.1))';
  currentOption.style.borderLeft = '3px solid #f59e0b';
  currentOption.style.fontWeight = '600';
  currentOption.style.color = '#f59e0b';
  currentOption.innerHTML = `
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <span>${currentWeekLabel}</span>
      <span style="font-size: 0.75rem; opacity: 0.8;">Cette semaine - À remplir</span>
    </div>
  `;

  currentOption.onclick = (e) => {
    e.stopPropagation();
    selectResumeWeek(currentWeekValue, currentWeekLabel);
  };
  weekDropdownMenu.appendChild(currentOption);

  // ===== SEMAINES DE 2026 =====
  const year2026 = 2026;
  let currentDate = new Date(year2026, 0, 1);
  const dayOfWeek = currentDate.getDay();
  if (dayOfWeek !== 1) {
    const daysUntilMonday = dayOfWeek === 0 ? 1 : 8 - dayOfWeek;
    currentDate.setDate(currentDate.getDate() + daysUntilMonday);
  }

  let weekNumber = 1;

  while (currentDate.getFullYear() === year2026) {
    const monday = new Date(currentDate);
    const sunday = new Date(currentDate);
    sunday.setDate(sunday.getDate() + 6);

    const mondayDay = monday.getDate();
    const mondayMonth = monthNames[monday.getMonth()];
    const sundayDay = sunday.getDate();
    const sundayMonth = monthNames[sunday.getMonth()];

    let weekLabel;
    if (monday.getMonth() === sunday.getMonth()) {
      weekLabel = `${mondayDay} ${mondayMonth} - ${sundayDay} ${mondayMonth}`;
    } else {
      weekLabel = `${mondayDay} ${mondayMonth} - ${sundayDay} ${sundayMonth}`;
    }

    const weekValue = `${year2026}-W${String(weekNumber).padStart(2, '0')}`;

    // Ne pas ajouter la semaine si elle est déjà ajoutée comme semaine actuelle
    if (weekValue !== currentWeekValue) {
      const option = document.createElement('div');
      option.className = 'dropdown-secondary-option';
      option.textContent = weekLabel;
      option.onclick = (e) => {
        e.stopPropagation();
        selectResumeWeek(weekValue, weekLabel);
      };
      weekDropdownMenu.appendChild(option);
    }

    currentDate.setDate(currentDate.getDate() + 7);
    weekNumber++;
  }

  // Sélectionner la semaine actuelle par défaut
  selectedWeekValue = currentWeekValue;
  weekDropdownText.textContent = currentWeekLabel;

  // Charger les données de la semaine actuelle
  loadMacroMicroProblem();
}

// Toggle le dropdown de semaine pour Résumé hebdomadaire
function toggleResumeWeekDropdown() {
  const dropdown = document.getElementById('resume-week-dropdown');
  const menu = document.getElementById('resume-week-dropdown-menu');

  dropdown.classList.toggle('active');
  if (menu.style.display === 'none' || menu.style.display === '') {
    menu.style.display = 'block';
    menu.classList.add('show');
  } else {
    menu.style.display = 'none';
    menu.classList.remove('show');
  }
}

// Sélectionner une semaine dans le dropdown Résumé hebdomadaire
function selectResumeWeek(weekValue, weekLabel) {
  selectedWeekValue = weekValue;
  document.getElementById('resume-week-dropdown-text').textContent = weekLabel;

  // Fermer le dropdown
  const dropdown = document.getElementById('resume-week-dropdown');
  const menu = document.getElementById('resume-week-dropdown-menu');
  dropdown.classList.remove('active');
  menu.style.display = 'none';
  menu.classList.remove('show');

  // Charger UNIQUEMENT les données MACRO/MICRO/Problème de la semaine sélectionnée
  loadMacroMicroProblem();

  // NE PAS synchroniser avec le dropdown du tableau - ils sont indépendants
}

// Toggle le dropdown de semaine
function toggleWeekDropdown() {
  const dropdown = document.getElementById('week-dropdown');
  const menu = document.getElementById('week-dropdown-menu');

  // Toggle la classe active et le menu
  dropdown.classList.toggle('active');
  if (menu.style.display === 'none' || menu.style.display === '') {
    menu.style.display = 'block';
    menu.classList.add('show');
  } else {
    menu.style.display = 'none';
    menu.classList.remove('show');
  }
}

// Sélectionner une semaine dans le dropdown
function selectWeek(weekValue, weekLabel) {
  selectedWeekValue = weekValue;
  document.getElementById('week-dropdown-text').textContent = weekLabel;

  // Fermer le dropdown
  const dropdown = document.getElementById('week-dropdown');
  const menu = document.getElementById('week-dropdown-menu');
  dropdown.classList.remove('active');
  menu.style.display = 'none';
  menu.classList.remove('show');

  // NE PAS synchroniser avec le dropdown de Résumé hebdomadaire - ils sont indépendants

  // Charger UNIQUEMENT les données du tableau (pas MACRO/MICRO/Problème)
  loadWeeklyEntrepreneurData();
}

// Ouvrir le modal de sélection de coach
async function openCoachSelectionModal() {
  const modal = document.getElementById('coach-selection-modal');
  modal.style.display = 'flex';

  // Charger les coachs disponibles
  await loadAvailableCoaches();
}

// Fermer le modal de sélection de coach
function closeCoachSelectionModal() {
  const modal = document.getElementById('coach-selection-modal');
  modal.style.display = 'none';
}

// Charger tous les coachs disponibles
async function loadAvailableCoaches() {
  const list = document.getElementById('coach-selection-list');
  const noMessage = document.getElementById('no-coach-selection-message');

  list.innerHTML = '<div style="padding: 1rem; color: var(--text-gray); text-align: center;"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>';
  noMessage.style.display = 'none';

  try {
    // Utiliser l'API pour obtenir TOUS les coachs
    const response = await fetch('/api/users/coaches');

    if (response.ok) {
      const data = await response.json();
      list.innerHTML = '';

      if (data.success && data.coaches && data.coaches.length > 0) {
        data.coaches.forEach(coach => {
          const card = document.createElement('div');
          card.style.cssText = 'padding: 1rem; background: rgba(51, 65, 85, 0.3); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.75rem;';

          const displayName = coach.prenom && coach.nom
            ? `${coach.prenom} ${coach.nom}`
            : coach.username;

          card.innerHTML = `
            <i class="fas fa-chalkboard-teacher" style="color: #8b5cf6; font-size: 1.5rem;"></i>
            <span style="color: var(--text-light); font-weight: 500;">${displayName}</span>
          `;

          card.onmouseover = () => {
            card.style.background = 'rgba(139, 92, 246, 0.15)';
            card.style.borderColor = 'rgba(139, 92, 246, 0.3)';
          };

          card.onmouseout = () => {
            card.style.background = 'rgba(51, 65, 85, 0.3)';
            card.style.borderColor = 'rgba(51, 65, 85, 0.6)';
          };

          card.onclick = () => {
            selectCoach(coach.username, displayName);
          };

          list.appendChild(card);
        });
      } else {
        list.innerHTML = '';
        noMessage.style.display = 'block';
      }
    } else {
      list.innerHTML = '<div style="padding: 1rem; color: #ef4444; text-align: center;"><i class="fas fa-exclamation-triangle"></i> Erreur de chargement</div>';
    }
  } catch (error) {
    console.error('[COACH SELECTION] Erreur:', error);
    list.innerHTML = '<div style="padding: 1rem; color: #ef4444; text-align: center;"><i class="fas fa-exclamation-triangle"></i> Erreur de chargement</div>';
  }
}

// Variables globales pour le coach sélectionné
let selectedCoachForView = null;
let selectedCoachDisplayName = null;
let allWeeksData = [];

// Fonction pour initialiser allWeeksData (sans dépendre du DOM)
// Génère les semaines EXACTEMENT comme dans le plan d'affaires entrepreneur
function initializeAllWeeksData() {
  if (allWeeksData.length > 0) return; // Déjà initialisé

  // Date de départ: 5 janvier 2026 (lundi)
  const startDate = new Date(2026, 0, 5); // 5 janvier 2026

  // Générer 52 semaines (du 5 janvier au 27 décembre 2026)
  const totalWeeks = 52;
  let weekCounter2026 = 1;

  for (let i = 1; i <= totalWeeks; i++) {
    // Génération continue des dates depuis le 5 janvier 2026
    const weekStartDate = new Date(startDate.getTime() + ((i - 1) * 7 * 24 * 60 * 60 * 1000));
    const weekEndDate = new Date(weekStartDate.getTime() + (6 * 24 * 60 * 60 * 1000));

    // Format: "5 janv. - 11 janv."
    const startDay = weekStartDate.getDate();
    const endDay = weekEndDate.getDate();
    const startMonth = weekStartDate.toLocaleDateString('fr-FR', { month: 'short' });
    const endMonth = weekEndDate.toLocaleDateString('fr-FR', { month: 'short' });

    let dateRangeStr;
    let weekValue;

    // Toutes les semaines sont en 2026
    if (startMonth === endMonth) {
      dateRangeStr = `${startDay} - ${endDay} ${startMonth.replace('.', '')}`;
    } else {
      dateRangeStr = `${startDay} ${startMonth.replace('.', '')} - ${endDay} ${endMonth.replace('.', '')}`;
    }
    weekValue = `2026-W${String(weekCounter2026).padStart(2, '0')}`;
    weekCounter2026++;

    allWeeksData.push({ value: weekValue, label: dateRangeStr });
  }

  
  
  
}

// Afficher un spinner de chargement sur le plan d'affaire
function showPlanLoadingSpinner() {
  const planSection = document.getElementById('stats-plan-affaire');
  if (!planSection) return;

  // Créer l'overlay avec spinner s'il n'existe pas déjà
  let overlay = document.getElementById('plan-loading-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'plan-loading-overlay';
    overlay.style.cssText = `
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
      z-index: 100;
    `;
    overlay.innerHTML = `
      <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary-blue); margin-bottom: 1rem;"></i>
      <div style="color: white; font-size: 1rem;">Chargement du plan d'affaire...</div>
    `;
    planSection.style.position = 'relative';
    planSection.appendChild(overlay);
  }
  overlay.style.display = 'flex';
}

// Cacher le spinner de chargement
function hidePlanLoadingSpinner() {
  const overlay = document.getElementById('plan-loading-overlay');
  if (overlay) {
    overlay.style.display = 'none';
  }
}

// Réinitialiser complètement l'affichage des statistiques
function resetStatsDisplay() {
  

  // 1. Réinitialiser les cartes métriques (les cacher par défaut)
  const metricsCards = document.getElementById('team-metrics-cards');
  if (metricsCards) {
    metricsCards.style.display = 'none';
  }

  // 2. Afficher le bouton "Créer plan d'affaires" par défaut
  const createBtn = document.getElementById('create-business-plan-btn');
  if (createBtn) {
    createBtn.style.display = 'block';
  }

  // 3. Cacher le bouton "Modifier" par défaut
  const editBtn = document.getElementById('edit-business-plan-btn');
  if (editBtn) {
    editBtn.style.display = 'none';
  }

  // 4. Cacher le tableau du plan d'affaire par défaut
  const planTable = document.querySelector('#stats-plan-affaire .plan-scroll-container');
  if (planTable) {
    planTable.style.display = 'none';
  }

  // 4b. Vider le contenu du tableau pour éviter de voir les anciennes données
  const tbody = document.getElementById('stats-plan-weeks-body');
  if (tbody) {
    tbody.innerHTML = '';
  }

  // 5. Réinitialiser les valeurs des métriques
  const teamObjectifValue = document.getElementById('team-objectif-value');
  const teamObjectifPlaceholder = document.getElementById('team-objectif-placeholder');
  if (teamObjectifValue) {
    teamObjectifValue.textContent = '0,00 $';
    teamObjectifValue.style.display = 'none';
  }
  if (teamObjectifPlaceholder) teamObjectifPlaceholder.style.display = 'block';

  const coachCmValue = document.getElementById('coach-cm-value');
  const coachCmPlaceholder = document.getElementById('coach-cm-placeholder');
  if (coachCmValue) {
    coachCmValue.textContent = '0,00 $';
    coachCmValue.style.display = 'none';
  }
  if (coachCmPlaceholder) coachCmPlaceholder.style.display = 'block';

  const coachRatioValue = document.getElementById('coach-ratio-value');
  const coachRatioPlaceholder = document.getElementById('coach-ratio-placeholder');
  if (coachRatioValue) {
    coachRatioValue.textContent = '0 %';
    coachRatioValue.style.display = 'none';
  }
  if (coachRatioPlaceholder) coachRatioPlaceholder.style.display = 'block';

  const coachTauxValue = document.getElementById('coach-taux-value');
  const coachTauxPlaceholder = document.getElementById('coach-taux-placeholder');
  if (coachTauxValue) {
    coachTauxValue.textContent = '0 %';
    coachTauxValue.style.display = 'none';
  }
  if (coachTauxPlaceholder) coachTauxPlaceholder.style.display = 'block';

  
}

// Sélectionner un coach pour voir son suivi
async function selectCoach(username, displayName) {
  

  // Fermer le modal de sélection
  closeCoachSelectionModal();

  // AFFICHER LE SPINNER FULLSCREEN IMMÉDIATEMENT
  const coachSpinner = document.getElementById('coach-loading-spinner');
  if (coachSpinner) {
    coachSpinner.style.display = 'flex';
  }

  // Mettre à jour les variables globales
  selectedCoachForView = username;
  selectedCoachDisplayName = displayName;

  try {
    // Attendre un petit délai pour que le spinner s'affiche bien
    await new Promise(resolve => setTimeout(resolve, 100));

    // Mettre à jour le titre
    const title = document.querySelector('.box-header-title');
    if (title && title.textContent === 'Suivi hebdomadaire des coachs') {
      title.textContent = `Cette semaine - ${displayName}`;
    }

    // Afficher le badge, le tableau et cacher le bouton et le message
    const badge = document.getElementById('selected-coach-badge');
    const nameSpan = document.getElementById('selected-coach-name');
    const button = document.getElementById('suivi-action-btn');
    const tableContainer = document.getElementById('coach-table-container');
    const noCoachMessage = document.getElementById('no-coach-message');

    if (badge && nameSpan) {
      nameSpan.textContent = displayName;
      badge.style.display = 'flex';
    }

    if (button) {
      button.style.display = 'none';
    }

    // Cacher le message et afficher le tableau
    if (noCoachMessage) {
      noCoachMessage.style.display = 'none';
    }

    if (tableContainer) {
      tableContainer.style.display = 'block';
    }

    // NE PAS afficher le bouton "Enregistrer" automatiquement
    // Il n'apparaîtra que lorsque l'utilisateur modifie quelque chose

    // Réinitialiser le filtre de mois au mois actuel (Janvier 2026)
    selectedMonthFilter = '01';
    const monthLabel = document.getElementById('selected-month-label');
    if (monthLabel) {
      monthLabel.textContent = 'Janvier';
    }

    // IMPORTANT: Réinitialiser complètement l'affichage des statistiques AVANT de charger les nouvelles données
    resetStatsDisplay();

    // Charger les données pour toutes les semaines de ce coach
    
    await loadAllWeeksForCoach(username);

    // Recharger aussi le tableau du plan d'affaire
    
    if (typeof initTeamPlan === 'function') {
      await initTeamPlan();
    }

    // Recharger le plan d'affaire et les statistiques pour le coach sélectionné
    // IMPORTANT: Appeler APRÈS initTeamPlan pour que l'affichage soit correct
    
    await checkAndToggleBusinessPlanView();

    
  } finally {
    // Toujours cacher le spinner fullscreen, même en cas d'erreur
    if (coachSpinner) {
      coachSpinner.style.display = 'none';
    }
  }
}

// Fonction pour réinitialiser la sélection
function clearCoachSelection() {
  // Réinitialiser les variables globales
  selectedCoachForView = null;
  selectedCoachDisplayName = null;
  coachWeeklyData = [];

  // Réinitialiser le titre
  const title = document.querySelector('.box-header-title');
  if (title) {
    title.textContent = 'Suivi hebdomadaire des coachs';
  }

  // Cacher le badge, le tableau et réafficher le bouton et le message
  const badge = document.getElementById('selected-coach-badge');
  const button = document.getElementById('suivi-action-btn');
  const tableContainer = document.getElementById('coach-table-container');
  const noCoachMessage = document.getElementById('no-coach-message');

  if (badge) {
    badge.style.display = 'none';
  }

  if (button) {
    button.style.display = 'block';
  }

  // Cacher le bouton "Enregistrer"
  const saveBtn = document.getElementById('save-all-btn');
  if (saveBtn) {
    saveBtn.style.display = 'none';
  }

  // Cacher le tableau et afficher le message
  if (tableContainer) {
    tableContainer.style.display = 'none';
  }

  if (noCoachMessage) {
    noCoachMessage.style.display = 'flex';
  }

  // Réinitialiser le tableau
  renderEntrepreneurWeeklyTable();

  // Réinitialiser le filtre de mois au mois actuel (Janvier 2026)
  selectedMonthFilter = '01';
  const monthLabel = document.getElementById('selected-month-label');
  if (monthLabel) {
    monthLabel.textContent = 'Janvier';
  }
}

// ================================================================
// GESTION DU FILTRE DE MOIS
// ================================================================

let selectedMonthFilter = '01'; // Format: "01", "02", etc. - Default: Janvier 2026
let selectedCoachUsername = null; // Coach sélectionné pour le suivi hebdomadaire

// Toggle le dropdown du filtre de mois
function toggleMonthFilterDropdown() {
  event.stopPropagation();

  const dropdown = document.querySelector('.rpo-month-filter-dropdown');
  const menu = document.getElementById('month-filter-menu');

  if (!dropdown || !menu) return;

  const isActive = dropdown.classList.contains('active');

  if (isActive) {
    dropdown.classList.remove('active');
    menu.style.display = 'none';
  } else {
    dropdown.classList.add('active');
    menu.style.display = 'block';
  }
}

// Sélectionner un mois dans le filtre
function selectMonthFilter(event, monthValue, monthLabel) {
  event.stopPropagation();

  // Mettre à jour la variable globale
  selectedMonthFilter = monthValue;

  // Mettre à jour l'affichage
  const label = document.getElementById('selected-month-label');
  if (label) {
    label.textContent = monthLabel;
  }

  // Fermer le dropdown
  const dropdown = document.querySelector('.rpo-month-filter-dropdown');
  const menu = document.getElementById('month-filter-menu');

  if (dropdown) dropdown.classList.remove('active');
  if (menu) menu.style.display = 'none';

  // Re-render le tableau avec le filtre appliqué
  renderEntrepreneurWeeklyTable();

  // Si un coach est sélectionné, re-render aussi le tableau coach
  if (selectedCoachForView) {
    
    renderCoachWeeklyTable();
  }

  
}

// Fermer le dropdown si on clique ailleurs
document.addEventListener('click', function(event) {
  const dropdown = document.querySelector('.rpo-month-filter-dropdown');
  const menu = document.getElementById('month-filter-menu');

  if (dropdown && menu && !dropdown.contains(event.target)) {
    dropdown.classList.remove('active');
    menu.style.display = 'none';
  }
});

// ================================================================
// GESTION DES DROPDOWNS INLINE DANS LE TABLEAU
// ================================================================

// Toggle dropdown inline
function toggleInlineDropdown(element, field, entryId) {
  event.stopPropagation();

  const menu = element.querySelector('.dropdown-secondary-menu');
  const isActive = element.classList.contains('active');

  // Fermer tous les autres dropdowns
  document.querySelectorAll('.inline-table-dropdown.active').forEach(dropdown => {
    dropdown.classList.remove('active');
    const otherMenu = dropdown.querySelector('.dropdown-secondary-menu');
    if (otherMenu) otherMenu.style.display = 'none';
  });

  // Toggle current dropdown
  if (!isActive) {
    element.classList.add('active');
    if (menu) menu.style.display = 'block';
  }
}

// Sélectionner une option dans un dropdown inline
async function selectInlineOption(event, entryId, field, value) {
  event.stopPropagation();

  // Trouver le dropdown parent
  const dropdown = event.target.closest('.inline-table-dropdown');
  const selectedSpan = dropdown.querySelector('.dropdown-selected');

  // Mettre à jour l'affichage
  selectedSpan.textContent = value;
  dropdown.setAttribute('data-value', value);

  // Fermer le dropdown
  dropdown.classList.remove('active');
  const menu = dropdown.querySelector('.dropdown-secondary-menu');
  if (menu) menu.style.display = 'none';

  // Sauvegarder immédiatement
  await saveInlineChange(entryId, field, value);
}

// Sauvegarder une modification de textarea
async function saveInlineTextarea(element, entryId, field) {
  const value = element.value.trim();
  await saveInlineChange(entryId, field, value);
}

// Fonction générique de sauvegarde
async function saveInlineChange(entryId, field, value) {
  try {
    // Trouver l'entrée dans les données
    const entry = entrepreneurWeeklyData.find(e => e.id === entryId);
    if (!entry) {
      console.error('[INLINE SAVE] Entry not found:', entryId);
      return;
    }

    // Mapper les noms de champs
    const fieldMapping = {
      'hpap': 'objectif_hpap',
      'estims': 'objectif_estims',
      'vendu': 'objectif_vendu',
      'probleme_semaine': 'probleme_semaine',
      'racine_probleme': 'racine_probleme',
      'source_probleme': 'source_probleme',
      'type_coaching': 'type_coaching',
      'plan_match': 'plan_match'
    };

    const actualField = fieldMapping[field] || field;

    // Mettre à jour localement
    entry[actualField] = value;

    // Créer un ID unique si l'entrée n'en a pas
    if (!entry.id) {
      entry.id = `${selectedEntrepreneurForView}_${entry.week_label}`;
    }

    // Préparer les données pour l'API
    const updateData = {
      coach_username: coachUsername,
      week: entry.week_value,
      id: entry.id,
      entrepreneur_username: selectedEntrepreneurForView,
      week_label: entry.week_label,
      objectif_hpap: entry.objectif_hpap || '',
      objectif_estims: entry.objectif_estims || '',
      objectif_vendu: entry.objectif_vendu || '',
      probleme_semaine: entry.probleme_semaine || '',
      racine_probleme: entry.racine_probleme || '',
      source_probleme: entry.source_probleme || '',
      type_coaching: entry.type_coaching || '',
      plan_match: entry.plan_match || ''
    };

    // Sauvegarder via l'API
    const response = await fetch('/api/coach/weekly-entrepreneur-data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updateData)
    });

    if (response.ok) {
      

      // Animation de feedback visuel
      const cell = document.querySelector(`[data-entry-id="${entryId}"] [data-field="${field}"]`)?.closest('td');
      if (cell) {
        cell.style.background = 'rgba(34, 197, 94, 0.2)';
        setTimeout(() => {
          cell.style.background = '';
        }, 500);
      }
    } else {
      throw new Error('Save failed');
    }

  } catch (error) {
    console.error('[INLINE SAVE] Error:', error);
    alert('Erreur lors de la sauvegarde');
  }
}

// Charger toutes les semaines pour un entrepreneur
async function loadAllWeeksForEntrepreneur(username) {
  entrepreneurWeeklyData = [];

  // S'assurer que allWeeksData est initialisé
  if (!allWeeksData || allWeeksData.length === 0) {
    console.warn('[LOAD ALL WEEKS] allWeeksData vide, initialisation...');
    await initializeAllWeeksData();
  }

  // Utiliser allWeeksData qui est déjà généré globalement (contient Décembre 2025 + toutes les semaines 2026)
  const allWeeks = allWeeksData.map(week => ({
    weekValue: week.value,
    weekLabel: week.label
  }));

  

  // Charger les données pour TOUTES les semaines EN PARALLÈLE
  const weekPromises = allWeeks.map(async (week) => {
    let weekEntry = null;

    try {
      const response = await fetch(`/api/coach/weekly-entrepreneur-data?coach_username=${coachUsername}&week=${week.weekValue}`);
      if (response.ok) {
        const data = await response.json();

        // Filtrer pour cet entrepreneur
        if (data.entries && Array.isArray(data.entries)) {
          const entrepreneurData = data.entries.filter(entry => entry.entrepreneur_username === username);

          if (entrepreneurData.length > 0) {
            // Essayer de trouver l'entrée avec l'ID qui correspond au pattern attendu
            const expectedId = `${username}_${week.weekLabel}`;
            weekEntry = entrepreneurData.find(e => e.id === expectedId);

            // Si pas trouvé avec l'ID exact, prendre la première entrée qui a un ID valide
            if (!weekEntry) {
              weekEntry = entrepreneurData.find(e => e.id && e.id !== null);
            }

            // Si toujours pas trouvé, prendre la première entrée
            if (!weekEntry) {
              weekEntry = entrepreneurData[0];
            }
          }
        }
      }
    } catch (error) {
      console.error(`[LOAD ALL WEEKS] Erreur pour la semaine ${week.weekValue}:`, error);
    }

    // Retourner l'entrée pour cette semaine (avec ou sans données)
    if (weekEntry) {
      // On a des données pour cette semaine - mettre à jour avec les nouveaux labels/values
      weekEntry.week_label = week.weekLabel;
      weekEntry.week_value = week.weekValue;
      weekEntry.entrepreneur_display_name = selectedEntrepreneurDisplayName;
      // Mettre à jour l'ID pour correspondre au nouveau format
      weekEntry.id = `${username}_${week.weekLabel}`;
      return weekEntry;
    } else {
      // Pas de données, créer une entrée vide
      return {
        week_label: week.weekLabel,
        week_value: week.weekValue,
        entrepreneur_username: username,
        entrepreneur_display_name: selectedEntrepreneurDisplayName,
        objectif_hpap: '-',
        objectif_estims: '-',
        objectif_vendu: '-',
        probleme_semaine: '-',
        racine_probleme: '-',
        source_probleme: '-',
        type_coaching: '-',
        plan_match: '-'
      };
    }
  });

  // Attendre que TOUTES les requêtes soient terminées
  entrepreneurWeeklyData = await Promise.all(weekPromises);

  

  // Rafraîchir le tableau
  renderEntrepreneurWeeklyTable();
}

// Charger toutes les semaines pour un coach (pour Direction RPO)
async function loadAllWeeksForCoach(username) {
  coachWeeklyData = [];

  // S'assurer que allWeeksData est initialisé
  if (!allWeeksData || allWeeksData.length === 0) {
    console.warn('[LOAD ALL WEEKS COACH] allWeeksData vide, initialisation...');
    await initializeAllWeeksData();
  }

  // Utiliser allWeeksData qui est déjà généré globalement
  const allWeeks = allWeeksData.map(week => ({
    weekValue: week.value,
    weekLabel: week.label
  }));

  

  // Charger les données pour TOUTES les semaines EN PARALLÈLE
  const weekPromises = allWeeks.map(async (week) => {
    try {
      // Créer un ID unique basé sur coach + week_label
      const uniqueId = `${username}_${week.weekLabel}`;

      // Essayer de charger les données depuis l'API
      const response = await fetch(`/api/direction/coach-weekly-data?id=${encodeURIComponent(uniqueId)}`);

      if (response.ok) {
        const result = await response.json();

        if (result.success && result.data) {
          // Données trouvées dans la DB
          return {
            week_label: week.weekLabel,
            week_value: week.weekValue,
            coach_username: username,
            coach_display_name: selectedCoachDisplayName,
            notes_hebdo: result.data.notes_hebdo || ''
          };
        }
      }
    } catch (err) {
      console.warn(`[LOAD WEEK COACH] Erreur pour ${week.weekLabel}:`, err);
    }

    // Pas de données ou erreur, créer une entrée vide
    return {
      week_label: week.weekLabel,
      week_value: week.weekValue,
      coach_username: username,
      coach_display_name: selectedCoachDisplayName,
      notes_hebdo: ''
    };
  });

  // Attendre que TOUTES les requêtes soient terminées
  coachWeeklyData = await Promise.all(weekPromises);

  

  // Rafraîchir le tableau
  renderCoachWeeklyTable();
}

// ================================================================
// GESTION DES DROPDOWNS INLINE DANS LE TABLEAU
// ================================================================

// Toggle dropdown inline
function toggleInlineDropdown(element, field, entryId) {
  event.stopPropagation();

  const menu = element.querySelector('.dropdown-secondary-menu');
  const isActive = element.classList.contains('active');

  // Fermer tous les autres dropdowns
  document.querySelectorAll('.inline-table-dropdown.active').forEach(dropdown => {
    dropdown.classList.remove('active');
    const otherMenu = dropdown.querySelector('.dropdown-secondary-menu');
    if (otherMenu) otherMenu.style.display = 'none';
  });

  // Toggle current dropdown
  if (!isActive) {
    element.classList.add('active');
    if (menu) menu.style.display = 'block';
  }
}

// Sélectionner une option dans un dropdown inline
async function selectInlineOption(event, entryId, field, value) {
  event.stopPropagation();

  // Trouver le dropdown parent
  const dropdown = event.target.closest('.inline-table-dropdown');
  const selectedSpan = dropdown.querySelector('.dropdown-selected');

  // Mettre à jour l'affichage
  selectedSpan.textContent = value;
  dropdown.setAttribute('data-value', value);

  // Fermer le dropdown
  dropdown.classList.remove('active');
  const menu = dropdown.querySelector('.dropdown-secondary-menu');
  if (menu) menu.style.display = 'none';

  // Sauvegarder immédiatement
  await saveInlineChange(entryId, field, value);
}

// Sauvegarder une modification de textarea
async function saveInlineTextarea(element, entryId, field) {
  const value = element.value.trim();
  await saveInlineChange(entryId, field, value);
}

// Fonction générique de sauvegarde
async function saveInlineChange(entryId, field, value) {
  try {
    // Trouver l'entrée dans les données
    const entry = entrepreneurWeeklyData.find(e => e.id === entryId);
    if (!entry) {
      console.error('[INLINE SAVE] Entry not found:', entryId);
      return;
    }

    // Mapper les noms de champs
    const fieldMapping = {
      'hpap': 'objectif_hpap',
      'estims': 'objectif_estims',
      'vendu': 'objectif_vendu',
      'probleme_semaine': 'probleme_semaine',
      'racine_probleme': 'racine_probleme',
      'source_probleme': 'source_probleme',
      'type_coaching': 'type_coaching',
      'plan_match': 'plan_match'
    };

    const actualField = fieldMapping[field] || field;

    // Mettre à jour localement
    entry[actualField] = value;

    // Créer un ID unique si l'entrée n'en a pas
    if (!entry.id) {
      entry.id = `${selectedEntrepreneurForView}_${entry.week_label}`;
    }

    // Préparer les données pour l'API
    const updateData = {
      coach_username: coachUsername,
      week: entry.week_value,
      id: entry.id,
      entrepreneur_username: selectedEntrepreneurForView,
      week_label: entry.week_label,
      objectif_hpap: entry.objectif_hpap || '',
      objectif_estims: entry.objectif_estims || '',
      objectif_vendu: entry.objectif_vendu || '',
      probleme_semaine: entry.probleme_semaine || '',
      racine_probleme: entry.racine_probleme || '',
      source_probleme: entry.source_probleme || '',
      type_coaching: entry.type_coaching || '',
      plan_match: entry.plan_match || ''
    };

    // Sauvegarder via l'API
    const response = await fetch('/api/coach/weekly-entrepreneur-data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updateData)
    });

    if (response.ok) {
      

      // Animation de feedback visuel
      const cell = document.querySelector(`[data-entry-id="${entryId}"] [data-field="${field}"]`)?.closest('td');
      if (cell) {
        cell.style.background = 'rgba(34, 197, 94, 0.2)';
        setTimeout(() => {
          cell.style.background = '';
        }, 500);
      }
    } else {
      throw new Error('Save failed');
    }

  } catch (error) {
    console.error('[INLINE SAVE] Error:', error);
    alert('Erreur lors de la sauvegarde');
  }
}

// ================================================================
// RPO TABLE - NEW DROPDOWN & TEXTAREA FUNCTIONS
// ================================================================

function toggleRpoDropdown(element, field, entryId) {
  event.stopPropagation();

  const menu = element.querySelector('.rpo-dropdown-menu');
  const isActive = element.classList.contains('active');

  // Close all other dropdowns
  document.querySelectorAll('.rpo-dropdown.active').forEach(dropdown => {
    dropdown.classList.remove('active');
    const otherMenu = dropdown.querySelector('.rpo-dropdown-menu');
    if (otherMenu) {
      otherMenu.style.display = 'none';
      otherMenu.style.top = '';
      otherMenu.style.bottom = '';
    }
  });

  // Toggle current dropdown
  if (!isActive) {
    element.classList.add('active');
    if (menu) {
      // Trouver la ligne (tr) qui contient ce dropdown
      const row = element.closest('tr');
      const table = element.closest('table');

      if (row && table) {
        const allRows = Array.from(table.querySelectorAll('tbody tr'));
        const rowIndex = allRows.indexOf(row);
        const totalRows = allRows.length;

        // Si c'est une des 3 dernières lignes, ouvrir vers le haut
        if (rowIndex >= totalRows - 3) {
          menu.style.top = 'auto';
          menu.style.bottom = 'calc(100% + 4px)';
        } else {
          menu.style.top = 'calc(100% + 4px)';
          menu.style.bottom = 'auto';
        }
      } else {
        // Fallback: ouvrir vers le bas
        menu.style.top = 'calc(100% + 4px)';
        menu.style.bottom = 'auto';
      }

      menu.style.display = 'block';
    }
  }
}

function selectRpoOption(event, entryId, field, value) {
  event.stopPropagation();

  const dropdown = event.target.closest('.rpo-dropdown');
  const selectedSpan = dropdown.querySelector('.rpo-dropdown-text');

  selectedSpan.textContent = value;
  dropdown.setAttribute('data-value', value);

  dropdown.classList.remove('active');
  const menu = dropdown.querySelector('.rpo-dropdown-menu');
  if (menu) menu.style.display = 'none';

  // Afficher le bouton "Enregistrer" quand une modification est faite
  const saveBtn = document.getElementById('save-all-btn');
  if (saveBtn && selectedEntrepreneurForView) {
    saveBtn.style.display = 'inline-flex';
  }

  
}

// Auto-sauvegarde des textareas: debounce 1s sur input + sauvegarde immédiate sur blur

async function saveRpoChange(entryId, field, value) {
  try {
    const entry = entrepreneurWeeklyData.find(e => e.week_label === entryId);
    if (!entry) {
      console.error('[RPO SAVE] Entry not found:', entryId);
      return;
    }

    const fieldMapping = {
      'hpap': 'objectif_hpap',
      'estims': 'objectif_estims',
      'vendu': 'objectif_vendu',
      'probleme_semaine': 'probleme_semaine',
      'racine_probleme': 'racine_probleme',
      'source_probleme': 'source_probleme',
      'type_coaching': 'type_coaching',
      'plan_match': 'plan_match'
    };

    const actualField = fieldMapping[field] || field;
    entry[actualField] = value;

    // Créer un ID unique basé sur entrepreneur + week_label
    const uniqueId = `${selectedEntrepreneurForView}_${entry.week_label}`;

    const updateData = {
      id: uniqueId,
      coach_username: coachUsername,
      week: selectedWeekValue,
      entrepreneur_username: selectedEntrepreneurForView,
      week_label: entry.week_label,
      // Envoyer TOUS les champs, pas seulement celui modifié
      objectif_hpap: entry.objectif_hpap || '',
      objectif_estims: entry.objectif_estims || '',
      objectif_vendu: entry.objectif_vendu || '',
      probleme_semaine: entry.probleme_semaine || '',
      racine_probleme: entry.racine_probleme || '',
      source_probleme: entry.source_probleme || '',
      type_coaching: entry.type_coaching || '',
      plan_match: entry.plan_match || ''
    };

    

    const response = await fetch('/api/coach/weekly-entrepreneur-data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updateData)
    });

    if (response.ok) {
      const result = await response.json();
      
    } else {
      throw new Error('Save failed');
    }

  } catch (error) {
    console.error('[RPO SAVE] Error:', error);
    alert('Erreur lors de la sauvegarde');
  }
}

// Fermer les dropdowns RPO si on clique ailleurs ou scroll
document.addEventListener('click', function(event) {
  if (!event.target.closest('.rpo-dropdown')) {
    document.querySelectorAll('.rpo-dropdown.active').forEach(dropdown => {
      dropdown.classList.remove('active');
      const menu = dropdown.querySelector('.rpo-dropdown-menu');
      if (menu) menu.style.display = 'none';
    });
  }
});

// Fermer les dropdowns RPO lors du scroll
window.addEventListener('scroll', function() {
  document.querySelectorAll('.rpo-dropdown.active').forEach(dropdown => {
    dropdown.classList.remove('active');
    const menu = dropdown.querySelector('.rpo-dropdown-menu');
    if (menu) menu.style.display = 'none';
  });
}, true); // true pour capturer en phase de capture

// Fermer les dropdowns RPO lors du resize
window.addEventListener('resize', function() {
  document.querySelectorAll('.rpo-dropdown.active').forEach(dropdown => {
    dropdown.classList.remove('active');
    const menu = dropdown.querySelector('.rpo-dropdown-menu');
    if (menu) menu.style.display = 'none';
  });
});

// Fermer les dropdowns si on clique ailleurs
document.addEventListener('click', function(event) {
  // Dropdown du tableau Suivi hebdomadaire
  const dropdown = document.getElementById('week-dropdown');
  if (dropdown && !dropdown.contains(event.target)) {
    const menu = document.getElementById('week-dropdown-menu');
    dropdown.classList.remove('active');
    if (menu) {
      menu.style.display = 'none';
      menu.classList.remove('show');
    }
  }

  // Dropdown de Résumé hebdomadaire
  const resumeDropdown = document.getElementById('resume-week-dropdown');
  if (resumeDropdown && !resumeDropdown.contains(event.target)) {
    const resumeMenu = document.getElementById('resume-week-dropdown-menu');
    resumeDropdown.classList.remove('active');
    if (resumeMenu) {
      resumeMenu.style.display = 'none';
      resumeMenu.classList.remove('show');
    }
  }

  // Close RPO dropdowns
  document.querySelectorAll('.rpo-dropdown.active').forEach(dd => {
    dd.classList.remove('active');
    const m = dd.querySelector('.rpo-dropdown-menu');
    if (m) m.style.display = 'none';
  });
});

// Toggle edit mode pour Suivi hebdomadaire
let isSuiviEditMode = false;

function toggleSuiviEditMode() {
  isSuiviEditMode = !isSuiviEditMode;
  const btn = document.getElementById('suivi-edit-btn');
  const tableContainer = document.getElementById('suivi-table-container');
  const addEntryContainer = document.getElementById('add-entry-container');

  if (isSuiviEditMode) {
    // Mode édition: activer l'ajout d'entrées
    tableContainer.classList.remove('table-readonly');
    addEntryContainer.style.display = 'flex';

    btn.innerHTML = '<i class="fas fa-check"></i>Terminer';
    btn.classList.remove('btn-secondary');
    btn.classList.add('btn-primary');
  } else {
    // Mode lecture: désactiver l'ajout
    tableContainer.classList.add('table-readonly');
    addEntryContainer.style.display = 'none';

    btn.innerHTML = '<i class="fas fa-edit"></i>Modifier';
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-secondary');
  }
}

// Charger les données hebdomadaires des entrepreneurs
async function loadWeeklyEntrepreneurData() {
  const weekValue = selectedWeekValue;

  if (!weekValue) return;

  try {
    const response = await fetch(`/api/coach/weekly-entrepreneur-data?coach_username=${coachUsername}&week=${weekValue}`);
    if (response.ok) {
      const data = await response.json();
      entrepreneurWeeklyData = data.entries || [];
      renderEntrepreneurWeeklyTable();
      
    }
  } catch (error) {
    console.error('[RPO] Erreur chargement données hebdomadaires:', error);
    entrepreneurWeeklyData = [];
    renderEntrepreneurWeeklyTable();
  }
}

// Afficher le tableau
function renderEntrepreneurWeeklyTable() {
  const tbody = document.getElementById('weekly-entrepreneur-table-body');
  if (!tbody) return; // Si l'élément n'existe pas, ne rien faire
  tbody.innerHTML = '';

  if (entrepreneurWeeklyData.length === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td colspan="9" class="empty-state">
        <i class="fas fa-hand-pointer"></i>
        <p>Sélectionner un entrepreneur pour voir le suivi...</p>
      </td>
    `;
    tbody.appendChild(tr);
    return;
  }

  // Appliquer le filtre de mois si sélectionné (même logique que coach_rpo.html)
  let filteredData = entrepreneurWeeklyData;

  if (selectedMonthFilter && selectedMonthFilter !== 'all') {
    // Filtrer par mois (Janvier-Décembre 2026)
    // Map des noms de mois français vers numéros (2026)
    const monthNameToNumber = {
      'janvier': '01', 'janv.': '01', 'janv': '01',
      'février': '02', 'févr.': '02', 'févr': '02',
      'mars': '03',
      'avril': '04', 'avr.': '04', 'avr': '04',
      'mai': '05',
      'juin': '06',
      'juillet': '07', 'juil.': '07', 'juil': '07',
      'août': '08',
      'septembre': '09', 'sept.': '09', 'sept': '09',
      'octobre': '10', 'oct.': '10', 'oct': '10',
      'novembre': '11', 'nov.': '11', 'nov': '11',
      'décembre': '12', 'déc.': '12', 'déc': '12'
    };

    filteredData = entrepreneurWeeklyData.filter(entry => {
      // Format possible: "5 - 11 janv" OU "26 janv - 1 févr"
      const weekLabelStr = String(entry.week_label || '').toLowerCase();

      // Trouver le PREMIER mois qui APPARAÎT dans le texte (par position)
      // Ex: "29 déc - 4 janv" -> "déc" apparaît avant "janv", donc c'est Décembre
      let firstMonthFound = null;
      let earliestPosition = Infinity;

      for (const [monthName, monthNumber] of Object.entries(monthNameToNumber)) {
        const position = weekLabelStr.indexOf(monthName);
        if (position !== -1 && position < earliestPosition) {
          earliestPosition = position;
          firstMonthFound = monthNumber;
        }
      }

      return firstMonthFound === selectedMonthFilter;
    });
  }

  

  // Si aucune donnée après filtrage, afficher un message
  if (filteredData.length === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td colspan="9" class="empty-state">
        <i class="fas fa-calendar-times"></i>
        <p>Aucune semaine trouvée pour ce mois</p>
      </td>
    `;
    tbody.appendChild(tr);
    return;
  }

  filteredData.forEach(entry => {
    const tr = document.createElement('tr');
    tr.setAttribute('data-entry-id', entry.week_label);

    // Déterminer si c'est la semaine actuelle basé sur le label
    const today = new Date();
    const currentDay = today.getDate();
    const currentMonth = today.getMonth(); // 0-11
    const currentYear = today.getFullYear();

    let isCurrentWeek = false;

    if (entry.week_label) {
      const labelStr = String(entry.week_label);
      const labelLower = labelStr.toLowerCase();
      const monthMap = {
        'janv': 0, 'janvier': 0, 'févr': 1, 'février': 1, 'mars': 2,
        'avr': 3, 'avril': 3, 'mai': 4, 'juin': 5,
        'juil': 6, 'juillet': 6, 'août': 7,
        'sept': 8, 'septembre': 8, 'oct': 9, 'octobre': 9,
        'nov': 10, 'novembre': 10, 'déc': 11, 'décembre': 11
      };

      // Déterminer l'année du label (2025 si contient "2025", sinon 2026)
      const labelYear = labelStr.includes('2025') ? 2025 : 2026;

      // Pattern pour capturer les différents formats:
      // "8 - 14 déc 2025", "5 - 11 janv.", "29 déc - 4 janv"
      const singleMonthMatch = labelLower.match(/(\d+)\s*-\s*(\d+)\s*([a-zéèêû]+)/);
      const twoMonthMatch = labelLower.match(/(\d+)\s*([a-zéèêû]+)\s*-\s*(\d+)\s*([a-zéèêû]+)/);

      if (singleMonthMatch && !twoMonthMatch) {
        // Format: "8 - 14 déc 2025" ou "5 - 11 janv."
        const startDay = parseInt(singleMonthMatch[1]);
        const endDay = parseInt(singleMonthMatch[2]);
        const monthName = singleMonthMatch[3].replace('.', '');
        const labelMonth = monthMap[monthName];

        if (labelMonth !== undefined && currentYear === labelYear && currentMonth === labelMonth) {
          isCurrentWeek = currentDay >= startDay && currentDay <= endDay;
        }
      } else if (twoMonthMatch) {
        // Format: "29 déc - 4 janv" (semaine qui traverse deux mois)
        const startDay = parseInt(twoMonthMatch[1]);
        const startMonthName = twoMonthMatch[2].replace('.', '');
        const endDay = parseInt(twoMonthMatch[3]);
        const endMonthName = twoMonthMatch[4].replace('.', '');
        const startMonth = monthMap[startMonthName];
        const endMonth = monthMap[endMonthName];

        if (startMonth !== undefined && endMonth !== undefined) {
          // Si on est dans le mois de début
          if (currentMonth === startMonth && currentDay >= startDay) {
            // Vérifier l'année pour décembre 2025
            if (startMonth === 11 && currentYear === 2025) {
              isCurrentWeek = true;
            } else if (currentYear === 2026) {
              isCurrentWeek = true;
            }
          }
          // Si on est dans le mois de fin
          else if (currentMonth === endMonth && currentDay <= endDay) {
            // Pour janvier 2026 (après décembre 2025)
            if (endMonth === 0 && currentYear === 2026) {
              isCurrentWeek = true;
            } else if (currentYear === 2026) {
              isCurrentWeek = true;
            }
          }
        }
      }
    }

    // Construire le HTML de la ligne avec dropdowns et textareas - FILTRER LES TIRETS
    const hpapValue = (entry.objectif_hpap && entry.objectif_hpap !== '-') ? entry.objectif_hpap : '';
    const estimsValue = (entry.objectif_estims && entry.objectif_estims !== '-') ? entry.objectif_estims : '';
    const venduValue = (entry.objectif_vendu && entry.objectif_vendu !== '-') ? entry.objectif_vendu : '';
    const sourceValue = (entry.source_probleme && entry.source_probleme !== '-') ? entry.source_probleme : '';
    const coachingValue = (entry.type_coaching && entry.type_coaching !== '-') ? entry.type_coaching : '';
    const problemeValue = (entry.probleme_semaine && entry.probleme_semaine !== '-') ? entry.probleme_semaine : '';
    const racineValue = (entry.racine_probleme && entry.racine_probleme !== '-') ? entry.racine_probleme : '';
    const planValue = (entry.plan_match && entry.plan_match !== '-') ? entry.plan_match : '';

    tr.innerHTML = `
      <td class="rpo-col-date">
        ${entry.week_label || ''}
      </td>

      <!-- Dropdown HPAP -->
      <td class="rpo-col-standard">
        <div class="rpo-dropdown"
             onclick="toggleRpoDropdown(this, 'hpap', '${entry.week_label}')"
             data-field="hpap"
             data-value="${hpapValue}">
          <span class="rpo-dropdown-text">${hpapValue}</span>
          <i class="fas fa-chevron-down rpo-dropdown-icon"></i>
          <div class="rpo-dropdown-menu" style="display: none;">
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'hpap', '-')">-</div>
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'hpap', 'Oui')">Oui</div>
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'hpap', 'Non')">Non</div>
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'hpap', 'Partiellement')">Partiellement</div>
          </div>
        </div>
      </td>

      <!-- Dropdown Estims -->
      <td class="rpo-col-standard">
        <div class="rpo-dropdown"
             onclick="toggleRpoDropdown(this, 'estims', '${entry.week_label}')"
             data-field="estims"
             data-value="${estimsValue}">
          <span class="rpo-dropdown-text">${estimsValue}</span>
          <i class="fas fa-chevron-down rpo-dropdown-icon"></i>
          <div class="rpo-dropdown-menu" style="display: none;">
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'estims', '-')">-</div>
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'estims', 'Oui')">Oui</div>
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'estims', 'Non')">Non</div>
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'estims', 'Partiellement')">Partiellement</div>
          </div>
        </div>
      </td>

      <!-- Dropdown $Vendu -->
      <td class="rpo-col-standard">
        <div class="rpo-dropdown"
             onclick="toggleRpoDropdown(this, 'vendu', '${entry.week_label}')"
             data-field="vendu"
             data-value="${venduValue}">
          <span class="rpo-dropdown-text">${venduValue}</span>
          <i class="fas fa-chevron-down rpo-dropdown-icon"></i>
          <div class="rpo-dropdown-menu" style="display: none;">
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'vendu', '-')">-</div>
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'vendu', 'Oui')">Oui</div>
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'vendu', 'Non')">Non</div>
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'vendu', 'Partiellement')">Partiellement</div>
          </div>
        </div>
      </td>

      <!-- Textarea Problème de la semaine -->
      <td class="rpo-col-wide">
        <textarea
          class="rpo-textarea"
          data-field="probleme_semaine"
          data-entry-id="${entry.week_label}"
          placeholder=""
        >${problemeValue}</textarea>
      </td>

      <!-- Textarea Racine du problème -->
      <td class="rpo-col-wide">
        <textarea
          class="rpo-textarea"
          data-field="racine_probleme"
          data-entry-id="${entry.week_label}"
          placeholder=""
        >${racineValue}</textarea>
      </td>

      <!-- Dropdown Source du problème -->
      <td class="rpo-col-standard">
        <div class="rpo-dropdown"
             onclick="toggleRpoDropdown(this, 'source', '${entry.week_label}')"
             data-field="source_probleme"
             data-value="${sourceValue}">
          <span class="rpo-dropdown-text">${sourceValue}</span>
          <i class="fas fa-chevron-down rpo-dropdown-icon"></i>
          <div class="rpo-dropdown-menu" style="display: none;">
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'source_probleme', 'Engagement')">Engagement</div>
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'source_probleme', 'Confiance')">Confiance</div>
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'source_probleme', 'Paresse')">Paresse</div>
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'source_probleme', 'Compétence')">Compétence</div>
          </div>
        </div>
      </td>

      <!-- Dropdown Type de coaching -->
      <td class="rpo-col-standard">
        <div class="rpo-dropdown"
             onclick="toggleRpoDropdown(this, 'coaching', '${entry.week_label}')"
             data-field="type_coaching"
             data-value="${coachingValue}">
          <span class="rpo-dropdown-text">${coachingValue}</span>
          <i class="fas fa-chevron-down rpo-dropdown-icon"></i>
          <div class="rpo-dropdown-menu" style="display: none;">
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'type_coaching', 'Directif')">Directif</div>
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'type_coaching', 'Coaching')">Coaching</div>
            <div class="rpo-dropdown-item" onclick="selectRpoOption(event, '${entry.week_label}', 'type_coaching', 'Support')">Support</div>
          </div>
        </div>
      </td>

      <!-- Textarea Plan de match -->
      <td class="rpo-col-wide">
        <textarea
          class="rpo-textarea"
          data-field="plan_match"
          data-entry-id="${entry.week_label}"
          placeholder=""
        >${planValue}</textarea>
      </td>
    `;

    // Appliquer le style jaune pour la semaine actuelle APRÈS avoir défini le innerHTML
    if (isCurrentWeek) {
      tr.style.background = 'rgba(251, 191, 36, 0.08)';
      tr.style.borderLeft = '3px solid #fbbf24';
    }

    tbody.appendChild(tr);
  });

  // Auto-sauvegarde des textareas avec debounce (1 seconde) + sauvegarde immédiate sur blur
  const allTextareas = tbody.querySelectorAll('.rpo-textarea');
  const saveTimers = new Map();

  allTextareas.forEach(textarea => {
    // Auto-sauvegarde avec debounce 1 seconde sur input
    textarea.addEventListener('input', function() {
      const field = this.getAttribute('data-field');
      const entryId = this.getAttribute('data-entry-id');
      const value = this.value;

      // Annuler le timer précédent s'il existe
      if (saveTimers.has(this)) {
        clearTimeout(saveTimers.get(this));
      }

      // Créer un nouveau timer pour sauvegarder après 1 seconde
      const timer = setTimeout(async () => {
        console.log('[RPO] Auto-sauvegarde textarea:', field, 'pour', entryId);
        await saveRpoChange(entryId, field, value);
        saveTimers.delete(this);
      }, 1000);

      saveTimers.set(this, timer);
    });

    // Sauvegarde immédiate sur blur (quand on clique ailleurs)
    textarea.addEventListener('blur', async function() {
      const field = this.getAttribute('data-field');
      const entryId = this.getAttribute('data-entry-id');
      const value = this.value;

      // Annuler tout timer en cours
      if (saveTimers.has(this)) {
        clearTimeout(saveTimers.get(this));
        saveTimers.delete(this);
      }

      console.log('[RPO] Sauvegarde blur textarea:', field, 'pour', entryId);
      await saveRpoChange(entryId, field, value);
    });
  });

  // Activer le scroll horizontal en glissant le header
  enableHeaderDragScroll();
}

// Fonction pour rendre le tableau hebdomadaire des coaches (pour Direction RPO)
function renderCoachWeeklyTable() {
  const tbody = document.getElementById('weekly-coach-table-body');

  if (!tbody) {
    console.error('[RENDER COACH TABLE] Table body not found');
    return;
  }

  tbody.innerHTML = '';

  if (coachWeeklyData.length === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td colspan="2" class="empty-state">
        <i class="fas fa-chalkboard-teacher"></i>
        <p>Sélectionner un coach pour voir le suivi...</p>
      </td>
    `;
    tbody.appendChild(tr);
    return;
  }

  // Appliquer le filtre de mois si sélectionné (même logique que coach_rpo.html)
  let filteredData = coachWeeklyData;

  if (selectedMonthFilter && selectedMonthFilter !== 'all') {
    // Filtrer par mois (Janvier-Décembre 2026)
    // Map des noms de mois français vers numéros (2026)
    const monthNameToNumber = {
      'janvier': '01', 'janv.': '01', 'janv': '01',
      'février': '02', 'févr.': '02', 'févr': '02',
      'mars': '03',
      'avril': '04', 'avr.': '04', 'avr': '04',
      'mai': '05',
      'juin': '06',
      'juillet': '07', 'juil.': '07', 'juil': '07',
      'août': '08',
      'septembre': '09', 'sept.': '09', 'sept': '09',
      'octobre': '10', 'oct.': '10', 'oct': '10',
      'novembre': '11', 'nov.': '11', 'nov': '11',
      'décembre': '12', 'déc.': '12', 'déc': '12'
    };

    filteredData = coachWeeklyData.filter(entry => {
      // Format possible: "5 - 11 janv" OU "26 janv - 1 févr"
      const weekLabelStr = String(entry.week_label || '').toLowerCase();

      // Trouver le PREMIER mois qui APPARAÎT dans le texte (par position)
      // Ex: "29 déc - 4 janv" -> "déc" apparaît avant "janv", donc c'est Décembre
      let firstMonthFound = null;
      let earliestPosition = Infinity;

      for (const [monthName, monthNumber] of Object.entries(monthNameToNumber)) {
        const position = weekLabelStr.indexOf(monthName);
        if (position !== -1 && position < earliestPosition) {
          earliestPosition = position;
          firstMonthFound = monthNumber;
        }
      }

      return firstMonthFound === selectedMonthFilter;
    });
  }

  

  // Obtenir la semaine actuelle
  const currentWeekLabel = getCurrentWeekLabel();

  // Rendu simplifié avec une seule colonne éditable
  filteredData.forEach(entry => {
    const tr = document.createElement('tr');
    tr.dataset.entryId = entry.week_label;

    const isCurrentWeek = entry.week_label === currentWeekLabel;
    const notesValue = entry.notes_hebdo || '';

    tr.innerHTML = `
      <td class="rpo-col-date">
        ${entry.week_label}
      </td>
      <td class="rpo-col-wide">
        <textarea
          class="rpo-textarea"
          data-field="notes_hebdo"
          data-entry-id="${entry.week_label}"
          placeholder="Ajouter des notes pour cette semaine..."
        >${notesValue}</textarea>
      </td>
    `;

    // Appliquer le style jaune pour la semaine actuelle
    if (isCurrentWeek) {
      tr.style.background = 'rgba(251, 191, 36, 0.08)';
      tr.style.borderLeft = '3px solid #fbbf24';
    }

    tbody.appendChild(tr);
  });

  // Auto-sauvegarde des textareas coach avec debounce + blur
  const allTextareas = tbody.querySelectorAll('.rpo-textarea');
  const coachSaveTimers = new Map();

  allTextareas.forEach(textarea => {
    // Auto-sauvegarde avec debounce 1 seconde sur input
    textarea.addEventListener('input', function() {
      const field = this.getAttribute('data-field');
      const entryId = this.getAttribute('data-entry-id');
      const value = this.value;

      if (coachSaveTimers.has(this)) {
        clearTimeout(coachSaveTimers.get(this));
      }

      const timer = setTimeout(async () => {
        console.log('[RPO COACH] Auto-sauvegarde:', field, 'pour', entryId);
        await saveCoachRpoChange(entryId, field, value);
        coachSaveTimers.delete(this);
      }, 1000);

      coachSaveTimers.set(this, timer);
    });

    // Sauvegarde immédiate sur blur
    textarea.addEventListener('blur', async function() {
      const field = this.getAttribute('data-field');
      const entryId = this.getAttribute('data-entry-id');
      const value = this.value;

      if (coachSaveTimers.has(this)) {
        clearTimeout(coachSaveTimers.get(this));
        coachSaveTimers.delete(this);
      }

      console.log('[RPO COACH] Sauvegarde blur:', field, 'pour', entryId);
      await saveCoachRpoChange(entryId, field, value);
    });
  });

  enableHeaderDragScroll();
}

// Fonction de sauvegarde auto pour les textareas coach
async function saveCoachRpoChange(entryId, field, value) {
  try {
    const entry = coachWeeklyData.find(e => e.week_label === entryId);
    if (!entry) {
      console.error('[RPO COACH SAVE] Entry not found:', entryId);
      return;
    }

    entry[field] = value;

    const uniqueId = `${selectedCoachForView}_${entry.week_label}`;

    const updateData = {
      id: uniqueId,
      coach_username: selectedCoachForView,
      week_label: entry.week_label,
      notes_hebdo: entry.notes_hebdo || ''
    };

    const response = await fetch('/api/direction/coach-weekly-data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updateData)
    });

    if (response.ok) {
      console.log('[RPO COACH SAVE] Saved successfully');
    } else {
      throw new Error('Save failed');
    }
  } catch (error) {
    console.error('[RPO COACH SAVE] Error:', error);
  }
}

// Enregistrer toutes les données du tableau coach
async function saveCoachWeeklyData() {
  try {
    const saveBtn = document.getElementById('save-coach-btn');
    if (!saveBtn) return;

    // Désactiver le bouton pendant la sauvegarde
    const originalHTML = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Enregistrement...';

    // Récupérer toutes les lignes du tableau
    const rows = document.querySelectorAll('#weekly-coach-table-body tr[data-entry-id]');
    let savedCount = 0;
    let errorCount = 0;

    for (const row of rows) {
      const weekLabel = row.getAttribute('data-entry-id');
      const entry = coachWeeklyData.find(e => e.week_label === weekLabel);

      if (!entry) continue;

      try {
        // Récupérer la valeur du textarea
        const notesTextarea = row.querySelector('[data-field="notes_hebdo"]');

        // Mettre à jour l'objet entry
        entry.notes_hebdo = notesTextarea?.value || '';

        // Créer un ID unique basé sur coach + week_label
        const uniqueId = `${selectedCoachForView}_${entry.week_label}`;

        // Préparer les données pour l'API
        const updateData = {
          id: uniqueId,
          coach_username: selectedCoachForView,
          week_label: entry.week_label,
          notes_hebdo: entry.notes_hebdo
        };

        // Envoyer à l'API
        const response = await fetch('/api/direction/coach-weekly-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updateData)
        });

        if (response.ok) {
          savedCount++;
        } else {
          errorCount++;
          console.error(`[SAVE COACH] Erreur pour ${weekLabel}`);
        }

      } catch (err) {
        errorCount++;
        console.error(`[SAVE COACH] Exception pour ${weekLabel}:`, err);
      }
    }

    

    // Afficher le résultat
    if (errorCount === 0) {
      saveBtn.innerHTML = '<i class="fas fa-check"></i>Enregistré!';
      saveBtn.style.background = '#10b981';
    } else {
      saveBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>Erreurs détectées';
      saveBtn.style.background = '#f59e0b';
    }

    // Masquer le bouton après 2 secondes
    setTimeout(() => {
      saveBtn.style.display = 'none';
      saveBtn.innerHTML = originalHTML;
      saveBtn.disabled = false;
      saveBtn.style.background = '';
    }, 2000);

  } catch (error) {
    console.error('[SAVE COACH] Erreur globale:', error);
    const saveBtn = document.getElementById('save-coach-btn');
    if (saveBtn) {
      saveBtn.innerHTML = '<i class="fas fa-times"></i>Erreur';
      saveBtn.style.background = '#ef4444';
      saveBtn.disabled = false;
    }
  }
}

// Helper function pour convertir numéro de mois en nom abrégé (pour correspondre aux labels de semaines générés par toLocaleDateString)
function getMonthNameFromNumber(monthNum) {
  // Utiliser toLocaleDateString pour obtenir EXACTEMENT la même abréviation
  const date = new Date(2026, parseInt(monthNum) - 1, 1);
  const monthAbbr = date.toLocaleDateString('fr-FR', { month: 'short' }).replace('.', '');
  return monthAbbr;
}

// Fonction pour activer le scroll par glisser sur le header
function enableHeaderDragScroll() {
  const tableContainer = document.getElementById('entrepreneur-table-container');
  const tableHead = document.querySelector('.rpo-table-head');

  if (!tableContainer || !tableHead) return;

  let isDown = false;
  let startX;
  let scrollLeft;

  tableHead.addEventListener('mousedown', (e) => {
    // Ne pas activer sur les dropdowns ou inputs
    if (e.target.closest('.rpo-dropdown') || e.target.closest('textarea')) {
      return;
    }

    isDown = true;
    startX = e.pageX - tableContainer.offsetLeft;
    scrollLeft = tableContainer.scrollLeft;
  });

  tableHead.addEventListener('mouseleave', () => {
    isDown = false;
  });

  tableHead.addEventListener('mouseup', () => {
    isDown = false;
  });

  tableHead.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - tableContainer.offsetLeft;
    const walk = (x - startX) * 1.5; // Multiplier pour un scroll plus rapide
    tableContainer.scrollLeft = scrollLeft - walk;
  });
}

// Enregistrer TOUTES les données du tableau entrepreneur
async function saveAllEntrepreneurWeeklyData() {
  try {
    const saveBtn = document.getElementById('save-all-btn');
    if (!saveBtn) return;

    // Désactiver le bouton pendant la sauvegarde
    const originalHTML = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Enregistrement...';

    // Récupérer toutes les lignes du tableau
    const rows = document.querySelectorAll('#weekly-entrepreneur-table-body tr[data-entry-id]');
    let savedCount = 0;
    let errorCount = 0;

    for (const row of rows) {
      const weekLabel = row.getAttribute('data-entry-id');
      const entry = entrepreneurWeeklyData.find(e => e.week_label === weekLabel);

      if (!entry) continue;

      try {
        // Récupérer les valeurs des dropdowns
        const hpapDropdown = row.querySelector('[data-field="hpap"]');
        const estimsDropdown = row.querySelector('[data-field="estims"]');
        const venduDropdown = row.querySelector('[data-field="vendu"]');
        const sourceDropdown = row.querySelector('[data-field="source_probleme"]');
        const coachingDropdown = row.querySelector('[data-field="type_coaching"]');

        // Récupérer les valeurs des textareas
        const problemeTextarea = row.querySelector('[data-field="probleme_semaine"]');
        const racineTextarea = row.querySelector('[data-field="racine_probleme"]');
        const planTextarea = row.querySelector('[data-field="plan_match"]');

        // Mettre à jour l'objet entry
        entry.objectif_hpap = hpapDropdown?.getAttribute('data-value') || '';
        entry.objectif_estims = estimsDropdown?.getAttribute('data-value') || '';
        entry.objectif_vendu = venduDropdown?.getAttribute('data-value') || '';
        entry.source_probleme = sourceDropdown?.getAttribute('data-value') || '';
        entry.type_coaching = coachingDropdown?.getAttribute('data-value') || '';
        entry.probleme_semaine = problemeTextarea?.value || '';
        entry.racine_probleme = racineTextarea?.value || '';
        entry.plan_match = planTextarea?.value || '';

        // Créer un ID unique basé sur entrepreneur + week_label
        const uniqueId = `${selectedEntrepreneurForView}_${entry.week_label}`;

        // Préparer les données pour l'API
        const updateData = {
          id: uniqueId,
          coach_username: coachUsername,
          week: entry.week_value || entry.week || selectedWeekValue,  // Utiliser le week_value de l'entrée
          entrepreneur_username: selectedEntrepreneurForView,
          week_label: entry.week_label,
          objectif_hpap: entry.objectif_hpap || '',
          objectif_estims: entry.objectif_estims || '',
          objectif_vendu: entry.objectif_vendu || '',
          probleme_semaine: entry.probleme_semaine || '',
          racine_probleme: entry.racine_probleme || '',
          source_probleme: entry.source_probleme || '',
          type_coaching: entry.type_coaching || '',
          plan_match: entry.plan_match || ''
        };

        

        // Sauvegarder via l'API
        const response = await fetch('/api/coach/weekly-entrepreneur-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updateData)
        });

        if (response.ok) {
          const result = await response.json();
          
          savedCount++;
        } else {
          throw new Error(`Échec sauvegarde: ${response.status}`);
        }
      } catch (error) {
        console.error(`[SAVE ALL] Erreur pour ${weekLabel}:`, error);
        errorCount++;
      }
    }

    // Afficher le résultat
    if (errorCount === 0) {
      saveBtn.innerHTML = '<i class="fas fa-check"></i>Enregistré!';
      saveBtn.style.background = '#22c55e';

      setTimeout(() => {
        saveBtn.innerHTML = originalHTML;
        saveBtn.style.background = '';
        saveBtn.disabled = false;
        // Cacher le bouton après la sauvegarde
        saveBtn.style.display = 'none';
      }, 2000);
    } else {
      saveBtn.innerHTML = originalHTML;
      saveBtn.disabled = false;
      alert(`Enregistrement terminé avec ${errorCount} erreur(s) sur ${savedCount + errorCount} ligne(s).`);
    }

    

  } catch (error) {
    console.error('[SAVE ALL] Error:', error);
    alert('Erreur lors de la sauvegarde');

    const saveBtn = document.getElementById('save-all-btn');
    if (saveBtn) {
      saveBtn.innerHTML = '<i class="fas fa-save"></i>Enregistrer';
      saveBtn.disabled = false;
    }
  }
}

// Ouvrir le modal
function openEntrepreneurWeeklyModal(entryId = null) {
  const modal = document.getElementById('entrepreneur-weekly-modal');
  const form = document.getElementById('entrepreneur-weekly-form');

  form.reset();

  if (entryId) {
    // Mode édition
    const entry = entrepreneurWeeklyData.find(e => e.id === entryId);
    if (entry) {
      document.getElementById('modal-entrepreneur-title').textContent = 'Modifier l\'entrée';
      document.getElementById('ew-id').value = entry.id;
      document.getElementById('ew-date').value = entry.date || '';
      document.getElementById('ew-entrepreneur').value = entry.entrepreneur || '';
      document.getElementById('ew-objectif').value = entry.objectif || 'Non';
      document.getElementById('ew-probleme').value = entry.probleme || '';
      document.getElementById('ew-racine').value = entry.racine || '';
      document.getElementById('ew-source').value = entry.source || '';
      document.getElementById('ew-coaching').value = entry.coaching || 'Coaching';
      document.getElementById('ew-plan').value = entry.plan || '';
    }
  } else {
    // Mode création
    document.getElementById('modal-entrepreneur-title').textContent = 'Nouvelle entrée hebdomadaire';
    document.getElementById('ew-id').value = '';

    // Pré-remplir la date avec la semaine sélectionnée
    const weekSelector = document.getElementById('week-selector-table');
    if (weekSelector.value) {
      const weekValue = weekSelector.value; // Format: "2024-W12"
      const [year, week] = weekValue.split('-W');
      const date = getDateFromWeek(parseInt(year), parseInt(week));
      document.getElementById('ew-date').value = date.toISOString().split('T')[0];
    }
  }

  modal.style.display = 'flex';
}

// Fermer le modal
function closeEntrepreneurWeeklyModal() {
  document.getElementById('entrepreneur-weekly-modal').style.display = 'none';
}

// Sauvegarder une entrée
async function saveEntrepreneurWeekly(event) {
  event.preventDefault();

  // Récupérer le bouton submit du formulaire
  const submitButton = document.querySelector('#entrepreneur-weekly-form + .modal-footer .btn-primary');
  const originalText = submitButton.innerHTML;

  // Désactiver le bouton et changer l'apparence
  submitButton.disabled = true;
  submitButton.style.opacity = '0.6';
  submitButton.style.cursor = 'not-allowed';
  submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Enregistrement...';

  const weekValue = selectedWeekValue;

  const entryId = document.getElementById('ew-id').value;
  const entryData = {
    id: entryId || Date.now().toString(),
    coach_username: coachUsername,
    week: weekValue,
    date: document.getElementById('ew-date').value,
    objectif: document.getElementById('ew-objectif').value,
    probleme: document.getElementById('ew-probleme').value,
    racine: document.getElementById('ew-racine').value,
    source: document.getElementById('ew-source').value,
    coaching: document.getElementById('ew-coaching').value,
    plan: document.getElementById('ew-plan').value
  };

  try {
    const response = await fetch('/api/coach/weekly-entrepreneur-data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(entryData)
    });

    if (response.ok) {
      
      submitButton.innerHTML = '<i class="fas fa-check"></i>Enregistré!';
      setTimeout(() => {
        closeEntrepreneurWeeklyModal();
        loadWeeklyEntrepreneurData();
        // Réactiver le bouton
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
        submitButton.style.opacity = '1';
        submitButton.style.cursor = 'pointer';
      }, 1000);
    } else {
      throw new Error('Erreur lors de la sauvegarde');
    }
  } catch (error) {
    console.error('[RPO] Erreur:', error);
    alert('Erreur lors de la sauvegarde');
    submitButton.innerHTML = originalText;
    submitButton.disabled = false;
    submitButton.style.opacity = '1';
    submitButton.style.cursor = 'pointer';
  }
}

// Supprimer une entrée
async function deleteEntrepreneurWeekly(entryId) {
  if (!confirm('Êtes-vous sûr de vouloir supprimer cette entrée ?')) return;

  const weekSelector = document.getElementById('week-selector-table');
  const weekValue = weekSelector.value;

  try {
    const response = await fetch('/api/coach/weekly-entrepreneur-data', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        coach_username: coachUsername,
        week: weekValue,
        entry_id: entryId
      })
    });

    if (response.ok) {
      
      await loadWeeklyEntrepreneurData();
    }
  } catch (error) {
    console.error('[RPO] Erreur suppression:', error);
  }
}

// Obtenir la date du lundi d'une semaine ISO
function getDateFromWeek(year, week) {
  const jan4 = new Date(year, 0, 4);
  const jan4Day = jan4.getDay() || 7;
  const weekStart = new Date(jan4);
  weekStart.setDate(jan4.getDate() - jan4Day + 1 + (week - 1) * 7);
  return weekStart;
}

// ================================================================
// PLAN D'AFFAIRES - PRÉVISIONS ET MÉTRIQUES
// ================================================================

async function checkIfBusinessPlanNeeded() {
  const username = window.username || localStorage.getItem('username');
  if (!username) return;

  try {
    // Charger les prévisions
    const prevResponse = await fetch(`/api/coach/team-objectifs?coach_username=${username}`);
    const prevData = await prevResponse.json();

    // Charger les métriques
    const metricsResponse = await fetch(`/api/coach/metrics?coach_username=${username}`);
    const metricsData = await metricsResponse.json();

    const hasPrevisions = prevData.success && prevData.previsions && Object.keys(prevData.previsions).length > 0;
    const hasMetrics = metricsData.success && metricsData.metrics &&
                      (metricsData.metrics.cm > 0 || metricsData.metrics.ratioMktg > 0 || metricsData.metrics.tauxVente > 0);

    const createBtn = document.getElementById('create-business-plan-btn');
    const editBtn = document.getElementById('edit-business-plan-btn');
    const metricsCards = document.getElementById('team-metrics-cards');

    if (createBtn && editBtn && metricsCards) {
      if (!hasPrevisions && !hasMetrics) {
        // Tout est à 0, afficher le bouton "Créer" et cacher les cartes
        createBtn.style.display = 'block';
        editBtn.style.display = 'none';
        metricsCards.style.display = 'none';
      } else {
        // Des données existent, afficher le bouton "Modifier" et les cartes
        createBtn.style.display = 'none';
        editBtn.style.display = 'block';
        metricsCards.style.display = 'grid';
      }
    }
  } catch (error) {
    console.error('[BUSINESS PLAN] Erreur vérification:', error);
  }
}

// Ouvrir le popup de création du plan d'affaires
async function openBusinessPlanPopup() {
  const popup = document.getElementById('business-plan-popup');
  const modal = popup.querySelector('.business-plan-modal');

  popup.classList.add('active');

  // Réinitialiser le bouton d'enregistrement (au cas où il serait resté bloqué)
  const saveBtn = document.getElementById('bp-save-btn');
  if (saveBtn) {
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<i class="fas fa-save"></i><span>Enregistrer</span>';
  }

  // Charger les entrepreneurs
  await loadEntrepreneursForBusinessPlan();

  // Charger les métriques existantes si elles existent
  await loadExistingMetricsForBusinessPlan();
}

// Fermer le popup
function closeBusinessPlanPopup() {
  const popup = document.getElementById('business-plan-popup');
  popup.classList.remove('active');
}

// Charger les coaches pour le formulaire (pour Direction)
async function loadEntrepreneursForBusinessPlan() {
  const container = document.getElementById('entrepreneurs-previsions-container');
  // Utiliser le coach sélectionné si on est en mode Direction, sinon utiliser le username de l'utilisateur connecté
  const username = selectedCoachForView || window.username || localStorage.getItem('username');

  // Choisir le bon endpoint selon si un coach est sélectionné ou non
  const isCoachSelected = selectedCoachForView !== null;
  const objectifsEndpoint = isCoachSelected
    ? `/api/coach/team-objectifs?coach_username=${username}`
    : `/api/direction/team-objectifs?direction_username=${username}`;

  try {
    const response = await fetch(`/api/coaches`);
    const coaches = await response.json();

    if (coaches && coaches.length > 0) {
      // Charger les prévisions existantes
      const prevResponse = await fetch(objectifsEndpoint);
      const prevData = await prevResponse.json();
      const existingPrevisions = prevData.success && prevData.previsions ? prevData.previsions : {};

      // Générer les inputs avec les coaches
      let html = '';
      for (const coach of coaches) {
        const existingValue = existingPrevisions[coach.username] !== undefined ? existingPrevisions[coach.username] : 0;
        // Afficher la valeur formatée même si c'est 0$ (0$ est une prévision valide)
        const displayValue = formatCurrency(existingValue);

        // Récupérer la somme des prévisions que le coach a faites pour ses entrepreneurs
        let objectifCA = 0;
        try {
          const coachPrevResponse = await fetch(`/api/coach/team-objectifs?coach_username=${coach.username}`);
          const coachPrevData = await coachPrevResponse.json();
          if (coachPrevData.success && coachPrevData.previsions) {
            // Calculer la somme de toutes les prévisions du coach
            objectifCA = Object.values(coachPrevData.previsions).reduce((sum, val) => sum + val, 0);
          }
        } catch (error) {
          console.error(`[BUSINESS PLAN] Erreur chargement prévisions du coach ${coach.username}:`, error);
        }

        const fullName = coach.full_name || coach.username;
        // Afficher la somme des prévisions du coach pour ses entrepreneurs
        const objectifDisplay = formatCurrency(objectifCA);

        html += `
          <div class="entrepreneur-input-row">
            <div class="entrepreneur-label" style="display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-user-shield" style="color: var(--primary-blue);"></i>
              <span style="font-weight: 600;">${fullName}</span>
              <span style="font-size: 0.8rem; color: var(--text-gray);">— Objectif: ${objectifDisplay}</span>
            </div>
            <input
              type="text"
              class="business-plan-input bp-entrepreneur-input"
              data-username="${coach.username}"
              data-raw-value="${existingValue}"
              value="${displayValue}"
              placeholder="0,00 $"
              onfocus="handleBPCurrencyFocus(this)"
              onblur="handleBPCurrencyBlur(this)"
              oninput="handleBPCurrencyInput(this)"
            />
          </div>
        `;
      }

      container.innerHTML = html;
    } else {
      container.innerHTML = `
        <div style="text-align: center; padding: 2rem; color: var(--text-gray);">
          <i class="fas fa-exclamation-circle" style="font-size: 1.5rem; margin-bottom: 0.5rem; color: #ef4444;"></i>
          <div>Aucun coach trouvé</div>
        </div>
      `;
    }
  } catch (error) {
    console.error('[BUSINESS PLAN] Erreur chargement coaches:', error);
    container.innerHTML = `
      <div style="text-align: center; padding: 2rem; color: #ef4444;">
        <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
        <div>Erreur lors du chargement des coaches</div>
      </div>
    `;
  }
}

// Charger les métriques existantes
async function loadExistingMetricsForBusinessPlan() {
  // Utiliser le coach sélectionné si on est en mode Direction, sinon utiliser le username de l'utilisateur connecté
  const username = selectedCoachForView || window.username || localStorage.getItem('username');

  // Choisir le bon endpoint selon si un coach est sélectionné ou non
  const isCoachSelected = selectedCoachForView !== null;
  const metricsEndpoint = isCoachSelected
    ? `/api/coach/team-metrics?coach_username=${username}`
    : `/api/direction/team-metrics?direction_username=${username}`;

  try {
    const response = await fetch(metricsEndpoint);
    const data = await response.json();

    if (data.success && data.metrics) {
      const cmInput = document.getElementById('bp-cm-input');
      const ratioInput = document.getElementById('bp-ratio-input');
      const tauxInput = document.getElementById('bp-taux-input');

      if (data.metrics.cm > 0) {
        cmInput.dataset.rawValue = data.metrics.cm;
        cmInput.value = formatCurrency(data.metrics.cm);
      }

      if (data.metrics.ratioMktg > 0) {
        ratioInput.dataset.rawValue = data.metrics.ratioMktg;
        ratioInput.value = data.metrics.ratioMktg.toFixed(1) + ' %';
      }

      if (data.metrics.tauxVente > 0) {
        tauxInput.dataset.rawValue = data.metrics.tauxVente;
        tauxInput.value = data.metrics.tauxVente.toFixed(1) + ' %';
      }

      // Changer le titre si des données existent
      const title = document.getElementById('business-plan-title');
      if (title) {
        title.textContent = 'Modifier mon plan d\'affaires';
      }
    }
  } catch (error) {
    console.error('[BUSINESS PLAN] Erreur chargement métriques:', error);
  }
}

// Gestion des inputs de devise ($ pour entrepreneurs et CM)
function handleBPCurrencyFocus(input) {
  const rawValue = parseFloat(input.dataset.rawValue || '0');
  if (rawValue > 0) {
    input.value = rawValue.toString();
  } else {
    input.value = '';
  }
  input.select();
}

function handleBPCurrencyBlur(input) {
  const value = input.value.replace(/[^0-9.]/g, '');
  const numValue = parseFloat(value) || 0;
  input.dataset.rawValue = numValue;

  if (numValue > 0) {
    input.value = formatCurrency(numValue);
  } else {
    input.value = '';
  }
}

function handleBPCurrencyInput(input) {
  const oldValue = input.value;

  // Retirer tout sauf les chiffres
  const rawValue = oldValue.replace(/[^0-9]/g, '');

  // Si vide, on efface tout
  if (!rawValue) {
    input.value = '';
    input.dataset.rawValue = '0';
    return;
  }

  // Convertir en nombre
  const numValue = parseInt(rawValue, 10);
  input.dataset.rawValue = numValue;

  // Formater avec des espaces tous les 3 chiffres (sans le $)
  const formatted = numValue.toLocaleString('fr-CA').replace(/,/g, ' ');

  input.value = formatted;
}

// Gestion des inputs de métriques (% pour ratio et taux)
function handleBPMetricFocus(input) {
  const metricType = input.dataset.metric;
  const rawValue = parseFloat(input.dataset.rawValue || '0');

  if (rawValue > 0) {
    if (metricType === 'cm') {
      input.value = rawValue.toString();
    } else {
      // Pour les pourcentages
      input.value = rawValue.toString();
    }
  } else {
    input.value = '';
  }
  input.select();
}

function handleBPMetricBlur(input) {
  const metricType = input.dataset.metric;
  const value = input.value.replace(/[^0-9.]/g, '');
  const numValue = parseFloat(value) || 0;
  input.dataset.rawValue = numValue;

  if (numValue > 0) {
    if (metricType === 'cm') {
      input.value = formatCurrency(numValue);
    } else {
      // Pour les pourcentages
      input.value = numValue.toFixed(1) + ' %';
    }
  } else {
    input.value = '';
  }
}

function handleBPMetricInput(input) {
  const metricType = input.dataset.metric;
  const oldValue = input.value;

  if (metricType === 'cm') {
    // Pour CM (devise) - formater en temps réel (sans le $)
    const rawValue = oldValue.replace(/[^0-9]/g, '');

    if (!rawValue) {
      input.value = '';
      input.dataset.rawValue = '0';
      return;
    }

    const numValue = parseInt(rawValue, 10);
    input.dataset.rawValue = numValue;

    const formatted = numValue.toLocaleString('fr-CA').replace(/,/g, ' ');

    input.value = formatted;

  } else {
    // Pour les pourcentages - juste retirer les caractères non numériques
    const newValue = oldValue.replace(/[^0-9.]/g, '');
    if (newValue !== oldValue) {
      input.value = newValue;
    }
  }
}

// Fonction utilitaire pour formater la devise
function formatCurrency(value) {
  return parseFloat(value).toLocaleString('fr-CA', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }) + ' $';
}

// Sauvegarder le plan d'affaires
async function saveBusinessPlan() {
  // Utiliser le coach sélectionné si on est en mode Direction, sinon utiliser le username de l'utilisateur connecté
  const username = selectedCoachForView || window.username || localStorage.getItem('username');

  // Choisir le bon endpoint selon si un coach est sélectionné ou non
  const isCoachSelected = selectedCoachForView !== null;
  const objectifsEndpoint = isCoachSelected ? '/api/coach/team-objectifs' : '/api/direction/team-objectifs';
  const metricsEndpoint = isCoachSelected ? '/api/coach/team-metrics' : '/api/direction/team-metrics';

  const saveBtn = document.getElementById('bp-save-btn');

  // Désactiver le bouton et afficher le spinner
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Enregistrement...</span>';

  try {
    // 1. Récupérer les prévisions des entrepreneurs
    const previsions = {};
    const entrepreneurInputs = document.querySelectorAll('.bp-entrepreneur-input');
    let hasPrevisions = false;

    entrepreneurInputs.forEach(input => {
      const username = input.dataset.username;
      const value = parseFloat(input.dataset.rawValue || '0');
      if (value > 0) {
        previsions[username] = value;
        hasPrevisions = true;
      }
    });

    // 2. Récupérer les métriques
    const cmInput = document.getElementById('bp-cm-input');
    const ratioInput = document.getElementById('bp-ratio-input');
    const tauxInput = document.getElementById('bp-taux-input');

    const metrics = {
      cm: parseFloat(cmInput.dataset.rawValue || '0'),
      ratioMktg: parseFloat(ratioInput.dataset.rawValue || '0'),
      tauxVente: parseFloat(tauxInput.dataset.rawValue || '0')
    };

    const hasMetrics = metrics.cm > 0 || metrics.ratioMktg > 0 || metrics.tauxVente > 0;

    // 3. Vérifier qu'au moins une donnée est renseignée
    if (!hasPrevisions && !hasMetrics) {
      alert('Veuillez renseigner au moins une prévision ou une métrique');
      saveBtn.disabled = false;
      saveBtn.innerHTML = '<i class="fas fa-save"></i><span>Enregistrer</span>';
      return;
    }

    // 4. Sauvegarder les prévisions
    if (hasPrevisions) {
      const requestBody = isCoachSelected
        ? { coach_username: username, previsions: previsions }
        : { direction_username: username, previsions: previsions };

      const prevResponse = await fetch(objectifsEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
      });

      const prevData = await prevResponse.json();
      if (!prevData.success) {
        throw new Error('Erreur lors de la sauvegarde des prévisions');
      }
    }

    // 5. Sauvegarder les métriques
    if (hasMetrics) {
      const requestBody = isCoachSelected
        ? { coach_username: username, metrics: metrics }
        : { direction_username: username, metrics: metrics };

      const metricsResponse = await fetch(metricsEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
      });

      const metricsData = await metricsResponse.json();
      if (!metricsData.success) {
        throw new Error('Erreur lors de la sauvegarde des métriques');
      }
    }

    // 6. Fermer le popup
    closeBusinessPlanPopup();

    // 7. Afficher l'animation de succès
    showSuccessAnimation('Plan d\'affaires enregistré avec succès!');

    // 8. Afficher le spinner pendant le rechargement
    showPlanLoadingSpinner();

    try {
      // 9. Recharger les données pour mettre à jour l'affichage
      await checkAndToggleBusinessPlanView();

      // 10. Recharger le tableau du plan d'affaire
      if (typeof initTeamPlan === 'function') {
        await initTeamPlan();
      }
    } finally {
      // Toujours cacher le spinner
      hidePlanLoadingSpinner();
    }

  } catch (error) {
    console.error('[BUSINESS PLAN] Erreur sauvegarde:', error);
    alert('Erreur lors de la sauvegarde du plan d\'affaires');
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<i class="fas fa-save"></i><span>Enregistrer</span>';
  }
}

// ================================================================
// GESTION DU MODAL RPO COMPLET
// ================================================================

// Variables globales pour le modal
let modalRpoData = null;
let modalCurrentMonth = 0; // Janvier 2026 par défaut
let modalTransformOrigin = 'top left'; // Origine de l'animation

// Variables globales pour le modal RPO Coach
let coachModalSelectedWeek = '2025-W53'; // Semaine par défaut (29 déc - 4 janv)
let coachModalCurrentCoach = null;
let coachModalEntrepreneurFilter = null; // null = tous, sinon username de l'entrepreneur filtré
let coachModalAllEntrepreneurs = []; // Liste de tous les entrepreneurs du coach

// Ouvrir le modal RPO Coach - Afficher le RPO du coach sélectionné
async function openCoachRpoModal(buttonElement) {
  if (!selectedCoachForView) {
    console.error('[COACH RPO MODAL] Aucun coach sélectionné');
    return;
  }

  

  coachModalCurrentCoach = selectedCoachForView;

  // Réinitialiser les filtres pour le nouveau coach
  coachModalAllEntrepreneurs = [];
  coachModalEntrepreneurFilter = null;
  document.getElementById('coach-entrepreneur-filter-text').textContent = 'Tous les entrepreneurs';

  // Afficher le modal
  const modal = document.getElementById('coach-rpo-modal');
  const nameSpan = document.getElementById('coach-rpo-name');
  nameSpan.textContent = selectedCoachDisplayName;

  modal.style.display = 'flex';

  // Bloquer le scroll de la page en arrière-plan
  document.body.style.overflow = 'hidden';

  // Initialiser la semaine actuelle
  coachModalSelectedWeek = getCurrentWeekValue();

  // Initialiser le sélecteur de semaines
  initCoachWeekSelector();

  // Charger les données de la semaine actuelle
  await loadCoachMacroMicroProblem();
  await loadCoachEntrepreneursTable();
}

// Fermer le modal RPO Coach
function closeCoachRpoModal() {
  const modal = document.getElementById('coach-rpo-modal');
  modal.style.display = 'none';

  // Réactiver le scroll de la page
  document.body.style.overflow = '';
}

// Initialiser le sélecteur de semaines
function initCoachWeekSelector() {
  const dropdown = document.getElementById('coach-week-dropdown');
  const selectedText = document.getElementById('coach-selected-week-text');

  dropdown.innerHTML = '';

  // Semaine actuelle (dynamique)
  const currentWeekLabel = getCurrentWeekLabel();
  const currentWeekValue = getCurrentWeekValue();

  const currentWeek = {
    value: currentWeekValue,
    label: currentWeekLabel
  };

  const currentOption = document.createElement('div');
  currentOption.className = 'dropdown-secondary-option';
  currentOption.textContent = currentWeek.label + ' (Semaine actuelle)';
  currentOption.style.background = 'linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.1))';
  currentOption.style.borderLeft = '3px solid #fbbf24';
  currentOption.style.fontWeight = '600';
  currentOption.style.color = '#fbbf24';
  currentOption.onclick = () => selectCoachWeek(currentWeek.value, currentWeek.label);
  dropdown.appendChild(currentOption);

  // Séparateur après la semaine actuelle
  const separator = document.createElement('div');
  separator.style.height = '1px';
  separator.style.background = 'rgba(139, 92, 246, 0.3)';
  separator.style.margin = '0.5rem 0';
  dropdown.appendChild(separator);

  // Toutes les semaines de 2026
  const weeks2026 = [
    // Janvier
    { value: '2026-W01', label: '5 - 11 janv' }, { value: '2026-W02', label: '12 - 18 janv' },
    { value: '2026-W03', label: '19 - 25 janv' }, { value: '2026-W04', label: '26 janv - 1 févr' },
    // Février
    { value: '2026-W05', label: '2 - 8 févr' }, { value: '2026-W06', label: '9 - 15 févr' },
    { value: '2026-W07', label: '16 - 22 févr' }, { value: '2026-W08', label: '23 févr - 1 mars' },
    // Mars
    { value: '2026-W09', label: '2 - 8 mars' }, { value: '2026-W10', label: '9 - 15 mars' },
    { value: '2026-W11', label: '16 - 22 mars' }, { value: '2026-W12', label: '23 - 29 mars' },
    { value: '2026-W13', label: '30 mars - 5 avr' },
    // Avril
    { value: '2026-W14', label: '6 - 12 avr' }, { value: '2026-W15', label: '13 - 19 avr' },
    { value: '2026-W16', label: '20 - 26 avr' }, { value: '2026-W17', label: '27 avr - 3 mai' },
    // Mai
    { value: '2026-W18', label: '4 - 10 mai' }, { value: '2026-W19', label: '11 - 17 mai' },
    { value: '2026-W20', label: '18 - 24 mai' }, { value: '2026-W21', label: '25 - 31 mai' },
    // Juin
    { value: '2026-W22', label: '1 - 7 juin' }, { value: '2026-W23', label: '8 - 14 juin' },
    { value: '2026-W24', label: '15 - 21 juin' }, { value: '2026-W25', label: '22 - 28 juin' },
    { value: '2026-W26', label: '29 juin - 5 juil' },
    // Juillet
    { value: '2026-W27', label: '6 - 12 juil' }, { value: '2026-W28', label: '13 - 19 juil' },
    { value: '2026-W29', label: '20 - 26 juil' }, { value: '2026-W30', label: '27 juil - 2 août' },
    // Août
    { value: '2026-W31', label: '3 - 9 août' }, { value: '2026-W32', label: '10 - 16 août' },
    { value: '2026-W33', label: '17 - 23 août' }, { value: '2026-W34', label: '24 - 30 août' },
    { value: '2026-W35', label: '31 août - 6 sept' },
    // Septembre
    { value: '2026-W36', label: '7 - 13 sept' }, { value: '2026-W37', label: '14 - 20 sept' },
    { value: '2026-W38', label: '21 - 27 sept' }, { value: '2026-W39', label: '28 sept - 4 oct' },
    // Octobre
    { value: '2026-W40', label: '5 - 11 oct' }, { value: '2026-W41', label: '12 - 18 oct' },
    { value: '2026-W42', label: '19 - 25 oct' }, { value: '2026-W43', label: '26 oct - 1 nov' },
    // Novembre
    { value: '2026-W44', label: '2 - 8 nov' }, { value: '2026-W45', label: '9 - 15 nov' },
    { value: '2026-W46', label: '16 - 22 nov' }, { value: '2026-W47', label: '23 - 29 nov' },
    { value: '2026-W48', label: '30 nov - 6 déc' },
    // Décembre
    { value: '2026-W49', label: '7 - 13 déc' }, { value: '2026-W50', label: '14 - 20 déc' },
    { value: '2026-W51', label: '21 - 27 déc' }
  ];

  weeks2026.forEach(week => {
    const option = document.createElement('div');
    option.className = 'dropdown-secondary-option';
    option.textContent = week.label;
    option.onclick = () => selectCoachWeek(week.value, week.label);
    dropdown.appendChild(option);
  });

  // Sélectionner la semaine actuelle par défaut
  coachModalSelectedWeek = currentWeek.value;
  selectedText.textContent = currentWeek.label;

  // Afficher le badge "Semaine actuelle"
  document.getElementById('coach-current-week-badge').style.display = 'inline-block';
}

// Toggle dropdown de semaines
function toggleCoachWeekDropdown() {
  const dropdown = document.getElementById('coach-week-dropdown');
  dropdown.classList.toggle('show');
}

// Sélectionner une semaine
async function selectCoachWeek(weekValue, weekLabel) {
  coachModalSelectedWeek = weekValue;
  document.getElementById('coach-selected-week-text').textContent = weekLabel;
  document.getElementById('coach-week-dropdown').classList.remove('show');

  // Afficher/masquer le badge "Semaine actuelle" selon si c'est la semaine en cours
  const badge = document.getElementById('coach-current-week-badge');
  const currentWeekValue = getCurrentWeekValue();
  if (weekValue === currentWeekValue) {
    badge.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
  }

  // Recharger les données
  await loadCoachMacroMicroProblem();
  await loadCoachEntrepreneursTable(); // Recharger le tableau aussi car le statut RPO dépend de la semaine
}

// Charger MACRO/MICRO/PROBLÈME du coach
async function loadCoachMacroMicroProblem() {
  try {
    const response = await fetch(`/api/coach/macro-micro-problem?coach_username=${coachModalCurrentCoach}&week=${coachModalSelectedWeek}`);

    if (response.ok) {
      const data = await response.json();

      document.getElementById('coach-macro-display').textContent = data.macro || '-';
      document.getElementById('coach-micro-display').textContent = data.micro || '-';
      document.getElementById('coach-problem-display').textContent = data.problem || '-';
    }
  } catch (error) {
    console.error('[COACH RPO MODAL] Erreur chargement MACRO/MICRO/PROBLÈME:', error);
  }
}

// Charger le tableau des entrepreneurs du coach (tableau RPO complet avec toutes les semaines)
async function loadCoachEntrepreneursTable() {
  const tableContainer = document.getElementById('coach-entrepreneurs-table');

  try {
    // Récupérer la liste des entrepreneurs du coach
    const response = await fetch(`/api/entrepreneurs/${coachModalCurrentCoach}`);

    if (!response.ok) {
      throw new Error('Erreur chargement entrepreneurs');
    }

    const entrepreneurs = await response.json();

    // Sauvegarder tous les entrepreneurs pour le filtre
    if (coachModalAllEntrepreneurs.length === 0) {
      coachModalAllEntrepreneurs = entrepreneurs;
      // Initialiser le dropdown du filtre
      initCoachEntrepreneurFilter();
    }

    if (!entrepreneurs || entrepreneurs.length === 0) {
      tableContainer.innerHTML = `
        <div style="text-align: center; padding: 2rem; color: var(--text-gray);">
          <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;"></i>
          <p>Aucun entrepreneur assigné à ce coach</p>
        </div>
      `;
      return;
    }

    // Récupérer les photos de profil pour tous les entrepreneurs (comme dans dashboard classement)
    const photoPromises = entrepreneurs.map(async (entrepreneur) => {
      try {
        const photoResponse = await fetch(`/api/get-profile-photo/${entrepreneur.username}`);
        if (photoResponse.ok) {
          const photoResult = await photoResponse.json();
          return { username: entrepreneur.username, photoUrl: photoResult.photoUrl || null };
        }
      } catch (err) {
        console.warn(`Erreur récupération photo pour ${entrepreneur.username}:`, err);
      }
      return { username: entrepreneur.username, photoUrl: null };
    });

    const photoResults = await Promise.all(photoPromises);
    const photoMap = {};
    photoResults.forEach(result => {
      photoMap[result.username] = result.photoUrl;
    });

    // Filtrer les entrepreneurs selon le filtre sélectionné
    let filteredEntrepreneurs = entrepreneurs;
    if (coachModalEntrepreneurFilter) {
      filteredEntrepreneurs = entrepreneurs.filter(e => e.username === coachModalEntrepreneurFilter);
    }

    // Créer le tableau RPO complet (même structure que le tableau entrepreneur RPO)
    let tableHTML = `
      <div class="rpo-scroll-horizontal" style="overflow-x: auto;">
        <table class="rpo-weekly-table" style="width: 100%; border-collapse: separate; border-spacing: 0;">
          <thead class="rpo-table-head">
            <!-- Première ligne: Groupes de colonnes -->
            <tr class="rpo-header-row rpo-header-group">
              <th class="rpo-col-date" rowspan="2" style="vertical-align: middle; border-right: 2px solid rgba(96, 165, 250, 0.3); position: sticky; left: 0; background: #0f172a; z-index: 30;">Entrepreneur</th>
              <th colspan="3" style="text-align: center; background: rgba(15, 23, 42, 0.5); border-right: 2px solid rgba(96, 165, 250, 0.3);">A-t-il réussi ses objectifs?</th>
              <th colspan="2" style="text-align: center; background: rgba(15, 23, 42, 0.5); border-right: 2px solid rgba(96, 165, 250, 0.3);">Problématique</th>
              <th colspan="3" style="text-align: center; background: rgba(15, 23, 42, 0.5);">Coaching</th>
            </tr>
            <!-- Deuxième ligne: Détails des colonnes -->
            <tr class="rpo-header-row">
              <th class="rpo-col-standard" style="border-right: 1px solid rgba(96, 165, 250, 0.15);">HPAP</th>
              <th class="rpo-col-standard" style="border-right: 1px solid rgba(96, 165, 250, 0.15);">Estims</th>
              <th class="rpo-col-standard" style="border-right: 2px solid rgba(96, 165, 250, 0.3);">$Vendu</th>
              <th class="rpo-col-wide" style="border-right: 1px solid rgba(96, 165, 250, 0.15);">Problème semaine</th>
              <th class="rpo-col-wide" style="border-right: 2px solid rgba(96, 165, 250, 0.3);">Racine problème</th>
              <th class="rpo-col-wide" style="border-right: 1px solid rgba(96, 165, 250, 0.15);">Source du problème</th>
              <th class="rpo-col-wide" style="border-right: 1px solid rgba(96, 165, 250, 0.15);">Type coaching</th>
              <th class="rpo-col-wide">Plan de match</th>
            </tr>
          </thead>
          <tbody class="rpo-table-body">
    `;

    // Pour chaque entrepreneur (filtré), créer une ligne avec ses données RPO pour la semaine sélectionnée
    for (const entrepreneur of filteredEntrepreneurs) {
      const entrepreneurName = entrepreneur.full_name || entrepreneur.username;
      const entrepreneurPhoto = photoMap[entrepreneur.username] || null;

      

      // Charger les données RPO de cet entrepreneur pour la semaine sélectionnée
      let rpoData = {
        objectif_hpap: '',
        objectif_estims: '',
        objectif_vendu: '',
        probleme_semaine: '',
        racine_probleme: '',
        source_probleme: '',
        type_coaching: '',
        plan_match: ''
      };

      try {
        const rpoResp = await fetch(`/api/entrepreneur/weekly-data?username=${entrepreneur.username}&week=${coachModalSelectedWeek}`);
        if (rpoResp.ok) {
          const data = await rpoResp.json();
          if (data.has_data && data.data) {
            rpoData = { ...rpoData, ...data.data };
          }
        }
      } catch (err) {
        console.warn(`Erreur chargement RPO pour ${entrepreneur.username}:`, err);
      }

      tableHTML += `
        <tr style="border-bottom: 1px solid rgba(51, 65, 85, 0.5);">
          <td class="rpo-col-date" style="position: sticky; left: 0; background: #0f172a; z-index: 15; font-weight: 600; color: var(--text-light);">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              ${entrepreneurPhoto
                ? `<img src="${entrepreneurPhoto}" alt="${entrepreneurName}" style="width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 2px solid #60a5fa;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                   <i class="fas fa-user-circle" style="display: none; color: #60a5fa; font-size: 1.5rem;"></i>`
                : `<i class="fas fa-user-circle" style="color: #60a5fa; font-size: 1.5rem;"></i>`
              }
              <span>${entrepreneurName}</span>
            </div>
          </td>

          <!-- HPAP -->
          <td class="rpo-col-standard" style="text-align: left; color: var(--text-gray);">${rpoData.objectif_hpap || '-'}</td>

          <!-- Estims -->
          <td class="rpo-col-standard" style="text-align: left; color: var(--text-gray);">${rpoData.objectif_estims || '-'}</td>

          <!-- $Vendu -->
          <td class="rpo-col-standard" style="text-align: left; color: var(--text-gray);">${rpoData.objectif_vendu || '-'}</td>

          <!-- Problème semaine -->
          <td class="rpo-col-wide">
            <div style="padding: 0.5rem; color: var(--text-gray); font-size: 0.875rem; max-height: 80px; overflow-y: auto;">
              ${rpoData.probleme_semaine || '-'}
            </div>
          </td>

          <!-- Racine problème -->
          <td class="rpo-col-wide">
            <div style="padding: 0.5rem; color: var(--text-gray); font-size: 0.875rem; max-height: 80px; overflow-y: auto;">
              ${rpoData.racine_probleme || '-'}
            </div>
          </td>

          <!-- Source problème -->
          <td class="rpo-col-wide">
            <div style="padding: 0.5rem; color: var(--text-gray); font-size: 0.875rem; max-height: 80px; overflow-y: auto;">
              ${rpoData.source_probleme || '-'}
            </div>
          </td>

          <!-- Type coaching -->
          <td class="rpo-col-wide">
            <div style="padding: 0.5rem; color: var(--text-gray); font-size: 0.875rem; max-height: 80px; overflow-y: auto;">
              ${rpoData.type_coaching || '-'}
            </div>
          </td>

          <!-- Plan de match -->
          <td class="rpo-col-wide">
            <div style="padding: 0.5rem; color: var(--text-gray); font-size: 0.875rem; max-height: 80px; overflow-y: auto;">
              ${rpoData.plan_match || '-'}
            </div>
          </td>
        </tr>
      `;
    }

    tableHTML += `
          </tbody>
        </table>
      </div>
    `;

    tableContainer.innerHTML = tableHTML;

    // Activer le drag-to-scroll sur le conteneur horizontal
    const scrollContainer = tableContainer.querySelector('.rpo-scroll-horizontal');
    if (scrollContainer) {
      let isDown = false;
      let startX;
      let scrollLeft;

      scrollContainer.addEventListener('mousedown', (e) => {
        // Seulement si on clique sur le header
        if (e.target.tagName === 'TH' || e.target.closest('th')) {
          isDown = true;
          scrollContainer.style.cursor = 'grabbing';
          startX = e.pageX - scrollContainer.offsetLeft;
          scrollLeft = scrollContainer.scrollLeft;
        }
      });

      scrollContainer.addEventListener('mouseleave', () => {
        isDown = false;
        scrollContainer.style.cursor = 'default';
      });

      scrollContainer.addEventListener('mouseup', () => {
        isDown = false;
        scrollContainer.style.cursor = 'default';
      });

      scrollContainer.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - scrollContainer.offsetLeft;
        const walk = (x - startX) * 2; // Vitesse de scroll (multiplier pour plus rapide)
        scrollContainer.scrollLeft = scrollLeft - walk;
      });
    }

  } catch (error) {
    console.error('[COACH RPO MODAL] Erreur chargement tableau entrepreneurs:', error);
    tableContainer.innerHTML = `
      <div style="text-align: center; padding: 2rem; color: #ef4444;">
        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
        <p>Erreur lors du chargement des entrepreneurs</p>
      </div>
    `;
  }
}

// Toggle dropdown filtre entrepreneur
function toggleCoachEntrepreneurFilter() {
  const dropdown = document.getElementById('coach-entrepreneur-filter-dropdown');
  dropdown.classList.toggle('show');
}

// Initialiser le filtre entrepreneur
function initCoachEntrepreneurFilter() {
  const dropdown = document.getElementById('coach-entrepreneur-filter-dropdown');
  dropdown.innerHTML = '';

  // Option "Tous les entrepreneurs"
  const allOption = document.createElement('div');
  allOption.className = 'dropdown-option';
  allOption.textContent = 'Tous les entrepreneurs';
  allOption.onclick = () => selectCoachEntrepreneurFilter(null, 'Tous les entrepreneurs');
  dropdown.appendChild(allOption);

  // Ajouter un séparateur
  const separator = document.createElement('div');
  separator.className = 'dropdown-separator';
  dropdown.appendChild(separator);

  // Ajouter chaque entrepreneur
  coachModalAllEntrepreneurs.forEach(entrepreneur => {
    const option = document.createElement('div');
    option.className = 'dropdown-option';
    option.textContent = entrepreneur.full_name || entrepreneur.username;
    option.onclick = () => selectCoachEntrepreneurFilter(entrepreneur.username, entrepreneur.full_name || entrepreneur.username);
    dropdown.appendChild(option);
  });
}

// Sélectionner un filtre entrepreneur
async function selectCoachEntrepreneurFilter(username, displayName) {
  coachModalEntrepreneurFilter = username;
  document.getElementById('coach-entrepreneur-filter-text').textContent = displayName;
  document.getElementById('coach-entrepreneur-filter-dropdown').classList.remove('show');

  // Recharger le tableau avec le filtre
  await loadCoachEntrepreneursTable();
}

// Fermer le dropdown si on clique ailleurs
document.addEventListener('click', function(event) {
  const dropdown = document.getElementById('coach-week-dropdown');
  const button = document.getElementById('coach-week-selector-btn');

  if (dropdown && button && !button.contains(event.target) && !dropdown.contains(event.target)) {
    dropdown.classList.remove('show');
  }

  // Fermer aussi le dropdown du filtre entrepreneur
  const filterDropdown = document.getElementById('coach-entrepreneur-filter-dropdown');
  const filterButton = document.getElementById('coach-entrepreneur-filter-btn');

  if (filterDropdown && filterButton && !filterButton.contains(event.target) && !filterDropdown.contains(event.target)) {
    filterDropdown.classList.remove('show');
  }
});

// Ouvrir le modal RPO - Charger et afficher les données
async function openRpoModal(buttonElement) {
  if (!selectedEntrepreneurForView) {
    console.error('[RPO MODAL] Aucun entrepreneur sélectionné');
    return;
  }

  

  // Préparer le modal (ne pas l'afficher tout de suite)
  const modal = document.getElementById('rpo-modal');
  const modalContent = modal.querySelector('div[style*="background: var(--bg-card)"]');

  // Calculer la position du bouton pour l'origine de l'animation
  if (modalContent && buttonElement) {
    const buttonRect = buttonElement.getBoundingClientRect();
    const modalRect = modal.getBoundingClientRect();

    // Calculer le point d'origine en pourcentage par rapport au modal
    const originX = ((buttonRect.left + buttonRect.width / 2) / modalRect.width) * 100;
    const originY = ((buttonRect.top + buttonRect.height / 2) / modalRect.height) * 100;

    modalTransformOrigin = `${originX}% ${originY}%`;
    modalContent.style.transformOrigin = modalTransformOrigin;
    modalContent.classList.remove('bubble-out');
    modalContent.classList.add('bubble-in');
  } else if (modalContent) {
    // Fallback: origine en haut à gauche
    modalTransformOrigin = 'top left';
    modalContent.style.transformOrigin = modalTransformOrigin;
    modalContent.classList.remove('bubble-out');
    modalContent.classList.add('bubble-in');
  }

  // Charger le nom complet depuis user_info.json (comme le dashboard)
  try {
    const userInfoResponse = await fetch(`/api/get-file/${selectedEntrepreneurForView}/user_info.json`);
    if (userInfoResponse.ok) {
      const userInfo = await userInfoResponse.json();
      const entrepreneurNameDisplay = document.getElementById('entrepreneur-name-display');
      if (entrepreneurNameDisplay) {
        const prenom = userInfo.prenom || '';
        const nom = userInfo.nom || '';
        const fullName = `${prenom} ${nom}`.trim() || selectedEntrepreneurForView;
        entrepreneurNameDisplay.textContent = fullName;
      }
    } else {
      // Fallback: utiliser le displayName s'il existe
      const entrepreneurNameDisplay = document.getElementById('entrepreneur-name-display');
      if (entrepreneurNameDisplay) {
        entrepreneurNameDisplay.textContent = selectedEntrepreneurDisplayName || selectedEntrepreneurForView;
      }
    }
  } catch (error) {
    console.error('[RPO MODAL] Erreur chargement user_info:', error);
    const entrepreneurNameDisplay = document.getElementById('entrepreneur-name-display');
    if (entrepreneurNameDisplay) {
      entrepreneurNameDisplay.textContent = selectedEntrepreneurDisplayName || selectedEntrepreneurForView;
    }
  }

  // Attacher les event listeners pour les boutons Objectifs/Résumé
  document.getElementById('objectifsBtn-modal').onclick = () => toggleModalView(true);
  document.getElementById('resumeBtn-modal').onclick = () => toggleModalView(false);

  // Sélectionner "Objectifs de la semaine" par défaut
  toggleModalView(true);

  // Charger les données RPO de l'entrepreneur
  try {
    const response = await fetch(`/api/coach/entrepreneur-rpo-data?username=${selectedEntrepreneurForView}`);
    if (response.ok) {
      modalRpoData = await response.json();
      

      // Peupler le dropdown des mois avec les mois disponibles
      populateModalMonthDropdown();

      // Déterminer le mois actuel et l'afficher par défaut
      const currentWeekInfo = getCurrentWeekInfo();
      const defaultMonth = currentWeekInfo ? currentWeekInfo.monthIndex : 0;

      
      
      

      // Charger les données du mois actuel (ou janvier si hors période)
      loadModalMonthData(defaultMonth);

      // Afficher le modal APRÈS que les données soient chargées et rendues
      modal.style.display = 'flex';
    } else {
      console.error('[RPO MODAL] Erreur lors du chargement des données');
      document.getElementById('objectifsTable-modal').innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 2rem;">Erreur lors du chargement des données</p>';
    }
  } catch (error) {
    console.error('[RPO MODAL] Erreur:', error);
    document.getElementById('objectifsTable-modal').innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 2rem;">Erreur lors du chargement des données</p>';
  }
}

// Peupler le dropdown des mois avec les mois disponibles dans les données
function populateModalMonthDropdown() {
  if (!modalRpoData || !modalRpoData.weekly) {
    console.error('[MODAL] Pas de données hebdomadaires disponibles');
    return;
  }

  // Tableau des noms de mois (Janvier 2026 à Octobre 2026)
  const monthNames = {
    '0': 'Janvier 2026',
    '1': 'Février 2026',
    '2': 'Mars 2026',
    '3': 'Avril 2026',
    '4': 'Mai 2026',
    '5': 'Juin 2026',
    '6': 'Juillet 2026',
    '7': 'Août 2026',
    '8': 'Septembre 2026',
    '9': 'Octobre 2026'
  };

  const dropdown = document.getElementById('monthSelector-modal-dropdown');
  if (!dropdown) return;

  // Récupérer les mois qui ont des données (limité de Janvier 2026 à Octobre 2026)
  const availableMonths = Object.keys(modalRpoData.weekly)
    .map(m => parseInt(m))
    .filter(m => !isNaN(m) && m >= 0 && m <= 9)  // 0 (Jan 2026) à 9 (Oct 2026)
    .sort((a, b) => a - b);

  

  // Construire le HTML du dropdown
  let html = '';
  availableMonths.forEach(monthIndex => {
    const monthName = monthNames[String(monthIndex)] || `Mois ${monthIndex + 1}`;
    html += `<div class="custom-select-option" data-value="${monthIndex}" onclick="selectModalMonth(${monthIndex}, '${monthName}')">${monthName}</div>`;
  });

  dropdown.innerHTML = html;
}

// Toggle dropdown mois
function toggleModalMonthDropdown(event) {
  if (event) event.stopPropagation();

  const selectContainer = document.getElementById('monthSelector-modal');
  let dropdown = document.getElementById('monthSelector-modal-dropdown');

  if (!selectContainer || !dropdown) {
    console.error('[MODAL] Select container or dropdown not found');
    return;
  }

  // Toggle la classe 'open' sur le container pour activer les styles CSS
  selectContainer.classList.toggle('open');

  // Si on ouvre le dropdown, le déplacer au body et calculer sa position
  if (selectContainer.classList.contains('open')) {
    const button = selectContainer.querySelector('.custom-select-button');

    if (button) {
      // Déplacer le dropdown au body pour échapper au overflow hidden
      if (dropdown.parentElement !== document.body) {
        document.body.appendChild(dropdown);
      }

      const rect = button.getBoundingClientRect();

      // Forcer chaque propriété individuellement avec !important
      dropdown.style.setProperty('position', 'absolute', 'important');
      dropdown.style.setProperty('top', `${rect.bottom + window.scrollY + 4}px`, 'important');
      dropdown.style.setProperty('left', `${rect.left + window.scrollX}px`, 'important');
      dropdown.style.setProperty('width', `${rect.width}px`, 'important');
      dropdown.style.setProperty('display', 'block', 'important');
      dropdown.style.setProperty('z-index', '100001', 'important');
      dropdown.style.setProperty('visibility', 'visible', 'important');
      dropdown.style.setProperty('opacity', '1', 'important');
      dropdown.style.setProperty('transform', 'translateY(0)', 'important');
      dropdown.style.setProperty('min-width', '180px');
      dropdown.style.setProperty('background', 'var(--bg-card)');
      dropdown.style.setProperty('border', '1px solid rgba(51, 65, 85, 0.8)');
      dropdown.style.setProperty('border-radius', '8px');
      dropdown.style.setProperty('box-shadow', '0 4px 12px rgba(0, 0, 0, 0.3)');
    }
  } else {
    // Si on ferme, cacher le dropdown
    dropdown.style.display = 'none';
  }

  
}

// Sélectionner un mois
function selectModalMonth(monthIndex, monthName) {
  modalCurrentMonth = monthIndex;
  document.getElementById('monthSelector-modal-text').textContent = monthName;
  document.getElementById('currentMonthLabel-modal').textContent = `Objectifs et résultats hebdomadaires - ${monthName}`;

  // Fermer le dropdown
  const selectContainer = document.getElementById('monthSelector-modal');
  const dropdown = document.getElementById('monthSelector-modal-dropdown');

  if (selectContainer) {
    selectContainer.classList.remove('open');
  }

  if (dropdown) {
    dropdown.style.display = 'none';
  }

  // Charger les données du mois
  loadModalMonthData(monthIndex);
}

// Fonction pour obtenir la valeur de la semaine actuelle (format "2026-W01")
function getCurrentWeekValue() {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const day = today.getDate();

  if ((year === 2025 && month === 11 && day >= 29) || (year === 2026 && month === 0 && day <= 4)) {
    return '2025-W53';
  } else if (year === 2026 && month === 0 && day >= 5 && day <= 11) {
    return '2026-W01';
  } else if (year === 2026 && month === 0 && day >= 12 && day <= 18) {
    return '2026-W02';
  } else if (year === 2026 && month === 0 && day >= 19 && day <= 25) {
    return '2026-W03';
  } else if (year === 2026 && month === 0 && day >= 26) {
    return '2026-W04';
  } else {
    const startOfYear = new Date(year, 0, 1);
    const daysSinceStart = Math.floor((today - startOfYear) / (24 * 60 * 60 * 1000));
    const weekNum = Math.floor(daysSinceStart / 7) + 1;
    return `${year}-W${String(weekNum).padStart(2, '0')}`;
  }
}

// Fonction pour obtenir le label de la semaine actuelle (format court)
function getCurrentWeekLabel() {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth(); // 0-11 (0=Janvier, 11=Décembre)
  const day = today.getDate();

  // Janvier 2026
  if (year === 2026 && month === 0) {
    if (day >= 5 && day <= 11) return '5 - 11 janv';
    if (day >= 12 && day <= 18) return '12 - 18 janv';
    if (day >= 19 && day <= 25) return '19 - 25 janv';
    if (day >= 26) return '26 janv - 1 févr';
  }

  // Février 2026
  if (year === 2026 && month === 1) {
    if (day >= 2 && day <= 8) return '2 - 8 févr';
    if (day >= 9 && day <= 15) return '9 - 15 févr';
    if (day >= 16 && day <= 22) return '16 - 22 févr';
    if (day >= 23) return '23 févr - 1 mars';
  }

  // Mars 2026
  if (year === 2026 && month === 2) {
    if (day >= 2 && day <= 8) return '2 - 8 mars';
    if (day >= 9 && day <= 15) return '9 - 15 mars';
    if (day >= 16 && day <= 22) return '16 - 22 mars';
    if (day >= 23 && day <= 29) return '23 - 29 mars';
    if (day >= 30) return '30 mars - 5 avr';
  }

  // Par défaut (si aucune correspondance)
  return '5 - 11 janv';
}

// Fonction pour obtenir le label de la semaine actuelle (format long avec années complètes)
function getCurrentWeekLabelLong() {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth(); // 0-11 (0=Janvier, 11=Décembre)
  const day = today.getDate();

  // Janvier 2026
  if (year === 2026 && month === 0) {
    if (day >= 5 && day <= 11) return '5 janvier - 11 janvier';
    if (day >= 12 && day <= 18) return '12 janvier - 18 janvier';
    if (day >= 19 && day <= 25) return '19 janvier - 25 janvier';
    if (day >= 26) return '26 janvier - 1 février';
  }

  // Février 2026
  if (year === 2026 && month === 1) {
    if (day >= 2 && day <= 8) return '2 février - 8 février';
    if (day >= 9 && day <= 15) return '9 février - 15 février';
    if (day >= 16 && day <= 22) return '16 février - 22 février';
    if (day >= 23) return '23 février - 1 mars';
  }

  // Mars 2026
  if (year === 2026 && month === 2) {
    if (day >= 2 && day <= 8) return '2 mars - 8 mars';
    if (day >= 9 && day <= 15) return '9 mars - 15 mars';
    if (day >= 16 && day <= 22) return '16 mars - 22 mars';
    if (day >= 23 && day <= 29) return '23 mars - 29 mars';
    if (day >= 30) return '30 mars - 5 avril';
  }

  // Par défaut (si aucune correspondance)
  return '5 janvier - 11 janvier';
}

// Fonction pour déterminer la semaine actuelle
function getCurrentWeekInfo() {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth(); // 0-11

  // Calculer l'index du mois (Janvier 2026 = 0, etc.)
  let monthIndex;
  if (year === 2026) {
    monthIndex = month; // 0 = Janvier, 1 = Février, etc.
  } else {
    return null; // Pas dans la période couverte
  }

  // Trouver la semaine (1-5) en fonction du jour du mois
  const day = today.getDate();
  let weekNum;
  if (day <= 7) weekNum = 1;
  else if (day <= 14) weekNum = 2;
  else if (day <= 21) weekNum = 3;
  else if (day <= 28) weekNum = 4;
  else weekNum = 5;

  return { monthIndex, weekNum };
}

// Charger les données d'un mois
function loadModalMonthData(monthIndex) {
  if (!modalRpoData || !modalRpoData.weekly) {
    console.error('[RPO MODAL] Pas de données disponibles');
    return;
  }

  const monthKey = String(monthIndex);
  const monthData = modalRpoData.weekly[monthKey] || {};

  

  // Mettre à jour les labels avec le nom du mois
  const monthNames = {
    '0': 'Janvier 2026',
    '1': 'Février 2026',
    '2': 'Mars 2026',
    '3': 'Avril 2026',
    '4': 'Mai 2026',
    '5': 'Juin 2026',
    '6': 'Juillet 2026',
    '7': 'Août 2026',
    '8': 'Septembre 2026',
    '9': 'Octobre 2026',
    '10': 'Novembre 2026',
    '11': 'Décembre 2026'
  };

  const monthName = monthNames[monthKey] || 'Janvier 2026';
  modalCurrentMonth = monthIndex;

  const textElement = document.getElementById('monthSelector-modal-text');
  const labelElement = document.getElementById('currentMonthLabel-modal');

  if (textElement) {
    textElement.textContent = monthName;
  }
  if (labelElement) {
    labelElement.textContent = `Objectifs et résultats hebdomadaires - ${monthName}`;
  }

  // Générer le tableau pour toutes les semaines du mois
  renderModalWeeklyTable(monthData, monthIndex);
}

// Helper function to sanitize number values
function sanitizeNumberValue(value) {
  // Si la valeur est "-" ou null ou undefined, retourner vide
  if (value === '-' || value === null || value === undefined || value === '') {
    return '';
  }
  // Si c'est 0, retourner 0
  if (value === 0) {
    return 0;
  }
  // Sinon retourner la valeur
  return value;
}

// Générer un label de semaine pour un mois et numéro de semaine donnés
function generateWeekLabel(monthIndex, weekNum) {
  const year = monthIndex === -1 ? 2025 : 2026;
  const actualMonth = monthIndex === -1 ? 11 : monthIndex; // -1 => décembre (11)

  const monthNames = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin',
                      'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];

  // Calculer le premier lundi du mois
  const firstDay = new Date(year, actualMonth, 1);
  let currentDate = new Date(firstDay);
  const dayOfWeek = currentDate.getDay();
  const daysToMonday = dayOfWeek === 0 ? 1 : (1 - dayOfWeek + 7) % 7;
  if (daysToMonday > 0) {
    currentDate.setDate(currentDate.getDate() + daysToMonday);
  }

  // Avancer au numéro de semaine demandé (weekNum est 1-indexed)
  currentDate.setDate(currentDate.getDate() + (weekNum - 1) * 7);

  const monday = new Date(currentDate);
  const sunday = new Date(currentDate);
  sunday.setDate(sunday.getDate() + 6);

  const mondayDay = monday.getDate();
  const mondayMonth = monthNames[monday.getMonth()];
  const sundayDay = sunday.getDate();
  const sundayMonth = monthNames[sunday.getMonth()];

  if (monday.getMonth() === sunday.getMonth()) {
    return `${mondayDay} ${mondayMonth} - ${sundayDay} ${mondayMonth}`;
  } else {
    return `${mondayDay} ${mondayMonth} - ${sundayDay} ${sundayMonth}`;
  }
}

// Générer les labels de semaine pour un mois donné (identique à allWeeks dans le coach RPO)
function generateWeekLabelsForMonth(monthIndex) {
  const year = 2026;
  const monthNames = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin',
                      'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];

  // Générer TOUTES les semaines de l'année comme le coach RPO
  let currentDate = new Date(year, 0, 1);
  const dayOfWeek = currentDate.getDay();
  const daysToMonday = dayOfWeek === 0 ? 1 : (1 - dayOfWeek + 7) % 7;
  if (daysToMonday > 0) {
    currentDate.setDate(currentDate.getDate() + daysToMonday);
  }

  const allWeeks = [];

  // Générer toutes les semaines de 2026
  while (currentDate.getFullYear() === year) {
    const monday = new Date(currentDate);
    const sunday = new Date(currentDate);
    sunday.setDate(sunday.getDate() + 6);

    const mondayDay = monday.getDate();
    const mondayMonth = monthNames[monday.getMonth()];
    const sundayDay = sunday.getDate();
    const sundayMonth = monthNames[sunday.getMonth()];

    let weekLabel;
    if (monday.getMonth() === sunday.getMonth()) {
      weekLabel = `${mondayDay} ${mondayMonth} - ${sundayDay} ${mondayMonth}`;
    } else {
      weekLabel = `${mondayDay} ${mondayMonth} - ${sundayDay} ${sundayMonth}`;
    }

    // Exclure la semaine qui chevauche décembre/janvier
    const isDecemberJanuaryWeek = monday.getMonth() === 11 && sunday.getMonth() === 0;
    if (!isDecemberJanuaryWeek) {
      allWeeks.push({
        label: weekLabel,
        monthIndex: monday.getMonth()
      });
    }

    currentDate.setDate(currentDate.getDate() + 7);
  }

  // Filtrer pour garder seulement les 5 premières semaines du mois sélectionné
  const monthWeeks = allWeeks.filter(w => w.monthIndex === monthIndex).slice(0, 5);

  

  return monthWeeks.map(w => w.label);
}

// Générer le tableau hebdomadaire
function renderModalWeeklyTable(monthData, monthIndex) {
  const objectifsTable = document.getElementById('objectifsTable-modal');
  const resumeTable = document.getElementById('resumeTable-modal');

  // Si pas de données, afficher un message
  if (!monthData || Object.keys(monthData).length === 0) {
    objectifsTable.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 2rem;">Aucune donnée pour ce mois</p>';
    resumeTable.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 2rem;">Aucune donnée pour ce mois</p>';
    return;
  }

  // Récupérer toutes les semaines et les trier
  const weeks = Object.keys(monthData).sort((a, b) => parseInt(a) - parseInt(b));

  

  

  // Déterminer si on affiche la colonne Prod Horaire (Décembre 2025 ou à partir de Mai 2026)
  const showProdHoraire = monthIndex === -2 || monthIndex >= 4;

  // Construire le tableau des objectifs - FORMAT IDENTIQUE AU RPO ENTREPRENEUR
  let objectifsHTML = `
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: separate; border-spacing: 0;">
        <thead>
          <tr style="border-bottom: 2px solid rgba(51, 65, 85, 0.5);">
            <th style="position: sticky; left: 0; z-index: 2; background: rgba(30, 41, 59, 0.5); color: #94a3b8; padding: 12px; text-align: left; font-weight: 600; font-size: 0.875rem; border-radius: 14px 14px 0px 0px;">Semaine</th>
            <th style="background: #0f172a; color: #94a3b8; padding: 12px; text-align: center; font-weight: 600; font-size: 0.875rem; border-radius: 14px 14px 0px 0px;">H Marketing</th>
            <th style="background: rgba(30, 41, 59, 0.5); color: #94a3b8; padding: 12px; text-align: center; font-weight: 600; font-size: 0.875rem; border-radius: 14px 14px 0px 0px; min-width: 140px;">H Mktg Réel</th>
            <th style="background: #0f172a; color: #94a3b8; padding: 12px; text-align: center; font-weight: 600; font-size: 0.875rem; border-radius: 14px 14px 0px 0px;">Estimation #</th>
            <th style="background: rgba(30, 41, 59, 0.5); color: #94a3b8; padding: 12px; text-align: center; font-weight: 600; font-size: 0.875rem; border-radius: 14px 14px 0px 0px; min-width: 140px;">Estimation Réel</th>
            <th style="background: #0f172a; color: #94a3b8; padding: 12px; text-align: center; font-weight: 600; font-size: 0.875rem; border-radius: 14px 14px 0px 0px;">Contrat Signé</th>
            <th style="background: rgba(30, 41, 59, 0.5); color: #94a3b8; padding: 12px; text-align: center; font-weight: 600; font-size: 0.875rem; border-radius: 14px 14px 0px 0px; min-width: 140px;">Contrat Signé Réel</th>
            <th style="background: #0f172a; color: #94a3b8; padding: 12px; text-align: center; font-weight: 600; font-size: 0.875rem; border-radius: 14px 14px 0px 0px; min-width: 160px;">$ Signé</th>
            <th style="background: rgba(30, 41, 59, 0.5); color: #94a3b8; padding: 12px; text-align: center; font-weight: 600; font-size: 0.875rem; border-radius: 14px 14px 0px 0px; min-width: 160px;">$ Signé Réel</th>
            ${showProdHoraire ? '<th style="background: #0f172a; color: #94a3b8; padding: 12px; text-align: center; font-weight: 600; font-size: 0.875rem; border-radius: 14px 14px 0px 0px; min-width: 140px;">Prod Horaire ($/H)</th>' : ''}
          </tr>
        </thead>
        <tbody>
  `;

  weeks.forEach((weekNum, index) => {
    const weekData = monthData[weekNum];

    // Filtrer les Semaine 5 qui n'ont pas de week_label (semaines vides/invalides)
    if (weekNum === '5' && !weekData.week_label) {
      return; // Skip cette semaine
    }

    const isLastRow = index === weeks.length - 1;

    // Utiliser le week_label depuis le JSON (exactement comme l'entrepreneur le voit)
    // Pour Décembre 2025 (index -2), générer les labels si manquants
    let weekLabel = weekData.week_label;
    if (!weekLabel && monthIndex === -2) {
      // Décembre 2025 - générer les labels de semaines
      const decWeekLabels = {
        '1': '1 - 7 déc',
        '2': '8 - 14 déc',
        '3': '15 - 21 déc',
        '4': '22 - 28 déc',
        '5': '29 déc - 4 janv'
      };
      weekLabel = decWeekLabels[weekNum] || `Semaine ${weekNum}`;
    } else if (!weekLabel) {
      weekLabel = `Semaine ${weekNum}`;
    }

    // h_marketing peut être "-" dans le JSON, le formater correctement
    const hMarketing = weekData.h_marketing;

    // Lire les vraies valeurs "Visé" depuis le JSON de l'entrepreneur
    const hMarketingVise = weekData.h_marketing_vise || 0;
    const estimationVise = weekData.estimation_vise || 0;
    const contractVise = weekData.contract_vise || 0;
    const dollarVise = Math.round(weekData.dollar_vise || 0);

    // Valeurs "Réel" avec valeurs par défaut
    const estimation = weekData.estimation !== undefined ? weekData.estimation : 0;
    const contract = weekData.contract !== undefined ? weekData.contract : 0;
    const dollar = weekData.dollar !== undefined ? weekData.dollar : 0;

    // Déterminer si c'est la semaine actuelle
    const currentWeek = getCurrentWeekInfo();
    const isCurrentWeek = currentWeek && currentWeek.monthIndex === monthIndex && currentWeek.weekNum === parseInt(weekNum);

    // Styles pour la semaine actuelle (couleur plus jaune)
    const rowBg = isCurrentWeek ? 'background: rgba(251, 191, 36, 0.08); border-left: 3px solid #fbbf24;' : '';
    const cellBgDark = isCurrentWeek ? 'background: rgba(251, 191, 36, 0.12);' : 'background: #0f172a;';
    const cellBgLight = isCurrentWeek ? 'background: rgba(251, 191, 36, 0.08);' : 'background: rgba(30, 41, 59, 0.5);';

    objectifsHTML += `
      <tr style="border-bottom: 1px solid rgba(51, 65, 85, 0.5); height: 60px; ${rowBg}">
        <td style="position: sticky; left: 0; z-index: 1; ${cellBgLight} color: var(--text-gray); padding: 12px; text-align: left; font-size: 0.75rem;">
          ${weekLabel}
          ${isCurrentWeek ? '<span style="display: inline-block; margin-left: 8px; padding: 2px 8px; background: #fbbf24; color: white; border-radius: 4px; font-size: 0.65rem; font-weight: 600;">Cette semaine</span>' : ''}
        </td>
        <td style="${cellBgDark} color: #9ca3af; padding: 12px; text-align: center; font-size: 0.875rem;">${hMarketingVise} h</td>
        <td style="${cellBgLight} color: var(--text-light); padding: 12px; text-align: center; font-size: 0.875rem;">${sanitizeNumberValue(hMarketing)} h</td>
        <td style="${cellBgDark} color: #9ca3af; padding: 12px; text-align: center; font-size: 0.875rem;">${estimationVise}</td>
        <td style="${cellBgLight} color: var(--text-light); padding: 12px; text-align: center; font-size: 0.875rem;">${sanitizeNumberValue(estimation)}</td>
        <td style="${cellBgDark} color: #9ca3af; padding: 12px; text-align: center; font-size: 0.875rem;">${contractVise}</td>
        <td style="${cellBgLight} color: var(--text-light); padding: 12px; text-align: center; font-size: 0.875rem;">${sanitizeNumberValue(contract)}</td>
        <td style="${cellBgDark} color: #9ca3af; padding: 12px; text-align: center; font-size: 0.875rem;">${dollarVise} $</td>
        <td style="${cellBgLight} color: var(--text-light); padding: 12px; text-align: center; font-size: 0.875rem;">${sanitizeNumberValue(dollar)} $</td>
        ${showProdHoraire ? `<td style="${cellBgDark} color: var(--text-light); padding: 12px; text-align: center; font-size: 0.875rem;">${weekData.prod_horaire || '0'} $/H</td>` : ''}
      </tr>
    `;
  });

  objectifsHTML += '</tbody></table></div>';
  objectifsTable.innerHTML = objectifsHTML;

  // Table résumé avec même format
  let resumeHTML = `
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: separate; border-spacing: 0;">
        <thead>
          <tr>
            <th style="position: sticky; left: 0; z-index: 2; background: #0f172a; color: #94a3b8; padding: 12px; text-align: left; font-weight: 600; font-size: 0.875rem; border-radius: 14px 0px 0px 0px; min-width: 180px;">Semaine</th>
            <th style="background: rgba(30, 41, 59, 0.5); color: #94a3b8; padding: 12px; text-align: center; font-weight: 600; font-size: 0.875rem; min-width: 150px;">Comment va-tu</th>
            <th style="background: #0f172a; color: #94a3b8; padding: 12px; text-align: center; font-weight: 600; font-size: 0.875rem; min-width: 250px;">Problème</th>
            <th style="background: rgba(30, 41, 59, 0.5); color: #94a3b8; padding: 12px; text-align: center; font-weight: 600; font-size: 0.875rem; border-radius: 0px 14px 0px 0px; min-width: 250px;">Focus</th>
          </tr>
        </thead>
        <tbody>
  `;

  weeks.forEach((weekNum, index) => {
    const weekData = monthData[weekNum];

    // Filtrer les Semaine 5 qui n'ont pas de week_label (semaines vides/invalides)
    if (weekNum === '5' && !weekData.week_label) {
      return; // Skip cette semaine
    }

    const rating = weekData.rating || 0;
    const stars = rating > 0 ? '⭐'.repeat(rating) : '-';
    const isLastRow = index === weeks.length - 1;

    // Utiliser le week_label depuis le JSON (exactement comme l'entrepreneur le voit)
    // Pour Décembre 2025 (index -2), générer les labels si manquants
    let weekLabel = weekData.week_label;
    if (!weekLabel && monthIndex === -2) {
      // Décembre 2025 - générer les labels de semaines
      const decWeekLabels = {
        '1': '1 - 7 déc',
        '2': '8 - 14 déc',
        '3': '15 - 21 déc',
        '4': '22 - 28 déc',
        '5': '29 déc - 4 janv'
      };
      weekLabel = decWeekLabels[weekNum] || `Semaine ${weekNum}`;
    } else if (!weekLabel) {
      weekLabel = `Semaine ${weekNum}`;
    }

    // Déterminer si c'est la semaine actuelle
    const currentWeek = getCurrentWeekInfo();
    const isCurrentWeek = currentWeek && currentWeek.monthIndex === monthIndex && currentWeek.weekNum === parseInt(weekNum);

    // Styles pour la semaine actuelle (couleur plus jaune)
    const rowBg = isCurrentWeek ? 'background: rgba(251, 191, 36, 0.08); border-left: 3px solid #fbbf24;' : '';
    const cellBgDark = isCurrentWeek ? 'background: rgba(251, 191, 36, 0.12);' : 'background: #0f172a;';
    const cellBgLight = isCurrentWeek ? 'background: rgba(251, 191, 36, 0.08);' : 'background: rgba(30, 41, 59, 0.5);';

    resumeHTML += `
      <tr style="border-bottom: 1px solid rgba(51, 65, 85, 0.5); ${rowBg}">
        <td style="position: sticky; left: 0; z-index: 1; ${cellBgDark} color: #e2e8f0; padding: 12px; text-align: left; font-size: 0.875rem; ${isLastRow ? 'border-radius: 0px 0px 0px 14px;' : ''}">
          ${weekLabel}
          ${isCurrentWeek ? '<span style="display: inline-block; margin-left: 8px; padding: 2px 8px; background: #fbbf24; color: white; border-radius: 4px; font-size: 0.65rem; font-weight: 600;">Cette semaine</span>' : ''}
        </td>
        <td style="${cellBgLight} color: #e2e8f0; padding: 12px; text-align: center; font-size: 0.875rem;">${stars}</td>
        <td style="${cellBgDark} color: #e2e8f0; padding: 12px; text-align: center; font-size: 0.875rem;">${weekData.probleme || '-'}</td>
        <td style="${cellBgLight} color: #e2e8f0; padding: 12px; text-align: center; font-size: 0.875rem; ${isLastRow ? 'border-radius: 0px 0px 14px 0px;' : ''}">${weekData.focus || '-'}</td>
      </tr>
    `;
  });

  resumeHTML += '</tbody></table></div>';
  resumeTable.innerHTML = resumeHTML;
}

// Basculer entre objectifs et résumé
function toggleModalView(showObjectifs) {
  const objectifsBtn = document.getElementById('objectifsBtn-modal');
  const resumeBtn = document.getElementById('resumeBtn-modal');
  const objectifsTable = document.getElementById('objectifsTable-modal');
  const resumeTable = document.getElementById('resumeTable-modal');

  if (showObjectifs) {
    objectifsBtn.className = 'btn-primary';
    resumeBtn.className = 'btn-secondary';
    objectifsTable.classList.remove('hidden');
    resumeTable.classList.add('hidden');
  } else {
    objectifsBtn.className = 'btn-secondary';
    resumeBtn.className = 'btn-primary';
    objectifsTable.classList.add('hidden');
    resumeTable.classList.remove('hidden');
  }
}

// Construire l'interface RPO de l'entrepreneur (avec Marketing Visé/Réel, étoiles, etc.)
function buildEntrepreneurRpoInterface(rpoData, selectedMonth) {
  const weekly = rpoData.weekly || {};
  const monthly = rpoData.monthly || {};

  // Utiliser le mois sélectionné
  const now = new Date();
  const currentMonth = now.getMonth() + 1; // 1-12 (ex: décembre = 12)
  const year = now.getFullYear();

  // Calculer l'index du mois dans la structure weekly
  const targetMonth = parseInt(selectedMonth); // 1-12
  let monthIndex = targetMonth - currentMonth; // ex: si current=12 et target=1, index=-11

  // Ajuster pour le changement d'année
  if (monthIndex < -6) {
    monthIndex += 12; // ex: -11 + 12 = 1 (janvier est le mois prochain)
  }

  

  // Mapper les mois pour l'affichage
  const monthNames = {
    '01': 'Janvier', '02': 'Février', '03': 'Mars', '04': 'Avril',
    '05': 'Mai', '06': 'Juin', '07': 'Juillet', '08': 'Août',
    '09': 'Septembre', '10': 'Octobre', '11': 'Novembre', '12': 'Décembre'
  };
  const monthLabel = `${monthNames[selectedMonth]} ${year}`;

  // Données du mois sélectionné
  
  

  const monthData = weekly[String(monthIndex)] || {};
  const weeks = Object.keys(monthData).sort((a, b) => parseInt(a) - parseInt(b));

  
  

  // Filtrer allWeeksData pour obtenir les semaines du mois sélectionné
  const weeksForMonth = allWeeksData.filter(week => {
    // Extraire le mois de la semaine depuis le label
    const parts = week.label.split(' - ');
    if (parts.length < 2) return false;

    // Prendre la date de début de la semaine
    const startPart = parts[0].trim();
    const monthMatch = startPart.match(/(\d+)\s+(\w+)/);
    if (!monthMatch) return false;

    const monthName = monthMatch[2].toLowerCase();
    const monthNamesMap = {
      'janvier': '01', 'janv.': '01', 'février': '02', 'févr.': '02', 'mars': '03',
      'avril': '04', 'avr.': '04', 'mai': '05', 'juin': '06',
      'juillet': '07', 'juil.': '07', 'août': '08', 'septembre': '09', 'sept.': '09',
      'octobre': '10', 'oct.': '10', 'novembre': '11', 'nov.': '11', 'décembre': '12', 'déc.': '12'
    };

    return monthNamesMap[monthName] === selectedMonth;
  });

  

  // Construire le HTML
  let html = `
    <div class="flex flex-col mb-8" style="border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; overflow: hidden;">
      <!-- Header avec dropdown de mois -->
      <div style="padding: 1.5rem; background: rgba(15, 23, 42, 0.8); border-bottom: 2px solid rgba(96, 165, 250, 0.3); display: flex; justify-content: space-between; align-items: center;">
        <h3 style="color: var(--text-light); font-size: 1.3rem; font-weight: 700; margin: 0;">
          <i class="fas fa-chart-line" style="color: #60a5fa;"></i>
          Objectifs et résultats hebdomadaires
        </h3>
        <!-- Dropdown de sélection de mois -->
        <div style="position: relative;">
          <div onclick="toggleModalMonthDropdown()" style="display: flex; align-items: center; gap: 0.5rem; background: var(--bg-card); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer; min-width: 160px; justify-content: space-between;">
            <span id="modal-month-label" style="color: var(--text-light); font-size: 0.95rem; font-weight: 500;">${monthLabel}</span>
            <i class="fas fa-chevron-down" style="color: var(--text-gray); font-size: 0.75rem;"></i>
          </div>
          <div id="modal-month-menu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: #1e293b; border: 1px solid var(--border-light); border-radius: 8px; padding: 0.5rem; min-width: 180px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; max-height: 350px; overflow-y: auto;">
            <div class="modal-month-option" onclick="selectModalMonth(event, '01')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">Janvier</div>
            <div class="modal-month-option" onclick="selectModalMonth(event, '02')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">Février</div>
            <div class="modal-month-option" onclick="selectModalMonth(event, '03')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">Mars</div>
            <div class="modal-month-option" onclick="selectModalMonth(event, '04')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">Avril</div>
            <div class="modal-month-option" onclick="selectModalMonth(event, '05')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">Mai</div>
            <div class="modal-month-option" onclick="selectModalMonth(event, '06')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">Juin</div>
            <div class="modal-month-option" onclick="selectModalMonth(event, '07')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">Juillet</div>
            <div class="modal-month-option" onclick="selectModalMonth(event, '08')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">Août</div>
            <div class="modal-month-option" onclick="selectModalMonth(event, '09')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">Septembre</div>
            <div class="modal-month-option" onclick="selectModalMonth(event, '10')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">Octobre</div>
            <div class="modal-month-option" onclick="selectModalMonth(event, '11')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">Novembre</div>
            <div class="modal-month-option" onclick="selectModalMonth(event, '12')" style="padding: 0.6rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-light); font-size: 0.9rem; transition: background 0.15s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.15)'" onmouseout="this.style.background=''">Décembre</div>
          </div>
        </div>
      </div>

      <!-- Boutons Objectifs/Résumé -->
      <div style="padding: 1rem 1.5rem; background: rgba(15, 23, 42, 0.5); display: flex; gap: 1rem; border-bottom: 1px solid rgba(51, 65, 85, 0.5);">
        <button onclick="toggleRpoView('objectifs')" id="btn-objectifs" style="padding: 0.5rem 1.5rem; border-radius: 0.5rem; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; font-weight: 600; cursor: pointer; border: none; transition: all 0.3s;">
          Objectifs
        </button>
        <button onclick="toggleRpoView('resume')" id="btn-resume" style="padding: 0.5rem 1.5rem; border-radius: 0.5rem; background: rgba(51, 65, 85, 0.5); color: var(--text-light); font-weight: 600; cursor: pointer; border: none; transition: all 0.3s;">
          Résumé
        </button>
      </div>

      <!-- Tableau Objectifs -->
      <div id="rpo-view-objectifs" style="overflow-x: auto; padding: 1.5rem; padding-bottom: 20rem;">
        <table style="width: 100%; border-collapse: collapse; min-width: 1200px;">
          <thead>
            <tr style="background: rgba(96, 165, 250, 0.1); border-bottom: 2px solid rgba(96, 165, 250, 0.3);">
              <th style="padding: 0.75rem; text-align: left; color: var(--text-light); font-weight: 600; border-right: 1px solid rgba(51, 65, 85, 0.3);">Semaine</th>
              <th style="padding: 0.75rem; text-align: center; color: var(--text-light); font-weight: 600; border-right: 1px solid rgba(51, 65, 85, 0.3);">Marketing Visé (H)</th>
              <th style="padding: 0.75rem; text-align: center; color: var(--text-light); font-weight: 600; border-right: 1px solid rgba(51, 65, 85, 0.3);">Marketing Réel (H)</th>
              <th style="padding: 0.75rem; text-align: center; color: var(--text-light); font-weight: 600; border-right: 1px solid rgba(51, 65, 85, 0.3);">Estimation Visé (#)</th>
              <th style="padding: 0.75rem; text-align: center; color: var(--text-light); font-weight: 600; border-right: 1px solid rgba(51, 65, 85, 0.3);">Estimation Réel (#)</th>
              <th style="padding: 0.75rem; text-align: center; color: var(--text-light); font-weight: 600; border-right: 1px solid rgba(51, 65, 85, 0.3);">Contrat Signé Visé (#)</th>
              <th style="padding: 0.75rem; text-align: center; color: var(--text-light); font-weight: 600; border-right: 1px solid rgba(51, 65, 85, 0.3);">Contrat Signé Réel (#)</th>
              <th style="padding: 0.75rem; text-align: center; color: var(--text-light); font-weight: 600; border-right: 1px solid rgba(51, 65, 85, 0.3);">Montant Signé Visé ($)</th>
              <th style="padding: 0.75rem; text-align: center; color: var(--text-light); font-weight: 600; border-right: 1px solid rgba(51, 65, 85, 0.3);">Montant Signé Réel ($)</th>
              <th style="padding: 0.75rem; text-align: center; color: var(--text-light); font-weight: 600;">Prod Horaire ($/H)</th>
            </tr>
          </thead>
          <tbody>
  `;

  // Récupérer les objectifs mensuels depuis monthly
  const monthKeys = {
    '01': 'jan', '02': 'feb', '03': 'mar', '04': 'apr',
    '05': 'may', '06': 'jun', '07': 'jul', '08': 'aug',
    '09': 'sep', '10': 'oct', '11': 'nov', '12': 'dec'
  };
  const monthlyKey = monthKeys[selectedMonth];
  const monthlyData = monthly[monthlyKey] || {};

  // Ajouter les lignes de données
  if (weeks.length === 0) {
    html += `
      <tr>
        <td colspan="10" style="padding: 2rem; text-align: center; color: var(--text-muted);">
          <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
          <p>Aucune donnée pour ce mois</p>
        </td>
      </tr>
    `;
  } else {
    weeks.forEach((week, index) => {
      const weekData = monthData[week] || {};
      const weekInfo = weeksForMonth[index]; // Utiliser weeksForMonth au lieu de weeksInfo

      // Les données hebdomadaires contiennent uniquement les valeurs réelles
      const hMarketing = weekData.h_marketing || '-';
      const estimation = weekData.estimation || 0;
      const contract = weekData.contract || 0;
      const dollar = weekData.dollar || 0;
      const prodHoraire = weekData.prod_horaire || 0;

      // Les objectifs viennent du monthly (divisés par ~4 semaines pour affichage hebdo)
      const marketingVise = monthlyData.hrpap_vise ? Math.round(monthlyData.hrpap_vise / 4) : 0;
      const estimationVise = monthlyData.estimation_vise ? Math.round(monthlyData.estimation_vise / 4) : 0;
      const contratVise = monthlyData.contract_vise ? Math.round(monthlyData.contract_vise / 4) : 0;
      const montantVise = monthlyData.dollar_vise ? Math.round(monthlyData.dollar_vise / 4) : 0;

      const weekLabel = weekInfo ? weekInfo.label : `Semaine ${week}`;

      html += `
        <tr style="border-bottom: 1px solid rgba(51, 65, 85, 0.3);">
          <td style="padding: 0.75rem; color: var(--text-light); border-right: 1px solid rgba(51, 65, 85, 0.3);">${weekLabel}</td>
          <td style="padding: 0.75rem; text-align: center; color: var(--text-light); border-right: 1px solid rgba(51, 65, 85, 0.3);">${marketingVise}</td>
          <td style="padding: 0.75rem; text-align: center; color: var(--text-light); border-right: 1px solid rgba(51, 65, 85, 0.3);">${hMarketing}</td>
          <td style="padding: 0.75rem; text-align: center; color: var(--text-light); border-right: 1px solid rgba(51, 65, 85, 0.3);">${estimationVise}</td>
          <td style="padding: 0.75rem; text-align: center; color: var(--text-light); border-right: 1px solid rgba(51, 65, 85, 0.3);">${estimation}</td>
          <td style="padding: 0.75rem; text-align: center; color: var(--text-light); border-right: 1px solid rgba(51, 65, 85, 0.3);">${contratVise}</td>
          <td style="padding: 0.75rem; text-align: center; color: var(--text-light); border-right: 1px solid rgba(51, 65, 85, 0.3);">${contract}</td>
          <td style="padding: 0.75rem; text-align: center; color: var(--text-light); border-right: 1px solid rgba(51, 65, 85, 0.3);">${montantVise} $</td>
          <td style="padding: 0.75rem; text-align: center; color: var(--text-light); border-right: 1px solid rgba(51, 65, 85, 0.3);">${dollar} $</td>
          <td style="padding: 0.75rem; text-align: center; color: var(--text-light);">${prodHoraire} $/H</td>
        </tr>
      `;
    });
  }

  html += `
          </tbody>
        </table>
      </div>

      <!-- Tableau Résumé -->
      <div id="rpo-view-resume" style="display: none; overflow-x: auto; padding: 1.5rem;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(96, 165, 250, 0.1); border-bottom: 2px solid rgba(96, 165, 250, 0.3);">
              <th style="padding: 0.75rem; text-align: left; color: var(--text-light); font-weight: 600; width: 15%;">Semaine</th>
              <th style="padding: 0.75rem; text-align: center; color: var(--text-light); font-weight: 600; width: 20%;">Comment va-tu ?</th>
              <th style="padding: 0.75rem; text-align: left; color: var(--text-light); font-weight: 600; width: 35%;">Problème de la semaine</th>
              <th style="padding: 0.75rem; text-align: left; color: var(--text-light); font-weight: 600; width: 30%;">Focus de la semaine</th>
            </tr>
          </thead>
          <tbody>
  `;

  // Ajouter les lignes de résumé
  if (weeks.length === 0) {
    html += `
      <tr>
        <td colspan="4" style="padding: 2rem; text-align: center; color: var(--text-muted);">
          <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
          <p>Aucun résumé pour ce mois</p>
        </td>
      </tr>
    `;
  } else {
    weeks.forEach(week => {
      const weekData = monthData[week] || {};
      const weekInfo = weeksInfo[parseInt(week) - 1]; // week est "1", "2", etc., index 0-based
      const stars = weekData.rating || 0;

      // Extraire Problème et Focus (priorité aux champs directs, fallback sur commentaire)
      let probleme = '-';
      let focus = '-';

      // Priorité 1: Champs directs (nouveau format)
      if (weekData.probleme !== undefined && weekData.probleme !== '') {
        probleme = weekData.probleme;
      }
      if (weekData.focus !== undefined && weekData.focus !== '') {
        focus = weekData.focus;
      }

      // Priorité 2: Parser le commentaire (ancien format) si champs directs vides
      if (probleme === '-' || focus === '-') {
        const commentaire = weekData.commentaire || '';
        if (commentaire && commentaire.includes('|')) {
          const parts = commentaire.split('|');
          if (parts[0] && probleme === '-') probleme = parts[0].replace('Problème:', '').trim() || '-';
          if (parts[1] && focus === '-') focus = parts[1].replace('Focus:', '').trim() || '-';
        }
      }

      // Générer les étoiles
      let starsHtml = '';
      for (let i = 1; i <= 5; i++) {
        starsHtml += `<i class="fas fa-star" style="color: ${i <= stars ? '#fbbf24' : '#4b5563'}; font-size: 1rem;"></i>`;
      }

      const weekLabel = weekInfo ? weekInfo.label : `Semaine ${week}`;

      // Tronquer le texte si trop long (max 30 caractères)
      const truncate = (text, max = 30) => {
        if (!text || text === '-') return '-';
        return text.length > max ? text.substring(0, max) + '...' : text;
      };
      const problemeDisplay = truncate(probleme);
      const focusDisplay = truncate(focus);
      const problemeClickable = probleme && probleme !== '-' && probleme.length > 30;
      const focusClickable = focus && focus !== '-' && focus.length > 30;

      html += `
        <tr style="border-bottom: 1px solid rgba(51, 65, 85, 0.3);">
          <td style="padding: 0.75rem; color: var(--text-light);">${weekLabel}</td>
          <td style="padding: 0.75rem; text-align: center;">${starsHtml}</td>
          <td style="padding: 0.75rem; color: var(--text-light); ${problemeClickable ? 'cursor: pointer;' : ''}" ${problemeClickable ? `onclick="showTextPopup('Problème de la semaine', \`${probleme.replace(/`/g, "'").replace(/"/g, '&quot;')}\`)" title="Cliquer pour voir"` : ''}>${problemeDisplay}</td>
          <td style="padding: 0.75rem; color: var(--text-light); ${focusClickable ? 'cursor: pointer;' : ''}" ${focusClickable ? `onclick="showTextPopup('Analyse', \`${focus.replace(/`/g, "'").replace(/"/g, '&quot;')}\`)" title="Cliquer pour voir"` : ''}>${focusDisplay}</td>
        </tr>
      `;
    });
  }

  html += `
          </tbody>
        </table>
      </div>
    </div>
  `;

  return html;
}

// Toggle entre Objectifs et Résumé
function toggleRpoView(view) {
  const objectifsView = document.getElementById('rpo-view-objectifs');
  const resumeView = document.getElementById('rpo-view-resume');
  const btnObjectifs = document.getElementById('btn-objectifs');
  const btnResume = document.getElementById('btn-resume');

  if (view === 'objectifs') {
    objectifsView.style.display = 'block';
    resumeView.style.display = 'none';
    btnObjectifs.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
    btnObjectifs.style.color = 'white';
    btnResume.style.background = 'rgba(51, 65, 85, 0.5)';
    btnResume.style.color = 'var(--text-light)';
  } else {
    objectifsView.style.display = 'none';
    resumeView.style.display = 'block';
    btnObjectifs.style.background = 'rgba(51, 65, 85, 0.5)';
    btnObjectifs.style.color = 'var(--text-light)';
    btnResume.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
    btnResume.style.color = 'white';
  }
}

// Toggle le dropdown de mois dans le modal
function toggleModalMonthDropdown() {
  event.stopPropagation();
  const menu = document.getElementById('monthSelector-modal-dropdown');
  const isVisible = menu.style.display === 'block';
  menu.style.display = isVisible ? 'none' : 'block';
}
// Fermer les dropdowns si on clique à l'extérieur
document.addEventListener('click', function(e) {
  const modalMonthMenu = document.getElementById('modal-month-menu');
  if (modalMonthMenu && !e.target.closest('.modal-month-option') && !e.target.closest('#modal-month-label')) {
    modalMonthMenu.style.display = 'none';
  }
});

// Fermer le modal RPO avec animation
function closeRpoModal() {
  const modal = document.getElementById('rpo-modal');
  const modalContent = modal.querySelector('div[style*="background: var(--bg-card)"]');

  // Ajouter l'animation de fermeture
  if (modalContent) {
    // Utiliser la même origine que l'ouverture
    modalContent.style.transformOrigin = modalTransformOrigin;
    modalContent.classList.remove('bubble-in');
    modalContent.classList.add('bubble-out');

    // Attendre la fin de l'animation avant de cacher
    setTimeout(() => {
      modal.style.display = 'none';
      modalContent.classList.remove('bubble-out');
    }, 400);
  } else {
    modal.style.display = 'none';
  }

  
}

// Fermer le modal RPO en cliquant à l'extérieur
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('rpo-modal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeRpoModal();
      }
    });
  }
});

// ==================== PLAN D'AFFAIRE ÉQUIPE (STATISTIQUES) ====================

// Variables globales
let teamPlanWeeks = [];
let teamTotalObjectif = 0;

// Fonction pour générer les 52 semaines du plan d'affaire
function generateTeamPlanWeeks() {
  const weeks = [];
  const startDate = new Date(2026, 0, 5); // 5 janvier 2026 (lundi)
  const totalWeeks = 52;
  let weekCounter2026 = 1;

  for (let i = 1; i <= totalWeeks; i++) {
    const weekStartDate = new Date(startDate.getTime() + ((i - 1) * 7 * 24 * 60 * 60 * 1000));
    const weekEndDate = new Date(weekStartDate.getTime() + (6 * 24 * 60 * 60 * 1000));

    const startDay = weekStartDate.getDate();
    const endDay = weekEndDate.getDate();
    const startMonth = weekStartDate.toLocaleDateString('fr-FR', { month: 'short' });
    const endMonth = weekEndDate.toLocaleDateString('fr-FR', { month: 'short' });
    const startYear = weekStartDate.getFullYear();
    const weekMonth = weekStartDate.getMonth() + 1; // 1-12

    let dateRangeStr;
    let weekValue;

    // Toutes les semaines sont en 2026, sauf décembre en fin d'année
    if (startMonth === endMonth) {
      dateRangeStr = `${startDay} - ${endDay} ${startMonth.replace('.', '')}`;
    } else {
      dateRangeStr = `${startDay} ${startMonth.replace('.', '')} - ${endDay} ${endMonth.replace('.', '')}`;
    }
    weekValue = `2026-W${String(weekCounter2026).padStart(2, '0')}`;
    weekCounter2026++;

    weeks.push({
      weekNumber: i,
      weekValue: weekValue,
      weekLabel: dateRangeStr,
      month: weekMonth,
      year: startYear,
      // Toutes les données à 0 par défaut
      mktgPrev: 0,
      mktgReel: 0,
      mktgCumul: 0,
      estimPrev: 0,
      estimReel: 0,
      estimCumul: 0,
      ratio: 0,
      contratPrev: 0,
      contratReel: 0,
      contratCumul: 0,
      dollarPrev: 0,
      dollarReel: 0,
      dollarCumul: 0,
      pctSem: 0,
      pctCumul: 0,
      tvVal: '-',
      prodVise: 0,
      prodReel: 0,
      prodPct: 0
    });
  }

  return weeks;
}

// Fonction pour rendre le tableau du plan d'affaire de l'équipe
function renderTeamPlanTable(weeks, filterMonth = 'all', totalObjectif = 0) {
  const tbody = document.getElementById('stats-plan-weeks-body');
  if (!tbody) return;

  tbody.innerHTML = '';

  // Filtrer les semaines selon le mois sélectionné
  let filteredWeeks = weeks;
  if (filterMonth !== 'all') {
    const [year, month] = filterMonth.split('-').map(Number);
    const monthNames = {
      12: 'déc',
      1: 'janv',
      2: 'févr',
      3: 'mars',
      4: 'avr',
      5: 'mai',
      6: 'juin',
      7: 'juil',
      8: 'août',
      9: 'sept',
      10: 'oct'
    };
    const monthName = monthNames[month];

    filteredWeeks = weeks.filter(w => {
      const weekLabelLower = w.weekLabel.toLowerCase();
      const hasMonthName = weekLabelLower.includes(monthName);

      // Toutes les semaines sont en 2026
      return hasMonthName;
    });
  }

  // Calculer les cumuls (objectifs et réels) pour les semaines filtrées
  let cumulMktgObj = 0;
  let cumulMktgReel = 0;
  let cumulEstimObj = 0;
  let cumulEstimReel = 0;
  let cumulContratObj = 0;
  let cumulContratReel = 0;
  let cumulDollarObj = 0;
  let cumulDollarReel = 0;
  let cumulProdObj = 0;
  let cumulProdReel = 0;
  let cumulPctPattern = 0;
  let cumulDollarPrev = 0;

  filteredWeeks.forEach((week, index) => {
    // Calculer cumuls objectifs
    cumulMktgObj += week.mktgPrev;
    cumulEstimObj += week.estimPrev;
    cumulContratObj += week.contratPrev;
    cumulDollarObj += week.dollarPrev;
    cumulProdObj += week.prodVise;

    // Calculer cumuls réels
    cumulMktgReel += week.mktgReel;
    cumulEstimReel += week.estimReel;
    cumulContratReel += week.contratReel;
    cumulDollarReel += week.dollarReel;
    cumulProdReel += week.prodReel;

    // Trouver l'index global de cette semaine dans le tableau complet (52 semaines)
    const globalIndex = weeks.findIndex(w => w.weekLabel === week.weekLabel);

    // Accumuler les dollars PRÉVUS seulement à partir de la semaine 2 (12 janvier)
    if (globalIndex >= 1) {
      cumulDollarPrev += week.dollarPrev;
    }

    // Ratio (Estim / H. Marketing)
    const ratio = week.mktgReel > 0 ? (week.estimReel / week.mktgReel) : 0;

    // % Objectif semaine (utiliser directement la valeur du pattern pour précision exacte)
    const pctSem = percentagePattern[globalIndex] || 0;

    // % Objectif cumulatif (accumulation des % du pattern, commence à la semaine 2)
    if (globalIndex >= 1) {
      cumulPctPattern += pctSem;
    }
    const pctCumul = (globalIndex >= 1) ? cumulPctPattern : 0;

    // Calculer les tendances (projection annuelle basée sur le % de progression)
    // Formule: (cumul réel / cumul % objectif) * 100 = projection annuelle
    let tendanceMktg = '-';
    let tendanceEstim = '-';
    let tendanceContrat = '-';
    let tendanceDollar = '-';
    let tendanceProd = '-';

    if (pctCumul > 0) {
      // H. Marketing tendance
      if (cumulMktgReel > 0) {
        const tendanceMktgVal = (cumulMktgReel / pctCumul) * 100;
        tendanceMktg = tendanceMktgVal.toFixed(1) + ' h';
      }

      // Estimations tendance
      if (cumulEstimReel > 0) {
        const tendanceEstimVal = (cumulEstimReel / pctCumul) * 100;
        tendanceEstim = Math.round(tendanceEstimVal).toString();
      }

      // Contrats tendance
      if (cumulContratReel > 0) {
        const tendanceContratVal = (cumulContratReel / pctCumul) * 100;
        tendanceContrat = tendanceContratVal.toFixed(1);
      }

      // $ Signés tendance
      if (cumulDollarReel > 0) {
        const tendanceDollarVal = (cumulDollarReel / pctCumul) * 100;
        tendanceDollar = Math.round(tendanceDollarVal).toLocaleString('fr-CA') + ' $';
      }

      // Production tendance
      if (cumulProdReel > 0) {
        const tendanceProdVal = (cumulProdReel / pctCumul) * 100;
        tendanceProd = Math.round(tendanceProdVal).toLocaleString('fr-CA') + ' $';
      }
    }

    // TV% (taux de vente cible, actif du 12 janv au 30 août = index 1 à 33)
    let tvVal = '-';
    if (globalIndex >= 1 && globalIndex <= 33) {
      // Progression du TV% pendant la période de ventes
      tvVal = 25;
      if (globalIndex >= 20) tvVal = 30;
      if (globalIndex >= 32) tvVal = 35;
    }

    // % Production (affiche le % du pattern de production)
    const prodPct = productionIntensityPattern[globalIndex] || 0;

    const tr = document.createElement('tr');
    tr.className = 'plan-row';
    tr.setAttribute('data-month', week.month);
    tr.setAttribute('data-year', week.year);

    tr.innerHTML = `
      <td class="plan-td-sticky" style="left: 0; width: 180px; min-width: 180px; max-width: 180px; text-align: left; font-size: 0.8rem; padding-left: 12px; color: white;">${week.weekLabel}</td>

      <!-- H. Marketing -->
      <td class="plan-td plan-td-prev" style="background: rgba(96, 165, 250, 0.03); color: white;">${week.mktgPrev.toFixed(1)} h</td>
      <td class="plan-td plan-td-reel" style="background: rgba(96, 165, 250, 0.08);">${week.mktgReel > 0 ? week.mktgReel.toFixed(1) + ' h' : '-'}</td>
      <td class="plan-td plan-td-prev" style="background: rgba(96, 165, 250, 0.03); color: white;">${cumulMktgObj.toFixed(1)} h</td>
      <td class="plan-td plan-td-prev" style="background: rgba(96, 165, 250, 0.03); color: white;">${cumulMktgReel.toFixed(1)} h</td>
      <td class="plan-td plan-td-prev" style="background: rgba(96, 165, 250, 0.05); color: white;">${tendanceMktg}</td>

      <!-- Estimations -->
      <td class="plan-td plan-td-prev" style="background: rgba(52, 211, 153, 0.03); color: white;">${Math.round(week.estimPrev)}</td>
      <td class="plan-td plan-td-reel" style="background: rgba(52, 211, 153, 0.08);">${Math.round(week.estimReel)}</td>
      <td class="plan-td plan-td-prev" style="background: rgba(52, 211, 153, 0.03); color: white;">${Math.round(cumulEstimObj)}</td>
      <td class="plan-td plan-td-prev" style="background: rgba(52, 211, 153, 0.03); color: white;">${Math.round(cumulEstimReel)}</td>
      <td class="plan-td plan-td-prev" style="background: rgba(52, 211, 153, 0.05); color: white;">${tendanceEstim}</td>
      <td class="plan-td plan-td-prev" style="background: rgba(52, 211, 153, 0.05); color: white;">${ratio.toFixed(2)}</td>

      <!-- Contrats -->
      <td class="plan-td plan-td-prev" style="background: rgba(251, 146, 60, 0.03); color: white;">${week.contratPrev.toFixed(1)}</td>
      <td class="plan-td plan-td-reel" style="background: rgba(251, 146, 60, 0.08);">${week.contratReel.toFixed(1)}</td>
      <td class="plan-td plan-td-prev" style="background: rgba(251, 146, 60, 0.03); color: white;">${cumulContratObj.toFixed(1)}</td>
      <td class="plan-td plan-td-prev" style="background: rgba(251, 146, 60, 0.03); color: white;">${cumulContratReel.toFixed(1)}</td>
      <td class="plan-td plan-td-prev" style="background: rgba(251, 146, 60, 0.05); color: white;">${tendanceContrat}</td>

      <!-- $ Signés -->
      <td class="plan-td plan-td-prev" style="background: rgba(244, 114, 182, 0.03); color: white;">${Math.round(week.dollarPrev).toLocaleString('fr-CA')} $</td>
      <td class="plan-td plan-td-reel" style="background: rgba(244, 114, 182, 0.08);">${Math.round(week.dollarReel).toLocaleString('fr-CA')} $</td>
      <td class="plan-td" style="background: rgba(244, 114, 182, 0.03); color: white;">${Math.round(cumulDollarObj).toLocaleString('fr-CA')} $</td>
      <td class="plan-td" style="background: rgba(244, 114, 182, 0.03); color: white;">${Math.round(cumulDollarReel).toLocaleString('fr-CA')} $</td>
      <td class="plan-td plan-td-prev" style="background: rgba(244, 114, 182, 0.05); color: white;">${tendanceDollar}</td>

      <!-- % Objectif -->
      <td class="plan-td" style="background: rgba(167, 139, 250, 0.18); font-weight: 600; min-width: 100px; color: white;">${pctSem.toFixed(1)}%</td>
      <td class="plan-td" style="background: rgba(167, 139, 250, 0.12); font-weight: 600; min-width: 100px; color: white;">${pctCumul.toFixed(2)}%</td>
      <td class="plan-td" style="background: rgba(167, 139, 250, 0.18); font-weight: 600; min-width: 100px; color: white;">${tvVal === '-' ? '-' : tvVal + '%'}</td>

      <!-- Production -->
      <td class="plan-td plan-td-prev" style="background: rgba(45, 212, 191, 0.03); color: white;">${Math.round(week.prodVise).toLocaleString('fr-CA')} $</td>
      <td class="plan-td plan-td-reel" style="background: rgba(45, 212, 191, 0.08);">${Math.round(week.prodReel).toLocaleString('fr-CA')} $</td>
      <td class="plan-td plan-td-prev" style="background: rgba(45, 212, 191, 0.03); color: white;">${Math.round(cumulProdObj).toLocaleString('fr-CA')} $</td>
      <td class="plan-td plan-td-prev" style="background: rgba(45, 212, 191, 0.03); color: white;">${Math.round(cumulProdReel).toLocaleString('fr-CA')} $</td>
      <td class="plan-td plan-td-prev" style="background: rgba(45, 212, 191, 0.05); color: white;">${tendanceProd}</td>
      <td class="plan-td plan-td-prev" style="background: rgba(45, 212, 191, 0.03); color: white;">${prodPct > 0 ? prodPct.toFixed(1) + '%' : '0%'}</td>
    `;

    tbody.appendChild(tr);
  });

  // Calculer les totaux
  let totals = {
    mktgPrev: 0,
    mktgReel: 0,
    estimPrev: 0,
    estimReel: 0,
    contratPrev: 0,
    contratReel: 0,
    dollarPrev: 0,
    dollarReel: 0,
    prodVise: 0,
    prodReel: 0
  };

  filteredWeeks.forEach(week => {
    totals.mktgPrev += week.mktgPrev;
    totals.mktgReel += week.mktgReel;
    totals.estimPrev += week.estimPrev;
    totals.estimReel += week.estimReel;
    totals.contratPrev += week.contratPrev;
    totals.contratReel += week.contratReel;
    totals.dollarPrev += week.dollarPrev;
    totals.dollarReel += week.dollarReel;
    totals.prodVise += week.prodVise;
    totals.prodReel += week.prodReel;
  });

  // Mettre à jour les totaux dans le footer
  document.getElementById('total-mktg-prev').textContent = totals.mktgPrev.toFixed(1) + ' h';
  document.getElementById('total-mktg-reel').textContent = totals.mktgReel > 0 ? totals.mktgReel.toFixed(1) + ' h' : '0 h';
  document.getElementById('total-mktg-cumul').textContent = totals.mktgReel.toFixed(1) + ' h';

  document.getElementById('total-estim-prev').textContent = Math.round(totals.estimPrev);
  document.getElementById('total-estim-reel').textContent = Math.round(totals.estimReel);
  document.getElementById('total-estim-cumul').textContent = Math.round(totals.estimReel);
  document.getElementById('total-ratio').textContent = totals.mktgReel > 0 ? (totals.estimReel / totals.mktgReel).toFixed(2) : '0.00';

  document.getElementById('total-contrat-prev').textContent = totals.contratPrev.toFixed(1);
  document.getElementById('total-contrat-reel').textContent = totals.contratReel.toFixed(1);
  document.getElementById('total-contrat-cumul').textContent = totals.contratReel.toFixed(1);

  document.getElementById('total-dollar-prev').textContent = Math.round(totals.dollarPrev).toLocaleString('fr-CA') + ' $';
  document.getElementById('total-dollar-reel').textContent = Math.round(totals.dollarReel).toLocaleString('fr-CA') + ' $';
  document.getElementById('total-dollar-cumul').textContent = Math.round(totals.dollarReel).toLocaleString('fr-CA') + ' $';

  // Calculer % objectif (utiliser le cumul du pattern pour précision exacte)
  const pctPrev = cumulPctPattern;  // Somme exacte des % du pattern
  const pctReel = totalObjectif > 0 ? (totals.dollarReel / totalObjectif * 100) : 0;

  document.getElementById('total-pct-sem').textContent = pctPrev.toFixed(1) + '%';
  document.getElementById('total-pct-cumul').textContent = cumulPctPattern.toFixed(2) + '%';

  document.getElementById('total-prod-vise').textContent = Math.round(totals.prodVise).toLocaleString('fr-CA') + ' $';
  document.getElementById('total-prod-reel').textContent = Math.round(totals.prodReel).toLocaleString('fr-CA') + ' $';

  // Calculer le total du pattern (somme des % pour les semaines filtrées)
  let totalPatternPct = 0;
  filteredWeeks.forEach((week) => {
    const globalIndex = weeks.findIndex(w => w.weekLabel === week.weekLabel);
    totalPatternPct += productionIntensityPattern[globalIndex] || 0;
  });
  document.getElementById('total-prod-pct').textContent = totalPatternPct.toFixed(1) + '%';
}

// Fonction pour activer le scroll par glisser sur le plan d'affaire
function enableStatsPlanScroll() {
  const container = document.querySelector('#stats-plan-affaire .plan-scroll-container');
  if (!container) return;

  let isDown = false;
  let startX;
  let scrollLeft;

  container.addEventListener('mousedown', (e) => {
    isDown = true;
    container.style.cursor = 'grabbing';
    startX = e.pageX - container.offsetLeft;
    scrollLeft = container.scrollLeft;
  });

  container.addEventListener('mouseleave', () => {
    isDown = false;
    container.style.cursor = 'grab';
  });

  container.addEventListener('mouseup', () => {
    isDown = false;
    container.style.cursor = 'grab';
  });

  container.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - container.offsetLeft;
    const walk = (x - startX) * 2;
    container.scrollLeft = scrollLeft - walk;
  });
}

// ==================== FONCTIONS POUR CHARGER LES DONNÉES DES ENTREPRENEURS ====================

// Pattern de distribution des objectifs (% de l'objectif annuel par semaine, du 12 janv au 30 août)
const percentagePattern = [
  0,  // Index 0: 5-11 janv 2026 (semaine vide)
  0.5, 2.0, 2.0,  // Index 1-3: 12 janv - 1 fév
  3.0, 2.5, 3.0, 3.0,  // Index 4-7: 2 fév - 1 mars (2-8 fév: +0.5% = 3.0%)
  3.5, 4.0, 4.5, 5.5,  // Index 8-11: 2 mars - 29 mars (2 mars: +0.5% = 3.5%, 9-15 mars: +0.5% = 4.0%, 16-22 mars: +1% = 4.5%)
  4.5, 6.5, 5.5, 6.0, 6.0,  // Index 12-16: 30 mars - 4 mai (30 mars: +0.5% = 4.5%)
  4.5, 4.5, 4.5, 4.5,  // Index 17-20: 5 mai - 1 juin
  3.5, 4.0, 3.5, 3.0,  // Index 21-24: 2 juin - 29 juin (1-7 juin: +0.5% = 3.5%, 8-14 juin: +1% = 4.0%, 15 juin: +0.5% = 3.5%)
  3.0, 3.0, 3.0, 2.0, 1.0,  // Index 25-29: 30 juin - 3 août
  1.0, 1.0, 1.0, 1.0,  // Index 30-33: 4 août - 31 août
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  // Index 34-51: reste (0%)
];

// Pattern de distribution de production (52 semaines, du 5 mai au 4 octobre = index 17 à 38)
const productionIntensityPattern = [
  // Janvier - Avril 2026 (index 0-16): pas de production
  0, 0, 0, 0, 0,  // Index 0-4: Janvier 2026
  0, 0, 0, 0,     // Index 5-8: Février 2026
  0, 0, 0, 0,     // Index 9-12: Mars 2026
  0, 0, 0, 0,     // Index 13-16: Avril 2026

  // Mai 2026 (index 17-20)
  1,    // Index 17: 5 mai 2026 = 1%
  4,    // Index 18: 12 mai 2026 = 4%
  5,    // Index 19: 19 mai 2026 = 5%
  5,    // Index 20: 26 mai 2026 = 5%

  // Juin 2026 (index 21-24)
  5, 7, 7, 7,

  // Juillet 2026 (index 25-29)
  7, 7, 7, 7, 7,

  // Août 2026 (index 30-33)
  6, 5, 5, 4,

  // Septembre 2026 (index 34-37)
  3.6, 0.1, 0.1, 0.1,

  // Octobre - Décembre 2026 (index 38-51): après production
  0.1,  // Index 38: Première semaine d'octobre
  0, 0, 0, 0, 0,  // Index 39-43: Reste d'octobre
  0, 0, 0, 0,     // Index 44-47: Novembre 2026
  0, 0, 0, 0      // Index 48-51: Décembre 2026
];

// Fonction pour calculer les objectifs visés de l'équipe selon le pattern
function calculateTeamObjectivePattern(totalObjectif, avgCM, avgRatioMktg, avgTauxVente) {
  
  
  
  
  

  const weeklyObjectives = [];

  // Calculer le total du pattern (en excluant les -1 et seulement index 1+)
  const totalPatternPct = percentagePattern.reduce((sum, pct, idx) => {
    if (idx >= 1 && pct > 0) {
      return sum + pct;
    }
    return sum;
  }, 0);

  // L'objectif visé total correspond à l'objectif de base + 10% (comme pour les entrepreneurs)
  const totalObjectifVise = totalObjectif * 1.10;

  for (let i = 0; i < 52; i++) {
    const pct = percentagePattern[i] || 0;

    if (pct === -1 || i < 1) {
      // Semaine d'arrêt (-1) ou avant la semaine 2 (12 janvier), pas d'objectif
      weeklyObjectives.push({
        dollarPrev: 0,
        contratPrev: 0,
        estimPrev: 0,
        mktgPrev: 0
      });
    } else {
      // Calculer les objectifs pour cette semaine (distribution exacte du pattern)
      const dollarPrev = (totalObjectifVise * pct) / totalPatternPct;
      const contratPrev = avgCM > 0 ? dollarPrev / avgCM : 0;
      const estimPrev = contratPrev / (avgTauxVente / 100);
      const mktgPrev = estimPrev / (avgRatioMktg / 100);

      weeklyObjectives.push({
        dollarPrev,
        contratPrev,
        estimPrev,
        mktgPrev
      });
    }
  }

  
  
  
  return weeklyObjectives;
}

// Fonction pour calculer la production visée de l'équipe selon le pattern
function calculateTeamProductionPattern(totalObjectif) {
  const prodPattern = [];

  // Calculer le total des % du pattern
  const totalIntensity = productionIntensityPattern.reduce((sum, val) => sum + val, 0);

  // Pour Direction: production visée = objectif + 10% (comme pour les entrepreneurs)
  const totalProductionVise = totalObjectif * 1.10;

  // Distribuer cette production selon le pattern (normaliser pour que le total = 100% de l'objectif)
  for (let i = 0; i < 52; i++) {
    const prodVise = (totalProductionVise * productionIntensityPattern[i]) / totalIntensity;
    prodPattern.push(prodVise);
  }

  const totalCalculated = prodPattern.reduce((sum, val) => sum + val, 0);
  
  
  
  
  

  return prodPattern;
}

// Fonction pour récupérer la liste des entrepreneurs du coach (ou tous pour Direction)
async function getCoachEntrepreneurs() {
  try {
    const userRole = localStorage.getItem('userRole');

    // Si Direction: récupérer TOUS les entrepreneurs de TOUS les coaches
    if (userRole === 'direction') {
      
      const response = await fetch('/api/direction/all-entrepreneurs');
      if (response.ok) {
        const data = await response.json();
        
        return data.entrepreneurs || [];
      } else {
        console.error('[TEAM PLAN] Erreur récupération tous entrepreneurs:', response.status);
        return [];
      }
    }

    // Si Coach: récupérer seulement les entrepreneurs assignés
    if (!coachUsername) {
      console.error('[TEAM PLAN] Coach username non trouvé');
      return [];
    }

    const response = await fetch(`/api/coach/entrepreneurs?coach_username=${coachUsername}`);
    if (response.ok) {
      const data = await response.json();
      
      return data.entrepreneurs || [];
    } else {
      console.error('[TEAM PLAN] Erreur récupération entrepreneurs:', response.status);
      return [];
    }
  } catch (error) {
    console.error('[TEAM PLAN] Erreur réseau:', error);
    return [];
  }
}

// Fonction pour charger les données RPO d'un entrepreneur
async function loadEntrepreneurRPOData(username) {
  try {
    const response = await fetch(`/api/rpo/data/${username}`);
    if (response.ok) {
      const data = await response.json();
      
      return data;
    } else {
      console.warn(`[TEAM PLAN] Pas de données RPO pour ${username}`);
      return null;
    }
  } catch (error) {
    console.warn(`[TEAM PLAN] Erreur chargement RPO pour ${username}:`, error);
    return null;
  }
}

// Fonction pour charger les objectifs d'un entrepreneur depuis la DB
async function loadEntrepreneurObjectifs(username) {
  try {
    const response = await fetch(`/api/rpo/objectifs/${username}`);
    if (response.ok) {
      const data = await response.json();
      
      return {
        objectif_ca: parseFloat(data.objectif_ca) || 0,
        contrat_moyen: parseFloat(data.contrat_moyen) || 2500,
        ratio_mktg: parseFloat(data.ratio_mktg) || 85,
        taux_vente: parseFloat(data.taux_vente) || 30,
        taux_horaire: parseFloat(data.taux_horaire) || 43
      };
    } else {
      console.warn(`[TEAM PLAN] Pas d'objectifs pour ${username}`);
      return null;
    }
  } catch (error) {
    console.warn(`[TEAM PLAN] Erreur chargement objectifs pour ${username}:`, error);
    return null;
  }
}

// Fonction pour charger les ventes produites d'un entrepreneur
async function loadEntrepreneurVentesProduit(username) {
  try {
    const response = await fetch(`/api/ventes_produit/${username}`);
    if (response.ok) {
      const data = await response.json();
      
      return data || [];
    } else {
      console.warn(`[TEAM PLAN] Pas de ventes produit pour ${username}`);
      return [];
    }
  } catch (error) {
    console.warn(`[TEAM PLAN] Erreur chargement ventes produit pour ${username}:`, error);
    return [];
  }
}

// Fonction pour convertir une date_completion en index de semaine (0-51)
// Les semaines commencent le 5 janvier 2026
function getWeekIndexFromDate(dateCompletion) {
  try {
    // Parser la date (format ISO: "2026-01-10T13:54:19.645559")
    const completionDate = new Date(dateCompletion);

    // Date de début des semaines (5 janvier 2026)
    const startDate = new Date(2026, 0, 5); // Month is 0-indexed, so 0 = January

    // Calculer la différence en jours
    const diffTime = completionDate - startDate;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    // Calculer l'index de semaine (0-51)
    const weekIndex = Math.floor(diffDays / 7);

    // Valider que c'est dans la plage valide (0-51)
    if (weekIndex < 0 || weekIndex >= 52) {
      console.warn(`[TEAM PLAN] Date hors plage: ${dateCompletion} -> semaine ${weekIndex}`);
      return null;
    }

    
    return weekIndex;
  } catch (error) {
    console.warn(`[TEAM PLAN] Erreur parsing date ${dateCompletion}:`, error);
    return null;
  }
}

// Fonction pour parser un montant formaté ("1 500,00 $" -> 1500)
function parseMonetaryAmount(amountStr) {
  if (!amountStr) return 0;

  // Enlever les espaces, le symbole $ et convertir la virgule en point
  const cleanAmount = String(amountStr)
    .replace(/\s/g, '')  // Enlever les espaces
    .replace('$', '')     // Enlever le $
    .replace(',', '.');   // Remplacer virgule par point

  const parsed = parseFloat(cleanAmount);
  return isNaN(parsed) ? 0 : parsed;
}

// Fonction pour charger les données pré-agrégées depuis le RPO direction
async function aggregateTeamData() {
  console.log('[TEAM PLAN] Chargement données direction depuis JSON (instantané)...');

  // Charger le JSON direction (contient prévisions + réels)
  const directionRPOData = await loadEntrepreneurRPOData('direction');

  if (!directionRPOData) {
    console.warn('[TEAM PLAN] Pas de données RPO pour direction');
    return {
      totalObjectif: 0,
      averages: {
        cm: 0,
        ratioMktg: 0,
        tauxVente: 0
      },
      weeklyData: {}
    };
  }

  // 1. Charger les PRÉVISIONS depuis le JSON direction
  const directionPrevisions = directionRPOData.direction_previsions || { cm: 0, ratioMktg: 0, tauxVente: 0, totalObjectif: 0 };
  const totalObjectif = directionPrevisions.totalObjectif || 0;
  const directionMetrics = {
    cm: directionPrevisions.cm || 0,
    ratioMktg: directionPrevisions.ratioMktg || 0,
    tauxVente: directionPrevisions.tauxVente || 0
  };

  console.log('[TEAM PLAN] Prévisions depuis JSON:', { totalObjectif, ...directionMetrics });

  // Si pas de prévisions, retourner objectif à 0
  if (totalObjectif === 0) {
    console.warn('[TEAM PLAN] Aucune prévision définie - plan d\'affaire non disponible');
    return {
      totalObjectif: 0,
      averages: {
        cm: 0,
        ratioMktg: 0,
        tauxVente: 0
      },
      weeklyData: {}
    };
  }

  // 2. Charger les RÉELS de direction (depuis JSON - données hebdomadaires agrégées)
  if (!directionRPOData.weekly) {
    console.warn('[TEAM PLAN] Pas de données hebdomadaires pour direction');
    return {
      totalObjectif,
      averages: directionMetrics,
      weeklyData: {}
    };
  }

  const allWeeklyData = {};

  // Initialiser la structure pour 52 semaines
  for (let i = 0; i < 52; i++) {
    allWeeklyData[i] = {
      mktgReel: 0,
      estimReel: 0,
      contratReel: 0,
      dollarReel: 0,
      prodReel: 0
    };
  }

  // Offsets des semaines par mois (52 semaines total, du 5 janvier au 27 décembre 2026)
  const weekOffsets = {
    '0': 0,    // Janvier 2026 (5 semaines)
    '1': 5,    // Février 2026 (4 semaines)
    '2': 9,    // Mars 2026 (4 semaines)
    '3': 13,   // Avril 2026 (5 semaines)
    '4': 18,   // Mai 2026 (4 semaines)
    '5': 22,   // Juin 2026 (4 semaines)
    '6': 26,   // Juillet 2026 (5 semaines)
    '7': 31,   // Août 2026 (4 semaines)
    '8': 35,   // Septembre 2026 (4 semaines)
    '9': 39,   // Octobre 2026 (5 semaines)
    '10': 44,  // Novembre 2026 (4 semaines)
    '11': 48   // Décembre 2026 (4 semaines)
  };

  // Lire les données hebdomadaires pré-agrégées de direction
  for (let monthIndex = 0; monthIndex <= 11; monthIndex++) {
    const monthKey = String(monthIndex);
    if (!directionRPOData.weekly[monthKey]) continue;

    const monthData = directionRPOData.weekly[monthKey];
    const weekNumbers = Object.keys(monthData).sort((a, b) => parseInt(a) - parseInt(b));

    for (const weekNum of weekNumbers) {
      const offset = weekOffsets[monthKey];
      if (offset === undefined) continue;

      const weekIndex = offset + parseInt(weekNum) - 1;
      if (weekIndex < 0 || weekIndex >= 52) continue;

      const weekData = monthData[weekNum];

      // Les données sont déjà agrégées dans le fichier RPO direction
      const hMarketing = weekData.h_marketing || 0;
      allWeeklyData[weekIndex].mktgReel = (hMarketing === '-' || hMarketing === '') ? 0 : parseFloat(hMarketing);
      allWeeklyData[weekIndex].estimReel = parseFloat(weekData.estimation) || 0;
      allWeeklyData[weekIndex].contratReel = parseFloat(weekData.contract) || 0;
      allWeeklyData[weekIndex].dollarReel = parseFloat(weekData.dollar) || 0;
      allWeeklyData[weekIndex].prodReel = parseFloat(weekData.produit) || 0;
    }
  }

  console.log('[TEAM PLAN] Données hebdomadaires chargées depuis RPO direction:', allWeeklyData);

  // Calculer la production réelle totale
  const productionTotale = Object.values(allWeeklyData).reduce((sum, w) => sum + w.prodReel, 0);
  console.log('[TEAM PLAN] Production réelle totale (ventes produites):', productionTotale.toLocaleString('fr-CA') + ' $');

  console.log('[TEAM PLAN] ✅ Prévisions (JSON):', { totalObjectif, averages: directionMetrics });
  console.log('[TEAM PLAN] ✅ Réels (JSON):', { productionTotale, nombreSemaines: Object.keys(allWeeklyData).length });

  return {
    totalObjectif,        // Depuis JSON (prévisions)
    weeklyData: allWeeklyData,  // Depuis JSON (réels)
    averages: directionMetrics      // Depuis JSON (prévisions)
  };
}

// Fonction pour initialiser le plan d'affaire de l'équipe
async function initTeamPlan() {
  

  // Utiliser le coach sélectionné si on est en mode Direction, sinon utiliser le username de l'utilisateur connecté
  const username = selectedCoachForView || window.username || localStorage.getItem('username');
  if (!username) {
    console.warn('[DIRECTION PLAN] Pas de username');
    return;
  }

  // Choisir le bon endpoint selon si un coach est sélectionné ou non
  const isCoachSelected = selectedCoachForView !== null;
  const objectifsEndpoint = isCoachSelected
    ? `/api/coach/team-objectifs?coach_username=${username}`
    : `/api/direction/team-objectifs?direction_username=${username}`;
  const metricsEndpoint = isCoachSelected
    ? `/api/coach/team-metrics?coach_username=${username}`
    : `/api/direction/team-metrics?direction_username=${username}`;

  // Générer les 52 semaines
  teamPlanWeeks = generateTeamPlanWeeks();


  // ÉTAPE 1: Charger l'objectif total
  try {
    let objectifData;

    // OPTIMISATION: Utiliser le cache si disponible pour direction
    if (!isCoachSelected) {
      const cachedObjectifs = sessionStorage.getItem('cached_direction_objectifs');
      if (cachedObjectifs) {
        objectifData = JSON.parse(cachedObjectifs);
      }
    }

    // Si pas de cache, faire l'appel API
    if (!objectifData) {
      const objectifResponse = await fetch(objectifsEndpoint);
      objectifData = await objectifResponse.json();
    }

    if (objectifData.success && objectifData.total) {
      teamTotalObjectif = objectifData.total;

    } else {
      teamTotalObjectif = 0;

    }
  } catch (error) {
    console.error('[DIRECTION PLAN] ❌ Erreur chargement objectif:', error);
    teamTotalObjectif = 0;
  }

  // Afficher l'objectif total
  const valueSpan = document.getElementById('team-objectif-value');
  const placeholderDiv = document.getElementById('team-objectif-placeholder');

  if (!teamTotalObjectif || teamTotalObjectif === 0) {
    valueSpan.style.display = 'none';
    placeholderDiv.style.display = 'block';
  } else {
    valueSpan.style.display = 'block';
    placeholderDiv.style.display = 'none';
    valueSpan.textContent = teamTotalObjectif.toLocaleString('fr-CA', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }) + ' $';
  }

  // ÉTAPE 2: Charger les métriques (CM, Ratio Marketing, Taux de Vente)
  let directionMetrics = { cm: 0, ratioMktg: 0, tauxVente: 0 };
  try {
    let metricsData;

    // OPTIMISATION: Utiliser le cache si disponible pour direction
    if (!isCoachSelected) {
      const cachedMetrics = sessionStorage.getItem('cached_direction_metrics');
      if (cachedMetrics) {
        metricsData = JSON.parse(cachedMetrics);
      }
    }

    // Si pas de cache, faire l'appel API
    if (!metricsData) {
      const metricsResponse = await fetch(metricsEndpoint);
      metricsData = await metricsResponse.json();
    }

    if (metricsData.success && metricsData.metrics) {
      directionMetrics = metricsData.metrics;

    } else {

    }
  } catch (error) {
    console.error('[DIRECTION PLAN] ❌ Erreur chargement métriques:', error);
  }

  // Afficher les métriques
  const cmValueSpan = document.getElementById('coach-cm-value') || document.getElementById('team-cm-value');
  const cmPlaceholder = document.getElementById('coach-cm-placeholder') || document.getElementById('team-cm-placeholder');
  const ratioValueSpan = document.getElementById('coach-ratio-value') || document.getElementById('team-ratio-value');
  const ratioPlaceholder = document.getElementById('coach-ratio-placeholder') || document.getElementById('team-ratio-placeholder');
  const tauxValueSpan = document.getElementById('coach-taux-value') || document.getElementById('team-taux-value');
  const tauxPlaceholder = document.getElementById('coach-taux-placeholder') || document.getElementById('team-taux-placeholder');

  // CM
  if (directionMetrics.cm > 0 && cmValueSpan) {
    cmValueSpan.textContent = directionMetrics.cm.toLocaleString('fr-CA', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }) + ' $';
    cmValueSpan.style.display = 'block';
    if (cmPlaceholder) cmPlaceholder.style.display = 'none';
  } else if (cmValueSpan) {
    cmValueSpan.style.display = 'none';
    if (cmPlaceholder) cmPlaceholder.style.display = 'block';
  }

  // Ratio Marketing
  if (directionMetrics.ratioMktg > 0 && ratioValueSpan) {
    ratioValueSpan.textContent = directionMetrics.ratioMktg.toFixed(1) + ' %';
    ratioValueSpan.style.display = 'block';
    if (ratioPlaceholder) ratioPlaceholder.style.display = 'none';
  } else if (ratioValueSpan) {
    ratioValueSpan.style.display = 'none';
    if (ratioPlaceholder) ratioPlaceholder.style.display = 'block';
  }

  // Taux de Vente
  if (directionMetrics.tauxVente > 0 && tauxValueSpan) {
    tauxValueSpan.textContent = directionMetrics.tauxVente.toFixed(1) + ' %';
    tauxValueSpan.style.display = 'block';
    if (tauxPlaceholder) tauxPlaceholder.style.display = 'none';
  } else if (tauxValueSpan) {
    tauxValueSpan.style.display = 'none';
    if (tauxPlaceholder) tauxPlaceholder.style.display = 'block';
  }

  // ÉTAPE 3: Calculer le plan UNIQUEMENT à partir des 4 stats
  
  
  
  
  

  // Pattern d'objectifs ($ Objectif, Contrats Objectif, etc.)
  const objectivePattern = calculateTeamObjectivePattern(
    teamTotalObjectif,
    directionMetrics.cm,
    directionMetrics.ratioMktg,
    directionMetrics.tauxVente
  );

  // Pattern de production
  const prodPattern = calculateTeamProductionPattern(teamTotalObjectif);

  // ÉTAPE 4: Charger les données RÉELLES de tous les entrepreneurs
  const aggregatedData = await aggregateTeamData();
  

  // Appliquer les patterns aux semaines + données réelles
  teamPlanWeeks.forEach((week, index) => {
    const objectives = objectivePattern[index];
    if (objectives) {
      week.mktgPrev = objectives.mktgPrev;
      week.estimPrev = objectives.estimPrev;
      week.contratPrev = objectives.contratPrev;
      week.dollarPrev = objectives.dollarPrev;
    }
    week.prodVise = prodPattern[index] || 0;

    // Charger les données RÉELLES agrégées de tous les entrepreneurs
    if (aggregatedData && aggregatedData.weeklyData && aggregatedData.weeklyData[index]) {
      const weekData = aggregatedData.weeklyData[index];
      week.mktgReel = weekData.mktgReel || 0;
      week.estimReel = weekData.estimReel || 0;
      week.contratReel = weekData.contratReel || 0;
      week.dollarReel = weekData.dollarReel || 0;
      week.prodReel = weekData.prodReel || 0;
    } else {
      week.mktgReel = 0;
      week.estimReel = 0;
      week.contratReel = 0;
      week.dollarReel = 0;
      week.prodReel = 0;
    }
  });

  

  // Rendre le tableau avec toutes les semaines par défaut
  renderTeamPlanTable(teamPlanWeeks, 'all', teamTotalObjectif);

  // Activer le scroll par glisser
  enableStatsPlanScroll();

  // Gérer le dropdown de filtre par mois
  const statsMonthSelector = document.getElementById('statsMonthSelectorDesktop');
  if (statsMonthSelector) {
    
    const options = statsMonthSelector.querySelectorAll('.custom-select-option');
    const buttonText = statsMonthSelector.querySelector('.custom-select-text');
    const buttonElement = statsMonthSelector.querySelector('.custom-select-button');
    const dropdown = statsMonthSelector.querySelector('.custom-select-dropdown');

    

    options.forEach(option => {
      option.addEventListener('click', function(e) {
        e.stopPropagation();
        const value = this.getAttribute('data-value');
        const text = this.textContent.trim();

        

        if (buttonText) {
          buttonText.textContent = text;
        }
        options.forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        renderTeamPlanTable(teamPlanWeeks, value, teamTotalObjectif);
        if (dropdown) {
          dropdown.style.display = 'none';
          dropdown.style.opacity = '0';
          dropdown.style.visibility = 'hidden';
          dropdown.style.transform = 'translateY(-10px)';
        }
      });
    });

    if (buttonElement) {
      buttonElement.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (dropdown) {
          const isHidden = dropdown.style.display === 'none' || dropdown.style.display === '';

          // Utiliser un setTimeout pour éviter les conflits avec l'événement document
          setTimeout(() => {
            if (isHidden) {
              dropdown.style.display = 'block';
              dropdown.style.opacity = '1';
              dropdown.style.visibility = 'visible';
              dropdown.style.transform = 'translateY(0)';
            } else {
              dropdown.style.display = 'none';
              dropdown.style.opacity = '0';
              dropdown.style.visibility = 'hidden';
              dropdown.style.transform = 'translateY(-10px)';
            }
            
          }, 0);
        }
      });
    }

    // Fermer le dropdown si on clique ailleurs
    document.addEventListener('click', function(e) {
      if (statsMonthSelector && !statsMonthSelector.contains(e.target)) {
        if (dropdown) {
          dropdown.style.display = 'none';
          dropdown.style.opacity = '0';
          dropdown.style.visibility = 'hidden';
          dropdown.style.transform = 'translateY(-10px)';
        }
      }
    });
  } else {
    console.error('[STATS] statsMonthSelector NON trouvé!');
  }
}

// Appeler initTeamPlan au chargement si on a déjà un coachUsername
document.addEventListener('DOMContentLoaded', function() {
  // Attendre un peu que coachUsername soit défini (dans l'autre DOMContentLoaded)
  setTimeout(() => {
    if (coachUsername) {
      
      updateTeamObjectifDisplay(); // Mettre à jour l'affichage immédiatement
      initTeamPlan();
      checkIfBusinessPlanNeeded(); // Vérifier et afficher le plan d'affaires
    } else {
      console.warn('[INIT] coachUsername non défini, initTeamPlan() non appelé');
    }
  }, 100);
});

// ========== POPUP OBJECTIF VENTE ÉQUIPE ==========

// Fonction pour ouvrir la popup et charger les coaches
async function openTeamObjectifPopup() {
  

  // Mettre à jour l'affichage de la carte avant d'ouvrir le popup
  await updateTeamObjectifDisplay();

  // Afficher la popup
  const popup = document.getElementById('teamObjectifPopup');
  popup.style.display = 'flex';

  // Pour Direction, charger TOUS les coaches
  try {
    const username = window.username || localStorage.getItem('username');
    

    const response = await fetch(`/api/coaches`);
    const coaches = await response.json();

    if (coaches && Array.isArray(coaches)) {
      
      await populateTeamObjectifTable(coaches, username);
    } else {
      console.error('[TEAM OBJECTIF] Erreur chargement coaches');
    }
  } catch (error) {
    console.error('[TEAM OBJECTIF] Erreur:', error);
  }
}

// Fonction pour peupler le tableau
async function populateTeamObjectifTable(coaches, directionUsername) {
  const tbody = document.getElementById('team-objectif-tbody');
  tbody.innerHTML = '';

  // Charger les prévisions existantes de la direction
  let directionPrevisions = {};
  try {
    const prevResponse = await fetch(`/api/direction/team-objectifs?direction_username=${directionUsername}`);
    const prevData = await prevResponse.json();
    if (prevData.success && prevData.previsions) {
      directionPrevisions = prevData.previsions;
    }
  } catch (error) {
    console.warn('[TEAM OBJECTIF] Pas de prévisions existantes');
  }

  let totalPrevision = 0;

  for (const coach of coaches) {
    // Récupérer l'objectif actuel du coach (agrégé de son équipe)
    const objectifActuel = coach.chiffre_affaires?.objectif || 0;

    // Photo de profil déjà fournie par l'API
    const photoUrl = coach.photo;

    // Récupérer la prévision de la direction (0 par défaut)
    const previsionDirection = directionPrevisions[coach.username] || 0;
    totalPrevision += previsionDirection;

    // Déterminer le nom à afficher
    const displayName = (coach.prenom && coach.nom)
      ? `${coach.prenom} ${coach.nom}`.trim()
      : coach.username;
    const initials = coach.prenom && coach.nom
      ? `${coach.prenom[0]}${coach.nom[0]}`.toUpperCase()
      : coach.username.substring(0, 2).toUpperCase();

    const row = document.createElement('tr');
    row.style.borderBottom = '1px solid var(--border-dark)';
    row.style.transition = 'background 0.2s ease';
    row.onmouseover = function() { this.style.background = 'rgba(59, 130, 246, 0.05)'; };
    row.onmouseout = function() { this.style.background = 'transparent'; };

    // Générer l'avatar (photo ou initiales)
    const avatarHtml = photoUrl
      ? `<img src="${photoUrl}" alt="${displayName}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-blue);">`
      : `<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.875rem; border: 2px solid var(--primary-blue);">
          ${initials}
        </div>`;

    row.innerHTML = `
      <td style="padding: 1rem;">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          ${avatarHtml}
          <div>
            <div style="font-weight: 600; color: var(--text-light);">${displayName}</div>
            <div style="font-size: 0.75rem; color: var(--text-gray);">Coach - ${coach.nb_entrepreneurs || 0} entrepreneur(s)</div>
          </div>
        </div>
      </td>
      <td style="padding: 1rem;">
        <div style="font-weight: 600; color: var(--text-gray); font-size: 0.875rem;">
          ${objectifActuel.toLocaleString('fr-CA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} $
        </div>
      </td>
      <td style="padding: 1rem;">
        <input
          type="text"
          value="${formatCurrency(previsionDirection)}"
          placeholder="Cliquez pour remplir"
          data-coach="${coach.username}"
          data-raw-value="${previsionDirection}"
          class="prevision-input ${previsionDirection === 0 ? 'prevision-empty' : ''}"
          style="width: 100%; background: rgba(23, 32, 51, 0.8); border: 2px solid ${previsionDirection === 0 ? 'rgba(239, 68, 68, 0.5)' : 'var(--border-dark)'}; border-radius: 12px; padding: 0.75rem; color: ${previsionDirection === 0 ? 'var(--text-gray)' : 'var(--text-light)'}; font-weight: 600; font-size: 0.875rem; transition: all 0.3s ease;"
          onfocus="handlePrevisionFocus(this)"
          onblur="handlePrevisionBlur(this)"
          oninput="handlePrevisionInput(this)"
        />
      </td>
    `;

    tbody.appendChild(row);
  }

  // Mettre à jour le total
  document.getElementById('popup-team-total').textContent = totalPrevision.toLocaleString('fr-CA', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }) + ' $';
}

// Fonction pour formater un nombre en devise
function formatCurrency(value) {
  const num = parseFloat(value) || 0;
  return num.toLocaleString('fr-CA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' $';
}

// Fonction pour extraire la valeur numérique d'une devise formatée
function parseCurrency(formattedValue) {
  const cleaned = formattedValue.replace(/\s/g, '').replace('$', '').replace(',', '.');
  return parseFloat(cleaned) || 0;
}

// Gestion du focus sur l'input de prévision
function handlePrevisionFocus(input) {
  input.style.borderColor = 'var(--primary-blue)';
  input.style.background = 'rgba(23, 32, 51, 1)';
  if (input.value.endsWith(' $')) {
    input.value = input.value.slice(0, -2).trim();
  }
  input.select();
}

// Gestion de la perte de focus sur l'input de prévision
function handlePrevisionBlur(input) {
  input.style.borderColor = 'var(--border-dark)';
  input.style.background = 'rgba(23, 32, 51, 0.8)';
  const rawValue = input.dataset.rawValue || '0';
  const value = parseFloat(rawValue) || 0;
  input.dataset.rawValue = value;
  input.value = formatCurrency(value);
  updateTotalPrevision();
}

// Gestion de la saisie dans l'input de prévision
function handlePrevisionInput(input) {
  const cursorPosition = input.selectionStart;
  const oldValue = input.value;

  let cleanValue = input.value.replace(/[^\d.,]/g, '');
  cleanValue = cleanValue.replace(',', '.');

  const parts = cleanValue.split('.');
  let integerPart = parts[0] || '';
  const decimalPart = parts.length > 1 ? '.' + parts[1].substring(0, 2) : '';

  integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');

  const formattedValue = integerPart + decimalPart;
  input.value = formattedValue;
  input.dataset.rawValue = cleanValue;

  const oldSpaces = (oldValue.substring(0, cursorPosition).match(/ /g) || []).length;
  const newSpaces = (formattedValue.substring(0, cursorPosition).match(/ /g) || []).length;
  const newCursorPosition = cursorPosition + (newSpaces - oldSpaces);

  input.setSelectionRange(newCursorPosition, newCursorPosition);

  updateTotalPrevision();
}

// Fonction pour mettre à jour le total en temps réel
function updateTotalPrevision() {
  const inputs = document.querySelectorAll('.prevision-input');
  let total = 0;

  inputs.forEach(input => {
    const rawValue = parseFloat(input.dataset.rawValue) || 0;
    total += rawValue;
  });

  document.getElementById('popup-team-total').textContent = total.toLocaleString('fr-CA', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }) + ' $';
}

// Fonction pour sauvegarder les prévisions
async function saveTeamObjectifs() {
  

  const directionUsername = window.username || localStorage.getItem('username');
  const inputs = document.querySelectorAll('.prevision-input');

  const previsions = {};
  inputs.forEach(input => {
    const coach = input.dataset.coach;
    const value = parseFloat(input.dataset.rawValue) || 0;
    previsions[coach] = value;
  });

  try {
    const response = await fetch('/api/direction/team-objectifs', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        direction_username: directionUsername,
        previsions: previsions
      })
    });

    const data = await response.json();

    if (data.success) {
      

      // Fermer la popup
      closeTeamObjectifPopup();

      

      // Mettre à jour immédiatement l'affichage de la carte
      await updateTeamObjectifDisplay();
      

      // Recharger le plan d'affaire avec animation
      await reloadPlanWithAnimation();

      // Afficher un message de succès
      showSuccessMessage('Prévisions enregistrées avec succès');
    } else {
      const errorMsg = data.error || data.detail || 'Erreur inconnue';
      console.error('[TEAM OBJECTIF] Erreur sauvegarde:', errorMsg);
      alert('Erreur lors de la sauvegarde des prévisions: ' + errorMsg);
    }
  } catch (error) {
    console.error('[TEAM OBJECTIF] Exception complète:', error);
    console.error('[TEAM OBJECTIF] Message:', error.message);
    console.error('[TEAM OBJECTIF] Stack:', error.stack);
    alert('Erreur lors de la sauvegarde des prévisions: ' + error.message);
  }
}

// Fonction pour fermer la popup
function closeTeamObjectifPopup() {
  document.getElementById('teamObjectifPopup').style.display = 'none';
}

// Fonction pour mettre à jour l'affichage de l'objectif dans la carte
async function updateTeamObjectifDisplay() {
  try {
    const username = window.username || localStorage.getItem('username');
    const response = await fetch(`/api/direction/team-objectifs?direction_username=${username}`);
    const data = await response.json();

    if (data.success) {
      const totalObjectif = data.total || 0;
      const valueSpan = document.getElementById('team-objectif-value');
      const placeholderDiv = document.getElementById('team-objectif-placeholder');

      

      if (!totalObjectif || totalObjectif === 0) {
        
        valueSpan.style.display = 'none';
        placeholderDiv.style.display = 'block';
      } else {
        
        valueSpan.style.display = 'block';
        placeholderDiv.style.display = 'none';
        valueSpan.textContent = totalObjectif.toLocaleString('fr-CA', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }) + ' $';
      }
    }
  } catch (error) {
    console.error('[UPDATE DISPLAY] Erreur:', error);
  }
}

// Animation de succès (style soumission)
function showSuccessAnimation(message) {
  const overlay = document.createElement('div');
  overlay.className = 'success-overlay';
  overlay.innerHTML = `
    <div class="success-content">
      <div class="success-checkmark">
        <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
          <path d="M8 20 L16 28 L32 12" stroke="white" stroke-width="3"
                stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">${message}</h2>
    </div>
  `;

  document.body.appendChild(overlay);

  setTimeout(async () => {
    // Retirer l'overlay
    overlay.remove();

    // Mettre à jour l'affichage
    await updateTeamObjectifDisplay();
    await updateTeamMetricsDisplay();
    await checkAndToggleBusinessPlanView();

    // Recharger le tableau
    if (typeof initTeamPlan === 'function') {
      initTeamPlan();
    }
  }, 2000);
}

// Fonction pour vérifier si un plan d'affaires existe et afficher/cacher les sections appropriées
async function checkAndToggleBusinessPlanView() {
  try {
    // Utiliser le coach sélectionné si on est en mode Direction, sinon utiliser le username de l'utilisateur connecté
    const username = selectedCoachForView || window.username || localStorage.getItem('username');

    // Choisir le bon endpoint selon si un coach est sélectionné ou non
    const isCoachSelected = selectedCoachForView !== null;
    const objectifsEndpoint = isCoachSelected
      ? `/api/coach/team-objectifs?coach_username=${username}`
      : `/api/direction/team-objectifs?direction_username=${username}`;
    const metricsEndpoint = isCoachSelected
      ? `/api/coach/team-metrics?coach_username=${username}`
      : `/api/direction/team-metrics?direction_username=${username}`;

    let objectifsData, metricsData;

    // OPTIMISATION: Utiliser le cache si disponible pour direction (pas pour coach sélectionné)
    if (!isCoachSelected) {
      const cachedObjectifs = sessionStorage.getItem('cached_direction_objectifs');
      const cachedMetrics = sessionStorage.getItem('cached_direction_metrics');

      if (cachedObjectifs && cachedMetrics) {
        objectifsData = JSON.parse(cachedObjectifs);
        metricsData = JSON.parse(cachedMetrics);
      }
    }

    // Si pas de cache, faire les appels API
    if (!objectifsData || !metricsData) {
      const objectifsResponse = await fetch(objectifsEndpoint);
      objectifsData = await objectifsResponse.json();

      const metricsResponse = await fetch(metricsEndpoint);
      metricsData = await metricsResponse.json();
    }

    const totalObjectif = objectifsData.success ? (objectifsData.total || 0) : 0;
    const metrics = metricsData.success ? metricsData.metrics : { cm: 0, ratioMktg: 0, tauxVente: 0 };

    // Vérifier si au moins une donnée existe
    const hasData = totalObjectif > 0 || metrics.cm > 0 || metrics.ratioMktg > 0 || metrics.tauxVente > 0;

    
    
    
    
    

    // Éléments à afficher/cacher
    const createBtn = document.getElementById('create-business-plan-btn');
    const metricsCards = document.getElementById('team-metrics-cards');
    const editBtn = document.getElementById('edit-business-plan-btn');
    const planTable = document.querySelector('#stats-plan-affaire .plan-scroll-container');

    if (hasData) {
      // Des données existent : afficher le tableau, les cartes et le bouton modifier
      
      
      
      
      

      if (createBtn) {
        createBtn.style.display = 'none';
        
      }
      if (metricsCards) {
        metricsCards.style.display = 'grid';
        
      }
      if (editBtn) {
        editBtn.style.display = 'block';
        
      }
      if (planTable) {
        planTable.style.display = 'block';
        
      }
    } else {
      // Aucune donnée : afficher uniquement le bouton créer
      
      
      
      
      

      if (createBtn) {
        createBtn.style.display = 'block';
        
      }
      if (metricsCards) {
        metricsCards.style.display = 'none';
        
      }
      if (editBtn) {
        editBtn.style.display = 'none';
        
      }
      if (planTable) {
        planTable.style.display = 'none';
        
      }
    }

    
  } catch (error) {
    console.error('[BUSINESS PLAN VIEW] Erreur:', error);
  }
}

// Fonction pour afficher un message de succès
function showSuccessMessage(message) {
  const toast = document.createElement('div');
  toast.style.position = 'fixed';
  toast.style.top = '2rem';
  toast.style.right = '2rem';
  toast.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
  toast.style.color = 'white';
  toast.style.padding = '1rem 1.5rem';
  toast.style.borderRadius = '12px';
  toast.style.boxShadow = '0 10px 40px rgba(16, 185, 129, 0.3)';
  toast.style.zIndex = '10001';
  toast.style.display = 'flex';
  toast.style.alignItems = 'center';
  toast.style.gap = '0.75rem';
  toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;

  document.body.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 3000);
}

// ========== TEAM METRICS POPUP (CM, Ratio Marketing, Taux de Vente) ==========

// Fonction pour recharger le plan d'affaire avec spinner
async function reloadPlanWithAnimation() {
  const planContainer = document.querySelector('.plan-scroll-container');
  if (!planContainer) return;

  // Créer l'overlay avec spinner
  const overlay = document.createElement('div');
  overlay.style.position = 'absolute';
  overlay.style.top = '0';
  overlay.style.left = '0';
  overlay.style.width = '100%';
  overlay.style.height = '100%';
  overlay.style.background = 'rgba(15, 23, 42, 0.95)';
  overlay.style.display = 'flex';
  overlay.style.flexDirection = 'column';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.zIndex = '1000';
  overlay.style.borderRadius = '14px';

  // Créer le spinner
  const spinner = document.createElement('div');
  spinner.style.width = '60px';
  spinner.style.height = '60px';
  spinner.style.border = '4px solid rgba(59, 130, 246, 0.2)';
  spinner.style.borderTop = '4px solid var(--primary-blue)';
  spinner.style.borderRadius = '50%';
  spinner.style.animation = 'spin 1s linear infinite';

  // Texte de chargement
  const loadingText = document.createElement('div');
  loadingText.textContent = 'Rechargement du plan...';
  loadingText.style.marginTop = '1.5rem';
  loadingText.style.color = 'var(--text-light)';
  loadingText.style.fontSize = '0.875rem';
  loadingText.style.fontWeight = '500';

  overlay.appendChild(spinner);
  overlay.appendChild(loadingText);

  // Ajouter l'animation du spinner si elle n'existe pas
  if (!document.getElementById('spinner-animation-style')) {
    const style = document.createElement('style');
    style.id = 'spinner-animation-style';
    style.textContent = `
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);
  }

  // Positionner le container en relatif pour l'overlay
  const originalPosition = planContainer.style.position;
  planContainer.style.position = 'relative';
  planContainer.appendChild(overlay);

  // Petit délai pour que le spinner soit visible
  await new Promise(resolve => setTimeout(resolve, 100));

  // Recharger les données
  if (typeof initTeamPlan === 'function') {
    await initTeamPlan();
  }

  // Petit délai avant de retirer le spinner
  await new Promise(resolve => setTimeout(resolve, 300));

  // Retirer l'overlay
  overlay.remove();
  planContainer.style.position = originalPosition;
}

// ===== POPUP CM MOYEN =====
async function openTeamCMPopup() {
  
  await updateTeamMetricsDisplay();

  const popup = document.getElementById('teamCMPopup');
  popup.style.display = 'flex';

  try {
    const response = await fetch(`/api/coaches`);
    const coaches = await response.json();

    if (coaches && Array.isArray(coaches)) {
      const username = window.username || localStorage.getItem('username');
      await populateCMTable(coaches, username);
    }
  } catch (error) {
    console.error('[CM POPUP] Erreur:', error);
  }
}

async function populateCMTable(coaches, directionUsername) {
  const tbody = document.getElementById('team-cm-tbody');
  tbody.innerHTML = '';

  // Charger la métrique Direction
  let directionCM = 0;
  try {
    const response = await fetch(`/api/direction/team-metrics?direction_username=${directionUsername}`);
    const data = await response.json();
    if (data.success && data.metrics) {
      directionCM = data.metrics.cm || 0;
    }
  } catch (error) {
    console.warn('[CM POPUP] Pas de métrique CM');
  }

  // Remplir l'input Direction
  const cmInput = document.getElementById('direction-cm-input');
  if (cmInput) {
    cmInput.value = directionCM > 0 ? formatCurrency(directionCM) : '';
    cmInput.dataset.rawValue = directionCM;
  }

  // Créer les lignes pour chaque coach
  for (const coach of coaches) {
    const row = document.createElement('tr');

    // Charger les métriques prévisionnelles du coach
    let coachCM = 0;
    try {
      const coachMetricsResponse = await fetch(`/api/coach/metrics?coach_username=${coach.username}`);
      const coachMetricsData = await coachMetricsResponse.json();
      if (coachMetricsData.success && coachMetricsData.metrics) {
        coachCM = coachMetricsData.metrics.cm || 0;
      }
    } catch (error) {
      console.warn(`[CM POPUP] Pas de prévision CM pour ${coach.username}`);
    }

    let avatarHtml = '';
    if (coach.photo) {
      avatarHtml = `<img src="${coach.photo}" alt="${coach.prenom}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-blue);" />`;
    } else {
      const initial = coach.prenom ? coach.prenom[0].toUpperCase() : '?';
      avatarHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-blue) 0%, #1e40af 100%); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.125rem; color: white; border: 2px solid var(--primary-blue);">${initial}</div>`;
    }

    const displayName = coach.prenom && coach.nom ? `${coach.prenom} ${coach.nom}` : coach.username;

    row.innerHTML = `
      <td style="padding: 1rem; border-bottom: 1px solid var(--border-dark);">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          ${avatarHtml}
          <div>
            <div style="font-weight: 600; color: var(--text-light);">${displayName}</div>
            <div style="font-size: 0.875rem; color: var(--text-gray);">Coach - ${coach.nb_entrepreneurs || 0} entrepreneur(s)</div>
          </div>
        </div>
      </td>
      <td style="padding: 1rem; border-bottom: 1px solid var(--border-dark); text-align: center;">
        <div style="color: var(--text-gray); font-size: 0.875rem; font-weight: 600;">
          ${coachCM > 0 ? formatCurrency(coachCM) : '-'}
        </div>
      </td>
    `;

    tbody.appendChild(row);
  }
}

function closeTeamCMPopup() {
  document.getElementById('teamCMPopup').style.display = 'none';
}

async function saveTeamCM() {
  const directionUsername = window.username || localStorage.getItem('username');
  const cmInput = document.getElementById('direction-cm-input');
  const cmValue = parseFloat(cmInput?.dataset.rawValue) || 0;

  try {
    // Charger les métriques existantes
    const getResponse = await fetch(`/api/direction/team-metrics?direction_username=${directionUsername}`);
    const getData = await getResponse.json();
    const existingMetrics = getData.success ? getData.metrics : { cm: 0, ratioMktg: 0, tauxVente: 0 };

    // Mettre à jour seulement le CM
    const metrics = {
      ...existingMetrics,
      cm: cmValue
    };

    const response = await fetch('/api/direction/team-metrics', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ direction_username: directionUsername, metrics: metrics })
    });

    const data = await response.json();
    if (data.success) {
      closeTeamCMPopup();
      await updateTeamMetricsDisplay();
      showSuccessMessage('CM Moyen enregistré avec succès');
      await reloadPlanWithAnimation();
    }
  } catch (error) {
    console.error('[CM POPUP] Erreur:', error);
    alert('Erreur lors de la sauvegarde');
  }
}

// ===== POPUP RATIO MARKETING =====
async function openTeamRatioPopup() {
  
  await updateTeamMetricsDisplay();

  const popup = document.getElementById('teamRatioPopup');
  popup.style.display = 'flex';

  try {
    const response = await fetch(`/api/coaches`);
    const coaches = await response.json();

    if (coaches && Array.isArray(coaches)) {
      const username = window.username || localStorage.getItem('username');
      await populateRatioTable(coaches, username);
    }
  } catch (error) {
    console.error('[RATIO POPUP] Erreur:', error);
  }
}

async function populateRatioTable(coaches, directionUsername) {
  const tbody = document.getElementById('team-ratio-tbody');
  tbody.innerHTML = '';

  // Charger la métrique Direction
  let directionRatio = 0;
  try {
    const response = await fetch(`/api/direction/team-metrics?direction_username=${directionUsername}`);
    const data = await response.json();
    if (data.success && data.metrics) {
      directionRatio = data.metrics.ratioMktg || 0;
    }
  } catch (error) {
    console.warn('[RATIO POPUP] Pas de métrique Ratio');
  }

  // Remplir l'input Direction
  const ratioInput = document.getElementById('direction-ratio-input');
  if (ratioInput) {
    ratioInput.value = directionRatio > 0 ? directionRatio.toFixed(1) + ' %' : '';
    ratioInput.dataset.rawValue = directionRatio;
  }

  // Créer les lignes pour chaque coach
  for (const coach of coaches) {
    const row = document.createElement('tr');

    // Charger les métriques prévisionnelles du coach
    let coachRatio = 0;
    try {
      const coachMetricsResponse = await fetch(`/api/coach/metrics?coach_username=${coach.username}`);
      const coachMetricsData = await coachMetricsResponse.json();
      if (coachMetricsData.success && coachMetricsData.metrics) {
        coachRatio = coachMetricsData.metrics.ratioMktg || 0;
      }
    } catch (error) {
      console.warn(`[RATIO POPUP] Pas de prévision Ratio pour ${coach.username}`);
    }

    let avatarHtml = '';
    if (coach.photo) {
      avatarHtml = `<img src="${coach.photo}" alt="${coach.prenom}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-blue);" />`;
    } else {
      const initial = coach.prenom ? coach.prenom[0].toUpperCase() : '?';
      avatarHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-blue) 0%, #1e40af 100%); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.125rem; color: white; border: 2px solid var(--primary-blue);">${initial}</div>`;
    }

    const displayName = coach.prenom && coach.nom ? `${coach.prenom} ${coach.nom}` : coach.username;

    row.innerHTML = `
      <td style="padding: 1rem; border-bottom: 1px solid var(--border-dark);">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          ${avatarHtml}
          <div>
            <div style="font-weight: 600; color: var(--text-light);">${displayName}</div>
            <div style="font-size: 0.875rem; color: var(--text-gray);">Coach - ${coach.nb_entrepreneurs || 0} entrepreneur(s)</div>
          </div>
        </div>
      </td>
      <td style="padding: 1rem; border-bottom: 1px solid var(--border-dark); text-align: center;">
        <div style="color: var(--text-gray); font-size: 0.875rem; font-weight: 600;">
          ${coachRatio > 0 ? coachRatio.toFixed(1) + ' %' : '-'}
        </div>
      </td>
    `;

    tbody.appendChild(row);
  }
}

function closeTeamRatioPopup() {
  document.getElementById('teamRatioPopup').style.display = 'none';
}

async function saveTeamRatio() {
  const directionUsername = window.username || localStorage.getItem('username');
  const ratioInput = document.getElementById('direction-ratio-input');
  const ratioValue = parseFloat(ratioInput?.dataset.rawValue) || 0;

  try {
    // Charger les métriques existantes
    const getResponse = await fetch(`/api/direction/team-metrics?direction_username=${directionUsername}`);
    const getData = await getResponse.json();
    const existingMetrics = getData.success ? getData.metrics : { cm: 0, ratioMktg: 0, tauxVente: 0 };

    // Mettre à jour seulement le Ratio Marketing
    const metrics = {
      ...existingMetrics,
      ratioMktg: ratioValue
    };

    const response = await fetch('/api/direction/team-metrics', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ direction_username: directionUsername, metrics: metrics })
    });

    const data = await response.json();
    if (data.success) {
      closeTeamRatioPopup();
      await updateTeamMetricsDisplay();
      showSuccessMessage('Ratio Marketing enregistré avec succès');
      await reloadPlanWithAnimation();
    }
  } catch (error) {
    console.error('[RATIO POPUP] Erreur:', error);
    alert('Erreur lors de la sauvegarde');
  }
}

// ===== POPUP TAUX DE VENTE =====
async function openTeamTauxPopup() {
  
  await updateTeamMetricsDisplay();

  const popup = document.getElementById('teamTauxPopup');
  popup.style.display = 'flex';

  try {
    const response = await fetch(`/api/coaches`);
    const coaches = await response.json();

    if (coaches && Array.isArray(coaches)) {
      const username = window.username || localStorage.getItem('username');
      await populateTauxTable(coaches, username);
    }
  } catch (error) {
    console.error('[TAUX POPUP] Erreur:', error);
  }
}

async function populateTauxTable(coaches, directionUsername) {
  const tbody = document.getElementById('team-taux-tbody');
  tbody.innerHTML = '';

  // Charger la métrique Direction
  let directionTaux = 0;
  try {
    const response = await fetch(`/api/direction/team-metrics?direction_username=${directionUsername}`);
    const data = await response.json();
    if (data.success && data.metrics) {
      directionTaux = data.metrics.tauxVente || 0;
    }
  } catch (error) {
    console.warn('[TAUX POPUP] Pas de métrique Taux');
  }

  // Remplir l'input Direction
  const tauxInput = document.getElementById('direction-taux-input');
  if (tauxInput) {
    tauxInput.value = directionTaux > 0 ? directionTaux.toFixed(1) + ' %' : '';
    tauxInput.dataset.rawValue = directionTaux;
  }

  // Créer les lignes pour chaque coach
  for (const coach of coaches) {
    const row = document.createElement('tr');

    // Charger les métriques prévisionnelles du coach
    let coachTaux = 0;
    try {
      const coachMetricsResponse = await fetch(`/api/coach/metrics?coach_username=${coach.username}`);
      const coachMetricsData = await coachMetricsResponse.json();
      if (coachMetricsData.success && coachMetricsData.metrics) {
        coachTaux = coachMetricsData.metrics.tauxVente || 0;
      }
    } catch (error) {
      console.warn(`[TAUX POPUP] Pas de prévision Taux pour ${coach.username}`);
    }

    let avatarHtml = '';
    if (coach.photo) {
      avatarHtml = `<img src="${coach.photo}" alt="${coach.prenom}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-blue);" />`;
    } else {
      const initial = coach.prenom ? coach.prenom[0].toUpperCase() : '?';
      avatarHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-blue) 0%, #1e40af 100%); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.125rem; color: white; border: 2px solid var(--primary-blue);">${initial}</div>`;
    }

    const displayName = coach.prenom && coach.nom ? `${coach.prenom} ${coach.nom}` : coach.username;

    row.innerHTML = `
      <td style="padding: 1rem; border-bottom: 1px solid var(--border-dark);">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          ${avatarHtml}
          <div>
            <div style="font-weight: 600; color: var(--text-light);">${displayName}</div>
            <div style="font-size: 0.875rem; color: var(--text-gray);">Coach - ${coach.nb_entrepreneurs || 0} entrepreneur(s)</div>
          </div>
        </div>
      </td>
      <td style="padding: 1rem; border-bottom: 1px solid var(--border-dark); text-align: center;">
        <div style="color: var(--text-gray); font-size: 0.875rem; font-weight: 600;">
          ${coachTaux > 0 ? coachTaux.toFixed(1) + ' %' : '-'}
        </div>
      </td>
    `;

    tbody.appendChild(row);
  }
}

function closeTeamTauxPopup() {
  document.getElementById('teamTauxPopup').style.display = 'none';
}

async function saveTeamTaux() {
  const directionUsername = window.username || localStorage.getItem('username');
  const tauxInput = document.getElementById('direction-taux-input');
  const tauxValue = parseFloat(tauxInput?.dataset.rawValue) || 0;

  try {
    // Charger les métriques existantes
    const getResponse = await fetch(`/api/direction/team-metrics?direction_username=${directionUsername}`);
    const getData = await getResponse.json();
    const existingMetrics = getData.success ? getData.metrics : { cm: 0, ratioMktg: 0, tauxVente: 0 };

    // Mettre à jour seulement le Taux de Vente
    const metrics = {
      ...existingMetrics,
      tauxVente: tauxValue
    };

    const response = await fetch('/api/direction/team-metrics', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ direction_username: directionUsername, metrics: metrics })
    });

    const data = await response.json();
    if (data.success) {
      closeTeamTauxPopup();
      await updateTeamMetricsDisplay();
      showSuccessMessage('Taux de Vente enregistré avec succès');
      await reloadPlanWithAnimation();
    }
  } catch (error) {
    console.error('[TAUX POPUP] Erreur:', error);
    alert('Erreur lors de la sauvegarde');
  }
}

// Handlers pour les inputs simples (utilisés dans les 3 popups)
function handleSingleMetricFocus(input) {
  const rawValue = parseFloat(input.dataset.rawValue) || 0;
  const metric = input.dataset.metric;

  if (metric === 'cm') {
    input.value = rawValue > 0 ? rawValue.toString() : '';
  } else {
    input.value = rawValue > 0 ? rawValue.toString() : '';
  }

  input.style.borderColor = 'var(--primary-blue)';
}

function handleSingleMetricBlur(input) {
  const rawValue = parseFloat(input.dataset.rawValue) || 0;
  const metric = input.dataset.metric;

  if (metric === 'cm') {
    input.value = rawValue > 0 ? formatCurrency(rawValue) : '';
    input.style.borderColor = rawValue > 0 ? 'rgba(16, 185, 129, 0.5)' : 'rgba(239, 68, 68, 0.5)';
  } else if (metric === 'ratioMktg') {
    input.value = rawValue > 0 ? rawValue.toFixed(1) + ' %' : '';
    input.style.borderColor = rawValue > 0 ? 'rgba(234, 179, 8, 0.5)' : 'rgba(239, 68, 68, 0.5)';
  } else if (metric === 'tauxVente') {
    input.value = rawValue > 0 ? rawValue.toFixed(1) + ' %' : '';
    input.style.borderColor = rawValue > 0 ? 'rgba(139, 92, 246, 0.5)' : 'rgba(239, 68, 68, 0.5)';
  }
}

function handleSingleMetricInput(input) {
  let value = input.value.replace(/[^0-9.,]/g, '').replace(',', '.');
  const numericValue = parseFloat(value) || 0;

  input.dataset.rawValue = numericValue;
  input.style.borderColor = 'var(--primary-blue)';
}

// Fonction pour mettre à jour l'affichage des métriques dans les cartes
async function updateTeamMetricsDisplay() {
  try {
    const username = window.username || localStorage.getItem('username');
    const response = await fetch(`/api/direction/team-metrics?direction_username=${username}`);
    const data = await response.json();

    if (data.success) {
      const metrics = data.metrics || { cm: 0, ratioMktg: 0, tauxVente: 0 };

      

      // Mise à jour CM Moyen
      const cmValue = document.getElementById('team-cm-value');
      const cmPlaceholder = document.getElementById('team-cm-placeholder');

      if (cmValue && cmPlaceholder) {
        if (!metrics.cm || metrics.cm === 0) {
          cmValue.style.display = 'none';
          cmPlaceholder.style.display = 'block';
        } else {
          cmValue.style.display = 'block';
          cmPlaceholder.style.display = 'none';
          cmValue.textContent = metrics.cm.toLocaleString('fr-CA', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }) + ' $';
        }
      }

      // Mise à jour Ratio Marketing
      const ratioValue = document.getElementById('team-ratio-value');
      const ratioPlaceholder = document.getElementById('team-ratio-placeholder');

      if (ratioValue && ratioPlaceholder) {
        if (!metrics.ratioMktg || metrics.ratioMktg === 0) {
          ratioValue.style.display = 'none';
          ratioPlaceholder.style.display = 'block';
        } else {
          ratioValue.style.display = 'block';
          ratioPlaceholder.style.display = 'none';
          ratioValue.textContent = metrics.ratioMktg.toFixed(1) + ' %';
        }
      }

      // Mise à jour Taux de Vente
      const tauxValue = document.getElementById('team-taux-value');
      const tauxPlaceholder = document.getElementById('team-taux-placeholder');

      if (tauxValue && tauxPlaceholder) {
        if (!metrics.tauxVente || metrics.tauxVente === 0) {
          tauxValue.style.display = 'none';
          tauxPlaceholder.style.display = 'block';
        } else {
          tauxValue.style.display = 'block';
          tauxPlaceholder.style.display = 'none';
          tauxValue.textContent = metrics.tauxVente.toFixed(1) + ' %';
        }
      }
    }
  } catch (error) {
    console.error('[UPDATE METRICS DISPLAY] Erreur:', error);
  }
}


</script>

<!-- Popup Objectif Vente Équipe -->
<div id="teamObjectifPopup" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); z-index: 10000; align-items: center; justify-content: center;">
  <div class="modal-content" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 24px; padding: 2rem; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto; border: 2px solid var(--border-dark); box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);">
    <!-- Header -->
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border-dark);">
      <div>
        <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-light); display: flex; align-items: center; gap: 0.75rem;">
          <i class="fas fa-chart-line" style="color: var(--primary-blue);"></i>
          Prévisions Objectif Vente Équipe
        </h2>
        <p style="font-size: 0.875rem; color: var(--text-gray); margin-top: 0.5rem;">
          Définissez les prévisions d'objectifs de vente pour chaque coach
        </p>
      </div>
      <button onclick="closeTeamObjectifPopup()" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; width: 40px; height: 40px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Total Objectif Équipe -->
    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.05) 100%); border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem;">
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <div>
          <div style="font-size: 0.875rem; color: var(--text-gray); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-users"></i>
            <span>Objectif Total de l'Équipe</span>
          </div>
          <div id="popup-team-total" style="font-size: 2rem; font-weight: 700; color: var(--primary-blue);">
            0,00 $
          </div>
        </div>
        <div style="background: rgba(59, 130, 246, 0.2); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-trophy" style="font-size: 2rem; color: var(--primary-blue);"></i>
        </div>
      </div>
    </div>

    <!-- Tableau des coaches -->
    <div style="background: rgba(30, 41, 59, 0.5); border-radius: 16px; border: 1px solid var(--border-dark); overflow: hidden;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: rgba(15, 23, 42, 0.8);">
            <th style="padding: 1rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-gray); text-transform: uppercase; border-bottom: 1px solid var(--border-dark);">
              <i class="fas fa-user-tie" style="margin-right: 0.5rem;"></i>Coach
            </th>
            <th style="padding: 1rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-gray); text-transform: uppercase; border-bottom: 1px solid var(--border-dark);">
              <i class="fas fa-chart-bar" style="margin-right: 0.5rem;"></i>Objectif Actuel (Équipe)
            </th>
            <th style="padding: 1rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-gray); text-transform: uppercase; border-bottom: 1px solid var(--border-dark);">
              <i class="fas fa-edit" style="margin-right: 0.5rem;"></i>Prévision Direction
            </th>
          </tr>
        </thead>
        <tbody id="team-objectif-tbody">
          <!-- Les lignes seront ajoutées dynamiquement -->
        </tbody>
      </table>
    </div>

    <!-- Footer Actions -->
    <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
      <button onclick="closeTeamObjectifPopup()" class="btn-secondary"><i class="fas fa-times"></i>Annuler</button>
      <button onclick="saveTeamObjectifs()" class="btn-primary"><i class="fas fa-save"></i>Enregistrer</button>
    </div>
  </div>
</div>

<!-- Popup CM Moyen Équipe -->
<div id="teamCMPopup" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); z-index: 10000; align-items: center; justify-content: center;">
  <div class="modal-content" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 24px; padding: 2rem; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto; border: 2px solid var(--border-dark); box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);">
    <!-- Header -->
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border-dark);">
      <div>
        <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-light); display: flex; align-items: center; gap: 0.75rem;">
          <i class="fas fa-dollar-sign" style="color: #10b981;"></i>
          Contrat Moyen Équipe
        </h2>
        <p style="font-size: 0.875rem; color: var(--text-gray); margin-top: 0.5rem;">
          Définissez le contrat moyen prévisionnel pour l'équipe
        </p>
      </div>
      <button onclick="closeTeamCMPopup()" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; width: 40px; height: 40px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- CM Direction -->
    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.05) 100%); border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <div>
          <div style="font-size: 0.875rem; color: var(--text-gray); margin-bottom: 0.5rem;">
            <i class="fas fa-chart-line"></i>
            <span>Prévision Direction</span>
          </div>
          <div style="font-size: 1.25rem; font-weight: 700; color: #10b981;">Contrat Moyen Prévisionnel</div>
        </div>
        <div style="background: rgba(16, 185, 129, 0.2); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-file-contract" style="font-size: 2rem; color: #10b981;"></i>
        </div>
      </div>

      <input type="text"
             id="direction-cm-input"
             placeholder="0 $"
             data-metric="cm"
             data-raw-value="0"
             class="metric-input"
             style="width: 100%; background: rgba(23, 32, 51, 0.8); border: 2px solid rgba(16, 185, 129, 0.5); border-radius: 12px; padding: 1rem; color: var(--text-light); font-weight: 600; font-size: 1.125rem; transition: all 0.3s ease;"
             onfocus="handleSingleMetricFocus(this)"
             onblur="handleSingleMetricBlur(this)"
             oninput="handleSingleMetricInput(this)" />
    </div>

    <!-- Tableau des coaches -->
    <div style="background: rgba(30, 41, 59, 0.5); border-radius: 16px; border: 1px solid var(--border-dark); overflow: hidden;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: rgba(15, 23, 42, 0.8);">
            <th style="padding: 1rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-gray); text-transform: uppercase; border-bottom: 1px solid var(--border-dark);">
              <i class="fas fa-user-tie" style="margin-right: 0.5rem;"></i>Coach
            </th>
            <th style="padding: 1rem; text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--text-gray); text-transform: uppercase; border-bottom: 1px solid var(--border-dark);">
              <i class="fas fa-dollar-sign" style="margin-right: 0.5rem;"></i>CM Prévision
            </th>
          </tr>
        </thead>
        <tbody id="team-cm-tbody">
          <!-- Les lignes seront ajoutées dynamiquement -->
        </tbody>
      </table>
    </div>

    <!-- Footer Actions -->
    <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
      <button onclick="closeTeamCMPopup()" class="btn-secondary"><i class="fas fa-times"></i>Annuler</button>
      <button onclick="saveTeamCM()" class="btn-primary"><i class="fas fa-save"></i>Enregistrer</button>
    </div>
  </div>
</div>

<!-- Popup Ratio Marketing Équipe -->
<div id="teamRatioPopup" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); z-index: 10000; align-items: center; justify-content: center;">
  <div class="modal-content" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 24px; padding: 2rem; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto; border: 2px solid var(--border-dark); box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);">
    <!-- Header -->
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border-dark);">
      <div>
        <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-light); display: flex; align-items: center; gap: 0.75rem;">
          <i class="fas fa-bullhorn" style="color: #eab308;"></i>
          Ratio Marketing Équipe
        </h2>
        <p style="font-size: 0.875rem; color: var(--text-gray); margin-top: 0.5rem;">
          Définissez le ratio marketing prévisionnel pour l'équipe
        </p>
      </div>
      <button onclick="closeTeamRatioPopup()" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; width: 40px; height: 40px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Ratio Direction -->
    <div style="background: linear-gradient(135deg, rgba(234, 179, 8, 0.2) 0%, rgba(234, 179, 8, 0.05) 100%); border: 2px solid rgba(234, 179, 8, 0.3); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <div>
          <div style="font-size: 0.875rem; color: var(--text-gray); margin-bottom: 0.5rem;">
            <i class="fas fa-chart-line"></i>
            <span>Prévision Direction</span>
          </div>
          <div style="font-size: 1.25rem; font-weight: 700; color: #eab308;">Ratio Marketing Prévisionnel</div>
        </div>
        <div style="background: rgba(234, 179, 8, 0.2); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-bullhorn" style="font-size: 2rem; color: #eab308;"></i>
        </div>
      </div>

      <input type="text"
             id="direction-ratio-input"
             placeholder="0 %"
             data-metric="ratioMktg"
             data-raw-value="0"
             class="metric-input"
             style="width: 100%; background: rgba(23, 32, 51, 0.8); border: 2px solid rgba(234, 179, 8, 0.5); border-radius: 12px; padding: 1rem; color: var(--text-light); font-weight: 600; font-size: 1.125rem; transition: all 0.3s ease;"
             onfocus="handleSingleMetricFocus(this)"
             onblur="handleSingleMetricBlur(this)"
             oninput="handleSingleMetricInput(this)" />
    </div>

    <!-- Tableau des coaches -->
    <div style="background: rgba(30, 41, 59, 0.5); border-radius: 16px; border: 1px solid var(--border-dark); overflow: hidden;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: rgba(15, 23, 42, 0.8);">
            <th style="padding: 1rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-gray); text-transform: uppercase; border-bottom: 1px solid var(--border-dark);">
              <i class="fas fa-user-tie" style="margin-right: 0.5rem;"></i>Coach
            </th>
            <th style="padding: 1rem; text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--text-gray); text-transform: uppercase; border-bottom: 1px solid var(--border-dark);">
              <i class="fas fa-bullhorn" style="margin-right: 0.5rem;"></i>Ratio Marketing Prévision (%)
            </th>
          </tr>
        </thead>
        <tbody id="team-ratio-tbody">
          <!-- Les lignes seront ajoutées dynamiquement -->
        </tbody>
      </table>
    </div>

    <!-- Footer Actions -->
    <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
      <button onclick="closeTeamRatioPopup()" class="btn-secondary"><i class="fas fa-times"></i>Annuler</button>
      <button onclick="saveTeamRatio()" class="btn-primary"><i class="fas fa-save"></i>Enregistrer</button>
    </div>
  </div>
</div>

<!-- Popup Taux de Vente Équipe -->
<div id="teamTauxPopup" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); z-index: 10000; align-items: center; justify-content: center;">
  <div class="modal-content" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 24px; padding: 2rem; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto; border: 2px solid var(--border-dark); box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);">
    <!-- Header -->
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border-dark);">
      <div>
        <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-light); display: flex; align-items: center; gap: 0.75rem;">
          <i class="fas fa-percentage" style="color: #8b5cf6;"></i>
          Taux de Vente Équipe
        </h2>
        <p style="font-size: 0.875rem; color: var(--text-gray); margin-top: 0.5rem;">
          Définissez le taux de vente prévisionnel pour l'équipe
        </p>
      </div>
      <button onclick="closeTeamTauxPopup()" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; width: 40px; height: 40px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Taux Direction -->
    <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(139, 92, 246, 0.05) 100%); border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <div>
          <div style="font-size: 0.875rem; color: var(--text-gray); margin-bottom: 0.5rem;">
            <i class="fas fa-chart-line"></i>
            <span>Prévision Direction</span>
          </div>
          <div style="font-size: 1.25rem; font-weight: 700; color: #8b5cf6;">Taux de Vente Prévisionnel</div>
        </div>
        <div style="background: rgba(139, 92, 246, 0.2); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-chart-pie" style="font-size: 2rem; color: #8b5cf6;"></i>
        </div>
      </div>

      <input type="text"
             id="direction-taux-input"
             placeholder="0 %"
             data-metric="tauxVente"
             data-raw-value="0"
             class="metric-input"
             style="width: 100%; background: rgba(23, 32, 51, 0.8); border: 2px solid rgba(139, 92, 246, 0.5); border-radius: 12px; padding: 1rem; color: var(--text-light); font-weight: 600; font-size: 1.125rem; transition: all 0.3s ease;"
             onfocus="handleSingleMetricFocus(this)"
             onblur="handleSingleMetricBlur(this)"
             oninput="handleSingleMetricInput(this)" />
    </div>

    <!-- Tableau des coaches -->
    <div style="background: rgba(30, 41, 59, 0.5); border-radius: 16px; border: 1px solid var(--border-dark); overflow: hidden;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: rgba(15, 23, 42, 0.8);">
            <th style="padding: 1rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-gray); text-transform: uppercase; border-bottom: 1px solid var(--border-dark);">
              <i class="fas fa-user-tie" style="margin-right: 0.5rem;"></i>Coach
            </th>
            <th style="padding: 1rem; text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--text-gray); text-transform: uppercase; border-bottom: 1px solid var(--border-dark);">
              <i class="fas fa-percentage" style="margin-right: 0.5rem;"></i>Taux de Vente Prévision (%)
            </th>
          </tr>
        </thead>
        <tbody id="team-taux-tbody">
          <!-- Les lignes seront ajoutées dynamiquement -->
        </tbody>
      </table>
    </div>

    <!-- Footer Actions -->
    <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
      <button onclick="closeTeamTauxPopup()" class="btn-secondary"><i class="fas fa-times"></i>Annuler</button>
      <button onclick="saveTeamTaux()" class="btn-primary"><i class="fas fa-save"></i>Enregistrer</button>
    </div>
  </div>
</div>

<!-- ==================== POPUP PLAN D'AFFAIRES ==================== -->
<div id="business-plan-popup">
  <div class="business-plan-modal">
    <!-- Header -->
    <div class="business-plan-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h2 style="font-size: 1.5rem; font-weight: 700; color: white; display: flex; align-items: center; gap: 0.75rem;">
            <div style="background: rgba(59, 130, 246, 0.2); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-chart-line" style="font-size: 1.3rem; color: var(--primary-blue);"></i>
            </div>
            <span id="business-plan-title">Créer mon plan d'affaires</span>
          </h2>
          <p style="font-size: 0.9rem; color: white; margin-top: 0.5rem; margin-left: 3.75rem;">
            Définissez les prévisions de votre équipe et les métriques moyennes
          </p>
        </div>
        <button onclick="closeBusinessPlanPopup()" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; width: 40px; height: 40px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Body -->
    <div class="business-plan-body">
      <!-- Section Prévisions Coaches -->
      <div class="business-plan-section">
        <h3>
          <i class="fas fa-user-shield"></i>
          Prévisions par Coach
        </h3>
        <div id="entrepreneurs-previsions-container">
          <!-- Les inputs seront générés dynamiquement ici -->
          <div style="text-align: center; padding: 2rem; color: var(--text-gray);">
            <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
            <div>Chargement des coaches...</div>
          </div>
        </div>
      </div>

      <!-- Section Métriques Moyennes -->
      <div class="business-plan-section">
        <h3>
          <i class="fas fa-calculator"></i>
          Métriques Moyennes de l'Équipe
        </h3>
        <div class="metrics-grid">
          <!-- CM Moyen -->
          <div class="metric-input-group">
            <label for="bp-cm-input">
              <i class="fas fa-dollar-sign" style="color: var(--primary-blue);"></i> CM Moyen
            </label>
            <input
              type="text"
              id="bp-cm-input"
              class="business-plan-input"
              placeholder="2 500,00 $"
              data-metric="cm"
              data-raw-value="0"
              onfocus="handleBPMetricFocus(this)"
              onblur="handleBPMetricBlur(this)"
              oninput="handleBPMetricInput(this)"
            />
          </div>

          <!-- Ratio Marketing -->
          <div class="metric-input-group">
            <label for="bp-ratio-input">
              <i class="fas fa-bullhorn" style="color: var(--primary-blue);"></i> Ratio Marketing
            </label>
            <input
              type="text"
              id="bp-ratio-input"
              class="business-plan-input"
              placeholder="85 %"
              data-metric="ratioMktg"
              data-raw-value="0"
              onfocus="handleBPMetricFocus(this)"
              onblur="handleBPMetricBlur(this)"
              oninput="handleBPMetricInput(this)"
            />
          </div>

          <!-- Taux de Vente -->
          <div class="metric-input-group">
            <label for="bp-taux-input">
              <i class="fas fa-handshake" style="color: var(--primary-blue);"></i> Taux de Vente
            </label>
            <input
              type="text"
              id="bp-taux-input"
              class="business-plan-input"
              placeholder="30 %"
              data-metric="tauxVente"
              data-raw-value="0"
              onfocus="handleBPMetricFocus(this)"
              onblur="handleBPMetricBlur(this)"
              oninput="handleBPMetricInput(this)"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="business-plan-footer">
      <button class="btn-secondary" onclick="closeBusinessPlanPopup()" style="display: flex; align-items: center; gap: 0.5rem;">
        <i class="fas fa-times"></i>
        <span>Annuler</span>
      </button>
      <button id="bp-save-btn" class="btn-primary" onclick="saveBusinessPlan()" style="display: flex; align-items: center; gap: 0.5rem;">
        <i class="fas fa-save"></i>
        <span>Enregistrer</span>
      </button>
    </div>
  </div>
</div>

</body>
</html>
