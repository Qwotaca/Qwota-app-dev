<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Qwota App</title>

  <!-- üì± PWA Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Qwota">
  <meta name="msapplication-TileColor" content="#1f2937">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Icones PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

  <!-- Scripts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="icon" href="/favicon" type="image/x-icon" />

  <!-- Script commun -->
  <script src="/common.js"></script>

  <!-- Feuille de style principale - Theme Dark Organise -->
  <link rel="stylesheet" href="/base.css">

  <style>
    /* ================================================================
       SCROLLBARS PERSONNALISEES - Style discret et moderne
       ================================================================ */

    /* Scrollbar pour tous les √©l√©ments */
    * {
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.15) transparent;
    }

    /* Webkit scrollbar (Chrome, Safari, Edge) */
    *::-webkit-scrollbar {
      width: 3px;
      height: 3px;
    }

    *::-webkit-scrollbar-track {
      background: transparent;
    }

    *::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.15);
      border-radius: 0;
      transition: background 0.2s ease;
    }

    *::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.25);
    }

    /* Scrollbar pour les iframes */
    iframe::-webkit-scrollbar {
      width: 3px;
      height: 3px;
    }

    iframe::-webkit-scrollbar-track {
      background: transparent;
    }

    iframe::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.15);
      border-radius: 0;
      transition: background 0.2s ease;
    }

    iframe::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.25);
    }

    /* ================================================================
       MOBILE OPTIMIZATIONS - Comportement Safari iOS
       ================================================================ */

    /* D√©sactiver le comportement Safari iOS qui cache les barres */
    html {
      overflow: hidden;
      height: 100%;
      position: fixed;
      width: 100%;
    }

    /* Permettre les swipes horizontaux mais emp√™cher le zoom */
    * {
      touch-action: pan-y pinch-zoom !important;
    }

    html, body {
      touch-action: pan-y pinch-zoom !important;
      -webkit-touch-callout: none !important;
      -webkit-user-select: none !important;
      -khtml-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      user-select: none !important;
      -webkit-text-size-adjust: 100% !important;
      -moz-text-size-adjust: 100% !important;
      -ms-text-size-adjust: 100% !important;
      text-size-adjust: 100% !important;
    }

    /* Permettre tous les types de touch sur le conteneur principal pour le swipe */
    #app-content {
      touch-action: auto !important;
    }

    /* Permettre la s√©lection de texte dans les inputs et textarea seulement */
    input, textarea, select {
      -webkit-user-select: text !important;
      -khtml-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      user-select: text !important;
      touch-action: manipulation !important;
    }

    /* Emp√™cher le zoom sur double-tap pour boutons et liens */
    a, button {
      touch-action: manipulation !important;
    }

    /* Forcer les headers √† rester fixes sur iOS */
    @supports (-webkit-touch-callout: none) {
      .mobile-header-top,
      .mobile-header-bottom {
        position: fixed !important;
        -webkit-transform: translate3d(0, 0, 0);
        transform: translate3d(0, 0, 0);
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }

      .mobile-header-top {
        top: 0 !important;
      }

      /* Emp√™cher Safari de cacher la barre du bas */
      .mobile-header-bottom,
      .md\\:hidden.fixed.bottom-0 {
        bottom: 0 !important;
        position: fixed !important;
      }
    }

    /* Emp√™cher le zoom avec les gestes */
    @media (max-width: 600px) {
      html {
        -webkit-text-size-adjust: none !important;
        -moz-text-size-adjust: none !important;
        -ms-text-size-adjust: none !important;
        text-size-adjust: none !important;
      }

      body {
        -webkit-text-size-adjust: none !important;
        -moz-text-size-adjust: none !important;
        -ms-text-size-adjust: none !important;
        text-size-adjust: none !important;
        overflow-x: hidden !important;
      }

      /* Bloquer les sections mobile-locked uniquement sur mobile */
      .nav-section.mobile-locked {
        opacity: 0.5;
        pointer-events: none;
        cursor: not-allowed;
      }
    }

    /* ================================================================
       LAYOUT PRINCIPAL - Architecture SPA
       ================================================================ */

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow: hidden;
      height: 100%;
      width: 100%;
      position: fixed;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: none;
      -webkit-overscroll-behavior: none;
    }

    /* Conteneur principal de l'app - cache par defaut pendant le chargement */
    #app-container {
      display: flex;
      min-height: 100vh;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    /* Quand le chargement est termine */
    #app-container.loaded {
      opacity: 1;
    }

    /* ================================================================
       SIDEBAR - Style Qwota Lite (Copie exacte)
       ================================================================ */

    /* SIDEBAR */
    .sidebar {
      width: 80px;
      background: rgba(20, 30, 50, 0.95);
      border-right: 1px solid rgba(96, 165, 250, 0.2);
      display: flex;
      flex-direction: column;
      transition: width 0.25s ease;
      overflow: hidden;
      z-index: 10000;
      position: fixed;
      top: 90px;
      left: 0;
      height: calc(100vh - 90px);
      box-shadow: 4px 0 24px rgba(0, 0, 0, 0.3);
    }

    .sidebar.expanded {
      width: 260px;
    }

    /* Toggle button */
    .sidebar-toggle {
      width: 100%;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.4);
      border: none;
      color: #94a3b8;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 1px solid rgba(51, 65, 85, 0.4);
      flex-shrink: 0;
      position: relative;
    }

    .sidebar-toggle:hover {
      background: rgba(96, 165, 250, 0.12);
      color: #60a5fa;
      box-shadow: 0 2px 8px rgba(96, 165, 250, 0.15);
    }

    .sidebar-toggle i {
      font-size: 18px;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .sidebar.expanded .sidebar-toggle i {
      transform: rotate(180deg);
    }

    .sidebar-toggle::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%) scaleX(0);
      width: 80%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #60a5fa, transparent);
      transition: transform 0.3s ease;
    }

    .sidebar-toggle:hover::before {
      transform: translateX(-50%) scaleX(1);
    }

    .sidebar-nav {
      flex: 1;
      padding: 6px 0 6px 0;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .sidebar.expanded .sidebar-nav {
      padding: 12px 0 6px 0;
      gap: 2px;
    }

    /* Scrollbar styling */
    .sidebar-nav::-webkit-scrollbar {
      width: 2px;
    }

    .sidebar-nav::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar-nav::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.3);
      border-radius: 1px;
    }

    .sidebar-nav::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.5);
    }

    .nav-section {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 6px;
    }

    .sidebar.expanded .nav-section {
      gap: 6px;
      margin-bottom: 0;
    }

    .nav-section-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #94a3b8;
      padding: 10px 12px 4px 12px;
      white-space: nowrap;
      display: none;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .sidebar.expanded .nav-section-title {
      display: block;
    }

    .nav-item {
      width: 48px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      color: #94a3b8;
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      position: relative;
      border-radius: 8px;
      border: none;
      margin: 0 auto;
      background: transparent;
    }

    .sidebar.expanded .nav-item {
      width: calc(100% - 20px);
      justify-content: flex-start;
      padding: 0 10px;
      margin: 0 10px;
      gap: 10px;
      position: relative;
    }

    /* Cadenas pour les items d√©sactiv√©s - UNIQUEMENT DANS LE SIDEBAR */
    .sidebar .nav-item .nav-lock-icon {
      margin-left: auto;
      font-size: 0.75rem;
      color: #64748b;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sidebar.expanded .nav-item .nav-lock-icon {
      opacity: 1;
    }

    /* Afficher les cadenas pour les items verrouill√©s */
    .sidebar .nav-item[style*="pointer-events: none"] .nav-lock-icon,
    .sidebar .nav-item.locked-for-entrepreneur .nav-lock-icon {
      opacity: 1 !important;
      display: inline-block !important;
    }

    /* Positionner les cadenas en bas √† droite des ic√¥nes quand le sidebar est ferm√© */
    .sidebar:not(.expanded) .nav-item .nav-lock-icon {
      position: absolute;
      bottom: 8px;
      right: 16px;
      margin-left: 0;
      font-size: 9px;
      opacity: 1;
      background: #1e293b;
      border-radius: 50%;
      padding: 2px;
    }

    .sidebar .nav-item:not([style*="pointer-events: none"]) .nav-lock-icon {
      display: none;
    }

    .nav-item:hover {
      background: rgba(96, 165, 250, 0.1);
      color: #e2e8f0;
    }

    .nav-item.active {
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.15) 0%, rgba(96, 165, 250, 0.08) 100%);
      color: #60a5fa;
      box-shadow: inset 3px 0 0 0 #60a5fa;
      border-radius: 12px;
    }

    .sidebar.expanded .nav-item.active {
      box-shadow: inset 3px 0 0 0 #60a5fa;
    }

    .nav-item.active .nav-icon {
      color: #60a5fa;
    }

    .nav-item.active .nav-label {
      color: #60a5fa;
      font-weight: 600;
    }

    .nav-icon {
      font-size: 17px;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
    }

    /* Cadenas pour items verrouill√©s */
    .lock-icon {
      position: absolute;
      bottom: -4px;
      right: -4px;
      font-size: 10px !important;
      color: #f59e0b;
      background: #1e293b;
      border-radius: 50%;
      padding: 2px;
      display: none;
    }

    .locked-for-entrepreneur .lock-icon {
      display: block;
    }

    /* Positionner les cadenas en bas √† droite des ic√¥nes quand le sidebar est ferm√© */
    .sidebar:not(.expanded) .lock-icon {
      bottom: 2px;
      right: 2px;
      font-size: 8px !important;
      padding: 1px;
    }

    .locked-for-entrepreneur {
      opacity: 0.5;
      cursor: not-allowed !important;
      pointer-events: none;
    }

    .locked-for-entrepreneur:hover {
      background: transparent !important;
    }

    /* Badge de notification pour les plaintes */
    .notification-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      margin-left: 8px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      font-size: 0.75rem;
      font-weight: 700;
      border-radius: 10px;
    }

    /* Ajuster la position pour le sidebar r√©duit */
    .sidebar:not(.expanded) .notification-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      margin-left: 0;
      min-width: 18px;
      height: 18px;
      font-size: 0.65rem;
      display: inline-flex !important;
    }

    /* Retirer le nav-label du flux quand sidebar ferm√© pour √©viter d√©calage */
    .sidebar:not(.expanded) .nav-label {
      position: absolute;
      width: 0;
      height: 0;
      overflow: hidden;
      opacity: 0;
    }

    /* Le badge reste cliquable m√™me si nav-label est hors du flux */
    .sidebar:not(.expanded) .nav-label .notification-badge {
      pointer-events: auto;
    }

    .nav-icon svg {
      width: 17px;
      height: 17px;
    }

    .nav-icon i {
      font-size: 17px;
    }

    /* Nav label (cach√© quand sidebar ferm√©) */
    .nav-label {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      width: 0;
      overflow: hidden;
      transition: opacity 0.25s ease, width 0.25s ease;
    }

    .sidebar.expanded .nav-label {
      opacity: 1;
      width: auto;
    }

    /* TOOLTIP (cach√© quand sidebar ouvert) */
    .tooltip {
      position: fixed;
      left: 80px;
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      color: #f1f5f9;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.5);
      z-index: 999999;
      visibility: hidden;
      border: 1px solid rgba(96, 165, 250, 0.2);
      transform: translateX(-4px);
    }

    .nav-item:hover .tooltip {
      opacity: 1;
      visibility: visible;
      transform: translateX(0);
    }

    /* Cacher tooltips quand sidebar ouvert */
    .sidebar.expanded .tooltip {
      display: none;
    }

    /* Sidebar footer */
    .sidebar-footer {
      width: 100%;
      border-top: 1px solid rgba(51, 65, 85, 0.3);
      padding: 12px 0;
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: rgba(15, 23, 42, 0.6);
    }

    .sidebar-footer-content {
      width: 100%;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
    }

    .sidebar.expanded .sidebar-footer-content {
      width: calc(100% - 20px);
      margin: 0 10px;
      padding-left: 8px;
      justify-content: flex-start;
      gap: 12px;
    }

    .sidebar-footer-logo {
      width: 32px;
      height: 32px;
      object-fit: contain;
      flex-shrink: 0;
      margin: 0 auto;
    }

    .sidebar.expanded .sidebar-footer-logo {
      margin: 0;
    }

    .sidebar-footer-text {
      font-size: 12px;
      font-weight: 600;
      color: #94a3b8;
      white-space: nowrap;
      opacity: 0;
      width: 0;
      overflow: hidden;
      transition: opacity 0.25s ease, width 0.25s ease;
    }

    .sidebar.expanded .sidebar-footer-text {
      opacity: 1;
      width: auto;
    }

    /* Sidebar overlay (mobile/tablette) */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 9998;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sidebar-overlay.show {
      display: block;
      opacity: 1;
    }

    /* Sur tablette: overlay sous le header */
    @media (min-width: 601px) and (max-width: 1366px) {
      .sidebar-overlay {
        top: 90px;
        height: calc(100% - 90px);
        background: rgba(15, 23, 42, 0.85);
      }
    }

    /* ================================================================
       HEADER FIXE
       ================================================================ */

    #app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 90px;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(24px) saturate(180%);
      -webkit-backdrop-filter: blur(24px) saturate(180%);
      border-bottom: 1px solid rgba(96, 165, 250, 0.15);
      z-index: 30;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    #app-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(96, 165, 250, 0.5) 50%, transparent);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 2.5rem;
    }

    .header-logo {
      height: 54px;
      width: auto;
      object-fit: contain;
      filter: drop-shadow(0 4px 8px rgba(96, 165, 250, 0.3));
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .header-logo:hover {
      transform: scale(1.03) translateY(-1px);
      filter: drop-shadow(0 6px 12px rgba(96, 165, 250, 0.5));
    }

    .header-account {
      position: relative;
      margin-right: 0.5rem;
    }

    .account-btn {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      padding: 0.5rem 1.5rem 0.5rem 1.5rem;
      background: rgba(30, 41, 59, 0.4);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1.5px solid rgba(96, 165, 250, 0.15);
      border-radius: 48px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:
        0 4px 16px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.08),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
      min-width: 270px;
      height: 58px;
      position: relative;
      overflow: hidden;
    }

    .account-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(96, 165, 250, 0.1), transparent);
      transition: left 0.6s ease;
    }

    .account-btn:hover::before {
      left: 100%;
    }

    .account-btn:hover {
      background: rgba(51, 65, 85, 0.6);
      border-color: rgba(96, 165, 250, 0.4);
      box-shadow:
        0 8px 32px rgba(96, 165, 250, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.12),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }

    .account-avatar {
      position: relative;
      width: 32px;
      height: 32px;
      min-width: 32px;
      min-height: 32px;
      border-radius: 50%;
      overflow: visible;
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 0 0 1.5px rgba(96, 165, 250, 0.2),
        0 2px 4px rgba(96, 165, 250, 0.2);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .account-btn:hover .account-avatar {
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 0 0 1.5px rgba(96, 165, 250, 0.35),
        0 2px 8px rgba(96, 165, 250, 0.35);
      transform: scale(1.08) rotate(5deg);
    }

    .account-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .account-avatar i {
      font-size: 16px;
      color: white;
    }

    .account-info-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
      min-width: 0;
    }

    .account-name-row {
      display: flex;
      align-items: center;
    }

    .account-info {
      color: #f1f5f9;
      font-size: 0.8125rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }

    .account-meta-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .account-role {
      font-size: 0.6875rem;
      color: #94a3b8;
      font-weight: 500;
      white-space: nowrap;
      line-height: 1;
    }

    .account-level {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.6875rem;
      line-height: 1;
    }

    .account-level i {
      font-size: 0.625rem;
      color: #fbbf24;
    }

    .account-level span {
      color: #60a5fa;
      font-weight: 600;
    }

    .account-xp-bar {
      height: 3px;
      background: rgba(51, 65, 85, 0.8);
      border-radius: 1.5px;
      overflow: hidden;
      width: 100%;
      margin-top: 0.125rem;
    }

    .account-xp-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
      transition: width 0.5s ease;
      border-radius: 1.5px;
    }

    .account-chevron {
      color: #94a3b8;
      font-size: 0.75rem;
      transition: transform 0.3s ease;
      margin-left: auto;
      flex-shrink: 0;
    }

    .account-btn:hover .account-chevron {
      transform: rotate(180deg);
    }

    .account-dropdown {
      position: absolute;
      top: calc(100% + 0.5rem);
      right: 0;
      min-width: 250px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
    }

    .account-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    /* Header simple du dropdown */
    .dropdown-header-simple {
      padding: 1rem;
      border-bottom: 1px solid #334155;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .dropdown-user-info {
      flex: 1;
    }

    .dropdown-username {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 0.25rem;
    }

    .dropdown-role {
      font-size: 0.875rem;
      color: #94a3b8;
      font-weight: 500;
    }

    .dropdown-grade-badge-img {
      width: 50px;
      height: 50px;
      object-fit: contain;
      flex-shrink: 0;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      color: #cbd5e1;
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
    }

    .dropdown-item:hover {
      background: rgba(96, 165, 250, 0.1);
      color: #60a5fa;
    }

    .dropdown-item.logout {
      color: #ef4444;
      border-top: 1px solid #334155;
    }

    .dropdown-item.logout:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* Cadenas pour dropdown items */
    .dropdown-lock-icon {
      margin-left: auto;
      font-size: 0.75rem;
      color: #94a3b8;
      display: none;
    }

    .dropdown-item.locked-guide .dropdown-lock-icon {
      display: block;
    }

    .dropdown-item.locked-guide {
      position: relative;
    }

    /* ================================================================
       POPUP RECONNEXION GOOGLE
       ================================================================ */
    .google-reconnect-popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(4px);
      z-index: 100000;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    .google-reconnect-popup.active {
      display: flex;
    }

    .google-reconnect-content {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(96, 165, 250, 0.3);
      border-radius: 16px;
      padding: 1.5rem 2rem;
      display: flex;
      align-items: center;
      gap: 1.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
      max-width: 500px;
      width: 100%;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    }

    .google-reconnect-content:hover {
      border-color: rgba(96, 165, 250, 0.6);
      transform: translateY(-2px);
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.5);
    }

    .google-reconnect-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #4285f4 0%, #34a853 50%, #fbbc05 75%, #ea4335 100%);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .google-reconnect-icon i {
      font-size: 28px;
      color: white;
    }

    .google-reconnect-text {
      flex: 1;
    }

    .google-reconnect-text h3 {
      margin: 0 0 0.25rem 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: #f1f5f9;
    }

    .google-reconnect-text p {
      margin: 0;
      font-size: 0.875rem;
      color: #94a3b8;
      line-height: 1.4;
    }

    .google-reconnect-arrow {
      color: #60a5fa;
      font-size: 1.25rem;
      transition: transform 0.3s ease;
    }

    .google-reconnect-content:hover .google-reconnect-arrow {
      transform: translateX(4px);
    }

    @media (max-width: 600px) {
      .google-reconnect-content {
        flex-direction: column;
        text-align: center;
        padding: 1.5rem;
      }

      .google-reconnect-arrow {
        display: none;
      }
    }

    /* ================================================================
       MODAL STATISTIQUES
       ================================================================ */
    .stats-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(8px);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 2rem 1rem;
    }

    .stats-modal.active {
      display: flex;
    }

    .stats-modal-content {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border-radius: 20px;
      width: 100%;
      max-width: 800px;
      max-height: 75vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(96, 165, 250, 0.2);
      display: flex;
      flex-direction: column;
    }

    .stats-modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(96, 165, 250, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(82, 113, 255, 0.05));
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .stats-modal-header h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .stats-modal-header i {
      color: var(--primary-blue);
    }

    .stats-modal-close {
      background: transparent;
      border: none;
      color: var(--text-gray);
      font-size: 1.5rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .stats-modal-close:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .stats-modal-body {
      padding: 0 1.5rem 1.5rem 1.5rem;
      overflow-y: auto;
      flex: 1;
    }

    /* Spinner de chargement dans le modal */
    .stats-modal-loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem 2rem;
      gap: 1.5rem;
    }

    .stats-loader-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(96, 165, 250, 0.2);
      border-top-color: #60a5fa;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .stats-loader-text {
      color: var(--text-gray);
      font-size: 1rem;
      font-weight: 500;
      margin: 0;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .stats-section {
      margin-bottom: 1.5rem;
      padding: 1rem;
      border-radius: 8px;
    }

    .stats-section-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .stats-section-title i {
      color: var(--primary-blue);
    }

    /* Structure unifi√©e - Une seule grande card */
    .stats-unified-card {
      padding: 2rem;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 16px;
      border: 1px solid rgba(96, 165, 250, 0.2);
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    /* Desktop et Mobile versions */
    .desktop-stats-profile {
      display: block;
    }

    .mobile-stats-profile {
      display: none;
    }

    .stats-profile-header {
      display: flex;
      align-items: center;
      gap: 3rem;
    }

    /* Section Photo + Nom */
    .stats-photo-nom-section {
      display: flex;
      align-items: center;
      gap: 3rem;
    }

    .stats-profile-nom-grade {
      flex: 1;
    }

    /* Section XP */
    .stats-xp-section {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .stats-xp-text-inline {
      font-size: 0.9375rem;
      color: var(--text-gray);
    }

    /* Conteneur sans background */
    .stats-profile-photo-banner {
      position: relative;
      flex-shrink: 0;
      margin-left: 1rem;
    }

    .stats-profile-photo-wrapper {
      position: relative;
      display: inline-block;
    }

    .stats-profile-photo-container {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      overflow: visible;
      flex-shrink: 0;
      z-index: 2;
      border: 4px solid #60a5fa;
      box-shadow: 0 0 20px rgba(96, 165, 250, 0.5), 0 0 40px rgba(82, 113, 255, 0.3);
    }

    /* Contours de grade pour statistiques */
    .stats-profile-photo-container.grade-demarrage {
      border: none !important;
      box-shadow: none !important;
    }

    .stats-profile-photo-container.grade-demarrage::after {
      content: '';
      position: absolute;
      top: 64%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/4RhBL7H8/NIVEAU-2.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .stats-profile-photo-container.grade-apprenti {
      border: none !important;
      box-shadow: none !important;
    }

    .stats-profile-photo-container.grade-apprenti::after {
      content: '';
      position: absolute;
      top: 64%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/21PNKPWb/NIVEAU-5.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .stats-profile-photo-container.grade-pilier {
      border: none !important;
      box-shadow: none !important;
    }

    .stats-profile-photo-container.grade-pilier::after {
      content: '';
      position: absolute;
      top: 64%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/Q3fmL0Zh/NIVEAU-6.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .stats-profile-photo-container.grade-expert {
      border: none !important;
      box-shadow: none !important;
    }

    .stats-profile-photo-container.grade-expert::after {
      content: '';
      position: absolute;
      top: 64%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/4g9g9PJT/9.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .stats-profile-photo-container.grade-maitre {
      border: none !important;
      box-shadow: none !important;
    }

    .stats-profile-photo-container.grade-maitre::after {
      content: '';
      position: absolute;
      top: 64%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/xtS2CMMw/11.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .stats-profile-photo-container.grade-heros {
      border: none !important;
      box-shadow: none !important;
    }

    .stats-profile-photo-container.grade-heros::after {
      content: '';
      position: absolute;
      top: 64%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/ymQq2mXZ/13.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .stats-profile-photo-container.grade-prestige {
      border: none !important;
      box-shadow: none !important;
    }

    .stats-profile-photo-container.grade-prestige::after {
      content: '';
      position: absolute;
      top: 64%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/NdRR6bm1/15.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .stats-profile-photo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 50%;
    }

    /* ================================================================
       CONTOURS DE GRADE - Personnalisables selon le design

       Instructions:
       - Tu peux remplacer les couleurs, box-shadow, et m√™me ajouter des animations
       - Pour utiliser des images de contour personnalis√©es, ajoute: background-image
       - Pour des effets anim√©s, ajoute: animation ou transition

       Exemple avec image:
       .grade-prestige {
         border: none !important;
         background-image: url('ton-image-contour.png') !important;
         background-size: contain !important;
       }
       ================================================================ */

    /* Grade: D√©marrage (Niveau 1) - Avec image de contour personnalis√©e */
    .grade-demarrage {
      border: none !important;
      box-shadow: none !important;
      overflow: visible !important;
    }

    .grade-demarrage::after {
      content: '';
      position: absolute;
      top: 64%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/4RhBL7H8/NIVEAU-2.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .grade-demarrage .stats-profile-photo {
      border-radius: 50%;
      overflow: hidden;
    }

    /* Grade: Apprenti (Niv. 2-10) - √Ä personnaliser */
    .grade-apprenti {
      border: 4px solid #34d399 !important;
      box-shadow: 0 0 20px rgba(52, 211, 153, 0.5), 0 0 40px rgba(16, 185, 129, 0.3) !important;
    }

    /* Grade: Pilier (Niv. 11-30) - √Ä personnaliser */
    .grade-pilier {
      border: 4px solid #a78bfa !important;
      box-shadow: 0 0 20px rgba(167, 139, 250, 0.5), 0 0 40px rgba(139, 92, 246, 0.3) !important;
    }

    /* Grade: Expert (Niv. 31-50) - √Ä personnaliser */
    .grade-expert {
      border: 4px solid #f59e0b !important;
      box-shadow: 0 0 20px rgba(245, 158, 11, 0.5), 0 0 40px rgba(251, 191, 36, 0.3) !important;
    }

    /* Grade: Ma√Ætre (Niv. 51-75) - √Ä personnaliser */
    .grade-maitre {
      border: 4px solid #ef4444 !important;
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5), 0 0 40px rgba(220, 38, 38, 0.3) !important;
    }

    /* Grade: H√©ros (Niv. 76-90) - √Ä personnaliser */
    .grade-heros {
      border: 4px solid #ec4899 !important;
      box-shadow: 0 0 20px rgba(236, 72, 153, 0.5), 0 0 40px rgba(219, 39, 119, 0.3) !important;
    }

    /* Grade: Prestige (Niv. 91-100) - √Ä personnaliser */
    .grade-prestige {
      border: 4px solid #fbbf24 !important;
      box-shadow:
        0 0 20px rgba(251, 191, 36, 0.6),
        0 0 40px rgba(245, 158, 11, 0.4),
        0 0 60px rgba(251, 191, 36, 0.2) !important;
    }

    /* ================================================================
       VARIANTES POUR PHOTOS PLUS PETITES (header 36px)
       ================================================================ */

    .account-avatar.grade-demarrage {
      border: none !important;
      box-shadow: none !important;
    }

    .account-avatar.grade-demarrage::after {
      content: '';
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/39fQQrk0/3.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .account-avatar.grade-apprenti {
      border: none !important;
      box-shadow: none !important;
    }

    .account-avatar.grade-apprenti::after {
      content: '';
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/CK0mG8N1/5.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .account-avatar.grade-pilier {
      border: none !important;
      box-shadow: none !important;
    }

    .account-avatar.grade-pilier::after {
      content: '';
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/Pvjk5KmF/7.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .account-avatar.grade-expert {
      border: none !important;
      box-shadow: none !important;
    }

    .account-avatar.grade-expert::after {
      content: '';
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/b5CXksjS/8.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .account-avatar.grade-maitre {
      border: none !important;
      box-shadow: none !important;
    }

    .account-avatar.grade-maitre::after {
      content: '';
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/CKMwQTCq/10.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .account-avatar.grade-heros {
      border: none !important;
      box-shadow: none !important;
    }

    .account-avatar.grade-heros::after {
      content: '';
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/27JYbJfR/12.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .account-avatar.grade-prestige {
      border: none !important;
      box-shadow: none !important;
    }

    .account-avatar.grade-prestige::after {
      content: '';
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/847kXqTN/14.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .account-avatar.grade-expert {
      border: 2px solid #f59e0b !important;
      box-shadow: 0 2px 6px rgba(245, 158, 11, 0.5) !important;
    }

    .account-avatar.grade-maitre {
      border: 2px solid #ef4444 !important;
      box-shadow: 0 2px 6px rgba(239, 68, 68, 0.5) !important;
    }

    .account-avatar.grade-heros {
      border: 2px solid #ec4899 !important;
      box-shadow: 0 2px 6px rgba(236, 72, 153, 0.5) !important;
    }

    .account-avatar.grade-prestige {
      border: 2px solid #fbbf24 !important;
      box-shadow: 0 2px 6px rgba(251, 191, 36, 0.6) !important;
    }

    /* ================================================================
       CONTOURS DE GRADE POUR MOBILE PROFILE ICON
       ================================================================ */

    /* Contours de grade pour mobile header - M√™mes images que dashboard PC */
    .mobile-profile-icon.grade-demarrage {
      border: none !important;
    }

    .mobile-profile-icon.grade-demarrage::after {
      content: '';
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/4RhBL7H8/NIVEAU-2.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .mobile-profile-icon.grade-apprenti {
      border: none !important;
    }

    .mobile-profile-icon.grade-apprenti::after {
      content: '';
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/21PNKPWb/NIVEAU-5.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .mobile-profile-icon.grade-pilier {
      border: none !important;
    }

    .mobile-profile-icon.grade-pilier::after {
      content: '';
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/Q3fmL0Zh/NIVEAU-6.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .mobile-profile-icon.grade-expert {
      border: none !important;
    }

    .mobile-profile-icon.grade-expert::after {
      content: '';
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/4g9g9PJT/9.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .mobile-profile-icon.grade-maitre {
      border: none !important;
    }

    .mobile-profile-icon.grade-maitre::after {
      content: '';
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/xtS2CMMw/11.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .mobile-profile-icon.grade-heros {
      border: none !important;
    }

    .mobile-profile-icon.grade-heros::after {
      content: '';
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/ymQq2mXZ/13.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    .mobile-profile-icon.grade-prestige {
      border: none !important;
    }

    .mobile-profile-icon.grade-prestige::after {
      content: '';
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 175%;
      height: 175%;
      background-image: url('https://i.ibb.co/NdRR6bm1/15.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 10;
    }

    /* Banni√®re classique avec extr√©mit√©s coup√©es */
    .stats-photo-level-banner {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      z-index: 3;
      white-space: nowrap;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .stats-profile-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    /* Ligne avec nom et XP */
    .stats-name-xp-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .stats-name-xp-row h3 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-light);
    }

    /* Nom du grade dans la section du haut */
    .stats-grade-name-display {
      font-size: 0.95rem;
      font-weight: 600;
      color: #60a5fa;
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
    }

    .stats-xp-text-inline {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-gray);
      white-space: nowrap;
    }

    /* Barre XP */
    .stats-xp-bar {
      height: 8px;
      background: rgba(51, 65, 85, 0.5);
      border-radius: 10px;
      overflow: hidden;
      width: 100%;
    }

    .stats-xp-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      border-radius: 10px;
      transition: width 0.6s ease;
      box-shadow: 0 0 10px rgba(96, 165, 250, 0.5);
    }

    /* Section grade actuel avec s√©parateur */
    .stats-current-grade-section {
      padding-top: 1.5rem;
      border-top: 1px solid rgba(96, 165, 250, 0.2);
    }

    /* Grade actuel */
    .stats-current-grade {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .stats-grade-image {
      width: 100px;
      height: 100px;
      object-fit: contain;
      flex-shrink: 0;
    }

    .stats-grade-details {
      flex: 1;
    }

    .stats-grade-name {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary-blue);
      margin-bottom: 0.5rem;
    }

    .stats-grade-level {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-gray);
    }

    .stats-grade-level i {
      color: #f59e0b;
    }

    /* Vers prochain grade section */
    .stats-next-grade-section {
      padding-top: 1.5rem;
      border-top: 1px solid rgba(96, 165, 250, 0.2);
    }

    .stats-subsection-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* XP Card */
    .stats-xp-card {
      padding: 1.5rem;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 16px;
      border: 1px solid rgba(96, 165, 250, 0.2);
    }

    .stats-xp-text {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 1rem;
      text-align: center;
    }

    .stats-xp-bar {
      height: 12px;
      background: rgba(51, 65, 85, 0.5);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 0.75rem;
    }

    .stats-xp-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      border-radius: 10px;
      transition: width 0.6s ease;
      box-shadow: 0 0 15px rgba(96, 165, 250, 0.6);
    }

    .stats-xp-percentage {
      text-align: center;
      font-size: 0.875rem;
      color: var(--text-gray);
      font-weight: 600;
    }

    /* Next Grade Card */
    .stats-next-grade-card {
      padding: 1.5rem;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 16px;
      border: 1px solid rgba(96, 165, 250, 0.2);
    }

    .stats-next-grade-content {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .stats-grade-badge-left,
    .stats-grade-badge-right {
      width: 70px;
      height: 70px;
      flex-shrink: 0;
    }

    .stats-grade-badge-left img,
    .stats-grade-badge-right img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .stats-next-grade-info {
      flex: 1;
    }

    .stats-next-grade-levels {
      display: flex;
      justify-content: space-between;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 0.5rem;
    }

    .stats-next-grade-bar {
      height: 10px;
      background: rgba(51, 65, 85, 0.5);
      border-radius: 10px;
      overflow: hidden;
    }

    .stats-next-grade-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-green), #10b981);
      border-radius: 10px;
      transition: width 0.6s ease;
      box-shadow: 0 0 10px rgba(52, 211, 153, 0.5);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }


    /* Category Title */
    .stats-category-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-light);
      margin: 1.5rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid rgba(96, 165, 250, 0.3);
    }

    /* Badges Header with Expand Button */
    .badges-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .badges-expand-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(96, 165, 250, 0.1);
      border: 1px solid rgba(96, 165, 250, 0.3);
      border-radius: 8px;
      color: var(--text-light);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .badges-expand-btn:hover {
      background: rgba(96, 165, 250, 0.2);
      border-color: rgba(96, 165, 250, 0.5);
    }

    .badges-expand-btn i {
      transition: transform 0.3s ease;
    }

    .badges-expand-btn.expanded i {
      transform: rotate(180deg);
    }

    /* Top 5 Badges Container */
    .badges-top-container {
      margin-bottom: 0.5rem;
      padding: 1rem;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.5);
    }

    .top-badges-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(96, 165, 250, 0.2);
    }

    /* Ic√¥nes plus petites dans la section Top 5 (case m√™me taille) */
    .badges-top-container .badge-image {
      width: 50px;
      height: 50px;
    }

    .badges-top-container .badge-emoji {
      font-size: 2.75rem !important;
      width: 50px;
      height: 50px;
    }

    .top-badges-title i {
      color: #fbbf24;
    }

    /* Badges Container - Multiple Rarity Sections */
    .badges-grid {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-bottom: 0;
      padding-bottom: 0;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transform: scaleY(0);
      transform-origin: top;
      transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                  opacity 0.4s ease-in-out,
                  transform 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                  margin-top 0.4s ease-in-out;
      margin-top: 0;
    }

    .badges-grid.show {
      max-height: 3000px;
      opacity: 1;
      transform: scaleY(1);
      margin-top: 1rem;
      padding-bottom: 2rem;
      overflow: visible;
    }

    /* Rarity Section */
    .rarity-section {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 1rem;
      border-radius: 8px;
      transition: background-color 0.3s ease;
      overflow: visible;
    }

    /* Alternance de couleurs: une section sur deux a un fond fonc√© */
    .rarity-section:nth-child(even) {
      background: rgba(15, 23, 42, 0.5);
    }

    .rarity-section-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .rarity-section-title .badge-rarity {
      font-size: 0.875rem;
      padding: 0.35rem 0.75rem;
    }

    .rarity-badge-count {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-gray);
      background: rgba(30, 41, 59, 0.5);
      padding: 0.15rem 0.5rem;
      border-radius: 12px;
    }

    /* Horizontal Scroll Container per Rarity */
    .badges-horizontal-scroll {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 0.5rem;
      padding-bottom: 1rem;
      margin-bottom: 0;
      scroll-behavior: smooth;
      height: auto;
      cursor: grab;
    }

    .badges-horizontal-scroll * {
      cursor: grab !important;
    }

    .badges-horizontal-scroll .badge-info-icon,
    .badges-horizontal-scroll .badge-info-icon * {
      cursor: pointer !important;
    }

    .badges-horizontal-scroll::-webkit-scrollbar {
      height: 6px;
    }

    .badges-horizontal-scroll::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.3);
      border-radius: 3px;
    }

    .badges-horizontal-scroll::-webkit-scrollbar-thumb {
      background: rgba(96, 165, 250, 0.5);
      border-radius: 3px;
    }

    .badges-horizontal-scroll::-webkit-scrollbar-thumb:hover {
      background: rgba(96, 165, 250, 0.7);
    }

    .badge-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: rgba(30, 41, 59, 0.4);
      border-radius: 10px;
      border: 2px solid rgba(96, 165, 250, 0.3);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      width: 100px;
      height: 100px;
      flex-shrink: 0;
      box-sizing: border-box;
    }

    .badge-item:hover {
      border-color: rgba(96, 165, 250, 0.6);
      box-shadow: 0 4px 15px rgba(96, 165, 250, 0.4);
      background: rgba(30, 41, 59, 0.5);
    }

    .badge-image {
      width: 65px;
      height: 65px;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      flex-shrink: 0;
    }

    .badge-emoji {
      font-size: 3.5rem !important;
      line-height: 1;
      width: 65px;
      height: 65px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    /* Badge Count (x2, x3, etc.) - M√äME POSITION QUE GAMIFICATION.HTML */
    .badge-count {
      position: absolute;
      top: 0.75rem;
      right: 1rem;
      background: transparent;
      color: #fbbf24;
      padding: 0;
      font-size: 1rem;
      font-weight: 900;
      z-index: 5;
      text-shadow:
        0 2px 8px rgba(251, 191, 36, 0.3),
        2px 2px 4px rgba(0, 0, 0, 0.8),
        -1px -1px 2px rgba(0, 0, 0, 0.6),
        0 4px 12px rgba(0, 0, 0, 0.5);
      letter-spacing: 1px;
      -webkit-text-stroke: 0.5px white;
      text-stroke: 0.5px white;
      paint-order: stroke fill;
      filter: drop-shadow(2px 4px 6px rgba(0, 0, 0, 0.7));
    }

    /* Badge Info Icon - EN HAUT √Ä GAUCHE */
    .badge-info-icon {
      position: absolute;
      top: 0.35rem;
      left: 0.35rem;
      width: 16px;
      height: 16px;
      background: rgba(96, 165, 250, 0.2);
      border: 1px solid rgba(96, 165, 250, 0.4);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.45rem;
      color: var(--primary-blue);
      cursor: help;
      transition: all 0.3s ease;
      opacity: 1 !important;
      z-index: 10;
    }

    .badge-info-icon:hover {
      background: rgba(96, 165, 250, 0.4);
      border-color: var(--primary-blue);
      transform: scale(1.15);
    }

    .badge-item:has(.badge-info-icon:hover) {
      z-index: 100000 !important;
    }

    /* Tooltip pour les descriptions */
    .badge-tooltip {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 0.5rem;
      background: var(--bg-card);
      border: 1px solid var(--border-dark);
      border-radius: 8px;
      padding: 0.75rem;
      width: 200px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
      opacity: 0 !important;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 999999 !important;
      pointer-events: none;
    }

    /* Le PREMIER badge de chaque ligne ‚Üí tooltip √† GAUCHE */
    .badges-horizontal-scroll > .badge-item:first-child .badge-tooltip {
      left: 0 !important;
      right: auto !important;
      transform: translateX(0) !important;
    }

    /* TOUS les autres tooltips sont centr√©s */

    .badge-info-icon:hover .badge-tooltip {
      opacity: 1 !important;
      visibility: visible;
    }

    .badge-tooltip * {
      opacity: 1 !important;
    }

    .tooltip-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 0.25rem;
    }

    .tooltip-description {
      font-size: 0.6rem;
      color: var(--text-gray);
      line-height: 1.4;
    }

    .tooltip-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border-dark);
    }

    .tooltip-footer .badge-xp {
      font-size: 0.625rem;
      font-weight: 600;
      color: var(--primary-blue);
    }

    .badge-rarity {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-top: 0.15rem;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      letter-spacing: 0.5px;
    }

    .badge-rarity.commun {
      background: rgba(129, 140, 248, 0.2);
      color: #818cf8;
    }

    .badge-rarity.rare {
      background: rgba(96, 165, 250, 0.2);
      color: #60a5fa;
    }

    .badge-rarity.legendaire {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    .badge-rarity.mythique {
      background: rgba(244, 114, 182, 0.2);
      color: #f472b6;
    }

    .badge-rarity.epique {
      background: rgba(167, 139, 250, 0.2);
      color: #a78bfa;
    }

    .badge-rarity.anti-badge {
      background: rgba(248, 113, 113, 0.2);
      color: #f87171;
    }

    .no-badges-message {
      text-align: center;
      padding: 2rem;
      color: var(--text-gray);
      font-size: 0.875rem;
    }

    /* Stats Tables Grid - 2 colonnes */
    .stats-tables-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    /* Stats Table */
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(30, 41, 59, 0.3);
      border-radius: 8px;
      overflow: hidden;
    }

    .stats-table tbody tr {
      border-bottom: 1px solid rgba(96, 165, 250, 0.1);
    }

    .stats-table tbody tr:last-child {
      border-bottom: none;
    }

    .stats-table tbody tr:hover {
      background: rgba(30, 41, 59, 0.5);
    }

    .stats-table td {
      padding: 1rem 1.5rem;
      background: rgba(15, 23, 42, 0.5);
    }

    .stats-table td.stat-label {
      font-size: 0.875rem;
      color: var(--text-gray);
      font-weight: 500;
      width: 60%;
    }

    .stats-table td.stat-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-light);
      text-align: right;
      width: 40%;
    }

    /* CTA Button */
    .stats-cta {
      margin-top: 1rem;
      text-align: center;
    }

    .stats-cta-button {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
    }

    .stats-cta-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(59, 130, 246, 0.5);
    }

    /* Responsive */
    @media (max-width: 600px) {
      .stats-modal-content {
        max-width: 95%;
      }

      .stats-modal-title-extra {
        display: none;
      }

      .stats-modal-body {
        padding: 0 !important;
      }

      /* Afficher mobile / Cacher desktop */
      .desktop-stats-profile {
        display: none !important;
      }

      .mobile-stats-profile {
        display: block !important;
      }

      /* Section Photo + Nom sur mobile */
      .stats-photo-nom-section {
        display: flex;
        flex-direction: row;
        gap: 2rem;
        align-items: center;
      }

      .stats-profile-photo-banner {
        flex-shrink: 0;
        margin-left: 0 !important;
      }

      /* R√©duire la taille de la photo de profil sur mobile */
      .stats-profile-photo-container {
        width: 60px !important;
        height: 60px !important;
        border-width: 2px !important;
      }

      /* Ajuster le niveau sous la photo */
      .stats-photo-level-banner {
        bottom: -15.2px !important;
        font-size: 0.7rem !important;
        padding: 0.15rem 0.4rem !important;
      }

      /* Ajuster les contours de grade pour la petite photo */
      .stats-profile-photo-container.grade-demarrage::after,
      .stats-profile-photo-container.grade-apprenti::after,
      .stats-profile-photo-container.grade-pilier::after,
      .stats-profile-photo-container.grade-expert::after,
      .stats-profile-photo-container.grade-maitre::after,
      .stats-profile-photo-container.grade-heros::after,
      .stats-profile-photo-container.grade-prestige::after {
        width: 160% !important;
        height: 160% !important;
      }

      /* Nom et grade √† droite de la photo */
      .stats-profile-nom-grade {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .stats-profile-nom-grade > div {
        display: flex !important;
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 0.25rem !important;
      }

      #stats-username {
        font-size: 1.1rem !important;
        margin: 0 !important;
      }

      .stats-grade-name-display {
        font-size: 0.8rem !important;
      }

      /* Section XP en pleine largeur */
      .stats-xp-section {
        width: 100%;
        margin-top: 1.75rem;
      }

      .stats-xp-text-inline {
        font-size: 0.75rem !important;
      }

      .stats-xp-bar {
        width: 100% !important;
      }

      /* Compacter les sections stats sur mobile */
      .stats-section {
        margin-bottom: 0.75rem !important;
        padding: 0.5rem !important;
      }

      .stats-unified-card {
        padding: 1rem !important;
        gap: 1rem !important;
      }

      .stats-grid,
      .stats-tables-grid {
        grid-template-columns: 1fr;
        gap: 0.5rem !important;
        margin-bottom: 0.75rem !important;
      }

      .stats-table td {
        padding: 0.5rem 0.75rem !important;
      }

      .stats-table td.stat-label {
        font-size: 0.75rem !important;
      }

      .stats-section-title {
        font-size: 0.95rem !important;
        margin-bottom: 0.5rem !important;
      }

      .stats-subsection-title {
        font-size: 0.85rem !important;
        margin-bottom: 0.5rem !important;
      }

      .stats-next-grade-section {
        padding-top: 1rem !important;
      }

      .stats-next-grade-content {
        gap: 1rem !important;
        align-items: center !important;
      }

      .stats-grade-badge-left,
      .stats-grade-badge-right {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      .stats-grade-badge-left img,
      .stats-grade-badge-right img {
        width: 40px !important;
        height: 40px !important;
      }

      .badges-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        max-height: 250px;
      }

      /* Retirer l'espace de la section badges quand elle est cach√©e */
      .badges-grid:not(.show) {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
        padding: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
      }

      /* Activer le scroll tactile sur mobile */
      .badges-horizontal-scroll {
        -webkit-overflow-scrolling: touch !important;
        touch-action: pan-x pan-y !important;
        cursor: default !important;
        overflow-x: auto !important;
        overflow-y: hidden !important;
        scroll-behavior: auto !important;
        user-select: none !important;
        -webkit-user-select: none !important;
      }

      .badges-horizontal-scroll * {
        cursor: default !important;
        pointer-events: auto !important;
      }

      /* Taille de police pour les valeurs de stats */
      .stats-table td.stat-value {
        font-size: 1rem !important;
      }

      .badge-item {
        padding: 0.5rem;
      }

      .badge-emoji {
        font-size: 1.75rem !important;
      }

      .stats-grade-card,
      .stats-next-grade-content {
        text-align: center;
      }

      /* Masquer les niveaux dans "Vers Prochain Grade" sur mobile */
      .stats-next-grade-levels {
        display: none !important;
      }

      /* Style du bouton de fermeture sur mobile */
      .stats-modal-close {
        background: #ff000036 !important;
        color: #6986ad !important;
        font-size: 1.5rem !important;
        width: 30px !important;
        height: 30px !important;
      }
    }

    /* ================================================================
       ZONE DE CONTENU DYNAMIQUE
       ================================================================ */

    #app-content {
      margin-left: 80px;
      margin-top: 90px;
      min-height: calc(100vh - 90px);
      width: calc(100% - 80px);
      padding: 0;
      transition: margin-left 0.25s ease, width 0.25s ease;
      background: #0f172a;
      overflow: hidden;
    }

    body.sidebar-expanded #app-content {
      margin-left: 260px;
      width: calc(100% - 260px);
    }

    /* DESKTOP & MOBILE: Iframes multiples pour navigation instantan√©e */
    .page-iframe {
      width: 100%;
      height: calc(100vh - 70px);
      border: none;
      display: none; /* Cach√©es par d√©faut, une seule visible √† la fois */
    }

    /* Sur desktop, l'iframe prend toute la hauteur disponible */
    @media (min-width: 769px) {
      .page-iframe {
        height: calc(100vh - 70px);
      }
    }

    /* Sur mobile, les iframes sont positionn√©es en absolu pour le swipe */
    @media (max-width: 600px) {
      .page-iframe {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: auto;
        transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        will-change: transform;
      }

      /* D√©sactiver la transition pendant le swipe actif */
      .page-iframe.swiping {
        transition: none;
      }
    }

    /* Zones de swipe sur les bords */
    .swipe-zone {
      display: none;
      position: fixed;
      top: 0;
      height: 100vh;
      width: 1.75rem; /* 28px */
      z-index: 999999;
      pointer-events: auto;
      background: transparent;
    }

    #swipe-zone-left {
      left: 0;
    }

    #swipe-zone-right {
      right: 0;
    }

    @media (max-width: 600px) {
      .swipe-zone {
        display: none !important;
      }
    }

    /* Overlay pour suivre le swipe une fois activ√© */
    #swipe-overlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 11;
      pointer-events: none;
    }

    #swipe-overlay.swiping-active {
      pointer-events: auto;
    }

    @media (max-width: 600px) {
      #swipe-overlay {
        display: block;
      }

      /* Reset du contenu sur mobile - pas de sidebar */
      #app-content {
        margin-left: 0 !important;
        width: 100% !important;
      }
    }

    /* Animation de transition entre pages */
    .page-transition-enter {
      animation: fadeSlideIn 0.3s ease-out;
    }

    @keyframes fadeSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ================================================================
       HEADER MOBILE TOP - Style app-shell
       ================================================================ */

    .mobile-header-top {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 40;
      background: #1e293b;
      height: 64px;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    /* Mobile header icons */
    .mobile-settings-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: #475569;
      cursor: pointer;
      flex-shrink: 0;
    }

    .mobile-settings-icon i {
      color: white;
      font-size: 16px;
    }

    .mobile-profile-icon {
      width: 36px !important;
      height: 36px !important;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      overflow: visible;
      cursor: pointer;
      flex-shrink: 0;
      position: relative;
    }

    .mobile-profile-icon img {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
      border-radius: 50%;
    }

    .mobile-profile-icon i {
      color: white;
      font-size: 32px !important;
      width: 32px !important;
      height: 32px !important;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mobile-logo-container {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .mobile-logo-container img {
      height: 40px;
      width: auto;
      object-fit: contain;
    }

    .mobile-profile-container {
      position: relative;
    }

    .mobile-profile-wrapper {
      position: relative;
      display: inline-block;
    }

    .mobile-level-banner {
      position: absolute;
      bottom: -13px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 0.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.2rem;
      white-space: nowrap;
      z-index: 20;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
    }

    .mobile-profile-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      min-width: 240px;
      z-index: 50;
      opacity: 0;
      transform: translateY(-10px) scale(0.95);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }

    .mobile-profile-dropdown.show {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }

    /* Header du dropdown mobile - m√™me style que PC */
    .mobile-dropdown-header {
      padding: 1rem;
      border-bottom: 1px solid #334155;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .mobile-dropdown-user-info {
      flex: 1;
    }

    .mobile-dropdown-username {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 0.25rem;
    }

    .mobile-dropdown-role {
      font-size: 0.875rem;
      color: #94a3b8;
      font-weight: 500;
    }

    .mobile-dropdown-grade-badge {
      width: 50px;
      height: 50px;
      object-fit: contain;
      flex-shrink: 0;
    }

    /* Items du dropdown mobile - m√™me style que PC */
    .mobile-dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      color: #cbd5e1;
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      font-size: 0.9375rem;
    }

    .mobile-dropdown-item:hover {
      background: rgba(96, 165, 250, 0.1);
      color: #60a5fa;
    }

    .mobile-dropdown-item.mobile-logout {
      color: #ef4444;
      border-top: 1px solid #334155;
    }

    .mobile-dropdown-item.mobile-logout:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* Cadenas pour items mobiles */
    .mobile-dropdown-lock-icon {
      margin-left: auto;
      font-size: 0.75rem;
      color: #94a3b8;
      display: none;
    }

    .mobile-dropdown-item.locked-guide .mobile-dropdown-lock-icon {
      display: block;
    }

    .mobile-dropdown-item.locked-guide {
      position: relative;
    }

    /* ================================================================
       BOTTOM NAVIGATION MOBILE - Style app-shell
       ================================================================ */

    .mobile-header-bottom {
      display: none;
    }

    .case-container {
      position: relative;
      transition: all 0.7s ease-in-out;
    }

    .icon-container {
      transition: all 0.7s ease-in-out;
      transform-origin: center;
    }

    .icon-container.selected {
      transform: scale(1.2) translateY(-8px);
    }

    .icon-title {
      opacity: 0;
      transform: translateY(8px);
      transition: all 0.7s ease-in-out;
    }

    .icon-title.show {
      opacity: 1;
      transform: translateY(0);
    }

    .icon-container i {
      transition: none;
    }

    /* Case s√©lectionn√©e plus large */
    .flex-2 {
      flex: 1.5;
    }

    /* Alignement sp√©cial quand aucune ic√¥ne n'est s√©lectionn√©e */
    .case-container.no-selection {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    .hidden {
      display: none;
    }

    /* ================================================================
       RESPONSIVE - TABLET (769px - 1366px)
       iPad Mini: 768x1024, iPad Air: 820x1180, iPad Pro: 1024x1366
       ================================================================ */

    @media (min-width: 769px) and (max-width: 1366px) {
      /* Sur tablette, sidebar ferm√© par d√©faut (g√©r√© par JS) */
      /* Quand sidebar ouvert, flouter l'iframe et bloquer interactions */
      .sidebar.expanded ~ #app-content .page-iframe {
        filter: blur(8px) !important;
        pointer-events: none !important;
        user-select: none !important;
        -webkit-user-select: none !important;
        touch-action: none !important;
      }

      /* Overlay pour bloquer toutes les interactions */
      .sidebar.expanded ~ #app-content::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.3);
        z-index: 100;
        pointer-events: auto;
        cursor: not-allowed;
      }

      /* Cacher les tooltips sur tablette */
      .sidebar .tooltip {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
      }
    }

    /* ================================================================
       RESPONSIVE - MOBILE
       ================================================================ */

    @media (max-width: 600px) {
      /* Cacher le sidebar sur mobile */
      .sidebar {
        display: none;
      }

      /* Cacher le header PC */
      #app-header {
        display: none;
      }

      /* Afficher les headers mobile */
      .mobile-header-top {
        display: flex;
      }

      .mobile-header-bottom {
        display: block;
      }

      /* Ajuster le contenu pour les headers mobile */
      #app-content {
        margin-left: 0;
        margin-top: 64px;
        margin-bottom: 96px;
        width: 100%;
        padding: 0;
        min-height: calc(100vh - 160px);
        height: calc(100vh - 160px);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
      }

      /* Sur mobile, ajuster la hauteur des iframes */
      .page-iframe {
        height: calc(100vh - 160px);
        width: 100%;
      }

      /* Cacher les scrollbars sur mobile */
      .page-iframe::-webkit-scrollbar {
        display: none;
      }

      .page-iframe {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      #app-content {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      #app-content::-webkit-scrollbar {
        display: none;
      }

      /* R√®gle additionnelle avec sp√©cificit√© plus √©lev√©e pour mobile logout btn */
      button.mobile-logout-btn {
        padding: 12px 16px !important;
        font-size: 14px !important;
      }
    }

    /* ================================================================
       LOADING STATE
       ================================================================ */

    .loading-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 3rem;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #334155;
      border-top-color: #60a5fa;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ================================================================
       FULLSCREEN LOADING OVERLAY - Mobile uniquement
       ================================================================ */

    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    #loading-overlay.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .loading-content {
      text-align: center;
      padding: 2rem;
    }

    .loading-logo {
      width: 120px;
      height: 120px;
      margin: 0 auto 2rem;
    }

    .loading-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .loading-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #f1f5f9;
      margin-bottom: 0.5rem;
    }

    .loading-subtitle {
      font-size: 1rem;
      color: #94a3b8;
      margin-bottom: 2rem;
    }

    .loading-progress-container {
      width: 280px;
      margin: 0 auto;
    }

    .loading-progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(51, 65, 85, 0.5);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 0.75rem;
    }

    .loading-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #60a5fa 0%, #3b82f6 100%);
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s ease;
      box-shadow: 0 0 10px rgba(96, 165, 250, 0.5);
    }

    .loading-progress-text {
      font-size: 0.875rem;
      color: #60a5fa;
      font-weight: 600;
    }

    /* Afficher sur desktop aussi */
    @media (min-width: 769px) {
      #loading-overlay {
        display: flex;
      }
    }
  </style>
</head>
<body class="sidebar-expanded">

  <!-- √âcran de chargement fullscreen (mobile uniquement) -->
  <div id="loading-overlay">
    <div class="loading-content">
      <!-- Logo anim√© qui tourne -->
      <div class="loading-logo">
        <img src="https://i.ibb.co/1fzHGQWw/TES-MUTE-TH-O-6.png" alt="Qwota">
      </div>

      <!-- Texte -->
      <h2 class="loading-title">Chargement de Qwota</h2>
      <p id="loading-current-page" class="loading-subtitle">Preparation de votre espace de travail...</p>

      <!-- Barre de progression -->
      <div class="loading-progress-container">
        <div class="loading-progress-bar">
          <div id="loading-progress-fill" class="loading-progress-fill"></div>
        </div>
        <div id="loading-progress-text" class="loading-progress-text">0%</div>
      </div>

    </div>
  </div>

  <!-- ================================================================
       NOUVEAU: Spinner de navigation entre pages (petit et fluide)
       ================================================================ -->
  <div id="page-loading-spinner" style="display: none; position: fixed; top: 90px; left: 260px; right: 0; bottom: 0; background: #0f172a; z-index: 40; align-items: center; justify-content: center;">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
      <!-- Spinner SVG anim√© -->
      <svg width="64" height="64" viewBox="0 0 64 64" style="animation: spin 0.8s linear infinite;">
        <circle cx="32" cy="32" r="28" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="6"/>
        <circle cx="32" cy="32" r="28" fill="none" stroke="#3b82f6" stroke-width="6" stroke-dasharray="140" stroke-dashoffset="40" stroke-linecap="round" style="transform-origin: center; transform: rotate(-90deg);"/>
      </svg>
      <div style="margin-top: 16px; font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500; text-align: center;">Chargement...</div>
    </div>
  </div>

  <!-- Container principal de l'app - style inline pour garantir invisibilite immediate -->
  <div id="app-container" style="opacity: 0;">

    <!-- Sidebar - Style Qwota Lite -->
    <aside class="sidebar expanded">
      <!-- Toggle button -->
      <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-chevron-right"></i>
      </button>

      <nav class="sidebar-nav">
        <!-- Section Param√®tre -->
        <div class="nav-section mobile-locked">
          <div class="nav-section-title">Param√®tre</div>
          <a href="#/connection" class="nav-item" data-page="connection">
            <span class="nav-icon">
              <i class="fas fa-cog"></i>
            </span>
            <span class="nav-label">Parametres</span>
            <span class="tooltip">Parametres</span>
            <i class="fas fa-lock nav-lock-icon"></i>
          </a>
        </div>

        <!-- Section G√©n√©ral -->
        <div class="nav-section">
          <div class="nav-section-title">G√©n√©ral</div>
          <a href="#/dashboard" class="nav-item active" data-page="dashboard" style="position: relative;">
            <span class="nav-icon">
              <i class="fas fa-chart-bar"></i>
            </span>
            <span class="nav-label" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
              <span>Dashboard</span>
              <span id="plaintes-notification-badge" class="notification-badge" style="display: none; margin-left: auto;">0</span>
            </span>
            <span class="tooltip">Dashboard</span>
          </a>
          <a href="#/rpo" class="nav-item" data-page="rpo" id="nav-rpo" style="position: relative; opacity: 0.5; pointer-events: none; cursor: not-allowed;">
            <span class="nav-icon">
              <i class="fas fa-calendar-alt"></i>
            </span>
            <span class="nav-label">RPO</span>
            <span class="tooltip">RPO</span>
            <span id="rpo-notification-badge" class="hidden" style="position: absolute; top: 8px; right: 8px; background: #ef4444; color: white; border-radius: 50%; min-width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; padding: 0 5px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); z-index: 100;">0</span>
          </a>
          <a href="#/centralevue" class="nav-item" data-page="centralevue" style="opacity: 0.5; pointer-events: none; cursor: not-allowed;">
            <span class="nav-icon">
              <i class="fas fa-building"></i>
            </span>
            <span class="nav-label">La Centrale</span>
            <span class="tooltip">La Centrale</span>
          </a>
          <a href="#/gamification" class="nav-item" data-page="gamification" style="opacity: 0.5; pointer-events: none; cursor: not-allowed;">
            <span class="nav-icon">
              <i class="fas fa-trophy"></i>
            </span>
            <span class="nav-label">Niveaux & Troph√©es</span>
            <span class="tooltip">Niveaux & Troph√©es</span>
          </a>
        </div>

        <!-- Section Outils -->
        <div class="nav-section">
          <div class="nav-section-title">Outils</div>
          <a href="#/calculateur" class="nav-item" data-page="calculateur">
            <span class="nav-icon">
              <i class="fas fa-calculator"></i>
            </span>
            <span class="nav-label">Calculateur</span>
            <span class="tooltip">Calculateur</span>
          </a>
          <a href="#/soumissions" class="nav-item" data-page="soumissions">
            <span class="nav-icon">
              <i class="fas fa-file-text"></i>
            </span>
            <span class="nav-label">Soumission</span>
            <span class="tooltip">Soumission</span>
          </a>
          <a href="#/gqp" class="nav-item" data-page="gqp">
            <span class="nav-icon">
              <i class="fas fa-clipboard-list"></i>
            </span>
            <span class="nav-label">GQP de travaux</span>
            <span class="tooltip">GQP de travaux</span>
          </a>
          <a href="#/facture" class="nav-item" data-page="facture">
            <span class="nav-icon">
              <i class="fas fa-file-invoice"></i>
            </span>
            <span class="nav-label">Facturation client</span>
            <span class="tooltip">Facturation client</span>
          </a>
        </div>

        <!-- Section Gestion -->
        <div class="nav-section mobile-locked">
          <div class="nav-section-title">Gestion</div>
          <a href="#/travaux" class="nav-item" data-page="travaux">
            <span class="nav-icon">
              <i class="fas fa-chart-line"></i>
            </span>
            <span class="nav-label">Ventes</span>
            <span class="tooltip">Ventes</span>
          </a>
          <a href="#/gestionemployes" class="nav-item" data-page="gestionemployes">
            <span class="nav-icon">
              <i class="fas fa-users"></i>
            </span>
            <span class="nav-label">Employ√©s</span>
            <span class="tooltip">Employ√©s</span>
          </a>
          <a href="#/facturationqe" class="nav-item" data-page="facturationqe" id="nav-facturationqe" style="position: relative;">
            <span class="nav-icon">
              <i class="fas fa-file-invoice-dollar"></i>
            </span>
            <span class="nav-label" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
              <span>Facturation QE</span>
              <span id="facturationqe-urgent-badge" class="notification-badge" style="display: none; margin-left: auto;">0</span>
            </span>
            <span class="tooltip">Facturation QE</span>
            <span class="nav-badge-modifications" id="badge-modifications-comptable" style="display: none;"></span>
          </a>
          <a href="#/avis" class="nav-item" data-page="avis">
            <span class="nav-icon">
              <i class="fas fa-star"></i>
            </span>
            <span class="nav-label">Mes avis clients</span>
            <span class="tooltip">Mes avis clients</span>
          </a>
        </div>
      </nav>

      <!-- Sidebar Footer -->
      <div class="sidebar-footer">
        <div class="sidebar-footer-content">
          <img src="https://i.ibb.co/CKYppwJD/Design-sans-titre-95.png" alt="QE" class="sidebar-footer-logo">
          <span class="sidebar-footer-text">Qualit√© √âtudiants</span>
        </div>
      </div>
    </aside>

    <!-- Overlay pour sidebar mobile/tablette -->
    <div class="sidebar-overlay" onclick="closeSidebarOverlay()"></div>

    <!-- Header desktop fixe -->
    <header id="app-header">
      <div class="header-left">
        <img src="https://i.ibb.co/XfvCg4tN/Sans-titre-500-x-170-px-13.png" alt="Logo" class="header-logo">
      </div>

      <div class="header-account">
        <button class="account-btn" onclick="toggleAccountDropdown()">
          <div class="account-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="account-info-wrapper">
            <div class="account-name-row">
              <div class="account-info" id="account-username">Chargement...</div>
            </div>
            <div class="account-meta-row">
              <div class="account-role" id="account-role">Entrepreneur</div>
              <div class="account-level">
                <i class="fas fa-star"></i>
                <span id="account-level-text">Niv. 1</span>
              </div>
            </div>
            <div class="account-xp-bar">
              <div class="account-xp-fill" id="account-xp-fill" style="width: 0%"></div>
            </div>
          </div>
          <i class="fas fa-chevron-down account-chevron"></i>
        </button>

        <div class="account-dropdown" id="account-dropdown">
          <!-- Header simple avec nom et grade -->
          <div class="dropdown-header-simple">
            <div class="dropdown-user-info">
              <div class="dropdown-username" id="dropdown-username">Chargement...</div>
              <div class="dropdown-role" id="dropdown-role">Chargement...</div>
            </div>
            <img id="dropdown-grade-badge" src="" alt="Grade" class="dropdown-grade-badge-img">
          </div>

          <!-- Boutons -->
          <button class="dropdown-item stats-item" onclick="openStatsModal()">
            <i class="fas fa-chart-line"></i>
            <span>Statistiques</span>
            <i class="fas fa-lock dropdown-lock-icon"></i>
          </button>
          <button class="dropdown-item params-item" onclick="navigateTo('connection')">
            <i class="fas fa-cog"></i>
            <span>Parametres</span>
            <i class="fas fa-lock dropdown-lock-icon"></i>
          </button>
          <button class="dropdown-item logout" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Se deconnecter</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Header Mobile Top - Style app-shell -->
    <div class="mobile-header-top md:hidden">
      <div class="mobile-settings-icon" onclick="router.loadPage('connection')">
        <i class="fas fa-cog text-white"></i>
      </div>
      <div class="mobile-logo-container">
        <img src="https://i.ibb.co/XfvCg4tN/Sans-titre-500-x-170-px-13.png" alt="Logo" class="h-8">
      </div>
      <div class="mobile-profile-container">
        <div class="mobile-profile-wrapper">
          <div class="mobile-profile-icon" onclick="toggleMobileProfileMenu()">
            <i class="fas fa-user text-white"></i>
          </div>
          <div class="mobile-level-banner">
            <span>Niv. <span id="mobile-level-text">1</span></span>
          </div>
        </div>
        <div id="mobile-profile-dropdown" class="mobile-profile-dropdown hidden">
          <!-- Header avec nom, r√¥le et badge de grade -->
          <div class="mobile-dropdown-header">
            <div class="mobile-dropdown-user-info">
              <div class="mobile-dropdown-username" id="mobile-dropdown-username">Chargement...</div>
              <div class="mobile-dropdown-role" id="mobile-dropdown-role">Chargement...</div>
            </div>
            <img id="mobile-dropdown-grade-badge" src="" alt="Grade" class="mobile-dropdown-grade-badge">
          </div>

          <!-- Boutons -->
          <button class="mobile-dropdown-item mobile-stats-item" onclick="openStatsModal(); toggleMobileProfileMenu();">
            <i class="fas fa-chart-line"></i>
            <span>Statistiques</span>
            <i class="fas fa-lock mobile-dropdown-lock-icon"></i>
          </button>
          <button class="mobile-dropdown-item mobile-params-item" onclick="navigateTo('connection'); toggleMobileProfileMenu();">
            <i class="fas fa-cog"></i>
            <span>Parametres</span>
            <i class="fas fa-lock mobile-dropdown-lock-icon"></i>
          </button>
          <button class="mobile-dropdown-item mobile-logout" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Se deconnecter</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Zone de contenu dynamique -->
    <main id="app-content">
      <!-- Zones de swipe sur les bords (MOBILE SEULEMENT) -->
      <div id="swipe-zone-left" class="swipe-zone"></div>
      <div id="swipe-zone-right" class="swipe-zone"></div>

      <!-- Overlay pour suivre le swipe une fois activ√© -->
      <div id="swipe-overlay"></div>

      <!-- DESKTOP & MOBILE: Iframes multiples pour navigation instantan√©e (une par page) -->
      <!-- Les iframes sont pr√©charg√©es au lancement et restent en m√©moire -->
      <iframe id="iframe-guide" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-dashboard" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-rpo" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-travaux" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-outils" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-gestions" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-connection" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-centralevue" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-centraleadmin" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-gamification" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-calcul" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-calculateur" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-soumissions" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-gqp" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-facture" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-gestionemployes" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-facturationqe" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-avis" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-centrale" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-ventes" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-dashboardcoach" class="page-iframe" src="" style="display: none;"></iframe>
      <iframe id="iframe-parametrecoach" class="page-iframe" src="" style="display: none;"></iframe>
    </main>

    <!-- Bottom Navigation Mobile - Style app-shell -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 z-50 mobile-header-bottom">
      <div class="bg-slate-800 h-24 shadow-2xl relative" style="filter: drop-shadow(0 -8px 18px rgba(59, 130, 246, 0.2));">
        <!-- 5 ic√¥nes r√©parties -->
        <div class="absolute top-1.5 left-0 right-0 flex justify-center">
          <div class="flex items-center w-full h-full">
            <!-- Case 1 - RPO (d√©sactiv√© pour l'instant) -->
            <div class="flex-1 case-container flex justify-center items-center h-full">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-gray-400 to-gray-500 flex items-center justify-center shadow-lg cursor-not-allowed icon-container opacity-50" title="Bient√¥t disponible">
                <i class="fas fa-calendar-alt text-sm text-white"></i>
              </div>
            </div>
            <!-- S√©parateur 1 -->
            <div class="w-px h-8 bg-slate-400 opacity-30"></div>
            <!-- Case 2 - Ventes (actif) -->
            <div class="flex-1 case-container flex justify-center items-center h-full">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center shadow-lg cursor-pointer icon-container" onclick="router.loadPage('travaux')">
                <i class="fas fa-chart-line text-sm text-white"></i>
              </div>
            </div>
            <!-- S√©parateur 2 -->
            <div class="w-px h-8 bg-slate-400 opacity-30"></div>
            <!-- Case 3 (centrale - Dashboard) -->
            <div class="flex-2 case-container flex flex-col justify-center items-center h-full">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-xl cursor-pointer icon-container" onclick="router.loadPage('dashboard')">
                <i class="fas fa-chart-bar text-xl text-white"></i>
              </div>
            </div>
            <!-- S√©parateur 3 -->
            <div class="w-px h-8 bg-slate-400 opacity-30"></div>
            <!-- Case 4 - Outils -->
            <div class="flex-1 case-container flex justify-center items-center h-full">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center shadow-lg cursor-pointer icon-container" onclick="router.loadPage('outils')">
                <i class="fas fa-tools text-sm text-white"></i>
              </div>
            </div>
            <!-- S√©parateur 4 -->
            <div class="w-px h-8 bg-slate-400 opacity-30"></div>
            <!-- Case 5 - Gestions -->
            <div class="flex-1 case-container flex justify-center items-center h-full">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-gray-400 to-gray-500 flex items-center justify-center shadow-lg cursor-not-allowed icon-container opacity-50" title="Bient√¥t disponible">
                <i class="fas fa-briefcase text-sm text-white"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================================================================
       MODAL STATISTIQUES GAMIFICATION
       ================================================================ -->
  <div id="stats-modal" class="stats-modal">
    <div class="stats-modal-content">
      <!-- Header du modal -->
      <div class="stats-modal-header">
        <h2><i class="fas fa-chart-line"></i> Statistiques<span class="stats-modal-title-extra"> de Progression</span></h2>
        <button class="stats-modal-close" onclick="closeStatsModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Spinner de chargement -->
      <div id="stats-modal-loader" class="stats-modal-loader" style="display: none;">
        <div class="stats-loader-spinner"></div>
        <p class="stats-loader-text">Chargement des statistiques...</p>
      </div>

      <!-- Contenu du modal -->
      <div class="stats-modal-body" id="stats-modal-body-content">
        <!-- SECTION 1: PROFIL COMPLET (Photo + Nom + Grade + Progression) -->
        <div class="stats-section">
          <div class="stats-unified-card">
            <!-- Version Desktop - Structure originale -->
            <div class="desktop-stats-profile">
              <div class="stats-profile-header">
                <div class="stats-profile-photo-banner">
                  <div class="stats-profile-photo-wrapper">
                    <div class="stats-profile-photo-container">
                      <img id="stats-profile-photo" src="" alt="Photo de profil" class="stats-profile-photo">
                      <!-- Badge de streak (affich√© si streak >= 1) -->
                      <div id="statsStreakBadge" style="position: absolute; top: -17px; right: -34px; background: linear-gradient(135deg, rgb(31, 41, 55), rgb(17, 24, 39)); color: white; min-width: 49px; height: 30px; border-radius: 20%; display: none; flex-direction: row; align-items: center; justify-content: center; gap: 0.15rem; padding: 0px 0.35rem; border: 2px solid var(--bg-dark); box-shadow: rgba(0, 0, 0, 0.5) 0px 2px 8px, rgba(245, 158, 11, 0.3) 0px 0px 12px; z-index: 20;">
                        <i class="fas fa-fire" style="font-size: 1rem !important; color: #f59e0b;"></i>
                        <span id="statsStreakNumber" style="font-size: 1rem; font-weight: 800; line-height: 1;">0</span>
                      </div>
                    </div>
                    <div class="stats-photo-level-banner">
                      <span>Niv. <span id="stats-photo-level-text">1</span></span>
                    </div>
                  </div>
                </div>
                <div class="stats-profile-info">
                  <div class="stats-name-xp-row">
                    <div style="display: flex; align-items: baseline; gap: 1rem;">
                      <h3 id="stats-username">Username</h3>
                      <div class="stats-grade-name-display" id="stats-grade-name-display">D√©marrage</div>
                    </div>
                    <div class="stats-xp-text-inline">
                      <span id="stats-xp-current">0</span> / <span id="stats-xp-next">100</span> XP
                      <span class="stats-xp-percentage" id="stats-xp-percentage">(0%)</span>
                    </div>
                  </div>
                  <!-- Barre XP sous le nom -->
                  <div class="stats-xp-bar">
                    <div class="stats-xp-fill" id="stats-xp-fill" style="width: 0%"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Version Mobile - Structure simplifi√©e -->
            <div class="mobile-stats-profile">
              <!-- Section 1: Photo + Nom/Grade -->
              <div class="stats-photo-nom-section">
                <div class="stats-profile-photo-banner">
                  <div class="stats-profile-photo-wrapper">
                    <div class="stats-profile-photo-container">
                      <img id="stats-profile-photo-mobile" src="" alt="Photo de profil" class="stats-profile-photo">
                      <!-- Badge de streak (affich√© si streak >= 1) -->
                      <div id="statsStreakBadgeMobile" style="position: absolute; top: -17px; right: -34px; background: linear-gradient(135deg, rgb(31, 41, 55), rgb(17, 24, 39)); color: white; min-width: 49px; height: 30px; border-radius: 20%; display: none; flex-direction: row; align-items: center; justify-content: center; gap: 0.15rem; padding: 0px 0.35rem; border: 2px solid var(--bg-dark); box-shadow: rgba(0, 0, 0, 0.5) 0px 2px 8px, rgba(245, 158, 11, 0.3) 0px 0px 12px; z-index: 20;">
                        <i class="fas fa-fire" style="font-size: 1rem !important; color: #f59e0b;"></i>
                        <span id="statsStreakNumberMobile" style="font-size: 1rem; font-weight: 800; line-height: 1;">0</span>
                      </div>
                    </div>
                    <div class="stats-photo-level-banner">
                      <span>Niv. <span id="stats-photo-level-text-mobile">1</span></span>
                    </div>
                  </div>
                </div>
                <div class="stats-profile-nom-grade">
                  <div style="display: flex; align-items: baseline; gap: 1rem;">
                    <h3 id="stats-username-mobile">Username</h3>
                    <div class="stats-grade-name-display" id="stats-grade-name-display-mobile">D√©marrage</div>
                  </div>
                </div>
              </div>

              <!-- Section 2: Barre de Progression XP -->
              <div class="stats-xp-section">
                <div class="stats-xp-text-inline">
                  <span id="stats-xp-current-mobile">0</span> / <span id="stats-xp-next-mobile">100</span> XP
                  <span class="stats-xp-percentage" id="stats-xp-percentage-mobile">(0%)</span>
                </div>
                <div class="stats-xp-bar">
                  <div class="stats-xp-fill" id="stats-xp-fill-mobile" style="width: 0%"></div>
                </div>
              </div>
            </div>

            <!-- Section 3: Vers Prochain Grade -->
            <div class="stats-next-grade-section">
              <h4 class="stats-subsection-title">Vers Prochain Grade</h4>
              <div class="stats-next-grade-content">
                <div class="stats-grade-badge-left">
                  <img id="stats-current-grade-badge" src="" alt="Grade actuel">
                </div>
                <div class="stats-next-grade-info">
                  <div class="stats-next-grade-levels">
                    <span id="stats-current-level-text">Niv 1</span>
                    <span id="stats-next-level-text">Niv 2</span>
                  </div>
                  <div class="stats-next-grade-bar">
                    <div class="stats-next-grade-fill" id="stats-next-grade-fill" style="width: 0%"></div>
                  </div>
                </div>
                <div class="stats-grade-badge-right">
                  <img id="stats-next-grade-badge" src="" alt="Prochain grade">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECTION 2: MES BADGES -->
        <div class="stats-section">
          <div class="badges-header">
            <h3 class="stats-section-title"><i class="fas fa-medal"></i> Mes Badges</h3>
            <button class="badges-expand-btn" id="badges-expand-btn" onclick="toggleBadgesSection()">
              <span id="badges-expand-text">Voir tous</span>
              <i class="fas fa-chevron-down" id="badges-expand-icon"></i>
            </button>
          </div>

          <!-- Top 5 badges (visible par d√©faut) -->
          <div class="badges-top-container" id="badges-top-container">
            <div class="top-badges-title">
              <i class="fas fa-trophy"></i>
              <span>5 Meilleurs Badges</span>
            </div>
            <div class="badges-horizontal-scroll" id="stats-badges-top">
              <!-- Les 5 meilleurs badges seront charg√©s ici -->
              <div class="no-badges-message">Chargement des badges...</div>
            </div>
          </div>

          <!-- Tous les badges par raret√© (cach√© par d√©faut avec animation) -->
          <div class="badges-grid" id="stats-badges-grid">
            <!-- Les badges seront charg√©s ici par JavaScript -->
          </div>
        </div>

        <!-- SECTION 3: STATISTIQUES COMPL√àTES -->
        <div class="stats-section">
          <h3 class="stats-section-title"><i class="fas fa-chart-bar"></i> Toutes mes Statistiques</h3>

          <!-- Toutes les stats -->
          <div class="stats-tables-grid">
            <table class="stats-table">
              <tbody>
                <tr>
                  <td class="stat-label">XP Total</td>
                  <td class="stat-value" id="stats-total-xp">0</td>
                </tr>
              </tbody>
            </table>
            <table class="stats-table">
              <tbody>
                <tr>
                  <td class="stat-label">Badges</td>
                  <td class="stat-value" id="stats-badges">0</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="stats-tables-grid">
            <table class="stats-table">
              <tbody>
                <tr>
                  <td class="stat-label">Dollars ($) vendu</td>
                  <td class="stat-value text-green-600 font-bold" id="stats-ca-actuel">0 $</td>
                </tr>
                <tr>
                  <td class="stat-label">H de P√ÄP</td>
                  <td class="stat-value" id="stats-heures-pap">0 h</td>
                </tr>
                <tr>
                  <td class="stat-label">Taux marketing</td>
                  <td class="stat-value" id="stats-taux-marketing">0%</td>
                </tr>
                <tr>
                  <td class="stat-label">Contrats sign√©s</td>
                  <td class="stat-value font-bold" id="stats-contrats-signes">0</td>
                </tr>
                <tr>
                  <td class="stat-label">Estimations totales</td>
                  <td class="stat-value" id="stats-estimations-totales">0</td>
                </tr>
              </tbody>
            </table>
            <table class="stats-table">
              <tbody>
                <tr>
                  <td class="stat-label">Contrat moyen</td>
                  <td class="stat-value" id="stats-contrat-moyen">0 $</td>
                </tr>
                <tr>
                  <td class="stat-label">Taux de vente</td>
                  <td class="stat-value" id="stats-taux-vente">0%</td>
                </tr>
                <tr>
                  <td class="stat-label">Dollars produit</td>
                  <td class="stat-value font-bold" style="color: #60a5fa;" id="stats-dollars-produit">0 $</td>
                </tr>
                <tr>
                  <td class="stat-label">Productivit√©/h</td>
                  <td class="stat-value" id="stats-prod-horaire">0 $/h</td>
                </tr>
                <tr>
                  <td class="stat-label">Satisfaction</td>
                  <td class="stat-value" style="color: #eab308;" id="stats-satisfaction"><i class="fas fa-star"></i> 0</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================================================================
       ROUTER JAVASCRIPT - Navigation SPA
       ================================================================ -->

  <script>
    // Configuration du router
    const router = {
      currentPage: null,

      // Map des routes vers les URLs FastAPI
      routes: {
        'guide': '/guide-content?v=20260106c',
        'dashboard': '/dashboard',
        'connection': '/connection',
        'rpo': '/rpo',
        'centralevue': '/centralevue',
        'centraleadmin': '/centraleadmin',
        'gamification': '/gamification',
        'calcul': '/calcul',
        'calculateur': '/calcul',  // Alias pour le menu lat√©ral
        'soumissions': '/soumissions',
        'outils': '/outilsmobile',
        'gestions': '/gestionsmobile',
        'gqp': '/gqp',
        'facture': '/facture',
        'travaux': '/travaux',
        'gestionemployes': '/gestionemployes',
        'facturationqe': '/facturationqe',
        'avis': '/avis',
        'centrale': '/centrale',
        'dashboardcoach': '/dashboardcoach',
        'parametrecoach': '/parametrecoach',
        'test-functions': '/test-functions'
      },

      // Charger une page (diff√©rent pour PC et mobile)
      loadPage(pageName) {
        const url = this.routes[pageName];

        if (!url) {
          console.error(`[APPPC] Route non trouvee pour: ${pageName}`);
          return;
        }

        // BLOQUER navigation si guide non compl√©t√© (sauf vers guide lui-m√™me)
        if (pageName !== 'guide' && window.guideIsCompleted === false) {
          console.log(`[APPPC] Guide non compl√©t√© - blocage navigation vers ${pageName}, redirection vers guide`);
          location.hash = '#/guide';
          pageName = 'guide';
        }

        console.log(`[APPPC] Navigation vers ${pageName}`);

        // Si on est sur le guide, bloquer tous les items du menu et ajouter des cadenas
        const menuItems = document.querySelectorAll('.nav-item');
        const sidebar = document.querySelector('.sidebar');

        // S√©lectionner les items du dropdown PC (Statistiques et Parametres)
        const statsItem = document.querySelector('.dropdown-item.stats-item');
        const paramsItem = document.querySelector('.dropdown-item.params-item');

        // S√©lectionner les items du dropdown mobile (Statistiques et Parametres)
        const mobileStatsItem = document.querySelector('.mobile-dropdown-item.mobile-stats-item');
        const mobileParamsItem = document.querySelector('.mobile-dropdown-item.mobile-params-item');

        if (pageName === 'guide') {
          // Bloquer le menu quand on est sur le guide
          menuItems.forEach(item => {
            item.style.pointerEvents = 'none';
            item.style.opacity = '0.5';
            item.style.cursor = 'not-allowed';
          });

          // Bloquer dropdown PC
          if (statsItem) {
            statsItem.style.pointerEvents = 'none';
            statsItem.style.opacity = '0.5';
            statsItem.classList.add('locked-guide');
          }
          if (paramsItem) {
            paramsItem.style.pointerEvents = 'none';
            paramsItem.style.opacity = '0.5';
            paramsItem.classList.add('locked-guide');
          }

          // Bloquer dropdown mobile
          if (mobileStatsItem) {
            mobileStatsItem.style.pointerEvents = 'none';
            mobileStatsItem.style.opacity = '0.5';
            mobileStatsItem.classList.add('locked-guide');
          }
          if (mobileParamsItem) {
            mobileParamsItem.style.pointerEvents = 'none';
            mobileParamsItem.style.opacity = '0.5';
            mobileParamsItem.classList.add('locked-guide');
          }
        } else {
          menuItems.forEach(item => {
            item.style.pointerEvents = '';
            item.style.opacity = '';
            item.style.cursor = '';
          });

          // D√©bloquer dropdown PC
          if (statsItem) {
            statsItem.style.pointerEvents = '';
            statsItem.style.opacity = '';
            statsItem.classList.remove('locked-guide');
          }
          if (paramsItem) {
            paramsItem.style.pointerEvents = '';
            paramsItem.style.opacity = '';
            paramsItem.classList.remove('locked-guide');
          }

          // D√©bloquer dropdown mobile
          if (mobileStatsItem) {
            mobileStatsItem.style.pointerEvents = '';
            mobileStatsItem.style.opacity = '';
            mobileStatsItem.classList.remove('locked-guide');
          }
          if (mobileParamsItem) {
            mobileParamsItem.style.pointerEvents = '';
            mobileParamsItem.style.opacity = '';
            mobileParamsItem.classList.remove('locked-guide');
          }
        }

        // DESKTOP & MOBILE: Utiliser le syst√®me multi-iframes pour navigation instantan√©e
        // Cacher toutes les iframes
        document.querySelectorAll('.page-iframe').forEach(iframe => {
          iframe.style.display = 'none';
        });

        // Afficher l'iframe correspondante
        const targetIframe = document.getElementById(`iframe-${pageName}`);
        if (targetIframe) {
          // Utiliser getAttribute pour avoir la vraie valeur de l'attribut HTML (pas la propriete resolue)
          const srcAttr = targetIframe.getAttribute('src');
          console.log(`[APPPC] Navigation vers ${pageName} - src attr: "${srcAttr}", src prop: "${targetIframe.src}"`);

          // Si l'iframe n'a pas encore de src (chargement a la demande), la charger
          // Verifier l'attribut HTML car la propriete .src retourne toujours une URL absolue
          const needsLoading = !srcAttr || srcAttr === '' || srcAttr === 'about:blank';

          // SPECIAL: Si on navigue vers soumissions ou calcul et qu'il y a des donn√©es, forcer le reload
          const hasCalcData = sessionStorage.getItem('submissionData') || sessionStorage.getItem('soumissionData') || sessionStorage.getItem('calcClientData') || localStorage.getItem('recuperationClient');
          const forceReloadSoumissions = pageName === 'soumissions' && hasCalcData && !needsLoading;
          const forceReloadCalcul = (pageName === 'calcul' || pageName === 'calculateur') && hasCalcData && !needsLoading;
          const forceReload = forceReloadSoumissions || forceReloadCalcul;

          if (needsLoading || forceReload) {
            // ‚ö° CACHER L'IFRAME IMM√âDIATEMENT pour √©viter le flash
            targetIframe.style.opacity = '0';

            // ‚ö° AFFICHER le spinner IMM√âDIATEMENT (pas de d√©lai)
            // MAIS seulement si le loading-overlay principal n'est pas visible (pas au premier lancement)
            // EXCEPTION: Pour le guide, toujours afficher le spinner car le loading-overlay se cache rapidement
            const pageSpinner = document.getElementById('page-loading-spinner');
            const loadingOverlay = document.getElementById('loading-overlay');
            const isInitialLoad = loadingOverlay && !loadingOverlay.classList.contains('hidden');
            const isGuide = pageName === 'guide';

            // ‚ö° Ajuster la position du spinner selon la sidebar (desktop vs mobile)
            if (pageSpinner && (!isInitialLoad || isGuide)) {
              const sidebar = document.querySelector('.sidebar');
              const isMobile = window.innerWidth <= 600;

              if (isMobile) {
                pageSpinner.style.left = '0';
                pageSpinner.style.top = '64px';
                pageSpinner.style.bottom = '96px';
                pageSpinner.style.right = '0';
              } else {
                const sidebarWidth = sidebar && sidebar.classList.contains('expanded') ? '260px' : '80px';
                pageSpinner.style.left = sidebarWidth;
                pageSpinner.style.top = '90px';
              }

              // Afficher le spinner pour la navigation entre pages
              pageSpinner.style.display = 'flex';
              console.log(`[APPPC] üîÑ Spinner affich√© pour ${pageName}`);
            }

            if (forceReload) {
              console.log(`[APPPC] üîÑ Rechargement forc√© de soumissions (donn√©es calculateur d√©tect√©es)`);
            } else {
              console.log(`[APPPC] Chargement initial de ${pageName}: ${url}`);
            }

            // Passer le param√®tre ?user= de l'URL parente √† l'iframe si pr√©sent
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('user');
            let finalUrl = url;
            if (username) {
              finalUrl = url.includes('?') ? `${url}&user=${encodeURIComponent(username)}` : `${url}?user=${encodeURIComponent(username)}`;
              console.log(`[APPPC] Ajout du param√®tre user √† l'iframe: ${finalUrl}`);
            }

            // ‚ö° NOUVEAU: Listener pour cacher le spinner quand la page est charg√©e
            const hideSpinnerOnLoad = function() {
              // ‚ö° Attendre 500ms APR√àS le load pour s'assurer que le JavaScript a fini de s'ex√©cuter
              setTimeout(() => {
                if (pageSpinner) {
                  pageSpinner.style.display = 'none';
                  console.log(`[APPPC] ‚úÖ Spinner cach√© - ${pageName} charg√©`);
                }
                // ‚ö° Remettre l'iframe visible maintenant que tout est charg√©
                targetIframe.style.opacity = '1';
              }, 500); // D√©lai pour que le JS soit compl√®tement charg√© et visible
            };

            // FORCER RELOAD COMPLET: Vider puis recharger facturationqe pour appliquer le fix
            if (pageName === 'facturationqe') {
              console.log(`[APPPC] Vidage et rechargement forc√© de facturationqe`);
              targetIframe.src = '';  // Vider d'abord
              // Attendre 10ms puis recharger
              setTimeout(() => {
                targetIframe.src = finalUrl;
                targetIframe.addEventListener('load', hideSpinnerOnLoad, { once: true });
                // V√©rifier les modifications comptable apr√®s chargement
                targetIframe.addEventListener('load', function() {
                  setTimeout(checkModificationsComptable, 500);
                }, { once: true });
                console.log(`[APPPC] Facturationqe recharg√© avec: ${finalUrl}`);
              }, 10);
            } else {
              targetIframe.src = finalUrl;
              targetIframe.addEventListener('load', hideSpinnerOnLoad, { once: true });
            }

            // Sur mobile, injecter CSS pour cacher les scrollbars quand l'iframe est charg√©e
            if (window.innerWidth <= 600) {
              targetIframe.addEventListener('load', function() {
                hideScrollbarsInIframe(targetIframe);
              });
            }

            // Retirer l'opacit√© une fois charg√©
            if (forceReload) {
              targetIframe.addEventListener('load', function onLoad() {
                targetIframe.style.opacity = '1';
                targetIframe.removeEventListener('load', onLoad);
              });
            }
          } else {
            // V√©rifier si le param√®tre user a chang√© et forcer un reload si n√©cessaire
            const urlParams = new URLSearchParams(window.location.search);
            const currentUsername = urlParams.get('user');
            const iframeSrc = targetIframe.getAttribute('src');

            // V√©rifier si l'iframe a le bon param√®tre user
            let needsUserUpdate = false;
            if (currentUsername) {
              const iframeUrl = new URL(iframeSrc, window.location.origin);
              const iframeUsername = iframeUrl.searchParams.get('user');

              if (iframeUsername !== currentUsername) {
                console.log(`[APPPC] ‚ö†Ô∏è Username chang√© (${iframeUsername} -> ${currentUsername}) - Rechargement forc√©`);
                needsUserUpdate = true;
              }
            }

            if (needsUserUpdate) {
              // Forcer le rechargement avec le bon username
              let finalUrl = url;
              if (currentUsername) {
                finalUrl = url.includes('?') ? `${url}&user=${encodeURIComponent(currentUsername)}` : `${url}?user=${encodeURIComponent(currentUsername)}`;
              }
              targetIframe.src = finalUrl;
            } else {
              // ‚ö° TOUJOURS recharger le JavaScript pour avoir les donn√©es fra√Æches
              // Le HTML/CSS restent en cache (rapide), mais le JS se r√©ex√©cute
              console.log(`[APPPC] üîÑ Rechargement du JavaScript pour: ${pageName}`);

              // ‚ö° CACHER L'IFRAME IMM√âDIATEMENT pour √©viter le flash
              targetIframe.style.opacity = '0';

              // ‚ö° AFFICHER le spinner IMM√âDIATEMENT (pas de d√©lai)
              // MAIS seulement si le loading-overlay principal n'est pas visible
              const spinner = document.getElementById('page-loading-spinner');
              const loadingOverlay = document.getElementById('loading-overlay');
              const isInitialLoad = loadingOverlay && !loadingOverlay.classList.contains('hidden');

              // ‚ö° Ajuster la position du spinner selon la sidebar (desktop vs mobile)
              if (spinner && !isInitialLoad) {
                const sidebar = document.querySelector('.sidebar');
                const isMobile = window.innerWidth <= 600;

                if (isMobile) {
                  // Mobile: pas de sidebar, spinner couvre seulement la zone de contenu (entre header et bottom nav)
                  spinner.style.left = '0';
                  spinner.style.top = '64px';
                  spinner.style.bottom = '96px';
                  spinner.style.right = '0';
                } else {
                  // Desktop: ajuster selon si sidebar expanded ou collapsed
                  const sidebarWidth = sidebar && sidebar.classList.contains('expanded') ? '260px' : '80px';
                  spinner.style.left = sidebarWidth;
                  spinner.style.top = '90px'; // Hauteur du header
                }

                // Afficher le spinner pour la navigation entre pages
                spinner.style.display = 'flex';
              }

              // ‚ö° Fonction pour cacher le spinner apr√®s chargement
              const hideSpinner = () => {
                // ‚ö° Attendre 500ms APR√àS le load pour s'assurer que le JavaScript a fini de s'ex√©cuter
                // (certaines pages comme Ventes ont beaucoup de JS √† ex√©cuter)
                setTimeout(() => {
                  if (spinner) {
                    spinner.style.display = 'none';
                  }
                  // ‚ö° Remettre l'iframe visible maintenant que tout est charg√©
                  targetIframe.style.opacity = '1';
                }, 500); // D√©lai pour que le JS soit compl√®tement charg√© et visible
              };

              // ‚ö° √âcouter le chargement de l'iframe
              targetIframe.addEventListener('load', hideSpinner, { once: true });

              // V√©rifier les modifications comptable si facturationqe
              if (pageName === 'facturationqe') {
                targetIframe.addEventListener('load', function() {
                  setTimeout(checkModificationsComptable, 500);
                }, { once: true });
              }

              try {
                targetIframe.contentWindow.location.reload();
              } catch (e) {
                console.log(`[APPPC] Impossible de recharger (cross-origin), rechargement via src`);
                targetIframe.src = targetIframe.src; // Force reload via src
              }
            }
          }
          targetIframe.style.display = 'block';
        } else {
          console.error(`[APPPC] Iframe non trouv√©e pour: ${pageName}`);
        }

        // Mettre a jour le menu actif
        this.updateActiveMenu(pageName);
        this.currentPage = pageName;

        // Activer l'animation de l'ic√¥ne correspondante dans le bottom navigation
        if (typeof setActiveNavIcon === 'function') {
          setActiveNavIcon(pageName);
        }
      },

      // Mettre a jour le menu actif
      updateActiveMenu(pageName) {
        // Retirer imm√©diatement tous les active pour √©viter les transitions
        document.querySelectorAll('.menu-item').forEach(item => {
          item.classList.remove('active');
        });
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });

        // Si on est sur centraleadmin, activer le menu centralevue
        const pageToMatch = (pageName === 'centraleadmin') ? 'centralevue' : pageName;

        // Puis ajouter la classe active au bon √©l√©ment
        document.querySelectorAll('.menu-item').forEach(item => {
          if (item.dataset.page === pageToMatch) {
            item.classList.add('active');
          }
        });
        document.querySelectorAll('.nav-item').forEach(item => {
          if (item.dataset.page === pageToMatch) {
            item.classList.add('active');
          }
        });
      },

      // Initialiser le router
      init() {
        // Gerer les changements de hash
        window.addEventListener('hashchange', () => {
          const page = location.hash.slice(2) || 'dashboard';
          console.log('[APPPC] Hashchange d√©tect√©, page:', page);
          this.loadPage(page);
          // Forcer la mise √† jour de l'ic√¥ne apr√®s un court d√©lai
          setTimeout(() => {
            if (typeof setActiveNavIcon === 'function') {
              console.log('[APPPC] Mise √† jour ic√¥ne pour:', page);
              setActiveNavIcon(page);
            }
          }, 100);
        });

        // Gerer les clics sur les liens du menu
        document.querySelectorAll('.nav-item').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();

            // Bloquer la navigation si on est sur le guide
            if (this.currentPage === 'guide') {
              console.log('[APPPC] Navigation bloqu√©e - guide en cours');
              return;
            }

            const page = link.dataset.page;
            if (page) {
              const currentHash = location.hash.slice(2);
              // Si le hash est d√©j√† sur cette page, forcer le chargement
              if (currentHash === page) {
                console.log(`[APPPC] Hash d√©j√† sur ${page}, chargement forc√©`);
                this.loadPage(page);
              } else {
                location.hash = `#/${page}`;
              }
            }
          });
        });

        // V√©rifier si le guide est compl√©t√© avant de charger la page initiale
        const checkGuideAndLoadInitialPage = async () => {
          const urlParams = new URLSearchParams(window.location.search);
          const usernameFromUrl = urlParams.get('user');
          const username = usernameFromUrl || window.username || localStorage.getItem('username');

          // Forcer dashboard au lancement initial (ignorer le hash existant)
          const initialPage = 'dashboard';
          location.hash = '#/dashboard';

          // IMPORTANT: Vider toutes les iframes si un nouveau username est d√©tect√©
          if (usernameFromUrl) {
            const lastUsername = sessionStorage.getItem('lastLoadedUsername');
            if (lastUsername && lastUsername !== usernameFromUrl) {
              console.log(`[APPPC] üîÑ Changement d'utilisateur d√©tect√© (${lastUsername} -> ${usernameFromUrl}) - Vidage des iframes`);
              // Vider toutes les iframes pour forcer le rechargement avec le bon user
              document.querySelectorAll('.page-iframe').forEach(iframe => {
                iframe.setAttribute('src', '');
              });
            }
            sessionStorage.setItem('lastLoadedUsername', usernameFromUrl);
          }

          if (username) {
            try {
              const response = await fetch(`/api/guide-progress/${username}`);
              if (response.ok) {
                const guideData = await response.json();

                // IMPORTANT: D√©finir la variable globale pour bloquer les navigations futures
                // Forcer un bool√©en explicite (undefined/null/false -> false, true -> true)
                window.guideIsCompleted = !!guideData.completed;

                // Si le guide n'est pas compl√©t√©, forcer le chargement du guide
                if (!guideData.completed) {
                  console.log('[APPPC] Guide non compl√©t√© (window.guideIsCompleted =', window.guideIsCompleted, '), redirection vers guide');
                  // Changer le hash seulement - le hashchange event va appeler loadPage automatiquement
                  location.hash = '#/guide';
                  return;
                }
              }
            } catch (error) {
              console.error('[APPPC] Erreur v√©rification guide:', error);
            }
          }

          // Si le guide est compl√©t√© ou erreur, charger la page normale
          this.loadPage(initialPage);

          // Initialiser l'ic√¥ne s√©lectionn√©e au chargement
          setTimeout(() => {
            if (typeof setActiveNavIcon === 'function') {
              setActiveNavIcon(initialPage);
            }
          }, 300);
        };

        checkGuideAndLoadInitialPage();

        // √âcouter les messages de connexion Gmail (pour popup) et reload-gqp
        window.addEventListener('message', (event) => {
          if (event.data && event.data.type === 'gmail_connected') {
            console.log('[APPPC] Gmail connected via postMessage');
            this.loadPage('connection');
            location.hash = '#/connection';
          }
          // Recharger l'iframe GQP quand les √©quipes sont modifi√©es
          if (event.data && event.data.type === 'reload-gqp') {
            console.log('[APPPC] Rechargement de l\'iframe GQP demand√©');
            const gqpIframe = document.getElementById('iframe-gqp');
            if (gqpIframe && gqpIframe.src) {
              gqpIframe.src = gqpIframe.src;
              console.log('[APPPC] iframe GQP recharg√©e');
            }
          }
          // Mettre √† jour le badge RPO depuis l'iframe
          if (event.data && event.data.type === 'update-rpo-badge') {
            console.log('[APPPC] Mise √† jour du badge RPO:', event.data.count);
            const badge = document.getElementById('rpo-notification-badge');
            if (badge) {
              const count = event.data.count;
              if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
                console.log('[APPPC] Badge RPO mis √† jour et affich√©:', count);
              } else {
                badge.classList.add('hidden');
                console.log('[APPPC] Badge RPO cach√© (count = 0)');
              }
            } else {
              console.warn('[APPPC] Badge RPO non trouv√© dans le DOM');
            }
          }
        });

        // V√©rifier p√©riodiquement localStorage pour d√©tection de connexion Gmail (pour PWA)
        setInterval(() => {
          const gmailConnected = localStorage.getItem('gmail_connected');
          if (gmailConnected) {
            console.log('[APPPC] Gmail connected via localStorage');
            localStorage.removeItem('gmail_connected');
            this.loadPage('connection');
            location.hash = '#/connection';
          }
        }, 500);
      }
    };

    // ================================================================
    // FONCTIONS UTILITAIRES
    // ================================================================

    // Fonction pour cacher les scrollbars dans une iframe (sur mobile uniquement)
    function hideScrollbarsInIframe(iframe) {
      if (window.innerWidth > 768) return; // Seulement sur mobile

      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

        // Cr√©er un style tag pour cacher les scrollbars
        const style = iframeDoc.createElement('style');
        style.textContent = `
          /* Cacher les scrollbars sur mobile */
          * {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
          }

          *::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
          }

          html, body {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
          }

          html::-webkit-scrollbar,
          body::-webkit-scrollbar {
            display: none !important;
          }
        `;

        iframeDoc.head.appendChild(style);
        console.log('[APPPC] Scrollbars cach√©es dans iframe');
      } catch (e) {
        console.warn('[APPPC] Impossible de modifier iframe (cross-origin):', e.message);
      }
    }

    // Navigation programmatique
    function navigateTo(page) {
      location.hash = `#/${page}`;
      toggleAccountDropdown(); // Fermer le dropdown
    }

    // Toggle dropdown compte
    function toggleAccountDropdown() {
      const dropdown = document.getElementById('account-dropdown');
      dropdown.classList.toggle('show');
    }

    // Toggle sidebar mobile
    function toggleMobileSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      sidebar.classList.toggle('mobile-open');
      overlay.classList.toggle('show');
    }

    // Fermer le sidebar quand on clique sur l'overlay (mobile et tablette)
    function closeSidebarOverlay() {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      const isMobile = window.innerWidth <= 600;
      const isTablet = window.innerWidth > 600 && window.innerWidth <= 1366;

      if (isMobile) {
        sidebar.classList.remove('mobile-open');
      } else if (isTablet) {
        sidebar.classList.remove('expanded');
        document.body.classList.remove('sidebar-expanded');
      }
      overlay.classList.remove('show');
    }

    // Toggle sidebar (ouvrir/fermer)
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      sidebar.classList.toggle('expanded');
      document.body.classList.toggle('sidebar-expanded');

      // Sur tablette, afficher/masquer l'overlay avec flou
      const isTablet = window.innerWidth > 600 && window.innerWidth <= 1366;
      if (isTablet && overlay) {
        overlay.classList.toggle('show', sidebar.classList.contains('expanded'));
      }
    }

    // Ajouter les cadenas aux √©l√©ments du menu - UNIQUEMENT DANS LE SIDEBAR
    function addLockIconsToDisabledItems() {
      document.querySelectorAll('.sidebar .nav-item').forEach(item => {
        // V√©rifier si l'√©l√©ment n'a pas d√©j√† un cadenas
        if (!item.querySelector('.nav-lock-icon')) {
          const lockIcon = document.createElement('i');
          lockIcon.className = 'fas fa-lock nav-lock-icon';
          item.appendChild(lockIcon);
        }
      });
    }

    // Navigation active state - Style Qwota Lite
    document.addEventListener('DOMContentLoaded', function() {
      // Ajouter les cadenas au chargement
      addLockIconsToDisabledItems();

      // Sur tablette (601px - 1366px), fermer le sidebar par d√©faut
      // iPad 6th gen: 768x1024, iPad Mini: 768x1024, iPad Air: 820x1180, iPad Pro: 1024x1366
      const isTablet = window.innerWidth > 600 && window.innerWidth <= 1366;
      if (isTablet) {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
          sidebar.classList.remove('expanded');
          document.body.classList.remove('sidebar-expanded');
        }
      }

      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
          const pageName = this.getAttribute('data-page');

          if (pageName) {
            // Update active state
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');

            // Sur tablette, fermer le sidebar et l'overlay apr√®s s√©lection
            const isTabletNow = window.innerWidth > 600 && window.innerWidth <= 1366;
            if (isTabletNow) {
              const sidebar = document.querySelector('.sidebar');
              const overlay = document.querySelector('.sidebar-overlay');
              if (sidebar && sidebar.classList.contains('expanded')) {
                sidebar.classList.remove('expanded');
                document.body.classList.remove('sidebar-expanded');
                if (overlay) overlay.classList.remove('show');
              }
            }
          }
        });
      });
    });

    // Fermer dropdown si clic en dehors
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('account-dropdown');
      const accountBtn = document.querySelector('.account-btn');
      if (!accountBtn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.remove('show');
      }
    });

    // Fonction logout
    function logout() {
      // Supprimer toutes les donn√©es de session
      localStorage.removeItem('username');
      localStorage.removeItem('role');
      localStorage.removeItem('qwotaCredentials'); // Supprimer les credentials "me rappeler de moi"
      localStorage.removeItem('sidebarCollapsed');
      localStorage.removeItem('gmail_connected');

      // Nettoyer tout le localStorage pour une d√©connexion compl√®te
      // localStorage.clear(); // Alternative: tout effacer (comment√© pour garder certaines pr√©f√©rences)

      // Forcer un rechargement complet de la page de login depuis le serveur
      window.location.href = '/login?t=' + new Date().getTime();
    }

    // Charger les infos utilisateur
    function loadUserInfo() {
      const username = localStorage.getItem('username') || 'Utilisateur';
      const role = localStorage.getItem('role') || 'Entrepreneur';

      // Header PC
      const accountUsername = document.getElementById('account-username');
      const accountRole = document.getElementById('account-role');
      const dropdownUsername = document.getElementById('dropdown-username');
      const dropdownRole = document.getElementById('dropdown-role');

      if (accountUsername) accountUsername.textContent = username;
      if (accountRole) accountRole.textContent = role;
      if (dropdownUsername) dropdownUsername.textContent = username;
      if (dropdownRole) dropdownRole.textContent = role;

      // Mobile dropdown
      const mobileDropdownUsername = document.getElementById('mobile-dropdown-username');
      const mobileDropdownRole = document.getElementById('mobile-dropdown-role');

      if (mobileDropdownUsername) mobileDropdownUsername.textContent = username;
      if (mobileDropdownRole) mobileDropdownRole.textContent = role;

      // Charger les donn√©es de gamification
      loadGamificationData(username);
    }

    // Charger les donn√©es de gamification
    // Variable globale pour stocker les donn√©es gamification
    let globalGamificationData = null;

    async function loadGamificationData(username) {
      try {
        const response = await fetch(`/api/gamification/profile/${username}`);
        const data = await response.json();

        if (data.status === 'success' && data.profile) {
          const profile = data.profile;
          globalGamificationData = profile; // Stocker globalement

          const gradeImageMap = {
            'D√©marrage': 'https://i.ibb.co/v6PRQ6RX/2.png',
            'Apprenti': 'https://i.ibb.co/CpT20JQK/3.png',
            'Pilier': 'https://i.ibb.co/ksw5bZnH/4.png',
            'Expert': 'https://i.ibb.co/HfDN4YV2/5.png',
            'Ma√Ætre': 'https://i.ibb.co/YTbb1Bpw/6.png',
            'H√©ros': 'https://i.ibb.co/q322mLQd/8.png',
            'Prestige': 'https://i.ibb.co/k2fNLV6S/9.png'
          };

          // Grades levels
          const gradeLevels = [
            { name: 'D√©marrage', minLevel: 1, maxLevel: 1 },
            { name: 'Apprenti', minLevel: 2, maxLevel: 10 },
            { name: 'Pilier', minLevel: 11, maxLevel: 30 },
            { name: 'Expert', minLevel: 31, maxLevel: 50 },
            { name: 'Ma√Ætre', minLevel: 51, maxLevel: 75 },
            { name: 'H√©ros', minLevel: 76, maxLevel: 90 },
            { name: 'Prestige', minLevel: 91, maxLevel: 100 }
          ];

          // Appliquer le contour de grade √† l'avatar du header
          const accountAvatar = document.querySelector('.account-avatar');
          if (accountAvatar) {
            // Retirer toutes les anciennes classes de grade
            const classList = accountAvatar.className.split(' ');
            accountAvatar.className = classList.filter(c => !c.startsWith('grade-')).join(' ');
            // Ajouter la nouvelle classe de grade
            const gradeClass = 'grade-' + profile.category.toLowerCase()
              .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
              .replace(/\s+/g, '-');
            accountAvatar.classList.add(gradeClass);
          }

          // Appliquer le contour de grade au mobile profile icon
          const mobileProfileIcon = document.querySelector('.mobile-profile-icon');
          if (mobileProfileIcon) {
            // Retirer toutes les anciennes classes de grade
            const classList = mobileProfileIcon.className.split(' ');
            mobileProfileIcon.className = classList.filter(c => !c.startsWith('grade-')).join(' ');
            // Ajouter la nouvelle classe de grade
            const gradeClass = 'grade-' + profile.category.toLowerCase()
              .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
              .replace(/\s+/g, '-');
            mobileProfileIcon.classList.add(gradeClass);

            // Charger la photo de profil dans le mobile icon
            const username = localStorage.getItem('username');
            if (username) {
              fetch(`/api/get-profile-photo/${username}`)
                .then(res => res.json())
                .then(photoData => {
                  // Remplacer l'ic√¥ne par une image
                  if (photoData && photoData.photoUrl) {
                    mobileProfileIcon.innerHTML = `<img src="${photoData.photoUrl}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                  } else {
                    // Fallback avec initiale
                    const initial = username.charAt(0).toUpperCase();
                    const svgDataUrl = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%2360a5fa" width="100" height="100"/><text x="50" y="50" font-size="50" text-anchor="middle" dy=".3em" fill="white">${initial}</text></svg>`;
                    mobileProfileIcon.innerHTML = `<img src="${svgDataUrl}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                  }
                })
                .catch(error => {
                  console.error('Erreur chargement photo mobile:', error);
                });
            }
          }

          // Mettre √† jour la barre XP du header
          const xpFill = document.getElementById('account-xp-fill');
          if (xpFill) {
            xpFill.style.width = `${profile.progress_percentage}%`;
          }

          // Mettre √† jour le niveau dans le header
          const levelText = document.getElementById('account-level-text');
          if (levelText && profile.level) {
            levelText.textContent = `Niv. ${profile.level}`;
          }

          // Mettre √† jour le niveau dans le mobile header
          const mobileLevelText = document.getElementById('mobile-level-text');
          if (mobileLevelText && profile.level) {
            mobileLevelText.textContent = profile.level;
          }

          // Mettre √† jour le badge de grade dans le dropdown PC
          const dropdownGradeBadge = document.getElementById('dropdown-grade-badge');
          if (dropdownGradeBadge && profile.category) {
            const gradeImage = gradeImageMap[profile.category];
            if (gradeImage) {
              dropdownGradeBadge.src = gradeImage;
            }
          }

          // Mettre √† jour le badge de grade dans le dropdown mobile
          const mobileDropdownGradeBadge = document.getElementById('mobile-dropdown-grade-badge');
          if (mobileDropdownGradeBadge && profile.category) {
            const gradeImage = gradeImageMap[profile.category];
            if (gradeImage) {
              mobileDropdownGradeBadge.src = gradeImage;
            }
          }
        }
      } catch (error) {
        console.error('Erreur chargement gamification:', error);
      }
    }

    // === FONCTIONS MODAL STATISTIQUES ===

    async function openStatsModal(username = null, fullName = null, entrepreneurData = null) {
      const modal = document.getElementById('stats-modal');
      if (!modal) return;

      const loader = document.getElementById('stats-modal-loader');
      const content = document.getElementById('stats-modal-body-content');

      // R√©initialiser le scroll en haut du modal
      if (content) content.scrollTop = 0;

      // Ouvrir le modal imm√©diatement avec le spinner
      modal.classList.add('active');

      // Afficher le spinner, cacher le contenu
      if (loader) loader.style.display = 'flex';
      if (content) content.style.display = 'none';

      // Si aucun username fourni, utiliser l'utilisateur connect√©
      const targetUsername = username || localStorage.getItem('username');

      // D√©but du chargement (pour calculer le temps minimum d'affichage du spinner)
      const startTime = Date.now();
      const minLoadingTime = 500; // Temps minimum d'affichage du spinner en ms

      // Charger les donn√©es de gamification pour l'utilisateur cible
      try {
        const response = await fetch(`/api/gamification/profile/${targetUsername}`);
        const data = await response.json();

        if (data.status === 'success') {
          // Passer le fullName ET entrepreneurData √† populateStatsModal
          await populateStatsModal(data.profile, targetUsername, fullName, entrepreneurData);

          // Calculer le temps √©coul√©
          const elapsedTime = Date.now() - startTime;
          const remainingTime = Math.max(0, minLoadingTime - elapsedTime);

          // Attendre le temps restant pour atteindre le temps minimum
          await new Promise(resolve => setTimeout(resolve, remainingTime));

          // Cacher le spinner, afficher le contenu
          if (loader) loader.style.display = 'none';
          if (content) {
            content.style.display = 'block';
            // S'assurer que le scroll est bien en haut apr√®s affichage
            content.scrollTop = 0;
          }
        } else {
          // En cas d'erreur, fermer le modal et alerter
          modal.classList.remove('active');
          alert('Erreur lors du chargement du profil');
        }
      } catch (error) {
        error('Erreur chargement profil:', error);
        modal.classList.remove('active');
        alert('Erreur lors du chargement du profil');
      }
    }

    function closeStatsModal() {
      const modal = document.getElementById('stats-modal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // Exposer la fonction globalement pour les iframes
    window.openStatsModal = openStatsModal;
    window.closeStatsModal = closeStatsModal;

    // Toggle badges section (expand/collapse)
    function toggleBadgesSection() {
      const badgesGrid = document.getElementById('stats-badges-grid');
      const expandBtn = document.getElementById('badges-expand-btn');
      const expandText = document.getElementById('badges-expand-text');
      const expandIcon = document.getElementById('badges-expand-icon');

      if (badgesGrid.classList.contains('show')) {
        // Collapse: cacher les sections par raret√© (top 5 reste visible)
        badgesGrid.classList.remove('show');
        expandBtn.classList.remove('expanded');
        expandText.textContent = 'Voir tous';
        expandIcon.classList.remove('fa-chevron-up');
        expandIcon.classList.add('fa-chevron-down');
      } else {
        // Expand: montrer toutes les sections par raret√© (top 5 reste visible)
        badgesGrid.classList.add('show');
        expandBtn.classList.add('expanded');
        expandText.textContent = 'R√©duire';
        expandIcon.classList.remove('fa-chevron-down');
        expandIcon.classList.add('fa-chevron-up');
      }
    }

    async function populateStatsModal(profile, targetUsername = null, fullName = null, entrepreneurData = null) {
      // Utiliser le username pass√© en param√®tre ou celui du localStorage
      const username = targetUsername || localStorage.getItem('username');
      const role = localStorage.getItem('role');

      console.log('[STATS MODAL APPPC] populateStatsModal appel√© avec entrepreneurData:', entrepreneurData);

      const gradeImageMap = {
        'D√©marrage': 'https://i.ibb.co/v6PRQ6RX/2.png',
        'Apprenti': 'https://i.ibb.co/CpT20JQK/3.png',
        'Pilier': 'https://i.ibb.co/ksw5bZnH/4.png',
        'Expert': 'https://i.ibb.co/HfDN4YV2/5.png',
        'Ma√Ætre': 'https://i.ibb.co/YTbb1Bpw/6.png',
        'H√©ros': 'https://i.ibb.co/q322mLQd/8.png',
        'Prestige': 'https://i.ibb.co/k2fNLV6S/9.png'
      };

      const gradeLevels = [
        { name: 'D√©marrage', minLevel: 1, maxLevel: 1 },
        { name: 'Apprenti', minLevel: 2, maxLevel: 10 },
        { name: 'Pilier', minLevel: 11, maxLevel: 30 },
        { name: 'Expert', minLevel: 31, maxLevel: 50 },
        { name: 'Ma√Ætre', minLevel: 51, maxLevel: 75 },
        { name: 'H√©ros', minLevel: 76, maxLevel: 90 },
        { name: 'Prestige', minLevel: 91, maxLevel: 100 }
      ];

      // R√©cup√©rer le nom complet si pas fourni
      let displayName = fullName;
      console.log('[STATS] fullName fourni:', fullName);
      console.log('[STATS] username:', username);

      if (!displayName) {
        try {
          const entrepreneurResponse = await fetch('/api/entrepreneurs');
          if (entrepreneurResponse.ok) {
            const entrepreneurs = await entrepreneurResponse.json();
            console.log('[STATS] Entrepreneurs r√©cup√©r√©s:', entrepreneurs.length);

            const currentEntrepreneur = entrepreneurs.find(e => e.username === username || e.login_username === username);
            console.log('[STATS] Entrepreneur trouv√©:', currentEntrepreneur);

            if (currentEntrepreneur) {
              // Le nom complet est dans le champ username de l'entrepreneur
              displayName = currentEntrepreneur.username || username;
              console.log('[STATS] Nom complet r√©cup√©r√©:', displayName);
            } else {
              console.log('[STATS] Aucun entrepreneur trouv√© pour:', username);
            }
          }
        } catch (error) {
          console.error('[STATS] Erreur r√©cup√©ration nom complet:', error);
        }
      }

      console.log('[STATS] displayName final:', displayName);

      // Profil - Utiliser le nom complet si disponible, sinon username
      document.getElementById('stats-username').textContent = displayName || username;
      document.getElementById('stats-username-mobile').textContent = displayName || username;

      // Photo de profil
      const statsPhoto = document.getElementById('stats-profile-photo');
      const statsPhotoMobile = document.getElementById('stats-profile-photo-mobile');

      // Log pour d√©boguer
      log('[APPPC DEBUG] populateStatsModal - username:', username, 'fullName:', fullName);

      // Charger la photo de profil
      {
        log('[APPPC DEBUG] Chargement photo via API');
        // Charger via l'API
        try {
          const photoResponse = await fetch(`/api/get-profile-photo/${username}`);

          if (photoResponse.ok) {
            const photoData = await photoResponse.json();
            // V√©rifier si photoUrl existe dans la r√©ponse
            if (photoData && photoData.photoUrl) {
              statsPhoto.src = photoData.photoUrl;
              statsPhotoMobile.src = photoData.photoUrl;
            } else {
              // Fallback sur SVG avec initiale
              const initial = username.charAt(0).toUpperCase();
              const fallbackSvg = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%2360a5fa" width="100" height="100"/><text x="50" y="50" font-size="50" text-anchor="middle" dy=".3em" fill="white">${initial}</text></svg>`;
              statsPhoto.src = fallbackSvg;
              statsPhotoMobile.src = fallbackSvg;
            }
          } else {
            // Erreur de r√©ponse, utiliser le fallback
            const initial = username.charAt(0).toUpperCase();
            const fallbackSvg = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%2360a5fa" width="100" height="100"/><text x="50" y="50" font-size="50" text-anchor="middle" dy=".3em" fill="white">${initial}</text></svg>`;
            statsPhoto.src = fallbackSvg;
            statsPhotoMobile.src = fallbackSvg;
          }
        } catch (error) {
          error('Erreur photo:', error);
          // En cas d'erreur, utiliser le fallback
          const initial = username.charAt(0).toUpperCase();
          const fallbackSvg = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%2360a5fa" width="100" height="100"/><text x="50" y="50" font-size="50" text-anchor="middle" dy=".3em" fill="white">${initial}</text></svg>`;
          if (statsPhoto) {
            statsPhoto.src = fallbackSvg;
          }
          if (statsPhotoMobile) {
            statsPhotoMobile.src = fallbackSvg;
          }
        }
      }

      // Nom du grade dans la section du haut
      document.getElementById('stats-grade-name-display').textContent = profile.category;
      document.getElementById('stats-grade-name-display-mobile').textContent = profile.category;

      // Niveau sur le badge photo
      document.getElementById('stats-photo-level-text').textContent = profile.level;
      document.getElementById('stats-photo-level-text-mobile').textContent = profile.level;

      // Appliquer le contour de grade √† la photo de profil (desktop et mobile)
      const photoContainers = document.querySelectorAll('.stats-profile-photo-container');
      if (photoContainers.length > 0 && profile.category) {
        // Convertir le nom du grade en classe CSS
        // D√©marrage ‚Üí grade-demarrage, Ma√Ætre ‚Üí grade-maitre, etc.
        const gradeClass = 'grade-' + profile.category.toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Enlever accents
          .replace(/\s+/g, '-'); // Remplacer espaces par tirets

        photoContainers.forEach(photoContainer => {
          // Retirer toutes les classes de grade pr√©c√©dentes
          photoContainer.className = photoContainer.className.replace(/grade-\S+/g, '').trim();

          // Ajouter la nouvelle classe de grade
          photoContainer.classList.add(gradeClass);
        });
        console.log(`Contour de grade appliqu√©: ${gradeClass}`);
      }

      // Charger et afficher le streak (desktop et mobile)
      try {
        const today = new Date().toISOString().split('T')[0];
        const streakResponse = await fetch(`/api/gamification/quest-progress/${username}?quest_date=${today}`);
        const streakData = await streakResponse.json();

        if (streakData.status === 'success' && streakData.streak !== undefined) {
          const streak = streakData.streak;
          const statsStreakBadge = document.getElementById('statsStreakBadge');
          const statsStreakNumber = document.getElementById('statsStreakNumber');
          const statsStreakBadgeMobile = document.getElementById('statsStreakBadgeMobile');
          const statsStreakNumberMobile = document.getElementById('statsStreakNumberMobile');

          if (statsStreakNumber) {
            statsStreakNumber.textContent = streak;
          }
          if (statsStreakNumberMobile) {
            statsStreakNumberMobile.textContent = streak;
          }

          // Afficher le badge si streak >= 1
          if (statsStreakBadge) {
            if (streak >= 1) {
              statsStreakBadge.style.display = 'flex';
            } else {
              statsStreakBadge.style.display = 'none';
            }
          }
          if (statsStreakBadgeMobile) {
            if (streak >= 1) {
              statsStreakBadgeMobile.style.display = 'flex';
            } else {
              statsStreakBadgeMobile.style.display = 'none';
            }
          }
        }
      } catch (error) {
        console.error('Erreur chargement streak stats modal:', error);
      }

      // XP (desktop et mobile)
      document.getElementById('stats-xp-current').textContent = profile.xp_progress;
      document.getElementById('stats-xp-next').textContent = profile.xp_for_next_level;
      document.getElementById('stats-xp-fill').style.width = `${profile.progress_percentage}%`;
      document.getElementById('stats-xp-percentage').textContent = `${Math.round(profile.progress_percentage)}%`;

      document.getElementById('stats-xp-current-mobile').textContent = profile.xp_progress;
      document.getElementById('stats-xp-next-mobile').textContent = profile.xp_for_next_level;
      document.getElementById('stats-xp-fill-mobile').style.width = `${profile.progress_percentage}%`;
      document.getElementById('stats-xp-percentage-mobile').textContent = `${Math.round(profile.progress_percentage)}%`;

      // Progression vers prochain grade
      const currentLevel = profile.level;
      const currentGradeIndex = gradeLevels.findIndex(g => currentLevel >= g.minLevel && currentLevel <= g.maxLevel);
      const currentGrade = gradeLevels[currentGradeIndex];

      if (currentGrade) {
        document.getElementById('stats-current-grade-badge').src = gradeImageMap[currentGrade.name];

        if (currentGrade.name === 'Prestige') {
          document.getElementById('stats-current-level-text').textContent = `Niv ${currentLevel}`;
          document.getElementById('stats-next-level-text').innerHTML = '<span style="color: var(--primary-gold);">Max</span>';
          document.getElementById('stats-next-grade-fill').style.width = '100%';
          document.getElementById('stats-next-grade-badge').src = gradeImageMap['Prestige'];
        } else {
          const nextGrade = gradeLevels[currentGradeIndex + 1];
          const nextGradeLevel = nextGrade.minLevel;

          document.getElementById('stats-next-grade-badge').src = gradeImageMap[nextGrade.name];
          document.getElementById('stats-current-level-text').textContent = `Niv ${currentLevel}`;
          document.getElementById('stats-next-level-text').textContent = `Niv ${nextGradeLevel}`;

          const levelsInCurrentGrade = currentGrade.maxLevel - currentGrade.minLevel + 1;
          const levelProgress = currentLevel - currentGrade.minLevel;
          const progressPercentage = (levelProgress / levelsInCurrentGrade) * 100;
          document.getElementById('stats-next-grade-fill').style.width = `${progressPercentage}%`;
        }
      }

      // Stats principales
      document.getElementById('stats-total-xp').textContent = profile.total_xp || 0;
      document.getElementById('stats-badges').textContent = profile.badges_count || 0;

      // Stats Business - Utiliser les donn√©es pass√©es OU fetch from /api/entrepreneurs
      try {
        let currentEntrepreneur = null;

        // Si entrepreneurData est fourni, l'utiliser directement (vient du classement)
        if (entrepreneurData) {
          console.log('[STATS MODAL APPPC] Utilisation des donn√©es du classement:', entrepreneurData);
          currentEntrepreneur = entrepreneurData;
        } else {
          // Sinon, fetch depuis l'API
          const entrepreneurResponse = await fetch('/api/entrepreneurs');
          if (entrepreneurResponse.ok) {
            const entrepreneurs = await entrepreneurResponse.json();
            currentEntrepreneur = entrepreneurs.find(e => e.login_username === username || e.username === username);
          }
        }

        if (currentEntrepreneur) {
            // Dollars ($) vendu - dollar_reel depuis RPO (contrats avec premier paiement)
            document.getElementById('stats-ca-actuel').textContent = `${(currentEntrepreneur.dollar_reel || 0).toLocaleString()} $`;

            // Contrats sign√©s - contract_reel depuis RPO (contrats avec premier paiement)
            document.getElementById('stats-contrats-signes').textContent = currentEntrepreneur.contract_reel || 0;

            // En attente = sign√©s sans premier paiement (soumissions_signees - contract_reel)
            const enAttenteReel = (currentEntrepreneur.soumissions_signees || 0) - (currentEntrepreneur.contract_reel || 0);

            // Estimations totales = Sign√©es + En attente + Perdus
            const estimationsTotales = (currentEntrepreneur.contract_reel || 0) + enAttenteReel + (currentEntrepreneur.soumissions_perdues || 0);
            document.getElementById('stats-estimations-totales').textContent = estimationsTotales;

            // Satisfaction (avec √©toile)
            document.getElementById('stats-satisfaction').innerHTML = `<i class="fas fa-star"></i> ${(currentEntrepreneur.etoiles || 0).toFixed(1)}`;

            // Contrat moyen
            document.getElementById('stats-contrat-moyen').textContent = `${(currentEntrepreneur.contrat_moyen || 0).toLocaleString()} $`;

            // Taux marketing
            document.getElementById('stats-taux-marketing').textContent = `${(currentEntrepreneur.taux_marketing || 0).toFixed(2)}`;

            // Taux de vente
            document.getElementById('stats-taux-vente').textContent = `${Math.round((currentEntrepreneur.taux_vente || 0) * 10) / 10}%`;

            // Dollars produit
            const dollarsProduit = Math.round(currentEntrepreneur.montant_produit || 0);
            document.getElementById('stats-dollars-produit').textContent = `${dollarsProduit.toLocaleString()} $`;

            // Productivit√© horaire
            document.getElementById('stats-prod-horaire').textContent = `${Math.round(currentEntrepreneur.prod_horaire || 0).toLocaleString()} $/h`;

            // Heures de P√ÄP
            document.getElementById('stats-heures-pap').textContent = `${(currentEntrepreneur.heures_pap || 0).toFixed(1)} h`;
          } else {
            // Utilisateur non trouv√©, mettre des valeurs par d√©faut
            document.getElementById('stats-ca-actuel').textContent = '0 $';
            document.getElementById('stats-contrats-signes').textContent = '0';
            document.getElementById('stats-estimations-totales').textContent = '0';
            document.getElementById('stats-satisfaction').innerHTML = '<i class="fas fa-star"></i> 0.0';
            document.getElementById('stats-contrat-moyen').textContent = '0 $';
            document.getElementById('stats-taux-marketing').textContent = '0%';
            document.getElementById('stats-taux-vente').textContent = '0%';
            document.getElementById('stats-dollars-produit').textContent = '0 $';
            document.getElementById('stats-prod-horaire').textContent = '0 $/h';
            document.getElementById('stats-heures-pap').textContent = '0.0 h';
          }
      } catch (error) {
        console.error('Erreur chargement stats business:', error);
        // En cas d'erreur, mettre des valeurs par d√©faut
        document.getElementById('stats-ca-actuel').textContent = '0 $';
        document.getElementById('stats-contrats-signes').textContent = '0';
        document.getElementById('stats-estimations-totales').textContent = '0';
        document.getElementById('stats-satisfaction').innerHTML = '<i class="fas fa-star"></i> 0.0';
        document.getElementById('stats-contrat-moyen').textContent = '0 $';
        document.getElementById('stats-taux-marketing').textContent = '0%';
        document.getElementById('stats-taux-vente').textContent = '0%';
        document.getElementById('stats-dollars-produit').textContent = '0 $';
        document.getElementById('stats-prod-horaire').textContent = '0 $/h';
        document.getElementById('stats-heures-pap').textContent = '0.0 h';
      }

      // Charger les badges obtenus - Utiliser le bon endpoint
      try {
        const badgesResponse = await fetch(`/api/gamification/badges/user/${username}`);
        if (badgesResponse.ok) {
          const badgesData = await badgesResponse.json();
          const badgesGrid = document.getElementById('stats-badges-grid');

          console.log('Badges response:', badgesData);

          let badges = [];

          // Format attendu: {status: 'success', badges: [...]}
          if (badgesData.badges && Array.isArray(badgesData.badges)) {
            badges = badgesData.badges;
          } else if (Array.isArray(badgesData)) {
            badges = badgesData;
          }

          console.log('Badges trouv√©s:', badges.length);
          if (badges.length > 0) {
            console.log('Premier badge:', badges[0]);
          }

          if (badges.length > 0) {
            // Fonction helper pour cr√©er un badge item
            const createBadgeItem = (badge, showRarity = false) => {
              const badgeItem = document.createElement('div');
              badgeItem.className = 'badge-item';

              const imageUrl = badge.image_url || badge.icon_url || '';
              const emoji = badge.image || badge.icon || badge.emoji || '';
              const badgeName = badge.name || badge.badge_name || badge.title || 'Badge';
              const rarity = badge.rarity || badge.rarete || 'Commun';
              const description = badge.description || 'Aucune description disponible';
              const xpBonus = badge.xp_bonus || badge.xp || 0;
              const badgeCount = badge.count || 1;

              // PRIORISER image_url (PNG) sur icon (emoji) - M√äME LOGIQUE QUE GAMIFICATION.HTML
              let imageHTML = '';
              if (imageUrl && typeof imageUrl === 'string' && (imageUrl.startsWith('http') || imageUrl.startsWith('/static/'))) {
                // Priorit√© 1: PNG/URL dans image_url (externe ou local)
                imageHTML = `<img src="${imageUrl}" alt="${badgeName}" class="badge-image">`;
              } else if (emoji && typeof emoji === 'string' && (emoji.startsWith('http') || emoji.startsWith('/static/'))) {
                // Priorit√© 2: URL ou chemin local dans le champ icon/emoji
                imageHTML = `<img src="${emoji}" alt="${badgeName}" class="badge-image">`;
              } else if (emoji && typeof emoji === 'string' && emoji.endsWith('.png')) {
                // Priorit√© 3: Fichier PNG sans pr√©fixe /static/
                imageHTML = `<img src="/static/badges/${emoji}" alt="${badgeName}" class="badge-image">`;
              } else if (emoji && typeof emoji === 'string') {
                // Priorit√© 4: Emoji (texte/unicode)
                imageHTML = `<div class="badge-emoji">${emoji}</div>`;
              } else {
                // Fallback: pas d'image disponible
                imageHTML = `<div class="badge-emoji">üèÖ</div>`;
              }

              // Normaliser la raret√© pour la classe CSS
              const rarityClass = rarity.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]/g, '-');

              const rarityHTML = showRarity ? `<div class="badge-rarity ${rarityClass}">${rarity}</div>` : '';
              const countHTML = badgeCount > 1 ? `<div class="badge-count">x${badgeCount}</div>` : '';

              badgeItem.innerHTML = `
                ${countHTML}
                ${imageHTML}
                ${rarityHTML}
                <div class="badge-info-icon">
                  <i class="fas fa-info"></i>
                  <div class="badge-tooltip">
                    <div class="tooltip-title">${badgeName}</div>
                    <div class="tooltip-description">${description}</div>
                  </div>
                </div>
              `;
              return badgeItem;
            };

            // Grouper les badges par raret√© - M√äME ORDRE QUE GAMIFICATION.HTML
            const rarityOrderDisplay = ['Commun', 'Rare', 'L√©gendaire', 'Mythique', '√âpique', 'Anti-Badge'];
            const rarityOrderTop5 = ['Mythique', '√âpique', 'L√©gendaire', 'Rare', 'Commun']; // Pour TOP 5 (meilleurs d'abord)
            const badgesByRarity = {};

            // Initialiser les cat√©gories
            rarityOrderDisplay.forEach(r => badgesByRarity[r] = []);

            // Grouper les badges
            badges.forEach(badge => {
              const rarity = badge.rarity || badge.rarete || 'Commun';
              if (!badgesByRarity[rarity]) {
                badgesByRarity[rarity] = [];
              }
              badgesByRarity[rarity].push(badge);
            });

            // === TOP 5 MEILLEURS BADGES (par raret√© - du meilleur au pire) ===
            const topBadgesContainer = document.getElementById('stats-badges-top');
            topBadgesContainer.innerHTML = '';

            const topBadges = [];
            rarityOrderTop5.forEach(rarity => {
              const rarityBadges = badgesByRarity[rarity];
              if (rarityBadges && rarityBadges.length > 0) {
                topBadges.push(...rarityBadges);
              }
            });

            // Prendre les 5 premiers (les plus rares)
            const top5 = topBadges.slice(0, 5);
            if (top5.length > 0) {
              top5.forEach(badge => {
                topBadgesContainer.appendChild(createBadgeItem(badge, true)); // Afficher la raret√©
              });
            } else {
              topBadgesContainer.innerHTML = '<div class="no-badges-message">Aucun badge</div>';
            }

            // === TOUS LES BADGES PAR RARET√â (cach√© par d√©faut) - DU PIRE AU MEILLEUR ===
            badgesGrid.innerHTML = '';

            rarityOrderDisplay.forEach(rarity => {
              const rarityBadges = badgesByRarity[rarity];
              if (rarityBadges && rarityBadges.length > 0) {
                // TRIER PAR COUNT (du plus grand au plus petit: x4, x3, x2, x1)
                const sortedBadges = rarityBadges.sort((a, b) => {
                  const countA = a.count || 1;
                  const countB = b.count || 1;
                  return countB - countA; // Ordre d√©croissant
                });

                const rarityClass = rarity.toLowerCase()
                  .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                  .replace(/[^a-z0-9]/g, '-');

                const raritySection = document.createElement('div');
                raritySection.className = 'rarity-section';

                const rarityTitle = document.createElement('div');
                rarityTitle.className = 'rarity-section-title';
                rarityTitle.innerHTML = `
                  <span class="badge-rarity ${rarityClass}">${rarity}</span>
                  <span class="rarity-badge-count">${sortedBadges.length}</span>
                `;
                raritySection.appendChild(rarityTitle);

                const scrollContainer = document.createElement('div');
                scrollContainer.className = 'badges-horizontal-scroll';

                sortedBadges.forEach(badge => {
                  scrollContainer.appendChild(createBadgeItem(badge));
                });

                raritySection.appendChild(scrollContainer);
                badgesGrid.appendChild(raritySection);
              }
            });
          } else {
            document.getElementById('stats-badges-top').innerHTML = '<div class="no-badges-message">Aucun badge obtenu pour le moment</div>';
            badgesGrid.innerHTML = ''; // Laisser vide si aucun badge
          }

          // Activer le drag-to-scroll sur tous les containers horizontaux (desktop uniquement)
          document.querySelectorAll('.badges-horizontal-scroll').forEach(container => {
            // Ne pas activer le drag-to-scroll sur mobile
            if (window.innerWidth <= 600) {
              container.style.cursor = 'default';
              container.style.scrollBehavior = 'auto';
              return;
            }

            let isDown = false;
            let startX;
            let scrollLeft;
            let isDragging = false;

            container.addEventListener('mousedown', (e) => {
              // Ne pas commencer le drag si on clique sur un bouton ou lien
              if (e.target.closest('button') || e.target.closest('a')) return;

              isDown = true;
              isDragging = false;
              container.style.cursor = 'grabbing';
              container.style.userSelect = 'none';
              startX = e.pageX - container.offsetLeft;
              scrollLeft = container.scrollLeft;
            });

            container.addEventListener('mouseleave', () => {
              isDown = false;
              container.style.cursor = 'grab';
              container.style.userSelect = 'auto';
            });

            container.addEventListener('mouseup', (e) => {
              isDown = false;
              container.style.cursor = 'grab';
              container.style.userSelect = 'auto';

              // Emp√™cher le clic si on a drag
              if (isDragging) {
                e.preventDefault();
                e.stopPropagation();
              }
              isDragging = false;
            });

            container.addEventListener('mousemove', (e) => {
              if (!isDown) return;
              e.preventDefault();
              isDragging = true;
              const x = e.pageX - container.offsetLeft;
              const walk = (x - startX) * 1.5; // Vitesse de scroll plus fluide
              container.scrollLeft = scrollLeft - walk;
            });

            // Bloquer les clics sur les badges pendant le drag
            container.addEventListener('click', (e) => {
              if (isDragging) {
                e.preventDefault();
                e.stopPropagation();
              }
            }, true);

            // D√©finir le curseur initial
            container.style.cursor = 'grab';
            container.style.scrollBehavior = 'auto';
          });
        }
      } catch (error) {
        console.error('Erreur chargement badges:', error);
        document.getElementById('stats-badges-grid').innerHTML = '<div class="no-badges-message">Erreur de chargement des badges</div>';
      }
    }

    // Fermer le modal en cliquant sur le fond
    document.addEventListener('click', (e) => {
      const modal = document.getElementById('stats-modal');
      if (e.target === modal) {
        closeStatsModal();
      }
    });

    // ================================================================
    // MOBILE PROFILE MENU
    // ================================================================

    // Toggle mobile profile dropdown
    function toggleMobileProfileMenu() {
      const dropdown = document.getElementById('mobile-profile-dropdown');
      if (dropdown) {
        dropdown.classList.toggle('hidden');
        dropdown.classList.toggle('show');
      }
    }

    // Fermer le dropdown mobile si on clique ailleurs
    document.addEventListener('click', function(event) {
      const container = document.querySelector('.mobile-profile-container');
      const dropdown = document.getElementById('mobile-profile-dropdown');

      if (container && dropdown && !container.contains(event.target)) {
        dropdown.classList.add('hidden');
        dropdown.classList.remove('show');
      }
    });

    // ================================================================
    // BOTTOM NAVIGATION ANIMATIONS - Exact comme app-shell.html
    // ================================================================

    // Variable pour tracker l'ic√¥ne s√©lectionn√©e
    if (typeof window.selectedIcon === 'undefined') {
      window.selectedIcon = null;
    }

    // Fonction pour s√©lectionner une ic√¥ne avec animations
    function selectIcon(iconNumber, title) {
      window.selectedIcon = iconNumber;

      // Donn√©es des ic√¥nes
      const icons = [
        { id: 1, title: 'RPO' },
        { id: 2, title: 'Travaux' },
        { id: 3, title: 'Dashboard' },
        { id: 4, title: 'Outils' },
        { id: 5, title: 'Gestions' }
      ];

      // Trouver les conteneurs des ic√¥nes
      const containers = document.querySelectorAll('.case-container');
      const iconContainers = document.querySelectorAll('.icon-container');
      const iconElements = document.querySelectorAll('.icon-container i');
      const titleElements = document.querySelectorAll('.icon-title');

      containers.forEach((container, index) => {
        const iconId = index + 1;
        const isSelected = iconId === window.selectedIcon;
        const iconContainer = iconContainers[index];
        const iconElement = iconElements[index];

        // Animer le conteneur de la case
        if (isSelected) {
          container.className = 'flex-2 case-container flex flex-col justify-center items-center h-full';
        } else {
          container.className = 'flex-1 case-container flex justify-center items-center h-full';
        }

        // Animer l'ic√¥ne avec transform
        if (isSelected) {
          iconContainer.classList.add('selected');
          iconContainer.classList.remove('shadow-lg');
          iconContainer.classList.add('shadow-xl');
          iconElement.classList.remove('text-sm');
          iconElement.classList.add('text-xl');
        } else {
          iconContainer.classList.remove('selected');
          iconContainer.classList.remove('shadow-xl');
          iconContainer.classList.add('shadow-lg');
          iconElement.classList.remove('text-xl');
          iconElement.classList.add('text-sm');
        }
      });

      // G√©rer les titres
      titleElements.forEach(title => title.remove());

      // Ajouter le nouveau titre pour l'ic√¥ne s√©lectionn√©e
      const selectedContainer = containers[iconNumber - 1];
      if (selectedContainer) {
        const titleSpan = document.createElement('span');
        titleSpan.className = 'text-xs font-medium mt-1 icon-title show';
        titleSpan.style.color = '#ffffff';
        titleSpan.textContent = icons[iconNumber - 1].title;
        selectedContainer.appendChild(titleSpan);
      }

      console.log(`Ic√¥ne ${iconNumber} s√©lectionn√©e: ${icons[iconNumber - 1].title}`);
    }

    // Fonction pour d√©s√©lectionner toutes les ic√¥nes
    function deselectAllIcons() {
      const iconContainers = document.querySelectorAll('.icon-container');
      const containers = document.querySelectorAll('.case-container');
      const iconElements = document.querySelectorAll('.icon-container i');
      const titleElements = document.querySelectorAll('.icon-title');

      iconContainers.forEach((iconContainer) => {
        iconContainer.classList.remove('selected');
        iconContainer.classList.remove('shadow-xl');
        iconContainer.classList.add('shadow-lg');
        iconContainer.style.transform = '';
      });

      containers.forEach((container) => {
        container.className = 'flex-1 case-container flex justify-center items-center h-full';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
      });

      iconElements.forEach((iconElement) => {
        iconElement.classList.remove('text-xl');
        iconElement.classList.add('text-sm');
      });

      titleElements.forEach(title => title.remove());
      window.selectedIcon = null;

      console.log('Toutes les ic√¥nes d√©s√©lectionn√©es');
    }

    // Fonction pour mapper les pages aux ic√¥nes
    function setActiveNavIcon(page) {
      const pageMapping = {
        'rpo': 1,
        'travaux': 2,
        'dashboard': 3,
        'outils': 4,
        'calcul': 4,        // Calcul fait partie de Outils
        'calculateur': 4,   // Alias pour calcul
        'soumissions': 4,   // Soumissions fait partie de Outils
        'gestions': 5
      };

      // Pages qui ne correspondent √† aucune ic√¥ne de navigation
      const noIconPages = ['connection', 'login'];

      if (noIconPages.includes(page)) {
        deselectAllIcons();
        return;
      }

      const iconNumber = pageMapping[page] || 3;
      const titles = ['RPO', 'Travaux', 'Dashboard', 'Calcul', 'Soumissions'];
      selectIcon(iconNumber, titles[iconNumber - 1]);
    }

    // ================================================================
    // TOOLTIP PERSONNALISE POUR MENU
    // ================================================================

    function initMenuTooltips() {
      // Les tooltips sont maintenant g√©r√©s par CSS uniquement (style Qwota Lite)
      // Cette fonction reste pour compatibilit√© mais ne fait rien
    }

    // ================================================================
    // INITIALISATION
    // ================================================================

    document.addEventListener('DOMContentLoaded', () => {
      router.init();
      loadUserInfo();
      initMenuTooltips();

      // Facturation QE reste verrouill√©e pour les entrepreneurs
      const userRole = localStorage.getItem('role');
      if (userRole === 'entrepreneur' || userRole === 'beta') {
        const navFacturationQe = document.getElementById('nav-facturationqe');

        if (navFacturationQe) {
          navFacturationQe.style.pointerEvents = 'none';
          navFacturationQe.style.opacity = '0.5';
          navFacturationQe.style.cursor = 'not-allowed';
          console.log('[LOCK] Facturation QE verrouill√©e pour entrepreneur');
        }
      }

      console.log('[LAUNCH] Qwota SPA initialized');

      // Variable globale pour savoir si le guide est complete
      window.guideIsCompleted = null; // sera defini apres verification API

      // Fonction pour demarrer le prechargement (appelee seulement si guide complete)
      async function startPreloading() {
        console.log('[PRELOAD] D√©marrage startPreloading() - window.guideIsCompleted:', window.guideIsCompleted);

        // Attendre que window.guideIsCompleted soit defini par le router
        let attempts = 0;
        const maxAttempts = 50; // 5 secondes max

        while (window.guideIsCompleted === null && attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
        }

        console.log('[PRELOAD] Apr√®s polling - window.guideIsCompleted:', window.guideIsCompleted, 'attempts:', attempts);

        // Si le guide n'est pas complete, ne rien precharger
        if (window.guideIsCompleted === false) {
          console.log('[PRELOAD] Guide non complete - pas de prechargement');
          // Cacher l ecran de chargement et afficher l app
          const loadingOverlay = document.getElementById('loading-overlay');
          const appContainer = document.getElementById('app-container');
          if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
          }
          if (appContainer) {
            appContainer.classList.add('loaded');
            appContainer.style.opacity = '1';
          }
          return;
        }

        console.log('[PRELOAD] Guide complete - demarrage du prechargement');
        doPreloadPages();
      }

      // ================================================================
      // NOUVEAU SYST√àME OPTIMIS√â - Chargement ultra-rapide
      // ================================================================
      function doPreloadPages() {
      // DESKTOP & MOBILE: Chargement optimis√© intelligent
      console.log('[OPTIMIZED] üöÄ D√âMARRAGE DU SYST√àME DE CHARGEMENT ULTRA-RAPIDE');

      const isDesktop = window.innerWidth > 768;
      const deviceType = isDesktop ? 'DESKTOP' : 'MOBILE';

      // ‚ö° IMPORTANT: Vider TOUTES les iframes au d√©marrage
      // Pour que chaque refresh recharge tout avec des donn√©es fra√Æches
      console.log(`[${deviceType}] üóëÔ∏è Vidage de toutes les iframes (cache reset)...`);
      document.querySelectorAll('.page-iframe').forEach(iframe => {
        if (iframe.id !== 'iframe-dashboard') { // Garder dashboard
          iframe.src = '';
          iframe.style.display = 'none';
        }
      });

      // Fonction pour masquer l'ecran de chargement
      const hideLoadingScreen = () => {
        const loadingOverlay = document.getElementById('loading-overlay');
        const appContainer = document.getElementById('app-container');

        if (loadingOverlay) {
          console.log(`[${deviceType}] Masquage de l ecran de chargement`);
          loadingOverlay.classList.add('hidden');

          if (appContainer) {
            appContainer.classList.add('loaded');
            appContainer.style.opacity = '1';
          }
        }
      };

      // ‚ö° √âTAPE 1: Charger SEULEMENT Dashboard au d√©marrage (< 2 secondes)
      const dashboardIframe = document.getElementById('iframe-dashboard');
      if (dashboardIframe) {
        console.log(`[${deviceType}] ‚ö° CHARGEMENT PRIORITAIRE: Dashboard uniquement`);

        dashboardIframe.addEventListener('load', function() {
          console.log(`[${deviceType}] ‚úÖ Dashboard charg√© - D√©marrage du pr√©chargement...`);
          // ‚ö° NE PAS masquer l'√©cran de chargement ici - attendre que TOUTES les pages soient pr√©charg√©es

          // üîÑ √âTAPE 2: Pr√©charger les autres pages en arri√®re-plan (par priorit√©)
          setTimeout(() => {
            startBackgroundPreloading();
          }, 500); // Attendre 500ms que l'utilisateur voit le dashboard

        }, { once: true });

        // ‚ö° Ajouter le param√®tre ?user= au dashboard aussi
        const username = window.username || localStorage.getItem('username');
        const dashboardUrl = username ? `/dashboard?user=${username}` : '/dashboard';
        dashboardIframe.src = dashboardUrl;
        dashboardIframe.style.display = 'block';
      }

      // üîÑ PR√âCHARGEMENT EN ARRI√àRE-PLAN (pages par priorit√©)
      function startBackgroundPreloading() {
        console.log(`[${deviceType}] üîÑ D√©marrage du pr√©chargement en arri√®re-plan...`);

        // ‚ö° INITIALISER la barre de progression
        const progressFill = document.getElementById('loading-progress-fill');
        const progressText = document.getElementById('loading-progress-text');

        if (progressFill) progressFill.style.width = '0%';
        if (progressText) progressText.textContent = '0%';

        // ‚ö° IMPORTANT: R√©cup√©rer le username pour l'ajouter aux URLs
        const username = window.username || localStorage.getItem('username');

        // Pages par ordre de priorit√©
        const preloadQueue = [
          // PRIORIT√â 1: Pages les plus utilis√©es (charger en premier)
          { id: 'rpo', url: '/rpo', name: 'RPO', priority: 1 },
          { id: 'calcul', url: '/calcul', name: 'Calculateur', priority: 1 },
          { id: 'facture', url: '/facture', name: 'Facture', priority: 1 },

          // PRIORIT√â 2: Pages courantes
          { id: 'soumissions', url: '/soumissions', name: 'Soumissions', priority: 2 },
          { id: 'gqp', url: '/gqp', name: 'GQP', priority: 2 },
          { id: 'connection', url: '/connection', name: 'Parametres', priority: 2 },

          // PRIORIT√â 3: Pages secondaires
          { id: 'gestionemployes', url: '/gestionemployes', name: 'Gestion Employes', priority: 3 },
          { id: 'ventes', url: '/ventes', name: 'Ventes', priority: 3 },
          { id: 'facturationqe', url: '/facturationqe', name: 'Facturation QE', priority: 3 },
          { id: 'centralevue', url: '/centralevue', name: 'Centrale Vue', priority: 3 },
          { id: 'gamification', url: '/gamification', name: 'Gamification', priority: 3 },

          // PRIORIT√â 4: Pages rarement utilis√©es
          { id: 'avis', url: '/avis', name: 'Avis', priority: 4 },
          { id: 'travaux', url: '/travaux', name: 'Travaux', priority: 4 },
          { id: 'centrale', url: '/centrale', name: 'Centrale', priority: 4 },
          { id: 'centraleadmin', url: '/centraleadmin', name: 'Centrale Admin', priority: 4 }
        ];

        let loadedCount = 0;
        const totalPages = preloadQueue.length;

        // ‚ö° NOUVEAU: Charger par BATCH (3-4 pages en parall√®le √† la fois)
        // Plus rapide que une par une, mais moins lourd que tout en m√™me temps
        const BATCH_SIZE = 4; // Charger 4 pages en parall√®le
        let currentBatchIndex = 0;

        function loadNextBatch() {
          const startIndex = currentBatchIndex * BATCH_SIZE;
          const endIndex = Math.min(startIndex + BATCH_SIZE, totalPages);

          if (startIndex >= totalPages) {
            console.log(`[${deviceType}] üéâ TOUTES LES PAGES PR√âCHARG√âES (${loadedCount}/${totalPages})`);

            // ‚ö° MASQUER L'√âCRAN DE CHARGEMENT maintenant que TOUT est pr√©charg√©
            hideLoadingScreen();

            // ‚ö° HIGHLIGHTER le menu Dashboard (pas l'ancienne page)
            if (typeof window.appShell !== 'undefined' && window.appShell.updateActiveMenu) {
              window.appShell.updateActiveMenu('dashboard');
            } else {
              // Fallback: mettre √† jour manuellement
              document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === 'dashboard') {
                  item.classList.add('active');
                }
              });
            }

            return;
          }

          const batch = preloadQueue.slice(startIndex, endIndex);
          console.log(`[${deviceType}] üì¶ Chargement batch ${currentBatchIndex + 1} (${batch.length} pages)...`);

          let batchLoaded = 0;
          let batchCompleted = false; // ‚ö° FIX: Emp√™cher le double-incr√©ment

          batch.forEach((page) => {
            const iframe = document.getElementById(`iframe-${page.id}`);
            const srcAttr = iframe ? iframe.getAttribute('src') : null;
            const needsLoading = !srcAttr || srcAttr === '' || srcAttr === 'about:blank';

            if (iframe && needsLoading) {
              console.log(`[${deviceType}] ‚è≥ [P${page.priority}]: ${page.name}`);

              // ‚ö° CRUCIAL: Rendre l'iframe VRAIMENT visible (hors √©cran) pour forcer
              // le t√©l√©chargement de TOUTES les ressources (HTML, CSS, JS, Google Maps, Tailwind, etc.)
              // Si opacity:0 ou display:none, le navigateur optimise et skip le t√©l√©chargement!
              iframe.style.display = 'block';
              iframe.style.visibility = 'visible'; // IMPORTANT: pas hidden!
              iframe.style.position = 'fixed';
              iframe.style.top = '-9999px'; // Hors √©cran (invisible mais le navigateur charge tout)
              iframe.style.left = '-9999px';
              iframe.style.zIndex = '-9999';
              iframe.style.pointerEvents = 'none';

              iframe.addEventListener('load', function() {
                loadedCount++;
                batchLoaded++;
                console.log(`[${deviceType}] ‚úì (${loadedCount}/${totalPages}): ${page.name}`);

                // ‚ö° METTRE √Ä JOUR LA BARRE DE PROGRESSION
                const progress = Math.round((loadedCount / totalPages) * 100);
                const progressFill = document.getElementById('loading-progress-fill');
                const progressText = document.getElementById('loading-progress-text');

                if (progressFill) {
                  progressFill.style.width = `${progress}%`;
                }
                if (progressText) {
                  progressText.textContent = `${progress}%`;
                }

                // Attendre 500ms APR√àS le load pour que TOUS les scripts/CSS se chargent
                setTimeout(() => {
                  // Re-cacher l'iframe maintenant que TOUT est en cache (HTML + CSS + JS)
                  iframe.style.display = 'none';
                  iframe.style.visibility = '';
                  iframe.style.position = '';
                  iframe.style.top = '';
                  iframe.style.left = '';
                  iframe.style.zIndex = '';
                  iframe.style.pointerEvents = '';
                  console.log(`[${deviceType}] üíæ HTML + CSS + JS en cache: ${page.name}`);

                  // ‚ö° FIX: Emp√™cher le double-incr√©ment avec flag
                  // Quand tout le batch est charg√©, charger le batch suivant
                  if (batchLoaded === batch.length && !batchCompleted) {
                    batchCompleted = true; // Marquer comme compl√©t√©
                    currentBatchIndex++;
                    // Petit d√©lai entre les batchs pour ne pas surcharger
                    setTimeout(loadNextBatch, 50);
                  }
                }, 500); // Attendre 500ms pour que TOUS les scripts/CSS async se chargent
              }, { once: true });

              // ‚ö° IMPORTANT: Ajouter le param√®tre ?user= pour √©viter le rechargement lors de la navigation
              const urlWithUser = username ? `${page.url}?user=${username}` : page.url;
              iframe.src = urlWithUser;
            } else {
              // Si d√©j√† charg√©e, compter quand m√™me
              batchLoaded++;
              // ‚ö° FIX: Emp√™cher le double-incr√©ment avec flag
              if (batchLoaded === batch.length && !batchCompleted) {
                batchCompleted = true; // Marquer comme compl√©t√©
                currentBatchIndex++;
                setTimeout(loadNextBatch, 10);
              }
            }
          });
        }

        // D√©marrer le pr√©chargement par batch
        loadNextBatch();
      }

      } // Fin de doPreloadPages()

      // Appeler startPreloading - il attendra que window.guideIsCompleted soit defini
      startPreloading();

      // ===== SWIPE NAVIGATION SUR MOBILE AVEC ANIMATION FLUIDE =====
      if (window.innerWidth <= 600) {
        console.log('[SWIPE] Initialisation de la navigation par swipe avec animation fluide');

        const swipeOverlay = document.getElementById('swipe-overlay');
        const appContent = document.getElementById('app-content');

        if (!swipeOverlay) {
          console.error('[SWIPE] Overlay non trouv√©!');
          return;
        }

        // Ordre des pages pour la navigation par swipe
        const pageOrder = ['rpo', 'travaux', 'dashboard', 'outils', 'gestions'];

        // Variables pour le swipe
        let touchStartX = 0;
        let touchStartY = 0;
        let currentX = 0;
        let isSwiping = false;
        let currentIframe = null;
        let nextIframe = null;
        let swipeDirection = null;
        let touchId = null;

        const swipeThreshold = 30; // Seuil pour valider le swipe (en pixels) - r√©duit pour mobile
        const screenWidth = window.innerWidth;

        const swipeZoneLeft = document.getElementById('swipe-zone-left');
        const swipeZoneRight = document.getElementById('swipe-zone-right');

        // Fonction pour setup une zone
        function setupZone(zone) {
          zone.addEventListener('touchstart', function(e) {
            if (isSwiping) return;

            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            currentX = touchStartX;

            console.log('[SWIPE] üéØ Touch sur zone √† x:', touchStartX.toFixed(0), 'y:', touchStartY.toFixed(0));
          }, { passive: true });

          zone.addEventListener('touchmove', function(e) {
            const touch = e.touches[0];
            currentX = touch.clientX;
            const currentY = touch.clientY;

            const deltaX = currentX - touchStartX;
            const deltaY = currentY - touchStartY;
            const absDeltaX = Math.abs(deltaX);
            const absDeltaY = Math.abs(deltaY);

            // Si pas encore en swipe
            if (!isSwiping) {
              // Si trop vertical, abandonner
              if (absDeltaY > absDeltaX * 1.5) {
                return;
              }

              // Attendre mouvement horizontal
              if (absDeltaX < 25) return;

              // OK, swipe activ√©
              isSwiping = true;
              swipeDirection = deltaX > 0 ? 'right' : 'left';

              console.log('[SWIPE] ‚úÖ Swipe activ√©:', swipeDirection);

              e.preventDefault();

              // ACTIVER l'overlay
              swipeOverlay.classList.add('swiping-active');

              const currentPage = router.currentPage || 'dashboard';
              currentIframe = document.getElementById(`iframe-${currentPage}`);
              const currentIndex = pageOrder.indexOf(currentPage);

              // D√©terminer la page suivante
              let targetPage = null;
              if (swipeDirection === 'right' && currentIndex > 0) {
                targetPage = pageOrder[currentIndex - 1];
              } else if (swipeDirection === 'left' && currentIndex < pageOrder.length - 1) {
                targetPage = pageOrder[currentIndex + 1];
              }

              if (targetPage) {
                nextIframe = document.getElementById(`iframe-${targetPage}`);
                if (nextIframe) {
                  nextIframe.style.display = 'block';
                  if (swipeDirection === 'right') {
                    nextIframe.style.transform = 'translateX(-100%)';
                  } else {
                    nextIframe.style.transform = 'translateX(100%)';
                  }
                }
              }

              // D√©sactiver les transitions
              if (currentIframe) currentIframe.classList.add('swiping');
              if (nextIframe) nextIframe.classList.add('swiping');
            }

            // Animer si swipe actif
            if (isSwiping && nextIframe) {
              e.preventDefault();

              const limitedDeltaX = Math.max(-screenWidth, Math.min(screenWidth, deltaX));

              if (currentIframe) {
                currentIframe.style.transform = `translateX(${limitedDeltaX}px)`;
              }

              if (swipeDirection === 'right') {
                nextIframe.style.transform = `translateX(${-screenWidth + limitedDeltaX}px)`;
              } else {
                nextIframe.style.transform = `translateX(${screenWidth + limitedDeltaX}px)`;
              }
            }
          }, { passive: false });
        }

        // Setup les deux zones
        setupZone(swipeZoneLeft);
        setupZone(swipeZoneRight);

        console.log('[SWIPE] ‚úÖ Zones de swipe 1.25rem activ√©es');

        // L'overlay capture les mouvements SEULEMENT pendant un swipe actif
        swipeOverlay.addEventListener('touchmove', function(e) {
          if (!isSwiping || !nextIframe) return;

          e.preventDefault(); // Bloquer le scroll seulement pendant le swipe

          currentX = e.changedTouches[0].clientX;
          const deltaX = currentX - touchStartX;
          const limitedDeltaX = Math.max(-screenWidth, Math.min(screenWidth, deltaX));

          // D√©placer les pages en suivant le doigt
          if (currentIframe) {
            currentIframe.style.transform = `translateX(${limitedDeltaX}px)`;
          }

          if (swipeDirection === 'right') {
            nextIframe.style.transform = `translateX(${-screenWidth + limitedDeltaX}px)`;
          } else {
            nextIframe.style.transform = `translateX(${screenWidth + limitedDeltaX}px)`;
          }
        }, { passive: false });

        // D√©tecter la fin du touch
        document.addEventListener('touchend', function(e) {
          if (!isSwiping) {
            return;
          }

          // D√âSACTIVER l'overlay
          swipeOverlay.classList.remove('swiping-active');

          const deltaX = currentX - touchStartX;
          const absDeltaX = Math.abs(deltaX);

          // R√©activer les transitions
          if (currentIframe) currentIframe.classList.remove('swiping');
          if (nextIframe) nextIframe.classList.remove('swiping');

          // V√©rifier si le swipe doit √™tre valid√©
          if (absDeltaX > swipeThreshold && nextIframe) {
            // Swipe valid√© - compl√©ter l'animation
            if (currentIframe) {
              if (swipeDirection === 'right') {
                currentIframe.style.transform = 'translateX(100%)';
              } else {
                currentIframe.style.transform = 'translateX(-100%)';
              }
            }

            nextIframe.style.transform = 'translateX(0)';

            // Changer de page apr√®s l'animation
            setTimeout(() => {
              const currentPage = router.currentPage || 'dashboard';
              const currentIndex = pageOrder.indexOf(currentPage);

              let targetPage = null;
              if (swipeDirection === 'right' && currentIndex > 0) {
                targetPage = pageOrder[currentIndex - 1];
              } else if (swipeDirection === 'left' && currentIndex < pageOrder.length - 1) {
                targetPage = pageOrder[currentIndex + 1];
              }

              if (targetPage) {
                // Cacher l'ancienne page
                if (currentIframe) {
                  currentIframe.style.display = 'none';
                  currentIframe.style.transform = 'translateX(0)';
                }

                router.currentPage = targetPage;
                location.hash = `#/${targetPage}`;
                router.updateActiveMenu(targetPage);

                if (typeof setActiveNavIcon === 'function') {
                  setActiveNavIcon(targetPage);
                }
              }
            }, 300);

          } else {
            // Swipe annul√© - revenir √† la position initiale
            if (currentIframe) {
              currentIframe.style.transform = 'translateX(0)';
            }

            if (nextIframe) {
              if (swipeDirection === 'right') {
                nextIframe.style.transform = 'translateX(-100%)';
              } else {
                nextIframe.style.transform = 'translateX(100%)';
              }

              // Capturer nextIframe dans une variable locale pour le setTimeout
              const iframeToHide = nextIframe;

              // Cacher la page suivante apr√®s l'animation
              setTimeout(() => {
                iframeToHide.style.display = 'none';
                iframeToHide.style.transform = 'translateX(0)';
              }, 300);
            }
          }

          // R√©initialiser les √©tats
          isSwiping = false;
          nextIframe = null;
        }, { passive: true });

        console.log('[SWIPE] ‚úÖ Navigation par swipe fluide activ√©e - Pages:', pageOrder.join(' ‚Üí '));
      }

      // Fonction pour mettre √† jour le badge des plaintes
      async function updatePlaintesBadge() {
        const username = window.username || localStorage.getItem('username');
        if (!username) return;

        try {
          const response = await fetch(`/api/plaintes/${username}`);
          const data = await response.json();

          if (data.success) {
            const plaintesCount = (data.plaintes_actuelles || []).length;
            const badge = document.getElementById('plaintes-notification-badge');

            if (badge) {
              if (plaintesCount > 0) {
                badge.textContent = plaintesCount;
                badge.style.display = 'flex';
              } else {
                badge.style.display = 'none';
              }
            }
          }
        } catch (error) {
          console.error('Erreur lors de la mise √† jour du badge des plaintes:', error);
        }
      }

      // Fonction pour mettre √† jour le badge urgent de Facturation QE
      async function updateFacturationUrgentBadge() {
        const username = window.username || localStorage.getItem('username');
        if (!username) return;

        try {
          const response = await fetch(`/api/facturationqe/urgent-count/${username}`);
          const data = await response.json();

          if (data.success) {
            const urgentCount = data.urgent_count || 0;
            const badge = document.getElementById('facturationqe-urgent-badge');

            if (badge) {
              if (urgentCount > 0) {
                badge.textContent = urgentCount;
                badge.style.display = 'flex';
              } else {
                badge.style.display = 'none';
              }
            }
          }
        } catch (error) {
          console.error('Erreur lors de la mise √† jour du badge Facturation QE:', error);
        }
      }

      // Mettre √† jour les badges au chargement
      updatePlaintesBadge();
      updateFacturationUrgentBadge();

      // Exposer les fonctions globalement
      window.updatePlaintesBadge = updatePlaintesBadge;
      window.updateFacturationUrgentBadge = updateFacturationUrgentBadge;

      // √âcouter les messages des iframes pour mise √† jour instantan√©e du badge
      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'plainte-resolved') {
          console.log('[APPPC] Plainte r√©solue - mise √† jour du badge');
          updatePlaintesBadge();
        }
        if (event.data && event.data.type === 'facturation-urgent-updated') {
          console.log('[APPPC] Facturation mise √† jour - mise √† jour du badge urgent');
          updateFacturationUrgentBadge();
        }
      });

      // Heartbeat pour tracker les utilisateurs en ligne
      function sendHeartbeat() {
        const username = window.username || localStorage.getItem('username');
        if (username) {
          fetch('/api/users/heartbeat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username })
          }).catch(() => {});
        }
      }
      sendHeartbeat();
      setInterval(sendHeartbeat, 15000);

      // D√©connexion imm√©diate quand l'utilisateur quitte la page
      window.addEventListener('beforeunload', () => {
        const username = window.username || localStorage.getItem('username');
        if (username) {
          navigator.sendBeacon('/api/users/disconnect', JSON.stringify({ username }));
        }
      });
    });
  </script>

  <!-- ================================================================
       POPUP RECONNEXION GOOGLE
       ================================================================ -->
  <div id="google-reconnect-popup" class="google-reconnect-popup">
    <div class="google-reconnect-content" onclick="redirectToConnectGoogle()">
      <div class="google-reconnect-icon">
        <i class="fab fa-google"></i>
      </div>
      <div class="google-reconnect-text">
        <h3>Reconnexion requise</h3>
        <p>Veuillez vous reconnecter √† Google pour synchroniser votre agenda et courriel</p>
      </div>
      <div class="google-reconnect-arrow">
        <i class="fas fa-chevron-right"></i>
      </div>
    </div>
  </div>

  <!-- ================================================================
       POPUP MODIFICATIONS COMPTABLE
       ================================================================ -->
  <div id="modifications-comptable-popup" class="modifications-comptable-popup" style="display: none;">
    <div class="modifications-comptable-overlay"></div>
    <div class="modifications-comptable-content">
      <div class="modifications-comptable-header">
        <i class="fas fa-edit"></i>
        <h3>Modifications de la comptable</h3>
      </div>
      <div class="modifications-comptable-body" id="modifications-comptable-list">
        <!-- Liste des modifications -->
      </div>
      <div class="modifications-comptable-footer">
        <button class="btn-ok-modifications" onclick="fermerModificationsPopup()">
          <i class="fas fa-check"></i> OK, j'ai compris
        </button>
      </div>
    </div>
  </div>

  <style>
    .modifications-comptable-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modifications-comptable-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
    }
    .modifications-comptable-content {
      position: relative;
      background: #1a1a2e;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .modifications-comptable-header {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
    }
    .modifications-comptable-header i {
      font-size: 24px;
    }
    .modifications-comptable-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    .modifications-comptable-body {
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
    }
    .modification-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
      border-left: 3px solid #f59e0b;
    }
    .modification-item:last-child {
      margin-bottom: 0;
    }
    .modification-client {
      font-size: 16px;
      color: #fff;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .modification-client i {
      color: #f59e0b;
      margin-right: 6px;
    }
    .modification-soumission {
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 8px;
    }
    .modification-type {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .modification-montants {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
    }
    .montant-original {
      color: #ef4444;
      text-decoration: line-through;
    }
    .montant-fleche {
      color: #6b7280;
    }
    .montant-nouveau {
      color: #22c55e;
      font-weight: 600;
    }
    .modifications-comptable-footer {
      padding: 15px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: center;
    }
    .btn-ok-modifications {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      border: none;
      color: white;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }
    .btn-ok-modifications:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(34, 197, 94, 0.4);
    }
    /* Badge notification menu lat√©ral */
    #nav-facturationqe {
      position: relative;
    }
    .nav-badge-modifications {
      position: absolute;
      top: 50%;
      right: 12px;
      transform: translateY(-50%);
      min-width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      font-size: 12px;
      font-weight: 700;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
      box-shadow: 0 2px 6px rgba(245, 158, 11, 0.5);
    }
  </style>

  <script>
    // ================================================================
    // V√âRIFICATION CONNEXION GOOGLE AU D√âMARRAGE
    // ================================================================
    async function checkGoogleConnections() {
      const username = localStorage.getItem('username');
      if (!username) return;

      try {
        // V√©rifier les deux connexions en parall√®le
        const [agendaResponse, emailResponse] = await Promise.all([
          fetch(`/is-agenda-linked?username=${encodeURIComponent(username)}`),
          fetch(`/email-connecte?username=${encodeURIComponent(username)}`).catch(() => ({ ok: false }))
        ]);

        const agendaData = await agendaResponse.json();
        const isAgendaLinked = agendaData.linked === true;
        const isEmailLinked = emailResponse.ok;

        console.log('[GOOGLE CHECK] Agenda:', isAgendaLinked, 'Email:', isEmailLinked);

        // Si au moins une des deux n'est pas connect√©e, afficher le popup
        if (!isAgendaLinked || !isEmailLinked) {
          showGoogleReconnectPopup();
        }
      } catch (error) {
        console.error('[GOOGLE CHECK] Erreur:', error);
      }
    }

    function showGoogleReconnectPopup() {
      const popup = document.getElementById('google-reconnect-popup');
      if (popup) {
        popup.classList.add('active');
      }
    }

    function hideGoogleReconnectPopup() {
      const popup = document.getElementById('google-reconnect-popup');
      if (popup) {
        popup.classList.remove('active');
      }
    }

    function redirectToConnectGoogle() {
      // Cacher le popup
      hideGoogleReconnectPopup();
      // Naviguer vers la page de connexion agenda
      router.loadPage('connection');
    }

    // V√©rifier les connexions Google apr√®s que l'app soit compl√®tement charg√©e
    // On √©coute quand l'√©cran de chargement est masqu√©
    function waitForAppLoadedThenCheckGoogle() {
      const loadingOverlay = document.getElementById('loading-overlay');
      if (loadingOverlay && loadingOverlay.classList.contains('hidden')) {
        // L'app est charg√©e, v√©rifier les connexions Google
        setTimeout(checkGoogleConnections, 500);
      } else {
        // L'app n'est pas encore charg√©e, r√©essayer
        setTimeout(waitForAppLoadedThenCheckGoogle, 500);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Attendre que l'app soit compl√®tement charg√©e
      waitForAppLoadedThenCheckGoogle();

      // V√©rifier les notifications de modifications comptable (badge seulement, pas de popup)
      setTimeout(() => {
        checkModificationsComptable(false);
      }, 1000);
    });

    // ================================================================
    // NOTIFICATIONS MODIFICATIONS COMPTABLE
    // ================================================================
    async function checkModificationsComptable(showPopup = true) {
      const username = localStorage.getItem('username');
      if (!username) return;

      try {
        const response = await fetch(`/api/notifications/modifications/${encodeURIComponent(username)}`);
        if (!response.ok) return;

        const data = await response.json();
        const count = data.notifications ? data.notifications.length : 0;

        // Mettre √† jour le badge
        updateBadgeModifications(count);

        // Afficher le popup seulement si demand√© et s'il y a des notifications
        if (showPopup && data.success && data.notifications && data.notifications.length > 0) {
          afficherModificationsPopup(data.notifications);
        }
      } catch (error) {
        console.error('[MODIFICATIONS COMPTABLE] Erreur:', error);
      }
    }

    function updateBadgeModifications(count) {
      const badge = document.getElementById('badge-modifications-comptable');
      if (!badge) return;

      if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }

    function afficherModificationsPopup(modifications) {
      const popup = document.getElementById('modifications-comptable-popup');
      const listContainer = document.getElementById('modifications-comptable-list');

      if (!popup || !listContainer) return;

      // Formater le montant pour l'affichage
      function formatMontant(montant) {
        const num = parseFloat(montant) || 0;
        return num.toLocaleString('fr-CA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' $';
      }

      // Formater le type de paiement
      function formatType(type) {
        const types = {
          'depot': 'D√©p√¥t',
          'paiement_final': 'Paiement final',
          'autres_paiements': 'Autre paiement',
          'remboursement': 'Remboursement'
        };
        return types[type] || type;
      }

      // G√©n√©rer le HTML pour chaque modification
      const html = modifications.map(mod => `
        <div class="modification-item">
          <div class="modification-client">
            <i class="fas fa-user"></i> ${mod.nom_client || 'Client'}
          </div>
          <div class="modification-soumission">
            <i class="fas fa-file-invoice"></i> Soumission #${mod.numero_soumission}
          </div>
          <div class="modification-type">${formatType(mod.type_paiement)}</div>
          <div class="modification-montants">
            <span class="montant-original">${formatMontant(mod.montant_original)}</span>
            <span class="montant-fleche"><i class="fas fa-arrow-right"></i></span>
            <span class="montant-nouveau">${formatMontant(mod.montant_modifie)}</span>
          </div>
        </div>
      `).join('');

      listContainer.innerHTML = html;
      popup.style.display = 'flex';
    }

    async function fermerModificationsPopup() {
      const username = localStorage.getItem('username');
      const popup = document.getElementById('modifications-comptable-popup');

      if (popup) {
        popup.style.display = 'none';
      }

      // Cacher le badge
      updateBadgeModifications(0);

      // Marquer comme vues dans le backend
      if (username) {
        try {
          await fetch(`/api/notifications/modifications/${encodeURIComponent(username)}/marquer-vues`, {
            method: 'POST'
          });
        } catch (error) {
          console.error('[MODIFICATIONS COMPTABLE] Erreur marquage vues:', error);
        }
      }
    }
  </script>

</body>
</html>
