<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration Support - Qwota</title>
  <link rel="icon" type="image/png" href="https://i.ibb.co/R4Bq6WVh/TES-MUTE-TH-O-10.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      color: #e2e8f0;
      min-height: 100vh;
      padding: 2rem;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 50% 0%, rgba(96, 165, 250, 0.03) 0%, transparent 50%);
      pointer-events: none;
      will-change: opacity;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    .header {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      margin-bottom: 2rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(96, 165, 250, 0.15);
      border: 1px solid rgba(96, 165, 250, 0.2);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 100%;
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.04) 0%, transparent 100%);
      pointer-events: none;
    }

    .header-top {
      padding: 1.75rem 2.5rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      position: relative;
      z-index: 1;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .brand-logo {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      color: white;
      box-shadow: 0 8px 24px rgba(96, 165, 250, 0.4);
      position: relative;
      overflow: hidden;
    }

    .brand-logo::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
      opacity: 0.5;
    }

    .header-title-section h1 {
      font-size: 1.875rem;
      font-weight: 800;
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 50%, #2563eb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.375rem;
      letter-spacing: -0.025em;
    }

    .header-title-section p {
      font-size: 0.875rem;
      color: rgba(148, 163, 184, 0.9);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1.25rem;
    }

    .quick-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .quick-action-btn {
      width: 44px;
      height: 44px;
      background: rgba(96, 165, 250, 0.1);
      border: 1px solid rgba(96, 165, 250, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #60a5fa;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .quick-action-btn:hover {
      background: rgba(96, 165, 250, 0.2);
      border-color: #60a5fa;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    .quick-action-btn .badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ef4444;
      color: white;
      font-size: 0.65rem;
      padding: 0.125rem 0.375rem;
      border-radius: 10px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0 0.875rem 0 0.375rem;
      background: rgba(96, 165, 250, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(96, 165, 250, 0.2);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      height: 44px;
    }

    .user-menu:hover {
      background: rgba(96, 165, 250, 0.2);
      border-color: #60a5fa;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-info {
      display: flex;
      align-items: center;
    }

    .user-name {
      font-size: 0.875rem;
      font-weight: 600;
      color: #e2e8f0;
      line-height: 1;
    }

    .user-role {
      display: none;
    }

    .logout-btn {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1));
      border: 1px solid rgba(239, 68, 68, 0.4);
      color: #fca5a5;
      padding: 0 1rem;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      height: 44px;
    }

    .logout-btn:hover {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(220, 38, 38, 0.2));
      border-color: #ef4444;
      color: #fee2e2;
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
    }

    .header-stats {
      padding: 1.5rem 2.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1.5rem;
      position: relative;
      z-index: 1;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.08) 0%, rgba(59, 130, 246, 0.05) 100%);
      border: 1px solid rgba(96, 165, 250, 0.2);
      border-radius: 16px;
      padding: 1.25rem 1.5rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.1), transparent);
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.12) 0%, rgba(59, 130, 246, 0.08) 100%);
      border-color: rgba(96, 165, 250, 0.4);
      box-shadow: 0 8px 24px rgba(96, 165, 250, 0.2);
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.875rem;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.2), rgba(59, 130, 246, 0.15));
      border: 1px solid rgba(96, 165, 250, 0.3);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #60a5fa;
      font-size: 1.125rem;
    }

    .stat-trend {
      font-size: 0.75rem;
      padding: 0.25rem 0.625rem;
      border-radius: 8px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .stat-trend.up {
      background: rgba(16, 185, 129, 0.15);
      color: #6ee7b7;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .stat-trend.down {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
      margin-bottom: 0.5rem;
      letter-spacing: -0.025em;
    }

    .stat-label {
      font-size: 0.8125rem;
      color: rgba(148, 163, 184, 0.9);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .main-content {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 2rem;
      height: calc(100vh - 160px);
      min-height: 900px;
    }

    .conversations-panel {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 1.75rem;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(96, 165, 250, 0.15);
      border: 1px solid rgba(96, 165, 250, 0.2);
      position: relative;
    }

    .conversations-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 100px;
      background: linear-gradient(180deg, rgba(96, 165, 250, 0.03) 0%, transparent 100%);
      border-radius: 24px 24px 0 0;
      pointer-events: none;
    }

    .conversations-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.25rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(96, 165, 250, 0.15);
      position: relative;
      z-index: 1;
    }

    .conversations-title {
      font-size: 1.25rem;
      font-weight: 700;
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .conversations-title i {
      -webkit-text-fill-color: #60a5fa;
      font-size: 1.125rem;
    }

    .refresh-btn {
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.1), rgba(59, 130, 246, 0.08));
      border: 1px solid rgba(96, 165, 250, 0.3);
      color: #60a5fa;
      padding: 0.625rem 1rem;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .refresh-btn:hover {
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.2), rgba(59, 130, 246, 0.15));
      border-color: #60a5fa;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    .refresh-btn i {
      transition: transform 0.6s ease;
    }

    .refresh-btn:hover i {
      transform: rotate(180deg);
    }

    .conversation-item {
      background: rgba(51, 65, 85, 0.4);
      padding: 1.125rem;
      border-radius: 14px;
      margin-bottom: 0.875rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .conversation-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.05), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .conversation-item:hover {
      background: rgba(51, 65, 85, 0.7);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .conversation-item:hover::before {
      opacity: 1;
    }

    .conversation-item.active {
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.2), rgba(59, 130, 246, 0.15));
      border-color: #60a5fa;
      box-shadow: 0 4px 20px rgba(96, 165, 250, 0.25);
    }

    .conversation-item.unread {
      border-left: 3px solid #60a5fa;
    }

    .conversation-user {
      font-weight: 600;
      color: #e2e8f0;
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .unread-badge {
      background: #60a5fa;
      color: white;
      font-size: 0.65rem;
      padding: 0.15rem 0.5rem;
      border-radius: 12px;
      font-weight: 600;
    }

    .conversation-preview {
      font-size: 0.875rem;
      color: rgba(226, 232, 240, 0.7);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-time {
      font-size: 0.75rem;
      color: rgba(148, 163, 184, 0.6);
      margin-top: 0.25rem;
    }

    .chat-panel {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(96, 165, 250, 0.15);
      border: 1px solid rgba(96, 165, 250, 0.2);
      position: relative;
      overflow: hidden;
    }

    .chat-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 150px;
      background: linear-gradient(180deg, rgba(96, 165, 250, 0.04) 0%, transparent 100%);
      pointer-events: none;
      z-index: 0;
    }

    .chat-header {
      padding: 1.75rem 2rem;
      border-bottom: 1px solid rgba(96, 165, 250, 0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 1;
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.02) 0%, transparent 100%);
    }

    .chat-user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .chat-user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.125rem;
      font-weight: 600;
      color: white;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    .chat-user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chat-user-details h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #e2e8f0;
    }

    .chat-user-details p {
      font-size: 0.875rem;
      color: rgba(226, 232, 240, 0.6);
    }

    .chat-messages {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: 600px;
    }

    .message {
      display: flex;
      gap: 1rem;
      max-width: 70%;
    }

    .message.user {
      align-self: flex-start;
    }

    .message.admin {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
    }

    .message.admin .message-avatar {
      background: none;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    .message.admin .message-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .message-content {
      flex: 1;
    }

    .message-bubble {
      background: rgba(51, 65, 85, 0.8);
      padding: 1rem 1.25rem;
      border-radius: 18px;
      color: #e2e8f0;
      word-wrap: break-word;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
      position: relative;
    }

    .message-bubble:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .message.admin .message-bubble {
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.25), rgba(59, 130, 246, 0.2));
      border: 1px solid rgba(96, 165, 250, 0.35);
      box-shadow: 0 4px 16px rgba(96, 165, 250, 0.15);
    }

    .message-image {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .message-image:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .message-time {
      font-size: 0.75rem;
      color: rgba(148, 163, 184, 0.6);
      margin-top: 0.25rem;
    }

    .chat-input-container {
      padding: 1.5rem 2rem;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
    }

    .chat-input-wrapper {
      display: flex;
      align-items: flex-end;
      gap: 0.5rem;
      position: relative;
    }

    .chat-input {
      flex: 1;
      background: rgba(51, 65, 85, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 0.625rem 1rem;
      color: #e2e8f0;
      font-size: 0.9375rem;
      resize: none;
      height: 42px;
      font-family: inherit;
      line-height: 1.5;
      overflow: hidden;
      box-sizing: border-box;
    }

    .chat-input:focus {
      outline: none;
      border-color: #60a5fa;
      background: rgba(51, 65, 85, 0.8);
    }

    .chat-input::placeholder {
      color: rgba(148, 163, 184, 0.6);
    }

    .send-btn {
      background: transparent;
      border: none;
      width: 42px;
      height: 42px;
      border-radius: 10px;
      color: #60a5fa;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .send-btn:hover {
      background: rgba(96, 165, 250, 0.1);
      color: #60a5fa;
    }

    .send-btn:active {
      transform: scale(0.9);
    }

    .send-btn i {
      font-size: 18px;
    }

    .chat-attach-btn {
      background: transparent;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      color: rgba(148, 163, 184, 0.7);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .chat-attach-btn:hover {
      background: rgba(148, 163, 184, 0.1);
      color: rgba(148, 163, 184, 0.9);
    }

    .chat-attach-btn:active {
      transform: scale(0.9);
    }

    .chat-attach-btn i {
      font-size: 18px;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 3rem;
    }

    .empty-state-icon {
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.1), rgba(59, 130, 246, 0.05));
      border: 2px solid rgba(96, 165, 250, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2rem;
      position: relative;
    }

    .empty-state-icon::before {
      content: '';
      position: absolute;
      inset: -10px;
      border-radius: 50%;
      border: 2px solid rgba(96, 165, 250, 0.15);
    }

    .empty-state-icon i {
      font-size: 3rem;
      color: #60a5fa;
    }

    .empty-state h3 {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.75rem;
    }

    .empty-state p {
      color: rgba(148, 163, 184, 0.8);
      font-size: 0.9375rem;
      max-width: 320px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(51, 65, 85, 0.8);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(71, 85, 105, 0.9);
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(96, 165, 250, 0.2);
      border-radius: 50%;
      border-top-color: #60a5fa;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .mark-read-btn {
      background: transparent;
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .mark-read-btn:hover {
      background: rgba(16, 185, 129, 0.1);
      border-color: #10b981;
    }

    .conversation-actions {
      display: flex;
      gap: 0.5rem;
    }

    .action-btn {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: rgba(226, 232, 240, 0.8);
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .action-btn:hover {
      background: rgba(96, 165, 250, 0.1);
      border-color: #60a5fa;
      color: #60a5fa;
    }

    .action-btn.danger:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
      color: #fca5a5;
    }

    .action-btn.success:hover {
      background: rgba(16, 185, 129, 0.1);
      border-color: #10b981;
      color: #6ee7b7;
    }

    /* Search Bar */
    .search-container {
      margin-bottom: 1rem;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 0.875rem 1rem 0.875rem 3rem;
      background: rgba(51, 65, 85, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      color: #e2e8f0;
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: #60a5fa;
      background: rgba(51, 65, 85, 0.7);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }

    .search-input::placeholder {
      color: rgba(148, 163, 184, 0.5);
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(148, 163, 184, 0.5);
      pointer-events: none;
    }

    /* Resolved Today Badge */
    .resolved-today {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1));
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 12px;
      padding: 0.875rem 1.25rem;
      margin-bottom: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .resolved-today-label {
      color: rgba(226, 232, 240, 0.8);
      font-size: 0.875rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .resolved-today-count {
      background: rgba(16, 185, 129, 0.2);
      color: #6ee7b7;
      font-size: 1.25rem;
      font-weight: 700;
      padding: 0.375rem 0.875rem;
      border-radius: 8px;
      min-width: 3rem;
      text-align: center;
    }

    /* Custom Popup */
    .custom-popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .custom-popup-overlay.active {
      display: flex;
    }

    .custom-popup {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border-radius: 20px;
      padding: 2rem;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(96, 165, 250, 0.2);
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .custom-popup-overlay.active .custom-popup {
      transform: scale(1);
      opacity: 1;
    }

    .custom-popup-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 1.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .custom-popup-icon.warning {
      background: rgba(239, 68, 68, 0.1);
      border: 2px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }

    .custom-popup-icon.success {
      background: rgba(16, 185, 129, 0.1);
      border: 2px solid rgba(16, 185, 129, 0.3);
      color: #6ee7b7;
    }

    .custom-popup-title {
      color: #e2e8f0;
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.75rem;
    }

    .custom-popup-message {
      color: rgba(226, 232, 240, 0.7);
      font-size: 0.9375rem;
      text-align: center;
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .custom-popup-buttons {
      display: flex;
      gap: 0.75rem;
    }

    .popup-btn {
      flex: 1;
      padding: 0.875rem;
      border: none;
      border-radius: 12px;
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .popup-btn.cancel {
      background: rgba(51, 65, 85, 0.6);
      color: rgba(226, 232, 240, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .popup-btn.cancel:hover {
      background: rgba(51, 65, 85, 0.8);
      border-color: rgba(148, 163, 184, 0.5);
    }

    .popup-btn.confirm {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: 1px solid rgba(239, 68, 68, 0.5);
    }

    .popup-btn.confirm:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .popup-btn.confirm.success {
      background: linear-gradient(135deg, #10b981, #059669);
      border: 1px solid rgba(16, 185, 129, 0.5);
    }

    .popup-btn.confirm.success:hover {
      background: linear-gradient(135deg, #059669, #047857);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    /* Filter Buttons */
    .filter-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.25rem;
    }

    .filter-btn {
      flex: 1;
      background: rgba(51, 65, 85, 0.4);
      border: 1px solid rgba(148, 163, 184, 0.2);
      color: rgba(226, 232, 240, 0.7);
      padding: 0.625rem 0.75rem;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.8125rem;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .filter-btn:hover {
      background: rgba(51, 65, 85, 0.6);
      border-color: rgba(96, 165, 250, 0.3);
      color: #e2e8f0;
      transform: translateY(-1px);
    }

    .filter-btn.active {
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.25), rgba(59, 130, 246, 0.2));
      border-color: #60a5fa;
      color: #60a5fa;
      box-shadow: 0 2px 8px rgba(96, 165, 250, 0.2);
    }

    .filter-btn i {
      font-size: 0.875rem;
    }

    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem 1.25rem;
      background: rgba(51, 65, 85, 0.6);
      border-radius: 18px;
      width: fit-content;
      margin-bottom: 1rem;
    }

    .typing-dots {
      display: flex;
      gap: 0.25rem;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: rgba(96, 165, 250, 0.6);
      border-radius: 50%;
      animation: typing 1.4s ease-in-out infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.6;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }

    /* Message Markdown Styling */
    .message-bubble strong {
      font-weight: 700;
      color: #f1f5f9;
    }

    .message-bubble em {
      font-style: italic;
      color: #cbd5e1;
    }

    .message-bubble code {
      background: rgba(15, 23, 42, 0.6);
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.875em;
      color: #60a5fa;
    }

    .message-bubble a {
      color: #60a5fa;
      text-decoration: none;
      border-bottom: 1px solid rgba(96, 165, 250, 0.3);
      transition: all 0.2s ease;
    }

    .message-bubble a:hover {
      border-bottom-color: #60a5fa;
      color: #3b82f6;
    }

    .message-bubble ul, .message-bubble ol {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }

    .message-bubble li {
      margin: 0.25rem 0;
    }

    /* Loading Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .conversation-item {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <!-- Header Top -->
      <div class="header-top">
        <div class="header-left">
          <div class="brand-logo">
            <i class="fas fa-headset"></i>
          </div>
          <div class="header-title-section">
            <h1>Administration Support</h1>
            <p>
              <span class="status-dot"></span>
              <span>En ligne • Qwota Platform</span>
            </p>
          </div>
        </div>
        <div class="header-right">
          <div class="quick-actions">
            <button class="quick-action-btn" title="Notifications" onclick="showNotifications()">
              <i class="fas fa-bell"></i>
              <span class="badge" id="notification-badge">0</span>
            </button>
            <button class="quick-action-btn" title="Paramètres" onclick="showSettings()">
              <i class="fas fa-cog"></i>
            </button>
            <button class="quick-action-btn" title="Aide" onclick="showHelp()">
              <i class="fas fa-question-circle"></i>
            </button>
          </div>
          <div class="user-menu" onclick="toggleUserMenu()">
            <div class="user-avatar" id="user-avatar">
              <img src="https://i.ibb.co/R4Bq6WVh/TES-MUTE-TH-O-10.png" alt="Qwota">
            </div>
            <div class="user-info">
              <div class="user-name" id="user-name">Support</div>
              <div class="user-role">Support</div>
            </div>
          </div>
          <button class="logout-btn" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
            Déconnexion
          </button>
        </div>
      </div>

      <!-- Header Stats -->
      <div class="header-stats">
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon">
              <i class="fas fa-comments"></i>
            </div>
            <div class="stat-trend up">
              <i class="fas fa-arrow-up"></i>
              12%
            </div>
          </div>
          <div class="stat-value" id="total-conversations">0</div>
          <div class="stat-label">
            <i class="fas fa-circle" style="font-size: 0.375rem; color: #60a5fa;"></i>
            Total Conversations
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon">
              <i class="fas fa-envelope"></i>
            </div>
            <div class="stat-trend down">
              <i class="fas fa-arrow-down"></i>
              5%
            </div>
          </div>
          <div class="stat-value" id="unread-count">0</div>
          <div class="stat-label">
            <i class="fas fa-circle" style="font-size: 0.375rem; color: #ef4444;"></i>
            Messages Non Lus
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-trend up">
              <i class="fas fa-arrow-up"></i>
              8%
            </div>
          </div>
          <div class="stat-value" id="avg-response-time">2.5</div>
          <div class="stat-label">
            <i class="fas fa-circle" style="font-size: 0.375rem; color: #10b981;"></i>
            Temps Moyen (min)
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon">
              <i class="fas fa-check-double"></i>
            </div>
            <div class="stat-trend up">
              <i class="fas fa-arrow-up"></i>
              15%
            </div>
          </div>
          <div class="stat-value" id="resolved-today">0</div>
          <div class="stat-label">
            <i class="fas fa-circle" style="font-size: 0.375rem; color: #10b981;"></i>
            Résolus Aujourd'hui
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Conversations List -->
      <div class="conversations-panel">
        <div class="conversations-header">
          <div class="conversations-title">
            <i class="fas fa-inbox"></i>
            Conversations
          </div>
        </div>

        <!-- Search Bar -->
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input
            type="text"
            class="search-input"
            id="search-input"
            placeholder="Rechercher une conversation..."
            oninput="searchConversations(this.value)"
          >
        </div>

        <!-- Filter Buttons -->
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="all" onclick="filterConversations('all')">
            <i class="fas fa-inbox"></i>
            Toutes
          </button>
          <button class="filter-btn" data-filter="unread" onclick="filterConversations('unread')">
            <i class="fas fa-envelope"></i>
            Non lues
          </button>
          <button class="filter-btn" data-filter="read" onclick="filterConversations('read')">
            <i class="fas fa-envelope-open"></i>
            Lues
          </button>
        </div>

        <div id="conversations-list">
          <!-- Conversations will be loaded here -->
        </div>
      </div>

      <!-- Chat Panel -->
      <div class="chat-panel">
        <div id="chat-content">
          <div class="empty-state">
            <div class="empty-state-icon">
              <i class="fas fa-comments"></i>
            </div>
            <h3>Sélectionnez une conversation</h3>
            <p>Choisissez une conversation dans la liste pour afficher les messages et commencer à répondre</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let selectedUsername = null;
    let messageCheckInterval = null;
    let conversationsCheckInterval = null;
    let allConversations = [];
    let currentFilter = 'all';

    // Vérifier l'authentification au chargement
    function checkAuth() {
      const username = window.username || localStorage.getItem('username');
      const userRole = localStorage.getItem('userRole');

      if (!username || userRole !== 'support') {
        // Rediriger vers la page de connexion si pas authentifié ou pas le bon rôle
        alert('Accès refusé. Cette page est réservée au personnel support.');
        window.location.href = '/';
        return false;
      }

      // Afficher le nom d'utilisateur dans le header
      const userNameEl = document.getElementById('user-name');
      if (userNameEl) userNameEl.textContent = username;

      return true;
    }

    // Fonction de déconnexion
    function handleLogout() {
      if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
        // Nettoyer le localStorage
        localStorage.removeItem('username');
        localStorage.removeItem('userRole');
        localStorage.removeItem('supportAuth');

        // Rediriger vers la page de connexion
        window.location.href = '/';
      }
    }

    // Vérifier l'authentification avant de charger la page
    if (!checkAuth()) {
      // Arrêter l'exécution du script si pas authentifié
      throw new Error('Authentification requise');
    }

    // Charger toutes les conversations
    async function loadConversations() {
      try {
        const response = await fetch('/api/support/all-conversations');
        if (response.ok) {
          const data = await response.json();
          allConversations = data.conversations || [];
          applyFiltersAndSearch();
          updateStats(allConversations);
        }
      } catch (error) {
        console.error('[ADMIN] Erreur chargement conversations:', error);
        allConversations = [];
        applyFiltersAndSearch();
      }
    }

    // Appliquer les filtres et la recherche
    function applyFiltersAndSearch() {
      let filtered = [...allConversations];

      // Appliquer le filtre
      if (currentFilter === 'unread') {
        filtered = filtered.filter(conv => (conv.unread_count || 0) > 0);
      } else if (currentFilter === 'read') {
        filtered = filtered.filter(conv => (conv.unread_count || 0) === 0);
      }

      // Appliquer la recherche
      const searchInput = document.getElementById('search-input');
      if (searchInput && searchInput.value.trim()) {
        const searchTerm = searchInput.value.toLowerCase();
        filtered = filtered.filter(conv =>
          conv.username.toLowerCase().includes(searchTerm) ||
          (conv.last_message || '').toLowerCase().includes(searchTerm)
        );
      }

      displayConversations(filtered);
    }

    // Rechercher dans les conversations
    function searchConversations(query) {
      applyFiltersAndSearch();
    }

    // Filtrer les conversations
    function filterConversations(filter) {
      currentFilter = filter;

      // Mettre à jour les boutons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-filter') === filter) {
          btn.classList.add('active');
        }
      });

      applyFiltersAndSearch();
    }

    // Afficher les conversations
    function displayConversations(conversations) {
      const container = document.getElementById('conversations-list');

      if (conversations.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: rgba(226, 232, 240, 0.5);">Aucune conversation</div>';
        return;
      }

      container.innerHTML = conversations.map(conv => {
        const unreadCount = conv.unread_count || 0;
        const lastMessage = conv.last_message || 'Aucun message';
        const time = formatTime(conv.last_message_time);
        const isActive = selectedUsername === conv.username;

        return `
          <div class="conversation-item ${isActive ? 'active' : ''} ${unreadCount > 0 ? 'unread' : ''}"
               onclick="selectConversation('${conv.username}')">
            <div class="conversation-user">
              ${conv.username}
              ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
            </div>
            <div class="conversation-preview">${lastMessage}</div>
            <div class="conversation-time">${time}</div>
          </div>
        `;
      }).join('');
    }

    // Mettre à jour les stats
    function updateStats(conversations) {
      const totalCount = conversations.length;
      const unreadCount = conversations.reduce((sum, conv) => sum + (conv.unread_count || 0), 0);

      document.getElementById('total-conversations').textContent = totalCount;
      document.getElementById('unread-count').textContent = unreadCount;
      document.getElementById('notification-badge').textContent = unreadCount;

      // Masquer le badge si 0
      const badge = document.getElementById('notification-badge');
      if (unreadCount === 0) {
        badge.style.display = 'none';
      } else {
        badge.style.display = 'block';
      }
    }

    // Afficher les notifications
    function showNotifications() {
      alert('Panneau de notifications (à implémenter)');
    }

    // Afficher les paramètres
    function showSettings() {
      alert('Panneau de paramètres (à implémenter)');
    }

    // Afficher l'aide
    function showHelp() {
      window.open('https://docs.qwota.com/support', '_blank');
    }

    // Toggle user menu
    function toggleUserMenu() {
      // Pour l'instant, on peut afficher un menu contextuel
      console.log('User menu clicked');
    }

    // Sélectionner une conversation
    async function selectConversation(username) {
      selectedUsername = username;

      // Arrêter l'interval précédent si existe
      if (messageCheckInterval) {
        clearInterval(messageCheckInterval);
        messageCheckInterval = null;
      }

      // Marquer comme lu
      await fetch(`/api/support/mark-read/${username}`, { method: 'POST' });

      // Retirer le badge visuellement
      const convElement = document.querySelector(`[onclick*="selectConversation('${username}')"]`);
      if (convElement) {
        // Retirer le badge
        const badge = convElement.querySelector('.unread-badge');
        if (badge) badge.remove();

        // Retirer la classe unread
        convElement.classList.remove('unread');
      }

      // Charger les messages
      loadMessages(username);
    }

    // Charger les messages d'une conversation
    async function loadMessages(username) {
      try {
        const response = await fetch(`/api/support/messages/${username}`);
        if (response.ok) {
          const data = await response.json();
          displayChat(username, data.messages);
        }
      } catch (error) {
        console.error('[ADMIN] Erreur chargement messages:', error);
      }
    }

    // Afficher le chat
    function displayChat(username, messages) {
      const chatContent = document.getElementById('chat-content');

      chatContent.innerHTML = `
        <div class="chat-header">
          <div class="chat-user-info">
            <div class="chat-user-avatar">${username[0].toUpperCase()}</div>
            <div class="chat-user-details">
              <h2>${username}</h2>
              <p>${messages.length} message(s)</p>
            </div>
          </div>
          <div class="conversation-actions">
            <button class="action-btn success" onclick="resolveConversation('${username}')" title="Marquer comme résolue">
              <i class="fas fa-check-circle"></i>
              Résolu
            </button>
            <button class="action-btn danger" onclick="deleteConversation('${username}')" title="Supprimer la conversation">
              <i class="fas fa-trash"></i>
              Supprimer
            </button>
          </div>
        </div>
        <div class="chat-messages" id="chat-messages">
          ${messages.length === 0 ? '<div class="empty-state"><p>Aucun message</p></div>' : ''}
        </div>
        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <input type="file" id="admin-file-input" accept="image/*" style="display: none;" onchange="handleAdminFileSelect(event)">
            <textarea
              id="admin-input"
              class="chat-input"
              placeholder="Tapez votre réponse..."
              rows="1"
              onkeydown="handleKeyDown(event)"
            ></textarea>
            <button class="chat-attach-btn" onclick="document.getElementById('admin-file-input').click()" title="Joindre une image">
              <i class="fas fa-paperclip"></i>
            </button>
            <button class="send-btn" onclick="sendMessage()">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      `;

      // Afficher les messages
      const messagesContainer = document.getElementById('chat-messages');
      messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.is_admin ? 'admin' : 'user'}`;

        const time = formatTime(msg.created_at);

        let imageHTML = '';
        if (msg.attachment_path && msg.attachment_type === 'image') {
          imageHTML = `<img src="/cloud/${msg.attachment_path}" alt="Image" class="message-image" onclick="window.open('/cloud/${msg.attachment_path}', '_blank')">`;
        }

        // Avatar conditionnel: logo pour admin, lettre pour user
        const avatarContent = msg.is_admin
          ? '<img src="https://i.ibb.co/R4Bq6WVh/TES-MUTE-TH-O-10.png" alt="Qwota">'
          : username[0].toUpperCase();

        messageDiv.innerHTML = `
          <div class="message-avatar">${avatarContent}</div>
          <div class="message-content">
            <div class="message-bubble">
              ${parseMarkdown(msg.message)}
              ${imageHTML}
            </div>
            <div class="message-time">${time}</div>
          </div>
        `;

        messagesContainer.appendChild(messageDiv);
      });

      // Scroll vers le bas
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Envoyer un message admin
    // Variable pour stocker le fichier sélectionné
    let adminSelectedFile = null;

    // Gérer la sélection de fichier
    function handleAdminFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Vérifier que c'est une image
      if (!file.type.startsWith('image/')) {
        alert('Seules les images sont acceptées');
        return;
      }

      // Vérifier la taille (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('L\'image est trop volumineuse (max 5MB)');
        return;
      }

      adminSelectedFile = file;
      console.log('[ADMIN] Fichier sélectionné:', file.name);
    }

    // Envoyer un message (avec ou sans fichier)
    async function sendMessage() {
      if (!selectedUsername) return;

      const input = document.getElementById('admin-input');
      const message = input.value.trim();

      if (!message && !adminSelectedFile) return;

      try {
        // Si un fichier est sélectionné, envoyer avec FormData
        if (adminSelectedFile) {
          const formData = new FormData();
          formData.append('username', selectedUsername);
          formData.append('message', message || 'Image envoyée');
          formData.append('file', adminSelectedFile);
          formData.append('is_admin', '1');

          const response = await fetch('/api/support/upload-attachment', {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            input.value = '';
            input.style.height = 'auto';
            adminSelectedFile = null;
            document.getElementById('admin-file-input').value = '';

            // Recharger les messages pour afficher le nouveau
            loadMessages(selectedUsername);
          }
        } else {
          // Envoi normal sans fichier
          const response = await fetch('/api/support/send-message', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              username: selectedUsername,
              message: message,
              is_admin: 1
            })
          });

          if (response.ok) {
            input.value = '';
            input.style.height = 'auto';

            // Recharger les messages pour afficher le nouveau
            loadMessages(selectedUsername);
          }
        }
      } catch (error) {
        console.error('[ADMIN] Erreur envoi message:', error);
      }
    }

    // Afficher un popup personnalisé
    function showCustomPopup(title, message, iconClass, confirmText, confirmClass, onConfirm) {
      const overlay = document.getElementById('custom-popup');
      const icon = document.getElementById('popup-icon');
      const titleEl = document.getElementById('popup-title');
      const messageEl = document.getElementById('popup-message');
      const confirmBtn = document.getElementById('popup-confirm');
      const cancelBtn = document.getElementById('popup-cancel');

      // Configurer le contenu
      titleEl.textContent = title;
      messageEl.textContent = message;
      confirmBtn.textContent = confirmText;

      // Configurer l'icône
      icon.className = `custom-popup-icon ${iconClass}`;
      icon.innerHTML = iconClass === 'warning'
        ? '<i class="fas fa-exclamation-triangle"></i>'
        : '<i class="fas fa-check-circle"></i>';

      // Configurer le bouton
      confirmBtn.className = `popup-btn confirm ${confirmClass}`;

      // Afficher le popup
      overlay.classList.add('active');

      // Gérer les événements
      const handleConfirm = () => {
        overlay.classList.remove('active');
        confirmBtn.removeEventListener('click', handleConfirm);
        cancelBtn.removeEventListener('click', handleCancel);
        onConfirm();
      };

      const handleCancel = () => {
        overlay.classList.remove('active');
        confirmBtn.removeEventListener('click', handleConfirm);
        cancelBtn.removeEventListener('click', handleCancel);
      };

      confirmBtn.addEventListener('click', handleConfirm);
      cancelBtn.addEventListener('click', handleCancel);

      // Fermer avec Escape
      const handleEscape = (e) => {
        if (e.key === 'Escape') {
          handleCancel();
          document.removeEventListener('keydown', handleEscape);
        }
      };
      document.addEventListener('keydown', handleEscape);
    }

    // Supprimer une conversation
    async function deleteConversation(username) {
      showCustomPopup(
        'Supprimer la conversation',
        `Voulez-vous vraiment supprimer la conversation avec ${username} ? Cette action est irréversible.`,
        'warning',
        'Supprimer',
        '',
        async () => {
          try {
            const response = await fetch(`/api/support/conversation/${username}`, { method: 'DELETE' });
            if (response.ok) {
              selectedUsername = null;
              document.getElementById('chat-content').innerHTML = `
                <div class="empty-state">
                  <div class="empty-state-icon">
                    <i class="fas fa-comments"></i>
                  </div>
                  <h3>Conversation supprimée</h3>
                  <p>La conversation a été supprimée avec succès</p>
                </div>
              `;
              await loadConversations();
            }
          } catch (error) {
            console.error('[ADMIN] Erreur suppression conversation:', error);
            alert('Erreur lors de la suppression de la conversation');
          }
        }
      );
    }

    // Marquer une conversation comme résolue
    async function resolveConversation(username) {
      showCustomPopup(
        'Marquer comme résolue',
        `Marquer la conversation avec ${username} comme résolue ? Les messages seront archivés.`,
        'success',
        'Résoudre',
        'success',
        async () => {
          try {
            const response = await fetch(`/api/support/resolve/${username}`, { method: 'POST' });
            if (response.ok) {
              selectedUsername = null;
              document.getElementById('chat-content').innerHTML = `
                <div class="empty-state">
                  <div class="empty-state-icon">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <h3>Conversation résolue</h3>
                  <p>La conversation a été marquée comme résolue et archivée</p>
                </div>
              `;
              await loadConversations();
              await loadResolvedToday(); // Mettre à jour le compteur
            }
          } catch (error) {
            console.error('[ADMIN] Erreur résolution conversation:', error);
            alert('Erreur lors de la résolution de la conversation');
          }
        }
      );
    }

    // Charger le compteur de résolutions aujourd'hui
    async function loadResolvedToday() {
      try {
        const response = await fetch('/api/support/resolved-today');
        if (response.ok) {
          const data = await response.json();
          const element = document.getElementById('resolved-today');
          if (element) {
            element.textContent = data.count;
          }
        }
      } catch (error) {
        console.error('[ADMIN] Erreur chargement résolutions:', error);
      }
    }

    // Gérer Enter pour envoyer
    function handleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    // Insérer du markdown dans le textarea
    function insertMarkdown(before, after) {
      const textarea = document.getElementById('admin-input');
      if (!textarea) return;

      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const selectedText = textarea.value.substring(start, end);
      const beforeText = textarea.value.substring(0, start);
      const afterText = textarea.value.substring(end);

      const newText = beforeText + before + (selectedText || 'texte') + after + afterText;
      textarea.value = newText;

      // Positionner le curseur
      const newCursorPos = start + before.length + (selectedText ? selectedText.length : 5);
      textarea.focus();
      textarea.setSelectionRange(newCursorPos, newCursorPos);
    }

    // Parser markdown simple
    function parseMarkdown(text) {
      if (!text) return '';

      let html = text;

      // Code inline `code`
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

      // Gras **texte** ou __texte__
      html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');

      // Italique *texte* ou _texte_
      html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      html = html.replace(/_([^_]+)_/g, '<em>$1</em>');

      // Liens [texte](url)
      html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

      // URLs simples
      html = html.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');

      // Sauts de ligne
      html = html.replace(/\n/g, '<br>');

      return html;
    }

    // Formater le temps
    function formatTime(timestamp) {
      if (!timestamp) return '';

      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'À l\'instant';
      if (diff < 3600000) return `Il y a ${Math.floor(diff / 60000)} min`;
      if (diff < 86400000) return `Il y a ${Math.floor(diff / 3600000)}h`;

      return date.toLocaleDateString('fr-FR', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
      });
    }


    // Vérifier les nouvelles conversations sans recharger
    async function checkForNewMessages() {
      try {
        const response = await fetch('/api/support/all-conversations');
        if (response.ok) {
          const result = await response.json();
          const data = Array.isArray(result) ? result : result.conversations || [];

          // Vérifier s'il y a de nouvelles conversations
          if (data.length > allConversations.length) {
            // Il y a de nouvelles conversations, recharger la liste une fois
            loadConversations();
            return;
          }

          // Sinon, vérifier chaque conversation pour les badges
          data.forEach(conv => {
            const convElement = document.querySelector(`[onclick="selectConversation('${conv.username}')"]`)?.closest('.conversation-item');
            if (convElement && conv.unread_count > 0) {
              // Ajouter le badge si pas déjà là
              const existingBadge = convElement.querySelector('.conversation-badge.unread');
              if (!existingBadge) {
                const badge = document.createElement('span');
                badge.className = 'conversation-badge unread';
                badge.textContent = conv.unread_count;
                const badgeContainer = convElement.querySelector('.conversation-info');
                if (badgeContainer) badgeContainer.appendChild(badge);
              } else {
                // Mettre à jour le nombre
                existingBadge.textContent = conv.unread_count;
              }
            }
          });
        }
      } catch (error) {
        console.error('[ADMIN] Erreur vérification nouveaux messages:', error);
      }
    }

    // Initialisation
    loadConversations();
    loadResolvedToday();

    // Vérifier les nouveaux messages toutes les 2 secondes SANS recharger la liste
    conversationsCheckInterval = setInterval(checkForNewMessages, 2000);
  </script>

  <!-- Custom Popup -->
  <div class="custom-popup-overlay" id="custom-popup">
    <div class="custom-popup">
      <div class="custom-popup-icon" id="popup-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="custom-popup-title" id="popup-title">Confirmation</div>
      <div class="custom-popup-message" id="popup-message">Êtes-vous sûr de vouloir effectuer cette action ?</div>
      <div class="custom-popup-buttons">
        <button class="popup-btn cancel" id="popup-cancel">Annuler</button>
        <button class="popup-btn confirm" id="popup-confirm">Confirmer</button>
      </div>
    </div>
  </div>

</body>
</html>
