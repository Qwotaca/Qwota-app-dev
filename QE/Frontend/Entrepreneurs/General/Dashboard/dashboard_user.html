<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  
  <!-- üì± PWA Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Qwota">
  <meta name="msapplication-TileColor" content="#1f2937">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Ic√¥nes PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

  <!-- Scripts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="icon" href="/favicon" type="image/x-icon" />

  <!-- Script commun -->
  <script src="/common.js"></script>

  <!-- Feuille de style principale - Th√®me Dark Organis√© -->
  <link rel="stylesheet" href="/base.css">

  <!-- Styles specifiques a la page Dashboard User -->
  <link rel="stylesheet" href="/dashboard_user.css">

  <!-- Styles pour la banni√®re de qu√™te -->
  <link rel="stylesheet" href="/gamification.css">

  <style>
    /* Styles pour les contours de gradient des photos de profil selon le grade */
    .profile-photo-small {
      position: relative;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      padding: 1.5px;
    }

    .profile-photo-small.grade-recrue {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .profile-photo-small.grade-senior1 {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }

    .profile-photo-small.grade-senior2 {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    }

    .profile-photo-small.grade-senior3 {
      background: linear-gradient(135deg, #a78bfa 0%, #7c3aed 100%);
    }

    .profile-photo-small img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--background-dark);
    }

    /* Styles pour les en-t√™tes de colonnes triables */
    .sortable-header {
      transition: background-color 0.2s ease;
      position: relative;
    }
    .sortable-header.active {
      background-color: rgba(96, 165, 250, 0.15) !important;
    }
    /* Cellules de la colonne active (clic) */
    #classementTable td.active-column {
      background-color: rgba(96, 165, 250, 0.08);
    }
    /* Cellules de la colonne survol√©e (hover) */
    #classementTable th.hover-column,
    #classementTable td.hover-column {
      background-color: rgba(255, 255, 255, 0.05);
    }

    /* Styles pour le tableau de classement coach */
    /* Header de la colonne active (clic) */
    #coachClassementTable th.active {
      background-color: rgba(96, 165, 250, 0.15) !important;
    }
    /* Cellules de la colonne active (clic) */
    #coachClassementTable td.active-column {
      background-color: rgba(96, 165, 250, 0.08);
    }
    /* Cellules de la colonne survol√©e (hover) */
    #coachClassementTable th.hover-column,
    #coachClassementTable td.hover-column {
      background-color: rgba(255, 255, 255, 0.05);
    }

    /* Styles pour le tableau de classement coach (coaches) */
    /* Header de la colonne active (clic) */
    #coachClassementCoachTable th.active {
      background-color: rgba(96, 165, 250, 0.15) !important;
    }
    /* Cellules de la colonne active (clic) */
    #coachClassementCoachTable td.active-column {
      background-color: rgba(96, 165, 250, 0.08);
    }
    /* Cellules de la colonne survol√©e (hover) */
    #coachClassementCoachTable th.hover-column,
    #coachClassementCoachTable td.hover-column {
      background-color: rgba(255, 255, 255, 0.05);
    }

    /* Barre de s√©lection entrepreneur pour coaches */
    #coach-entrepreneur-selector {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid var(--border-dark);
      padding: 0.75rem 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 10001 !important;
      display: none;
    }

    #coach-entrepreneur-selector.visible {
      display: block !important;
    }

    #coach-entrepreneur-selector .selector-container {
      max-width: 1400px;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    #coach-entrepreneur-selector .selector-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-light);
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
    }

    #coach-entrepreneur-selector .selector-label i {
      color: var(--primary-blue);
      font-size: 18px;
    }

    .coach-dropdown {
      position: relative;
      flex: 1;
      max-width: 450px;
    }

    .coach-dropdown-toggle {
      background: rgba(23, 32, 51, 0.8);
      border: 2px solid var(--border-dark);
      border-radius: 12px;
      padding: 10px 16px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text-light);
      font-size: 14px;
      gap: 0.5rem;
    }

    .coach-dropdown-toggle:hover {
      border-color: var(--primary-blue);
      background: rgba(23, 32, 51, 1);
    }

    .coach-dropdown-toggle.active {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
    }

    .coach-dropdown-toggle .placeholder {
      color: var(--text-gray);
      flex: 1;
    }

    .coach-dropdown-toggle .selected-text {
      color: var(--text-light);
      font-weight: 500;
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .coach-dropdown-toggle .selected-text i {
      color: var(--primary-green);
    }

    .coach-dropdown-toggle .chevron {
      color: var(--text-gray);
      transition: transform 0.3s ease;
      font-size: 12px;
    }

    .coach-dropdown-toggle.active .chevron {
      transform: rotate(180deg);
    }

    /* Search input inside dropdown toggle */
    .coach-dropdown-toggle input.search-input,
    .coach-dropdown-toggle .search-input {
      flex: 1 !important;
      min-width: 0 !important;
      background: transparent !important;
      border: none !important;
      outline: none !important;
      color: var(--text-light) !important;
      font-size: 15px !important;
      line-height: normal !important;
      font-family: inherit !important;
      font-weight: 400 !important;
      padding: 0 !important;
      margin: 0 !important;
      cursor: text !important;
      caret-color: var(--text-light) !important;
      height: auto !important;
      border-radius: 0 !important;
      box-sizing: border-box !important;
    }

    .coach-dropdown-toggle .search-input[style*="display: none"],
    .coach-dropdown-toggle .search-input[style*="display:none"] {
      width: 0 !important;
      flex: 0 0 0 !important;
      padding: 0 !important;
      margin: 0 !important;
      border: 0 !important;
      overflow: hidden !important;
    }

    .coach-dropdown-toggle .search-input::placeholder {
      color: var(--text-gray);
      font-size: 15px !important;
      font-family: inherit !important;
      font-weight: 400 !important;
    }

    .coach-dropdown-menu {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      right: 0;
      background: var(--bg-card);
      border: 2px solid var(--border-dark);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      z-index: 10000;
      max-height: 320px;
      overflow-y: auto;
      opacity: 0;
      transform: translateY(-10px);
      pointer-events: none;
      transition: all 0.3s ease;
    }

    .coach-dropdown-menu.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }

    .coach-dropdown-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      color: var(--text-light);
      border-bottom: 1px solid rgba(71, 85, 105, 0.2);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .coach-dropdown-option:hover {
      background: rgba(59, 130, 246, 0.15);
    }

    .coach-dropdown-option:last-child {
      border-bottom: none;
    }

    .coach-dropdown-option i {
      color: var(--primary-green);
      font-size: 16px;
    }

    .coach-dropdown-option-disabled {
      padding: 12px 16px;
      color: var(--text-gray);
      font-style: italic;
      cursor: default;
      text-align: center;
    }

    body.coach-mode {
      padding-top: 60px !important;
    }

    body.coach-mode .main-content {
      padding-top: 2rem !important;
    }

    body.coach-mode > .mobile-overlay,
    body.coach-mode > div:not(#coach-entrepreneur-selector):not(.mobile-overlay) {
      margin-top: 0 !important;
    }

    .coach-dropdown-menu::-webkit-scrollbar {
      width: 8px;
    }

    .coach-dropdown-menu::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 10px;
    }

    .coach-dropdown-menu::-webkit-scrollbar-thumb {
      background: var(--primary-blue);
      border-radius: 10px;
    }

    .coach-dropdown-menu::-webkit-scrollbar-thumb:hover {
      background: #60a5fa;
    }

    /* Scrollbar pour la liste des plaintes */
    #plaintesListeContainer::-webkit-scrollbar {
      width: 6px;
    }

    #plaintesListeContainer::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.3);
      border-radius: 10px;
    }

    #plaintesListeContainer::-webkit-scrollbar-thumb {
      background: rgba(107, 114, 128, 0.5);
      border-radius: 10px;
    }

    #plaintesListeContainer::-webkit-scrollbar-thumb:hover {
      background: rgba(107, 114, 128, 0.7);
    }

    /* Animation de succ√®s pour r√©solution de plainte */
    @keyframes successFadeIn {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes checkmarkDraw {
      0% {
        stroke-dashoffset: 100;
      }
      100% {
        stroke-dashoffset: 0;
      }
    }

    .success-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: successFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .success-content {
      text-align: center;
      color: white;
      animation: successFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
    }

    .success-checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      margin: 0 auto 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
    }

    .success-checkmark svg {
      stroke: white;
      stroke-width: 3;
      stroke-dasharray: 100;
      stroke-dashoffset: 100;
      animation: checkmarkDraw 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.4s forwards;
    }

    /* Styles pour les cercles de countdown */
    .countdown-circle {
      position: relative;
      display: inline-block;
    }

    .countdown-circle svg {
      transform: rotate(-90deg);
    }

    .countdown-circle-bg {
      fill: none;
      stroke: rgba(71, 85, 105, 0.3);
      stroke-width: 4;
    }

    .countdown-circle-progress {
      fill: none;
      stroke: #ef4444;
      stroke-width: 4;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s linear;
    }

    .countdown-circle-progress.warning {
      stroke: #f59e0b;
    }

    .countdown-circle-progress.critical {
      stroke: #ef4444;
      animation: pulse-critical 1s ease-in-out infinite;
    }

    .countdown-circle-progress.paused {
      stroke: #6b7280;
    }

    @keyframes pulse-critical {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .countdown-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: var(--text-light);
      font-weight: bold;
      pointer-events: none;
    }

    .countdown-text div {
      font-size: 11px;
      line-height: 1;
    }

    .countdown-text .countdown-label {
      font-size: 7px;
      color: var(--text-gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
      display: block;
    }

    /* Cercle de 80px - texte plus gros */
    .countdown-circle[style*="width: 80px"] .countdown-text div {
      font-size: 16px;
    }

    .countdown-circle[style*="width: 80px"] .countdown-text .countdown-label {
      font-size: 9px;
      margin-top: 3px;
    }

    /* Cercle plus petit pour le popup */
    .countdown-circle.small {
      width: 40px;
      height: 40px;
    }

    .countdown-circle.small .countdown-text div {
      font-size: 9px;
    }

    .countdown-circle.small .countdown-text .countdown-label {
      font-size: 6px;
    }

    /* ===== STYLES POUR LE DASHBOARD COACH (Mon √âquipe) ===== */
    /* Cacher par d√©faut, affich√© uniquement quand role === 'coach' */
    #coach-dashboard-content {
      display: none;
      margin: 0 auto;
      width: 100%;
      min-height: 100vh;
    }

    /* Main content */
    .main-content {
      padding: 2rem;
      margin: 0 auto;
    }

    /* Animations fade-in */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in-up {
      /* Animation d√©sactiv√©e pour mise √† jour fluide des donn√©es */
      /* animation: fadeInUp 0.6s ease-out forwards; */
    }

    /* Header de la page - Style Dashboard */
    .page-header {
      margin-bottom: 2.5rem;
    }

    .page-header h1 {
      font-size: 2.25rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 0.75rem;
      position: relative;
      display: inline-block;
    }

    .page-header .title-underline {
      position: absolute;
      bottom: -0.5rem;
      left: 0;
      width: 5rem;
      height: 0.25rem;
      background: linear-gradient(to right, #3b82f6, #60a5fa);
      border-radius: 9999px;
    }

    .page-header .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      margin-right: 0 !important;
      padding: 0 !important;
      max-width: 100% !important;
      height: auto !important;
    }

    .page-header p {
      color: var(--text-gray);
      font-size: 1.25rem;
      font-weight: 500;
    }

    /* Stats globales - Layout principal */
    .stats-grid {
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
      align-items: stretch;
    }

    /* CARTE CA - Principale et compacte */
    .ca-main-card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.98) 100%);
      border: 1px solid var(--border-dark);
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .ca-main-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #10b981, #34d399, #6ee7b7);
      box-shadow: 0 2px 12px rgba(16, 185, 129, 0.5);
    }

    .ca-main-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(52, 211, 153, 0.2);
      border-color: rgba(52, 211, 153, 0.3);
    }

    /* Header de la carte CA */
    .ca-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(52, 211, 153, 0.2);
    }

    .ca-title-section {
      flex: 1;
    }

    .ca-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .ca-title i {
      font-size: 1.5rem;
      background: linear-gradient(135deg, #10b981, #34d399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .ca-subtitle {
      font-size: 0.8125rem;
      color: var(--text-gray);
      font-weight: 500;
    }

    /* Montant CA principal */
    .ca-amount-section {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding: 1.25rem;
      background: rgba(16, 185, 129, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(16, 185, 129, 0.1);
    }

    .ca-label {
      font-size: 0.75rem;
      color: var(--text-gray);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .ca-main-value {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #10b981, #34d399, #6ee7b7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
    }

    /* Stats rapides CA */
    .ca-quick-stats {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .ca-quick-stat {
      flex: 1;
      background: rgba(15, 23, 42, 0.5);
      padding: 0.75rem;
      border-radius: 10px;
      border: 1px solid var(--border-dark);
      transition: all 0.3s ease;
      text-align: center;
    }

    .ca-quick-stat:hover {
      background: rgba(16, 185, 129, 0.08);
      border-color: rgba(16, 185, 129, 0.3);
      transform: translateY(-2px);
    }

    .ca-quick-stat-label {
      font-size: 0.6875rem;
      color: var(--text-gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.375rem;
      font-weight: 600;
    }

    .ca-quick-stat-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-light);
      line-height: 1;
    }

    /* Section graphique dans la carte CA */
    .ca-chart-section {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(52, 211, 153, 0.2);
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .ca-chart-title {
      font-size: 0.9375rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .ca-chart-title i {
      color: var(--primary-green);
      font-size: 1rem;
    }

    .ca-chart-container {
      position: relative;
      flex: 1;
      min-height: 200px;
      background: rgba(15, 23, 42, 0.3);
      border-radius: 12px;
      padding: 0.75rem;
    }

    /* Section droite - Stats 2x2 + Soumissions en bas */
    .stats-grid-right {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      height: 100%;
    }

    .stats-top-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 0.75rem;
      min-height: 0;
    }

    .soumissions-chart-right {
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .soumissions-chart-right .chart-card {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .soumissions-chart-right .chart-container {
      flex: 1 !important;
      height: auto !important;
      min-height: 200px;
    }

    /* Responsive stats grid */
    @media (max-width: 1400px) {
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
      }

      .stat-card.stat-ca {
        grid-column: span 2;
        grid-row: span 2;
      }

      .stat-card:not(.stat-ca) {
        grid-column: span 1;
      }
    }

    @media (max-width: 1024px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .stat-card.stat-ca {
        grid-column: span 2;
        grid-row: span 1;
      }

      .stat-card:not(.stat-ca) {
        grid-column: span 1;
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .stat-card.stat-ca,
      .stat-card:not(.stat-ca) {
        grid-column: span 1;
        grid-row: span 1;
      }

      .stat-card.stat-ca .stat-value {
        font-size: 2rem;
      }

      .stat-card.stat-ca .stat-icon {
        width: 56px;
        height: 56px;
        font-size: 1.5rem;
      }
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-dark);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      justify-content: center;
      height: 100%;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--card-color-start), var(--card-color-end));
      opacity: 1;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      border-color: rgba(96, 165, 250, 0.3);
    }

    .stat-header {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .stat-icon {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.125rem;
      background: rgba(96, 165, 250, 0.12);
      color: var(--primary-blue);
      flex-shrink: 0;
    }

    .stat-info {
      flex: 1;
      min-width: 0;
    }

    .stat-label {
      font-size: 0.8125rem;
      color: var(--text-gray);
      font-weight: 500;
      margin-bottom: 0.375rem;
      line-height: 1.2;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-light);
      line-height: 1;
    }

    /* Section graphiques */
    .charts-section {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border-dark);
      border-radius: 12px;
      padding: 1.25rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .chart-card:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      transform: translateY(-3px);
      border-color: rgba(96, 165, 250, 0.3);
    }

    .chart-header {
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-dark);
    }

    .chart-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 0.625rem;
    }

    .chart-title i {
      color: var(--primary-blue);
      font-size: 1.125rem;
    }

    .chart-container {
      position: relative;
    }

    /* Section entrepreneurs */
    .entrepreneurs-section {
      margin-top: 2rem;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border-dark);
    }

    .section-title i {
      color: var(--primary-blue);
      font-size: 1.5rem;
    }

    .entrepreneurs-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-auto-rows: 1fr;
      gap: 1.5rem;
    }

    /* Classement grid - Ranking view for coach */
    .classement-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
      padding: 1rem 0;
    }

    .classement-card {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      padding: 0.625rem 0.875rem;
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
      border: 1px solid rgba(96, 165, 250, 0.2);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 768px) {
      .classement-card {
        gap: 1rem;
      }

      .classement-card:hover {
        transform: none !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
        border-color: rgba(96, 165, 250, 0.2) !important;
        background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9)) !important;
      }

      .classement-card-rang {
        order: 3;
        margin-left: auto;
        margin-right: 0;
      }

      .classement-card-photo {
        order: 1;
        margin-left: 0.5rem;
        margin-right: 0;
      }

      .classement-card-info {
        order: 2;
      }
    }

    .classement-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(96, 165, 250, 0.25);
      border-color: rgba(96, 165, 250, 0.4);
      background: linear-gradient(145deg, rgba(30, 41, 59, 1), rgba(15, 23, 42, 0.95));
    }

    .classement-card-rang {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      background: rgba(96, 165, 250, 0.1);
      border: 1px solid rgba(96, 165, 250, 0.3);
    }

    .classement-card-photo {
      flex-shrink: 0;
    }

    .classement-card-photo-container {
      position: relative;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      overflow: visible;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Contours de grade pour le classement mobile - M√™mes images que PC */
    @media (max-width: 768px) {
      .classement-card-photo-container.grade-demarrage {
        border: none !important;
      }

      .classement-card-photo-container.grade-demarrage::after {
        content: '';
        position: absolute;
        top: 70%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 175%;
        height: 175%;
        background-image: url('https://i.ibb.co/39fQQrk0/3.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        pointer-events: none;
        z-index: 10;
      }

      .classement-card-photo-container.grade-apprenti {
        border: none !important;
      }

      .classement-card-photo-container.grade-apprenti::after {
        content: '';
        position: absolute;
        top: 70%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 175%;
        height: 175%;
        background-image: url('https://i.ibb.co/CK0mG8N1/5.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        pointer-events: none;
        z-index: 10;
      }

      .classement-card-photo-container.grade-pilier {
        border: none !important;
      }

      .classement-card-photo-container.grade-pilier::after {
        content: '';
        position: absolute;
        top: 70%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 175%;
        height: 175%;
        background-image: url('https://i.ibb.co/Pvjk5KmF/7.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        pointer-events: none;
        z-index: 10;
      }

      .classement-card-photo-container.grade-expert {
        border: none !important;
      }

      .classement-card-photo-container.grade-expert::after {
        content: '';
        position: absolute;
        top: 70%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 175%;
        height: 175%;
        background-image: url('https://i.ibb.co/b5CXksjS/8.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        pointer-events: none;
        z-index: 10;
      }

      .classement-card-photo-container.grade-maitre {
        border: none !important;
      }

      .classement-card-photo-container.grade-maitre::after {
        content: '';
        position: absolute;
        top: 70%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 175%;
        height: 175%;
        background-image: url('https://i.ibb.co/CKMwQTCq/10.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        pointer-events: none;
        z-index: 10;
      }

      .classement-card-photo-container.grade-heros {
        border: none !important;
      }

      .classement-card-photo-container.grade-heros::after {
        content: '';
        position: absolute;
        top: 70%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 175%;
        height: 175%;
        background-image: url('https://i.ibb.co/27JYbJfR/12.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        pointer-events: none;
        z-index: 10;
      }

      .classement-card-photo-container.grade-prestige {
        border: none !important;
      }

      .classement-card-photo-container.grade-prestige::after {
        content: '';
        position: absolute;
        top: 70%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 175%;
        height: 175%;
        background-image: url('https://i.ibb.co/847kXqTN/14.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        pointer-events: none;
        z-index: 10;
      }
    }

    .classement-card-info {
      flex: 1;
      min-width: 0;
    }

    .classement-card-name {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Carte entrepreneur - Style Dashboard */
    .entrepreneur-card {
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
      border: 1px solid rgba(96, 165, 250, 0.2);
      border-radius: 16px;
      padding: 1.25rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 1px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      height: 100%;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }

    .entrepreneur-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #60a5fa, #818cf8, #a78bfa);
      box-shadow: 0 2px 10px rgba(96, 165, 250, 0.5);
    }

    .entrepreneur-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(96, 165, 250, 0.1), transparent 50%);
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
    }

    .entrepreneur-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 40px rgba(59, 130, 246, 0.25), 0 10px 20px rgba(0, 0, 0, 0.3);
      border-color: rgba(96, 165, 250, 0.5);
    }

    .entrepreneur-card:hover::after {
      opacity: 1;
    }

    /* Carte emplacement vide */
    .empty-slot-card {
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.3), rgba(51, 65, 85, 0.2));
      border: 2px dashed var(--border-dark);
      border-radius: 16px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .empty-slot-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, rgba(148, 163, 184, 0.3), rgba(100, 116, 139, 0.3));
    }

    .empty-slot-card:hover {
      border-color: rgba(96, 165, 250, 0.4);
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.4), rgba(51, 65, 85, 0.3));
      transform: translateY(-3px);
    }

    .empty-slot-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(148, 163, 184, 0.1);
      border: 2px dashed rgba(148, 163, 184, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1.5rem;
    }

    .empty-slot-icon i {
      font-size: 2.5rem;
      color: rgba(148, 163, 184, 0.4);
    }

    .empty-slot-text {
      text-align: center;
      color: var(--text-gray);
      font-size: 0.9375rem;
      font-weight: 500;
      line-height: 1.5;
    }

    .entrepreneur-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.875rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-dark);
    }

    .entrepreneur-photo {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary-blue);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.4);
      flex-shrink: 0;
    }

    .entrepreneur-info {
      flex: 1;
    }

    .entrepreneur-info h3 {
      font-size: 0.9375rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 0.25rem;
      line-height: 1.2;
    }

    .grade {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.1875rem 0.5rem;
      border-radius: 10px;
      font-size: 0.6875rem;
      font-weight: 600;
      background: rgba(250, 204, 21, 0.15);
      color: #facc15;
      border: 1px solid rgba(250, 204, 21, 0.3);
    }

    /* Badge de classement */
    .rank-badge {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 0.875rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }

    .rank-badge.rank-1 {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
      border: 3px solid #fef3c7;
      box-shadow: 0 4px 20px rgba(251, 191, 36, 0.6);
    }

    .rank-badge.rank-2 {
      background: linear-gradient(135deg, #94a3b8, #64748b);
      color: white;
      border: 3px solid #e2e8f0;
      box-shadow: 0 4px 20px rgba(148, 163, 184, 0.6);
    }

    .rank-badge.rank-3 {
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: white;
      border: 3px solid #fed7aa;
      box-shadow: 0 4px 20px rgba(249, 115, 22, 0.6);
    }

    .rank-badge i {
      font-size: 1.25rem;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    /* Mini stats dans carte entrepreneur */
    .entrepreneur-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .stat-item {
      text-align: center;
      padding: 0.625rem 0.5rem;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.5), rgba(30, 41, 59, 0.3));
      border-radius: 10px;
      border: 1px solid rgba(96, 165, 250, 0.15);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .stat-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--primary-blue), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .stat-item:hover {
      background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(96, 165, 250, 0.1));
      border-color: rgba(96, 165, 250, 0.4);
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 16px rgba(59, 130, 246, 0.2);
    }

    .stat-item:hover::before {
      opacity: 1;
    }

    .stat-item .label {
      font-size: 0.625rem;
      color: var(--text-gray);
      margin-bottom: 0.375rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      font-weight: 400;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.1875rem;
      line-height: 1.2;
    }

    .stat-item .value {
      font-size: 0.9375rem;
      font-weight: 600;
      line-height: 1.1;
    }

    .value.green { color: var(--primary-green); }
    .value.blue { color: var(--primary-blue); }
    .value.orange { color: var(--primary-orange); }
    .value.red { color: var(--primary-red); }
    .value.purple { color: var(--primary-purple); }
    .value.yellow { color: var(--primary-yellow); }
    .value.teal { color: var(--primary-teal); }
    .value.indigo { color: var(--primary-indigo); }
    .value.pink { color: var(--primary-pink); }

    /* Boutons d'action - Style Dashboard */
    .entrepreneur-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border-dark);
    }

    .action-btn {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .action-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    .action-btn.secondary {
      background: rgba(148, 163, 184, 0.15);
      color: var(--text-light);
      border: 1px solid var(--border-dark);
    }

    .action-btn.secondary:hover {
      background: rgba(148, 163, 184, 0.25);
      transform: translateY(-2px);
      border-color: rgba(96, 165, 250, 0.3);
    }

    /* Loading spinner */
    .loading-spinner {
      text-align: center;
      padding: 3rem;
      color: var(--primary-blue);
      font-size: 2rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-spinner i {
      animation: spin 1s linear infinite;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-gray);
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 1.2rem;
      margin-top: 1rem;
    }

    /* Personnalisation - Stats items */
    .active-stat-item,
    .available-stat-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.375rem 0.5rem;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(96, 165, 250, 0.2);
      border-radius: 4px;
      transition: all 0.2s ease;
      font-size: 0.75rem;
    }

    .active-stat-item:hover,
    .available-stat-item:hover {
      background: rgba(30, 41, 59, 0.8);
      border-color: rgba(96, 165, 250, 0.4);
      transform: translateX(2px);
    }

    .active-stat-item {
      cursor: move;
    }

    .active-stat-item:active {
      cursor: grabbing;
    }

    .active-stat-item button,
    .available-stat-item button {
      font-size: 0.6875rem;
      padding: 0.25rem 0.4375rem;
    }

    .active-stat-item i.fa-grip-vertical {
      font-size: 0.75rem;
    }

    /* Custom Toggle Switch */
    .custom-toggle {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .custom-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(71, 85, 105, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
      transition: all 0.3s ease;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 2px;
      bottom: 2px;
      background: white;
      transition: all 0.3s ease;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .custom-toggle input:checked + .toggle-slider {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-color: rgba(16, 185, 129, 0.5);
    }

    .custom-toggle input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }

    .custom-toggle:hover .toggle-slider {
      box-shadow: 0 0 8px rgba(96, 165, 250, 0.4);
    }

    /* Spinner animation */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .spinner {
      display: inline-block;
      animation: spin 0.8s linear infinite;
    }

    /* Responsive pour dashboard coach */
    @media (max-width: 1400px) {
      .ca-chart-container {
        height: 260px;
      }

      .stats-grid {
        grid-template-columns: 1fr 0.9fr;
      }
    }

    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .stats-top-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .charts-section {
        gap: 1rem;
      }
    }

    @media (max-width: 968px) {
      .ca-main-value {
        font-size: 2.75rem;
      }

      .ca-amount-section {
        flex-direction: column;
        align-items: flex-start;
      }

      .ca-quick-stats {
        width: 100%;
        margin-top: 1rem;
      }

      .ca-chart-container {
        height: 220px;
      }

      .stats-top-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .charts-section {
        grid-template-columns: 1fr;
      }

      .entrepreneurs-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .ca-main-card {
        padding: 1.25rem;
      }

      .ca-header {
        margin-bottom: 1rem;
      }

      .ca-title {
        font-size: 1.125rem;
      }

      .ca-main-value {
        font-size: 2rem;
      }

      .ca-amount-section {
        padding: 1rem;
        flex-direction: column;
        align-items: flex-start;
      }

      .ca-quick-stats {
        width: 100%;
        margin-top: 0.75rem;
        flex-direction: column;
      }

      .ca-chart-section {
        margin-top: 1rem;
        padding-top: 1rem;
      }

      .ca-chart-container {
        height: 180px;
      }

      .stats-top-grid {
        grid-template-columns: 1fr;
      }

      .charts-section {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .entrepreneurs-grid {
        grid-template-columns: 1fr;
      }

      .page-header h1 {
        font-size: 1.875rem;
      }

      .page-header p {
        font-size: 1rem;
      }

      .section-title {
        font-size: 1.25rem;
      }

      .entrepreneur-card {
        padding: 1.25rem;
      }
    }

    /* ===== STYLES CALENDRIER PERSONNALIS√â ===== */
    .coach-custom-calendar-widget .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .coach-custom-calendar-widget .calendar-nav-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid var(--border-dark);
      background: #0f172a;
      color: var(--primary-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .coach-custom-calendar-widget .calendar-nav-btn:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--primary-blue);
      transform: scale(1.1);
    }

    .coach-custom-calendar-widget .calendar-month-year {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-light);
    }

    .coach-custom-calendar-widget .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .coach-custom-calendar-widget .calendar-day-header {
      text-align: center;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-gray);
      padding: 6px 2px;
    }

    .coach-custom-calendar-widget .calendar-day {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-light);
      margin: 0 auto;
    }

    .coach-custom-calendar-widget .calendar-day:hover {
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary-blue);
    }

    .coach-custom-calendar-widget .calendar-day.today {
      background: rgba(59, 130, 246, 0.2);
      color: white;
      font-weight: 600;
    }

    .coach-custom-calendar-widget .calendar-day.selected {
      background: #3b82f6;
      color: white;
      font-weight: 600;
    }

    .coach-custom-calendar-widget .calendar-day.other-month {
      color: var(--text-gray);
      opacity: 0.4;
    }

    .coach-custom-calendar-widget .calendar-day.in-range {
      background: rgba(59, 130, 246, 0.15);
      color: var(--text-light);
    }
    /* ===== FIN STYLES CALENDRIER PERSONNALIS√â ===== */

    /* ===== MASQUER LES SCROLLBARS DU CLASSEMENT ===== */
    .classement-table-container {
      overflow: visible !important;
      -ms-overflow-style: none;  /* IE et Edge */
      scrollbar-width: none;  /* Firefox */
    }

    .classement-table-container::-webkit-scrollbar {
      display: none;  /* Chrome, Safari et Opera */
    }
    /* ===== FIN MASQUER SCROLLBARS ===== */

    /* ===== FIN STYLES BOUTONS FILTRAGE ===== */

    /* ===== DROPDOWN ENTREPRENEUR SCOPE - RESPONSIVE ===== */
    /* Sur mobile: afficher seulement le dropdown mobile */
    @media (max-width: 768px) {
      #entrepreneurScopeDesktopContainer {
        display: none !important;
      }
      #entrepreneurScopeMobileContainer {
        display: block !important;
      }
    }

    /* Sur desktop: afficher seulement le dropdown desktop */
    @media (min-width: 769px) {
      #entrepreneurScopeDesktopContainer {
        display: block !important;
      }
      #entrepreneurScopeMobileContainer {
        display: none !important;
      }
    }
    /* ===== FIN DROPDOWN ENTREPRENEUR SCOPE ===== */

    /* ===== FIN STYLES DASHBOARD COACH ===== */

    /* ===== STYLES TABLETTE (600px - 1199px) ===== */
    @media (min-width: 600px) and (max-width: 1199px) {
      /* Metrics grid en 2 colonnes sur tablette */
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }

      /* Padding en bas pour s√©curit√© */
      .main-content {
        padding-bottom: 4rem !important;
      }

      /* Classement: dropdown √† droite du titre (comme desktop) */
      #entrepreneurScopeDesktopContainer {
        display: block !important;
      }
      #entrepreneurScopeMobileContainer {
        display: none !important;
      }
    }

    /* ===== STYLES PC (1200px+) ===== */
    @media (min-width: 1200px) {
      /* Metrics grid en 5 colonnes sur PC */
      .metrics-grid {
        grid-template-columns: repeat(5, 1fr) !important;
      }
    }
  </style>
</head>
<body class="min-h-screen" style="margin: 0; padding: 0;">

  <!-- S√©lecteur de dashboard (visible uniquement pour les coaches) -->
  <div id="coach-entrepreneur-selector">
    <div class="selector-container">
      <!-- First Dropdown: Dashboard Type -->
      <div class="selector-label">
        <i class="fas fa-building"></i>
        <span>Dashboard:</span>
      </div>
      <div class="coach-dropdown" style="min-width: 220px;">
        <div class="coach-dropdown-toggle" id="dashboard-type-toggle">
          <span class="selected-text">
            <i class="fas fa-users"></i>
            Mon √âquipe
          </span>
          <i class="fas fa-chevron-down chevron"></i>
        </div>
        <div class="coach-dropdown-menu" id="dashboard-type-menu">
          <div class="coach-dropdown-option" data-type="mon-equipe">
            <i class="fas fa-users-cog"></i>
            <span>Mon √âquipe</span>
          </div>
          <div class="coach-dropdown-option" data-type="par-coach">
            <i class="fas fa-chalkboard-teacher"></i>
            <span>Dashboard par Coach</span>
          </div>
          <div class="coach-dropdown-option" data-type="entrepreneur">
            <i class="fas fa-users"></i>
            <span>Dashboard par Entrepreneur</span>
          </div>
          <div class="coach-dropdown-option" data-type="qualite-etudiants">
            <i class="fas fa-graduation-cap"></i>
            <span>Dashboard Qualit√© √âtudiants</span>
          </div>
        </div>
      </div>

      <!-- Second Dropdown: Coach Selector (conditionally visible) -->
      <div id="coach-selector-wrapper" style="display: none;">
        <div class="selector-label">
          <i class="fas fa-chalkboard-teacher"></i>
          <span>Coach:</span>
        </div>
        <div class="coach-dropdown" style="min-width: 280px; max-width: 280px;">
          <div class="coach-dropdown-toggle" id="coach-selector-toggle">
            <span class="placeholder">-- S√©lectionner un coach --</span>
            <i class="fas fa-chevron-down chevron"></i>
          </div>
          <div class="coach-dropdown-menu" id="coach-selector-menu">
            <!-- Options charg√©es dynamiquement -->
          </div>
        </div>
      </div>

      <!-- Third Dropdown: Entrepreneur Selector (conditionally visible) -->
      <div id="entrepreneur-selector-wrapper" style="display: none;">
        <div class="selector-label">
          <i class="fas fa-user-tie"></i>
          <span>Entrepreneur:</span>
        </div>
        <div class="coach-dropdown" style="min-width: 280px; max-width: 280px;">
          <div class="coach-dropdown-toggle" id="coach-dropdown-toggle">
            <input type="text"
                   class="search-input"
                   id="search-input"
                   placeholder="Rechercher..."
                   autocomplete="off"
                   style="display: none;">
            <span class="placeholder">-- S√©lectionner un entrepreneur --</span>
            <i class="fas fa-chevron-down chevron"></i>
          </div>
          <div class="coach-dropdown-menu" id="coach-dropdown-menu">
            <!-- Options charg√©es dynamiquement -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Banni√®re Side Quest (visible uniquement pour les entrepreneurs) -->
  <style>
    @media (max-width: 768px) {
      #quest-banner-float {
        display: none !important;
      }
    }
  </style>
  <div id="quest-banner-float" class="quest-banner-float" style="display: none; cursor: pointer;" onclick="openDashboardQuestModal()">
    <div class="quest-banner-content">
      <div class="quest-banner-icon">
        <i class="fas fa-crosshairs"></i>
      </div>
      <div class="quest-banner-info">
        <div class="quest-banner-title">Side Quest</div>
        <div class="quest-banner-subtitle" id="dashboardQuestTitle">Chargement...</div>
        <div class="quest-banner-progress">
          <div class="quest-banner-progress-bar">
            <div class="quest-banner-progress-fill" id="dashboardQuestProgress" style="width: 0%;"></div>
          </div>
        </div>
      </div>
      <div class="quest-banner-arrow">
        <i class="fas fa-chevron-left"></i>
      </div>
    </div>
  </div>

  <!-- Modal Side Quest pour Dashboard (identique √† gamification.html) -->
  <div class="quest-modal" id="dashboardQuestModal">
    <div class="quest-modal-overlay" onclick="closeDashboardQuestModal()"></div>
    <div class="quest-modal-content">
      <button class="quest-modal-close" onclick="closeDashboardQuestModal()">
        <i class="fas fa-times"></i>
      </button>

      <div class="quest-modal-header">
        <div class="quest-modal-icon">
          <i class="fas fa-crosshairs"></i>
        </div>
        <div>
          <h2>Side Quest</h2>
          <p class="quest-modal-subtitle">Compl√©tez le d√©fi de la semaine</p>
        </div>
      </div>

      <div class="quest-modal-body">
        <div class="quest-modal-columns">
          <!-- Colonne Gauche : Side Quest Active -->
          <div class="quest-column-left">
            <div class="quest-card-modal">
              <div class="quest-header">
                <div class="quest-info-full">
                  <h3 class="quest-title" id="dbModalQuestTitle">Chargement...</h3>
                  <div class="quest-deadline">
                    <i class="fas fa-clock"></i>
                    <span id="dbModalQuestDeadline">--</span>
                  </div>
                </div>
                <div class="quest-status" id="dbModalQuestStatus">
                  <span class="status-badge status-active">En cours</span>
                </div>
              </div>

              <div class="quest-progress-container">
                <div class="quest-progress-bar">
                  <div class="quest-progress-fill" id="dbModalQuestProgressFill" style="width: 0%"></div>
                </div>
                <div class="quest-progress-text">
                  <span id="dbModalQuestProgressCurrent">0</span> / <span id="dbModalQuestProgressTarget">0</span>
                </div>
              </div>

              <div class="quest-reward">
                <div class="reward-label">
                  <i class="fas fa-gift"></i>
                  R√©compenses
                </div>
                <div class="reward-content">
                  <div class="reward-item">
                    <i class="fas fa-star reward-icon"></i>
                    <span id="dbModalQuestRewardXP">+10 XP</span>
                  </div>
                  <div class="reward-item reward-streak-indicator" id="dbModalStreakReward" style="display: none;">
                    <i class="fas fa-fire reward-icon-fire"></i>
                    <span>Streaks de profil</span>
                  </div>
                </div>
              </div>

              <!-- Semaine Prochaine -->
              <div class="upcoming-weeks-section">
                <div class="upcoming-weeks-header">
                  <h4 style="color: var(--text-light); font-size: 1rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-calendar-week" style="color: #60a5fa;"></i>
                    Semaine Prochaine
                  </h4>
                </div>

                <div class="week-card">
                  <div class="week-card-header">
                    <div class="week-number" id="dbNextWeekNumber">--</div>
                  </div>
                  <div class="week-quest">
                    <div class="week-quest-icon">
                      <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="week-quest-details">
                      <div class="week-quest-title" id="dbNextWeekQuestTitle">--</div>
                      <div class="week-quest-reward"><i class="fas fa-star"></i> +10 XP</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Colonne Droite : Flammes de Profil -->
          <div class="quest-column-right">
            <div class="quest-flames-section">
              <div class="flames-header">
                <h3><i class="fas fa-fire"></i> Streaks de Profil</h3>
                <p class="flames-subtitle" style="margin-bottom: 1rem;">Comment obtenir des streaks : Compl√©tez chaque side quest de la semaine. Plus vous en compl√©tez de mani√®re cons√©cutive, plus votre compteur de streaks augmente!</p>
              </div>

              <div class="flames-progression" style="display: flex; flex-direction: column; align-items: center; padding: 0;">
                <!-- Titre avec streak actuel -->
                <div style="text-align: center; width: 100%;">
                  <h4 id="dbStreakTitle" style="color: #fbbf24; font-size: 0.95rem; font-weight: 700; margin-bottom: 1.5rem; text-transform: uppercase; letter-spacing: 0.05em;">
                    <i class="fas fa-fire" style="color: #f59e0b; margin-right: 0.5rem;"></i>
                    Streak actuel: <span id="dbCurrentStreakNumber">0</span>
                  </h4>

                  <!-- Vue progression : Streak actuel ‚Üí Prochain palier -->
                  <div id="dbStreakProgressView" style="display: flex; align-items: center; justify-content: center; gap: 3rem; padding: 1.5rem;">
                    <!-- Photo actuelle (gauche) -->
                    <div style="text-align: center;">
                      <div style="position: relative; width: 140px; height: 140px; margin: 0 auto 0.75rem auto; background: rgba(31, 41, 55, 0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);">
                        <div class="flame-avatar-container" style="position: relative; width: 100px; height: 100px;">
                          <div id="dbCurrentStreakAvatar" class="flame-avatar grade-demarrage" style="width: 100%; height: 100%; position: relative; border-radius: 50%; z-index: 1;">
                            <img id="dbCurrentStreakPhoto" src="" alt="Streak actuel" style="display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                          </div>
                          <div id="dbCurrentStreakBadge" style="position: absolute; bottom: 70px; right: -35px; background: linear-gradient(135deg, rgb(31, 41, 55), rgb(17, 24, 39)); color: white; min-width: 53px; height: 33px; border-radius: 20%; display: flex; align-items: center; justify-content: center; gap: 0.2rem; padding: 0px 0.35rem; border: 2px solid var(--bg-dark); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5); z-index: 20;">
                            <i class="fas fa-fire" style="font-size: 0.95rem; color: #9ca3af;"></i>
                            <span id="dbCurrentStreakBadgeNum" style="font-size: 1rem; font-weight: 700;">0</span>
                          </div>
                        </div>
                      </div>
                      <p id="dbCurrentStreakLabel" style="margin: 0; color: var(--text-muted); font-size: 1rem; font-weight: 600;">Actuel</p>
                    </div>

                    <!-- Fl√®che -->
                    <div style="display: flex; align-items: center; justify-content: center; padding: 0 1rem;">
                      <i class="fas fa-arrow-right" style="font-size: 2.5rem; color: white;"></i>
                    </div>

                    <!-- Prochain palier (droite) -->
                    <div style="text-align: center;">
                      <div style="position: relative; width: 140px; height: 140px; margin: 0 auto 0.75rem auto; background: rgba(31, 41, 55, 0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);">
                        <div class="flame-avatar-container" style="position: relative; width: 100px; height: 100px;">
                          <div id="dbNextStreakAvatar" class="flame-avatar grade-demarrage" style="width: 100%; height: 100%; position: relative; border-radius: 50%; z-index: 1;">
                            <img id="dbNextStreakPhoto" src="" alt="Prochain palier" style="display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                          </div>
                          <div id="dbNextStreakBadge" style="position: absolute; bottom: 70px; right: -35px; background: linear-gradient(135deg, rgb(31, 41, 55), rgb(17, 24, 39)); color: white; min-width: 53px; height: 33px; border-radius: 20%; display: flex; align-items: center; justify-content: center; gap: 0.2rem; padding: 0px 0.35rem; border: 2px solid var(--bg-dark); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5), 0 0 12px rgba(245, 158, 11, 0.3); z-index: 20;">
                            <i class="fas fa-fire" style="font-size: 0.95rem; color: #fbbf24;"></i>
                            <span id="dbNextStreakBadgeNum" style="font-size: 1rem; font-weight: 700;">4</span>
                          </div>
                        </div>
                      </div>
                      <p id="dbNextStreakLabel" style="margin: 0; color: #fbbf24; font-size: 1rem; font-weight: 600;">Avec des Streaks</p>
                    </div>
                  </div>

                  <!-- Vue quand streak > 0 : 1 photo avec badge -->
                  <div id="dbStreakActiveView" style="display: none;">
                    <div class="flame-tier active" id="dbStreakAvatarContainer" style="position: relative; overflow: visible;">
                      <div class="flame-avatar-container" style="position: relative;">
                        <div class="flame-avatar" style="width: 120px; height: 120px; position: relative; margin: 0 auto;">
                          <img class="flame-user-avatar" id="dbStreakAvatar" src="" alt="Avatar" style="display: block;">
                          <div class="flame-effect" id="dbFlameEffect" style="animation: flameAnimation 2s infinite;"></div>
                          <div id="dbStreakBadge" style="position: absolute; bottom: 85px; right: -40px; background: linear-gradient(135deg, #1f2937, #111827); color: white; width: 65px; height: 38px; border-radius: 28%; display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 0.2rem; border: 3px solid var(--bg-dark); box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5), 0 0 20px rgba(245, 158, 11, 0.3); z-index: 20;">
                            <i class="fas fa-fire" style="font-size: 1rem; color: #f59e0b;"></i>
                            <span id="dbStreakBadgeNumber" style="font-size: 1rem; font-weight: 800; line-height: 1;">0</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenu principal -->
  <div class="main-content w-full" style="width: 100%;">
    <div class="w-full">

    <!-- Message "En d√©veloppement" pour Dashboard Coach -->
    <div id="coach-dev-message" style="display: none;">
      <div class="mb-10 mt-5 md:mt-0">
        <div class="relative">
          <h1 class="text-4xl font-bold mb-3">
            Dashboard Coach
          </h1>
          <span class="absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-blue-600 to-blue-400 rounded-full"></span>
        </div>
      </div>

      <div style="background: var(--bg-card); border-radius: 16px; padding: 3rem; text-align: center; border: 1px solid var(--border-dark); box-shadow: var(--shadow-dark-medium);">
        <i class="fas fa-tools" style="font-size: 4rem; color: var(--primary-blue); margin-bottom: 1.5rem;"></i>
        <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-light); margin-bottom: 1rem;">
          En d√©veloppement
        </h2>
        <p style="color: var(--text-gray); font-size: 1rem;">
          Le dashboard coach sera bient√¥t disponible.
        </p>
      </div>
    </div>

    <!-- Contenu principal du dashboard (entrepreneur) -->
    <div id="entrepreneur-dashboard-content">
      <!-- Header -->
      <div class="mb-10 mt-5 md:mt-0">
        <div class="relative">
          <h1 class="text-4xl font-bold mb-3">
            Tableau de Bord
          </h1>
  <span class="absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-blue-600 to-blue-400 rounded-full"></span>
          <div class="flex items-center justify-between">
            <p class="text-xl font-medium">
              <span>Vue d'ensemble de votre activit√© commerciale</span>
            </p>
            <div class="text-sm flex items-center date-display-container">
              <i class="fas fa-calendar-alt mr-2"></i>
              <span id="currentDate">Aujourd'hui</span>
            </div>
          </div>
        </div>
      </div>

    <!-- Top Status Cards -->
    <div class="status-cards-grid grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      
      <!-- Gauche: Status Soumissions avec lignes de couleur -->
      <div class="status-card p-6">
        <div class="flex items-start justify-between mb-4">
          <div>
            <h3 class="text-lg font-semibold mb-1">Status Soumissions</h3>
            <p class="text-sm">√âtat des propositions</p>
          </div>
          <div class="w-12 h-12 rounded-xl flex items-center justify-center">
            <i class="fas fa-file-signature text-lg" style="color: #60a5fa;"></i>
          </div>
        </div>
        
        <div class="space-y-3" id="soumissions-status-container">
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium">Sign√©es</span>
            <span id="soumissionsSignees" class="text-lg font-bold text-green-600 animated-number">0</span>
          </div>
          <div id="status-line-signees" class="status-line bg-green-500"></div>
          
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium">En attente</span>
            <span id="soumissionsEnAttente" class="text-lg font-bold text-orange-600 animated-number">0</span>
          </div>
          <div id="status-line-attente" class="status-line bg-orange-500"></div>
          
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium">Perdus</span>
            <span id="soumissionsPerdus" class="text-lg font-bold text-red-600 animated-number">0</span>
          </div>
          <div id="status-line-perdus" class="status-line bg-red-500"></div>
        </div>
      </div>

      <!-- Centre: Objectif de l'ann√©e -->
      <div class="status-card p-6">
        <div class="flex items-start justify-between mb-4">
          <div>
            <h3 class="text-lg font-semibold mb-1">Chiffre d'affaires</h3>
            <p class="text-sm">Suivi des objectifs</p>
          </div>
          <div class="w-12 h-12 rounded-xl flex items-center justify-center">
            <i class="fas fa-dollar-sign text-lg"></i>
          </div>
        </div>

        <div class="flex items-center justify-between mb-6">
          <div class="flex-1 text-center">
            <div class="relative inline-block">
              <svg class="w-20 h-20 progress-ring" viewBox="0 0 84 84">
                <circle cx="42" cy="42" r="40" stroke="#475569" stroke-width="4" fill="none"/>
                <circle id="progress-circle" cx="42" cy="42" r="40" stroke="#10b981" stroke-width="4" fill="none" class="progress-ring-circle"/>
              </svg>
              <div class="absolute inset-0 flex flex-col items-center justify-center">
                <span id="progressPercent" class="text-lg font-bold text-green-600">0%</span>
                <span id="objectifMontant" class="text-xs mt-0.5" style="color: var(--text-gray); opacity: 0.7;">0 $</span>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-center gap-8">
          <div class="text-center">
            <div id="travauxEnCours" class="text-2xl font-bold text-green-600 animated-number mb-1">0 $</div>
            <div class="text-xs text-gray-500 uppercase">Dollars ($) vendu</div>
          </div>
          <div class="text-center">
            <div id="montantProduit" class="text-2xl font-bold text-blue-600 animated-number mb-1">0 $</div>
            <div class="text-xs text-gray-500 uppercase">Montant produit</div>
          </div>
        </div>
      </div>

      <!-- Droite: Satisfaction client -->
      <div class="status-card satisfaction-card p-6">
        <div class="flex items-start justify-between mb-4">
          <div>
            <h3 class="text-lg font-semibold mb-1">Satisfaction client</h3>
            <p class="text-sm">Retour des clients</p>
          </div>
          <div class="w-12 h-12 rounded-xl flex items-center justify-center">
            <i class="fas fa-smile text-lg"></i>
          </div>
        </div>

        <div class="space-y-3">
          <div class="rounded-lg p-3">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium">Satisfaction client</span>
              <span class="text-lg font-bold animated-number">
                <i class="fas fa-star" style="color: #eab308 !important;"></i> <span id="etoilesMoyennes" class="text-yellow-500">0.0</span>
              </span>
            </div>
          </div>

          <div class="rounded-lg p-3">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium">Nombre d'avis re√ßus</span>
              <span id="nombreAvis" class="text-lg font-bold text-blue-600 animated-number">0</span>
            </div>
          </div>

          <div class="rounded-lg p-3 cursor-pointer transition-all" onclick="ouvrirPlaintePopup()" style="box-shadow: 0 0 0 rgba(239, 68, 68, 0); border: 2px solid transparent;" onmouseover="this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.3)'; this.style.borderColor='#ef4444'" onmouseout="this.style.boxShadow='0 0 0 rgba(239, 68, 68, 0)'; this.style.borderColor='transparent'">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium">Plaintes actuelles</span>

              <div class="flex items-center gap-3">
                <!-- Badge chrono urgent - Cercle de countdown -->
                <div id="plainteIcon" class="hidden" style="width: 50px; height: 50px; pointer-events: none;">
                  <!-- Le cercle sera ins√©r√© ici dynamiquement -->
                </div>

                <!-- Compteur plaintes -->
                <span id="plaintesActuel" class="text-lg font-bold text-red-600 animated-number">1</span>
                <span id="plaintesZero" class="hidden text-lg font-bold text-green-600 animated-number">0</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Metrics Grid -->
    <div class="metrics-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">

      <div class="metric-card p-6">
        <div class="flex flex-col md:flex-row items-center md:justify-between mb-2">
          <div class="metric-icon w-12 h-12 rounded-xl flex items-center justify-center text-white mb-3 md:mb-0">
            <i class="fas fa-business-time text-lg"></i>
          </div>
          <div class="text-center md:text-right">
            <div id="heuresPAPSemaine" class="text-2xl font-bold animated-number">0 h</div>
            <div class="text-xs uppercase font-semibold tracking-wider">Heure PAP/semaine</div>
          </div>
        </div>
      </div>

      <div class="metric-card p-6">
        <div class="flex flex-col md:flex-row items-center md:justify-between mb-2">
          <div class="metric-icon w-12 h-12 rounded-xl flex items-center justify-center text-white mb-3 md:mb-0">
            <i class="fas fa-bullhorn text-lg"></i>
          </div>
          <div class="text-center md:text-right">
            <div id="tauxMarketing" class="text-2xl font-bold animated-number">0.00</div>
            <div class="text-xs uppercase font-semibold tracking-wider">Taux marketing</div>
          </div>
        </div>
      </div>

      <div class="metric-card p-6">
        <div class="flex flex-col md:flex-row items-center md:justify-between mb-2">
          <div class="metric-icon w-12 h-12 rounded-xl flex items-center justify-center text-white mb-3 md:mb-0">
            <i class="fas fa-file-contract text-lg"></i>
          </div>
          <div class="text-center md:text-right">
            <div id="contratMoyen" class="text-2xl font-bold animated-number">0 $</div>
            <div class="text-xs uppercase font-semibold tracking-wider">Contrat moyen</div>
          </div>
        </div>
      </div>

      <div class="metric-card p-6">
        <div class="flex flex-col md:flex-row items-center md:justify-between mb-2">
          <div class="metric-icon w-12 h-12 rounded-xl flex items-center justify-center text-white mb-3 md:mb-0">
            <i class="fas fa-percentage text-lg"></i>
          </div>
          <div class="text-center md:text-right">
            <div id="tv" class="text-2xl font-bold animated-number">0%</div>
            <div class="text-xs uppercase font-semibold tracking-wider">Taux de vente</div>
          </div>
        </div>
      </div>

      <div class="metric-card p-6">
        <div class="flex flex-col md:flex-row items-center md:justify-between mb-2">
          <div class="metric-icon w-12 h-12 rounded-xl flex items-center justify-center text-white mb-3 md:mb-0">
            <i class="fas fa-clock text-lg"></i>
          </div>
          <div class="text-center md:text-right">
            <div id="prodHoraire" class="text-2xl font-bold animated-number">0 $/h</div>
            <div class="text-xs uppercase font-semibold tracking-wider">Prod horaire</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Classement Section -->
    <div class="chart-container p-8 mb-8" id="classement-section">
      <!-- Titre avec dropdowns Filtrage et P√©riode -->
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-2xl font-bold">Classement</h2>
        <div class="flex items-center gap-2">
          <!-- Dropdown de filtrage entrepreneurs (visible uniquement sur desktop √† droite) -->
          <div id="entrepreneurScopeDesktopContainer" style="position: relative; display: none;">
            <div class="custom-select" id="entrepreneurScopeSelectDesktop" style="width: auto; min-width: 220px;">
              <button class="custom-select-button" id="entrepreneurScopeBtnDesktop" style="min-height: 40px; padding: 8px 14px;">
                <span class="custom-select-text" id="entrepreneurScopeBtnTextDesktop">
                  <i class="fas fa-users mr-2"></i>Tous les entrepreneurs
                </span>
                <i class="fas fa-chevron-down custom-select-arrow"></i>
              </button>
              <div class="custom-select-dropdown" id="entrepreneurScopeDropdownDesktop">
                <div class="custom-select-option" data-scope="tous">
                  <i class="fas fa-users mr-2"></i>Tous les entrepreneurs
                </div>
                <div class="custom-select-option" data-scope="grade" data-grade="recrue" style="padding-left: 2.5rem;">
                  <i class="fas fa-seedling mr-2"></i>Recrue
                </div>
                <div class="custom-select-option" data-scope="grade" data-grade="senior1" style="padding-left: 2.5rem;">
                  <i class="fas fa-star mr-2"></i>S√©nior 1
                </div>
                <div class="custom-select-option" data-scope="grade" data-grade="senior2" style="padding-left: 2.5rem;">
                  <i class="fas fa-star mr-2"></i>S√©nior 2
                </div>
                <div class="custom-select-option" data-scope="grade" data-grade="senior3" style="padding-left: 2.5rem;">
                  <i class="fas fa-star mr-2"></i>S√©nior 3
                </div>
              </div>
            </div>
          </div>
          <!-- Dropdown de p√©riode (cach√© sur mobile) -->
          <div style="position: relative;" class="hidden md:block">
          <div class="custom-select" id="periodeSelect" style="width: auto; min-width: 180px;">
            <button class="custom-select-button" id="periodeBtn" style="min-height: 40px; padding: 8px 14px;">
              <span class="custom-select-text" id="periodeBtnText">
                <i class="fas fa-calendar-alt mr-2"></i>Toute l'ann√©e
              </span>
              <i class="fas fa-chevron-down custom-select-arrow"></i>
            </button>
            <div class="custom-select-dropdown" id="periodeDropdown">
              <div class="custom-select-option" data-periode="annee">Toute l'ann√©e</div>
              <div class="custom-select-option" data-periode="90">90 derniers jours</div>
              <div class="custom-select-option" data-periode="30">30 derniers jours</div>
              <div class="custom-select-option" data-periode="14">14 derniers jours</div>
              <div class="custom-select-option" data-periode="semaine">Cette semaine</div>
              <div class="custom-select-option" data-periode="custom">Personnaliser...</div>
            </div>
          </div>
          <!-- Date picker personnalis√© -->
          <div class="custom-calendar hidden" id="customDatePicker" style="position: absolute; right: 0; top: 100%; margin-top: 0.5rem; width: 600px; background: #1a2332; border: 2px solid #334155; border-radius: 12px; padding: 1.5rem; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); z-index: 1000;">
            <div style="display: flex; gap: 1rem;">
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: #e2e8f0; font-weight: 500;">Date de d√©but</label>
                <div id="startCalendar" class="coach-custom-calendar-widget"></div>
              </div>
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: #e2e8f0; font-weight: 500;">Date de fin</label>
                <div id="endCalendar" class="coach-custom-calendar-widget"></div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: flex-end;">
              <button id="applyCustomDate" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.875rem;">Appliquer</button>
              <button id="cancelCustomDate" style="padding: 0.5rem 1rem; background: #0f172a; color: #e2e8f0; border: 1px solid #334155; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.875rem;">Annuler</button>
            </div>
          </div>
          </div>
        </div>
      </div>

      <!-- Sous-titre avec message "Cette semaine" (cach√© sur mobile) -->
      <div class="hidden md:flex justify-between items-center mb-4">
        <p style="color: var(--text-gray);">Classement de tous les entrepreneurs</p>
        <span id="semaineInfo" class="text-xs hidden" style="color: #f59e0b;"><i class="fas fa-exclamation-triangle mr-1"></i></span>
      </div>

      <!-- Dropdown de filtrage d'entrepreneurs (visible uniquement sur mobile) -->
      <div id="entrepreneurScopeMobileContainer" style="position: relative; margin-bottom: 1rem;">
        <div class="custom-select" id="entrepreneurScopeSelect" style="width: auto; min-width: 220px;">
          <button class="custom-select-button" id="entrepreneurScopeBtn" style="min-height: 40px; padding: 8px 14px;">
            <span class="custom-select-text" id="entrepreneurScopeBtnText">
              <i class="fas fa-users mr-2"></i>Tous les entrepreneurs
            </span>
            <i class="fas fa-chevron-down custom-select-arrow"></i>
          </button>
          <div class="custom-select-dropdown" id="entrepreneurScopeDropdown">
            <div class="custom-select-option" data-scope="tous">
              <i class="fas fa-users mr-2"></i>Tous les entrepreneurs
            </div>
            <div class="custom-select-option" data-scope="grade" data-grade="recrue" style="padding-left: 2.5rem;">
              <i class="fas fa-seedling mr-2"></i>Recrue
            </div>
            <div class="custom-select-option" data-scope="grade" data-grade="senior1" style="padding-left: 2.5rem;">
              <i class="fas fa-star mr-2"></i>S√©nior 1
            </div>
            <div class="custom-select-option" data-scope="grade" data-grade="senior2" style="padding-left: 2.5rem;">
              <i class="fas fa-star mr-2"></i>S√©nior 2
            </div>
            <div class="custom-select-option" data-scope="grade" data-grade="senior3" style="padding-left: 2.5rem;">
              <i class="fas fa-star mr-2"></i>S√©nior 3
            </div>
          </div>
        </div>
      </div>

      <!-- Ligne s√©paratrice -->
      <div class="mb-6" style="border-bottom: 1px solid var(--border-dark);"></div>

      <!-- Version Mobile - Cartes -->
      <div class="classement-mobile-container" style="display: none;">
        <div id="classementMobileCards">
          <!-- Les cartes seront charg√©es ici dynamiquement -->
          <div class="text-center py-8" style="color: var(--text-gray);">
            <i class="fas fa-spinner fa-spin mr-2"></i>Chargement des donn√©es...
          </div>
        </div>
      </div>

      <!-- Version Desktop - Tableau -->
      <div class="classement-table-container overflow-x-auto">
        <table class="w-full" id="classementTable">
          <thead>
            <!-- Headers de colonnes (sans cat√©gories) -->
            <tr class="border-b" style="border-color: var(--border-dark);">
              <th class="text-center py-4 px-4 text-sm font-semibold" style="color: var(--text-light);">Rang</th>
              <th class="text-left py-4 px-4 text-sm font-semibold" style="color: var(--text-light);">Entrepreneur</th>
              <th class="text-left py-2 px-4 text-xs font-semibold sortable-header active" data-sort="ca" style="color: var(--text-light); cursor: pointer;">$ Vendus</th>
              <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="pap" style="color: var(--text-light); cursor: pointer;">Hr PAP</th>
              <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="marketing" style="color: var(--text-light); cursor: pointer;">Taux MKG</th>
              <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="signees" style="color: var(--text-light); cursor: pointer;">Contrat sign√©</th>
              <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="estimations" style="color: var(--text-light); cursor: pointer;">Nb Estimations</th>
              <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="contrat" style="color: var(--text-light); cursor: pointer;">Contrat moyen</th>
              <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="tv" style="color: var(--text-light); cursor: pointer;">Taux de vente</th>
              <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="produit" style="color: var(--text-light); cursor: pointer;">$ Produits</th>
              <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="prod" style="color: var(--text-light); cursor: pointer;">Prod/h</th>
              <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="etoiles" style="color: var(--text-light); cursor: pointer;">Satisfaction</th>
            </tr>
          </thead>
          <tbody id="classementTableBody">
            <!-- Les entrepreneurs seront charg√©s ici dynamiquement -->
            <tr>
              <td colspan="12" class="text-center py-8" style="color: var(--text-gray);">
                <i class="fas fa-spinner fa-spin mr-2"></i>Chargement des donn√©es...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Modal Stats Entrepreneur (Mobile uniquement) -->
  <div id="entrepreneurStatsModal" class="entrepreneur-stats-modal" onclick="closeEntrepreneurStats(event)">
    <div class="entrepreneur-stats-content" onclick="event.stopPropagation()">
      <button class="entrepreneur-stats-close" onclick="closeEntrepreneurStats()">
        <i class="fas fa-times"></i>
      </button>
      <div class="entrepreneur-stats-header">
        <div id="statsEntrepreneurPhoto"></div>
        <div style="flex: 1;">
          <div class="entrepreneur-stats-name" id="statsEntrepreneurName">-</div>
          <div class="entrepreneur-stats-rang" id="statsEntrepreneurRang">-</div>
        </div>
      </div>
      <div class="entrepreneur-stats-grid" id="statsEntrepreneurGrid">
        <!-- Les stats seront charg√©es ici dynamiquement -->
      </div>
    </div>
  </div>

  <!-- Modal de statistiques complet (User Stats Modal) -->
  <div id="user-stats-modal" class="stats-modal">
    <div class="stats-modal-content">
      <!-- Header du modal -->
      <div class="stats-modal-header">
        <h2><i class="fas fa-chart-line"></i> Statistiques<span class="stats-modal-title-extra"> de Progression</span></h2>
        <button class="stats-modal-close" onclick="closeUserStatsModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Contenu du modal -->
      <div class="stats-modal-body">
        <!-- SECTION 1: PROFIL COMPLET (Photo + Nom + Grade + Progression) -->
        <div class="stats-section">
          <div class="stats-unified-card">
            <!-- Version Desktop - Structure originale -->
            <div class="desktop-stats-profile">
              <div class="stats-profile-header">
                <div class="stats-profile-photo-banner">
                  <div class="stats-profile-photo-wrapper">
                    <div class="stats-profile-photo-container">
                      <img id="user-stats-profile-photo" src="" alt="Photo de profil" class="stats-profile-photo">
                    </div>
                    <div class="stats-photo-level-banner">
                      <span>Niv. <span id="user-stats-photo-level-text">1</span></span>
                    </div>
                  </div>
                </div>
                <div class="stats-profile-info">
                  <div class="stats-name-xp-row">
                    <div style="display: flex; align-items: baseline; gap: 1rem;">
                      <h3 id="user-stats-username">Username</h3>
                      <div class="stats-grade-name-display" id="user-stats-grade-name-display">D√©marrage</div>
                    </div>
                    <div class="stats-xp-text-inline">
                      <span id="user-stats-xp-current">0</span> / <span id="user-stats-xp-next">100</span> XP
                      <span class="stats-xp-percentage" id="user-stats-xp-percentage">(0%)</span>
                    </div>
                  </div>
                  <!-- Barre XP sous le nom -->
                  <div class="stats-xp-bar">
                    <div class="stats-xp-fill" id="user-stats-xp-fill" style="width: 0%"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Version Mobile - Structure simplifi√©e -->
            <div class="mobile-stats-profile">
              <!-- Section 1: Photo + Nom/Grade -->
              <div class="stats-photo-nom-section">
                <div class="stats-profile-photo-banner">
                  <div class="stats-profile-photo-wrapper">
                    <div class="stats-profile-photo-container">
                      <img id="user-stats-profile-photo-mobile" src="" alt="Photo de profil" class="stats-profile-photo">
                    </div>
                    <div class="stats-photo-level-banner">
                      <span>Niv. <span id="user-stats-photo-level-text-mobile">1</span></span>
                    </div>
                  </div>
                </div>
                <div class="stats-profile-nom-grade">
                  <div style="display: flex; align-items: baseline; gap: 1rem;">
                    <h3 id="user-stats-username-mobile">Username</h3>
                    <div class="stats-grade-name-display" id="user-stats-grade-name-display-mobile">D√©marrage</div>
                  </div>
                </div>
              </div>

              <!-- Section 2: Barre de Progression XP -->
              <div class="stats-xp-section">
                <div class="stats-xp-text-inline">
                  <span id="user-stats-xp-current-mobile">0</span> / <span id="user-stats-xp-next-mobile">100</span> XP
                  <span class="stats-xp-percentage" id="user-stats-xp-percentage-mobile">(0%)</span>
                </div>
                <div class="stats-xp-bar">
                  <div class="stats-xp-fill" id="user-stats-xp-fill-mobile" style="width: 0%"></div>
                </div>
              </div>
            </div>

            <!-- Section 3: Vers Prochain Grade -->
            <div class="stats-next-grade-section">
              <h4 class="stats-subsection-title">Vers Prochain Grade</h4>
              <div class="stats-next-grade-content">
                <div class="stats-grade-badge-left">
                  <img id="user-stats-current-grade-badge" src="" alt="Grade actuel">
                </div>
                <div class="stats-next-grade-info">
                  <div class="stats-next-grade-levels">
                    <span id="user-stats-current-level-text">Niv 1</span>
                    <span id="user-stats-next-level-text">Niv 2</span>
                  </div>
                  <div class="stats-next-grade-bar">
                    <div class="stats-next-grade-fill" id="user-stats-next-grade-fill" style="width: 0%"></div>
                  </div>
                </div>
                <div class="stats-grade-badge-right">
                  <img id="user-stats-next-grade-badge" src="" alt="Prochain grade">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECTION 2: MES BADGES -->
        <div class="stats-section">
          <div class="badges-header">
            <h3 class="stats-section-title"><i class="fas fa-medal"></i> Badges</h3>
            <button class="badges-expand-btn" id="user-badges-expand-btn" onclick="toggleUserBadgesSection()">
              <span id="user-badges-expand-text">Voir tous</span>
              <i class="fas fa-chevron-down" id="user-badges-expand-icon"></i>
            </button>
          </div>

          <!-- Top 5 badges (visible par d√©faut) -->
          <div class="badges-top-container" id="user-badges-top-container">
            <div class="top-badges-title">
              <i class="fas fa-trophy"></i>
              <span>5 Meilleurs Badges</span>
            </div>
            <div class="badges-horizontal-scroll" id="user-stats-badges-top">
              <!-- Les 5 meilleurs badges seront charg√©s ici -->
              <div class="no-badges-message">Chargement des badges...</div>
            </div>
          </div>

          <!-- Tous les badges par raret√© (cach√© par d√©faut avec animation) -->
          <div class="badges-grid" id="user-stats-badges-grid">
            <!-- Les badges seront charg√©s ici par JavaScript -->
          </div>
        </div>

        <!-- SECTION 3: STATISTIQUES COMPL√àTES -->
        <div class="stats-section">
          <h3 class="stats-section-title"><i class="fas fa-chart-bar"></i> Toutes les Statistiques</h3>

          <!-- Toutes les stats -->
          <div class="stats-tables-grid">
            <table class="stats-table">
              <tbody>
                <tr>
                  <td class="stat-label">XP Total</td>
                  <td class="stat-value" id="user-stats-total-xp">0</td>
                </tr>
              </tbody>
            </table>
            <table class="stats-table">
              <tbody>
                <tr>
                  <td class="stat-label">Badges</td>
                  <td class="stat-value" id="user-stats-badges">0</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="stats-tables-grid">
            <table class="stats-table">
              <tbody>
                <tr>
                  <td class="stat-label">Dollars ($) vendu</td>
                  <td class="stat-value" id="user-stats-ca-actuel">0 $</td>
                </tr>
                <tr>
                  <td class="stat-label">Contrats sign√©s</td>
                  <td class="stat-value" id="user-stats-contrats-signes">0</td>
                </tr>
                <tr>
                  <td class="stat-label">Satisfaction</td>
                  <td class="stat-value" id="user-stats-satisfaction">0</td>
                </tr>
                <tr>
                  <td class="stat-label">Contrat moyen</td>
                  <td class="stat-value" id="user-stats-contrat-moyen">0 $</td>
                </tr>
              </tbody>
            </table>
            <table class="stats-table">
              <tbody>
                <tr>
                  <td class="stat-label">Taux marketing</td>
                  <td class="stat-value" id="user-stats-taux-marketing">0%</td>
                </tr>
                <tr>
                  <td class="stat-label">Taux de vente</td>
                  <td class="stat-value" id="user-stats-taux-vente">0%</td>
                </tr>
                <tr>
                  <td class="stat-label">Productivit√©/h</td>
                  <td class="stat-value" id="user-stats-prod-horaire">0 $/h</td>
                </tr>
                <tr>
                  <td class="stat-label">H de P√ÄP</td>
                  <td class="stat-value" id="user-stats-heures-pap">0 h</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup Plainte -->
  <div id="plaintePopup" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-2xl shadow-2xl" onclick="event.stopPropagation()" style="border: 2px solid var(--border-dark); width: 600px; height: 70vh; display: flex; flex-direction: column;">

      <!-- Vue: Liste des plaintes -->
      <div id="plaintesListe" style="display: flex; flex-direction: column; height: 100%;">
        <div class="flex items-center justify-between p-6 pb-4">
          <h3 class="text-xl font-bold flex items-center gap-2" style="color: var(--text-light);">
            <i class="fas fa-exclamation-triangle" style="color: #f87171;"></i>
            <span>Mes plaintes (<span id="plaintesCount">0</span>)</span>
          </h3>
          <button onclick="fermerPlaintePopup()" class="text-gray-400 hover:text-red-500 transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <div class="space-y-2 px-6 pb-6" id="plaintesListeContainer" style="flex: 1; overflow-y: auto; overflow-x: hidden;">
          <!-- Les plaintes seront ins√©r√©es dynamiquement ici -->
        </div>
      </div>

      <!-- Vue: D√©tails d'une plainte -->
      <div id="plainteDetails" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
        <!-- Le contenu sera ins√©r√© dynamiquement -->
      </div>

    </div>
    <!-- FIN entrepreneur-dashboard-content -->

  </div>
  <!-- FIN div class="w-full" -->

  <!-- D√âBUT coach-dashboard-content (Mon √âquipe) - SORTI du conteneur w-full -->
  <div id="coach-dashboard-content" style="display: none; width: 100%;">
      <!-- Spinner de chargement - D√âSACTIV√â -->
      <div id="coach-dashboard-loading" style="display: none !important;">
        <div style="width: 60px; height: 60px; border: 4px solid rgba(96, 165, 250, 0.2); border-top: 4px solid #60a5fa; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 1.5rem; color: var(--text-gray); font-size: 1rem;">Chargement des donn√©es de l'√©quipe...</p>
      </div>

      <!-- Contenu du dashboard (cach√© pendant le chargement) -->
      <div id="coach-dashboard-main-content" style="display: none; opacity: 0; transition: opacity 0.3s ease-in;">
      <!-- Header de la page -->
      <div class="page-header fade-in-up">
        <h1 id="coach-dashboard-title" class="text-4xl font-bold mb-3">
          Mon √âquipe
        </h1>

        <div class="header-content mt-4">
          <div class="relative">
            <p class="text-xl font-medium">
              <span>Statistiques compl√®tes et visualisations en temps r√©el</span>
            </p>
            <span id="coach-dashboard-accent" class="absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-blue-600 to-blue-400 rounded-full"></span>
          </div>
        </div>
      </div>

      <!-- Barre de progression objectif (pleine largeur) -->
      <div id="objectifProgressContainer">
        <!-- Objectif progress bar will be generated dynamically -->
      </div>

      <!-- Stats globales -->
      <div class="stats-grid" id="statsGrid">
        <!-- Stats will be generated dynamically -->
      </div>

      <!-- Section graphiques -->
      <div class="charts-section">

        <!-- Graphique performance -->
        <div class="chart-card fade-in-up">
          <div class="chart-header">
            <h3 class="chart-title">
              <i class="fas fa-chart-line"></i>
              Performance de l'√©quipe
            </h3>
          </div>
          <div class="chart-container">
            <canvas id="performanceChart"></canvas>
          </div>
        </div>

        <!-- Graphique $ produit par mois -->
        <div class="chart-card fade-in-up">
          <div class="chart-header">
            <h3 class="chart-title">
              <i class="fas fa-chart-line"></i>
              $ Produit par mois
            </h3>
          </div>
          <div class="chart-container">
            <canvas id="produitMensuelChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Liste des entrepreneurs -->
      <div class="entrepreneurs-section fade-in-up">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
          <div style="display: flex; align-items: center; gap: 2rem;">
            <h2 class="section-title" id="coachGridTitle" style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 10px; opacity: 1; transition: opacity 0.3s;" onclick="showCoachGrid()" title="Voir la grille des membres">
              <i class="fas fa-th"></i>
              <span>Membres de l'√©quipe</span>
            </h2>
            <h2 class="section-title" id="coachClassementEntrepreneursTitle" style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 10px; opacity: 0.5; transition: opacity 0.3s;" onclick="showCoachClassement()" title="Voir le classement entrepreneurs">
              <i class="fas fa-trophy"></i>
              <span>Classement Entrepreneurs</span>
            </h2>
            <h2 class="section-title" id="coachClassementCoachTitle" style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 10px; opacity: 0.5; transition: opacity 0.3s;" onclick="showCoachClassementCoach()" title="Voir le classement coach">
              <i class="fas fa-medal"></i>
              <span>Classement Coach</span>
            </h2>
          </div>
          <button id="coachPersonnaliserBtn" onclick="openPersonaliserModal()" class="btn-primary" style="padding: 0.75rem 1.5rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem; border: none; cursor: pointer;">
            <i class="fas fa-cog"></i>
            Personnaliser
          </button>
        </div>

        <!-- Vue Grille -->
        <div id="entrepreneursContainer" class="entrepreneurs-grid">
          <div class="loading-spinner">
            <i class="fas fa-spinner"></i>
          </div>
        </div>

        <!-- Vue Classement -->
        <div id="coachClassementContainer" style="display: none;">
          <!-- Copie EXACTE de la section classement principale -->
          <div class="chart-container p-8 mb-8">
            <!-- Titre avec boutons Classement et P√©riode -->
            <div class="flex justify-between items-center mb-2">
              <h2 class="text-2xl font-bold">Classement</h2>
              <div style="display: flex; gap: 12px;">
                <!-- Dropdown Classement par -->
                <div class="custom-select" id="coachScopeSelect" style="width: 280px;">
                  <button class="custom-select-button" id="coachScopeBtn" style="min-height: 40px; padding: 8px 14px;">
                    <span class="custom-select-text" id="coachScopeBtnText">
                      <i class="fas fa-user-friends mr-2"></i>Mon √©quipe
                    </span>
                    <i class="fas fa-chevron-down custom-select-arrow"></i>
                  </button>
                  <div class="custom-select-dropdown" id="coachScopeDropdown">
                    <!-- Options pour Dashboard Qualit√© √âtudiants (grades) -->
                    <div class="custom-select-option coach-scope-grade-option" data-scope="tous" style="display: none;">
                      <i class="fas fa-users mr-2"></i>Tous les entrepreneurs
                    </div>
                    <div class="custom-select-option coach-scope-grade-option" data-scope="grade" data-grade="recrue" style="padding-left: 2.5rem; display: none;">
                      <i class="fas fa-seedling mr-2"></i>Recrue
                    </div>
                    <div class="custom-select-option coach-scope-grade-option" data-scope="grade" data-grade="senior1" style="padding-left: 2.5rem; display: none;">
                      <i class="fas fa-star mr-2"></i>S√©nior 1
                    </div>
                    <div class="custom-select-option coach-scope-grade-option" data-scope="grade" data-grade="senior2" style="padding-left: 2.5rem; display: none;">
                      <i class="fas fa-star mr-2"></i>S√©nior 2
                    </div>
                    <div class="custom-select-option coach-scope-grade-option" data-scope="grade" data-grade="senior3" style="padding-left: 2.5rem; display: none;">
                      <i class="fas fa-star mr-2"></i>S√©nior 3
                    </div>
                    <!-- Options pour Mon √âquipe / Par Coach (coaches) -->
                    <div class="custom-select-option coach-scope-team-option" data-scope="equipe">
                      <i class="fas fa-user-friends mr-2"></i>Mon √©quipe
                    </div>
                    <div class="custom-select-option coach-scope-team-option" data-scope="tous">
                      <i class="fas fa-users mr-2"></i>Tous les entrepreneurs
                    </div>
                  </div>
                </div>
                <!-- Bouton S√©lection de P√©riode -->
                <div class="custom-select" id="coachPeriodeSelect" style="width: auto; min-width: 200px;">
                  <button class="custom-select-button" id="coachPeriodeBtn" style="min-height: 40px; padding: 8px 14px;">
                    <span class="custom-select-text" id="coachPeriodeBtnText">
                      <i class="fas fa-calendar-alt mr-2"></i>Toute l'ann√©e
                    </span>
                    <i class="fas fa-chevron-down custom-select-arrow"></i>
                  </button>
                  <!-- Dropdown cach√© - remplac√© par le modal -->
                  <div class="custom-select-dropdown hidden" id="coachPeriodeDropdown" style="display: none;">
                  </div>

                  <!-- S√©lecteur de dates personnalis√© -->
                  <div class="custom-calendar hidden" id="coachCustomDatePicker" style="position: absolute; top: 100%; right: 0; margin-top: 4px; width: 600px; padding: 1rem; background: #1a2332; border: 2px solid var(--border-dark); border-radius: 8px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); z-index: 10000;">
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                      <!-- Calendrier Date de d√©but -->
                      <div style="flex: 1;">
                        <label style="display: block; color: var(--text-gray); font-size: 0.875rem; margin-bottom: 0.5rem; font-weight: 600;">Date de d√©but</label>
                        <div id="coachStartCalendar" class="coach-custom-calendar-widget" style="background: #0f172a; border: 1px solid var(--border-dark); border-radius: 8px; padding: 12px;"></div>
                      </div>

                      <!-- Calendrier Date de fin -->
                      <div style="flex: 1;">
                        <label style="display: block; color: var(--text-gray); font-size: 0.875rem; margin-bottom: 0.5rem; font-weight: 600;">Date de fin</label>
                        <div id="coachEndCalendar" class="coach-custom-calendar-widget" style="background: #0f172a; border: 1px solid var(--border-dark); border-radius: 8px; padding: 12px;"></div>
                      </div>
                    </div>

                    <div style="display: flex; gap: 0.5rem;">
                      <button id="coachApplyCustomDate" style="flex: 1; padding: 0.5rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Appliquer</button>
                      <button id="coachCancelCustomDate" style="flex: 1; padding: 0.5rem; background: #1e293b; color: var(--text-light); border: 1px solid var(--border-dark); border-radius: 4px; cursor: pointer;">Annuler</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sous-titre -->
            <div class="flex justify-between items-center mb-4">
              <p style="color: var(--text-gray);">Classement de tous les entrepreneurs</p>
            </div>

            <!-- Ligne s√©paratrice -->
            <div class="mb-6" style="border-bottom: 1px solid var(--border-dark);"></div>

            <!-- Version Mobile - Cartes -->
            <div class="classement-mobile-container" style="display: none;">
              <div id="coachClassementMobileCards">
                <!-- Les cartes seront charg√©es ici dynamiquement -->
                <div class="text-center py-8" style="color: var(--text-gray);">
                  <i class="fas fa-spinner fa-spin mr-2"></i>Chargement des donn√©es...
                </div>
              </div>
            </div>

            <!-- Version Desktop - Tableau -->
            <div class="classement-table-container overflow-x-auto">
              <table class="w-full" id="coachClassementTable">
                <thead>
                  <!-- Headers de colonnes (sans cat√©gories) -->
                  <tr class="border-b" style="border-color: var(--border-dark);">
                    <th class="text-center py-4 px-4 text-sm font-semibold" style="color: var(--text-light);">Rang</th>
                    <th class="text-left py-4 px-4 text-sm font-semibold" style="color: var(--text-light);">Entrepreneur</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header active" data-sort="ca" style="color: var(--text-light); cursor: pointer;">$ Vendus</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="pap" style="color: var(--text-light); cursor: pointer;">Hr PAP</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="marketing" style="color: var(--text-light); cursor: pointer;">Taux MKG</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="signees" style="color: var(--text-light); cursor: pointer;">Contrat sign√©</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="estimations" style="color: var(--text-light); cursor: pointer;">Nb Estimations</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="contrat" style="color: var(--text-light); cursor: pointer;">Contrat moyen</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="tv" style="color: var(--text-light); cursor: pointer;">Taux de vente</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="produit" style="color: var(--text-light); cursor: pointer;">$ Produits</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="prod" style="color: var(--text-light); cursor: pointer;">Prod/h</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="etoiles" style="color: var(--text-light); cursor: pointer;">Satisfaction</th>
                  </tr>
                </thead>
                <tbody id="coachClassementTableBody">
                  <!-- Les entrepreneurs seront charg√©s ici dynamiquement -->
                  <tr>
                    <td colspan="12" class="text-center py-8" style="color: var(--text-gray);">
                      <i class="fas fa-spinner fa-spin mr-2"></i>Chargement des donn√©es...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Vue Classement Coach -->
        <div id="coachClassementCoachContainer" style="display: none;">
          <!-- Copie EXACTE de la section classement principale mais pour les coachs -->
          <div class="chart-container p-8 mb-8">
            <!-- Titre avec boutons Classement et P√©riode -->
            <div class="flex justify-between items-center mb-2">
              <h2 class="text-2xl font-bold">Classement Coach</h2>
              <div style="display: flex; gap: 12px;">
                <!-- Bouton S√©lection de P√©riode (m√™me modal que classement entrepreneur) -->
                <div class="custom-select" id="coachClassementCoachPeriodeSelect" style="width: auto; min-width: 200px;">
                  <button class="custom-select-button" id="coachClassementCoachPeriodeBtn" style="min-height: 40px; padding: 8px 14px;">
                    <span class="custom-select-text" id="coachClassementCoachPeriodeBtnText">
                      <i class="fas fa-calendar-alt mr-2"></i>Toute l'ann√©e
                    </span>
                    <i class="fas fa-chevron-down custom-select-arrow"></i>
                  </button>
                  <!-- Dropdown cach√© - remplac√© par le modal -->
                  <div class="custom-select-dropdown hidden" id="coachClassementCoachPeriodeDropdown" style="display: none;">
                  </div>
                </div>
              </div>
            </div>

            <!-- Sous-titre -->
            <div class="flex justify-between items-center mb-4">
              <p style="color: var(--text-gray);">Classement de tous les coachs</p>
            </div>

            <!-- Ligne s√©paratrice -->
            <div class="mb-6" style="border-bottom: 1px solid var(--border-dark);"></div>

            <!-- Version Mobile - Cartes -->
            <div class="classement-mobile-container" style="display: none;">
              <div id="coachClassementCoachMobileCards">
                <!-- Les cartes seront charg√©es ici dynamiquement -->
                <div class="text-center py-8" style="color: var(--text-gray);">
                  <i class="fas fa-spinner fa-spin mr-2"></i>Chargement des donn√©es...
                </div>
              </div>
            </div>

            <!-- Version Desktop - Tableau -->
            <div class="classement-table-container overflow-x-auto">
              <table class="w-full" id="coachClassementCoachTable">
                <thead>
                  <!-- Headers de colonnes (sans cat√©gories) -->
                  <tr class="border-b" style="border-color: var(--border-dark);">
                    <th class="text-center py-4 px-4 text-sm font-semibold" style="color: var(--text-light);">Rang</th>
                    <th class="text-left py-4 px-4 text-sm font-semibold" style="color: var(--text-light);">Coach</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header active" data-sort="ca" style="color: var(--text-light); cursor: pointer;">$ Vendus</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="pap" style="color: var(--text-light); cursor: pointer;">Hr PAP</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="marketing" style="color: var(--text-light); cursor: pointer;">Taux MKG</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="signees" style="color: var(--text-light); cursor: pointer;">Contrat sign√©</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="estimations" style="color: var(--text-light); cursor: pointer;">Nb Estimations</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="contrat" style="color: var(--text-light); cursor: pointer;">Contrat moyen</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="tv" style="color: var(--text-light); cursor: pointer;">Taux de vente</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="produit" style="color: var(--text-light); cursor: pointer;">$ Produits</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="prod" style="color: var(--text-light); cursor: pointer;">Prod/h</th>
                    <th class="text-left py-2 px-4 text-xs font-semibold sortable-header" data-sort="etoiles" style="color: var(--text-light); cursor: pointer;">Satisfaction</th>
                  </tr>
                </thead>
                <tbody id="coachClassementCoachTableBody">
                  <!-- Les coachs seront charg√©s ici dynamiquement -->
                  <tr>
                    <td colspan="12" class="text-center py-8" style="color: var(--text-gray);">
                      <i class="fas fa-spinner fa-spin mr-2"></i>Chargement des donn√©es...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      </div>
      <!-- FIN coach-dashboard-main-content -->

  </div>
  <!-- FIN coach-dashboard-content -->

</div>
<!-- FIN main-content -->

<!-- Modal Personnaliser -->
<div id="personaliserModal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
  <div style="background: var(--bg-card); border-radius: 16px; width: 95%; height: 780px; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); border: 1px solid rgba(96, 165, 250, 0.3);">
    <!-- Header -->
    <div style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-dark); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
      <h2 style="margin: 0; color: var(--text-light); font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
        <i class="fas fa-cog" style="color: #60a5fa; font-size: 0.875rem;"></i>
        Personnaliser l'affichage
      </h2>
      <button onclick="closePersonaliserModal()" style="background: none; border: none; color: var(--text-gray); font-size: 1.125rem; cursor: pointer; padding: 0.25rem; transition: color 0.3s ease;">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Content -->
    <div style="padding: 0.75rem 1rem; flex: 1; overflow: hidden;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; height: 100%;">

        <!-- Colonne gauche: Aper√ßu -->
        <div style="display: flex; flex-direction: column;">
          <h3 style="color: var(--text-light); margin-bottom: 0.5rem; font-size: 0.875rem;">
            <i class="fas fa-eye" style="color: #60a5fa; margin-right: 0.25rem; font-size: 0.75rem;"></i>
            Aper√ßu
          </h3>

          <!-- Example Entrepreneur Card -->
          <div id="previewCard" class="entrepreneur-card fade-in-up" style="overflow-y: auto; max-height: 100%;">
            <div class="entrepreneur-header">
              <img src="https://i.ibb.co/twJsgZrb/Design-sans-titre-39.png" alt="Jean Exemple" class="entrepreneur-photo">
              <div class="entrepreneur-info">
                <h3>Jean Exemple</h3>
                <span class="grade"><i class="fas fa-star"></i> Recrue</span>
              </div>
            </div>

            <div id="previewStatsContainer">
              <!-- Les stats seront g√©n√©r√©es ici dynamiquement -->
            </div>

            <div id="previewActions" class="entrepreneur-actions">
              <button type="button" class="action-btn primary" style="pointer-events: none; opacity: 0.7;">
                <i class="fas fa-chart-line"></i> Dashboard
              </button>
              <button type="button" class="action-btn secondary" style="pointer-events: none; opacity: 0.7;">
                <i class="fas fa-envelope"></i> Contact
              </button>
            </div>
          </div>
        </div>

        <!-- Colonne droite: Personnalisation -->
        <div style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
          <!-- Header avec boutons -->
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.375rem; flex-shrink: 0;">
            <h3 style="color: var(--text-light); margin: 0; font-size: 0.875rem;">
              <i class="fas fa-sliders-h" style="color: #60a5fa; margin-right: 0.25rem; font-size: 0.75rem;"></i>
              Personnaliser
            </h3>
            <div style="display: flex; gap: 0.375rem;">
              <button id="saveBtn" onclick="saveCustomization()" style="display: none; padding: 0.375rem 0.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 4px; font-weight: 600; font-size: 0.6875rem; cursor: pointer; align-items: center; gap: 0.25rem; transition: all 0.2s ease;">
                <i id="saveIcon" class="fas fa-save" style="font-size: 0.625rem;"></i>
                <span id="saveText">Enregistrer</span>
              </button>
              <button onclick="resetToDefault()" style="padding: 0.375rem; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 4px; font-weight: 600; font-size: 0.6875rem; cursor: pointer; transition: all 0.2s ease;">
                <i class="fas fa-undo" style="font-size: 0.625rem;"></i>
              </button>
            </div>
          </div>
          <p style="color: var(--text-gray); font-size: 0.6875rem; margin-bottom: 0.375rem; flex-shrink: 0;">
            Glissez pour r√©organiser ‚Ä¢ <i class="fas fa-times" style="color: #ef4444;"></i> retirer
          </p>

          <!-- Message d'erreur max stats -->
          <div id="maxStatsWarning" style="display: none; padding: 0.5rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; margin-bottom: 0.5rem; flex-shrink: 0;">
            <p style="color: #ef4444; font-size: 0.6875rem; margin: 0; display: flex; align-items: center; gap: 0.375rem;">
              <i class="fas fa-exclamation-circle"></i>
              <span>Maximum de 12 statistiques actives atteint</span>
            </p>
          </div>

          <!-- Stats actives -->
          <div style="margin-bottom: 0.5rem; flex-shrink: 0;">
            <h4 style="color: var(--text-light); font-size: 0.75rem; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.25rem;">
              <i class="fas fa-check-circle" style="color: #10b981; font-size: 0.625rem;"></i>
              Actives
            </h4>
            <div id="activeStats" style="display: flex; flex-direction: column; gap: 0.25rem; max-height: 340px; overflow-y: auto; padding: 0.5rem; background: rgba(15, 23, 42, 0.5); border-radius: 8px; border: 2px dashed rgba(96, 165, 250, 0.3);">
              <!-- Les stats actives seront ici -->
            </div>
          </div>

          <!-- Stats disponibles -->
          <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
            <h4 style="color: var(--text-light); font-size: 0.75rem; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.25rem; flex-shrink: 0;">
              <i class="fas fa-plus-circle" style="color: #8b5cf6; font-size: 0.625rem;"></i>
              Disponibles
            </h4>
            <div id="availableStats" style="display: flex; flex-direction: column; gap: 0.25rem; flex: 1; overflow-y: auto; padding: 0.5rem; background: rgba(15, 23, 42, 0.3); border-radius: 8px;">
              <!-- Les stats disponibles seront ici -->
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  // ‚ö° D√âSACTIVATION DES LOGS - Performance optimization
  window.log = () => {};
  window.warn = () => {};
  window.error = () => {};
  window.info = () => {};
  window.debug = () => {};

  // Variables globales
  let revenueChart;
  let lastSelectedShortcut = null; // Pour tracker le dernier raccourci s√©lectionn√©
  
  // Fonction globale pour obtenir le type de donn√©es s√©lectionn√©
  function getSelectedChartType() {
    // Essayer d'abord le dropdown PC, puis mobile
    let selectedOption = document.querySelector('#chart-type-dropdown-menu .agenda-dropdown-option.selected');
    if (!selectedOption) {
      selectedOption = document.querySelector('#mobile-chart-type-dropdown-menu .agenda-dropdown-option.selected');
    }
    return selectedOption ? selectedOption.getAttribute('data-value') : 'montant-signe';
  }

  // Fonctions pour m√©moriser la p√©riode s√©lectionn√©e
  function savePeriodSelection(type, value = null) {
    const selection = { type, value };
    localStorage.setItem(`dashboard-period-${username}`, JSON.stringify(selection));
  }

  function getSavedPeriodSelection() {
    const saved = localStorage.getItem(`dashboard-period-${username}`);
    return saved ? JSON.parse(saved) : null;
  }

  function restoreActiveShortcut() {
    const saved = getSavedPeriodSelection();
    if (!saved || saved.type !== 'shortcut') return;

    // Retirer toutes les classes actives
    document.querySelectorAll('.dashboard-shortcut-btn').forEach(btn => {
      btn.classList.remove('active');
    });

    // Activer le bon bouton
    if (saved.value === 'thisYear') {
      const yearBtn = document.getElementById('thisYear');
      if (yearBtn) yearBtn.classList.add('active');
    } else {
      const targetBtn = document.querySelector(`[data-days="${saved.value}"]`);
      if (targetBtn) targetBtn.classList.add('active');
    }
  }

  // Initialisation du graphique moderne
  function initChart() {
    const ctx = document.getElementById('revenueChart').getContext('2d');
    
    revenueChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Revenus',
          data: [],
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 0,
          pointHoverRadius: 8,
          pointHoverBackgroundColor: '#3b82f6',
          pointHoverBorderColor: '#ffffff',
          pointHoverBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: '#1e293b',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            cornerRadius: 8,
            displayColors: false,
            callbacks: {
              title: function(context) {
                // Utiliser les dates compl√®tes stock√©es dans le graphique
                const chart = context[0].chart;
                if (chart.allDatesForTooltips && chart.allDatesForTooltips[context[0].dataIndex]) {
                  return chart.allDatesForTooltips[context[0].dataIndex];
                }
                return context[0].label;
              },
              label: function(context) {
                const selectedType = getSelectedChartType();
                
                let labelPrefix = 'Revenus';
                let formatOptions = {};
                
                if (selectedType === 'soumissions') {
                  labelPrefix = 'Soumissions';
                  formatOptions = { minimumFractionDigits: 0, maximumFractionDigits: 0 };
                } else if (selectedType === 'montant-signe') {
                  labelPrefix = 'Montant sign√©';
                  formatOptions = { style: 'currency', currency: 'CAD' };
                } else if (selectedType === 'montant-produit') {
                  labelPrefix = 'Montant produit';
                  formatOptions = { style: 'currency', currency: 'CAD' };
                } else {
                  formatOptions = { style: 'currency', currency: 'CAD' };
                }
                
                return labelPrefix + ': ' + context.parsed.y.toLocaleString('fr-FR', formatOptions);
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              display: false
            },
            border: {
              display: false
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: '#475569'
            },
            border: {
              display: false
            },
            ticks: {
              callback: function(value) {
                const selectedType = getSelectedChartType();
                
                if (selectedType === 'soumissions') {
                  return value.toLocaleString('fr-FR', { 
                    minimumFractionDigits: 0, 
                    maximumFractionDigits: 0 
                  });
                } else {
                  return value.toLocaleString('fr-FR', {
                    style: 'currency',
                    currency: 'CAD',
                    minimumFractionDigits: 0
                  });
                }
              }
            }
          }
        }
      }
    });
    
    // Charger les donn√©es initiales du graphique
    updateChartData();
  }

  // Animation des nombres
  function animateNumber(elementId, targetValue, isPercentage = false, isCurrency = false, isDecimal = false) {
    const element = document.getElementById(elementId);
    if (!element) return;

    const startValue = 0;
    const duration = 1000;
    const startTime = Date.now();

    function updateNumber() {
      const currentTime = Date.now();
      const progress = Math.min((currentTime - startTime) / duration, 1);

      // Easing function
      const easeOutQuart = 1 - Math.pow(1 - progress, 4);
      const currentValue = startValue + (targetValue - startValue) * easeOutQuart;

      let displayValue;
      if (isCurrency) {
        // Format manuel pour √©viter "CA" dans l'affichage
        const parts = currentValue.toFixed(2).split('.');
        const partieEntiere = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        const partieDecimale = parts[1];
        displayValue = `${partieEntiere},${partieDecimale} $`;
      } else if (isPercentage) {
        displayValue = currentValue.toFixed(1) + '%';
      } else if (isDecimal) {
        displayValue = currentValue.toFixed(2);
      } else {
        displayValue = Math.round(currentValue).toLocaleString('fr-FR');
      }

      element.textContent = displayValue;

      if (progress < 1) {
        requestAnimationFrame(updateNumber);
      }
    }

    updateNumber();
  }

  // Animation des nombres avec suffixe personnalis√©
  function animateNumberWithSuffix(elementId, targetValue, suffix, isDecimal = false) {
    const element = document.getElementById(elementId);
    if (!element) return;

    const startValue = 0;
    const duration = 1000;
    const startTime = Date.now();

    function updateNumber() {
      const currentTime = Date.now();
      const progress = Math.min((currentTime - startTime) / duration, 1);

      // Easing function
      const easeOutQuart = 1 - Math.pow(1 - progress, 4);
      const currentValue = startValue + (targetValue - startValue) * easeOutQuart;

      let displayValue;
      if (isDecimal) {
        displayValue = currentValue.toFixed(1) + suffix;
      } else {
        // Format avec espaces pour les milliers
        const parts = currentValue.toFixed(2).split('.');
        const partieEntiere = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        displayValue = partieEntiere + suffix;
      }

      element.textContent = displayValue;

      if (progress < 1) {
        requestAnimationFrame(updateNumber);
      }
    }

    updateNumber();
  }

  // Mise √† jour du progress ring
  function formatMontantCourt(montant) {
    if (montant >= 1000000) {
      return (montant / 1000000).toFixed(1) + 'M $';
    } else if (montant >= 1000) {
      return Math.round(montant / 1000) + 'k $';
    } else {
      return montant.toString() + ' $';
    }
  }

  function updateProgressRing(percentage, objectifMontant = 0) {
    const circle = document.getElementById('progress-circle');
    const circumference = 2 * Math.PI * 40; // r = 40
    const offset = circumference - (percentage / 100) * circumference;
    circle.style.strokeDashoffset = offset;

    document.getElementById('progressPercent').textContent = percentage.toFixed(0) + '%';
    document.getElementById('objectifMontant').textContent = formatMontantCourt(objectifMontant);
  }

  // Fonction pour mettre √† jour les lignes de progression
  function updateStatusLines(signees, attente, perdus) {
    const total = signees + attente + perdus;

    // Calculer les pourcentages avec minimum 5%
    let signeesPercent, attentePercent, perdusPercent;

    if (total === 0) {
      // Si tout est √† 0, minimum 5% pour chaque
      signeesPercent = 5;
      attentePercent = 5;
      perdusPercent = 5;
    } else {
      // Calculer normalement mais avec minimum 5%
      signeesPercent = Math.max((signees / total) * 100, 5);
      attentePercent = Math.max((attente / total) * 100, 5);
      perdusPercent = Math.max((perdus / total) * 100, 5);
    }

    // Mettre √† jour directement les lignes existantes
    const signeesLine = document.getElementById('status-line-signees');
    const attenteLine = document.getElementById('status-line-attente');
    const perdusLine = document.getElementById('status-line-perdus');

    if (signeesLine) {
      signeesLine.style.width = signeesPercent + '%';
      log('Ligne sign√©es:', signeesPercent + '%');
    }
    if (attenteLine) {
      attenteLine.style.width = attentePercent + '%';
      log('Ligne attente:', attentePercent + '%');
    }
    if (perdusLine) {
      perdusLine.style.width = perdusPercent + '%';
      log('Ligne perdus:', perdusPercent + '%');
    }
  }
  
  // Fonction pour charger le taux de satisfaction
  async function loadTauxSatisfaction() {
    try {
      const response = await fetch(`/api/taux-satisfaction/${username}`);
      if (response.ok) {
        const data = await response.json();
        const tauxSatisfaction = data.taux_satisfaction || 0;
        const moyenneEtoiles = data.moyenne_etoiles || 0;
        const nombreAvis = data.nombre_avis || 0;

        animateNumber('tauxSatisfaction', tauxSatisfaction, true);
        animateNumber('etoilesMoyennes', moyenneEtoiles, false, false, true); // isDecimal = true
        animateNumber('nombreAvis', nombreAvis, false);
      } else {
        log('Aucune donn√©e de satisfaction trouv√©e');
        animateNumber('tauxSatisfaction', 0, true);
        animateNumber('etoilesMoyennes', 0, false, false, true); // isDecimal = true
        animateNumber('nombreAvis', 0, false);
      }
    } catch (error) {
      error('Erreur lors du chargement du taux de satisfaction:', error);
      animateNumber('tauxSatisfaction', 0, true);
      animateNumber('etoilesMoyennes', 0, false, false, true); // isDecimal = true
      animateNumber('nombreAvis', 0, false);
    }
  }

  // Chargement des donn√©es r√©elles
  async function loadDashboardData() {
    log('[loadDashboardData] DEBUT - username:', username, 'window.username:', window.username, 'localStorage.username:', localStorage.getItem('username'));

    if (!username) {
      error('[loadDashboardData] ERREUR - Username non d√©fini!');
      error('[loadDashboardData] window.username:', window.username);
      error('[loadDashboardData] localStorage.username:', localStorage.getItem('username'));
      error('[loadDashboardData] URL params:', new URLSearchParams(window.location.search).get('user'));
      return;
    }

    try {
      // D√©terminer si on doit charger les donn√©es de l'√©quipe
      const userRole = localStorage.getItem('userRole');
      const isCoach = userRole === 'coach';
      const isDashboardParCoach = window.dashboardType === 'par-coach';
      const isDashboardQualiteEtudiants = window.dashboardType === 'qualite-etudiants';

      log('[loadDashboardData] Chargement des donn√©es pour:', username, '| Role:', userRole, '| Dashboard type:', window.dashboardType);

      // Pour "Dashboard Qualit√© √âtudiants", ajouter le param√®tre ?all_teams=true
      // Pour "Dashboard par Coach", ajouter le param√®tre ?team=true
      let teamParam = '';
      if (isDashboardQualiteEtudiants) {
        teamParam = '?all_teams=true';
      } else if (isDashboardParCoach) {
        teamParam = '?team=true';
      }

      // Charger toutes les donn√©es en parall√®le
      const [soumissionsRes, soumissionsSigneesRes, ventesAttenteRes, clientsPerdusRes, ventesProduitRes, travauxEnCoursRes, chiffreAffairesRes, panierMoyenRes, montantSigneRes, montantNonProduitRes, rpoRes, montantProduitRes] = await Promise.all([
        fetch(`/api/soumissions/count/${username}${teamParam}`),
        fetch(`/api/soumissions/signees/total/${username}${teamParam}`),
        fetch(`/api/ventes/attente/count/${username}${teamParam}`),
        fetch(`/api/clients-perdus/count/${username}${teamParam}`),
        fetch(`/api/ventes/produit/count/${username}${teamParam}`),
        fetch(`/api/travaux-en-cours/count/${username}${teamParam}`),
        fetch(`/api/chiffre-affaires/${username}${teamParam}`),
        fetch(`/api/panier-moyen/${username}${teamParam}`),
        fetch(`/api/chiffre-affaires-signes/${username}${teamParam}`),
        fetch(`/api/montant-non-produit/${username}${teamParam}`),
        fetch(`/api/rpo/${username}${teamParam}`),
        fetch(`/api/ventes/produit/total/${username}${teamParam}`)
      ]);

      // Extraire les donn√©es
      const soumissionsData = await soumissionsRes.json();
      const soumissionsSigneesData = await soumissionsSigneesRes.json();
      const ventesAttenteData = await ventesAttenteRes.json();
      const clientsPerdusData = await clientsPerdusRes.json();
      const ventesProduitData = await ventesProduitRes.json();
      const travauxEnCoursData = await travauxEnCoursRes.json();
      const chiffreAffairesData = await chiffreAffairesRes.json();
      const panierMoyenData = await panierMoyenRes.json();
      const montantSigneData = await montantSigneRes.json();
      const montantNonProduitData = await montantNonProduitRes.json();
      const rpoData = rpoRes.ok ? await rpoRes.json() : null;
      const montantProduitData = montantProduitRes.ok ? await montantProduitRes.json() : null;

      // Status soumissions
      const totalSoumissions = soumissionsData.count || 0;
      const soumissionsSignees = soumissionsSigneesData.count || 0;
      const soumissionsEnAttente = ventesAttenteData.count || 0;
      const soumissionsPerdus = clientsPerdusData.count || 0;

      // Taux de vente: sign√©es / (attente + perdus + sign√©es) * 100
      const totalPotentiel = soumissionsEnAttente + soumissionsPerdus + soumissionsSignees;
      const tauxVente = totalPotentiel > 0 ? (soumissionsSignees / totalPotentiel) * 100 : 0;

      // Note: soumissionsSignees sera remplac√© par contractReelRPO apr√®s le chargement RPO
      // On anime seulement en_attente et perdus ici, sign√©es sera mis √† jour apr√®s calcul RPO
      animateNumber('soumissionsEnAttente', soumissionsEnAttente);
      animateNumber('soumissionsPerdus', soumissionsPerdus);
      // Note: tv sera recalcul√© avec contractReelRPO plus bas
      
      // Finances - extraire les montants num√©riques des cha√Ænes format√©es
      const chiffreAffairesStr = chiffreAffairesData.total || '0,00 $';
      const montantSigneStr = montantSigneData.total || '0,00 $';
      const montantNonProduitStr = montantNonProduitData.total || '0,00 $';
      const panierMoyenStr = panierMoyenData.panier_moyen || '0,00 $';

      // Convertir les strings format√©es en nombres
      const chiffreAffairesNum = parseFloat(chiffreAffairesStr.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;
      const montantSigneNum = parseFloat(montantSigneStr.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;
      const montantNonProduitNum = parseFloat(montantNonProduitStr.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;
      const panierMoyenNum = parseFloat(panierMoyenStr.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;

      // R√©cup√©rer l'Objectif CA, le Taux Marketing, Prod Horaire et H de P√ÄP depuis les donn√©es RPO
      log('[DEBUG] rpoData complet:', rpoData);
      log('[DEBUG] rpoData.annual:', rpoData?.annual);
      const objectifCA = rpoData?.annual?.objectif_ca || 0;
      const tauxMarketing = rpoData?.annual?.mktg_reel || 0;

      // Calculer contract_reel et dollar_reel depuis RPO (avec fallback depuis weekly si annual est 0)
      let contractReelRPO = rpoData?.annual?.contract_reel || 0;
      let dollarReelRPOFromAnnual = rpoData?.annual?.dollar_reel || 0;

      // Si annual est 0, calculer depuis weekly
      const needsFallback = contractReelRPO === 0 || dollarReelRPOFromAnnual === 0;
      if (needsFallback && rpoData?.weekly) {
        let totalContractFromWeekly = 0;
        let totalDollarFromWeekly = 0;
        for (const monthKey in rpoData.weekly) {
          for (const weekKey in rpoData.weekly[monthKey]) {
            const weekData = rpoData.weekly[monthKey][weekKey];
            totalContractFromWeekly += weekData.contract || 0;
            totalDollarFromWeekly += weekData.dollar || 0;
          }
        }
        // Utiliser les totaux weekly si annual est 0
        if (contractReelRPO === 0) contractReelRPO = totalContractFromWeekly;
        if (dollarReelRPOFromAnnual === 0) dollarReelRPOFromAnnual = totalDollarFromWeekly;
      }
      log('[DEBUG] contractReelRPO (calcul√©):', contractReelRPO);
      log('[DEBUG] dollarReelRPO (calcul√©):', dollarReelRPOFromAnnual);

      // Le montant produit vient du total des ventes produit (travaux termin√©s)
      const montantProduitStr = montantProduitData?.total || '0,00 $';
      const montantProduitTotal = montantProduitData?.montant || 0;
      log('[DEBUG] Montant produit (ventes termin√©es):', montantProduitTotal, montantProduitStr);

      // Calculer heures de P√ÄP - d'abord essayer de lire depuis l'√©l√©ment total-mktg-reel
      let heuresPAP = 0;
      let nombreSemaines = 0;

      // Essayer de r√©cup√©rer depuis l'√©l√©ment HTML total-mktg-reel (plus fiable)
      const totalMktgReelEl = document.getElementById('total-mktg-reel');
      if (totalMktgReelEl) {
        const totalMktgText = totalMktgReelEl.textContent.trim();
        log('[DEBUG] total-mktg-reel text:', totalMktgText);
        const match = totalMktgText.match(/(\d+)/);
        if (match) {
          heuresPAP = parseFloat(match[1]);
          log('[DEBUG] heuresPAP extrait depuis total-mktg-reel:', heuresPAP);
        }
      }

      // Si pas trouv√©, calculer depuis rpoData.weekly
      if (heuresPAP === 0 && rpoData?.weekly) {
        log('[DEBUG] Calcul depuis rpoData.weekly');
        // Compter les semaines SANS la semaine 1 (5-11 janv), semaine actuelle, et semaines futures

        // D√©terminer la semaine actuelle
        const now = new Date();
        const startOfYear = new Date(2026, 0, 5); // 5 janvier 2026
        const daysSinceStart = Math.floor((now - startOfYear) / (1000 * 60 * 60 * 24));
        const currentMonthIdx = Math.floor(daysSinceStart / 28); // ~4 semaines par mois
        const currentWeekNum = Math.floor((daysSinceStart % 28) / 7) + 1;

        for (const monthKey in rpoData.weekly) {
          const monthNum = parseInt(monthKey);
          for (const weekKey in rpoData.weekly[monthKey]) {
            const weekNum = parseInt(weekKey);

            // Exclure semaine 1 du mois 0 (5-11 janvier = formation)
            const isWeek1January = (monthNum === 0 && weekNum === 1);
            // Exclure semaine actuelle (incompl√®te)
            const isCurrentWeek = (monthNum === currentMonthIdx && weekNum === currentWeekNum);
            // Exclure semaines futures
            const isFutureWeek = (monthNum > currentMonthIdx) ||
                                 (monthNum === currentMonthIdx && weekNum > currentWeekNum);

            if (isWeek1January || isCurrentWeek || isFutureWeek) {
              continue;
            }

            const hMktg = rpoData.weekly[monthKey][weekKey].h_marketing;
            // Compter toutes les valeurs sauf "-" (m√™me 0 compte comme une semaine faite)
            if (hMktg !== undefined && hMktg !== null && hMktg !== '-') {
              heuresPAP += parseFloat(hMktg) || 0;
              nombreSemaines++;
            }
          }
        }
      }
      log('[DEBUG DASHBOARD] heuresPAP final:', heuresPAP);
      log('[DEBUG DASHBOARD] nombreSemaines:', nombreSemaines);

      // Calculer la moyenne des heures PAP par semaine
      const heuresPAPSemaine = nombreSemaines > 0 ? heuresPAP / nombreSemaines : 0;
      log('[DEBUG DASHBOARD] heuresPAPSemaine (moyenne):', heuresPAPSemaine);

      // Calculer Prod Horaire depuis les valeurs saisies dans RPO (mai √† septembre)
      let totalProdHoraire = 0;
      let nombreSemainesProdHoraire = 0;

      if (rpoData?.weekly) {
        // Mois avec prod_horaire: mai √† septembre 2026 (mois 4 √† 8)
        for (let monthIndex = 4; monthIndex <= 8; monthIndex++) {
          const monthKey = String(monthIndex);
          if (rpoData.weekly[monthKey]) {
            for (const weekKey in rpoData.weekly[monthKey]) {
              const prodH = rpoData.weekly[monthKey][weekKey].prod_horaire;
              // Compter seulement les valeurs saisies (diff√©rentes de 0, undefined, null)
              if (prodH !== undefined && prodH !== null && prodH !== 0 && prodH !== '-') {
                totalProdHoraire += parseFloat(prodH) || 0;
                nombreSemainesProdHoraire++;
              }
            }
          }
        }
      }

      const prodHoraire = nombreSemainesProdHoraire > 0 ? (totalProdHoraire / nombreSemainesProdHoraire) : 0;
      log('[DEBUG] Prod Horaire calcul√© depuis RPO:', prodHoraire, `(${totalProdHoraire} / ${nombreSemainesProdHoraire} semaines)`);

      // Afficher Prod Horaire
      const prodHoraireEl = document.getElementById('prodHoraire');
      if (prodHoraireEl) {
        prodHoraireEl.textContent = `${Math.round(prodHoraire)} $/h`;
      }

      // Utiliser dollar_reel du RPO comme "Dollars ($) vendu" (avec fallback depuis weekly)
      // dollarReelRPOFromAnnual est d√©j√† calcul√© plus haut avec le fallback
      log('[DEBUG] dollar_reel RPO (avec fallback):', dollarReelRPOFromAnnual);

      // Mettre √† jour "Sign√©es" avec contract_reel du RPO (contrats avec premier paiement)
      animateNumber('soumissionsSignees', contractReelRPO);

      // "En attente" = ventes_attente + (sign√©s sans premier paiement)
      const enAttenteReel = soumissionsEnAttente + (soumissionsSignees - contractReelRPO);
      animateNumber('soumissionsEnAttente', enAttenteReel);

      updateStatusLines(contractReelRPO, enAttenteReel, soumissionsPerdus);

      // Calculer le pourcentage de progression: (Dollar R√©el RPO / Objectif CA) * 100
      const progressionPct = objectifCA > 0 ? (dollarReelRPOFromAnnual / objectifCA) * 100 : 0;

      // Chiffre d'affaires - Actuel = dollar_reel du RPO (contrats avec premier paiement envoy√©)
      animateNumber('travauxEnCours', dollarReelRPOFromAnnual, false, true); // Actuel
      updateProgressRing(progressionPct, objectifCA); // Progression et objectif synchronis√©s

      // Afficher les nouvelles m√©triques financi√®res
      animateNumber('montantSigne', montantSigneNum, false, true);
      // Montant produit depuis le CA actuel (chiffre d'affaires)
      animateNumber('montantProduit', montantProduitTotal, false, true);
      animateNumber('montantNonProduit', montantNonProduitNum, false, true);

      // Animer la nouvelle stat: Heure PAP/semaine
      const heuresPAPSemaineEl = document.getElementById('heuresPAPSemaine');
      if (heuresPAPSemaineEl) {
        heuresPAPSemaineEl.textContent = `${heuresPAPSemaine.toFixed(1)} h`;
      }

      // Taux de marketing = mktg_reel du RPO annual (estimations par heure, d√©j√† calcul√©)
      const tauxMarketingRPO = rpoData?.annual?.mktg_reel || 0;
      animateNumber('tauxMarketing', tauxMarketingRPO, false, false, true);

      // Contrat moyen = dollar_reel / contract_reel (contrats avec premier paiement envoy√©)
      const contratMoyenNum = contractReelRPO > 0 ? dollarReelRPOFromAnnual / contractReelRPO : 0;
      animateNumber('contratMoyen', contratMoyenNum, false, true);

      // Recalculer taux de vente: Sign√©es / (Sign√©es + En attente + Perdus)
      // Sign√©es = contract_reel, En attente = enAttenteReel (sign√©s sans paiement)
      const totalPotentielReel = contractReelRPO + enAttenteReel + soumissionsPerdus;
      const tauxVenteReel = totalPotentielReel > 0 ? (contractReelRPO / totalPotentielReel) * 100 : 0;
      animateNumber('tv', tauxVenteReel, true);

      // Stocker le taux marketing r√©el, les heures P√ÄP et la prod horaire pour le classement
      window.tauxMarketingReel = tauxMarketing;
      window.heuresPAPReel = heuresPAP;
      window.prodHoraireReel = Math.round(prodHoraire); // Arrondir sans d√©cimales
      log('[DEBUG] window.heuresPAPReel stock√©:', window.heuresPAPReel);
      log('[DEBUG] window.prodHoraireReel stock√©:', window.prodHoraireReel);

      // Prod Horaire depuis RPO (moyenne des semaines mai-septembre)
      const prodHoraireElement = document.getElementById('prodHoraire');
      if (prodHoraireElement) {
        const formatted = Math.round(prodHoraire).toLocaleString('fr-CA');
        prodHoraireElement.textContent = `${formatted} $/h`;
      }

      // M√©triques additionnelles
      animateNumber('totalSoumissions', totalSoumissions);
      animateNumber('panierMoyen', panierMoyenNum, false, true);
      // Charger le taux de satisfaction depuis l'API
      loadTauxSatisfaction();
      animateNumber('tauxClosingMetric', tauxVente, true);

      // Charger le graphique avec les vraies donn√©es
      setTimeout(updateChartData, 500);

      log('[OK] Donn√©es du dashboard charg√©es avec succ√®s');
      log(`[DATA] Soumissions: ${totalSoumissions} total, ${soumissionsSignees} sign√©es, ${soumissionsEnAttente} en attente, ${soumissionsPerdus} perdus`);
      log(`[STATS] Taux de vente: ${tauxVente.toFixed(2)}%`);
      log(`üî® Ventes produit: ${ventesProduitData.count || 0} compl√©t√©es`);
      log(`[MONEY] Finances: Sign√© ${montantSigneStr}, Produit ${chiffreAffairesStr}, Non produit ${montantNonProduitStr}`);

      // Signal que les donn√©es RPO sont pr√™tes pour le classement
      log('[DEBUG] tauxMarketingReel d√©fini:', window.tauxMarketingReel);
      window.rpoDataReady = true;

    } catch (error) {
      error('[ERROR] Erreur lors du chargement des donn√©es:', error);
      // Afficher des valeurs par d√©faut en cas d'erreur
      animateNumber('soumissionsSignees', 0);
      animateNumber('soumissionsEnAttente', 0);
      animateNumber('soumissionsPerdus', 0);
      animateNumber('tv', 0, true);
      animateNumber('travauxEnCours', 0, false, true);
      updateProgressRing(0, 0);
      animateNumber('montantSigne', 0, false, true);
      animateNumber('montantProduit', 0, false, true);
      animateNumber('montantNonProduit', 0, false, true);
      animateNumber('contratMoyen', 0, false, true);
    }
  }

  // Scripts existants
  function toggleMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.mobile-overlay');
    
    sidebar.classList.toggle('mobile-open');
    overlay.classList.toggle('active');
  }
  
  function closeMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.mobile-overlay');
    
    sidebar.classList.remove('mobile-open');
    overlay.classList.remove('active');
  }

  function logout() {
    localStorage.removeItem("qwotaCredentials");
    localStorage.removeItem("rememberMe");
    window.location.href = "/login";
  }

  // Menu compte utilisateur
  const btn = document.getElementById("account-dropdown-toggle");
  const dropdown = document.getElementById("account-dropdown");

  if (btn && dropdown) {
    btn.addEventListener("click", () => {
      dropdown.classList.toggle("hidden");
    });

    window.addEventListener("click", (e) => {
      if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.add("hidden");
      }
    });
  }

  // Fonction pour mettre √† jour le graphique avec les donn√©es r√©elles
  async function updateChartData() {
    if (!username || !revenueChart) return;
    
    try {
      // Obtenir la p√©riode s√©lectionn√©e (p√©riode personnalis√©e par d√©faut)
      const activePeriod = document.querySelector('.period-button.active');
      const period = activePeriod ? activePeriod.dataset.period : 'custom';
      
      let start, end;
      
      if (period === 'custom') {
        // Utiliser les dates personnalis√©es du modal
        const startInput = document.getElementById('modalStartDate');
        const endInput = document.getElementById('modalEndDate');
        
        if (!startInput || !startInput.value || !endInput || !endInput.value) {
          warn('Dates personnalis√©es manquantes, utilisation des 30 derniers jours');
          // Valeurs par d√©faut: 30 derniers jours
          end = new Date();
          start = new Date();
          start.setDate(end.getDate() - 30);
        } else {
          start = parseDisplayDate(startInput.value);
          end = parseDisplayDate(endInput.value);
          
          // V√©rifier que la date de fin est apr√®s la date de d√©but
          if (!start || !end || end <= start) {
            warn('Dates invalides, utilisation des 30 derniers jours');
            end = new Date();
            start = new Date();
            start.setDate(end.getDate() - 30);
          }
        }
      } else {
        // Autres p√©riodes (ne devrait plus arriver avec la nouvelle interface)
        end = new Date();
        start = new Date();
        start.setDate(end.getDate() - parseInt(period));
      }
      
      const startStr = start.toISOString().split('T')[0];
      const endStr = end.toISOString().split('T')[0];
      
      // Obtenir le type de donn√©es s√©lectionn√© du dropdown personnalis√©
      const selectedType = getSelectedChartType();
      
      // Charger les donn√©es selon le type s√©lectionn√©
      const response = await fetch(`/api/graph-data/${username}?start=${startStr}&end=${endStr}&type=${selectedType}`);
      if (!response.ok) throw new Error('Erreur chargement donn√©es graphique');
      
      const data = await response.json();
      
      // Mettre √† jour le graphique
      revenueChart.data.labels = data.dates || [];
      revenueChart.data.datasets[0].data = data.data || [];
      
      // Stocker les dates compl√®tes pour les tooltips
      revenueChart.allDatesForTooltips = data.all_dates || data.dates || [];
      
      // Configurer stepSize et suggestedMax selon le type s√©lectionn√©
      if (selectedType === 'soumissions') {
        revenueChart.options.scales.y.ticks.stepSize = 1;
        revenueChart.options.scales.y.suggestedMax = 5;
      } else {
        // Pour montants (sign√© et produit) : minimum 5000
        delete revenueChart.options.scales.y.ticks.stepSize;
        revenueChart.options.scales.y.suggestedMax = 5000;
      }
      
      revenueChart.update();
      
    } catch (error) {
      error('Erreur mise √† jour graphique:', error);
      // Donn√©es de fallback
      revenueChart.data.labels = ['Aucune donn√©e'];
      revenueChart.data.datasets[0].data = [0];
      revenueChart.update();
    }
  }

  // Fonction pour initialiser les dates par d√©faut (30 derniers jours)
  function initializeDefaultDates() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    // S'assurer que les √©l√©ments existent avant de les modifier
    const startInput = document.getElementById('modalStartDate');
    const endInput = document.getElementById('modalEndDate');
    
    if (startInput) startInput.value = thirtyDaysAgo.toISOString().split('T')[0];
    if (endInput) endInput.value = today.toISOString().split('T')[0];
    
    // Sauvegarder par d√©faut si aucune s√©lection n'existe
    if (!getSavedPeriodSelection()) {
      savePeriodSelection('shortcut', '30');
    }
    
    log('[DATE] Dates par d√©faut initialis√©es: 30 derniers jours');
  }

  // Gestion des boutons de p√©riode
  function setupPeriodButtons() {
    // Initialiser les dates par d√©faut d√®s le chargement (30 derniers jours)
    initializeDefaultDates();
    
    // G√©rer le dropdown de type de donn√©es personnalis√©
    const chartTypeDropdown = document.getElementById('chart-type-dropdown');
    const chartTypeDropdownMenu = document.getElementById('chart-type-dropdown-menu');
    const chartTypeSelectedText = document.getElementById('chart-type-selected-text');
    
    if (chartTypeDropdown && chartTypeDropdownMenu) {
      // Toggle du dropdown
      chartTypeDropdown.addEventListener('click', function() {
        chartTypeDropdownMenu.classList.toggle('show');
        chartTypeDropdown.classList.toggle('active');
      });
      
      // Fermer le dropdown si on clique ailleurs
      document.addEventListener('click', function(event) {
        if (!chartTypeDropdown.contains(event.target)) {
          chartTypeDropdownMenu.classList.remove('show');
          chartTypeDropdown.classList.remove('active');
        }
      });
      
      // G√©rer la s√©lection d'une option
      chartTypeDropdownMenu.querySelectorAll('.agenda-dropdown-option').forEach(option => {
        option.addEventListener('click', function() {
          const value = this.getAttribute('data-value');
          const text = this.textContent;
          
          // Mettre √† jour l'affichage
          chartTypeSelectedText.textContent = text;

          // Synchroniser avec le dropdown mobile
          const mobileSelectedText = document.getElementById('mobile-chart-type-selected-text');
          if (mobileSelectedText) {
            mobileSelectedText.textContent = text;
          }

          // Mettre √† jour les classes selected
          chartTypeDropdownMenu.querySelectorAll('.agenda-dropdown-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          this.classList.add('selected');

          // Synchroniser les classes selected avec le dropdown mobile
          const mobileDropdownMenu = document.getElementById('mobile-chart-type-dropdown-menu');
          if (mobileDropdownMenu) {
            mobileDropdownMenu.querySelectorAll('.agenda-dropdown-option').forEach(opt => {
              opt.classList.remove('selected');
              if (opt.getAttribute('data-value') === value) {
                opt.classList.add('selected');
              }
            });
          }
          
          // Fermer le dropdown
          chartTypeDropdownMenu.classList.remove('show');
          chartTypeDropdown.classList.remove('active');
          
          log(`[STATS] Changement type de donn√©es: ${value}`);
          
          // Mettre √† jour la configuration de l'axe Y selon le type
          if (revenueChart) {
            if (value === 'soumissions') {
              revenueChart.options.scales.y.ticks.stepSize = 1;
              revenueChart.options.scales.y.suggestedMax = 5;
            } else {
              // Pour montants (sign√© et produit) : minimum 5000
              delete revenueChart.options.scales.y.ticks.stepSize;
              revenueChart.options.scales.y.suggestedMax = 5000;
            }
            revenueChart.update(); // Mettre √† jour la configuration (tooltips, axes)
          }
          setTimeout(updateChartData, 100);
        });
      });
    }

    // G√©rer le dropdown mobile de type de donn√©es
    const mobileChartTypeDropdown = document.getElementById('mobile-chart-type-dropdown');
    const mobileChartTypeDropdownMenu = document.getElementById('mobile-chart-type-dropdown-menu');
    const mobileChartTypeSelectedText = document.getElementById('mobile-chart-type-selected-text');

    if (mobileChartTypeDropdown && mobileChartTypeDropdownMenu) {
      // Toggle du dropdown mobile
      mobileChartTypeDropdown.addEventListener('click', function() {
        mobileChartTypeDropdownMenu.classList.toggle('show');
        mobileChartTypeDropdown.classList.toggle('active');
      });

      // Fermer le dropdown mobile si on clique ailleurs
      document.addEventListener('click', function(event) {
        if (!mobileChartTypeDropdown.contains(event.target)) {
          mobileChartTypeDropdownMenu.classList.remove('show');
          mobileChartTypeDropdown.classList.remove('active');
        }
      });

      // G√©rer la s√©lection d'une option mobile
      mobileChartTypeDropdownMenu.querySelectorAll('.agenda-dropdown-option').forEach(option => {
        option.addEventListener('click', function() {
          const value = this.getAttribute('data-value');
          const text = this.textContent;

          // Mettre √† jour l'affichage mobile
          mobileChartTypeSelectedText.textContent = text;

          // Synchroniser avec le dropdown PC
          const pcSelectedText = document.getElementById('chart-type-selected-text');
          if (pcSelectedText) {
            pcSelectedText.textContent = text;
          }

          // Mettre √† jour les classes selected sur mobile
          mobileChartTypeDropdownMenu.querySelectorAll('.agenda-dropdown-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          this.classList.add('selected');

          // Synchroniser les classes selected avec le dropdown PC
          const pcDropdownMenu = document.getElementById('chart-type-dropdown-menu');
          if (pcDropdownMenu) {
            pcDropdownMenu.querySelectorAll('.agenda-dropdown-option').forEach(opt => {
              opt.classList.remove('selected');
              if (opt.getAttribute('data-value') === value) {
                opt.classList.add('selected');
              }
            });
          }

          // Fermer le dropdown mobile
          mobileChartTypeDropdownMenu.classList.remove('show');
          mobileChartTypeDropdown.classList.remove('active');

          log(`[STATS] Changement type de donn√©es mobile: ${value}`);

          // Mettre √† jour la configuration de l'axe Y selon le type
          if (revenueChart) {
            if (value === 'soumissions') {
              revenueChart.options.scales.y.ticks.stepSize = 1;
              revenueChart.options.scales.y.suggestedMax = 5;
            } else {
              // Pour montants (sign√© et produit) : minimum 5000
              delete revenueChart.options.scales.y.ticks.stepSize;
              revenueChart.options.scales.y.suggestedMax = 5000;
            }
            revenueChart.update(); // Mettre √† jour la configuration (tooltips, axes)
          }
          setTimeout(updateChartData, 100);
        });
      });
    }

    const buttons = document.querySelectorAll('.period-button');
    const modal = document.getElementById('customDateModal');
    const closeModal = document.getElementById('closeModal');
    const cancelModal = document.getElementById('cancelModal');
    const applyCustomDates = document.getElementById('applyCustomDates');
    const modalOverlay = modal.querySelector('.dashboard-modal-overlay');
    
    buttons.forEach(button => {
      button.addEventListener('click', function() {
        const period = this.getAttribute('data-period');
        log(`[DATA] S√©lection p√©riode: ${period}`);
        
        if (period === 'custom') {
          // Ouvrir le modal pour les dates personnalis√©es
          openDateModal();
        }
      });
    });
    
    // Fonction pour ouvrir le modal
    function openDateModal() {
      modal.classList.remove('hidden');
      // Pas de overflow hidden pour ce popup
      
      // Restaurer la derni√®re s√©lection ou initialiser par d√©faut
      const saved = getSavedPeriodSelection();
      const today = new Date();
      
      if (saved && saved.type === 'custom') {
        // Restaurer les dates personnalis√©es
        document.getElementById('modalStartDate').value = saved.value.start;
        document.getElementById('modalEndDate').value = saved.value.end;
        // Aucun raccourci actif pour les dates personnalis√©es
        document.querySelectorAll('.dashboard-shortcut-btn').forEach(b => b.classList.remove('active'));
        lastSelectedShortcut = null; // Pas de raccourci pour les dates custom
      } else {
        // Par d√©faut ou raccourci sauvegard√© : 30 derniers jours
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        document.getElementById('modalStartDate').value = thirtyDaysAgo.toLocaleDateString('fr-FR');
        document.getElementById('modalEndDate').value = today.toLocaleDateString('fr-FR');
        
        // Restaurer le raccourci actif ou 30 jours par d√©faut
        restoreActiveShortcut();
        if (!document.querySelector('.dashboard-shortcut-btn.active')) {
          document.querySelector('.dashboard-shortcut-btn[data-days="30"]')?.classList.add('active');
          lastSelectedShortcut = { type: 'days', value: '30' }; // Par d√©faut
        } else {
          // R√©cup√©rer le raccourci actuellement actif
          const activeBtn = document.querySelector('.dashboard-shortcut-btn.active');
          if (activeBtn) {
            if (activeBtn.id === 'thisYear') {
              lastSelectedShortcut = { type: 'thisYear', value: 'thisYear' };
            } else {
              const days = activeBtn.getAttribute('data-days');
              lastSelectedShortcut = { type: 'days', value: days };
            }
          }
        }
      }
      
      // Ajouter des listeners pour retirer la classe active si l'utilisateur modifie manuellement les dates
      const startInput = document.getElementById('modalStartDate');
      const endInput = document.getElementById('modalEndDate');
      
      const removeActiveFromShortcuts = () => {
        document.querySelectorAll('.dashboard-shortcut-btn').forEach(b => b.classList.remove('active'));
        lastSelectedShortcut = null; // Reset car l'utilisateur modifie manuellement
      };
      
      startInput.addEventListener('input', removeActiveFromShortcuts);
      endInput.addEventListener('input', removeActiveFromShortcuts);
      
      // Ajouter des listeners pour ouvrir les calendriers en cliquant sur les inputs
      startInput.addEventListener('click', () => toggleCalendar('start'));
      endInput.addEventListener('click', () => toggleCalendar('end'));
    }
    
    // Fonction pour fermer le modal
    function closeDateModal() {
      modal.classList.add('hidden');
      // Pas de overflow √† remettre
    }
    
    // Event listeners pour fermer le modal
    closeModal.addEventListener('click', closeDateModal);
    cancelModal.addEventListener('click', closeDateModal);
    modalOverlay.addEventListener('click', closeDateModal);
    
    // Fermer avec Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeDateModal();
      }
    });
    
    // Gestion des raccourcis rapides
    document.querySelectorAll('.dashboard-shortcut-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const days = this.getAttribute('data-days');
        const today = new Date();
        const startDate = new Date(today);
        
        if (this.id === 'thisYear') {
          // Cette ann√©e (du 1er janvier √† aujourd'hui)
          startDate.setMonth(0, 1); // 1er janvier
        } else {
          // X derniers jours
          startDate.setDate(today.getDate() - parseInt(days));
        }
        
        document.getElementById('modalStartDate').value = startDate.toLocaleDateString('fr-FR');
        document.getElementById('modalEndDate').value = today.toLocaleDateString('fr-FR');
        
        // G√©rer la classe active pour les raccourcis
        document.querySelectorAll('.dashboard-shortcut-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // M√©moriser le raccourci s√©lectionn√©
        if (this.id === 'thisYear') {
          lastSelectedShortcut = { type: 'thisYear', value: 'thisYear' };
        } else {
          lastSelectedShortcut = { type: 'days', value: days };
        }
      });
    });
    
    // Appliquer les dates personnalis√©es
    applyCustomDates.addEventListener('click', function() {
      const startInput = document.getElementById('modalStartDate');
      const endInput = document.getElementById('modalEndDate');
      
      if (!startInput.value || !endInput.value) {
        alert('Veuillez s√©lectionner une date de d√©but et une date de fin');
        return;
      }
      
      const startDate = parseDisplayDate(startInput.value);
      const endDate = parseDisplayDate(endInput.value);
      
      if (!startDate || !endDate || endDate <= startDate) {
        alert('La date de fin doit √™tre post√©rieure √† la date de d√©but');
        return;
      }
      
      // Activer le bouton personnalis√©
      buttons.forEach(btn => btn.classList.remove('active'));
      document.getElementById('customPeriodBtn').classList.add('active');
      
      log(`[DATA] Application des dates: ${startInput.value} √† ${endInput.value}`);
      
      // Sauvegarder selon le type (raccourci ou personnalis√©)
      if (lastSelectedShortcut) {
        // C'√©tait un raccourci, sauvegarder comme raccourci
        savePeriodSelection('shortcut', lastSelectedShortcut.value);
        log(`[DATA] Sauvegarde raccourci: ${lastSelectedShortcut.value}`);
      } else {
        // Dates modifi√©es manuellement, sauvegarder comme personnalis√©
        savePeriodSelection('custom', { start: startInput.value, end: endInput.value });
        log(`[DATA] Sauvegarde dates personnalis√©es`);
      }
      
      // Fermer le modal
      closeDateModal();
      
      // Mettre √† jour le graphique
      updateChartData();
    });
  }

  // Mise √† jour du graphique selon la p√©riode
  function updateChartForPeriod(days) {
    // Simuler diff√©rentes donn√©es selon la p√©riode
    let labels, data;
    
    if (days == '7') {
      labels = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
      data = [5000, 8000, 6000, 12000, 9000, 15000, 11000];
    } else if (days == '30') {
      labels = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];
      data = [25000, 32000, 28000, 45000];
    } else {
      labels = ['Mois 1', 'Mois 2', 'Mois 3'];
      data = [95000, 120000, 140000];
    }
    
    revenueChart.data.labels = labels;
    revenueChart.data.datasets[0].data = data;
    revenueChart.update('active');
  }

  // Affichage de la date actuelle
  function updateCurrentDate() {
    const now = new Date();
    const isMobile = window.innerWidth <= 768;

    if (isMobile) {
      // Mobile : afficher seulement le jour de la semaine
      const options = { weekday: 'long' };
      const dateString = now.toLocaleDateString('fr-FR', options);
      document.getElementById('currentDate').textContent = dateString;
    } else {
      // PC : afficher la date compl√®te
      const options = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      };
      const dateString = now.toLocaleDateString('fr-FR', options);
      document.getElementById('currentDate').textContent = dateString;
    }
  }

  // Mettre √† jour la date lors du redimensionnement
  window.addEventListener('resize', updateCurrentDate);

  // Initialisation
  document.addEventListener('DOMContentLoaded', function() {
    // Mobile menu
    const menuLinks = document.querySelectorAll('#sidebar a');
    menuLinks.forEach(link => {
      link.addEventListener('click', closeMobileMenu);
    });
    
    // Mobile account menu
    const mobileAccountBtn = document.getElementById('mobile-account-menu-button');
    const mobileAccountDropdown = document.getElementById('mobile-account-dropdown');
    
    if (mobileAccountBtn && mobileAccountDropdown) {
      mobileAccountBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        mobileAccountDropdown.classList.toggle('hidden');
      });
      
      document.addEventListener('click', function() {
        mobileAccountDropdown.classList.add('hidden');
      });
      
      mobileAccountDropdown.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    }

    // ================================================================
    // CLASSEMENT - FONCTIONS
    // ================================================================

    let currentSortColumn = 'ca'; // Colonne de tri par d√©faut

    function setupClassementDropdown() {
      // Nouveau syst√®me: clic sur les en-t√™tes de colonnes
      const headers = document.querySelectorAll('.sortable-header');

      headers.forEach(header => {
        if (header.dataset.listenerAttached) return;
        header.dataset.listenerAttached = "true";

        // √âv√©nement clic pour trier
        header.addEventListener('click', function() {
          const sortBy = this.getAttribute('data-sort');

          // Retirer active de tous les headers
          headers.forEach(h => h.classList.remove('active'));

          // Ajouter active au header cliqu√©
          this.classList.add('active');

          // Sauvegarder la colonne active
          currentSortColumn = sortBy;

          // Trier le tableau
          sortClassement(sortBy);
        });

        // √âv√©nement hover - mouseenter
        header.addEventListener('mouseenter', function() {
          const columnName = this.getAttribute('data-sort');
          // Ajouter hover-column au header
          this.classList.add('hover-column');
          // Ajouter hover-column √† toutes les cellules de cette colonne
          document.querySelectorAll(`#classementTable td[data-column="${columnName}"]`).forEach(td => {
            td.classList.add('hover-column');
          });
        });

        // √âv√©nement hover - mouseleave
        header.addEventListener('mouseleave', function() {
          const columnName = this.getAttribute('data-sort');
          // Retirer hover-column du header
          this.classList.remove('hover-column');
          // Retirer hover-column de toutes les cellules de cette colonne
          document.querySelectorAll(`#classementTable td[data-column="${columnName}"]`).forEach(td => {
            td.classList.remove('hover-column');
          });
        });
      });
    }

    // P√©riode s√©lectionn√©e (par d√©faut: toute l'ann√©e)
    let currentPeriode = 'annee';
    let currentCustomDates = null; // {start: 'YYYY-MM-DD', end: 'YYYY-MM-DD'}
    let entrepreneurStartCalendar = null;
    let entrepreneurEndCalendar = null;

    function setupPeriodeDropdown() {
      const periodeSelect = document.getElementById('periodeSelect');
      const periodeBtn = document.getElementById('periodeBtn');
      const periodeBtnText = document.getElementById('periodeBtnText');
      const semaineInfo = document.getElementById('semaineInfo');
      const customDatePicker = document.getElementById('customDatePicker');
      const applyBtn = document.getElementById('applyCustomDate');
      const cancelBtn = document.getElementById('cancelCustomDate');

      if (!periodeSelect || !periodeBtn) return;

      // Initialiser les calendriers personnalis√©s
      if (!entrepreneurStartCalendar) {
        entrepreneurStartCalendar = new CoachCustomCalendar('startCalendar', () => {});
        entrepreneurEndCalendar = new CoachCustomCalendar('endCalendar', () => {});
      }

      // Toggle dropdown avec la classe .open
      periodeBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (customDatePicker) {
          customDatePicker.classList.add('hidden');
        }
        periodeSelect.classList.toggle('open');
      });

      // Fermer dropdown si clic ailleurs
      document.addEventListener('click', function(e) {
        if (!periodeSelect.contains(e.target) && !customDatePicker.contains(e.target)) {
          periodeSelect.classList.remove('open');
          if (customDatePicker) {
            customDatePicker.classList.add('hidden');
          }
        }
      });

      // D√©l√©gation d'√©v√©nements pour les options
      const dropdown = document.getElementById('periodeDropdown');
      dropdown.addEventListener('click', function(e) {
        const option = e.target.closest('.custom-select-option');
        if (!option) return;

        const periode = option.getAttribute('data-periode');

        if (periode === 'custom') {
          // Ouvrir le s√©lecteur de dates personnalis√©
          periodeSelect.classList.remove('open');
          customDatePicker.classList.remove('hidden');

          // D√©finir les dates par d√©faut (30 derniers jours)
          const today = new Date();
          const thirtyDaysAgo = new Date(today);
          thirtyDaysAgo.setDate(today.getDate() - 30);

          entrepreneurStartCalendar.setDate(thirtyDaysAgo);
          entrepreneurEndCalendar.setDate(today);
        } else {
          // P√©riode pr√©d√©finie
          currentPeriode = periode;
          currentCustomDates = null;

          // Mettre √† jour le texte du bouton
          const textes = {
            'annee': "Toute l'ann√©e",
            '90': '90 derniers jours',
            '30': '30 derniers jours',
            '14': '14 derniers jours',
            'semaine': 'Cette semaine'
          };
          periodeBtnText.innerHTML = `<i class="fas fa-calendar-alt mr-2"></i>${textes[periode]}`;

          // Afficher/masquer le message "Cette semaine"
          if (periode === 'semaine') {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            monday.setDate(today.getDate() - daysFromMonday);
            const joursDepuisLundi = daysFromMonday + 1;
            const dateOptions = { day: 'numeric', month: 'long' };
            const lundiFormate = monday.toLocaleDateString('fr-CA', dateOptions);
            semaineInfo.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>Semaine √† partir du lundi le ${lundiFormate} (${joursDepuisLundi} jour${joursDepuisLundi > 1 ? 's' : ''})`;
            semaineInfo.classList.remove('hidden');
          } else {
            semaineInfo.classList.add('hidden');
          }

          // Fermer dropdown
          periodeSelect.classList.remove('open');

          // Recharger les donn√©es du classement avec la nouvelle p√©riode
          loadClassementData();
        }
      });

      // Bouton Appliquer pour les dates personnalis√©es
      if (applyBtn) {
        applyBtn.addEventListener('click', function() {
          const startDate = entrepreneurStartCalendar.getDate();
          const endDate = entrepreneurEndCalendar.getDate();

          if (!startDate || !endDate) {
            alert('Veuillez s√©lectionner une date de d√©but et de fin');
            return;
          }

          if (startDate > endDate) {
            alert('La date de d√©but doit √™tre ant√©rieure √† la date de fin');
            return;
          }

          // Formater les dates
          const startStr = startDate.toISOString().split('T')[0];
          const endStr = endDate.toISOString().split('T')[0];

          // Mettre √† jour le texte du bouton
          periodeBtnText.innerHTML = `<i class="fas fa-calendar-alt mr-2"></i>${startStr} au ${endStr}`;

          // Sauvegarder les dates personnalis√©es
          currentPeriode = 'custom';
          currentCustomDates = { start: startStr, end: endStr };

          // Masquer le message "Cette semaine"
          semaineInfo.classList.add('hidden');

          // Fermer le s√©lecteur
          customDatePicker.classList.add('hidden');

          // Recharger les donn√©es avec les dates personnalis√©es
          loadClassementData();
        });
      }

      // Bouton Annuler
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          customDatePicker.classList.add('hidden');
        });
      }
    }

    // Fonction pour configurer le dropdown de scope d'entrepreneurs
    async function setupEntrepreneurScopeDropdown() {
      // G√©rer √† la fois le dropdown mobile et desktop
      const scopeSelect = document.getElementById('entrepreneurScopeSelect');
      const scopeBtn = document.getElementById('entrepreneurScopeBtn');
      const scopeBtnText = document.getElementById('entrepreneurScopeBtnText');
      const dropdown = document.getElementById('entrepreneurScopeDropdown');

      const scopeSelectDesktop = document.getElementById('entrepreneurScopeSelectDesktop');
      const scopeBtnDesktop = document.getElementById('entrepreneurScopeBtnDesktop');
      const scopeBtnTextDesktop = document.getElementById('entrepreneurScopeBtnTextDesktop');
      const dropdownDesktop = document.getElementById('entrepreneurScopeDropdownDesktop');

      if (!scopeSelect || !scopeBtn) return;

      // Si l'utilisateur est un entrepreneur (pas coach), initialiser avec son grade
      const userRole = localStorage.getItem('userRole');
      const username = localStorage.getItem('username');

      if (userRole !== 'coach' && userRole !== 'direction') {
        try {
          // R√©cup√©rer le grade de l'entrepreneur depuis l'API
          const response = await fetch(`/api/get-info/${username}`);

          console.log('[GRADE FILTER] Username recherch√©:', username);

          if (response.ok) {
            const result = await response.json();
            const userInfo = result.data || {};
            const grade = userInfo.grade;

            console.log('[GRADE FILTER] R√©ponse API:', result);
            console.log('[GRADE FILTER] Grade de l\'entrepreneur:', grade);

            if (grade) {
              const gradeLower = grade.toLowerCase();
              console.log('[GRADE FILTER] Grade normalis√©:', gradeLower);

              // Mapper le grade au bon format
              const gradeMap = {
                'recrue': { icon: 'fas fa-seedling', text: 'Recrue', value: 'recrue' },
                'senior1': { icon: 'fas fa-star', text: 'S√©nior 1', value: 'senior1' },
                'senior2': { icon: 'fas fa-star', text: 'S√©nior 2', value: 'senior2' },
                'senior3': { icon: 'fas fa-star', text: 'S√©nior 3', value: 'senior3' }
              };

              if (gradeMap[gradeLower]) {
                // Mettre √† jour le bouton avec le grade de l'entrepreneur (mobile et desktop)
                console.log('[GRADE FILTER] Mise √† jour du bouton avec:', gradeMap[gradeLower].text);
                scopeBtnText.innerHTML = `<i class="${gradeMap[gradeLower].icon} mr-2"></i>${gradeMap[gradeLower].text}`;
                if (scopeBtnTextDesktop) {
                  scopeBtnTextDesktop.innerHTML = `<i class="${gradeMap[gradeLower].icon} mr-2"></i>${gradeMap[gradeLower].text}`;
                }
                currentGroupFilter = gradeMap[gradeLower].value;
                console.log('[GRADE FILTER] currentGroupFilter d√©fini √†:', currentGroupFilter);
              } else {
                console.log('[GRADE FILTER] Grade non trouv√© dans gradeMap:', gradeLower);
              }
            } else {
              console.log('[GRADE FILTER] Pas de grade trouv√© dans les infos utilisateur');
            }
          }
        } catch (error) {
          console.error('[GRADE FILTER] Erreur lors de la r√©cup√©ration du grade:', error);
          // Garder la valeur par d√©faut "Tous les entrepreneurs"
        }
      }

      // Toggle dropdown
      scopeBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        scopeSelect.classList.toggle('open');
      });

      // Fermer dropdown si clic ailleurs
      document.addEventListener('click', function(e) {
        if (!scopeSelect.contains(e.target)) {
          scopeSelect.classList.remove('open');
        }
      });

      // G√©rer les options mobile
      dropdown.addEventListener('click', function(e) {
        const option = e.target.closest('.custom-select-option');
        if (!option) return;

        const scope = option.getAttribute('data-scope');
        const grade = option.getAttribute('data-grade');

        // Mettre √† jour le texte du bouton (mobile et desktop)
        scopeBtnText.innerHTML = option.innerHTML;
        if (scopeBtnTextDesktop) {
          scopeBtnTextDesktop.innerHTML = option.innerHTML;
        }

        // Fermer le dropdown
        scopeSelect.classList.remove('open');

        // Filtrer selon la s√©lection
        if (scope === 'tous') {
          currentGroupFilter = 'tous';
        } else if (scope === 'grade') {
          currentGroupFilter = grade;
        }

        // Recharger les donn√©es (qui appliquera automatiquement le filtre apr√®s le render)
        loadClassementData();
      });

      // G√©rer le dropdown desktop (si pr√©sent)
      if (scopeSelectDesktop && scopeBtnDesktop && dropdownDesktop) {
        // Toggle dropdown desktop
        scopeBtnDesktop.addEventListener('click', function(e) {
          e.stopPropagation();
          scopeSelectDesktop.classList.toggle('open');
        });

        // Fermer dropdown desktop si clic ailleurs
        document.addEventListener('click', function(e) {
          if (!scopeSelectDesktop.contains(e.target)) {
            scopeSelectDesktop.classList.remove('open');
          }
        });

        // G√©rer les options desktop
        dropdownDesktop.addEventListener('click', function(e) {
          const option = e.target.closest('.custom-select-option');
          if (!option) return;

          const scope = option.getAttribute('data-scope');
          const grade = option.getAttribute('data-grade');

          // Mettre √† jour le texte des boutons (desktop et mobile)
          scopeBtnTextDesktop.innerHTML = option.innerHTML;
          if (scopeBtnText) {
            scopeBtnText.innerHTML = option.innerHTML;
          }

          // Fermer le dropdown
          scopeSelectDesktop.classList.remove('open');

          // Filtrer selon la s√©lection
          if (scope === 'tous') {
            currentGroupFilter = 'tous';
          } else if (scope === 'grade') {
            currentGroupFilter = grade;
          }

          // Recharger les donn√©es
          loadClassementData();
        });
      }
    }

    let classementData = [];
    let currentGroupFilter = 'tous';

    async function sortClassement(sortBy) {
      let sortedData = [...classementData].sort((a, b) => {
        switch(sortBy) {
          case 'ca': return (b.dollar_reel || 0) - (a.dollar_reel || 0);
          case 'signees': return (b.contract_reel || 0) - (a.contract_reel || 0);
          case 'estimations': {
            const totalA = a.nb_estimations || 0;
            const totalB = b.nb_estimations || 0;
            return totalB - totalA;
          }
          case 'etoiles': return (b.etoiles || 0) - (a.etoiles || 0);
          case 'contrat': return (b.contrat_moyen || 0) - (a.contrat_moyen || 0);
          case 'produit': return (b.montant_produit || 0) - (a.montant_produit || 0);
          case 'marketing': return (b.taux_marketing || 0) - (a.taux_marketing || 0);
          case 'prod': return (b.prod_horaire || 0) - (a.prod_horaire || 0);
          case 'pap': return (b.heures_pap || 0) - (a.heures_pap || 0);
          case 'tv': return (b.taux_vente || 0) - (a.taux_vente || 0);
          default: return 0;
        }
      });

      // IMPORTANT: Filtrer les donn√©es AVANT de les rendre pour √©viter le flash
      if (currentGroupFilter && currentGroupFilter !== 'tous') {
        log('[SORT] Filtrage des donn√©es AVANT render - filtre:', currentGroupFilter);
        sortedData = sortedData.filter(entrepreneur => {
          const grade = entrepreneur.grade || '';

          let matches = false;
          switch(currentGroupFilter) {
            case 'recrue':
              matches = grade === 'recrue' || grade === 'rookie';
              break;
            case 'senior1':
              matches = grade === 'senior1';
              break;
            case 'senior2':
              matches = grade === 'senior2';
              break;
            case 'senior3':
              matches = grade === 'senior3';
              break;
            default:
              matches = true;
          }

          return matches;
        });
      }

      await renderClassement(sortedData);

      // Le filtre a d√©j√† √©t√© appliqu√© avant le render, pas besoin de re-filtrer
      log('[SORT] Donn√©es tri√©es et filtr√©es rendues - count:', sortedData.length);
    }

    // Fonction unifi√©e pour le rendu du classement (entrepreneur ET coach)
    // options: { tbodyId, mobileCardsId, context: 'entrepreneur' | 'coach' }
    // Expos√©e globalement pour √™tre accessible depuis renderCoachClassementCards()
    async function renderClassement(data, options = {}) {
      const tbodyId = options.tbodyId || 'classementTableBody';
      const mobileCardsId = options.mobileCardsId || 'classementMobileCards';
      const context = options.context || 'entrepreneur'; // 'entrepreneur' ou 'coach'

      const tbody = document.getElementById(tbodyId);
      const mobileCards = document.getElementById(mobileCardsId);

      if (!tbody || !mobileCards) {
        console.error(`[RENDER CLASSEMENT] Elements non trouv√©s: tbody=${tbodyId}, mobile=${mobileCardsId}`);
        return;
      }

      if (data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="12" class="text-center py-8" style="color: var(--text-gray);">
              Aucun entrepreneur trouv√©
            </td>
          </tr>
        `;
        mobileCards.innerHTML = `
          <div class="text-center py-8" style="color: var(--text-gray);">
            Aucun entrepreneur trouv√©
          </div>
        `;
        return;
      }

      // R√©cup√©rer les photos de profil et grades pour tous les entrepreneurs
      const photoGradePromises = data.map(async (entrepreneur) => {
        const loginUsername = entrepreneur.login_username || entrepreneur.username;

        try {
          // R√©cup√©rer la photo
          const photoResponse = await fetch(`/api/get-profile-photo/${loginUsername}`);
          let photoUrl = null;
          if (photoResponse.ok) {
            const photoResult = await photoResponse.json();
            photoUrl = photoResult.photoUrl || null;
          }

          // R√©cup√©rer le grade m√©tier depuis user_info (pour le filtrage)
          // Si le grade est d√©j√† charg√© dans classementData, l'utiliser directement
          let gradeMetier = entrepreneur.grade || 'recrue'; // D√©faut
          if (!entrepreneur.grade) {
            // Charger le grade seulement s'il n'est pas d√©j√† pr√©sent
            try {
              const userInfoResponse = await fetch(`/api/user-info/${loginUsername}`);
              if (userInfoResponse.ok) {
                const userInfo = await userInfoResponse.json();
                // Le grade m√©tier est directement dans userInfo.grade (recrue, senior1, senior2, senior3)
                gradeMetier = userInfo.grade || 'recrue';
                entrepreneur.grade = gradeMetier; // Stocker pour les prochains renders
              }
            } catch (err) {
              log(`Grade m√©tier par d√©faut pour ${entrepreneur.username}`);
            }
          }

          // R√©cup√©rer le grade de gamification (pour le contour de photo)
          let gradeGamification = 'D√©marrage'; // D√©faut
          try {
            const gamifResponse = await fetch(`/api/gamification/profile/${loginUsername}`);
            if (gamifResponse.ok) {
              const gamifData = await gamifResponse.json();
              const profile = gamifData.status === 'success' && gamifData.profile ? gamifData.profile : gamifData;
              gradeGamification = profile.category || 'D√©marrage';
            }
          } catch (err) {
            log(`Grade gamification par d√©faut pour ${entrepreneur.username}`);
          }

          return {
            username: entrepreneur.username,
            loginUsername: loginUsername, // Ajouter le loginUsername pour le modal
            photoUrl: photoUrl,
            grade: gradeMetier,
            gradeGamification: gradeGamification
          };
        } catch (error) {
          error(`[ERROR] Erreur chargement donn√©es pour ${entrepreneur.username}:`, error);
          return {
            username: entrepreneur.username,
            loginUsername: loginUsername, // Ajouter le loginUsername pour le modal
            photoUrl: null,
            grade: 'recrue',
            gradeGamification: 'D√©marrage'
          };
        }
      });

      const photosGrades = await Promise.all(photoGradePromises);
      const photoMap = {};
      const gradeMap = {};
      const gradeGamificationMap = {};
      const loginUsernameMap = {}; // Map pour stocker login_username
      photosGrades.forEach(p => {
        photoMap[p.username] = p.photoUrl;
        gradeMap[p.username] = p.grade;
        gradeGamificationMap[p.username] = p.gradeGamification;
        loginUsernameMap[p.username] = p.loginUsername; // Stocker le loginUsername
        log(`üì∏ ${p.username}: photo=${p.photoUrl ? 'oui' : 'non'}, gradeMetier=${p.grade}, gradeGamif=${p.gradeGamification}, loginUsername=${p.loginUsername}`);
      });
      log('üó∫Ô∏è Photo map final:', photoMap);
      log('üéñÔ∏è Grade m√©tier map final:', gradeMap);
      log('üèÜ Grade gamification map final:', gradeGamificationMap);
      log('üîë Login username map final:', loginUsernameMap);

      // Pr√©parer les donn√©es enrichies avec photos et grades
      const enrichedData = data.map(e => ({
        ...e,
        login_username: loginUsernameMap[e.username] || e.username,
        photoUrl: photoMap[e.username] || null,
        grade: gradeMap[e.username] || e.grade || 'recrue',
        gradeGamification: gradeGamificationMap[e.username] || 'D√©marrage'
      }));

      // Stocker selon le contexte
      if (context === 'coach') {
        // Contexte coach - mettre √† jour coachClassementData et currentCoachClassementData
        coachClassementData = enrichedData;
        currentCoachClassementData = enrichedData;
        // Aussi mettre √† jour la Map pour le modal coach
        window.coachClassementDataMap = new Map();
        enrichedData.forEach(e => {
          window.coachClassementDataMap.set(e.login_username || e.username, e);
        });
        log('[RENDER COACH] ‚úÖ currentCoachClassementData mis √† jour:', enrichedData.length, 'entrepreneurs');
      } else {
        // Contexte entrepreneur - mettre √† jour classementData et currentClassementData
        classementData = classementData.map(e => ({
          ...e,
          grade: gradeMap[e.username] || e.grade || 'recrue'
        }));
        currentClassementData = enrichedData;
        log('[RENDER ENTREPRENEUR] ‚úÖ currentClassementData mis √† jour:', enrichedData.length, 'entrepreneurs');
      }

      // Log pour v√©rifier les donn√©es
      log('[DEBUG] Donn√©es classement cr√©√©es avec photos:',
        enrichedData.slice(0, 3).map(e => ({
          username: e.username,
          login_username: e.login_username,
          photoUrl: e.photoUrl
        }))
      );

      // Variable pour la colonne de tri active selon le contexte
      const sortColumn = context === 'coach' ? currentCoachSortColumn : currentSortColumn;

      // Pour le contexte entrepreneur: limiter √† 40 et afficher l'utilisateur actuel s'il est au-del√†
      const MAX_DISPLAY = 40;
      let dataToDisplay = data;
      let currentUserBeyond40 = null;
      let currentUserOriginalIndex = -1;

      // Seulement appliquer la limite de 40 pour le contexte entrepreneur avec un username d√©fini
      const currentUsername = window.username || '';
      if (context === 'entrepreneur' && data.length > MAX_DISPLAY && currentUsername) {
        // Trouver la position de l'utilisateur actuel dans les donn√©es compl√®tes
        currentUserOriginalIndex = data.findIndex(e =>
          (e.username && e.username === currentUsername) ||
          (e.login_username && e.login_username === currentUsername)
        );

        if (currentUserOriginalIndex >= MAX_DISPLAY) {
          // L'utilisateur est au-del√† du top 40, le sauvegarder pour l'afficher en bas
          currentUserBeyond40 = { ...data[currentUserOriginalIndex], originalRank: currentUserOriginalIndex + 1 };
          log(`[CLASSEMENT] Utilisateur ${currentUsername} au rang ${currentUserOriginalIndex + 1} (au-del√† de ${MAX_DISPLAY})`);
        }

        // Limiter √† 40
        dataToDisplay = data.slice(0, MAX_DISPLAY);
      } else if (context === 'entrepreneur' && data.length > MAX_DISPLAY) {
        // Pas de username, juste limiter √† 40
        dataToDisplay = data.slice(0, MAX_DISPLAY);
      }

      tbody.innerHTML = dataToDisplay.map((entrepreneur, index) => {
        // V√©rifier si c'est l'utilisateur actuel (avec protection contre undefined)
        const isCurrentUser = currentUsername && (
          (entrepreneur.username && entrepreneur.username === currentUsername) ||
          (entrepreneur.login_username && entrepreneur.login_username === currentUsername)
        );

        // M√©dailles pour les 3 premi√®res positions
        let rangDisplay = '';
        if (index === 0) {
          rangDisplay = '<i class="fas fa-medal text-2xl" style="color: #fbbf24;"></i>'; // Or
        } else if (index === 1) {
          rangDisplay = '<i class="fas fa-medal text-2xl" style="color: #94a3b8;"></i>'; // Argent
        } else if (index === 2) {
          rangDisplay = '<i class="fas fa-medal text-2xl" style="color: #cd7f32;"></i>'; // Bronze
        } else {
          rangDisplay = `<span class="font-bold" style="color: var(--text-light);">${index + 1}</span>`;
        }

        // Photo de profil avec contour de grade GAMIFICATION
        const photoUrl = photoMap[entrepreneur.username];
        const gradeGamif = gradeGamificationMap[entrepreneur.username] || 'D√©marrage';
        const gradeClass = 'grade-' + gradeGamif.toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/\s+/g, '-');

        const profilePhotoHTML = photoUrl
          ? `<div class="profile-photo-small ${gradeClass}"><img src="${photoUrl}" alt="Photo de profil"></div>`
          : `<div class="profile-photo-small ${gradeClass}"><div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #2586fd 0%, #b2c5fbc7 100%); display: flex; align-items: center; justify-content: center;"><i class="fas fa-user" style="color: white; font-size: 14px;"></i></div></div>`;

        // Utiliser le montant produit depuis l'API (ventes_produit uniquement)
        const dollarsProduit = Math.round(entrepreneur.montant_produit || 0);

        // Handler onclick selon le contexte (entrepreneur, coach, ou coach-ranking)
        const loginUsername = (entrepreneur.login_username || entrepreneur.username).replace(/'/g, "\\'");
        const displayName = entrepreneur.username.replace(/'/g, "\\'");
        let onclickHandler;
        if (context === 'coach') {
          onclickHandler = `showCoachClassementEntrepreneurStats('${loginUsername}')`;
        } else if (context === 'coach-ranking') {
          onclickHandler = `openCoachStatsModal('${loginUsername}', '${displayName}')`;
        } else {
          onclickHandler = `showEntrepreneurStats(${index})`;
        }

        // Style sp√©cial pour la ligne "MOI" (utilisateur actuel)
        const moiRowStyle = isCurrentUser
          ? 'background: linear-gradient(90deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.15) 100%); border-left: 4px solid #3b82f6; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);'
          : '';
        const moiBadge = isCurrentUser
          ? `<span style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.2rem 0.6rem; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; font-size: 0.7rem; font-weight: 700; border-radius: 12px; margin-left: 0.5rem; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4); letter-spacing: 0.5px; text-transform: uppercase;"><i class="fas fa-user-circle" style="font-size: 0.75rem;"></i>MOI</span>`
          : '';

        return `
          <tr class="border-b hover:bg-opacity-5 hover:bg-blue-500 transition-colors ${isCurrentUser ? 'current-user-row' : ''}" style="border-color: var(--border-dark); cursor: pointer; ${moiRowStyle}" onclick="${onclickHandler}">
            <td class="py-2 px-3 text-center" style="border-right: 1px solid var(--border-dark);">
              ${rangDisplay}
            </td>
            <td class="py-2 px-3" style="border-right: 1px solid var(--border-dark); padding-left: 1.5rem !important; padding-right: 0.25rem !important;">
              <div style="display: flex; align-items: center; gap: 16px;">
                ${profilePhotoHTML}
                <span class="font-semibold" style="color: ${isCurrentUser ? '#60a5fa' : 'var(--text-light)'}; font-size: ${isCurrentUser ? '0.95rem' : '0.875rem'}; font-weight: ${isCurrentUser ? '700' : '600'};">${entrepreneur.username}</span>
                ${moiBadge}
              </div>
            </td>
            <td class="py-2 px-3 text-left font-bold text-green-600 ${sortColumn === 'ca' ? 'active-column' : ''}" data-column="ca" style="font-size: 0.8125rem; min-width: 100px;">${(entrepreneur.dollar_reel || 0).toLocaleString()}&nbsp;$</td>
            <td class="py-2 px-3 text-left ${sortColumn === 'pap' ? 'active-column' : ''}" data-column="pap" style="color: var(--text-light); font-size: 0.8125rem;">${(entrepreneur.heures_pap || 0).toFixed(1)}&nbsp;h</td>
            <td class="py-2 px-3 text-left ${sortColumn === 'marketing' ? 'active-column' : ''}" data-column="marketing" style="color: var(--text-light); font-size: 0.8125rem;">${(entrepreneur.taux_marketing || 0).toFixed(2)}</td>
            <td class="py-2 px-3 text-left font-bold ${sortColumn === 'signees' ? 'active-column' : ''}" data-column="signees" style="color: var(--text-light); font-size: 0.8125rem;">${entrepreneur.contract_reel || 0}</td>
            <td class="py-2 px-3 text-left ${sortColumn === 'estimations' ? 'active-column' : ''}" data-column="estimations" style="color: var(--text-light); font-size: 0.8125rem;">${entrepreneur.nb_estimations || 0}</td>
            <td class="py-2 px-3 text-left ${sortColumn === 'contrat' ? 'active-column' : ''}" data-column="contrat" style="color: var(--text-light); font-size: 0.8125rem;">${(entrepreneur.contrat_moyen || 0).toLocaleString()}&nbsp;$</td>
            <td class="py-2 px-3 text-left ${sortColumn === 'tv' ? 'active-column' : ''}" data-column="tv" style="color: var(--text-light); font-size: 0.8125rem;">${Math.round((entrepreneur.taux_vente || 0) * 10) / 10}%</td>
            <td class="py-2 px-3 text-left font-bold ${sortColumn === 'produit' ? 'active-column' : ''}" data-column="produit" style="color: #60a5fa; font-size: 0.8125rem;">${dollarsProduit.toLocaleString()}&nbsp;$</td>
            <td class="py-2 px-3 text-left ${sortColumn === 'prod' ? 'active-column' : ''}" data-column="prod" style="color: var(--text-light); font-size: 0.8125rem;">${Math.round(entrepreneur.prod_horaire || 0).toLocaleString()}&nbsp;$/h</td>
            <td class="py-2 px-3 text-left ${sortColumn === 'etoiles' ? 'active-column' : ''}" data-column="etoiles">
              <span class="text-yellow-500" style="font-size: 0.8125rem;">
                <i class="fas fa-star"></i> ${(entrepreneur.etoiles || 0).toFixed(1)}
              </span>
            </td>
          </tr>
        `;
      }).join('');

      // Pour le contexte entrepreneur: ajouter s√©parateur et ligne "MOI" si l'utilisateur est au-del√† du top 40
      if (context === 'entrepreneur' && currentUserBeyond40) {
        const e = currentUserBeyond40;
        const userRank = e.originalRank;

        // Photo de profil
        const photoUrl = photoMap[e.username];
        const gradeGamif = gradeGamificationMap[e.username] || 'D√©marrage';
        const gradeClass = 'grade-' + gradeGamif.toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/\s+/g, '-');
        const profilePhotoHTML = photoUrl
          ? `<div class="profile-photo-small ${gradeClass}"><img src="${photoUrl}" alt="Photo de profil"></div>`
          : `<div class="profile-photo-small ${gradeClass}"><div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #2586fd 0%, #b2c5fbc7 100%); display: flex; align-items: center; justify-content: center;"><i class="fas fa-user" style="color: white; font-size: 14px;"></i></div></div>`;

        const dollarsProduit = Math.round(e.montant_produit || 0);

        // Ligne de l'utilisateur actuel avec son vrai rang
        tbody.innerHTML += `
          <tr class="border-b current-user-row" style="border-color: var(--border-dark); cursor: pointer; background: linear-gradient(90deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.15) 100%); border-left: 4px solid #3b82f6; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);" onclick="showEntrepreneurStats(${currentUserOriginalIndex})">
            <td class="py-2 px-3 text-center" style="border-right: 1px solid var(--border-dark);">
              <span class="font-bold" style="color: #60a5fa; font-size: 1.1rem;">${userRank}</span>
            </td>
            <td class="py-2 px-3" style="border-right: 1px solid var(--border-dark); padding-left: 1.5rem !important; padding-right: 0.25rem !important;">
              <div style="display: flex; align-items: center; gap: 16px;">
                ${profilePhotoHTML}
                <span class="font-semibold" style="color: #60a5fa; font-size: 0.95rem; font-weight: 700;">${e.username}</span>
                <span style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.2rem 0.6rem; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; font-size: 0.7rem; font-weight: 700; border-radius: 12px; margin-left: 0.5rem; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4); letter-spacing: 0.5px; text-transform: uppercase;"><i class="fas fa-user-circle" style="font-size: 0.75rem;"></i>MOI</span>
              </div>
            </td>
            <td class="py-2 px-3 text-left font-bold text-green-600" style="font-size: 0.8125rem; min-width: 100px;">${(e.dollar_reel || 0).toLocaleString()}&nbsp;$</td>
            <td class="py-2 px-3 text-left" style="color: var(--text-light); font-size: 0.8125rem;">${(e.heures_pap || 0).toFixed(1)}&nbsp;h</td>
            <td class="py-2 px-3 text-left" style="color: var(--text-light); font-size: 0.8125rem;">${(e.taux_marketing || 0).toFixed(2)}</td>
            <td class="py-2 px-3 text-left font-bold" style="color: var(--text-light); font-size: 0.8125rem;">${e.contract_reel || 0}</td>
            <td class="py-2 px-3 text-left" style="color: var(--text-light); font-size: 0.8125rem;">${e.nb_estimations || 0}</td>
            <td class="py-2 px-3 text-left" style="color: var(--text-light); font-size: 0.8125rem;">${(e.contrat_moyen || 0).toLocaleString()}&nbsp;$</td>
            <td class="py-2 px-3 text-left" style="color: var(--text-light); font-size: 0.8125rem;">${Math.round((e.taux_vente || 0) * 10) / 10}%</td>
            <td class="py-2 px-3 text-left font-bold" style="color: #60a5fa; font-size: 0.8125rem;">${dollarsProduit.toLocaleString()}&nbsp;$</td>
            <td class="py-2 px-3 text-left" style="color: var(--text-light); font-size: 0.8125rem;">${Math.round(e.prod_horaire || 0).toLocaleString()}&nbsp;$/h</td>
            <td class="py-2 px-3 text-left">
              <span class="text-yellow-500" style="font-size: 0.8125rem;">
                <i class="fas fa-star"></i> ${(e.etoiles || 0).toFixed(1)}
              </span>
            </td>
          </tr>
        `;
        log(`[CLASSEMENT] Ligne MOI ajout√©e au rang ${userRank}`);
      }

      // Ajouter la ligne TOTAL seulement pour les contextes coach et direction (pas entrepreneur)
      if (context === 'coach' || context === 'coach-ranking') {
        const totals = data.reduce((acc, e) => {
          acc.dollarReel += (e.dollar_reel || 0);
          acc.heuresPap += (e.heures_pap || 0);
          acc.contractReel += (e.contract_reel || 0);
          acc.nbEstimations += (e.nb_estimations || 0);
          acc.montantProduit += (e.montant_produit || 0);
          acc.totalEtoiles += (e.etoiles || 0);
          acc.countEtoiles += (e.etoiles && e.etoiles > 0) ? 1 : 0;
          return acc;
        }, { dollarReel: 0, heuresPap: 0, contractReel: 0, nbEstimations: 0, montantProduit: 0, totalEtoiles: 0, countEtoiles: 0 });

        // Moyenne satisfaction (ou "-" si pas de donn√©es)
        const avgSatisfaction = totals.countEtoiles > 0 ? (totals.totalEtoiles / totals.countEtoiles).toFixed(1) : '-';

        tbody.innerHTML += `
          <tr class="border-t-2" style="border-color: rgba(96, 165, 250, 0.5); background: rgba(30, 41, 59, 0.8);">
            <td class="py-3 px-3 text-center font-bold" style="border-right: 1px solid var(--border-dark); color: var(--text-light);">
              <i class="fas fa-calculator" style="color: #60a5fa;"></i>
            </td>
            <td class="py-3 px-3 font-bold" style="border-right: 1px solid var(--border-dark); color: var(--text-light); font-size: 0.9rem;">
              TOTAL
            </td>
            <td class="py-3 px-3 text-left font-bold" style="color: #10b981; font-size: 0.875rem;">${totals.dollarReel.toLocaleString()}&nbsp;$</td>
            <td class="py-3 px-3 text-left font-bold" style="color: var(--text-light); font-size: 0.875rem;">${totals.heuresPap.toFixed(1)}&nbsp;h</td>
            <td class="py-3 px-3 text-left" style="color: var(--text-gray); font-size: 0.875rem;">-</td>
            <td class="py-3 px-3 text-left font-bold" style="color: var(--text-light); font-size: 0.875rem;">${totals.contractReel}</td>
            <td class="py-3 px-3 text-left font-bold" style="color: var(--text-light); font-size: 0.875rem;">${totals.nbEstimations}</td>
            <td class="py-3 px-3 text-left" style="color: var(--text-gray); font-size: 0.875rem;">-</td>
            <td class="py-3 px-3 text-left" style="color: var(--text-gray); font-size: 0.875rem;">-</td>
            <td class="py-3 px-3 text-left font-bold" style="color: #60a5fa; font-size: 0.875rem;">${Math.round(totals.montantProduit).toLocaleString()}&nbsp;$</td>
            <td class="py-3 px-3 text-left" style="color: var(--text-gray); font-size: 0.875rem;">-</td>
            <td class="py-3 px-3 text-left" style="font-size: 0.875rem;">
              <span class="text-yellow-500">
                <i class="fas fa-star"></i> ${avgSatisfaction}
              </span>
            </td>
          </tr>
        `;
      }

      // G√©n√©rer les cartes mobiles (version simplifi√©e: rang + entrepreneur seulement)
      log('[MOBILE] G√©n√©ration des cartes mobiles pour', dataToDisplay.length, 'entrepreneurs');
      mobileCards.innerHTML = dataToDisplay.map((entrepreneur, index) => {
        // M√©dailles pour les 3 premi√®res positions
        let rangDisplay = '';
        if (index === 0) {
          rangDisplay = '<i class="fas fa-medal text-lg" style="color: #fbbf24;"></i>'; // Or
        } else if (index === 1) {
          rangDisplay = '<i class="fas fa-medal text-lg" style="color: #94a3b8;"></i>'; // Argent
        } else if (index === 2) {
          rangDisplay = '<i class="fas fa-medal text-lg" style="color: #cd7f32;"></i>'; // Bronze
        } else {
          rangDisplay = `<span class="font-bold text-base" style="color: var(--text-light);">${index + 1}</span>`;
        }

        // Photo de profil avec contour de grade GAMIFICATION (mobile)
        const photoUrl = photoMap[entrepreneur.username];
        const gradeGamif = gradeGamificationMap[entrepreneur.username] || 'D√©marrage';
        const gradeClass = 'grade-' + gradeGamif.toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/\s+/g, '-');

        const profilePhotoContent = photoUrl
          ? `<img src="${photoUrl}" alt="Photo de profil" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`
          : `<div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #2586fd 0%, #b2c5fbc7 100%); display: flex; align-items: center; justify-content: center;"><i class="fas fa-user" style="color: white; font-size: 14px;"></i></div>`;

        const profilePhotoHTML = `<div class="classement-card-photo-container ${gradeClass}">${profilePhotoContent}</div>`;

        // Badge "Moi" si c'est l'utilisateur actuel - style plus visible (avec protection contre undefined)
        const isCurrentUser = currentUsername && (
          (entrepreneur.username && entrepreneur.username === currentUsername) ||
          (entrepreneur.login_username && entrepreneur.login_username === currentUsername)
        );
        const meBadge = isCurrentUser
          ? `<span style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.2rem 0.6rem; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; font-size: 0.7rem; font-weight: 700; border-radius: 12px; margin-left: 0.5rem; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4); letter-spacing: 0.5px; text-transform: uppercase;"><i class="fas fa-user-circle" style="font-size: 0.75rem;"></i>MOI</span>`
          : '';

        // Style sp√©cial pour la carte "MOI" (plus visible)
        const moiCardStyle = isCurrentUser
          ? 'background: linear-gradient(90deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.15) 100%); border-left: 4px solid #3b82f6; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);'
          : '';

        // Handler onclick mobile selon le contexte (entrepreneur, coach, ou coach-ranking)
        const mobileLoginUsername = (entrepreneur.login_username || entrepreneur.username).replace(/'/g, "\\'");
        const mobileDisplayName = entrepreneur.username.replace(/'/g, "\\'");
        let mobileOnclickHandler;
        if (context === 'coach') {
          mobileOnclickHandler = `showCoachClassementEntrepreneurStats('${mobileLoginUsername}')`;
        } else if (context === 'coach-ranking') {
          mobileOnclickHandler = `openCoachStatsModal('${mobileLoginUsername}', '${mobileDisplayName}')`;
        } else {
          mobileOnclickHandler = `showEntrepreneurStats(${index})`;
        }

        return `
          <div class="classement-card" onclick="${mobileOnclickHandler}" style="${moiCardStyle}">
            <div class="classement-card-rang">
              ${rangDisplay}
            </div>
            <div class="classement-card-photo">
              ${profilePhotoHTML}
            </div>
            <div class="classement-card-info">
              <div class="classement-card-name" style="${isCurrentUser ? 'color: #60a5fa; font-weight: 700; font-size: 1rem;' : ''}">${entrepreneur.username}${meBadge}</div>
            </div>
          </div>
        `;
      }).join('');

      // Pour le contexte entrepreneur mobile: ajouter s√©parateur et carte "MOI" si au-del√† du top 40
      if (context === 'entrepreneur' && currentUserBeyond40) {
        const e = currentUserBeyond40;
        const userRank = e.originalRank;

        // Photo de profil
        const photoUrl = photoMap[e.username];
        const gradeGamif = gradeGamificationMap[e.username] || 'D√©marrage';
        const gradeClass = 'grade-' + gradeGamif.toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/\s+/g, '-');
        const profilePhotoContent = photoUrl
          ? `<img src="${photoUrl}" alt="Photo de profil" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`
          : `<div style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #2586fd 0%, #b2c5fbc7 100%); display: flex; align-items: center; justify-content: center;"><i class="fas fa-user" style="color: white; font-size: 14px;"></i></div>`;
        const profilePhotoHTML = `<div class="classement-card-photo-container ${gradeClass}">${profilePhotoContent}</div>`;

        // Carte de l'utilisateur actuel
        mobileCards.innerHTML += `
          <div class="classement-card" onclick="showEntrepreneurStats(${currentUserOriginalIndex})" style="background: linear-gradient(90deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.15) 100%); border-left: 4px solid #3b82f6; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);">
            <div class="classement-card-rang">
              <span class="font-bold text-base" style="color: #60a5fa; font-size: 1.1rem;">${userRank}</span>
            </div>
            <div class="classement-card-photo">
              ${profilePhotoHTML}
            </div>
            <div class="classement-card-info">
              <div class="classement-card-name" style="color: #60a5fa; font-weight: 700; font-size: 1rem;">
                ${e.username}
                <span style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.2rem 0.6rem; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; font-size: 0.7rem; font-weight: 700; border-radius: 12px; margin-left: 0.5rem; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4); letter-spacing: 0.5px; text-transform: uppercase;"><i class="fas fa-user-circle" style="font-size: 0.75rem;"></i>MOI</span>
              </div>
            </div>
          </div>
        `;
      }
    }
    // Exposer la fonction globalement pour renderCoachClassementCards()
    window.renderClassement = renderClassement;

    // Variables globales pour le modal
    let currentClassementData = [];
    let currentCoachClassementData = []; // Donn√©es sp√©cifiques au classement coach (pour √©viter les √©crasements)
    window.coachClassementDataMap = new Map(); // Map pour stocker les donn√©es par username (plus fiable que l'array) - GLOBAL

    // Fonction pour afficher les stats d'un entrepreneur dans le modal (classement entrepreneur)
    window.showEntrepreneurStats = function(index) {
      console.log('[SHOW ENTREPRENEUR STATS] Index cliqu√©:', index);
      console.log('[SHOW ENTREPRENEUR STATS] currentClassementData length:', currentClassementData.length);
      console.log('[SHOW ENTREPRENEUR STATS] Premiers 3 entrepreneurs:', currentClassementData.slice(0, 3).map(e => ({
        username: e.username,
        login_username: e.login_username,
        prenom: e.prenom,
        nom: e.nom
      })));

      const entrepreneur = currentClassementData[index];
      if (!entrepreneur) {
        console.error('[SHOW ENTREPRENEUR STATS] Entrepreneur non trouv√© √† l\'index:', index);
        return;
      }

      // Log pour d√©boguer
      log('[MODAL DEBUG] Entrepreneur cliqu√©:', {
        username: entrepreneur.username,
        login_username: entrepreneur.login_username,
        prenom: entrepreneur.prenom,
        nom: entrepreneur.nom,
        photoUrl: entrepreneur.photoUrl
      });

      // Ouvrir le modal complet de statistiques (PC et mobile)
      // Utiliser login_username si disponible, sinon username
      const targetUsername = entrepreneur.login_username || entrepreneur.username;
      // Construire le nom complet (prenom + nom)
      const fullName = [entrepreneur.prenom, entrepreneur.nom].filter(Boolean).join(' ') || entrepreneur.username;
      // Passer le nom complet ET les donn√©es de l'entrepreneur
      log('[MODAL DEBUG] Passage au modal - username:', targetUsername, 'fullName:', fullName, 'data:', entrepreneur);
      openUserStatsModal(targetUsername, fullName, entrepreneur);
      return;

    }

    // Fonction pour fermer le modal
    window.closeEntrepreneurStats = function(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('entrepreneurStatsModal');
      modal.classList.remove('show');
      // R√©activer le scroll du body
      document.body.style.overflow = '';
    }

    // ================================================================
    // FONCTION POUR LE CLASSEMENT COACH (utilise currentCoachClassementData)
    // ================================================================

    window.showCoachClassementEntrepreneurStats = function(username) {
      console.log('[SHOW COACH CLASSEMENT STATS] Username cliqu√©:', username);
      console.log('[SHOW COACH CLASSEMENT STATS] coachClassementDataMap size:', window.coachClassementDataMap.size);
      console.log('[SHOW COACH CLASSEMENT STATS] Cl√©s disponibles dans la Map:', Array.from(window.coachClassementDataMap.keys()));

      // Chercher dans la Map d'abord (plus fiable)
      let entrepreneur = window.coachClassementDataMap.get(username);

      if (!entrepreneur) {
        console.error('[SHOW COACH CLASSEMENT STATS] Entrepreneur non trouv√© dans la Map pour username:', username);
        console.log('[SHOW COACH CLASSEMENT STATS] Tentative de recherche dans l\'array...');

        // Fallback: chercher dans l'array
        entrepreneur = currentCoachClassementData.find(e =>
          e.login_username === username || e.username === username
        );

        if (!entrepreneur) {
          console.error('[SHOW COACH CLASSEMENT STATS] Entrepreneur non trouv√© dans l\'array non plus!');
          console.log('[SHOW COACH CLASSEMENT STATS] currentCoachClassementData:', currentCoachClassementData);
          return;
        }
      }

      console.log('[SHOW COACH CLASSEMENT STATS] Entrepreneur trouv√©:', entrepreneur);

      // Ouvrir le modal complet de statistiques (PC et mobile)
      // Utiliser login_username si disponible, sinon username
      const targetUsername = entrepreneur.login_username || entrepreneur.username;
      // Construire le nom complet (prenom + nom)
      const fullName = [entrepreneur.prenom, entrepreneur.nom].filter(Boolean).join(' ') || entrepreneur.username;
      // Passer le nom complet ET les donn√©es de l'entrepreneur
      console.log('[SHOW COACH CLASSEMENT STATS] Ouverture modal - username:', targetUsername, 'fullName:', fullName);
      openUserStatsModal(targetUsername, fullName, entrepreneur);
    }

    // ================================================================
    // FONCTIONS DU MODAL DE STATISTIQUES UTILISATEUR
    // ================================================================

    // Fonction pour ouvrir le modal de stats d'un utilisateur
    async function openUserStatsModal(username, fullName = null, entrepreneurData = null) {
      // UTILISER LE MODAL D'APPPC.HTML (m√™me modal que les statistiques du menu)
      if (parent && parent.openStatsModal) {
        // Appeler la fonction du parent (apppc.html) avec le fullName ET les donn√©es
        await parent.openStatsModal(username, fullName, entrepreneurData);
      } else if (window.openStatsModal) {
        // Si pas dans une iframe, utiliser la fonction locale
        await window.openStatsModal(username, fullName, entrepreneurData);
      } else {
        error('openStatsModal non disponible');
        alert('Erreur: modal de statistiques non disponible');
      }
    }

    // Fonction pour ouvrir le modal de stats d'un coach depuis le classement coach
    window.openCoachStatsModal = async function(username, fullName = null) {
      // UTILISER LE MODAL D'APPPC/APPPCCOACH.HTML (m√™me modal que les statistiques du menu)
      if (parent && parent.openStatsModal) {
        // Appeler la fonction du parent (apppc.html ou apppccoach.html) avec le fullName
        await parent.openStatsModal(username, fullName);
      } else if (window.openStatsModal) {
        // Si pas dans une iframe, utiliser la fonction locale
        await window.openStatsModal(username, fullName);
      } else {
        error('openStatsModal non disponible');
        alert('Erreur: modal de statistiques non disponible');
      }
    }

    // Fonction pour fermer le modal de stats
    function closeUserStatsModal() {
      const modal = document.getElementById('user-stats-modal');
      if (modal) {
        modal.classList.remove('active');
      }
      // R√©activer le scroll
      document.body.style.overflow = '';
    }

    // Toggle badges section (expand/collapse)
    function toggleUserBadgesSection() {
      const badgesGrid = document.getElementById('user-stats-badges-grid');
      const expandBtn = document.getElementById('user-badges-expand-btn');
      const expandText = document.getElementById('user-badges-expand-text');
      const expandIcon = document.getElementById('user-badges-expand-icon');

      if (badgesGrid.classList.contains('show')) {
        // Collapse: cacher les sections par raret√© (top 5 reste visible)
        badgesGrid.classList.remove('show');
        expandBtn.classList.remove('expanded');
        expandText.textContent = 'Voir tous';
        expandIcon.classList.remove('fa-chevron-up');
        expandIcon.classList.add('fa-chevron-down');
      } else {
        // Expand: montrer toutes les sections par raret√© (top 5 reste visible)
        badgesGrid.classList.add('show');
        expandBtn.classList.add('expanded');
        expandText.textContent = 'R√©duire';
        expandIcon.classList.remove('fa-chevron-down');
        expandIcon.classList.add('fa-chevron-up');
      }
    }

    // Fonction pour peupler le modal avec les donn√©es
    async function populateUserStatsModal(profile, username, preloadedPhotoUrl = null) {
      log('Peuplement du modal avec:', { profile, username, preloadedPhotoUrl });

      const gradeImageMap = {
        'D√©marrage': 'https://i.ibb.co/v6PRQ6RX/2.png',
        'Apprenti': 'https://i.ibb.co/CpT20JQK/3.png',
        'Pilier': 'https://i.ibb.co/ksw5bZnH/4.png',
        'Expert': 'https://i.ibb.co/HfDN4YV2/5.png',
        'Ma√Ætre': 'https://i.ibb.co/YTbb1Bpw/6.png',
        'H√©ros': 'https://i.ibb.co/q322mLQd/8.png',
        'Prestige': 'https://i.ibb.co/k2fNLV6S/9.png'
      };

      const gradeLevels = [
        { name: 'D√©marrage', minLevel: 1, maxLevel: 1 },
        { name: 'Apprenti', minLevel: 2, maxLevel: 10 },
        { name: 'Pilier', minLevel: 11, maxLevel: 30 },
        { name: 'Expert', minLevel: 31, maxLevel: 50 },
        { name: 'Ma√Ætre', minLevel: 51, maxLevel: 75 },
        { name: 'H√©ros', minLevel: 76, maxLevel: 90 },
        { name: 'Prestige', minLevel: 91, maxLevel: 100 }
      ];

      // Profil (desktop et mobile)
      document.getElementById('user-stats-username').textContent = username || 'Utilisateur';
      document.getElementById('user-stats-username-mobile').textContent = username || 'Utilisateur';

      // Photo de profil (desktop et mobile)
      const statsPhoto = document.getElementById('user-stats-profile-photo');
      const statsPhotoMobile = document.getElementById('user-stats-profile-photo-mobile');

      // Log pour d√©boguer
      log('[DASHBOARD DEBUG] populateUserStatsModal - username:', username, 'preloadedPhotoUrl:', preloadedPhotoUrl);

      // Si une photoUrl pr√©charg√©e est fournie, l'utiliser directement
      if (preloadedPhotoUrl) {
        log('[DASHBOARD DEBUG] Utilisation de la photo pr√©charg√©e:', preloadedPhotoUrl);
        statsPhoto.src = preloadedPhotoUrl;
        statsPhotoMobile.src = preloadedPhotoUrl;
      } else {
        log('[DASHBOARD DEBUG] Pas de photo pr√©charg√©e, chargement via API');
        // Sinon, charger via l'API
        try {
          const photoResponse = await fetch(`/api/get-profile-photo/${username}`);

          if (photoResponse.ok) {
            const photoData = await photoResponse.json();
            // V√©rifier si photoUrl existe dans la r√©ponse
            if (photoData && photoData.photoUrl) {
              statsPhoto.src = photoData.photoUrl;
              statsPhotoMobile.src = photoData.photoUrl;
            } else {
              // Fallback sur SVG avec initiale
              const initial = username.charAt(0).toUpperCase();
              const fallbackSvg = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%2360a5fa" width="100" height="100"/><text x="50" y="50" font-size="50" text-anchor="middle" dy=".3em" fill="white">${initial}</text></svg>`;
              statsPhoto.src = fallbackSvg;
              statsPhotoMobile.src = fallbackSvg;
            }
          } else {
            // Erreur de r√©ponse, utiliser le fallback
            const initial = username.charAt(0).toUpperCase();
            const fallbackSvg = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%2360a5fa" width="100" height="100"/><text x="50" y="50" font-size="50" text-anchor="middle" dy=".3em" fill="white">${initial}</text></svg>`;
            statsPhoto.src = fallbackSvg;
            statsPhotoMobile.src = fallbackSvg;
          }
        } catch (error) {
          error('Erreur photo:', error);
          // En cas d'erreur, utiliser le fallback
          const initial = username.charAt(0).toUpperCase();
          const fallbackSvg = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%2360a5fa" width="100" height="100"/><text x="50" y="50" font-size="50" text-anchor="middle" dy=".3em" fill="white">${initial}</text></svg>`;
          if (statsPhoto) {
            statsPhoto.src = fallbackSvg;
          }
          if (statsPhotoMobile) {
            statsPhotoMobile.src = fallbackSvg;
          }
        }
      }

      // Nom du grade dans la section du haut (desktop et mobile)
      document.getElementById('user-stats-grade-name-display').textContent = profile.category || 'D√©marrage';
      document.getElementById('user-stats-grade-name-display-mobile').textContent = profile.category || 'D√©marrage';

      // Niveau sur le badge photo (desktop et mobile)
      document.getElementById('user-stats-photo-level-text').textContent = profile.level || 1;
      document.getElementById('user-stats-photo-level-text-mobile').textContent = profile.level || 1;

      // Appliquer le contour de grade √† la photo de profil (desktop et mobile)
      const photoContainers = document.querySelectorAll('#user-stats-modal .stats-profile-photo-container');
      if (photoContainers.length > 0 && profile.category) {
        // Convertir le nom du grade en classe CSS
        // D√©marrage ‚Üí grade-demarrage, Ma√Ætre ‚Üí grade-maitre, etc.
        const gradeClass = 'grade-' + profile.category.toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Enlever accents
          .replace(/\s+/g, '-'); // Remplacer espaces par tirets

        photoContainers.forEach(photoContainer => {
          // Retirer toutes les classes de grade pr√©c√©dentes
          photoContainer.className = photoContainer.className.replace(/grade-\S+/g, '').trim();

          // Ajouter la nouvelle classe de grade
          photoContainer.classList.add(gradeClass);
        });
        log(`Contour de grade appliqu√©: ${gradeClass}`);
      }

      // XP (desktop et mobile)
      document.getElementById('user-stats-xp-current').textContent = profile.xp_progress || 0;
      document.getElementById('user-stats-xp-next').textContent = profile.xp_for_next_level || 100;
      document.getElementById('user-stats-xp-fill').style.width = `${profile.progress_percentage || 0}%`;
      document.getElementById('user-stats-xp-percentage').textContent = `${Math.round(profile.progress_percentage || 0)}%`;

      document.getElementById('user-stats-xp-current-mobile').textContent = profile.xp_progress || 0;
      document.getElementById('user-stats-xp-next-mobile').textContent = profile.xp_for_next_level || 100;
      document.getElementById('user-stats-xp-fill-mobile').style.width = `${profile.progress_percentage || 0}%`;
      document.getElementById('user-stats-xp-percentage-mobile').textContent = `${Math.round(profile.progress_percentage || 0)}%`;

      // Progression vers prochain grade
      const currentLevel = profile.level || 1;
      const currentGradeIndex = gradeLevels.findIndex(g => currentLevel >= g.minLevel && currentLevel <= g.maxLevel);
      const currentGrade = gradeLevels[currentGradeIndex >= 0 ? currentGradeIndex : 0];

      if (currentGrade) {
        document.getElementById('user-stats-current-grade-badge').src = gradeImageMap[currentGrade.name];

        if (currentGrade.name === 'Prestige') {
          document.getElementById('user-stats-current-level-text').textContent = `Niv ${currentLevel}`;
          document.getElementById('user-stats-next-level-text').innerHTML = '<span style="color: var(--primary-gold);">Max</span>';
          document.getElementById('user-stats-next-grade-fill').style.width = '100%';
          document.getElementById('user-stats-next-grade-badge').src = gradeImageMap['Prestige'];
        } else {
          const nextGrade = gradeLevels[currentGradeIndex + 1];
          const nextGradeLevel = nextGrade.minLevel;

          document.getElementById('user-stats-next-grade-badge').src = gradeImageMap[nextGrade.name];
          document.getElementById('user-stats-current-level-text').textContent = `Niv ${currentLevel}`;
          document.getElementById('user-stats-next-level-text').textContent = `Niv ${nextGradeLevel}`;

          const levelsInCurrentGrade = currentGrade.maxLevel - currentGrade.minLevel + 1;
          const levelProgress = currentLevel - currentGrade.minLevel;
          const progressPercentage = (levelProgress / levelsInCurrentGrade) * 100;
          document.getElementById('user-stats-next-grade-fill').style.width = `${progressPercentage}%`;
        }
      }

      // Stats principales
      document.getElementById('user-stats-total-xp').textContent = profile.total_xp || 0;
      document.getElementById('user-stats-badges').textContent = profile.badges_count || 0;

      // Stats Business - Fetch from /api/entrepreneurs
      try {
        const entrepreneurResponse = await fetch('/api/entrepreneurs');
        if (entrepreneurResponse.ok) {
          const entrepreneurs = await entrepreneurResponse.json();
          const currentEntrepreneur = entrepreneurs.find(e => e.username === username);

          if (currentEntrepreneur) {
            // CA Actuel (dollar_reel = contrats factur√©s depuis RPO)
            document.getElementById('user-stats-ca-actuel').textContent = `${(currentEntrepreneur.dollar_reel || 0).toLocaleString()} $`;

            // Contrats sign√©s
            document.getElementById('user-stats-contrats-signes').textContent = currentEntrepreneur.contract_reel || 0;

            // Satisfaction
            document.getElementById('user-stats-satisfaction').textContent = (currentEntrepreneur.etoiles || 0).toFixed(1);

            // Contrat moyen
            document.getElementById('user-stats-contrat-moyen').textContent = `${(currentEntrepreneur.contrat_moyen || 0).toLocaleString()} $`;

            // Taux marketing
            document.getElementById('user-stats-taux-marketing').textContent = `${(currentEntrepreneur.taux_marketing || 0).toFixed(2)}`;

            // Taux de vente
            document.getElementById('user-stats-taux-vente').textContent = `${Math.round((currentEntrepreneur.taux_vente || 0) * 10) / 10}%`;

            // Productivit√© horaire
            document.getElementById('user-stats-prod-horaire').textContent = `${(currentEntrepreneur.prod_horaire || 0).toLocaleString()} $/h`;

            // Heures de P√ÄP
            document.getElementById('user-stats-heures-pap').textContent = `${(currentEntrepreneur.heures_pap || 0).toFixed(1)} h`;
          } else {
            // Utilisateur non trouv√©, mettre des valeurs par d√©faut
            document.getElementById('user-stats-ca-actuel').textContent = '0 $';
            document.getElementById('user-stats-contrats-signes').textContent = '0';
            document.getElementById('user-stats-satisfaction').textContent = '0.0';
            document.getElementById('user-stats-contrat-moyen').textContent = '0 $';
            document.getElementById('user-stats-taux-marketing').textContent = '0.00';
            document.getElementById('user-stats-taux-vente').textContent = '0%';
            document.getElementById('user-stats-prod-horaire').textContent = '0 $/h';
            document.getElementById('user-stats-heures-pap').textContent = '0.0 h';
          }
        }
      } catch (error) {
        error('Erreur chargement stats business:', error);
      }

      // Charger les badges obtenus
      try {
        log(`Chargement des badges pour ${username}...`);
        const badgesResponse = await fetch(`/api/gamification/badges/user/${username}`);
        log('R√©ponse badges status:', badgesResponse.status);

        if (badgesResponse.ok) {
          const badgesData = await badgesResponse.json();
          log('Donn√©es badges brutes:', badgesData);
          const badgesGrid = document.getElementById('user-stats-badges-grid');

          let badges = [];

          // Format attendu: {status: 'success', badges: [...]}
          if (badgesData.badges && Array.isArray(badgesData.badges)) {
            badges = badgesData.badges;
          } else if (Array.isArray(badgesData)) {
            badges = badgesData;
          }

          log(`${badges.length} badges trouv√©s pour ${username}`);

          if (badges.length > 0) {
            // Fonction helper pour cr√©er un badge item
            const createBadgeItem = (badge, showRarity = false) => {
              const badgeItem = document.createElement('div');
              badgeItem.className = 'badge-item';

              const imageUrl = badge.image_url || badge.icon_url || '';
              const emoji = badge.image || badge.icon || badge.emoji || '';
              const badgeName = badge.name || badge.badge_name || badge.title || 'Badge';
              const rarity = badge.rarity || badge.rarete || 'Commun';
              const description = badge.description || 'Aucune description disponible';

              // PRIORISER image_url (PNG) sur icon (emoji)
              let imageHTML = '';
              if (imageUrl && imageUrl.startsWith('http')) {
                imageHTML = `<img src="${imageUrl}" alt="${badgeName}" class="badge-image">`;
              } else if (emoji && emoji.startsWith && emoji.startsWith('http')) {
                imageHTML = `<img src="${emoji}" alt="${badgeName}" class="badge-image">`;
              } else if (emoji) {
                imageHTML = `<div class="badge-emoji">${emoji}</div>`;
              } else {
                imageHTML = `<div class="badge-emoji">üèÖ</div>`;
              }

              // Normaliser la raret√© pour la classe CSS
              const rarityClass = rarity.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]/g, '-');

              const rarityHTML = showRarity ? `<div class="badge-rarity ${rarityClass}">${rarity}</div>` : '';

              badgeItem.innerHTML = `
                ${imageHTML}
                ${rarityHTML}
                <div class="badge-info-icon">
                  <i class="fas fa-info"></i>
                  <div class="badge-tooltip">
                    <div class="tooltip-title">${badgeName}</div>
                    <div class="tooltip-description">${description}</div>
                  </div>
                </div>
              `;
              return badgeItem;
            };

            // Grouper les badges par raret√©
            const rarityOrder = ['Mythique', '√âpique', 'L√©gendaire', 'Rare', 'Commun', 'Anti-Badge'];
            const badgesByRarity = {};

            // Initialiser les cat√©gories
            rarityOrder.forEach(r => badgesByRarity[r] = []);

            // Grouper les badges
            badges.forEach(badge => {
              const rarity = badge.rarity || badge.rarete || 'Commun';
              if (!badgesByRarity[rarity]) {
                badgesByRarity[rarity] = [];
              }
              badgesByRarity[rarity].push(badge);
            });

            // === TOP 5 MEILLEURS BADGES (par raret√©) ===
            const topBadgesContainer = document.getElementById('user-stats-badges-top');
            topBadgesContainer.innerHTML = '';

            const topBadges = [];
            rarityOrder.forEach(rarity => {
              const rarityBadges = badgesByRarity[rarity];
              if (rarityBadges && rarityBadges.length > 0) {
                topBadges.push(...rarityBadges);
              }
            });

            // Prendre les 5 premiers (les plus rares)
            const top5 = topBadges.slice(0, 5);
            if (top5.length > 0) {
              top5.forEach(badge => {
                topBadgesContainer.appendChild(createBadgeItem(badge, true)); // Afficher la raret√©
              });
            } else {
              topBadgesContainer.innerHTML = '<div class="no-badges-message">Aucun badge</div>';
            }

            // === TOUS LES BADGES PAR RARET√â (cach√© par d√©faut) ===
            badgesGrid.innerHTML = '';

            rarityOrder.forEach(rarity => {
              const rarityBadges = badgesByRarity[rarity];
              if (rarityBadges && rarityBadges.length > 0) {
                const rarityClass = rarity.toLowerCase()
                  .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                  .replace(/[^a-z0-9]/g, '-');

                const raritySection = document.createElement('div');
                raritySection.className = 'rarity-section';

                const rarityTitle = document.createElement('div');
                rarityTitle.className = 'rarity-section-title';
                rarityTitle.innerHTML = `
                  <span class="badge-rarity ${rarityClass}">${rarity}</span>
                  <span class="rarity-badge-count">${rarityBadges.length}</span>
                `;
                raritySection.appendChild(rarityTitle);

                const scrollContainer = document.createElement('div');
                scrollContainer.className = 'badges-horizontal-scroll';

                rarityBadges.forEach(badge => {
                  scrollContainer.appendChild(createBadgeItem(badge));
                });

                raritySection.appendChild(scrollContainer);
                badgesGrid.appendChild(raritySection);
              }
            });
          } else {
            document.getElementById('user-stats-badges-top').innerHTML = '<div class="no-badges-message">Aucun badge obtenu pour le moment</div>';
            badgesGrid.innerHTML = '<div class="no-badges-message">Aucun badge obtenu pour le moment</div>';
          }
        }
      } catch (error) {
        error('Erreur chargement badges:', error);
        document.getElementById('user-stats-badges-grid').innerHTML = '<div class="no-badges-message">Erreur de chargement des badges</div>';
      }
    }

    // Fermer le modal en cliquant sur le fond
    document.addEventListener('click', (e) => {
      const modal = document.getElementById('user-stats-modal');
      if (e.target === modal) {
        closeUserStatsModal();
      }
    });

    // Rendre les fonctions globales
    window.openUserStatsModal = openUserStatsModal;
    window.closeUserStatsModal = closeUserStatsModal;
    window.toggleUserBadgesSection = toggleUserBadgesSection;

    function filterClassementByGroup(groupValue) {
      currentGroupFilter = groupValue;

      log('[FILTER] üîç D√©but filterClassementByGroup - groupValue:', groupValue);
      log('[FILTER] classementData length:', classementData.length);
      log('[FILTER] √âchantillon des grades dans classementData:',
        classementData.slice(0, 3).map(e => ({ username: e.username, grade: e.grade }))
      );

      // Filtrer par grade
      let filteredData = classementData;

      if (groupValue !== 'tous') {
        filteredData = classementData.filter(entrepreneur => {
          const grade = entrepreneur.grade || '';

          let matches = false;
          switch(groupValue) {
            case 'recrue':
              matches = grade === 'recrue' || grade === 'rookie';
              break;
            case 'senior1':
              matches = grade === 'senior1';
              break;
            case 'senior2':
              matches = grade === 'senior2';
              break;
            case 'senior3':
              matches = grade === 'senior3';
              break;
            default:
              matches = true;
          }

          if (matches) {
            log(`[FILTER] ‚úÖ ${entrepreneur.username} (grade: ${grade}) correspond au filtre ${groupValue}`);
          } else {
            log(`[FILTER] ‚ùå ${entrepreneur.username} (grade: ${grade}) ne correspond pas au filtre ${groupValue}`);
          }

          return matches;
        });

        log('[FILTER] R√©sultat: filteredData length:', filteredData.length);
      }

      // Trier les donn√©es filtr√©es avec le tri actuel
      // Chercher d'abord dans les headers de colonnes (.sortable-header.active)
      const activeHeader = document.querySelector('.sortable-header.active');
      const currentSort = activeHeader ? activeHeader.getAttribute('data-sort') : 'ca';

      log('[FILTER] Tri actuel d√©tect√©:', currentSort);

      const sortedData = [...filteredData].sort((a, b) => {
        switch(currentSort) {
          case 'ca': return (b.dollar_reel || 0) - (a.dollar_reel || 0);
          case 'signees': return (b.contract_reel || 0) - (a.contract_reel || 0);
          case 'etoiles': return (b.etoiles || 0) - (a.etoiles || 0);
          case 'contrat': return (b.contrat_moyen || 0) - (a.contrat_moyen || 0);
          case 'marketing': return (b.taux_marketing || 0) - (a.taux_marketing || 0);
          case 'tv': return (b.taux_vente || 0) - (a.taux_vente || 0);
          case 'prod': return (b.prod_horaire || 0) - (a.prod_horaire || 0);
          case 'pap': return (b.heures_pap || 0) - (a.heures_pap || 0);
          case 'produit': return (b.montant_produit || 0) - (a.montant_produit || 0);
          case 'estimations': {
            const totalA = a.nb_estimations || 0;
            const totalB = b.nb_estimations || 0;
            return totalB - totalA;
          }
          default: return (b.dollar_reel || 0) - (a.dollar_reel || 0);
        }
      });

      renderClassement(sortedData);
    }

    async function loadClassementData() {
      log('[CLASSEMENT] üöÄ DEBUT loadClassementData');
      try {
        // Pour les entrepreneurs, ne pas attendre window.rpoDataReady (d√©j√† charg√© avant)
        const userRole = localStorage.getItem('userRole');
        log('[CLASSEMENT] UserRole:', userRole);
        if (userRole === 'coach' || userRole === 'direction') {
          log('[CLASSEMENT] Mode coach/direction - attente window.rpoDataReady');
          // Attendre que les donn√©es RPO soient pr√™tes (jusqu'√† 5 secondes max)
          let waitCount = 0;
          while (!window.rpoDataReady && waitCount < 50) {
            await new Promise(resolve => setTimeout(resolve, 100));
            waitCount++;
          }
          log('[CLASSEMENT] window.rpoDataReady OK apr√®s', waitCount * 100, 'ms');
        } else {
          log('[CLASSEMENT] Mode entrepreneur - pas d\'attente');
        }

        // D√©terminer quel endpoint appeler selon le type de dashboard
        const isDashboardQualiteEtudiants = window.dashboardType === 'qualite-etudiants';
        const isDashboardParCoach = window.dashboardType === 'par-coach';
        log('[CLASSEMENT] Dashboard type:', window.dashboardType, '| Qualite:', isDashboardQualiteEtudiants, '| ParCoach:', isDashboardParCoach);

        let apiEndpoint;
        let classementDataSource;

        // Construire les param√®tres de p√©riode
        let periodParam = '';
        if (currentPeriode === 'custom' && currentCustomDates) {
          periodParam = `start=${currentCustomDates.start}&end=${currentCustomDates.end}`;
        } else if (currentPeriode === 'annee') {
          periodParam = 'period=all';
        } else if (currentPeriode === 'semaine') {
          periodParam = 'period=week';
        } else {
          // Pour 90, 30, 14 jours
          periodParam = `period=${currentPeriode}`;
        }

        if (isDashboardQualiteEtudiants) {
          // Dashboard Qualit√© √âtudiants: afficher les coaches
          apiEndpoint = '/api/coaches';
          classementDataSource = 'coaches';
        } else if (isDashboardParCoach) {
          // Dashboard par Coach: afficher les entrepreneurs de l'√©quipe du coach s√©lectionn√©
          const selectedCoach = window.selectedCoachUsername;
          if (selectedCoach) {
            apiEndpoint = `/api/coach/${selectedCoach}/equipe/dashboard?${periodParam}`;
            classementDataSource = 'equipe';
          } else {
            // Pas de coach s√©lectionn√©, afficher rien
            classementData = [];
            renderClassement([]);
            return;
          }
        } else {
          // Autres dashboards: afficher tous les entrepreneurs
          apiEndpoint = `/api/entrepreneurs?${periodParam}`;
          classementDataSource = 'entrepreneurs';
        }

        log(`üîÑ Chargement depuis ${apiEndpoint}...`);
        log('[DEBUG] window.heuresPAPReel:', window.heuresPAPReel);
        log('[DEBUG] window.tauxMarketingReel:', window.tauxMarketingReel);
        const response = await fetch(apiEndpoint);

        if (!response.ok) {
          throw new Error('Erreur lors du chargement des donn√©es');
        }

        let responseData = await response.json();

        // Si c'est l'endpoint equipe, extraire les entrepreneurs de la r√©ponse
        if (classementDataSource === 'equipe') {
          classementData = responseData.entrepreneurs || [];
        } else {
          classementData = responseData;
        }
        log('[DEBUG loadClassementData] Dashboard type:', window.dashboardType);
        log('[DEBUG loadClassementData] API endpoint:', apiEndpoint);
        log('[DEBUG loadClassementData] Data source:', classementDataSource);
        log('[DEBUG loadClassementData] Raw data count:', classementData.length);
        log('[DEBUG loadClassementData] Raw data:', classementData);
        log('[OK] Entrepreneurs charg√©s:', classementData);

        // Initialiser heures_pap √† 0 pour tous les entrepreneurs si le champ n'existe pas
        classementData = classementData.map(e => ({
          ...e,
          heures_pap: e.heures_pap || 0
        }));

        // IMPORTANT: Filtrer d'abord AVANT de charger les photos/grades
        // Filtrer uniquement les entrepreneurs avec nom complet (espace)
        log('[DEBUG] isDashboardQualiteEtudiants:', isDashboardQualiteEtudiants);
        if (!isDashboardQualiteEtudiants) {
          log('[DEBUG] Filtrage des entrepreneurs (seulement nom complet)...');
          const beforeFilter = classementData.length;
          classementData = classementData.filter(e => {
            const username = e.username || '';
            const hasSpace = username.trim().includes(' ');

            if (!hasSpace) {
              log(`[DEBUG] Entrepreneur "${username}" exclu (pas de nom complet)`);
              return false;
            }
            return true;
          });
          log(`[DEBUG] Apr√®s filtrage: ${beforeFilter} -> ${classementData.length} entrepreneurs`);
        } else {
          // Pour les coaches, afficher tous (pas de filtre)
          log('[DEBUG] Filtrage des coaches sans donn√©es...');
          const beforeDataFilter = classementData.length;
          classementData = classementData.filter(e => {
            const hasData = (e.dollar_reel && e.dollar_reel > 0) || (e.ca_actuel && e.ca_actuel > 0) || (e.soumissions_signees && e.soumissions_signees > 0);
            if (!hasData) {
              log(`[DEBUG] Coach "${e.username}" exclu (aucune donn√©e)`);
            }
            return hasData;
          });
          log(`[DEBUG] Apr√®s filtrage donn√©es: ${beforeDataFilter} -> ${classementData.length} coaches`);
        }

        // Corriger les donn√©es de l'utilisateur actuel en lisant directement depuis les √©l√©ments HTML du dashboard
        const currentUsername = localStorage.getItem('username');
        const userIndex = classementData.findIndex(e => e.login_username === currentUsername || e.username === currentUsername);

        if (currentUsername && userIndex !== -1) {
          log(`[FIX] Correction des donn√©es pour ${currentUsername} depuis les √©l√©ments HTML du dashboard`);

          // Prod horaire depuis #prodHoraire (ex: "107 $/h" ‚Üí 107)
          const prodHoraireElement = document.getElementById('prodHoraire');
          if (prodHoraireElement && prodHoraireElement.textContent) {
            const prodHoraireText = prodHoraireElement.textContent.trim();
            const prodHoraireValue = parseFloat(prodHoraireText.replace(/[^0-9.-]/g, ''));
            if (!isNaN(prodHoraireValue)) {
              log(`[FIX] Prod/h: ${classementData[userIndex].prod_horaire}$/h ‚Üí ${Math.round(prodHoraireValue)}$/h (depuis #prodHoraire: "${prodHoraireText}")`);
              classementData[userIndex].prod_horaire = Math.round(prodHoraireValue);
            }
          }

          // Taux marketing et H de P√ÄP viennent directement de l'API (annual.hr_pap_reel_sans_week1)
          // Pas de override - utiliser les valeurs de l'API directement

          log(`[OK] Donn√©es API utilis√©es:`, classementData[userIndex]);
        } else if (!currentUsername) {
          log(`[WARNING] currentUsername non d√©fini`);
        } else if (userIndex === -1) {
          log(`[WARNING] Utilisateur ${currentUsername} non trouv√© dans classementData`);
        }

        // Les grades sont maintenant inclus dans la r√©ponse de l'API /api/entrepreneurs
        // Pas besoin d'appels suppl√©mentaires sauf pour les coaches (qui n'ont pas de grade)
        if (isDashboardQualiteEtudiants) {
          // Pour les coaches, pas de grade (mettre une valeur par d√©faut)
          classementData.forEach(entrepreneur => {
            entrepreneur.grade = entrepreneur.grade || 'coach';
          });
        } else {
          // Pour les entrepreneurs, le grade est d√©j√† inclus depuis l'API
          // D√©finir une valeur par d√©faut seulement si vide
          classementData.forEach(entrepreneur => {
            entrepreneur.grade = entrepreneur.grade || 'recrue';
          });
        }
        log('[CLASSEMENT] Grades configur√©s pour', classementData.length, 'utilisateurs');

        await sortClassement('ca'); // Trier par CA par d√©faut
      } catch (error) {
        error('[ERROR] Erreur chargement classement:', error);
        document.getElementById('classementTableBody').innerHTML = `
          <tr>
            <td colspan="12" class="text-center py-8 text-red-500">
              <i class="fas fa-exclamation-triangle mr-2"></i>Erreur de chargement
            </td>
          </tr>
        `;
      }
    }

    // Rendre loadClassementData accessible globalement
    window.loadClassementData = loadClassementData;

    // Fonctions pour la plainte popup
    let plaintesActuellesData = []; // Donn√©es r√©elles charg√©es depuis l'API

    // Fonction pour calculer le temps business restant (excluant weekends)
    function calculateBusinessHoursRemaining(dateCreation) {
      const TOTAL_BUSINESS_HOURS = 24;
      const created = new Date(dateCreation);
      const now = new Date();

      const nowDay = now.getDay();
      const isPaused = nowDay === 0 || nowDay === 6; // Weekend

      let businessHoursElapsed = 0;
      let current = new Date(created);

      while (current < now) {
        const currentDay = current.getDay();
        if (currentDay !== 0 && currentDay !== 6) {
          const nextHour = new Date(current.getTime() + (60 * 60 * 1000));
          const timeToAdd = Math.min((now - current) / (1000 * 60 * 60), 1);
          businessHoursElapsed += timeToAdd;
          if (businessHoursElapsed >= TOTAL_BUSINESS_HOURS) break;
        }
        current = new Date(current.getTime() + (60 * 60 * 1000));
        if (current > now) break;
      }

      const hoursRemaining = Math.max(0, TOTAL_BUSINESS_HOURS - businessHoursElapsed);
      const percentRemaining = (hoursRemaining / TOTAL_BUSINESS_HOURS) * 100;

      return { hoursRemaining, isPaused, percentRemaining };
    }

    // Fonction pour cr√©er le HTML du cercle de countdown
    function createCountdownCircleHTML(dateCreation, size = 50) {
      const { hoursRemaining, isPaused, percentRemaining } = calculateBusinessHoursRemaining(dateCreation);

      const radius = (size / 2) - 4;
      const circumference = 2 * Math.PI * radius;
      const strokeDashoffset = circumference * (1 - percentRemaining / 100);

      let progressClass = '';
      if (isPaused) {
        progressClass = 'paused';
      } else if (percentRemaining < 25) {
        progressClass = 'critical';
      } else if (percentRemaining < 50) {
        progressClass = 'warning';
      }

      const hours = Math.floor(hoursRemaining);
      const minutes = Math.floor((hoursRemaining - hours) * 60);

      let timeDisplay, labelDisplay;
      const showLabel = size >= 50; // Afficher le label seulement pour les grands cercles

      if (isPaused) {
        timeDisplay = `${hours}h${minutes > 0 ? String(minutes).padStart(2, '0') : ''}`;
        labelDisplay = showLabel ? 'PAUSE' : '';
      } else if (hours > 0) {
        timeDisplay = `${hours}h${minutes > 0 ? String(minutes).padStart(2, '0') : ''}`;
        labelDisplay = ''; // Pas de label pendant la semaine
      } else {
        timeDisplay = `${minutes}min`;
        labelDisplay = ''; // Pas de label pendant la semaine
      }

      return `
        <div class="countdown-circle" style="width: ${size}px; height: ${size}px; pointer-events: none;">
          <svg width="${size}" height="${size}">
            <circle class="countdown-circle-bg" cx="${size/2}" cy="${size/2}" r="${radius}"></circle>
            <circle class="countdown-circle-progress ${progressClass}"
                    cx="${size/2}" cy="${size/2}" r="${radius}"
                    stroke-dasharray="${circumference}"
                    stroke-dashoffset="${strokeDashoffset}"></circle>
          </svg>
          <div class="countdown-text">
            <div>${timeDisplay}</div>
            ${labelDisplay ? `<span class="countdown-label">${labelDisplay}</span>` : ''}
          </div>
        </div>
      `;
    }

    // Fonction pour formater le temps restant en texte (pour compatibilit√©)
    function formatTimeRemaining(hoursRemaining, isPaused) {
      if (isPaused) {
        const hours = Math.floor(hoursRemaining);
        const minutes = Math.floor((hoursRemaining - hours) * 60);
        return `${hours}h${minutes > 0 ? String(minutes).padStart(2, '0') : ''} (PAUSE)`;
      }

      const totalMinutes = Math.floor(hoursRemaining * 60);
      const days = Math.floor(totalMinutes / (24 * 60));
      const hours = Math.floor((totalMinutes % (24 * 60)) / 60);
      const minutes = totalMinutes % 60;

      return `${days}j ${hours}h ${minutes}m`;
    }

    // Charger les plaintes depuis l'API
    async function loadPlaintesData() {
      if (!window.username) return;

      try {
        const response = await fetch(`/api/plaintes/${window.username}`);
        const data = await response.json();

        if (data.success) {
          plaintesActuellesData = data.plaintes_actuelles || [];
        }
      } catch (error) {
        console.error('Erreur lors du chargement des plaintes:', error);
      }
    }

    window.ouvrirPlaintePopup = async function() {
      await loadPlaintesData();

      document.getElementById('plaintePopup').classList.remove('hidden');
      document.body.style.overflow = 'hidden'; // Bloquer le scroll

      // Afficher la liste, cacher les d√©tails
      document.getElementById('plaintesListe').classList.remove('hidden');
      document.getElementById('plaintesListe').style.display = 'flex';
      document.getElementById('plainteDetails').classList.add('hidden');
      document.getElementById('plainteDetails').style.display = 'none';

      // Mettre √† jour le contenu
      renderPlaintesList();
    };

    window.fermerPlaintePopup = function() {
      document.getElementById('plaintePopup').classList.add('hidden');
      document.body.style.overflow = ''; // R√©activer le scroll
    };

    window.retourListePlaintes = function() {
      document.getElementById('plaintesListe').classList.remove('hidden');
      document.getElementById('plaintesListe').style.display = 'flex';
      document.getElementById('plainteDetails').classList.add('hidden');
      document.getElementById('plainteDetails').style.display = 'none';
    };

    // Rendre la liste des plaintes dynamiquement
    function renderPlaintesList() {
      const container = document.getElementById('plaintesListeContainer');
      const countSpan = document.getElementById('plaintesCount');

      countSpan.textContent = plaintesActuellesData.length;

      if (plaintesActuellesData.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8" style="color: var(--text-gray);">
            <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
            <p>Aucune plainte actuelle</p>
          </div>
        `;
        return;
      }

      container.innerHTML = plaintesActuellesData.map((plainte, index) => {
        const circleHTML = createCountdownCircleHTML(plainte.date_creation, 40);

        return `
          <div onclick="ouvrirDetailsPlainte(${index})" class="bg-gray-900 rounded-lg p-4 cursor-pointer border border-transparent transition-all">
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1 min-w-0">
                <div class="text-base font-bold truncate" style="color: var(--text-light);">${plainte.client_prenom} ${plainte.client_nom}</div>
                <div class="text-xs mt-1" style="color: var(--text-gray);">${plainte.soumission_num}</div>
              </div>
              <div class="flex items-center gap-2">
                ${circleHTML}
                <i class="fas fa-chevron-right text-gray-500 text-sm"></i>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    window.ouvrirDetailsPlainte = async function(plainteIndex) {
      const plainte = plaintesActuellesData[plainteIndex];
      if (!plainte) return;

      // Masquer la liste, afficher les d√©tails
      document.getElementById('plaintesListe').classList.add('hidden');
      document.getElementById('plainteDetails').classList.remove('hidden');
      document.getElementById('plainteDetails').style.display = 'flex';

      // Si les donn√©es t√©l√©phone/courriel ne sont pas dans la plainte, aller les chercher
      let telephone = plainte.client_telephone || '';
      let courriel = plainte.client_courriel || '';

      if (!telephone || !courriel) {
        try {
          const response = await fetch(`/api/soumissions/${window.username}/signed`);
          const data = await response.json();
          if (data.success && data.soumissions) {
            const soumission = data.soumissions.find(s => s.num === plainte.soumission_num);
            if (soumission) {
              telephone = soumission.telephone || '';
              courriel = soumission.courriel || '';
            }
          }
        } catch (error) {
          console.error('Erreur lors de la r√©cup√©ration des infos client:', error);
        }
      }

      // Afficher les d√©tails
      const circleHTMLLarge = createCountdownCircleHTML(plainte.date_creation, 80);

      document.getElementById('plainteDetails').innerHTML = `
        <div class="p-6 pb-4">
          <div class="flex items-center justify-between mb-6">
            <button onclick="retourListePlaintes()" class="text-gray-400 hover:text-white transition-colors flex items-center gap-2">
              <i class="fas fa-arrow-left"></i>
              <span class="font-semibold">Retour</span>
            </button>
            <button onclick="fermerPlaintePopup()" class="text-gray-400 hover:text-red-500 transition-colors">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <div style="display: grid; grid-template-columns: 1fr auto; gap: 1.5rem;">
            <!-- Partie gauche: Info client -->
            <div class="bg-gray-900 rounded-lg p-5 border border-red-500 border-opacity-30">
              <div class="text-xs text-gray-500 mb-1">Client</div>
              <div class="text-xl font-bold mb-3" style="color: var(--text-light);">${plainte.client_prenom} ${plainte.client_nom}</div>

              <div class="space-y-2">
                ${telephone ? `
                <div class="flex items-center gap-2">
                  <i class="fas fa-phone text-xs" style="color: var(--text-gray);"></i>
                  <div class="text-sm" style="color: var(--text-gray);">${telephone}</div>
                </div>
                ` : ''}

                ${courriel ? `
                <div class="flex items-center gap-2">
                  <i class="fas fa-envelope text-xs" style="color: var(--text-gray);"></i>
                  <div class="text-sm" style="color: var(--text-gray);">${courriel}</div>
                </div>
                ` : ''}

                <div class="flex items-center gap-2">
                  <i class="fas fa-file-signature text-xs" style="color: var(--text-gray);"></i>
                  <div class="text-sm font-medium" style="color: var(--text-gray);">${plainte.soumission_num}</div>
                </div>
              </div>
            </div>

            <!-- Partie droite: Cercle centr√© -->
            <div class="bg-gray-900 rounded-lg border border-red-500 border-opacity-30 flex items-center justify-center" style="min-width: 140px; padding: 1.5rem;">
              ${circleHTMLLarge}
            </div>
          </div>
        </div>

        <div class="px-6 flex-1" style="overflow-y: auto;">
          <div class="text-xs text-gray-500 mb-2">Message de la plainte</div>
          <div class="text-sm leading-relaxed bg-gray-900 rounded-lg p-4 border border-gray-700" style="color: var(--text-light); min-height: 150px;">
            ${plainte.description}
          </div>
        </div>

        <div class="p-6 pt-4 flex justify-end">
          <button onclick="reglerPlainte('${plainte.id}')" class="btn-primary" style="background: #10b981 !important; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3) !important;">
            <i class="fas fa-check mr-2"></i>R√©gler cette plainte
          </button>
        </div>
      `;
    };

    // Fonction pour afficher l'animation de succ√®s
    function showSuccessAnimation() {
      const overlay = document.createElement('div');
      overlay.className = 'success-overlay';
      overlay.innerHTML = `
        <div class="success-content">
          <div class="success-checkmark">
            <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
              <path d="M8 20 L16 28 L32 12" stroke="white" stroke-width="3"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">Plainte r√©gl√©e avec succ√®s!</h2>
        </div>
      `;

      document.body.appendChild(overlay);

      setTimeout(() => {
        overlay.remove();
        // Fermer le popup et recharger
        document.body.style.overflow = '';
        fermerPlaintePopup();
        updatePlainteTimer();

        // Mettre √† jour le badge dans le menu lat√©ral
        if (window.parent && window.parent.updatePlaintesBadge) {
          window.parent.updatePlaintesBadge();
        }
      }, 2000);
    }

    window.reglerPlainte = async function(plainteId) {
      try {
        const response = await fetch(`/api/plaintes/${plainteId}/resoudre`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (data.success) {
          // Recharger les donn√©es
          await loadPlaintesData();

          // Afficher l'animation de succ√®s
          showSuccessAnimation();
        } else {
          alert('Erreur lors de la r√©solution de la plainte');
        }
      } catch (error) {
        console.error('Erreur lors de la r√©solution de la plainte:', error);
        alert('Erreur lors de la r√©solution de la plainte');
      }
    };

    function updatePlainteTimer() {
      // Ne PAS charger les donn√©es √† chaque seconde - utiliser le cache
      // Les donn√©es sont charg√©es au d√©marrage et lors des √©v√©nements (plainte r√©solue)
      const plaintesCount = plaintesActuellesData.length;
      const badgeDiv = document.getElementById('plainteIcon');
      const countSpan = document.getElementById('plaintesActuel');
      const zeroSpan = document.getElementById('plaintesZero');

      if (plaintesCount > 0) {
        // Afficher le badge chrono + le compteur rouge
        badgeDiv.classList.remove('hidden');
        countSpan.classList.remove('hidden');
        zeroSpan.classList.add('hidden');

        // Mettre √† jour le compteur
        countSpan.textContent = plaintesCount;

        // Trouver la plainte avec le MOINS de temps restant
        let criticalPlainte = plaintesActuellesData[0];
        let minTimeRemaining = calculateBusinessHoursRemaining(criticalPlainte.date_creation).hoursRemaining;

        for (let plainte of plaintesActuellesData) {
          const { hoursRemaining } = calculateBusinessHoursRemaining(plainte.date_creation);
          if (hoursRemaining < minTimeRemaining) {
            minTimeRemaining = hoursRemaining;
            criticalPlainte = plainte;
          }
        }

        // Afficher le cercle pour la plainte la plus critique
        badgeDiv.innerHTML = createCountdownCircleHTML(criticalPlainte.date_creation, 50);
      } else {
        // Afficher le "0" vert, cacher le badge et le compteur
        badgeDiv.classList.add('hidden');
        countSpan.classList.add('hidden');
        zeroSpan.classList.remove('hidden');
      }
    }


    // Charger les donn√©es des plaintes au d√©marrage uniquement
    // puis mettre √† jour le timer visuel chaque seconde (calcul local, pas d'API)
    (async function initPlaintesTimer() {
      if (window.username) {
        await loadPlaintesData();  // Chargement au d√©marrage seulement
      }
      updatePlainteTimer();
      setInterval(updatePlainteTimer, 1000);  // Timer visuel (pas d'API)
    })();

    // Initialiser le dashboard moderne
    updateCurrentDate();
    setupPeriodButtons();
    // initChart(); // D√©sactiv√© - remplac√© par le tableau de classement
    setupClassementDropdown();
    setupPeriodeDropdown();

    // Pour les entrepreneurs, charger les donn√©es du dashboard
    const userRole = localStorage.getItem('userRole');
    if (userRole !== 'coach') {
      log('[INIT] Entrepreneur d√©tect√© - Chargement des donn√©es pour:', window.username);
      setTimeout(async () => {
        if (window.username) {
          log('[INIT] Username disponible, chargement des donn√©es...');
          loadDashboardData();
          // Attendre que le dropdown de grade soit configur√© AVANT de charger le classement
          await setupEntrepreneurScopeDropdown();
          log('[INIT] setupEntrepreneurScopeDropdown termin√©, currentGroupFilter:', currentGroupFilter);
          // Charger le classement apr√®s les donn√©es du dashboard (attendre 2s pour que les variables window.* soient d√©finies)
          setTimeout(() => {
            log('[INIT] Chargement du classement avec filtre:', currentGroupFilter);
            loadClassementData();
          }, 2000);
        } else {
          error('[INIT] ERREUR - Username non d√©fini! localStorage username:', localStorage.getItem('username'));
        }
      }, 200);
    } else {
      log('[INIT] Coach d√©tect√© - Attente de la s√©lection d\'entrepreneur');
      setupEntrepreneurScopeDropdown();
    }
    // Pour les coaches, loadClassementData() sera appel√© par selectDashboardType() apr√®s l'initialisation
  });

  // ================================================================
  // CALENDRIER PERSONNALIS√â - FONCTIONS
  // ================================================================
  
  let currentCalendarType = null;
  let currentDate = new Date();
  let selectedStartDate = null;
  let selectedEndDate = null;
  
  // Noms des mois en fran√ßais
  const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
    'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
  
  // Fonction pour ouvrir/fermer un calendrier
  window.toggleCalendar = function(type) {
    const calendar = document.getElementById(type + 'Calendar');
    const otherCalendar = document.getElementById(type === 'start' ? 'endCalendar' : 'startCalendar');
    
    // Fermer l'autre calendrier
    if (otherCalendar && !otherCalendar.classList.contains('hidden')) {
      otherCalendar.classList.add('hidden');
    }
    
    if (calendar.classList.contains('hidden')) {
      currentCalendarType = type;
      calendar.classList.remove('hidden');
      renderCalendar(type);
    } else {
      calendar.classList.add('hidden');
      currentCalendarType = null;
    }
  };
  
  // Fonction pour changer de mois
  window.changeMonth = function(type, direction) {
    const calendar = type === 'start' ? new Date(currentDate) : new Date(currentDate);
    calendar.setMonth(calendar.getMonth() + direction);
    currentDate = calendar;
    renderCalendar(type);
  };
  
  // Fonction pour g√©n√©rer le calendrier
  function renderCalendar(type) {
    const calendarDays = document.getElementById(type + 'CalendarDays');
    const calendarTitle = document.getElementById(type + 'CalendarTitle');
    
    if (!calendarDays || !calendarTitle) return;
    
    // Mettre √† jour le titre
    calendarTitle.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
    
    // G√©n√©rer les jours
    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    const firstDayOfWeek = firstDay.getDay();
    const today = new Date();
    
    // Vider le calendrier
    calendarDays.innerHTML = '';
    
    // Ajouter les jours du mois pr√©c√©dent
    for (let i = firstDayOfWeek - 1; i >= 0; i--) {
      const prevDate = new Date(firstDay);
      prevDate.setDate(prevDate.getDate() - (i + 1));
      const dayElement = createDayElement(prevDate, true, type);
      calendarDays.appendChild(dayElement);
    }
    
    // Ajouter les jours du mois actuel
    for (let day = 1; day <= lastDay.getDate(); day++) {
      const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
      const dayElement = createDayElement(date, false, type);
      calendarDays.appendChild(dayElement);
    }
    
    // Ajouter les jours du mois suivant pour compl√©ter la grille
    const totalCells = calendarDays.children.length;
    const remainingCells = 42 - totalCells; // 6 semaines * 7 jours
    for (let day = 1; day <= remainingCells; day++) {
      const nextDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, day);
      const dayElement = createDayElement(nextDate, true, type);
      calendarDays.appendChild(dayElement);
    }
  }
  
  // Fonction pour cr√©er un √©l√©ment jour
  function createDayElement(date, isOtherMonth, type) {
    const dayElement = document.createElement('div');
    dayElement.className = 'dashboard-calendar-day';
    dayElement.textContent = date.getDate();
    
    if (isOtherMonth) {
      dayElement.classList.add('other-month');
    }
    
    // Marquer aujourd'hui
    const today = new Date();
    if (date.toDateString() === today.toDateString()) {
      dayElement.classList.add('today');
    }
    
    // Marquer les dates s√©lectionn√©es
    const currentInput = document.getElementById('modal' + (type === 'start' ? 'Start' : 'End') + 'Date');
    if (currentInput && currentInput.value) {
      const inputDate = parseDisplayDate(currentInput.value);
      if (inputDate && date.toDateString() === inputDate.toDateString()) {
        dayElement.classList.add('selected');
      }
    }
    
    // Ajouter l'√©v√©nement click
    dayElement.addEventListener('click', function() {
      selectDate(date, type);
    });
    
    return dayElement;
  }
  
  // Fonction pour s√©lectionner une date
  function selectDate(date, type) {
    const input = document.getElementById('modal' + (type === 'start' ? 'Start' : 'End') + 'Date');
    const formattedDate = date.toLocaleDateString('fr-FR');
    
    input.value = formattedDate;
    
    // Stocker la date pour la validation
    if (type === 'start') {
      selectedStartDate = date;
    } else {
      selectedEndDate = date;
    }
    
    // Fermer le calendrier
    document.getElementById(type + 'Calendar').classList.add('hidden');
    currentCalendarType = null;
    
    // Retirer la classe active des raccourcis et reset du tracking
    document.querySelectorAll('.dashboard-shortcut-btn').forEach(b => b.classList.remove('active'));
    lastSelectedShortcut = null; // Reset car l'utilisateur a s√©lectionn√© une date custom
    
    log(`[DATE] Date ${type} s√©lectionn√©e:`, formattedDate);
  }
  
  // Fonction pour parser une date d'affichage (format fran√ßais)
  function parseDisplayDate(dateStr) {
    if (!dateStr) return null;
    const parts = dateStr.split('/');
    if (parts.length === 3) {
      return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    return null;
  }
  
  // Fermer les calendriers en cliquant ailleurs
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.dashboard-calendar-container') && !e.target.closest('.dashboard-calendar')) {
      document.querySelectorAll('.dashboard-calendar').forEach(cal => {
        cal.classList.add('hidden');
      });
      currentCalendarType = null;
    }
  });

  // Script pour gestion menu actif - EXACT COPY de dashboard_user.html
  function activateCurrentPageMenu() {
    // D√©tecter la page actuelle
    const currentPath = window.location.pathname;
    log('üåê Page actuelle d√©tect√©e:', currentPath);
    
    // Enlever la classe menu-active de tous les liens
    const allMenuLinks = document.querySelectorAll('#sidebar a');
    allMenuLinks.forEach(link => {
      link.classList.remove('menu-active');
      link.removeAttribute('data-menu-state');
    });
    
    // Mapping des pages vers leurs data-path correspondants
    const pageMap = {
      '/dashboard': '/dashboard',
      '/centralevue': '/centralevue', 
      '/calcul': '/calcul',
      '/soumissions': '/soumissions',
      '/gqp': '/gqp',
      '/travaux': '/travaux',
      '/facture': '/facture',
      '/avis': '/avis',
      '/centrale': '/centrale',
      '/dashboardcoach': '/dashboardcoach'
    };
    
    // D√©terminer quel lien activer bas√© sur la page
    const targetPath = pageMap[currentPath];
    let targetLink = null;
    
    if (targetPath) {
      targetLink = document.querySelector(`#sidebar a[data-path="${targetPath}"]`);
      log('[TARGET] Page d√©tect√©e - activation du menu pour:', targetPath);
    }
    
    // Activer le lien correspondant
    if (targetLink) {
      targetLink.classList.add('menu-active');
      targetLink.setAttribute('data-menu-state', 'active');
      
      log('[OK] Menu activ√© pour:', targetLink.textContent.trim());
      log('[DEBUG] Classes actuelles:', targetLink.className);
    } else {
      log('[WARN] Aucun menu trouv√© pour la page:', currentPath);
    }
  }

  // S'assurer que le menu correct reste actif selon la page
  document.addEventListener('DOMContentLoaded', function() {
    activateCurrentPageMenu();

    // Re-activer apr√®s un d√©lai pour contrer les autres scripts
    setTimeout(activateCurrentPageMenu, 150);
    setTimeout(activateCurrentPageMenu, 300);
  });

  // √âcouter les messages de mise √† jour des plaintes (quand une plainte est r√©solue)
  window.addEventListener('message', async (event) => {
    if (event.data && event.data.type === 'plainte-resolved') {
      console.log('[DASHBOARD] Plainte r√©solue - mise √† jour du badge');
      // Recharger les donn√©es des plaintes
      await loadPlaintesData();
      // Mettre √† jour le badge
      const countSpan = document.getElementById('plaintesActuel');
      if (countSpan) {
        countSpan.textContent = plaintesActuellesData.length;
      }
    }
  });
</script>

  <!-- Footer -->
<footer class="hidden md:block md:ml-[15%] md:mr-[15%] w-100% text-center text-sm text-gray-500 mt-12 mb-4">
  <a href="/politique" class="hover:underline">Politique de confidentialit√©</a>
  &nbsp;|&nbsp;
  <a href="/conditions" class="hover:underline">Conditions d'utilisation</a>
  &nbsp;|&nbsp;
  <a href="/support" class="hover:underline">Support client</a>
  <br><br>
  <span>Propuls√© par <strong>Qwota</strong></span>
</footer>

<!-- Popup Modal pour S√©lecteur de Dates Personnalis√© -->
<div id="customDateModal" class="dashboard-modal hidden">
  <div class="dashboard-modal-overlay"></div>
  <div class="dashboard-modal-content">
    <!-- Header du Modal -->
    <div class="dashboard-modal-header">
      <h3 class="dashboard-modal-title">
        <i class="fas fa-calendar-alt mr-2"></i>
        S√©lectionner une p√©riode
      </h3>
      <button id="closeModal" class="dashboard-modal-close">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- Body du Modal -->
    <div class="dashboard-modal-body">
      <div class="dashboard-date-grid">
        <!-- Date de d√©but -->
        <div class="dashboard-date-section">
          <label class="dashboard-date-label">
            <i class="fas fa-play mr-1"></i>Date de d√©but
          </label>
          <div class="dashboard-date-wrapper">
            <div class="dashboard-calendar-container" id="startDateContainer">
              <input type="text" id="modalStartDate" class="dashboard-date-display" readonly placeholder="S√©lectionner une date">
              <i class="fas fa-calendar dashboard-date-icon" onclick="toggleCalendar('start')"></i>
              <div class="dashboard-calendar hidden" id="startCalendar">
                <div class="dashboard-calendar-header">
                  <button type="button" class="dashboard-calendar-nav" onclick="changeMonth('start', -1)">
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <span class="dashboard-calendar-title" id="startCalendarTitle">Mars 2024</span>
                  <button type="button" class="dashboard-calendar-nav" onclick="changeMonth('start', 1)">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
                <div class="dashboard-calendar-weekdays">
                  <span>Dim</span><span>Lun</span><span>Mar</span><span>Mer</span><span>Jeu</span><span>Ven</span><span>Sam</span>
                </div>
                <div class="dashboard-calendar-days" id="startCalendarDays"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Date de fin -->
        <div class="dashboard-date-section">
          <label class="dashboard-date-label">
            <i class="fas fa-stop mr-1"></i>Date de fin
          </label>
          <div class="dashboard-date-wrapper">
            <div class="dashboard-calendar-container" id="endDateContainer">
              <input type="text" id="modalEndDate" class="dashboard-date-display" readonly placeholder="S√©lectionner une date">
              <i class="fas fa-calendar dashboard-date-icon" onclick="toggleCalendar('end')"></i>
              <div class="dashboard-calendar hidden" id="endCalendar">
                <div class="dashboard-calendar-header">
                  <button type="button" class="dashboard-calendar-nav" onclick="changeMonth('end', -1)">
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <span class="dashboard-calendar-title" id="endCalendarTitle">Mars 2024</span>
                  <button type="button" class="dashboard-calendar-nav" onclick="changeMonth('end', 1)">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
                <div class="dashboard-calendar-weekdays">
                  <span>Dim</span><span>Lun</span><span>Mar</span><span>Mer</span><span>Jeu</span><span>Ven</span><span>Sam</span>
                </div>
                <div class="dashboard-calendar-days" id="endCalendarDays"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Raccourcis de dates -->
      <div class="dashboard-shortcuts">
        <h4 class="dashboard-shortcuts-title">Raccourcis rapides</h4>
        <div class="dashboard-shortcuts-grid">
          <button class="dashboard-shortcut-btn" data-days="7">
            <i class="fas fa-clock mr-1"></i>7 derniers jours
          </button>
          <button class="dashboard-shortcut-btn" data-days="30">
            <i class="fas fa-calendar-week mr-1"></i>30 derniers jours
          </button>
          <button class="dashboard-shortcut-btn" data-days="90">
            <i class="fas fa-calendar-check mr-1"></i>90 derniers jours
          </button>
          <button class="dashboard-shortcut-btn" id="thisYear">
            <i class="fas fa-calendar-days mr-1"></i>Cette ann√©e
          </button>
        </div>
      </div>
    </div>
    
    <!-- Footer du Modal -->
    <div class="dashboard-modal-footer">
      <button id="cancelModal" class="btn-secondary">
        <i class="fas fa-times mr-1"></i>Annuler
      </button>
      <button id="applyCustomDates" class="btn-primary">
        <i class="fas fa-check mr-1"></i>Appliquer
      </button>
    </div>
    </div>
  </div>
</div>

<!-- Modal S√©lection de P√©riodes par Semaines -->
<div id="weekSelectionModal" class="week-selection-modal hidden" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 10001; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
  <div class="week-selection-content" style="background: #1a2332; border-radius: 12px; width: 95%; max-width: 900px; max-height: 90vh; overflow: hidden; border: 2px solid var(--border-dark); box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);">
    <!-- Header -->
    <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-dark); display: flex; justify-content: space-between; align-items: center;">
      <h3 style="color: var(--text-light); font-size: 1.1rem; font-weight: 600; margin: 0;">
        <i class="fas fa-calendar-alt mr-2" style="color: #3b82f6;"></i>S√©lectionner une p√©riode
      </h3>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <span style="font-size: 0.75rem; color: var(--text-gray);"><span style="display: inline-block; width: 12px; height: 12px; background: rgba(249, 115, 22, 0.3); border: 1px solid #f97316; border-radius: 3px; margin-right: 4px;"></span>Semaine actuelle</span>
        <button id="closeWeekModal" style="background: none; border: none; color: var(--text-gray); cursor: pointer; font-size: 1.25rem; padding: 0.25rem;">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Instructions -->
    <div style="padding: 0.75rem 1.5rem; background: #0f172a; border-bottom: 1px solid var(--border-dark);">
      <p style="color: var(--text-gray); margin: 0; font-size: 0.8rem;">
        <i class="fas fa-info-circle mr-1" style="color: #3b82f6;"></i>
        Cliquez sur 1 semaine ou 2 semaines pour d√©finir une plage.
      </p>
      <div id="weekSelectionStatus" style="margin-top: 0.25rem; color: #10b981; font-weight: 600; font-size: 0.85rem; display: none;">
        <i class="fas fa-check-circle mr-1"></i><span id="weekSelectionStatusText"></span>
      </div>
    </div>

    <!-- Grille des semaines -->
    <div style="padding: 1rem; overflow-y: auto; max-height: 60vh;">
      <div id="weeksGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 0.4rem;">
        <!-- Les semaines seront charg√©es ici dynamiquement -->
        <div style="color: var(--text-gray); text-align: center; padding: 2rem; grid-column: 1 / -1;">
          <i class="fas fa-spinner fa-spin mr-2"></i>Chargement des p√©riodes...
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div style="padding: 0.75rem 1.5rem; border-top: 1px solid var(--border-dark); display: flex; gap: 0.75rem; justify-content: flex-end;">
      <button id="resetWeekSelection" style="padding: 0.5rem 1rem; background: #1e293b; color: var(--text-light); border: 1px solid var(--border-dark); border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.85rem;">
        <i class="fas fa-undo mr-1"></i>Toute l'ann√©e
      </button>
      <button id="cancelWeekSelection" style="padding: 0.5rem 1rem; background: #374151; color: var(--text-light); border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.85rem;">
        Annuler
      </button>
      <button id="applyWeekSelection" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
        <i class="fas fa-check mr-1"></i>Appliquer
      </button>
    </div>
  </div>
</div>

<style>
.week-selection-modal.hidden {
  display: none !important;
}
.week-selection-modal:not(.hidden) {
  display: flex !important;
}
.week-item {
  padding: 0.4rem 0.6rem;
  background: #0f172a;
  border: 1px solid var(--border-dark);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s ease;
  text-align: center;
}
.week-item:hover {
  border-color: #3b82f6;
  background: #1e293b;
}
.week-item.selected {
  border-color: #10b981;
  background: rgba(16, 185, 129, 0.2);
}
.week-item.in-range {
  border-color: #3b82f6;
  background: rgba(59, 130, 246, 0.15);
}
.week-item.current-week {
  border-color: #f97316;
  background: rgba(249, 115, 22, 0.15);
}
.week-item.current-week:hover {
  background: rgba(249, 115, 22, 0.25);
}
.week-item .week-label {
  color: var(--text-light);
  font-weight: 500;
  font-size: 0.75rem;
}
</style>

    </div>
    <!-- Fin du contenu entrepreneur -->

    </div>
  </div>

<script>
// ===== VARIABLES GLOBALES DASHBOARD COACH (Mon √âquipe) =====
let entrepreneursData = [];
let teamStats = {};
let coachUsername = '';
let charts = {};
let coachCurrentView = 'grid'; // 'grid' or 'ranking'

// Gestion du s√©lecteur de dashboard pour les coaches et direction
(function() {
  const userRole = localStorage.getItem('userRole');
  const isCoach = userRole === 'coach';
  const isDirection = userRole === 'direction';

  // Variable pour suivre le type de dashboard s√©lectionn√©
  // IMPORTANT: Ne d√©finir dashboardType QUE pour les coaches et direction!
  // Pour les entrepreneurs, laisser undefined pour charger leurs propres donn√©es
  if (isCoach || isDirection) {
    // V√©rifier si un type de dashboard est sp√©cifi√© dans l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const dashboardTypeParam = urlParams.get('dashboardType');
    // Pour direction: d√©faut = 'qualite-etudiants', pour coach: d√©faut = 'mon-equipe'
    const defaultType = isDirection ? 'qualite-etudiants' : 'mon-equipe';
    window.dashboardType = dashboardTypeParam || defaultType;
  }

  if (isCoach || isDirection) {
    document.body.classList.add('coach-mode');

    const selector = document.getElementById('coach-entrepreneur-selector');
    if (selector) {
      selector.classList.add('visible');
    }

    // Par d√©faut pour un coach : afficher le dashboard "Mon √âquipe" avec ses propres donn√©es
    // R√©cup√©rer le username du coach depuis localStorage ou cookies
    const currentUsername = localStorage.getItem('username') || window.username;
    if (currentUsername) {
      coachUsername = currentUsername;

      // Afficher le dashboard coach et cacher les autres
      const coachDevMessage = document.getElementById('coach-dev-message');
      const entrepreneurDashboardContent = document.getElementById('entrepreneur-dashboard-content');
      const coachDashboardContent = document.getElementById('coach-dashboard-content');

      if (coachDevMessage) {
        coachDevMessage.style.display = 'none';
      }
      if (entrepreneurDashboardContent) {
        entrepreneurDashboardContent.style.display = 'none';
      }
      if (coachDashboardContent) {
        coachDashboardContent.style.display = 'block';
      }

      // Charger les donn√©es du coach
      log('[DEBUG INIT COACH] Pr√©paration chargement pour coach:', currentUsername);
      log('[DEBUG INIT COACH] coachUsername global:', coachUsername);

      // S√©lectionner le type de dashboard (depuis URL ou par d√©faut "Mon √âquipe")
      setTimeout(() => {
        log('[DEBUG INIT COACH] setTimeout - D√©but chargement');
        log('[DEBUG INIT COACH] S√©lection du type de dashboard:', window.dashboardType);
        selectDashboardType(window.dashboardType);

        if (typeof loadCoaches === 'function') {
          log('[DEBUG INIT COACH] Appel loadCoaches()');
          loadCoaches();
        } else {
          error('[DEBUG INIT COACH] loadCoaches N\'EST PAS une fonction!');
        }
      }, 500);
    }

    // G√©rer le dropdown de type de dashboard
    const dashboardTypeToggle = document.getElementById('dashboard-type-toggle');
    const dashboardTypeMenu = document.getElementById('dashboard-type-menu');

    if (dashboardTypeToggle && dashboardTypeMenu) {
      // Cacher l'option "Mon √âquipe" pour la direction (ils n'ont pas d'√©quipe propre)
      if (isDirection) {
        const monEquipeOption = dashboardTypeMenu.querySelector('[data-type="mon-equipe"]');
        if (monEquipeOption) {
          monEquipeOption.style.display = 'none';
        }
      }

      // Ouvrir/fermer le dropdown de type
      dashboardTypeToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        this.classList.toggle('active');
        dashboardTypeMenu.classList.toggle('show');
      });

      // G√©rer le choix du type de dashboard
      dashboardTypeMenu.querySelectorAll('.coach-dropdown-option').forEach(option => {
        option.addEventListener('click', function(e) {
          e.stopPropagation();
          const type = this.getAttribute('data-type');
          selectDashboardType(type);
        });
      });

      // Fermer le dropdown en cliquant ailleurs
      document.addEventListener('click', function(e) {
        if (!dashboardTypeToggle.contains(e.target) && !dashboardTypeMenu.contains(e.target)) {
          dashboardTypeToggle.classList.remove('active');
          dashboardTypeMenu.classList.remove('show');
        }
      });
    }

    // G√©rer le dropdown de coach
    const coachSelectorToggle = document.getElementById('coach-selector-toggle');
    const coachSelectorMenu = document.getElementById('coach-selector-menu');

    if (coachSelectorToggle && coachSelectorMenu) {
      coachSelectorToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        this.classList.toggle('active');
        coachSelectorMenu.classList.toggle('show');
      });

      document.addEventListener('click', function(e) {
        if (!coachSelectorToggle.contains(e.target) && !coachSelectorMenu.contains(e.target)) {
          coachSelectorToggle.classList.remove('active');
          coachSelectorMenu.classList.remove('show');
        }
      });
    }

    // G√©rer le dropdown d'entrepreneur
    const dropdownToggle = document.getElementById('coach-dropdown-toggle');
    const dropdownMenu = document.getElementById('coach-dropdown-menu');
    const searchInput = document.getElementById('search-input');

    if (dropdownToggle && dropdownMenu) {
      dropdownToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        const isOpening = !this.classList.contains('active');

        this.classList.toggle('active');
        dropdownMenu.classList.toggle('show');

        const placeholderEl = dropdownToggle.querySelector('.placeholder, .selected-text');

        // When dropdown opens
        if (isOpening && searchInput) {
          // Hide placeholder, show search input
          if (placeholderEl) {
            placeholderEl.style.display = 'none';
          }
          searchInput.style.display = '';
          searchInput.style.removeProperty('display');
          searchInput.value = '';
          searchInput.focus();
        }
        // When dropdown closes
        else if (searchInput) {
          // Hide search input
          searchInput.style.display = 'none';
          searchInput.value = '';
          searchInput.blur();

          // Show placeholder or selected text
          if (placeholderEl) {
            placeholderEl.style.display = 'flex';
          }

          // Show all options again
          const allOptions = dropdownMenu.querySelectorAll('.coach-dropdown-option');
          allOptions.forEach(opt => opt.style.removeProperty('display'));

          // Hide "no results" message
          const noResultsMsg = dropdownMenu.querySelector('.no-results-message');
          if (noResultsMsg) {
            noResultsMsg.style.display = 'none';
          }
        }
      });

      // Search input filtering
      if (searchInput) {
        searchInput.addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase().trim();
          const allOptions = dropdownMenu.querySelectorAll('.coach-dropdown-option');
          let visibleCount = 0;

          allOptions.forEach(option => {
            const displayText = option.querySelector('span')?.textContent?.toLowerCase() || '';
            if (searchTerm === '' || displayText.includes(searchTerm)) {
              option.style.display = 'flex';
              visibleCount++;
            } else {
              option.style.display = 'none';
            }
          });

          // Show/hide "no results" message
          let noResultsMsg = dropdownMenu.querySelector('.no-results-message');

          if (visibleCount === 0 && searchTerm !== '') {
            if (!noResultsMsg) {
              noResultsMsg = document.createElement('div');
              noResultsMsg.className = 'coach-dropdown-option-disabled no-results-message';
              noResultsMsg.textContent = 'Aucun entrepreneur trouv√©...';
              dropdownMenu.appendChild(noResultsMsg);
            }
            noResultsMsg.style.display = 'block';
          } else if (noResultsMsg) {
            noResultsMsg.style.display = 'none';
          }
        });

        // Prevent dropdown from closing when clicking in search input
        searchInput.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      }

      document.addEventListener('click', function(e) {
        if (!dropdownToggle.contains(e.target) && !dropdownMenu.contains(e.target)) {
          dropdownToggle.classList.remove('active');
          dropdownMenu.classList.remove('show');

          if (searchInput) {
            // Hide search input
            searchInput.style.display = 'none';
            searchInput.value = '';
            searchInput.blur();

            // Show placeholder or selected text
            const placeholderEl = dropdownToggle.querySelector('.placeholder, .selected-text');
            if (placeholderEl) {
              placeholderEl.style.display = 'flex';
            }

            // Show all options again
            const allOptions = dropdownMenu.querySelectorAll('.coach-dropdown-option');
            allOptions.forEach(opt => opt.style.removeProperty('display'));

            // Hide "no results" message
            const noResultsMsg = dropdownMenu.querySelector('.no-results-message');
            if (noResultsMsg) {
              noResultsMsg.style.display = 'none';
            }
          }
        }
      });
    }

    // V√©rifier si on vient de "Mon √©quipe" avec un entrepreneur pr√©-s√©lectionn√©
    const viewEntrepreneurUsername = sessionStorage.getItem('viewEntrepreneurUsername');
    log('üîç V√©rification viewEntrepreneurUsername:', viewEntrepreneurUsername);
    log('üîç isCoach:', isCoach);
    log('üîç Tout le sessionStorage:', sessionStorage);

    if (viewEntrepreneurUsername) {
      log('üéØ Entrepreneur pr√©-s√©lectionn√© depuis Mon √âquipe:', viewEntrepreneurUsername);

      // S√©lectionner automatiquement "Dashboard par Entrepreneur"
      setTimeout(() => {
        log('‚è∞ Timeout 1: S√©lection du type dashboard entrepreneur');
        selectDashboardType('entrepreneur');

        // Attendre que les entrepreneurs soient charg√©s, puis s√©lectionner l'entrepreneur
        setTimeout(() => {
          log('‚è∞ Timeout 2: S√©lection de l\'entrepreneur', viewEntrepreneurUsername);
          selectEntrepreneur(viewEntrepreneurUsername);
          // Nettoyer le sessionStorage
          sessionStorage.removeItem('viewEntrepreneurUsername');
        }, 1000);
      }, 500);
    }
  }

  function selectDashboardType(type) {
    const dashboardTypeToggle = document.getElementById('dashboard-type-toggle');
    const dashboardTypeMenu = document.getElementById('dashboard-type-menu');
    const coachSelectorWrapper = document.getElementById('coach-selector-wrapper');
    const entrepreneurSelectorWrapper = document.getElementById('entrepreneur-selector-wrapper');
    const coachDevMessage = document.getElementById('coach-dev-message');
    const entrepreneurDashboardContent = document.getElementById('entrepreneur-dashboard-content');

    // R√©initialiser la vue du classement: cacher le classement et afficher la grille
    const entrepreneursContainer = document.getElementById('entrepreneursContainer');
    const coachClassementEntrepreneursContainer = document.getElementById('coachClassementContainer');
    const coachClassementCoachContainer = document.getElementById('coachClassementCoachContainer');
    if (entrepreneursContainer) {
      entrepreneursContainer.style.display = 'grid';
      // Afficher un spinner de chargement pendant la transition
      entrepreneursContainer.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner"></i></div>';
    }
    if (coachClassementEntrepreneursContainer) {
      coachClassementEntrepreneursContainer.style.display = 'none';
    }
    if (coachClassementCoachContainer) {
      coachClassementCoachContainer.style.display = 'none';
    }
    // R√©initialiser la variable de vue
    coachCurrentView = 'grid';

    // Mettre √† jour les titres pour indiquer que la vue grille est active
    const coachGridTitle = document.getElementById('coachGridTitle');
    const coachClassementEntrepreneursTitle = document.getElementById('coachClassementEntrepreneursTitle');
    const coachClassementCoachTitle = document.getElementById('coachClassementCoachTitle');
    const coachPersonnaliserBtn = document.getElementById('coachPersonnaliserBtn');
    if (coachGridTitle) {
      coachGridTitle.style.opacity = '1';
    }
    if (coachClassementEntrepreneursTitle) {
      coachClassementEntrepreneursTitle.style.opacity = '0.5';
    }
    if (coachClassementCoachTitle) {
      coachClassementCoachTitle.style.opacity = '0.5';
    }
    // Afficher le bouton personnaliser quand on revient √† la vue grille
    if (coachPersonnaliserBtn) {
      coachPersonnaliserBtn.style.display = 'flex';
    }

    // Configuration pour chaque type de dashboard
    const dashboardConfig = {
      'mon-equipe': {
        icon: 'fas fa-users-cog',
        label: 'Mon √âquipe',
        showCoachSelector: false,
        showEntrepreneurSelector: false,
        showDevMessage: false
      },
      'equipe': {
        icon: 'fas fa-users-cog',
        label: 'Dashboard par √âquipe',
        showCoachSelector: false,
        showEntrepreneurSelector: false,
        showDevMessage: true
      },
      'par-coach': {
        icon: 'fas fa-chalkboard-teacher',
        label: 'Dashboard par Coach',
        showCoachSelector: true,
        showEntrepreneurSelector: false,
        showDevMessage: false
      },
      'entrepreneur': {
        icon: 'fas fa-users',
        label: 'Dashboard par Entrepreneur',
        showCoachSelector: false,
        showEntrepreneurSelector: true,
        showDevMessage: false
      },
      'qualite-etudiants': {
        icon: 'fas fa-graduation-cap',
        label: 'Dashboard Qualit√© √âtudiants',
        showCoachSelector: false,
        showEntrepreneurSelector: false,
        showDevMessage: false
      }
    };

    const config = dashboardConfig[type];
    if (!config) return;

    // Mettre √† jour le toggle avec le bon label et ic√¥ne
    dashboardTypeToggle.innerHTML = `
      <span class="selected-text">
        <i class="${config.icon}"></i>
        ${config.label}
      </span>
      <i class="fas fa-chevron-down chevron"></i>
    `;

    window.dashboardType = type;

    // G√©rer l'affichage du s√©lecteur de coach
    if (coachSelectorWrapper) {
      if (config.showCoachSelector) {
        coachSelectorWrapper.style.display = 'flex';
        coachSelectorWrapper.style.alignItems = 'center';
        coachSelectorWrapper.style.gap = '1rem';

        // Charger la liste des coachs
        if (type === 'par-coach') {
          loadCoaches();
        }
      } else {
        coachSelectorWrapper.style.display = 'none';
      }
    }

    // G√©rer l'affichage du s√©lecteur d'entrepreneur
    if (entrepreneurSelectorWrapper) {
      if (config.showEntrepreneurSelector) {
        entrepreneurSelectorWrapper.style.display = 'flex';
        entrepreneurSelectorWrapper.style.alignItems = 'center';
        entrepreneurSelectorWrapper.style.gap = '1rem';

        // Charger les entrepreneurs si c'est le dashboard entrepreneur
        if (type === 'entrepreneur') {
          if (window.username) {
            loadEntrepreneursForCoach();
          } else {
            setTimeout(() => {
              if (window.username) {
                loadEntrepreneursForCoach();
              }
            }, 100);
          }
        }
      } else {
        entrepreneurSelectorWrapper.style.display = 'none';
      }
    }

    // G√©rer l'affichage du contenu
    const coachDashboardContent = document.getElementById('coach-dashboard-content');

    if (config.showDevMessage) {
      // Afficher le message "En d√©veloppement"
      if (coachDevMessage) {
        coachDevMessage.style.display = 'block';
      }
      if (entrepreneurDashboardContent) {
        entrepreneurDashboardContent.style.display = 'none';
      }
      if (coachDashboardContent) {
        coachDashboardContent.style.display = 'none';
      }
    } else if (type === 'mon-equipe' || type === 'par-coach' || type === 'qualite-etudiants') {
      // Afficher le dashboard coach (Mon √âquipe ou Qualit√© √âtudiants)
      log('[DEBUG selectDashboardType] Type:', type, '- Affichage dashboard coach');
      log('[DEBUG selectDashboardType] coachDashboardContent:', coachDashboardContent);
      log('[DEBUG selectDashboardType] Display AVANT:', coachDashboardContent ? coachDashboardContent.style.display : 'NULL');

      if (coachDevMessage) {
        coachDevMessage.style.display = 'none';
      }
      if (entrepreneurDashboardContent) {
        entrepreneurDashboardContent.style.display = 'none';
      }
      if (coachDashboardContent) {
        // Afficher le dashboard (styles padding et width d√©j√† dans le HTML)
        coachDashboardContent.style.display = 'block';

        log('[DEBUG selectDashboardType] Display APR√àS:', coachDashboardContent.style.display);

        // V√©rifier apr√®s un court d√©lai pour laisser le navigateur appliquer les styles
        setTimeout(() => {
          const styles = window.getComputedStyle(coachDashboardContent);
          log('[DEBUG APR√àS TIMEOUT] Computed display:', styles.display);
          log('[DEBUG APR√àS TIMEOUT] Computed padding:', styles.padding);
          log('[DEBUG APR√àS TIMEOUT] Computed width:', styles.width);
          log('[DEBUG APR√àS TIMEOUT] Computed minHeight:', styles.minHeight);
          log('[DEBUG APR√àS TIMEOUT] offsetHeight:', coachDashboardContent.offsetHeight);
          log('[DEBUG APR√àS TIMEOUT] offsetWidth:', coachDashboardContent.offsetWidth);
        }, 100);
      }

      // Mettre √† jour le titre, la couleur et le fond selon le type de dashboard
      const titleElement = document.getElementById('coach-dashboard-title');
      const accentElement = document.getElementById('coach-dashboard-accent');
      const bodyElement = document.body;

      if (titleElement && accentElement && bodyElement) {
        if (type === 'mon-equipe') {
          titleElement.textContent = 'Mon √âquipe';
          titleElement.style.color = '#3b82f6'; // Bleu
          accentElement.className = 'absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-blue-600 to-blue-400 rounded-full';
          // Fond bleu sur le body (couvre toute la page)
          bodyElement.style.background = 'linear-gradient(135deg, rgba(59, 130, 246, 0.12) 0%, rgba(59, 130, 246, 0.05) 40%, transparent 100%)';
          bodyElement.style.borderLeft = '6px solid rgba(59, 130, 246, 0.7)';
        } else if (type === 'qualite-etudiants') {
          titleElement.textContent = 'Dashboard Qualit√© √âtudiants';
          titleElement.style.color = '#10b981'; // Vert
          accentElement.className = 'absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-green-600 to-green-400 rounded-full';
          // Fond vert sur le body (couvre toute la page)
          bodyElement.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.12) 0%, rgba(16, 185, 129, 0.05) 40%, transparent 100%)';
          bodyElement.style.borderLeft = '6px solid rgba(16, 185, 129, 0.7)';
        } else if (type === 'par-coach') {
          const selectedCoach = window.selectedCoachFullName || window.selectedCoachUsername || 'Coach';
          titleElement.textContent = `Dashboard de ${selectedCoach}`;
          titleElement.style.color = '#f59e0b'; // Orange
          accentElement.className = 'absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-amber-600 to-amber-400 rounded-full';
          // Fond orange sur le body (couvre toute la page)
          bodyElement.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.12) 0%, rgba(245, 158, 11, 0.05) 40%, transparent 100%)';
          bodyElement.style.borderLeft = '6px solid rgba(245, 158, 11, 0.7)';
        }
      }

      // Charger les donn√©es pour "Mon √âquipe"
      if (type === 'mon-equipe') {
        log('[DEBUG selectDashboardType] Chargement donn√©es Mon √âquipe');
        // Utiliser le coach actuel (coach3)
        const currentUsername = localStorage.getItem('username') || window.username;
        log('[DEBUG selectDashboardType] currentUsername:', currentUsername);
        if (currentUsername) {
          coachUsername = currentUsername;
          if (typeof chargerEntrepreneurs === 'function') {
            log('[DEBUG selectDashboardType] Appel chargerEntrepreneurs()');
            chargerEntrepreneurs();
          } else {
            error('[DEBUG selectDashboardType] chargerEntrepreneurs non d√©fini!');
          }
        }
      }
      // Charger les donn√©es pour "Dashboard Qualit√© √âtudiants"
      else if (type === 'qualite-etudiants') {
        log('[DEBUG selectDashboardType] Chargement donn√©es Qualit√© √âtudiants (coaches)');
        if (typeof chargerCoaches === 'function') {
          log('[DEBUG selectDashboardType] Appel chargerCoaches()');
          chargerCoaches();
        } else {
          error('[DEBUG selectDashboardType] chargerCoaches non d√©fini!');
        }
      }
      // Pour 'par-coach': ne rien charger, attendre la s√©lection d'un coach
      else if (type === 'par-coach') {
        log('[DEBUG selectDashboardType] Dashboard par coach - en attente de s√©lection');

        // Cacher le dropdown scope (pas de choix d'√©quipe, on affiche l'√©quipe du coach s√©lectionn√©)
        const scopeSelect = document.getElementById('coachScopeSelect');
        if (scopeSelect) {
          scopeSelect.style.display = 'none';
        }

        // R√©initialiser le s√©lecteur de coach au placeholder
        const coachSelectorToggle = document.getElementById('coach-selector-toggle');
        if (coachSelectorToggle) {
          coachSelectorToggle.innerHTML = `
            <span class="placeholder">-- S√©lectionner un coach --</span>
            <i class="fas fa-chevron-down chevron"></i>
          `;
        }
        // Afficher le dashboard complet mais avec des donn√©es vides
        // R√©initialiser les donn√©es globales √† z√©ro
        teamStats = {
          total_ca: 0,
          objectif_total: 0,
          montant_produit: 0,
          pourcentage_objectif: 0,
          soumissions_signees: 0,
          total_signees: 0,
          total_en_attente: 0,
          total_perdus: 0,
          taux_vente_moyen: 0,
          estimation_moyenne: 0,
          heures_pap_semaine: 0,
          ca_moyen: 0,
          prod_horaire_moyen: 0,
          produit_mensuel: new Array(13).fill(0)
        };
        entrepreneursData = [];

        // Afficher le dashboard vide
        afficherStatsGlobales();
        afficherGraphiques();
        afficherEntrepreneurs();
      }
      // Pour 'entrepreneur': ne rien charger, attendre la s√©lection d'un entrepreneur
      else if (type === 'entrepreneur') {
        log('[DEBUG selectDashboardType] Dashboard entrepreneur - en attente de s√©lection');
        // R√©initialiser le s√©lecteur d'entrepreneur au placeholder
        const coachDropdownToggle = document.getElementById('coach-dropdown-toggle');
        if (coachDropdownToggle) {
          coachDropdownToggle.innerHTML = `
            <span class="placeholder">-- S√©lectionner un entrepreneur --</span>
            <i class="fas fa-chevron-down chevron"></i>
          `;
        }
        // Afficher le contenu entrepreneur
        if (coachDevMessage) {
          coachDevMessage.style.display = 'none';
        }
        if (entrepreneurDashboardContent) {
          entrepreneurDashboardContent.style.display = 'block';
        }
        if (coachDashboardContent) {
          coachDashboardContent.style.display = 'none';
        }

        // Afficher le dashboard avec des donn√©es vides (ne pas appeler loadDashboardData)
        // Le dashboard sera rempli uniquement quand un entrepreneur sera s√©lectionn√© via selectEntrepreneur()
      }
    } else {
      // Afficher le contenu entrepreneur (autres types)
      if (coachDevMessage) {
        coachDevMessage.style.display = 'none';
      }
      if (entrepreneurDashboardContent) {
        entrepreneurDashboardContent.style.display = 'block';
      }
      if (coachDashboardContent) {
        coachDashboardContent.style.display = 'none';
      }

      // Recharger les donn√©es si on affiche le contenu
      if (typeof loadDashboardData === 'function') {
        loadDashboardData();
      }
    }

    log(`${config.label} s√©lectionn√©`);

    // Recharger le classement avec les bonnes donn√©es selon le type de dashboard
    log('[DEBUG selectDashboardType] Rechargement du classement pour type:', type);
    log('[DEBUG selectDashboardType] window.dashboardType AVANT appel:', window.dashboardType);
    // Forcer un d√©lai pour s'assurer que window.dashboardType est bien mis √† jour
    setTimeout(() => {
      log('[DEBUG selectDashboardType setTimeout] window.dashboardType:', window.dashboardType);
      if (typeof window.loadClassementData === 'function') {
        window.loadClassementData();
      } else {
        error('[ERROR] window.loadClassementData non disponible');
      }
    }, 100);

    // Fermer le menu
    dashboardTypeToggle.classList.remove('active');
    dashboardTypeMenu.classList.remove('show');
  }

  // Rendre la fonction accessible globalement pour voirDashboard()
  window.selectDashboardType = selectDashboardType;

  function selectEntrepreneur(username, fullName) {
    const dropdownToggle = document.getElementById('coach-dropdown-toggle');
    const dropdownMenu = document.getElementById('coach-dropdown-menu');
    const displayName = fullName || username;

    if (dropdownToggle) {
      dropdownToggle.innerHTML = `
        <span class="selected-text">
          <i class="fas fa-user-circle"></i>
          ${displayName}
        </span>
        <i class="fas fa-chevron-down chevron"></i>
      `;

      dropdownToggle.classList.remove('active');
      if (dropdownMenu) {
        dropdownMenu.classList.remove('show');
      }

      window.username = username;
      window.selectedEntrepreneurFullName = displayName;

      // Mettre √† jour le titre du dashboard pour afficher le nom de l'entrepreneur
      const dashboardTitle = document.querySelector('.page-header h1');
      if (dashboardTitle && !dashboardTitle.id) {
        dashboardTitle.textContent = `Dashboard de ${displayName}`;
      }

      // Recharger les donn√©es du dashboard pour cet entrepreneur
      if (typeof loadDashboardData === 'function') {
        loadDashboardData();
      }

      // Rafra√Æchir le classement pour mettre √† jour la ligne "MOI" avec le nouvel entrepreneur
      if (typeof window.loadClassementData === 'function') {
        console.log('[SELECT ENTREPRENEUR] Rafra√Æchissement du classement pour', username);
        window.loadClassementData();
      }
    }
  }

  // Rendre la fonction accessible globalement pour voirDashboard()
  window.selectEntrepreneur = selectEntrepreneur;

  // Fonction pour charger la liste des coachs
  async function loadCoaches() {
    try {
      const response = await fetch('/api/users/coaches');
      const data = await response.json();

      const menu = document.getElementById('coach-selector-menu');
      const toggle = document.getElementById('coach-selector-toggle');
      if (!menu) return;

      menu.innerHTML = '';

      if (data.coaches && data.coaches.length > 0) {
        data.coaches.forEach(coach => {
          // Construire le nom complet du coach
          const fullName = [coach.prenom, coach.nom].filter(Boolean).join(' ') || coach.username;

          const option = document.createElement('div');
          option.className = 'coach-dropdown-option';
          option.innerHTML = `
            <i class="fas fa-chalkboard-teacher"></i>
            <span>${fullName}</span>
          `;
          option.onclick = () => selectCoach(coach.username, fullName);
          menu.appendChild(option);
        });
      } else {
        const option = document.createElement('div');
        option.className = 'coach-dropdown-option-disabled';
        option.textContent = 'Aucun coach trouv√©';
        menu.appendChild(option);
      }
    } catch (error) {
      error('Erreur chargement coachs:', error);
    }
  }

  // Fonction pour s√©lectionner un coach
  async function selectCoach(selectedCoachUsername, fullName) {
    const toggle = document.getElementById('coach-selector-toggle');
    const displayName = fullName || selectedCoachUsername;

    toggle.innerHTML = `
      <span class="selected-text">
        <i class="fas fa-chalkboard-teacher"></i>
        ${displayName}
      </span>
      <i class="fas fa-chevron-down chevron"></i>
    `;

    // Fermer le menu
    document.getElementById('coach-selector-menu').classList.remove('show');
    toggle.classList.remove('active');

    // Mettre √† jour le coachUsername global et charger les donn√©es
    coachUsername = selectedCoachUsername;
    window.selectedCoachUsername = selectedCoachUsername; // Pour le classement
    window.selectedCoachFullName = displayName; // Stocker le nom complet pour l'affichage
    log('Coach s√©lectionn√©:', coachUsername);

    // Mettre √† jour le titre du dashboard
    const titleElement = document.getElementById('coach-dashboard-title');
    if (titleElement) {
      titleElement.textContent = `Dashboard de ${displayName}`;
    }

    // Mettre √† jour le dropdown du classement coach pour afficher le bon nom
    if (typeof initCoachScopeDropdownText === 'function') {
      await initCoachScopeDropdownText();
    }

    // Charger les donn√©es du coach au lieu de rediriger
    // Passer false pour ne pas afficher le spinner (juste recharger les stats)
    if (typeof chargerEntrepreneurs === 'function') {
      chargerEntrepreneurs(false);
    } else {
      error('Fonction chargerEntrepreneurs non d√©finie');
    }

    // Recharger le classement entrepreneur (dashboard_user.html)
    if (typeof loadClassementData === 'function') {
      loadClassementData();
    }

    // Recharger le classement coach (section coach) avec la nouvelle √©quipe
    if (typeof renderCoachClassementCards === 'function') {
      renderCoachClassementCards();
    }
  }

  async function loadEntrepreneursForCoach() {
    try {
      // R√©cup√©rer le username du COACH depuis l'URL (pas window.username qui peut √™tre un entrepreneur)
      const urlParams = new URLSearchParams(window.location.search);
      const coachUsername = urlParams.get('user');

      // Pour la direction sans coach username, charger tous les entrepreneurs
      log('üîç Chargement de TOUS les entrepreneurs');
      const response = await fetch(`/api/entrepreneurs`);
      const entrepreneurs = await response.json();

      const menu = document.getElementById('coach-dropdown-menu');
      const toggle = document.getElementById('coach-dropdown-toggle');
      if (!menu) return;

      menu.innerHTML = '';

      if (entrepreneurs && entrepreneurs.length > 0) {
        entrepreneurs.forEach(entrepreneur => {
          // Construire le nom complet de l'entrepreneur
          const fullName = [entrepreneur.prenom, entrepreneur.nom].filter(Boolean).join(' ') || entrepreneur.username;

          const option = document.createElement('div');
          option.className = 'coach-dropdown-option';
          option.innerHTML = `
            <i class="fas fa-user-circle"></i>
            <span>${fullName}</span>
          `;
          option.onclick = () => selectEntrepreneur(entrepreneur.login_username, fullName);
          menu.appendChild(option);
        });

        // V√©rifier si un entrepreneur est pr√©-s√©lectionn√© depuis sessionStorage
        const viewEntrepreneurUsername = sessionStorage.getItem('viewEntrepreneurUsername');
        let entrepreneurToSelect = null;

        if (viewEntrepreneurUsername && entrepreneurs.some(e => e.login_username === viewEntrepreneurUsername)) {
          // Si on vient de "Mon √©quipe", s√©lectionner l'entrepreneur demand√©
          entrepreneurToSelect = viewEntrepreneurUsername;
          log('‚úÖ S√©lection depuis sessionStorage:', entrepreneurToSelect);

          // Trouver le nom complet de l'entrepreneur s√©lectionn√©
          const selectedEntrepreneur = entrepreneurs.find(e => e.login_username === entrepreneurToSelect);
          const selectedFullName = selectedEntrepreneur
            ? ([selectedEntrepreneur.prenom, selectedEntrepreneur.nom].filter(Boolean).join(' ') || selectedEntrepreneur.username)
            : entrepreneurToSelect;

          if (entrepreneurToSelect && toggle) {
            toggle.innerHTML = `
              <span class="selected-text">
                <i class="fas fa-user-circle"></i>
                ${selectedFullName}
              </span>
              <i class="fas fa-chevron-down chevron"></i>
            `;

            window.username = entrepreneurToSelect;
            window.selectedEntrepreneurFullName = selectedFullName;
            setTimeout(() => {
              if (typeof loadDashboardData === 'function') {
                loadDashboardData();
              }
            }, 500);
          }
        }
        // D√âSACTIV√â: Ne pas auto-s√©lectionner le premier entrepreneur
        // Laisser le placeholder "-- S√©lectionner un entrepreneur --"
      } else {
        const option = document.createElement('div');
        option.className = 'coach-dropdown-option-disabled';
        option.textContent = 'Aucun entrepreneur trouv√©';
        menu.appendChild(option);
      }
    } catch (error) {
      error('Erreur chargement entrepreneurs:', error);
    }
  }
})();

// ===== D√âBUT JAVASCRIPT DASHBOARD COACH (Mon √âquipe) =====

// Charger les coaches pour le Dashboard Qualit√© √âtudiants
async function chargerCoaches() {
  log('[DEBUG chargerCoaches] D√©but fonction - Dashboard Qualit√© √âtudiants');

  // ‚ö° SPINNER D√âSACTIV√â - Afficher le contenu directement
  const loadingSpinner = document.getElementById('coach-dashboard-loading');
  const mainContent = document.getElementById('coach-dashboard-main-content');
  // if (loadingSpinner) loadingSpinner.style.display = 'flex';
  // if (mainContent) mainContent.style.display = 'none';
  // Toujours afficher le contenu directement
  if (mainContent) {
    mainContent.style.display = 'block';
    mainContent.style.opacity = '1';
  }

  try {
    // Charger le RPO direction pour les donn√©es annual
    let directionRpoAnnual = null;
    try {
      const rpoResponse = await fetch('/api/rpo/direction');
      if (rpoResponse.ok) {
        const rpoData = await rpoResponse.json();
        directionRpoAnnual = rpoData?.annual || null;
        log('[DEBUG chargerCoaches] Direction RPO annual charg√©:', directionRpoAnnual);
      }
    } catch (e) {
      error('[WARN] Impossible de charger direction RPO:', e);
    }

    // Charger les coaches
    const coachesResponse = await fetch('/api/coaches');
    if (!coachesResponse.ok) {
      throw new Error(`Erreur HTTP coaches: ${coachesResponse.status}`);
    }
    const coachesData = await coachesResponse.json();
    log('[DEBUG chargerCoaches] Coaches charg√©s:', coachesData.length);

    // Utiliser directement les donn√©es de /api/coaches qui contiennent d√©j√† toutes les stats
    let coachesWithStats = [];
    let totalCA = 0;
    let totalObjectif = 0;
    let totalMontantProduit = 0;
    let totalSignees = 0;
    let totalContractReel = 0;  // Contrats avec premier paiement (syst√®me RPO)
    let totalEnAttente = 0;
    let totalPerdus = 0;
    let totalHeuresMarketingAbsolue = 0;  // Total absolu des heures marketing
    let totalHeuresPAPRecrue = 0;  // H PAP total recrues
    let totalHeuresPAPSenior = 0;  // H PAP total seniors
    let totalEstimationsRecrue = 0;  // Estimations total recrues
    let totalEstimationsSenior = 0;  // Estimations total seniors
    let totalRecrueCount = 0;
    let totalSeniorCount = 0;
    let totalEstimations = 0;
    let totalProdHoraire = 0;
    let totalTauxVente = 0;
    let totalContratMoyen = 0;
    let nbEntrepreneurs = 0;
    let produitMensuelAggrege = new Array(13).fill(0); // 13 mois

    for (const coach of coachesData) {
      try {
        const response = await fetch(`/api/coach/${coach.username}/equipe/dashboard?period=all`);
        if (response.ok) {
          const data = await response.json();
          const stats = data.team_stats || {};

          // Cr√©er un objet coach avec ses stats d'√©quipe agr√©g√©es
          const coachWithStats = {
            username: coach.username,
            prenom: coach.prenom || 'Coach',
            nom: coach.nom || coach.username,
            courriel: coach.email || '',
            telephone: coach.telephone || '',
            grade: coach.role || 'coach',
            photo: coach.photo || null,
            chiffre_affaires: {
              objectif: stats.objectif_total || 0,
              ca_actuel: stats.total_dollar_reel || 0,  // Utiliser dollar_reel (RPO) au lieu de total_ca
              dollar_reel: stats.total_dollar_reel || 0,  // Contrats avec premier paiement
              pourcentage: stats.pourcentage_objectif || 0,
              montant_produit: stats.montant_produit || 0
            },
            status_soumissions: {
              signees: stats.total_signees || 0,
              contract_reel: stats.total_contract_reel || 0,  // Contrats avec premier paiement
              en_attente: stats.total_en_attente || 0,
              perdus: stats.total_perdus || 0
            },
            satisfaction: {
              etoiles_moyennes: stats.moyenne_etoiles || 0,
              nombre_avis: stats.total_avis || 0
            },
            employes: {
              actifs: stats.total_employes_actifs || 0,
              candidats: stats.total_employes_candidats || 0,
              inactifs: stats.total_employes_inactifs || 0,
              total: (stats.total_employes_actifs || 0) + (stats.total_employes_candidats || 0) + (stats.total_employes_inactifs || 0)
            },
            metriques: {
              contrat_moyen: stats.contrat_moyen || 0,
              taux_vente: stats.taux_vente_moyen || 0,
              prod_horaire: stats.prod_horaire_moyen || 0,
              taux_marketing: stats.taux_marketing_moyen || 0,
              estimations: stats.total_nb_estimations || 0,  // Depuis RPO (estimation_reel) - source unique de v√©rit√©
              heures_pap_semaine: stats.heures_pap_semaine || 0,
              heures_pap: stats.total_heures_marketing_absolue || 0  // Total absolu
            }
          };

          coachesWithStats.push(coachWithStats);

          // Agr√©ger les stats globales (utiliser dollar_reel depuis RPO)
          totalCA += stats.total_dollar_reel || 0;
          totalObjectif += stats.objectif_total || 0;
          totalMontantProduit += stats.montant_produit || 0;
          totalSignees += stats.total_signees || 0;
          totalContractReel += stats.total_contract_reel || 0;  // Contrats avec premier paiement
          totalEnAttente += stats.total_en_attente || 0;
          totalPerdus += stats.total_perdus || 0;
          totalEstimations += stats.estimation_moyenne || 0;
          totalProdHoraire += stats.prod_horaire_moyen || 0;
          totalTauxVente += stats.taux_vente_moyen || 0;
          totalContratMoyen += stats.contrat_moyen || 0;
          totalHeuresMarketingAbsolue += stats.total_heures_marketing_absolue || 0;
          // Agr√©ger H PAP et Estimations par grade (pond√©r√© par le nombre d'entrepreneurs de chaque grade)
          const recrueCount = stats.recrue_count || 0;
          const seniorCount = stats.senior_count || 0;
          if (recrueCount > 0) {
            totalHeuresPAPRecrue += (stats.heures_pap_semaine_recrue || 0) * recrueCount;
            totalEstimationsRecrue += (stats.estimation_moyenne_recrue || 0) * recrueCount;
            totalRecrueCount += recrueCount;
          }
          if (seniorCount > 0) {
            totalHeuresPAPSenior += (stats.heures_pap_semaine_senior || 0) * seniorCount;
            totalEstimationsSenior += (stats.estimation_moyenne_senior || 0) * seniorCount;
            totalSeniorCount += seniorCount;
          }
          nbEntrepreneurs += data.entrepreneurs?.length || 0;

          // Agr√©ger produit_mensuel
          if (stats.produit_mensuel && Array.isArray(stats.produit_mensuel)) {
            stats.produit_mensuel.forEach((montant, index) => {
              produitMensuelAggrege[index] += (montant || 0);
            });
          }
        }
      } catch (e) {
        error(`[ERROR] Erreur chargement stats coach ${coach.username}:`, e);
      }
    }

    // IMPORTANT: Remplacer totalObjectif par la somme des pr√©visions de Direction
    // Au lieu d'additionner les objectifs individuels des coaches,
    // on utilise les pr√©visions que Direction a faites pour tous les coaches
    const directionUsername = localStorage.getItem('username') || window.username;
    try {
      const previsionsResponse = await fetch(`/api/direction/team-objectifs?direction_username=${encodeURIComponent(directionUsername)}`);
      if (previsionsResponse.ok) {
        const previsionsData = await previsionsResponse.json();
        if (previsionsData.success) {
          // Utiliser le total d√©j√† calcul√© par le backend
          totalObjectif = previsionsData.total || 0;
          log('[DEBUG OBJECTIF DIRECTION] Objectif depuis pr√©visions Direction:', totalObjectif, '| D√©tail:', previsionsData.previsions);
        }
      }
    } catch (e) {
      error('[ERROR] Erreur chargement pr√©visions Direction:', e);
      // Si erreur, garder la somme des objectifs individuels
    }

    // Afficher les coaches avec leurs stats d'√©quipe dans les cartes
    entrepreneursData = coachesWithStats;
    log('[DEBUG chargerCoaches] Total coaches charg√©s:', coachesWithStats.length);

    // Charger le total des paiements r√©colt√©s depuis l'API de facturation QE
    let totalPaiementsRecoltes = 0;
    try {
      const periodeResponse = await fetch('/api/comptable/facturation/periodes');
      if (periodeResponse.ok) {
        const periodeData = await periodeResponse.json();
        const periodes = periodeData.periodes || {};

        // Parcourir toutes les p√©riodes et compter tous les paiements trait√©s
        for (const [periodeId, paiements] of Object.entries(periodes)) {
          if (Array.isArray(paiements)) {
            paiements.forEach(paiement => {
              const montant = parseMontant(paiement.montant);
              totalPaiementsRecoltes += montant;
            });
          }
        }
      }
    } catch (e) {
      error('[ERROR] Erreur chargement paiements r√©colt√©s:', e);
    }

    // Calculer les moyennes
    // nb_estimations = total r√©partition des soumissions (contract_reel + en_attente + perdus = sign√©es + perdues)
    const nbEstimations = totalSignees + totalPerdus;
    // Taux de vente = contract_reel / nb_estimations * 100 (m√™me formule que entrepreneur)
    const tauxVenteGlobal = nbEstimations > 0 ? (totalContractReel / nbEstimations) * 100 : 0;

    // Calculer le nombre de semaines √©coul√©es depuis le 5 janvier 2026
    const startDate = new Date('2026-01-05');
    const currentDate = new Date();
    const daysSinceStart = Math.max(0, (currentDate - startDate) / (1000 * 60 * 60 * 24));
    const nombreSemainesEcoulees = Math.max(1, Math.floor(daysSinceStart / 7)); // Semaines compl√©t√©es, minimum 1

    // Taux marketing = utiliser les donn√©es du RPO direction annual (hr_pap_reel_sans_week1)
    // Fallback: calculer par estimation si RPO non disponible
    let tauxMarketingGlobal = 0;
    let heuresSansWeek1 = 0;
    if (directionRpoAnnual && directionRpoAnnual.hr_pap_reel_sans_week1 > 0) {
      // Utiliser les donn√©es pr√©calcul√©es du RPO direction
      heuresSansWeek1 = directionRpoAnnual.hr_pap_reel_sans_week1;
      tauxMarketingGlobal = directionRpoAnnual.mktg_reel || (nbEstimations / heuresSansWeek1);
      log('[DEBUG chargerCoaches] Taux marketing depuis RPO annual:', tauxMarketingGlobal, 'h_pap_sans_week1:', heuresSansWeek1);
    } else {
      // Fallback: estimation proportionnelle
      const nombreSemainesSansWeek1 = Math.max(1, nombreSemainesEcoulees - 1);
      heuresSansWeek1 = nombreSemainesEcoulees > 1
        ? totalHeuresMarketingAbsolue * nombreSemainesSansWeek1 / nombreSemainesEcoulees
        : totalHeuresMarketingAbsolue;
      tauxMarketingGlobal = heuresSansWeek1 > 0 ? nbEstimations / heuresSansWeek1 : 0;
      log('[DEBUG chargerCoaches] Taux marketing calcul√© (fallback):', tauxMarketingGlobal);
    }

    // Total estimations = sign√©es + perdues (d√©cisions prises, pas en_attente qui est un sous-ensemble de sign√©es)
    const totalEstimationsReelles = nbEstimations;

    teamStats = {
      total_ca: totalCA,
      objectif_total: totalObjectif,
      montant_produit: totalMontantProduit,
      pourcentage_objectif: totalObjectif > 0 ? (totalCA / totalObjectif * 100) : 0,
      soumissions_signees: totalSignees,
      total_signees: totalSignees,
      total_contract_reel: totalContractReel,  // Contrats avec premier paiement (syst√®me RPO)
      total_en_attente: totalEnAttente,
      total_perdus: totalPerdus,
      taux_vente_moyen: directionRpoAnnual?.vente_reel || 0,  // Utiliser vente_reel du RPO
      estimation_moyenne: nbEntrepreneurs > 0 ? totalEstimationsReelles / nbEntrepreneurs : 0,
      heures_pap_semaine: nombreSemainesEcoulees > 0 ? totalHeuresMarketingAbsolue / nombreSemainesEcoulees : 0,
      heures_pap_semaine_recrue: totalRecrueCount > 0 ? totalHeuresPAPRecrue / totalRecrueCount : 0,
      heures_pap_semaine_senior: totalSeniorCount > 0 ? totalHeuresPAPSenior / totalSeniorCount : 0,
      // Utiliser estimation par grade directement depuis RPO annual
      estimation_moyenne_recrue: (directionRpoAnnual?.nb_recrue || 0) > 0 ? (directionRpoAnnual?.estimation_reel_recrue || 0) / (directionRpoAnnual?.nb_recrue || 1) : 0,
      estimation_moyenne_senior: (directionRpoAnnual?.nb_senior || 0) > 0 ? (directionRpoAnnual?.estimation_reel_senior || 0) / (directionRpoAnnual?.nb_senior || 1) : 0,
      ca_moyen: directionRpoAnnual?.moyen_reel || 0,  // Utiliser moyen_reel du RPO
      prod_horaire_moyen: directionRpoAnnual?.prod_horaire || 0,  // Utiliser prod_horaire du RPO
      taux_marketing_moyen: directionRpoAnnual?.mktg_reel || 0,  // Utiliser mktg_reel du RPO
      produit_mensuel: produitMensuelAggrege,
      paiements_recoltes: totalPaiementsRecoltes
    };

    log('[DEBUG chargerCoaches] teamStats calcul√©:', teamStats);

    // Appeler les fonctions d'affichage
    afficherStatsGlobales();
    afficherGraphiques();
    afficherEntrepreneurs(); // Affichera les coaches

    // Cacher le spinner et afficher le contenu avec transition
    if (loadingSpinner) loadingSpinner.style.display = 'none';
    if (mainContent) {
      mainContent.style.display = 'block';
      // Petit d√©lai pour la transition CSS
      setTimeout(() => {
        if (mainContent) mainContent.style.opacity = '1';
      }, 50);
    }

  } catch (error) {
    console.error('[ERROR] chargerCoaches:', error);

    // Cacher le spinner m√™me en cas d'erreur
    if (loadingSpinner) loadingSpinner.style.display = 'none';
    if (mainContent) {
      mainContent.style.display = 'block';
      mainContent.style.opacity = '1';
    }
  }
}

// Charger les entrepreneurs du coach
async function chargerEntrepreneurs(showSpinner = true) {
  log('[DEBUG chargerEntrepreneurs] D√©but fonction, coachUsername:', coachUsername);

  // ‚ö° SPINNER D√âSACTIV√â - Afficher le contenu directement
  const loadingSpinner = document.getElementById('coach-dashboard-loading');
  const mainContent = document.getElementById('coach-dashboard-main-content');
  // if (showSpinner) {
  //   if (loadingSpinner) loadingSpinner.style.display = 'flex';
  //   if (mainContent) {
  //     mainContent.style.display = 'none';
  //     mainContent.style.opacity = '0';
  //   }
  // }
  // Toujours afficher le contenu directement
  if (mainContent) {
    mainContent.style.display = 'block';
    mainContent.style.opacity = '1';
  }

  try {
    // Charger le RPO du coach pour les donn√©es annual
    let coachRpoAnnual = null;
    try {
      const rpoResponse = await fetch(`/api/rpo/${coachUsername}`);
      if (rpoResponse.ok) {
        const rpoData = await rpoResponse.json();
        coachRpoAnnual = rpoData?.annual || null;
        log('[DEBUG chargerEntrepreneurs] Coach RPO annual charg√©:', coachRpoAnnual);
      }
    } catch (e) {
      error('[WARN] Impossible de charger coach RPO:', e);
    }

    const url = `/api/coach/${coachUsername}/equipe/dashboard?period=all`;
    log('[DEBUG chargerEntrepreneurs] Fetch URL:', url);

    const response = await fetch(url);
    log('[DEBUG chargerEntrepreneurs] Response status:', response.status, response.ok);

    if (!response.ok) {
      throw new Error('Erreur lors du chargement');
    }

    const data = await response.json();
    log('[DEBUG chargerEntrepreneurs] Data re√ßue:', data);

    entrepreneursData = data.entrepreneurs || [];
    teamStats = data.team_stats || {};

    // Utiliser les valeurs du RPO coach annual
    if (coachRpoAnnual) {
      teamStats.ca_moyen = coachRpoAnnual.moyen_reel || 0;
      teamStats.taux_vente_moyen = coachRpoAnnual.vente_reel || 0;
      teamStats.prod_horaire_moyen = coachRpoAnnual.prod_horaire || 0;
      teamStats.taux_marketing_moyen = coachRpoAnnual.mktg_reel || 0;

      // Utiliser estimation par grade directement depuis RPO annual
      const nbRecrue = coachRpoAnnual.nb_recrue || 0;
      const nbSenior = coachRpoAnnual.nb_senior || 0;
      const estimRecrue = coachRpoAnnual.estimation_reel_recrue || 0;
      const estimSenior = coachRpoAnnual.estimation_reel_senior || 0;

      // Moyenne = total estimations du grade / nombre d'entrepreneurs de ce grade
      if (nbRecrue > 0) {
        teamStats.estimation_moyenne_recrue = estimRecrue / nbRecrue;
      }
      if (nbSenior > 0) {
        teamStats.estimation_moyenne_senior = estimSenior / nbSenior;
      }

      log('[DEBUG chargerEntrepreneurs] Stats depuis RPO annual:', {
        ca_moyen: teamStats.ca_moyen,
        taux_vente: teamStats.taux_vente_moyen,
        prod_horaire: teamStats.prod_horaire_moyen,
        taux_mktg: teamStats.taux_marketing_moyen,
        estim_recrue: teamStats.estimation_moyenne_recrue,
        estim_senior: teamStats.estimation_moyenne_senior,
        nb_recrue: nbRecrue,
        nb_senior: nbSenior
      });
    }

    log('[DEBUG chargerEntrepreneurs] entrepreneursData:', entrepreneursData.length, 'items');
    log('[DEBUG chargerEntrepreneurs] teamStats:', teamStats);

    // Charger le total des paiements r√©colt√©s depuis l'API de facturation QE
    try {
      let totalPaiementsRecoltes = 0;

      // R√©cup√©rer les p√©riodes une seule fois
      const periodeResponse = await fetch('/api/comptable/facturation/periodes');
      if (periodeResponse.ok) {
        const periodeData = await periodeResponse.json();
        const periodes = periodeData.periodes || {};

        // Cr√©er un Set des usernames des entrepreneurs de l'√©quipe pour un filtrage efficace
        const teamUsernames = new Set(entrepreneursData.map(e => e.username));

        // Parcourir toutes les p√©riodes et filtrer les paiements de cette √©quipe
        for (const [periodeId, paiements] of Object.entries(periodes)) {
          if (Array.isArray(paiements)) {
            paiements.forEach(paiement => {
              if (teamUsernames.has(paiement.entrepreneurUsername)) {
                const montant = parseMontant(paiement.montant);
                totalPaiementsRecoltes += montant;
              }
            });
          }
        }
      }

      teamStats.paiements_recoltes = totalPaiementsRecoltes;
      log('[DEBUG chargerEntrepreneurs] Total paiements r√©colt√©s:', totalPaiementsRecoltes);
    } catch (error) {
      error('[ERROR] Erreur calcul paiements r√©colt√©s:', error);
      teamStats.paiements_recoltes = 0;
    }

    log('[DEBUG chargerEntrepreneurs] Appel afficherStatsGlobales()');
    afficherStatsGlobales();
    log('[DEBUG chargerEntrepreneurs] Appel afficherGraphiques()');
    afficherGraphiques();
    log('[DEBUG chargerEntrepreneurs] Appel afficherEntrepreneurs()');
    afficherEntrepreneurs();
    log('[DEBUG chargerEntrepreneurs] Toutes les fonctions d\'affichage termin√©es');

    // Cacher le spinner et afficher le contenu avec transition (seulement si showSpinner √©tait activ√©)
    if (showSpinner) {
      if (loadingSpinner) loadingSpinner.style.display = 'none';
      if (mainContent) {
        mainContent.style.display = 'block';
        // Petit d√©lai pour la transition CSS
        setTimeout(() => {
          mainContent.style.opacity = '1';
        }, 50);
      }
    }

  } catch (error) {
    console.error('[DEBUG chargerEntrepreneurs] ERREUR:', error);

    // Cacher le spinner m√™me en cas d'erreur (seulement si showSpinner √©tait activ√©)
    if (showSpinner) {
      if (loadingSpinner) loadingSpinner.style.display = 'none';
      if (mainContent) {
        mainContent.style.display = 'block';
        mainContent.style.opacity = '1';
      }
    }

    const container = document.getElementById('entrepreneursContainer');
    if (container) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <p>Erreur lors du chargement des donn√©es</p>
        </div>
      `;
    }
  }
}

// Afficher les stats globales
function afficherStatsGlobales() {
  log('[DEBUG afficherStatsGlobales] D√©but fonction');
  const grid = document.getElementById('statsGrid');
  const objectifContainer = document.getElementById('objectifProgressContainer');
  log('[DEBUG afficherStatsGlobales] statsGrid element:', grid);
  log('[DEBUG afficherStatsGlobales] objectifContainer element:', objectifContainer);
  if (!grid || !objectifContainer) {
    error('[DEBUG afficherStatsGlobales] statsGrid or objectifContainer NOT FOUND!');
    return;
  }

  // D√©terminer le texte selon le type de dashboard
  const isQualiteEtudiants = window.dashboardType === 'qualite-etudiants';
  const repartitionLabel = isQualiteEtudiants ? 'coach' : 'entrepreneur';

  // Calculer les pourcentages et valeurs AVANT les templates
  const montantProduit = teamStats.montant_produit || 0;
  const totalCA = teamStats.total_dollar_reel || teamStats.total_ca || 0;  // Pr√©f√©rer dollar_reel (RPO)
  const objectif = teamStats.objectif_total || 0;
  log('[DEBUG MON EQUIPE] teamStats.objectif_total:', teamStats.objectif_total, 'objectif:', objectif);
  const estimationMoyenne = teamStats.estimation_moyenne || 0;
  const estimationMoyenneRecrue = teamStats.estimation_moyenne_recrue || 0;
  const estimationMoyenneSenior = teamStats.estimation_moyenne_senior || 0;
  const heuresPAP = teamStats.heures_pap_semaine || 0;
  const heuresPAPRecrue = teamStats.heures_pap_semaine_recrue || 0;
  const heuresPAPSenior = teamStats.heures_pap_semaine_senior || 0;
  const caMoyen = teamStats.ca_moyen || 0;
  const tauxVente = teamStats.taux_vente_moyen || 0;
  const prodHoraire = teamStats.prod_horaire_moyen || 0;
  const tauxMarketing = teamStats.taux_marketing_moyen || 0;

  const pctObjectif = (teamStats.pourcentage_objectif || 0);
  const pctProduitSurObjectif = objectif > 0 ? (montantProduit / objectif * 100) : 0;
  const pctSigneSurObjectif = objectif > 0 ? (totalCA / objectif * 100) : 0;
  const pctProduitSurVendu = totalCA > 0 ? (montantProduit / totalCA * 100) : 0;
  const pctTauxVente = Math.min(tauxVente, 100);

  // BARRES DE PROGRESSION SIGN√â ET PRODUIT SUR OBJECTIF (au-dessus de tout)
  const objectifProgressBar = `
    <div class="fade-in-up" style="animation-delay: 0s; margin-bottom: 1.5rem;">
      <div style="
        padding: 1.25rem 1.5rem;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.6) 0%, rgba(30, 41, 59, 0.4) 100%);
        border-radius: 16px;
        border: 1px solid rgba(96, 165, 250, 0.3);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      ">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div style="
              width: 40px;
              height: 40px;
              border-radius: 10px;
              background: linear-gradient(135deg, #3b82f6, #60a5fa);
              display: flex;
              align-items: center;
              justify-content: center;
              box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
            ">
              <i class="fas fa-bullseye" style="color: white; font-size: 1.1rem;"></i>
            </div>
            <div>
              <div class="ca-label" style="font-size: 0.75rem; opacity: 0.8; margin-bottom: 0.15rem;">Objectif de production</div>
              <div style="font-size: 1rem; font-weight: 600; color: var(--text-light);">Sign√© et Produit vs objectif (${formatMontant(objectif)})</div>
            </div>
          </div>
        </div>

        <!-- Barre Sign√© -->
        <div style="margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.35rem;">
            <span style="font-size: 0.8rem; color: var(--text-light); font-weight: 500;"><i class="fas fa-file-signature" style="color: #10b981; margin-right: 0.5rem;"></i>Sign√©</span>
            <span style="font-size: 0.9rem; font-weight: 700; color: ${pctSigneSurObjectif >= 100 ? '#10b981' : '#10b981'};">${pctSigneSurObjectif.toFixed(1)}%</span>
          </div>
          <div style="position: relative;">
            <div style="background: rgba(15, 23, 42, 0.7); height: 12px; border-radius: 10px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);">
              <div style="
                height: 100%;
                width: ${Math.min(pctSigneSurObjectif, 100)}%;
                background: linear-gradient(90deg, #10b981, #34d399);
                border-radius: 10px;
                transition: width 1s ease-in-out;
                box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
                position: relative;
              ">
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, rgba(255, 255, 255, 0.2), transparent); border-radius: 10px;"></div>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 0.3rem; font-size: 0.7rem; opacity: 0.7;">
              <span>${formatMontant(totalCA)}</span>
              <span>${formatMontant(objectif)}</span>
            </div>
          </div>
        </div>

        <!-- Barre Produit -->
        <div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.35rem;">
            <span style="font-size: 0.8rem; color: var(--text-light); font-weight: 500;"><i class="fas fa-box" style="color: #f59e0b; margin-right: 0.5rem;"></i>Produit</span>
            <span style="font-size: 0.9rem; font-weight: 700; color: ${pctProduitSurObjectif >= 100 ? '#10b981' : '#f59e0b'};">${pctProduitSurObjectif.toFixed(1)}%</span>
          </div>
          <div style="position: relative;">
            <div style="background: rgba(15, 23, 42, 0.7); height: 12px; border-radius: 10px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);">
              <div style="
                height: 100%;
                width: ${Math.min(pctProduitSurObjectif, 100)}%;
                background: linear-gradient(90deg, #f59e0b, #fbbf24);
                border-radius: 10px;
                transition: width 1s ease-in-out;
                box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
                position: relative;
              ">
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, rgba(255, 255, 255, 0.2), transparent); border-radius: 10px;"></div>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 0.3rem; font-size: 0.7rem; opacity: 0.7;">
              <span>${formatMontant(montantProduit)}</span>
              <span>${formatMontant(objectif)}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

  // CARTE CA PRINCIPALE (gauche)
  const caCard = `
    <div class="ca-main-card fade-in-up" style="animation-delay: 0s;">
      <!-- Header -->
      <div class="ca-header">
        <div class="ca-title-section">
          <h2 class="ca-title">
            <i class="fas fa-dollar-sign"></i>
            Chiffre d'affaires de l'√©quipe
          </h2>
          <p class="ca-subtitle">Performance globale et r√©partition par entrepreneur</p>
        </div>
      </div>

      <!-- Montants principaux et taux de vente -->
      <div class="ca-amount-section" style="display: flex; gap: 2rem; align-items: center; margin-bottom: 1.5rem;">
        <div style="min-height: 70px; display: flex; flex-direction: column; justify-content: space-between; flex: 1;">
          <div class="ca-label" style="font-size: 0.85rem; margin-bottom: 0.5rem; height: 20px; display: flex; align-items: center;">Montant vendu</div>
          <div id="coach-montant-vendu" style="font-size: 1.75rem; font-weight: 700; background: linear-gradient(135deg, #10b981, #34d399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">0 $</div>
        </div>
        <div style="min-height: 70px; display: flex; flex-direction: column; justify-content: space-between; flex: 1;">
          <div class="ca-label" style="font-size: 0.85rem; margin-bottom: 0.5rem; height: 20px; display: flex; align-items: center;">Montant Produit</div>
          <div id="coach-montant-produit" style="font-size: 1.75rem; font-weight: 700; background: linear-gradient(135deg, #a855f7, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">0 $</div>
        </div>
        <div style="min-height: 70px; display: flex; flex-direction: column; justify-content: space-between; flex: 1;">
          <div class="ca-label" style="font-size: 0.85rem; margin-bottom: 0.5rem; height: 20px; display: flex; align-items: center;">Paiement R√©colt√©</div>
          <div id="coach-paiement-recolte" style="font-size: 1.75rem; font-weight: 700; background: linear-gradient(135deg, #3b82f6, #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">0 $</div>
        </div>
      </div>

      <!-- Graphique int√©gr√© -->
      <div class="ca-chart-section">
        <h3 class="ca-chart-title">
          <i class="fas fa-chart-bar"></i>
          R√©partition par ${repartitionLabel}
        </h3>
        <div class="ca-chart-container">
          <canvas id="caChartMain"></canvas>
        </div>
      </div>
    </div>
  `;

  // Cr√©er les stats avec le style original mais avec barre de progression pour % Produit / Vendu
  const statsWithProgress = [
    {
      icon: 'fa-dollar-sign',
      label: 'Contrat moyen',
      value: formatMontant(caMoyen),
      colorStart: '#60a5fa',
      colorEnd: '#3b82f6'
    },
    {
      icon: 'fa-chart-line',
      label: 'Prod. horaire moyen',
      value: formatMontant(prodHoraire) + '/h',
      colorStart: '#14b8a6',
      colorEnd: '#34d399'
    },
    {
      icon: 'fa-percentage',
      label: 'Taux de vente',
      value: tauxVente.toFixed(1) + '%',
      colorStart: '#f59e0b',
      colorEnd: '#f97316'
    },
    {
      icon: 'fa-bullhorn',
      label: 'Taux marketing',
      value: tauxMarketing.toFixed(2),
      colorStart: '#8b5cf6',
      colorEnd: '#a855f7'
    },
    {
      icon: 'fa-seedling',
      label: 'H PAP/sem Recrue',
      value: heuresPAPRecrue.toFixed(1) + ' h',
      colorStart: '#10b981',
      colorEnd: '#059669'
    },
    {
      icon: 'fa-star',
      label: 'H PAP/sem Senior',
      value: heuresPAPSenior.toFixed(1) + ' h',
      colorStart: '#f59e0b',
      colorEnd: '#d97706'
    },
    {
      icon: 'fa-seedling',
      label: 'Estim. moy. Recrue',
      value: estimationMoyenneRecrue.toFixed(1),
      colorStart: '#22c55e',
      colorEnd: '#16a34a'
    },
    {
      icon: 'fa-star',
      label: 'Estim. moy. Senior',
      value: estimationMoyenneSenior.toFixed(1),
      colorStart: '#eab308',
      colorEnd: '#ca8a04'
    }
  ];

  const rightSection = `
    <div class="stats-grid-right">
      <!-- Stats en grille 2x4 -->
      <div class="stats-top-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
        ${statsWithProgress.map((stat, index) => `
          <div class="stat-card fade-in-up" style="
            --card-color-start: ${stat.colorStart};
            --card-color-end: ${stat.colorEnd};
            animation-delay: ${(index + 1) * 0.05}s;
            ${stat.spanTwoColumns ? 'grid-column: span 2;' : ''}
          ">
            ${stat.showLabelsAbove ? `
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.25rem;">
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-sack-dollar" style="color: ${stat.colorEnd}; font-size: 1rem;"></i>
                    <span style="font-size: 0.85rem; font-weight: 600; color: var(--text-light);">$ Produit</span>
                  </div>
                  <div style="font-size: 1.1rem; font-weight: 700; color: ${stat.colorEnd};">${stat.montantProduitValue}</div>
                </div>
                <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-light);">${stat.value}</div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem;">
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 0.85rem; font-weight: 600; color: var(--text-light);">$ Vendu</span>
                    <i class="fas fa-dollar-sign" style="color: ${stat.colorStart}; font-size: 1rem;"></i>
                  </div>
                  <div style="font-size: 1.1rem; font-weight: 700; color: ${stat.colorStart};">${stat.montantVenduValue}</div>
                </div>
              </div>
            ` : `
              <div class="stat-header">
                ${stat.showCircle ? `
                  <div class="stat-icon" style="position: relative; width: 48px; height: 48px;">
                    <svg width="48" height="48" style="transform: rotate(-90deg); position: absolute; top: 0; left: 0;">
                      <defs>
                        <linearGradient id="gradient-circle-${index}" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" style="stop-color:${stat.colorStart}"/>
                          <stop offset="100%" style="stop-color:${stat.colorEnd}"/>
                        </linearGradient>
                      </defs>
                      <circle cx="24" cy="24" r="20" fill="none" stroke="rgba(251, 146, 60, 0.2)" stroke-width="4"/>
                      <circle cx="24" cy="24" r="20" fill="none" stroke="url(#gradient-circle-${index})" stroke-width="4"
                        stroke-dasharray="${(stat.circleValue / 100) * 126} 126"
                        stroke-linecap="round"
                        style="transition: stroke-dasharray 1s ease-in-out;"/>
                    </svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                      ${stat.showPercentInCircle ? `
                        <div style="font-size: 0.75rem; font-weight: 700; color: ${stat.colorStart};">${stat.circleValue.toFixed(0)}%</div>
                      ` : `
                        <i class="fas ${stat.icon}" style="font-size: 1rem; color: ${stat.colorStart};"></i>
                      `}
                    </div>
                  </div>
                ` : `
                  <div class="stat-icon">
                    <i class="fas ${stat.icon}"></i>
                  </div>
                `}
                <div class="stat-info">
                  <div class="stat-label">${stat.label}</div>
                  <div id="coach-stat-${index}" class="stat-value">0</div>
                </div>
              </div>
            `}
            ${stat.showProgressBar ? `
              <div style="margin-top: 0.75rem;">
                ${stat.showIconsInBar && !stat.showLabelsAbove ? `
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-dollar-sign" style="color: ${stat.colorStart}; font-size: 0.9rem;"></i>
                    <div style="flex: 1; background: rgba(15, 23, 42, 0.5); height: 8px; border-radius: 10px; overflow: hidden;">
                      <div style="
                        height: 100%;
                        width: ${Math.min(stat.progressValue, 100)}%;
                        background: linear-gradient(90deg, ${stat.colorStart}, ${stat.colorEnd});
                        border-radius: 10px;
                        transition: width 1s ease-in-out;
                        box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
                      "></div>
                    </div>
                    <i class="fas fa-sack-dollar" style="color: ${stat.colorEnd}; font-size: 0.9rem;"></i>
                  </div>
                ` : `
                  <div style="background: rgba(15, 23, 42, 0.5); height: 10px; border-radius: 10px; overflow: hidden;">
                    <div style="
                      height: 100%;
                      width: ${Math.min(stat.progressValue, 100)}%;
                      background: linear-gradient(90deg, ${stat.colorStart}, ${stat.colorEnd});
                      border-radius: 10px;
                      transition: width 1s ease-in-out;
                      box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
                    "></div>
                  </div>
                `}
              </div>
            ` : ''}
          </div>
        `).join('')}
      </div>

      <!-- Graphique Soumissions en bas -->
      <div class="soumissions-chart-right fade-in-up" style="animation-delay: 0.5s;">
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">
              <i class="fas fa-chart-pie"></i>
              R√©partition des soumissions
            </h3>
          </div>
          <div class="chart-container">
            <canvas id="soumissionsChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  `;

  // Ins√©rer la barre de progression dans son propre conteneur (pleine largeur)
  objectifContainer.innerHTML = objectifProgressBar;

  // Ins√©rer le reste dans le grid
  grid.innerHTML = caCard + rightSection;
  log('[DEBUG afficherStatsGlobales] HTML ins√©r√© dans objectifContainer et grid');
  log('[DEBUG afficherStatsGlobales] Premier enfant de grid:', grid.firstElementChild);

  // Animer les chiffres principaux
  setTimeout(() => {
    animateNumber('coach-montant-vendu', totalCA, false, true);
    animateNumber('coach-montant-produit', montantProduit, false, true);
    animateNumber('coach-paiement-recolte', teamStats.paiements_recoltes || 0, false, true);
    animateNumber('coach-taux-vente', tauxVente, true);

    // Animer les 8 stats de la grille
    animateNumber('coach-stat-0', caMoyen, false, true); // Contrat moyen
    animateNumberWithSuffix('coach-stat-1', prodHoraire, ' $/h'); // Prod. horaire
    animateNumberWithSuffix('coach-stat-2', tauxVente, '%', true); // Taux de vente
    animateNumber('coach-stat-3', tauxMarketing, false, false, true); // Taux marketing (ratio soumissions/heure)
    animateNumberWithSuffix('coach-stat-4', heuresPAPRecrue, ' h', true); // H PAP/sem Recrue
    animateNumberWithSuffix('coach-stat-5', heuresPAPSenior, ' h', true); // H PAP/sem Senior
    animateNumber('coach-stat-6', estimationMoyenneRecrue, false, false, true); // Estim. Recrue (1 d√©cimale)
    animateNumber('coach-stat-7', estimationMoyenneSenior, false, false, true); // Estim. Senior (1 d√©cimale)
  }, 50);

  // Cr√©er le graphique CA imm√©diatement apr√®s avoir ins√©r√© le HTML
  setTimeout(() => {
    creerGraphiqueCA();
  }, 100);
}

// Toggle between grid and ranking views for coach dashboard
// Afficher la vue grille
function showCoachGrid() {
  const gridContainer = document.getElementById('entrepreneursContainer');
  const classementEntrepreneursContainer = document.getElementById('coachClassementContainer');
  const classementCoachContainer = document.getElementById('coachClassementCoachContainer');
  const gridTitle = document.getElementById('coachGridTitle');
  const classementEntrepreneursTitle = document.getElementById('coachClassementEntrepreneursTitle');
  const classementCoachTitle = document.getElementById('coachClassementCoachTitle');
  const personnaliserBtn = document.getElementById('coachPersonnaliserBtn');

  gridContainer.style.display = 'grid';
  classementEntrepreneursContainer.style.display = 'none';
  classementCoachContainer.style.display = 'none';

  // Mettre en √©vidence le titre actif
  gridTitle.style.opacity = '1';
  classementEntrepreneursTitle.style.opacity = '0.5';
  classementCoachTitle.style.opacity = '0.5';

  // Afficher le bouton personnaliser
  personnaliserBtn.style.display = 'flex';

  coachCurrentView = 'grid';
}

// Afficher la vue classement entrepreneurs
async function showCoachClassement() {
  const gridContainer = document.getElementById('entrepreneursContainer');
  const classementEntrepreneursContainer = document.getElementById('coachClassementContainer');
  const classementCoachContainer = document.getElementById('coachClassementCoachContainer');
  const gridTitle = document.getElementById('coachGridTitle');
  const classementEntrepreneursTitle = document.getElementById('coachClassementEntrepreneursTitle');
  const classementCoachTitle = document.getElementById('coachClassementCoachTitle');
  const personnaliserBtn = document.getElementById('coachPersonnaliserBtn');

  gridContainer.style.display = 'none';
  classementEntrepreneursContainer.style.display = 'block';
  classementCoachContainer.style.display = 'none';

  // Mettre en √©vidence le titre actif
  gridTitle.style.opacity = '0.5';
  classementEntrepreneursTitle.style.opacity = '1';
  classementCoachTitle.style.opacity = '0.5';

  // Cacher le bouton personnaliser
  personnaliserBtn.style.display = 'none';

  coachCurrentView = 'ranking';

  // Initialiser le texte du dropdown selon le r√¥le (async)
  await initCoachScopeDropdownText();

  renderCoachClassementCards();
}

// Afficher la vue classement coach
function showCoachClassementCoach() {
  const gridContainer = document.getElementById('entrepreneursContainer');
  const classementEntrepreneursContainer = document.getElementById('coachClassementContainer');
  const classementCoachContainer = document.getElementById('coachClassementCoachContainer');
  const gridTitle = document.getElementById('coachGridTitle');
  const classementEntrepreneursTitle = document.getElementById('coachClassementEntrepreneursTitle');
  const classementCoachTitle = document.getElementById('coachClassementCoachTitle');
  const personnaliserBtn = document.getElementById('coachPersonnaliserBtn');

  // Cacher tous les conteneurs sauf le classement coach
  gridContainer.style.display = 'none';
  classementEntrepreneursContainer.style.display = 'none';
  classementCoachContainer.style.display = 'block';

  // Mettre en √©vidence le titre actif
  gridTitle.style.opacity = '0.5';
  classementEntrepreneursTitle.style.opacity = '0.5';
  classementCoachTitle.style.opacity = '1';

  // Cacher le bouton personnaliser
  personnaliserBtn.style.display = 'none';

  coachCurrentView = 'ranking-coach';

  // Charger les donn√©es du classement coach
  renderCoachClassementCoachCards();
}

// Initialiser le texte du dropdown de scope selon le r√¥le de l'utilisateur et le type de dashboard
async function initCoachScopeDropdownText() {
  const scopeSelect = document.getElementById('coachScopeSelect');
  const scopeBtnText = document.getElementById('coachScopeBtnText');
  const userRole = localStorage.getItem('userRole');
  const dashboardType = window.dashboardType;

  console.log('[INIT COACH SCOPE DROPDOWN] dashboardType:', dashboardType);

  // IMPORTANT: Recharger les options du dropdown selon le type de dashboard
  await loadCoachScopeOptions();

  // Afficher/masquer les options selon le type de dashboard
  const gradeOptions = document.querySelectorAll('.coach-scope-grade-option');
  const teamOptions = document.querySelectorAll('.coach-scope-team-option');

  // Si on est sur Dashboard Qualit√© √âtudiants, afficher les options de grade
  if (dashboardType === 'qualite-etudiants') {
    if (scopeSelect) scopeSelect.style.display = 'block';

    // Afficher les options de grade, cacher les options d'√©quipe
    gradeOptions.forEach(opt => opt.style.display = 'flex');
    teamOptions.forEach(opt => opt.style.display = 'none');

    if (scopeBtnText) {
      scopeBtnText.innerHTML = '<i class="fas fa-users mr-2"></i>Tous les entrepreneurs';
    }
    currentCoachScope = 'tous';
    currentCoachFilter = null;
  } else if (dashboardType === 'par-coach') {
    // Dashboard par coach sp√©cifique : PAS de dropdown, on affiche directement l'√©quipe du coach s√©lectionn√©
    // Pour voir tous les entrepreneurs, utiliser "Dashboard Qualit√© √âtudiants"
    if (scopeSelect) scopeSelect.style.display = 'none';

    currentCoachScope = 'coach';
    currentCoachFilter = window.selectedCoachUsername || null;
  } else if (userRole === 'coach' || userRole === 'direction') {
    // Pour les coachs/direction sur Mon √âquipe: afficher le dropdown et mettre "Mon √©quipe" par d√©faut
    if (scopeSelect) scopeSelect.style.display = 'block';

    // Afficher les options d'√©quipe, cacher les options de grade
    gradeOptions.forEach(opt => opt.style.display = 'none');
    teamOptions.forEach(opt => opt.style.display = 'flex');

    if (scopeBtnText) {
      scopeBtnText.innerHTML = '<i class="fas fa-user-friends mr-2"></i>Mon √©quipe';
    }
    currentCoachScope = 'equipe';
  } else {
    // Pour les entrepreneurs: cacher le dropdown et forcer "Tous les entrepreneurs"
    if (scopeSelect) scopeSelect.style.display = 'none';
    currentCoachScope = 'tous';
  }
}

// Variables globales pour le classement coach
let coachClassementData = [];
let currentCoachSortColumn = 'ca'; // Colonne de tri par d√©faut
// D√©finir le scope par d√©faut selon le r√¥le et la pr√©sence d'un coach username
const userRoleForScope = localStorage.getItem('userRole');
const urlParams = new URLSearchParams(window.location.search);
const hasCoachUsername = urlParams.get('user') !== null;
// Direction sans coach username ‚Üí 'tous', Coach avec username ‚Üí 'equipe', Entrepreneur ‚Üí 'tous'
let currentCoachScope = ((userRoleForScope === 'coach' || userRoleForScope === 'direction') && hasCoachUsername) ? 'equipe' : 'tous';
let currentCoachFilter = null; // Pour stocker le filtre actuel (coach username ou grade)
let currentCoachPeriode = 'annee'; // P√©riode actuelle
let currentCoachCustomDates = null; // {start: 'YYYY-MM-DD', end: 'YYYY-MM-DD'} pour p√©riode personnalis√©e
let coachDropdownsInitialized = false; // Flag pour √©viter d'initialiser les dropdowns plusieurs fois

// Fonction pour obtenir le param√®tre de p√©riode pour les API calls
function getCoachPeriodParam() {
  if (currentCoachPeriode === 'custom' && currentCoachCustomDates) {
    // Pour p√©riode personnalis√©e, retourner les dates de d√©but et fin
    return `start=${currentCoachCustomDates.start}&end=${currentCoachCustomDates.end}`;
  } else if (currentCoachPeriode === 'annee') {
    return 'period=all';
  } else if (currentCoachPeriode === 'semaine') {
    return 'period=week';
  } else {
    // Pour 90, 30, 14 jours
    return `period=${currentCoachPeriode}`;
  }
}

// Fonction pour v√©rifier si une date est dans la p√©riode s√©lectionn√©e
function isDateInPeriod(dateStr) {
  if (!dateStr) return false;
  if (currentCoachPeriode === 'annee') return true; // Toute l'ann√©e = pas de filtre

  const date = new Date(dateStr);
  const today = new Date();
  today.setHours(23, 59, 59, 999); // Fin de la journ√©e

  if (currentCoachPeriode === 'custom' && currentCoachCustomDates) {
    const startDate = new Date(currentCoachCustomDates.start);
    startDate.setHours(0, 0, 0, 0);
    const endDate = new Date(currentCoachCustomDates.end);
    endDate.setHours(23, 59, 59, 999);
    return date >= startDate && date <= endDate;
  } else if (currentCoachPeriode === 'semaine') {
    // Cette semaine (lundi √† dimanche)
    const monday = new Date(today);
    monday.setDate(today.getDate() - today.getDay() + 1);
    monday.setHours(0, 0, 0, 0);
    return date >= monday && date <= today;
  } else {
    // 90, 30, 14 jours
    const daysAgo = parseInt(currentCoachPeriode);
    const startDate = new Date(today);
    startDate.setDate(today.getDate() - daysAgo);
    startDate.setHours(0, 0, 0, 0);
    return date >= startDate && date <= today;
  }
}

// Fonction de tri pour le classement coach
function sortCoachClassement(sortBy) {
  const sortedData = [...coachClassementData].sort((a, b) => {
    switch(sortBy) {
      case 'ca': return (b.dollar_reel || 0) - (a.dollar_reel || 0);
      case 'signees': return (b.contract_reel || 0) - (a.contract_reel || 0);
      case 'estimations': {
        const totalA = a.nb_estimations || 0;
        const totalB = b.nb_estimations || 0;
        return totalB - totalA;
      }
      case 'etoiles': return (b.etoiles || 0) - (a.etoiles || 0);
      case 'contrat': return (b.contrat_moyen || 0) - (a.contrat_moyen || 0);
      case 'produit': return (b.montant_produit || 0) - (a.montant_produit || 0);
      case 'marketing': return (b.taux_marketing || 0) - (a.taux_marketing || 0);
      case 'prod': return (b.prod_horaire || 0) - (a.prod_horaire || 0);
      case 'pap': return (b.heures_pap || 0) - (a.heures_pap || 0);
      case 'tv': return (b.taux_vente || 0) - (a.taux_vente || 0);
      default: return 0;
    }
  });

  // Utiliser la fonction unifi√©e renderClassement() avec le contexte coach
  renderClassement(sortedData, {
    tbodyId: 'coachClassementTableBody',
    mobileCardsId: 'coachClassementMobileCards',
    context: 'coach'
  });
}

// Setup des √©v√©nements de tri pour le classement coach
function setupCoachClassementSorting() {
  const headers = document.querySelectorAll('#coachClassementTable .sortable-header');

  headers.forEach(header => {
    // Retirer les anciens listeners si existants en clonant l'√©l√©ment
    const newHeader = header.cloneNode(true);
    header.parentNode.replaceChild(newHeader, header);
  });

  // Re-s√©lectionner les headers apr√®s clonage
  const freshHeaders = document.querySelectorAll('#coachClassementTable .sortable-header');

  freshHeaders.forEach(header => {
    // √âv√©nement clic pour trier
    header.addEventListener('click', function() {
      const sortBy = this.getAttribute('data-sort');

      // Retirer active de tous les headers
      freshHeaders.forEach(h => h.classList.remove('active'));

      // Ajouter active au header cliqu√©
      this.classList.add('active');

      // Sauvegarder la colonne active
      currentCoachSortColumn = sortBy;

      // Trier le tableau (le rendu ajoutera automatiquement active-column aux bonnes cellules)
      sortCoachClassement(sortBy);
    });

    // √âv√©nement hover - mouseenter
    header.addEventListener('mouseenter', function() {
      const columnName = this.getAttribute('data-sort');
      // Ajouter hover-column au header
      this.classList.add('hover-column');
      // Ajouter hover-column √† toutes les cellules de cette colonne
      document.querySelectorAll(`#coachClassementTable td[data-column="${columnName}"]`).forEach(td => {
        td.classList.add('hover-column');
      });
    });

    // √âv√©nement hover - mouseleave
    header.addEventListener('mouseleave', function() {
      const columnName = this.getAttribute('data-sort');
      // Retirer hover-column du header
      this.classList.remove('hover-column');
      // Retirer hover-column de toutes les cellules de cette colonne
      document.querySelectorAll(`#coachClassementTable td[data-column="${columnName}"]`).forEach(td => {
        td.classList.remove('hover-column');
      });
    });
  });

  // Mettre √† jour les classes active sur les headers pour correspondre √† currentCoachSortColumn
  freshHeaders.forEach(h => {
    if (h.getAttribute('data-sort') === currentCoachSortColumn) {
      h.classList.add('active');
    } else {
      h.classList.remove('active');
    }
  });
}

// Charger les options du dropdown bas√©es sur le r√¥le
async function loadCoachScopeOptions() {
  const dropdown = document.getElementById('coachScopeDropdown');
  const userRole = localStorage.getItem('userRole');
  const dashboardType = window.dashboardType;

  console.log('[LOAD COACH SCOPE OPTIONS] Appel√©e avec dashboardType:', dashboardType, 'userRole:', userRole);

  if (!dropdown) return;

  // Pour Dashboard par Coach, pas de dropdown (on affiche l'√©quipe du coach s√©lectionn√© directement)
  if (dashboardType === 'par-coach') {
    console.log('[LOAD COACH SCOPE OPTIONS] Dashboard par Coach - dropdown cach√©');
    return;
  }

  let optionsHTML = '';

  // Pour Dashboard Qualit√© √âtudiants, afficher SEULEMENT les options de grade
  if (dashboardType === 'qualite-etudiants') {
    console.log('[LOAD COACH SCOPE OPTIONS] Dashboard Qualit√© √âtudiants - chargement options de grade');
    optionsHTML = `
      <div class="custom-select-option coach-scope-grade-option" data-scope="tous" style="display: flex;">
        <i class="fas fa-users mr-2"></i>Tous les entrepreneurs
      </div>
      <div class="custom-select-option coach-scope-grade-option" data-scope="grade" data-grade="recrue" style="padding-left: 2.5rem; display: flex;">
        <i class="fas fa-seedling mr-2"></i>Recrue
      </div>
      <div class="custom-select-option coach-scope-grade-option" data-scope="grade" data-grade="senior1" style="padding-left: 2.5rem; display: flex;">
        <i class="fas fa-star mr-2"></i>S√©nior 1
      </div>
      <div class="custom-select-option coach-scope-grade-option" data-scope="grade" data-grade="senior2" style="padding-left: 2.5rem; display: flex;">
        <i class="fas fa-star mr-2"></i>S√©nior 2
      </div>
      <div class="custom-select-option coach-scope-grade-option" data-scope="grade" data-grade="senior3" style="padding-left: 2.5rem; display: flex;">
        <i class="fas fa-star mr-2"></i>S√©nior 3
      </div>
    `;
    dropdown.innerHTML = optionsHTML;
    return;
  }

  if (userRole === 'direction') {
    console.log('[LOAD COACH SCOPE OPTIONS] Branche DIRECTION');
    // Pour la direction: charger toutes les √©quipes de coaches + filtres par grade
    try {
      const response = await fetch('/api/coaches/list');
      if (response.ok) {
        const coaches = await response.json();

        // Ajouter les √©quipes de chaque coach
        coaches.forEach(coach => {
          const coachName = coach.prenom && coach.nom
            ? `${coach.prenom} ${coach.nom}`
            : coach.username;
          optionsHTML += `<div class="custom-select-option" data-scope="coach" data-coach="${coach.username}">
            <i class="fas fa-user-tie mr-2"></i>√âquipe de ${coachName}
          </div>`;
        });

        // Ajouter un s√©parateur
        optionsHTML += `<div style="border-top: 1px solid var(--border-dark); margin: 0.5rem 0;"></div>`;
      }
    } catch (error) {
      error('Erreur chargement coaches:', error);
    }

    // Ajouter "Tous les entrepreneurs" avec sous-options
    optionsHTML += `
      <div class="custom-select-option" data-scope="tous">
        <i class="fas fa-users mr-2"></i>Tous les entrepreneurs
      </div>
      <div class="custom-select-option" data-scope="grade" data-grade="recrue" style="padding-left: 2.5rem;">
        <i class="fas fa-seedling mr-2"></i>Recrue
      </div>
      <div class="custom-select-option" data-scope="grade" data-grade="senior1" style="padding-left: 2.5rem;">
        <i class="fas fa-star mr-2"></i>S√©nior 1
      </div>
      <div class="custom-select-option" data-scope="grade" data-grade="senior2" style="padding-left: 2.5rem;">
        <i class="fas fa-star mr-2"></i>S√©nior 2
      </div>
      <div class="custom-select-option" data-scope="grade" data-grade="senior3" style="padding-left: 2.5rem;">
        <i class="fas fa-star mr-2"></i>S√©nior 3
      </div>
    `;
  } else if (userRole === 'coach') {
    console.log('[LOAD COACH SCOPE OPTIONS] Branche COACH');
    // Pour les coaches: seulement Mon √©quipe et Tous
    optionsHTML = `
      <div class="custom-select-option" data-scope="equipe">
        <i class="fas fa-user-friends mr-2"></i>Mon √©quipe
      </div>
      <div class="custom-select-option" data-scope="tous">
        <i class="fas fa-users mr-2"></i>Tous les entrepreneurs
      </div>
    `;
  } else {
    console.log('[LOAD COACH SCOPE OPTIONS] Branche AUTRE (userRole inconnu)');
  }

  console.log('[LOAD COACH SCOPE OPTIONS] HTML g√©n√©r√©, longueur:', optionsHTML.length);
  dropdown.innerHTML = optionsHTML;
}

// Setup du dropdown de scope (Mon √©quipe / Tous les entrepreneurs) pour le classement coach
async function setupCoachScopeDropdown() {
  const scopeSelect = document.getElementById('coachScopeSelect');
  const scopeBtn = document.getElementById('coachScopeBtn');
  const scopeBtnText = document.getElementById('coachScopeBtnText');

  if (!scopeSelect || !scopeBtn) return;

  // Charger les options dynamiquement
  await loadCoachScopeOptions();

  // Toggle dropdown avec la classe .open
  scopeBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    // Fermer le dropdown de p√©riode si ouvert
    const periodeSelect = document.getElementById('coachPeriodeSelect');
    if (periodeSelect) {
      periodeSelect.classList.remove('open');
    }
    scopeSelect.classList.toggle('open');
  });

  // Fermer dropdown si clic ailleurs
  document.addEventListener('click', function(e) {
    if (!scopeSelect.contains(e.target)) {
      scopeSelect.classList.remove('open');
    }
  });

  // D√©l√©gation d'√©v√©nements pour les options
  const dropdown = document.getElementById('coachScopeDropdown');
  dropdown.addEventListener('click', function(e) {
    const option = e.target.closest('.custom-select-option');
    if (!option) return;

    const scope = option.getAttribute('data-scope');
    const coach = option.getAttribute('data-coach');
    const grade = option.getAttribute('data-grade');

    // Mettre √† jour le texte du bouton
    scopeBtnText.innerHTML = option.innerHTML;

    // Fermer le dropdown
    scopeSelect.classList.remove('open');

    // Sauvegarder le scope actuel
    currentCoachScope = scope;
    currentCoachFilter = coach || grade || null;

    // Recharger les donn√©es avec le nouveau scope
    renderCoachClassementCards();
  });
}

// ===== CLASSE CALENDRIER PERSONNALIS√â =====
class CoachCustomCalendar {
  constructor(elementId, onDateSelect) {
    this.element = document.getElementById(elementId);
    this.onDateSelect = onDateSelect;
    this.currentDate = new Date();
    this.selectedDate = null;
    this.monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                       'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
    this.dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
    this.render();
  }

  render() {
    const year = this.currentDate.getFullYear();
    const month = this.currentDate.getMonth();

    this.element.innerHTML = `
      <div class="calendar-header">
        <button type="button" class="calendar-nav-btn prev-btn">‚Äπ</button>
        <div class="calendar-month-year">${this.monthNames[month]} ${year}</div>
        <button type="button" class="calendar-nav-btn next-btn">‚Ä∫</button>
      </div>
      <div class="calendar-grid">
        ${this.renderDayHeaders()}
        ${this.renderDays()}
      </div>
    `;

    // Event listeners pour navigation
    this.element.querySelector('.prev-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      this.previousMonth();
    });

    this.element.querySelector('.next-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      this.nextMonth();
    });

    // Event listeners pour s√©lection de date
    this.element.querySelectorAll('.calendar-day:not(.other-month)').forEach(day => {
      day.addEventListener('click', (e) => {
        e.stopPropagation();
        const dayNum = parseInt(day.textContent);
        if (!isNaN(dayNum)) {
          this.selectDate(dayNum);
        }
      });
    });
  }

  renderDayHeaders() {
    return this.dayNames.map(day =>
      `<div class="calendar-day-header">${day}</div>`
    ).join('');
  }

  renderDays() {
    const year = this.currentDate.getFullYear();
    const month = this.currentDate.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();

    let html = '';
    const today = new Date();
    const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

    // Jours du mois pr√©c√©dent
    for (let i = firstDay - 1; i >= 0; i--) {
      const day = daysInPrevMonth - i;
      html += `<div class="calendar-day other-month">${day}</div>`;
    }

    // Jours du mois actuel
    for (let day = 1; day <= daysInMonth; day++) {
      const isToday = isCurrentMonth && day === today.getDate();
      const isSelected = this.selectedDate &&
                         this.selectedDate.getDate() === day &&
                         this.selectedDate.getMonth() === month &&
                         this.selectedDate.getFullYear() === year;

      let classes = 'calendar-day';
      if (isToday) classes += ' today';
      if (isSelected) classes += ' selected';

      html += `<div class="${classes}">${day}</div>`;
    }

    // Jours du mois suivant pour compl√©ter la grille
    const totalCells = firstDay + daysInMonth;
    const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for (let day = 1; day <= remainingCells; day++) {
      html += `<div class="calendar-day other-month">${day}</div>`;
    }

    return html;
  }

  selectDate(day) {
    this.selectedDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), day);
    this.render();
    if (this.onDateSelect) {
      this.onDateSelect(this.selectedDate);
    }
  }

  previousMonth() {
    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
    this.render();
  }

  nextMonth() {
    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
    this.render();
  }

  setDate(date) {
    if (date) {
      this.selectedDate = new Date(date);
      this.currentDate = new Date(date);
      this.render();
    }
  }

  getDate() {
    return this.selectedDate;
  }
}
// ===== FIN CLASSE CALENDRIER PERSONNALIS√â =====

// Setup du dropdown de p√©riode pour le classement coach
let startCalendar = null;
let endCalendar = null;

function setupCoachPeriodeDropdown() {
  const periodeSelect = document.getElementById('coachPeriodeSelect');
  const periodeBtn = document.getElementById('coachPeriodeBtn');
  const periodeBtnText = document.getElementById('coachPeriodeBtnText');
  const customDatePicker = document.getElementById('coachCustomDatePicker');
  const applyBtn = document.getElementById('coachApplyCustomDate');
  const cancelBtn = document.getElementById('coachCancelCustomDate');

  if (!periodeSelect || !periodeBtn) return;

  // Initialiser les calendriers personnalis√©s
  if (!startCalendar) {
    startCalendar = new CoachCustomCalendar('coachStartCalendar', () => {});
    endCalendar = new CoachCustomCalendar('coachEndCalendar', () => {});
  }

  // Toggle dropdown avec la classe .open
  periodeBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    // Fermer le dropdown de scope si ouvert
    const scopeSelect = document.getElementById('coachScopeSelect');
    if (scopeSelect) {
      scopeSelect.classList.remove('open');
    }
    // Fermer le date picker si ouvert
    if (customDatePicker) {
      customDatePicker.classList.add('hidden');
    }
    periodeSelect.classList.toggle('open');
  });

  // Fermer dropdown si clic ailleurs
  document.addEventListener('click', function(e) {
    if (!periodeSelect.contains(e.target) && !customDatePicker.contains(e.target)) {
      periodeSelect.classList.remove('open');
      if (customDatePicker) {
        customDatePicker.classList.add('hidden');
      }
    }
  });

  // D√©l√©gation d'√©v√©nements pour les options
  const dropdown = document.getElementById('coachPeriodeDropdown');
  dropdown.addEventListener('click', function(e) {
    const option = e.target.closest('.custom-select-option');
    if (!option) return;

    const periode = option.getAttribute('data-periode');

    if (periode === 'custom') {
      // Ouvrir le s√©lecteur de dates personnalis√©
      periodeSelect.classList.remove('open');
      customDatePicker.classList.remove('hidden');

      // D√©finir les dates par d√©faut (30 derniers jours)
      const today = new Date();
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);

      // Initialiser les calendriers avec les dates par d√©faut
      startCalendar.setDate(thirtyDaysAgo);
      endCalendar.setDate(today);
    } else {
      // P√©riode pr√©d√©finie
      const textes = {
        'annee': '<i class="fas fa-calendar mr-2"></i>Toute l\'ann√©e',
        '90': '<i class="fas fa-calendar-week mr-2"></i>90 derniers jours',
        '30': '<i class="fas fa-calendar-day mr-2"></i>30 derniers jours',
        '14': '<i class="fas fa-calendar-day mr-2"></i>14 derniers jours',
        'semaine': '<i class="fas fa-calendar-week mr-2"></i>Cette semaine'
      };
      periodeBtnText.innerHTML = textes[periode];

      // Fermer le dropdown
      periodeSelect.classList.remove('open');

      // Sauvegarder la p√©riode actuelle
      currentCoachPeriode = periode;
      currentCoachCustomDates = null; // R√©initialiser les dates personnalis√©es

      // Recharger les donn√©es avec la nouvelle p√©riode
      renderCoachClassementCards();
    }
  });

  // Bouton Appliquer pour les dates personnalis√©es
  if (applyBtn) {
    applyBtn.addEventListener('click', function() {
      const startDate = startCalendar.getDate();
      const endDate = endCalendar.getDate();

      if (!startDate || !endDate) {
        alert('Veuillez s√©lectionner une date de d√©but et de fin');
        return;
      }

      if (startDate > endDate) {
        alert('La date de d√©but doit √™tre ant√©rieure √† la date de fin');
        return;
      }

      // Formater les dates
      const startStr = startDate.toISOString().split('T')[0];
      const endStr = endDate.toISOString().split('T')[0];

      // Mettre √† jour le texte du bouton
      periodeBtnText.innerHTML = `<i class="fas fa-calendar-alt mr-2"></i>${startStr} au ${endStr}`;

      // Sauvegarder les dates personnalis√©es
      currentCoachPeriode = 'custom';
      currentCoachCustomDates = { start: startStr, end: endStr };

      // Fermer le s√©lecteur
      customDatePicker.classList.add('hidden');

      // Recharger les donn√©es
      renderCoachClassementCards();
    });
  }

  // Bouton Annuler
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function() {
      customDatePicker.classList.add('hidden');
    });
  }
}

// ===== WEEK SELECTION MODAL =====
let availableWeeks = [];
let selectedWeeks = []; // Max 2 semaines s√©lectionn√©es
let weekModalContext = 'entrepreneur'; // 'entrepreneur' ou 'coach' - pour savoir quel classement mettre √† jour

async function loadAvailableWeeks() {
  console.log('[WEEK MODAL] Chargement des semaines disponibles...');
  try {
    const response = await fetch('/api/rpo/available-weeks');
    console.log('[WEEK MODAL] Response status:', response.status);
    const data = await response.json();
    console.log('[WEEK MODAL] Data received:', data);
    availableWeeks = data.weeks || [];
    console.log('[WEEK MODAL] Semaines charg√©es:', availableWeeks.length);
    renderWeeksGrid();
  } catch (error) {
    console.error('[WEEK MODAL] Erreur chargement semaines:', error);
    document.getElementById('weeksGrid').innerHTML = `
      <div style="color: #ef4444; text-align: center; padding: 2rem; grid-column: 1 / -1;">
        <i class="fas fa-exclamation-triangle mr-2"></i>Erreur de chargement des p√©riodes: ${error.message}
      </div>
    `;
  }
}

function renderWeeksGrid() {
  console.log('[WEEK MODAL] Rendering weeks grid...');
  const grid = document.getElementById('weeksGrid');
  console.log('[WEEK MODAL] Grid element:', !!grid, 'Weeks count:', availableWeeks.length);
  if (!grid) {
    console.error('[WEEK MODAL] Grid element not found!');
    return;
  }
  if (availableWeeks.length === 0) {
    console.log('[WEEK MODAL] No weeks to display');
    grid.innerHTML = `
      <div style="color: var(--text-gray); text-align: center; padding: 2rem; grid-column: 1 / -1;">
        <i class="fas fa-info-circle mr-2"></i>Aucune p√©riode disponible
      </div>
    `;
    return;
  }

  // Grouper par mois
  const months = ['Janv', 'F√©vr', 'Mars', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sept', 'Oct', 'Nov', 'D√©c'];
  let html = '';

  // Cr√©er une map des mois avec leurs semaines
  const weeksByMonth = {};
  availableWeeks.forEach(week => {
    if (!weeksByMonth[week.month_index]) {
      weeksByMonth[week.month_index] = [];
    }
    weeksByMonth[week.month_index].push(week);
  });

  // G√©n√©rer le HTML par mois
  Object.keys(weeksByMonth).sort((a, b) => parseInt(a) - parseInt(b)).forEach(monthIndex => {
    const monthWeeks = weeksByMonth[monthIndex];
    const monthName = months[parseInt(monthIndex)];

    html += `<div style="grid-column: 1 / -1; margin-top: 0.5rem; margin-bottom: 0.25rem; padding-bottom: 0.25rem; border-bottom: 1px solid var(--border-dark);">
      <span style="color: #3b82f6; font-weight: 600; font-size: 0.8rem;">${monthName} 2026</span>
    </div>`;

    monthWeeks.forEach(week => {
      const isSelected = selectedWeeks.some(sw => sw.start === week.start && sw.end === week.end);
      const isInRange = isWeekInRange(week);
      const isCurrent = week.is_current;
      let classes = 'week-item';
      if (isSelected) classes += ' selected';
      else if (isInRange) classes += ' in-range';
      if (isCurrent) classes += ' current-week';

      html += `<div class="${classes}" data-start="${week.start}" data-end="${week.end}" data-label="${week.week_label}" onclick="toggleWeekSelection(this)">
          <div class="week-label">${week.week_label}</div>
        </div>`;
    });
  });

  grid.innerHTML = html;
  updateSelectionStatus();
}

function formatDateShort(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString('fr-CA', { day: 'numeric', month: 'short' });
}

function isWeekInRange(week) {
  if (selectedWeeks.length !== 2) return false;

  const weekStart = new Date(week.start);
  const rangeStart = new Date(Math.min(new Date(selectedWeeks[0].start), new Date(selectedWeeks[1].start)));
  const rangeEnd = new Date(Math.max(new Date(selectedWeeks[0].end), new Date(selectedWeeks[1].end)));

  return weekStart >= rangeStart && weekStart <= rangeEnd;
}

function toggleWeekSelection(element) {
  const start = element.getAttribute('data-start');
  const end = element.getAttribute('data-end');
  const label = element.getAttribute('data-label');

  // V√©rifier si cette semaine est d√©j√† s√©lectionn√©e
  const existingIndex = selectedWeeks.findIndex(sw => sw.start === start && sw.end === end);

  if (existingIndex !== -1) {
    // D√©s√©lectionner
    selectedWeeks.splice(existingIndex, 1);
  } else if (selectedWeeks.length < 2) {
    // Ajouter (max 2)
    selectedWeeks.push({ start, end, label });
  } else {
    // Remplacer la DEUXI√àME s√©lection (garder la premi√®re)
    selectedWeeks[1] = { start, end, label };
  }

  // Mettre √† jour l'affichage
  renderWeeksGrid();
}

function updateSelectionStatus() {
  const statusDiv = document.getElementById('weekSelectionStatus');
  const statusText = document.getElementById('weekSelectionStatusText');

  if (selectedWeeks.length === 0) {
    statusDiv.style.display = 'none';
  } else if (selectedWeeks.length === 1) {
    statusDiv.style.display = 'block';
    statusText.textContent = `Semaine s√©lectionn√©e: ${selectedWeeks[0].label}`;
  } else {
    statusDiv.style.display = 'block';
    // Trier par date
    const sorted = [...selectedWeeks].sort((a, b) => new Date(a.start) - new Date(b.start));
    statusText.textContent = `P√©riode: ${sorted[0].label} ‚Üí ${sorted[1].label}`;
  }
}

function openWeekSelectionModal(context = 'entrepreneur') {
  console.log('[WEEK MODAL] Ouverture du modal pour:', context);
  weekModalContext = context;
  const modal = document.getElementById('weekSelectionModal');
  if (!modal) {
    console.error('[WEEK MODAL] Modal non trouv√©!');
    return;
  }

  selectedWeeks = []; // R√©initialiser la s√©lection
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden'; // Bloquer le scroll arri√®re-plan
  console.log('[WEEK MODAL] Modal ouvert, chargement des semaines...');
  loadAvailableWeeks();
}

function closeWeekSelectionModal() {
  const modal = document.getElementById('weekSelectionModal');
  if (modal) {
    modal.classList.add('hidden');
    document.body.style.overflow = ''; // Restaurer le scroll
  }
}

function applyWeekSelection() {
  // D√©terminer quel bouton et quelles variables mettre √† jour selon le contexte
  const isCoachClassement = weekModalContext === 'coach';
  const periodeBtnText = document.getElementById(isCoachClassement ? 'coachClassementCoachPeriodeBtnText' : 'coachPeriodeBtnText');

  let labelText = '';
  let periode = 'annee';
  let customDates = null;

  if (selectedWeeks.length === 0) {
    // Toute l'ann√©e
    labelText = '<i class="fas fa-calendar-alt mr-2"></i>Toute l\'ann√©e';
    periode = 'annee';
    customDates = null;
  } else if (selectedWeeks.length === 1) {
    // Une seule semaine
    labelText = `<i class="fas fa-calendar-alt mr-2"></i>${selectedWeeks[0].label}`;
    periode = 'custom';
    customDates = {
      start: selectedWeeks[0].start,
      end: selectedWeeks[0].end
    };
  } else {
    // Plage de semaines
    const sorted = [...selectedWeeks].sort((a, b) => new Date(a.start) - new Date(b.start));
    labelText = `<i class="fas fa-calendar-alt mr-2"></i>${sorted[0].label} ‚Üí ${sorted[1].label}`;
    periode = 'custom';
    customDates = {
      start: sorted[0].start,
      end: sorted[1].end
    };
  }

  // Mettre √† jour le bouton
  if (periodeBtnText) {
    periodeBtnText.innerHTML = labelText;
  }

  // Mettre √† jour les variables selon le contexte
  if (isCoachClassement) {
    currentCoachClassementCoachPeriode = periode;
    currentCoachClassementCoachCustomDates = customDates;
  } else {
    currentCoachPeriode = periode;
    currentCoachCustomDates = customDates;
  }

  closeWeekSelectionModal();

  // Recharger les donn√©es selon le contexte
  if (isCoachClassement) {
    renderCoachClassementCoachCards();
  } else {
    renderCoachClassementCards();
  }
}

function resetWeekSelection() {
  selectedWeeks = [];

  const isCoachClassement = weekModalContext === 'coach';
  const periodeBtnText = document.getElementById(isCoachClassement ? 'coachClassementCoachPeriodeBtnText' : 'coachPeriodeBtnText');

  if (periodeBtnText) {
    periodeBtnText.innerHTML = '<i class="fas fa-calendar-alt mr-2"></i>Toute l\'ann√©e';
  }

  if (isCoachClassement) {
    currentCoachClassementCoachPeriode = 'annee';
    currentCoachClassementCoachCustomDates = null;
  } else {
    currentCoachPeriode = 'annee';
    currentCoachCustomDates = null;
  }

  closeWeekSelectionModal();

  if (isCoachClassement) {
    renderCoachClassementCoachCards();
  } else {
    renderCoachClassementCards();
  }
}

// Initialiser les event listeners du modal de s√©lection de semaines
function setupWeekSelectionModal() {
  console.log('[WEEK MODAL] Setup du modal de s√©lection de semaines...');

  // Bouton pour ouvrir le modal - Classement Entrepreneur
  const periodeBtn = document.getElementById('coachPeriodeBtn');
  console.log('[WEEK MODAL] Bouton p√©riode entrepreneur trouv√©:', !!periodeBtn);
  if (periodeBtn) {
    periodeBtn.replaceWith(periodeBtn.cloneNode(true));
    const newBtn = document.getElementById('coachPeriodeBtn');
    newBtn.addEventListener('click', function(e) {
      console.log('[WEEK MODAL] Bouton entrepreneur cliqu√©!');
      e.stopPropagation();
      openWeekSelectionModal('entrepreneur');
    });
  }

  // Bouton pour ouvrir le modal - Classement Coach
  const periodeBtnCoach = document.getElementById('coachClassementCoachPeriodeBtn');
  console.log('[WEEK MODAL] Bouton p√©riode coach trouv√©:', !!periodeBtnCoach);
  if (periodeBtnCoach) {
    periodeBtnCoach.replaceWith(periodeBtnCoach.cloneNode(true));
    const newBtnCoach = document.getElementById('coachClassementCoachPeriodeBtn');
    newBtnCoach.addEventListener('click', function(e) {
      console.log('[WEEK MODAL] Bouton coach cliqu√©!');
      e.stopPropagation();
      openWeekSelectionModal('coach');
    });
  }

  // Bouton fermer
  const closeBtn = document.getElementById('closeWeekModal');
  if (closeBtn) {
    closeBtn.addEventListener('click', closeWeekSelectionModal);
  }

  // Bouton annuler
  const cancelBtn = document.getElementById('cancelWeekSelection');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', closeWeekSelectionModal);
  }

  // Bouton appliquer
  const applyBtn = document.getElementById('applyWeekSelection');
  if (applyBtn) {
    applyBtn.addEventListener('click', applyWeekSelection);
  }

  // Bouton reset (toute l'ann√©e)
  const resetBtn = document.getElementById('resetWeekSelection');
  if (resetBtn) {
    resetBtn.addEventListener('click', resetWeekSelection);
  }

  // Fermer en cliquant en dehors
  const modal = document.getElementById('weekSelectionModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeWeekSelectionModal();
      }
    });
  }
}

// ===== CLASSEMENT COACH FUNCTIONS =====

// Variables globales pour le classement coach
let coachClassementCoachData = [];
let coachClassementCoachDropdownsInitialized = false;
let currentCoachClassementCoachPeriode = 'annee';
let currentCoachClassementCoachCustomDates = null; // {start: 'YYYY-MM-DD', end: 'YYYY-MM-DD'}
// Initialiser avec des dates par d√©faut (d√©but et fin de l'ann√©e en cours)
const today = new Date();
let coachClassementCoachStartDate = new Date(today.getFullYear(), 0, 1); // 1er janvier
let coachClassementCoachEndDate = new Date(today.getFullYear(), 11, 31); // 31 d√©cembre
let currentCoachClassementCoachSortColumn = 'ca'; // Colonne de tri par d√©faut

// Fonction pour obtenir le param√®tre de p√©riode pour le classement coach
function getCoachClassementCoachPeriodParam() {
  if (currentCoachClassementCoachPeriode === 'custom' && currentCoachClassementCoachCustomDates) {
    return `start=${currentCoachClassementCoachCustomDates.start}&end=${currentCoachClassementCoachCustomDates.end}`;
  } else if (currentCoachClassementCoachPeriode === 'annee') {
    return 'period=all';
  } else if (currentCoachClassementCoachPeriode === 'semaine') {
    return 'period=week';
  } else {
    // Pour 90, 30, 14 jours
    return `period=${currentCoachClassementCoachPeriode}`;
  }
}

// Fonction principale pour charger et afficher le classement des coachs
async function renderCoachClassementCoachCards() {
  log(`üîç Chargement du classement coach - P√©riode: ${currentCoachClassementCoachPeriode}`);

  try {
    // R√©cup√©rer tous les coachs avec leurs stats d√©j√† calcul√©es par le backend
    const periodParam = getCoachClassementCoachPeriodParam();
    const response = await fetch(`/api/coaches?${periodParam}`);
    if (!response.ok) {
      throw new Error(`Erreur API: ${response.status}`);
    }
    const allCoachs = await response.json();
    log(`üìä ${allCoachs.length} coachs trouv√©s`);

    // Mapper les donn√©es du backend vers le format IDENTIQUE √† entrepreneur
    const coachsWithStats = allCoachs.map(coach => {
      // Cr√©er le nom complet du coach
      const nomComplet = coach.prenom && coach.nom
        ? `${coach.prenom} ${coach.nom}`
        : (coach.prenom || coach.nom || coach.username);

      // Format identique √† entrepreneur (m√™mes champs)
      return {
        username: nomComplet,
        login_username: coach.username,
        prenom: coach.prenom,
        nom: coach.nom,
        // Donn√©es cumul√©es (identiques √† entrepreneur)
        dollar_reel: coach.dollar_reel || 0,
        contract_reel: coach.contract_reel || 0,
        heures_pap: coach.heures_pap || coach.hr_pap_reel || 0,
        montant_produit: coach.montant_produit || coach.produit_reel || 0,
        // Soumissions cumul√©es (pour nb_estimations = sign√©es + perdues)
        soumissions_signees: coach.soumissions_signees || 0,
        soumissions_perdues: coach.soumissions_perdues || 0,
        // Nb estimations depuis l'API (estimation_reel du RPO)
        nb_estimations: coach.nb_estimations || coach.estimation_reel || ((coach.soumissions_signees || 0) + (coach.soumissions_perdues || 0)),
        // M√©triques calcul√©es
        contrat_moyen: coach.contrat_moyen || 0,
        taux_vente: coach.taux_vente || 0,
        taux_marketing: coach.taux_marketing || 0,
        prod_horaire: coach.prod_horaire || 0,
        // Satisfaction
        etoiles: coach.etoiles || 0,
        nombre_avis: coach.satisfactions || 0,
      };
    });

    // Filtrer les coachs invalides
    const validCoachs = coachsWithStats.filter(c => c !== null);

    // Trier par CA d√©croissant (dollar_reel comme entrepreneur)
    const sortedData = validCoachs.sort((a, b) => {
      const caA = a.dollar_reel || 0;
      const caB = b.dollar_reel || 0;
      return caB - caA;
    });

    // Sauvegarder les donn√©es pour le tri
    coachClassementCoachData = sortedData;

    log(`‚úÖ ${sortedData.length} coachs avec stats calcul√©es`);

    // Utiliser la fonction unifi√©e renderClassement() avec le contexte coach-ranking
    await renderClassement(sortedData, {
      tbodyId: 'coachClassementCoachTableBody',
      mobileCardsId: 'coachClassementCoachMobileCards',
      context: 'coach-ranking'
    });

    // Setup des √©v√©nements de tri
    setupCoachClassementCoachSorting();

    // Setup des dropdowns (une seule fois)
    if (!coachClassementCoachDropdownsInitialized) {
      setupCoachClassementCoachPeriodeDropdown();
      setupWeekSelectionModal(); // Configurer aussi le modal pour classement coach
      coachClassementCoachDropdownsInitialized = true;
    }

  } catch (error) {
    error('‚ùå Erreur chargement classement coach:', error);
    const coachTableBody = document.getElementById('coachClassementCoachTableBody');
    if (coachTableBody) {
      coachTableBody.innerHTML = `
        <tr>
          <td colspan="12" class="text-center py-8" style="color: var(--text-gray);">
            <i class="fas fa-exclamation-triangle mr-2"></i>Erreur de chargement des donn√©es
          </td>
        </tr>
      `;
    }
  }
}

// Configuration du tri pour le classement coach
function setupCoachClassementCoachSorting() {
  const headers = document.querySelectorAll('#coachClassementCoachTable .sortable-header');

  headers.forEach(header => {
    header.addEventListener('click', function() {
      const sortKey = this.getAttribute('data-sort');

      // Mettre √† jour la colonne de tri actuelle
      currentCoachClassementCoachSortColumn = sortKey;

      // Retirer la classe active de tous les headers
      headers.forEach(h => h.classList.remove('active'));

      // Ajouter la classe active au header cliqu√©
      this.classList.add('active');

      // Trier les donn√©es
      const sortedData = sortCoachClassementCoachData(coachClassementCoachData, sortKey);

      // Re-render avec les donn√©es tri√©es (fonction unifi√©e)
      renderClassement(sortedData, {
        tbodyId: 'coachClassementCoachTableBody',
        mobileCardsId: 'coachClassementCoachMobileCards',
        context: 'coach-ranking'
      });
    });
  });
}

// Fonction de tri pour le classement coach
function sortCoachClassementCoachData(data, sortKey) {
  const sortedData = [...data];

  sortedData.sort((a, b) => {
    let valA, valB;

    switch(sortKey) {
      case 'ca':
        valA = a.ca_actuel || 0;
        valB = b.ca_actuel || 0;
        break;
      case 'pap':
        valA = a.heures_pap || 0;
        valB = b.heures_pap || 0;
        break;
      case 'marketing':
        valA = a.taux_marketing || 0;
        valB = b.taux_marketing || 0;
        break;
      case 'signees':
        valA = a.contract_reel || 0;  // Contrats avec premi√®re facturation
        valB = b.contract_reel || 0;
        break;
      case 'estimations':
        valA = a.nb_estimations || 0;
        valB = b.nb_estimations || 0;
        break;
      case 'contrat':
        valA = a.contrat_moyen || 0;
        valB = b.contrat_moyen || 0;
        break;
      case 'tv':
        valA = a.taux_vente || 0;
        valB = b.taux_vente || 0;
        break;
      case 'produit':
        valA = a.montant_produit || 0;
        valB = b.montant_produit || 0;
        break;
      case 'prod':
        valA = a.prod_horaire || 0;
        valB = b.prod_horaire || 0;
        break;
      case 'etoiles':
        valA = a.etoiles || 0;
        valB = b.etoiles || 0;
        break;
      default:
        valA = a.ca_actuel || 0;
        valB = b.ca_actuel || 0;
    }

    return valB - valA; // Tri d√©croissant
  });

  return sortedData;
}

// Configuration du dropdown de p√©riode pour le classement coach
// NOTE: Le click sur le bouton est maintenant g√©r√© par setupWeekSelectionModal (modal de semaines)
function setupCoachClassementCoachPeriodeDropdown() {
  // Cette fonction est conserv√©e pour compatibilit√© mais le click est g√©r√© par le modal
  console.log('[COACH CLASSEMENT] Setup p√©riode - g√©r√© par le modal de semaines');
}

// ===== FIN CLASSEMENT COACH FUNCTIONS =====

// Render ranking cards for coach dashboard - Use existing renderClassement function
async function renderCoachClassementCards() {
  log(`üîç Chargement du classement - Scope: ${currentCoachScope}, Filter: ${currentCoachFilter}, P√©riode: ${currentCoachPeriode}`);

  try {
    // R√©cup√©rer le username du coach depuis l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const coachUsername = urlParams.get('user');

    let allEntrepreneurs;

    // Charger les entrepreneurs selon le scope
    if (currentCoachScope === 'equipe' && coachUsername) {
      // Charger seulement l'√©quipe du coach (seulement si coach username existe)
      const periodParam = getCoachPeriodParam();
      log(`üìÖ [PERIODE] Chargement √©quipe avec param√®tre: ${periodParam}`);
      const response = await fetch(`/api/coach/${coachUsername}/equipe/dashboard?${periodParam}`);
      if (!response.ok) {
        throw new Error(`Erreur API: ${response.status}`);
      }
      const data = await response.json();

      // Transformer les donn√©es de l'API coach en format plat pour le classement
      allEntrepreneurs = (data.entrepreneurs || []).map(e => {
        // Cr√©er le nom complet pour l'affichage
        const nomComplet = e.prenom && e.nom
          ? `${e.prenom} ${e.nom}`
          : (e.prenom || e.nom || e.username);

        // Log pour d√©boguer les champs disponibles
        console.log('[EQUIPE] Entrepreneur de l\'√©quipe:', {
          username: e.username,
          prenom: e.prenom,
          nom: e.nom,
          login_username: e.login_username,
          nomComplet: nomComplet
        });

        return {
          username: nomComplet, // Utiliser le nom complet pour l'affichage
          login_username: e.login_username || e.username, // Essayer login_username en premier, puis username
          prenom: e.prenom, // Ajouter prenom pour construire le nom complet plus tard
          nom: e.nom, // Ajouter nom pour construire le nom complet plus tard
          // dollar_reel et contract_reel (contrats avec premi√®re facturation)
          dollar_reel: e.chiffre_affaires?.dollar_reel || e.dollar_reel || 0,
          contract_reel: e.status_soumissions?.contract_reel || e.contract_reel || 0,
          ca_actuel: e.chiffre_affaires?.dollar_reel || e.dollar_reel || 0,
          objectif: e.chiffre_affaires?.objectif || 0,
          montant_produit: e.chiffre_affaires?.montant_produit || 0,
          soumissions_signees: e.status_soumissions?.signees || 0,
          soumissions_en_attente: e.status_soumissions?.en_attente || 0,
          soumissions_perdues: e.status_soumissions?.perdus || 0,
          // nb_estimations depuis RPO (estimation_reel) - source unique de v√©rit√©
          nb_estimations: e.metriques?.estimations || e.nb_estimations || e.estimation_reel || 0,
          etoiles: e.satisfaction?.etoiles_moyennes || 0,
          nombre_avis: e.satisfaction?.nombre_avis || 0,
          contrat_moyen: e.metriques?.contrat_moyen || 0,
          taux_vente: e.metriques?.taux_vente || 0,
          prod_horaire: e.metriques?.prod_horaire || 0,
          taux_marketing: e.metriques?.taux_marketing || 0,
          heures_pap: e.heures_pap || e.metriques?.heures_pap || 0  // Total heures PAP (pas moyenne)
        };
      });
      log(`üìä ${allEntrepreneurs.length} entrepreneurs de l'√©quipe charg√©s`);
    } else if (currentCoachScope === 'coach' && currentCoachFilter) {
      // Charger l'√©quipe d'un coach sp√©cifique (pour direction)
      const periodParam = getCoachPeriodParam();
      log(`üìÖ [PERIODE] Chargement √©quipe coach avec param√®tre: ${periodParam}`);
      const response = await fetch(`/api/coach/${currentCoachFilter}/equipe/dashboard?${periodParam}`);
      if (!response.ok) {
        throw new Error(`Erreur API: ${response.status}`);
      }
      const data = await response.json();

      // Transformer les donn√©es
      allEntrepreneurs = (data.entrepreneurs || []).map(e => {
        const nomComplet = e.prenom && e.nom
          ? `${e.prenom} ${e.nom}`
          : (e.prenom || e.nom || e.username);

        return {
          username: nomComplet,
          login_username: e.login_username || e.username,
          prenom: e.prenom,
          nom: e.nom,
          // dollar_reel et contract_reel (contrats avec premi√®re facturation)
          dollar_reel: e.chiffre_affaires?.dollar_reel || e.dollar_reel || 0,
          contract_reel: e.status_soumissions?.contract_reel || e.contract_reel || 0,
          // Aussi mettre dans ca_actuel pour le tri
          ca_actuel: e.chiffre_affaires?.dollar_reel || e.dollar_reel || 0,
          objectif: e.chiffre_affaires?.objectif || 0,
          montant_produit: e.chiffre_affaires?.montant_produit || 0,
          // Garder les originaux pour nb_estimations
          soumissions_signees: e.status_soumissions?.signees || 0,  // Original (36)
          soumissions_en_attente: e.status_soumissions?.en_attente || 0,
          soumissions_perdues: e.status_soumissions?.perdus || 0,
          // nb_estimations depuis RPO (estimation_reel) - source unique de v√©rit√©
          nb_estimations: e.metriques?.estimations || e.nb_estimations || e.estimation_reel || 0,
          etoiles: e.satisfaction?.etoiles_moyennes || 0,
          nombre_avis: e.satisfaction?.nombre_avis || 0,
          contrat_moyen: e.metriques?.contrat_moyen || 0,
          taux_vente: e.metriques?.taux_vente || 0,
          prod_horaire: e.metriques?.prod_horaire || 0,
          taux_marketing: e.metriques?.taux_marketing || 0,
          heures_pap: e.heures_pap || e.metriques?.heures_pap || 0  // Total heures PAP (pas moyenne)
        };
      });
      log(`üìä ${allEntrepreneurs.length} entrepreneurs de l'√©quipe ${currentCoachFilter} charg√©s`);
    } else {
      // Charger TOUS les entrepreneurs
      const periodParam = getCoachPeriodParam();
      log(`üìÖ [PERIODE] Chargement tous entrepreneurs avec param√®tre: ${periodParam}`);
      const response = await fetch(`/api/entrepreneurs?${periodParam}`);
      if (!response.ok) {
        throw new Error(`Erreur API: ${response.status}`);
      }
      allEntrepreneurs = await response.json();
      console.log(`üìä [GRADE DEBUG] ${allEntrepreneurs.length} entrepreneurs charg√©s AVANT filtrage`);

      // Debug: afficher les grades disponibles AVANT tout filtrage
      const gradesDisponibles = {};
      allEntrepreneurs.forEach(e => {
        const grade = e.grade || 'vide';
        gradesDisponibles[grade] = (gradesDisponibles[grade] || 0) + 1;
        console.log(`   [GRADE] ${e.username}: grade="${e.grade}", role="${e.role}"`);
      });
      console.log(`üìã [GRADE DEBUG] Grades disponibles dans les donn√©es brutes:`, gradesDisponibles);
      console.log(`üîç [GRADE DEBUG] currentCoachScope="${currentCoachScope}", currentCoachFilter="${currentCoachFilter}"`);

      // Filtrer pour ne garder que ceux avec nom complet ET exclure les coaches
      const beforeRoleFilter = allEntrepreneurs.length;
      allEntrepreneurs = allEntrepreneurs.filter(e => {
        const hasFullName = e.username && e.username.includes(' ');
        const isNotCoach = e.role !== 'coach' && e.role !== 'direction';
        const keep = hasFullName && isNotCoach;
        if (!keep) {
          console.log(`   [FILTER OUT] ${e.username}: hasFullName=${hasFullName}, isNotCoach=${isNotCoach}`);
        }
        return keep;
      });
      console.log(`üîç [GRADE DEBUG] Apr√®s filtre r√¥le: ${beforeRoleFilter} -> ${allEntrepreneurs.length}`);

      // Si on a un filtre de grade, filtrer par grade depuis les donn√©es d√©j√† charg√©es
      if (currentCoachScope === 'grade' && currentCoachFilter) {
        console.log(`üéØ [GRADE DEBUG] FILTRAGE PAR GRADE ACTIV√â: "${currentCoachFilter}"`);

        // Debug: afficher tous les grades avant le filtre
        const gradesAvantFiltre = allEntrepreneurs.map(e => ({
          username: e.username,
          grade: e.grade,
          role: e.role
        }));
        console.log(`üìã [GRADE DEBUG] Grades AVANT filtre de grade (${allEntrepreneurs.length} entrepreneurs):`, gradesAvantFiltre);

        const beforeGradeFilter = allEntrepreneurs.length;
        // Filtrer avec mapping des grades (ex: rookie = recrue)
        allEntrepreneurs = allEntrepreneurs.filter(e => {
          const grade = e.grade || '';
          console.log(`   [GRADE CHECK] ${e.username}: grade="${grade}" vs filter="${currentCoachFilter}"`);

          // Mapping pour g√©rer les variations de noms de grades
          let matches = false;
          if (currentCoachFilter === 'recrue') {
            matches = grade === 'recrue' || grade === 'rookie';
          } else if (currentCoachFilter === 'senior1') {
            matches = grade === 'senior1';
          } else if (currentCoachFilter === 'senior2') {
            matches = grade === 'senior2';
          } else if (currentCoachFilter === 'senior3') {
            matches = grade === 'senior3';
          } else {
            matches = grade === currentCoachFilter;
          }

          console.log(`      -> matches=${matches}`);
          return matches;
        });
        console.log(`üìä [GRADE DEBUG] Apr√®s filtre de grade: ${beforeGradeFilter} -> ${allEntrepreneurs.length}`);
      }
    }

    // Trier par CA d√©croissant
    const sortedData = allEntrepreneurs.sort((a, b) => {
      const caA = a.ca_actuel || 0;
      const caB = b.ca_actuel || 0;
      return caB - caA;
    });

    // Sauvegarder les donn√©es pour le tri
    coachClassementData = sortedData;

    log(`‚úÖ ${sortedData.length} entrepreneurs filtr√©s et tri√©s`);

    // Utiliser la fonction unifi√©e renderClassement() avec le contexte coach
    await renderClassement(sortedData, {
      tbodyId: 'coachClassementTableBody',
      mobileCardsId: 'coachClassementMobileCards',
      context: 'coach'
    });

    // Setup des √©v√©nements de tri
    setupCoachClassementSorting();

    // Setup des dropdowns (une seule fois)
    if (!coachDropdownsInitialized) {
      setupCoachScopeDropdown();
      setupCoachPeriodeDropdown();
      setupWeekSelectionModal(); // Nouveau: modal de s√©lection de semaines
      coachDropdownsInitialized = true;
    }

  } catch (err) {
    console.error('‚ùå Erreur chargement classement coach:', err);
    const coachTableBody = document.getElementById('coachClassementTableBody');
    if (coachTableBody) {
      coachTableBody.innerHTML = `
        <tr>
          <td colspan="12" class="text-center py-8" style="color: var(--text-gray);">
            <i class="fas fa-exclamation-triangle mr-2"></i>Erreur de chargement des donn√©es
          </td>
        </tr>
      `;
    }
  }
}

// NOTE: renderCoachClassementData() a √©t√© supprim√©e - utiliser renderClassement() avec context: 'coach'

// Cr√©er le graphique CA dans la carte principale
function creerGraphiqueCA() {
  const caCtx = document.getElementById('caChartMain');
  if (!caCtx) return;

  // D√©truire l'ancien graphique s'il existe
  if (charts.caMain) {
    charts.caMain.destroy();
  }

  charts.caMain = new Chart(caCtx, {
    type: 'bar',
    data: {
      labels: entrepreneursData.map(e => (e.prenom || e.nom || e.username).split(' ')[0]), // Pr√©nom seulement
      datasets: [{
        label: 'Dollars ($) vendu',
        data: entrepreneursData.map(e => e.dollar_reel || e.chiffre_affaires?.dollar_reel || 0),
        backgroundColor: entrepreneursData.map((e, i) => {
          const colors = ['rgba(16, 185, 129, 0.8)', 'rgba(52, 211, 153, 0.8)', 'rgba(110, 231, 183, 0.8)'];
          return colors[i % colors.length];
        }),
        borderColor: entrepreneursData.map((e, i) => {
          const colors = ['rgba(16, 185, 129, 1)', 'rgba(52, 211, 153, 1)', 'rgba(110, 231, 183, 1)'];
          return colors[i % colors.length];
        }),
        borderWidth: 2,
        borderRadius: 8,
        hoverBackgroundColor: 'rgba(16, 185, 129, 0.95)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.95)',
          titleColor: '#f1f5f9',
          bodyColor: '#94a3b8',
          borderColor: 'rgba(16, 185, 129, 0.5)',
          borderWidth: 2,
          padding: 16,
          displayColors: true,
          callbacks: {
            label: function(context) {
              return ' CA: ' + formatMontant(context.parsed.y);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(16, 185, 129, 0.1)',
            drawBorder: false
          },
          ticks: {
            color: '#94a3b8',
            callback: function(value) {
              return formatMontant(value);
            }
          }
        },
        x: {
          grid: { display: false },
          ticks: {
            color: '#94a3b8',
            font: { weight: 500 }
          }
        }
      }
    }
  });
}

// Afficher les graphiques avec Chart.js
function afficherGraphiques() {
  // D√©truire les graphiques existants (sauf caMain qui est g√©r√© s√©par√©ment)
  Object.keys(charts).forEach(key => {
    if (key !== 'caMain' && charts[key]) {
      charts[key].destroy();
    }
  });

  // Configuration commune des tooltips
  const tooltipConfig = {
    backgroundColor: 'rgba(15, 23, 42, 0.95)',
    titleColor: '#f1f5f9',
    bodyColor: '#94a3b8',
    borderColor: 'rgba(96, 165, 250, 0.5)',
    borderWidth: 1,
    padding: 12,
    displayColors: true
  };

  // Graphique soumissions (donut) - Adapt√© au nouveau syst√®me RPO
  // Contrats = contract_reel (avec 1er paiement)
  // En attente = ventes_attente + sign√©es sans paiement (total_en_attente)
  // Perdues = clients perdus
  const soumissionsCtx = document.getElementById('soumissionsChart');
  if (soumissionsCtx) {
    const contractReel = teamStats.total_contract_reel || 0;
    // En attente = ventes_attente + (sign√©es sans paiement) - utiliser total_en_attente
    const enAttente = teamStats.total_en_attente || 0;
    const perdus = teamStats.total_perdus || 0;

    charts.soumissions = new Chart(soumissionsCtx, {
      type: 'doughnut',
      data: {
        labels: ['Contrats', 'En attente', 'Perdues'],
        datasets: [{
          data: [
            contractReel,
            enAttente,
            perdus
          ],
          backgroundColor: [
            'rgba(168, 85, 247, 0.8)',
            'rgba(251, 146, 60, 0.8)',
            'rgba(248, 113, 113, 0.8)'
          ],
          borderColor: [
            'rgba(168, 85, 247, 1)',
            'rgba(251, 146, 60, 1)',
            'rgba(248, 113, 113, 1)'
          ],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#94a3b8', padding: 15 }
          },
          tooltip: tooltipConfig
        }
      }
    });
  }

  // Graphique performance (line)
  const performanceCtx = document.getElementById('performanceChart');
  if (performanceCtx) {
    charts.performance = new Chart(performanceCtx, {
      type: 'line',
      data: {
        labels: entrepreneursData.map(e => e.prenom || e.nom || e.username),
        datasets: [{
          label: 'Taux de vente (%)',
          data: entrepreneursData.map(e => e.metriques?.taux_vente || 0),
          borderColor: 'rgba(52, 211, 153, 1)',
          backgroundColor: 'rgba(52, 211, 153, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: tooltipConfig
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(255, 255, 255, 0.05)' },
            ticks: { color: '#94a3b8' }
          },
          x: {
            grid: { display: false },
            ticks: { color: '#94a3b8' }
          }
        }
      }
    });
  }

  // Graphique $ produit par mois (line chart)
  const produitMensuelCtx = document.getElementById('produitMensuelChart');
  if (produitMensuelCtx) {
    // G√©n√©rer les mois avec D√©c. 2025 au d√©but
    const mois = ['D√©c. 2025', 'Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];

    // Donn√©es mensuelles avec d√©cembre 2025 au d√©but
    const dataMensuelle = teamStats.produit_mensuel || Array(13).fill(0);

    charts.produitMensuel = new Chart(produitMensuelCtx, {
      type: 'line',
      data: {
        labels: mois,
        datasets: [{
          label: '$ Produit',
          data: dataMensuelle,
          borderColor: 'rgba(16, 185, 129, 1)',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 3,
          pointBackgroundColor: 'rgba(16, 185, 129, 1)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            ...tooltipConfig,
            callbacks: {
              label: function(context) {
                return ' $ Produit: ' + formatMontant(context.parsed.y);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(16, 185, 129, 0.1)',
              drawBorder: false
            },
            ticks: {
              color: '#94a3b8',
              callback: function(value) {
                return formatMontant(value);
              }
            }
          },
          x: {
            grid: { display: false },
            ticks: {
              color: '#94a3b8',
              font: { weight: 500 }
            }
          }
        }
      }
    });
  }
}

// Afficher les entrepreneurs
function afficherEntrepreneurs() {
  const container = document.getElementById('entrepreneursContainer');
  if (!container) return;

  const maxSlots = 9; // 3x3 grid

  // Trier les entrepreneurs par CA (du plus √©lev√© au plus bas)
  const sortedEntrepreneurs = [...entrepreneursData].sort((a, b) => {
    const caA = a.dollar_reel || a.chiffre_affaires?.dollar_reel || 0;
    const caB = b.dollar_reel || b.chiffre_affaires?.dollar_reel || 0;
    return caB - caA;
  });

  const actualEntrepreneurs = sortedEntrepreneurs.length;
  const emptySlots = Math.max(0, maxSlots - actualEntrepreneurs);

  let html = '';

  // Charger la configuration de personnalisation
  const savedConfig = localStorage.getItem(`coach-card-config-${coachUsername}`);
  let cardConfig = {
    stats: ['ca_vendu', 'objectif_montant', 'objectif_pct', 'estimations', 'taux_vente', 'contrats', 'hpap_sem', 'taux_mktg', 'contrat_moy', 'produit_total', 'prod_horaire', 'nb_employes']
  };

  if (savedConfig) {
    try {
      const saved = JSON.parse(savedConfig);
      cardConfig.stats = saved.stats || cardConfig.stats;
    } catch (e) {
      error('Erreur chargement config:', e);
    }
  }

  sortedEntrepreneurs.forEach((entrepreneur, index) => {
    const rank = index + 1;

    // Debug complet de l'entrepreneur
    log(`[DEBUG ENTREPRENEUR ${index}] Username:`, entrepreneur.username);
    log(`[DEBUG ENTREPRENEUR ${index}] Prenom:`, entrepreneur.prenom);
    log(`[DEBUG ENTREPRENEUR ${index}] Nom:`, entrepreneur.nom);
    log(`[DEBUG ENTREPRENEUR ${index}] Grade:`, entrepreneur.grade);
    log(`[DEBUG ENTREPRENEUR ${index}] Photo:`, entrepreneur.photo);
    log(`[DEBUG ENTREPRENEUR ${index}] Full object:`, entrepreneur);

    const photoUrl = entrepreneur.photo || `/api/get-file/${entrepreneur.username}/profile_photo_${entrepreneur.username}.png`;
    const nomComplet = `${entrepreneur.prenom || ''} ${entrepreneur.nom || entrepreneur.username}`.trim();
    const grade = formatGrade(entrepreneur.grade || 'rookie');

    const ca = entrepreneur.chiffre_affaires || {};
    const soumissions = entrepreneur.status_soumissions || {};
    const satisfaction = entrepreneur.satisfaction || {};
    const employes = entrepreneur.employes || {};
    const metriques = entrepreneur.metriques || {};

    // Debug logging pour voir les donn√©es re√ßues
    log(`[DEBUG ${entrepreneur.username}] CA:`, ca);
    log(`[DEBUG ${entrepreneur.username}] Soumissions:`, soumissions);
    log(`[DEBUG ${entrepreneur.username}] Satisfaction:`, satisfaction);
    log(`[DEBUG ${entrepreneur.username}] Employ√©s:`, employes);
    log(`[DEBUG ${entrepreneur.username}] M√©triques:`, metriques);

    // Badge pour le top 3
    let rankBadge = '';
    if (rank === 1) {
      rankBadge = '<div class="rank-badge rank-1"><i class="fas fa-trophy"></i></div>';
    } else if (rank === 2) {
      rankBadge = '<div class="rank-badge rank-2"><i class="fas fa-medal"></i></div>';
    } else if (rank === 3) {
      rankBadge = '<div class="rank-badge rank-3"><i class="fas fa-award"></i></div>';
    }

    // G√©n√©rer les stats selon la config
    let statsHTML = '';
    for (let i = 0; i < cardConfig.stats.length; i += 3) {
      const statsInRow = cardConfig.stats.slice(i, i + 3);
      statsHTML += '<div class="entrepreneur-stats">';

      statsInRow.forEach(statId => {
        const statData = getStatData(statId, ca, soumissions, metriques, satisfaction, employes);
        if (statData) {
          statsHTML += `
            <div class="stat-item">
              <div class="label"><i class="fas ${statData.icon}"></i> ${statData.label}</div>
              <div class="value ${statData.color}">${statData.value}</div>
            </div>
          `;
        }
      });

      statsHTML += '</div>';
    }

    // Toujours afficher les 2 boutons
    const actionsHTML = `
      <div class="entrepreneur-actions">
        <button type="button" class="action-btn primary" onclick="event.stopPropagation(); voirDashboard('${entrepreneur.username}');">
          <i class="fas fa-chart-line"></i> Dashboard
        </button>
        <button type="button" class="action-btn secondary" onclick="event.stopPropagation(); contacterEntrepreneur('${entrepreneur.courriel || ''}');">
          <i class="fas fa-envelope"></i> Contact
        </button>
      </div>
    `;

    // G√©n√©rer les √©toiles de satisfaction
    const moyenneEtoiles = satisfaction.etoiles_moyennes || satisfaction.moyenne_etoiles || 0;
    const etoilesHTML = generateStarsHTML(moyenneEtoiles);

    html += `
      <div class="entrepreneur-card fade-in-up" style="animation-delay: ${index * 0.1}s;">
        ${rankBadge}
        <div class="entrepreneur-header">
          <img src="${photoUrl}" alt="${nomComplet}" class="entrepreneur-photo" onerror="this.src='https://i.ibb.co/twJsgZrb/Design-sans-titre-39.png'">
          <div class="entrepreneur-info">
            <h3>${nomComplet} ${etoilesHTML}</h3>
            <span class="grade"><i class="fas fa-star"></i> ${grade}</span>
          </div>
        </div>

        ${statsHTML}

        ${actionsHTML}
      </div>
    `;
  });

  // Ajouter les emplacements vides
  for (let i = 0; i < emptySlots; i++) {
    html += `
      <div class="empty-slot-card fade-in-up" style="animation-delay: ${(actualEntrepreneurs + i) * 0.1}s;">
        <div class="empty-slot-icon">
          <i class="fas fa-user-plus"></i>
        </div>
        <div class="empty-slot-text">
          Emplacement pour<br>futur membre de l'√©quipe
        </div>
      </div>
    `;
  }

  container.innerHTML = html;
}

// Fonctions utilitaires
// Fonction pour parser un montant au format "1293,46 $" ou "1293.46"
function parseMontant(montantStr) {
  if (!montantStr) return 0;
  // Supprimer le symbole $ et les espaces
  let cleaned = String(montantStr).replace(/\$/g, '').trim();
  // Remplacer la virgule par un point pour le format d√©cimal
  cleaned = cleaned.replace(',', '.');
  // Parser en float
  return parseFloat(cleaned) || 0;
}

function formatGrade(grade) {
  const grades = {
    'rookie': 'Recrue',
    'junior1': 'Junior I',
    'junior2': 'Junior II',
    'senior1': 'Senior I',
    'senior2': 'Senior II',
    'expert1': 'Expert I',
    'expert2': 'Expert II',
    'master': 'Master'
  };
  return grades[grade] || grade;
}

function generateStarsHTML(moyenne) {
  // Une seule √©toile avec le chiffre √† c√¥t√©
  const moyenneNum = parseFloat(moyenne) || 0;

  return `<span style="margin-left: 0.5rem; white-space: nowrap;"><i class="fas fa-star" style="color: #eab308;"></i> <span style="color: #eab308; font-weight: 500;">${moyenneNum.toFixed(1)}</span></span>`;
}

function formatMontant(montant) {
  return new Intl.NumberFormat('fr-CA', {
    style: 'currency',
    currency: 'CAD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(montant);
}

// Obtenir les donn√©es d'une statistique
function getStatData(statId, ca, soumissions, metriques, satisfaction, employes) {
  // Utiliser dollar_reel pour $ Vendu (contrats avec premi√®re facturation)
  const dollarReel = ca.dollar_reel || 0;
  // Utiliser contract_reel pour Sign√©s (contrats avec premi√®re facturation)
  const contractReel = soumissions.contract_reel || 0;

  const statMap = {
    'ca_vendu': {
      label: '$ Vendu',
      icon: 'fa-dollar-sign',
      color: 'green',
      value: formatMontant(dollarReel)
    },
    'objectif_montant': {
      label: 'Objectif',
      icon: 'fa-bullseye',
      color: 'blue',
      value: formatMontant(ca.objectif || 0)
    },
    'objectif_pct': {
      label: 'Objectif %',
      icon: 'fa-percentage',
      color: (ca.pourcentage || 0) >= 100 ? 'green' : 'orange',
      value: `${(ca.pourcentage || 0).toFixed(1)}%`
    },
    'estimations': {
      label: 'Estimations',
      icon: 'fa-file-alt',
      color: 'purple',
      // Nb estimations depuis RPO (estimation_reel) - source unique de v√©rit√©
      value: metriques.estimations || 0
    },
    'taux_vente': {
      label: 'Taux vente',
      icon: 'fa-chart-line',
      color: 'orange',
      value: `${(metriques.taux_vente || 0).toFixed(1)}%`
    },
    'contrats': {
      label: 'Sign√©s',
      icon: 'fa-file-signature',
      color: 'red',
      value: contractReel  // Contrats avec premi√®re facturation
    },
    'hpap_sem': {
      label: 'H PAP/sem',
      icon: 'fa-clock',
      color: 'yellow',
      value: `${(metriques.heures_pap_semaine || 0).toFixed(1)}h`
    },
    'taux_mktg': {
      label: 'Taux MKTG',
      icon: 'fa-bullhorn',
      color: 'blue',
      value: `${(metriques.taux_marketing || 0).toFixed(2)}`
    },
    'contrat_moy': {
      label: 'Contrat moy',
      icon: 'fa-hand-holding-usd',
      color: 'teal',
      value: formatMontant(metriques.contrat_moyen || 0)
    },
    'produit_mensuel': {
      label: '$ Produit/mois',
      icon: 'fa-calendar-alt',
      color: 'green',
      value: formatMontant((ca.dollar_reel || 0) / 12)
    },
    'produit_total': {
      label: '$ produit',
      icon: 'fa-box',
      color: 'purple',
      value: formatMontant(ca.montant_produit || 0)
    },
    'prod_horaire': {
      label: 'Prod/h',
      icon: 'fa-hourglass-half',
      color: 'teal',
      value: formatMontant(metriques.prod_horaire || 0) + '/h'
    },
    'signees': {
      label: 'Sign√©es',
      icon: 'fa-check-circle',
      color: 'green',
      value: soumissions.signees || 0
    },
    'en_attente': {
      label: 'En attente',
      icon: 'fa-hourglass-half',
      color: 'orange',
      value: soumissions.en_attente || 0
    },
    'perdus': {
      label: 'Perdus',
      icon: 'fa-times-circle',
      color: 'red',
      value: soumissions.perdues || 0
    },
    'nb_avis': {
      label: 'Nb avis',
      icon: 'fa-comments',
      color: 'blue',
      value: satisfaction.nb_avis || 0
    },
    'nb_employes': {
      label: 'Employ√©s',
      icon: 'fa-users',
      color: 'purple',
      value: employes.actifs || 0
    },
    'hpap_total': {
      label: 'H PAP total',
      icon: 'fa-clock',
      color: 'yellow',
      value: `${(metriques.heures_pap || 0).toFixed(0)}h`
    },
    'ca_objectif_diff': {
      label: '√âcart objectif',
      icon: 'fa-chart-bar',
      color: ((ca.dollar_reel || 0) - (ca.objectif || 0)) >= 0 ? 'green' : 'red',
      value: formatMontant((ca.dollar_reel || 0) - (ca.objectif || 0))
    }
  };

  return statMap[statId] || null;
}

async function voirDashboard(usernameParam) {
  log('Redirection vers dashboard pour:', usernameParam);

  // V√©rifier si on est d√©j√† sur la page dashboard
  const currentHash = window.parent ? window.parent.location.hash : window.location.hash;
  const isOnDashboard = currentHash === '#/dashboard';

  if (isOnDashboard) {
    // On est d√©j√† sur le dashboard - changer la vue directement sans recharger
    log('‚úÖ D√©j√† sur dashboard - changement de vue direct');

    // Afficher un loader pendant la transition
    const loader = document.createElement('div');
    loader.id = 'dashboard-transition-loader';
    loader.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    `;
    loader.innerHTML = `
      <div style="text-align: center;">
        <div class="spinner" style="border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #60a5fa; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
        <p style="color: white; font-size: 16px; font-weight: 500;">Chargement du dashboard...</p>
      </div>
    `;
    document.body.appendChild(loader);

    // Attendre un instant pour que le loader s'affiche
    await new Promise(resolve => setTimeout(resolve, 100));

    // Changer le type de dashboard vers "entrepreneur"
    selectDashboardType('entrepreneur');

    // Attendre que les entrepreneurs soient charg√©s
    await new Promise(resolve => setTimeout(resolve, 300));

    // S√©lectionner l'entrepreneur
    selectEntrepreneur(usernameParam);

    // Attendre que le dashboard se charge
    await new Promise(resolve => setTimeout(resolve, 500));

    // Retirer le loader
    loader.remove();
  } else {
    // On n'est pas sur le dashboard - rediriger normalement
    log('üîÑ Navigation vers dashboard');

    // Stocker le username de l'entrepreneur √† visualiser
    sessionStorage.setItem('viewEntrepreneurUsername', usernameParam);

    // Rediriger vers le dashboard via le routeur parent
    if (window.parent && window.parent !== window) {
      window.parent.location.hash = '#/dashboard';
    } else {
      const urlParams = new URLSearchParams(window.location.search);
      const coachUser = urlParams.get('user') || coachUsername;
      window.location.href = `/apppccoach?user=${coachUser}#/dashboard`;
    }
  }
}

function contacterEntrepreneur(email) {
  if (email) {
    window.location.href = `mailto:${email}`;
  }
}

// ===== MODAL PERSONNALISER =====

// Toutes les statistiques disponibles
const allAvailableStats = [
  { id: 'ca_vendu', label: '$ Vendu', icon: 'fa-dollar-sign', color: 'green', value: '15 000 $' },
  { id: 'objectif_montant', label: 'Objectif', icon: 'fa-bullseye', color: 'blue', value: '20 000 $' },
  { id: 'objectif_pct', label: 'Objectif %', icon: 'fa-percentage', color: 'orange', value: '75.0%' },
  { id: 'estimations', label: 'Estimations', icon: 'fa-file-alt', color: 'purple', value: '12' },
  { id: 'taux_vente', label: 'Taux vente', icon: 'fa-chart-line', color: 'orange', value: '45.5%' },
  { id: 'contrats', label: 'Sign√©s', icon: 'fa-file-signature', color: 'red', value: '8' },
  { id: 'hpap_sem', label: 'H PAP/sem', icon: 'fa-clock', color: 'yellow', value: '25.5h' },
  { id: 'taux_mktg', label: 'Taux MKTG', icon: 'fa-bullhorn', color: 'blue', value: '0.46' },
  { id: 'contrat_moy', label: 'Contrat moy', icon: 'fa-hand-holding-usd', color: 'teal', value: '1 875 $' },
  { id: 'produit_total', label: '$ produit', icon: 'fa-box', color: 'purple', value: '0 $' },
  { id: 'produit_mensuel', label: '$ Produit/mois', icon: 'fa-calendar-alt', color: 'green', value: '3 000 $' },
  { id: 'prod_horaire', label: 'Prod/h', icon: 'fa-hourglass-half', color: 'teal', value: '75 $/h' },
  { id: 'signees', label: 'Sign√©es', icon: 'fa-check-circle', color: 'green', value: '8' },
  { id: 'en_attente', label: 'En attente', icon: 'fa-hourglass-half', color: 'orange', value: '3' },
  { id: 'perdus', label: 'Perdus', icon: 'fa-times-circle', color: 'red', value: '1' },
  { id: 'nb_avis', label: 'Nb avis', icon: 'fa-comments', color: 'blue', value: '12' },
  { id: 'nb_employes', label: 'Employ√©s', icon: 'fa-users', color: 'purple', value: '5' },
  { id: 'hpap_total', label: 'H PAP total', icon: 'fa-clock', color: 'yellow', value: '125h' },
  { id: 'ca_objectif_diff', label: '√âcart objectif', icon: 'fa-chart-bar', color: 'red', value: '-5 000 $' }
];

// Configuration par d√©faut (12 stats)
let defaultActiveStats = [
  'ca_vendu', 'objectif_montant', 'objectif_pct',
  'estimations', 'taux_vente', 'contrats',
  'hpap_sem', 'taux_mktg', 'contrat_moy',
  'produit_total', 'prod_horaire', 'nb_employes'
];

let activeStatsConfig = [...defaultActiveStats];
let draggedElement = null;
let previewDraggedElement = null;
let initialConfig = null; // Pour d√©tecter les changements

function openPersonaliserModal() {
  const modal = document.getElementById('personaliserModal');
  modal.style.display = 'flex';

  // D√©sactiver le scroll en arri√®re-plan
  document.body.style.overflow = 'hidden';

  // Charger la configuration sauvegard√©e
  loadSavedConfig();

  // Sauvegarder la config initiale pour d√©tecter les changements
  initialConfig = {
    stats: [...activeStatsConfig]
  };

  // Initialiser les listes
  renderActiveStats();
  renderAvailableStats();
  updatePreview();

  // Masquer le bouton Enregistrer au d√©part
  document.getElementById('saveBtn').style.display = 'none';
}

function closePersonaliserModal() {
  const modal = document.getElementById('personaliserModal');
  modal.style.display = 'none';

  // R√©activer le scroll en arri√®re-plan
  document.body.style.overflow = '';
}

function loadSavedConfig() {
  const saved = localStorage.getItem(`coach-card-config-${coachUsername}`);
  if (saved) {
    try {
      const config = JSON.parse(saved);
      activeStatsConfig = config.stats || [...defaultActiveStats];
    } catch (e) {
      error('Erreur chargement config:', e);
    }
  }
}

function renderActiveStats() {
  const container = document.getElementById('activeStats');

  if (activeStatsConfig.length === 0) {
    container.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 1rem;">Aucune statistique active. Ajoutez-en depuis la liste ci-dessous.</p>';
    return;
  }

  container.innerHTML = activeStatsConfig.map((statId, index) => {
    const stat = allAvailableStats.find(s => s.id === statId);
    if (!stat) return '';

    return `
      <div class="active-stat-item" draggable="true" data-stat-id="${stat.id}" data-index="${index}">
        <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
          <i class="fas fa-grip-vertical" style="color: var(--text-gray); cursor: grab;"></i>
          <i class="fas ${stat.icon}" style="color: var(--${stat.color});"></i>
          <span style="color: var(--text-light); font-weight: 500;">${stat.label}</span>
        </div>
        <button class="remove-stat-btn" data-stat-id="${stat.id}" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `;
  }).join('');

  // Ajouter les event listeners pour les boutons de suppression
  console.log('[DEBUG] Attaching remove button listeners...');
  const removeButtons = document.querySelectorAll('.remove-stat-btn');
  console.log('[DEBUG] Found', removeButtons.length, 'remove buttons');

  removeButtons.forEach(btn => {
    // Emp√™cher le drag sur le bouton
    btn.setAttribute('draggable', 'false');
    btn.addEventListener('mousedown', function(e) {
      e.stopPropagation(); // Emp√™cher le drag de d√©marrer
    });

    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const statId = this.getAttribute('data-stat-id');
      console.log('[DEBUG] Remove button clicked for stat:', statId);
      removeStat(statId);
    });
  });

  // Ajouter les event listeners pour le drag & drop
  setupDragAndDrop();
}

function renderAvailableStats() {
  const container = document.getElementById('availableStats');
  const available = allAvailableStats.filter(stat => !activeStatsConfig.includes(stat.id));

  if (available.length === 0) {
    container.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 1rem;">Toutes les statistiques sont d√©j√† actives</p>';
    return;
  }

  container.innerHTML = available.map(stat => {
    return `
      <div class="available-stat-item" data-stat-id="${stat.id}">
        <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
          <i class="fas ${stat.icon}" style="color: var(--${stat.color});"></i>
          <span style="color: var(--text-light); font-weight: 500;">${stat.label}</span>
        </div>
        <button onclick="addStat('${stat.id}')" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;">
          <i class="fas fa-plus"></i>
        </button>
      </div>
    `;
  }).join('');
}

let isDraggingActive = false;
let activeDragElement = null;
let placeholder = null;

function setupDragAndDrop() {
  const items = document.querySelectorAll('.active-stat-item');

  items.forEach(item => {
    item.addEventListener('mousedown', handleMouseDown);
  });
}

function handleMouseDown(e) {
  e.preventDefault();

  isDraggingActive = true;
  activeDragElement = this;
  const rect = this.getBoundingClientRect();

  // Cr√©er placeholder
  placeholder = this.cloneNode(true);
  placeholder.style.opacity = '0.3';
  placeholder.style.visibility = 'hidden';
  this.parentNode.insertBefore(placeholder, this);

  // L'√©l√©ment devient fixed
  this.style.position = 'fixed';
  this.style.left = rect.left + 'px';
  this.style.top = rect.top + 'px';
  this.style.width = rect.width + 'px';
  this.style.zIndex = '9999';
  this.style.pointerEvents = 'none';

  const offsetX = e.clientX - rect.left;
  const offsetY = e.clientY - rect.top;

  function onMouseMove(e) {
    if (!isDraggingActive) return;

    activeDragElement.style.left = (e.clientX - offsetX) + 'px';
    activeDragElement.style.top = (e.clientY - offsetY) + 'px';

    // Trouver √©l√©ment dessous
    activeDragElement.style.pointerEvents = 'none';
    const below = document.elementFromPoint(e.clientX, e.clientY);
    const target = below?.closest('.active-stat-item');

    if (target && target !== activeDragElement && target !== placeholder && placeholder.parentNode) {
      const container = placeholder.parentNode;

      // V√©rifier que target est bien dans le m√™me container
      if (target.parentNode !== container) return;

      const targetRect = target.getBoundingClientRect();

      try {
        if (e.clientY < targetRect.top + targetRect.height / 2) {
          // Ins√©rer avant
          if (placeholder.nextSibling !== target) {
            container.insertBefore(placeholder, target);
          }
        } else {
          // Ins√©rer apr√®s
          const nextNode = target.nextSibling;
          if (placeholder !== nextNode) {
            if (nextNode && nextNode.parentNode === container) {
              container.insertBefore(placeholder, nextNode);
            } else {
              container.appendChild(placeholder);
            }
          }
        }
      } catch (err) {
        // Ignorer les erreurs DOM
      }
    }
  }

  function onMouseUp(e) {
    if (!isDraggingActive) return;

    isDraggingActive = false;

    // Calculer nouvel index
    const oldIndex = parseInt(activeDragElement.dataset.index);
    const newIndex = Array.from(placeholder.parentNode.children).indexOf(placeholder);

    // Retirer placeholder
    if (placeholder && placeholder.parentNode) {
      placeholder.parentNode.removeChild(placeholder);
    }

    // R√©organiser
    if (oldIndex !== newIndex) {
      const [removed] = activeStatsConfig.splice(oldIndex, 1);
      let adjustedIndex = newIndex;
      if (newIndex > oldIndex) adjustedIndex--;
      activeStatsConfig.splice(adjustedIndex, 0, removed);
    }

    // Re-render
    renderActiveStats();
    updatePreview();
    checkForChanges();

    // Cleanup
    activeDragElement = null;
    placeholder = null;

    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
  }

  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', onMouseUp);
}

// Pas de drag & drop dans l'aper√ßu
function setupPreviewDragAndDrop() {
  // Fonction vide - pas de drag dans l'aper√ßu
}

function addStat(statId) {
  if (!activeStatsConfig.includes(statId)) {
    if (activeStatsConfig.length >= 12) {
      // Afficher le message d'avertissement
      const warning = document.getElementById('maxStatsWarning');
      warning.style.display = 'block';

      // Masquer apr√®s 3 secondes
      setTimeout(() => {
        warning.style.display = 'none';
      }, 3000);

      return;
    }
    activeStatsConfig.push(statId);
    renderActiveStats();
    renderAvailableStats();
    updatePreview();
    checkForChanges();
  }
}

function removeStat(statId) {
  activeStatsConfig = activeStatsConfig.filter(id => id !== statId);
  renderActiveStats();
  renderAvailableStats();
  updatePreview();
  checkForChanges();
}

function renderPreviewOnly(config) {
  // Fonction pour render uniquement l'aper√ßu sans affecter activeStatsConfig
  const previewContainer = document.getElementById('previewStatsContainer');

  let html = '';
  for (let i = 0; i < config.length; i += 3) {
    const statsInRow = config.slice(i, i + 3);
    html += '<div class="entrepreneur-stats">';

    statsInRow.forEach((statId, indexInRow) => {
      const stat = allAvailableStats.find(s => s.id === statId);
      const globalIndex = i + indexInRow;
      if (stat) {
        html += `
          <div class="stat-item" data-stat-id="${stat.id}" data-index="${globalIndex}">
            <div class="label"><i class="fas ${stat.icon}"></i> ${stat.label}</div>
            <div class="value ${stat.color}">${stat.value}</div>
          </div>
        `;
      }
    });

    html += '</div>';
  }

  previewContainer.innerHTML = html;
  setupPreviewDragAndDrop();
}

function updatePreview() {
  const previewContainer = document.getElementById('previewStatsContainer');
  const actionsContainer = document.getElementById('previewActions');

  // G√©n√©rer les stats par groupe de 3 avec drag & drop
  let html = '';
  for (let i = 0; i < activeStatsConfig.length; i += 3) {
    const statsInRow = activeStatsConfig.slice(i, i + 3);
    html += '<div class="entrepreneur-stats">';

    statsInRow.forEach((statId, indexInRow) => {
      const stat = allAvailableStats.find(s => s.id === statId);
      const globalIndex = i + indexInRow;
      if (stat) {
        html += `
          <div class="stat-item" data-stat-id="${stat.id}" data-index="${globalIndex}">
            <div class="label"><i class="fas ${stat.icon}"></i> ${stat.label}</div>
            <div class="value ${stat.color}">${stat.value}</div>
          </div>
        `;
      }
    });

    html += '</div>';
  }

  previewContainer.innerHTML = html;

  // Ajouter les event listeners pour le drag & drop dans l'aper√ßu
  setupPreviewDragAndDrop();

  // Toujours afficher les 2 boutons
  actionsContainer.style.display = 'flex';
  actionsContainer.innerHTML = `
    <button type="button" class="action-btn primary" style="pointer-events: none; opacity: 0.7;">
      <i class="fas fa-chart-line"></i> Dashboard
    </button>
    <button type="button" class="action-btn secondary" style="pointer-events: none; opacity: 0.7;">
      <i class="fas fa-envelope"></i> Contact
    </button>
  `;
}

function checkForChanges() {
  if (!initialConfig) return;

  const currentConfig = {
    stats: [...activeStatsConfig]
  };

  // Comparer avec la config initiale
  const hasChanges = JSON.stringify(currentConfig.stats) !== JSON.stringify(initialConfig.stats);

  const saveBtn = document.getElementById('saveBtn');
  if (hasChanges) {
    saveBtn.style.display = 'flex';
  } else {
    saveBtn.style.display = 'none';
  }
}

function saveCustomization() {
  const saveBtn = document.getElementById('saveBtn');
  const saveIcon = document.getElementById('saveIcon');
  const saveText = document.getElementById('saveText');

  // D√©sactiver le bouton et afficher le spinner
  saveBtn.disabled = true;
  saveBtn.style.opacity = '0.7';
  saveBtn.style.cursor = 'not-allowed';
  saveIcon.className = 'fas fa-spinner spinner';
  saveText.textContent = 'Enregistrement...';

  const config = {
    stats: activeStatsConfig
  };

  // Sauvegarder dans localStorage
  localStorage.setItem(`coach-card-config-${coachUsername}`, JSON.stringify(config));

  // Simuler un d√©lai d'enregistrement et afficher succ√®s
  setTimeout(() => {
    saveIcon.className = 'fas fa-check';
    saveText.textContent = 'Enregistr√© !';
    saveBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';

    // Recharger les cartes entrepreneur
    afficherEntrepreneurs();

    // Mettre √† jour la config initiale
    initialConfig = {
      stats: [...activeStatsConfig]
    };

    // R√©initialiser le bouton apr√®s 2 secondes
    setTimeout(() => {
      saveIcon.className = 'fas fa-save';
      saveText.textContent = 'Enregistrer';
      saveBtn.disabled = false;
      saveBtn.style.opacity = '1';
      saveBtn.style.cursor = 'pointer';
      saveBtn.style.display = 'none'; // Masquer car plus de changements
    }, 2000);
  }, 800);
}

function resetToDefault() {
  if (confirm('Voulez-vous vraiment r√©initialiser la configuration par d√©faut ?')) {
    activeStatsConfig = [...defaultActiveStats];

    renderActiveStats();
    renderAvailableStats();
    updatePreview();
    checkForChanges();
  }
}
// ===== FIN JAVASCRIPT DASHBOARD COACH =====
</script>

<!-- Script pour la banni√®re Side Quest (entrepreneurs uniquement) -->
<script>
// Variables globales pour les qu√™tes du dashboard
let dashboardCurrentQuest = null;
let dashboardNextQuest = null;
let dashboardQuestProgress = { current: 0, percent: 0 };
let dashboardStreak = 0;

// Liste des qu√™tes (m√™me que gamification.html)
const dashboardWeeklyQuests = [
  { title: "Faire 12h de PAP durant la semaine Internationale", deadline: "2026-01-12", target: 12, unit: "heures" },
  { title: "Faire 12h de PAP durant la semaine", deadline: "2026-01-19", target: 12, unit: "heures" },
  { title: "Faire 12h de PAP durant la semaine", deadline: "2026-01-26", target: 12, unit: "heures" },
  { title: "Faire 3 estimations ou plus cette semaine", deadline: "2026-02-02", target: 3, unit: "estimations" },
  { title: "Avoir un taux marketing de 0,75 estimations par heure", deadline: "2026-02-09", target: 0.75, unit: "taux" },
  { title: "Faire 5 estimations cette semaine", deadline: "2026-02-16", target: 5, unit: "estimations" },
  { title: "Faire 5 estimations cette semaine", deadline: "2026-02-23", target: 5, unit: "estimations" },
  { title: "Faire 7 estimations cette semaine", deadline: "2026-03-02", target: 7, unit: "estimations" },
  { title: "Signer 5000$", deadline: "2026-03-09", target: 5000, unit: "$" },
  { title: "Collecter plus de 1500$ en d√©p√¥t", deadline: "2026-03-16", target: 1500, unit: "depot" },
  { title: "Signer 7500$", deadline: "2026-03-23", target: 7500, unit: "$" },
  { title: "Signer un contrat de plus de 4000$ avant taxes", deadline: "2026-03-30", target: 4000, unit: "$" },
  { title: "Profiter de la folie de P√¢ques pour signer 15000$ cette semaine", deadline: "2026-04-06", target: 15000, unit: "$" },
  { title: "Embaucher un premier peintre", deadline: "2026-04-13", target: 1, unit: "peintre" },
  { title: "Signer 10000$", deadline: "2026-04-20", target: 10000, unit: "$" },
  { title: "Signer 12000$", deadline: "2026-04-27", target: 12000, unit: "$" },
  { title: "Signer 12000$", deadline: "2026-05-04", target: 12000, unit: "$" },
  { title: "Signer 12000$", deadline: "2026-05-11", target: 12000, unit: "$" },
  { title: "Signer 12000$", deadline: "2026-05-18", target: 12000, unit: "$" },
  { title: "15 estimations cette semaine", deadline: "2026-05-25", target: 15, unit: "estimations" },
  { title: "Atteindre 100000$ de ventes cumulatif depuis le d√©but de l'ann√©e", deadline: "2026-06-01", target: 100000, unit: "ca_cumul" },
  { title: "Produire 5000$ de contrats", deadline: "2026-06-08", target: 5000, unit: "produit" },
  { title: "Productivit√© horaire de plus de 90", deadline: "2026-06-15", target: 90, unit: "productivit√©" },
  { title: "Faire 10h de PAP cette semaine", deadline: "2026-06-22", target: 10, unit: "heures" },
  { title: "Faire plus de 15 estimations cette semaine", deadline: "2026-06-29", target: 15, unit: "estimations" },
  { title: "Productivit√© horaire de plus de 100", deadline: "2026-07-06", target: 100, unit: "productivit√©" },
  { title: "Produire 15000$ cette semaine", deadline: "2026-07-13", target: 15000, unit: "produit" },
  { title: "Satisfaction client cumulative de plus de 4,5 √©toiles", deadline: "2026-07-20", target: 4.5, unit: "√©toiles" },
  { title: "10 estimations cette semaine", deadline: "2026-07-27", target: 10, unit: "estimations" },
  { title: "Signer 5000$", deadline: "2026-08-03", target: 5000, unit: "$" },
  { title: "Productivit√© horaire de 110", deadline: "2026-08-10", target: 110, unit: "productivit√©" },
  { title: "Produire 10000$", deadline: "2026-08-17", target: 10000, unit: "produit" },
  { title: "Produire 10000$", deadline: "2026-08-24", target: 10000, unit: "produit" },
  { title: "Faire 9h de PAP", deadline: "2026-09-28", target: 9, unit: "heures" },
  { title: "Signer 5000$", deadline: "2026-10-05", target: 5000, unit: "$" },
  { title: "Signer 10000$", deadline: "2026-10-12", target: 10000, unit: "$" },
  { title: "Signer 10000$", deadline: "2026-10-19", target: 10000, unit: "$" },
  { title: "Signer 5000$", deadline: "2026-10-26", target: 5000, unit: "$" }
];

// Fonction pour obtenir le style de streak
function dbGetStreakStyle(streakNum) {
  const streakTiers = [
    { min: 25, border: '#ef4444', badgeBg: 'linear-gradient(135deg, #7f1d1d, #991b1b)', badgeBorder: '#7f1d1d', fireColor: '#fca5a5', shadow: '0 4px 16px rgba(0, 0, 0, 0.7), 0 0 24px rgba(239, 68, 68, 0.7)', xp: 100 },
    { min: 20, border: '#f59e0b', badgeBg: 'linear-gradient(135deg, #1f2937, #111827)', badgeBorder: 'var(--bg-dark)', fireColor: '#f59e0b', shadow: '0 4px 12px rgba(0, 0, 0, 0.5), 0 0 20px rgba(245, 158, 11, 0.6)', xp: 50 },
    { min: 15, border: '#fbbf24', badgeBg: 'linear-gradient(135deg, #1f2937, #111827)', badgeBorder: 'var(--bg-dark)', fireColor: '#f59e0b', shadow: '0 2px 8px rgba(0, 0, 0, 0.5), 0 0 16px rgba(245, 158, 11, 0.5)', xp: 25 },
    { min: 10, border: '#10b981', badgeBg: 'linear-gradient(135deg, #1f2937, #111827)', badgeBorder: 'var(--bg-dark)', fireColor: '#f59e0b', shadow: '0 2px 8px rgba(0, 0, 0, 0.5), 0 0 12px rgba(245, 158, 11, 0.3)', xp: 20 },
    { min: 4, border: '#6b7280', badgeBg: 'linear-gradient(135deg, #1f2937, #111827)', badgeBorder: 'var(--bg-dark)', fireColor: '#fbbf24', shadow: '0 2px 8px rgba(0, 0, 0, 0.5)', xp: 15 },
    { min: 1, border: 'var(--border-color)', badgeBg: 'linear-gradient(135deg, #1f2937, #111827)', badgeBorder: 'var(--bg-dark)', fireColor: '#fbbf24', shadow: '0 2px 8px rgba(0, 0, 0, 0.5)', xp: 10 },
    { min: 0, border: 'var(--border-color)', badgeBg: 'linear-gradient(135deg, #1f2937, #111827)', badgeBorder: 'var(--bg-dark)', fireColor: '#f59e0b', shadow: '0 2px 8px rgba(0, 0, 0, 0.5)', xp: 0 }
  ];
  for (const tier of streakTiers) {
    if (streakNum >= tier.min) return tier;
  }
  return streakTiers[streakTiers.length - 1];
}

// Fonction pour obtenir le prochain palier
function dbGetNextStreakTier(currentStreak) {
  const tiers = [1, 4, 10, 15, 20, 25];
  for (const tier of tiers) {
    if (currentStreak < tier) return tier;
  }
  return 25;
}

// Ouvrir le modal de qu√™te
function openDashboardQuestModal() {
  const modal = document.getElementById('dashboardQuestModal');
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    populateDashboardQuestModal();
  }
}

// Fermer le modal de qu√™te
function closeDashboardQuestModal() {
  const modal = document.getElementById('dashboardQuestModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
}

// Peupler le modal avec les donn√©es
async function populateDashboardQuestModal() {
  if (!dashboardCurrentQuest) return;

  const username = localStorage.getItem('username');
  const months = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];

  // Titre de la qu√™te actuelle
  const titleEl = document.getElementById('dbModalQuestTitle');
  if (titleEl) titleEl.textContent = dashboardCurrentQuest.title;

  // Calculer les dates de la semaine (lundi √† dimanche avant deadline)
  const deadline = new Date(dashboardCurrentQuest.deadline);
  const monday = new Date(deadline);
  monday.setDate(deadline.getDate() - 6);
  const sunday = new Date(deadline);

  const mondayStr = monday.getDate() + ' ' + months[monday.getMonth()];
  const sundayStr = sunday.getDate() + ' ' + months[sunday.getMonth()] + ' ' + sunday.getFullYear();
  const deadlineEl = document.getElementById('dbModalQuestDeadline');
  if (deadlineEl) deadlineEl.textContent = mondayStr + ' - ' + sundayStr;

  // Progression
  const progressCurrentEl = document.getElementById('dbModalQuestProgressCurrent');
  const progressTargetEl = document.getElementById('dbModalQuestProgressTarget');
  const progressFillEl = document.getElementById('dbModalQuestProgressFill');

  if (progressCurrentEl) {
    if (dashboardCurrentQuest.unit === '$' || dashboardCurrentQuest.unit === 'depot' || dashboardCurrentQuest.unit === 'ca_cumul' || dashboardCurrentQuest.unit === 'produit') {
      progressCurrentEl.textContent = dashboardQuestProgress.current.toLocaleString('fr-CA');
    } else if (dashboardCurrentQuest.unit === 'taux') {
      progressCurrentEl.textContent = dashboardQuestProgress.current.toFixed(2);
    } else {
      progressCurrentEl.textContent = dashboardQuestProgress.current;
    }
  }
  if (progressTargetEl) progressTargetEl.textContent = dashboardCurrentQuest.target + ' ' + dashboardCurrentQuest.unit;
  if (progressFillEl) progressFillEl.style.width = dashboardQuestProgress.percent + '%';

  // Statut de la qu√™te
  const statusEl = document.getElementById('dbModalQuestStatus');
  if (statusEl && dashboardQuestProgress.percent >= 100) {
    const statusBadge = statusEl.querySelector('.status-badge');
    if (statusBadge) {
      statusBadge.textContent = 'Compl√©t√©e';
      statusBadge.className = 'status-badge status-completed';
    }
  }

  // XP selon le streak
  const xpEl = document.getElementById('dbModalQuestRewardXP');
  if (xpEl) {
    const xpValue = dbGetStreakStyle(dashboardStreak).xp || 10;
    xpEl.textContent = '+' + xpValue + ' XP';
  }

  // Indicateur streak dans r√©compenses
  const streakRewardEl = document.getElementById('dbModalStreakReward');
  if (streakRewardEl) {
    streakRewardEl.style.display = dashboardStreak > 0 ? 'flex' : 'none';
  }

  // Semaine prochaine
  if (dashboardNextQuest) {
    const nextDeadline = new Date(dashboardNextQuest.deadline);
    const nextMonday = new Date(nextDeadline);
    nextMonday.setDate(nextDeadline.getDate() - 6);
    const nextSunday = new Date(nextDeadline);

    const nextMondayStr = nextMonday.getDate() + ' ' + months[nextMonday.getMonth()];
    const nextSundayStr = nextSunday.getDate() + ' ' + months[nextSunday.getMonth()] + ' ' + nextSunday.getFullYear();

    const weekNumEl = document.getElementById('dbNextWeekNumber');
    if (weekNumEl) weekNumEl.textContent = nextMondayStr + ' - ' + nextSundayStr;

    const nextQuestTitleEl = document.getElementById('dbNextWeekQuestTitle');
    if (nextQuestTitleEl) nextQuestTitleEl.textContent = dashboardNextQuest.title;
  }

  // Section Streaks
  const streak = dashboardStreak;
  const currentStreakNumberEl = document.getElementById('dbCurrentStreakNumber');
  if (currentStreakNumberEl) currentStreakNumberEl.textContent = streak;

  // Photo de profil
  const profilePhotoUrl = `/cloud/signatures/${username}/profile_photo_${username}.png?v=${Date.now()}`;
  const defaultAvatar = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%239ca3af"%3E%3Cpath d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/%3E%3C/svg%3E';

  // R√©cup√©rer tous les √©l√©ments d'abord
  const currentStreakPhoto = document.getElementById('dbCurrentStreakPhoto');
  const currentStreakAvatar = document.getElementById('dbCurrentStreakAvatar');
  const currentStreakBadge = document.getElementById('dbCurrentStreakBadge');
  const currentStreakBadgeNum = document.getElementById('dbCurrentStreakBadgeNum');
  const nextStreak = dbGetNextStreakTier(streak);
  const nextStreakPhoto = document.getElementById('dbNextStreakPhoto');
  const nextStreakAvatar = document.getElementById('dbNextStreakAvatar');
  const nextStreakBadge = document.getElementById('dbNextStreakBadge');
  const nextStreakBadgeNum = document.getElementById('dbNextStreakBadgeNum');
  const nextStreakLabel = document.getElementById('dbNextStreakLabel');

  // Photos de profil
  if (currentStreakPhoto) {
    currentStreakPhoto.src = profilePhotoUrl;
    currentStreakPhoto.onerror = function() { this.src = defaultAvatar; };
  }
  if (nextStreakPhoto) {
    nextStreakPhoto.src = profilePhotoUrl;
    nextStreakPhoto.onerror = function() { this.src = defaultAvatar; };
  }

  // Badges streak
  if (currentStreakBadgeNum) currentStreakBadgeNum.textContent = streak;
  if (nextStreakBadgeNum) nextStreakBadgeNum.textContent = nextStreak;

  // Charger le grade de l'utilisateur pour le cadre
  try {
    const profileResponse = await fetch(`/api/gamification/profile/${username}`);
    if (profileResponse.ok) {
      const profileData = await profileResponse.json();
      if (profileData.status === 'success' && profileData.profile && profileData.profile.category) {
        const gradeClass = 'grade-' + profileData.profile.category.toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/\s+/g, '-');

        // Appliquer la classe de grade aux deux avatars (m√™me grade actuel)
        if (currentStreakAvatar) {
          currentStreakAvatar.className = 'flame-avatar ' + gradeClass;
        }
        if (nextStreakAvatar) {
          nextStreakAvatar.className = 'flame-avatar ' + gradeClass;
        }
      }
    }
  } catch (err) {
    console.log('[QUEST MODAL] Erreur chargement profil:', err);
  }

  // Style du badge streak actuel
  if (currentStreakBadge) {
    if (streak === 0) {
      currentStreakBadge.style.display = 'none';
    } else {
      currentStreakBadge.style.display = 'flex';
      const currentStyle = dbGetStreakStyle(streak);
      currentStreakBadge.style.background = currentStyle.badgeBg;
      currentStreakBadge.style.borderColor = currentStyle.badgeBorder;
      currentStreakBadge.style.boxShadow = currentStyle.shadow;
      const fireIcon = currentStreakBadge.querySelector('.fa-fire');
      if (fireIcon) fireIcon.style.color = currentStyle.fireColor;
    }
  }

  // Style du badge prochain palier
  if (nextStreakBadge) {
    const nextStyle = dbGetStreakStyle(nextStreak);
    nextStreakBadge.style.background = nextStyle.badgeBg;
    nextStreakBadge.style.borderColor = nextStyle.badgeBorder;
    nextStreakBadge.style.boxShadow = nextStyle.shadow;
    const nextFireIcon = nextStreakBadge.querySelector('.fa-fire');
    if (nextFireIcon) nextFireIcon.style.color = nextStyle.fireColor;
  }
  if (nextStreakLabel) {
    nextStreakLabel.textContent = 'Avec des Streaks';
    nextStreakLabel.style.color = '#fbbf24';
  }

  // Vue progression vs vue active
  const streakProgressView = document.getElementById('dbStreakProgressView');
  const streakActiveView = document.getElementById('dbStreakActiveView');
  if (streakProgressView) streakProgressView.style.display = 'flex';
  if (streakActiveView) streakActiveView.style.display = 'none';
}

(function() {
  const userRole = localStorage.getItem('userRole');

  // Afficher la banni√®re uniquement pour les entrepreneurs
  if (userRole === 'entrepreneur') {
    const questBanner = document.getElementById('quest-banner-float');
    if (questBanner) {
      questBanner.style.display = 'block';

      // Charger les donn√©es de la qu√™te actuelle
      loadCurrentQuestData();
    }
  }

  async function loadCurrentQuestData() {
    const username = localStorage.getItem('username');
    if (!username) return;

    // Trouver la qu√™te actuelle (premi√®re dont la deadline est dans le futur)
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    let foundCurrent = false;
    for (let i = 0; i < dashboardWeeklyQuests.length; i++) {
      const quest = dashboardWeeklyQuests[i];
      const questDate = new Date(quest.deadline);
      if (questDate > today) {
        if (!foundCurrent) {
          dashboardCurrentQuest = quest;
          foundCurrent = true;
          // Trouver la prochaine qu√™te
          if (i + 1 < dashboardWeeklyQuests.length) {
            dashboardNextQuest = dashboardWeeklyQuests[i + 1];
          }
          break;
        }
      }
    }

    if (!dashboardCurrentQuest) {
      document.getElementById('dashboardQuestTitle').textContent = 'Aucune qu√™te';
      return;
    }

    // Afficher le titre de la qu√™te
    document.getElementById('dashboardQuestTitle').textContent = dashboardCurrentQuest.title;

    // Charger la progression et le streak depuis l'API gamification
    try {
      const response = await fetch(`/api/gamification/quest-progress/${username}?quest_date=${dashboardCurrentQuest.deadline}`);
      if (response.ok) {
        const data = await response.json();
        if (data.status === 'success') {
          // R√©cup√©rer le streak
          dashboardStreak = data.streak || 0;

          // Calculer la progression selon le type de qu√™te
          let current = 0;
          switch (dashboardCurrentQuest.unit) {
            case 'heures':
              current = data.progress.h_marketing || 0;
              break;
            case 'estimations':
              current = data.progress.estimation || 0;
              break;
            case '$':
              current = data.progress.dollar || 0;
              break;
            case 'taux':
              current = data.progress.taux_marketing || 0;
              break;
            case 'depot':
              current = data.progress.depot || 0;
              break;
            case 'peintre':
              current = data.progress.peintre || 0;
              break;
            case 'ca_cumul':
              current = data.progress.ca_cumul || 0;
              break;
            case 'produit':
              current = data.progress.produit || 0;
              break;
            case 'productivit√©':
              current = data.progress.prod_horaire || 0;
              break;
            case '√©toiles':
              current = data.progress.satisfaction || 0;
              break;
            case 'contrats':
              current = data.progress.contract || 0;
              break;
            default:
              current = 0;
          }

          // Stocker la progression
          dashboardQuestProgress.current = current;
          dashboardQuestProgress.percent = Math.min(100, (current / dashboardCurrentQuest.target) * 100);

          // Mettre √† jour la banni√®re
          document.getElementById('dashboardQuestProgress').style.width = dashboardQuestProgress.percent + '%';
        }
      }
    } catch (err) {
      console.log('[QUEST BANNER] Erreur chargement API:', err);
    }
  }
})();

// Fermer le modal avec Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeDashboardQuestModal();
  }
});
</script>

</body>
</html>

