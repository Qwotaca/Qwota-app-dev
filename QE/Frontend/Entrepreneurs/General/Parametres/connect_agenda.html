<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Param√®tres</title>
  
  <!-- üì± PWA Meta Tags Enhanced for Mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Qwota">
  <meta name="msapplication-TileColor" content="#1f2937">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Ic√¥nes PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

  <!-- Scripts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link rel="icon" href="/favicon" type="image/x-icon" />

  <!-- Script commun en premier pour v√©rification onboarding -->
  <script src="/common.js"></script>

  <!-- Feuille de style principale - Th√®me Dark Organis√© -->
  <link rel="stylesheet" href="/base.css">

  <!-- Styles sp√©cifiques √† la page Connect Agenda -->
  <link rel="stylesheet" href="/connect_agenda.css">

  <!-- Styles tablette - bas√© sur largeur iframe (pas √©cran) -->
  <style>
    /* 2 colonnes d√®s 600px (iframe peut √™tre plus petit que l'√©cran) */
    @media (min-width: 600px) {
      /* Grille compl√©tion profil en 2 colonnes */
      #profile-progress-steps {
        grid-template-columns: repeat(2, 1fr) !important;
      }

      /* Header compl√©tion profil horizontal */
      #profile-progress-header {
        flex-direction: row !important;
        align-items: center !important;
      }

      /* Box header horizontal (boutons √† droite) */
      .box-header {
        flex-direction: row !important;
        align-items: center !important;
        justify-content: space-between !important;
      }
    }

    /* 3 colonnes sur grand √©cran (1000px+) */
    @media (min-width: 1000px) {
      #profile-progress-steps {
        grid-template-columns: repeat(3, 1fr) !important;
      }
    }

    /* Padding en bas sur tablette pour s√©curit√© */
    @media (min-width: 600px) and (max-width: 1366px) {
      .main-content {
        padding-bottom: 4rem !important;
      }
    }
  </style>

</head>

<body class="min-h-screen" style="margin: 0; padding: 0;">

  <!-- Contenu principal -->
  <div class="main-content w-full" style="width: 100%; padding: 2rem;">
    <div class="w-full">

      <!-- Section Title: Param√®tres -->
      <div class="mb-10 mt-5 md:mt-0">
        <div class="relative">
          <h1 class="text-4xl font-bold mb-3" style="color: var(--text-light);">
            Param√®tres
          </h1>
          <span class="absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-blue-600 to-blue-400 rounded-full"></span>
          <div class="flex items-center justify-between">
            <p class="text-xl font-medium" style="color: var(--text-gray);">
              <span>G√©rez votre profil et vos connexions</span>
            </p>
          </div>
        </div>
      </div>

      <!-- Widget de progression du profil -->
      <div class="card p-6 mb-6" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(59, 130, 246, 0.05)); border: 1px solid rgba(59, 130, 246, 0.2);">
        <!-- En-t√™te avec progression globale -->
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6 cursor-pointer" id="profile-progress-header" onclick="toggleProfileProgress()">
          <div class="flex items-center gap-4">
            <div class="relative w-16 h-16">
              <!-- Cercle de progression -->
              <svg class="transform -rotate-90 w-16 h-16">
                <circle cx="32" cy="32" r="28" stroke="rgba(59, 130, 246, 0.2)" stroke-width="4" fill="none" />
                <circle id="progress-circle" cx="32" cy="32" r="28" stroke="#3b82f6" stroke-width="4" fill="none"
                  stroke-dasharray="176" stroke-dashoffset="176" stroke-linecap="round"
                  style="transition: stroke-dashoffset 0.5s ease;" />
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span id="progress-percent" class="text-sm font-bold" style="color: var(--text-light);">0%</span>
              </div>
            </div>
            <div>
              <h3 class="text-lg font-bold mb-1" style="color: var(--text-light);">Compl√©tion du profil</h3>
              <p class="text-sm" style="color: var(--text-gray);">
                <span id="completed-steps">0</span>/6 √©tapes termin√©es
              </p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 px-4 py-2 rounded-lg" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3);">
              <i class="fas fa-trophy text-yellow-500"></i>
              <span class="text-sm font-semibold" style="color: var(--text-light);" id="profile-status">Profil en cours</span>
            </div>
            <i id="profile-progress-chevron" class="fas fa-chevron-down text-lg" style="color: var(--text-gray); transition: transform 0.3s ease;"></i>
          </div>
        </div>

        <!-- Grille des √©tapes -->
        <div id="profile-progress-steps" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out, margin-top 0.3s ease;">
          <!-- √âtape 1: Connexion -->
          <div class="step-card p-4 rounded-lg" style="background: var(--bg-card); border: 1px solid var(--border-dark);">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(59, 130, 246, 0.2);">
                  <i class="fas fa-plug text-blue-500"></i>
                </div>
                <div>
                  <h4 class="text-sm font-semibold" style="color: var(--text-light);">Connexion</h4>
                  <p class="text-xs" style="color: var(--text-gray);" id="connection-status-text">Gmail, Agenda</p>
                </div>
              </div>
              <div class="step-check" data-step="connection">
                <i class="fas fa-check-circle text-green-500 text-lg"></i>
              </div>
            </div>
            <div class="h-1.5 rounded-full overflow-hidden" style="background: rgba(59, 130, 246, 0.2);">
              <div id="connection-progress-bar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: #22c55e;"></div>
            </div>
            <p class="text-xs font-semibold mt-2 text-green-500" id="connection-progress-percent">0%</p>
          </div>

          <!-- √âtape 2: Grade -->
          <div class="step-card p-4 rounded-lg" style="background: var(--bg-card); border: 1px solid var(--border-dark);">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(59, 130, 246, 0.2);">
                  <i class="fas fa-star text-blue-500"></i>
                </div>
                <div>
                  <h4 class="text-sm font-semibold" style="color: var(--text-light);">Grade</h4>
                  <p class="text-xs" style="color: var(--text-gray);">Niveau s√©lectionn√©</p>
                </div>
              </div>
              <div class="step-check" data-step="grade">
                <i class="fas fa-circle text-gray-500 text-lg"></i>
              </div>
            </div>
            <div class="h-1.5 rounded-full overflow-hidden" style="background: rgba(59, 130, 246, 0.2);">
              <div id="grade-progress-bar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: #3b82f6;"></div>
            </div>
            <div class="flex items-center justify-between mt-2">
              <p id="grade-progress-text" class="text-xs font-semibold" style="color: var(--text-gray);">0%</p>
              <button onclick="scrollToSection('grade')" class="text-xs px-2 py-1 rounded transition-all hover:bg-blue-500/20" style="color: #3b82f6; display: none;" id="grade-complete-btn">
                <i class="fas fa-arrow-down mr-1"></i>Compl√©ter
              </button>
            </div>
          </div>

          <!-- √âtape 3: Info personnelles -->
          <div class="step-card p-4 rounded-lg" style="background: var(--bg-card); border: 1px solid var(--border-dark);">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(59, 130, 246, 0.2);">
                  <i class="fas fa-user text-blue-500"></i>
                </div>
                <div>
                  <h4 class="text-sm font-semibold" style="color: var(--text-light);">Info personnelles</h4>
                  <p class="text-xs" style="color: var(--text-gray);">Nom, t√©l√©phone, etc.</p>
                </div>
              </div>
              <div class="step-check" data-step="personal">
                <i class="fas fa-circle text-gray-500 text-lg"></i>
              </div>
            </div>
            <div class="h-1.5 rounded-full overflow-hidden" style="background: rgba(59, 130, 246, 0.2);">
              <div id="personal-progress-bar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: #3b82f6;"></div>
            </div>
            <div class="flex items-center justify-between mt-2">
              <p id="personal-progress-text" class="text-xs font-semibold" style="color: var(--text-gray);">0%</p>
              <button onclick="scrollToSection('personal')" class="text-xs px-2 py-1 rounded transition-all hover:bg-blue-500/20" style="color: #3b82f6; display: none;" id="personal-complete-btn">
                <i class="fas fa-arrow-down mr-1"></i>Compl√©ter
              </button>
            </div>
          </div>

          <!-- √âtape 4: Info entreprise -->
          <div class="step-card p-4 rounded-lg" style="background: var(--bg-card); border: 1px solid var(--border-dark);">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(59, 130, 246, 0.2);">
                  <i class="fas fa-building text-blue-500"></i>
                </div>
                <div>
                  <h4 class="text-sm font-semibold" style="color: var(--text-light);">Info entreprise</h4>
                  <p class="text-xs" style="color: var(--text-gray);">NEQ, TPS, TVQ</p>
                </div>
              </div>
              <div class="step-check" data-step="business">
                <i class="fas fa-circle text-gray-500 text-lg"></i>
              </div>
            </div>
            <div class="h-1.5 rounded-full overflow-hidden" style="background: rgba(59, 130, 246, 0.2);">
              <div id="business-progress-bar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: #3b82f6;"></div>
            </div>
            <div class="flex items-center justify-between mt-2">
              <p id="business-progress-text" class="text-xs font-semibold" style="color: var(--text-gray);">0%</p>
              <button onclick="scrollToSection('business')" class="text-xs px-2 py-1 rounded transition-all hover:bg-blue-500/20" style="color: #3b82f6; display: none;" id="business-complete-btn">
                <i class="fas fa-arrow-down mr-1"></i>Compl√©ter
              </button>
            </div>
          </div>

          <!-- √âtape 5: Documents -->
          <div class="step-card p-4 rounded-lg" style="background: var(--bg-card); border: 1px solid var(--border-dark);">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(59, 130, 246, 0.2);">
                  <i class="fas fa-file-alt text-blue-500"></i>
                </div>
                <div>
                  <h4 class="text-sm font-semibold" style="color: var(--text-light);">Documents</h4>
                  <p class="text-xs" style="color: var(--text-gray);">Ch√®que, formulaires</p>
                </div>
              </div>
              <div class="step-check" data-step="documents">
                <i class="fas fa-circle text-gray-500 text-lg"></i>
              </div>
            </div>
            <div class="h-1.5 rounded-full overflow-hidden" style="background: rgba(59, 130, 246, 0.2);">
              <div id="documents-progress-bar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: #3b82f6;"></div>
            </div>
            <div class="flex items-center justify-between mt-2">
              <p id="documents-progress-text" class="text-xs font-semibold" style="color: var(--text-gray);">0%</p>
              <button onclick="scrollToSection('documents')" class="text-xs px-2 py-1 rounded transition-all hover:bg-blue-500/20" style="color: #3b82f6; display: none;" id="documents-complete-btn">
                <i class="fas fa-arrow-down mr-1"></i>Compl√©ter
              </button>
            </div>
          </div>

          <!-- √âtape 6: Signature & Photo -->
          <div class="step-card p-4 rounded-lg" style="background: var(--bg-card); border: 1px solid var(--border-dark);">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(59, 130, 246, 0.2);">
                  <i class="fas fa-signature text-blue-500"></i>
                </div>
                <div>
                  <h4 class="text-sm font-semibold" style="color: var(--text-light);">Signature & Photo</h4>
                  <p class="text-xs" style="color: var(--text-gray);">Personnalisation</p>
                </div>
              </div>
              <div class="step-check" data-step="signature">
                <i class="fas fa-circle text-gray-500 text-lg"></i>
              </div>
            </div>
            <div class="h-1.5 rounded-full overflow-hidden" style="background: rgba(59, 130, 246, 0.2);">
              <div id="signature-progress-bar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: #3b82f6;"></div>
            </div>
            <div class="flex items-center justify-between mt-2">
              <p id="signature-progress-text" class="text-xs font-semibold" style="color: var(--text-gray);">0%</p>
              <button onclick="scrollToSection('signature')" class="text-xs px-2 py-1 rounded transition-all hover:bg-blue-500/20" style="color: #3b82f6; display: none;" id="signature-complete-btn">
                <i class="fas fa-arrow-down mr-1"></i>Compl√©ter
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Section Title: Connexions -->
      <div class="mb-8 mt-5 md:mt-0">
        <h1 class="text-xl md:text-2xl font-bold mb-2" style="color: var(--text-light);">Connexions</h1>
        <p class="text-sm md:text-base" style="color: var(--text-gray);">G√©rez vos connexions Agenda et Courriel pour synchroniser vos donn√©es.</p>
      </div>

      <!-- Connexions Agenda et Email c√¥te √† c√¥te -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">

        <!-- Connexion Google Agenda - Gauche -->
        <div class="card p-4 h-auto md:h-72 flex flex-col">
          <!-- Header avec logo gauche et √©tiquette droite -->
          <div class="flex flex-col md:flex-row md:items-start md:justify-between mb-4 gap-3">
            <div class="flex items-center gap-3">
              <img src="https://i.ibb.co/8L05RDTV/Google-Calendar-icon-2020-svg-1.png" class="h-10 md:h-12 w-10 md:w-12" />
              <div>
                <h2 class="text-base md:text-lg font-semibold" style="color: var(--text-light);">Google Agenda</h2>
                <p class="text-xs md:text-sm" style="color: var(--text-gray);">Synchronisation des calendriers</p>
              </div>
            </div>
            <!-- √âtiquette √©tat -->
            <div class="flex md:justify-end">
              <div id="agenda-status-disconnected" class="inline-block bg-yellow-500 text-yellow-900 px-2 md:px-3 py-1 rounded-full text-xs font-medium">
                Connexion n√©cessaire
              </div>
              <div id="agenda-status-connected" class="hidden inline-block bg-green-500 text-green-900 px-2 md:px-3 py-1 rounded-full text-xs font-medium">
                Connect√©
              </div>
            </div>
          </div>

          <!-- Contenu flexible -->
          <div class="flex-1">
            <!-- Email connect√© (visible quand connect√©) -->
            <div id="agenda-connected-info" class="hidden">
              <p id="user-email" class="text-sm mb-2 truncate" style="color: var(--text-gray);">...</p>
              <p class="text-xs mb-2" style="color: var(--text-gray);">S√©lectionnez votre agenda principal</p>
              <div class="custom-select" id="agenda-select">
                <button type="button" class="custom-select-button" id="agenda-select-button">
                  <span class="custom-select-text" id="agenda-selected-text" style="color: var(--text-gray);">Choisir un agenda...</span>
                  <i class="fas fa-chevron-down custom-select-arrow"></i>
                </button>
                <div class="custom-select-dropdown" id="dropdown-secondary-menu">
                  <!-- Options g√©n√©r√©es dynamiquement -->
                </div>
              </div>
            </div>
          </div>

          <!-- Bouton en bas -->
          <div class="mt-6">
            <div id="agenda-disconnected" class="text-left md:text-right">
              <button id="agendaBtn" class="btn-primary text-sm px-4 py-2 md:w-auto">
                Se connecter
              </button>
            </div>
            <div id="calendar-box" class="hidden text-left md:text-right">
              <button id="agendaBtnDisconnect" class="btn-secondary text-sm px-4 py-2 md:w-auto">
                D√©connecter
              </button>
            </div>
          </div>
        </div>

        <!-- Connexion Email - Droite -->
        <div class="card p-4 h-auto md:h-72 flex flex-col">
          <!-- Header avec logo gauche et √©tiquette droite -->
          <div class="flex flex-col md:flex-row md:items-start md:justify-between mb-4 gap-3">
            <div class="flex items-center gap-3">
              <img src="https://i.ibb.co/QvyDxXp3/Design-sans-titre-71.png" class="h-10 md:h-12 w-10 md:w-12" />
              <div>
                <h2 class="text-base md:text-lg font-semibold" style="color: var(--text-light);">Gmail</h2>
                <p class="text-xs md:text-sm" style="color: var(--text-gray);">Envoi automatique des soumissions</p>
              </div>
            </div>
            <!-- √âtiquette √©tat -->
            <div class="flex md:justify-end">
              <div id="email-status-disconnected" class="inline-block bg-yellow-500 text-yellow-900 px-2 md:px-3 py-1 rounded-full text-xs font-medium">
                Connexion n√©cessaire
              </div>
              <div id="email-status-connected" class="hidden inline-block bg-green-500 text-green-900 px-2 md:px-3 py-1 rounded-full text-xs font-medium">
                Connect√©
              </div>
            </div>
          </div>

          <!-- Contenu flexible -->
          <div class="flex-1">
            <!-- Email connect√© (visible quand connect√©) -->
            <div id="gmail-box" class="hidden">
              <p id="gmail-email" class="text-sm truncate" style="color: var(--text-gray);">...</p>
            </div>
          </div>

          <!-- Bouton en bas -->
          <div class="mt-6">
            <div id="email-disconnected" class="text-left md:text-right">
              <div id="email-buttons">
                <button onclick="connectGmail()" class="btn-primary text-sm px-4 py-2 md:w-auto">
                  Se connecter
                </button>
              </div>
            </div>
            <div id="email-connected-actions" class="hidden text-left md:text-right">
              <button id="email-disconnect" onclick="disconnectGmail()" class="btn-secondary text-sm px-4 py-2 md:w-auto">
                D√©connecter
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Connexion Monday.com - Nouvelle section (HIDDEN FOR NOW) -->
      <div id="monday-section-title" class="mb-8 mt-12" style="display: none;">
        <h1 class="text-xl md:text-2xl font-bold mb-2" style="color: var(--text-light);">Int√©gration Monday.com</h1>
        <p class="text-sm md:text-base" style="color: var(--text-gray);">Synchronisez vos clients et ventes avec votre board Monday.com personnel.</p>
      </div>

      <div id="monday-section-card" class="card p-6" style="display: none;">
        <!-- Header avec logo et statut -->
        <div class="flex flex-col md:flex-row md:items-start md:justify-between mb-6 gap-3">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center overflow-hidden" style="background: white;">
              <img src="https://i.ibb.co/Z6kNyHsg/monday-200x200-1.png" alt="Monday.com" class="w-full h-full object-cover" />
            </div>
            <div>
              <h2 class="text-lg font-semibold" style="color: var(--text-light);">Monday.com</h2>
              <p class="text-sm" style="color: var(--text-gray);">Gestion de projets et clients</p>
            </div>
          </div>
          <!-- √âtiquette √©tat -->
          <div class="flex md:justify-end">
            <div id="monday-status-disconnected" class="inline-block bg-yellow-500 text-yellow-900 px-3 py-1 rounded-full text-xs font-medium">
              Non connect√©
            </div>
            <div id="monday-status-connected" class="hidden inline-block bg-green-500 text-green-900 px-3 py-1 rounded-full text-xs font-medium">
              Connect√©
            </div>
          </div>
        </div>

        <!-- Formulaire de configuration -->
        <div id="monday-config-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">
              <i class="fas fa-key mr-2"></i>Cl√© API Monday.com
            </label>
            <input
              type="password"
              id="monday-api-key"
              placeholder="Entrez votre cl√© API Monday.com"
              class="w-full px-4 py-3 rounded-lg text-sm transition-all"
              style="background: var(--bg-input); border: 1px solid var(--border-dark); color: var(--text-light);"
            />
            <p class="text-xs mt-1" style="color: var(--text-gray);">
              <i class="fas fa-info-circle mr-1"></i>
              Trouvez votre cl√© API dans Monday.com ‚Üí Avatar ‚Üí Developers ‚Üí API
            </p>
          </div>

          <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">
              <i class="fas fa-table mr-2"></i>ID du Board
            </label>
            <input
              type="text"
              id="monday-board-id"
              placeholder="Ex: 1234567890"
              class="w-full px-4 py-3 rounded-lg text-sm transition-all"
              style="background: var(--bg-input); border: 1px solid var(--border-dark); color: var(--text-light);"
            />
            <p class="text-xs mt-1" style="color: var(--text-gray);">
              <i class="fas fa-info-circle mr-1"></i>
              L'ID du board se trouve dans l'URL: monday.com/boards/<strong>1234567890</strong>
            </p>
          </div>

          <!-- Info sur les donn√©es synchronis√©es -->
          <div class="p-4 rounded-lg" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3);">
            <h4 class="text-sm font-semibold mb-2" style="color: var(--text-light);">
              <i class="fas fa-sync-alt mr-2"></i>Donn√©es synchronis√©es
            </h4>
            <ul class="text-xs space-y-1" style="color: var(--text-gray);">
              <li><i class="fas fa-check text-green-500 mr-2"></i>Clients et prospects</li>
              <li><i class="fas fa-check text-green-500 mr-2"></i>Ventes accept√©es et en production</li>
              <li><i class="fas fa-check text-green-500 mr-2"></i>Statuts et informations de contact</li>
            </ul>
          </div>
        </div>

        <!-- Info connect√© -->
        <div id="monday-connected-info" class="hidden">
          <div class="p-4 rounded-lg mb-4" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3);">
            <p class="text-sm" style="color: var(--text-light);">
              <i class="fas fa-check-circle text-green-500 mr-2"></i>
              Monday.com est connect√© et synchronis√©
            </p>
            <p class="text-xs mt-1" style="color: var(--text-gray);">
              Board: <span id="monday-board-name" class="font-semibold" style="color: var(--text-light);">-</span>
            </p>
          </div>

          <!-- Bouton d√©connecter (visible uniquement quand connect√©) -->
          <div class="text-left md:text-right">
            <button
              onclick="disconnectMonday()"
              class="btn-secondary text-sm px-4 py-2 md:w-auto"
            >
              D√©connecter
            </button>
          </div>
        </div>

        <!-- Boutons actions (visibles uniquement quand d√©connect√©) -->
        <div id="monday-action-buttons" class="flex gap-3 mt-6">
          <button
            id="monday-test-btn"
            onclick="testMondayConnection()"
            class="btn-secondary text-sm px-4 py-2 flex items-center gap-2"
          >
            <i class="fas fa-plug"></i>
            Tester la connexion
          </button>
          <button
            id="monday-save-btn"
            onclick="saveMondayConfig()"
            class="btn-primary text-sm px-4 py-2 flex items-center gap-2"
          >
            <i class="fas fa-save"></i>
            Sauvegarder
          </button>
        </div>
      </div>

      <!-- Section Title: Gestion √©quipe & Information -->
      <div class="mb-8 mt-12">
        <h1 class="text-xl md:text-2xl font-bold mb-2" style="color: var(--text-light);">Gestion √©quipe & Information</h1>
        <p class="text-sm md:text-base" style="color: var(--text-gray);">Organisez vos √©quipes, g√©rez vos informations d'entreprise et votre signature.</p>
      </div>

      <!-- Gestion √©quipes -->
      <div id="teams-container" class="box mt-6">
        <div class="box-header">
          <div class="flex items-center gap-3">
            <div class="box-header-icon" style="background: linear-gradient(135deg, rgb(59, 130, 246), rgb(59, 130, 246));">
              <i class="fas fa-users text-white" style="font-size: 1.25rem;"></i>
            </div>
            <h2 class="text-lg md:text-xl font-semibold" style="color: var(--text-light);">Gestion des √©quipes</h2>
          </div>
          <div class="flex gap-2" style="width: auto;">
            <button id="add-team-btn" onclick="addNewTeam()" class="btn-secondary px-4 py-2 text-sm" style="display: none; width: auto;">
              + Ajouter une √©quipe
            </button>
            <button id="edit-teams-btn" onclick="toggleEditTeams()" class="btn-primary px-4 py-2 text-sm" style="width: auto;">
              Modifier
            </button>
          </div>
        </div>
        <div id="teams-list" class="space-y-4" style="padding: 0.5rem;"></div>
      </div>

      <!-- Section Title: Informations personnelles -->
      <div class="mb-8 mt-12">
        <h1 class="text-xl md:text-2xl font-bold mb-2" style="color: var(--text-light);">Informations personnelles</h1>
        <p class="text-sm md:text-base" style="color: var(--text-gray);">G√©rez vos informations personnelles, votre signature, photo de profil et informations d'entreprise.</p>
      </div>

      <!-- S√©lection du grade -->
      <div class="card p-4 mt-6">
        <h2 class="text-lg md:text-xl font-semibold mb-4" style="color: var(--text-light);">S√©lectionner votre grade</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <button id="grade-recrue" class="grade-btn px-4 py-3 rounded-lg border-2 transition-all duration-200"
                  style="border-color: var(--border-dark); background: rgba(30, 41, 59, 0.3);"
                  onclick="selectGrade('recrue')">
            <div class="text-sm font-medium" style="color: var(--text-light);">Recrue</div>
          </button>
          <button id="grade-senior1" class="grade-btn px-4 py-3 rounded-lg border-2 transition-all duration-200"
                  style="border-color: var(--border-dark); background: rgba(30, 41, 59, 0.3);"
                  onclick="selectGrade('senior1')">
            <div class="text-sm font-medium" style="color: var(--text-light);">Senior <span style="position: relative; top: -1.5px;">|</span> 1</div>
          </button>
          <button id="grade-senior2" class="grade-btn px-4 py-3 rounded-lg border-2 transition-all duration-200"
                  style="border-color: var(--border-dark); background: rgba(30, 41, 59, 0.3);"
                  onclick="selectGrade('senior2')">
            <div class="text-sm font-medium" style="color: var(--text-light);">Senior <span style="position: relative; top: -1.5px;">|</span> 2</div>
          </button>
          <button id="grade-senior3" class="grade-btn px-4 py-3 rounded-lg border-2 transition-all duration-200"
                  style="border-color: var(--border-dark); background: rgba(30, 41, 59, 0.3);"
                  onclick="selectGrade('senior3')">
            <div class="text-sm font-medium" style="color: var(--text-light);">Senior <span style="position: relative; top: -1.5px;">|</span> 3</div>
          </button>
        </div>
      </div>

      <!-- Mes informations -->
      <div id="mes-informations-section" class="box mt-6">
        <div class="box-header">
          <div class="flex items-center gap-3">
            <div class="box-header-icon" style="background: linear-gradient(135deg, rgb(59, 130, 246), rgb(59, 130, 246));">
              <i class="fas fa-user text-white" style="font-size: 1.1rem;"></i>
            </div>
            <h2 class="text-lg md:text-xl font-semibold" style="color: var(--text-light);">Mes informations</h2>
          </div>
          <button id="edit-info-btn" onclick="toggleEditInfo()" class="btn-primary px-4 py-2 text-sm" style="width: auto;">
            Modifier
          </button>
        </div>

        <div class="flex flex-col gap-4" style="padding: 1.5rem;">
          <!-- Sous-titre: Information personnelle -->
          <div class="mb-2 mt-2">
            <h3 class="text-base md:text-lg font-semibold flex items-center gap-2" style="color: var(--text-light);">
              <i class="fas fa-user text-blue-500"></i>
              Information personnelle
            </h3>
            <div class="h-px mt-2" style="background: var(--border-dark);"></div>
          </div>

          <!-- Nom + Pr√©nom (50/50) -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Nom</label>
              <input type="text" id="nom" autocomplete="off"
                class="w-full border rounded p-2 shadow-sm info-field"
                placeholder="Nom" disabled>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Pr√©nom</label>
              <input type="text" id="prenom" autocomplete="off"
                class="w-full border rounded p-2 shadow-sm info-field"
                placeholder="Pr√©nom" disabled>
            </div>
          </div>

          <!-- T√©l√©phone + Courriel (50/50) -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Num√©ro de t√©l√©phone</label>
              <input type="tel" id="telephone" autocomplete="off"
                class="w-full border rounded p-2 shadow-sm info-field"
                placeholder="514-029-2001"
                maxlength="12" disabled>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Courriel</label>
              <input type="email" id="courriel" autocomplete="off"
                class="w-full border rounded p-2 shadow-sm info-field"
                placeholder="votre@email.com" disabled>
            </div>
          </div>

          <!-- Sous-titre: Information entreprise -->
          <div class="mb-2 mt-4">
            <h3 class="text-base md:text-lg font-semibold flex items-center gap-2" style="color: var(--text-light);">
              <i class="fas fa-building text-green-500"></i>
              Information entreprise
            </h3>
            <div class="h-px mt-2" style="background: var(--border-dark);"></div>
          </div>

          <!-- Message si information entreprise vide -->
          <div id="business-empty-warning" class="mb-4 p-3 rounded-lg" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); display: none;">
            <p class="text-sm flex items-center gap-2" style="color: #f59e0b;">
              <i class="fas fa-exclamation-triangle"></i>
              Veuillez remplir les informations entreprise pour compl√©ter votre profil.
            </p>
          </div>

          <!-- NEQ + TPS + TVQ (m√™me ligne) -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">NEQ</label>
              <input type="text" id="neq"
                class="w-full border rounded p-2 shadow-sm info-field"
                placeholder="Num√©ro d'entreprise du Qu√©bec" disabled>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Num√©ro TPS</label>
              <input type="text" id="tps"
                class="w-full border rounded p-2 shadow-sm info-field"
                placeholder="Num√©ro TPS" disabled>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Num√©ro TVQ</label>
              <input type="text" id="tvq"
                class="w-full border rounded p-2 shadow-sm info-field"
                placeholder="Num√©ro TVQ" disabled>
            </div>
          </div>

          <!-- Message si documents vides -->
          <div id="documents-empty-warning" class="mb-4 p-3 rounded-lg" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); display: none;">
            <p class="text-sm flex items-center gap-2" style="color: #f59e0b;">
              <i class="fas fa-exclamation-triangle"></i>
              Veuillez t√©l√©verser les documents requis pour compl√©ter votre profil.
            </p>
          </div>

          <!-- Sp√©cimen ch√®que -->
          <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Sp√©cimen ch√®que</label>
            <div class="flex items-center gap-3">
              <input type="file" id="specimen" class="hidden info-file-input" onchange="previewFile('specimen', this)" disabled>
              <label for="specimen" id="specimen-label" class="btn-secondary cursor-pointer file-upload-btn">Choisir un fichier</label>
              <div id="specimen-preview" class="hidden relative inline-block">
                <a href="#" target="_blank" class="file-preview-link">
                  <img class="h-12 rounded shadow" />
                </a>
                <button type="button" onclick="removeFile('specimen')" class="file-remove-btn absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center shadow hover:bg-red-700">
                  ‚úï
                </button>
              </div>
            </div>
          </div>

          <!-- Formulaire B√©tonel -->
          <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Formulaire B√©tonel</label>
            <div class="flex items-center gap-3">
              <input type="file" id="betonel" class="hidden info-file-input" onchange="previewFile('betonel', this)" disabled>
              <label for="betonel" id="betonel-label" class="btn-secondary cursor-pointer file-upload-btn">Choisir un fichier</label>
              <div id="betonel-preview" class="hidden relative inline-block">
                <a href="#" target="_blank" class="file-preview-link">
                  <img class="h-12 rounded shadow" />
                </a>
                <button type="button" onclick="removeFile('betonel')" class="file-remove-btn absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center shadow hover:bg-red-700">
                  ‚úï
                </button>
              </div>
            </div>
          </div>

          <!-- Compl√©ter l'int√©gration -->
          <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Compl√©ter l'int√©gration</label>
            <div class="flex items-center gap-3">
              <input type="file" id="integration" class="hidden info-file-input" onchange="previewFile('integration', this)" disabled>
              <label for="integration" id="integration-label" class="btn-secondary cursor-pointer file-upload-btn">Choisir un fichier</label>
              <div id="integration-preview" class="hidden relative inline-block">
                <a href="#" target="_blank" class="file-preview-link">
                  <img class="h-12 rounded shadow" />
                </a>
                <button type="button" onclick="removeFile('integration')" class="file-remove-btn absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center shadow hover:bg-red-700">
                  ‚úï
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section Ma signature & Photo de profil (en 50/50) -->
      <div class="flex flex-col md:flex-row gap-6 mt-6">
        <!-- Ma signature (50%) -->
        <div class="box w-full md:w-1/2">
          <div class="box-header">
            <div class="flex items-center gap-3">
              <div class="box-header-icon" style="background: linear-gradient(135deg, rgb(139, 92, 246), rgb(139, 92, 246));">
                <i class="fas fa-signature text-white" style="font-size: 1.1rem;"></i>
              </div>
              <h2 class="text-lg md:text-xl font-semibold" style="color: var(--text-light);">Ma signature</h2>
            </div>
          </div>
          <div style="padding: 1.5rem;">
          <p class="text-sm mb-4" style="color: var(--text-gray);">
            <i class="fas fa-info-circle mr-2"></i>
            La signature sera utilis√©e dans les soumissions envoy√©es aux clients uniquement.
          </p>

          <div id="signature-container" class="flex flex-col gap-3" style="width: 100%;">
            <div id="signature-drawing-mode" style="width: 100%; max-width: 400px;">
              <canvas id="signature-pad" style="border: 1px solid var(--border-dark); border-radius: 6px; width: 100%; min-width: 280px; max-width: 400px; height: 150px; background-color: transparent; box-shadow: inset 0 1px 3px rgb(0 0 0 / 0.1); cursor: crosshair; touch-action: none;"></canvas>

              <div class="flex gap-3 mt-3 items-center">
                <button id="clear-signature-btn" class="btn-secondary">Effacer</button>
                <button id="save-signature-btn" class="btn-primary">Enregistrer</button>
              </div>
            </div>

            <div id="signature-saved-mode" class="hidden">
              <img id="signature-image" style="border: 1px solid var(--border-dark); border-radius: 6px; width: 100%; max-width: 400px; height: 150px !important; min-height: 150px !important; background-color: transparent; box-shadow: inset 0 1px 3px rgb(0 0 0 / 0.1); object-fit: contain;" />

              <div class="flex gap-3 mt-3">
                <button id="edit-signature-btn" class="btn-secondary">Modifier</button>
              </div>
            </div>
          </div>
          </div>
        </div>

        <!-- Photo de profil (50%) -->
        <div class="box w-full md:w-1/2">
          <div class="box-header">
            <div class="flex items-center gap-3">
              <div class="box-header-icon" style="background: linear-gradient(135deg, rgb(16, 185, 129), rgb(16, 185, 129));">
                <i class="fas fa-camera text-white" style="font-size: 1.1rem;"></i>
              </div>
              <h2 class="text-lg md:text-xl font-semibold" style="color: var(--text-light);">Photo de profil</h2>
            </div>
          </div>
          <div style="padding: 1.5rem;">
          <p class="text-sm mb-4" style="color: var(--text-gray);">
            <i class="fas fa-info-circle mr-2"></i>
            La photo sera affich√©e dans votre compte et sur votre profil.
          </p>

          <div class="flex flex-col items-start gap-4">
            <!-- Photo de profil circulaire -->
            <div id="profile-photo-display" class="relative">
              <div class="w-40 h-40 rounded-full overflow-hidden border-4 flex items-center justify-center" style="border-color: var(--primary-blue); background: var(--bg-dark);">
                <img id="profile-photo-image" src="" alt="Photo de profil" class="w-full h-full object-cover hidden" />
                <div id="profile-photo-placeholder" class="flex flex-col items-center justify-center">
                  <i class="fas fa-user text-5xl" style="color: var(--text-gray);"></i>
                </div>
              </div>
              <button id="photo-menu-btn" class="absolute bottom-0 right-0 w-10 h-10 rounded-full flex items-center justify-center" style="background: var(--primary-blue); color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                <i class="fas fa-camera"></i>
              </button>

              <!-- Menu dropdown pour la photo -->
              <div id="photo-menu-dropdown" class="hidden absolute bottom-12 right-0 rounded-lg shadow-lg z-10" style="background: var(--bg-card); border: 1px solid var(--border-dark); min-width: 260px;">
                <button id="camera-photo-option" class="w-full text-left px-5 py-3 flex items-center gap-3 hover:bg-opacity-80 transition-colors" style="color: var(--text-light);">
                  <i class="fas fa-camera" style="color: var(--primary-green);"></i>
                  <span>Prendre une photo</span>
                </button>
                <button id="upload-photo-option" class="w-full text-left px-5 py-3 flex items-center gap-3 hover:bg-opacity-80 transition-colors border-t" style="color: var(--text-light); border-color: var(--border-dark);">
                  <i class="fas fa-upload" style="color: var(--primary-blue);"></i>
                  <span>Modifier photo de profil</span>
                </button>
              </div>
            </div>

            <input type="file" id="profile-photo-input" accept="image/*" class="hidden" />
            <input type="file" id="camera-capture-input" accept="image/*" capture="environment" class="hidden" />
          </div>
          </div>
        </div>
      </div>

      <!-- Section Changer mot de passe (m√™me largeur que signature) -->
      <div class="flex flex-col md:flex-row gap-6 mt-6">
        <div id="change-password-section" class="box w-full md:w-[49%]">
          <div class="box-header">
          <div class="flex items-center gap-3">
            <div class="box-header-icon" style="background: linear-gradient(135deg, rgb(239, 68, 68), rgb(239, 68, 68));">
              <i class="fas fa-lock text-white" style="font-size: 1.1rem;"></i>
            </div>
            <h2 class="text-lg md:text-xl font-semibold" style="color: var(--text-light);">Changer mon mot de passe</h2>
          </div>
        </div>

        <div style="padding: 1.5rem;">
          <!-- Formulaire de changement de mot de passe -->
          <form id="change-password-form" onsubmit="handleChangePassword(event)">
            <!-- Mot de passe actuel -->
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">
                Mot de passe actuel
              </label>
              <div class="relative">
                <input type="password" id="current-password" required autocomplete="current-password"
                  class="w-full border rounded p-2 pr-10 text-sm"
                  style="background: var(--bg-dark); border-color: var(--border-dark); color: var(--text-light);"
                  placeholder="Mot de passe actuel"
                  oninput="validatePasswordForm()">
                <button type="button" onclick="togglePasswordVisibility('current-password')"
                  class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-300">
                  <i class="fas fa-eye text-sm"></i>
                </button>
              </div>
            </div>

            <!-- Nouveau mot de passe -->
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">
                Nouveau mot de passe
              </label>
              <div class="relative">
                <input type="password" id="new-password" required autocomplete="new-password"
                  class="w-full border rounded p-2 pr-10 text-sm"
                  style="background: var(--bg-dark); border-color: var(--border-dark); color: var(--text-light);"
                  placeholder="Nouveau mot de passe"
                  oninput="checkPasswordStrength(this.value); validatePasswordForm()">
                <button type="button" onclick="togglePasswordVisibility('new-password')"
                  class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-300">
                  <i class="fas fa-eye text-sm"></i>
                </button>
              </div>

              <!-- Indicateur de force du mot de passe -->
              <div class="mt-2">
                <div class="flex gap-1 mb-1">
                  <div id="strength-bar-1" class="h-1 flex-1 rounded-full" style="background: var(--border-dark);"></div>
                  <div id="strength-bar-2" class="h-1 flex-1 rounded-full" style="background: var(--border-dark);"></div>
                  <div id="strength-bar-3" class="h-1 flex-1 rounded-full" style="background: var(--border-dark);"></div>
                  <div id="strength-bar-4" class="h-1 flex-1 rounded-full" style="background: var(--border-dark);"></div>
                </div>
                <p id="password-strength-text" class="text-xs" style="color: var(--text-gray);">
                  Minimum 6 caract√®res
                </p>
              </div>

              <!-- Crit√®res du mot de passe -->
              <div class="mt-2 text-xs" style="color: var(--text-gray);">
                <div class="grid grid-cols-2 gap-1">
                  <span id="criteria-length" class="flex items-center gap-1">
                    <i class="fas fa-circle text-[6px]"></i> 6+ caract√®res
                  </span>
                  <span id="criteria-uppercase" class="flex items-center gap-1">
                    <i class="fas fa-circle text-[6px]"></i> Majuscule
                  </span>
                  <span id="criteria-lowercase" class="flex items-center gap-1">
                    <i class="fas fa-circle text-[6px]"></i> Minuscule
                  </span>
                  <span id="criteria-number" class="flex items-center gap-1">
                    <i class="fas fa-circle text-[6px]"></i> Chiffre
                  </span>
                </div>
              </div>
            </div>

            <!-- Confirmer nouveau mot de passe -->
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">
                Confirmer le mot de passe
              </label>
              <div class="relative">
                <input type="password" id="confirm-password" required autocomplete="new-password"
                  class="w-full border rounded p-2 pr-10 text-sm"
                  style="background: var(--bg-dark); border-color: var(--border-dark); color: var(--text-light);"
                  placeholder="Confirmer le mot de passe"
                  oninput="checkPasswordMatch(); validatePasswordForm()">
                <button type="button" onclick="togglePasswordVisibility('confirm-password')"
                  class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-300">
                  <i class="fas fa-eye text-sm"></i>
                </button>
              </div>
              <p id="password-match-text" class="text-xs mt-1" style="color: var(--text-gray); display: none;"></p>
            </div>

            <!-- Message d'erreur/succ√®s -->
            <div id="password-change-message" class="mb-4 p-2 rounded-lg text-sm" style="display: none;"></div>

            <!-- Bouton de soumission (d√©sactiv√© par d√©faut) -->
            <button type="submit" id="change-password-btn" disabled
              class="py-2 px-4 text-sm font-semibold flex items-center justify-center gap-2 rounded"
              style="background: #4b5563; color: #9ca3af; width: auto; cursor: not-allowed;">
              <i class="fas fa-key"></i>
              <span>Changer</span>
            </button>
          </form>
        </div>
        </div>
        <!-- Placeholder invisible pour l'alignement -->
        <div class="hidden md:block w-full md:w-[49%]"></div>
      </div>

      <!-- Modal d'√©dition de photo de profil -->
      <div id="photo-editor-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center" style="background: rgba(0,0,0,0.8);">
        <div class="card p-6 w-full max-w-md mx-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold" style="color: var(--text-light);">Modifier la photo de profil</h3>
            <button id="close-editor-btn" class="text-2xl" style="color: var(--text-gray);">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="flex flex-col items-center gap-4">
            <!-- Canvas pour l'√©dition -->
            <div class="relative">
              <canvas id="photo-editor-canvas" width="300" height="300" class="rounded-lg" style="border: 1px solid var(--border-dark); max-width: 100%;"></canvas>
            </div>

            <!-- Contr√¥le de zoom -->
            <div class="w-full">
              <label class="text-sm mb-2 block" style="color: var(--text-gray);">
                <i class="fas fa-search-plus mr-2"></i>
                Zoom
              </label>
              <input type="range" id="zoom-slider" min="1" max="3" step="0.1" value="1" class="w-full" />
            </div>

            <!-- Boutons d'action -->
            <div class="flex gap-3 w-full">
              <button id="cancel-editor-btn" class="btn-secondary flex-1">Annuler</button>
              <button id="save-editor-btn" class="btn-primary flex-1">Enregistrer</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal de choix cam√©ra -->
      <div id="camera-choice-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center" style="background: rgba(0,0,0,0.8);">
        <div class="card p-6 w-full max-w-md mx-4">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold" style="color: var(--text-light);">Prendre une photo</h3>
            <button id="close-choice-modal-btn" class="text-2xl" style="color: var(--text-gray);">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <p class="text-sm mb-6" style="color: var(--text-gray);">
            Choisissez comment vous souhaitez prendre votre photo
          </p>

          <div class="grid grid-cols-1 gap-4">
            <!-- Option Cam√©ra PC -->
            <button id="use-pc-camera-btn" class="p-6 rounded-lg border-2 transition-all hover:border-blue-500" style="background: var(--bg-dark); border-color: var(--border-dark);">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background: rgba(59, 130, 246, 0.2);">
                  <i class="fas fa-desktop text-2xl" style="color: var(--primary-blue);"></i>
                </div>
                <div class="text-left">
                  <h4 class="font-semibold mb-1" style="color: var(--text-light);">Cam√©ra PC</h4>
                  <p class="text-sm" style="color: var(--text-gray);">Utiliser la webcam de votre ordinateur</p>
                </div>
              </div>
            </button>

            <!-- Option Mobile avec QR -->
            <button id="use-mobile-qr-btn" class="p-6 rounded-lg border-2 transition-all hover:border-blue-500" style="background: var(--bg-dark); border-color: var(--border-dark);">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background: rgba(34, 197, 94, 0.2);">
                  <i class="fas fa-mobile-alt text-2xl" style="color: var(--primary-green);"></i>
                </div>
                <div class="text-left">
                  <h4 class="font-semibold mb-1" style="color: var(--text-light);">Mobile (QR Code)</h4>
                  <p class="text-sm" style="color: var(--text-gray);">Scanner un QR code avec votre t√©l√©phone</p>
                </div>
              </div>
            </button>
          </div>
        </div>
      </div>

      <!-- Modal de cam√©ra PC -->
      <div id="camera-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center" style="background: rgba(0,0,0,0.95);">
        <div class="w-full h-full flex flex-col items-center justify-center p-4">
          <div class="w-full max-w-lg">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold" style="color: var(--text-light);">Cam√©ra PC</h3>
              <button id="close-camera-btn" class="text-2xl" style="color: var(--text-gray);">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <div class="relative rounded-lg overflow-hidden" style="background: #000;">
              <video id="camera-video" autoplay playsinline class="w-full" style="max-height: 60vh;"></video>
              <canvas id="camera-canvas" class="hidden"></canvas>
            </div>

            <div class="flex gap-3 mt-4">
              <button id="cancel-camera-btn" class="btn-secondary flex-1">Annuler</button>
              <button id="capture-photo-btn" class="btn-primary flex-1">
                <i class="fas fa-camera mr-2"></i>Capturer
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal QR Code Mobile -->
      <div id="qr-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center" style="background: rgba(0,0,0,0.8);">
        <div class="card p-6 w-full max-w-md mx-4">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold" style="color: var(--text-light);">Scanner le QR Code</h3>
            <button id="close-qr-modal-btn" class="text-2xl" style="color: var(--text-gray);">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="text-center">
            <p class="text-sm mb-6" style="color: var(--text-gray);">
              Scannez ce QR code avec votre t√©l√©phone pour prendre une photo
            </p>

            <div id="qrcode-container" class="flex justify-center mb-6 p-4 rounded-lg" style="background: white;">
              <!-- Le QR code sera g√©n√©r√© ici -->
            </div>

            <div class="flex items-center justify-center gap-2 mb-4">
              <div class="spinner-border" style="display: none;" id="qr-waiting-spinner"></div>
              <p class="text-sm" style="color: var(--text-gray);" id="qr-status-text">
                En attente de la photo...
              </p>
            </div>

            <button id="cancel-qr-btn" class="btn-secondary w-full">Annuler</button>
          </div>
        </div>
      </div>

      <!-- Section Title: S√©curit√© et d√©connexion -->
      <div class="mb-8 mt-12">
        <h1 class="text-xl md:text-2xl font-bold mb-2" style="color: var(--text-light);">S√©curit√© et d√©connexion</h1>
        <p class="text-sm md:text-base" style="color: var(--text-gray);">G√©rez la s√©curit√© de votre compte et d√©connectez-vous si n√©cessaire.</p>
      </div>

      <!-- S√©curit√© - Section compacte -->
      <div class="card p-4 mt-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-orange) 100%);">
              <i class="fas fa-shield-alt text-white text-sm"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold" style="color: var(--text-light);">S√©curit√©</h3>
              <p class="text-xs" style="color: var(--text-gray);">D√©connexion du compte</p>
            </div>
          </div>
          <button onclick="logout()" class="btn-secondary text-red-400 hover:text-red-300 text-xs">
            <i class="fas fa-sign-out-alt md:mr-2"></i>
            <span class="hidden md:inline">Se d√©connecter</span>
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- Footer -->
  <footer class="hidden md:block md:ml-[15%] md:mr-[15%] w-100% text-center text-sm mt-12 mb-4">
    <a href="/politique" class="hover:underline">Politique de confidentialit√©</a>
    &nbsp;|&nbsp;
    <a href="/conditions" class="hover:underline">Conditions d'utilisation</a>
    &nbsp;|&nbsp;
    <a href="/support" class="hover:underline">Support client</a>
    <br><br>
    <span style="color: var(--text-gray);">Propuls√© par <strong style="color: var(--primary-blue);">Qwota</strong></span>
  </footer>

<script>
  // ‚ö° D√âSACTIVATION DES LOGS - Performance optimization
  window.log = () => {};
  window.warn = () => {};
  window.error = () => {};
  window.info = () => {};
  window.debug = () => {};

  // Variables globales - Username is handled by common.js

  // ================================================================
  //  NEW MOBILE NAVIGATION FUNCTIONS
  // ================================================================

  // Variable pour tracker l'ic√¥ne s√©lectionn√©e
  let selectedIcon = null; // Aucun s√©lectionn√© par d√©faut sur la page param√®tres

  // Fonction pour s√©lectionner une ic√¥ne
  function selectIcon(iconNumber, title, iconClass) {
    if (selectedIcon === iconNumber) return; // √âviter de re-s√©lectionner

    const previousSelected = selectedIcon;
    selectedIcon = iconNumber;

    // Donn√©es des ic√¥nes
    const icons = [
      { id: 1, title: 'RPO' },
      { id: 2, title: 'Ventes' },
      { id: 3, title: 'Dashboard' },
      { id: 4, title: 'Outils' },
      { id: 5, title: 'Gestion' }
    ];

    // Trouver les conteneurs des ic√¥nes
    const containers = document.querySelectorAll('.case-container');
    const iconContainers = document.querySelectorAll('.icon-container');
    const iconElements = document.querySelectorAll('.icon-container i');
    const titleElements = document.querySelectorAll('.icon-title');

    containers.forEach((container, index) => {
      const iconId = index + 1;
      const isSelected = iconId === selectedIcon;
      const iconContainer = iconContainers[index];
      const iconElement = iconElements[index];

      // Animer le conteneur de la case
      if (isSelected) {
        container.className = 'flex-2 case-container flex flex-col justify-center items-center h-full';
      } else {
        container.className = 'flex-1 case-container flex justify-center items-center h-full';
      }

      // Animer l'ic√¥ne avec transform
      if (isSelected) {
        iconContainer.classList.add('selected');
        iconContainer.classList.remove('shadow-lg');
        iconContainer.classList.add('shadow-xl');
        iconElement.className = iconElement.className.replace(/text-\w+/, 'text-xl');
      } else {
        iconContainer.classList.remove('selected');
        iconContainer.classList.remove('shadow-xl');
        iconContainer.classList.add('shadow-lg');
        iconElement.className = iconElement.className.replace(/text-\w+/, 'text-sm');
      }
    });

    // G√©rer les titres
    titleElements.forEach(title => title.remove());

    // Ajouter le nouveau titre pour l'ic√¥ne s√©lectionn√©e
    const selectedContainer = containers[selectedIcon - 1];
    if (selectedContainer) {
      const titleSpan = document.createElement('span');
      titleSpan.className = 'text-xs font-medium mt-1 icon-title show';
      titleSpan.style.color = '#ffffff';
      titleSpan.textContent = icons[selectedIcon - 1].title;
      selectedContainer.appendChild(titleSpan);
    }
  }

  // Fonction pour toggle le dropdown mobile
  function toggleMobileProfileMenu() {
    const dropdown = document.getElementById('mobile-profile-dropdown');

    if (dropdown.classList.contains('show')) {
      // Fermer avec animation
      dropdown.classList.remove('show');
      setTimeout(() => {
        dropdown.classList.add('hidden');
      }, 300); // D√©lai correspondant √† la dur√©e de transition
    } else {
      // Ouvrir avec animation
      dropdown.classList.remove('hidden');
      setTimeout(() => {
        dropdown.classList.add('show');
      }, 10); // Petit d√©lai pour permettre le rendu
    }
  }

  // Fermer le dropdown si on clique ailleurs
  document.addEventListener('click', function(event) {
    const container = document.querySelector('.mobile-profile-container');
    const dropdown = document.getElementById('mobile-profile-dropdown');

    if (container && !container.contains(event.target) && dropdown.classList.contains('show')) {
      dropdown.classList.remove('show');
      setTimeout(() => {
        dropdown.classList.add('hidden');
      }, 300);
    }
  });

  // Charger les donn√©es utilisateur au d√©marrage pour mobile
  window.addEventListener('load', function() {
    // Utiliser les donn√©es de common.js
    if (typeof getCurrentUser === 'function') {
      const userData = getCurrentUser();
      if (userData && document.getElementById('mobile-username')) {
        document.getElementById('mobile-username').textContent = userData.username || 'Utilisateur';
        document.getElementById('mobile-role').textContent = userData.role || 'Entrepreneur';
      }
    } else if (typeof username !== 'undefined') {
      if (document.getElementById('mobile-username')) {
        document.getElementById('mobile-username').textContent = username || 'Utilisateur';
        document.getElementById('mobile-role').textContent = 'Entrepreneur';
      }
    }
  });

  // ================================================================
  //  ORIGINAL MOBILE MENU FUNCTIONS - Optimized
  // ================================================================
  function toggleMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.mobile-overlay');

    if (sidebar && overlay) {
      sidebar.classList.toggle('mobile-open');
      overlay.classList.toggle('active');

      // Prevent body scroll when menu is open
      if (sidebar.classList.contains('mobile-open')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }
  }

  function closeMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.mobile-overlay');

    if (sidebar && overlay) {
      sidebar.classList.remove('mobile-open');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    }
  }

  function setupMobileMenu() {
    const toggle = document.getElementById('mobile-menu-toggle');
    const closeBtn = document.getElementById('mobile-sidebar-close');
    const overlay = document.querySelector('.mobile-overlay');

    if (toggle) {
      toggle.addEventListener('click', toggleMobileMenu);
    }

    if (closeBtn) {
      closeBtn.addEventListener('click', closeMobileMenu);
    }

    if (overlay) {
      overlay.addEventListener('click', closeMobileMenu);
    }

    // Close menu on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeMobileMenu();
      }
    });

    // Close menu when clicking on menu links
    const menuLinks = document.querySelectorAll('#sidebar a');
    menuLinks.forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
          closeMobileMenu();
        }
      });
    });
  }

  // Setup Account Menus
  function setupAccountMenus() {
    // Desktop Account Menu
    const btn = document.getElementById("account-menu-button");
    const dropdown = document.getElementById("account-dropdown");

    if (btn && dropdown) {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdown.classList.toggle("hidden");
        
        if (!dropdown.classList.contains("hidden")) {
          setTimeout(() => dropdown.addEventListener("click", (e) => e.stopPropagation()), 0);
        }
      });
    }

    // Mobile Account Menu
    const mobileAccountBtn = document.getElementById('mobile-account-menu-button');
    const mobileAccountDropdown = document.getElementById('mobile-account-dropdown');
    
    if (mobileAccountBtn && mobileAccountDropdown) {
      mobileAccountBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        mobileAccountDropdown.classList.toggle('hidden');
      });
    }

    // Fermer les dropdowns en cliquant √† l'ext√©rieur
    document.addEventListener("click", () => {
      if (dropdown) dropdown.classList.add("hidden");
      if (mobileAccountDropdown) mobileAccountDropdown.classList.add('hidden');
    });

    // Donn√©es utilisateur g√©r√©es par common.js
  }

  // Script pour gestion menu actif
  function activateCurrentPageMenu() {
    const currentPath = window.location.pathname;
    log('üåê Page actuelle d√©tect√©e:', currentPath);
    
    const allMenuLinks = document.querySelectorAll('#sidebar a');
    allMenuLinks.forEach(link => {
      link.classList.remove('menu-active');
      link.removeAttribute('data-menu-state');
    });
    
    const pageMap = {
      '/connection': '/connection',
      '/connect_agenda': '/connection',
      '/newconnectagenda': '/connection'
    };
    
    const targetPath = pageMap[currentPath] || currentPath;
    const targetLink = document.querySelector(`#sidebar a[data-path="${targetPath}"]`);
    
    if (targetLink) {
      targetLink.classList.add('menu-active');
      targetLink.setAttribute('data-menu-state', 'active');
      log('[OK] Menu activ√© pour:', targetLink.textContent.trim());
    } else {
      log('[WARN] Aucun menu trouv√© pour la page:', currentPath);
    }
  }

  // Logout function
  function logout() {
    localStorage.removeItem('username');
    window.location.href = '/';
  }

  // Am√©lioration mobile pour √©viter le zoom double-tap
  function preventDoubleTabZoom() {
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
  }

  // Am√©lioration des interactions tactiles
  function enhanceTouchInteractions() {
    // Am√©liorer les dropdowns sur mobile
    const dropdowns = document.querySelectorAll('.custom-select-button');
    dropdowns.forEach(dropdown => {
      dropdown.addEventListener('touchstart', function(e) {
        this.style.transform = 'scale(0.98)';
      }, { passive: true });

      dropdown.addEventListener('touchend', function(e) {
        this.style.transform = 'scale(1)';
      }, { passive: true });
    });

    // Am√©liorer les boutons sur mobile
    const buttons = document.querySelectorAll('.btn-primary, .btn-secondary');
    buttons.forEach(button => {
      button.addEventListener('touchstart', function(e) {
        this.style.transform = 'scale(0.95)';
      }, { passive: true });

      button.addEventListener('touchend', function(e) {
        this.style.transform = 'scale(1)';
      }, { passive: true });
    });
  }

  // Redimensionnement du canvas signature sur orientation change
  function handleOrientationChange() {
    window.addEventListener('orientationchange', function() {
      setTimeout(() => {
        const canvas = document.getElementById('signature-pad');
        if (canvas && typeof setupCanvas === 'function') {
          setupCanvas(); // Reconfigurer le canvas
        }
      }, 100);
    });
  }

  // Initialisation
  document.addEventListener('DOMContentLoaded', function() {
    setupMobileMenu();
    setupAccountMenus();
    activateCurrentPageMenu();

    // Am√©liorations mobiles
    if (window.innerWidth <= 768) {
      preventDoubleTabZoom();
      enhanceTouchInteractions();
      handleOrientationChange();
    }
  });

  // ===== CODE COMPLET DE connect_agenda.html =====
  
  // Username is now handled by common.js
  const teamsKey = `teams_${window.username}`;
  const teamsContainer = document.getElementById("teams-list");

  async function loadTeams() {
    log('üë• Chargement √©quipes depuis user_info pour:', window.username);
    // Les √©quipes sont charg√©es automatiquement par loadInfos()
    // Cette fonction ne fait que retourner les √©quipes d√©j√† charg√©es
    return teams || [];
  }

  async function saveTeams(teamsData) {
    // Filtrer pour ne garder que les √©quipes avec au moins 1 membre
    const validTeams = teamsData.filter(team => team.painters && team.painters.length > 0);
    // Mettre √† jour la variable globale teams avec les √©quipes valides uniquement
    teams = validTeams;

    // Sauvegarder UNIQUEMENT sur le backend via /api/save-info (pas de localStorage)
    try {
      const data = {
        nom: document.getElementById("nom").value.trim(),
        prenom: document.getElementById("prenom").value.trim(),
        telephone: document.getElementById("telephone").value.trim(),
        courriel: document.getElementById("courriel").value.trim(),
        neq: document.getElementById("neq").value.trim(),
        tps: document.getElementById("tps").value.trim(),
        tvq: document.getElementById("tvq").value.trim(),
        equipes: validTeams,
        niveau_actuel: parseInt(document.getElementById("niveau-actuel")?.value || "1", 10)
      };

      const formData = new FormData();
      formData.append("username", window.username);
      formData.append("data", JSON.stringify(data));

      const response = await fetch('/api/save-info', {
        method: "POST",
        body: formData
      });

      if (!response.ok) {
        error('[TEAMS] Erreur sauvegarde backend:', response.status);
      } else {
        // Notifier le top window pour recharger l'iframe GQP
        if (window.top && window.top !== window) {
          window.top.postMessage({ type: 'reload-gqp' }, '*');
          log('[TEAMS] Message envoy√© √† window.top pour recharger GQP');
        }
      }
    } catch (error) {
      error('[TEAMS] Erreur sauvegarde backend:', error);
    }
  }

  // Variable globale pour stocker les employ√©s actifs
  let activeEmployees = [];

  // Fonction pour charger les employ√©s actifs
  async function loadActiveEmployees() {
    try {
      // V√©rifier que window.username est d√©fini
      if (!window.username) {
        log('[WARN] Username non d√©fini, nouvelle tentative dans 100ms...');
        await new Promise(resolve => setTimeout(resolve, 100));
        return loadActiveEmployees(); // R√©essayer
      }

      log('[DEBUG] Chargement employ√©s pour username:', window.username);
      const response = await fetch(`/get-employees-actifs/${window.username}`);
      if (response.ok) {
        const data = await response.json();
        activeEmployees = data.employees || [];
        log('üë• Employ√©s actifs charg√©s:', activeEmployees);
      } else {
        log('[ERROR] Erreur lors du chargement des employ√©s actifs');
        activeEmployees = [];
      }
    } catch (error) {
      error('Erreur:', error);
      activeEmployees = [];
    }
  }

  function createPainterRow(teamIndex, painterIndex, painter) {
    const row = document.createElement("div");
    row.className = "flex flex-col md:flex-row gap-2 md:items-center mb-4 md:mb-2";

    // Conteneur pour dropdown employ√© (style identique √† agenda)
    const employeeDropdownContainer = document.createElement("div");
    employeeDropdownContainer.className = "relative w-full md:flex-1";
    
    // Dropdown principal (style identique √† agenda)
    const employeeDropdown = document.createElement("div");
    employeeDropdown.className = "dropdown-secondary";
    
    const employeeSelectedText = document.createElement("span");
    employeeSelectedText.style.color = "var(--text-gray)";
    
    // D√©finir le texte initial
    if (painter.prenom && painter.nom) {
      employeeSelectedText.textContent = `${painter.prenom} ${painter.nom}`;
      employeeSelectedText.style.color = "var(--text-light)";
    } else {
      employeeSelectedText.textContent = "Choisir un peintre...";
    }
    
    const chevronIcon = document.createElement("i");
    chevronIcon.className = "fas fa-chevron-down";
    chevronIcon.style.color = "var(--text-gray)";
    
    employeeDropdown.appendChild(employeeSelectedText);
    employeeDropdown.appendChild(chevronIcon);
    
    // Menu dropdown (style identique √† agenda)
    const employeeDropdownMenu = document.createElement("div");
    employeeDropdownMenu.className = "dropdown-secondary-menu";
    employeeDropdownMenu.style.width = "250px";

    // V√©rifier s'il y a des employ√©s actifs
    if (activeEmployees.length === 0) {
      // Afficher un message si aucun employ√© n'existe
      const noEmployeeMessage = document.createElement("div");
      noEmployeeMessage.className = "dropdown-secondary-option";
      noEmployeeMessage.textContent = "Veuillez ajouter des employ√©s dans la section Employ√©s avant de former des √©quipes";
      employeeDropdownMenu.appendChild(noEmployeeMessage);
    } else {
      // Compter les employ√©s disponibles (non d√©j√† dans cette √©quipe)
      let availableCount = 0;

      // Ajouter les employ√©s actifs (exclure ceux d√©j√† dans cette √©quipe)
      activeEmployees.forEach((emp, index) => {
        // V√©rifier si cet employ√© est d√©j√† dans cette √©quipe
        const isAlreadyInTeam = teams[teamIndex].painters.some((p, idx) =>
          idx !== painterIndex && p.prenom === emp.prenom && p.nom === emp.nom
        );

        // Ne pas afficher l'employ√© s'il est d√©j√† dans cette √©quipe
        if (isAlreadyInTeam) return;

        availableCount++; // Incr√©menter le compteur

        const option = document.createElement("div");
        option.className = "dropdown-secondary-option";
        option.textContent = `${emp.prenom} ${emp.nom}`;
        option.dataset.prenom = emp.prenom;
        option.dataset.nom = emp.nom;
        option.dataset.courriel = emp.courriel;

        // Marquer comme s√©lectionn√© si c'est l'employ√© actuel
        if (painter.prenom === emp.prenom && painter.nom === emp.nom) {
          option.classList.add("selected");
        }

        option.addEventListener("click", (e) => {
          e.stopPropagation();

          // Supprimer la s√©lection pr√©c√©dente
          employeeDropdownMenu.querySelectorAll(".dropdown-secondary-option").forEach(opt => {
            opt.classList.remove("selected");
          });

          // Marquer comme s√©lectionn√©
          option.classList.add("selected");
          employeeSelectedText.textContent = `${emp.prenom} ${emp.nom}`;
          employeeSelectedText.style.color = "var(--text-light)";

          // Sauvegarder la s√©lection
          teams[teamIndex].painters[painterIndex] = {
            prenom: emp.prenom,
            nom: emp.nom,
            courriel: emp.courriel
          };

          // Fermer le dropdown
          employeeDropdownMenu.classList.remove("show");
          employeeDropdown.classList.remove("active");

          // Mettre √† jour l'affichage des informations
          renderTeams();
        });

        employeeDropdownMenu.appendChild(option);
      });

      // Si aucun employ√© disponible apr√®s filtrage, afficher un message
      if (availableCount === 0) {
        const noAvailableMessage = document.createElement("div");
        noAvailableMessage.className = "dropdown-secondary-option";
        noAvailableMessage.textContent = "Aucun employ√© disponible (tous les employ√©s sont d√©j√† dans cette √©quipe)";
        employeeDropdownMenu.appendChild(noAvailableMessage);
      }
    }
    
    // Gestion des √©v√©nements dropdown (identique √† agenda)
    employeeDropdown.addEventListener("click", (e) => {
      e.stopPropagation();
      employeeDropdownMenu.classList.toggle("show");
      employeeDropdown.classList.toggle("active");
    });
    
    // Fermer le dropdown en cliquant √† l'ext√©rieur
    document.addEventListener("click", () => {
      employeeDropdownMenu.classList.remove("show");
      employeeDropdown.classList.remove("active");
    });
    
    employeeDropdownContainer.appendChild(employeeDropdown);
    employeeDropdownContainer.appendChild(employeeDropdownMenu);

    // Affichage des infos de l'employ√© s√©lectionn√©
    const infoDiv = document.createElement("div");
    infoDiv.className = "w-full md:flex-1 p-2 rounded";
    infoDiv.style.background = "var(--bg-card)";
    infoDiv.style.borderColor = "var(--border-dark)";
    infoDiv.style.color = "var(--text-gray)";
    infoDiv.style.fontSize = "0.875rem";
    
    if (painter.prenom && painter.nom && painter.courriel) {
      infoDiv.innerHTML = `<strong>${painter.prenom} ${painter.nom}</strong><br><small>${painter.courriel}</small>`;
    } else {
      infoDiv.innerHTML = `<em>Aucun employ√© s√©lectionn√©</em>`;
    }

    const removeBtn = document.createElement("button");
    removeBtn.innerHTML = `<i class="fas fa-trash"></i>`;
    const icon = removeBtn.querySelector('.fas.fa-trash');
    icon.style.color = 'var(--text-light)';
    
    removeBtn.style.cssText = "background: none !important; border: none !important; padding: 4px !important; cursor: pointer; border-radius: 50% !important; transition: transform 0.2s ease !important; align-self: center !important; margin-top: 0 !important;";
    removeBtn.title = "Supprimer cet employ√© de l'√©quipe";
    
    // Effet hover
    removeBtn.addEventListener("mouseenter", () => {
      removeBtn.style.transform = "scale(1.2)";
    });
    removeBtn.addEventListener("mouseleave", () => {
      removeBtn.style.transform = "scale(1)";
    });
    removeBtn.addEventListener("click", () => {
      teams[teamIndex].painters.splice(painterIndex, 1);
      renderTeams();
    });

    // Desktop: utiliser les √©l√©ments originaux
    const desktopContainer = document.createElement("div");
    desktopContainer.className = "gap-2 items-center mb-2";
    // Afficher seulement sur desktop (largeur > 768px)
    if (window.innerWidth >= 768) {
      desktopContainer.style.setProperty('display', 'flex', 'important');
    } else {
      desktopContainer.style.setProperty('display', 'none', 'important');
    }

    desktopContainer.appendChild(employeeDropdownContainer);
    desktopContainer.appendChild(infoDiv);
    desktopContainer.appendChild(removeBtn);

    // Mobile: cr√©er des √©l√©ments s√©par√©s
    const mobileContainer = document.createElement("div");
    mobileContainer.className = "md:hidden flex flex-col gap-2 mb-2";

    // Recr√©er le dropdown pour mobile
    const mobileDropdownContainer = document.createElement("div");
    mobileDropdownContainer.className = "relative w-full";

    const mobileDropdown = document.createElement("div");
    mobileDropdown.className = "dropdown-secondary";

    const mobileSelectedText = document.createElement("span");
    mobileSelectedText.style.color = "var(--text-gray)";

    if (painter.prenom && painter.nom) {
      mobileSelectedText.textContent = `${painter.prenom} ${painter.nom}`;
      mobileSelectedText.style.color = "var(--text-light)";
    } else {
      mobileSelectedText.textContent = "Choisir un peintre...";
    }

    const mobileChevron = document.createElement("i");
    mobileChevron.className = "fas fa-chevron-down";
    mobileChevron.style.color = "var(--text-gray)";

    mobileDropdown.appendChild(mobileSelectedText);
    mobileDropdown.appendChild(mobileChevron);

    const mobileDropdownMenu = document.createElement("div");
    mobileDropdownMenu.className = "dropdown-secondary-menu";
    mobileDropdownMenu.style.width = "250px";

    // Ajouter les employ√©s au menu mobile
    let mobileAvailableCount = 0;

    activeEmployees.forEach((emp) => {
      const isAlreadyInTeam = teams[teamIndex].painters.some((p, idx) =>
        idx !== painterIndex && p.prenom === emp.prenom && p.nom === emp.nom
      );

      if (isAlreadyInTeam) return;

      mobileAvailableCount++; // Incr√©menter le compteur

      const option = document.createElement("div");
      option.className = "dropdown-secondary-option";
      option.textContent = `${emp.prenom} ${emp.nom}`;
      option.dataset.prenom = emp.prenom;
      option.dataset.nom = emp.nom;
      option.dataset.courriel = emp.courriel;

      if (painter.prenom === emp.prenom && painter.nom === emp.nom) {
        option.classList.add("selected");
      }

      option.addEventListener("click", (e) => {
        e.stopPropagation();

        teams[teamIndex].painters[painterIndex] = {
          prenom: emp.prenom,
          nom: emp.nom,
          courriel: emp.courriel
        };
        renderTeams();
      });

      mobileDropdownMenu.appendChild(option);
    });

    // Si aucun employ√© disponible, afficher un message
    if (mobileAvailableCount === 0) {
      const noAvailableMessage = document.createElement("div");
      noAvailableMessage.className = "dropdown-secondary-option";
      noAvailableMessage.textContent = "Aucun employ√© disponible";
      mobileDropdownMenu.appendChild(noAvailableMessage);
    }

    mobileDropdown.addEventListener("click", (e) => {
      e.stopPropagation();
      mobileDropdownMenu.classList.toggle("show");
      mobileDropdown.classList.toggle("active");
    });

    mobileDropdownContainer.appendChild(mobileDropdown);
    mobileDropdownContainer.appendChild(mobileDropdownMenu);

    // Cr√©er le bouton remove pour mobile
    const mobileRemoveBtn = document.createElement("button");
    mobileRemoveBtn.innerHTML = `<i class="fas fa-trash"></i>`;
    const mobileIcon = mobileRemoveBtn.querySelector('.fas.fa-trash');
    mobileIcon.style.color = 'var(--text-light)';

    mobileRemoveBtn.style.cssText = "background: none !important; border: none !important; padding: 4px !important; cursor: pointer; border-radius: 50% !important; transition: transform 0.2s ease !important; align-self: center !important; margin-top: 0 !important;";
    mobileRemoveBtn.title = "Supprimer cet employ√© de l'√©quipe";

    mobileRemoveBtn.addEventListener("mouseenter", () => {
      mobileRemoveBtn.style.transform = "scale(1.2)";
    });
    mobileRemoveBtn.addEventListener("mouseleave", () => {
      mobileRemoveBtn.style.transform = "scale(1)";
    });
    mobileRemoveBtn.addEventListener("click", () => {
      teams[teamIndex].painters.splice(painterIndex, 1);
      renderTeams();
    });

    // Cr√©er l'info div pour mobile
    const mobileInfoDiv = document.createElement("div");
    mobileInfoDiv.className = "w-full p-2 rounded";
    mobileInfoDiv.style.background = "var(--bg-card)";
    mobileInfoDiv.style.borderColor = "var(--border-dark)";
    mobileInfoDiv.style.color = "var(--text-gray)";
    mobileInfoDiv.style.fontSize = "0.875rem";

    if (painter.prenom && painter.nom && painter.courriel) {
      mobileInfoDiv.innerHTML = `<strong>${painter.prenom} ${painter.nom}</strong><br><small>${painter.courriel}</small>`;
    } else {
      mobileInfoDiv.innerHTML = `<em>Aucun employ√© s√©lectionn√©</em>`;
    }

    const mobileTopRow = document.createElement("div");
    mobileTopRow.className = "flex gap-2 items-center";
    mobileTopRow.appendChild(mobileDropdownContainer);
    mobileTopRow.appendChild(mobileRemoveBtn);

    mobileContainer.appendChild(mobileTopRow);
    mobileContainer.appendChild(mobileInfoDiv);

    row.appendChild(desktopContainer);
    row.appendChild(mobileContainer);

    return row;
  }

function createTeamBox(team, index) {
  const box = document.createElement("div");
  box.className = "border p-5 rounded-xl";
  box.style.cssText = `
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.4), rgba(30, 41, 59, 0.2)) !important;
    border: 1px solid var(--border-dark) !important;
    border-radius: 1rem !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    transition: all 0.3s ease !important;
  `;

  // Hover effect
  box.addEventListener("mouseenter", () => {
    box.style.borderColor = "rgba(59, 130, 246, 0.3)";
    box.style.boxShadow = "0 4px 16px rgba(0, 0, 0, 0.25)";
  });
  box.addEventListener("mouseleave", () => {
    box.style.borderColor = "var(--border-dark)";
    box.style.boxShadow = "0 2px 8px rgba(0, 0, 0, 0.1)";
  });

  const removeTeamBtn = document.createElement("button");
  removeTeamBtn.innerHTML = '<i class="fas fa-trash mr-2"></i><span>Supprimer l\'√©quipe</span>';
  removeTeamBtn.className = "btn-secondary px-3 py-1.5 text-xs md:px-4 md:py-2 md:text-sm team-remove-btn";
  removeTeamBtn.style.cssText = "white-space: nowrap !important; flex-shrink: 0 !important; display: none !important; align-items: center !important; gap: 0.5rem !important;";
  removeTeamBtn.addEventListener("click", async () => {
    const confirmed = await showConfirm("Supprimer cette √©quipe ?");
    if (confirmed) {
      teams.splice(index, 1);

      // Si c'√©tait la derni√®re √©quipe, sortir du mode √©dition et revenir √† l'√©tat initial
      if (teams.length === 0) {
        isEditingTeams = false;
        const editBtn = document.getElementById("edit-teams-btn");
        const addTeamBtn = document.getElementById("add-team-btn");
        if (editBtn) editBtn.textContent = "Ajouter ma premi√®re √©quipe";
        if (addTeamBtn) addTeamBtn.style.display = "none";
      }

      renderTeams();
    }
  });

  const topButtonContainer = document.createElement("div");
  topButtonContainer.className = "flex justify-between items-center mb-4";

  // Add team number badge
  const teamBadge = document.createElement("div");
  teamBadge.style.cssText = `
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.3)) !important;
    border: 1px solid var(--primary-blue) !important;
    color: var(--primary-blue) !important;
    padding: 4px 12px !important;
    border-radius: 20px !important;
    font-size: 0.75rem !important;
    font-weight: 600 !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 6px !important;
  `;
  teamBadge.innerHTML = `<i class="fas fa-users" style="font-size: 0.7rem;"></i>√âquipe ${index + 1}`;

  topButtonContainer.appendChild(teamBadge);
  topButtonContainer.appendChild(removeTeamBtn);

  // Nom de l'√©quipe input (styled like info fields)
  const titleLabel = document.createElement("div");
  titleLabel.innerHTML = '<i class="fas fa-tag mr-2" style="color: var(--primary-blue); font-size: 0.7rem;"></i>Nom de l\'√©quipe';
  titleLabel.style.cssText = `
    font-size: 0.8rem !important;
    color: var(--text-light) !important;
    margin-bottom: 8px !important;
    font-weight: 600 !important;
    display: flex !important;
    align-items: center !important;
  `;

  const titleInput = document.createElement("input");
  titleInput.type = "text";
  titleInput.value = team.name || `√âquipe ${index + 1}`;
  titleInput.maxLength = 40;
  titleInput.className = "team-name-input";
  titleInput.disabled = true;
  titleInput.style.cssText = `
    background: rgba(128, 128, 128, 0.1) !important;
    color: rgba(255, 255, 255, 0.5) !important;
    cursor: not-allowed !important;
    border: 2px solid rgba(128, 128, 128, 0.3) !important;
    border-radius: 12px !important;
    padding: 12px 16px !important;
    font-size: 0.875rem !important;
    transition: all 0.3s ease !important;
    width: 100% !important;
    max-width: 350px !important;
  `;

  titleInput.addEventListener("focus", () => {
    titleInput.style.borderColor = "var(--primary-blue)";
    titleInput.style.background = "rgba(23, 32, 51, 0.8)";
  });
  titleInput.addEventListener("blur", () => {
    titleInput.style.borderColor = "var(--border-dark)";
    titleInput.style.background = "rgba(23, 32, 51, 0.6)";
  });

  titleInput.addEventListener("input", () => {
    teams[index].name = titleInput.value.trim();
  });

  const titleContainer = document.createElement("div");
  titleContainer.className = "mb-5";
  titleContainer.appendChild(titleLabel);
  titleContainer.appendChild(titleInput);

  // Peintre section label
  const paintersLabel = document.createElement("div");
  paintersLabel.innerHTML = '<i class="fas fa-user-friends mr-2" style="color: var(--primary-blue); font-size: 0.7rem;"></i>Membres de l\'√©quipe';
  paintersLabel.style.cssText = `
    font-size: 0.8rem !important;
    color: var(--text-light) !important;
    margin-bottom: 10px !important;
    font-weight: 600 !important;
    display: flex !important;
    align-items: center !important;
  `;

  // Container for badges and add button
  const badgesContainer = document.createElement("div");
  badgesContainer.className = "flex flex-wrap gap-2.5 items-center";
  badgesContainer.style.cssText = `
    background: rgba(30, 41, 59, 0.3) !important;
    padding: 12px !important;
    border-radius: 10px !important;
    border: 1px dashed var(--border-dark) !important;
    min-height: 56px !important;
  `;

  // Add badges for each painter
  team.painters.forEach((painter, pIndex) => {
    if (painter.prenom && painter.nom) {
      const badge = createPainterBadge(index, pIndex, painter);
      badgesContainer.appendChild(badge);
    }
  });

  // Add "+" button with dropdown
  const addPainterWrapper = document.createElement("div");
  addPainterWrapper.className = "relative team-add-member-btn";
  addPainterWrapper.style.display = "none";

  const addPainterBtn = document.createElement("button");
  addPainterBtn.innerHTML = '<i class="fas fa-plus"></i>';
  addPainterBtn.style.cssText = `
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.3)) !important;
    border: 2px dashed var(--primary-blue) !important;
    color: var(--primary-blue) !important;
    width: 36px !important;
    height: 36px !important;
    border-radius: 50% !important;
    font-size: 0.95rem !important;
    font-weight: bold !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 0 !important;
    flex-shrink: 0 !important;
  `;

  addPainterBtn.addEventListener("mouseenter", () => {
    addPainterBtn.style.background = "linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(59, 130, 246, 0.4))";
    addPainterBtn.style.transform = "scale(1.08)";
    addPainterBtn.style.borderStyle = "solid";
  });
  addPainterBtn.addEventListener("mouseleave", () => {
    addPainterBtn.style.background = "linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.3))";
    addPainterBtn.style.transform = "scale(1)";
    addPainterBtn.style.borderStyle = "dashed";
  });

  // Dropdown menu
  const dropdown = document.createElement("div");
  dropdown.className = "dropdown-secondary-menu";
  dropdown.style.width = "250px";

  // Populate dropdown with available employees
  if (activeEmployees.length === 0) {
    const noEmployeeMessage = document.createElement("div");
    noEmployeeMessage.className = "dropdown-secondary-option";
    noEmployeeMessage.textContent = "Aucun employ√© disponible";
    dropdown.appendChild(noEmployeeMessage);
  } else {
    let addPainterAvailableCount = 0;

    activeEmployees.forEach((emp) => {
      // Check if already in team
      const isAlreadyInTeam = team.painters.some(p =>
        p.prenom === emp.prenom && p.nom === emp.nom
      );

      if (isAlreadyInTeam) return;

      addPainterAvailableCount++; // Incr√©menter le compteur

      const option = document.createElement("div");
      option.className = "dropdown-secondary-option";
      option.textContent = `${emp.prenom} ${emp.nom}`;

      option.addEventListener("click", (e) => {
        e.stopPropagation();

        // Add painter to team
        teams[index].painters.push({
          prenom: emp.prenom,
          nom: emp.nom,
          courriel: emp.courriel
        });

        renderTeams();

        dropdown.style.display = "none";
      });

      dropdown.appendChild(option);
    });

    // Si aucun employ√© disponible apr√®s filtrage, afficher un message
    if (addPainterAvailableCount === 0) {
      const noAvailableMessage = document.createElement("div");
      noAvailableMessage.className = "dropdown-secondary-option";
      noAvailableMessage.textContent = "Aucun employ√© disponible (tous les employ√©s sont d√©j√† dans cette √©quipe)";
      dropdown.appendChild(noAvailableMessage);
    }
  }

  addPainterBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    dropdown.style.display = dropdown.style.display === "none" ? "block" : "none";
  });

  // Close dropdown when clicking outside
  document.addEventListener("click", () => {
    dropdown.style.display = "none";
  });

  addPainterWrapper.appendChild(addPainterBtn);
  addPainterWrapper.appendChild(dropdown);
  badgesContainer.appendChild(addPainterWrapper);

  box.appendChild(topButtonContainer);
  box.appendChild(titleContainer);
  box.appendChild(paintersLabel);
  box.appendChild(badgesContainer);

  return box;
}

// Create badge for a painter
function createPainterBadge(teamIndex, painterIndex, painter) {
  const badge = document.createElement("div");
  badge.style.cssText = `
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1)) !important;
    border: 1.5px solid rgba(59, 130, 246, 0.4) !important;
    color: var(--text-light) !important;
    padding: 8px 14px !important;
    border-radius: 25px !important;
    font-size: 0.875rem !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 10px !important;
    transition: all 0.2s ease !important;
    font-weight: 500 !important;
  `;

  // Hover effect
  badge.addEventListener("mouseenter", () => {
    badge.style.background = "linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(59, 130, 246, 0.15))";
    badge.style.borderColor = "rgba(59, 130, 246, 0.6)";
    badge.style.transform = "translateY(-1px)";
  });
  badge.addEventListener("mouseleave", () => {
    badge.style.background = "linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1))";
    badge.style.borderColor = "rgba(59, 130, 246, 0.4)";
    badge.style.transform = "translateY(0)";
  });

  // Icon
  const icon = document.createElement("i");
  icon.className = "fas fa-user";
  icon.style.cssText = "font-size: 0.75rem; color: var(--primary-blue);";

  const nameSpan = document.createElement("span");
  nameSpan.textContent = `${painter.prenom} ${painter.nom}`;

  const removeBtn = document.createElement("button");
  removeBtn.className = "team-member-remove-btn";
  removeBtn.innerHTML = "√ó";
  removeBtn.style.cssText = `
    background: rgba(239, 68, 68, 0.15) !important;
    border: none !important;
    color: #ef4444 !important;
    font-size: 1.1rem !important;
    cursor: pointer !important;
    padding: 0 !important;
    margin: 0 !important;
    line-height: 1 !important;
    width: 20px !important;
    height: 20px !important;
    border-radius: 50% !important;
    display: none !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.2s ease !important;
  `;

  removeBtn.addEventListener("mouseenter", () => {
    removeBtn.style.background = "rgba(239, 68, 68, 0.3)";
    removeBtn.style.transform = "scale(1.15)";
  });
  removeBtn.addEventListener("mouseleave", () => {
    removeBtn.style.background = "rgba(239, 68, 68, 0.15)";
    removeBtn.style.transform = "scale(1)";
  });

  removeBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    teams[teamIndex].painters.splice(painterIndex, 1);
    renderTeams();
  });

  badge.appendChild(icon);
  badge.appendChild(nameSpan);
  badge.appendChild(removeBtn);

  return badge;
}

  let isEditingTeams = false; // Variable pour suivre l'√©tat d'√©dition

  function renderTeams() {
    log('üé® Rendu √©quipes:', teams.length, '√©quipes √† afficher');
    teamsContainer.innerHTML = "";

    // Le bouton change selon le nombre d'√©quipes (sauf en mode √©dition)
    const editBtn = document.getElementById("edit-teams-btn");
    if (editBtn && !isEditingTeams) {
      editBtn.textContent = teams.length === 0 ? "Ajouter ma premi√®re √©quipe" : "Modifier";
    }

    // Si aucune √©quipe, afficher un message
    if (teams.length === 0) {
      const emptyState = document.createElement("div");
      emptyState.style.cssText = `
        text-align: center;
        padding: 3rem 1.5rem;
        color: var(--text-gray);
      `;
      emptyState.innerHTML = `
        <i class="fas fa-users" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
        <p style="font-size: 1rem; margin-bottom: 0.5rem;">Aucune √©quipe cr√©√©e...</p>
        <p style="font-size: 0.875rem; opacity: 0.7;">Cliquez sur "Ajouter ma premi√®re √©quipe" pour commencer</p>
      `;
      teamsContainer.appendChild(emptyState);
      return;
    }

    teams.forEach((team, i) => {
      teamsContainer.appendChild(createTeamBox(team, i));
      log('[OK] √âquipe', i, 'ajout√©e:', team);
    });

    // R√©appliquer l'√©tat d'√©dition apr√®s le rendu
    if (isEditingTeams) {
      const teamNameInputs = document.querySelectorAll(".team-name-input");
      const teamRemoveBtns = document.querySelectorAll(".team-remove-btn");
      const teamAddMemberBtns = document.querySelectorAll(".team-add-member-btn");
      const memberRemoveBtns = document.querySelectorAll(".team-member-remove-btn");

      teamNameInputs.forEach(input => {
        input.disabled = false;
        input.style.background = "rgba(23, 32, 51, 0.6)";
        input.style.color = "var(--text-light)";
        input.style.cursor = "text";
        input.style.border = "2px solid var(--border-dark)";
      });
      teamRemoveBtns.forEach(btn => { btn.style.display = "flex"; });
      teamAddMemberBtns.forEach(btn => { btn.style.display = "inline-block"; });
      memberRemoveBtns.forEach(btn => { btn.style.display = "flex"; });
    }
  }

  // Removed - now handled by toggleEditTeams

  let teams = [];

  // Charger les employ√©s actifs et les √©quipes de fa√ßon asynchrone
  async function initializeTeamsSection() {
    // V√©rifier que window.username est bien d√©fini
    if (!window.username) {
      log('[WARN] Attente de la d√©finition de window.username...');
      setTimeout(initializeTeamsSection, 100);
      return;
    }

    log('[DEBUG] Initialisation section √©quipes pour:', window.username);
    await loadActiveEmployees(); // Charger d'abord les employ√©s actifs

    const loadedTeams = await loadTeams(); // Puis les √©quipes
    teams = loadedTeams;

    renderTeams();
  }

  // Initialiser la section √©quipes apr√®s le chargement du DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeTeamsSection);
  } else {
    // Le DOM est d√©j√† pr√™t
    initializeTeamsSection();
  }

document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("agendaBtn");
  const box = document.getElementById("calendar-box");
  const list = document.getElementById("agenda-list");
  const emailConnectBtn = document.querySelector("#email-buttons button");
  const emailDisconnectBtn = document.getElementById("email-disconnect");

  function checkConnection() {
    fetch(`/is-agenda-linked?username=${username}`)
      .then(res => res.json())
      .then(data => {
        if (data.linked) {
          // Changer les √©tats
          document.getElementById("agenda-disconnected").classList.add("hidden");
          document.getElementById("calendar-box").classList.remove("hidden");
          document.getElementById("agenda-status-disconnected").classList.add("hidden");
          document.getElementById("agenda-status-connected").classList.remove("hidden");
          document.getElementById("agenda-connected-info").classList.remove("hidden");
          
          // Configurer le bouton de d√©connexion
          document.getElementById("agendaBtnDisconnect").onclick = disconnect;
          loadCalendars();
        } else {
          // √âtats par d√©faut (non connect√©)
          document.getElementById("agenda-disconnected").classList.remove("hidden");
          document.getElementById("calendar-box").classList.add("hidden");
          document.getElementById("agenda-status-disconnected").classList.remove("hidden");
          document.getElementById("agenda-status-connected").classList.add("hidden");
          document.getElementById("agenda-connected-info").classList.add("hidden");
          
          btn.onclick = connect;
        }
      })
      .catch(() => {
        // √âtats par d√©faut en cas d'erreur
        document.getElementById("agenda-disconnected").classList.remove("hidden");
        document.getElementById("calendar-box").classList.add("hidden");
        document.getElementById("agenda-status-disconnected").classList.remove("hidden");
        document.getElementById("agenda-status-connected").classList.add("hidden");
        document.getElementById("agenda-connected-info").classList.add("hidden");
        
        btn.onclick = connect;
      });
  }

async function saveTeamsToBackend() {
  // V√©rifier s'il y a des √©quipes sans membres
  const teamsWithoutMembers = teams.filter(team => !team.painters || team.painters.length === 0);
  const validTeams = teams.filter(team => team.painters && team.painters.length > 0);

  // Si toutes les √©quipes sont invalides (0 membre), afficher un message d'erreur
  if (teams.length > 0 && validTeams.length === 0) {
    showToast("Impossible d'enregistrer : chaque √©quipe doit avoir au moins un membre", "error");
    return;
  }

  // Si certaines √©quipes n'ont pas de membres, avertir l'utilisateur
  if (teamsWithoutMembers.length > 0) {
    const teamNames = teamsWithoutMembers.map(t => t.nom || "Sans nom").join(", ");
    showToast(`Les √©quipes suivantes n'ont pas de membres et ne seront pas enregistr√©es : ${teamNames}`, "warning");
  }

  const confirmed = await showConfirm("Voulez-vous vraiment sauvegarder les √©quipes ?");
  if (!confirmed) return;

  const saveBtn = document.getElementById("save-teams-btn");
  const originalText = saveBtn.innerHTML;

  try {
    // Afficher le spinner
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner"></span> Sauvegarde...';

    // Mapper 'nom' vers 'name' pour le backend
    const teamsForBackend = validTeams.map(team => ({
      name: team.nom || team.name || '',
      painters: team.painters || []
    }));

    const response = await fetch(`/save-equipes/${window.username}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(teamsForBackend)
    });

    if (response.ok) {
      // Mettre √† jour la variable teams avec seulement les √©quipes valides
      teams = validTeams;

      // Rafra√Æchir l'affichage pour supprimer visuellement les √©quipes sans membres
      renderTeams();

      // R√©cup√©rer les √©quipes depuis le backend
      const resGet = await fetch(`/get-equipes/${window.username}`);
      if (!resGet.ok) throw new Error("Erreur r√©cup√©ration √©quipes");

      const equipes = await resGet.json();

      // Mettre √† jour le menu d√©roulant (supposons qu'il a l'id "teams-select")
      const select = document.getElementById("teams-select");
      if (select) {
        select.innerHTML = ""; // vider les options

        equipes.forEach(team => {
          const option = document.createElement("option");
          option.value = team.name || "√âquipe sans nom";
          option.textContent = team.name || "√âquipe sans nom";
          select.appendChild(option);
        });
      }

      // Afficher notification de succ√®s
      showToast("√âquipes sauvegard√©es avec succ√®s", "success");

      // Notifier le top window pour recharger l'iframe GQP
      if (window.top && window.top !== window) {
        window.top.postMessage({ type: 'reload-gqp' }, '*');
        log('[TEAMS] Message envoy√© √† window.top pour recharger GQP');
      }
    } else {
      showToast("Une erreur s'est produite lors de la sauvegarde", "error");
    }
  } catch (error) {
    showToast("Une erreur s'est produite lors de la sauvegarde", "error");
    error(error);
  } finally {
    // Restaurer le bouton
    saveBtn.disabled = false;
    saveBtn.innerHTML = originalText;
  }
}


  async function connect() {
    try {
      // 1. R√©cup√©rer l'URL OAuth depuis le backend
      const response = await fetch(`/connect-google?username=${username}&return_url=true`);
      const data = await response.json();
      const oauthUrl = data.oauth_url;

      log('üîê URL OAuth Calendar r√©cup√©r√©e');

      // MOBILE: Redirection directe dans une nouvelle page (popups bloqu√©s dans iframes)
      const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      if (isMobile) {
        // Sur mobile, ouvrir dans un nouvel onglet ou rediriger
        // Sauvegarder l'√©tat pour savoir qu'on attend une connexion
        localStorage.setItem('oauth_pending', 'calendar');
        // Utiliser window.top pour sortir de l'iframe
        window.top.location.href = oauthUrl;
        return;
      }

      // DESKTOP: Ouvrir popup web
      const width = 600, height = 700;
      const left = (screen.width - width) / 2;
      const top = (screen.height - height) / 2;

      const popup = window.open(
        oauthUrl,
        "calendar_oauth",
        `width=${width},height=${height},top=${top},left=${left},toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes`
      );

      // √âcouter le message de succ√®s
      const messageHandler = (event) => {
        if (event.data === 'agenda_connected') {
          log('‚úÖ Google Calendar connect√© avec succ√®s');
          if (popup && !popup.closed) {
            popup.close();
          }
          checkConnection();
          window.removeEventListener('message', messageHandler);
        }
      };

      window.addEventListener('message', messageHandler);

    } catch (error) {
      error('‚ùå Erreur lors de la connexion Google Calendar:', error);
    }
  }

  function disconnect() {
    fetch(`/deconnecter-agenda?username=${username}`, { method: "DELETE" })
      .then(() => {
        checkConnection();
        setTimeout(() => updateProfileProgress(), 500); // Mettre √† jour apr√®s que l'UI soit mise √† jour
      });
  }

  let lastSelectedId = localStorage.getItem(`selected-agenda-${window.username}`) || null;

  // R√©cup√©rer l'agenda s√©lectionn√© depuis le backend
  function loadSelectedAgenda() {
    return fetch(`/get-agenda-id?username=${username}`)
      .then(res => res.ok ? res.json() : { agenda_id: null })
      .then(data => {
        if (data.agenda_id) {
          lastSelectedId = data.agenda_id;
          localStorage.setItem(`selected-agenda-${username}`, data.agenda_id);
          log('[DATE] Agenda s√©lectionn√© r√©cup√©r√© depuis backend:', data.agenda_id);
        }
        return lastSelectedId;
      })
      .catch(err => {
        log('[DATE] Erreur r√©cup√©ration agenda backend, utilisation localStorage');
        return lastSelectedId;
      });
  }

  function loadCalendars() {
    log('[DATE] Chargement agendars pour:', username);
    const dropdown = document.getElementById("agenda-select");
    const dropdownButton = document.getElementById("agenda-select-button");
    const dropdownMenu = document.getElementById("dropdown-secondary-menu");
    const selectedText = document.getElementById("agenda-selected-text");

    // S'assurer que le dropdown est ferm√© au chargement
    dropdown.classList.remove("open");

    // D'abord r√©cup√©rer l'agenda s√©lectionn√© depuis le backend
    loadSelectedAgenda().then(() => {
      fetch(`/liste-agendas?username=${username}`)
        .then(res => {
          log('[DATE] R√©ponse agendas:', res.status);
          return res.json();
        })
        .then(data => {
          log('[DATE] Donn√©es agendas re√ßues:', data, 'Selected ID:', lastSelectedId);

          // Vider le menu dropdown
          dropdownMenu.innerHTML = "";

          // S√©parer les agendas personnels (owner) des partag√©s
          const personalAgendas = data.filter(cal => cal.accessRole === 'owner');
          const sharedAgendas = data.filter(cal => cal.accessRole !== 'owner');

          log('[DATE] Agendas personnels:', personalAgendas.length, 'Partag√©s:', sharedAgendas.length);

          // Si aucun agenda personnel, afficher un message informatif
          if (personalAgendas.length === 0) {
            const infoMessage = document.createElement("div");
            infoMessage.style.cssText = "padding: 0.75rem; color: rgba(251, 191, 36, 0.9); background: rgba(251, 191, 36, 0.1); border-radius: 6px; font-size: 0.8rem; margin-bottom: 0.5rem; border: 1px solid rgba(251, 191, 36, 0.2);";
            infoMessage.innerHTML = '<i class="fas fa-info-circle"></i> Aucun agenda personnel cr√©√©. Vous pouvez s√©lectionner un agenda partag√© ou en cr√©er un nouveau dans Google Agenda.';
            dropdownMenu.appendChild(infoMessage);
          }

          // Fonction pour cr√©er une option d'agenda
          function createAgendaOption(cal, isPersonal) {
            const option = document.createElement("div");
            option.className = "custom-select-option";
            if (cal.id === lastSelectedId) {
              option.classList.add("selected");
              selectedText.textContent = cal.nom;
              selectedText.style.color = "var(--text-light)";
            }

            // Ic√¥ne diff√©rente pour agenda personnel vs partag√©
            const icon = isPersonal
              ? '<i class="fas fa-calendar" style="color: rgba(34, 197, 94, 0.8); margin-right: 0.5rem;"></i>'
              : '<i class="fas fa-users" style="color: rgba(148, 163, 184, 0.6); margin-right: 0.5rem;"></i>';

            option.innerHTML = icon + cal.nom;
            option.dataset.agendaId = cal.id;
            option.dataset.agendaName = cal.nom;

            option.addEventListener("click", (e) => {
              e.stopPropagation();

              // Supprimer la s√©lection pr√©c√©dente
              dropdownMenu.querySelectorAll(".custom-select-option").forEach(opt => {
                opt.classList.remove("selected");
              });

              // Marquer comme s√©lectionn√©
              option.classList.add("selected");
              selectedText.textContent = cal.nom;
              selectedText.style.color = "var(--text-light)";

              // Sauvegarder la s√©lection
              localStorage.setItem(`selected-agenda-${username}`, cal.id);
              lastSelectedId = cal.id;

              fetch("/sauver-agenda-id", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username: username, agenda_id: cal.id })
              }).then(() => {
                log('[OK] Agenda sauvegard√©:', cal.nom);
              });

              // Fermer le dropdown
              dropdown.classList.remove("open");
            });

            return option;
          }

          // Ajouter d'abord les agendas personnels
          personalAgendas.forEach(cal => {
            dropdownMenu.appendChild(createAgendaOption(cal, true));
          });

          // Ajouter un s√©parateur si on a les deux types
          if (personalAgendas.length > 0 && sharedAgendas.length > 0) {
            const separator = document.createElement("div");
            separator.style.cssText = "padding: 0.5rem 0.75rem; color: rgba(148, 163, 184, 0.6); font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; border-top: 1px solid rgba(148, 163, 184, 0.1); margin-top: 0.25rem;";
            separator.textContent = "Agendas partag√©s";
            dropdownMenu.appendChild(separator);
          }

          // Ajouter les agendas partag√©s
          sharedAgendas.forEach(cal => {
            dropdownMenu.appendChild(createAgendaOption(cal, false));
          });

          // Si aucun agenda s√©lectionn√©, afficher le placeholder
          if (!lastSelectedId && data.length > 0) {
            selectedText.textContent = "Choisir un agenda...";
            selectedText.style.color = "var(--text-gray)";
          }

          // Gestion du clic sur le dropdown - ajouter les listeners une seule fois
          if (!dropdownButton.dataset.listenerAttached) {
            dropdownButton.dataset.listenerAttached = "true";

            dropdownButton.addEventListener("click", (e) => {
              e.stopPropagation();
              dropdown.classList.toggle("open");
            });

            // Fermer le dropdown en cliquant √† l'ext√©rieur
            document.addEventListener("click", (e) => {
              if (!dropdown.contains(e.target)) {
                dropdown.classList.remove("open");
              }
            });
          }
      });
    });

    fetch(`/email-connecte?username=${username}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById("user-email").textContent = data.email || "...";
      })
      .catch(() => {
        document.getElementById("user-email").textContent = "...";
      });
  }

  async function connectGmail() {
    try {
      // 1. R√©cup√©rer l'URL OAuth depuis le backend
      const response = await fetch(`/connect-gmail?username=${username}&return_url=true`);
      const data = await response.json();
      const oauthUrl = data.oauth_url;

      log('üîê URL OAuth Gmail r√©cup√©r√©e');

      // MOBILE: Redirection directe dans une nouvelle page (popups bloqu√©s dans iframes)
      const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      if (isMobile) {
        // Sur mobile, ouvrir dans un nouvel onglet ou rediriger
        // Sauvegarder l'√©tat pour savoir qu'on attend une connexion
        localStorage.setItem('oauth_pending', 'gmail');
        // Utiliser window.top pour sortir de l'iframe
        window.top.location.href = oauthUrl;
        return;
      }

      // DESKTOP: Ouvrir popup web
      const width = 600, height = 700;
      const left = (screen.width - width) / 2;
      const top = (screen.height - height) / 2;

      const popup = window.open(
        oauthUrl,
        "gmail_oauth",
        `width=${width},height=${height},top=${top},left=${left},toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes`
      );

      // √âcouter le message de succ√®s
      const messageHandler = (event) => {
        if (event.data === 'gmail_connected') {
          log('‚úÖ Gmail connect√© avec succ√®s');
          if (popup && !popup.closed) {
            popup.close();
          }
          checkEmailConnection();
          window.removeEventListener('message', messageHandler);
        }
      };

      window.addEventListener('message', messageHandler);

    } catch (error) {
      error('‚ùå Erreur lors de la connexion Gmail:', error);
    }
  }


  function disconnectGmail() {
    fetch(`/deconnecter-email?username=${username}`, { method: "DELETE" })
      .then(() => {
        checkEmailConnection();
        setTimeout(() => updateProfileProgress(), 500); // Mettre √† jour apr√®s que l'UI soit mise √† jour
      });
  }

  btn.onclick = () => {
    if (btn.textContent === "D√©connecter") disconnect();
    else connect();
  };

  if (emailConnectBtn) emailConnectBtn.onclick = connectGmail;
  if (emailDisconnectBtn) emailDisconnectBtn.onclick = disconnectGmail;

  window.addEventListener("message", (event) => {
    if (event.data === "gmail_connected") {
      checkEmailConnection();
      setTimeout(() => updateProfileProgress(), 500); // Mettre √† jour apr√®s que l'UI soit mise √† jour
    }
    if (event.data === "agenda_connected") {
      checkConnection();
      setTimeout(() => updateProfileProgress(), 500); // Mettre √† jour apr√®s que l'UI soit mise √† jour
    }
  });

  function checkEmailConnection() {
    fetch(`/email-connecte?username=${username}`)
      .then(res => {
        if (!res.ok) throw new Error();
        return res.json();
      })
      .then(data => {
        // Changer les √©tats pour email connect√©
        document.getElementById("email-disconnected").classList.add("hidden");
        document.getElementById("email-connected-actions").classList.remove("hidden");
        document.getElementById("email-status-disconnected").classList.add("hidden");
        document.getElementById("email-status-connected").classList.remove("hidden");
        document.getElementById("gmail-box").classList.remove("hidden");
        document.getElementById("gmail-email").textContent = data.email || "";
      })
      .catch(() => {
        // √âtats par d√©faut (non connect√©)
        document.getElementById("email-disconnected").classList.remove("hidden");
        document.getElementById("email-connected-actions").classList.add("hidden");
        document.getElementById("email-status-disconnected").classList.remove("hidden");
        document.getElementById("email-status-connected").classList.add("hidden");
        document.getElementById("gmail-box").classList.add("hidden");
      });
  }

  checkConnection();
  checkEmailConnection();

});

// Variables globales pour le popup
let confirmPopup, confirmMessage, confirmYesBtn, confirmNoBtn;

// Initialiser les √©l√©ments du popup apr√®s chargement du DOM
setTimeout(() => {
  confirmPopup = document.getElementById("confirm-popup");
  confirmMessage = document.getElementById("confirm-message");
  confirmYesBtn = document.getElementById("confirm-yes");
  confirmNoBtn = document.getElementById("confirm-no");
}, 100);

function showConfirm(message) {
  return new Promise((resolve) => {
    // V√©rifier que les √©l√©ments existent
    if (!confirmMessage || !confirmPopup || !confirmYesBtn || !confirmNoBtn) {
      error("√âl√©ments du popup de confirmation non trouv√©s");
      resolve(true); // Par d√©faut, accepter l'action
      return;
    }

    confirmMessage.textContent = message;
    confirmPopup.classList.remove("hidden");

    function onYes() {
      cleanup();
      resolve(true);
    }
    function onNo() {
      cleanup();
      resolve(false);
    }

    function cleanup() {
      confirmPopup.classList.add("hidden");
      confirmYesBtn.removeEventListener("click", onYes);
      confirmNoBtn.removeEventListener("click", onNo);
    }

    confirmYesBtn.addEventListener("click", onYes);
    confirmNoBtn.addEventListener("click", onNo);
  });
}

// Toggle entre mode lecture et mode √©dition des informations
function toggleEditInfo() {
  const btn = document.getElementById("edit-info-btn");
  const fields = document.querySelectorAll(".info-field");
  const fileInputs = document.querySelectorAll(".info-file-input");
  const fileButtons = document.querySelectorAll(".file-upload-btn");

  // Si on est en mode "Modifier", on passe en mode √©dition
  if (btn.textContent.trim() === "Modifier") {
    // Activer les champs
    fields.forEach(field => field.disabled = false);

    // Activer les inputs fichiers
    fileInputs.forEach(input => input.disabled = false);

    // Activer visuellement les boutons fichiers
    fileButtons.forEach(button => {
      button.style.opacity = "1";
      button.style.cursor = "pointer";
      button.style.pointerEvents = "auto";
    });

    // Afficher les boutons X et permettre le clic sur les fichiers
    const removeButtons = document.querySelectorAll(".file-remove-btn");
    removeButtons.forEach(btn => btn.style.display = "flex");

    const previewLinks = document.querySelectorAll(".file-preview-link");
    previewLinks.forEach(link => link.style.pointerEvents = "auto");

    // Changer le bouton en "Enregistrer"
    btn.textContent = "Enregistrer";
  }
  // Si on est en mode "Enregistrer", on sauvegarde et repasse en mode lecture
  else {
    saveInfo();
  }
}

// Fonction pour ajouter une nouvelle √©quipe (seulement en mode √©dition)
function addNewTeam() {
  if (!isEditingTeams) return;

  teams.push({ nom: "", painters: [] });
  renderTeams();

  // R√©appliquer le mode √©dition aux nouveaux √©l√©ments
  const teamNameInputs = document.querySelectorAll(".team-name-input");
  const teamRemoveBtns = document.querySelectorAll(".team-remove-btn");
  const teamAddMemberBtns = document.querySelectorAll(".team-add-member-btn");
  const memberRemoveBtns = document.querySelectorAll(".team-member-remove-btn");

  teamNameInputs.forEach(input => {
    input.disabled = false;
    input.style.background = "rgba(23, 32, 51, 0.6)";
    input.style.color = "var(--text-light)";
    input.style.cursor = "text";
    input.style.border = "2px solid var(--border-dark)";
  });

  teamRemoveBtns.forEach(btn => btn.style.display = "flex");
  teamAddMemberBtns.forEach(btn => btn.style.display = "inline-block");
  memberRemoveBtns.forEach(btn => btn.style.display = "flex");
}

// Toggle entre mode lecture et mode √©dition des √©quipes
function toggleEditTeams() {
  const btn = document.getElementById("edit-teams-btn");
  const addTeamBtn = document.getElementById("add-team-btn");

  // D√©clarer les variables au d√©but de la fonction pour √©viter les erreurs de scope
  let teamNameInputs, teamRemoveBtns, teamAddMemberBtns, memberRemoveBtns;

  // Si on est en mode "Modifier" ou "Ajouter ma premi√®re √©quipe", on passe en mode √©dition
  if (btn.textContent.trim() === "Modifier" || btn.textContent.trim() === "Ajouter ma premi√®re √©quipe") {
    isEditingTeams = true; // Activer le mode √©dition

    // Si c'est "Ajouter ma premi√®re √©quipe", cr√©er une √©quipe vide automatiquement
    if (btn.textContent.trim() === "Ajouter ma premi√®re √©quipe") {
      teams.push({ nom: "", painters: [] });
      renderTeams();
    }

    // Afficher le bouton "Ajouter une √©quipe"
    if (addTeamBtn) addTeamBtn.style.display = "inline-block";

    // Re-s√©lectionner les √©l√©ments apr√®s le render potentiel
    teamNameInputs = document.querySelectorAll(".team-name-input");
    teamRemoveBtns = document.querySelectorAll(".team-remove-btn");
    teamAddMemberBtns = document.querySelectorAll(".team-add-member-btn");
    memberRemoveBtns = document.querySelectorAll(".team-member-remove-btn");

    // Activer les champs de nom d'√©quipe
    teamNameInputs.forEach(input => {
      input.disabled = false;
      input.style.background = "rgba(23, 32, 51, 0.6)";
      input.style.color = "var(--text-light)";
      input.style.cursor = "text";
      input.style.border = "2px solid var(--border-dark)";
    });

    // Afficher les boutons "Supprimer l'√©quipe"
    teamRemoveBtns.forEach(btn => {
      btn.style.display = "flex";
    });

    // Afficher les boutons "+" pour ajouter des membres
    teamAddMemberBtns.forEach(btn => {
      btn.style.display = "inline-block";
    });

    // Afficher les boutons "√ó" pour retirer des membres
    memberRemoveBtns.forEach(btn => {
      btn.style.display = "flex";
    });

    // Changer le bouton en "Enregistrer"
    btn.textContent = "Enregistrer";
  }
  // Si on est en mode "Enregistrer", on valide et sauvegarde
  else {
    // V√©rifier s'il y a des √©quipes sans membres
    const teamsWithoutMembers = teams.filter(team => !team.painters || team.painters.length === 0);
    const validTeams = teams.filter(team => team.painters && team.painters.length > 0);

    // Si toutes les √©quipes sont invalides (0 membre), afficher un message d'erreur
    if (teams.length > 0 && validTeams.length === 0) {
      showToast("Impossible d'enregistrer : chaque √©quipe doit avoir au moins un membre", "error");
      return; // Ne pas sortir du mode √©dition
    }

    // Si certaines √©quipes n'ont pas de membres, avertir l'utilisateur
    if (teamsWithoutMembers.length > 0) {
      const teamNames = teamsWithoutMembers.map(t => t.nom || "Sans nom").join(", ");
      showToast(`Les √©quipes sans membres seront supprim√©es : ${teamNames}`, "warning");
    }

    // Mettre √† jour teams avec seulement les √©quipes valides
    teams = validTeams;

    isEditingTeams = false; // D√©sactiver le mode √©dition

    // Masquer le bouton "Ajouter une √©quipe"
    if (addTeamBtn) addTeamBtn.style.display = "none";

    // Sauvegarder les √©quipes
    saveTeams(teams);

    // Rafra√Æchir l'affichage avec les √©quipes valides uniquement
    renderTeams();

    // Re-s√©lectionner les √©l√©ments pour la d√©sactivation
    teamNameInputs = document.querySelectorAll(".team-name-input");
    teamRemoveBtns = document.querySelectorAll(".team-remove-btn");
    teamAddMemberBtns = document.querySelectorAll(".team-add-member-btn");
    memberRemoveBtns = document.querySelectorAll(".team-member-remove-btn");

    // D√©sactiver les champs
    teamNameInputs.forEach(input => {
      input.disabled = true;
      input.style.background = "rgba(128, 128, 128, 0.1)";
      input.style.color = "rgba(255, 255, 255, 0.5)";
      input.style.cursor = "not-allowed";
      input.style.border = "2px solid rgba(128, 128, 128, 0.3)";
    });

    // Masquer les boutons "Supprimer l'√©quipe"
    teamRemoveBtns.forEach(btn => {
      btn.style.display = "none";
    });

    // Masquer les boutons "+" pour ajouter des membres
    teamAddMemberBtns.forEach(btn => {
      btn.style.display = "none";
    });

    // Masquer les boutons "√ó" pour retirer des membres
    memberRemoveBtns.forEach(btn => {
      btn.style.display = "none";
    });

    // Changer le bouton en "Modifier"
    btn.textContent = "Modifier";
  }
}

async function saveInfo() {
  const btn = document.getElementById("edit-info-btn");
  const originalText = btn.innerHTML;

  // Filtrer les √©quipes qui ont au moins un membre
  const validTeams = (teams || []).filter(team => team.painters && team.painters.length > 0);

  const data = {
    nom: document.getElementById("nom").value.trim(),
    prenom: document.getElementById("prenom").value.trim(),
    telephone: document.getElementById("telephone").value.trim(),
    courriel: document.getElementById("courriel").value.trim(),
    neq: document.getElementById("neq").value.trim(),
    tps: document.getElementById("tps").value.trim(),
    tvq: document.getElementById("tvq").value.trim(),
    equipes: validTeams,
    niveau_actuel: parseInt(document.getElementById("niveau-actuel")?.value || "1", 10),
    // flags de suppression si l'utilisateur a cliqu√© sur ‚úï
    specimen_delete: document.getElementById("specimen-preview").classList.contains("hidden"),
    betonel_delete: document.getElementById("betonel-preview").classList.contains("hidden"),
    integration_delete: document.getElementById("integration-preview").classList.contains("hidden"),
  };

  // Validation des champs obligatoires (seuls les fichiers peuvent √™tre vides)
  const champsObligatoires = [
    { nom: 'Pr√©nom', valeur: data.prenom },
    { nom: 'Nom', valeur: data.nom },
    { nom: 'T√©l√©phone', valeur: data.telephone },
    { nom: 'Courriel', valeur: data.courriel }
  ];

  const champsVides = champsObligatoires.filter(champ => !champ.valeur);

  if (champsVides.length > 0) {
    const listeChamps = champsVides.map(c => c.nom).join(', ');
    showToast(`Veuillez remplir les champs obligatoires: ${listeChamps}`, "error");
    return;
  }

  log("[DEBUG] Donn√©es √† envoyer:", data);

  const formData = new FormData();
  formData.append("username", username);
  formData.append("data", JSON.stringify(data));

  const specimen = document.getElementById("specimen").files[0];
  const betonel = document.getElementById("betonel").files[0];
  const integration = document.getElementById("integration").files[0];

  if (specimen) formData.append("specimen", specimen);
  if (betonel) formData.append("betonel", betonel);
  if (integration) formData.append("integration", integration);

  try {
    // Afficher le spinner
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Sauvegarde...';

    const res = await fetch("/api/save-info", { method: "POST", body: formData });
    if (!res.ok) throw new Error(await res.text());

    // recharge les infos depuis le serveur (avec cache-busting)
    await loadInfos(true);
    // vide les inputs fichiers pour √©viter r√©-upload involontaire
    ["specimen","betonel","integration"].forEach(id => document.getElementById(id).value = "");

    // Afficher notification de succ√®s
    showToast("Informations sauvegard√©es avec succ√®s", "success");

    // Mettre √† jour la progression du profil
    updateProfileProgress();

    // Repasser en mode lecture
    const fields = document.querySelectorAll(".info-field");
    fields.forEach(field => field.disabled = true);

    // D√©sactiver les inputs fichiers
    const fileInputs = document.querySelectorAll(".info-file-input");
    fileInputs.forEach(input => input.disabled = true);

    // D√©sactiver visuellement les boutons fichiers
    const fileButtons = document.querySelectorAll(".file-upload-btn");
    fileButtons.forEach(button => {
      button.style.opacity = "0.5";
      button.style.cursor = "not-allowed";
      button.style.pointerEvents = "none";
    });

    // Cacher les boutons X et d√©sactiver le clic sur les fichiers
    const removeButtons = document.querySelectorAll(".file-remove-btn");
    removeButtons.forEach(btn => btn.style.display = "none");

    const previewLinks = document.querySelectorAll(".file-preview-link");
    previewLinks.forEach(link => link.style.pointerEvents = "none");

    btn.textContent = "Modifier";
  } catch (e) {
    showToast("Une erreur s'est produite lors de la sauvegarde", "error");
    error(e);
  } finally {
    // Restaurer le bouton
    btn.disabled = false;
    if (btn.textContent.includes("Sauvegarde")) {
      btn.textContent = "Enregistrer";
    }
  }
}

function previewFile(field, input) {
  const file = input.files[0];
  if (!file) return;

  const previewBox = document.getElementById(field + "-preview");
  const link = previewBox.querySelector("a");
  const img = previewBox.querySelector("img");

  if (file.type.startsWith("image/")) {
    const reader = new FileReader();
    reader.onload = function(e) {
      img.src = e.target.result;
      link.href = e.target.result;
      previewBox.classList.remove("hidden");
    };
    reader.readAsDataURL(file);
  } 
  else if (file.type === "application/pdf") {
    const reader = new FileReader();
    reader.onload = async function(e) {
      try {
        const pdfData = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 0.5 });
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        await page.render({ canvasContext: context, viewport }).promise;

        img.src = canvas.toDataURL("image/png"); // preview
        link.href = URL.createObjectURL(file);   // lien vers PDF complet
        previewBox.classList.remove("hidden");
      } catch (err) {
        error("Erreur PDF.js:", err);
        img.src = "https://cdn-icons-png.flaticon.com/512/337/337946.png";
        link.href = URL.createObjectURL(file);
        previewBox.classList.remove("hidden");
      }
    };
    reader.readAsArrayBuffer(file);
  } 
  else {
    img.src = "https://cdn-icons-png.flaticon.com/512/337/337946.png"; // ic√¥ne par d√©faut
    link.href = URL.createObjectURL(file);
    previewBox.classList.remove("hidden");
  }
}

function removeFile(field) {
  const input = document.getElementById(field);
  input.value = "";
  const previewBox = document.getElementById(field + "-preview");
  previewBox.classList.add("hidden");
  const img = previewBox.querySelector("img");
  img.src = "";
}

async function loadInfos(bust = false) {
  // Attendre que window.username soit d√©fini
  if (!window.username) {
    log('[WARN] Attente de window.username pour loadInfos...');
    setTimeout(() => loadInfos(bust), 100);
    return;
  }

  const res = await fetch(`/api/get-info/${window.username}`);
  if (!res.ok) return;
  const result = await res.json();

  log("[DEBUG] Donn√©es re√ßues du backend:", result.data);

  // V√©rifier que les √©l√©ments existent avant de les remplir
  const nomElement = document.getElementById("nom");
  const prenomElement = document.getElementById("prenom");
  const telephoneElement = document.getElementById("telephone");
  const courrielElement = document.getElementById("courriel");

  log("[DEBUG] √âl√©ments trouv√©s:", {
    nom: nomElement ? "[OK]" : "[ERROR]",
    prenom: prenomElement ? "[OK]" : "[ERROR]",
    telephone: telephoneElement ? "[OK]" : "[ERROR]",
    courriel: courrielElement ? "[OK]" : "[ERROR]"
  });

  if (nomElement) nomElement.value = result.data?.nom || "";
  if (prenomElement) prenomElement.value = result.data?.prenom || "";
  if (telephoneElement) telephoneElement.value = result.data?.telephone || "";
  if (courrielElement) courrielElement.value = result.data?.courriel || "";

  // Info entreprise avec v√©rification
  const neqElement = document.getElementById("neq");
  const tpsElement = document.getElementById("tps");
  const tvqElement = document.getElementById("tvq");

  log("[DEBUG] √âl√©ments entreprise trouv√©s:", {
    neq: neqElement ? "[OK]" : "[ERROR]",
    tps: tpsElement ? "[OK]" : "[ERROR]",
    tvq: tvqElement ? "[OK]" : "[ERROR]"
  });

  log("[DEBUG] Valeurs entreprise re√ßues:", {
    neq: result.data?.neq,
    tps: result.data?.tps,
    tvq: result.data?.tvq
  });

  if (neqElement) neqElement.value = result.data?.neq || "";
  if (tpsElement) tpsElement.value = result.data?.tps || "";
  if (tvqElement) tvqElement.value = result.data?.tvq || "";

  // Charger les √©quipes depuis le backend (user_info.json)
  // Filtrer pour ne garder que les √©quipes avec au moins 1 membre
  if (result.data?.equipes && Array.isArray(result.data.equipes)) {
    teams = result.data.equipes.filter(team => team.painters && team.painters.length > 0);
    renderTeams();
  } else {
    teams = [];
    renderTeams();
  }

  // Charger le niveau actuel
  const niveauElement = document.getElementById("niveau-actuel");
  if (niveauElement) {
    niveauElement.value = result.data?.niveau_actuel || 1;
  }

  // reset previews
  ["specimen","betonel","integration"].forEach(field => {
    const box = document.getElementById(field + "-preview");
    box.classList.add("hidden");
    const img = box.querySelector("img");
    img.src = "";
    box.querySelector("a").href = "#";
  });

  const ver = bust ? (`?v=` + Date.now()) : "";
  for (const [field, url] of Object.entries(result.files || {})) {
    const box = document.getElementById(field + "-preview");
    if (!box) continue; // Skip if element doesn't exist
    const link = box.querySelector("a");
    const img = box.querySelector("img");

    // si PDF, on rend la 1√®re page; sinon image directe
    if (url.toLowerCase().endsWith(".pdf")) {
      const loadingTask = pdfjsLib.getDocument(url + ver);
      loadingTask.promise.then(async pdf => {
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 0.5 });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.height = viewport.height; canvas.width = viewport.width;
        await page.render({ canvasContext: ctx, viewport }).promise;
        img.src = canvas.toDataURL("image/png");
        link.href = url + ver;
        box.classList.remove("hidden");
      }).catch(() => {
        img.src = "https://cdn-icons-png.flaticon.com/512/337/337946.png";
        link.href = url + ver;
        box.classList.remove("hidden");
      });
    } else {
      img.src = url + ver;
      link.href = url + ver;
      box.classList.remove("hidden");
    }
  }

  // Par d√©faut, cacher les boutons X et d√©sactiver le clic sur les fichiers
  const removeButtons = document.querySelectorAll(".file-remove-btn");
  removeButtons.forEach(btn => btn.style.display = "none");

  const previewLinks = document.querySelectorAll(".file-preview-link");
  previewLinks.forEach(link => link.style.pointerEvents = "none");

  // Afficher les avertissements si les donn√©es sont vides
  updateEmptyWarnings(result.data, result.files);
}

// Fonction pour mettre √† jour les avertissements de donn√©es vides
function updateEmptyWarnings(data, files) {
  // V√©rifier si l'information entreprise est vide (NEQ, TPS, TVQ)
  const businessWarning = document.getElementById('business-empty-warning');
  if (businessWarning) {
    const hasBusinessInfo = (data?.neq && data.neq.trim()) ||
                            (data?.tps && data.tps.trim()) ||
                            (data?.tvq && data.tvq.trim());
    businessWarning.style.display = hasBusinessInfo ? 'none' : 'block';
  }

  // V√©rifier si les documents sont vides (specimen, betonel, integration)
  const documentsWarning = document.getElementById('documents-empty-warning');
  if (documentsWarning) {
    const hasDocuments = files && (files.specimen || files.betonel || files.integration);
    documentsWarning.style.display = hasDocuments ? 'none' : 'block';
  }
}
window.addEventListener("DOMContentLoaded", () => loadInfos());

pdfjsLib.GlobalWorkerOptions.workerSrc = 
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

// Gestion de la signature
document.addEventListener("DOMContentLoaded", function() {
  const canvas = document.getElementById("signature-pad");
  const ctx = canvas.getContext("2d");
  const clearBtn = document.getElementById("clear-signature-btn");
  const saveBtn = document.getElementById("save-signature-btn");
  const editBtn = document.getElementById("edit-signature-btn");
  const drawingMode = document.getElementById("signature-drawing-mode");
  const savedMode = document.getElementById("signature-saved-mode");
  const signatureImg = document.getElementById("signature-image");

  // Configuration du canvas - toujours 150px de hauteur
  function setupCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);

    // Utiliser le parent container pour la largeur (plus fiable que le canvas lui-m√™me)
    const container = canvas.parentElement;
    const containerWidth = container ? container.offsetWidth : window.innerWidth - 64;

    // Largeur responsive, hauteur fixe √† 150px
    const isMobile = window.innerWidth <= 768;
    const isTablet = window.innerWidth > 768 && window.innerWidth <= 1366;

    // Calculer la largeur: utiliser le container ou fallback
    let targetWidth;
    if (isMobile) {
      targetWidth = Math.min(containerWidth - 16, window.innerWidth - 64, 400);
    } else if (isTablet) {
      targetWidth = Math.min(containerWidth - 16, 400);
    } else {
      targetWidth = 400;
    }

    // Minimum 280px pour pouvoir signer
    const canvasWidth = Math.max(targetWidth, 280);
    const canvasHeight = 150; // Toujours 150px

    canvas.width = canvasWidth * ratio;
    canvas.height = canvasHeight * ratio;
    canvas.style.width = canvasWidth + "px";
    canvas.style.height = canvasHeight + "px";

    ctx.scale(ratio, ratio);
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.lineWidth = 2; // M√™me √©paisseur sur toutes les plateformes
    ctx.strokeStyle = '#ffffff';

    // IMPORTANT: S'assurer que le fond reste transparent
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    console.log('[SIGNATURE] Canvas setup:', canvasWidth, 'x', canvasHeight, 'ratio:', ratio);
  }

  // Initialiser le canvas - multiple tentatives pour s'assurer que c'est correct
  setupCanvas();
  setTimeout(setupCanvas, 100);
  setTimeout(setupCanvas, 300);
  setTimeout(setupCanvas, 500);
  setTimeout(setupCanvas, 1000);
  window.addEventListener('load', setupCanvas);

  // Observer pour d√©tecter quand le canvas devient visible
  const canvasObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        setupCanvas();
      }
    });
  });
  canvasObserver.observe(canvas);

  // Appeler setupCanvas quand on clique sur Modifier
  if (editBtn) {
    const originalEditClick = editBtn.onclick;
    editBtn.addEventListener("click", () => {
      setTimeout(setupCanvas, 50);
    });
  }

  // Variables de dessin
  let drawing = false;
  let points = [];

  // Fonction pour obtenir les coordonn√©es (mobile/desktop)
  function getEventPos(e) {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : e;
    const clientX = touch.clientX || e.clientX;
    const clientY = touch.clientY || e.clientY;

    // Calculer les coordonn√©es en tenant compte du ratio entre taille affich√©e et taille r√©elle
    const scaleX = rect.width / 400; // 400 est la largeur de base
    const scaleY = rect.height / 150; // 150 est la hauteur fixe

    return {
      x: (clientX - rect.left) / scaleX,
      y: (clientY - rect.top) / scaleY
    };
  }

  function startDrawing(e) {
    e.preventDefault();
    drawing = true;
    points = [];
    const pos = getEventPos(e);
    points.push(pos);
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
  }

  function draw(e) {
    if (!drawing) return;
    e.preventDefault();

    const pos = getEventPos(e);
    points.push(pos);

    if (points.length >= 3) {
      const [p0, p1, p2] = points.slice(-3);
      const cpx = (p0.x + p1.x) / 2;
      const cpy = (p0.y + p1.y) / 2;
      ctx.quadraticCurveTo(p0.x, p0.y, cpx, cpy);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(cpx, cpy);
    } else {
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
    }
  }

  function stopDrawing(e) {
    if (!drawing) return;
    e.preventDefault();
    drawing = false;

    if (points.length >= 3) {
      const lastTwoPoints = points.slice(-2);
      ctx.lineTo(lastTwoPoints[1].x, lastTwoPoints[1].y);
      ctx.stroke();
    }
    ctx.closePath();
  }

  // √âv√©nements tactiles (mobile)
  canvas.addEventListener("touchstart", startDrawing, { passive: false });
  canvas.addEventListener("touchmove", draw, { passive: false });
  canvas.addEventListener("touchend", stopDrawing, { passive: false });

  // √âv√©nements souris (desktop)
  canvas.addEventListener("mousedown", startDrawing);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", stopDrawing);

  // √âv√©nements pointer (hybride - pour compatibilit√©)
  canvas.addEventListener("pointerdown", startDrawing);
  canvas.addEventListener("pointermove", draw);
  canvas.addEventListener("pointerup", stopDrawing);

  // Bouton effacer
  clearBtn.addEventListener("click", () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  });

  // Bouton sauvegarder
  saveBtn.addEventListener("click", async () => {
    // V√©rifier qu'il y a une signature
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    if (imgData.data.every(v => v === 0)) {
      showToast("Veuillez dessiner votre signature avant de sauvegarder", "error");
      return;
    }

    const signatureDataUrl = canvas.toDataURL("image/png");
    const originalText = saveBtn.innerHTML;

    try {
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="spinner"></span> Sauvegarde...';

      const response = await fetch('/api/save-signature', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: username,
          signatureData: signatureDataUrl
        })
      });

      if (!response.ok) throw new Error(`Erreur ${response.status}`);

      // Passer en mode signature sauvegard√©e
      signatureImg.src = signatureDataUrl;

      // Toujours 150px de hauteur pour la signature
      signatureImg.style.height = "150px";

      drawingMode.classList.add("hidden");
      savedMode.classList.remove("hidden");

      // Afficher notification de succ√®s
      showToast("Signature sauvegard√©e avec succ√®s", "success");

      // Mettre √† jour la progression du profil
      updateProfileProgress();

    } catch (error) {
      showToast("Une erreur s'est produite lors de la sauvegarde", "error");
      error(error);
    } finally {
      saveBtn.disabled = false;
      saveBtn.innerHTML = originalText;
    }
  });

  // Bouton modifier signature
  editBtn.addEventListener("click", () => {
    // Retour en mode dessin
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    savedMode.classList.add("hidden");
    drawingMode.classList.remove("hidden");
  });

  // Charger la signature existante au d√©marrage
  loadExistingSignature();

  async function loadExistingSignature() {
    try {
      const response = await fetch(`/api/get-signature/${window.username}`);
      if (response.ok) {
        const data = await response.json();
        if (data.signatureUrl) {
          signatureImg.src = data.signatureUrl;

          // Toujours 150px de hauteur pour la signature
          signatureImg.style.height = "150px";

          drawingMode.classList.add("hidden");
          savedMode.classList.remove("hidden");
        }
      }
    } catch (error) {
      log("Aucune signature existante trouv√©e");
    }
  }
});

// Gestion de la photo de profil avec √©diteur circulaire
document.addEventListener("DOMContentLoaded", function() {
  const photoInput = document.getElementById("profile-photo-input");
  const cameraInput = document.getElementById("camera-capture-input");
  const photoMenuBtn = document.getElementById("photo-menu-btn");
  const photoMenuDropdown = document.getElementById("photo-menu-dropdown");
  const uploadPhotoOption = document.getElementById("upload-photo-option");
  const cameraPhotoOption = document.getElementById("camera-photo-option");
  const profilePhotoImage = document.getElementById("profile-photo-image");
  const profilePhotoPlaceholder = document.getElementById("profile-photo-placeholder");

  // Modal et √©diteur
  const editorModal = document.getElementById("photo-editor-modal");
  const closeEditorBtn = document.getElementById("close-editor-btn");
  const cancelEditorBtn = document.getElementById("cancel-editor-btn");
  const saveEditorBtn = document.getElementById("save-editor-btn");
  const canvas = document.getElementById("photo-editor-canvas");
  const ctx = canvas.getContext("2d");
  const zoomSlider = document.getElementById("zoom-slider");

  let currentImage = null;
  let imageScale = 1;
  let imageX = 0;
  let imageY = 0;
  let isDragging = false;
  let startX, startY;

  // D√©tection mobile
  const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;

  // Toggle menu dropdown
  photoMenuBtn.addEventListener("click", (e) => {
    e.stopPropagation();

    // Sur mobile, ouvrir directement le s√©lecteur de fichiers natif
    if (isMobileDevice) {
      photoInput.click();
    } else {
      // Sur desktop, afficher le menu
      photoMenuDropdown.classList.toggle("hidden");
    }
  });

  // Fermer le menu en cliquant ailleurs
  document.addEventListener("click", () => {
    photoMenuDropdown.classList.add("hidden");
  });

  // Option: Modifier photo
  uploadPhotoOption.addEventListener("click", () => {
    photoMenuDropdown.classList.add("hidden");
    photoInput.click();
  });

  // Variable pour stocker le stream de la cam√©ra
  let cameraStream = null;
  let qrCheckInterval = null;
  let currentSessionId = null;

  // Option: Prendre photo - Ouvrir le modal de choix
  cameraPhotoOption.addEventListener("click", () => {
    photoMenuDropdown.classList.add("hidden");
    document.getElementById("camera-choice-modal").classList.remove("hidden");
  });

  // Fermer le modal de choix
  document.getElementById("close-choice-modal-btn").addEventListener("click", () => {
    document.getElementById("camera-choice-modal").classList.add("hidden");
  });

  // Choix cam√©ra PC
  document.getElementById("use-pc-camera-btn").addEventListener("click", async () => {
    document.getElementById("camera-choice-modal").classList.add("hidden");
    await openCamera();
  });

  // Choix QR Code Mobile
  document.getElementById("use-mobile-qr-btn").addEventListener("click", () => {
    document.getElementById("camera-choice-modal").classList.add("hidden");
    openQRModal();
  });

  // Fonction pour ouvrir la cam√©ra
  async function openCamera() {
    const cameraModal = document.getElementById("camera-modal");
    const video = document.getElementById("camera-video");

    try {
      // Demander l'acc√®s √† la cam√©ra (pr√©f√©rence pour la cam√©ra frontale sur mobile)
      cameraStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false
      });

      video.srcObject = cameraStream;
      cameraModal.classList.remove("hidden");
    } catch (error) {
      error("Erreur d'acc√®s √† la cam√©ra:", error);
      showToast("Impossible d'acc√©der √† la cam√©ra", "error");
    }
  }

  // Fonction pour arr√™ter la cam√©ra
  function stopCamera() {
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
      cameraStream = null;
    }
    document.getElementById("camera-modal").classList.add("hidden");
  }

  // Bouton fermer cam√©ra
  document.getElementById("close-camera-btn").addEventListener("click", stopCamera);
  document.getElementById("cancel-camera-btn").addEventListener("click", stopCamera);

  // Bouton capturer photo
  document.getElementById("capture-photo-btn").addEventListener("click", () => {
    const video = document.getElementById("camera-video");
    const canvas = document.getElementById("camera-canvas");
    const ctx = canvas.getContext("2d");

    // D√©finir la taille du canvas bas√©e sur la vid√©o
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    // Dessiner l'image de la vid√©o sur le canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Convertir en blob et traiter comme un fichier
    canvas.toBlob((blob) => {
      stopCamera();

      // Cr√©er un objet File depuis le blob
      const file = new File([blob], "camera-photo.jpg", { type: "image/jpeg" });
      handleImageFile(file);
    }, "image/jpeg", 0.95);
  });

  // Fonction pour ouvrir le modal QR
  function openQRModal() {
    const qrModal = document.getElementById("qr-modal");
    const qrcodeContainer = document.getElementById("qrcode-container");

    // G√©n√©rer un ID de session unique
    currentSessionId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substring(7);

    // Nettoyer le container QR
    qrcodeContainer.innerHTML = '';

    // Utiliser l'adresse IP locale pour que le mobile puisse se connecter
    const hostname = window.location.hostname;
    const port = window.location.port;
    const protocol = window.location.protocol;

    // Si on est sur localhost, utiliser l'IP locale
    let baseUrl;
    if (hostname === 'localhost' || hostname === '127.0.0.1') {
      baseUrl = `${protocol}//192.168.2.231:${port}`;
    } else {
      baseUrl = window.location.origin;
    }

    const mobileUrl = `${baseUrl}/mobile-camera?session=${currentSessionId}&username=${encodeURIComponent(username)}`;

    // G√©n√©rer le QR code
    new QRCode(qrcodeContainer, {
      text: mobileUrl,
      width: 256,
      height: 256,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });

    // Afficher le modal
    qrModal.classList.remove("hidden");

    // Commencer √† v√©rifier si une photo a √©t√© upload√©e
    startPhotoPolling();
  }

  // Fonction pour d√©marrer le polling avec SSE
  function startPhotoPolling() {
    // Arr√™ter tout polling existant
    if (qrCheckInterval) {
      qrCheckInterval.close();
      qrCheckInterval = null;
    }

    // Utiliser Server-Sent Events pour recevoir la notification
    const eventSource = new EventSource(`/api/wait-mobile-photo/${currentSessionId}`);

    eventSource.onmessage = async (event) => {
      try {
        const data = JSON.parse(event.data);

        if (data.photo) {
          // Photo re√ßue!
          eventSource.close();
          stopPhotoPolling();

          // Convertir la base64 en blob
          const photoBlob = await fetch(data.photo).then(r => r.blob());
          const file = new File([photoBlob], "mobile-photo.jpg", { type: "image/jpeg" });

          // Traiter la photo
          handleImageFile(file);
        }
      } catch (error) {
        error("Erreur lors du traitement de la photo:", error);
      }
    };

    eventSource.onerror = (error) => {
      error("Erreur SSE:", error);
      eventSource.close();
    };

    // Stocker la r√©f√©rence
    qrCheckInterval = eventSource;
  }

  // Fonction pour arr√™ter le polling
  function stopPhotoPolling() {
    if (qrCheckInterval) {
      if (qrCheckInterval.close) {
        qrCheckInterval.close();
      }
      qrCheckInterval = null;
    }
    document.getElementById("qr-modal").classList.add("hidden");
    currentSessionId = null;
  }

  // Boutons fermer/annuler QR modal
  document.getElementById("close-qr-modal-btn").addEventListener("click", stopPhotoPolling);
  document.getElementById("cancel-qr-btn").addEventListener("click", stopPhotoPolling);

  // Fonction commune pour traiter une image
  function handleImageFile(file) {
    if (file && file.type.startsWith("image/")) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          currentImage = img;
          imageScale = 1;

          // Centrer l'image
          const canvasSize = canvas.width;
          const minScale = canvasSize / Math.min(img.width, img.height);
          imageScale = minScale;
          imageX = (canvasSize - img.width * imageScale) / 2;
          imageY = (canvasSize - img.height * imageScale) / 2;

          zoomSlider.value = 1;

          // Ouvrir le modal
          editorModal.classList.remove("hidden");
          drawImage();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  }

  // Quand une image est s√©lectionn√©e (upload)
  photoInput.addEventListener("change", function(e) {
    const file = e.target.files[0];
    handleImageFile(file);
  });

  // Quand une photo est prise avec la cam√©ra
  cameraInput.addEventListener("change", function(e) {
    const file = e.target.files[0];
    handleImageFile(file);
  });

  // Fermer le modal
  function closeModal() {
    editorModal.classList.add("hidden");
    photoInput.value = "";
    currentImage = null;
  }

  closeEditorBtn.addEventListener("click", closeModal);
  cancelEditorBtn.addEventListener("click", closeModal);

  // Fonction pour contraindre la position de l'image (toujours couvrir le canvas)
  function constrainImagePosition() {
    const canvasSize = canvas.width;
    const scaledWidth = currentImage.width * imageScale;
    const scaledHeight = currentImage.height * imageScale;

    // L'image doit toujours couvrir le canvas enti√®rement
    // Limite √† droite/bas (l'image ne peut pas laisser d'espace vide)
    const maxX = 0;
    const maxY = 0;
    // Limite √† gauche/haut (l'image ne peut pas laisser d'espace vide)
    const minX = canvasSize - scaledWidth;
    const minY = canvasSize - scaledHeight;

    // Contraindre X
    if (imageX > maxX) imageX = maxX;
    if (imageX < minX) imageX = minX;

    // Contraindre Y
    if (imageY > maxY) imageY = maxY;
    if (imageY < minY) imageY = minY;
  }

  // Zoom avec le slider
  zoomSlider.addEventListener("input", function(e) {
    if (!currentImage) return;

    const canvasSize = canvas.width;
    const minScale = canvasSize / Math.min(currentImage.width, currentImage.height);
    const newScale = minScale * parseFloat(e.target.value);

    // Ajuster la position pour garder le centre
    const centerX = canvasSize / 2;
    const centerY = canvasSize / 2;
    const imageCenterX = imageX + (currentImage.width * imageScale) / 2;
    const imageCenterY = imageY + (currentImage.height * imageScale) / 2;

    imageX = centerX - (imageCenterX - imageX) * (newScale / imageScale);
    imageY = centerY - (imageCenterY - imageY) * (newScale / imageScale);
    imageScale = newScale;

    // Contraindre la position apr√®s le zoom
    constrainImagePosition();

    drawImage();
  });

  // Drag pour d√©placer l'image
  canvas.addEventListener("mousedown", function(e) {
    isDragging = true;
    startX = e.offsetX;
    startY = e.offsetY;
  });

  canvas.addEventListener("mousemove", function(e) {
    if (!isDragging || !currentImage) return;

    const dx = e.offsetX - startX;
    const dy = e.offsetY - startY;

    imageX += dx;
    imageY += dy;

    // Contraindre la position
    constrainImagePosition();

    startX = e.offsetX;
    startY = e.offsetY;

    drawImage();
  });

  canvas.addEventListener("mouseup", () => {
    isDragging = false;
  });

  canvas.addEventListener("mouseleave", () => {
    isDragging = false;
  });

  // Support tactile pour mobile
  canvas.addEventListener("touchstart", function(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    isDragging = true;
    startX = touch.clientX - rect.left;
    startY = touch.clientY - rect.top;
  });

  canvas.addEventListener("touchmove", function(e) {
    if (!isDragging || !currentImage) return;
    e.preventDefault();

    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const currentX = touch.clientX - rect.left;
    const currentY = touch.clientY - rect.top;

    const dx = currentX - startX;
    const dy = currentY - startY;

    imageX += dx;
    imageY += dy;

    // Contraindre la position
    constrainImagePosition();

    startX = currentX;
    startY = currentY;

    drawImage();
  });

  canvas.addEventListener("touchend", () => {
    isDragging = false;
  });

  // Dessiner l'image avec masque circulaire
  function drawImage() {
    if (!currentImage) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Dessiner l'image
    ctx.save();
    ctx.drawImage(currentImage, imageX, imageY, currentImage.width * imageScale, currentImage.height * imageScale);
    ctx.restore();

    // Appliquer un masque circulaire (overlay sombre avec cercle transparent)
    ctx.save();
    ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = canvas.width / 2;

    ctx.globalCompositeOperation = "destination-out";
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();

    // Dessiner le contour du cercle
    ctx.strokeStyle = "#60a5fa";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.stroke();
  }

  // Sauvegarder la photo cropp√©e
  saveEditorBtn.addEventListener("click", async () => {
    if (!currentImage) return;

    const originalText = saveEditorBtn.innerHTML;

    try {
      saveEditorBtn.disabled = true;
      saveEditorBtn.innerHTML = '<span class="spinner"></span> Sauvegarde...';

      // Cr√©er un canvas temporaire pour le crop circulaire
      const tempCanvas = document.createElement("canvas");
      const tempCtx = tempCanvas.getContext("2d");
      const size = canvas.width;
      tempCanvas.width = size;
      tempCanvas.height = size;

      // Dessiner l'image cropp√©e en cercle
      tempCtx.save();
      tempCtx.beginPath();
      tempCtx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
      tempCtx.clip();
      tempCtx.drawImage(currentImage, imageX, imageY, currentImage.width * imageScale, currentImage.height * imageScale);
      tempCtx.restore();

      // Convertir en base64
      const photoDataUrl = tempCanvas.toDataURL("image/png");

      // Sauvegarder via l'API
      const response = await fetch('/api/save-profile-photo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: username,
          photoData: photoDataUrl
        })
      });

      if (!response.ok) throw new Error(`Erreur ${response.status}`);

      // Afficher la photo
      profilePhotoImage.src = photoDataUrl;
      profilePhotoImage.classList.remove("hidden");
      profilePhotoPlaceholder.style.display = "none";

      // Mettre √† jour la photo dans le header
      updateHeaderProfilePhoto(photoDataUrl);

      // Fermer le modal
      closeModal();

      showToast("Photo de profil sauvegard√©e avec succ√®s", "success");

      // Mettre √† jour la progression du profil
      updateProfileProgress();

    } catch (error) {
      showToast("Une erreur s'est produite lors de la sauvegarde", "error");
      error(error);
    } finally {
      saveEditorBtn.disabled = false;
      saveEditorBtn.innerHTML = originalText;
    }
  });

  // Charger la photo existante au d√©marrage
  loadExistingProfilePhoto();

  async function loadExistingProfilePhoto() {
    try {
      const response = await fetch(`/api/get-profile-photo/${window.username}`);
      if (response.ok) {
        const data = await response.json();
        if (data.photoUrl) {
          profilePhotoImage.src = data.photoUrl;
          profilePhotoImage.classList.remove("hidden");
          profilePhotoPlaceholder.style.display = "none";

          // Mettre √† jour la photo dans le header
          updateHeaderProfilePhoto(data.photoUrl);
        }
      }
    } catch (error) {
      log("Aucune photo de profil existante trouv√©e");
    }
  }

  // Fonction pour mettre √† jour la photo dans le header
  function updateHeaderProfilePhoto(photoUrl) {
    log('üñºÔ∏è Mise √† jour de la photo de profil dans le header:', photoUrl);

    // Si on est dans un iframe, mettre √† jour le header de la page parent (apppc.html)
    if (window.parent && window.parent !== window) {
      try {
        const parentDoc = window.parent.document;

        // Desktop account avatar (dans le bouton header du parent)
        const accountAvatar = parentDoc.querySelector('.account-avatar img');
        if (accountAvatar) {
          accountAvatar.src = photoUrl;
          log('[OK] Desktop account avatar mis √† jour (parent)');
        }

        // Mobile profile icon (dans le header mobile du parent)
        const mobileProfileIcon = parentDoc.querySelector('.mobile-profile-icon');
        if (mobileProfileIcon) {
          mobileProfileIcon.innerHTML = `<img src="${photoUrl}" alt="Photo de profil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
          log('[OK] Mobile profile icon mis √† jour (parent)');
        }
      } catch (e) {
        log('[WARN] Impossible d\'acc√©der au parent (CORS):', e.message);
      }
    }

    // Aussi mettre √† jour localement si les √©l√©ments existent dans cette page
    const mobileProfileIcon = document.querySelector('.mobile-profile-icon');
    if (mobileProfileIcon) {
      mobileProfileIcon.innerHTML = `<img src="${photoUrl}" alt="Photo de profil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
      log('[OK] Mobile profile icon mis √† jour (local)');
    }

    const accountAvatar = document.querySelector('.account-avatar');
    if (accountAvatar) {
      const img = accountAvatar.querySelector('img');
      if (img) {
        img.src = photoUrl;
      } else {
        accountAvatar.innerHTML = `<img src="${photoUrl}" alt="Photo de profil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
      }
      log('[OK] Desktop account avatar mis √† jour (local)');
    }
  }
});

// Formatage automatique du t√©l√©phone (000-000-0000)
const telephoneInput = document.getElementById('telephone');

if (telephoneInput) {
  telephoneInput.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, ''); // Garder seulement les chiffres
    let formattedValue = '';

    if (value.length > 0) {
      formattedValue = value.substring(0, 3);
    }
    if (value.length >= 4) {
      formattedValue += '-' + value.substring(3, 6);
    }
    if (value.length >= 7) {
      formattedValue += '-' + value.substring(6, 10);
    }

    e.target.value = formattedValue;
  });

  telephoneInput.addEventListener('keydown', function(e) {
    // Si l'utilisateur appuie sur Backspace ou Delete
    if (e.key === 'Backspace' || e.key === 'Delete') {
      const cursorPos = e.target.selectionStart;
      const value = e.target.value;

      // Si le curseur est juste apr√®s un tiret, effacer le tiret + le chiffre avant
      if (e.key === 'Backspace' && cursorPos > 0 && value[cursorPos - 1] === '-') {
        e.preventDefault();
        const newValue = value.substring(0, cursorPos - 2) + value.substring(cursorPos);
        e.target.value = newValue;

        // Reformater
        const cleanValue = newValue.replace(/\D/g, '');
        let formattedValue = '';
        if (cleanValue.length > 0) {
          formattedValue = cleanValue.substring(0, 3);
        }
        if (cleanValue.length >= 4) {
          formattedValue += '-' + cleanValue.substring(3, 6);
        }
        if (cleanValue.length >= 7) {
          formattedValue += '-' + cleanValue.substring(6, 10);
        }

        e.target.value = formattedValue;

        // Repositionner le curseur
        const newCursorPos = cursorPos - 2;
        e.target.setSelectionRange(newCursorPos, newCursorPos);
      }
    }
  });
}

// =============================================
// FONCTIONS POUR LE CHANGEMENT DE MOT DE PASSE
// =============================================

// Toggle visibility du mot de passe
function togglePasswordVisibility(inputId) {
  const input = document.getElementById(inputId);
  const icon = input.nextElementSibling.querySelector('i');

  if (input.type === 'password') {
    input.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    input.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
}

// V√©rifier la force du mot de passe
function checkPasswordStrength(password) {
  const bars = [
    document.getElementById('strength-bar-1'),
    document.getElementById('strength-bar-2'),
    document.getElementById('strength-bar-3'),
    document.getElementById('strength-bar-4')
  ];
  const strengthText = document.getElementById('password-strength-text');

  // Crit√®res
  const hasLength = password.length >= 6;
  const hasUppercase = /[A-Z]/.test(password);
  const hasLowercase = /[a-z]/.test(password);
  const hasNumber = /[0-9]/.test(password);

  // Mettre √† jour les indicateurs visuels des crit√®res
  updateCriteria('criteria-length', hasLength);
  updateCriteria('criteria-uppercase', hasUppercase);
  updateCriteria('criteria-lowercase', hasLowercase);
  updateCriteria('criteria-number', hasNumber);

  // Calculer le score
  let score = 0;
  if (hasLength) score++;
  if (hasUppercase) score++;
  if (hasLowercase) score++;
  if (hasNumber) score++;

  // Reset bars
  bars.forEach(bar => {
    bar.style.background = 'var(--border-dark)';
  });

  // Couleurs selon le score
  let color, text;
  if (password.length === 0) {
    text = 'Entrez un mot de passe (minimum 6 caract√®res)';
    color = 'var(--text-gray)';
  } else if (score === 1) {
    bars[0].style.background = '#ef4444'; // Rouge
    text = 'Tr√®s faible';
    color = '#ef4444';
  } else if (score === 2) {
    bars[0].style.background = '#f97316'; // Orange
    bars[1].style.background = '#f97316';
    text = 'Faible';
    color = '#f97316';
  } else if (score === 3) {
    bars[0].style.background = '#eab308'; // Jaune
    bars[1].style.background = '#eab308';
    bars[2].style.background = '#eab308';
    text = 'Moyen';
    color = '#eab308';
  } else if (score === 4) {
    bars.forEach(bar => bar.style.background = '#22c55e'); // Vert
    text = 'Fort';
    color = '#22c55e';
  }

  strengthText.textContent = text;
  strengthText.style.color = color;

  // V√©rifier aussi la correspondance
  checkPasswordMatch();
}

// Mettre √† jour l'indicateur visuel d'un crit√®re
function updateCriteria(criteriaId, isValid) {
  const criteria = document.getElementById(criteriaId);
  if (!criteria) return;

  const icon = criteria.querySelector('i');

  if (isValid) {
    icon.classList.remove('fa-circle');
    icon.classList.add('fa-check-circle');
    criteria.style.color = '#22c55e';
  } else {
    icon.classList.remove('fa-check-circle');
    icon.classList.add('fa-circle');
    criteria.style.color = 'var(--text-gray)';
  }
}

// V√©rifier si les mots de passe correspondent
function checkPasswordMatch() {
  const newPassword = document.getElementById('new-password').value;
  const confirmPassword = document.getElementById('confirm-password').value;
  const matchText = document.getElementById('password-match-text');
  const confirmInput = document.getElementById('confirm-password');

  if (confirmPassword.length === 0) {
    matchText.style.display = 'none';
    confirmInput.style.borderColor = 'var(--border-dark)';
    return false;
  }

  matchText.style.display = 'block';

  if (newPassword === confirmPassword) {
    matchText.textContent = '‚úì Les mots de passe correspondent';
    matchText.style.color = '#22c55e';
    confirmInput.style.borderColor = '#22c55e';
    return true;
  } else {
    matchText.textContent = '‚úó Les mots de passe ne correspondent pas';
    matchText.style.color = '#ef4444';
    confirmInput.style.borderColor = '#ef4444';
    return false;
  }
}

// Valider le formulaire et activer/d√©sactiver le bouton
function validatePasswordForm() {
  const currentPassword = document.getElementById('current-password').value;
  const newPassword = document.getElementById('new-password').value;
  const confirmPassword = document.getElementById('confirm-password').value;
  const submitBtn = document.getElementById('change-password-btn');

  // V√©rifier que tous les champs sont remplis
  const allFieldsFilled = currentPassword.length > 0 && newPassword.length >= 6 && confirmPassword.length > 0;

  // V√©rifier que les mots de passe correspondent
  const passwordsMatch = newPassword === confirmPassword;

  // Activer ou d√©sactiver le bouton
  if (allFieldsFilled && passwordsMatch) {
    submitBtn.disabled = false;
    submitBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
    submitBtn.style.color = 'white';
    submitBtn.style.cursor = 'pointer';
    submitBtn.classList.add('btn-primary');
  } else {
    submitBtn.disabled = true;
    submitBtn.style.background = '#4b5563';
    submitBtn.style.color = '#9ca3af';
    submitBtn.style.cursor = 'not-allowed';
    submitBtn.classList.remove('btn-primary');
  }
}

// Soumettre le changement de mot de passe
async function handleChangePassword(event) {
  event.preventDefault();

  const currentPassword = document.getElementById('current-password').value;
  const newPassword = document.getElementById('new-password').value;
  const confirmPassword = document.getElementById('confirm-password').value;
  const messageDiv = document.getElementById('password-change-message');
  const submitBtn = document.getElementById('change-password-btn');

  // Validation
  if (newPassword.length < 6) {
    showPasswordMessage('Le nouveau mot de passe doit contenir au moins 6 caract√®res.', 'error');
    return;
  }

  if (newPassword !== confirmPassword) {
    showPasswordMessage('Les mots de passe ne correspondent pas.', 'error');
    return;
  }

  // D√©sactiver le bouton
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Changement en cours...</span>';

  try {
    const username = localStorage.getItem('username');
    if (!username) {
      throw new Error('Utilisateur non connect√©');
    }

    const response = await fetch('/api/user/change-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        username: username,
        current_password: currentPassword,
        new_password: newPassword
      })
    });

    const result = await response.json();

    if (response.ok && result.success) {
      showPasswordMessage('Mot de passe chang√© avec succ√®s !', 'success');

      // R√©initialiser le formulaire
      document.getElementById('change-password-form').reset();

      // Reset les indicateurs
      checkPasswordStrength('');
      document.getElementById('password-match-text').style.display = 'none';
      document.getElementById('confirm-password').style.borderColor = 'var(--border-dark)';
    } else {
      throw new Error(result.detail || 'Erreur lors du changement de mot de passe');
    }
  } catch (error) {
    console.error('Erreur changement mot de passe:', error);
    showPasswordMessage(error.message || 'Erreur lors du changement de mot de passe', 'error');
  } finally {
    // Restaurer le texte du bouton et r√©√©valuer son √©tat
    submitBtn.innerHTML = '<i class="fas fa-key"></i> <span>Changer</span>';
    validatePasswordForm();
  }
}

// Afficher un message de succ√®s/erreur
function showPasswordMessage(message, type) {
  const messageDiv = document.getElementById('password-change-message');

  if (type === 'success') {
    messageDiv.style.background = 'rgba(34, 197, 94, 0.1)';
    messageDiv.style.border = '1px solid rgba(34, 197, 94, 0.3)';
    messageDiv.style.color = '#22c55e';
    messageDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i>' + message;
  } else {
    messageDiv.style.background = 'rgba(239, 68, 68, 0.1)';
    messageDiv.style.border = '1px solid rgba(239, 68, 68, 0.3)';
    messageDiv.style.color = '#ef4444';
    messageDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>' + message;
  }

  messageDiv.style.display = 'block';

  // Masquer apr√®s 5 secondes
  setTimeout(() => {
    messageDiv.style.display = 'none';
  }, 5000);
}
</script>

<!-- Popup confirmation suppression -->
<div id="confirm-popup" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
  <div class="card rounded-lg p-6 max-w-sm w-full shadow-lg text-center">
    <p class="mb-6 font-semibold" id="confirm-message" style="color: var(--text-light);">√ätes-vous s√ªr de vouloir supprimer ?</p>
    <div class="flex justify-center gap-4">
      <button id="confirm-yes" class="btn-primary">Oui</button>
      <button id="confirm-no" class="btn-secondary">Annuler</button>
    </div>
  </div>
</div>

<!-- Toast Notifications Container -->
<div id="toast-container"></div>

<script>
// Fonction pour afficher les notifications toast
function showToast(message, type = 'success') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;

  const icon = type === 'success'
    ? '<i class="fas fa-check-circle toast-icon"></i>'
    : '<i class="fas fa-exclamation-circle toast-icon"></i>';

  toast.innerHTML = `
    ${icon}
    <span class="toast-message">${message}</span>
  `;

  container.appendChild(toast);

  // Retirer le toast apr√®s 3 secondes
  setTimeout(() => {
    toast.classList.add('hiding');
    setTimeout(() => {
      container.removeChild(toast);
    }, 300);
  }, 3000);
}

// ===== GESTION DE LA PROGRESSION DU PROFIL =====

// Mettre √† jour l'UI d'une √©tape
function updateStepUI(stepName, percentage) {
  const progressBar = document.getElementById(`${stepName}-progress-bar`);
  const progressText = document.getElementById(`${stepName}-progress-text`);
  const stepCheck = document.querySelector(`.step-check[data-step="${stepName}"]`);
  const completeBtn = document.getElementById(`${stepName}-complete-btn`);

  if (progressBar) {
    progressBar.style.width = `${percentage}%`;
    progressBar.style.background = percentage === 100 ? '#22c55e' : '#3b82f6';
  }

  if (progressText) {
    progressText.textContent = `${Math.round(percentage)}%`;
    progressText.style.color = percentage === 100 ? '#22c55e' : 'var(--text-gray)';
  }

  if (stepCheck) {
    const icon = stepCheck.querySelector('i');
    if (icon) {
      if (percentage === 100) {
        icon.className = 'fas fa-check-circle text-green-500 text-lg';
      } else {
        icon.className = 'fas fa-circle text-gray-500 text-lg';
      }
    }
  }

  // Afficher/cacher le bouton "Compl√©ter"
  if (completeBtn) {
    if (percentage < 100) {
      completeBtn.style.display = 'inline-block';
    } else {
      completeBtn.style.display = 'none';
    }
  }
}

// Toggle l'affichage des √©tapes de progression avec animation fluide
function toggleProfileProgress() {
  const stepsContainer = document.getElementById('profile-progress-steps');
  const chevron = document.getElementById('profile-progress-chevron');
  const header = document.getElementById('profile-progress-header');

  const isCurrentlyOpen = stepsContainer.style.maxHeight && stepsContainer.style.maxHeight !== '0px';

  if (!isCurrentlyOpen) {
    // Ouvrir - utiliser scrollHeight pour la hauteur exacte
    stepsContainer.style.maxHeight = stepsContainer.scrollHeight + 'px';
    stepsContainer.style.marginTop = '1.5rem';
    chevron.style.transform = 'rotate(0deg)';
    header.classList.remove('mb-0');
    header.classList.add('mb-6');
  } else {
    // Fermer
    stepsContainer.style.maxHeight = '0px';
    stepsContainer.style.marginTop = '0';
    chevron.style.transform = 'rotate(-180deg)';
    header.classList.remove('mb-6');
    header.classList.add('mb-0');
  }
}

// Scroll vers une section sp√©cifique
function scrollToSection(section) {
  log('[SCROLL] Tentative de scroll vers:', section);
  let targetElement = null;

  switch(section) {
    case 'grade':
      targetElement = document.querySelector('[onclick*="selectGrade"]');
      log('[SCROLL] Recherche grade, √©l√©ment trouv√©:', !!targetElement);
      break;
    case 'personal':
    case 'business':
    case 'documents':
      // Personal, Business et Documents sont tous dans la section "Mes informations"
      // Utiliser directement l'ID de la section
      targetElement = document.getElementById('mes-informations-section');
      log('[SCROLL] Recherche section "Mes informations", √©l√©ment trouv√©:', !!targetElement);
      break;
    case 'signature':
      targetElement = document.getElementById('signature-pad');
      log('[SCROLL] Recherche signature, √©l√©ment trouv√©:', !!targetElement);
      break;
  }

  if (targetElement) {
    log('[SCROLL] √âl√©ment trouv√©, scroll en cours...');

    // Fermer le widget si ouvert
    const stepsContainer = document.getElementById('profile-progress-steps');
    const isOpen = stepsContainer.style.maxHeight && stepsContainer.style.maxHeight !== '0px';
    if (isOpen) {
      toggleProfileProgress();
    }

    // Scroll imm√©diatement sans attendre avec offset pour garder le titre visible en haut
    const elementPosition = targetElement.getBoundingClientRect().top + window.pageYOffset;
    const offsetPosition = elementPosition - 350; // 350px d'offset pour voir le titre

    window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
    });
    log('[SCROLL] Scroll effectu√©');

    // Animation pour attirer l'attention sur l'√©l√©ment
    targetElement.style.transition = 'all 0.3s ease';
    targetElement.style.transform = 'scale(1.02)';
    targetElement.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.5)';

    setTimeout(() => {
      targetElement.style.transform = 'scale(1)';
      targetElement.style.boxShadow = '';
    }, 600);
  } else {
    error('[SCROLL] √âl√©ment non trouv√© pour la section:', section);
  }
}

// Calculer et mettre √† jour la progression globale du profil
async function updateProfileProgress() {
  try {
    if (!window.username) {
      log('[PROGRESS] En attente du username...');
      setTimeout(updateProfileProgress, 100);
      return;
    }

    log('[PROGRESS] Calcul de la progression pour:', window.username);

    // Charger les donn√©es utilisateur
    const response = await fetch(`/api/get-info/${window.username}`);
    if (!response.ok) {
      error('[PROGRESS] Erreur lors du chargement des donn√©es');
      return;
    }

    const result = await response.json();
    const data = result.data || {};
    const files = result.files || {};

    log('[PROGRESS] Donn√©es charg√©es:', { data, files });

    // √âtape 1: Connexion (Gmail, Agenda = 50% chacun)
    let connectionProgress = 0;
    let connectedServices = [];

    // V√©rifier Gmail - bas√© sur l'√©tat de l'UI
    const gmailBox = document.getElementById('gmail-box');
    const gmailConnected = gmailBox && !gmailBox.classList.contains('hidden');
    if (gmailConnected) {
      connectionProgress += 50;
      connectedServices.push('Gmail');
    }

    // V√©rifier Google Agenda - bas√© sur l'√©tat de l'UI
    const agendaBox = document.getElementById('calendar-box');
    const agendaConnected = agendaBox && !agendaBox.classList.contains('hidden');
    if (agendaConnected) {
      connectionProgress += 50;
      connectedServices.push('Agenda');
    }

    // Mettre √† jour le texte de statut de connexion
    const connectionStatusText = document.getElementById('connection-status-text');
    if (connectionStatusText) {
      if (connectedServices.length === 0) {
        connectionStatusText.textContent = 'Aucun service connect√©';
      } else if (connectedServices.length === 2) {
        connectionStatusText.textContent = 'Tous les services connect√©s';
      } else {
        connectionStatusText.textContent = `${connectedServices.join(', ')} connect√©${connectedServices.length > 1 ? 's' : ''}`;
      }
    }

    // Mettre √† jour la barre de progression de connexion
    const connectionProgressBar = document.getElementById('connection-progress-bar');
    const connectionProgressPercent = document.getElementById('connection-progress-percent');
    if (connectionProgressBar) {
      connectionProgressBar.style.width = `${connectionProgress}%`;
    }
    if (connectionProgressPercent) {
      connectionProgressPercent.textContent = `${Math.round(connectionProgress)}%`;
      // Changer la couleur selon le pourcentage
      if (connectionProgress === 100) {
        connectionProgressPercent.classList.remove('text-yellow-500', 'text-red-500');
        connectionProgressPercent.classList.add('text-green-500');
      } else if (connectionProgress > 0) {
        connectionProgressPercent.classList.remove('text-green-500', 'text-red-500');
        connectionProgressPercent.classList.add('text-yellow-500');
      } else {
        connectionProgressPercent.classList.remove('text-green-500', 'text-yellow-500');
        connectionProgressPercent.classList.add('text-red-500');
      }
    }

    // √âtape 2: Grade (100% si d√©fini, 0% sinon)
    const gradeProgress = data.grade ? 100 : 0;

    // √âtape 3: Info personnelles (nom, pr√©nom, t√©l√©phone, courriel = 25% chacun)
    let personalProgress = 0;
    if (data.nom && data.nom.trim() !== '') personalProgress += 25;
    if (data.prenom && data.prenom.trim() !== '') personalProgress += 25;
    if (data.telephone && data.telephone.trim() !== '') personalProgress += 25;
    if (data.courriel && data.courriel.trim() !== '') personalProgress += 25;

    // √âtape 4: Info entreprise (NEQ, TPS, TVQ = 33.33% chacun)
    let businessProgress = 0;
    if (data.neq && data.neq.trim() !== '') businessProgress += 33.33;
    if (data.tps && data.tps.trim() !== '') businessProgress += 33.33;
    if (data.tvq && data.tvq.trim() !== '') businessProgress += 33.34;

    // √âtape 5: Documents (specimen, betonel, integration = 33.33% chacun)
    let documentsProgress = 0;
    if (files.specimen) documentsProgress += 33.33;
    if (files.betonel) documentsProgress += 33.33;
    if (files.integration) documentsProgress += 33.34;

    // √âtape 6: Signature & Photo (signature, profile_photo = 50% chacun)
    let signatureProgress = 0;

    // V√©rifier la signature via son endpoint d√©di√©
    try {
      const sigResponse = await fetch(`/api/get-signature/${window.username}`);
      if (sigResponse.ok) {
        const sigData = await sigResponse.json();
        if (sigData.signatureUrl) signatureProgress += 50;
      }
    } catch (error) {
      log('[PROGRESS] Aucune signature trouv√©e');
    }

    // V√©rifier la photo via son endpoint d√©di√©
    try {
      const photoResponse = await fetch(`/api/get-profile-photo/${window.username}`);
      if (photoResponse.ok) {
        const photoData = await photoResponse.json();
        if (photoData.photoUrl) signatureProgress += 50;
      }
    } catch (error) {
      log('[PROGRESS] Aucune photo trouv√©e');
    }

    log('[PROGRESS] Calculs:', {
      connection: connectionProgress,
      grade: gradeProgress,
      personal: personalProgress,
      business: businessProgress,
      documents: documentsProgress,
      signature: signatureProgress
    });

    // Mettre √† jour l'UI pour chaque √©tape
    updateStepUI('grade', gradeProgress);
    updateStepUI('personal', personalProgress);
    updateStepUI('business', businessProgress);
    updateStepUI('documents', documentsProgress);
    updateStepUI('signature', signatureProgress);

    // Calculer la progression globale
    const overallProgress = (
      connectionProgress +
      gradeProgress +
      personalProgress +
      businessProgress +
      documentsProgress +
      signatureProgress
    ) / 6;

    // Mettre √† jour le cercle de progression
    const progressCircle = document.getElementById('progress-circle');
    const progressPercent = document.getElementById('progress-percent');

    if (progressCircle) {
      // Calcul du stroke-dashoffset pour l'animation du cercle
      // Circonf√©rence = 2 * œÄ * r = 2 * 3.14159 * 28 ‚âà 176
      const circumference = 176;
      const offset = circumference - (overallProgress / 100) * circumference;
      progressCircle.style.strokeDashoffset = offset;
    }

    if (progressPercent) {
      progressPercent.textContent = `${Math.round(overallProgress)}%`;
    }

    // Compter les √©tapes termin√©es
    const completedSteps = [
      connectionProgress,
      gradeProgress,
      personalProgress,
      businessProgress,
      documentsProgress,
      signatureProgress
    ].filter(progress => progress === 100).length;

    const completedStepsElement = document.getElementById('completed-steps');
    if (completedStepsElement) {
      completedStepsElement.textContent = completedSteps;
    }

    // Mettre √† jour le statut du profil
    const profileStatus = document.getElementById('profile-status');
    if (profileStatus) {
      if (completedSteps === 6) {
        profileStatus.textContent = 'Profil complet';
        profileStatus.parentElement.style.background = 'rgba(34, 197, 94, 0.15)';
        profileStatus.parentElement.style.border = '1px solid rgba(34, 197, 94, 0.4)';
      } else {
        profileStatus.textContent = 'Profil en cours';
        profileStatus.parentElement.style.background = 'rgba(59, 130, 246, 0.15)';
        profileStatus.parentElement.style.border = '1px solid rgba(59, 130, 246, 0.4)';
      }
    }

    log('[PROGRESS] Progression mise √† jour:', {
      overall: Math.round(overallProgress),
      completed: completedSteps
    });

    // G√©rer l'ouverture/fermeture du widget selon le profil
    const stepsContainer = document.getElementById('profile-progress-steps');
    const chevron = document.getElementById('profile-progress-chevron');
    const header = document.getElementById('profile-progress-header');

    if (stepsContainer && chevron && header) {
      if (overallProgress < 100) {
        // Profil incomplet - ouvrir le widget
        stepsContainer.style.maxHeight = '2000px';
        stepsContainer.style.marginTop = '1.5rem';
        chevron.style.transform = 'rotate(0deg)';
        header.classList.remove('mb-0');
        header.classList.add('mb-6');
        log('[PROGRESS] Widget ouvert - profil √†', Math.round(overallProgress), '%');
      } else {
        // Profil complet - fermer le widget
        stepsContainer.style.maxHeight = '0';
        stepsContainer.style.marginTop = '0';
        chevron.style.transform = 'rotate(-180deg)';
        header.classList.remove('mb-6');
        header.classList.add('mb-0');
        log('[PROGRESS] Widget ferm√© - profil complet √† 100%');
      }
    }

    return overallProgress;
  } catch (error) {
    error('[PROGRESS] Erreur lors du calcul de la progression:', error);
    return 0;
  }
}

// ===== GESTION DU GRADE =====
let currentGrade = null;

// Charger le grade actuel
async function loadGrade() {
  try {
    const response = await fetch(`/api/get-info/${username}`);
    if (!response.ok) throw new Error('Erreur lors du chargement du grade');

    const result = await response.json();
    const userInfo = result.data || {};
    currentGrade = userInfo.grade || null;

    // Mettre √† jour l'affichage
    updateGradeButtons();
  } catch (error) {
    error('[GRADE] Erreur lors du chargement:', error);
  }
}

// Mettre √† jour l'apparence des boutons
function updateGradeButtons() {
  const grades = ['recrue', 'senior1', 'senior2', 'senior3'];

  grades.forEach(grade => {
    const btn = document.getElementById(`grade-${grade}`);
    if (!btn) return;

    if (grade === currentGrade) {
      // Bouton s√©lectionn√©
      btn.style.borderColor = 'var(--primary-blue)';
      btn.style.background = 'rgba(59, 130, 246, 0.15)';
    } else {
      // Bouton non s√©lectionn√©
      btn.style.borderColor = 'var(--border-dark)';
      btn.style.background = 'rgba(30, 41, 59, 0.3)';
    }
  });
}

// S√©lectionner et enregistrer automatiquement le grade
async function selectGrade(grade) {
  try {
    // Enregistrer le grade
    const response = await fetch(`/api/update-info/${username}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ grade: grade })
    });

    if (!response.ok) throw new Error('Erreur lors de l\'enregistrement du grade');

    // Mettre √† jour le grade actuel
    currentGrade = grade;
    updateGradeButtons();

    // Afficher une notification de succ√®s
    showToast('Grade enregistr√© avec succ√®s', 'success');

    // Mettre √† jour la progression du profil
    updateProfileProgress();

    log('[GRADE] Grade enregistr√©:', grade);
  } catch (error) {
    error('[GRADE] Erreur lors de l\'enregistrement:', error);
    showToast('Erreur lors de l\'enregistrement du grade', 'error');
  }
}

// Charger le grade au chargement de la page
document.addEventListener('DOMContentLoaded', () => {
  loadGrade();
  updateProfileProgress();
  loadMondayConfig();
});

// ========================================
// MONDAY.COM INTEGRATION
// ========================================

// Charger la configuration Monday.com existante
async function loadMondayConfig() {
  try {
    const response = await fetch(`/api/monday/get-config/${username}`);
    if (!response.ok) {
      // Pas de config existante, afficher comme d√©connect√©
      updateMondayUI(false);
      return;
    }

    const data = await response.json();
    if (data.connected) {
      // Configuration existante trouv√©e
      document.getElementById('monday-api-key').value = data.api_key || '';
      document.getElementById('monday-board-id').value = data.board_id || '';
      updateMondayUI(true, data.board_name);
    } else {
      updateMondayUI(false);
    }
  } catch (error) {
    error('[MONDAY] Erreur lors du chargement de la config:', error);
    updateMondayUI(false);
  }
}

// Tester la connexion Monday.com
async function testMondayConnection() {
  const apiKey = document.getElementById('monday-api-key').value.trim();
  const boardId = document.getElementById('monday-board-id').value.trim();

  if (!apiKey || !boardId) {
    showToast('Veuillez remplir tous les champs', 'error');
    return;
  }

  // Afficher loading
  const testBtn = event.target;
  const originalText = testBtn.innerHTML;
  testBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Test en cours...';
  testBtn.disabled = true;

  try {
    const response = await fetch('/api/monday/test-connection', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        api_key: apiKey,
        board_id: boardId
      })
    });

    const data = await response.json();

    if (response.ok && data.success) {
      showToast(`Connexion r√©ussie ! Board: ${data.board_name}`, 'success');
    } else {
      showToast(data.error || 'Erreur lors du test de connexion', 'error');
    }
  } catch (error) {
    error('[MONDAY] Erreur lors du test:', error);
    showToast('Erreur lors du test de connexion', 'error');
  } finally {
    testBtn.innerHTML = originalText;
    testBtn.disabled = false;
  }
}

// Sauvegarder la configuration Monday.com
async function saveMondayConfig() {
  const apiKey = document.getElementById('monday-api-key').value.trim();
  const boardId = document.getElementById('monday-board-id').value.trim();

  if (!apiKey || !boardId) {
    showToast('Veuillez remplir tous les champs', 'error');
    return;
  }

  // Afficher loading
  const saveBtn = event.target;
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sauvegarde...';
  saveBtn.disabled = true;

  try {
    const response = await fetch('/api/monday/save-config', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        username: username,
        api_key: apiKey,
        board_id: boardId
      })
    });

    const data = await response.json();

    if (response.ok && data.success) {
      showToast('Configuration Monday.com sauvegard√©e avec succ√®s', 'success');
      updateMondayUI(true, data.board_name);
      updateProfileProgress(); // Mettre √† jour la progression du profil
    } else {
      showToast(data.error || 'Erreur lors de la sauvegarde', 'error');
    }
  } catch (error) {
    error('[MONDAY] Erreur lors de la sauvegarde:', error);
    showToast('Erreur lors de la sauvegarde', 'error');
  } finally {
    saveBtn.innerHTML = originalText;
    saveBtn.disabled = false;
  }
}

// D√©connecter Monday.com
async function disconnectMonday() {
  if (!confirm('Voulez-vous vraiment d√©connecter votre compte Monday.com ?')) {
    return;
  }

  try {
    const response = await fetch(`/api/monday/disconnect/${username}`, {
      method: 'DELETE'
    });

    if (response.ok) {
      // R√©initialiser les champs
      document.getElementById('monday-api-key').value = '';
      document.getElementById('monday-board-id').value = '';
      updateMondayUI(false);
      showToast('Compte Monday.com d√©connect√©', 'success');
      updateProfileProgress(); // Mettre √† jour la progression du profil
    } else {
      showToast('Erreur lors de la d√©connexion', 'error');
    }
  } catch (error) {
    error('[MONDAY] Erreur lors de la d√©connexion:', error);
    showToast('Erreur lors de la d√©connexion', 'error');
  }
}

// Mettre √† jour l'interface utilisateur selon l'√©tat de connexion
function updateMondayUI(isConnected, boardName = '') {
  const statusConnected = document.getElementById('monday-status-connected');
  const statusDisconnected = document.getElementById('monday-status-disconnected');
  const configForm = document.getElementById('monday-config-form');
  const connectedInfo = document.getElementById('monday-connected-info');
  const actionButtons = document.getElementById('monday-action-buttons');

  if (isConnected) {
    // Afficher comme connect√©
    statusConnected.classList.remove('hidden');
    statusDisconnected.classList.add('hidden');
    configForm.classList.add('hidden');
    connectedInfo.classList.remove('hidden');
    if (actionButtons) actionButtons.classList.add('hidden');

    // Mettre √† jour le nom du board si fourni
    if (boardName) {
      const boardNameSpan = document.getElementById('monday-board-name');
      if (boardNameSpan) {
        boardNameSpan.textContent = boardName;
      }
    }
  } else {
    // Afficher comme d√©connect√©
    statusConnected.classList.add('hidden');
    statusDisconnected.classList.remove('hidden');
    configForm.classList.remove('hidden');
    connectedInfo.classList.add('hidden');
    if (actionButtons) actionButtons.classList.remove('hidden');
  }
}

</script>

<!-- Modal OAuth Google (Gmail & Calendar) -->
<div id="oauth-modal" class="fixed inset-0 z-50 hidden" style="background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px);">
  <div class="flex items-center justify-center h-full p-4">
    <div class="relative w-full max-w-2xl h-[80vh] rounded-xl overflow-hidden shadow-2xl" style="background: var(--bg-card); border: 2px solid var(--border-dark);">
      <!-- Header du modal -->
      <div class="flex items-center justify-between p-4" style="background: linear-gradient(135deg, #3b82f6 0%, #3b82f6 100%); border-bottom: 1px solid rgba(255,255,255,0.1);">
        <h3 class="text-lg font-semibold text-white flex items-center gap-2">
          <i class="fab fa-google"></i>
          <span id="oauth-modal-title">Connexion Google</span>
        </h3>
        <button onclick="closeOAuthModal()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors hover:bg-white hover:bg-opacity-20" style="color: white;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Iframe pour Google OAuth -->
      <iframe id="oauth-iframe" class="w-full h-full border-0" style="height: calc(100% - 64px);" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"></iframe>

      <!-- Loading indicator -->
      <div id="oauth-loading" class="absolute inset-0 flex flex-col items-center justify-center" style="background: var(--bg-card);">
        <i class="fas fa-spinner fa-spin text-4xl mb-4" style="color: var(--primary-blue);"></i>
        <p style="color: var(--text-gray);">Chargement...</p>
      </div>
    </div>
  </div>
</div>

</body>
</html>



