<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">

  <!-- üö´ D√©sactiver le cache du navigateur -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <title>RPO</title>

  <!-- üì± PWA Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#5271ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Qwota">
  <meta name="msapplication-TileColor" content="#5271ff">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Ic√¥nes PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

  <!-- Script Service Worker -->
  <script>
  /* Service Worker disabled */
  </script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/base.css">
  <link rel="icon" href="/favicon" type="image/x-icon">

  <!-- Variables globales d√©finies dans common.js -->
  <script>
    // Ces variables sont maintenant g√©r√©es par common.js
    // username, userRole, canEditParameters sont disponibles globalement
  </script>

  <!-- Styles sp√©cifiques √† la page RPO -->
  <link rel="stylesheet" href="/rpo.css">

  <!-- ANTI-FLASH: D√©tection coach AVANT le rendu du body -->
  <script>
    (function() {
      const userRole = localStorage.getItem('userRole');
      const isCoach = userRole === 'coach';
      const urlParams = new URLSearchParams(window.location.search);
      const userParam = urlParams.get('user');
      const coachUsername = localStorage.getItem('username');

      console.log('[RPO ANTI-FLASH] userRole:', userRole, 'isCoach:', isCoach);
      console.log('[RPO ANTI-FLASH] userParam:', userParam, 'coachUsername:', coachUsername);

      // Afficher le s√©lecteur si:
      // - C'est un coach ET (pas de param√®tre user OU le param√®tre user est le coach lui-m√™me)
      const shouldShowSelector = isCoach && (!userParam || userParam === coachUsername);

      console.log('[RPO ANTI-FLASH] shouldShowSelector:', shouldShowSelector);

      if (shouldShowSelector) {
        console.log('[RPO ANTI-FLASH] ‚úÖ Application du CSS pour afficher le s√©lecteur coach');
        // Injecter le CSS imm√©diatement pour cacher le contenu et afficher le s√©lecteur
        const style = document.createElement('style');
        style.id = 'coach-anti-flash-css';
        style.textContent = `
          #main-content-wrapper {
            opacity: 0 !important;
            pointer-events: none !important;
          }
          #coach-selector-backdrop {
            display: block !important;
            opacity: 1 !important;
            pointer-events: all !important;
          }
          #coach-entrepreneur-selector {
            display: block !important;
            opacity: 1 !important;
            z-index: 10001 !important;
          }
        `;
        document.head.appendChild(style);
      } else {
        console.log('[RPO ANTI-FLASH] ‚ùå Pas de s√©lecteur coach - affichage normal du RPO');
      }
    })();
  </script>

  <style>
    /* ============================================
       COACH SELECTOR - CENTERED STATE (initial)
       ============================================ */
    #coach-entrepreneur-selector {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) scale(1);
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
      backdrop-filter: blur(20px);
      border: 2px solid var(--border-dark);
      border-radius: 24px;
      padding: 2.5rem 3rem;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 100px rgba(59, 130, 246, 0.1);
      z-index: 10001 !important;
      display: none;
      min-width: 450px;
      max-width: 550px;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #coach-entrepreneur-selector.visible {
      display: block !important;
    }

    /* ============================================
       COACH SELECTOR - HEADER STATE (after selection)
       ============================================ */
    #coach-entrepreneur-selector.in-header {
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      transform: translate(0, 0) scale(1);
      border-radius: 0;
      padding: 0.75rem 2rem;
      min-width: 100%;
      max-width: 100%;
      border: none;
      border-bottom: 2px solid var(--border-dark);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    #coach-entrepreneur-selector .selector-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      transition: all 0.4s ease;
    }

    #coach-entrepreneur-selector.in-header .selector-container {
      flex-direction: row;
      max-width: 1400px;
      gap: 1rem;
    }

    /* Titre centr√© */
    #coach-entrepreneur-selector .selector-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-light);
      text-align: center;
      margin-bottom: 0.5rem;
      opacity: 1;
      transition: all 0.4s ease;
    }

    #coach-entrepreneur-selector.in-header .selector-title {
      display: none;
    }

    /* Sous-titre */
    #coach-entrepreneur-selector .selector-subtitle {
      font-size: 0.9rem;
      color: var(--text-gray);
      text-align: center;
      margin-bottom: 1rem;
      opacity: 1;
      transition: all 0.4s ease;
    }

    #coach-entrepreneur-selector.in-header .selector-subtitle {
      display: none;
    }

    /* Cacher l'identit√© de page quand en mode header */
    #coach-entrepreneur-selector.in-header .page-identity {
      display: none;
    }

    /* Retirer la ligne de s√©paration du s√©lecteur */
    #coach-entrepreneur-selector {
      border-bottom: none !important;
    }

    #coach-entrepreneur-selector .selector-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-light);
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      opacity: 0;
      transition: all 0.4s ease;
    }

    #coach-entrepreneur-selector.in-header .selector-label {
      opacity: 1;
    }

    #coach-entrepreneur-selector .selector-label i {
      color: var(--primary-blue);
      font-size: 18px;
    }

    .coach-dropdown {
      position: relative;
      width: 100%;
      max-width: 400px;
      transition: all 0.4s ease;
    }

    #coach-entrepreneur-selector.in-header .coach-dropdown {
      flex: 1;
      max-width: 450px;
    }

    .coach-dropdown-toggle {
      background: rgba(23, 32, 51, 0.8);
      border: 2px solid var(--border-dark);
      border-radius: 16px;
      padding: 14px 20px;
      height: 56px;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text-light);
      font-size: 15px;
      gap: 0.5rem;
    }

    #coach-entrepreneur-selector.in-header .coach-dropdown-toggle {
      height: 44px;
      padding: 10px 16px;
      border-radius: 12px;
      font-size: 14px;
    }

    .coach-dropdown-toggle:hover {
      border-color: var(--primary-blue);
      background: rgba(23, 32, 51, 1);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
    }

    #coach-entrepreneur-selector.in-header .coach-dropdown-toggle:hover {
      transform: none;
      box-shadow: none;
    }

    .coach-dropdown-toggle.active {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2);
    }

    #coach-entrepreneur-selector.in-header .coach-dropdown-toggle.active {
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
    }


    .coach-dropdown-toggle .chevron {
      color: var(--text-gray);
      transition: transform 0.3s ease;
      font-size: 12px;
    }

    .coach-dropdown-toggle.active .chevron {
      transform: rotate(180deg);
    }

    .coach-dropdown-menu {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      background: var(--bg-card);
      border: 2px solid var(--border-dark);
      border-radius: 16px;
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
      z-index: 10000;
      max-height: 320px;
      overflow-y: auto;
      opacity: 0;
      transform: translateY(-10px) scale(0.98);
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #coach-entrepreneur-selector.in-header .coach-dropdown-menu {
      border-radius: 12px;
      top: calc(100% + 6px);
    }

    .coach-dropdown-menu.show {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: all;
    }

    .coach-dropdown-option {
      padding: 14px 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 15px;
      color: var(--text-light);
      border-bottom: 1px solid rgba(71, 85, 105, 0.2);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    #coach-entrepreneur-selector.in-header .coach-dropdown-option {
      padding: 12px 16px;
      font-size: 14px;
    }

    .coach-dropdown-option:hover {
      background: rgba(59, 130, 246, 0.15);
    }

    .coach-dropdown-option:first-child {
      border-radius: 14px 14px 0 0;
    }

    .coach-dropdown-option:last-child {
      border-bottom: none;
      border-radius: 0 0 14px 14px;
    }

    .coach-dropdown-option:only-child {
      border-radius: 14px;
    }

    .coach-dropdown-option i {
      color: var(--primary-green);
      font-size: 18px;
      transition: transform 0.2s ease;
    }

    .coach-dropdown-option:hover i {
      transform: scale(1.1);
    }

    .coach-dropdown-option-disabled {
      padding: 16px 20px;
      color: var(--text-gray);
      font-style: italic;
      cursor: default;
      text-align: center;
    }

    /* ============================================
       BODY STATES FOR COACH MODE
       ============================================ */
    body.coach-mode {
      padding-top: 0 !important;
    }

    body.coach-mode .main-content {
      padding-top: 2rem !important;
    }

    body.coach-mode > .mobile-overlay,
    body.coach-mode > div:not(#coach-entrepreneur-selector):not(.mobile-overlay) {
      margin-top: 0 !important;
    }

    /* ============================================
       MAIN CONTENT - Hidden until selection
       ============================================ */
    body.coach-mode #main-content-wrapper {
      opacity: 0;
      transform: translateY(30px);
      pointer-events: none;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body.coach-mode.has-selection #main-content-wrapper {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }

    /* ============================================
       SCROLLBAR STYLING
       ============================================ */
    .coach-dropdown-menu::-webkit-scrollbar {
      width: 8px;
    }

    .coach-dropdown-menu::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 10px;
    }

    .coach-dropdown-menu::-webkit-scrollbar-thumb {
      background: var(--primary-blue);
      border-radius: 10px;
    }

    .coach-dropdown-menu::-webkit-scrollbar-thumb:hover {
      background: #60a5fa;
    }

    /* ============================================
       OVERLAY BACKDROP
       ============================================ */
    #coach-selector-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }

    #coach-selector-backdrop.visible {
      opacity: 1;
      pointer-events: all;
    }

    body.coach-mode.has-selection #coach-selector-backdrop {
      opacity: 0;
      pointer-events: none;
    }
  </style>

  <link rel="stylesheet" href="/entrepreneur-selector.css">
</head>
<body class="min-h-screen" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: var(--text-light); margin: 0; padding: 0; touch-action: pan-y pinch-zoom;">

  <!-- Backdrop pour le s√©lecteur coach (√©tat centr√©) -->
  <div id="coach-selector-backdrop"></div>

  <!-- S√©lecteur d'entrepreneur (visible uniquement pour les coaches) -->
  <div id="coach-entrepreneur-selector">
    <!-- Titre de la page avec ic√¥ne RPO -->
    <div class="page-identity">
      <div class="page-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3), 0 0 40px rgba(59, 130, 246, 0.15);">
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="page-name" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #60a5fa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">RPO</div>
    </div>

    <!-- Titre et sous-titre (visibles uniquement en mode centr√©) -->
    <div class="selector-title">
      <i class="fas fa-user-tie"></i>
      S√©lectionnez un entrepreneur
    </div>
    <div class="selector-subtitle">Choisissez l'entrepreneur dont vous souhaitez consulter le RPO</div>

    <div class="selector-container">
      <div class="selector-label" style="display: none;">
        <i class="fas fa-user-tie"></i>
        <span>Entrepreneur:</span>
      </div>
      <div class="coach-dropdown">
        <div class="coach-dropdown-toggle" id="coach-dropdown-toggle">
          <input type="text"
                 class="search-input"
                 id="search-input"
                 placeholder="Rechercher..."
                 autocomplete="off"
                 style="display: none;">
          <span class="placeholder">-- S√©lectionner un entrepreneur --</span>
          <i class="fas fa-chevron-down chevron"></i>
        </div>
        <div class="coach-dropdown-menu" id="coach-dropdown-menu">
          <!-- Options charg√©es dynamiquement -->
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Wrapper pour les transitions coach -->
  <div id="main-content-wrapper">

<!-- Main Content - RPO -->
<div class="main-content" style="padding: 2rem; touch-action: pan-y pinch-zoom;">

  <!-- Header -->
  <div class="mb-10 mt-5 md:mt-0">
    <div class="relative">
      <div class="flex items-center justify-between mb-3">
        <h1 class="text-4xl font-bold" style="color: var(--text-light);">
          RPO
        </h1>
        <span class="absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-blue-600 to-blue-400 rounded-full"></span>
      </div>
      <div class="flex items-center justify-between">
        <p class="text-xl font-medium" style="color: var(--text-gray);">Gestion Strat√©gique</p>
      </div>
    </div>
  </div>

  <div class="mx-auto space-y-12">

    <!-- Navigation Pages -->
    <div class="mb-8" style="position: relative; z-index: 10000; pointer-events: auto; touch-action: manipulation;">
      <div class="tab-spacing">
        <button id="rpo-tab" class="btn-primary" onclick="showPage('rpo')" style="display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-chart-line"></i>RPO
        </button>
        <button id="plan-affaire-tab" class="btn-secondary" onclick="showPage('plan-affaire')" style="display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-briefcase"></i>Plan d'affaire
        </button>
        <button id="etat-resultats-tab" class="btn-secondary" onclick="showPage('etat-resultats')" style="display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-file-invoice-dollar"></i>√âtat des r√©sultats
        </button>
      </div>
    </div>

  <!-- Page RPO -->
  <div id="rpo" class="page-content">

    <!-- Section Objectif Annuel & Tendance - Tout en Un -->
    <div>

      <!-- BOX 1: Section Annuelle - Objectif CA + Chandelier Mensuel -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

        <!-- GAUCHE: Objectif CA -->
        <div class="flex flex-col" style="background: var(--bg-card); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; overflow: hidden;">

          <!-- Header -->
          <div class="flex items-center justify-between px-6" style="background: rgba(30, 41, 59, 0.5); border-bottom: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem 1rem 0 0; min-height: 80px;">
            <div class="flex items-center gap-3">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: #3b82f6; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-bullseye" style="font-size: 1.5rem; color: white;"></i>
              </div>
              <h3 class="text-2xl font-bold" style="color: var(--text-light);">Objectif dollars($) vendu</h3>
            </div>
            <div class="flex items-center gap-3">
              <button id="whyBtn" onclick="openWhyPopup()" class="rounded-lg flex items-center gap-2 justify-center transition-all hover:scale-105 px-3 py-2" style="background: rgba(168, 85, 247, 0.15); color: #a855f7; border: 1px solid rgba(168, 85, 247, 0.3);" title="Mon WHY">
                <i class="fas fa-lightbulb text-xs"></i>
                <span class="text-xs font-bold">Mon WHY</span>
              </button>
              <button id="editObjectifBtn" onclick="toggleEditObjectif()" class="rounded-lg flex items-center gap-2 justify-center transition-all hover:scale-105 px-3 py-2" style="background: rgba(96, 165, 250, 0.15); color: var(--primary-blue); border: 1px solid rgba(96, 165, 250, 0.3);" title="Modifier">
                <i class="fas fa-pencil-alt text-xs"></i>
                <span class="text-xs font-bold">Modifier</span>
              </button>
              <button id="saveObjectifBtn" onclick="saveObjectif()" class="hidden rounded-lg flex items-center gap-2 justify-center transition-all hover:scale-105 px-3 py-2" style="background: rgba(52, 211, 153, 0.15); color: var(--primary-green); border: 1px solid rgba(52, 211, 153, 0.3);" title="Enregistrer">
                <i class="fas fa-save text-xs"></i>
                <span class="text-xs font-bold">Enregistrer</span>
              </button>
            </div>
          </div>

          <!-- Contenu -->
          <div class="flex flex-col items-center justify-center p-6 flex-1">

                <!-- Message d'alerte si objectif CA = 0 (en haut, discret) -->
                <div id="objectif-ca-alert" class="w-full mb-4" style="display: none;">
                  <div style="
                    background: rgba(251, 191, 36, 0.1);
                    border-left: 3px solid #fbbf24;
                    border-radius: 0.5rem;
                    padding: 0.75rem 1rem;
                    display: flex;
                    align-items: center;
                    gap: 0.625rem;
                  ">
                    <i class="fas fa-info-circle" style="color: #fbbf24; font-size: 1rem;"></i>
                    <p style="color: var(--text-gray); font-size: 0.875rem; margin: 0;">
                      <span style="color: #fbbf24; font-weight: 600;">Objectif dollars($) vendu requis</span> ‚Äî Veuillez remplir l'objectif pour cr√©er le plan d'affaire.
                    </p>
                  </div>
                </div>

                <div class="mb-6 w-full max-w-md">
                  <input type="text" id="objectifCA" class="rpo-metric-input modern-input dollar-input text-center font-bold w-full" placeholder="0,00 $" value="0,00 $" data-value="0" readonly
                    style="
                      font-size: 2.3rem;
                      color: var(--primary-blue);
                      background: rgba(96, 165, 250, 0.05);
                      border: 2px solid rgba(96, 165, 250, 0.2);
                      border-radius: 1rem;
                      padding: 1.25rem;
                      outline: none;
                      transition: all 0.3s ease;
                      text-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
                    ">
                </div>

                <div class="relative inline-block mb-6">
                  <svg class="w-32 h-32 transform -rotate-90" style="filter: drop-shadow(0 0 10px rgba(96, 165, 250, 0.3));">
                    <circle cx="64" cy="64" r="56" stroke="rgba(51, 65, 85, 0.5)" stroke-width="8" fill="none"/>
                    <circle id="progressCircleObjectif" cx="64" cy="64" r="56" stroke="#ef4444" stroke-width="8" fill="none"
                            stroke-dasharray="352" stroke-dashoffset="351" class="transition-all duration-1000"
                            style="stroke-linecap: round;"/>
                    <defs>
                      <linearGradient id="gradient-blue" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                      </linearGradient>
                    </defs>
                  </svg>
                  <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span id="progressPercentObjectif" class="text-lg font-bold" style="color: var(--text-gray);">0%</span>
                    <span class="text-xs font-medium mt-1" style="color: var(--text-gray);">Compl√©t√©</span>
                  </div>
                </div>

          </div>
        </div>

        <!-- DROITE: Graphique Ann√©e 2026 -->
        <div class="flex flex-col" style="background: var(--bg-card); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; overflow: hidden;">

          <!-- Header -->
          <div class="flex items-center justify-between px-6" style="background: rgba(30, 41, 59, 0.5); border-bottom: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem 1rem 0 0; min-height: 80px;">
            <div class="flex items-center gap-3">
              <div style="width: 48px; height: 48px; border-radius: 12px; background: #8b5cf6; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-chart-bar" style="font-size: 1.5rem; color: white;"></i>
              </div>
              <h3 class="text-2xl font-bold" style="color: var(--text-light);">
                <span class="text-long">Chandelier Mensuel</span>
                <span class="text-short" style="display: none;">Mensuel</span>
              </h3>
            </div>
          </div>

          <!-- Contenu -->
          <div class="p-6">
            <div class="chart-header mb-4">
              <div class="chart-breadcrumb">
                <div class="breadcrumb-item clickable" id="breadcrumbYearItem" onclick="goBackToYear()" style="cursor: pointer;">
                  <span id="breadcrumbYear">Ann√©e 2026</span>
                </div>
                <span class="breadcrumb-separator" id="breadcrumbSep1" style="display: none;">‚Ä∫</span>
                <button class="breadcrumb-back" id="breadcrumbMonth" style="display: none;" onclick="goBackToMonth()">
                  <span id="breadcrumbMonthName">Janvier</span>
                </button>
                <span class="breadcrumb-separator" id="breadcrumbSep2" style="display: none;">‚Ä∫</span>
                <div class="breadcrumb-label" id="breadcrumbWeek" style="display: none;">
                  <span id="breadcrumbWeekName">Semaine 1</span>
                </div>
              </div>
            </div>

            <div class="annual-chart-container" id="annualChartContainer"></div>
            <div class="weekly-chart-container" id="weeklyChartContainer" style="display: none;"></div>
            <div class="daily-chart-container" id="dailyChartContainer" style="display: none;"></div>
          </div>
        </div>

      </div>

      <!-- BOX 2: Section Objectifs, R√©sultats & Tendances -->
      <div class="flex flex-col mb-8" style="border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; overflow: hidden;">

        <!-- Header -->
        <div class="flex items-center justify-between px-6" style="background: var(--bg-card); border-bottom: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem 1rem 0 0; min-height: 80px;">
          <div class="flex items-center gap-3">
            <div style="width: 48px; height: 48px; border-radius: 12px; background: #10b981; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-chart-line" style="font-size: 1.5rem; color: white;"></i>
            </div>
            <h3 class="text-2xl font-bold" style="color: var(--text-light);">
              <span class="text-long">Objectifs, R√©sultats & Tendances (Annuel)</span>
              <span class="text-short" style="display: none;">Annuel</span>
            </h3>
          </div>
          <!-- Dropdown pour filtrer les stats sur mobile -->
          <div class="annual-stats-dropdown" id="annualStatsDropdown" style="display: none;">
            <div class="custom-select" style="width: 180px;">
              <div class="custom-select-button" style="position: relative;">
                <span class="custom-select-text" id="annual-stat-selected-text">$ SIGN√â</span>
                <i class="fas fa-chevron-down" style="font-size: 0.75rem; color: var(--text-gray);"></i>
              </div>
              <div class="custom-select-dropdown" id="annual-stat-dropdown-menu" style="display: none;">
                <div class="custom-select-option" data-value="hrpap">HEURES P√ÄP</div>
                <div class="custom-select-option" data-value="estimation"># D'ESTIMATION</div>
                <div class="custom-select-option" data-value="contract"># CONTRAT SIGN√â</div>
                <div class="custom-select-option selected" data-value="dollar">$ SIGN√â</div>
                <div class="custom-select-option" data-value="mktg">TAUX MKTG</div>
                <div class="custom-select-option" data-value="vente">TAUX DE VENTE</div>
                <div class="custom-select-option" data-value="moyen">CONTRAT MOYEN</div>
                <div class="custom-select-option" data-value="tendance">TENDANCE CA</div>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2" style="display: none;">
            <!-- Boutons cach√©s car les objectifs sont automatiquement synchronis√©s avec le Plan d'affaires -->
            <button id="editMetricsBtn" onclick="toggleEditAllMetrics()" class="rounded-lg flex items-center gap-2 justify-center transition-all hover:scale-105 px-3 py-2" style="background: rgba(96, 165, 250, 0.15); color: var(--primary-blue); border: 1px solid rgba(96, 165, 250, 0.3);" title="Modifier">
              <i class="fas fa-pencil-alt text-xs"></i>
              <span class="text-xs font-bold">Modifier</span>
            </button>
            <button id="saveMetricsBtn" onclick="saveMetrics()" class="hidden rounded-lg flex items-center gap-2 justify-center transition-all hover:scale-105 px-3 py-2" style="background: rgba(52, 211, 153, 0.15); color: var(--primary-green); border: 1px solid rgba(52, 211, 153, 0.3);" title="Enregistrer">
              <i class="fas fa-save text-xs"></i>
              <span class="text-xs font-bold">Enregistrer</span>
            </button>
          </div>
        </div>

        <!-- Contenu -->
        <div class="p-6" style="background: var(--bg-card);">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="annualStatsGrid">
          <!-- HR P√ÄP R√âEL -->
          <div class="rounded-xl annual-stat-card" data-stat-type="hrpap" style="background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8)); border: 1px solid rgba(96, 165, 250, 0.15); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); ">

            <!-- Header avec bordure -->
            <div class="px-4 py-4 border-b" style="border-color: rgba(96, 165, 250, 0.1);">
              <h4 class="text-base font-bold text-center" style="color: var(--text-light); letter-spacing: 0.05em;">HEURES P√ÄP</h4>
            </div>

            <!-- Contenu -->
            <div class="p-5">
              <!-- Objectif -->
              <div class="mb-4">
                <div class="text-xs font-medium mb-2" style="color: rgba(148, 163, 184, 0.8);">Objectif</div>
                <input type="text" id="hrpap-vise" value="0 h" data-value="0" class="rpo-metric-input bg-transparent border-none text-left w-full" style="color: rgba(96, 165, 250, 0.7); outline: none; font-size: 1.25rem;" readonly>
              </div>

              <!-- S√©parateur -->
              <div class="h-px my-4" style="background: linear-gradient(to right, transparent, rgba(96, 165, 250, 0.2), transparent);"></div>

              <!-- Devrait √™tre √† -->
              <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                  <div class="text-xs font-medium" style="color: rgba(148, 163, 184, 0.8);">Devrait √™tre √†</div>
                  <button id="hrpap-advice-badge" onclick="showAdvice('hrpap')" class="hidden text-xs px-2 py-1 rounded-full transition-all hover:scale-105" style="display: none; background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.5);">
                    <i class="fas fa-lightbulb mr-1"></i>Conseils
                  </button>
                </div>
                <div id="hrpap-tendance" class="text-left" style="color: rgba(52, 211, 153, 0.7); font-size: 1.25rem;" data-value="0">0 h</div>
              </div>

              <!-- S√©parateur -->
              <div class="h-px my-4" style="background: linear-gradient(to right, transparent, rgba(96, 165, 250, 0.2), transparent);"></div>

              <!-- Actuel -->
              <div class="mb-4">
                <div class="text-base font-semibold mb-2" style="color: rgba(148, 163, 184, 0.8);">Actuel</div>
                <div id="annual-hrpap-reel" class="font-bold" style="color: var(--text-light); font-size: 2rem;" data-value="0">0 h</div>
              </div>

              <!-- Progress bar avec pourcentage -->
              <div>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs font-medium" style="color: rgba(148, 163, 184, 0.8);">Progression</span>
                  <span id="hrpap-percent" class="text-xs font-bold" style="color: var(--primary-blue);">0%</span>
                </div>
                <div class="w-full rounded-full h-2 overflow-hidden" style="background: rgba(15, 23, 42, 0.6);">
                  <div id="hrpap-progress-bar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: #e5e7eb;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- # d'estimation r√©el -->
          <div class="rounded-xl annual-stat-card" data-stat-type="estimation" style="background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8)); border: 1px solid rgba(96, 165, 250, 0.15); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);">

            <!-- Header avec bordure -->
            <div class="px-4 py-4 border-b" style="border-color: rgba(96, 165, 250, 0.1);">
              <h4 class="text-base font-bold text-center" style="color: var(--text-light); letter-spacing: 0.05em;"># D'ESTIMATION</h4>
            </div>

            <!-- Contenu -->
            <div class="p-5">
              <!-- Objectif -->
              <div class="mb-4">
                <div class="text-xs font-medium mb-2" style="color: rgba(148, 163, 184, 0.8);">Objectif</div>
                <input type="text" id="estimation-vise" value="0" data-value="0" class="rpo-metric-input bg-transparent border-none text-left w-full" style="color: rgba(96, 165, 250, 0.7); outline: none; font-size: 1.25rem;" readonly>
              </div>

              <!-- S√©parateur -->
              <div class="h-px my-4" style="background: linear-gradient(to right, transparent, rgba(96, 165, 250, 0.2), transparent);"></div>

              <!-- Devrait √™tre √† -->
              <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                  <div class="text-xs font-medium" style="color: rgba(148, 163, 184, 0.8);">Devrait √™tre √†</div>
                  <button id="estimation-advice-badge" onclick="showAdvice('estimation')" class="hidden text-xs px-2 py-1 rounded-full transition-all hover:scale-105" style="display: none; background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.5);">
                    <i class="fas fa-lightbulb mr-1"></i>Conseils
                  </button>
                </div>
                <div id="estimation-tendance" class="text-left" style="color: rgba(52, 211, 153, 0.7); font-size: 1.25rem;" data-value="0">0</div>
              </div>

              <!-- S√©parateur -->
              <div class="h-px my-4" style="background: linear-gradient(to right, transparent, rgba(96, 165, 250, 0.2), transparent);"></div>

              <!-- Actuel -->
              <div class="mb-4">
                <div class="text-base font-semibold mb-2" style="color: rgba(148, 163, 184, 0.8);">Actuel</div>
                <div id="annual-estimation-reel" class="font-bold" style="color: var(--text-light); font-size: 2rem;" data-value="0">0</div>
              </div>

              <!-- Progress bar avec pourcentage -->
              <div>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs font-medium" style="color: rgba(148, 163, 184, 0.8);">Progression</span>
                  <span id="estimation-percent" class="text-xs font-bold" style="color: var(--primary-blue);">0%</span>
                </div>
                <div class="w-full rounded-full h-2 overflow-hidden" style="background: rgba(15, 23, 42, 0.6);">
                  <div id="estimation-progress-bar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: #e5e7eb;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Contrat sign√© r√©el -->
          <div class="rounded-xl annual-stat-card" data-stat-type="contract" style="background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8)); border: 1px solid rgba(96, 165, 250, 0.15); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);">
            <div class="px-4 py-4 border-b" style="border-color: rgba(96, 165, 250, 0.1);">
              <h4 class="text-base font-bold text-center" style="color: var(--text-light); letter-spacing: 0.05em;"># CONTRAT SIGN√â</h4>
            </div>
            <div class="p-5">
              <div class="mb-4">
                <div class="text-xs font-medium mb-2" style="color: rgba(148, 163, 184, 0.8);">Objectif</div>
                <input type="text" id="contract-vise" value="0" data-value="0" class="rpo-metric-input bg-transparent border-none text-left w-full" style="color: rgba(96, 165, 250, 0.7); outline: none; font-size: 1.25rem;" readonly>
              </div>
              <div class="h-px my-4" style="background: linear-gradient(to right, transparent, rgba(96, 165, 250, 0.2), transparent);"></div>
              <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                  <div class="text-xs font-medium" style="color: rgba(148, 163, 184, 0.8);">Devrait √™tre √†</div>
                  <button id="contract-advice-badge" onclick="showAdvice('contract')" class="hidden text-xs px-2 py-1 rounded-full transition-all hover:scale-105" style="display: none; background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.5);">
                    <i class="fas fa-lightbulb mr-1"></i>Conseils
                  </button>
                </div>
                <div id="contract-tendance" class="text-left" style="color: rgba(52, 211, 153, 0.7); font-size: 1.25rem;" data-value="0">0</div>
              </div>
              <div class="h-px my-4" style="background: linear-gradient(to right, transparent, rgba(96, 165, 250, 0.2), transparent);"></div>
              <div class="mb-4">
                <div class="text-base font-semibold mb-2" style="color: rgba(148, 163, 184, 0.8);">Actuel</div>
                <div id="annual-contract-reel" class="font-bold" style="color: var(--text-light); font-size: 2rem;" data-value="0">0</div>
              </div>
              <div>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs font-medium" style="color: rgba(148, 163, 184, 0.8);">Progression</span>
                  <span id="contract-percent" class="text-xs font-bold" style="color: var(--primary-blue);">0%</span>
                </div>
                <div class="w-full rounded-full h-2 overflow-hidden" style="background: rgba(15, 23, 42, 0.6);">
                  <div id="contract-progress-bar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: #e5e7eb;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- $ sign√© r√©el -->
          <div class="rounded-xl annual-stat-card" data-stat-type="dollar" style="background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8)); border: 1px solid rgba(96, 165, 250, 0.15); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);">
            <div class="px-4 py-4 border-b" style="border-color: rgba(96, 165, 250, 0.1);">
              <h4 class="text-base font-bold text-center" style="color: var(--text-light); letter-spacing: 0.05em;">$ SIGN√â</h4>
            </div>
            <div class="p-5">
              <div class="mb-4">
                <div class="text-xs font-medium mb-2" style="color: rgba(148, 163, 184, 0.8);">Objectif</div>
                <input type="text" id="dollar-vise" value="0,00 $" data-value="0" class="rpo-metric-input bg-transparent border-none text-left w-full" style="color: rgba(96, 165, 250, 0.7); outline: none; font-size: 1.25rem;" readonly>
              </div>
              <div class="h-px my-4" style="background: linear-gradient(to right, transparent, rgba(96, 165, 250, 0.2), transparent);"></div>
              <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                  <div class="text-xs font-medium" style="color: rgba(148, 163, 184, 0.8);">Devrait √™tre √†</div>
                  <button id="dollar-advice-badge" onclick="showAdvice('dollar')" class="hidden text-xs px-2 py-1 rounded-full transition-all hover:scale-105" style="display: none; background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.5);">
                    <i class="fas fa-lightbulb mr-1"></i>Conseils
                  </button>
                </div>
                <div id="dollar-tendance" class="text-left" style="color: rgba(52, 211, 153, 0.7); font-size: 1.25rem;" data-value="0">0,00 $</div>
              </div>
              <div class="h-px my-4" style="background: linear-gradient(to right, transparent, rgba(96, 165, 250, 0.2), transparent);"></div>
              <div class="mb-4">
                <div class="text-base font-semibold mb-2" style="color: rgba(148, 163, 184, 0.8);">Actuel</div>
                <div id="annual-dollar-reel" class="font-bold" style="color: var(--text-light); font-size: 2rem;" data-value="0">0,00 $</div>
              </div>
              <div>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs font-medium" style="color: rgba(148, 163, 184, 0.8);">Progression</span>
                  <span id="dollar-percent" class="text-xs font-bold" style="color: var(--primary-blue);">0%</span>
                </div>
                <div class="w-full rounded-full h-2 overflow-hidden" style="background: rgba(15, 23, 42, 0.6);">
                  <div id="dollar-progress-bar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: #e5e7eb;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Taux mktg -->
          <div class="rounded-xl annual-stat-card" data-stat-type="mktg" style="background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8)); border: 1px solid rgba(96, 165, 250, 0.15); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);">
            <div class="px-4 py-4 border-b" style="border-color: rgba(96, 165, 250, 0.1);">
              <h4 class="text-base font-bold text-center" style="color: var(--text-light); letter-spacing: 0.05em;">TAUX MKTG</h4>
            </div>
            <div class="p-5">
              <div class="mb-4">
                <div class="text-xs font-medium mb-2" style="color: rgba(148, 163, 184, 0.8);">Objectif</div>
                <input type="text" id="mktg-vise" value="0%" data-value="0" class="rpo-metric-input bg-transparent border-none text-left w-full" style="color: rgba(96, 165, 250, 0.7); outline: none; font-size: 1.25rem;" readonly>
              </div>
              <div class="h-px my-4" style="background: linear-gradient(to right, transparent, rgba(96, 165, 250, 0.2), transparent);"></div>
              <div class="mb-4">
                <div class="text-base font-semibold mb-2" style="color: rgba(148, 163, 184, 0.8);">Actuel</div>
                <div id="mktg-reel" class="font-bold" style="color: var(--text-light); font-size: 2rem;" data-value="0">0%</div>
              </div>
              <div>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs font-medium" style="color: rgba(148, 163, 184, 0.8);">Progression</span>
                  <span id="mktg-percent" class="text-xs font-bold" style="color: var(--primary-blue);">0%</span>
                </div>
                <div class="w-full rounded-full h-2 overflow-hidden" style="background: rgba(15, 23, 42, 0.6);">
                  <div id="mktg-progress-bar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: #e5e7eb;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Taux vente -->
          <div class="rounded-xl annual-stat-card" data-stat-type="vente" style="background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8)); border: 1px solid rgba(96, 165, 250, 0.15); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);">
            <div class="px-4 py-4 border-b" style="border-color: rgba(96, 165, 250, 0.1);">
              <h4 class="text-base font-bold text-center" style="color: var(--text-light); letter-spacing: 0.05em;">TAUX DE VENTE</h4>
            </div>
            <div class="p-5">
              <div class="mb-4">
                <div class="text-xs font-medium mb-2" style="color: rgba(148, 163, 184, 0.8);">Objectif</div>
                <input type="text" id="vente-vise" value="0%" data-value="0" class="rpo-metric-input bg-transparent border-none text-left w-full" style="color: rgba(96, 165, 250, 0.7); outline: none; font-size: 1.25rem;" readonly>
              </div>
              <div class="h-px my-4" style="background: linear-gradient(to right, transparent, rgba(96, 165, 250, 0.2), transparent);"></div>
              <div class="mb-4">
                <div class="text-base font-semibold mb-2" style="color: rgba(148, 163, 184, 0.8);">Actuel</div>
                <div id="vente-reel" class="font-bold" style="color: var(--text-light); font-size: 2rem;" data-value="0">0%</div>
              </div>
              <div>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs font-medium" style="color: rgba(148, 163, 184, 0.8);">Progression</span>
                  <span id="vente-percent" class="text-xs font-bold" style="color: var(--primary-blue);">0%</span>
                </div>
                <div class="w-full rounded-full h-2 overflow-hidden" style="background: rgba(15, 23, 42, 0.6);">
                  <div id="vente-progress-bar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: #e5e7eb;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Contrat moyen -->
          <div class="rounded-xl annual-stat-card" data-stat-type="moyen" style="background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8)); border: 1px solid rgba(96, 165, 250, 0.15); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);">
            <div class="px-4 py-4 border-b" style="border-color: rgba(96, 165, 250, 0.1);">
              <h4 class="text-base font-bold text-center" style="color: var(--text-light); letter-spacing: 0.05em;">CONTRAT MOYEN</h4>
            </div>
            <div class="p-5">
              <div class="mb-4">
                <div class="text-xs font-medium mb-2" style="color: rgba(148, 163, 184, 0.8);">Objectif</div>
                <input type="text" id="moyen-vise" value="0,00 $" data-value="0" class="rpo-metric-input bg-transparent border-none text-left w-full" style="color: rgba(96, 165, 250, 0.7); outline: none; font-size: 1.25rem;" readonly>
              </div>
              <div class="h-px my-4" style="background: linear-gradient(to right, transparent, rgba(96, 165, 250, 0.2), transparent);"></div>
              <div class="mb-4">
                <div class="text-base font-semibold mb-2" style="color: rgba(148, 163, 184, 0.8);">Actuel</div>
                <div id="moyen-reel" class="font-bold" style="color: var(--text-light); font-size: 2rem;" data-value="0">0,00 $</div>
              </div>
              <div>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs font-medium" style="color: rgba(148, 163, 184, 0.8);">Progression</span>
                  <span id="moyen-percent" class="text-xs font-bold" style="color: var(--primary-blue);">0%</span>
                </div>
                <div class="w-full rounded-full h-2 overflow-hidden" style="background: rgba(15, 23, 42, 0.6);">
                  <div id="moyen-progress-bar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: #e5e7eb;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tendance CA attendu -->
          <div class="rounded-xl annual-stat-card" data-stat-type="tendance" style="background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8)); border: 1px solid rgba(96, 165, 250, 0.15); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);">
            <div class="px-4 py-4 border-b" style="border-color: rgba(96, 165, 250, 0.1);">
              <h4 class="text-base font-bold text-center" style="color: var(--text-light); letter-spacing: 0.05em;">TENDANCE CA</h4>
            </div>
            <div class="p-5">
              <div class="mb-4">
                <div class="text-xs font-medium mb-2" style="color: rgba(148, 163, 184, 0.8);">Objectif</div>
                <input type="text" id="tendance-vise" value="0,00 $" data-value="0" class="rpo-metric-input bg-transparent border-none text-left w-full" style="color: rgba(96, 165, 250, 0.7); outline: none; font-size: 1.25rem;" readonly>
              </div>
              <div class="h-px my-4" style="background: linear-gradient(to right, transparent, rgba(96, 165, 250, 0.2), transparent);"></div>
              <div class="mb-4">
                <div class="text-base font-semibold mb-2" style="color: rgba(148, 163, 184, 0.8);">Actuel</div>
                <div id="tendance-reel" class="font-bold" style="color: var(--text-light); font-size: 2rem;" data-value="0">0,00 $</div>
              </div>
              <div>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs font-medium" style="color: rgba(148, 163, 184, 0.8);">Progression</span>
                  <span id="tendance-percent" class="text-xs font-bold" style="color: var(--primary-blue);">0%</span>
                </div>
                <div class="w-full rounded-full h-2 overflow-hidden" style="background: rgba(15, 23, 42, 0.6);">
                  <div id="tendance-progress-bar" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: #e5e7eb;"></div>
                </div>
              </div>
            </div>
          </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Ligne de s√©paration -->
    <div class="my-12 relative">
      <div class="absolute inset-0 flex items-center">
        <div class="w-full border-t" style="border-color: var(--border-dark);"></div>
      </div>
      <div class="relative flex justify-center">
        <span class="px-6 py-2 rounded-full text-sm font-semibold" style="background: rgb(30, 41, 59); color: var(--text-gray); border: 1px solid var(--border-dark); display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-chart-line"></i>
          <span>D√©tails mensuels</span>
        </span>
      </div>
    </div>

    <!-- Section M√©triques mensuelles -->
    <div class="flex flex-col mb-8" style="border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; overflow: hidden;">

      <!-- Header -->
      <div class="flex items-center justify-between px-6" style="background: var(--bg-card); border-bottom: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem 1rem 0 0; min-height: 80px;">
        <div class="flex items-center gap-3">
          <div style="width: 48px; height: 48px; border-radius: 12px; background: #f97316; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-calendar-check" style="font-size: 1.5rem; color: white;"></i>
          </div>
          <h3 class="text-2xl font-bold" style="color: var(--text-light);">
            <span id="currentMonthlyLabel" class="text-long">Objectifs et r√©sultats mensuels - Janvier 2026</span>
            <span class="text-short" style="display: none;">Mensuel</span>
          </h3>
        </div>
        <div class="dropdown-with-label">
          <label class="dropdown-label">Mois</label>
          <div class="custom-select" id="monthlySelector" style="width: 180px;">
            <div class="custom-select-button">
              <span class="custom-select-text">Janvier 2026</span>
              <span class="custom-select-arrow">‚ñº</span>
            </div>
            <div class="custom-select-dropdown">
              <div class="custom-select-option selected" data-value="0">Janvier 2026</div>
              <div class="custom-select-option" data-value="1">F√©vrier 2026</div>
              <div class="custom-select-option" data-value="2">Mars 2026</div>
              <div class="custom-select-option" data-value="3">Avril 2026</div>
              <div class="custom-select-option" data-value="4">Mai 2026</div>
              <div class="custom-select-option" data-value="5">Juin 2026</div>
              <div class="custom-select-option" data-value="6">Juillet 2026</div>
              <div class="custom-select-option" data-value="7">Ao√ªt 2026</div>
              <div class="custom-select-option" data-value="8">Septembre 2026</div>
              <div class="custom-select-option" data-value="9">Octobre 2026</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Contenu -->
      <div class="p-6" style="background: var(--bg-card);">
        <div id="monthlyContainer"></div>
      </div>
    </div>

    <!-- S√©parateur Hebdomadaire -->
    <div class="relative my-8">
      <div class="absolute inset-0 flex items-center">
        <div class="w-full border-t" style="border-color: var(--border-dark);"></div>
      </div>
      <div class="relative flex justify-center">
        <span class="px-6 py-2 rounded-full text-sm font-semibold" style="background: rgb(30, 41, 59); color: var(--text-gray); border: 1px solid var(--border-dark); display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-calendar-week"></i>
          <span>D√©tails hebdomadaires</span>
        </span>
      </div>
    </div>

    <!-- Section Hebdomadaire - Janvier 2026 -->
    <div id="weekly-section-container" class="flex flex-col mb-8" style="border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem; overflow: hidden;">

      <!-- Header avec titre, dropdown mois et boutons -->
      <div class="flex items-center justify-between px-6" style="background: var(--bg-card); border-radius: 1rem 1rem 0 0; min-height: 80px; border-bottom: 1px solid rgba(51, 65, 85, 0.5);">
        <div class="flex items-center gap-3">
          <div style="width: 48px; height: 48px; border-radius: 12px; background: #06b6d4; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-calendar-week" style="font-size: 1.5rem; color: white;"></i>
          </div>
          <h3 class="text-2xl font-bold" style="color: var(--text-light);">
            <span id="currentMonthLabel" class="text-long">Objectifs et r√©sultats hebdomadaires - Janvier 2026</span>
            <span class="text-short" style="display: none;">Hebdomadaire</span>
          </h3>
        </div>
        <div class="flex items-center gap-3">
        <div class="dropdown-with-label">
          <label class="dropdown-label">Mois</label>
          <div class="custom-select" id="monthSelector" style="width: 180px; position: relative;">
              <div class="custom-select-button" style="position: relative;">
                <span class="custom-select-text">Janvier 2026</span>
                <span class="custom-select-arrow">‚ñº</span>
                <span id="totalBadge" style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; min-width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; padding: 0 5px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); z-index: 1000;">0</span>
              </div>
            <div class="custom-select-dropdown">
              <div class="custom-select-option selected" data-value="0" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Janvier 2026</span>
                <span class="month-badge hidden" data-month="0" style="background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">0</span>
              </div>
              <div class="custom-select-option" data-value="1" style="display: flex; justify-content: space-between; align-items: center;">
                <span>F√©vrier 2026</span>
                <span class="month-badge hidden" data-month="1" style="background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">0</span>
              </div>
              <div class="custom-select-option" data-value="2" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Mars 2026</span>
                <span class="month-badge hidden" data-month="2" style="background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">0</span>
              </div>
              <div class="custom-select-option" data-value="3" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Avril 2026</span>
                <span class="month-badge hidden" data-month="3" style="background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">0</span>
              </div>
              <div class="custom-select-option" data-value="4" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Mai 2026</span>
                <span class="month-badge hidden" data-month="4" style="background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">0</span>
              </div>
              <div class="custom-select-option" data-value="5" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Juin 2026</span>
                <span class="month-badge hidden" data-month="5" style="background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">0</span>
              </div>
              <div class="custom-select-option" data-value="6" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Juillet 2026</span>
                <span class="month-badge hidden" data-month="6" style="background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">0</span>
              </div>
              <div class="custom-select-option" data-value="7" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Ao√ªt 2026</span>
                <span class="month-badge hidden" data-month="7" style="background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">0</span>
              </div>
              <div class="custom-select-option" data-value="8" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Septembre 2026</span>
                <span class="month-badge hidden" data-month="8" style="background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">0</span>
              </div>
              <div class="custom-select-option" data-value="9" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Octobre 2026</span>
                <span class="month-badge hidden" data-month="9" style="background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">0</span>
              </div>
            </div>
            </div>
          </div>
        <div class="dropdown-with-label">
          <label class="dropdown-label">Semaine</label>
          <div class="custom-select" id="weekSelector" style="width: 200px; position: relative;">
            <div class="custom-select-button" style="position: relative;">
              <span class="custom-select-text">5 - 11 janv.</span>
              <span class="custom-select-arrow">‚ñº</span>
            </div>
            <div class="custom-select-dropdown" id="weekSelectorDropdown">
              <!-- Sera rempli dynamiquement -->
            </div>
          </div>
        </div>
        </div>
      </div>

      <!-- Contenu -->
      <div id="weekly-content-section" class="p-6" style="background: var(--bg-card); position: relative;">

        <!-- Boutons de navigation -->
        <div class="flex items-center justify-between mb-6">
          <div class="tab-spacing">
            <button id="objectifsBtn" onclick="showObjectifs()" class="btn-primary" style="padding: 4px 12px !important; font-size: 0.875rem !important; position: relative; overflow: visible !important;">
              Objectifs<span class="desktop-only-text"> de la semaine</span>
              <span id="incompleteWeeksBadge" class="hidden" style="position: absolute; top: -10px; right: -10px; background: #ef4444; color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; box-shadow: 0 2px 6px rgba(0,0,0,0.3); z-index: 1000;">0</span>
            </button>
            <button id="resumeBtn" onclick="showResume()" class="btn-secondary" style="padding: 4px 12px !important; font-size: 0.875rem !important; position: relative; overflow: visible !important;">
              R√©sum√©<span class="desktop-only-text"> de la semaine</span>
              <span id="incompleteWeeksBadge2" class="hidden" style="position: absolute; top: -10px; right: -10px; background: #ef4444; color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; box-shadow: 0 2px 6px rgba(0,0,0,0.3); z-index: 1000;">0</span>
            </button>
          </div>
          <div id="objectifsButtonsContainer" class="flex items-center gap-3">
            <button id="editWeekJanBtn" onclick="toggleEditWeekJan()" class="rounded-lg flex items-center gap-2 justify-center transition-all hover:scale-105 px-3 py-2" style="background: rgba(96, 165, 250, 0.15); color: var(--primary-blue); border: 1px solid rgba(96, 165, 250, 0.3);" title="Modifier">
              <i class="fas fa-pencil-alt text-xs"></i>
              <span class="text-xs font-bold">Modifier</span>
            </button>
            <button id="saveWeekJanBtn" onclick="saveWeekJan()" class="hidden rounded-lg flex items-center gap-2 justify-center transition-all hover:scale-105 px-3 py-2" style="background: rgba(52, 211, 153, 0.15); color: var(--primary-green); border: 1px solid rgba(52, 211, 153, 0.3);" title="Enregistrer">
              <i class="fas fa-save text-xs"></i>
              <span class="text-xs font-bold">Enregistrer</span>
            </button>
          </div>
        </div>

        <!-- Mobile Weekly Objectifs (une seule semaine) -->
        <div id="mobileWeeklyObjectifs" style="display: none;">
          <!-- Sera rempli dynamiquement par JavaScript -->
        </div>

        <!-- Grille des semaines - Objectifs -->
        <div id="objectifsTable" class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr style="border-bottom: 2px solid var(--border-dark);">
                <th class="p-3 text-left text-sm font-semibold sticky-semaine-header" style="color: var(--text-gray); background: rgb(30, 41, 59); border-radius: 14px 14px 0px 0px; position: sticky; z-index: 20;">Semaine</th>
                <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background-color: #0f172a; border-radius: 14px 14px 0px 0px;">H Marketing</th>
                <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background: rgba(30, 41, 59, 0.5); border-radius: 14px 14px 0px 0px; min-width: 140px;">H Mktg R√©el</th>
                <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background-color: #0f172a; border-radius: 14px 14px 0px 0px;">Estimation #</th>
                <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background: rgba(30, 41, 59, 0.5); border-radius: 14px 14px 0px 0px; min-width: 140px;">Estimation R√©el</th>
                <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background-color: #0f172a; border-radius: 14px 14px 0px 0px;">Contrat Sign√©</th>
                <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background: rgba(30, 41, 59, 0.5); border-radius: 14px 14px 0px 0px; min-width: 140px;">Contrat Sign√© R√©el</th>
                <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background-color: #0f172a; border-radius: 14px 14px 0px 0px;">$ Sign√©</th>
                <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background: rgba(30, 41, 59, 0.5); border-radius: 14px 14px 0px 0px; min-width: 140px;">$ Sign√© R√©el</th>
              </tr>
            </thead>
            <tbody>
              <!-- Semaine 1 -->
              <tr style="border-bottom: 1px solid var(--border-dark); height: 60px;">
                <td class="p-3 text-xs" style="color: var(--text-gray);">5 janv. - 11 janv.</td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0 h"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0 h"></td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0"></td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0"></td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0 $"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0 $"></td>
              </tr>

              <!-- Semaine 3 -->
              <tr style="border-bottom: 1px solid var(--border-dark); height: 60px;">
                <td class="p-3 text-xs" style="color: var(--text-gray);">12 janv. - 18 janv.</td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0 h"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0 h"></td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0"></td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0"></td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0 $"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0 $"></td>
              </tr>

              <!-- Semaine 4 -->
              <tr style="border-bottom: 1px solid var(--border-dark); height: 60px;">
                <td class="p-3 text-xs" style="color: var(--text-gray);">19 janv. - 25 janv.</td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0 h"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0 h"></td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0"></td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0"></td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0 $"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0 $"></td>
              </tr>

              <!-- Semaine 5 -->
              <tr style="border-bottom: 1px solid var(--border-dark); height: 60px;">
                <td class="p-3 text-xs" style="color: var(--text-gray);">26 janv. - 1 f√©vr.</td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0 h"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0 h"></td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0"></td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0"></td>
                <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly class="bg-transparent rounded px-2 py-1 w-20 text-center" style="cursor: not-allowed; background-color: transparent; color: #9ca3af; text-align: center; border: none;" value="0 $"></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-input rpo-metric-input bg-transparent border-none text-center w-20" style="color: var(--text-light); outline: none;" value="0 $"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Mobile Weekly Resume (une seule semaine) -->
        <div id="mobileWeeklyResume" style="display: none;">
          <!-- Sera rempli dynamiquement par JavaScript -->
        </div>

        <!-- Grille des semaines - R√©sum√© -->
        <div id="resumeTable" class="overflow-x-auto hidden">
          <table class="w-full">
            <thead>
              <tr style="border-bottom: 2px solid var(--border-dark);">
                <th class="p-3 text-left text-sm font-semibold sticky-semaine-header" style="color: var(--text-gray); background: rgb(30, 41, 59); border-radius: 14px 14px 0px 0px; position: sticky; z-index: 20;">Semaine</th>
                <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background: rgba(30, 41, 59, 0.5); border-radius: 14px 14px 0px 0px;">Comment vas-tu</th>
                <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background: rgba(30, 41, 59, 0.5); border-radius: 14px 14px 0px 0px;">Analyse de la semaine pass√©e</th>
                <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background: rgba(30, 41, 59, 0.5); border-radius: 14px 14px 0px 0px;">Focus de la semaine</th>
              </tr>
            </thead>
            <tbody>
              <!-- Semaine 1 -->
              <tr style="border-bottom: 1px solid var(--border-dark); height: 60px;">
                <td class="p-3 text-xs sticky-semaine-header" style="color: var(--text-gray); position: sticky; left: 0; background: var(--bg-card); z-index: 10;">5 janv. - 11 janv.</td>
                <td class="p-3 text-center">
                  <div class="flex gap-1 justify-center">
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="2" data-rating="1"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="2" data-rating="2"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="2" data-rating="3"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="2" data-rating="4"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="2" data-rating="5"></i>
                  </div>
                </td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-resume rpo-metric-input bg-transparent border-none text-center w-full" style="color: var(--text-light); outline: none;" placeholder="Probl√®me..."></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-resume rpo-metric-input bg-transparent border-none text-center w-full" style="color: var(--text-light); outline: none;" placeholder="Focus..."></td>
              </tr>

              <!-- Semaine 3 -->
              <tr style="border-bottom: 1px solid var(--border-dark); height: 60px;">
                <td class="p-3 text-xs sticky-semaine-header" style="color: var(--text-gray); position: sticky; left: 0; background: var(--bg-card); z-index: 10;">12 janv. - 18 janv.</td>
                <td class="p-3 text-center">
                  <div class="flex gap-1 justify-center">
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="3" data-rating="1"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="3" data-rating="2"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="3" data-rating="3"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="3" data-rating="4"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="3" data-rating="5"></i>
                  </div>
                </td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-resume rpo-metric-input bg-transparent border-none text-center w-full" style="color: var(--text-light); outline: none;" placeholder="Probl√®me..."></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-resume rpo-metric-input bg-transparent border-none text-center w-full" style="color: var(--text-light); outline: none;" placeholder="Focus..."></td>
              </tr>

              <!-- Semaine 4 -->
              <tr style="border-bottom: 1px solid var(--border-dark); height: 60px;">
                <td class="p-3 text-xs sticky-semaine-header" style="color: var(--text-gray); position: sticky; left: 0; background: var(--bg-card); z-index: 10;">19 janv. - 25 janv.</td>
                <td class="p-3 text-center">
                  <div class="flex gap-1 justify-center">
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="4" data-rating="1"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="4" data-rating="2"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="4" data-rating="3"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="4" data-rating="4"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="4" data-rating="5"></i>
                  </div>
                </td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-resume rpo-metric-input bg-transparent border-none text-center w-full" style="color: var(--text-light); outline: none;" placeholder="Probl√®me..."></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-resume rpo-metric-input bg-transparent border-none text-center w-full" style="color: var(--text-light); outline: none;" placeholder="Focus..."></td>
              </tr>

              <!-- Semaine 5 -->
              <tr style="border-bottom: 1px solid var(--border-dark); height: 60px;">
                <td class="p-3 text-xs sticky-semaine-header" style="color: var(--text-gray); position: sticky; left: 0; background: var(--bg-card); z-index: 10;">26 janv. - 1 f√©vr.</td>
                <td class="p-3 text-center">
                  <div class="flex gap-1 justify-center">
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="5" data-rating="1"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="5" data-rating="2"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="5" data-rating="3"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="5" data-rating="4"></i>
                    <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating" style="color: #374151;" data-week="5" data-rating="5"></i>
                  </div>
                </td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-resume rpo-metric-input bg-transparent border-none text-center w-full" style="color: var(--text-light); outline: none;" placeholder="Probl√®me..."></td>
                <td class="p-3 text-center"><input type="text" readonly class="week-jan-resume rpo-metric-input bg-transparent border-none text-center w-full" style="color: var(--text-light); outline: none;" placeholder="Focus..."></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Page Plan d'affaire -->
  <div id="plan-affaire" class="page-content hidden">

    <!-- En-t√™te du plan -->
    <div class="glass-card shadow mb-8">
      <div class="flex items-center justify-between px-6" style="background: var(--bg-card); border-bottom: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem 1rem 0 0; min-height: 80px;">
        <div class="flex items-center gap-3">
          <div style="width: 48px; height: 48px; border-radius: 12px; background: #60a5fa; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-briefcase" style="font-size: 1.5rem; color: white;"></i>
          </div>
          <h3 class="text-2xl font-bold" style="color: var(--text-light);">
            Pr√©vision
          </h3>
        </div>
        <div class="flex items-center gap-2">
          <button id="editPlanBtn" onclick="toggleEditPlan()" class="rounded-lg flex items-center gap-2 justify-center transition-all hover:scale-105 px-3 py-2" style="background: rgba(96, 165, 250, 0.15); color: var(--primary-blue); border: 1px solid rgba(96, 165, 250, 0.3);" title="Modifier">
            <i class="fas fa-pencil-alt text-xs"></i>
            <span class="text-xs font-bold">Modifier</span>
          </button>
          <button id="savePlanBtn" onclick="savePlan()" class="hidden rounded-lg flex items-center gap-2 justify-center transition-all hover:scale-105 px-3 py-2" style="background: rgba(52, 211, 153, 0.15); color: var(--primary-green); border: 1px solid rgba(52, 211, 153, 0.3);" title="Enregistrer">
            <i class="fas fa-save text-xs"></i>
            <span class="text-xs font-bold">Enregistrer</span>
          </button>
        </div>
      </div>
      <div class="p-3">
        <div class="mb-6"></div>

        <!-- Param√®tres du plan -->
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
          <!-- Objectif Vente -->
          <div class="rounded-lg p-4" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark);">
            <div class="text-xs mb-2" style="color: var(--text-gray);">Objectif Vente</div>
            <input type="text" id="plan-objectif" value="0,00 $" data-value="0" class="bg-transparent border-none w-full text-sm font-semibold plan-param-input" style="color: var(--primary-blue); outline: none;" readonly>
          </div>

          <!-- Contrat moyen pr√©vision -->
          <div class="rounded-lg p-4" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark);">
            <div class="text-xs mb-2" style="color: var(--text-gray);">CM Pr√©vision <span id="cm-prev-default-label" style="opacity: 0.6; font-style: italic;">(par d√©faut)</span></div>
            <input type="text" id="plan-cm-prev" value="2 500,00 $" data-value="2500" class="bg-transparent border-none w-full text-sm font-semibold plan-param-input" style="color: var(--primary-blue); outline: none;" readonly>
          </div>

          <!-- Taux horaire (cach√© mais actif en arri√®re-plan) -->
          <div class="rounded-lg p-4" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark); display: none;">
            <div class="text-xs mb-2" style="color: var(--text-gray);">Taux horaire</div>
            <input type="text" id="plan-taux-horaire" value="43,00 $" data-value="43" class="bg-transparent border-none w-full text-sm font-semibold plan-param-input" style="color: var(--primary-blue); outline: none;" readonly>
          </div>

          <!-- Ratio Marketing -->
          <div class="rounded-lg p-4" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark);">
            <div class="text-xs mb-2" style="color: var(--text-gray);">Ratio Marketing <span id="ratio-mktg-default-label" style="opacity: 0.6; font-style: italic;">(par d√©faut)</span></div>
            <input type="text" id="plan-ratio-mktg" value="0.85" data-value="85" class="bg-transparent border-none w-full text-sm font-semibold plan-param-input" style="color: var(--primary-blue); outline: none;" readonly>
          </div>

          <!-- Taux de vente -->
          <div class="rounded-lg p-4" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark);">
            <div class="text-xs mb-2" style="color: var(--text-gray);">Taux de vente <span id="taux-vente-default-label" style="opacity: 0.6; font-style: italic;">(par d√©faut)</span></div>
            <input type="text" id="plan-taux-vente" value="30%" data-value="30" class="bg-transparent border-none w-full text-sm font-semibold plan-param-input" style="color: var(--primary-blue); outline: none;" readonly>
          </div>

          <!-- Ventes actuelles (calcul√© - cach√©) -->
          <div class="rounded-lg p-4" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark); display: none;">
            <div class="text-xs mb-2" style="color: var(--text-gray);">Ventes</div>
            <div id="plan-ventes-actuel" class="text-sm font-semibold" style="color: #94a3b8;">0,00 $</div>
          </div>

          <!-- % atteint (calcul√© - cach√©) -->
          <div class="rounded-lg p-4" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark); display: none;">
            <div class="text-xs mb-2" style="color: var(--text-gray);">% Atteint</div>
            <div id="plan-pct-atteint" class="text-sm font-semibold" style="color: #94a3b8;">0,00%</div>
          </div>
        </div>

      </div>
    </div>

    <!-- Tableau hebdomadaire -->
    <div class="glass-card shadow">
      <div class="flex items-center justify-between px-6" style="background: var(--bg-card); border-bottom: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem 1rem 0 0; min-height: 80px;">
        <div class="flex items-center gap-3">
          <div style="width: 48px; height: 48px; border-radius: 12px; background: #10b981; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-calendar-week" style="font-size: 1.5rem; color: white;"></i>
          </div>
          <h3 class="text-2xl font-bold" style="color: var(--text-light);">
            Plan d'affaire - 2026
          </h3>
        </div>
        <!-- Dropdown mois sur desktop -->
        <div class="flex items-center gap-2 plan-header-dropdowns-desktop">
          <div class="custom-select" id="planMonthSelectorDesktop" style="width: 180px;">
            <div class="custom-select-button">
              <span class="custom-select-text">Tout l'ann√©e</span>
              <span class="custom-select-arrow">‚ñº</span>
            </div>
            <div class="custom-select-dropdown">
              <div class="custom-select-option selected" data-value="all">Tout l'ann√©e</div>
              <div class="custom-select-option" data-value="2026-1">Janvier</div>
              <div class="custom-select-option" data-value="2026-2">F√©vrier</div>
              <div class="custom-select-option" data-value="2026-3">Mars</div>
              <div class="custom-select-option" data-value="2026-4">Avril</div>
              <div class="custom-select-option" data-value="2026-5">Mai</div>
              <div class="custom-select-option" data-value="2026-6">Juin</div>
              <div class="custom-select-option" data-value="2026-7">Juillet</div>
              <div class="custom-select-option" data-value="2026-8">Ao√ªt</div>
              <div class="custom-select-option" data-value="2026-9">Septembre</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dropdowns Mois et Semaine (visible seulement sur mobile) -->
      <div class="flex items-center justify-start gap-3 px-6 plan-mobile-dropdowns lg:hidden" style="background: var(--bg-card); border-bottom: 1px solid rgba(51, 65, 85, 0.5); padding-top: 0.5rem; padding-bottom: 0.75rem;">
        <div class="dropdown-with-label">
          <label class="dropdown-label">Mois</label>
          <div class="custom-select" id="planMonthSelector" style="width: 150px;">
            <div class="custom-select-button">
              <span class="custom-select-text">Janvier 2026</span>
              <span class="custom-select-arrow">‚ñº</span>
            </div>
            <div class="custom-select-dropdown">
              <div class="custom-select-option" data-value="2026-1">Janvier</div>
              <div class="custom-select-option" data-value="2026-2">F√©vrier</div>
              <div class="custom-select-option" data-value="2026-3">Mars</div>
              <div class="custom-select-option" data-value="2026-4">Avril</div>
              <div class="custom-select-option" data-value="2026-5">Mai</div>
              <div class="custom-select-option" data-value="2026-6">Juin</div>
              <div class="custom-select-option" data-value="2026-7">Juillet</div>
              <div class="custom-select-option" data-value="2026-8">Ao√ªt</div>
              <div class="custom-select-option" data-value="2026-9">Septembre</div>
            </div>
          </div>
        </div>
        <div class="dropdown-with-label">
          <label class="dropdown-label">Semaine</label>
          <div class="custom-select" id="planWeekSelector" style="width: 140px;">
            <div class="custom-select-button">
              <span class="custom-select-text">S√©lectionner...</span>
              <span class="custom-select-arrow">‚ñº</span>
            </div>
            <div class="custom-select-dropdown" id="planWeekSelectorDropdown">
              <!-- Sera rempli dynamiquement -->
            </div>
          </div>
        </div>
      </div>

      <div class="p-8">
        <div class="mb-6"></div>

        <!-- Tableau scrollable avec sticky moderne -->
        <div class="plan-scroll-container" style="overflow-x: auto; overflow-y: visible; position: relative; border-radius: 14px; border: 1px solid var(--border-dark);">
          <table class="plan-table" style="width: 100%; min-width: 2400px; border-collapse: separate; border-spacing: 0;">
            <!-- En-t√™te sticky -->
            <thead style="position: sticky; top: 0; background: #0f172a;">
              <!-- Ligne 1: Groupes principaux -->
              <tr>
                <th rowspan="2" class="plan-th-sticky" style="left: 0; width: 180px; min-width: 180px; max-width: 180px;">
                  <div class="plan-header-cell">Semaine</div>
                </th>

                <!-- H. Marketing -->
                <th colspan="5" class="plan-th-group" style="background: linear-gradient(135deg, rgba(96, 165, 250, 0.15), rgba(96, 165, 250, 0.05)); border-left: 2px solid rgba(96, 165, 250, 0.3);">
                  <div class="plan-header-cell">
                    <i class="fas fa-bullhorn mr-1"></i>H. Marketing
                  </div>
                </th>

                <!-- Estimations -->
                <th colspan="6" class="plan-th-group" style="background: linear-gradient(135deg, rgba(52, 211, 153, 0.15), rgba(52, 211, 153, 0.05)); border-left: 2px solid rgba(52, 211, 153, 0.3);">
                  <div class="plan-header-cell">
                    <i class="fas fa-file-alt mr-1"></i>Estimations
                  </div>
                </th>

                <!-- Contrats -->
                <th colspan="5" class="plan-th-group" style="background: linear-gradient(135deg, rgba(251, 146, 60, 0.15), rgba(251, 146, 60, 0.05)); border-left: 2px solid rgba(251, 146, 60, 0.3);">
                  <div class="plan-header-cell">
                    <i class="fas fa-handshake mr-1"></i>Contrats
                  </div>
                </th>

                <!-- $ Sign√©s -->
                <th colspan="5" class="plan-th-group" style="background: linear-gradient(135deg, rgba(244, 114, 182, 0.15), rgba(244, 114, 182, 0.05)); border-left: 2px solid rgba(244, 114, 182, 0.3);">
                  <div class="plan-header-cell">
                    <i class="fas fa-dollar-sign mr-1"></i>$ Sign√©s
                  </div>
                </th>

                <!-- % Objectif -->
                <th colspan="3" class="plan-th-group" style="background: linear-gradient(135deg, rgba(167, 139, 250, 0.35), rgba(167, 139, 250, 0.20)); border-left: 2px solid rgba(167, 139, 250, 0.3);">
                  <div class="plan-header-cell" style="font-weight: 800; font-size: 1.05em;">
                    <i class="fas fa-bullseye mr-1"></i>% Objectif
                  </div>
                </th>

                <!-- Production -->
                <th colspan="6" class="plan-th-group" style="background: linear-gradient(135deg, rgba(45, 212, 191, 0.15), rgba(45, 212, 191, 0.05)); border-left: 2px solid rgba(45, 212, 191, 0.3);">
                  <div class="plan-header-cell">
                    <i class="fas fa-cogs mr-1"></i>Production
                  </div>
                </th>
              </tr>

              <!-- Ligne 2: Sous-colonnes -->
              <tr>
                <!-- H. Marketing -->
                <th class="plan-th-sub" style="background: rgba(96, 165, 250, 0.08); min-width: 110px;">Objectif</th>
                <th class="plan-th-sub" style="background: rgba(96, 165, 250, 0.08); min-width: 140px;">R√©el</th>
                <th class="plan-th-sub" style="background: rgba(96, 165, 250, 0.08); min-width: 110px;">Cumul Obj.</th>
                <th class="plan-th-sub" style="background: rgba(96, 165, 250, 0.08); min-width: 110px;">Cumul R√©el</th>
                <th class="plan-th-sub" style="background: rgba(96, 165, 250, 0.08); min-width: 110px;">Tendance</th>
                <!-- Estimations -->
                <th class="plan-th-sub" style="background: rgba(52, 211, 153, 0.08); min-width: 110px;">Objectif</th>
                <th class="plan-th-sub" style="background: rgba(52, 211, 153, 0.08); min-width: 140px;">R√©el</th>
                <th class="plan-th-sub" style="background: rgba(52, 211, 153, 0.08); min-width: 110px;">Cumul Obj.</th>
                <th class="plan-th-sub" style="background: rgba(52, 211, 153, 0.08); min-width: 110px;">Cumul R√©el</th>
                <th class="plan-th-sub" style="background: rgba(52, 211, 153, 0.08); min-width: 110px;">Tendance</th>
                <th class="plan-th-sub" style="background: rgba(52, 211, 153, 0.08); min-width: 110px;">Ratio Mktg</th>
                <!-- Contrats -->
                <th class="plan-th-sub" style="background: rgba(251, 146, 60, 0.08); min-width: 110px;">Objectif</th>
                <th class="plan-th-sub" style="background: rgba(251, 146, 60, 0.08); min-width: 140px;">R√©el</th>
                <th class="plan-th-sub" style="background: rgba(251, 146, 60, 0.08); min-width: 110px;">Cumul Obj.</th>
                <th class="plan-th-sub" style="background: rgba(251, 146, 60, 0.08); min-width: 110px;">Cumul R√©el</th>
                <th class="plan-th-sub" style="background: rgba(251, 146, 60, 0.08); min-width: 110px;">Tendance</th>
                <!-- $ Sign√©s -->
                <th class="plan-th-sub" style="background: rgba(244, 114, 182, 0.08); min-width: 110px;">Objectif</th>
                <th class="plan-th-sub" style="background: rgba(244, 114, 182, 0.08); min-width: 140px;">R√©el</th>
                <th class="plan-th-sub" style="background: rgba(244, 114, 182, 0.08); min-width: 110px;">Cumul Obj.</th>
                <th class="plan-th-sub" style="background: rgba(244, 114, 182, 0.08); min-width: 110px;">Cumul R√©el</th>
                <th class="plan-th-sub" style="background: rgba(244, 114, 182, 0.08); min-width: 110px;">Tendance</th>
                <!-- % Objectif -->
                <th class="plan-th-sub" style="background: rgba(167, 139, 250, 0.25); font-weight: 700; min-width: 110px;">Sem.</th>
                <th class="plan-th-sub" style="background: rgba(167, 139, 250, 0.25); font-weight: 700; min-width: 110px;">Cumul</th>
                <th class="plan-th-sub" style="background: rgba(167, 139, 250, 0.25); font-weight: 700; min-width: 110px;">TV %</th>
                <!-- Production -->
                <th class="plan-th-sub" style="background: rgba(45, 212, 191, 0.08); min-width: 110px;">Objectif</th>
                <th class="plan-th-sub" style="background: rgba(45, 212, 191, 0.08); min-width: 140px;">R√©el</th>
                <th class="plan-th-sub" style="background: rgba(45, 212, 191, 0.08); min-width: 110px;">Cumul Obj.</th>
                <th class="plan-th-sub" style="background: rgba(45, 212, 191, 0.08); min-width: 110px;">Cumul R√©el</th>
                <th class="plan-th-sub" style="background: rgba(45, 212, 191, 0.08); min-width: 110px;">Tendance</th>
                <th class="plan-th-sub" style="background: rgba(45, 212, 191, 0.08); min-width: 110px;">%</th>
              </tr>
            </thead>

            <!-- Corps du tableau -->
            <tbody id="plan-weeks-body">
              <!-- G√©n√©r√© par JavaScript -->
            </tbody>

            <!-- Footer sticky -->
            <tfoot style="position: sticky; bottom: 0; z-index: 90; background: linear-gradient(180deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.98)); backdrop-filter: blur(10px);">
              <tr>
                <td class="plan-td-sticky" style="left: 0; width: 180px; min-width: 180px; max-width: 180px;">
                  <div class="plan-footer-cell">TOTAL</div>
                </td>
                <!-- H. Marketing: Objectif, R√©el, Cumul Obj., Cumul, Tendance -->
                <td id="total-mktg-prev" class="plan-td-footer">0</td>
                <td id="total-mktg-reel" class="plan-td-footer plan-td-highlight">0</td>
                <td id="total-mktg-cumul-obj" class="plan-td-footer">-</td>
                <td id="total-mktg-cumul" class="plan-td-footer">-</td>
                <td id="total-mktg-tendance" class="plan-td-footer">-</td>
                <!-- Estimations: Objectif, R√©el, Cumul Obj., Cumul, Tendance, Ratio -->
                <td id="total-estim-prev" class="plan-td-footer">0</td>
                <td id="total-estim-reel" class="plan-td-footer plan-td-highlight">0</td>
                <td id="total-estim-cumul-obj" class="plan-td-footer">-</td>
                <td id="total-estim-cumul" class="plan-td-footer">-</td>
                <td id="total-estim-tendance" class="plan-td-footer">-</td>
                <td id="total-ratio" class="plan-td-footer">0.00</td>
                <!-- Contrats: Objectif, R√©el, Cumul Obj., Cumul, Tendance -->
                <td id="total-contrat-prev" class="plan-td-footer">0</td>
                <td id="total-contrat-reel" class="plan-td-footer plan-td-highlight">0</td>
                <td id="total-contrat-cumul-obj" class="plan-td-footer">-</td>
                <td id="total-contrat-cumul" class="plan-td-footer">-</td>
                <td id="total-contrat-tendance" class="plan-td-footer">-</td>
                <!-- $ Sign√©s: Objectif, R√©el, Cumul Obj., Cumul, Tendance -->
                <td id="total-dollar-prev" class="plan-td-footer">0 $</td>
                <td id="total-dollar-reel" class="plan-td-footer plan-td-highlight">0 $</td>
                <td id="total-dollar-cumul-obj" class="plan-td-footer">-</td>
                <td id="total-dollar-cumul" class="plan-td-footer">-</td>
                <td id="total-dollar-tendance" class="plan-td-footer">-</td>
                <!-- % Objectif: Sem., Cumul, TV % -->
                <td id="total-pct-sem" class="plan-td-footer">0.0%</td>
                <td id="total-pct-cumul" class="plan-td-footer plan-td-highlight">0.00%</td>
                <td id="total-tv" class="plan-td-footer">-</td>
                <!-- Production: Objectif, R√©el, Cumul Obj., Cumul, Tendance, % -->
                <td id="total-prod-vise" class="plan-td-footer">0 $</td>
                <td id="total-prod-reel" class="plan-td-footer plan-td-highlight">0 $</td>
                <td id="total-prod-cumul-obj" class="plan-td-footer">-</td>
                <td id="total-prod-cumul" class="plan-td-footer">-</td>
                <td id="total-prod-tendance" class="plan-td-footer">-</td>
                <td id="total-prod-pct" class="plan-td-footer">0%</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Container mobile avec cartes (cach√© sur desktop) -->
        <div id="plan-mobile-container" style="display: none;">
          <!-- G√©n√©r√© par JavaScript -->
        </div>
      </div>
    </div>

  </div>

  <!-- Page √âtat des r√©sultats -->
  <div id="etat-resultats" class="page-content hidden hide-ecart">
    <div class="glass-card shadow mb-8">
      <div class="flex items-center justify-between px-6" style="background: var(--bg-card); border-bottom: 1px solid rgba(51, 65, 85, 0.5); border-radius: 1rem 1rem 0 0; min-height: 80px;">
        <div class="flex items-center gap-3">
          <div style="width: 48px; height: 48px; border-radius: 12px; background: #3b82f6; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-chart-line" style="font-size: 1.5rem; color: white;"></i>
          </div>
          <h3 class="text-2xl font-bold" style="color: var(--text-light);">
            √âtats des r√©sultats
          </h3>
        </div>
        <div class="flex items-center gap-2">
          <button id="toggleEcartBtn" onclick="toggleEcartColumn()" class="rounded flex items-center gap-2 justify-center transition-all hover:scale-105 px-3 py-1.5" style="background: rgba(234, 179, 8, 0.2); color: #eab308;" title="Afficher/Masquer √âcart">
            <i class="fas fa-eye-slash text-xs"></i>
            <span class="text-xs font-semibold">√âcart</span>
          </button>
          <button id="editEtatsResultatsBtn" onclick="toggleEditEtatsResultats()" class="rounded flex items-center gap-2 justify-center transition-all hover:scale-105 px-3 py-1.5" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);" title="Modifier">
            <i class="fas fa-pencil-alt text-xs"></i>
            <span class="text-xs font-semibold">Modifier</span>
          </button>
          <button id="saveEtatsResultatsBtn" onclick="saveEtatsResultatsEdits()" class="hidden rounded flex items-center gap-2 justify-center transition-all hover:scale-105 px-3 py-1.5" style="background: rgba(52, 211, 153, 0.2); color: var(--primary-green);" title="Enregistrer">
            <i class="fas fa-save text-xs"></i>
            <span class="text-xs font-semibold">Enregistrer</span>
          </button>
          <button id="cancelEtatsResultatsBtn" onclick="cancelEtatsResultatsEdits()" class="hidden rounded flex items-center gap-2 justify-center transition-all hover:scale-105 px-3 py-1.5" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;" title="Annuler">
            <i class="fas fa-times text-xs"></i>
            <span class="text-xs font-semibold">Annuler</span>
          </button>
        </div>
      </div>

      <div class="p-8">

        <div class="overflow-x-auto">
          <table class="w-full" style="border-collapse: separate; border-spacing: 0; border: 2px solid var(--border-dark); border-radius: 0.90rem; overflow: hidden;">
            <thead>
              <!-- Premi√®re ligne: headers principaux -->
              <tr>
                <th rowspan="2" style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-light); border-bottom: 2px solid var(--border-dark); border-top-left-radius: 0.90rem;">
                  <span id="etat-username-header">Compte</span>
                </th>
                <th colspan="2" style="padding: 1rem; text-align: center; font-weight: 700; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(15, 23, 42, 0.5);">
                  <i class="fas fa-bullseye text-blue-400"></i>
                  CIBL√â
                </th>
                <th colspan="2" class="ecart-column" style="padding: 1rem; text-align: center; font-weight: 700; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(15, 23, 42, 0.35);">
                  <i class="fas fa-exchange-alt text-yellow-400"></i>
                  √âCART
                </th>
                <th colspan="2" style="padding: 1rem; text-align: center; font-weight: 700; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); border-top-right-radius: 0.90rem;">
                  <i class="fas fa-chart-bar text-purple-400"></i>
                  R√âEL
                </th>
              </tr>
              <!-- Deuxi√®me ligne: sous-headers -->
              <tr>
                <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: var(--text-light); font-size: 0.875rem; border-bottom: 2px solid var(--border-dark); border-left: 2px solid var(--border-dark); width: 200px; background: rgba(15, 23, 42, 0.5);">
                  Budget
                </th>
                <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: var(--text-light); font-size: 0.875rem; border-bottom: 2px solid var(--border-dark); width: 120px; background: rgba(15, 23, 42, 0.5);">
                  %
                </th>
                <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: var(--text-light); font-size: 0.875rem; border-bottom: 2px solid var(--border-dark); border-left: 2px solid var(--border-dark); width: 150px; background: rgba(15, 23, 42, 0.35);">
                  Montant
                </th>
                <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: var(--text-light); font-size: 0.875rem; border-bottom: 2px solid var(--border-dark); width: 80px; background: rgba(15, 23, 42, 0.35);">
                  %
                </th>
                <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: var(--text-light); font-size: 0.875rem; border-bottom: 2px solid var(--border-dark); border-left: 2px solid var(--border-dark); width: 200px;">
                  Actuel
                </th>
                <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: var(--text-light); font-size: 0.875rem; border-bottom: 2px solid var(--border-dark); width: 120px;">
                  %
                </th>
              </tr>
            </thead>
            <tbody>
              <!-- REVENUS D'ENTREPRISE -->
              <tr style="background: rgba(34, 197, 94, 0.1);">
                <td colspan="7" style="padding: 0.75rem 1rem; font-weight: 700; color: var(--text-light); font-size: 0.95rem; border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-dollar-sign text-green-500"></i>
                  REVENUS D'ENTREPRISE
                </td>
              </tr>
              <tr>
                <td style="padding: 0.75rem 1rem; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: var(--bg-secondary);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  Ventes
                </td>
                <td data-field="budget-montant" data-category="ventes" style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">
                  0,00 $
                </td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">
                  100%
                </td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(15, 23, 42, 0.35);">

                </td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.35);">

                </td>
                <td data-field="actuel-montant" data-category="ventes" style="padding: 0.75rem 1rem !important; text-align: left !important; color: var(--text-light) !important; border-left: 2px solid var(--border-dark) !important; border-bottom: 1px solid var(--border-dark) !important; background: var(--bg-secondary);">
                  0,00 $
                </td>
                <td data-field="actuel-percent" data-category="ventes" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: var(--bg-secondary);">
                  100%
                </td>
              </tr>

              <!-- D√âPENSES -->
              <tr style="background: rgba(239, 68, 68, 0.1);">
                <td colspan="7" style="padding: 0.75rem 1rem; font-weight: 700; color: var(--text-light); font-size: 0.95rem; border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-minus-circle text-red-500"></i>
                  D√âPENSES
                </td>
              </tr>

              <!-- Assurance QE -->
              <tr style="background: var(--bg-card);">
                <td style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  <span style="color: #f87171;">Assurance QE</span>
                </td>
                <td data-field="cible-montant" data-category="assurance-qe" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem; background: rgba(15, 23, 42, 0.6);"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="2,250$"></td>
                <td data-field="cible-percent" data-category="assurance-qe" style="padding: 0.75rem 1rem; text-align: right; color: #ef4444; border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">1.50%</td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0$</td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: #ef4444; border-bottom: 1px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0.00%</td>
                <td data-field="actuel-montant" data-category="assurance-qe" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem;"><input type="text" readonly class="etats-resultats-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="actuel-percent" data-category="assurance-qe" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">0%</td>
              </tr>

              <!-- Concours -->
              <tr style="background: var(--bg-secondary);">
                <td style="padding: 0.75rem 1rem; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  Concours
                </td>
                <td data-field="cible-montant" data-category="concours" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem; background: rgba(15, 23, 42, 0.6);"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="cible-percent" data-category="concours" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">0%</td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0$</td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0.00%</td>
                <td data-field="actuel-montant" data-category="concours" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem;"><input type="text" readonly class="etats-resultats-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="actuel-percent" data-category="concours" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">0%</td>
              </tr>

              <!-- Essence -->
              <tr style="background: var(--bg-card);">
                <td style="padding: 0.75rem 1rem; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  Essence
                </td>
                <td data-field="cible-montant" data-category="essence" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem; background: rgba(15, 23, 42, 0.6);"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="2,500$"></td>
                <td data-field="cible-percent" data-category="essence" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">1.67%</td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0$</td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0.00%</td>
                <td data-field="actuel-montant" data-category="essence" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem;"><input type="text" readonly class="etats-resultats-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="actuel-percent" data-category="essence" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">0%</td>
              </tr>

              <!-- Entretien voiture -->
              <tr style="background: var(--bg-secondary);">
                <td style="padding: 0.75rem 1rem; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  Entretien voiture
                </td>
                <td data-field="cible-montant" data-category="entretien-voiture" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem; background: rgba(15, 23, 42, 0.6);"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="750$"></td>
                <td data-field="cible-percent" data-category="entretien-voiture" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">0.50%</td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0$</td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0.00%</td>
                <td data-field="actuel-montant" data-category="entretien-voiture" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem;"><input type="text" readonly class="etats-resultats-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="actuel-percent" data-category="entretien-voiture" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">0%</td>
              </tr>

              <!-- Fourniture bureau -->
              <tr style="background: var(--bg-card);">
                <td style="padding: 0.75rem 1rem; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  Fourniture bureau
                </td>
                <td data-field="cible-montant" data-category="fourniture-bureau" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem; background: rgba(15, 23, 42, 0.6);"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="150$"></td>
                <td data-field="cible-percent" data-category="fourniture-bureau" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">0.10%</td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0$</td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0.00%</td>
                <td data-field="actuel-montant" data-category="fourniture-bureau" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem;"><input type="text" readonly class="etats-resultats-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="actuel-percent" data-category="fourniture-bureau" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">0%</td>
              </tr>

              <!-- Frais bancaires -->
              <tr style="background: var(--bg-secondary);">
                <td style="padding: 0.75rem 1rem; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  Frais bancaires
                </td>
                <td data-field="cible-montant" data-category="frais-bancaires" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem; background: rgba(15, 23, 42, 0.6);"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="150$"></td>
                <td data-field="cible-percent" data-category="frais-bancaires" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">0.10%</td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0$</td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0.00%</td>
                <td data-field="actuel-montant" data-category="frais-bancaires" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem;"><input type="text" readonly class="etats-resultats-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="actuel-percent" data-category="frais-bancaires" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">0%</td>
              </tr>

              <!-- Frais cellulaire -->
              <tr style="background: var(--bg-card);">
                <td style="padding: 0.75rem 1rem; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  Frais cellulaire
                </td>
                <td data-field="cible-montant" data-category="frais-cellulaire" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem; background: rgba(15, 23, 42, 0.6);"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="250$"></td>
                <td data-field="cible-percent" data-category="frais-cellulaire" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">0.17%</td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0$</td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0.00%</td>
                <td data-field="actuel-montant" data-category="frais-cellulaire" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem;"><input type="text" readonly class="etats-resultats-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="actuel-percent" data-category="frais-cellulaire" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">0%</td>
              </tr>

              <!-- Frais de garanties -->
              <tr style="background: var(--bg-secondary);">
                <td style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  <span style="color: #f87171;">Frais de garanties</span>
                </td>
                <td data-field="cible-montant" data-category="frais-garanties" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem; background: rgba(15, 23, 42, 0.6);"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="4,500$"></td>
                <td data-field="cible-percent" data-category="frais-garanties" style="padding: 0.75rem 1rem; text-align: right; color: #ef4444; border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">3.00%</td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0$</td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: #ef4444; border-bottom: 1px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0.00%</td>
                <td data-field="actuel-montant" data-category="frais-garanties" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem;"><input type="text" readonly class="etats-resultats-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="actuel-percent" data-category="frais-garanties" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">0%</td>
              </tr>

              <!-- Leads -->
              <tr style="background: var(--bg-card);">
                <td style="padding: 0.75rem 1rem; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  Leads
                </td>
                <td data-field="cible-montant" data-category="leads" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem; background: rgba(15, 23, 42, 0.6);"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="200$"></td>
                <td data-field="cible-percent" data-category="leads" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">0.13%</td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0$</td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0.00%</td>
                <td data-field="actuel-montant" data-category="leads" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem;"><input type="text" readonly class="etats-resultats-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="actuel-percent" data-category="leads" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">0%</td>
              </tr>

              <!-- Peinture -->
              <tr style="background: var(--bg-secondary);">
                <td style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  <span style="color: #f87171;">Peinture</span>
                </td>
                <td data-field="cible-montant" data-category="peinture" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem; background: rgba(15, 23, 42, 0.6);"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="13,500$"></td>
                <td data-field="cible-percent" data-category="peinture" style="padding: 0.75rem 1rem; text-align: right; color: #ef4444; border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">9.00%</td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0$</td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: #ef4444; border-bottom: 1px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0.00%</td>
                <td data-field="actuel-montant" data-category="peinture" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem;"><input type="text" readonly class="etats-resultats-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="actuel-percent" data-category="peinture" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">0%</td>
              </tr>

              <!-- Petits outils -->
              <tr style="background: var(--bg-card);">
                <td style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  <span style="color: #f87171;">Petits outils</span>
                </td>
                <td data-field="cible-montant" data-category="petits-outils" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem; background: rgba(15, 23, 42, 0.6);"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="6,000$"></td>
                <td data-field="cible-percent" data-category="petits-outils" style="padding: 0.75rem 1rem; text-align: right; color: #ef4444; border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">4.00%</td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0$</td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: #ef4444; border-bottom: 1px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0.00%</td>
                <td data-field="actuel-montant" data-category="petits-outils" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem;"><input type="text" readonly class="etats-resultats-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="actuel-percent" data-category="petits-outils" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">0%</td>
              </tr>

              <!-- Repas -->
              <tr style="background: var(--bg-secondary);">
                <td style="padding: 0.75rem 1rem; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  Repas
                </td>
                <td data-field="cible-montant" data-category="repas" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem; background: rgba(15, 23, 42, 0.6);"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="500$"></td>
                <td data-field="cible-percent" data-category="repas" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">0.33%</td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0$</td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0.00%</td>
                <td data-field="actuel-montant" data-category="repas" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem;"><input type="text" readonly class="etats-resultats-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="actuel-percent" data-category="repas" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">0%</td>
              </tr>

              <!-- Redevances -->
              <tr style="background: var(--bg-card);">
                <td style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  <span style="color: #f87171;">Redevances</span>
                </td>
                <td data-field="cible-montant" data-category="redevances" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem; background: rgba(15, 23, 42, 0.6);"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="30,000$"></td>
                <td data-field="cible-percent" data-category="redevances" style="padding: 0.75rem 1rem; text-align: right; color: #ef4444; border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">20.00%</td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0$</td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: #ef4444; border-bottom: 1px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0.00%</td>
                <td data-field="actuel-montant" data-category="redevances" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem;"><input type="text" readonly class="etats-resultats-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="actuel-percent" data-category="redevances" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">0%</td>
              </tr>

              <!-- Salaire des peintres -->
              <tr style="background: var(--bg-secondary);">
                <td style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  <span style="color: #f87171;">Salaire des peintres</span>
                </td>
                <td data-field="cible-montant" data-category="salaire-peintres" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem; background: rgba(15, 23, 42, 0.6);"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="45,000$"></td>
                <td data-field="cible-percent" data-category="salaire-peintres" style="padding: 0.75rem 1rem; text-align: right; color: #ef4444; border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">30.00%</td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0$</td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: #ef4444; border-bottom: 1px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0.00%</td>
                <td data-field="actuel-montant" data-category="salaire-peintres" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem;"><input type="text" readonly class="etats-resultats-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="actuel-percent" data-category="salaire-peintres" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">0%</td>
              </tr>

              <!-- Salaires repr√©sentant -->
              <tr style="background: var(--bg-card);">
                <td style="padding: 0.75rem 1rem; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-arrow-right" style="color: rgba(148, 163, 184, 0.4); font-size: 0.75rem;"></i>
                  Salaires repr√©sentant
                </td>
                <td data-field="cible-montant" data-category="salaires-representant" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem; background: rgba(15, 23, 42, 0.6);"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="2,000$"></td>
                <td data-field="cible-percent" data-category="salaires-representant" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.6);">1.33%</td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0$</td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark); background: rgba(34, 197, 94, 0.2);">0.00%</td>
                <td data-field="actuel-montant" data-category="salaires-representant" style="text-align: left; border-left: 2px solid var(--border-dark); border-bottom: 1px solid var(--border-dark); padding-left: 1rem;"><input type="text" readonly class="etats-resultats-input bg-transparent border-none w-full" style="color: var(--text-light); outline: none; text-align: left;" value="0$"></td>
                <td data-field="actuel-percent" data-category="salaires-representant" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-bottom: 1px solid var(--border-dark);">0%</td>
              </tr>

              <!-- Total des d√©penses -->
              <tr style="background: rgba(239, 68, 68, 0.15);">
                <td style="padding: 0.75rem 1rem; color: var(--text-light); border-top: 2px solid var(--border-dark); border-bottom: 2px solid var(--border-dark);">
                  <i class="fas fa-calculator text-red-400"></i>
                  Total des d√©penses
                </td>
                <td data-field="cible-montant" data-category="total-depenses" style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-top: 2px solid var(--border-dark); border-bottom: 2px solid var(--border-dark);">
                  107,750$
                </td>
                <td data-field="cible-percent" data-category="total-depenses" style="padding: 0.75rem 1rem; text-align: right; color: #ef4444; border-top: 2px solid var(--border-dark); border-bottom: 2px solid var(--border-dark);">
                  71.83%
                </td>
                <td style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-top: 2px solid var(--border-dark); border-bottom: 2px solid var(--border-dark);">

                </td>
                <td style="padding: 0.75rem 1rem; text-align: right; color: var(--text-light); border-top: 2px solid var(--border-dark); border-bottom: 2px solid var(--border-dark);">

                </td>
                <td data-field="actuel-montant" data-category="total-depenses" style="padding: 0.75rem 1rem !important; text-align: left !important; color: var(--text-light) !important; border-top: 2px solid var(--border-dark) !important; border-bottom: 2px solid var(--border-dark) !important;">
                  0$
                </td>
                <td data-field="actuel-percent" data-category="total-depenses" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-gray); border-top: 2px solid var(--border-dark); border-bottom: 2px solid var(--border-dark);">
                  0%
                </td>
              </tr>

              <!-- TOTAL √âCART -->
              <tr id="total-ecart-row" style="background: rgba(148, 163, 184, 0.1); font-weight: 600;">
                <td style="padding: 0.75rem 1rem; color: var(--text-light); border-bottom: 1px solid var(--border-dark);">
                  <i class="fas fa-balance-scale" style="color: #94a3b8;"></i>
                  TOTAL √âCART
                </td>
                <td style="padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border-dark);">

                </td>
                <td style="padding: 0.75rem 1rem; text-align: right; border-bottom: 1px solid var(--border-dark);">

                </td>
                <td data-field="ecart-montant" data-category="total-ecart" style="padding: 0.75rem 1rem; text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-left: 2px solid var(--border-dark); font-weight: 700;">
                  0,00 $
                </td>
                <td data-field="ecart-percent" data-category="total-ecart" style="padding: 0.75rem 1rem; text-align: right; color: var(--text-light); border-bottom: 1px solid var(--border-dark); border-right: 2px solid var(--border-dark); font-weight: 700;">
                  0,00%
                </td>
                <td style="padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border-dark);">

                </td>
                <td style="padding: 0.75rem 1rem; text-align: right; border-bottom: 1px solid var(--border-dark);">

                </td>
              </tr>

              <!-- PROFIT -->
              <tr style="background: rgba(34, 197, 94, 0.15);">
                <td style="padding: 1rem; color: var(--text-light); font-size: 1.05rem; border-bottom-left-radius: 0.90rem;">
                  <i class="fas fa-trophy" style="color: #22c55e;"></i>
                  PROFIT
                </td>
                <td data-field="cible-montant" data-category="profit" style="padding: 1rem; text-align: left; color: #22c55e; font-size: 1.05rem;">
                  42,250$
                </td>
                <td data-field="cible-percent" data-category="profit" style="padding: 1rem; text-align: right; color: #22c55e; font-size: 1.05rem;">
                  28.17%
                </td>
                <td style="padding: 1rem; text-align: left; color: var(--text-light); font-size: 1.05rem;">

                </td>
                <td style="padding: 1rem; text-align: right; color: var(--text-light); font-size: 1.05rem;">

                </td>
                <td data-field="actuel-montant" data-category="profit" style="padding: 1rem !important; text-align: left !important; color: var(--text-gray);">
                  0$
                </td>
                <td data-field="actuel-percent" data-category="profit" style="padding: 1rem; text-align: right; color: var(--text-gray); border-bottom-right-radius: 0.90rem;">
                  0%
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Container mobile avec cartes (cach√© sur desktop) -->
        <div id="etats-mobile-container" style="display: none;">
          <!-- G√©n√©r√© par JavaScript -->
        </div>
      </div>
    </div>
  </div>

  </div>
  <!-- Ferme mx-auto space-y-12 -->

</div>
<!-- Ferme main-content -->

<!-- Box En d√©veloppement -->
<div class="main-content ml-[15%] mr-[15%] w-100 pt-6 hidden" style="margin-top: 40px;">
  <div class="flex items-center justify-center min-h-[60vh]">
    <div class="text-center p-12 rounded-2xl" style="background: var(--bg-card); border: 2px solid var(--border-dark); box-shadow: var(--shadow-dark-strong); max-width: 500px;">
      <div class="mb-6">
        <i class="fas fa-tools text-6xl" style="color: var(--primary-blue);"></i>
      </div>
      <h2 class="text-3xl font-bold mb-4" style="color: var(--text-light);">
        En d√©veloppement
      </h2>
      <p class="text-lg" style="color: var(--text-gray);">
        Cette section est actuellement en cours de d√©veloppement.
      </p>
    </div>
  </div>
</div>

  </div> <!-- Fin du main-content-wrapper -->

<!-- Popup Mon WHY -->
<div id="whyPopup" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(8px);
  z-index: 10000;
  align-items: center;
  justify-content: center;
">
  <div style="
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.98), rgba(51, 65, 85, 0.95));
    border: 1px solid rgba(96, 165, 250, 0.3);
    border-radius: 1.5rem;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    animation: slideIn 0.3s ease-out;
  ">
    <!-- Header -->
    <div style="
      padding: 1.5rem 2rem;
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(168, 85, 247, 0.1);
    ">
      <div style="display: flex; align-items: center; gap: 1rem;">
        <div style="
          width: 48px;
          height: 48px;
          border-radius: 12px;
          background: linear-gradient(135deg, #a855f7, #9333ea);
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <i class="fas fa-lightbulb" style="font-size: 1.5rem; color: white;"></i>
        </div>
        <div>
          <h3 style="
            color: var(--text-light);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
          ">Mon WHY</h3>
          <p style="
            color: var(--text-gray);
            font-size: 0.875rem;
            margin: 0;
            margin-top: 0.25rem;
          ">Pourquoi je fais ce que je fais ?</p>
        </div>
      </div>
      <button onclick="closeWhyPopup()" style="
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: rgba(248, 113, 113, 0.1);
        border: 1px solid rgba(248, 113, 113, 0.3);
        color: #f87171;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      " onmouseover="this.style.background='rgba(248, 113, 113, 0.2)'" onmouseout="this.style.background='rgba(248, 113, 113, 0.1)'">
        <i class="fas fa-times" style="font-size: 1.25rem;"></i>
      </button>
    </div>

    <!-- Content -->
    <div style="padding: 2rem; overflow-y: auto; max-height: calc(80vh - 180px);">
      <div style="margin-bottom: 1.5rem;">
        <label style="
          display: block;
          color: var(--text-light);
          font-weight: 600;
          margin-bottom: 0.75rem;
          font-size: 0.95rem;
        ">
          <i class="fas fa-heart" style="color: #a855f7; margin-right: 0.5rem;"></i>
          Ma motivation profonde
        </label>
        <textarea id="whyTextarea" placeholder="Ex: Je veux cr√©er une entreprise prosp√®re pour offrir une meilleure qualit√© de vie √† ma famille..." style="
          width: 100%;
          height: 350px;
          padding: 1rem;
          background: rgba(15, 23, 42, 0.8);
          border: 2px solid rgba(96, 165, 250, 0.2);
          border-radius: 12px;
          color: var(--text-light);
          font-size: 0.95rem;
          line-height: 1.6;
          resize: none;
          outline: none;
          transition: all 0.3s ease;
          font-family: inherit;
        " onfocus="this.style.borderColor='rgba(168, 85, 247, 0.5)'" onblur="this.style.borderColor='rgba(96, 165, 250, 0.2)'"></textarea>
        <p style="
          color: var(--text-gray);
          font-size: 0.8rem;
          margin-top: 0.5rem;
          font-style: italic;
        ">
          <i class="fas fa-info-circle" style="color: #a855f7;"></i>
          √âcrivez librement ce qui vous motive vraiment dans votre parcours entrepreneurial.
        </p>
      </div>
    </div>

    <!-- Footer -->
    <div style="
      padding: 1.5rem 2rem;
      border-top: 1px solid rgba(51, 65, 85, 0.5);
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      background: rgba(30, 41, 59, 0.5);
    ">
      <button onclick="closeWhyPopup()" style="
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        background: rgba(100, 116, 139, 0.15);
        border: 1px solid rgba(100, 116, 139, 0.3);
        color: var(--text-gray);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95rem;
      " onmouseover="this.style.background='rgba(100, 116, 139, 0.25)'" onmouseout="this.style.background='rgba(100, 116, 139, 0.15)'">
        <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
        Annuler
      </button>
      <button id="saveWhyBtn" onclick="saveWhy()" style="
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        background: linear-gradient(135deg, #a855f7, #9333ea);
        border: none;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95rem;
        box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
      " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(168, 85, 247, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(168, 85, 247, 0.3)'">
        <i class="fas fa-save" style="margin-right: 0.5rem;"></i>
        Enregistrer
      </button>
    </div>
  </div>
</div>

<!-- Popup Analyse Hebdomadaire (Probl√®me / Focus) -->
<div id="weeklyAnalysisPopup" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(8px);
  z-index: 10000;
  align-items: center;
  justify-content: center;
">
  <div style="
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.98), rgba(51, 65, 85, 0.95));
    border: 1px solid rgba(96, 165, 250, 0.3);
    border-radius: 1.5rem;
    width: 90%;
    max-width: 650px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    animation: slideIn 0.3s ease-out;
  ">
    <!-- Header -->
    <div id="weeklyAnalysisHeader" style="
      padding: 1.5rem 2rem;
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(96, 165, 250, 0.1);
    ">
      <div style="display: flex; align-items: center; gap: 1rem;">
        <div id="weeklyAnalysisIcon" style="
          width: 48px;
          height: 48px;
          border-radius: 12px;
          background: linear-gradient(135deg, #ef4444, #dc2626);
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; color: white;"></i>
        </div>
        <div>
          <h3 id="weeklyAnalysisTitle" style="
            color: var(--text-light);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
          ">Analyse de la semaine pass√©e</h3>
          <p id="weeklyAnalysisSubtitle" style="
            color: var(--text-gray);
            font-size: 0.875rem;
            margin: 0;
            margin-top: 0.25rem;
          ">Semaine 1 - 5 janv. - 11 janv.</p>
        </div>
      </div>
      <button onclick="closeWeeklyAnalysisPopup()" style="
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: rgba(248, 113, 113, 0.1);
        border: 1px solid rgba(248, 113, 113, 0.3);
        color: #f87171;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      " onmouseover="this.style.background='rgba(248, 113, 113, 0.2)'" onmouseout="this.style.background='rgba(248, 113, 113, 0.1)'">
        <i class="fas fa-times" style="font-size: 1.25rem;"></i>
      </button>
    </div>

    <!-- Content -->
    <div style="padding: 2rem; overflow-y: auto; max-height: calc(80vh - 180px);">
      <div style="margin-bottom: 1.5rem;">
        <label id="weeklyAnalysisLabel" style="
          display: block;
          color: var(--text-light);
          font-weight: 600;
          margin-bottom: 0.75rem;
          font-size: 0.95rem;
        ">
          <i class="fas fa-pen" style="color: #ef4444; margin-right: 0.5rem;"></i>
          D√©cris le probl√®me rencontr√© cette semaine
        </label>
        <textarea id="weeklyAnalysisTextarea" placeholder="D√©cris ici le probl√®me ou d√©fi principal que tu as rencontr√© cette semaine..." style="
          width: 100%;
          height: 300px;
          padding: 1rem;
          background: rgba(15, 23, 42, 0.8);
          border: 2px solid rgba(96, 165, 250, 0.2);
          border-radius: 12px;
          color: var(--text-light);
          font-size: 0.95rem;
          line-height: 1.6;
          resize: none;
          outline: none;
          transition: all 0.3s ease;
          font-family: inherit;
        " onfocus="this.style.borderColor='rgba(239, 68, 68, 0.5)'" onblur="this.style.borderColor='rgba(96, 165, 250, 0.2)'"></textarea>
        <p id="weeklyAnalysisHelp" style="
          color: var(--text-gray);
          font-size: 0.8rem;
          margin-top: 0.5rem;
          font-style: italic;
        ">
          <i class="fas fa-info-circle" style="color: #ef4444;"></i>
          Identifie le probl√®me principal pour mieux planifier la semaine suivante.
        </p>
      </div>
    </div>

    <!-- Footer -->
    <div style="
      padding: 1.5rem 2rem;
      border-top: 1px solid rgba(51, 65, 85, 0.5);
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      background: rgba(30, 41, 59, 0.5);
    ">
      <button onclick="closeWeeklyAnalysisPopup()" class="btn-secondary">
        <i class="fas fa-times"></i>
        Annuler
      </button>
      <button id="saveWeeklyAnalysisBtn" onclick="saveWeeklyAnalysis()" class="btn-primary">
        <i class="fas fa-save"></i>
        Enregistrer
      </button>
    </div>
  </div>
</div>

<!-- Popup Lecture Seule (Voir le texte complet) -->
<div id="weeklyAnalysisViewPopup" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(8px);
  z-index: 10000;
  align-items: center;
  justify-content: center;
">
  <div style="
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.98), rgba(51, 65, 85, 0.95));
    border: 1px solid rgba(96, 165, 250, 0.3);
    border-radius: 1.5rem;
    width: 90%;
    max-width: 650px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    animation: slideIn 0.3s ease-out;
  ">
    <!-- Header -->
    <div id="weeklyAnalysisViewHeader" style="
      padding: 1.5rem 2rem;
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(96, 165, 250, 0.1);
    ">
      <div style="display: flex; align-items: center; gap: 1rem;">
        <div id="weeklyAnalysisViewIcon" style="
          width: 48px;
          height: 48px;
          border-radius: 12px;
          background: linear-gradient(135deg, #3b82f6, #2563eb);
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <i class="fas fa-eye" style="font-size: 1.5rem; color: white;"></i>
        </div>
        <div>
          <h3 id="weeklyAnalysisViewTitle" style="
            color: var(--text-light);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
          ">Analyse de la semaine</h3>
          <p id="weeklyAnalysisViewSubtitle" style="
            color: var(--text-gray);
            font-size: 0.875rem;
            margin: 0;
            margin-top: 0.25rem;
          ">Semaine 1 - 5 janv. - 11 janv.</p>
        </div>
      </div>
      <button onclick="closeWeeklyAnalysisViewPopup()" style="
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: rgba(248, 113, 113, 0.1);
        border: 1px solid rgba(248, 113, 113, 0.3);
        color: #f87171;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      " onmouseover="this.style.background='rgba(248, 113, 113, 0.2)'" onmouseout="this.style.background='rgba(248, 113, 113, 0.1)'">
        <i class="fas fa-times" style="font-size: 1.25rem;"></i>
      </button>
    </div>

    <!-- Content (read-only) -->
    <div style="padding: 2rem; overflow-y: auto; max-height: calc(80vh - 180px);">
      <div id="weeklyAnalysisViewContent" style="
        padding: 1.5rem;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(96, 165, 250, 0.2);
        border-radius: 12px;
        color: var(--text-light);
        font-size: 0.95rem;
        line-height: 1.8;
        white-space: pre-wrap;
        word-wrap: break-word;
        min-height: 100px;
      ">
        Texte de l'analyse...
      </div>
    </div>

    <!-- Footer -->
    <div style="
      padding: 1.5rem 2rem;
      border-top: 1px solid rgba(51, 65, 85, 0.5);
      display: flex;
      gap: 1rem;
      justify-content: center;
      background: rgba(30, 41, 59, 0.5);
    ">
      <button onclick="closeWeeklyAnalysisViewPopup()" style="
        padding: 0.75rem 2rem;
        border-radius: 10px;
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        border: none;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'">
        <i class="fas fa-check" style="margin-right: 0.5rem;"></i>
        Fermer
      </button>
    </div>
  </div>
</div>

<!-- Popup √âdition Ligne Compl√®te (Rating + Probleme + Focus) -->
<div id="weeklyRowEditPopup" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(8px);
  z-index: 10000;
  align-items: center;
  justify-content: center;
">
  <div style="
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.98), rgba(51, 65, 85, 0.95));
    border: 1px solid rgba(96, 165, 250, 0.3);
    border-radius: 1.5rem;
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    animation: slideIn 0.3s ease-out;
  ">
    <!-- Header -->
    <div style="
      padding: 1.5rem 2rem;
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(96, 165, 250, 0.1);
    ">
      <div style="display: flex; align-items: center; gap: 1rem;">
        <div style="
          width: 48px;
          height: 48px;
          border-radius: 12px;
          background: linear-gradient(135deg, #3b82f6, #2563eb);
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <i class="fas fa-edit" style="font-size: 1.5rem; color: white;"></i>
        </div>
        <div>
          <h3 style="
            color: var(--text-light);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
          ">R√©sum√© de la semaine</h3>
          <p id="weeklyRowEditSubtitle" style="
            color: var(--text-gray);
            font-size: 0.875rem;
            margin: 0;
            margin-top: 0.25rem;
          ">Semaine 1</p>
        </div>
      </div>
      <button onclick="closeWeeklyRowEditPopup()" style="
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: rgba(248, 113, 113, 0.1);
        border: 1px solid rgba(248, 113, 113, 0.3);
        color: #f87171;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      " onmouseover="this.style.background='rgba(248, 113, 113, 0.2)'" onmouseout="this.style.background='rgba(248, 113, 113, 0.1)'">
        <i class="fas fa-times" style="font-size: 1.25rem;"></i>
      </button>
    </div>

    <!-- Content -->
    <div style="padding: 1.5rem 2rem; overflow-y: auto; max-height: calc(90vh - 180px);">
      <!-- Rating (Comment vas-tu) -->
      <div style="margin-bottom: 1.5rem;">
        <label style="
          display: block;
          color: var(--text-light);
          font-weight: 600;
          margin-bottom: 0.75rem;
          font-size: 0.95rem;
        ">
          <i class="fas fa-smile" style="color: #fbbf24; margin-right: 0.5rem;"></i>
          Comment vas-tu cette semaine ?
        </label>
        <div id="weeklyRowEditStars" style="
          display: flex;
          gap: 0.75rem;
          padding: 1rem;
          background: rgba(15, 23, 42, 0.6);
          border: 1px solid rgba(96, 165, 250, 0.2);
          border-radius: 12px;
          justify-content: center;
        ">
          <i class="fas fa-star popup-star-rating" data-rating="1" style="font-size: 2rem; color: #374151; cursor: pointer; transition: all 0.2s;"></i>
          <i class="fas fa-star popup-star-rating" data-rating="2" style="font-size: 2rem; color: #374151; cursor: pointer; transition: all 0.2s;"></i>
          <i class="fas fa-star popup-star-rating" data-rating="3" style="font-size: 2rem; color: #374151; cursor: pointer; transition: all 0.2s;"></i>
          <i class="fas fa-star popup-star-rating" data-rating="4" style="font-size: 2rem; color: #374151; cursor: pointer; transition: all 0.2s;"></i>
          <i class="fas fa-star popup-star-rating" data-rating="5" style="font-size: 2rem; color: #374151; cursor: pointer; transition: all 0.2s;"></i>
        </div>
      </div>

      <!-- Probleme (Analyse de la semaine pass√©e) -->
      <div style="margin-bottom: 1.5rem;">
        <label style="
          display: block;
          color: var(--text-light);
          font-weight: 600;
          margin-bottom: 0.75rem;
          font-size: 0.95rem;
        ">
          <i class="fas fa-exclamation-triangle" style="color: #ef4444; margin-right: 0.5rem;"></i>
          Analyse de la semaine pass√©e
        </label>
        <textarea id="weeklyRowEditProbleme" placeholder="D√©cris ici le probl√®me ou d√©fi principal que tu as rencontr√© cette semaine..." style="
          width: 100%;
          height: 120px;
          padding: 1rem;
          background: rgba(15, 23, 42, 0.8);
          border: 2px solid rgba(239, 68, 68, 0.2);
          border-radius: 12px;
          color: var(--text-light);
          font-size: 0.95rem;
          line-height: 1.6;
          resize: none;
          outline: none;
          transition: all 0.3s ease;
          font-family: inherit;
          box-sizing: border-box;
        " onfocus="this.style.borderColor='rgba(239, 68, 68, 0.5)'" onblur="this.style.borderColor='rgba(239, 68, 68, 0.2)'"></textarea>
      </div>

      <!-- Focus (Focus de la semaine) -->
      <div style="margin-bottom: 1rem;">
        <label style="
          display: block;
          color: var(--text-light);
          font-weight: 600;
          margin-bottom: 0.75rem;
          font-size: 0.95rem;
        ">
          <i class="fas fa-bullseye" style="color: #10b981; margin-right: 0.5rem;"></i>
          Focus de la semaine
        </label>
        <textarea id="weeklyRowEditFocus" placeholder="Quel est ton objectif ou focus principal pour cette semaine ?..." style="
          width: 100%;
          height: 120px;
          padding: 1rem;
          background: rgba(15, 23, 42, 0.8);
          border: 2px solid rgba(16, 185, 129, 0.2);
          border-radius: 12px;
          color: var(--text-light);
          font-size: 0.95rem;
          line-height: 1.6;
          resize: none;
          outline: none;
          transition: all 0.3s ease;
          font-family: inherit;
          box-sizing: border-box;
        " onfocus="this.style.borderColor='rgba(16, 185, 129, 0.5)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.2)'"></textarea>
      </div>
    </div>

    <!-- Footer -->
    <div style="
      padding: 1.5rem 2rem;
      border-top: 1px solid rgba(51, 65, 85, 0.5);
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      background: rgba(30, 41, 59, 0.5);
    ">
      <button onclick="closeWeeklyRowEditPopup()" class="btn-secondary">
        <i class="fas fa-times"></i>
        Annuler
      </button>
      <button id="saveWeeklyRowEditBtn" onclick="saveWeeklyRowEdit()" style="
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        background: linear-gradient(135deg, #10b981, #059669);
        border: none;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
        <i class="fas fa-save"></i>
        Enregistrer
      </button>
    </div>
  </div>
</div>

<style>
@keyframes slideIn {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
  20%, 40%, 60%, 80% { transform: translateX(10px); }
}

@keyframes pulse-red {
  0%, 100% {
    box-shadow: 0 0 5px rgba(220, 38, 38, 0.5);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 0 20px rgba(220, 38, 38, 0.8);
    transform: scale(1.02);
  }
}

.shake-button {
  animation: shake 0.6s ease-in-out;
}
</style>

<!-- Initialiser window.username AVANT common.js pour √©viter la redirection -->
<script>
// ‚ö° ACTIVATION DES LOGS - Debug mode
window.log = console.log.bind(console);
window.warn = console.warn.bind(console);
window.error = console.error.bind(console);
window.info = console.info.bind(console);
window.debug = console.debug.bind(console);

(function() {
  const urlParams = new URLSearchParams(window.location.search);
  const userParam = urlParams.get('user');
  if (userParam) {
    window.username = userParam;
    log('[RPO INIT] window.username initialis√© depuis URL:', userParam);
  }
})();
</script>

<!-- Cache buster pour forcer le rechargement des fichiers JS -->
<script src="/common.js?v=20260114"></script>

<!-- Inline entrepreneur selector script removed - now handled by shared /entrepreneur-selector.js -->

<script>
// üîÑ FORCE CACHE RELOAD - Version check
(function() {
  const CURRENT_VERSION = '2026-01-14-v8'; // Incr√©menter cette version √† chaque d√©ploiement important
  const storageKey = 'rpo_page_version';
  const lastVersion = localStorage.getItem(storageKey);

  if (lastVersion !== CURRENT_VERSION) {
    console.log(`[CACHE] Nouvelle version d√©tect√©e: ${CURRENT_VERSION} (ancienne: ${lastVersion})`);
    console.log('[CACHE] Rechargement complet de la page...');

    // Mettre √† jour la version AVANT le reload pour √©viter la boucle
    localStorage.setItem(storageKey, CURRENT_VERSION);

    // Force un hard reload (ignore le cache)
    window.location.reload(true);

    // Alternative si reload(true) ne marche pas (certains navigateurs modernes)
    // window.location.href = window.location.href + '?nocache=' + Date.now();
  } else {
    console.log(`[CACHE] Version actuelle OK: ${CURRENT_VERSION}`);
  }
})();
</script>

<script>
// ‚ö° ACTIVATION DES LOGS - Debug mode
window.log = console.log.bind(console);
window.warn = console.warn.bind(console);
window.error = console.error.bind(console);
window.info = console.info.bind(console);
window.debug = console.debug.bind(console);

// ============================================
// TIMEZONE HELPERS - TORONTO (America/Toronto)
// ============================================

/**
 * Obtenir l'heure actuelle √† Toronto
 * @returns {Date} Date actuelle en timezone Toronto
 */
function getTorontoNow() {
  const now = new Date();
  // Convertir en string avec timezone Toronto, puis parser
  const torontoStr = now.toLocaleString('en-US', { timeZone: 'America/Toronto' });
  return new Date(torontoStr);
}

/**
 * Cr√©er une date en timezone Toronto
 * Cr√©e une date locale simple, √† midi pour √©viter les probl√®mes de DST
 * @param {number} year - Ann√©e
 * @param {number} month - Mois (0-11, comme dans Date)
 * @param {number} day - Jour du mois (1-31)
 * @param {number} hours - Heures (0-23), optionnel (par d√©faut 12)
 * @param {number} minutes - Minutes (0-59), optionnel
 * @param {number} seconds - Secondes (0-59), optionnel
 * @returns {Date} Date locale simple
 */
function createTorontoDate(year, month, day = 1, hours = 12, minutes = 0, seconds = 0) {
  // Cr√©er une date locale simple √† midi pour √©viter les probl√®mes de DST
  // Le backend g√®re le timezone Toronto c√¥t√© serveur
  return new Date(year, month, day, hours, minutes, seconds);
}

/**
 * Parser une date et la traiter comme √©tant en timezone Toronto
 * @param {string|Date} dateInput - Date √† parser
 * @returns {Date} Date pars√©e en timezone Toronto
 */
function parseTorontoDate(dateInput) {
  let date;

  if (dateInput instanceof Date) {
    return dateInput;
  }

  // Parser selon le format
  if (typeof dateInput === 'string') {
    if (dateInput.includes('T')) {
      // Format ISO
      date = new Date(dateInput);
    } else if (dateInput.includes('/')) {
      // Format JJ/MM/AAAA
      const [day, month, year] = dateInput.split('/').map(Number);
      return createTorontoDate(year, month - 1, day);
    } else if (dateInput.includes('-')) {
      // Format AAAA-MM-JJ
      const [year, month, day] = dateInput.split('-').map(Number);
      return createTorontoDate(year, month - 1, day);
    } else {
      date = new Date(dateInput);
    }
  }

  return date || getTorontoNow();
}

/**
 * Formatter une date selon le timezone Toronto
 * @param {Date} date - Date √† formatter
 * @param {string} format - Format de sortie ('iso', 'date', 'datetime', 'locale')
 * @returns {string} Date format√©e
 */
function formatTorontoDate(date, format = 'locale') {
  if (!(date instanceof Date) || isNaN(date)) {
    return '';
  }

  const options = {
    timeZone: 'America/Toronto'
  };

  switch (format) {
    case 'iso':
      // Format ISO avec timezone Toronto
      return date.toLocaleString('sv-SE', { ...options, hour12: false }).replace(' ', 'T');
    case 'date':
      // Format date seulement (AAAA-MM-JJ)
      return date.toLocaleDateString('fr-CA', options);
    case 'datetime':
      // Format date et heure
      return date.toLocaleString('fr-CA', { ...options, hour12: false });
    case 'locale':
    default:
      // Format localis√© fran√ßais Canada
      return date.toLocaleString('fr-CA', options);
  }
}

/**
 * Obtenir le lundi d'une semaine en timezone Toronto
 * @param {Date} date - N'importe quelle date dans la semaine
 * @returns {Date} Le lundi de cette semaine √† Toronto
 */
function getTorontoMonday(date) {
  const torontoDate = parseTorontoDate(date);
  const day = torontoDate.getDay();
  const diff = (day === 0 ? -6 : 1) - day; // Ajuster pour avoir le lundi
  const monday = new Date(torontoDate);
  monday.setDate(torontoDate.getDate() + diff);
  monday.setHours(12, 0, 0, 0); // Midi pour √©viter les probl√®mes de timezone
  return monday;
}

log('[OK] Timezone helpers Toronto charg√©s');
log('üìç Heure actuelle Toronto:', formatTorontoDate(getTorontoNow()));

// Script minimal pour g√©rer les onglets
function showPage(pageId) {
  // Masquer toutes les pages
  document.querySelectorAll('.page-content').forEach(page => {
    page.classList.add('hidden');
  });

  // Afficher la page s√©lectionn√©e
  const selectedPage = document.getElementById(pageId);
  if (selectedPage) {
    selectedPage.classList.remove('hidden');
  }

  // G√©rer les styles des boutons
  document.querySelectorAll('[id$="-tab"]').forEach(btn => {
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-secondary');
  });

  const selectedTab = document.getElementById(pageId + '-tab');
  if (selectedTab) {
    selectedTab.classList.remove('btn-secondary');
    selectedTab.classList.add('btn-primary');
  }

  // Si on affiche le plan d'affaires, afficher les logs
  if (pageId === 'plan-affaire') {
    console.log('üîÑ Chargement du plan d\'affaires...');
    setTimeout(() => {
      loadRPODataIntoPlan();
    }, 100);
  }
}

// Helper pour obtenir les informations du mois selon l'index
function getMonthInfo(monthIndex) {
  const monthsMap = {
    '0': { name: 'Janvier', abbr: 'jan', year: 2026, fullName: 'Janvier 2026' },
    '1': { name: 'F√©vrier', abbr: 'feb', year: 2026, fullName: 'F√©vrier 2026' },
    '2': { name: 'Mars', abbr: 'mar', year: 2026, fullName: 'Mars 2026' },
    '3': { name: 'Avril', abbr: 'apr', year: 2026, fullName: 'Avril 2026' },
    '4': { name: 'Mai', abbr: 'may', year: 2026, fullName: 'Mai 2026' },
    '5': { name: 'Juin', abbr: 'jun', year: 2026, fullName: 'Juin 2026' },
    '6': { name: 'Juillet', abbr: 'jul', year: 2026, fullName: 'Juillet 2026' },
    '7': { name: 'Ao√ªt', abbr: 'aug', year: 2026, fullName: 'Ao√ªt 2026' },
    '8': { name: 'Septembre', abbr: 'sep', year: 2026, fullName: 'Septembre 2026' },
    '9': { name: 'Octobre', abbr: 'oct', year: 2026, fullName: 'Octobre 2026' },
    '10': { name: 'Novembre', abbr: 'nov', year: 2026, fullName: 'Novembre 2026' },
    '11': { name: 'D√©cembre', abbr: 'dec', year: 2026, fullName: 'D√©cembre 2026' }
  };

  return monthsMap[String(monthIndex)] || monthsMap['0'];
}

// Mettre √† jour la date actuelle dans l'en-t√™te
function updateCurrentDateRPO() {
  const now = new Date();
  const isMobile = window.innerWidth <= 600;

  const dateElement = document.getElementById('currentDateRPO');
  if (!dateElement) return;

  if (isMobile) {
    // Mobile : afficher seulement le jour de la semaine
    const options = { weekday: 'long' };
    const dateString = now.toLocaleDateString('fr-FR', options);
    dateElement.textContent = dateString;
  } else {
    // PC : afficher la date compl√®te
    const options = {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    };
    const dateString = now.toLocaleDateString('fr-FR', options);
    dateElement.textContent = dateString;
  }
}

// Mettre √† jour la date lors du redimensionnement
window.addEventListener('resize', updateCurrentDateRPO);

// Afficher RPO par d√©faut
document.addEventListener('DOMContentLoaded', () => {
  showPage('rpo');

  // Mettre √† jour la date
  updateCurrentDateRPO();

  // Mettre √† jour l'en-t√™te "Compte" avec le nom complet de l'utilisateur
  const usernameHeader = document.getElementById('etat-username-header');
  if (usernameHeader) {
    const username = getCurrentUsername();

    // Charger les informations utilisateur depuis l'API
    fetch(`/api/get-info/${username}`)
      .then(response => {
        if (!response.ok) throw new Error('User info not found');
        return response.json();
      })
      .then(result => {
        // L'API retourne { success: true, data: { prenom, nom, ... } }
        const userInfo = result.data || {};

        // Afficher pr√©nom + nom (m√™me logique que dans classement)
        const prenom = userInfo.prenom || '';
        const nom = userInfo.nom || '';
        const fullName = `${prenom} ${nom}`.trim();
        usernameHeader.textContent = fullName || username;
        log('[ETAT] Nom complet charg√©:', fullName);
      })
      .catch(error => {
        warn('[ETAT] Impossible de charger user_info:', error);
        // Fallback: formater le username
        const formattedName = username
          .split(/[_\s]+/)
          .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
          .join(' ');
        usernameHeader.textContent = formattedName;
      });
  }
});

// Gestion de l'√©dition de l'objectif CA
function toggleEditObjectif() {
  const inputCA = document.getElementById('objectifCA');
  const editBtn = document.getElementById('editObjectifBtn');
  const saveBtn = document.getElementById('saveObjectifBtn');

  // Activer l'√©dition
  inputCA.removeAttribute('readonly');

  // Vider compl√®tement le champ (vraiment vide, pas de placeholder)
  inputCA.value = '';
  inputCA.placeholder = 'Entrez le montant...';

  inputCA.focus();

  // Changer les boutons
  editBtn.classList.add('hidden');
  saveBtn.classList.remove('hidden');
}

async function saveObjectif() {
  const inputCA = document.getElementById('objectifCA');
  const editBtn = document.getElementById('editObjectifBtn');
  const saveBtn = document.getElementById('saveObjectifBtn');

  // Enlever le placeholder
  inputCA.placeholder = '';

  // Formater la valeur avant de sauvegarder
  formatObjectifCA();

  // Synchroniser avec Objectif Vente dans le plan d'affaire
  const planObjectifInput = document.getElementById('plan-objectif');
  if (planObjectifInput) {
    const objectifValue = parseFloat(inputCA.dataset.value) || 0;
    planObjectifInput.dataset.value = objectifValue;
    planObjectifInput.value = objectifValue.toLocaleString('fr-CA', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }) + ' $';
  }

  // Synchroniser Tendance vis√© avec Objectif CA + 10%
  const tendanceViseInput = document.getElementById('tendance-vise');
  if (tendanceViseInput) {
    const objectifValue = parseFloat(inputCA.dataset.value) || 0;
    const tendanceValue = Math.round(objectifValue * 1.10); // Objectif CA + 10%
    tendanceViseInput.dataset.value = tendanceValue;
    tendanceViseInput.value = tendanceValue.toLocaleString('fr-CA').replace(/\s/g, ' ') + ' $';
    log('[OK] Tendance vis√© synchronis√© avec Objectif CA + 10%:', tendanceValue);
  }

  // D√©sactiver l'√©dition
  inputCA.setAttribute('readonly', true);

  // Changer les boutons
  saveBtn.classList.add('hidden');
  editBtn.classList.remove('hidden');

  // Recalculer le pourcentage de progression
  calculateObjectifCAProgress();

  // Synchroniser avec Ventes Budget dans √âtats des R√©sultats
  if (typeof syncObjectifCAWithVentesBudget === 'function') {
    syncObjectifCAWithVentesBudget();
  }

  // Sauvegarder les donn√©es annuelles
  await saveAnnualData();

  // R√©g√©n√©rer le plan d'affaire avec animation
  await reloadPlanWithAnimation();

  // V√©rifier et masquer/afficher l'alerte
  checkObjectifCAAlert();
}

// V√©rifier et afficher/masquer le message d'alerte Objectif CA
function checkObjectifCAAlert() {
  const inputCA = document.getElementById('objectifCA');
  const alert = document.getElementById('objectif-ca-alert');

  if (!inputCA || !alert) return;

  const objectifValue = parseFloat(inputCA.dataset.value) || 0;

  // Afficher l'alerte si objectif = 0, sinon la masquer
  if (objectifValue === 0 || isNaN(objectifValue)) {
    alert.style.display = 'block';
  } else {
    alert.style.display = 'none';
  }
}

// ============================================
// FONCTIONS MON WHY
// ============================================

// Ouvrir le popup WHY
async function openWhyPopup() {
  const popup = document.getElementById('whyPopup');
  const textarea = document.getElementById('whyTextarea');

  if (!popup || !textarea) {
    console.error('[WHY] √âl√©ments popup non trouv√©s');
    return;
  }

  // Charger le WHY existant depuis le backend
  const username = window.username || localStorage.getItem('username');

  try {
    const response = await fetch(`/api/rpo/why/${username}`);
    const data = await response.json();

    if (data.success && data.why) {
      textarea.value = data.why;
      console.log('[WHY] Charg√© depuis le backend:', data.why.substring(0, 50) + '...');
    } else {
      textarea.value = '';
    }
  } catch (error) {
    console.error('[WHY] Erreur chargement:', error);
    textarea.value = '';
  }

  // Bloquer le scroll de l'arri√®re-plan
  document.body.style.overflow = 'hidden';

  // Afficher le popup avec animation
  popup.style.display = 'flex';

  // Focus sur le textarea apr√®s l'animation
  setTimeout(() => {
    textarea.focus();
  }, 300);
}

// Fermer le popup WHY
function closeWhyPopup() {
  const popup = document.getElementById('whyPopup');
  if (!popup) return;

  popup.style.display = 'none';

  // R√©activer le scroll de l'arri√®re-plan
  document.body.style.overflow = '';
}

// Sauvegarder le WHY
async function saveWhy() {
  const textarea = document.getElementById('whyTextarea');
  const saveBtn = document.getElementById('saveWhyBtn');

  if (!textarea || !saveBtn) {
    console.error('[WHY] √âl√©ments non trouv√©s');
    return;
  }

  const whyText = textarea.value.trim();
  const username = window.username || localStorage.getItem('username');

  // D√©sactiver le bouton pendant la sauvegarde
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Enregistrement...';

  try {
    const response = await fetch(`/api/rpo/why/${username}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ why: whyText })
    });

    const data = await response.json();

    if (data.success) {
      console.log('[WHY] ‚úÖ Sauvegard√© avec succ√®s');

      // Afficher un feedback visuel
      saveBtn.innerHTML = '<i class="fas fa-check" style="margin-right: 0.5rem;"></i>Enregistr√© !';
      saveBtn.style.background = 'linear-gradient(135deg, #34d399, #10b981)';

      // Fermer le popup apr√®s un d√©lai
      setTimeout(() => {
        closeWhyPopup();

        // R√©initialiser le bouton
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save" style="margin-right: 0.5rem;"></i>Enregistrer';
        saveBtn.style.background = 'linear-gradient(135deg, #a855f7, #9333ea)';
      }, 1000);
    } else {
      throw new Error(data.error || 'Erreur de sauvegarde');
    }
  } catch (error) {
    console.error('[WHY] ‚ùå Erreur sauvegarde:', error);

    // Afficher l'erreur
    saveBtn.innerHTML = '<i class="fas fa-times" style="margin-right: 0.5rem;"></i>Erreur';
    saveBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';

    // R√©initialiser apr√®s un d√©lai
    setTimeout(() => {
      saveBtn.disabled = false;
      saveBtn.innerHTML = '<i class="fas fa-save" style="margin-right: 0.5rem;"></i>Enregistrer';
      saveBtn.style.background = 'linear-gradient(135deg, #a855f7, #9333ea)';
    }, 2000);
  }
}

// Fermer avec la touche Escape
document.addEventListener('keydown', function(event) {
  const popup = document.getElementById('whyPopup');
  if (!popup) return;

  if (event.key === 'Escape' && popup.style.display === 'flex') {
    closeWhyPopup();
  }
});

// ============================================
// FONCTIONS ANALYSE HEBDOMADAIRE (Probl√®me / Focus)
// ============================================

// Variable globale pour stocker le contexte actuel
let currentWeeklyAnalysisContext = {
  weekNumber: null,
  field: null, // 'probleme' ou 'focus'
  monthIndex: 0
};

// ===== POPUP DE LECTURE SEULE (Voir le texte complet) =====

// Ouvrir le popup de lecture seule pour voir le texte complet
function openWeeklyAnalysisViewPopup(weekNumber, field) {
  const popup = document.getElementById('weeklyAnalysisViewPopup');
  const content = document.getElementById('weeklyAnalysisViewContent');
  const title = document.getElementById('weeklyAnalysisViewTitle');
  const subtitle = document.getElementById('weeklyAnalysisViewSubtitle');
  const icon = document.getElementById('weeklyAnalysisViewIcon');

  if (!popup || !content) {
    console.error('[WEEKLY ANALYSIS VIEW] √âl√©ments popup non trouv√©s');
    return;
  }

  // Personnaliser selon le type (probleme ou focus)
  if (field === 'probleme') {
    title.textContent = 'Analyse de la semaine pass√©e';
    icon.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
    icon.innerHTML = '<i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; color: white;"></i>';
  } else {
    title.textContent = 'Focus de la semaine';
    icon.style.background = 'linear-gradient(135deg, #10b981, #059669)';
    icon.innerHTML = '<i class="fas fa-bullseye" style="font-size: 1.5rem; color: white;"></i>';
  }

  // Obtenir la description de la semaine
  const weeks = getWeeksForMonth(currentWeeklyMonthIndex);
  const weekLabel = (weeks && weeks[weekNumber - 1]) ? weeks[weekNumber - 1].label : `Semaine ${weekNumber}`;
  subtitle.textContent = `Semaine ${weekNumber} - ${weekLabel}`;

  // Charger le texte complet
  const cell = document.querySelector(`div[data-week="${weekNumber}"][data-field="${field}"]`);
  if (cell) {
    const textSpan = cell.querySelector('.week-analysis-text');
    const fullText = textSpan ? textSpan.getAttribute('data-full-text') || textSpan.textContent : '';
    content.textContent = fullText === '-' ? 'Aucune donn√©e saisie' : fullText;
  } else {
    content.textContent = 'Aucune donn√©e disponible';
  }

  // Bloquer le scroll de l'arri√®re-plan
  document.body.style.overflow = 'hidden';

  // Afficher le popup
  popup.style.display = 'flex';

  console.log(`[WEEKLY ANALYSIS VIEW] Popup ouvert - Semaine ${weekNumber}, Type: ${field}`);
}

// Fermer le popup de lecture seule
function closeWeeklyAnalysisViewPopup() {
  const popup = document.getElementById('weeklyAnalysisViewPopup');
  if (!popup) return;

  popup.style.display = 'none';

  // D√©bloquer le scroll
  document.body.style.overflow = '';

  console.log('[WEEKLY ANALYSIS VIEW] Popup ferm√©');
}

// ===== POPUP D'√âDITION =====

// Ouvrir le popup d'analyse hebdomadaire
function openWeeklyAnalysisPopup(weekNumber, field) {
  const popup = document.getElementById('weeklyAnalysisPopup');
  const textarea = document.getElementById('weeklyAnalysisTextarea');
  const title = document.getElementById('weeklyAnalysisTitle');
  const subtitle = document.getElementById('weeklyAnalysisSubtitle');
  const label = document.getElementById('weeklyAnalysisLabel');
  const help = document.getElementById('weeklyAnalysisHelp');
  const icon = document.getElementById('weeklyAnalysisIcon');
  const saveBtn = document.getElementById('saveWeeklyAnalysisBtn');

  if (!popup || !textarea) {
    console.error('[WEEKLY ANALYSIS] √âl√©ments popup non trouv√©s');
    return;
  }

  // Sauvegarder le contexte
  currentWeeklyAnalysisContext = { weekNumber, field, monthIndex: currentWeeklyMonthIndex };

  // Personnaliser selon le type (probleme ou focus)
  if (field === 'probleme') {
    title.textContent = 'Analyse de la semaine pass√©e';
    label.innerHTML = '<i class="fas fa-pen" style="color: #ef4444; margin-right: 0.5rem;"></i>D√©cris le probl√®me rencontr√© cette semaine';
    textarea.placeholder = 'D√©cris ici le probl√®me ou d√©fi principal que tu as rencontr√© cette semaine...';
    help.innerHTML = '<i class="fas fa-info-circle" style="color: #ef4444;"></i> Identifie le probl√®me principal pour mieux planifier la semaine suivante.';
    icon.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
    icon.innerHTML = '<i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; color: white;"></i>';
    saveBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
    saveBtn.style.boxShadow = '0 4px 12px rgba(239, 68, 68, 0.3)';
    textarea.onfocus = function() { this.style.borderColor = 'rgba(239, 68, 68, 0.5)'; };
  } else {
    title.textContent = 'Focus de la semaine';
    label.innerHTML = '<i class="fas fa-bullseye" style="color: #10b981; margin-right: 0.5rem;"></i>D√©finis ton focus principal';
    textarea.placeholder = 'Quel est ton objectif ou focus principal pour cette semaine ?...';
    help.innerHTML = '<i class="fas fa-info-circle" style="color: #10b981;"></i> Concentre-toi sur un objectif clair pour maximiser ton impact.';
    icon.style.background = 'linear-gradient(135deg, #10b981, #059669)';
    icon.innerHTML = '<i class="fas fa-bullseye" style="font-size: 1.5rem; color: white;"></i>';
    saveBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
    saveBtn.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)';
    textarea.onfocus = function() { this.style.borderColor = 'rgba(16, 185, 129, 0.5)'; };
  }

  // Obtenir la description de la semaine
  const weeks = getWeeksForMonth(currentWeeklyMonthIndex);
  const weekLabel = (weeks && weeks[weekNumber - 1]) ? weeks[weekNumber - 1].label : `Semaine ${weekNumber}`;
  subtitle.textContent = `Semaine ${weekNumber} - ${weekLabel}`;

  // Charger la valeur existante
  const cell = document.querySelector(`div[data-week="${weekNumber}"][data-field="${field}"]`);
  if (cell) {
    const textSpan = cell.querySelector('.week-analysis-text');
    const currentValue = textSpan ? textSpan.getAttribute('data-full-text') || textSpan.textContent : '';
    textarea.value = currentValue === '-' ? '' : currentValue;
  }

  // Bloquer le scroll de l'arri√®re-plan
  document.body.style.overflow = 'hidden';

  // Afficher le popup
  popup.style.display = 'flex';

  // Focus sur le textarea
  setTimeout(() => {
    textarea.focus();
  }, 300);

  console.log(`[WEEKLY ANALYSIS] Popup ouvert - Semaine ${weekNumber}, Type: ${field}`);
}

// Fermer le popup d'analyse hebdomadaire
function closeWeeklyAnalysisPopup() {
  const popup = document.getElementById('weeklyAnalysisPopup');
  if (!popup) return;

  popup.style.display = 'none';
  document.body.style.overflow = '';

  // R√©initialiser le contexte
  currentWeeklyAnalysisContext = { weekNumber: null, field: null, monthIndex: 0 };
}

// Sauvegarder l'analyse hebdomadaire
async function saveWeeklyAnalysis() {
  const textarea = document.getElementById('weeklyAnalysisTextarea');
  const saveBtn = document.getElementById('saveWeeklyAnalysisBtn');

  if (!textarea || !saveBtn) {
    console.error('[WEEKLY ANALYSIS] √âl√©ments non trouv√©s');
    return;
  }

  const { weekNumber, field, monthIndex } = currentWeeklyAnalysisContext;

  if (!weekNumber || !field) {
    console.error('[WEEKLY ANALYSIS] Contexte invalide');
    return;
  }

  const analysisText = textarea.value.trim();
  const username = window.username || localStorage.getItem('username');

  // D√©sactiver le bouton
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Enregistrement...';

  try {
    // Sauvegarder via l'API
    const response = await fetch(`/api/rpo/${username}/weekly/${monthIndex}/${weekNumber}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        [field]: analysisText || '-'
      })
    });

    const data = await response.json();

    if (response.ok) {
      console.log(`[WEEKLY ANALYSIS] ‚úÖ Sauvegard√© - Semaine ${weekNumber}, ${field}`);

      // Mettre √† jour l'affichage dans le tableau
      const cell = document.querySelector(`div[data-week="${weekNumber}"][data-field="${field}"]`);
      if (cell) {
        const textSpan = cell.querySelector('.week-analysis-text');
        if (textSpan) {
          // Stocker le texte complet
          textSpan.setAttribute('data-full-text', analysisText || '-');

          // Afficher avec ellipsis si n√©cessaire (max 50 caract√®res)
          const displayText = analysisText || '-';
          if (displayText.length > 50) {
            textSpan.textContent = displayText.substring(0, 50) + '...';
          } else {
            textSpan.textContent = displayText;
          }
        }
      }

      // Feedback visuel
      saveBtn.innerHTML = '<i class="fas fa-check"></i>Enregistr√© !';

      // Fermer apr√®s un d√©lai
      setTimeout(() => {
        closeWeeklyAnalysisPopup();
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i>Enregistrer';
      }, 1000);
    } else {
      throw new Error(data.error || 'Erreur de sauvegarde');
    }
  } catch (error) {
    console.error('[WEEKLY ANALYSIS] ‚ùå Erreur sauvegarde:', error);

    saveBtn.innerHTML = '<i class="fas fa-times"></i>Erreur';

    setTimeout(() => {
      saveBtn.disabled = false;
      saveBtn.innerHTML = '<i class="fas fa-save"></i>Enregistrer';
    }, 2000);
  }
}

// ===== POPUP √âDITION LIGNE COMPL√àTE (Rating + Probleme + Focus) =====

// Variable pour stocker la semaine en cours d'√©dition
let currentWeeklyRowEditContext = {
  weekNumber: null,
  monthIndex: 0,
  rating: 0
};

// Ouvrir le popup d'√©dition de ligne compl√®te
function openWeeklyRowEditPopup(weekNumber) {
  const popup = document.getElementById('weeklyRowEditPopup');
  const subtitle = document.getElementById('weeklyRowEditSubtitle');
  const problemeTextarea = document.getElementById('weeklyRowEditProbleme');
  const focusTextarea = document.getElementById('weeklyRowEditFocus');

  if (!popup) {
    console.error('[WEEKLY ROW EDIT] Popup non trouv√©');
    return;
  }

  // Sauvegarder le contexte
  currentWeeklyRowEditContext = {
    weekNumber: weekNumber,
    monthIndex: currentWeeklyMonthIndex,
    rating: 0
  };

  // Obtenir la description de la semaine
  const weeks = getWeeksForMonth(currentWeeklyMonthIndex);
  const weekLabel = (weeks && weeks[weekNumber - 1]) ? weeks[weekNumber - 1].label : '';
  subtitle.textContent = `Semaine ${weekNumber} - ${weekLabel}`;

  // Charger les donn√©es existantes depuis window.weeklyData
  const weekData = window.weeklyData?.[String(currentWeeklyMonthIndex)]?.[String(weekNumber)];

  // Rating
  const existingRating = weekData?.rating || 0;
  currentWeeklyRowEditContext.rating = existingRating;
  updatePopupStars(existingRating);

  // Probleme
  let existingProbleme = '';
  const problemeCell = document.querySelector(`div[data-week="${weekNumber}"][data-field="probleme"]`);
  if (problemeCell) {
    const textSpan = problemeCell.querySelector('.week-analysis-text');
    existingProbleme = textSpan ? textSpan.getAttribute('data-full-text') || textSpan.textContent : '';
    if (existingProbleme === '-') existingProbleme = '';
  }
  problemeTextarea.value = existingProbleme;

  // Focus
  let existingFocus = '';
  const focusCell = document.querySelector(`div[data-week="${weekNumber}"][data-field="focus"]`);
  if (focusCell) {
    const textSpan = focusCell.querySelector('.week-analysis-text');
    existingFocus = textSpan ? textSpan.getAttribute('data-full-text') || textSpan.textContent : '';
    if (existingFocus === '-') existingFocus = '';
  }
  focusTextarea.value = existingFocus;

  // Initialiser les √©v√©nements des √©toiles du popup
  initPopupStarRatings();

  // Bloquer le scroll
  document.body.style.overflow = 'hidden';

  // Afficher le popup
  popup.style.display = 'flex';

  console.log(`[WEEKLY ROW EDIT] Popup ouvert - Semaine ${weekNumber}`);
}

// Fermer le popup d'√©dition de ligne
function closeWeeklyRowEditPopup() {
  const popup = document.getElementById('weeklyRowEditPopup');
  if (!popup) return;

  popup.style.display = 'none';
  document.body.style.overflow = '';

  // R√©initialiser le contexte
  currentWeeklyRowEditContext = { weekNumber: null, monthIndex: 0, rating: 0 };

  console.log('[WEEKLY ROW EDIT] Popup ferm√©');
}

// Mettre √† jour les √©toiles du popup
function updatePopupStars(rating) {
  const stars = document.querySelectorAll('.popup-star-rating');
  stars.forEach((star, index) => {
    if (index < rating) {
      star.style.color = '#fbbf24'; // Yellow
    } else {
      star.style.color = '#374151'; // Gray
    }
  });
}

// Initialiser les √©v√©nements de clic sur les √©toiles du popup
function initPopupStarRatings() {
  const stars = document.querySelectorAll('.popup-star-rating');
  stars.forEach(star => {
    // Supprimer les anciens listeners
    const newStar = star.cloneNode(true);
    star.parentNode.replaceChild(newStar, star);
  });

  // Ajouter les nouveaux listeners
  document.querySelectorAll('.popup-star-rating').forEach(star => {
    star.addEventListener('click', function() {
      const rating = parseInt(this.dataset.rating);
      currentWeeklyRowEditContext.rating = rating;
      updatePopupStars(rating);
    });

    // Effet hover
    star.addEventListener('mouseenter', function() {
      const hoverRating = parseInt(this.dataset.rating);
      document.querySelectorAll('.popup-star-rating').forEach((s, index) => {
        if (index < hoverRating) {
          s.style.color = '#fbbf24';
          s.style.transform = 'scale(1.1)';
        } else {
          s.style.color = '#374151';
          s.style.transform = 'scale(1)';
        }
      });
    });

    star.addEventListener('mouseleave', function() {
      updatePopupStars(currentWeeklyRowEditContext.rating);
      document.querySelectorAll('.popup-star-rating').forEach(s => {
        s.style.transform = 'scale(1)';
      });
    });
  });
}

// Sauvegarder les 3 champs de la ligne (Rating + Probleme + Focus)
async function saveWeeklyRowEdit() {
  const saveBtn = document.getElementById('saveWeeklyRowEditBtn');
  const problemeTextarea = document.getElementById('weeklyRowEditProbleme');
  const focusTextarea = document.getElementById('weeklyRowEditFocus');

  if (!saveBtn) {
    console.error('[WEEKLY ROW EDIT] Bouton save non trouv√©');
    return;
  }

  const { weekNumber, monthIndex, rating } = currentWeeklyRowEditContext;

  if (!weekNumber) {
    console.error('[WEEKLY ROW EDIT] Contexte invalide');
    return;
  }

  const problemeText = problemeTextarea.value.trim();
  const focusText = focusTextarea.value.trim();
  const username = window.username || localStorage.getItem('username');

  // D√©sactiver le bouton
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';

  try {
    // Sauvegarder via l'API - les 3 champs en m√™me temps
    const response = await fetch(`/api/rpo/${username}/weekly/${monthIndex}/${weekNumber}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        rating: rating,
        probleme: problemeText || '-',
        focus: focusText || '-'
      })
    });

    const data = await response.json();

    if (response.ok) {
      console.log(`[WEEKLY ROW EDIT] ‚úÖ Sauvegard√© - Semaine ${weekNumber}`);

      // Mettre √† jour l'affichage dans le tableau

      // 1. Rating (√©toiles)
      const weekStars = document.querySelectorAll(`.star-rating[data-week="${weekNumber}"]`);
      weekStars.forEach((star, index) => {
        if (index < rating) {
          star.style.color = '#fbbf24';
        } else {
          star.style.color = '#374151';
        }
      });

      // Mettre √† jour le dash/√©toiles pour ce rating
      const starContainer = document.querySelector(`.star-container[data-week="${weekNumber}"]`);
      if (starContainer) {
        const dashSpan = starContainer.querySelector('span');
        const starsGroup = starContainer.querySelector('.star-rating-group');
        if (rating > 0) {
          if (dashSpan) dashSpan.classList.add('hidden');
          if (starsGroup) starsGroup.classList.remove('hidden');
        }
      }

      // 2. Probleme
      const problemeCell = document.querySelector(`div[data-week="${weekNumber}"][data-field="probleme"]`);
      if (problemeCell) {
        const textSpan = problemeCell.querySelector('.week-analysis-text');
        if (textSpan) {
          const displayText = problemeText || '-';
          textSpan.setAttribute('data-full-text', displayText);
          textSpan.textContent = displayText.length > 50 ? displayText.substring(0, 50) + '...' : displayText;
        }
      }

      // 3. Focus
      const focusCell = document.querySelector(`div[data-week="${weekNumber}"][data-field="focus"]`);
      if (focusCell) {
        const textSpan = focusCell.querySelector('.week-analysis-text');
        if (textSpan) {
          const displayText = focusText || '-';
          textSpan.setAttribute('data-full-text', displayText);
          textSpan.textContent = displayText.length > 50 ? displayText.substring(0, 50) + '...' : displayText;
        }
      }

      // Mettre √† jour window.weeklyData
      if (!window.weeklyData) window.weeklyData = {};
      if (!window.weeklyData[String(monthIndex)]) window.weeklyData[String(monthIndex)] = {};
      if (!window.weeklyData[String(monthIndex)][String(weekNumber)]) {
        window.weeklyData[String(monthIndex)][String(weekNumber)] = {};
      }
      window.weeklyData[String(monthIndex)][String(weekNumber)].rating = rating;
      window.weeklyData[String(monthIndex)][String(weekNumber)].probleme = problemeText || '-';
      window.weeklyData[String(monthIndex)][String(weekNumber)].focus = focusText || '-';

      // Feedback visuel
      saveBtn.innerHTML = '<i class="fas fa-check"></i> Enregistr√© !';
      saveBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';

      // Fermer apr√®s un d√©lai
      setTimeout(() => {
        closeWeeklyRowEditPopup();
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer';
      }, 800);
    } else {
      throw new Error(data.error || 'Erreur de sauvegarde');
    }
  } catch (error) {
    console.error('[WEEKLY ROW EDIT] ‚ùå Erreur sauvegarde:', error);

    saveBtn.innerHTML = '<i class="fas fa-times"></i> Erreur';
    saveBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';

    setTimeout(() => {
      saveBtn.disabled = false;
      saveBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer';
      saveBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
    }, 2000);
  }
}

// Fermer le popup avec Escape
document.addEventListener('keydown', function(event) {
  const popup = document.getElementById('weeklyRowEditPopup');
  if (popup && event.key === 'Escape' && popup.style.display === 'flex') {
    closeWeeklyRowEditPopup();
  }
});

// Formater l'input Objectif CA en temps r√©el (sans le $)
function formatObjectifCALive() {
  const input = document.getElementById('objectifCA');

  // Sauvegarder la valeur avant formatage
  const oldValue = input.value;
  const cursorPos = input.selectionStart;

  // Enlever tous les caract√®res non num√©riques
  let value = input.value.replace(/[^\d]/g, '');

  // Si vide, ne rien faire
  if (!value) {
    input.value = '';
    return;
  }

  // Convertir en nombre
  let number = parseInt(value);

  // Formater avec espaces de milliers SANS le $
  const formatted = number.toLocaleString('fr-CA').replace(/\s/g, ' ');

  // Seulement mettre √† jour si le format a chang√©
  if (oldValue !== formatted) {
    input.value = formatted;

    // Calculer la nouvelle position du curseur
    // Compter le nombre de chiffres avant le curseur
    const digitsBeforeCursor = oldValue.substring(0, cursorPos).replace(/[^\d]/g, '').length;

    // Trouver la position correspondante dans la nouvelle valeur
    let newCursorPos = 0;
    let digitCount = 0;
    for (let i = 0; i < formatted.length; i++) {
      if (/\d/.test(formatted[i])) {
        digitCount++;
        if (digitCount > digitsBeforeCursor) {
          newCursorPos = i;
          break;
        }
      }
      newCursorPos = i + 1;
    }

    // Placer le curseur
    input.setSelectionRange(newCursorPos, newCursorPos);
  }
}

// Formater l'input Objectif CA (final au blur/save)
function formatObjectifCA() {
  const input = document.getElementById('objectifCA');
  let value = input.value;

  // Enlever tous les caract√®res non num√©riques sauf le point et la virgule
  value = value.replace(/[^\d.,]/g, '');

  // Remplacer la virgule par un point pour la conversion
  value = value.replace(',', '.');

  // Convertir en nombre
  let number = parseFloat(value);

  // Si c'est un nombre valide, le formater
  if (!isNaN(number)) {
    // Formater avec espaces comme s√©parateurs de milliers et ,00 pour les d√©cimales
    const formatted = number.toLocaleString('fr-CA', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).replace(/\s/g, ' ') + ' $';

    input.value = formatted;
    input.dataset.value = number; // IMPORTANT: Mettre √† jour data-value
  } else {
    input.value = '0,00 $';
    input.dataset.value = 0;
  }
}

// Ajouter l'√©couteur d'√©v√©nement pour le formatage automatique
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('objectifCA');

  // Formater en temps r√©el pendant la saisie
  input.addEventListener('input', () => {
    if (!input.hasAttribute('readonly')) {
      formatObjectifCALive();
    }
  });

  // Formater lors de la perte de focus
  input.addEventListener('blur', () => {
    if (!input.hasAttribute('readonly')) {
      formatObjectifCA();
    }
  });

  // Formater lors de la touche Enter
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !input.hasAttribute('readonly')) {
      saveObjectif();
    }
  });

});

// Calculate percentage difference between reel and vise
function calculatePercentage(metricName) {
  const viseInput = document.getElementById(metricName + '-vise');
  if (!viseInput) return;

  const cardDiv = viseInput.closest('.rounded-xl');
  if (!cardDiv) return;

  // Try annual-{metric}-reel first, then fallback to {metric}-reel for calculated metrics
  let reelDiv = document.getElementById('annual-' + metricName + '-reel');
  if (!reelDiv) {
    reelDiv = document.getElementById(metricName + '-reel');
  }
  if (!reelDiv) return;

  const iconElement = document.getElementById(metricName + '-icon');
  const percentElement = document.getElementById(metricName + '-percent');

  const viseValue = parseFloat(viseInput.dataset.value);
  const reelValue = parseFloat(reelDiv.dataset.value);

  // If vis√© is 0, set everything to white/gray (nothing to compare)
  if (!viseValue || viseValue === 0) {
    const grayColor = '#e5e7eb';
    percentElement.textContent = '0%';
    if (iconElement) {
      iconElement.style.color = grayColor;
      iconElement.className = 'fas fa-minus mr-1';
    }
    cardDiv.style.borderTop = `3px solid ${grayColor}`;
    percentElement.style.color = grayColor;

    const progressBar = document.getElementById(metricName + '-progress-bar');
    if (progressBar) {
      progressBar.style.width = '0%';
      progressBar.style.background = grayColor;
    }
    return;
  }

  if (viseValue > 0) {
    const percentageOfTarget = (reelValue / viseValue) * 100;
    const percentRounded = Math.round(percentageOfTarget * 10) / 10;

    percentElement.textContent = percentRounded + '%';

    // Change colors based on percentage - orange d√®s 0.1%, jaune √† 30%, vert √† 60%
    let color;
    if (percentRounded >= 100) {
      // 100%+ - vert fonc√©
      color = '#22c55e';
      if (iconElement) iconElement.className = 'fas fa-arrow-up mr-1';
    } else if (percentRounded >= 90) {
      // 90-99% - vert
      color = '#34d399';
      if (iconElement) iconElement.className = 'fas fa-arrow-up mr-1';
    } else if (percentRounded >= 80) {
      // 80-89% - vert clair
      color = '#4ade80';
      if (iconElement) iconElement.className = 'fas fa-arrow-up mr-1';
    } else if (percentRounded >= 70) {
      // 70-79% - vert-jaune
      color = '#84cc16';
      if (iconElement) iconElement.className = 'fas fa-arrow-up mr-1';
    } else if (percentRounded >= 60) {
      // 60-69% - jaune-vert (d√©but du vert)
      color = '#a3e635';
      if (iconElement) iconElement.className = 'fas fa-minus mr-1';
    } else if (percentRounded >= 50) {
      // 50-59% - jaune vif
      color = '#eab308';
      if (iconElement) iconElement.className = 'fas fa-minus mr-1';
    } else if (percentRounded >= 30) {
      // 30-49% - jaune
      color = '#facc15';
      if (iconElement) iconElement.className = 'fas fa-minus mr-1';
    } else if (percentRounded > 0) {
      // 0.1-29% - orange (d√®s 0.1%)
      color = '#f97316';
      if (iconElement) iconElement.className = 'fas fa-minus mr-1';
    } else {
      // 0% uniquement - blanc/gris
      color = '#e5e7eb';
      if (iconElement) iconElement.className = 'fas fa-minus mr-1';
    }

    if (iconElement) iconElement.style.color = color;
    cardDiv.style.borderTop = `3px solid ${color}`;
    percentElement.style.color = color;

    // Update progress bar - couleur unie selon le pourcentage (m√™me que le cercle/bordure)
    const progressBar = document.getElementById(metricName + '-progress-bar');
    if (progressBar) {
      const widthPercent = Math.min(percentRounded, 100);
      progressBar.style.width = widthPercent + '%';
      progressBar.style.background = color; // Utilise la m√™me couleur que le cercle
    }
  }
}

// Calculate objective CA progress percentage
function calculateObjectifCAProgress() {
  const objectifCAInput = document.getElementById('objectifCA');
  const dollarReelDiv = document.getElementById('annual-dollar-reel');
  const progressCircle = document.getElementById('progressCircleObjectif');
  const progressPercent = document.getElementById('progressPercentObjectif');

  if (!objectifCAInput || !dollarReelDiv || !progressCircle || !progressPercent) {
    return;
  }

  // Get Objectif CA
  const objectifCA = parseFloat(objectifCAInput.dataset.value) || 0;

  // Get $ Sign√© R√©el
  const dollarReel = parseFloat(dollarReelDiv.dataset.value) || 0;

  // Calculate percentage
  let percentage = 0;
  if (objectifCA > 0) {
    percentage = (dollarReel / objectifCA) * 100;
  }

  // Round to 1 decimal
  percentage = Math.round(percentage * 10) / 10;

  // Update display
  progressPercent.textContent = percentage + '%';

  // Update circle (circumference = 2 * PI * r = 2 * 3.14159 * 56 = 352)
  const circumference = 352;
  let offset = circumference - (percentage / 100) * circumference;
  // Minimum 1 pixel visible (offset maximum de 351)
  offset = Math.min(offset, 351);
  progressCircle.style.strokeDashoffset = offset;

  // Change colors based on percentage - gradient from red to green
  let color;
  if (percentage >= 100) {
    // 100%+ - vert
    color = '#22c55e';
  } else if (percentage >= 90) {
    // 90-99% - vert clair
    color = '#34d399';
  } else if (percentage >= 80) {
    // 80-89% - vert jaune
    color = '#84cc16';
  } else if (percentage >= 70) {
    // 70-79% - jaune vert
    color = '#a3e635';
  } else if (percentage >= 60) {
    // 60-69% - jaune
    color = '#eab308';
  } else if (percentage >= 50) {
    // 50-59% - jaune orange
    color = '#f59e0b';
  } else if (percentage >= 40) {
    // 40-49% - orange
    color = '#f97316';
  } else if (percentage >= 30) {
    // 30-39% - orange rouge
    color = '#fb923c';
  } else if (percentage >= 20) {
    // 20-29% - rouge orange
    color = '#f87171';
  } else {
    // <20% - rouge
    color = '#ef4444';
  }

  // Apply color to circle and percentage text
  progressCircle.style.stroke = color;
  progressPercent.style.color = color;

  // Mettre √† jour le graphique √† barres annuel
  updateAnnualChart();

  // Mettre √† jour la ligne d'objectif dynamique dans le graphique (optionnel si graphique existe)
  if (typeof updateObjectifLine === 'function') {
    updateObjectifLine(objectifCA);
  }
}

// Mettre √† jour le graphique √† barres annuel
function updateAnnualChart() {
  const container = document.getElementById('annualChartContainer');
  if (!container) return;

  // Vider le conteneur
  container.innerHTML = '';

  // Noms des mois: Jan-Sept 2026
  const monthNames = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sept'];

  // Index des mois: 0-8 (Jan-Sept 2026)
  const monthIndexes = [0, 1, 2, 3, 4, 5, 6, 7, 8];

  // R√©cup√©rer les valeurs mensuelles en SOMMANT les donn√©es hebdomadaires
  const monthlyData = [];

  monthIndexes.forEach(monthIndex => {
    let monthTotal = 0;

    // Sommer toutes les semaines de ce mois
    if (window.rpoData && window.rpoData.weekly && window.rpoData.weekly[monthIndex.toString()]) {
      const monthWeeks = window.rpoData.weekly[monthIndex.toString()];

      // Parcourir les semaines 1-5
      for (let weekNum = 1; weekNum <= 5; weekNum++) {
        const weekData = monthWeeks[weekNum.toString()];
        if (weekData && weekData.dollar) {
          monthTotal += parseFloat(weekData.dollar) || 0;
        }
      }
    }

    monthlyData.push({ value: monthTotal, index: monthIndex });
  });

  log('[DATA] [CHART] Valeurs mensuelles calcul√©es:', monthlyData);

  // Trouver la valeur maximale pour normaliser les hauteurs
  const maxValue = Math.max(...monthlyData.map(d => d.value), 1);

  // Cr√©er les barres
  monthlyData.forEach((data, i) => {
    const maxHeight = 160;
    const height = maxValue > 0 ? (data.value / maxValue) * maxHeight : 5;

    const bar = document.createElement('div');
    bar.className = 'chart-bar';
    bar.style.height = `${Math.max(height, 5)}px`;
    bar.setAttribute('data-month-index', data.index);
    bar.style.cursor = 'pointer';

    // Formater la valeur en format mon√©taire
    const formattedValue = data.value > 0 ? Math.round(data.value).toLocaleString('fr-CA') + ' $' : '';

    bar.innerHTML = `
      <div class="chart-bar-value">${formattedValue}</div>
      <div class="chart-bar-label">${monthNames[i]}</div>
    `;

    // Ajouter l'event listener pour le drill-down
    bar.addEventListener('click', () => {
      openMonthDrillDown(data.index);
    });

    container.appendChild(bar);
  });
}

// Variables globales pour le drill-down
let currentSelectedMonth = null;
let currentSelectedWeek = null;

// Calculer toutes les semaines (D√©c 2025 + Jan-Sept 2026)
function getWeeksOf2025() {
  const weeks = [];

  // Partie 1: Janvier 2026 (5 semaines)
  let weekNumber = 1;

  // Calculer les lundis de janvier 2026 (commence le 5 janvier)
  const jan2026Start = createTorontoDate(2026, 0, 5); // 5 janvier 2026 - Toronto timezone

  for (let i = 0; i < 5; i++) {
    const weekStart = new Date(jan2026Start.getTime() + (i * 7 * 24 * 60 * 60 * 1000));
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate() + 6);

    weeks.push({
      weekNumber: weekNumber,
      weekStart: new Date(weekStart),
      weekEnd: new Date(weekEnd),
      month: 0 // Janvier 2026
    });
    weekNumber++;
  }

  // Partie 2: Janvier √† Septembre 2026
  let currentDate = createTorontoDate(2026, 0, 1); // 1er janvier 2026 - Toronto timezone

  // Trouver le premier lundi de 2026
  const dayOfWeek = currentDate.getDay();
  if (dayOfWeek !== 1) {
    // Avancer au prochain lundi
    const daysUntilMonday = dayOfWeek === 0 ? 1 : (8 - dayOfWeek) % 7;
    currentDate.setDate(currentDate.getDate() + daysUntilMonday);
  }

  // G√©n√©rer les semaines jusqu'√† fin septembre 2026
  while (currentDate.getFullYear() === 2026 && currentDate.getMonth() <= 8) {
    const weekStart = new Date(currentDate);
    const weekEnd = new Date(currentDate);
    weekEnd.setDate(weekEnd.getDate() + 6);

    // D√©terminer le mois principal de la semaine (jeudi)
    const midWeek = new Date(currentDate);
    midWeek.setDate(midWeek.getDate() + 3);
    const month = midWeek.getMonth();

    weeks.push({
      weekNumber: weekNumber,
      weekStart: new Date(weekStart),
      weekEnd: new Date(weekEnd),
      month: month // 0=Janvier, 1=F√©vrier, ..., 8=Septembre
    });

    currentDate.setDate(currentDate.getDate() + 7);
    weekNumber++;

    // Arr√™ter si on d√©passe septembre
    if (currentDate.getMonth() > 8) break;
  }

  return weeks;
}

// Fonction pour ouvrir le drill-down d'un mois
function openMonthDrillDown(monthIndex) {
  currentSelectedMonth = monthIndex;
  currentSelectedWeek = null;

  // Obtenir le nom du mois
  let monthName;
  const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
  monthName = monthNames[monthIndex] + ' 2026';

  // Cacher le graphique mensuel, afficher le graphique hebdomadaire
  document.getElementById('annualChartContainer').style.display = 'none';
  document.getElementById('weeklyChartContainer').style.display = 'flex';
  document.getElementById('dailyChartContainer').style.display = 'none';

  // Mettre √† jour le breadcrumb
  document.getElementById('breadcrumbMonthName').textContent = monthName;
  document.getElementById('breadcrumbMonth').style.display = 'flex';
  document.getElementById('breadcrumbSep1').style.display = 'inline';
  document.getElementById('breadcrumbWeek').style.display = 'none';
  document.getElementById('breadcrumbSep2').style.display = 'none';

  // G√©n√©rer le graphique hebdomadaire
  updateWeeklyChart(monthIndex);
}

// Fonction pour ouvrir le drill-down d'une semaine
function openWeekDrillDown(weekNumber, weekNumberInMonth) {
  currentSelectedWeek = weekNumber;

  // Cacher les graphiques mensuel et hebdomadaire, afficher le graphique quotidien
  document.getElementById('annualChartContainer').style.display = 'none';
  document.getElementById('weeklyChartContainer').style.display = 'none';
  document.getElementById('dailyChartContainer').style.display = 'flex';

  // R√©cup√©rer les informations de la semaine pour afficher la date
  const allWeeks = getWeeksOf2025();
  const selectedWeek = allWeeks.find(w => w.weekNumber === weekNumber);

  if (selectedWeek) {
    const monthNames = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
    const startDay = selectedWeek.weekStart.getDate();
    const startMonth = monthNames[selectedWeek.weekStart.getMonth()];
    const year = selectedWeek.weekStart.getFullYear();

    // Mettre √† jour le breadcrumb avec "Semaine du [jour] [mois]" (ajouter ann√©e si 2025)
    if (year === 2025) {
      document.getElementById('breadcrumbWeekName').textContent = `Semaine du ${startDay} ${startMonth} 2025`;
    } else {
      document.getElementById('breadcrumbWeekName').textContent = `Semaine du ${startDay} ${startMonth}`;
    }
  } else {
    document.getElementById('breadcrumbWeekName').textContent = `Semaine ${weekNumber}`;
  }

  document.getElementById('breadcrumbWeek').style.display = 'flex';
  document.getElementById('breadcrumbSep2').style.display = 'inline';

  // G√©n√©rer le graphique quotidien avec les vraies dates de la semaine
  updateDailyChart(weekNumber);
}

// Fonction pour retourner √† la vue annuelle
function goBackToYear() {
  // Ne rien faire si on est d√©j√† dans la vue annuelle
  if (currentSelectedMonth === null) return;

  currentSelectedMonth = null;
  currentSelectedWeek = null;

  // Afficher le graphique mensuel, cacher les autres
  document.getElementById('annualChartContainer').style.display = 'flex';
  document.getElementById('weeklyChartContainer').style.display = 'none';
  document.getElementById('dailyChartContainer').style.display = 'none';

  // Mettre √† jour le breadcrumb
  document.getElementById('breadcrumbMonth').style.display = 'none';
  document.getElementById('breadcrumbSep1').style.display = 'none';
  document.getElementById('breadcrumbWeek').style.display = 'none';
  document.getElementById('breadcrumbSep2').style.display = 'none';
}

// Fonction pour retourner √† la vue mensuelle (depuis la vue quotidienne)
function goBackToMonth() {
  currentSelectedWeek = null;

  // Afficher le graphique hebdomadaire, cacher les autres
  document.getElementById('annualChartContainer').style.display = 'none';
  document.getElementById('weeklyChartContainer').style.display = 'flex';
  document.getElementById('dailyChartContainer').style.display = 'none';

  // Mettre √† jour le breadcrumb
  document.getElementById('breadcrumbWeek').style.display = 'none';
  document.getElementById('breadcrumbSep2').style.display = 'none';
}

// Fonction pour mettre √† jour le graphique hebdomadaire
function updateWeeklyChart(monthIndex) {
  const container = document.getElementById('weeklyChartContainer');
  if (!container) return;

  // Vider le conteneur
  container.innerHTML = '';

  // R√©cup√©rer toutes les semaines de 2025
  const allWeeks = getWeeksOf2025();

  // Filtrer les semaines qui appartiennent √† ce mois
  const monthWeeks = allWeeks.filter(week => week.month === monthIndex);

  if (monthWeeks.length === 0) {
    container.innerHTML = '<p style="color: var(--text-gray); text-align: center; margin: auto;">Aucune semaine pour ce mois</p>';
    return;
  }

  // R√©cup√©rer les donn√©es pour chaque semaine depuis le backend
  const weeklyData = monthWeeks.map((week, index) => {
    let value = 0;

    // Calculer le num√©ro de semaine dans le mois (1-5)
    // Pour D√©c 2025, c'est d√©j√† dans week.weekInMonth
    // Compter les semaines dans ce mois sp√©cifique
    let weekNumberInMonth = index + 1;

    if (window.rpoData && window.rpoData.weekly && window.rpoData.weekly[monthIndex.toString()]) {
      const weekData = window.rpoData.weekly[monthIndex.toString()][weekNumberInMonth.toString()];
      if (weekData && weekData.dollar !== undefined) {
        value = parseFloat(weekData.dollar) || 0;
      }
    }

    return {
      week: week,
      value: value,
      weekNumberInMonth: weekNumberInMonth
    };
  });

  // Trouver la valeur maximale
  const maxValue = Math.max(...weeklyData.map(d => d.value), 1);

  // Cr√©er les barres hebdomadaires
  weeklyData.forEach((data, i) => {
    const maxHeight = 160;
    const height = maxValue > 0 ? (data.value / maxValue) * maxHeight : 5;

    const bar = document.createElement('div');
    bar.className = 'chart-bar';
    bar.style.height = `${Math.max(height, 5)}px`;
    bar.setAttribute('data-week-number', data.week.weekNumber);
    bar.setAttribute('data-week-in-month', data.weekNumberInMonth);
    bar.style.cursor = 'pointer';

    const formattedValue = data.value > 0 ? Math.round(data.value).toLocaleString('fr-CA') + ' $' : '';

    // Formater les dates de la semaine avec noms de mois
    const monthNames = ['jan', 'f√©v', 'mar', 'avr', 'mai', 'juin', 'juil', 'ao√ªt', 'sep', 'oct', 'nov', 'd√©c'];
    const startDay = data.week.weekStart.getDate();
    const startMonth = monthNames[data.week.weekStart.getMonth()];
    const endDay = data.week.weekEnd.getDate();
    const endMonth = monthNames[data.week.weekEnd.getMonth()];

    // Format: "4 juin - 10 juin" ou "28 mai - 3 juin" si la semaine chevauche deux mois
    const weekLabel = startMonth === endMonth
      ? `${startDay} - ${endDay} ${startMonth}`
      : `${startDay} ${startMonth} - ${endDay} ${endMonth}`;

    bar.innerHTML = `
      <div class="chart-bar-value">${formattedValue}</div>
      <div class="chart-bar-label">${weekLabel}</div>
    `;

    // Ajouter l'event listener pour le drill-down vers les jours
    bar.addEventListener('click', () => {
      openWeekDrillDown(data.week.weekNumber, data.weekNumberInMonth);
    });

    container.appendChild(bar);
  });
}

// Fonction pour mettre √† jour le graphique quotidien
async function updateDailyChart(weekNumber) {
  const container = document.getElementById('dailyChartContainer');
  if (!container) return;

  // Afficher un loader pendant le chargement
  container.innerHTML = '<p style="color: var(--text-gray); text-align: center; margin: auto;">Chargement...</p>';

  // R√©cup√©rer les informations de la semaine
  const allWeeks = getWeeksOf2025();
  const selectedWeek = allWeeks.find(w => w.weekNumber === weekNumber);

  if (!selectedWeek) {
    container.innerHTML = '<p style="color: var(--text-gray); text-align: center; margin: auto;">Semaine non trouv√©e</p>';
    return;
  }

  // Charger les soumissions sign√©es depuis le backend
  const username = getCurrentUsername();

  try {
    console.log('[RPO DAILY] Fetching soumissions for user:', username);

    // Charger les soumissions sign√©es ET les produits livr√©s pour le RPO
    const [soumissionsResponse, produitsResponse] = await Promise.all([
      fetch(`/soumissions_signees/${username}`),
      fetch(`/api/ventes_produit/${username}`)
    ]);

    if (!soumissionsResponse.ok) {
      throw new Error('Erreur chargement soumissions: ' + soumissionsResponse.status);
    }

    const soumissionsSignees = await soumissionsResponse.json();
    console.log('[RPO DAILY] Received', soumissionsSignees.length, 'soumissions sign√©es');

    // Charger aussi les produits livr√©s (pour RPO, on veut TOUTES les ventes)
    let produitsLivres = [];
    if (produitsResponse.ok) {
      produitsLivres = await produitsResponse.json();
      console.log('[RPO DAILY] Received', produitsLivres.length, 'produits livr√©s');
    }

    // Combiner les deux listes en √©vitant les doublons (m√™me ID)
    const idsVus = new Set();
    const toutesLesVentes = [];

    // Ajouter soumissions sign√©es
    soumissionsSignees.forEach(s => {
      const id = s.id || s.num;
      if (id && !idsVus.has(id)) {
        toutesLesVentes.push(s);
        idsVus.add(id);
      }
    });

    // Ajouter produits livr√©s (sans doublons)
    produitsLivres.forEach(p => {
      const id = p.id || p.num;
      if (id && !idsVus.has(id)) {
        toutesLesVentes.push(p);
        idsVus.add(id);
      }
    });

    console.log('[RPO DAILY] Total ventes (sans doublons):', toutesLesVentes.length);
    if (toutesLesVentes.length > 0) {
      console.log('[RPO DAILY] Sample vente:', toutesLesVentes[0]);
    }

    // Cr√©er un objet pour stocker les montants par jour
    const dailyAmounts = {};

    // Fonction pour parser les dates (format: DD/MM/YYYY ou YYYY-MM-DD ou ISO)
    const parseDate = (dateStr) => {
      if (!dateStr) return null;
      try {
        if (dateStr.includes('T')) {
          // Format ISO avec timestamp: "2025-10-10T17:00:49.241874"
          const datePart = dateStr.split('T')[0];
          const [year, month, day] = datePart.split('-').map(Number);
          return new Date(year, month - 1, day, 12, 0, 0);  // Midi pour √©viter les probl√®mes de timezone
        } else if (dateStr.includes('/')) {
          // Format DD/MM/YYYY
          const [day, month, year] = dateStr.split('/').map(Number);
          return new Date(year, month - 1, day, 12, 0, 0);  // Midi pour √©viter les probl√®mes de timezone
        } else if (dateStr.includes('-')) {
          // Format YYYY-MM-DD
          const [year, month, day] = dateStr.split('-').map(Number);
          return new Date(year, month - 1, day, 12, 0, 0);  // Midi pour √©viter les probl√®mes de timezone
        } else {
          const d = new Date(dateStr);
          d.setHours(12, 0, 0, 0);
          return d;
        }
      } catch (e) {
        console.error('[RPO] Erreur parsing date:', dateStr, e);
        return null;
      }
    };

    // Fonction pour cr√©er une cl√© de date (YYYY-MM-DD) en timezone locale
    const getDateKey = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };

    // Filtrer les soumissions pour la semaine s√©lectionn√©e
    // Utiliser des dates √† midi pour √©viter les probl√®mes de timezone
    const weekStart = new Date(selectedWeek.weekStart);
    weekStart.setHours(0, 0, 0, 0);
    const weekEnd = new Date(selectedWeek.weekEnd);
    weekEnd.setHours(23, 59, 59, 999);

    // Cr√©er des cl√©s de date pour la plage de la semaine (pour comparaison simple)
    const weekStartKey = getDateKey(weekStart);
    const weekEndKey = getDateKey(weekEnd);

    console.log('[RPO DAILY] Week range:', weekStartKey, 'to', weekEndKey);
    console.log('[RPO DAILY] Processing', toutesLesVentes.length, 'ventes total');

    toutesLesVentes.forEach((soumission, idx) => {
      // Pour ventes_produit, utiliser date_completion si disponible (date vraie de signature)
      // Sinon utiliser date (peut √™tre modifi√©e)
      let dateStr = soumission.date || soumission.dateEnvoi;

      // Si c'est un produit livr√© avec date_completion, extraire la date de l√†
      if (soumission.date_completion) {
        // date_completion est en format ISO: "2025-12-10T13:54:19.645559"
        // Extraire juste la partie date et convertir en DD/MM/YYYY
        const datePart = soumission.date_completion.split('T')[0]; // "2025-12-10"
        const [year, month, day] = datePart.split('-');
        dateStr = `${day}/${month}/${year}`; // Convertir en DD/MM/YYYY
        console.log('[RPO DAILY] Using date_completion:', soumission.date_completion, '-> converted to:', dateStr);
      }

      const soumissionDate = parseDate(dateStr);

      if (soumissionDate) {
        const dateKey = getDateKey(soumissionDate);

        // Comparer les cl√©s de date (YYYY-MM-DD) au lieu des objets Date
        if (dateKey >= weekStartKey && dateKey <= weekEndKey) {
          // Parser le prix
          let prix = 0;
          const prixStr = soumission.prix || soumission.montant || '0';
          const prixClean = prixStr.toString().replace(/\s/g, '').replace('$', '').replace(',', '.');
          try {
            prix = parseFloat(prixClean) || 0;
          } catch {
            prix = 0;
          }

          console.log('[RPO DAILY] Soumission matched:', dateKey, prix + '$', 'from:', dateStr);

          // Ajouter au total du jour
          if (!dailyAmounts[dateKey]) {
            dailyAmounts[dateKey] = 0;
          }
          dailyAmounts[dateKey] += prix;
        }
      } else {
        console.warn('[RPO DAILY] Could not parse date:', dateStr, 'for soumission', idx);
      }
    });

    console.log('[RPO DAILY] Daily amounts:', dailyAmounts);

    // G√©n√©rer les 7 jours de la semaine avec leurs montants r√©els
    const dailyData = [];
    for (let i = 0; i < 7; i++) {
      const currentDay = new Date(selectedWeek.weekStart);
      currentDay.setDate(currentDay.getDate() + i);
      currentDay.setHours(0, 0, 0, 0);
      const dateKey = getDateKey(currentDay);

      dailyData.push({
        date: currentDay,
        value: dailyAmounts[dateKey] || 0
      });
    }

    // Vider le conteneur
    container.innerHTML = '';

    // Trouver la valeur maximale
    const maxValue = Math.max(...dailyData.map(d => d.value), 1);

    // Cr√©er les barres quotidiennes
    dailyData.forEach((data, i) => {
      const maxHeight = 160;
      const height = maxValue > 0 ? (data.value / maxValue) * maxHeight : 5;

      const bar = document.createElement('div');
      bar.className = 'chart-bar';
      bar.style.height = `${Math.max(height, 5)}px`;

      const formattedValue = data.value > 0 ? Math.round(data.value).toLocaleString('fr-CA') + ' $' : '';

      // Formater la date avec le nom du mois
      const monthNames = ['jan', 'f√©v', 'mar', 'avr', 'mai', 'juin', 'juil', 'ao√ªt', 'sep', 'oct', 'nov', 'd√©c'];
      const day = data.date.getDate();
      const monthName = monthNames[data.date.getMonth()];

      bar.innerHTML = `
        <div class="chart-bar-value">${formattedValue}</div>
        <div class="chart-bar-label">${day} ${monthName}</div>
      `;

      container.appendChild(bar);
    });

  } catch (error) {
    console.error('[RPO DAILY] Erreur chargement soumissions sign√©es:', error);
    container.innerHTML = '<p style="color: var(--text-gray); text-align: center; margin: auto;">Erreur chargement des donn√©es: ' + error.message + '</p>';
  }
}

// Mettre √† jour la ligne d'objectif dans le graphique
function updateObjectifLine(objectifCA) {
  const objectifLine = document.getElementById('objectifLine');
  const objectifLineText = document.getElementById('objectifLineText');

  if (!objectifLine || !objectifLineText) return;

  // Si objectif est 0 ou n√©gatif, cacher la ligne
  if (objectifCA <= 0) {
    objectifLine.style.display = 'none';
    objectifLineText.style.display = 'none';
    return;
  }

  // Afficher la ligne si elle √©tait cach√©e
  objectifLine.style.display = 'block';
  objectifLineText.style.display = 'block';

  // Calculer la position Y de la ligne en fonction de l'objectif
  // Le graphique va de 0 √† max(objectifCA, max des valeurs mensuelles)
  // y=150 = 0$, y=10 = valeur max
  const graphHeight = 140; // de y=10 √† y=150
  const graphBottom = 150;
  const graphTop = 10;

  // Trouver la valeur maximale entre l'objectif et les donn√©es
  let maxValue = objectifCA;

  // Ajouter 10% de marge au-dessus pour que la ligne ne soit pas tout en haut
  maxValue = maxValue * 1.1;

  // Calculer la position Y (inverser car y=150 est le bas)
  const yPosition = graphBottom - ((objectifCA / maxValue) * graphHeight);

  // Mettre √† jour les positions de la ligne
  objectifLine.setAttribute('y1', yPosition);
  objectifLine.setAttribute('y2', yPosition);
  objectifLineText.setAttribute('y', yPosition + 5);

  // Formater le montant pour l'affichage (ex: 1000000 -> 1M$)
  let displayText = '';
  if (objectifCA >= 1000000) {
    displayText = (objectifCA / 1000000).toFixed(1).replace('.0', '') + 'M$';
  } else if (objectifCA >= 1000) {
    displayText = Math.round(objectifCA / 1000) + 'K$';
  } else {
    displayText = objectifCA + '$';
  }

  // Mettre √† jour le texte
  objectifLineText.textContent = displayText;
}

// Calculate all percentages on page load
document.addEventListener('DOMContentLoaded', () => {
  const metrics = ['hrpap', 'estimation', 'contract', 'dollar', 'mktg', 'vente', 'moyen', 'tendance'];
  metrics.forEach(metric => calculatePercentage(metric));
  calculateObjectifCAProgress();
});

// Calculer automatiquement les champs vis√©s li√©s
function autoCalculateViseFields(changedFieldId) {
  // Ne pas recalculer si on est en mode readonly
  const hrpapInput = document.getElementById('hrpap-vise');
  if (hrpapInput.hasAttribute('readonly')) return;

  // R√©cup√©rer toutes les valeurs actuelles
  const hrpap = parseFloat(document.getElementById('hrpap-vise')?.dataset.value) || 0;
  const estimation = parseFloat(document.getElementById('estimation-vise')?.dataset.value) || 0;
  const contract = parseFloat(document.getElementById('contract-vise')?.dataset.value) || 0;
  const dollar = parseFloat(document.getElementById('dollar-vise')?.dataset.value) || 0;
  const mktg = parseFloat(document.getElementById('mktg-vise')?.dataset.value) || 0;
  const vente = parseFloat(document.getElementById('vente-vise')?.dataset.value) || 0;
  const moyen = parseFloat(document.getElementById('moyen-vise')?.dataset.value) || 0;

  log('üîÑ Auto-calcul depuis:', changedFieldId);

  // Logique de calcul bas√©e sur le champ modifi√©
  switch(changedFieldId) {
    case 'hrpap-vise':
      // Recalculer taux mktg
      if (hrpap > 0 && estimation > 0) {
        const newMktg = (estimation / hrpap) * 100;
        updateViseField('mktg-vise', newMktg, '%');
      }
      break;

    case 'estimation-vise':
      // Recalculer taux mktg
      if (hrpap > 0 && estimation > 0) {
        const newMktg = (estimation / hrpap) * 100;
        updateViseField('mktg-vise', newMktg, '%');
      }
      // Recalculer taux de vente
      if (estimation > 0 && contract > 0) {
        const newVente = (contract / estimation) * 100;
        updateViseField('vente-vise', newVente, '%');
      }
      break;

    case 'mktg-vise':
      // Ajuster estimation en fonction du taux mktg
      if (hrpap > 0 && mktg > 0) {
        const newEstimation = (mktg / 100) * hrpap;
        updateViseField('estimation-vise', newEstimation, '');
      }
      break;

    case 'contract-vise':
      // Recalculer taux de vente et contrat moyen
      if (estimation > 0) {
        const newVente = (contract / estimation) * 100;
        updateViseField('vente-vise', newVente, '%');
      }
      if (contract > 0 && dollar > 0) {
        const newMoyen = dollar / contract;
        updateViseField('moyen-vise', newMoyen, '$');
      }
      break;

    case 'vente-vise':
      // Ajuster contrat en fonction du taux de vente
      if (estimation > 0 && vente > 0) {
        const newContract = (vente / 100) * estimation;
        updateViseField('contract-vise', newContract, '');
        // Recalculer contrat moyen aussi
        if (newContract > 0 && dollar > 0) {
          const newMoyen = dollar / newContract;
          updateViseField('moyen-vise', newMoyen, '$');
        }
      }
      break;

    case 'dollar-vise':
      // Recalculer contrat moyen
      if (contract > 0) {
        const newMoyen = dollar / contract;
        updateViseField('moyen-vise', newMoyen, '$');
      }
      break;

    case 'moyen-vise':
      // Ajuster dollar en fonction du contrat moyen
      if (contract > 0 && moyen > 0) {
        const newDollar = moyen * contract;
        updateViseField('dollar-vise', newDollar, '$');
      }
      break;
  }
}

// Mettre √† jour un champ vis√© avec formatage
function updateViseField(fieldId, value, suffix) {
  const input = document.getElementById(fieldId);
  if (!input) return;

  // Arrondir les valeurs $ pour √©viter les d√©cimales
  if (suffix === '$') {
    value = Math.round(value);
  }

  // Mettre √† jour dataset.value
  input.dataset.value = value;

  // Formater l'affichage selon le type
  if (suffix === '%') {
    input.value = value.toFixed(1) + '%';
  } else if (suffix === '$') {
    input.value = value.toLocaleString('fr-CA') + ' $';
  } else if (suffix === 'h') {
    input.value = value.toFixed(1) + ' h';
  } else {
    input.value = Math.round(value);
  }

  log(`[OK] ${fieldId} mis √† jour:`, input.value);
}

// Calculer les champs vis√©s au chargement initial
function calculateInitialViseFields() {
  const hrpap = parseFloat(document.getElementById('hrpap-vise')?.dataset.value) || 0;
  const estimation = parseFloat(document.getElementById('estimation-vise')?.dataset.value) || 0;
  const contract = parseFloat(document.getElementById('contract-vise')?.dataset.value) || 0;
  const dollar = parseFloat(document.getElementById('dollar-vise')?.dataset.value) || 0;

  log('üî¢ Calcul initial des champs vis√©s:', { hrpap, estimation, contract, dollar });

  // Calculer taux mktg vis√© si les donn√©es de base existent
  if (hrpap > 0 && estimation > 0) {
    const mktg = (estimation / hrpap) * 100;
    updateViseField('mktg-vise', mktg, '%');
  }

  // Calculer taux de vente vis√©
  if (estimation > 0 && contract > 0) {
    const vente = (contract / estimation) * 100;
    updateViseField('vente-vise', vente, '%');
  }

  // Calculer contrat moyen vis√©
  if (contract > 0 && dollar > 0) {
    const moyen = dollar / contract;
    updateViseField('moyen-vise', moyen, '$');
  }

  log('[OK] Calculs initiaux termin√©s');
}

// Toggle edit mode for all metrics (sauf tendance-vise qui est li√© √† Objectif CA)
function toggleEditAllMetrics() {
  const inputs = [
    document.getElementById('hrpap-vise'),
    document.getElementById('estimation-vise'),
    document.getElementById('contract-vise'),
    document.getElementById('dollar-vise'),
    document.getElementById('mktg-vise'),
    document.getElementById('vente-vise'),
    document.getElementById('moyen-vise')
  ];

  const editBtn = document.getElementById('editMetricsBtn');
  const saveBtn = document.getElementById('saveMetricsBtn');
  const isReadonly = inputs[0].hasAttribute('readonly');

  inputs.forEach(input => {
    if (isReadonly) {
      input.removeAttribute('readonly');
      input.style.background = 'rgba(96, 165, 250, 0.1)';
      input.style.borderBottom = '2px solid var(--primary-blue)';
      input.style.color = 'var(--primary-blue)';
      input.style.padding = '4px 8px';
      input.style.borderRadius = '4px';

      // Ajouter event listener pour calculs automatiques
      input.addEventListener('input', function() {
        // Mettre √† jour dataset.value en temps r√©el
        const cleanValue = this.value.replace(/[^\d.-]/g, '');
        this.dataset.value = cleanValue || '0';
        // Recalculer les champs li√©s
        autoCalculateViseFields(this.id);
      });

      // V√©rifier si la valeur est par d√©faut (0)
      const currentValue = input.value.trim();
      const parsedValue = parseFloat(currentValue.replace(/[^\d.-]/g, '')) || 0;
      if (parsedValue === 0) {
        // Valeur par d√©faut: mettre en placeholder et vider
        input.placeholder = currentValue;
        input.value = '';
      } else {
        // Valeur saisie: afficher la valeur num√©rique brute
        input.value = String(parsedValue);
        input.placeholder = '';
      }
    } else {
      // Nettoyer les event listeners en clonant le node
      const newInput = input.cloneNode(true);
      input.parentNode.replaceChild(newInput, input);

      newInput.setAttribute('readonly', 'true');
      newInput.style.background = 'transparent';
      newInput.style.borderBottom = 'none';
      newInput.style.color = 'var(--primary-blue)';
      newInput.style.padding = '0';
      newInput.style.borderRadius = '0';
      newInput.placeholder = '';
    }
  });

  // Toggle button visibility
  if (isReadonly) {
    editBtn.classList.add('hidden');
    saveBtn.classList.remove('hidden');
  } else {
    editBtn.classList.remove('hidden');
    saveBtn.classList.add('hidden');
  }
}

async function saveMetrics() {
  const saveBtn = document.getElementById('saveMetricsBtn');
  const originalHTML = saveBtn.innerHTML;

  // Afficher le spinner
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i><span class="text-xs font-semibold">Enregistrement...</span>';
  saveBtn.disabled = true;
  saveBtn.style.cursor = 'not-allowed';
  saveBtn.style.opacity = '0.7';

  try {
    // Formater les inputs avant de sauvegarder (sauf tendance-vise qui est synchronis√© avec Objectif CA)
    formatMetricInput('hrpap-vise', 'h');
    formatMetricInput('estimation-vise', '');
    formatMetricInput('contract-vise', '');
    formatMetricInput('dollar-vise', '$');
    formatMetricInput('moyen-vise', '$');
    formatMetricInput('mktg-vise', '%');
    formatMetricInput('vente-vise', '%');

    toggleEditAllMetrics();
    // Recalculer tous les pourcentages apr√®s sauvegarde
    const metrics = ['hrpap', 'estimation', 'contract', 'dollar', 'mktg', 'vente', 'moyen', 'tendance'];
    metrics.forEach(metric => calculatePercentage(metric));

    // Recalculer le pourcentage de progression de l'objectif CA
    calculateObjectifCAProgress();

    // Sauvegarder les donn√©es annuelles
    await saveAnnualData();

    // R√©g√©n√©rer le plan d'affaire avec animation
    await reloadPlanWithAnimation();
  } finally {
    // Restaurer le bouton
    saveBtn.innerHTML = originalHTML;
    saveBtn.disabled = false;
    saveBtn.style.cursor = '';
    saveBtn.style.opacity = '';
  }
}

// Formater les inputs de m√©triques ($ ou h)
function formatMetricInput(inputId, suffix) {
  // Accepter soit un ID string, soit un √©l√©ment DOM
  const input = typeof inputId === 'string' ? document.getElementById(inputId) : inputId;
  if (!input) return;

  let value = input.value.trim();

  // Si vide, utiliser le placeholder
  if (value === '' && input.placeholder) {
    value = input.placeholder;
  }

  // Si pas de suffix fourni, essayer de le d√©tecter depuis la valeur actuelle
  if (!suffix) {
    if (value.includes('$')) suffix = '$';
    else if (value.includes('%')) suffix = '%';
    else if (value.includes('h')) suffix = 'h';
  }

  // Retirer tous les caract√®res non num√©riques sauf les espaces, points et virgules
  value = value.replace(/[^\d\s.,]/g, '');
  value = value.replace(/\s+/g, '');
  value = value.replace(',', '.');

  // Convertir en nombre (float pour $ qui peut avoir des d√©cimales)
  let number = parseFloat(value);

  if (!isNaN(number)) {
    // Pour les dollars, arrondir sans d√©cimales
    if (suffix === '$') {
      const intNumber = Math.round(number);
      const formatted = intNumber.toLocaleString('fr-CA').replace(/\s/g, ' ');
      input.value = formatted + ' ' + suffix;
      input.dataset.value = intNumber;
    } else {
      // Pour les heures et autres, utiliser des entiers
      const intNumber = Math.round(number);
      const formatted = intNumber.toLocaleString('fr-CA').replace(/,/g, ' ');
      // N'ajouter un espace que s'il y a un suffixe
      input.value = suffix ? formatted + ' ' + suffix : formatted;
      input.dataset.value = intNumber;
    }
  } else {
    // N'ajouter un espace que s'il y a un suffixe
    input.value = suffix ? '0 ' + suffix : '0';
    input.dataset.value = 0;
  }
}

// Fonction sp√©ciale pour formater le ratio marketing en d√©cimal
function formatRatioMktgInput(inputId) {
  const input = typeof inputId === 'string' ? document.getElementById(inputId) : inputId;
  if (!input) return;

  let value = input.value.trim();

  // Retirer tous les caract√®res non num√©riques sauf les points et virgules
  value = value.replace(/[^\d.,]/g, '');
  value = value.replace(',', '.');

  let number = parseFloat(value);

  if (!isNaN(number)) {
    // Si la valeur est > 1, c'est un pourcentage qu'on doit convertir
    // Ex: 85 -> 0.85, ou 0.85 reste 0.85
    if (number > 1) {
      // C'est un pourcentage, stocker tel quel dans dataset.value
      input.dataset.value = Math.round(number);
      input.value = (number / 100).toFixed(2);
    } else {
      // C'est d√©j√† un d√©cimal, stocker en pourcentage dans dataset.value
      input.dataset.value = Math.round(number * 100);
      input.value = number.toFixed(2);
    }
  } else {
    input.value = '0.85';
    input.dataset.value = 85;
  }
}

// Toggle edit mode pour Janvier
function toggleEditJan() {
  // obj-pap et obj-rep sont EXCLUS - ils ne sont jamais modifiables (d√©finis par le coach)
  const inputs = [
    document.getElementById('jan-hrpap-vise'),
    document.getElementById('jan-estimation-vise'),
    document.getElementById('jan-contract-vise'),
    document.getElementById('jan-dollar-vise')
  ];

  const editBtn = document.getElementById('editJanBtn');
  const saveBtn = document.getElementById('saveJanBtn');
  const isReadonly = inputs[0].hasAttribute('readonly');

  inputs.forEach(input => {
    if (isReadonly) {
      input.removeAttribute('readonly');
      input.style.background = 'rgba(96, 165, 250, 0.1)';
      input.style.borderBottom = '2px solid var(--primary-blue)';
      input.style.color = 'var(--primary-blue)';
      input.style.padding = '4px 8px';
      input.style.borderRadius = '4px';

      // V√©rifier si la valeur est par d√©faut (0)
      const currentValue = input.value.trim();
      const parsedValue = parseFloat(currentValue.replace(/[^\d.-]/g, '')) || 0;
      if (parsedValue === 0) {
        // Valeur par d√©faut: mettre en placeholder et vider
        input.placeholder = currentValue;
        input.value = '';
      } else {
        // Valeur saisie: afficher la valeur num√©rique brute
        input.value = String(parsedValue);
        input.placeholder = '';
      }
    } else {
      input.setAttribute('readonly', 'true');
      input.style.background = 'transparent';
      input.style.borderBottom = 'none';
      const inputId = input.id;
      // Objectifs Coach (violet)
      if (inputId.endsWith('-obj-pap') || inputId.endsWith('-obj-rep')) {
        input.style.color = 'rgba(139, 92, 246, 0.8)';
      } else {
        input.style.color = 'var(--text-gray)';
      }
      input.style.padding = '0';
      input.style.borderRadius = '0';
      input.placeholder = '';
    }
  });

  // Toggle button visibility
  if (isReadonly) {
    editBtn.classList.add('hidden');
    saveBtn.classList.remove('hidden');
  } else {
    editBtn.classList.remove('hidden');
    saveBtn.classList.add('hidden');
  }
}

async function saveJan() {
  const saveBtn = document.getElementById('saveJanBtn');
  const originalHTML = saveBtn.innerHTML;

  // Afficher le spinner
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i><span class="text-xs font-semibold">Enregistrement...</span>';
  saveBtn.disabled = true;
  saveBtn.style.cursor = 'not-allowed';
  saveBtn.style.opacity = '0.7';

  try {
    // Formater les inputs avant de sauvegarder
    // Note: obj-pap et obj-rep ne sont pas format√©s car ils ne sont jamais modifiables (d√©finis par le coach)
    formatMetricInput('jan-hrpap-vise', 'h');
    formatMetricInput('jan-dollar-vise', '$');

    toggleEditJan();
  } finally {
    // Restaurer le bouton
    setTimeout(() => {
      saveBtn.innerHTML = originalHTML;
      saveBtn.disabled = false;
      saveBtn.style.cursor = '';
      saveBtn.style.opacity = '';
    }, 300);
  }
  // Recalculer tous les pourcentages apr√®s sauvegarde
  calculateMonthPercentage('jan', 'hrpap');
  calculateMonthPercentage('jan', 'estimation');
  calculateMonthPercentage('jan', 'contract');
  calculateMonthPercentage('jan', 'dollar');

  // Refresh weekly tables if January is currently displayed
  if (currentWeeklyMonthIndex === 0) {
    refreshWeeklyTables();
  }
}

// Toggle edit mode for weekly January data
function toggleEditWeekJan() {
  const inputs = document.querySelectorAll('.week-jan-input, .week-jan-resume, .rpo-objective-input');
  const editBtn = document.getElementById('editWeekJanBtn');
  const saveBtn = document.getElementById('saveWeekJanBtn');
  const isReadonly = inputs[0].hasAttribute('readonly');

  inputs.forEach(input => {
    // Les champs estimation, contract et dollar (r√©els) sont automatiques - toujours readonly
    const field = input.dataset.field;
    const isAutoField = field === 'estimation' || field === 'contract' || field === 'dollar';
    // Les objectifs (colonnes grises) sont maintenant √©ditables
    const isObjectiveField = input.classList.contains('rpo-objective-input');

    if (isReadonly) {
      // En mode √©dition: h_marketing, prod_horaire, probleme, focus, et TOUS les objectifs sont √©ditables
      if (!isAutoField || isObjectiveField) {
        input.removeAttribute('readonly');
        input.style.color = 'var(--primary-blue)';
        input.style.outline = 'none';
        input.style.background = 'rgba(96, 165, 250, 0.1)';
        input.style.border = 'none';
        input.style.borderBottom = '2px solid var(--primary-blue)';
        input.style.padding = '4px 8px';
        input.style.borderRadius = '4px';
        input.style.cursor = 'text';
        input.style.pointerEvents = 'auto';
      }
    } else {
      input.setAttribute('readonly', 'true');

      // Pour les objectifs, utiliser setProperty avec !important pour forcer les styles
      if (isObjectiveField) {
        input.style.setProperty('cursor', 'not-allowed', 'important');
        input.style.setProperty('background-color', 'transparent', 'important');
        input.style.setProperty('color', '#9ca3af', 'important');
        input.style.setProperty('text-align', 'center', 'important');
        input.style.setProperty('border', 'none', 'important');
        input.style.setProperty('border-bottom', 'none', 'important');
        input.style.setProperty('outline', 'none', 'important');
        input.style.setProperty('pointer-events', 'none', 'important');
        input.style.padding = '';
        input.style.borderRadius = '';
      } else {
        input.style.background = 'transparent';
        input.style.borderBottom = 'none';
        input.style.border = 'none';
        input.style.color = 'var(--text-light)';
        input.style.padding = '';
        input.style.borderRadius = '';
        input.style.outline = 'none';

        // Remettre les styles non-cliquables en mode readonly
        if (!isAutoField) {
          input.style.cursor = 'not-allowed';
          input.style.pointerEvents = 'none';
        }
      }
    }
  });

  // G√©rer les lignes du tableau R√©sum√© (en mode √©dition, clic sur ligne enti√®re)
  const resumeTable = document.getElementById('resumeTable');
  if (resumeTable) {
    const resumeRows = resumeTable.querySelectorAll('tbody tr[data-week]');
    resumeRows.forEach(row => {
      const weekNumber = row.dataset.week;

      if (isReadonly) {
        // Mode √©dition: rendre la ligne enti√®re cliquable pour ouvrir le popup
        row.style.cursor = 'pointer';
        row.style.transition = 'background-color 0.2s ease';
        row.onmouseenter = () => { row.style.backgroundColor = 'rgba(96, 165, 250, 0.1)'; };
        row.onmouseleave = () => { row.style.backgroundColor = ''; };
        row.onclick = (e) => {
          // Ne pas ouvrir si on clique sur un input ou autre √©l√©ment interactif
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
          openWeeklyRowEditPopup(parseInt(weekNumber));
        };
        row.title = 'Cliquer pour modifier cette semaine';
      } else {
        // Mode lecture: d√©sactiver le clic sur la ligne
        row.style.cursor = 'default';
        row.onmouseenter = null;
        row.onmouseleave = null;
        row.onclick = null;
        row.title = '';
        row.style.backgroundColor = '';
      }
    });
  }

  // G√©rer les √©toiles (les montrer/cacher et d√©sactiver en mode √©dition car on utilise le popup de ligne)
  const starContainers = document.querySelectorAll('.star-container');
  starContainers.forEach(container => {
    const dashSpan = container.querySelector('span');
    const starsGroup = container.querySelector('.star-rating-group');
    const stars = container.querySelectorAll('.star-rating');

    if (isReadonly) {
      // Passage en mode √©dition: montrer TOUTES les √©toiles, cacher tous les "-"
      // MAIS d√©sactiver les clics individuels car on utilise le popup de ligne
      if (dashSpan) dashSpan.classList.add('hidden');
      if (starsGroup) starsGroup.classList.remove('hidden');
      stars.forEach(star => {
        star.style.pointerEvents = 'none'; // D√©sactiv√© car on utilise le popup de ligne
        star.style.cursor = 'pointer'; // Cursor pointer pour indiquer que la ligne est cliquable
      });
    } else {
      // Passage en mode lecture: d√©sactiver les √©toiles
      stars.forEach(star => {
        star.style.pointerEvents = 'none';
        star.style.cursor = 'default';
      });

      // V√©rifier si cette semaine a un rating > 0
      const weekNumber = container.dataset.week;
      const weekData = window.weeklyData?.[String(currentWeeklyMonthIndex)]?.[String(weekNumber)];
      const hasRating = weekData && weekData.rating > 0;

      if (!hasRating) {
        // Pas de rating: remettre le "-" et cacher les √©toiles
        if (dashSpan) dashSpan.classList.remove('hidden');
        if (starsGroup) starsGroup.classList.add('hidden');
      }
      // Si hasRating, garder les √©toiles visibles (ne rien changer)
    }
  });

  // G√©rer les cellules d'analyse hebdomadaire (probleme et focus)
  // En mode √©dition: d√©sactiv√© car on utilise le popup de ligne
  const analysisCells = document.querySelectorAll('.week-analysis-cell');
  analysisCells.forEach(cell => {
    const editIcon = cell.querySelector('.week-edit-icon');
    const weekNumber = cell.dataset.week;
    const field = cell.dataset.field;

    if (isReadonly) {
      // Mode √©dition: d√©sactiver le clic individuel, on utilise le clic sur la ligne
      cell.onclick = null;
      cell.style.cursor = 'pointer'; // Cursor pointer pour indiquer que la ligne est cliquable
      cell.classList.remove('hover:bg-opacity-20', 'transition-all');
      cell.title = '';
      if (editIcon) editIcon.style.display = 'none';
    } else {
      // Mode lecture: ouvrir popup de lecture seule (voir le texte complet), cacher l'ic√¥ne d'√©dition
      const textSpan = cell.querySelector('.week-analysis-text');
      const hasText = textSpan && textSpan.getAttribute('data-full-text') && textSpan.getAttribute('data-full-text') !== '-';

      if (hasText) {
        // Si du texte existe, permettre de cliquer pour le voir
        cell.onclick = () => openWeeklyAnalysisViewPopup(parseInt(weekNumber), field);
        cell.style.cursor = 'pointer';
        cell.classList.add('hover:bg-opacity-20', 'transition-all');
        cell.title = 'Cliquer pour voir le texte complet';
      } else {
        // Pas de texte, d√©sactiver le clic
        cell.onclick = null;
        cell.style.cursor = 'default';
        cell.classList.remove('hover:bg-opacity-20', 'transition-all');
        cell.title = '';
      }

      if (editIcon) editIcon.style.display = 'none';
    }
  });

  if (isReadonly) {
    editBtn.classList.add('hidden');
    saveBtn.classList.remove('hidden');

    // Add input event listeners to update dataset.value for objective inputs
    const objectiveInputs = document.querySelectorAll('.rpo-objective-input');
    objectiveInputs.forEach(input => {
      input.addEventListener('input', function() {
        let value = this.value.trim();

        // Remove formatting characters to get numeric value
        value = value.replace(/[^\d.,]/g, '').replace(',', '.');

        const numericValue = parseFloat(value);
        if (!isNaN(numericValue)) {
          this.dataset.value = numericValue;
        } else {
          this.dataset.value = '0';
        }
      });
    });
  } else {
    editBtn.classList.remove('hidden');
    saveBtn.classList.add('hidden');
  }

  // Rafra√Æchir la vue mobile pour afficher/cacher les √©toiles selon le mode
  if (window.innerWidth <= 600 && typeof updateMobileWeeklyView === 'function') {
    updateMobileWeeklyView(currentMobileWeek || 1);
  }

  // Note: initStarRatings() n'est plus appel√© car on utilise le popup de ligne pour l'√©dition
}

// Save weekly January data
async function saveWeekJan() {
  // Valider que les objectifs n'ont pas de valeur 0
  const objectiveInputs = document.querySelectorAll('input[data-field$="_obj"]');
  const invalidInputs = [];

  objectiveInputs.forEach(input => {
    const value = parseFloat(input.dataset.value);
    // V√©rifier si la valeur est exactement 0 (pas 0.3, 10, etc.)
    if (value === 0 && input.value.trim() !== '' && input.value.trim() !== '-') {
      // V√©rifier que l'utilisateur a vraiment tap√© 0 (pas juste un champ vide)
      const rawValue = input.value.replace(/\s/g, '').replace(/\$/g, '').replace(/h/g, '').replace(/,/g, '.');
      if (rawValue === '0') {
        invalidInputs.push(input);
      }
    }
  });

  // Si des valeurs 0 sont d√©tect√©es, bloquer l'enregistrement
  if (invalidInputs.length > 0) {
    console.log(`[SAVE] Bloqu√© - ${invalidInputs.length} champ(s) avec valeur 0`);

    // Faire les champs invalides en rouge pendant 2 secondes
    invalidInputs.forEach(input => {
      // Sauvegarder le cssText original
      const originalCssText = input.style.cssText;

      // Appliquer les styles avec !important pour forcer l'affichage
      input.style.cssText = `
        background: rgba(220, 38, 38, 0.35) !important;
        color: #dc2626 !important;
        border: 3px solid #dc2626 !important;
        border-radius: 12px !important;
        box-shadow: 0 0 10px rgba(220, 38, 38, 0.5) !important;
        animation: pulse-red 0.3s ease-in-out 3 !important;
      `;

      setTimeout(() => {
        input.style.cssText = originalCssText;
      }, 2000);
    });

    // Shake le bouton enregistrer
    shakeSaveButton();

    return; // Ne pas sauvegarder
  }

  // Sauvegarder toutes les semaines visibles AVANT de sortir du mode √©dition
  const weekInputs = document.querySelectorAll('.week-jan-input[data-week]');
  const savedWeeks = new Set();

  for (const input of weekInputs) {
    const weekNumber = parseInt(input.dataset.week);
    if (!savedWeeks.has(weekNumber)) {
      await saveWeeklyDataToBackend(currentWeeklyMonthIndex, weekNumber);
      savedWeeks.add(weekNumber);
    }
  }

  // Sortir du mode √©dition APR√àS que les donn√©es soient sauvegard√©es
  toggleEditWeekJan();

  // Recharger les donn√©es pour appliquer le formatage correct
  await loadWeeklyDataForMonth(currentWeeklyMonthIndex);

  // NE PAS r√©g√©n√©rer le plan ici! Cela √©craserait les modifications manuelles (obj_modifier)
  // Le plan doit seulement √™tre r√©g√©n√©r√© quand l'Objectif CA change dans le Plan d'Affaires
  console.log('[SAVE] Donn√©es hebdomadaires sauvegard√©es et recharg√©es');
}

// Initialiser les lignes du tableau R√©sum√© comme cliquables (toujours en mode √©dition)
function initResumeTableRowClicks() {
  const resumeTable = document.getElementById('resumeTable');
  if (!resumeTable) return;

  const resumeRows = resumeTable.querySelectorAll('tbody tr[data-week]');
  resumeRows.forEach(row => {
    const weekNumber = row.dataset.week;

    // Rendre la ligne cliquable pour ouvrir le popup
    row.style.cursor = 'pointer';
    row.style.transition = 'background-color 0.2s ease';
    row.onmouseenter = () => { row.style.backgroundColor = 'rgba(96, 165, 250, 0.1)'; };
    row.onmouseleave = () => { row.style.backgroundColor = ''; };
    row.onclick = (e) => {
      // Ne pas ouvrir si on clique sur un input ou autre √©l√©ment interactif
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      openWeeklyRowEditPopup(parseInt(weekNumber));
    };
    row.title = 'Cliquer pour modifier cette semaine';
  });

  // Configurer les √©toiles (afficher, cursor pointer, mais pas de clic individuel)
  const starContainers = document.querySelectorAll('.star-container');
  starContainers.forEach(container => {
    const dashSpan = container.querySelector('span');
    const starsGroup = container.querySelector('.star-rating-group');
    const stars = container.querySelectorAll('.star-rating');
    const weekNumber = container.dataset.week;
    const weekData = window.weeklyData?.[String(currentWeeklyMonthIndex)]?.[String(weekNumber)];
    const hasRating = weekData && weekData.rating > 0;

    // Toujours montrer les √©toiles (ou le dash si pas de rating)
    if (hasRating) {
      if (dashSpan) dashSpan.classList.add('hidden');
      if (starsGroup) starsGroup.classList.remove('hidden');
    } else {
      if (dashSpan) dashSpan.classList.remove('hidden');
      if (starsGroup) starsGroup.classList.add('hidden');
    }

    stars.forEach(star => {
      star.style.pointerEvents = 'none';
      star.style.cursor = 'pointer';
    });
  });

  // Configurer les cellules d'analyse (cursor pointer, pas de clic individuel)
  const analysisCells = document.querySelectorAll('.week-analysis-cell');
  analysisCells.forEach(cell => {
    const editIcon = cell.querySelector('.week-edit-icon');
    cell.onclick = null;
    cell.style.cursor = 'pointer';
    cell.classList.remove('hover:bg-opacity-20', 'transition-all');
    cell.title = '';
    if (editIcon) editIcon.style.display = 'none';
  });

  console.log('[RESUME TABLE] Lignes initialis√©es comme cliquables');
}

// Show objectifs table
function showObjectifs() {
  document.getElementById('objectifsTable').classList.remove('hidden');
  document.getElementById('resumeTable').classList.add('hidden');

  // Afficher les boutons Modifier/Enregistrer pour Objectifs
  const buttonsContainer = document.getElementById('objectifsButtonsContainer');
  if (buttonsContainer) buttonsContainer.style.display = 'flex';

  // Mobile: afficher objectifs, cacher r√©sum√© (seulement si viewport mobile)
  if (window.innerWidth <= 600) {
    const mobileObjectifs = document.getElementById('mobileWeeklyObjectifs');
    const mobileResume = document.getElementById('mobileWeeklyResume');
    if (mobileObjectifs) {
      mobileObjectifs.style.setProperty('display', 'block', 'important');
    }
    if (mobileResume) {
      mobileResume.style.setProperty('display', 'none', 'important');
    }
  }

  document.getElementById('objectifsBtn').className = 'btn-primary';
  document.getElementById('resumeBtn').className = 'btn-secondary';
}

// Show resume table
function showResume() {
  document.getElementById('objectifsTable').classList.add('hidden');
  document.getElementById('resumeTable').classList.remove('hidden');

  // Cacher les boutons Modifier/Enregistrer (pas besoin pour R√©sum√©, on clique sur les lignes)
  const buttonsContainer = document.getElementById('objectifsButtonsContainer');
  if (buttonsContainer) buttonsContainer.style.display = 'none';

  // Mobile: cacher objectifs, afficher r√©sum√© (seulement si viewport mobile)
  if (window.innerWidth <= 600) {
    const mobileObjectifs = document.getElementById('mobileWeeklyObjectifs');
    const mobileResume = document.getElementById('mobileWeeklyResume');
    if (mobileObjectifs) {
      mobileObjectifs.style.setProperty('display', 'none', 'important');
    }
    if (mobileResume) {
      mobileResume.style.setProperty('display', 'block', 'important');
    }
  }

  document.getElementById('resumeBtn').className = 'btn-primary';
  document.getElementById('objectifsBtn').className = 'btn-secondary';

  // Initialiser les lignes comme cliquables
  initResumeTableRowClicks();
}

// Get objectif labels based on month
function getObjectifLabel1(monthIndex) {
  const labels = [
    'HEURES P√ÄP',           // Janvier (0)
    'HEURES P√ÄP',           // F√©vrier (1)
    'Estimations',          // Mars (2)
    'Ventes',               // Avril (3)
    'Ventes',               // Mai (4)
    'Ventes',               // Juin (5)
    'Ventes',               // Juillet (6)
    'Ventes',               // Ao√ªt (7)
    '$ Produit',            // Septembre (8)
    'HEURES P√ÄP',           // Octobre (9)
    'HEURES P√ÄP',           // Novembre (10)
    'HEURES P√ÄP'            // D√©cembre (11)
  ];
  return labels[monthIndex];
}

function getObjectifLabel2(monthIndex) {
  const labels = [
    'HEURES P√ÄP (REP)',     // Janvier (0)
    'Estimations',          // F√©vrier (1)
    'Ventes',               // Mars (2)
    'Peintres',             // Avril (3)
    'Prod Horaire',         // Mai (4)
    'Prod Horaire',         // Juin (5)
    '$ Produit',            // Juillet (6)
    '$ Produit',            // Ao√ªt (7)
    '',                     // Septembre (8) - pas de 2e objectif
    '$ Vendus',             // Octobre (9)
    '$ Vendus',             // Novembre (10)
    '$ Vendus'              // D√©cembre (11)
  ];
  return labels[monthIndex];
}

// Global variable to store coach objectives
let coachObjectifsData = {};

// Load coach objectives for the current entrepreneur
async function loadCoachObjectifs() {
  const username = getCurrentUsername();

  try {
    // Get the coach for this entrepreneur
    const coachResponse = await fetch(`/api/entrepreneur/coach?entrepreneur_username=${username}`);
    if (!coachResponse.ok) {
      console.log('[RPO] Pas de coach assign√©');
      return;
    }

    const coachData = await coachResponse.json();
    if (!coachData.success || !coachData.coach_username) {
      console.log('[RPO] Pas de coach assign√©');
      return;
    }

    const coachUsername = coachData.coach_username;
    console.log('[RPO] Coach trouv√©:', coachUsername);

    // Get the coach's monthly objectives
    const objectifsResponse = await fetch(`/api/coach/objectifs-mensuels?coach_username=${coachUsername}`);
    if (!objectifsResponse.ok) {
      console.log('[RPO] Erreur r√©cup√©ration objectifs coach');
      return;
    }

    const objectifsData = await objectifsResponse.json();
    if (objectifsData.success && objectifsData.objectifs) {
      coachObjectifsData = objectifsData.objectifs;
      console.log('[RPO] Objectifs coach charg√©s:', coachObjectifsData);

      // Update the display with loaded coach objectives
      updateMonthlyObjectifsDisplay();
    }

  } catch (error) {
    console.error('[RPO] Erreur chargement objectifs coach:', error);
  }
}

// Update monthly objective displays with loaded coach objectives
function updateMonthlyObjectifsDisplay() {
  const monthAbbrs = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];

  monthAbbrs.forEach((abbr, monthIndex) => {
    const objPapInput = document.getElementById(`${abbr}-obj-pap`);
    const objRepInput = document.getElementById(`${abbr}-obj-rep`);

    if (objPapInput) {
      const value1 = getObjectifDefaultValue1(monthIndex);
      objPapInput.value = value1;
      // Also update data-value if needed (extract numeric value)
      const numericValue1 = parseFloat(value1) || 0;
      objPapInput.setAttribute('data-value', numericValue1);
    }

    if (objRepInput) {
      const value2 = getObjectifDefaultValue2(monthIndex);
      objRepInput.value = value2;
      // Also update data-value if needed (extract numeric value)
      const numericValue2 = parseFloat(value2) || 0;
      objRepInput.setAttribute('data-value', numericValue2);
    }
  });

  console.log('[RPO] Affichage des objectifs coach mis √† jour');
}

// Get default values based on month
function getObjectifDefaultValue1(monthIndex) {
  // D√©cembre 2025 (index -2) utilise les m√™mes valeurs qu'octobre 2026
    // Try to get coach objective for this month
  const username = getCurrentUsername();
  const monthKey = `2026-${String(monthIndex + 1).padStart(2, '0')}`;

  if (coachObjectifsData[monthKey] && coachObjectifsData[monthKey][username]) {
    const objectif = coachObjectifsData[monthKey][username].objectif1;
    if (objectif !== undefined && objectif !== null && objectif !== 0) {
      // Format based on month type
      const defaultValues = [
        '0 h',      // Janvier - HEURES P√ÄP
        '0 h',      // F√©vrier - HEURES P√ÄP
        '0',        // Mars - Estimations
        '0',        // Avril - Ventes
        '0',        // Mai - Ventes
        '0',        // Juin - Ventes
        '0',        // Juillet - Ventes
        '0',        // Ao√ªt - Ventes
        '0,00 $',   // Septembre - $ Produit
        '0 h',      // Octobre - HEURES P√ÄP
        '0 h',      // Novembre - HEURES P√ÄP
        '0 h'       // D√©cembre - HEURES P√ÄP
      ];
      const format = defaultValues[monthIndex];

      if (format.includes('h')) {
        return `${objectif} h`;
      } else if (format.includes('$')) {
        return `${objectif.toFixed(2)} $`;
      } else {
        return String(objectif);
      }
    }
  }

  const values = [
    '0 h',      // Janvier - HEURES P√ÄP
    '0 h',      // F√©vrier - HEURES P√ÄP
    '0',        // Mars - Estimations
    '0',        // Avril - Ventes
    '0',        // Mai - Ventes
    '0',        // Juin - Ventes
    '0',        // Juillet - Ventes
    '0',        // Ao√ªt - Ventes
    '0,00 $',   // Septembre - $ Produit
    '0 h',      // Octobre - HEURES P√ÄP
    '0 h',      // Novembre - HEURES P√ÄP
    '0 h'       // D√©cembre - HEURES P√ÄP
  ];
  return values[monthIndex];
}

function getObjectifDefaultValue2(monthIndex) {
  // D√©cembre 2025 (index -2) utilise les m√™mes valeurs qu'octobre 2026
    // Try to get coach objective for this month
  const username = getCurrentUsername();
  const monthKey = `2026-${String(monthIndex + 1).padStart(2, '0')}`;

  if (coachObjectifsData[monthKey] && coachObjectifsData[monthKey][username]) {
    const objectif = coachObjectifsData[monthKey][username].objectif2;
    if (objectif !== undefined && objectif !== null && objectif !== 0) {
      // Format based on month type
      const defaultValues = [
        '0 h',      // Janvier - HEURES P√ÄP REP
        '0',        // F√©vrier - Estimations
        '0',        // Mars - Ventes
        '0',        // Avril - Peintres
        '0,00 $/h', // Mai - Prod Horaire
        '0,00 $/h', // Juin - Prod Horaire
        '0,00 $',   // Juillet - $ Produit
        '0,00 $',   // Ao√ªt - $ Produit
        '',         // Septembre - pas de 2e objectif
        '0,00 $',   // Octobre - $ Vendus
        '0,00 $',   // Novembre - $ Vendus
        '0,00 $'    // D√©cembre - $ Vendus
      ];
      const format = defaultValues[monthIndex];

      if (format.includes('h') && !format.includes('/h')) {
        return `${objectif} h`;
      } else if (format.includes('$/h')) {
        return `${objectif.toFixed(2)} $/h`;
      } else if (format.includes('$')) {
        return `${objectif.toFixed(2)} $`;
      } else if (format === '') {
        return '';
      } else {
        return String(objectif);
      }
    }
  }

  const values = [
    '0 h',      // Janvier - HEURES P√ÄP REP
    '0',        // F√©vrier - Estimations
    '0',        // Mars - Ventes
    '0',        // Avril - Peintres
    '0,00 $/h', // Mai - Prod Horaire
    '0,00 $/h', // Juin - Prod Horaire
    '0,00 $',   // Juillet - $ Produit
    '0,00 $',   // Ao√ªt - $ Produit
    '',         // Septembre - pas de 2e objectif
    '0,00 $',   // Octobre - $ Vendus
    '0,00 $',   // Novembre - $ Vendus
    '0,00 $'    // D√©cembre - $ Vendus
  ];
  return values[monthIndex];
}

function getObjectifSuffix1(monthIndex) {
  // D√©cembre 2025 (index -2) utilise les m√™mes suffixes qu'octobre 2026
    const suffixes = [
    'h',        // Janvier - Heures PAP
    'h',        // F√©vrier - Heure PAP
    '',         // Mars - Estims
    '',         // Avril - Ventes
    '',         // Mai - Ventes
    '',         // Juin - Ventes
    '',         // Juillet - Ventes
    '',         // Ao√ªt - Ventes
    '$',        // Septembre - $ Produit
    'h',        // Octobre - Heures PAP
    'h',        // Novembre - Heures PAP
    'h'         // D√©cembre - Heures PAP
  ];
  return suffixes[monthIndex];
}

function getObjectifSuffix2(monthIndex) {
  // D√©cembre 2025 (index -2) utilise les m√™mes suffixes qu'octobre 2026
    const suffixes = [
    'h',        // Janvier - Reps
    '',         // F√©vrier - Estims
    '',         // Mars - Ventes
    '',         // Avril - Peintres
    '$/h',      // Mai - Prod Horaire
    '$/h',      // Juin - Prod Horaire
    '$',        // Juillet - $ Produit
    '$',        // Ao√ªt - $ Produit
    '',         // Septembre - pas de 2e objectif
    '$',        // Octobre - $ Vendus
    '$',        // Novembre - $ Vendus
    '$'         // D√©cembre - $ Vendus
  ];
  return suffixes[monthIndex];
}

// Get weeks for a specific month in 2026
function getWeeksForMonth(monthIndex) {
  const weeks = [];

  // D√©terminer l'ann√©e et le mois r√©el selon l'index
  // Janvier-D√©cembre 2026
  let year = 2026;
  let realMonth = monthIndex;

  // Get first day of month
  const firstDay = createTorontoDate(year, realMonth, 1);
  // Get last day of month
  const lastDay = createTorontoDate(year, realMonth + 1, 0);

  // Find the Monday of the week containing the first day
  let currentDate = new Date(firstDay);
  const dayOfWeek = currentDate.getDay();
  const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Adjust to Monday
  currentDate.setDate(currentDate.getDate() + diff);

  // Pour d√©cembre 2025 sp√©cifiquement, commencer au 6 octobre (d√©but du plan)
    // Generate weeks until we pass the last day of the month
  while (currentDate <= lastDay || (currentDate.getMonth() === realMonth)) {
    const weekStart = new Date(currentDate);
    const weekEnd = new Date(currentDate.getTime() + (6 * 24 * 60 * 60 * 1000)); // Sunday

    // NOUVEAU: Une semaine appartient au mois o√π elle COMMENCE (pas o√π elle finit)
    // Cela √©vite qu'une semaine apparaisse dans 2 mois diff√©rents
    const weekBelongsToMonth = (weekStart.getMonth() === realMonth && weekStart.getFullYear() === year);

    if (weekBelongsToMonth) {
      // Utiliser EXACTEMENT la m√™me m√©thode que le plan d'affaires pour g√©n√©rer les labels
      const startDay = weekStart.getDate();
      const endDay = weekEnd.getDate();
      const startMonth = weekStart.toLocaleDateString('fr-FR', { month: 'short' });
      const endMonth = weekEnd.toLocaleDateString('fr-FR', { month: 'short' });

      let dateRangeStr;
      // IMPORTANT: Retirer les points pour coh√©rence avec le plan d'affaires
      if (startMonth === endMonth) {
        dateRangeStr = `${startDay} - ${endDay} ${startMonth.replace('.', '')}`;
      } else {
        dateRangeStr = `${startDay} ${startMonth.replace('.', '')} - ${endDay} ${endMonth.replace('.', '')}`;
      }

      weeks.push({
        label: dateRangeStr,
        weekNumber: weeks.length + 1
      });
    }

    currentDate.setDate(currentDate.getDate() + 7);

    // Break if the week start has completely passed the month
    if (currentDate > lastDay && currentDate.getMonth() > realMonth) break;
  }

  return weeks;
}

// Calculate days in month for a specific week
function getDaysInMonthForWeek(weekStart, weekEnd, monthIndex, year) {
  const monthStart = new Date(year, monthIndex, 1);
  const monthEnd = new Date(year, monthIndex + 1, 0);

  const effectiveStart = weekStart < monthStart ? monthStart : weekStart;
  const effectiveEnd = weekEnd > monthEnd ? monthEnd : weekEnd;

  if (effectiveStart > effectiveEnd) return 0;

  return Math.round((effectiveEnd - effectiveStart) / (1000 * 60 * 60 * 24)) + 1;
}

// R√©cup√©rer les objectifs hebdomadaires depuis le plan d'affaires
function getWeeklyTargetsFromPlan(monthIndex, weekNumber) {
  if (!window.planWeeklyTargets) {
    return null;
  }

  // Calculer l'index global dans les patterns (0-51)
  // Le plan d'affaires g√©n√®re 52 semaines √† partir du 5 janvier 2026
  // On doit mapper les semaines RPO (par mois) aux index du plan (global)

  // Mapping cumulatif: nombre de semaines √©coul√©es avant chaque mois
  const weekOffsets = {
    '0': 0,    // Janvier 2026: commence √† l'index 0
    '1': 5,    // F√©vrier 2026: commence √† l'index 5 (apr√®s 5 semaines de jan)
    '2': 9,    // Mars 2026: commence √† l'index 9 (5+4)
    '3': 13,   // Avril 2026: commence √† l'index 13 (5+4+4)
    '4': 18,   // Mai 2026: commence √† l'index 18 (5+4+4+5)
    '5': 22,   // Juin 2026: commence √† l'index 22 (5+4+4+5+4)
    '6': 26,   // Juillet 2026: commence √† l'index 26 (5+4+4+5+4+4)
    '7': 31,   // Ao√ªt 2026: commence √† l'index 31 (5+4+4+5+4+4+5)
    '8': 35,   // Septembre 2026: commence √† l'index 35 (5+4+4+5+4+4+5+4)
    '9': 39,   // Octobre 2026: commence √† l'index 39 (5+4+4+5+4+4+5+4+4)
    '10': 44,  // Novembre 2026: commence √† l'index 44 (5+4+4+5+4+4+5+4+4+5)
    '11': 48   // D√©cembre 2026: commence √† l'index 48 (5+4+4+5+4+4+5+4+4+5+4)
  };

  const offset = weekOffsets[String(monthIndex)];
  if (offset === undefined) {
    return null;
  }

  const globalIndex = offset + weekNumber - 1;

  if (globalIndex < 0 || globalIndex >= window.planWeeklyTargets.mktg.length) {
    return null;
  }

  const result = {
    h_marketing: window.planWeeklyTargets.mktg[globalIndex],
    estimation: window.planWeeklyTargets.estim[globalIndex],
    contract: window.planWeeklyTargets.contrat[globalIndex],
    dollar: window.planWeeklyTargets.dollar[globalIndex],
    prod: window.planWeeklyTargets.prod ? window.planWeeklyTargets.prod[globalIndex] : 0
  };

  return result;
}

// Calculate automatic values for weekly objectives
function calculateWeeklyObjectives(monthIndex) {
  // D√©terminer l'ann√©e et le mois r√©el
  let year, realMonth;
  year = 2026; realMonth = monthIndex;

  const monthInfo = getMonthInfo(monthIndex);
  const abbr = monthInfo.abbr;

  // Get monthly objectives
  const hMarketingInput = document.getElementById(`${abbr}-hrpap-vise`);
  const estimationInput = document.getElementById(`${abbr}-estimation-vise`);
  const contractInput = document.getElementById(`${abbr}-contract-vise`);
  const dollarInput = document.getElementById(`${abbr}-dollar-vise`);

  if (!hMarketingInput || !estimationInput || !contractInput || !dollarInput) return null;

  const hMarketing = parseFloat(hMarketingInput.dataset.value) || 0;
  const estimation = parseFloat(estimationInput.dataset.value) || 0;
  const contract = parseFloat(contractInput.dataset.value) || 0;
  const dollar = parseFloat(dollarInput.dataset.value) || 0;

  // Get total days in month
  const daysInMonth = new Date(year, realMonth + 1, 0).getDate();

  return { hMarketing, estimation, contract, dollar, daysInMonth };
}

// Generate weekly tables dynamically
function generateWeeklyTables(monthIndex) {
  // S'assurer que le plan d'affaires a √©t√© g√©n√©r√©
  if (!window.planWeeklyTargets) {
    console.log('[RPO] Plan d\'affaires non g√©n√©r√©, g√©n√©ration en cours...');
    if (typeof generatePlanWeeks === 'function') {
      generatePlanWeeks();
    }
  }

  const weeks = getWeeksForMonth(monthIndex);
  const showProdHoraire = monthIndex >= 4; // D√©cembre 2025 ou √† partir de Mai 2026 (index 4)

  // D√©terminer l'ann√©e et le mois r√©el
  let year, realMonth;
  year = 2026; realMonth = monthIndex;

  // Get monthly objectives for calculation
  const monthlyData = calculateWeeklyObjectives(monthIndex);

  // Generate Objectifs table
  let objectifsHTML = `
    <div id="objectifsTable" class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr style="border-bottom: 2px solid var(--border-dark);">
            <th class="p-3 text-left text-sm font-semibold sticky-semaine-header" style="color: var(--text-gray); background: rgb(30, 41, 59); border-radius: 14px 14px 0px 0px; position: sticky; z-index: 20; min-width: 150px; width: 150px;">Semaine</th>
            <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background-color: #0f172a; border-radius: 14px 14px 0px 0px; width: 80px;">Marketing Obj. (H)</th>
            <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background: rgba(30, 41, 59, 0.5); border-radius: 14px 14px 0px 0px; width: 100px;">Marketing R√©el (H)</th>
            <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background-color: #0f172a; border-radius: 14px 14px 0px 0px; width: 80px;">Estimation Obj. (#)</th>
            <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background: rgba(30, 41, 59, 0.5); border-radius: 14px 14px 0px 0px; width: 100px;">Estimation R√©el (#)</th>
            <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background-color: #0f172a; border-radius: 14px 14px 0px 0px; width: 80px;">Contrat Sign√© Obj. (#)</th>
            <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background: rgba(30, 41, 59, 0.5); border-radius: 14px 14px 0px 0px; width: 100px;">Contrat Sign√© R√©el (#)</th>
            <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background-color: #0f172a; border-radius: 14px 14px 0px 0px; width: 100px;">Montant Sign√© Obj. ($)</th>
            <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background: rgba(30, 41, 59, 0.5); border-radius: 14px 14px 0px 0px; width: 120px;">Montant Sign√© R√©el ($)</th>
            ${showProdHoraire ? '<th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background: rgba(30, 41, 59, 0.5); border-radius: 14px 14px 0px 0px; width: 150px;">Prod Horaire ($/H)</th>' : ''}
          </tr>
        </thead>
        <tbody>`;

  weeks.forEach((week, index) => {
    // Toutes les cellules Semaine sont sticky (pas seulement la premi√®re)
    const stickyClass = 'sticky-semaine-cell';
    const stickyStyle = 'position: sticky; background: var(--bg-card); z-index: 10;';

    // R√©cup√©rer les objectifs depuis le plan d'affaires
    const weekTargets = getWeeklyTargetsFromPlan(monthIndex, index + 1);

    // Valeurs automatiques (objectifs depuis le plan d'affaires)
    let hMarketingAuto = weekTargets ? weekTargets.h_marketing : 0;
    let estimationAuto = weekTargets ? weekTargets.estimation : 0;
    let contractAuto = weekTargets ? weekTargets.contract : 0;
    let dollarAuto = weekTargets ? weekTargets.dollar : 0;

    objectifsHTML += `
      <tr data-week="${index + 1}" style="border-bottom: 1px solid var(--border-dark); height: 60px;">
        <td class="p-3 text-sm ${stickyClass}" style="color: #9ca3af; ${stickyStyle}">${week.label}</td>
        <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly data-week="${index + 1}" data-field="h_marketing_obj" data-month="${monthIndex}" class="week-jan-input rpo-objective-input bg-transparent rounded px-1 py-0.5 w-full text-center text-sm" style="cursor: not-allowed !important; background-color: transparent !important; color: #9ca3af !important; text-align: center !important; border: none !important; outline: none !important; pointer-events: none !important;" value="${hMarketingAuto > 0 ? hMarketingAuto.toFixed(1) + ' h' : '-'}" data-value="${hMarketingAuto}"></td>
        <td class="p-3 text-center"><input type="text" readonly data-week="${index + 1}" data-field="h_marketing" class="week-jan-input rpo-metric-input bg-transparent text-center w-full text-sm" style="color: var(--text-light); outline: none !important; border: none !important; padding: 0 !important; background: transparent !important; cursor: not-allowed !important; pointer-events: none !important;" value="-" data-value="-"></td>
        <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly data-week="${index + 1}" data-field="estimation_obj" data-month="${monthIndex}" class="week-jan-input rpo-objective-input bg-transparent rounded px-1 py-0.5 w-full text-center text-sm" style="cursor: not-allowed !important; background-color: transparent !important; color: #9ca3af !important; text-align: center !important; border: none !important; outline: none !important; pointer-events: none !important;" value="${estimationAuto > 0 ? estimationAuto : '-'}" data-value="${estimationAuto}"></td>
        <td class="p-3 text-center"><input type="text" readonly data-week="${index + 1}" data-field="estimation" class="week-jan-input rpo-metric-input bg-transparent text-center w-full text-sm" style="color: var(--text-light); outline: none !important; border: none !important; padding: 0 !important; background: transparent !important; cursor: not-allowed !important; pointer-events: none !important;" value="0" data-value="0"></td>
        <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly data-week="${index + 1}" data-field="contract_obj" data-month="${monthIndex}" class="week-jan-input rpo-objective-input bg-transparent rounded px-1 py-0.5 w-full text-center text-sm" style="cursor: not-allowed !important; background-color: transparent !important; color: #9ca3af !important; text-align: center !important; border: none !important; outline: none !important; pointer-events: none !important;" value="${contractAuto > 0 ? (contractAuto % 1 === 0 ? contractAuto : contractAuto.toFixed(1)) : '-'}" data-value="${contractAuto}"></td>
        <td class="p-3 text-center"><input type="text" readonly data-week="${index + 1}" data-field="contract" class="week-jan-input rpo-metric-input bg-transparent text-center w-full text-sm" style="color: var(--text-light); outline: none !important; border: none !important; padding: 0 !important; background: transparent !important; cursor: not-allowed !important; pointer-events: none !important;" value="0" data-value="0"></td>
        <td class="p-3 text-center" style="background-color: #0f172a;"><input type="text" readonly data-week="${index + 1}" data-field="dollar_obj" data-month="${monthIndex}" class="week-jan-input rpo-objective-input bg-transparent rounded px-1 py-0.5 w-full text-center text-sm font-semibold" style="cursor: not-allowed !important; background-color: transparent !important; color: #9ca3af !important; text-align: center !important; border: none !important; outline: none !important; pointer-events: none !important;" value="${dollarAuto > 0 ? Math.round(dollarAuto).toLocaleString('fr-CA') + ' $' : '-'}" data-value="${dollarAuto}"></td>
        <td class="p-3 text-center"><input type="text" readonly data-week="${index + 1}" data-field="dollar" class="week-jan-input rpo-metric-input bg-transparent text-center w-full text-sm font-semibold" style="color: var(--text-light); outline: none !important; border: none !important; padding: 0 !important; background: transparent !important; cursor: not-allowed !important; pointer-events: none !important;" value="0 $" data-value="0"></td>
        ${showProdHoraire ? `<td class="p-3 text-center"><input type="text" readonly data-week="${index + 1}" data-field="prod_horaire" class="week-jan-input rpo-metric-input bg-transparent text-center w-full text-sm" style="color: var(--text-light); outline: none !important; border: none !important; padding: 0 !important; background: transparent !important; cursor: not-allowed !important; pointer-events: none !important;" value="-" data-value="-"></td>` : ''}
      </tr>`;
  });

  objectifsHTML += `
        </tbody>
      </table>
    </div>`;

  // Generate Resume table
  let resumeHTML = `
    <div id="resumeTable" class="overflow-x-auto hidden">
      <table class="w-full">
        <thead>
          <tr style="border-bottom: 2px solid var(--border-dark);">
            <th class="p-3 text-left text-sm font-semibold sticky-semaine-header" style="color: var(--text-gray); background: rgb(30, 41, 59); border-radius: 14px 14px 0px 0px; position: sticky; z-index: 20; min-width: 150px; width: 150px;">Semaine</th>
            <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background: rgba(30, 41, 59, 0.5); border-radius: 14px 14px 0px 0px;">Comment vas-tu</th>
            <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background: rgba(30, 41, 59, 0.5); border-radius: 14px 14px 0px 0px;">Analyse de la semaine pass√©e</th>
            <th class="p-3 text-center text-sm font-semibold" style="color: var(--text-gray); background: rgba(30, 41, 59, 0.5); border-radius: 14px 14px 0px 0px;">Focus de la semaine</th>
          </tr>
        </thead>
        <tbody>`;

  weeks.forEach((week, index) => {
    // Toutes les cellules Semaine sont sticky (pas seulement la premi√®re)
    const stickyClass = 'sticky-semaine-cell';
    const stickyStyle = 'position: sticky; background: var(--bg-card); z-index: 10;';

    resumeHTML += `
      <tr data-week="${index + 1}" style="border-bottom: 1px solid var(--border-dark); height: 60px;">
        <td class="p-3 text-sm ${stickyClass}" style="color: #9ca3af; ${stickyStyle}">${week.label}</td>
        <td class="p-3 text-center">
          <div class="flex gap-1 justify-center star-container" data-week="${index + 1}">
            <span class="text-sm" style="color: var(--text-light);">-</span>
            <div class="hidden star-rating-group flex gap-1">
              <i class="fas fa-star hover:scale-110 transition-all star-rating" style="color: #374151; pointer-events: none; cursor: default;" data-week="${index + 1}" data-rating="1"></i>
              <i class="fas fa-star hover:scale-110 transition-all star-rating" style="color: #374151; pointer-events: none; cursor: default;" data-week="${index + 1}" data-rating="2"></i>
              <i class="fas fa-star hover:scale-110 transition-all star-rating" style="color: #374151; pointer-events: none; cursor: default;" data-week="${index + 1}" data-rating="3"></i>
              <i class="fas fa-star hover:scale-110 transition-all star-rating" style="color: #374151; pointer-events: none; cursor: default;" data-week="${index + 1}" data-rating="4"></i>
              <i class="fas fa-star hover:scale-110 transition-all star-rating" style="color: #374151; pointer-events: none; cursor: default;" data-week="${index + 1}" data-rating="5"></i>
            </div>
          </div>
        </td>
        <td class="p-3 text-center">
          <div data-week="${index + 1}" data-field="probleme" class="week-analysis-cell" style="color: var(--text-light); padding: 4px 8px; border-radius: 6px; min-height: 32px; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <span class="week-analysis-text text-sm" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1;">-</span>
            <i class="fas fa-edit week-edit-icon" style="color: var(--primary-blue); font-size: 0.75rem; opacity: 0.6; display: none;"></i>
          </div>
        </td>
        <td class="p-3 text-center">
          <div data-week="${index + 1}" data-field="focus" class="week-analysis-cell" style="color: var(--text-light); padding: 4px 8px; border-radius: 6px; min-height: 32px; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <span class="week-analysis-text text-sm" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1;">-</span>
            <i class="fas fa-edit week-edit-icon" style="color: var(--primary-green); font-size: 0.75rem; opacity: 0.6; display: none;"></i>
          </div>
        </td>
      </tr>`;
  });

  resumeHTML += `
        </tbody>
      </table>
    </div>`;

  return { objectifs: objectifsHTML, resume: resumeHTML };
}

// Store current month index for refresh
let currentWeeklyMonthIndex = 0;

// Initialize event listeners for objective inputs to update dataset.value when user types
function initObjectiveInputListeners() {
  const objectiveInputs = document.querySelectorAll('.rpo-objective-input');

  objectiveInputs.forEach(input => {
    // Remove any existing listener first (avoid duplicates)
    input.removeEventListener('input', handleObjectiveInputChange);
    input.removeEventListener('focus', handleObjectiveInputFocus);

    // Add focus event to save original value before editing
    input.addEventListener('focus', handleObjectiveInputFocus);

    // Add input event listener to update dataset.value when user types
    input.addEventListener('input', handleObjectiveInputChange);
  });

  console.log(`[OBJECTIVE INPUTS] ${objectiveInputs.length} event listeners initialized`);
}

// Sauvegarder la valeur originale au focus (avant que l'utilisateur tape)
function handleObjectiveInputFocus(e) {
  const input = e.target;
  // Sauvegarder la valeur actuelle dans un attribut sp√©cial
  input.dataset.originalValue = input.dataset.value || input.dataset.vise || '0';
  console.log(`[OBJECTIVE FOCUS] Saved original value: ${input.dataset.originalValue}`);
}

// Handle objective input change: update dataset.value from input.value
function handleObjectiveInputChange(e) {
  const input = e.target;
  const field = input.dataset.field;

  // Remove formatting (spaces, $, h) and parse the number
  let rawValue = input.value.replace(/\s/g, '').replace(/\$/g, '').replace(/h/g, '').replace(/,/g, '.');
  const numericValue = parseFloat(rawValue);

  // Update dataset.value with the parsed number (m√™me si c'est 0, on laisse passer pour validation √† l'enregistrement)
  if (!isNaN(numericValue)) {
    input.dataset.value = numericValue;
    console.log(`[OBJECTIVE INPUT] ${field} updated: ${numericValue}`);
  } else if (rawValue === '') {
    // Valeur vide - garder la valeur du plan
    const viseValue = parseFloat(input.dataset.vise) || 0;
    input.dataset.value = viseValue;
  }
}

// Afficher notification que 0 n'est pas permis
function showZeroNotAllowedNotification() {
  // V√©rifier si une notification existe d√©j√†
  let notif = document.getElementById('zero-not-allowed-notif');
  if (notif) {
    notif.remove();
  }

  // Cr√©er la notification
  notif = document.createElement('div');
  notif.id = 'zero-not-allowed-notif';
  notif.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    z-index: 99999;
    box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideDown 0.3s ease-out;
  `;
  notif.innerHTML = `
    <i class="fas fa-exclamation-circle"></i>
    <span>La valeur 0 n'est pas permise pour les objectifs</span>
  `;

  // Ajouter l'animation CSS si pas d√©j√† pr√©sente
  if (!document.getElementById('zero-notif-animation')) {
    const style = document.createElement('style');
    style.id = 'zero-notif-animation';
    style.textContent = `
      @keyframes slideDown {
        from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }

  document.body.appendChild(notif);

  // Supprimer apr√®s 3 secondes
  setTimeout(() => {
    if (notif && notif.parentElement) {
      notif.style.animation = 'slideDown 0.3s ease-out reverse';
      setTimeout(() => notif.remove(), 300);
    }
  }, 3000);
}

// Load weekly data from backend for specific month
async function loadWeeklyDataForMonth(monthIndex) {
  const username = getCurrentUsername();

  log(`[loadWeeklyDataForMonth] Loading data for month ${monthIndex}, user: ${username}`);

  try {
    const response = await fetch(`/api/rpo/${username}/weekly/${monthIndex}`);
    if (response.ok) {
      const weeklyData = await response.json();

      log(`[loadWeeklyDataForMonth] Received data:`, weeklyData);

      // Log all prod_horaire values in the response
      const prodHoraireValues = Object.keys(weeklyData)
        .filter(week => weeklyData[week].prod_horaire !== undefined)
        .map(week => `Semaine ${week}: ${weeklyData[week].prod_horaire}$/h`);
      if (prodHoraireValues.length > 0) {
        console.log(`[SEM2026-LOAD] üì¶ Prod horaire dans les donn√©es re√ßues:`, prodHoraireValues);
      }

      // Apply data to inputs
      Object.keys(weeklyData).forEach(weekNumber => {
        const data = weeklyData[weekNumber];
        log(`[loadWeeklyDataForMonth] Week ${weekNumber}:`, data);

        // Load objectifs data
        if (data.h_marketing !== undefined && data.h_marketing !== null) {
          const input = document.querySelector(`input[data-week="${weekNumber}"][data-field="h_marketing"]`);
          if (input) {
            // Si c'est "-", l'afficher tel quel, sinon ajouter " h"
            if (data.h_marketing === '-') {
              input.value = '-';
              input.dataset.value = '-';
            } else {
              // Arrondir pour affichage (0.3h ‚Üí 1h), mais garder la valeur d√©cimale dans dataset
              input.value = Math.ceil(data.h_marketing) + ' h';
              input.dataset.value = data.h_marketing;
            }
          }
        }

        if (data.estimation !== undefined) {
          const input = document.querySelector(`input[data-week="${weekNumber}"][data-field="estimation"]`);
          if (input) {
            input.value = data.estimation;
            input.dataset.value = data.estimation;
          }
        }

        if (data.contract !== undefined) {
          const input = document.querySelector(`input[data-week="${weekNumber}"][data-field="contract"]`);
          if (input) {
            input.value = data.contract;
            input.dataset.value = data.contract;
          }
        }

        if (data.dollar !== undefined) {
          const input = document.querySelector(`input[data-week="${weekNumber}"][data-field="dollar"]`);
          if (input) {
            input.value = data.dollar.toLocaleString('fr-CA', {minimumFractionDigits: 2, maximumFractionDigits: 2}).replace(/\s/g, ' ') + ' $';
            input.dataset.value = data.dollar;
          }
        }

        // Charger prod_horaire (exactement comme h_marketing)
        if (data.prod_horaire !== undefined && data.prod_horaire !== null && data.prod_horaire !== 0 && data.prod_horaire !== '-') {
          // Valeur num√©rique: afficher avec "$/h"
          const input = document.querySelector(`input[data-week="${weekNumber}"][data-field="prod_horaire"]`);
          console.log(`[SEM2026-LOAD] üîç Tentative de charger prod_horaire pour semaine ${weekNumber}: ${data.prod_horaire}$/h`);
          if (input) {
            input.value = data.prod_horaire + ' $/h';
            input.dataset.value = data.prod_horaire;
            console.log(`[SEM2026-LOAD] ‚úÖ Input trouv√© et modifi√© - value: "${input.value}", dataset.value: "${input.dataset.value}"`);
          } else {
            console.log(`[SEM2026-LOAD] ‚ùå Input prod_horaire NON TROUV√â pour semaine ${weekNumber}!`);
          }
        } else {
          // Prod horaire pas d√©fini, = 0, ou = "-", afficher "-"
          const input = document.querySelector(`input[data-week="${weekNumber}"][data-field="prod_horaire"]`);
          if (input) {
            input.value = '-';
            input.dataset.value = '-';
            console.log(`[SEM2026-LOAD] ‚ÑπÔ∏è Prod Horaire semaine ${weekNumber}: non rempli, mis √† "-"`);
          }
        }

        // Load objectives with priority system:
        // 1. If obj_modifier exists and > 0, use it (manual override)
        // 2. If obj_modifier = 0 or null/undefined, use vise from business plan
        // Note: modifier = 0 means "use plan value" (reset to plan)

        // H. Marketing
        const hMarketingVise = data.h_marketing_vise || 0;
        const hMarketingValue = (data.h_marketing_obj_modifier && data.h_marketing_obj_modifier > 0)
          ? data.h_marketing_obj_modifier
          : hMarketingVise;
        if (hMarketingValue > 0) {
          const input = document.querySelector(`input[data-week="${weekNumber}"][data-field="h_marketing_obj"]`);
          if (input) {
            // Arrondir pour affichage (0.3h ‚Üí 1h), mais garder la valeur d√©cimale dans dataset
            input.value = Math.ceil(hMarketingValue) + ' h';
            input.dataset.value = hMarketingValue;
            input.dataset.vise = hMarketingVise; // Stocker la valeur du plan
          }
        }

        // Estimations
        const estimationVise = data.estimation_vise || 0;
        const estimationValue = (data.estimation_obj_modifier && data.estimation_obj_modifier > 0)
          ? data.estimation_obj_modifier
          : estimationVise;
        if (estimationValue > 0) {
          const input = document.querySelector(`input[data-week="${weekNumber}"][data-field="estimation_obj"]`);
          if (input) {
            input.value = estimationValue % 1 === 0 ? estimationValue : estimationValue.toFixed(1);
            input.dataset.value = estimationValue;
            input.dataset.vise = estimationVise; // Stocker la valeur du plan
          }
        }

        // Contrats
        const contractVise = data.contract_vise || 0;
        const contractValue = (data.contract_obj_modifier && data.contract_obj_modifier > 0)
          ? data.contract_obj_modifier
          : contractVise;
        if (contractValue > 0) {
          const input = document.querySelector(`input[data-week="${weekNumber}"][data-field="contract_obj"]`);
          if (input) {
            input.value = contractValue % 1 === 0 ? contractValue : contractValue.toFixed(1);
            input.dataset.value = contractValue;
            input.dataset.vise = contractVise; // Stocker la valeur du plan
          }
        }

        // Dollar
        const dollarVise = data.dollar_vise || 0;
        const dollarValue = (data.dollar_obj_modifier && data.dollar_obj_modifier > 0)
          ? data.dollar_obj_modifier
          : dollarVise;
        if (dollarValue > 0) {
          const input = document.querySelector(`input[data-week="${weekNumber}"][data-field="dollar_obj"]`);
          if (input) {
            input.value = Math.round(dollarValue).toLocaleString('fr-CA') + ' $';
            input.dataset.value = dollarValue;
            input.dataset.vise = dollarVise; // Stocker la valeur du plan
          }
        }

        // Load rating
        if (data.rating !== undefined && data.rating > 0) {
          const starContainer = document.querySelector(`.star-container[data-week="${weekNumber}"]`);
          if (starContainer) {
            // Cacher le "-" et montrer les √©toiles
            const dashSpan = starContainer.querySelector('span');
            const starsGroup = starContainer.querySelector('.star-rating-group');
            if (dashSpan) dashSpan.classList.add('hidden');
            if (starsGroup) starsGroup.classList.remove('hidden');

            // Colorier les √©toiles
            const stars = document.querySelectorAll(`.star-rating[data-week="${weekNumber}"]`);
            stars.forEach((star, index) => {
              if (index < data.rating) {
                star.style.color = '#fbbf24';
              } else {
                star.style.color = '#374151';
              }
            });
          }
        }

        // Load probleme and focus (prioritize direct fields, fallback to commentaire)
        let problemeValue = '-';
        let focusValue = '-';

        // Try loading from direct fields first
        if (data.probleme !== undefined) {
          problemeValue = data.probleme;
        } else if (data.commentaire) {
          // Fallback: parse from commentaire for backward compatibility
          const parts = data.commentaire.split(' | ');
          parts.forEach(part => {
            if (part.startsWith('Probl√®me: ')) {
              problemeValue = part.replace('Probl√®me: ', '');
            }
          });
        }

        if (data.focus !== undefined) {
          focusValue = data.focus;
        } else if (data.commentaire) {
          // Fallback: parse from commentaire for backward compatibility
          const parts = data.commentaire.split(' | ');
          parts.forEach(part => {
            if (part.startsWith('Focus: ')) {
              focusValue = part.replace('Focus: ', '');
            }
          });
        }

        // Update probleme cell
        const problemeCell = document.querySelector(`div[data-week="${weekNumber}"][data-field="probleme"]`);
        if (problemeCell) {
          const fullText = problemeValue !== '' && problemeValue !== '-' ? problemeValue : '-';
          const textSpan = problemeCell.querySelector('.week-analysis-text');
          if (textSpan) {
            textSpan.setAttribute('data-full-text', fullText);
            if (fullText.length > 50) {
              textSpan.textContent = fullText.substring(0, 50) + '...';
            } else {
              textSpan.textContent = fullText;
            }
          }

          // Activer le clic pour voir le texte complet si du texte existe (mode lecture par d√©faut)
          if (fullText !== '-') {
            problemeCell.onclick = () => openWeeklyAnalysisViewPopup(weekNumber, 'probleme');
            problemeCell.style.cursor = 'pointer';
            problemeCell.classList.add('hover:bg-opacity-20', 'transition-all');
            problemeCell.title = 'Cliquer pour voir le texte complet';
          }
        }

        // Update focus cell
        const focusCell = document.querySelector(`div[data-week="${weekNumber}"][data-field="focus"]`);
        if (focusCell) {
          const fullText = focusValue !== '' && focusValue !== '-' ? focusValue : '-';
          const textSpan = focusCell.querySelector('.week-analysis-text');
          if (textSpan) {
            textSpan.setAttribute('data-full-text', fullText);
            if (fullText.length > 50) {
              textSpan.textContent = fullText.substring(0, 50) + '...';
            } else {
              textSpan.textContent = fullText;
            }
          }

          // Activer le clic pour voir le texte complet si du texte existe (mode lecture par d√©faut)
          if (fullText !== '-') {
            focusCell.onclick = () => openWeeklyAnalysisViewPopup(weekNumber, 'focus');
            focusCell.style.cursor = 'pointer';
            focusCell.classList.add('hover:bg-opacity-20', 'transition-all');
            focusCell.title = 'Cliquer pour voir le texte complet';
          }
        }

        // IMPORTANT: Synchroniser avec le Plan d'affaires
        updatePlanFromWeeklyData(monthIndex, weekNumber, data);
      });

      // Recalculer le plan apr√®s avoir charg√© toutes les donn√©es
      calculatePlan();

      // Initialiser les event listeners pour les inputs d'objectifs
      initObjectiveInputListeners();

      // V√©rifier l'√©tat final de tous les inputs prod_horaire
      const allProdHoraireInputs = document.querySelectorAll('input[data-field="prod_horaire"]');
      if (allProdHoraireInputs.length > 0) {
        console.log(`[SEM2026-LOAD] üéØ √âtat final des inputs prod_horaire (${allProdHoraireInputs.length} inputs trouv√©s):`);
        allProdHoraireInputs.forEach(input => {
          console.log(`  - Semaine ${input.dataset.week}: value="${input.value}", dataset.value="${input.dataset.value}"`);
        });

        // V√©rifier si les valeurs changent apr√®s 1 seconde
        setTimeout(() => {
          console.log(`[SEM2026-LOAD] üïê V√©rification apr√®s 1 seconde:`);
          const inputs = document.querySelectorAll('input[data-field="prod_horaire"]');
          inputs.forEach(input => {
            console.log(`  - Semaine ${input.dataset.week}: value="${input.value}", dataset.value="${input.dataset.value}"`);
          });
        }, 1000);
      } else {
        console.log(`[SEM2026-LOAD] ‚ö†Ô∏è Aucun input prod_horaire trouv√© dans le DOM!`);
      }

      // Initialiser les lignes du tableau R√©sum√© comme cliquables
      initResumeTableRowClicks();
    }
  } catch (error) {
  }
}

// Variables globales pour stocker les semaines incompl√®tes
window.incompleteObjectifsWeeks = [];
window.incompleteResumeWeeks = [];

// Calculer et afficher le badge de semaines incompl√®tes pour Obj.ECTIFS (H Marketing Vis√© modifi√©)
function updateIncompleteObjectifsBadge() {
  if (!window.weeklyData) return;

  const today = getTorontoNow();
  const fiscalYearStart = createTorontoDate(2026, 0, 5); // 5 janvier 2026 (d√©but semaine 1) - Toronto timezone

  // Si on n'est pas encore dans l'ann√©e fiscale, ne rien afficher
  if (today < fiscalYearStart) {
    document.getElementById('incompleteWeeksBadge').classList.add('hidden');
    return;
  }

  // Calculer la semaine actuelle depuis le d√©but de l'ann√©e fiscale
  const daysSinceStart = Math.floor((today - fiscalYearStart) / (1000 * 60 * 60 * 24));
  const currentWeekNumber = Math.floor(daysSinceStart / 7) + 1; // Semaine 1 = 1-7 d√©c, Semaine 2 = 8-14 d√©c, etc.

  let incompleteCount = 0;
  window.incompleteObjectifsWeeks = [];

  // Retirer tous les backgrounds rouges existants d'abord
  document.querySelectorAll('td[data-incomplete-marketing]').forEach(td => {
    td.style.background = '';
    td.removeAttribute('data-incomplete-marketing');
  });

  // Parcourir TOUS les mois (d√©cembre 2025 = -2, puis janvier √† d√©cembre 2026 = 0 √† 11)
  for (let monthIndex = -2; monthIndex <= 11; monthIndex++) {
    const monthKey = String(monthIndex);
    const monthData = window.weeklyData[monthKey];

    if (monthData) {
      // Parcourir les semaines du mois (1-5)
      for (let weekNumber = 1; weekNumber <= 5; weekNumber++) {
        const weekKey = String(weekNumber);
        const weekData = monthData[weekKey];

        // Calculer le num√©ro de semaine global
        let globalWeekNumber;
        
          globalWeekNumber = 13 + (monthIndex * 4) + weekNumber;
        

        // V√©rifier seulement les semaines pass√©es
        if (globalWeekNumber >= currentWeekNumber) continue;

        // V√©rifier si H Marketing R√©el a √©t√© modifi√© (diff√©rent de "-")
        if (weekData) {
          const hMarketing = weekData.h_marketing;
          // Incomplet seulement si "-", "", undefined ou null (PAS si 0)
          const isIncomplete = (hMarketing === '-' || hMarketing === '' || hMarketing === undefined || hMarketing === null);

          if (isIncomplete) {
            incompleteCount++;
            window.incompleteObjectifsWeeks.push({ monthIndex, weekNumber, globalWeekNumber });

            // Ajouter le fond rouge √† la cellule h_marketing seulement si c'est le mois affich√©
            if (currentWeeklyMonthIndex === monthIndex) {
              const marketingInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="h_marketing"]`);
              if (marketingInput) {
                const td = marketingInput.closest('td');
                if (td) {
                  td.style.background = '#ff00001f';
                  td.setAttribute('data-incomplete-marketing', 'true');
                }
              }
            }
          }
        } else {
          incompleteCount++;
          window.incompleteObjectifsWeeks.push({ monthIndex, weekNumber, globalWeekNumber });

          // Ajouter le fond rouge √† la cellule h_marketing seulement si c'est le mois affich√©
          if (currentWeeklyMonthIndex === monthIndex) {
            const marketingInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="h_marketing"]`);
            if (marketingInput) {
              const td = marketingInput.closest('td');
              if (td) {
                td.style.background = '#ff00001f';
                td.setAttribute('data-incomplete-marketing', 'true');
              }
            }
          }
        }
      }
    }
  }

  // Afficher le badge
  const badge = document.getElementById('incompleteWeeksBadge');
  if (incompleteCount > 0) {
    if (badge) {
      badge.textContent = incompleteCount;
      badge.classList.remove('hidden');
    }
  } else {
    if (badge) badge.classList.add('hidden');
  }
}

// Calculer et afficher le badge de semaines incompl√®tes pour R√âSUM√â (Probl√®me + Focus)
function updateIncompleteResumeBadge() {
  if (!window.weeklyData) return;

  const today = getTorontoNow();
  const fiscalYearStart = createTorontoDate(2026, 0, 5); // 5 janvier 2026 (d√©but semaine 1) - Toronto timezone

  if (today < fiscalYearStart) {
    document.getElementById('incompleteWeeksBadge2').classList.add('hidden');
    return;
  }

  const daysSinceStart = Math.floor((today - fiscalYearStart) / (1000 * 60 * 60 * 24));
  const currentWeekNumber = Math.floor(daysSinceStart / 7) + 1; // Semaine 1 = 1-7 d√©c, Semaine 2 = 8-14 d√©c, etc.

  let incompleteCount = 0;
  window.incompleteResumeWeeks = [];

  // Retirer tous les backgrounds rouges existants d'abord
  document.querySelectorAll('td[data-incomplete-probleme]').forEach(td => {
    td.style.background = '';
    td.removeAttribute('data-incomplete-probleme');
  });
  document.querySelectorAll('td[data-incomplete-focus]').forEach(td => {
    td.style.background = '';
    td.removeAttribute('data-incomplete-focus');
  });
  document.querySelectorAll('td[data-incomplete-rating]').forEach(td => {
    td.style.background = '';
    td.removeAttribute('data-incomplete-rating');
  });

  // Parcourir TOUS les mois (d√©cembre 2025 = -2, puis janvier √† d√©cembre 2026 = 0 √† 11)
  for (let monthIndex = -2; monthIndex <= 11; monthIndex++) {
    const monthKey = String(monthIndex);
    const monthData = window.weeklyData[monthKey];

    if (monthData) {
      for (let weekNumber = 1; weekNumber <= 5; weekNumber++) {
        const weekKey = String(weekNumber);
        const weekData = monthData[weekKey];

        let globalWeekNumber;
        
          globalWeekNumber = 13 + (monthIndex * 4) + weekNumber;
        

        if (globalWeekNumber >= currentWeekNumber) continue;

        // V√©rifier si Probl√®me, Focus ET Rating sont remplis
        if (weekData) {
          // Prioritize direct fields, fallback to commentaire parsing
          let probleme = '';
          let focus = '';

          if (weekData.probleme !== undefined) {
            probleme = weekData.probleme;
          } else {
            const commentaireRaw = weekData.commentaire || '';
            if (commentaireRaw.includes('|')) {
              const parts = commentaireRaw.split('|');
              parts.forEach(part => {
                const trimmed = part.trim();
                if (trimmed.startsWith('Probl√®me:')) {
                  probleme = trimmed.replace('Probl√®me:', '').trim();
                }
              });
            } else if (commentaireRaw.startsWith('Probl√®me:')) {
              probleme = commentaireRaw.replace('Probl√®me:', '').trim();
            }
          }

          if (weekData.focus !== undefined) {
            focus = weekData.focus;
          } else {
            const commentaireRaw = weekData.commentaire || '';
            if (commentaireRaw.includes('|')) {
              const parts = commentaireRaw.split('|');
              parts.forEach(part => {
                const trimmed = part.trim();
                if (trimmed.startsWith('Focus:')) {
                  focus = trimmed.replace('Focus:', '').trim();
                }
              });
            } else if (commentaireRaw.startsWith('Focus:')) {
              focus = commentaireRaw.replace('Focus:', '').trim();
            }
          }

          const problemeIncomplete = (probleme === '' || probleme === '-');
          const focusIncomplete = (focus === '' || focus === '-');
          const rating = weekData.rating || 0;
          const ratingIncomplete = (rating === 0);
          const isIncomplete = problemeIncomplete || focusIncomplete || ratingIncomplete;

          if (isIncomplete) {
            incompleteCount++;
            window.incompleteResumeWeeks.push({ monthIndex, weekNumber, globalWeekNumber });

            // Ajouter le fond rouge aux cellules seulement si c'est le mois affich√©
            if (currentWeeklyMonthIndex === monthIndex) {
              if (problemeIncomplete) {
                const problemeInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="probleme"]`);
                if (problemeInput) {
                  const td = problemeInput.closest('td');
                  if (td) {
                    td.style.background = '#ff00001f';
                    td.setAttribute('data-incomplete-probleme', 'true');
                  }
                }
              }

              if (focusIncomplete) {
                const focusInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="focus"]`);
                if (focusInput) {
                  const td = focusInput.closest('td');
                  if (td) {
                    td.style.background = '#ff00001f';
                    td.setAttribute('data-incomplete-focus', 'true');
                  }
                }
              }

              if (ratingIncomplete) {
                const starContainer = document.querySelector(`.star-container[data-week="${weekNumber}"]`);
                if (starContainer) {
                  const td = starContainer.closest('td');
                  if (td) {
                    td.style.background = '#ff00001f';
                    td.setAttribute('data-incomplete-rating', 'true');
                  }
                }
              }
            }
          }
        } else {
          incompleteCount++;
          window.incompleteResumeWeeks.push({ monthIndex, weekNumber, globalWeekNumber });

          // Ajouter le fond rouge aux cellules probl√®me, focus et rating seulement si c'est le mois affich√©
          if (currentWeeklyMonthIndex === monthIndex) {
            const problemeInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="probleme"]`);
            if (problemeInput) {
              const td = problemeInput.closest('td');
              if (td) {
                td.style.background = '#ff00001f';
                td.setAttribute('data-incomplete-probleme', 'true');
              }
            }

            const focusInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="focus"]`);
            if (focusInput) {
              const td = focusInput.closest('td');
              if (td) {
                td.style.background = '#ff00001f';
                td.setAttribute('data-incomplete-focus', 'true');
              }
            }

            const starContainer = document.querySelector(`.star-container[data-week="${weekNumber}"]`);
            if (starContainer) {
              const td = starContainer.closest('td');
              if (td) {
                td.style.background = '#ff00001f';
                td.setAttribute('data-incomplete-rating', 'true');
              }
            }
          }
        }
      }
    }
  }

  // Afficher le badge
  const badge = document.getElementById('incompleteWeeksBadge2');
  if (incompleteCount > 0) {
    if (badge) {
      badge.textContent = incompleteCount;
      badge.classList.remove('hidden');
    }
  } else {
    if (badge) badge.classList.add('hidden');
  }
}

// Mettre √† jour les deux badges
function updateIncompleteWeeksBadge() {
  updateIncompleteObjectifsBadge();
  updateIncompleteResumeBadge();
  updateMonthDropdownBadges();
  updateTotalBadge();

  // Mettre √† jour le badge du menu lat√©ral
  const totalIncomplete = (window.incompleteObjectifsWeeks?.length || 0) +
                         (window.incompleteResumeWeeks?.length || 0);

  console.log('[RPO BADGE DEBUG] incompleteObjectifsWeeks:', window.incompleteObjectifsWeeks?.length || 0);
  console.log('[RPO BADGE DEBUG] incompleteResumeWeeks:', window.incompleteResumeWeeks?.length || 0);
  console.log('[RPO BADGE DEBUG] Total incomplete:', totalIncomplete);

  updateMenuBadge(totalIncomplete);

  // NE PAS afficher le modal si c'est un coach sans s√©lection d'entrepreneur
  const userRole = localStorage.getItem('userRole');
  const isCoach = userRole === 'coach' || userRole === 'direction';

  // V√©rifier si un entrepreneur est s√©lectionn√© en regardant:
  // 1. Si le body a la classe 'has-selection'
  // 2. Si le s√©lecteur est en mode header
  // 3. Si window.selectedEntrepreneurUsername est d√©fini
  const hasSelection = document.body.classList.contains('has-selection') ||
                      window.selectedEntrepreneurUsername ||
                      document.getElementById('coach-entrepreneur-selector')?.classList.contains('in-header');

  if (isCoach && !hasSelection) {
    console.log('[RPO NOTIFICATIONS] Coach sans s√©lection - modal non affich√©');
    return;
  }

  // Afficher le modal automatiquement si on vient de charger la page ET qu'il y a des donn√©es incompl√®tes
  if (!window.rpoNotificationModalShown && totalIncomplete > 0) {
    window.rpoNotificationModalShown = true;
    showNotificationsModal();
  }
}

// Mettre √† jour le badge total permanent sur le dropdown
function updateTotalBadge() {
  if (!window.weeklyData) return;

  const today = getTorontoNow();
  const fiscalYearStart = createTorontoDate(2026, 0, 5); // 5 janvier 2026 (d√©but semaine 1) - Toronto timezone
  if (today < fiscalYearStart) return;

  const daysSinceStart = Math.floor((today - fiscalYearStart) / (1000 * 60 * 60 * 24));
  const currentWeekNumber = Math.floor(daysSinceStart / 7) + 1;

  const allMonths = [-2, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];

  let totalObjectifsIncomplete = 0;
  let totalResumeIncomplete = 0;

  // Pour chaque mois, compter les semaines incompl√®tes
  allMonths.forEach(monthIndex => {
    const monthKey = String(monthIndex);
    const monthData = window.weeklyData[monthKey];

    if (monthData) {
      for (let weekNumber = 1; weekNumber <= 5; weekNumber++) {
        const weekKey = String(weekNumber);
        const weekData = monthData[weekKey];

        let globalWeekNumber;
        
          globalWeekNumber = 13 + (monthIndex * 4) + weekNumber;
        

        // V√©rifier seulement les semaines pass√©es
        if (globalWeekNumber >= currentWeekNumber) continue;

        if (weekData) {
          // V√©rifier H Marketing
          const hMarketing = weekData.h_marketing;
          const hMarketingIncomplete = (hMarketing === '-' || hMarketing === '' || hMarketing === undefined || hMarketing === null);
          if (hMarketingIncomplete) {
            totalObjectifsIncomplete++;
          }

          // V√©rifier Probl√®me, Focus, Rating
          let probleme = '';
          let focus = '';

          // Prioritize direct fields, fallback to commentaire parsing
          if (weekData.probleme !== undefined) {
            probleme = weekData.probleme;
          } else {
            const commentaireRaw = weekData.commentaire || '';
            if (commentaireRaw.includes('|')) {
              const parts = commentaireRaw.split('|');
              parts.forEach(part => {
                const trimmed = part.trim();
                if (trimmed.startsWith('Probl√®me:')) {
                  probleme = trimmed.replace('Probl√®me:', '').trim();
                }
              });
            }
          }

          if (weekData.focus !== undefined) {
            focus = weekData.focus;
          } else {
            const commentaireRaw = weekData.commentaire || '';
            if (commentaireRaw.includes('|')) {
              const parts = commentaireRaw.split('|');
              parts.forEach(part => {
                const trimmed = part.trim();
                if (trimmed.startsWith('Focus:')) {
                  focus = trimmed.replace('Focus:', '').trim();
                }
              });
            }
          }

          const problemeIncomplete = (probleme === '' || probleme === '-');
          const focusIncomplete = (focus === '' || focus === '-');
          const rating = weekData.rating || 0;
          const ratingIncomplete = (rating === 0);

          if (problemeIncomplete || focusIncomplete || ratingIncomplete) {
            totalResumeIncomplete++;
          }
        } else {
          // Pas de donn√©es = incomplet pour les deux
          totalObjectifsIncomplete++;
          totalResumeIncomplete++;
        }
      }
    }
  });

  const totalIncomplete = totalObjectifsIncomplete + totalResumeIncomplete;
  const totalBadge = document.getElementById('totalBadge');

  if (totalBadge) {
    if (totalIncomplete === 0) {
      // Tout est compl√©t√©: badge vert avec coche
      totalBadge.style.background = '#10b981';
      totalBadge.innerHTML = '‚úì';
    } else {
      // T√¢ches incompl√®tes: badge rouge avec nombre
      totalBadge.style.background = '#ef4444';
      totalBadge.textContent = totalIncomplete;
    }
  }
}

// Mettre √† jour les badges dans le dropdown de s√©lection de mois
function updateMonthDropdownBadges() {
  if (!window.weeklyData) return;

  const today = getTorontoNow();
  const fiscalYearStart = createTorontoDate(2026, 0, 5); // 5 janvier 2026 (d√©but semaine 1) - Toronto timezone
  if (today < fiscalYearStart) return;

  const daysSinceStart = Math.floor((today - fiscalYearStart) / (1000 * 60 * 60 * 24));
  const currentWeekNumber = Math.floor(daysSinceStart / 7) + 1;

  const allMonths = [-2, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];

  // Pour chaque mois, compter les semaines incompl√®tes pour Objectifs ET R√©sum√© s√©par√©ment
  allMonths.forEach(monthIndex => {
    let objectifsIncompleteCount = 0;
    let resumeIncompleteCount = 0;
    const monthKey = String(monthIndex);
    const monthData = window.weeklyData[monthKey];

    if (monthData) {
      // Parcourir les semaines du mois (1-5)
      for (let weekNumber = 1; weekNumber <= 5; weekNumber++) {
        const weekKey = String(weekNumber);
        const weekData = monthData[weekKey];

        // Calculer le num√©ro de semaine global
        let globalWeekNumber;
        
          globalWeekNumber = 13 + (monthIndex * 4) + weekNumber;
        

        // V√©rifier seulement les semaines pass√©es
        if (globalWeekNumber >= currentWeekNumber) continue;

        if (weekData) {
          // V√©rifier H Marketing (pour badge Objectifs)
          const hMarketing = weekData.h_marketing;
          const hMarketingIncomplete = (hMarketing === '-' || hMarketing === '' || hMarketing === undefined || hMarketing === null);
          if (hMarketingIncomplete) {
            objectifsIncompleteCount++;
          }

          // V√©rifier Probl√®me, Focus, Rating (pour badge R√©sum√©)
          let probleme = '';
          let focus = '';

          // Prioritize direct fields, fallback to commentaire parsing
          if (weekData.probleme !== undefined) {
            probleme = weekData.probleme;
          } else {
            const commentaireRaw = weekData.commentaire || '';
            if (commentaireRaw.includes('|')) {
              const parts = commentaireRaw.split('|');
              parts.forEach(part => {
                const trimmed = part.trim();
                if (trimmed.startsWith('Probl√®me:')) {
                  probleme = trimmed.replace('Probl√®me:', '').trim();
                }
              });
            }
          }

          if (weekData.focus !== undefined) {
            focus = weekData.focus;
          } else {
            const commentaireRaw = weekData.commentaire || '';
            if (commentaireRaw.includes('|')) {
              const parts = commentaireRaw.split('|');
              parts.forEach(part => {
                const trimmed = part.trim();
                if (trimmed.startsWith('Focus:')) {
                  focus = trimmed.replace('Focus:', '').trim();
                }
              });
            }
          }

          const problemeIncomplete = (probleme === '' || probleme === '-');
          const focusIncomplete = (focus === '' || focus === '-');
          const rating = weekData.rating || 0;
          const ratingIncomplete = (rating === 0);

          if (problemeIncomplete || focusIncomplete || ratingIncomplete) {
            resumeIncompleteCount++;
          }
        } else {
          // Pas de donn√©es pour cette semaine = incomplet pour les deux
          objectifsIncompleteCount++;
          resumeIncompleteCount++;
        }
      }
    }

    // Total = Objectifs + R√©sum√©
    const totalIncompleteCount = objectifsIncompleteCount + resumeIncompleteCount;

    // Mettre √† jour le badge du mois dans le dropdown
    const monthBadge = document.querySelector(`.month-badge[data-month="${monthIndex}"]`);
    if (monthBadge) {
      if (totalIncompleteCount > 0) {
        monthBadge.textContent = totalIncompleteCount;
        monthBadge.classList.remove('hidden');
      } else {
        monthBadge.classList.add('hidden');
      }
    }
  });
}

// V√©rifier si on est en mode √©dition (bouton edit cach√© = mode √©dition actif)
function isInEditMode() {
  const editBtn = document.getElementById('editWeekJanBtn');
  return editBtn?.classList.contains('hidden') || false;
}

// Change month function
async function changeMonth(monthIndex, forceChange = false) {
  // V√©rifier si on est en mode √©dition avec des modifications non enregistr√©es
  if (!forceChange && isInEditMode()) {
    // Faire shake le bouton pour attirer l'attention
    shakeSaveButton();

    // Afficher une alerte
    const confirmChange = confirm('‚ö†Ô∏è Vous avez des modifications non enregistr√©es!\n\nVoulez-vous quitter sans enregistrer?');
    if (!confirmChange) {
      // L'utilisateur veut rester - ne pas changer de mois
      return;
    }
    // L'utilisateur veut quitter - cacher le bouton save et continuer
    const saveBtn = document.getElementById('saveWeekJanBtn');
    if (saveBtn) saveBtn.classList.add('hidden');
  }

  // Afficher le loader sur la section contenu uniquement (pas le header)
  const contentSection = document.getElementById('weekly-content-section');
  if (contentSection) {
    const loader = document.createElement('div');
    loader.id = 'month-change-loader';
    loader.style.cssText = `
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10500;
      min-height: 100%;
    `;
    loader.innerHTML = `
      <div style="text-align: center;">
        <div class="spinner" style="
          width: 40px;
          height: 40px;
          border: 3px solid rgba(82, 113, 255, 0.2);
          border-top-color: #5271ff;
          border-radius: 50%;
          animation: spin 0.8s linear infinite;
          margin: 0 auto 12px;
        "></div>
        <div style="color: #9ca3af; font-size: 14px;">Chargement...</div>
      </div>
    `;

    // Ajouter l'animation de rotation
    if (!document.getElementById('spinner-animation-style')) {
      const style = document.createElement('style');
      style.id = 'spinner-animation-style';
      style.textContent = `
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
      `;
      document.head.appendChild(style);
    }

    contentSection.appendChild(loader);
  }

  currentWeeklyMonthIndex = monthIndex;
  const monthInfo = getMonthInfo(monthIndex);

  document.getElementById('currentMonthLabel').textContent = 'Objectifs et r√©sultats hebdomadaires - ' + monthInfo.fullName;

  // Update dropdown text
  const dropdownText = document.querySelector('#monthSelector .custom-select-text');
  if (dropdownText) {
    dropdownText.textContent = monthInfo.fullName;
  }

  // Sauvegarder l'onglet actif avant de changer les tables
  const isResumeActive = document.getElementById('resumeTable') && !document.getElementById('resumeTable').classList.contains('hidden');

  // Generate new tables (uses calculated week labels from getWeeksForMonth)
  const tables = generateWeeklyTables(monthIndex);

  // Replace old tables with new ones
  const oldObjectifs = document.getElementById('objectifsTable');
  const oldResume = document.getElementById('resumeTable');

  // Create temporary div to parse HTML
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = tables.objectifs + tables.resume;

  // Replace tables
  oldObjectifs.replaceWith(tempDiv.children[0]);
  oldResume.replaceWith(tempDiv.children[0]);

  // Re-initialize star rating event listeners
  initStarRatings();

  // Re-initialize objective input event listeners
  initObjectiveInputListeners();

  // Restaurer l'onglet actif
  if (isResumeActive) {
    showResume();
  } else {
    showObjectifs();
  }

  // Load saved weekly data for this month
  await loadWeeklyDataForMonth(monthIndex);

  // Calculer les totaux hebdomadaires et mettre √† jour la section mensuelle
  setTimeout(() => {
    calculateMonthlyTotalsFromWeekly(monthIndex);
  }, 50);

  // Synchroniser les pr√©visions du plan vers RPO
  // D√âSACTIV√â: Les objectifs sont d√©j√† remplis par generateWeeklyTables() depuis window.planWeeklyTargets
  // setTimeout(() => {
  //   syncPlanToRPO();
  // }, 100);

  // Synchroniser les donn√©es r√©elles RPO vers le plan
  // NOTE: Utiliser loadRPODataIntoPlan() au lieu de syncRPOToPlan()
  // car loadRPODataIntoPlan() fait le bon matching par week_label et le bon formatage
  setTimeout(() => {
    if (typeof loadRPODataIntoPlan === 'function') {
      loadRPODataIntoPlan();
    }
  }, 200);

  // Ajouter event listeners pour mise √† jour en temps r√©el
  setTimeout(() => {
    setupWeeklyRealtimeUpdate();
  }, 250);

  // Mettre √† jour le badge de semaines incompl√®tes
  setTimeout(() => {
    updateIncompleteWeeksBadge();
  }, 300);

  // Rafra√Æchir la vue mobile apr√®s changement de mois
  if (window.innerWidth <= 600) {
    setTimeout(() => {
      // Repopuler le dropdown avec les nouvelles semaines
      populateWeekDropdown();
      // Rafra√Æchir la vue de la semaine courante
      updateMobileWeeklyView(currentMobileWeek);
    }, 400);
  }

  // Retirer le loader apr√®s que tout soit charg√© et format√©
  setTimeout(() => {
    const loader = document.getElementById('month-change-loader');
    if (loader) {
      loader.remove();
    }
  }, 500);
}

// Ajouter des event listeners pour mise √† jour en temps r√©el
function setupWeeklyRealtimeUpdate() {
  const weeklyInputs = document.querySelectorAll('[data-field]');

  weeklyInputs.forEach(input => {
    // Supprimer les anciens listeners pour √©viter les doublons
    input.removeEventListener('input', handleWeeklyInputChange);
    input.removeEventListener('change', handleWeeklyInputChange);

    // Ajouter les nouveaux listeners
    input.addEventListener('input', handleWeeklyInputChange);
    input.addEventListener('change', handleWeeklyInputChange);
  });
}

// Toggle edit mode for coach objectives (January only - HEURES P√ÄP REP)
function toggleEditCoachObjectives(monthIndex) {
  if (monthIndex !== 0) return; // Only for January

  const abbr = 'jan';
  const input = document.getElementById(`${abbr}-obj-rep-reel`);
  const editBtn = document.getElementById(`editCoachBtn-${abbr}`);
  const saveBtn = document.getElementById(`saveCoachBtn-${abbr}`);

  if (!input) return;

  const isDisabled = input.disabled;

  if (isDisabled) {
    // Mode √©dition - activer l'input
    input.disabled = false;
    input.classList.add('editable-input');
    input.style.background = 'rgba(96, 165, 250, 0.1)';
    input.style.border = '2px solid rgba(96, 165, 250, 0.3)';
    input.style.padding = '0.5rem';

    // Enlever le formatage pour permettre la saisie
    const value = parseFloat(input.dataset.value) || 0;
    input.value = value.toString();

    input.focus();
    input.select();

    editBtn.classList.add('hidden');
    saveBtn.classList.remove('hidden');
  } else {
    // Mode lecture - d√©sactiver l'input
    input.disabled = true;
    input.classList.remove('editable-input');
    input.style.background = 'transparent';
    input.style.border = 'none';
    input.style.padding = '0';

    editBtn.classList.remove('hidden');
    saveBtn.classList.add('hidden');
  }
}

// Save coach objectives (January only - HEURES P√ÄP REP)
async function saveCoachObjectives(monthIndex) {
  if (monthIndex !== 0) return; // Only for January

  const abbr = 'jan';
  const input = document.getElementById(`${abbr}-obj-rep-reel`);
  const saveBtn = document.getElementById(`saveCoachBtn-${abbr}`);

  if (!input) return;

  // Sauvegarder l'HTML original du bouton
  const originalHTML = saveBtn.innerHTML;

  // Afficher l'ic√¥ne de chargement
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  saveBtn.disabled = true;
  saveBtn.style.cursor = 'wait';
  saveBtn.style.opacity = '0.7';

  try {
    // Nettoyer et formater la valeur
    const cleanValue = input.value.replace(/[^\d.]/g, '');
    const numericValue = parseFloat(cleanValue) || 0;

    // Mettre √† jour le dataset
    input.dataset.value = numericValue;

    // Formater l'affichage
    input.value = numericValue.toFixed(1) + ' h';

    // Mettre √† jour window.allMonthlyData
    if (!window.allMonthlyData) {
      window.allMonthlyData = {};
    }
    if (!window.allMonthlyData[abbr]) {
      window.allMonthlyData[abbr] = {};
    }
    window.allMonthlyData[abbr].obj_rep_reel = numericValue;

    // Sauvegarder dans le backend
    await saveMonthlyDataToBackend(monthIndex);

    // Revenir en mode lecture
    toggleEditCoachObjectives(monthIndex);

    // Recalculer le pourcentage
    calculateObjectifPercentage(abbr, 'rep');

    // V√©rifier si l'alerte doit √™tre affich√©e ou masqu√©e
    checkCoachObjectivesAlert(abbr);

  } finally {
    // Restaurer le bouton
    setTimeout(() => {
      saveBtn.innerHTML = originalHTML;
      saveBtn.disabled = false;
      saveBtn.style.cursor = '';
      saveBtn.style.opacity = '';
    }, 300);
  }
}

// Handler pour les changements dans les inputs hebdomadaires
function handleWeeklyInputChange(event) {
  const input = event.target;
  const field = input.dataset.field;

  // Pour h_marketing: garder "-" si c'est la valeur, sinon nettoyer
  if (field === 'h_marketing') {
    if (input.value === '-' || input.value.trim() === '') {
      input.dataset.value = '-';
    } else {
      const cleanValue = input.value.replace(/[^\d.]/g, '');
      input.dataset.value = cleanValue || '0';
    }
  } else {
    // Pour les autres champs: nettoyer normalement
    const cleanValue = input.value.replace(/[^\d.]/g, '');
    input.dataset.value = cleanValue || '0';
  }

  // Recalculer les totaux avec un debounce l√©ger
  clearTimeout(window.weeklyUpdateTimeout);
  window.weeklyUpdateTimeout = setTimeout(() => {
    if (typeof currentWeeklyMonthIndex !== 'undefined') {
      calculateMonthlyTotalsFromWeekly(currentWeeklyMonthIndex);
    }
  }, 100);
}

// Calculer les totaux hebdomadaires et mettre √† jour la section mensuelle
function calculateMonthlyTotalsFromWeekly(monthIndex) {
  const monthInfo = getMonthInfo(monthIndex);
  const abbr = monthInfo.abbr;

  // Parcourir tous les inputs hebdomadaires avec data-field
  const hMarketingInputs = document.querySelectorAll('[data-field="h_marketing"]');
  const estimationInputs = document.querySelectorAll('[data-field="estimation"]');
  const contractInputs = document.querySelectorAll('[data-field="contract"]');
  const dollarInputs = document.querySelectorAll('[data-field="dollar"]');

  // Calculer les totaux
  let totalHMarketing = 0;
  let totalEstimation = 0;
  let totalContract = 0;
  let totalDollar = 0;

  hMarketingInputs.forEach(input => {
    const dataValue = input.dataset.value;
    // Ne pas compter les "-" (non modifi√©s) dans le total
    if (dataValue !== '-' && dataValue !== '') {
      const value = parseFloat(dataValue) || 0;
      totalHMarketing += value;
    }
  });

  estimationInputs.forEach(input => {
    const value = parseFloat(input.dataset.value) || 0;
    totalEstimation += value;
  });

  contractInputs.forEach(input => {
    const value = parseFloat(input.dataset.value) || 0;
    totalContract += value;
  });

  dollarInputs.forEach(input => {
    const value = parseFloat(input.dataset.value) || 0;
    totalDollar += value;
  });

  // Mettre √† jour les divs r√©elles dans la section mensuelle (avec les IDs bas√©s sur abbr)
  const hrpapReelDiv = document.getElementById(`${abbr}-hrpap-reel`);
  const estimationReelDiv = document.getElementById(`${abbr}-estimation-reel`);
  const contractReelDiv = document.getElementById(`${abbr}-contract-reel`);
  const dollarReelDiv = document.getElementById(`${abbr}-dollar-reel`);

  if (hrpapReelDiv) {
    hrpapReelDiv.textContent = totalHMarketing.toFixed(1) + ' h';
    hrpapReelDiv.dataset.value = totalHMarketing;
  }

  if (estimationReelDiv) {
    estimationReelDiv.textContent = Math.round(totalEstimation).toString();
    estimationReelDiv.dataset.value = totalEstimation;
  }

  if (contractReelDiv) {
    contractReelDiv.textContent = Math.round(totalContract).toString();
    contractReelDiv.dataset.value = totalContract;
  }

  if (dollarReelDiv) {
    dollarReelDiv.textContent = Math.round(totalDollar).toLocaleString('fr-CA') + ' $';
    dollarReelDiv.dataset.value = totalDollar;
  }

  // Mettre √† jour window.allMonthlyData pour le mois actuel
  if (!window.allMonthlyData) {
    window.allMonthlyData = {};
  }
  if (!window.allMonthlyData[abbr]) {
    window.allMonthlyData[abbr] = {};
  }

  window.allMonthlyData[abbr].hrpap_reel = totalHMarketing;
  window.allMonthlyData[abbr].estimation_reel = totalEstimation;
  window.allMonthlyData[abbr].contract_reel = totalContract;
  window.allMonthlyData[abbr].dollar_reel = totalDollar;

  // Calculer les valeurs r√©elles des objectifs coach selon le mois
  const objPapReelDiv = document.getElementById(`${abbr}-obj-pap-reel`);
  const objRepReelDiv = document.getElementById(`${abbr}-obj-rep-reel`);

  let objPapReelValue = 0;
  let objRepReelValue = 0;

  // Mapper les valeurs selon le mois (index)
  // D√©cembre 2025 (index -2) utilise les m√™mes valeurs qu'octobre 2026
  let adjustedIndex = monthIndex;

  switch (adjustedIndex) {
    case 0: // Janvier
      objPapReelValue = totalHMarketing; // HEURES P√ÄP
      // HEURES P√ÄP (REP) est MANUEL pour janvier - ne pas √©craser
      objRepReelValue = objRepReelDiv ? (parseFloat(objRepReelDiv.dataset.value) || 0) : 0;
      break;
    case 1: // F√©vrier
      objPapReelValue = totalHMarketing; // HEURES P√ÄP
      objRepReelValue = totalEstimation; // Estimations
      break;
    case 2: // Mars
      objPapReelValue = totalEstimation; // Estimations
      objRepReelValue = totalContract; // Ventes
      break;
    case 3: // Avril
      objPapReelValue = totalContract; // Ventes
      objRepReelValue = 0; // Peintres (TODO: √† d√©finir)
      break;
    case 4: // Mai
    case 5: // Juin
    case 6: // Juillet
      objPapReelValue = totalContract; // Ventes
      objRepReelValue = totalHMarketing > 0 ? totalDollar / totalHMarketing : 0; // Prod Horaire ($/h)
      break;
    case 7: // Ao√ªt
      objPapReelValue = totalContract; // Ventes
      objRepReelValue = totalDollar; // $ Produit
      break;
    case 8: // Septembre
      objPapReelValue = totalDollar; // $ Produit
      objRepReelValue = 0; // Pas de 2e objectif
      break;
    case 9: // Octobre
    case 10: // Novembre
    case 11: // D√©cembre
      objPapReelValue = totalHMarketing; // HEURES P√ÄP
      objRepReelValue = totalDollar; // $ Vendus
      break;
  }

  // Mettre √† jour les divs r√©elles des objectifs coach
  if (objPapReelDiv) {
    const suffix = getObjectifSuffix(monthIndex, 'pap');
    if (suffix === ' h') {
      objPapReelDiv.textContent = objPapReelValue.toFixed(1) + suffix;
    } else if (suffix === ' $') {
      objPapReelDiv.textContent = Math.round(objPapReelValue).toLocaleString('fr-CA') + suffix;
    } else if (suffix === ' $/h') {
      objPapReelDiv.textContent = objPapReelValue.toFixed(2) + suffix;
    } else {
      objPapReelDiv.textContent = Math.round(objPapReelValue).toString();
    }
    objPapReelDiv.dataset.value = objPapReelValue;
  }

  if (objRepReelDiv) {
    const suffix = getObjectifSuffix(monthIndex, 'rep');

    // Pour janvier (index 0), obj-rep-reel est MANUEL - ne pas √©craser
    // Pour les autres mois, mettre √† jour automatiquement
    if (adjustedIndex !== 0) {
      if (suffix === ' h') {
        objRepReelDiv.textContent = objRepReelValue.toFixed(1) + suffix;
      } else if (suffix === ' $') {
        objRepReelDiv.textContent = Math.round(objRepReelValue).toLocaleString('fr-CA') + suffix;
      } else if (suffix === ' $/h') {
        objRepReelDiv.textContent = objRepReelValue.toFixed(2) + suffix;
      } else if (suffix !== null) {
        objRepReelDiv.textContent = Math.round(objRepReelValue).toString();
      }
      objRepReelDiv.dataset.value = objRepReelValue;
    }
    // Pour janvier, on garde la valeur existante (d√©j√† dans dataset.value)
  }

  // Sauvegarder dans window.allMonthlyData
  window.allMonthlyData[abbr].obj_pap_reel = objPapReelValue;
  window.allMonthlyData[abbr].obj_rep_reel = objRepReelValue;

  // Recalculer les pourcentages
  calculateObjectifPercentage(abbr, 'pap');
  calculateObjectifPercentage(abbr, 'rep');
  calculateMonthPercentage(abbr, 'hrpap');
  calculateMonthPercentage(abbr, 'estimation');
  calculateMonthPercentage(abbr, 'contract');
  calculateMonthPercentage(abbr, 'dollar');

  // S'assurer que tous les mois sont pr√©sents dans window.allMonthlyData avant de calculer les totaux annuels
  // Ceci garantit que les totaux annuels refl√®tent TOUS les mois, pas seulement le mois actuel
  ensureAllMonthsInAllMonthlyData();

  // NOTE: Ne PAS appeler calculateAnnualTotalsFromMonthly() ici car cela cause une triple comptabilisation
  // Appeler ensureAllMonthsInAllMonthlyData() suffit pour mettre √† jour window.allMonthlyData, et
  // calculateAllMonthlyTotalsFromWeekly() s'occupe d√©j√† de recalculer les totaux annuels.
  // calculateAnnualTotalsFromMonthly();
}

// S'assurer que tous les mois sont dans window.allMonthlyData
// Si un mois manque, le calculer depuis window.weeklyData
function ensureAllMonthsInAllMonthlyData() {
  if (!window.weeklyData) {
    return;
  }

  if (!window.allMonthlyData) {
    window.allMonthlyData = {};
  }

  // Inclure D√©cembre 2025 (index -2) + 12 mois 2026 (index 0-11)
  const allMonths = [-2, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];

  // Pour chaque mois, v√©rifier s'il existe dans window.allMonthlyData
  for (let monthIndex of allMonths) {
    const monthInfo = getMonthInfo(monthIndex);
    const abbr = monthInfo.abbr;

    // Si le mois n'existe pas ou n'a pas de donn√©es, le calculer depuis window.weeklyData
    if (!window.allMonthlyData[abbr] ||
        window.allMonthlyData[abbr].hrpap_reel === undefined) {

      const monthKey = String(monthIndex);
      const monthWeeklyData = window.weeklyData[monthKey];

      let totalHMarketing = 0;
      let totalEstimation = 0;
      let totalContract = 0;
      let totalDollar = 0;

      // Si le mois a des donn√©es hebdomadaires
      if (monthWeeklyData) {
        // Parcourir toutes les semaines du mois
        Object.keys(monthWeeklyData).forEach(weekNumber => {
          const weekData = monthWeeklyData[weekNumber];

          // Ignorer les valeurs "-" mais compter les 0
          if (weekData.h_marketing !== '-' && weekData.h_marketing !== undefined) {
            totalHMarketing += parseFloat(weekData.h_marketing) || 0;
          }
          if (weekData.estimation !== '-' && weekData.estimation !== undefined) {
            totalEstimation += parseFloat(weekData.estimation) || 0;
          }
          if (weekData.contract !== '-' && weekData.contract !== undefined) {
            totalContract += parseFloat(weekData.contract) || 0;
          }
          if (weekData.dollar !== '-' && weekData.dollar !== undefined) {
            totalDollar += parseFloat(weekData.dollar) || 0;
          }
        });
      }

      // Cr√©er l'objet si n√©cessaire
      if (!window.allMonthlyData[abbr]) {
        window.allMonthlyData[abbr] = {};
      }

      // Mettre √† jour les totaux
      window.allMonthlyData[abbr].hrpap_reel = totalHMarketing;
      window.allMonthlyData[abbr].estimation_reel = totalEstimation;
      window.allMonthlyData[abbr].contract_reel = totalContract;
      window.allMonthlyData[abbr].dollar_reel = totalDollar;
    }
  }
}

// Calculer les totaux mensuels R√âEL pour TOUS les mois depuis weekly data
function calculateAllMonthlyTotalsFromWeekly() {

  if (!window.weeklyData) {
    log('[MONTHLY] Pas de window.weeklyData');
    return;
  }

  // Initialiser window.allMonthlyData si n√©cessaire
  if (!window.allMonthlyData) {
    window.allMonthlyData = {};
  }

  log('[MONTHLY] D√©but calcul monthly totals depuis weekly data');
  log('[MONTHLY] window.weeklyData:', window.weeklyData);

  // Inclure D√©cembre 2025 (index -2) + 12 mois 2026 (index 0-11)
  const allMonths = [-2, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];

  // Pour chaque mois
  for (let monthIndex of allMonths) {
    const monthInfo = getMonthInfo(monthIndex);
    const abbr = monthInfo.abbr;
    const monthKey = String(monthIndex);
    const monthWeeklyData = window.weeklyData[monthKey];

    log(`[MONTHLY] Mois ${monthIndex} (${abbr}, key="${monthKey}"):`, monthWeeklyData);

    let totalHMarketing = 0;
    let totalEstimation = 0;
    let totalContract = 0;
    let totalDollar = 0;

    // Si le mois a des donn√©es hebdomadaires
    if (monthWeeklyData) {
      // Parcourir toutes les semaines du mois
      Object.keys(monthWeeklyData).forEach(weekNumber => {
        const weekData = monthWeeklyData[weekNumber];

        log(`[MONTHLY]   Semaine ${weekNumber}:`, weekData);

        // Ignorer les valeurs "-" mais compter les 0
        if (weekData.h_marketing !== '-' && weekData.h_marketing !== undefined) {
          const hValue = parseFloat(weekData.h_marketing) || 0;
          totalHMarketing += hValue;
          log(`[MONTHLY]     -> h_marketing: ${hValue}h (total: ${totalHMarketing}h)`);
        } else {
          log(`[MONTHLY]     -> h_marketing ignor√©: "${weekData.h_marketing}"`);
        }
        if (weekData.estimation !== '-' && weekData.estimation !== undefined) {
          totalEstimation += parseFloat(weekData.estimation) || 0;
        }
        if (weekData.contract !== '-' && weekData.contract !== undefined) {
          totalContract += parseFloat(weekData.contract) || 0;
        }
        if (weekData.dollar !== '-' && weekData.dollar !== undefined) {
          totalDollar += parseFloat(weekData.dollar) || 0;
        }
      });
    }

    log(`[MONTHLY] Mois ${monthIndex} (${abbr}) total H PAP: ${totalHMarketing}h`);

    // Mettre √† jour window.allMonthlyData
    if (!window.allMonthlyData[abbr]) {
      window.allMonthlyData[abbr] = {};
    }

    window.allMonthlyData[abbr].hrpap_reel = totalHMarketing;
    window.allMonthlyData[abbr].estimation_reel = totalEstimation;
    window.allMonthlyData[abbr].contract_reel = totalContract;
    window.allMonthlyData[abbr].dollar_reel = totalDollar;

    log(`[MONTHLY] window.allMonthlyData[${abbr}].hrpap_reel = ${totalHMarketing}h`);

    // Mettre √† jour l'affichage si le div existe (mois actuellement affich√©)
    const hrpapReelDiv = document.getElementById(`${abbr}-hrpap-reel`);
    const estimationReelDiv = document.getElementById(`${abbr}-estimation-reel`);
    const contractReelDiv = document.getElementById(`${abbr}-contract-reel`);
    const dollarReelDiv = document.getElementById(`${abbr}-dollar-reel`);

    if (hrpapReelDiv) {
      hrpapReelDiv.textContent = totalHMarketing.toFixed(1) + ' h';
      hrpapReelDiv.dataset.value = totalHMarketing;
    }

    if (estimationReelDiv) {
      estimationReelDiv.textContent = Math.round(totalEstimation).toString();
      estimationReelDiv.dataset.value = totalEstimation;
    }

    if (contractReelDiv) {
      contractReelDiv.textContent = Math.round(totalContract).toString();
      contractReelDiv.dataset.value = totalContract;
    }

    if (dollarReelDiv) {
      dollarReelDiv.textContent = Math.round(totalDollar).toLocaleString('fr-CA') + ' $';
      dollarReelDiv.dataset.value = totalDollar;
    }

    // Recalculer les pourcentages si le mois est affich√©
    if (hrpapReelDiv) {
      calculateMonthPercentage(abbr, 'hrpap');
      calculateMonthPercentage(abbr, 'estimation');
      calculateMonthPercentage(abbr, 'contract');
      calculateMonthPercentage(abbr, 'dollar');
    }
  }

  // Calculer les totaux annuels directement depuis window.weeklyData (mois 0-11 seulement)
  let annualHrpap = 0;
  let annualEstimation = 0;
  let annualContract = 0;
  let annualDollar = 0;

  for (let monthIndex = 0; monthIndex <= 11; monthIndex++) {
    const monthKey = String(monthIndex);
    const monthWeeklyData = window.weeklyData[monthKey];
    if (monthWeeklyData) {
      Object.keys(monthWeeklyData).forEach(weekNumber => {
        const weekData = monthWeeklyData[weekNumber];
        if (weekData.h_marketing !== '-' && weekData.h_marketing !== undefined) {
          annualHrpap += parseFloat(weekData.h_marketing) || 0;
        }
        if (weekData.estimation !== '-' && weekData.estimation !== undefined) {
          annualEstimation += parseFloat(weekData.estimation) || 0;
        }
        if (weekData.contract !== '-' && weekData.contract !== undefined) {
          annualContract += parseFloat(weekData.contract) || 0;
        }
        if (weekData.dollar !== '-' && weekData.dollar !== undefined) {
          annualDollar += parseFloat(weekData.dollar) || 0;
        }
      });
    }
  }

  // Mettre √† jour les totaux annuels dans l'UI
  const annualHrpapDiv = document.getElementById('annual-hrpap-reel');
  const annualEstimationDiv = document.getElementById('annual-estimation-reel');
  const annualContractDiv = document.getElementById('annual-contract-reel');
  const annualDollarDiv = document.getElementById('annual-dollar-reel');

  if (annualHrpapDiv) {
    annualHrpapDiv.textContent = annualHrpap.toFixed(1) + ' h';
    annualHrpapDiv.dataset.value = annualHrpap;
  }
  if (annualEstimationDiv) {
    annualEstimationDiv.textContent = Math.round(annualEstimation).toString();
    annualEstimationDiv.dataset.value = annualEstimation;
  }
  if (annualContractDiv) {
    annualContractDiv.textContent = Math.round(annualContract).toString();
    annualContractDiv.dataset.value = annualContract;
  }
  if (annualDollarDiv) {
    annualDollarDiv.textContent = Math.round(annualDollar).toLocaleString('fr-CA') + ' $';
    annualDollarDiv.dataset.value = annualDollar;
  }

  log(`[ANNUAL] Totaux calcul√©s depuis weekly: H=${annualHrpap}h, Est=${annualEstimation}, Contrats=${annualContract}, $=${annualDollar}`);

  // Recalculer les m√©triques calcul√©es (mktg, vente, moyen, tendance)
  calculateAnnualMetrics();

  // Recalculer les pourcentages
  calculatePercentage('hrpap');
  calculatePercentage('estimation');
  calculatePercentage('contract');
  calculatePercentage('dollar');

  // S'assurer que l'affichage de objectifCA est correct
  const objectifCAInput = document.getElementById('objectifCA');
  if (objectifCAInput && objectifCAInput.dataset.value) {
    const objectifCA = parseFloat(objectifCAInput.dataset.value) || 0;
    objectifCAInput.value = objectifCA.toLocaleString('fr-CA', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).replace(/\s/g, ' ') + ' $';
  }

  // Recalculer le % Objectif CA
  calculateObjectifCAProgress();
}

// Calculer les totaux annuels R√âEL en additionnant les 12 mois
function calculateAnnualTotalsFromMonthly() {
  let totalHrpap = 0;
  let totalEstimation = 0;
  let totalContract = 0;
  let totalDollar = 0;

  log('[ANNUAL] D√©but calcul totaux annuels depuis monthly data');
  log('[ANNUAL] window.allMonthlyData:', window.allMonthlyData);

  // Additionner tous les mois depuis window.allMonthlyData
  // Inclure D√©cembre 2025 (index -2) + 12 mois 2026
  if (window.allMonthlyData) {
    const allMonths = [-2, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
    allMonths.forEach(monthIndex => {
      const monthInfo = getMonthInfo(monthIndex);
      const abbr = monthInfo.abbr;
      const monthData = window.allMonthlyData[abbr];
      log(`[ANNUAL] Mois ${monthIndex} (${abbr}):`, monthData);
      if (monthData) {
        const hrpap = parseFloat(monthData.hrpap_reel) || 0;
        totalHrpap += hrpap;
        totalEstimation += parseFloat(monthData.estimation_reel) || 0;
        totalContract += parseFloat(monthData.contract_reel) || 0;
        totalDollar += parseFloat(monthData.dollar_reel) || 0;
        log(`[ANNUAL]   -> H PAP: ${hrpap}h, Total cumul√©: ${totalHrpap}h`);
      }
    });
  }

  log('[ANNUAL] Total final H PAP:', totalHrpap);

  // Mettre √† jour les totaux annuels
  const annualHrpapDiv = document.getElementById('annual-hrpap-reel');
  const annualEstimationDiv = document.getElementById('annual-estimation-reel');
  const annualContractDiv = document.getElementById('annual-contract-reel');
  const annualDollarDiv = document.getElementById('annual-dollar-reel');

  if (annualHrpapDiv) {
    annualHrpapDiv.textContent = totalHrpap.toFixed(1) + ' h';
    annualHrpapDiv.dataset.value = totalHrpap;
  }

  if (annualEstimationDiv) {
    annualEstimationDiv.textContent = Math.round(totalEstimation).toString();
    annualEstimationDiv.dataset.value = totalEstimation;
  }

  if (annualContractDiv) {
    annualContractDiv.textContent = Math.round(totalContract).toString();
    annualContractDiv.dataset.value = totalContract;
  }

  if (annualDollarDiv) {
    annualDollarDiv.textContent = Math.round(totalDollar).toLocaleString('fr-CA') + ' $';
    annualDollarDiv.dataset.value = totalDollar;
  }

  // Recalculer les pourcentages
  calculatePercentage('hrpap');
  calculatePercentage('estimation');
  calculatePercentage('contract');
  calculatePercentage('dollar');

  // Recalculer les m√©triques calcul√©es
  calculateAnnualMetrics();

  // Recalculer le % Objectif CA
  calculateObjectifCAProgress();
}

// Calculer les m√©triques annuelles automatiquement
function calculateAnnualMetrics() {
  // R√©cup√©rer les valeurs r√©elles des 4 m√©triques de base (section annuelle)
  const hrpapReelDiv = document.getElementById('annual-hrpap-reel');
  const estimationReelDiv = document.getElementById('annual-estimation-reel');
  const contractReelDiv = document.getElementById('annual-contract-reel');
  const dollarReelDiv = document.getElementById('annual-dollar-reel');

  const hrpapReel = parseFloat(hrpapReelDiv?.dataset.value) || 0;
  const estimationReel = parseFloat(estimationReelDiv?.dataset.value) || 0;
  const contractReel = parseFloat(contractReelDiv?.dataset.value) || 0;
  const dollarReel = parseFloat(dollarReelDiv?.dataset.value) || 0;

  // 1. Taux marketing = (Estimations / H Marketing) * 100
  const tauxMktg = hrpapReel > 0 ? (estimationReel / hrpapReel) * 100 : 0;
  const mktgReelDiv = document.getElementById('mktg-reel');
  if (mktgReelDiv) {
    mktgReelDiv.textContent = tauxMktg.toFixed(1) + '%';
    mktgReelDiv.dataset.value = tauxMktg;
  }

  // 2. Taux de vente = (Contrats / Estimations) * 100
  const tauxVente = estimationReel > 0 ? (contractReel / estimationReel) * 100 : 0;
  const venteReelDiv = document.getElementById('vente-reel');
  if (venteReelDiv) {
    venteReelDiv.textContent = tauxVente.toFixed(1) + '%';
    venteReelDiv.dataset.value = tauxVente;
  }

  // 3. Contrat moyen = $ sign√©s / Contrats
  const contratMoyen = contractReel > 0 ? dollarReel / contractReel : 0;
  const moyenReelDiv = document.getElementById('moyen-reel');
  if (moyenReelDiv) {
    moyenReelDiv.textContent = Math.round(contratMoyen).toLocaleString('fr-CA') + ' $';
    moyenReelDiv.dataset.value = contratMoyen;
  }

  // 4. Tendance CA attendu = calcul bas√© sur le cumul des pourcentages du plan d'affaires
  // Formule: ($ sign√© total) / (cumul % objectif) * 100

  // Pattern de pourcentages identique √† generatePlanWeeks
  const percentagePattern = [
    0,  // Index 0: 5-11 janv 2026 (semaine vide)
    0.5, 2.0, 2.0,  // Index 1-3: 12 janv - 1 f√©v
    3.0, 2.5, 3.0, 3.0,  // Index 4-7: 2 f√©v - 1 mars (2-8 f√©v: +0.5% = 3.0%)
    3.5, 4.0, 4.5, 5.5,  // Index 8-11: 2 mars - 29 mars
    4.5, 6.5, 5.5, 6.0, 6.0,  // Index 12-16: 30 mars - 4 mai
    4.5, 4.5, 4.5, 4.5,  // Index 17-20: 5 mai - 1 juin
    3.5, 4.0, 3.5, 3.0,  // Index 21-24: 2 juin - 29 juin
    3.0, 3.0, 3.0, 2.0, 1.0,  // Index 25-29: 30 juin - 3 ao√ªt
    1.0, 1.0, 1.0, 1.0,  // Index 30-33: 4 ao√ªt - 31 ao√ªt
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  // Index 34-51: reste (0%)
  ];

  // Calculer quelle semaine on est (0-51 depuis le 5 janvier 2026)
  const today = new Date();
  const jan5_2026 = new Date(2026, 0, 5); // 5 janvier 2026
  const daysSinceJan5 = Math.floor((today - jan5_2026) / (24 * 60 * 60 * 1000));
  const currentWeekIndex = Math.floor(daysSinceJan5 / 7);

  // Calculer le cumul des pourcentages jusqu'√† la semaine actuelle
  let cumulPercent = 0;
  for (let i = 0; i <= currentWeekIndex && i < percentagePattern.length; i++) {
    cumulPercent += percentagePattern[i];
  }

  // S√©curit√©: si le cumul est 0, mettre 0.01
  if (cumulPercent === 0) {
    cumulPercent = 0.01;
  }

  // Calculer la tendance: ($ sign√© / (cumul % / 100))
  // Si cumul = 2.56%, alors: $ sign√© / 0.0256 = tendance annuelle
  const objectifCAInput = document.getElementById('tendance-vise');
  const objectifCA = parseFloat(objectifCAInput?.dataset.value) || 0;
  const tendanceCA = (cumulPercent > 0 && dollarReel > 0)
    ? dollarReel / (cumulPercent / 100)
    : 0;

  const tendanceReelDiv = document.getElementById('tendance-reel');
  if (tendanceReelDiv) {
    tendanceReelDiv.textContent = Math.round(tendanceCA).toLocaleString('fr-CA') + ' $';
    tendanceReelDiv.dataset.value = tendanceCA;
  }

  log(`[TENDANCE] Semaine actuelle: ${currentWeekIndex + 1} | $ Sign√©: ${dollarReel} | Cumul %: ${cumulPercent.toFixed(2)}% | Tendance: ${Math.round(tendanceCA)}`);

  // 5. Calculer la moyenne de prod horaire √† partir des semaines hebdomadaires (d√©cembre 2025 √† d√©cembre 2026)
  let totalProdHoraire = 0;
  let countProdHoraire = 0;

  if (window.weeklyData) {
    // Parcourir TOUS les mois de d√©cembre 2025 √† d√©cembre 2026 (index -2 √† 11)
    const allMonthIndices = [-2, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];

    for (let monthIdx of allMonthIndices) {
      const monthKey = String(monthIdx);
      const monthData = window.weeklyData[monthKey];

      if (monthData) {
        // Parcourir les semaines du mois (1-5)
        for (let weekNum = 1; weekNum <= 5; weekNum++) {
          const weekKey = String(weekNum);
          const weekData = monthData[weekKey];

          if (weekData && weekData.prod_horaire !== undefined && weekData.prod_horaire > 0) {
            totalProdHoraire += parseFloat(weekData.prod_horaire);
            countProdHoraire++;
          }
        }
      }
    }
  }

  const avgProdHoraire = countProdHoraire > 0 ? totalProdHoraire / countProdHoraire : 0;
  log(`[DATA] Prod Horaire Moyenne: ${avgProdHoraire.toFixed(2)} $/h (${countProdHoraire} semaines)`);

  // Sauvegarder les m√©triques calcul√©es automatiquement (avec prod horaire)
  saveCalculatedMetrics(tauxMktg, tauxVente, contratMoyen, avgProdHoraire);

  // Recalculer les pourcentages
  calculatePercentage('mktg');
  calculatePercentage('vente');
  calculatePercentage('moyen');
  calculatePercentage('tendance');
}

// Refresh weekly tables (call after monthly data changes)
function refreshWeeklyTables() {
  if (typeof currentWeeklyMonthIndex !== 'undefined') {
    changeMonth(currentWeeklyMonthIndex, true); // forceChange=true pour le refresh interne
  }
}

// Generic toggle edit for monthly data
function toggleEditMonthly(monthIndex) {
  const monthInfo = getMonthInfo(monthIndex);
  const abbr = monthInfo.abbr;

  // obj-pap et obj-rep sont EXCLUS - ils ne sont jamais modifiables (d√©finis par le coach)
  const inputs = [
    document.getElementById(`${abbr}-hrpap-vise`),
    document.getElementById(`${abbr}-estimation-vise`),
    document.getElementById(`${abbr}-contract-vise`),
    document.getElementById(`${abbr}-dollar-vise`)
  ];

  const editBtn = document.getElementById(`editMonthlyBtn-${abbr}`);
  const saveBtn = document.getElementById(`saveMonthlyBtn-${abbr}`);

  if (!inputs[0]) return;

  const isReadonly = inputs[0].hasAttribute('readonly');

  inputs.forEach(input => {
    if (input) {
      if (isReadonly) {
        input.removeAttribute('readonly');
        input.style.background = 'rgba(96, 165, 250, 0.1)';
        input.style.borderBottom = '2px solid var(--primary-blue)';
        input.style.color = 'var(--primary-blue)';
        input.style.padding = '4px 8px';
        input.style.borderRadius = '4px';

        // V√©rifier si la valeur est par d√©faut (0)
        const currentValue = input.value.trim();
        const parsedValue = parseFloat(currentValue.replace(/[^\d.-]/g, '')) || 0;
        if (parsedValue === 0) {
          // Valeur par d√©faut: mettre en placeholder et vider
          input.placeholder = currentValue;
          input.value = '';
        } else {
          // Valeur saisie: afficher la valeur num√©rique brute
          input.value = String(parsedValue);
          input.placeholder = '';
        }
      } else {
        input.setAttribute('readonly', 'true');
        input.style.background = 'transparent';
        input.style.borderBottom = 'none';
        input.style.color = 'var(--primary-blue)';
        input.style.padding = '';
        input.style.borderRadius = '0';
        input.placeholder = '';
      }
    }
  });

  if (editBtn && saveBtn) {
    if (isReadonly) {
      editBtn.classList.add('hidden');
      saveBtn.classList.remove('hidden');
    } else {
      editBtn.classList.remove('hidden');
      saveBtn.classList.add('hidden');
    }
  }
}

// Generic save for monthly data
async function saveMonthly(monthIndex) {
  const monthInfo = getMonthInfo(monthIndex);
  const abbr = monthInfo.abbr;
  const saveBtn = document.getElementById(`saveMonthlyBtn-${abbr}`);
  if (!saveBtn) return;

  const originalHTML = saveBtn.innerHTML;

  // Afficher le spinner
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i><span class="text-xs font-semibold">Enregistrement...</span>';
  saveBtn.disabled = true;
  saveBtn.style.cursor = 'not-allowed';
  saveBtn.style.opacity = '0.7';

  try {
    const monthInfo = getMonthInfo(monthIndex);
    const abbr = monthInfo.abbr;

    // Formater les inputs avant de sauvegarder
    // Note: obj-pap et obj-rep ne sont pas format√©s car ils ne sont jamais modifiables (d√©finis par le coach)
    formatMetricInput(`${abbr}-hrpap-vise`, 'h');
    formatMetricInput(`${abbr}-estimation-vise`, '');
    formatMetricInput(`${abbr}-contract-vise`, '');
    formatMetricInput(`${abbr}-dollar-vise`, '$');

    // Sauvegarder dans le backend AVANT de toggle
    await saveMonthlyDataToBackend(monthIndex);

    // Ensuite toggle pour revenir en mode lecture
    toggleEditMonthly(monthIndex);

    // Recalculer tous les pourcentages apr√®s sauvegarde
    calculateObjectifPercentage(abbr, 'pap');
    calculateObjectifPercentage(abbr, 'rep');
    calculateMonthPercentage(abbr, 'hrpap');
    calculateMonthPercentage(abbr, 'estimation');
    calculateMonthPercentage(abbr, 'contract');
    calculateMonthPercentage(abbr, 'dollar');

    // V√©rifier si l'alerte doit √™tre affich√©e ou masqu√©e
    checkMonthlyObjectivesAlert(abbr);

    // R√©g√©n√©rer le plan d'affaire avec animation
    await reloadPlanWithAnimation();
  } finally {
    // Restaurer le bouton
    setTimeout(() => {
      saveBtn.innerHTML = originalHTML;
      saveBtn.disabled = false;
      saveBtn.style.cursor = '';
      saveBtn.style.opacity = '';
    }, 300);
  }

  // Refresh weekly tables if this month is currently displayed
  if (currentWeeklyMonthIndex === monthIndex) {
    refreshWeeklyTables();
  }
}

// Generate monthly content dynamically
function generateMonthlyContent(monthIndex) {
  const monthInfo = getMonthInfo(monthIndex);
  const month = monthInfo.name;
  const abbr = monthInfo.abbr;

  return `
    <div>
      <!-- ========== SECTION OBJECTIFS MENSUELS PERSONNELS ========== -->
      <div class="mb-8" style="border: 2px solid rgba(96, 165, 250, 0.3); border-radius: 1rem; overflow: hidden; background: rgba(96, 165, 250, 0.03);">
        <!-- Header Section Personnels -->
        <div class="px-6 py-4" style="background: linear-gradient(135deg, rgba(96, 165, 250, 0.15), rgba(59, 130, 246, 0.1)); border-bottom: 2px solid rgba(96, 165, 250, 0.2);">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #60a5fa, #3b82f6); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);">
                <i class="fas fa-bullseye" style="font-size: 1.25rem; color: white;"></i>
              </div>
              <div>
                <h4 style="color: var(--text-light); font-weight: 700; font-size: 1.125rem; margin: 0; letter-spacing: 0.02em;">OBJECTIFS MENSUELS PERSONNELS</h4>
                <p style="color: rgba(96, 165, 250, 0.8); font-size: 0.75rem; margin: 0; margin-top: 0.125rem;">Vos objectifs personnalis√©s pour ce mois</p>
              </div>
            </div>
          <div class="flex items-center gap-3">
            <button id="editMonthlyBtn-${abbr}" onclick="toggleEditMonthly(${monthIndex})" class="rounded-lg flex items-center gap-2 justify-center transition-all hover:scale-105 px-3 py-2" style="background: rgba(96, 165, 250, 0.15); color: var(--primary-blue); border: 1px solid rgba(96, 165, 250, 0.3);" title="Modifier">
              <i class="fas fa-pencil-alt text-xs"></i>
              <span class="text-xs font-bold">Modifier</span>
            </button>
            <button id="saveMonthlyBtn-${abbr}" onclick="saveMonthly(${monthIndex})" class="hidden rounded-lg flex items-center gap-2 justify-center transition-all hover:scale-105 px-3 py-2" style="background: rgba(52, 211, 153, 0.15); color: var(--primary-green); border: 1px solid rgba(52, 211, 153, 0.3);" title="Enregistrer">
              <i class="fas fa-save text-xs"></i>
              <span class="text-xs font-bold">Enregistrer</span>
            </button>
          </div>
          </div>
        </div>

        <!-- Contenu Objectifs Personnels -->
        <div class="p-6">
          <!-- Alerte objectifs manquants (seulement pour mois actuel) -->
          <div id="${abbr}-objectives-alert" style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.1)); border-left: 4px solid #f59e0b; border-radius: 0.5rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 1.25rem;"></i>
              <div>
                <div style="color: var(--text-light); font-weight: 600; margin-bottom: 0.25rem;">Objectifs manquants</div>
                <div style="color: rgba(148, 163, 184, 0.9); font-size: 0.875rem;">Veuillez remplir les objectifs pour ${monthInfo.fullName}</div>
              </div>
            </div>
          </div>

          <!-- Section M√©triques (4 en bas) -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <!-- HR P√ÄP R√âEL -->
          <div class="rounded-xl" style="background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8)); border: 1px solid rgba(96, 165, 250, 0.15); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); ">
            <div class="p-3 text-center border-b" style="border-color: rgba(96, 165, 250, 0.1);">
              <div class="text-xs mb-1" style="color: var(--text-gray);">Objectif</div>
              <input type="text" id="${abbr}-hrpap-vise" value="0 h" data-value="0" class="rpo-metric-input bg-transparent border-none text-center w-full rounded" style="color: rgba(96, 165, 250, 0.7); outline: none; font-size: 1.25rem;" readonly>
            </div>
            <div class="p-4 text-center">
              <div class="text-base font-bold mb-3" style="color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em;">HEURES P√ÄP R√âEL</div>
              <div class="flex items-center justify-center mb-3">
                <div class="relative inline-flex items-center justify-center">
                  <svg class="transform -rotate-90" width="80" height="80">
                    <circle cx="40" cy="40" r="32" stroke="rgba(148, 163, 184, 0.2)" stroke-width="6" fill="none"/>
                    <circle id="${abbr}-hrpap-circle" cx="40" cy="40" r="32" stroke="#60a5fa" stroke-width="6" fill="none"
                      stroke-dasharray="201" stroke-dashoffset="201" stroke-linecap="round"
                      style="transition: stroke-dashoffset 0.5s ease;"/>
                  </svg>
                  <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span id="${abbr}-hrpap-percent" class="text-lg font-bold" style="color: #60a5fa;">0%</span>
                  </div>
                </div>
              </div>
              <div id="${abbr}-hrpap-reel" class="font-bold" style="color: var(--text-light); font-size: 2rem;" data-value="0">0 h</div>
            </div>
          </div>

          <!-- # d'estimation -->
          <div class="rounded-xl" style="background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8)); border: 1px solid rgba(96, 165, 250, 0.15); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); ">
            <div class="p-3 text-center border-b" style="border-color: rgba(96, 165, 250, 0.1);">
              <div class="text-xs mb-1" style="color: var(--text-gray);">Objectif</div>
              <input type="text" id="${abbr}-estimation-vise" value="0" data-value="0" class="rpo-metric-input bg-transparent border-none text-center w-full rounded" style="color: rgba(96, 165, 250, 0.7); outline: none; font-size: 1.25rem;" readonly>
            </div>
            <div class="p-4 text-center">
              <div class="text-base font-bold mb-3" style="color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em;"># d'estimation</div>
              <div class="flex items-center justify-center mb-3">
                <div class="relative inline-flex items-center justify-center">
                  <svg class="transform -rotate-90" width="80" height="80">
                    <circle cx="40" cy="40" r="32" stroke="rgba(148, 163, 184, 0.2)" stroke-width="6" fill="none"/>
                    <circle id="${abbr}-estimation-circle" cx="40" cy="40" r="32" stroke="#60a5fa" stroke-width="6" fill="none"
                      stroke-dasharray="201" stroke-dashoffset="201" stroke-linecap="round"
                      style="transition: stroke-dashoffset 0.5s ease;"/>
                  </svg>
                  <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span id="${abbr}-estimation-percent" class="text-lg font-bold" style="color: #60a5fa;">0%</span>
                  </div>
                </div>
              </div>
              <div id="${abbr}-estimation-reel" class="font-bold" style="color: var(--text-light); font-size: 2rem;" data-value="0">0</div>
            </div>
          </div>

          <!-- Contrat sign√© -->
          <div class="rounded-xl" style="background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8)); border: 1px solid rgba(96, 165, 250, 0.15); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); ">
            <div class="p-3 text-center border-b" style="border-color: rgba(96, 165, 250, 0.1);">
              <div class="text-xs mb-1" style="color: var(--text-gray);">Objectif</div>
              <input type="text" id="${abbr}-contract-vise" value="0" data-value="0" class="rpo-metric-input bg-transparent border-none text-center w-full rounded" style="color: rgba(96, 165, 250, 0.7); outline: none; font-size: 1.25rem;" readonly>
            </div>
            <div class="p-4 text-center">
              <div class="text-base font-bold mb-3" style="color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em;"># Contrat sign√©</div>
              <div class="flex items-center justify-center mb-3">
                <div class="relative inline-flex items-center justify-center">
                  <svg class="transform -rotate-90" width="80" height="80">
                    <circle cx="40" cy="40" r="32" stroke="rgba(148, 163, 184, 0.2)" stroke-width="6" fill="none"/>
                    <circle id="${abbr}-contract-circle" cx="40" cy="40" r="32" stroke="#60a5fa" stroke-width="6" fill="none"
                      stroke-dasharray="201" stroke-dashoffset="201" stroke-linecap="round"
                      style="transition: stroke-dashoffset 0.5s ease;"/>
                  </svg>
                  <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span id="${abbr}-contract-percent" class="text-lg font-bold" style="color: #60a5fa;">0%</span>
                  </div>
                </div>
              </div>
              <div id="${abbr}-contract-reel" class="font-bold" style="color: var(--text-light); font-size: 2rem;" data-value="0">0</div>
            </div>
          </div>

          <!-- $ sign√© r√©el -->
          <div class="rounded-xl" style="background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8)); border: 1px solid rgba(96, 165, 250, 0.15); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); ">
            <div class="p-3 text-center border-b" style="border-color: rgba(96, 165, 250, 0.1);">
              <div class="text-xs mb-1" style="color: var(--text-gray);">Objectif</div>
              <input type="text" id="${abbr}-dollar-vise" value="0,00 $" data-value="0" class="rpo-metric-input bg-transparent border-none text-center w-full rounded" style="color: rgba(96, 165, 250, 0.7); outline: none; font-size: 1.25rem;" readonly>
            </div>
            <div class="p-4 text-center">
              <div class="text-base font-bold mb-3" style="color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em;">$ sign√© r√©el</div>
              <div class="flex items-center justify-center mb-3">
                <div class="relative inline-flex items-center justify-center">
                  <svg class="transform -rotate-90" width="80" height="80">
                    <circle cx="40" cy="40" r="32" stroke="rgba(148, 163, 184, 0.2)" stroke-width="6" fill="none"/>
                    <circle id="${abbr}-dollar-circle" cx="40" cy="40" r="32" stroke="#60a5fa" stroke-width="6" fill="none"
                      stroke-dasharray="201" stroke-dashoffset="201" stroke-linecap="round"
                      style="transition: stroke-dashoffset 0.5s ease;"/>
                  </svg>
                  <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span id="${abbr}-dollar-percent" class="text-lg font-bold" style="color: #60a5fa;">0%</span>
                  </div>
                </div>
              </div>
              <div id="${abbr}-dollar-reel" class="font-bold" style="color: var(--text-light); font-size: 2rem;" data-value="0">0,00 $</div>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>
  `;
}

// Change monthly view
function changeMonthlyView(monthIndex) {
  const monthInfo = getMonthInfo(monthIndex);
  const abbr = monthInfo.abbr;

  document.getElementById('currentMonthlyLabel').textContent = 'Objectifs et r√©sultats mensuels - ' + monthInfo.fullName;

  // Update dropdown text
  const dropdownText = document.querySelector('#monthlySelector .custom-select-text');
  if (dropdownText) {
    dropdownText.textContent = monthInfo.fullName;
  }

  // Generate and replace monthly content (les boutons sont maintenant dans le contenu g√©n√©r√©)
  const container = document.getElementById('monthlyContainer');
  container.innerHTML = generateMonthlyContent(monthIndex);

  // Restore coach objectives after HTML regeneration (since they come from coach, not monthly data)
  if (typeof updateMonthlyObjectifsDisplay === 'function') {
    updateMonthlyObjectifsDisplay();
  }

  // Load saved data for this month if available
  if (window.allMonthlyData && window.allMonthlyData[abbr]) {
    loadMonthlyData(monthIndex, window.allMonthlyData[abbr]);
  }

  // Calculate percentages for the circles
  calculateObjectifPercentage(abbr, 'pap');
  calculateObjectifPercentage(abbr, 'rep');
  calculateMonthPercentage(abbr, 'hrpap');
  calculateMonthPercentage(abbr, 'estimation');
  calculateMonthPercentage(abbr, 'contract');
  calculateMonthPercentage(abbr, 'dollar');

  // V√©rifier si tous les objectifs vis√©s sont √† 0 et afficher l'alerte si n√©cessaire
  checkMonthlyObjectivesAlert(abbr);

  // V√©rifier si l'objectif coach HEURES P√ÄP (REP) est √† 0 (seulement pour janvier)
  checkCoachObjectivesAlert(abbr);
}

// V√©rifier si l'objectif coach HEURES P√ÄP (REP) est √† 0 et afficher une alerte (uniquement pour janvier et mois actuel)
function checkCoachObjectivesAlert(abbr) {
  // Seulement pour janvier
  if (abbr !== 'jan') return;

  const alertDiv = document.getElementById(`${abbr}-coach-alert`);
  if (!alertDiv) return;

  // D√©terminer le mois actuel
  const now = getTorontoNow();
  const currentMonth = now.getMonth(); // 0-11 (0 = janvier, 11 = d√©cembre)
  const currentYear = now.getFullYear();

  // V√©rifier si c'est janvier 2026 (mois actuel)
  const isCurrentMonth = (currentYear === 2026 && currentMonth === 0);

  // Si ce n'est pas le mois actuel, masquer l'alerte
  if (!isCurrentMonth) {
    alertDiv.style.display = 'none';
    return;
  }

  // V√©rifier si obj-rep-reel est √† 0
  const objRepReelInput = document.getElementById(`${abbr}-obj-rep-reel`);
  const objRepReelValue = objRepReelInput ? (parseFloat(objRepReelInput.dataset.value) || 0) : 0;

  // Afficher l'alerte si la valeur est 0
  if (objRepReelValue === 0) {
    alertDiv.style.display = 'block';
  } else {
    alertDiv.style.display = 'none';
  }
}

// V√©rifier si les objectifs mensuels sont tous √† 0 et afficher une alerte (uniquement pour le mois actuel)
function checkMonthlyObjectivesAlert(abbr) {
  const alertDiv = document.getElementById(`${abbr}-objectives-alert`);
  if (!alertDiv) return;

  // D√©terminer le mois actuel
  const now = getTorontoNow();
  const currentMonth = now.getMonth(); // 0-11 (0 = janvier, 11 = d√©cembre)
  const currentYear = now.getFullYear();

  // Mapper abbr vers monthIndex pour comparer
  const monthMap = {
    'jan': 0, 'feb': 1, 'mar': 2, 'apr': 3,
    'may': 4, 'jun': 5, 'jul': 6, 'aug': 7,
    'sep': 8, 'oct': 9, 'nov': 10, 'dec': 11
  };

  const monthIndex = monthMap[abbr];

  // V√©rifier si c'est le mois actuel
  let isCurrentMonth = false;
  if (currentYear === 2026 && currentMonth === monthIndex) {
    // Mois de 2026
    isCurrentMonth = true;
  }

  // Si ce n'est pas le mois actuel, masquer l'alerte
  if (!isCurrentMonth) {
    alertDiv.style.display = 'none';
    return;
  }

  // Si c'est le mois actuel, v√©rifier si tous les objectifs sont √† 0
  const hrpapVise = parseFloat(document.getElementById(`${abbr}-hrpap-vise`)?.dataset.value || 0);
  const estimationVise = parseFloat(document.getElementById(`${abbr}-estimation-vise`)?.dataset.value || 0);
  const contractVise = parseFloat(document.getElementById(`${abbr}-contract-vise`)?.dataset.value || 0);
  const dollarVise = parseFloat(document.getElementById(`${abbr}-dollar-vise`)?.dataset.value || 0);

  // Si tous les 4 objectifs vis√©s sont √† 0, afficher l'alerte
  if (hrpapVise === 0 && estimationVise === 0 && contractVise === 0 && dollarVise === 0) {
    alertDiv.style.display = 'block';
  } else {
    alertDiv.style.display = 'none';
  }
}

// Initialize custom dropdowns
function initCustomDropdowns() {
  document.querySelectorAll('.custom-select').forEach(select => {
    const button = select.querySelector('.custom-select-button');
    const dropdown = select.querySelector('.custom-select-dropdown');
    const options = select.querySelectorAll('.custom-select-option');

    // Toggle dropdown
    button.addEventListener('click', (e) => {
      e.stopPropagation();

      // Close other dropdowns
      document.querySelectorAll('.custom-select').forEach(s => {
        if (s !== select) s.classList.remove('open');
      });

      select.classList.toggle('open');
    });

    // Handle option selection
    options.forEach(option => {
      option.addEventListener('click', (e) => {
        e.stopPropagation();

        // Remove selected class from all options
        options.forEach(opt => opt.classList.remove('selected'));

        // Add selected class to clicked option
        option.classList.add('selected');

        // Update button text
        const text = select.querySelector('.custom-select-text');
        text.textContent = option.textContent;

        // Close dropdown
        select.classList.remove('open');

        // Trigger change for month selector (weekly)
        if (select.id === 'monthSelector') {
          const monthIndex = parseInt(option.dataset.value);
          changeMonth(monthIndex);
        }

        // Trigger change for monthly selector
        if (select.id === 'monthlySelector') {
          const monthIndex = parseInt(option.dataset.value);
          changeMonthlyView(monthIndex);
        }

        // Trigger change for week selector (mobile)
        if (select.id === 'weekSelector') {
          const weekNumber = parseInt(option.dataset.week);
          log('[initCustomDropdowns] Semaine s√©lectionn√©e:', weekNumber);
          if (typeof updateMobileWeeklyView === 'function') {
            updateMobileWeeklyView(weekNumber);
          }
        }

        // Trigger change for plan period filter
        if (select.id === 'planPeriodSelector') {
          const periodValue = option.dataset.value;
          filterPlanByPeriod(periodValue);
        }

        // Trigger change for plan month selector (mobile)
        if (select.id === 'planMonthSelector') {
          const selectedMonth = option.dataset.value;
          if (window.planWeeksByMonth) {
            updatePlanWeekDropdown(selectedMonth, window.planWeeksByMonth);
          }
        }

        // Trigger change for plan month selector (desktop)
        if (select.id === 'planMonthSelectorDesktop') {
          const selectedValue = option.dataset.value;
          log('[Plan Desktop] Mois s√©lectionn√©:', selectedValue);
          filterPlanByPeriod(selectedValue);
        }
      });
    });
  });

  // Close dropdowns when clicking outside
  document.addEventListener('click', () => {
    document.querySelectorAll('.custom-select').forEach(select => {
      select.classList.remove('open');
    });
  });
}

// Initialize star rating clicks
function initStarRatings() {
  const stars = document.querySelectorAll('.star-rating');

  stars.forEach(star => {
    // Remove existing listeners by cloning
    const newStar = star.cloneNode(true);
    star.parentNode.replaceChild(newStar, star);
  });

  // Add new listeners
  document.querySelectorAll('.star-rating').forEach(star => {
    star.addEventListener('click', function() {
      // Only allow clicking if this star is enabled (pointer-events: auto)
      if (this.style.pointerEvents === 'auto') {
        const week = this.dataset.week;
        const rating = parseInt(this.dataset.rating);

        // Get all stars for this week
        const weekStars = document.querySelectorAll(`.star-rating[data-week="${week}"]`);

        // Update star colors
        weekStars.forEach((s, index) => {
          if (index < rating) {
            s.style.color = '#fbbf24'; // Yellow for selected stars
          } else {
            s.style.color = '#374151'; // Gray for unselected stars
          }
        });
      }
    });
  });
}

// Get current username from session
// EXACTEMENT COMME FACTURATIONQE
function getCurrentUsername() {
  // Si window.username est d√©fini ET diff√©rent du URL param, c'est qu'un entrepreneur a √©t√© s√©lectionn√© par le coach
  if (window.username) {
    const urlParams = new URLSearchParams(window.location.search);
    const urlUser = urlParams.get('user');
    // Si URL param existe ET qu'un username est d√©fini ET qu'ils sont diff√©rents, utiliser le username s√©lectionn√©
    if (urlUser && window.username !== urlUser) {
      log('[COACH] Utilisation du username s√©lectionn√©:', window.username);
      return window.username;
    }
  }
  // Sinon, comportement normal
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('user') || window.username || sessionStorage.getItem('username') || localStorage.getItem('username') || 'demo';
}

// Load all RPO data from backend (internal function)
async function loadRPODataInternal() {
  const username = getCurrentUsername();

  try {
    const response = await fetch(`/api/rpo/${username}`);
    if (response.ok) {
      const data = await response.json();

      // Store all RPO data globally for chart access
      window.rpoData = data;

      // Load weekly data FIRST (needed for calculateAnnualMetrics)
      // Store in global variable for access
      window.weeklyData = data.weekly || {};

      // Load annual data (toujours charger, m√™me si vide)
      loadAnnualData(data.annual || {});

      // Load all monthly data
      if (data.monthly) {
        loadAllMonthlyData(data.monthly);
      }

      // Calculer les totaux mensuels pour TOUS les mois depuis weekly data
      calculateAllMonthlyTotalsFromWeekly();

      // Mettre √† jour le badge de semaines incompl√®tes
      updateIncompleteWeeksBadge();

      // Update the annual chart with real data
      updateAnnualChart();

      return data;
    }
  } catch (error) {
  }

  return null;
}

// Exposer loadRPOData globalement pour entrepreneur-selector.js
// Wrapper function to reload data AND reinitialize views (comme facturationqe)
window.loadRPOData = async function() {
  log('[RPO] Rechargement des donn√©es apr√®s s√©lection entrepreneur');

  // Supprimer l'anti-flash CSS pour rendre le contenu visible
  const antiFlashStyle = document.getElementById('coach-anti-flash-css');
  if (antiFlashStyle) {
    antiFlashStyle.remove();
    log('[RPO] Anti-flash CSS supprim√©');
  }

  await loadRPODataInternal();

  // Charger les objectifs du coach pour cet entrepreneur
  await loadCoachObjectifs();

  // Initialiser ou recharger les √âtats des R√©sultats pour le nouvel entrepreneur
  log('[RPO] Initialisation/Rechargement des √âtats des R√©sultats');
  try {
    // Si √âtats des R√©sultats n'a jamais √©t√© initialis√© (cas d'un coach), faire l'initialisation compl√®te
    if (!window.etatsResultatsInitialized) {
      log('[RPO] √âtats des R√©sultats - Initialisation compl√®te (premi√®re fois)');
      if (typeof initEtatsResultatsEditor === 'function') {
        await initEtatsResultatsEditor();
        log('[RPO] √âtats des R√©sultats - initEtatsResultatsEditor() termin√©');
      }
      // NOTE: Ne PAS appeler updateCibleCalculations() ici car initEtatsResultatsEditor()
      // a d√©j√† charg√© les donn√©es CIBL√â sauvegard√©es. updateCibleCalculations() √©craserait
      // les valeurs charg√©es avec les valeurs calcul√©es √† partir des % par d√©faut.
      // G√©n√©rer les cartes mobiles APR√àS le chargement pour avoir les bonnes valeurs
      if (typeof generateEtatsMobile === 'function') {
        generateEtatsMobile();
        log('[RPO] √âtats des R√©sultats - generateEtatsMobile() termin√©');
      }
      window.etatsResultatsInitialized = true;
    } else {
      // Si d√©j√† initialis√©, juste recharger les donn√©es
      log('[RPO] √âtats des R√©sultats - Rechargement des donn√©es seulement');
      if (typeof loadEtatsResultatsData === 'function') {
        await loadEtatsResultatsData();
        log('[RPO] √âtats des R√©sultats - donn√©es Actuel/CIBL√â recharg√©es');
      }
      if (typeof loadChiffreAffaires === 'function') {
        await loadChiffreAffaires();
        log('[RPO] √âtats des R√©sultats - chiffre d\'affaires recharg√©');
      }
      // NOTE: Ne PAS appeler updateCibleCalculations() ici car les valeurs CIBL√â
      // viennent d'√™tre charg√©es. L'appeler √©craserait les valeurs sauvegard√©es.
      if (typeof updateAllCalculations === 'function') {
        updateAllCalculations();
        log('[RPO] √âtats des R√©sultats - calculs √âCART mis √† jour');
      }
      // R√©g√©n√©rer les cartes mobiles avec les nouvelles valeurs
      if (typeof generateEtatsMobile === 'function') {
        generateEtatsMobile();
        log('[RPO] √âtats des R√©sultats - cartes mobiles reg√©n√©r√©es');
      }
    }
  } catch (error) {
    error('[RPO] Erreur lors de l\'initialisation/rechargement des √âtats des R√©sultats:', error);
  }

  // R√©g√©n√©rer le plan d'affaire avec les nouvelles donn√©es
  if (typeof generatePlanWeeks === 'function') {
    generatePlanWeeks();
    log('[RPO] Plan d\'affaire r√©g√©n√©r√©');
  }

  // NOTE: loadWeeklyDataToPlan() SUPPRIM√â car redondant avec loadRPODataIntoPlan()
  // qui est appel√©e dans showPage() quand on affiche le plan d'affaires
  // Cela √©vite de charger les donn√©es 2 fois et de cr√©er des doublons

  // Calculer les cumuls et les "Devrait √™tre √†" apr√®s le chargement des donn√©es
  setTimeout(() => {
    if (typeof calculatePlan === 'function') {
      calculatePlan();
      log('[RPO] Cumuls et tendances calcul√©s');
    }
  }, 100);

  // R√©initialiser les vues RPO
  setTimeout(async () => {
    // Charger les objectifs sauvegard√©s AVANT d'afficher les vues
    if (typeof loadSavedWeeklyTargetsIntoPlan === 'function') {
      await loadSavedWeeklyTargetsIntoPlan();
      log('[RPO] Objectifs hebdomadaires sauvegard√©s recharg√©s');
    }

    changeMonthlyView(0);
    changeMonth(0, true); // forceChange=true pour l'initialisation
    calculateMonthlyTotalsFromWeekly(0);
  }, 100);
};

// Load annual data into UI
function loadAnnualData(annual) {
  const objectifCA = annual.objectif_ca || 0;

  const input = document.getElementById('objectifCA');
  if (input) {
    input.value = objectifCA.toLocaleString('fr-CA', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).replace(/\s/g, ' ') + ' $';
    input.dataset.value = objectifCA;
  }

  // Synchroniser avec Objectif Vente dans le plan d'affaire
  const planObjectifInput = document.getElementById('plan-objectif');
  if (planObjectifInput) {
    planObjectifInput.dataset.value = objectifCA;
    planObjectifInput.value = objectifCA.toLocaleString('fr-CA', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).replace(/\s/g, ' ') + ' $';
    log('[OK] Objectif CA synchronis√© avec Plan d\'Affaire:', objectifCA);
  } else {
    warn('[WARN] plan-objectif input non trouv√© lors du chargement');
  }

  // Charger les param√®tres du plan d'affaire (CM Pr√©vision, Ratio Marketing, Taux de vente)
  const cmPrevInput = document.getElementById('plan-cm-prev');
  if (cmPrevInput && annual.cm_prevision !== undefined) {
    const cmPrev = annual.cm_prevision || 2500;
    cmPrevInput.dataset.value = cmPrev;
    cmPrevInput.value = cmPrev.toLocaleString('fr-CA', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).replace(/\s/g, ' ') + ' $';
  }

  const ratioMktgInput = document.getElementById('plan-ratio-mktg');
  if (ratioMktgInput && annual.ratio_mktg !== undefined) {
    const ratioMktg = annual.ratio_mktg || 85;
    ratioMktgInput.dataset.value = ratioMktg;
    ratioMktgInput.value = (ratioMktg / 100).toFixed(2);
  }

  const tauxVenteInput = document.getElementById('plan-taux-vente');
  if (tauxVenteInput && annual.taux_vente !== undefined) {
    const tauxVente = annual.taux_vente || 30;
    tauxVenteInput.dataset.value = tauxVente;
    tauxVenteInput.value = tauxVente + '%';
  }

  // Mettre √† jour les labels "(par d√©faut)" selon les valeurs
  updatePlanDefaultLabels();

  // Synchroniser avec Ventes Budget dans √âtats des R√©sultats
  if (typeof syncObjectifCAWithVentesBudget === 'function') {
    setTimeout(() => {
      syncObjectifCAWithVentesBudget();
    }, 100);
  }

  // Synchroniser Tendance vis√© avec Objectif CA + 10%
  const tendanceViseInput = document.getElementById('tendance-vise');
  if (tendanceViseInput) {
    const tendanceValue = Math.round(objectifCA * 1.10); // Objectif CA + 10%
    tendanceViseInput.value = tendanceValue.toLocaleString('fr-CA').replace(/\s/g, ' ') + ' $';
    tendanceViseInput.dataset.value = tendanceValue;
  }

  // Charger tous les objectifs vis√©s annuels (sauf tendance-vise qui vient de objectif_ca)
  const metrics = [
    { id: 'hrpap-vise', key: 'hrpap_vise', suffix: ' h' },
    { id: 'estimation-vise', key: 'estimation_vise', suffix: '' },
    { id: 'contract-vise', key: 'contract_vise', suffix: '' },
    { id: 'dollar-vise', key: 'dollar_vise', suffix: ' $' },
    { id: 'mktg-vise', key: 'mktg_vise', suffix: '%' },
    { id: 'vente-vise', key: 'vente_vise', suffix: '%' },
    { id: 'moyen-vise', key: 'moyen_vise', suffix: ' $' }
  ];

  metrics.forEach(metric => {
    if (annual[metric.key] !== undefined) {
      const input = document.getElementById(metric.id);
      if (input) {
        const value = annual[metric.key];
        if (metric.suffix === ' $') {
          input.value = value.toLocaleString('fr-CA', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }).replace(/\s/g, ' ') + metric.suffix;
        } else if (metric.suffix === '%') {
          input.value = value + metric.suffix;
        } else {
          input.value = value + metric.suffix;
        }
        input.dataset.value = value;
      }
    }
  });

  // Charger les valeurs R√âEL annuelles
  if (annual.hr_pap_reel !== undefined) {
    const div = document.getElementById('annual-hrpap-reel');
    if (div) {
      div.textContent = annual.hr_pap_reel.toFixed(1) + ' h';
      div.dataset.value = annual.hr_pap_reel;
    }
  }

  if (annual.estimation_reel !== undefined) {
    const div = document.getElementById('annual-estimation-reel');
    if (div) {
      div.textContent = Math.round(annual.estimation_reel).toString();
      div.dataset.value = annual.estimation_reel;
    }
  }

  if (annual.contract_reel !== undefined) {
    const div = document.getElementById('annual-contract-reel');
    if (div) {
      div.textContent = Math.round(annual.contract_reel).toString();
      div.dataset.value = annual.contract_reel;
    }
  }

  if (annual.dollar_reel !== undefined) {
    const div = document.getElementById('annual-dollar-reel');
    if (div) {
      div.textContent = Math.round(annual.dollar_reel).toLocaleString('fr-CA') + ' $';
      div.dataset.value = annual.dollar_reel;
    }
  }

  // Calculer automatiquement les champs vis√©s calcul√©s (mktg, vente, moyen)
  calculateInitialViseFields();

  // Recalculer les pourcentages et afficher la ligne apr√®s avoir charg√© les donn√©es
  calculateObjectifCAProgress();

  // Calculer les m√©triques annuelles (taux mktg, taux vente, contrat moyen, tendance)
  calculateAnnualMetrics();

  // Recalculer les pourcentages pour toutes les m√©triques annuelles
  const metricNames = ['hrpap', 'estimation', 'contract', 'dollar', 'mktg', 'vente', 'moyen', 'tendance'];
  metricNames.forEach(metric => calculatePercentage(metric));

  // Mettre √† jour le graphique √† barres annuel
  setTimeout(() => updateAnnualChart(), 100);

  // Synchroniser les Ventes dans √âtats des R√©sultats avec $ SIGN√â
  setTimeout(() => loadChiffreAffaires(), 150);

  // V√©rifier et afficher/masquer l'alerte Objectif CA
  checkObjectifCAAlert();
}

// Load all monthly data into UI
function loadAllMonthlyData(monthlyData) {
  // Store in global variable for later use
  window.allMonthlyData = monthlyData;

  // Map month abbreviations to their indexes
  const monthIndexMap = {
    'jan': 0, 'feb': 1, 'mar': 2, 'apr': 3,
    'may': 4, 'jun': 5, 'jul': 6, 'aug': 7,
    'sep': 8, 'oct': 9, 'nov': 10, 'dec': 11
  };

  // Load all months from backend data
  Object.keys(monthlyData).forEach(abbr => {
    const monthIndex = monthIndexMap[abbr];
    if (monthIndex !== undefined && monthlyData[abbr]) {
      loadMonthlyData(monthIndex, monthlyData[abbr]);
    }
  });

  // NOTE: Ne PAS appeler calculateAnnualTotalsFromMonthly() ici car calculateAllMonthlyTotalsFromWeekly()
  // sera appel√©e juste apr√®s et recalculera les totaux annuels correctement depuis les donn√©es hebdomadaires.
  // calculateAnnualTotalsFromMonthly();

  // Mettre √† jour le graphique √† barres annuel
  setTimeout(() => updateAnnualChart(), 100);
}

// Get suffix for objectif coach based on month
function getObjectifSuffix(monthIndex, type) {
  // D√©cembre 2025 (index -2) utilise les m√™mes valeurs qu'octobre 2026
    if (type === 'pap') {
    const suffixes = [
      ' h',      // Janvier - HEURES P√ÄP
      ' h',      // F√©vrier - HEURES P√ÄP
      '',        // Mars - Estimations
      '',        // Avril - Ventes
      '',        // Mai - Ventes
      '',        // Juin - Ventes
      '',        // Juillet - Ventes
      '',        // Ao√ªt - Ventes
      ' $',      // Septembre - $ Produit
      ' h',      // Octobre - HEURES P√ÄP
      ' h',      // Novembre - HEURES P√ÄP
      ' h'       // D√©cembre - HEURES P√ÄP
    ];
    return suffixes[monthIndex];
  } else if (type === 'rep') {
    const suffixes = [
      ' h',      // Janvier - HEURES P√ÄP REP
      '',        // F√©vrier - Estimations
      '',        // Mars - Ventes
      '',        // Avril - Peintres
      ' $/h',    // Mai - Prod Horaire
      ' $/h',    // Juin - Prod Horaire
      ' $/h',    // Juillet - Prod Horaire
      ' $',      // Ao√ªt - $ Produit
      null,      // Septembre - pas de 2e objectif
      ' $',      // Octobre - $ Vendus
      ' $',      // Novembre - $ Vendus
      ' $'       // D√©cembre - $ Vendus
    ];
    return suffixes[monthIndex];
  }
  return '';
}

// Load monthly data for specific month
function loadMonthlyData(monthIndex, data) {
  const monthInfo = getMonthInfo(monthIndex);
  const abbr = monthInfo.abbr;

  // Get correct suffixes for objectifs coach
  const objPapSuffix = getObjectifSuffix(monthIndex, 'pap');
  const objRepSuffix = getObjectifSuffix(monthIndex, 'rep');

  const fields = [
    // IMPORTANT: obj-pap et obj-rep sont exclus car ils viennent du coach, pas des donn√©es mensuelles
    { id: `${abbr}-hrpap-vise`, key: 'hrpap_vise', suffix: ' h' },
    { id: `${abbr}-estimation-vise`, key: 'estimation_vise', suffix: '' },
    { id: `${abbr}-contract-vise`, key: 'contract_vise', suffix: '' },
    { id: `${abbr}-dollar-vise`, key: 'dollar_vise', suffix: ' $' }
  ];

  fields.forEach(field => {
    const input = document.getElementById(field.id);
    if (input && data[field.key] !== undefined) {
      const value = data[field.key];
      // Format selon le suffix
      if (field.suffix === ' $') {
        input.value = Math.round(value).toLocaleString('fr-CA') + field.suffix;
      } else if (field.suffix === ' $/h') {
        input.value = value.toFixed(2) + field.suffix;
      } else if (field.suffix === ' h') {
        input.value = value.toFixed(1) + field.suffix;
      } else {
        input.value = Math.round(value).toString() + field.suffix;
      }
      input.dataset.value = value;
    }
  });

  // Charger les valeurs R√âEL (divs, pas inputs) incluant les objectifs coach
  const reelFields = [
    { id: `${abbr}-obj-pap-reel`, key: 'obj_pap_reel', suffix: objPapSuffix },
    { id: `${abbr}-obj-rep-reel`, key: 'obj_rep_reel', suffix: objRepSuffix },
    { id: `${abbr}-hrpap-reel`, key: 'hrpap_reel', suffix: ' h' },
    { id: `${abbr}-estimation-reel`, key: 'estimation_reel', suffix: '' },
    { id: `${abbr}-contract-reel`, key: 'contract_reel', suffix: '' },
    { id: `${abbr}-dollar-reel`, key: 'dollar_reel', suffix: ' $' }
  ];

  reelFields.forEach(field => {
    const element = document.getElementById(field.id);
    if (element && data[field.key] !== undefined && field.suffix !== null) {
      const value = data[field.key];
      let formattedValue = '';

      // Format selon le suffix
      if (field.suffix === ' h') {
        formattedValue = value.toFixed(1) + field.suffix;
      } else if (field.suffix === ' $') {
        formattedValue = Math.round(value).toLocaleString('fr-CA') + field.suffix;
      } else if (field.suffix === ' $/h') {
        formattedValue = value.toFixed(2) + field.suffix;
      } else {
        formattedValue = Math.round(value).toString();
      }

      // Pour les inputs (comme jan-obj-rep-reel), utiliser .value
      // Pour les divs, utiliser .textContent
      if (element.tagName === 'INPUT') {
        element.value = formattedValue;
      } else {
        element.textContent = formattedValue;
      }

      element.dataset.value = value;
    }
  });

  // Recalculer les pourcentages et couleurs apr√®s le chargement
  calculateObjectifPercentage(abbr, 'pap');
  calculateObjectifPercentage(abbr, 'rep');
  calculateMonthPercentage(abbr, 'hrpap');
  calculateMonthPercentage(abbr, 'estimation');
  calculateMonthPercentage(abbr, 'contract');
  calculateMonthPercentage(abbr, 'dollar');
}

// Sauvegarder les m√©triques calcul√©es automatiquement (appel√© depuis calculateAnnualMetrics)
async function saveCalculatedMetrics(tauxMktg, tauxVente, contratMoyen, prodHoraire = 0) {
  const username = getCurrentUsername();

  const data = {
    objectif_ca: parseFloat(document.getElementById('objectifCA')?.dataset.value) || 0,
    hrpap_vise: parseFloat(document.getElementById('hrpap-vise')?.dataset.value) || 0,
    estimation_vise: parseFloat(document.getElementById('estimation-vise')?.dataset.value) || 0,
    contract_vise: parseFloat(document.getElementById('contract-vise')?.dataset.value) || 0,
    dollar_vise: parseFloat(document.getElementById('dollar-vise')?.dataset.value) || 0,
    mktg_vise: parseFloat(document.getElementById('mktg-vise')?.dataset.value) || 0,
    vente_vise: parseFloat(document.getElementById('vente-vise')?.dataset.value) || 0,
    moyen_vise: parseFloat(document.getElementById('moyen-vise')?.dataset.value) || 0,
    tendance_vise: parseFloat(document.getElementById('tendance-vise')?.dataset.value) || 0,
    ratio_mktg: parseFloat(document.getElementById('plan-ratio-mktg')?.dataset.value) || 85,
    cm_prevision: parseFloat(document.getElementById('plan-cm-prev')?.dataset.value) || 2500,
    taux_vente: parseFloat(document.getElementById('plan-taux-vente')?.dataset.value) || 30
    // NE PAS envoyer les donn√©es _reel (hr_pap_reel, estimation_reel, etc.)
    // car elles sont calcul√©es automatiquement par sync_soumissions_to_rpo()
    // Les m√©triques calcul√©es (mktg_reel, vente_reel, etc.) sont aussi calcul√©es par le backend
  };

  try {
    await fetch(`/api/rpo/${username}/annual`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
  } catch (error) {
    error('Erreur sauvegarde m√©triques calcul√©es:', error);
  }
}

// Save annual data to backend
async function saveAnnualData() {
  const username = getCurrentUsername();

  const data = {
    objectif_ca: parseFloat(document.getElementById('objectifCA').dataset.value) || 0,
    hrpap_vise: parseFloat(document.getElementById('hrpap-vise').dataset.value) || 0,
    estimation_vise: parseFloat(document.getElementById('estimation-vise').dataset.value) || 0,
    contract_vise: parseFloat(document.getElementById('contract-vise').dataset.value) || 0,
    dollar_vise: parseFloat(document.getElementById('dollar-vise').dataset.value) || 0,
    mktg_vise: parseFloat(document.getElementById('mktg-vise').dataset.value) || 0,
    vente_vise: parseFloat(document.getElementById('vente-vise').dataset.value) || 0,
    moyen_vise: parseFloat(document.getElementById('moyen-vise').dataset.value) || 0,
    tendance_vise: parseFloat(document.getElementById('tendance-vise').dataset.value) || 0,
    ratio_mktg: parseFloat(document.getElementById('plan-ratio-mktg')?.dataset.value) || 85,
    cm_prevision: parseFloat(document.getElementById('plan-cm-prev')?.dataset.value) || 2500,
    taux_vente: parseFloat(document.getElementById('plan-taux-vente')?.dataset.value) || 30
    // NE PAS envoyer les donn√©es _reel (hr_pap_reel, estimation_reel, etc.)
    // car elles sont calcul√©es automatiquement par sync_soumissions_to_rpo()
  };

  try {
    const response = await fetch(`/api/rpo/${username}/annual`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (response.ok) {
      return true;
    }
  } catch (error) {
  }

  return false;
}

// Save monthly data to backend
async function saveMonthlyDataToBackend(monthIndex) {
  const username = getCurrentUsername();
  const monthInfo = getMonthInfo(monthIndex);
  const abbr = monthInfo.abbr;

  const objPapEl = document.getElementById(`${abbr}-obj-pap`);
  const objRepEl = document.getElementById(`${abbr}-obj-rep`);
  const objPapReelEl = document.getElementById(`${abbr}-obj-pap-reel`);
  const objRepReelEl = document.getElementById(`${abbr}-obj-rep-reel`);
  const hrpapViseEl = document.getElementById(`${abbr}-hrpap-vise`);
  const estimationViseEl = document.getElementById(`${abbr}-estimation-vise`);
  const contractViseEl = document.getElementById(`${abbr}-contract-vise`);
  const dollarViseEl = document.getElementById(`${abbr}-dollar-vise`);

  const data = {
    obj_pap: objPapEl ? (parseFloat(objPapEl.dataset.value) || 0) : 0,
    obj_rep: objRepEl ? (parseFloat(objRepEl.dataset.value) || 0) : 0,
    obj_pap_reel: objPapReelEl ? (parseFloat(objPapReelEl.dataset.value) || 0) : 0,
    obj_rep_reel: objRepReelEl ? (parseFloat(objRepReelEl.dataset.value) || 0) : 0,
    hrpap_vise: hrpapViseEl ? (parseFloat(hrpapViseEl.dataset.value) || 0) : 0,
    estimation_vise: estimationViseEl ? (parseFloat(estimationViseEl.dataset.value) || 0) : 0,
    contract_vise: contractViseEl ? (parseFloat(contractViseEl.dataset.value) || 0) : 0,
    dollar_vise: dollarViseEl ? (parseFloat(dollarViseEl.dataset.value) || 0) : 0,
    hrpap_reel: 0,
    estimation_reel: 0,
    contract_reel: 0,
    dollar_reel: 0
  };

  try {
    const response = await fetch(`/api/rpo/${username}/monthly/${abbr}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await response.json();

    if (response.ok) {
      // Mettre √† jour window.allMonthlyData avec les nouvelles valeurs
      if (!window.allMonthlyData) {
        window.allMonthlyData = {};
      }
      if (!window.allMonthlyData[abbr]) {
        window.allMonthlyData[abbr] = {};
      }

      // Sauvegarder les valeurs vis√©es dans la m√©moire
      window.allMonthlyData[abbr].obj_pap = data.obj_pap;
      window.allMonthlyData[abbr].obj_rep = data.obj_rep;
      window.allMonthlyData[abbr].hrpap_vise = data.hrpap_vise;
      window.allMonthlyData[abbr].estimation_vise = data.estimation_vise;
      window.allMonthlyData[abbr].contract_vise = data.contract_vise;
      window.allMonthlyData[abbr].dollar_vise = data.dollar_vise;

      log(`‚úÖ Objectifs mensuels sauvegard√©s dans window.allMonthlyData[${abbr}]`);

      return true;
    }
  } catch (error) {
    error('Error saving monthly data:', error);
  }

  return false;
}

// Save weekly data to backend
async function saveWeeklyDataToBackend(monthIndex, weekNumber) {
  const username = getCurrentUsername();
  const showProdHoraire = monthIndex >= 4; // D√©cembre 2025 ou √† partir de Mai 2026 (index 4)

  // R√©cup√©rer les anciennes valeurs pour comparaison
  const oldData = window.weeklyData?.[String(monthIndex)]?.[String(weekNumber)] || {};

  // Collect weekly data from inputs using data-field attribute
  const data = {
    h_marketing: 0,
    estimation: 0,
    contract: 0,
    dollar: 0,
    // prod_horaire: ajout√© seulement si rempli (pas de valeur par d√©faut)
    rating: 0,
    commentaire: ''
  };

  // Get h_marketing
  const hMarketingInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="h_marketing"]`);
  if (hMarketingInput) {
    const value = hMarketingInput.dataset.value;
    // Si la valeur est "-" ou vide, garder "-" (pas de valeur)
    // Si la valeur est un nombre (y compris 0), l'enregistrer
    if (value === '-' || value === '' || value === null || value === undefined) {
      data.h_marketing = '-';
    } else {
      const parsed = parseFloat(value);
      data.h_marketing = isNaN(parsed) ? '-' : parsed;
    }
  }

  // Get estimation
  const estimationInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="estimation"]`);
  if (estimationInput) {
    data.estimation = parseFloat(estimationInput.dataset.value) || 0;
    log(`[SAVE] Semaine ${weekNumber} - Estimation dataset.value: ${estimationInput.dataset.value}, parsed: ${data.estimation}`);
  }

  // Get contract
  const contractInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="contract"]`);
  if (contractInput) {
    data.contract = parseFloat(contractInput.dataset.value) || 0;
    log(`[SAVE] Semaine ${weekNumber} - Contract dataset.value: ${contractInput.dataset.value}, parsed: ${data.contract}`);
  }

  // Get dollar
  const dollarInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="dollar"]`);
  if (dollarInput) {
    data.dollar = parseFloat(dollarInput.dataset.value) || 0;
    log(`[SAVE] Semaine ${weekNumber} - Dollar dataset.value: ${dollarInput.dataset.value}, parsed: ${data.dollar}`);
  }

  // Get prod_horaire (if applicable) - FONCTIONNE EXACTEMENT COMME h_marketing
  if (showProdHoraire) {
    const prodInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="prod_horaire"]`);
    if (prodInput) {
      const value = prodInput.dataset.value;
      // Si la valeur est "-" ou vide, envoyer "-" (comme h_marketing)
      // Si la valeur est un nombre (y compris 0), l'enregistrer
      if (value === '-' || value === '' || value === null || value === undefined) {
        data.prod_horaire = '-';  // ‚úÖ ENVOYER "-" comme h_marketing
        console.log(`[SAVE-PROD] Semaine ${weekNumber}: Prod Horaire = "-" (non rempli)`);
      } else {
        const parsed = parseFloat(value);
        data.prod_horaire = isNaN(parsed) ? '-' : parsed;
        console.log(`[SAVE-PROD] Semaine ${weekNumber}: Prod Horaire = ${data.prod_horaire}$/h`);
      }
    } else {
      console.log(`[SAVE-PROD] Semaine ${weekNumber}: Input prod_horaire NON TROUV√â`);
    }
  }

  // Find rating from resume table
  const stars = document.querySelectorAll(`.star-rating[data-week="${weekNumber}"]`);
  if (stars.length > 0) {
    // Count yellow stars
    let rating = 0;
    stars.forEach(star => {
      if (star.style.color === 'rgb(251, 191, 36)' || star.style.color === '#fbbf24') {
        rating++;
      }
    });
    if (rating > 0) data.rating = rating;
  }

  // Get probleme and focus comments
  // IMPORTANT: Ne sauvegarder que si les inputs existent, sinon garder les valeurs existantes
  const problemeInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="probleme"]`);
  const focusInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="focus"]`);

  // R√©cup√©rer les valeurs existantes de window.weeklyData si disponibles
  const existingProbleme = window.weeklyData?.[String(monthIndex)]?.[String(weekNumber)]?.probleme || '-';
  const existingFocus = window.weeklyData?.[String(monthIndex)]?.[String(weekNumber)]?.focus || '-';

  // Utiliser la valeur de l'input si elle existe, sinon garder l'existante
  let problemeValue = problemeInput ? (problemeInput.value.trim() || '-') : existingProbleme;
  let focusValue = focusInput ? (focusInput.value.trim() || '-') : existingFocus;

  // Sauvegarder probleme et focus comme champs s√©par√©s
  data.probleme = problemeValue;
  data.focus = focusValue;

  // Collect manually modified objectives and save them in _obj_modifier fields
  // These have priority over _vise (business plan) values when displaying
  // If user modifies an objective, it's saved as _obj_modifier and won't be affected by plan changes

  console.log(`[SAVE OBJ] Starting objective collection for week ${weekNumber}`);

  const hMarketingObjInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="h_marketing_obj"]`);
  console.log(`[SAVE OBJ] h_marketing_obj querySelector result: ${hMarketingObjInput ? 'FOUND' : 'NULL'}`);
  if (hMarketingObjInput) {
    const value = parseFloat(hMarketingObjInput.dataset.value);
    const vise = parseFloat(hMarketingObjInput.dataset.vise) || 0;
    // Si la valeur est identique au plan (vise) ou 0, envoyer 0 (utiliser vise). Sinon envoyer la modification.
    data.h_marketing_obj_modifier = (isNaN(value) || value === vise || value === 0) ? 0 : value;
    console.log(`[SAVE OBJ] h_marketing: value=${value}, vise=${vise}, modifier=${data.h_marketing_obj_modifier}`);
  }

  const estimationObjInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="estimation_obj"]`);
  console.log(`[SAVE OBJ] estimation_obj querySelector result: ${estimationObjInput ? 'FOUND' : 'NULL'}`);
  if (estimationObjInput) {
    const value = parseFloat(estimationObjInput.dataset.value);
    const vise = parseFloat(estimationObjInput.dataset.vise) || 0;
    // Si la valeur est identique au plan (vise) ou 0, envoyer 0 (utiliser vise). Sinon envoyer la modification.
    data.estimation_obj_modifier = (isNaN(value) || value === vise || value === 0) ? 0 : value;
    console.log(`[SAVE OBJ] estimation: value=${value}, vise=${vise}, modifier=${data.estimation_obj_modifier}`);
  }

  const contractObjInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="contract_obj"]`);
  console.log(`[SAVE OBJ] contract_obj querySelector result: ${contractObjInput ? 'FOUND' : 'NULL'}`);
  if (contractObjInput) {
    const value = parseFloat(contractObjInput.dataset.value);
    const vise = parseFloat(contractObjInput.dataset.vise) || 0;
    // Si la valeur est identique au plan (vise) ou 0, envoyer 0 (utiliser vise). Sinon envoyer la modification.
    data.contract_obj_modifier = (isNaN(value) || value === vise || value === 0) ? 0 : value;
    console.log(`[SAVE OBJ] contract: value=${value}, vise=${vise}, modifier=${data.contract_obj_modifier}`);
  }

  const dollarObjInput = document.querySelector(`input[data-week="${weekNumber}"][data-field="dollar_obj"]`);
  console.log(`[SAVE OBJ] dollar_obj querySelector result: ${dollarObjInput ? 'FOUND' : 'NULL'}`);
  if (dollarObjInput) {
    const value = parseFloat(dollarObjInput.dataset.value);
    const vise = parseFloat(dollarObjInput.dataset.vise) || 0;
    // Si la valeur est identique au plan (vise) ou 0, envoyer 0 (utiliser vise). Sinon envoyer la modification.
    data.dollar_obj_modifier = (isNaN(value) || value === vise || value === 0) ? 0 : value;
    console.log(`[SAVE OBJ] dollar: value=${value}, vise=${vise}, modifier=${data.dollar_obj_modifier}`);
  }

  console.log(`[SAVE OBJ] Final data object for week ${weekNumber}:`, data);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // LOG SEM2026 - Afficher les modifications
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  console.log('‚ïë                        SEM2026 - SAUVEGARDE                    ‚ïë');
  console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');

  // Obtenir le label de la semaine
  const weeks = getWeeksForMonth(monthIndex);
  const weekLabel = weeks && weeks[weekNumber - 1] ? weeks[weekNumber - 1].label : `Semaine ${weekNumber}`;

  const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
  const monthName = monthNames[monthIndex] + ' 2026';

  console.log(`üìÖ Mois: ${monthName}`);
  console.log(`üìå Semaine ${weekNumber}: ${weekLabel}`);
  console.log('');

  // Comparer et afficher les changements
  let hasChanges = false;

  if (oldData.h_marketing !== data.h_marketing) {
    console.log(`üîÑ H. Marketing: ${oldData.h_marketing || 0} ‚ûú ${data.h_marketing}`);
    hasChanges = true;
  }

  if (oldData.estimation !== data.estimation) {
    console.log(`üîÑ Estimations: ${oldData.estimation || 0} ‚ûú ${data.estimation}`);
    hasChanges = true;
  }

  if (oldData.contract !== data.contract) {
    console.log(`üîÑ Contrats: ${oldData.contract || 0} ‚ûú ${data.contract}`);
    hasChanges = true;
  }

  if (oldData.dollar !== data.dollar) {
    console.log(`üîÑ $ Sign√©s: ${oldData.dollar || 0}$ ‚ûú ${data.dollar}$`);
    hasChanges = true;
  }

  // TOUJOURS afficher prod_horaire si showProdHoraire = true (pour debug)
  if (showProdHoraire) {
    console.log(`üîç showProdHoraire = ${showProdHoraire} (monthIndex=${monthIndex})`);
    console.log(`üìä Prod Horaire DATA: ${data.prod_horaire}$/h`);
    if (oldData.prod_horaire !== data.prod_horaire) {
      console.log(`üîÑ Prod Horaire: ${oldData.prod_horaire || 0}$/h ‚ûú ${data.prod_horaire}$/h`);
      hasChanges = true;
    } else {
      console.log(`‚ÑπÔ∏è Prod Horaire: ${data.prod_horaire}$/h (pas de changement)`);
    }
  } else {
    console.log(`‚ö†Ô∏è showProdHoraire = false (monthIndex=${monthIndex}), prod_horaire non sauvegard√©`);
  }

  if (!hasChanges) {
    console.log('‚ÑπÔ∏è Aucune modification d√©tect√©e');
  }

  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

  console.log(`[SAVE-BACKEND] üì§ Envoi au backend pour semaine ${weekNumber}:`, data);

  try {
    console.log(`[FETCH] üåê Envoi requ√™te HTTP pour semaine ${weekNumber}...`);
    const response = await fetch(`/api/rpo/${username}/weekly/${monthIndex}/${weekNumber}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    console.log(`[FETCH] ‚úÖ R√©ponse re√ßue pour semaine ${weekNumber}: ${response.status}`);

    if (response.ok) {

      // Calculer le week_label avant de sauvegarder
      const weeks = getWeeksForMonth(monthIndex);
      if (weeks && weeks[weekNumber - 1]) {
        data.week_label = weeks[weekNumber - 1].label;
      }

      console.log(`‚úÖ SEM2026 - Sauvegarde r√©ussie pour ${weekLabel}`);

      // Mettre √† jour le plan d'affaire avec ces nouvelles donn√©es
      updatePlanFromWeeklyData(monthIndex, weekNumber, data);

      // Mettre √† jour les donn√©es globales et le badge
      if (!window.weeklyData[String(monthIndex)]) {
        window.weeklyData[String(monthIndex)] = {};
      }
      window.weeklyData[String(monthIndex)][String(weekNumber)] = data;

      updateIncompleteWeeksBadge();

      // Recalculer les totaux mensuels et annuels depuis les donn√©es hebdomadaires
      // pour que les changements soient visibles instantan√©ment sans refresh
      calculateAllMonthlyTotalsFromWeekly();

      // Mettre √† jour le graphique annuel
      updateAnnualChart();

      return true;
    } else {
      console.error(`[FETCH] ‚ùå Erreur HTTP pour semaine ${weekNumber}: ${response.status}`);
    }
  } catch (error) {
    console.error(`[FETCH] ‚ùå Exception pour semaine ${weekNumber}:`, error);
  }

  return false;
}

// Mettre √† jour le plan d'affaire quand on sauvegarde des donn√©es hebdo
function updatePlanFromWeeklyData(monthIndex, weekNumber, data) {
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log(`üîÑ updatePlanFromWeeklyData appel√© pour mois ${monthIndex}, semaine ${weekNumber}`);
  console.log('Data:', data);

  // Fonction de normalisation robuste des labels (identique √† loadRPODataIntoPlan)
  const normalizeLabel = (label) => {
    return label.toLowerCase()
      .replace(/\./g, '')
      .replace(/janvier|janv/g, 'janv')
      .replace(/f√©vrier|f√©vr|f√©v/g, 'fevr')
      .replace(/mars/g, 'mars')
      .replace(/avril|avr/g, 'avr')
      .replace(/mai/g, 'mai')
      .replace(/juin/g, 'juin')
      .replace(/juillet|juil/g, 'juil')
      .replace(/ao√ªt|aout/g, 'aout')
      .replace(/septembre|sept/g, 'sept')
      .replace(/octobre|oct/g, 'oct')
      .replace(/novembre|nov/g, 'nov')
      .replace(/d√©cembre|d√©c|dec/g, 'dec')
      .replace(/\s+/g, ' ')
      .trim();
  };

  // NOUVEAU: G√©n√©rer le week_label en recalculant comme dans getWeeksForMonth
  let rpoLabel = '';

  // Recalculer le label de semaine exactement comme getWeeksForMonth le fait
  const weeks = getWeeksForMonth(monthIndex);
  console.log(`üìÖ getWeeksForMonth(${monthIndex}) a retourn√© ${weeks?.length || 0} semaines:`, weeks);

  if (weeks && weeks[weekNumber - 1]) {
    rpoLabel = normalizeLabel(weeks[weekNumber - 1].label);
    console.log(`‚úÖ Label brut de getWeeksForMonth[${weekNumber - 1}]: "${weeks[weekNumber - 1].label}"`);
    console.log(`‚úÖ Label normalis√©: "${rpoLabel}"`);
  } else {
    console.warn(`‚ö†Ô∏è Pas de semaine ${weekNumber} dans getWeeksForMonth(${monthIndex})`);
  }

  // Si pas trouv√©, essayer depuis window.weeklyData en fallback
  if (!rpoLabel && window.weeklyData?.[String(monthIndex)]?.[String(weekNumber)]?.week_label) {
    rpoLabel = normalizeLabel(window.weeklyData[String(monthIndex)][String(weekNumber)].week_label);
    console.log(`üì¶ Label r√©cup√©r√© depuis window.weeklyData: "${rpoLabel}"`);
  }

  let globalWeekNum = null;

  if (rpoLabel) {
    // Matcher par label avec le plan d'affaires
    const planRows = document.querySelectorAll('#plan-weeks-body tr.plan-row');
    console.log(`üîç Recherche dans ${planRows.length} lignes du plan d'affaires...`);

    // Afficher les 10 premiers labels du plan pour debug
    console.log('üìã Premiers labels du plan d\'affaires:');
    planRows.forEach((row, idx) => {
      if (idx < 15) {
        const planLabelRaw = row.querySelector('td:first-child')?.textContent;
        const planLabel = normalizeLabel(planLabelRaw || '');
        console.log(`  Plan semaine ${idx + 1}: brut="${planLabelRaw}" normalis√©="${planLabel}"`);
      }
    });

    planRows.forEach((row, idx) => {
      const planLabelRaw = row.querySelector('td:first-child')?.textContent;
      const planLabel = normalizeLabel(planLabelRaw || '');
      if (planLabel === rpoLabel) {
        globalWeekNum = idx + 1; // idx commence √† 0, mais les semaines commencent √† 1
        console.log(`‚ú® MATCH TROUV√â! RPO "${rpoLabel}" = Plan ligne ${idx} (semaine ${globalWeekNum})`);
      }
    });

    if (globalWeekNum) {
      console.log(`‚úÖ Match par label: "${rpoLabel}" -> plan-w${globalWeekNum}`);
    } else {
      console.error(`‚ùå AUCUNE correspondance par label pour "${rpoLabel}"!`);
      console.log('üîç V√©rification: le label RPO existe-t-il dans le plan?');
    }
  }

  // Si toujours pas trouv√©, ne PAS utiliser la formule de fallback
  // Cette semaine n'existe pas r√©ellement pour ce mois (ex: semaine 5 de janvier qui n'a que 4 semaines)
  if (!globalWeekNum) {
    console.warn(`‚ö†Ô∏è SKIP: Semaine ${weekNumber} du mois ${monthIndex} n'existe pas dans le plan d'affaires`);
    console.warn(`   getWeeksForMonth(${monthIndex}) a retourn√© ${weeks?.length || 0} semaines`);
    return; // Skip cette mise √† jour
  }

  console.log(`üéØ R√©sultat final: globalWeekNum = ${globalWeekNum}`);
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

  // Mettre √† jour les inputs du plan d'affaire
  const mktgInput = document.getElementById(`plan-w${globalWeekNum}-mktg-reel`);
  if (mktgInput && data.h_marketing !== undefined) {
    // Formater uniquement si ce n'est pas "-"
    if (data.h_marketing === '-' || data.h_marketing === '') {
      mktgInput.value = '-';
    } else {
      mktgInput.value = data.h_marketing + ' h';
    }
  }

  const estimInput = document.getElementById(`plan-w${globalWeekNum}-estim-reel`);
  if (estimInput && data.estimation !== undefined) {
    estimInput.value = data.estimation;
  }

  const contratInput = document.getElementById(`plan-w${globalWeekNum}-contrat-reel`);
  if (contratInput && data.contract !== undefined) {
    contratInput.value = data.contract;
  }

  const dollarInput = document.getElementById(`plan-w${globalWeekNum}-dollar-reel`);
  if (dollarInput && data.dollar !== undefined) {
    dollarInput.value = data.dollar;
  }

  // Recalculer le plan
  calculatePlan();
}

// Format weekly input on blur - enlever le formatage automatique, juste sauvegarder la valeur
function setupWeeklyInputFormatting() {
  // Sur focus: enlever les suffixes pour √©dition pure
  document.addEventListener('focus', (e) => {
    if (e.target.classList.contains('week-jan-input')) {
      const field = e.target.dataset.field;

      // Ignorer les champs automatiques (estimation, contract, dollar)
      if (field === 'estimation' || field === 'contract' || field === 'dollar') {
        return;
      }

      let value = e.target.value.trim();

      // Si c'est "-", vider le champ pour permettre la saisie
      if (value === '-') {
        e.target.value = '';
        return;
      }

      // Enlever les suffixes (h, $, $/h) et espaces pour √©dition
      value = value.replace(/[^\d.]/g, '');
      e.target.value = value;
    }
  }, true);

  // Sur blur: juste sauvegarder dataset.value, pas de formatage visuel
  document.addEventListener('blur', (e) => {
    if (e.target.classList.contains('week-jan-input')) {
      const field = e.target.dataset.field;

      // Ignorer les champs automatiques (estimation, contract, dollar)
      if (field === 'estimation' || field === 'contract' || field === 'dollar') {
        return;
      }

      let value = e.target.value.trim();

      // Remove all non-numeric characters except decimal point
      value = value.replace(/[^\d.]/g, '');

      if (value === '') {
        // Si vide, mettre "-" pour h_marketing et prod_horaire, "0" pour le reste
        if (field === 'h_marketing' || field === 'prod_horaire') {
          e.target.value = '-';
          e.target.dataset.value = '-';
          return;
        } else {
          value = '0';
        }
      }

      const numValue = parseFloat(value);

      if (!isNaN(numValue)) {
        // Sauvegarder seulement dataset.value, pas de formatage visuel
        e.target.dataset.value = numValue;

        // Formatage intelligent bas√© sur le type de champ
        if (field === 'h_marketing') {
          // Pour les heures: enlever .00 si c'est un entier
          const formatted = numValue % 1 === 0 ? numValue.toFixed(0) : numValue.toFixed(1);
          e.target.value = formatted + ' h';
        } else if (field === 'estimation' || field === 'contract') {
          const intValue = Math.round(numValue);
          e.target.value = intValue.toString();
          e.target.dataset.value = intValue;
        } else if (field === 'dollar') {
          e.target.value = numValue.toLocaleString('fr-CA', {minimumFractionDigits: 2, maximumFractionDigits: 2}).replace(/\s/g, ' ') + ' $';
        } else if (field === 'prod_horaire') {
          e.target.value = numValue.toFixed(2) + ' $/h';
        }
      }
    }
  }, true);
}

// Initialize annual stats dropdown for mobile filtering
function initAnnualStatsDropdown() {
  const dropdownButton = document.querySelector('#annualStatsDropdown .custom-select-button');
  const dropdownMenu = document.getElementById('annual-stat-dropdown-menu');
  const selectedText = document.getElementById('annual-stat-selected-text');
  const options = document.querySelectorAll('#annual-stat-dropdown-menu .custom-select-option');

  if (!dropdownButton || !dropdownMenu || !selectedText) return;

  // Toggle dropdown on button click
  dropdownButton.addEventListener('click', function(e) {
    e.stopPropagation();
    const isVisible = dropdownMenu.style.display === 'block';
    dropdownMenu.style.display = isVisible ? 'none' : 'block';
  });

  // Handle option selection
  options.forEach(option => {
    option.addEventListener('click', function() {
      const value = this.getAttribute('data-value');
      const text = this.textContent;

      // Update selected text
      selectedText.textContent = text;

      // Remove selected class from all options
      options.forEach(opt => opt.classList.remove('selected'));

      // Add selected class to clicked option
      this.classList.add('selected');

      // Hide all stat cards
      document.querySelectorAll('.annual-stat-card').forEach(card => {
        card.classList.remove('active-stat');
      });

      // Show selected card
      const selectedCard = document.querySelector(`.annual-stat-card[data-stat-type="${value}"]`);
      if (selectedCard) {
        selectedCard.classList.add('active-stat');
      }

      // Close dropdown
      dropdownMenu.style.display = 'none';
    });
  });

  // Set default to $ SIGN√â on mobile
  if (window.innerWidth <= 600) {
    const dollarCard = document.querySelector('.annual-stat-card[data-stat-type="dollar"]');
    if (dollarCard) {
      dollarCard.classList.add('active-stat');
    }
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('#annualStatsDropdown')) {
      dropdownMenu.style.display = 'none';
    }
  });
}

// ============================================
// COACH SELECTOR FOR DIRECTION USERS
// ============================================

// Load coaches from API (for direction users)
async function loadCoaches() {
  try {
    const response = await fetch('/api/users/coaches');
    const data = await response.json();

    if (data.success && data.coaches) {
      log('[RPO] Coaches charg√©s:', data.coaches.length);
      populateCoachDropdown(data.coaches);
    } else {
      showNoCoaches();
    }
  } catch (error) {
    error('[RPO] Erreur chargement coaches:', error);
    showNoCoaches();
  }
}

// Populate coach dropdown (for direction users)
function populateCoachDropdown(coaches) {
  const dropdownMenu = document.getElementById('coach-dropdown-menu');

  if (!dropdownMenu) {
    error('[RPO] coach-dropdown-menu introuvable');
    return;
  }

  if (coaches.length === 0) {
    showNoCoaches();
    return;
  }

  dropdownMenu.innerHTML = '';

  coaches.forEach(coach => {
    const option = document.createElement('div');
    option.className = 'coach-dropdown-option';
    option.dataset.username = coach.username;

    const displayName = coach.prenom && coach.nom
      ? `${coach.prenom} ${coach.nom} (${coach.username})`
      : coach.username;

    option.innerHTML = `
      <span>
        <i class="fas fa-user-graduate"></i>
        <span>${displayName}</span>
      </span>
    `;

    option.addEventListener('click', function() {
      selectCoach(coach.username);
    });

    dropdownMenu.appendChild(option);
  });

  log('[RPO] ‚úÖ Dropdown peupl√© avec', coaches.length, 'coaches');
}

// Handle coach selection (for direction users)
function selectCoach(username) {
  log('[RPO] Coach s√©lectionn√©:', username);

  // Update URL parameter
  const url = new URL(window.location);
  url.searchParams.set('user', username);
  window.history.pushState({}, '', url);

  // Update dropdown toggle text
  const toggle = document.getElementById('coach-dropdown-toggle');
  if (toggle) {
    const placeholder = toggle.querySelector('.placeholder');
    if (placeholder) {
      placeholder.textContent = username;
    }
  }

  // Close dropdown
  const dropdownMenu = document.getElementById('coach-dropdown-menu');
  if (dropdownMenu) {
    dropdownMenu.classList.remove('show');
  }
  const toggleBtn = document.getElementById('coach-dropdown-toggle');
  if (toggleBtn) {
    toggleBtn.classList.remove('active');
  }

  // Hide selector and show content
  const selector = document.getElementById('coach-entrepreneur-selector');
  const backdrop = document.getElementById('coach-selector-backdrop');

  if (selector) {
    selector.classList.remove('visible');
    setTimeout(() => {
      selector.classList.add('in-header');
    }, 300);
  }

  if (backdrop) {
    backdrop.classList.remove('visible');
  }

  // Add has-selection class to body
  document.body.classList.add('has-selection');

  // Load RPO data for selected coach
  setTimeout(async () => {
    await loadRPODataInternal();

    // Charger les objectifs sauvegard√©s AVANT d'afficher les vues
    if (typeof loadSavedWeeklyTargetsIntoPlan === 'function') {
      await loadSavedWeeklyTargetsIntoPlan();
      log('[RPO] Objectifs hebdomadaires sauvegard√©s charg√©s pour le coach');
    }

    // Initialize views
    changeMonthlyView(0);
    changeMonth(0, true); // forceChange=true pour l'initialisation
    calculateMonthlyTotalsFromWeekly(0);

    log('[RPO] ‚úÖ Donn√©es charg√©es pour le coach:', username);
  }, 100);
}

// Show "no coaches" message
function showNoCoaches() {
  const dropdownMenu = document.getElementById('coach-dropdown-menu');
  if (dropdownMenu) {
    dropdownMenu.innerHTML = '<div class="coach-dropdown-option-disabled">Aucun coach disponible</div>';
  }
}

// Handle star rating clicks on page load
document.addEventListener('DOMContentLoaded', async function() {
  // D√©tecter si on est en mode "embed" (affichage dans iframe du coach)
  const urlParams = new URLSearchParams(window.location.search);
  const embedMode = urlParams.get('embed');

  // D√©tecter si un coach n'a pas encore s√©lectionn√© d'entrepreneur
  const userRole = localStorage.getItem('userRole');
  const isCoach = userRole === 'coach';
  const userParam = urlParams.get('user');
  const coachUsername = localStorage.getItem('username');

  initStarRatings();
  initCustomDropdowns();
  initAnnualStatsDropdown();
  setupWeeklyInputFormatting();

  // Les textes du s√©lecteur sont d√©finis dans le HTML de base (toujours "entrepreneur")

  // Skip data loading if coach hasn't selected an entrepreneur yet
  // (si pas de user param OU si le user param est le coach lui-m√™me)
  // EXACTEMENT COMME FACTURATION QE
  const userParamIsCoach = userParam && userParam === coachUsername;
  const isCoachModeWithoutSelection = isCoach && (!userParam || userParamIsCoach);

  if (isCoachModeWithoutSelection) {
    log('[INIT] Mode coach d√©tect√© - Les donn√©es seront charg√©es apr√®s la s√©lection d\'entrepreneur');
    // Ne pas charger les donn√©es maintenant, elles seront charg√©es par entrepreneur-selector.js
    return;
  }

  // D√©tecter si un utilisateur direction n'a pas encore s√©lectionn√© de coach
  const isDirection = userRole === 'direction';
  const isDirectionModeWithoutSelection = isDirection && !userParam;

  if (isDirectionModeWithoutSelection) {
    log('[INIT] Mode direction d√©tect√© - entrepreneur-selector.js chargera la liste des coaches');
    // Ne pas charger les donn√©es maintenant - entrepreneur-selector.js s'occupe du chargement des coaches
    // Les donn√©es RPO seront charg√©es apr√®s la s√©lection d'un coach
    return;
  }

  // Load RPO data from backend (entrepreneurs ou coachs avec entrepreneur s√©lectionn√©)
  await loadRPODataInternal();

  // Charger les objectifs du coach pour cet entrepreneur
  await loadCoachObjectifs();

  // Initialize views with January AFTER DOM is fully ready
  setTimeout(async () => {
    // Initialize monthly view
    changeMonthlyView(0);
    log('‚úì [INIT] Monthly view initialized with January (monthIndex: 0)');

    // IMPORTANT: Charger les objectifs sauvegard√©s AVANT d'afficher les tableaux hebdomadaires
    if (typeof loadSavedWeeklyTargetsIntoPlan === 'function') {
      await loadSavedWeeklyTargetsIntoPlan();
      log('‚úì [INIT] Objectifs hebdomadaires sauvegard√©s charg√©s');
    }

    // Initialize weekly view - THIS loads the weekly data
    changeMonth(0, true); // forceChange=true pour l'initialisation
    log('‚úì [INIT] Weekly view initialized with January (monthIndex: 0)');

    // Calculer les totaux hebdomadaires pour janvier
    calculateMonthlyTotalsFromWeekly(0);
  }, 100);

  // Appliquer le mode embed APR√àS le chargement des donn√©es
  if (embedMode === 'weekly') {
    log('[RPO EMBED] Mode embed d√©tect√© - initialisation...');

    // Fonction pour forcer le masquage des √©l√©ments ind√©sirables
    function hideUnwantedElements() {
      // Masquer le s√©lecteur d'entrepreneur et le backdrop
      const selector = document.getElementById('coach-entrepreneur-selector');
      const backdrop = document.getElementById('coach-selector-backdrop');
      const nav = document.querySelector('nav');
      const mainWrapper = document.getElementById('main-content-wrapper');

      if (selector) {
        selector.style.setProperty('display', 'none', 'important');
        selector.style.setProperty('visibility', 'hidden', 'important');
        selector.style.setProperty('opacity', '0', 'important');
        selector.style.setProperty('pointer-events', 'none', 'important');
        selector.classList.remove('visible');
      }

      if (backdrop) {
        backdrop.style.setProperty('display', 'none', 'important');
        backdrop.style.setProperty('visibility', 'hidden', 'important');
        backdrop.classList.remove('visible');
      }

      if (nav) {
        nav.style.setProperty('display', 'none', 'important');
      }

      if (mainWrapper) {
        mainWrapper.style.setProperty('padding', '0', 'important');
      }

      log('[RPO EMBED] √âl√©ments cach√©s:', {
        selector: !!selector,
        backdrop: !!backdrop,
        nav: !!nav
      });
    }

    // Appliquer imm√©diatement
    hideUnwantedElements();

    // Ajouter un style CSS global pour renforcer
    const style = document.createElement('style');
    style.textContent = `
      #coach-entrepreneur-selector,
      #coach-entrepreneur-selector.visible {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }
      #coach-selector-backdrop,
      #coach-selector-backdrop.visible {
        display: none !important;
        visibility: hidden !important;
      }
      nav { display: none !important; }
      header { display: none !important; }
      #main-content-wrapper { padding: 0 !important; }
    `;
    document.head.appendChild(style);

    // Observer les changements DOM pour r√©appliquer si n√©cessaire
    const observer = new MutationObserver(() => {
      hideUnwantedElements();
    });

    observer.observe(document.body, {
      attributes: true,
      attributeFilter: ['class', 'style'],
      subtree: true
    });

    setTimeout(() => {
      log('[RPO EMBED] Mode embed activ√© - affichage uniquement de la section hebdomadaire');

      // R√©appliquer le masquage
      hideUnwantedElements();

      // Cacher tous les enfants de .main-content SAUF weekly-section-container
      const mainContent = document.querySelector('.main-content');
      if (mainContent) {
        mainContent.style.padding = '0';
        Array.from(mainContent.children).forEach(child => {
          if (child.id !== 'weekly-section-container') {
            child.style.setProperty('display', 'none', 'important');
          }
        });
      }

      // Ajuster le style du body et de la section
      document.body.style.padding = '0';
      document.body.style.margin = '0';
      document.body.style.background = 'var(--bg-primary)';

      const weeklySection = document.getElementById('weekly-section-container');
      if (weeklySection) {
        weeklySection.style.marginTop = '0';
        weeklySection.style.marginBottom = '0';
      }

      log('[RPO EMBED] Section hebdomadaire affich√©e en mode embed');
    }, 600);
  }
});

// Calculer pourcentage pour mois sp√©cifique
function calculateMonthPercentage(month, metricName) {
  const viseInput = document.getElementById(month + '-' + metricName + '-vise');
  if (!viseInput) return;

  const cardDiv = viseInput.closest('.rounded-xl');
  if (!cardDiv) return;

  const reelDiv = document.getElementById(month + '-' + metricName + '-reel');
  const percentElement = document.getElementById(month + '-' + metricName + '-percent');
  const circleElement = document.getElementById(month + '-' + metricName + '-circle');

  if (!reelDiv || !percentElement || !circleElement) return;

  const viseValue = parseFloat(viseInput.dataset.value);
  const reelValue = parseFloat(reelDiv.dataset.value);

  // If vis√© is 0, set everything to white/gray (nothing to compare)
  if (!viseValue || viseValue === 0) {
    const grayColor = '#e5e7eb';
    const circumference = 201;
    percentElement.textContent = '0%';
    circleElement.style.strokeDashoffset = circumference;
    cardDiv.style.borderTop = `3px solid ${grayColor}`;
    circleElement.style.stroke = grayColor;
    percentElement.style.color = grayColor;
    // Barre de progression mobile √† 0
    cardDiv.style.setProperty('--progress-width', '0%');
    cardDiv.style.setProperty('--progress-color', grayColor);
    return;
  }

  if (viseValue > 0) {
    const percentageOfTarget = (reelValue / viseValue) * 100;
    const percentRounded = Math.round(percentageOfTarget * 10) / 10;

    // Calculate circle progress (circumference = 2 * œÄ * r = 2 * œÄ * 32 ‚âà 201)
    const circumference = 201;
    const progress = Math.min(percentRounded, 100); // Cap at 100%
    const offset = circumference - (progress / 100) * circumference;

    percentElement.textContent = percentRounded + '%';
    circleElement.style.strokeDashoffset = offset;

    // Change colors based on percentage - orange d√®s 0.1%, jaune √† 30%, vert √† 60%
    let color;
    if (percentRounded >= 100) {
      // 100%+ - vert fonc√©
      color = '#22c55e';
    } else if (percentRounded >= 90) {
      // 90-99% - vert
      color = '#34d399';
    } else if (percentRounded >= 80) {
      // 80-89% - vert clair
      color = '#4ade80';
    } else if (percentRounded >= 70) {
      // 70-79% - vert-jaune
      color = '#84cc16';
    } else if (percentRounded >= 60) {
      // 60-69% - jaune-vert (d√©but du vert)
      color = '#a3e635';
    } else if (percentRounded >= 50) {
      // 50-59% - jaune vif
      color = '#eab308';
    } else if (percentRounded >= 30) {
      // 30-49% - jaune
      color = '#facc15';
    } else if (percentRounded > 0) {
      // 0.1-29% - orange (d√®s 0.1%)
      color = '#f97316';
    } else {
      // 0% uniquement - blanc/gris
      color = '#e5e7eb';
    }

    cardDiv.style.borderTop = `3px solid ${color}`;
    circleElement.style.stroke = color;
    percentElement.style.color = color;

    // Mettre √† jour la barre de progression pour mobile
    cardDiv.style.setProperty('--progress-width', `${Math.min(progress, 100)}%`);
    cardDiv.style.setProperty('--progress-color', color);
  }
}

// Calculer pourcentage pour objectifs
function calculateObjectifPercentage(month, objectifType) {
  const objectifInput = document.getElementById(month + '-obj-' + objectifType);
  if (!objectifInput) return;

  const cardDiv = objectifInput.closest('.rounded-xl');
  if (!cardDiv) return;

  const reelDiv = document.getElementById(month + '-obj-' + objectifType + '-reel');
  const percentElement = document.getElementById(month + '-obj-' + objectifType + '-percent');
  const circleElement = document.getElementById(month + '-obj-' + objectifType + '-circle');

  if (!reelDiv || !percentElement || !circleElement) return;

  const objectifValue = parseFloat(objectifInput.dataset.value);
  const reelValue = parseFloat(reelDiv.dataset.value);

  // If objectif is 0, set everything to white/gray (nothing to compare)
  if (!objectifValue || objectifValue === 0) {
    const grayColor = '#e5e7eb';
    const circumference = 201;
    percentElement.textContent = '0%';
    circleElement.style.strokeDashoffset = circumference;
    cardDiv.style.borderTop = `3px solid ${grayColor}`;
    circleElement.style.stroke = grayColor;
    percentElement.style.color = grayColor;
    return;
  }

  if (objectifValue > 0) {
    const percentageOfTarget = (reelValue / objectifValue) * 100;
    const percentRounded = Math.round(percentageOfTarget * 10) / 10;

    // Calculate circle progress (circumference = 2 * œÄ * r = 2 * œÄ * 32 ‚âà 201)
    const circumference = 201;
    const progress = Math.min(percentRounded, 100); // Cap at 100%
    const offset = circumference - (progress / 100) * circumference;

    percentElement.textContent = percentRounded + '%';
    circleElement.style.strokeDashoffset = offset;

    // Change colors based on percentage - orange d√®s 0.1%, jaune √† 30%, vert √† 60%
    let color;
    if (percentRounded >= 100) {
      // 100%+ - vert fonc√©
      color = '#22c55e';
    } else if (percentRounded >= 90) {
      // 90-99% - vert
      color = '#34d399';
    } else if (percentRounded >= 80) {
      // 80-89% - vert clair
      color = '#4ade80';
    } else if (percentRounded >= 70) {
      // 70-79% - vert-jaune
      color = '#84cc16';
    } else if (percentRounded >= 60) {
      // 60-69% - jaune-vert (d√©but du vert)
      color = '#a3e635';
    } else if (percentRounded >= 50) {
      // 50-59% - jaune vif
      color = '#eab308';
    } else if (percentRounded >= 30) {
      // 30-49% - jaune
      color = '#facc15';
    } else if (percentRounded > 0) {
      // 0.1-29% - orange (d√®s 0.1%)
      color = '#f97316';
    } else {
      // 0% uniquement - blanc/gris
      color = '#e5e7eb';
    }

    cardDiv.style.borderTop = `3px solid ${color}`;
    circleElement.style.stroke = color;
    percentElement.style.color = color;
  }
}

// Toggle edit mode pour F√©vrier
function toggleEditFeb() {
  // obj-pap et obj-rep sont EXCLUS - ils ne sont jamais modifiables (d√©finis par le coach)
  const inputs = [
    document.getElementById('feb-hrpap-vise'),
    document.getElementById('feb-estimation-vise'),
    document.getElementById('feb-contract-vise'),
    document.getElementById('feb-dollar-vise')
  ];

  const editBtn = document.getElementById('editFebBtn');
  const saveBtn = document.getElementById('saveFebBtn');
  const isReadonly = inputs[0].hasAttribute('readonly');

  inputs.forEach(input => {
    if (isReadonly) {
      input.removeAttribute('readonly');
      input.style.background = 'rgba(96, 165, 250, 0.1)';
      input.style.borderBottom = '2px solid var(--primary-blue)';
      input.style.color = 'var(--primary-blue)';
      input.style.padding = '4px 8px';
      input.style.borderRadius = '4px';

      // V√©rifier si la valeur est par d√©faut (0)
      const currentValue = input.value.trim();
      const parsedValue = parseFloat(currentValue.replace(/[^\d.-]/g, '')) || 0;
      if (parsedValue === 0) {
        // Valeur par d√©faut: mettre en placeholder et vider
        input.placeholder = currentValue;
        input.value = '';
      } else {
        // Valeur saisie: afficher la valeur num√©rique brute
        input.value = String(parsedValue);
        input.placeholder = '';
      }
    } else {
      input.setAttribute('readonly', 'true');
      input.style.background = 'transparent';
      input.style.borderBottom = 'none';
      const inputId = input.id;
      if (inputId === 'feb-obj-pap' || inputId === 'feb-obj-rep') {
        input.style.color = 'var(--primary-blue)';
      } else {
        input.style.color = 'var(--text-gray)';
      }
      input.style.padding = '0';
      input.style.borderRadius = '0';
      input.placeholder = '';
    }
  });

  // Toggle button visibility
  if (isReadonly) {
    editBtn.classList.add('hidden');
    saveBtn.classList.remove('hidden');
  } else {
    editBtn.classList.remove('hidden');
    saveBtn.classList.add('hidden');
  }
}

async function saveFeb() {
  const saveBtn = document.getElementById('saveFebBtn');
  const originalHTML = saveBtn.innerHTML;

  // Afficher le spinner
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i><span class="text-xs font-semibold">Enregistrement...</span>';
  saveBtn.disabled = true;
  saveBtn.style.cursor = 'not-allowed';
  saveBtn.style.opacity = '0.7';

  try {
    // Formater les inputs avant de sauvegarder
    // Note: obj-pap et obj-rep ne sont pas format√©s car ils ne sont jamais modifiables (d√©finis par le coach)
    formatMetricInput('feb-hrpap-vise', 'h');
    formatMetricInput('feb-dollar-vise', '$');

    toggleEditFeb();
    // Recalculer tous les pourcentages apr√®s sauvegarde
    calculateMonthPercentage('feb', 'hrpap');
    calculateMonthPercentage('feb', 'estimation');
    calculateMonthPercentage('feb', 'contract');
    calculateMonthPercentage('feb', 'dollar');
  } finally {
    // Restaurer le bouton
    setTimeout(() => {
      saveBtn.innerHTML = originalHTML;
      saveBtn.disabled = false;
      saveBtn.style.cursor = '';
      saveBtn.style.opacity = '';
    }, 300);
  }
}

// Chart tooltip interaction am√©lior√©e
document.addEventListener('DOMContentLoaded', () => {
  // Calculer les pourcentages de janvier au chargement
  calculateMonthPercentage('jan', 'hrpap');
  calculateMonthPercentage('jan', 'estimation');
  calculateMonthPercentage('jan', 'contract');
  calculateMonthPercentage('jan', 'dollar');

  // Calculer les pourcentages de f√©vrier au chargement
  calculateMonthPercentage('feb', 'hrpap');
  calculateMonthPercentage('feb', 'estimation');
  calculateMonthPercentage('feb', 'contract');
  calculateMonthPercentage('feb', 'dollar');

  const chartPoints = document.querySelectorAll('.chart-point');
  const tooltip = document.getElementById('chartTooltip');
  const tooltipMonth = document.getElementById('tooltipMonth');
  const tooltipValue = document.getElementById('tooltipValue');

  // Ancien code de navigation par swipe - maintenant remplac√© par dropdown
  // (Code supprim√© car on utilise un dropdown pour changer de mois)

  chartPoints.forEach(point => {
    point.addEventListener('mouseenter', (e) => {
      const month = point.getAttribute('data-month');
      const value = parseInt(point.getAttribute('data-value'));

      // Agrandir le point au survol
      point.setAttribute('r', '8');
      point.style.filter = 'drop-shadow(0 0 8px rgba(16, 185, 129, 0.8))';

      tooltipMonth.textContent = month;
      tooltipValue.textContent = value.toLocaleString('fr-CA', { style: 'currency', currency: 'CAD', minimumFractionDigits: 0 });

      tooltip.classList.remove('hidden');
      tooltip.style.opacity = '1';
    });

    point.addEventListener('mousemove', (e) => {
      const rect = e.target.closest('svg').getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      tooltip.style.left = x + 15 + 'px';
      tooltip.style.top = y - 50 + 'px';
    });

    point.addEventListener('mouseleave', () => {
      // R√©duire le point √† sa taille normale
      point.setAttribute('r', '5');
      point.style.filter = 'none';

      tooltip.style.opacity = '0';
      setTimeout(() => {
        tooltip.classList.add('hidden');
      }, 200);
    });
  });
});

// ============================================
// PLAN D'AFFAIRE - FONCTIONS
// ============================================

// G√©n√©rer les lignes du tableau hebdomadaire avec pr√©visions
// Sauvegarder les objectifs "Vis√©" hebdomadaires dans le JSON
async function saveWeeklyTargetsToJSON(mktgPattern, estimPattern, contratPattern, dollarPattern, startDate) {
  log('[SAVE TARGETS] D√©but de la sauvegarde des objectifs hebdomadaires...');

  // Construire l'objet avec les donn√©es par mois et semaine
  const weeklyTargets = {};

  for (let i = 0; i < 52; i++) {
    const weekStartDate = new Date(startDate.getTime() + (i * 7 * 24 * 60 * 60 * 1000));
    const weekEndDate = new Date(weekStartDate.getTime() + (6 * 24 * 60 * 60 * 1000));

    // D√©terminer le mois de la semaine (utiliser month index comme dans le RPO)
    // D√©cembre 2025 = -1, Janvier 2026 = 0, F√©vrier = 1, etc.
    const month = weekStartDate.getMonth(); // 0-11
    const year = weekStartDate.getFullYear();

    let monthIndex;
    if (year === 2025 && month === 11) {
      monthIndex = -1; // D√©cembre 2025
    } else if (year === 2026) {
      monthIndex = month; // 0-11 pour janvier-d√©cembre 2026
    } else {
      continue; // Ignorer les autres ann√©es
    }

    // Cr√©er le label de semaine
    const startDay = weekStartDate.getDate();
    const endDay = weekEndDate.getDate();
    const startMonth = weekStartDate.toLocaleDateString('fr-FR', { month: 'short' });
    const endMonth = weekEndDate.toLocaleDateString('fr-FR', { month: 'short' });

    let weekLabel;
    if (startMonth === endMonth) {
      weekLabel = `${startDay} - ${endDay} ${startMonth.replace('.', '')}`;
    } else {
      weekLabel = `${startDay} ${startMonth.replace('.', '')} - ${endDay} ${endMonth.replace('.', '')}`;
    }

    // Initialiser le mois si n√©cessaire
    if (!weeklyTargets[monthIndex]) {
      weeklyTargets[monthIndex] = {};
    }

    // Compter les semaines dans ce mois
    const weekNumInMonth = Object.keys(weeklyTargets[monthIndex]).length + 1;

    // Ajouter les donn√©es de la semaine
    weeklyTargets[monthIndex][weekNumInMonth] = {
      week_label: weekLabel,
      h_marketing_vise: mktgPattern[i] || 0,
      estimation_vise: estimPattern[i] || 0,
      contract_vise: contratPattern[i] || 0,
      dollar_vise: dollarPattern[i] || 0
    };
  }

  log('[SAVE TARGETS] Donn√©es pr√©par√©es:', weeklyTargets);

  // Envoyer au backend
  const username = getCurrentUsername();

  try {
    const response = await fetch('/api/rpo/save-weekly-targets', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        username: username,
        weekly_targets: weeklyTargets
      })
    });

    if (response.ok) {
      log('[SAVE TARGETS] ‚úÖ Objectifs hebdomadaires sauvegard√©s avec succ√®s');
    } else {
      error('[SAVE TARGETS] ‚ùå Erreur lors de la sauvegarde:', response.status);
    }
  } catch (error) {
    error('[SAVE TARGETS] ‚ùå Erreur r√©seau:', error);
  }
}

// Charger les objectifs hebdomadaires sauvegard√©s depuis le backend et les mettre dans window.planWeeklyTargets
async function loadSavedWeeklyTargetsIntoPlan() {
  if (!window.planWeeklyTargets) {
    log('[LOAD TARGETS] window.planWeeklyTargets non initialis√©, skip');
    return;
  }

  const username = getCurrentUsername();
  log('[LOAD TARGETS] Chargement des objectifs hebdomadaires sauvegard√©s...');

  try {
    // Charger les donn√©es hebdomadaires pour tous les mois (Janvier = 0, jusqu'√† D√©cembre = 11)
    for (let monthIndex = 0; monthIndex <= 11; monthIndex++) {
      const response = await fetch(`/api/rpo/${username}/weekly/${monthIndex}`);
      if (response.ok) {
        const monthData = await response.json();

        // Pour chaque semaine dans ce mois
        Object.keys(monthData).forEach(weekNumber => {
          const weekData = monthData[weekNumber];

          // Si des objectifs "vise" sont sauvegard√©s, les utiliser
          if (weekData.h_marketing_vise !== undefined ||
              weekData.estimation_vise !== undefined ||
              weekData.contract_vise !== undefined ||
              weekData.dollar_vise !== undefined) {

            // Calculer l'index global dans window.planWeeklyTargets (0-51)
            const weekOffsets = {
              '0': 0,    // Janvier 2026
              '1': 5,    // F√©vrier 2026
              '2': 9,    // Mars 2026
              '3': 13,   // Avril 2026
              '4': 18,   // Mai 2026
              '5': 22,   // Juin 2026
              '6': 26,   // Juillet 2026
              '7': 31,   // Ao√ªt 2026
              '8': 35,   // Septembre 2026
              '9': 39,   // Octobre 2026
              '10': 44,  // Novembre 2026
              '11': 48   // D√©cembre 2026
            };

            const offset = weekOffsets[String(monthIndex)];
            if (offset !== undefined) {
              const globalIndex = offset + parseInt(weekNumber) - 1;

              if (globalIndex >= 0 && globalIndex < window.planWeeklyTargets.mktg.length) {
                // Remplacer les valeurs du plan par les valeurs sauvegard√©es
                if (weekData.h_marketing_vise !== undefined) {
                  window.planWeeklyTargets.mktg[globalIndex] = weekData.h_marketing_vise;
                }
                if (weekData.estimation_vise !== undefined) {
                  window.planWeeklyTargets.estim[globalIndex] = weekData.estimation_vise;
                }
                if (weekData.contract_vise !== undefined) {
                  window.planWeeklyTargets.contrat[globalIndex] = weekData.contract_vise;
                }
                if (weekData.dollar_vise !== undefined) {
                  window.planWeeklyTargets.dollar[globalIndex] = weekData.dollar_vise;
                }

                log(`[LOAD TARGETS] Semaine ${weekNumber} du mois ${monthIndex} (index global ${globalIndex}): h_marketing=${weekData.h_marketing_vise}, estimation=${weekData.estimation_vise}, contract=${weekData.contract_vise}, dollar=${weekData.dollar_vise}`);
              }
            }
          }
        });
      }
    }

    log('[LOAD TARGETS] OK Objectifs hebdomadaires charg√©s dans window.planWeeklyTargets');
  } catch (error) {
    error('[LOAD TARGETS] ERREUR Erreur r√©seau:', error);
  }
}

// Fonction pour recharger le plan d'affaire avec spinner
async function reloadPlanWithAnimation() {
  const planContainer = document.querySelector('.plan-scroll-container');
  if (!planContainer) return;

  // Cr√©er l'overlay avec spinner
  const overlay = document.createElement('div');
  overlay.style.position = 'absolute';
  overlay.style.top = '0';
  overlay.style.left = '0';
  overlay.style.width = '100%';
  overlay.style.height = '100%';
  overlay.style.background = 'rgba(15, 23, 42, 0.95)';
  overlay.style.display = 'flex';
  overlay.style.flexDirection = 'column';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.zIndex = '1000';
  overlay.style.borderRadius = '14px';

  // Cr√©er le spinner
  const spinner = document.createElement('div');
  spinner.style.width = '60px';
  spinner.style.height = '60px';
  spinner.style.border = '4px solid rgba(59, 130, 246, 0.2)';
  spinner.style.borderTop = '4px solid var(--primary-blue)';
  spinner.style.borderRadius = '50%';
  spinner.style.animation = 'spin 1s linear infinite';

  // Texte de chargement
  const loadingText = document.createElement('div');
  loadingText.textContent = 'Rechargement du plan...';
  loadingText.style.marginTop = '1.5rem';
  loadingText.style.color = 'var(--text-light)';
  loadingText.style.fontSize = '0.875rem';
  loadingText.style.fontWeight = '500';

  overlay.appendChild(spinner);
  overlay.appendChild(loadingText);

  // Ajouter l'animation du spinner si elle n'existe pas
  if (!document.getElementById('spinner-animation-style')) {
    const style = document.createElement('style');
    style.id = 'spinner-animation-style';
    style.textContent = `
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);
  }

  // Positionner le container en relatif pour l'overlay
  const originalPosition = planContainer.style.position;
  planContainer.style.position = 'relative';
  planContainer.appendChild(overlay);

  // Petit d√©lai pour que le spinner soit visible
  await new Promise(resolve => setTimeout(resolve, 100));

  // R√©g√©n√©rer le plan d'affaire
  generatePlanWeeks();

  // IMPORTANT: Sauvegarder les nouvelles valeurs du plan dans le backend
  // Cela met √† jour les *_vise avec les valeurs du nouveau plan
  const startDate = createTorontoDate(2026, 0, 5); // 5 janvier 2026
  await saveWeeklyTargetsToJSON(
    window.planWeeklyTargets.mktg,
    window.planWeeklyTargets.estim,
    window.planWeeklyTargets.contrat,
    window.planWeeklyTargets.dollar,
    startDate
  );

  // Charger les objectifs hebdomadaires sauvegard√©s (maintenant √† jour)
  await loadSavedWeeklyTargetsIntoPlan();

  // Synchroniser les pr√©visions vers RPO
  setTimeout(() => {
    syncPlanToRPO();
  }, 50);

  // Recharger les donn√©es r√©elles
  setTimeout(() => {
    loadRPODataIntoPlan();
  }, 100);

  // Attendre que toutes les op√©rations soient termin√©es
  await new Promise(resolve => setTimeout(resolve, 300));

  // Recharger les tableaux hebdomadaires (Objectifs et R√©sultats) avec les nouvelles valeurs
  console.log('[RELOAD PLAN] Rechargement des tableaux hebdomadaires...');
  await loadWeeklyDataForMonth(currentWeeklyMonthIndex);

  // R√©g√©n√©rer les tableaux pour afficher les nouvelles valeurs d'objectifs
  console.log('[RELOAD PLAN] R√©g√©n√©ration des tableaux avec nouvelles valeurs...');
  refreshWeeklyTables();

  // Recalculer les √âtats des R√©sultats CIBL√â avec les % sauvegard√©s
  console.log('[RELOAD PLAN] Recalcul des √âtats des R√©sultats avec nouveaux montants CIBL√â...');
  updateCibleCalculations();

  // Retirer l'overlay
  overlay.remove();
  planContainer.style.position = originalPosition;
}

function generatePlanWeeks() {
  const tbody = document.getElementById('plan-weeks-body');
  if (!tbody) return;

  const startDate = createTorontoDate(2026, 0, 5); // 5 janvier 2026 (lundi) - Toronto timezone
  const weeks = 52; // Du 5 janvier 2026 au 27 d√©cembre 2026

  // R√©cup√©rer les param√®tres utilisateur
  const objectif = parseFloat(document.getElementById('plan-objectif')?.dataset.value) || 0;

  // Validation: v√©rifier que l'objectif CA est rempli
  if (objectif === 0 || isNaN(objectif)) {
    // Scroller vers la section Objectif CA et montrer le message d'alerte
    document.getElementById('objectif-ca-alert').scrollIntoView({ behavior: 'smooth', block: 'center' });
    return;
  }
  const contratMoyen = parseFloat(document.getElementById('plan-cm-prev')?.dataset.value) || 2500;
  const ratioMktg = parseFloat(document.getElementById('plan-ratio-mktg')?.dataset.value) || 85;
  const tauxVente = parseFloat(document.getElementById('plan-taux-vente')?.dataset.value) || 30;

  // Pattern de pourcentages fixes par semaine (% de l'objectif annuel)
  // Plan commence le 5 janvier 2026 - premi√®re semaine vide, objectifs d√©butent le 12 janvier
  const percentagePattern = [
    0,  // Index 0: 5-11 janv 2026 (semaine vide)
    0.5, 2.0, 2.0,  // Index 1-3: 12 janv - 1 f√©v
    3.0, 2.5, 3.0, 3.0,  // Index 4-7: 2 f√©v - 1 mars (2-8 f√©v: +0.5% = 3.0%)
    3.5, 4.0, 4.5, 5.5,  // Index 8-11: 2 mars - 29 mars
    4.5, 6.5, 5.5, 6.0, 6.0,  // Index 12-16: 30 mars - 4 mai
    4.5, 4.5, 4.5, 4.5,  // Index 17-20: 5 mai - 1 juin
    3.5, 4.0, 3.5, 3.0,  // Index 21-24: 2 juin - 29 juin
    3.0, 3.0, 3.0, 2.0, 1.0,  // Index 25-29: 30 juin - 3 ao√ªt
    1.0, 1.0, 1.0, 1.0,  // Index 30-33: 4 ao√ªt - 31 ao√ªt
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  // Index 34-51: reste (0%)
  ];

  // Pour compatibilit√© avec le reste du code, garder intensityPattern
  const intensityPattern = percentagePattern;

  // Calculer le total d'intensit√© pour distribuer l'objectif
  // On compte seulement les semaines 2+ (index 1+) car le plan commence le 12 janvier (semaine 1 vide)
  const totalIntensity = intensityPattern.reduce((sum, val, idx) => {
    if (idx >= 1 && val > 0) {
      return sum + val;
    }
    return sum;
  }, 0);

  // Calculer les patterns dynamiquement
  const mktgPattern = [];
  const estimPattern = [];
  const contratPattern = [];
  const dollarPattern = [];
  const prodPattern = [];

  // Pattern d'intensit√© pour production avec pourcentages sp√©cifiques par semaine
  // Index mapping: Plan commence 5 janvier 2026
  // Index 17 = 5 mai 2026 (premi√®re semaine de production)
  const productionIntensity = [
    // Janvier - Avril 2026 (index 0-16): pas de production
    0, 0, 0, 0, 0,  // Index 0-4: Janvier 2026
    0, 0, 0, 0,     // Index 5-8: F√©vrier 2026
    0, 0, 0, 0,     // Index 9-12: Mars 2026
    0, 0, 0, 0,     // Index 13-16: Avril 2026

    // Mai 2026 (index 17-20)
    1,    // Index 17: 5 mai 2026 = 1%
    4,    // Index 18: 12 mai 2026 = 4%
    5,    // Index 19: 19 mai 2026 = 5%
    5,    // Index 20: 26 mai 2026 = 5%

    // Juin 2026 (index 21-24)
    5,    // Index 21: 2 juin 2026 = 5%
    7,    // Index 22: 9 juin 2026 = 7%
    7,    // Index 23: 16 juin 2026 = 7%
    7,    // Index 24: 23 juin 2026 = 7%

    // Juillet 2026 (index 25-29)
    7,    // Index 25: 30 juin 2026 = 7%
    7,    // Index 26: 7 juillet 2026 = 7%
    7,    // Index 27: 14 juillet 2026 = 7%
    7,    // Index 28: 21 juillet 2026 = 7%
    7,    // Index 29: 28 juillet 2026 = 7%

    // Ao√ªt 2026 (index 30-33)
    6,    // Index 30: 4 ao√ªt 2026 = 6%
    5,    // Index 31: 11 ao√ªt 2026 = 5%
    5,    // Index 32: 18 ao√ªt 2026 = 5%
    4,    // Index 33: 25 ao√ªt 2026 = 4%

    // Septembre 2026 - Fin (index 34-46)
    3.6,  // Index 34: 1 sept 2026 = 3,6%
    0.1,  // Index 35: 8 septembre 2026 = 0,1%
    0.1,  // Index 36: 15 septembre 2026 = 0,1%
    0.1,  // Index 37: 22 septembre 2026 = 0,1%
    0.1,  // Index 38: 29 septembre 2026 = 0,1%
    0, 0, 0, 0, 0, 0, 0, 0  // Index 39-46: reste
  ];
  const totalProdIntensity = productionIntensity.reduce((sum, val) => sum + val, 0);
  log('[PROD] Total des pourcentages de production:', totalProdIntensity + '%');

  for (let i = 0; i < weeks; i++) {
    const intensity = intensityPattern[i];

    // Pour la semaine 1 (index 0), pas de valeurs car le plan commence le 12 janvier (semaine 2)
    // Pour les semaines inactives (0) ou cach√©es (-1), pas de valeurs
    if (i < 1 || intensity <= 0) {
      mktgPattern.push(0);
      estimPattern.push(0);
      contratPattern.push(0);
      dollarPattern.push(0);
    } else {
      // Calculer $ sign√© pour cette semaine bas√© sur l'intensit√© (avec +10% distribu√© uniform√©ment)
      const dollarSemaine = ((objectif * 1.10) / totalIntensity) * intensity;
      dollarPattern.push(Math.round(dollarSemaine));

      // Calculer nombre de contrats ($ sign√© / contrat moyen)
      const nbContrats = dollarSemaine / contratMoyen;
      contratPattern.push(parseFloat(nbContrats.toFixed(1)));

      // Calculer estimations (contrats / taux de vente)
      const nbEstimations = nbContrats / (tauxVente / 100);
      estimPattern.push(Math.round(nbEstimations));

      // Calculer heures marketing (estimations / ratio marketing)
      const heuresMarketing = nbEstimations / (ratioMktg / 100);
      mktgPattern.push(parseFloat(heuresMarketing.toFixed(1)));
    }

    // Calculer production vis√©e bas√©e sur le pourcentage direct de l'objectif
    const prodIntensity = productionIntensity[i];
    if (prodIntensity > 0) {
      // prodIntensity est un pourcentage direct (1 = 1%, 4 = 4%, etc.)
      // Avec +10% distribu√© uniform√©ment
      const prodSemaine = (objectif * 1.10) * (prodIntensity / 100);
      prodPattern.push(Math.round(prodSemaine));
    } else {
      prodPattern.push(0);
    }
  }

  // V√©rifier le total calcul√©
  const totalDollarCalcule = dollarPattern.reduce((sum, val) => sum + val, 0);
  const totalProdCalcule = prodPattern.reduce((sum, val) => sum + val, 0);

  // Ajuster la derni√®re valeur non nulle de dollarPattern pour que le total soit exactement l'objectif + 10%
  const diffDollar = (objectif * 1.10) - totalDollarCalcule;
  if (diffDollar !== 0) {
    for (let i = dollarPattern.length - 1; i >= 0; i--) {
      if (dollarPattern[i] > 0) {
        dollarPattern[i] += diffDollar;
        break;
      }
    }
  }

  // Ajuster la derni√®re valeur non nulle de prodPattern pour que le total soit exactement l'objectif + 10%
  const diffProd = (objectif * 1.10) - totalProdCalcule;
  log('[DATA] Total production avant ajustement:', totalProdCalcule);
  log('[TARGET] Objectif CA + 10%:', objectif * 1.10);
  log('üìê Diff√©rence √† ajuster:', diffProd);

  if (diffProd !== 0) {
    for (let i = prodPattern.length - 1; i >= 0; i--) {
      if (prodPattern[i] > 0) {
        log(`‚úèÔ∏è Ajustement derni√®re semaine (index ${i}): ${prodPattern[i]} -> ${prodPattern[i] + diffProd}`);
        prodPattern[i] += diffProd;
        break;
      }
    }
  }

  // V√©rifier le total final
  const totalProdFinal = prodPattern.reduce((sum, val) => sum + val, 0);
  const semAvecProd = prodPattern.filter(v => v > 0).length;
  log('[OK] Total production apr√®s ajustement:', totalProdFinal);
  log('[CHECK] √âgal √† objectif + 10%?', totalProdFinal === (objectif * 1.10));
  log('[DATE] Nombre de semaines avec production > 0:', semAvecProd);
  log('[BAN] ProdPattern:', prodPattern);

  // Stocker les patterns globalement pour utilisation par le tableau RPO
  window.planWeeklyTargets = {
    mktg: [...mktgPattern],
    estim: [...estimPattern],
    contrat: [...contratPattern],
    dollar: [...dollarPattern],
    prod: [...prodPattern],
    startDate: new Date(startDate.getTime()) // Clone de la date de d√©part
  };

  let html = '';

  for (let i = 1; i <= weeks; i++) {
    // G√©n√©ration continue des dates depuis le 5 janvier 2026 (utiliser millisecondes pour √©viter probl√®mes timezone)
    const weekStartDate = new Date(startDate.getTime() + ((i - 1) * 7 * 24 * 60 * 60 * 1000));
    const weekEndDate = new Date(weekStartDate.getTime() + (6 * 24 * 60 * 60 * 1000));

    // Format: "5 janv - 11 janv" ou "20 - 26 d√©c" pour d√©cembre 2026
    const startDay = weekStartDate.getDate();
    const endDay = weekEndDate.getDate();
    const startMonth = weekStartDate.toLocaleDateString('fr-FR', { month: 'short' });
    const endMonth = weekEndDate.toLocaleDateString('fr-FR', { month: 'short' });
    const startYear = weekStartDate.getFullYear();
    const endYear = weekEndDate.getFullYear();

    let dateRangeStr;
    // Pour les semaines en 2025 (octobre et novembre), ajouter l'ann√©e
    if (startYear === 2025) {
      if (startMonth === endMonth) {
        dateRangeStr = `${startDay} - ${endDay} ${startMonth.replace('.', '')} 2025`;
      } else {
        // Si la semaine chevauche deux mois en 2025
        dateRangeStr = `${startDay} ${startMonth.replace('.', '')} - ${endDay} ${endMonth.replace('.', '')} 2025`;
      }
    } else {
      // Pour toutes les autres semaines (2026), pas d'ann√©e
      // IMPORTANT: Retirer les points pour coh√©rence avec le matching
      if (startMonth === endMonth) {
        dateRangeStr = `${startDay} - ${endDay} ${startMonth.replace('.', '')}`;
      } else {
        dateRangeStr = `${startDay} ${startMonth.replace('.', '')} - ${endDay} ${endMonth.replace('.', '')}`;
      }
    }

    // Skip hidden weeks (intensity = -1)
    if (intensityPattern[i - 1] === -1) {
      continue;
    }

    // Valeurs selon les patterns du CSV
    const mktgVal = mktgPattern[i - 1] || 0;
    const estimVal = estimPattern[i - 1] || 0;
    const contratVal = contratPattern[i - 1] || 0;
    const dollarVal = dollarPattern[i - 1] || 0;
    const prodViseVal = prodPattern[i - 1] || 0; // Production vis√©e (semaines 17-39, total = objectif CA)
    const pctSem = intensityPattern[i - 1] || 0; // % de l'objectif pour cette semaine
    const prodPct = productionIntensity[i - 1] || 0; // % de production pour cette semaine

    // TV commence le 12 janvier (semaine 2) et finit le 30 ao√ªt (semaine 34)
    // Progression: 25% -> 30% -> 35%
    let tvVal = '-';
    if (i >= 2 && i <= 34) {
      tvVal = 25;
      if (i >= 21) tvVal = 30; // √Ä partir de la semaine 21
      if (i >= 33) tvVal = 35; // √Ä partir de la semaine 33
    }

    const monthNum = weekStartDate.getMonth() + 1; // 1-12
    const yearNum = weekStartDate.getFullYear();

    html += `
      <tr class="plan-row" data-month="${monthNum}" data-year="${yearNum}">
        <!-- Semaine (sticky) -->
        <td class="plan-td-sticky" style="left: 0; width: 180px; min-width: 180px; max-width: 180px; text-align: left; font-size: 0.8rem; padding-left: 12px;">${dateRangeStr}</td>

        <!-- H. Marketing: Pr√©v + R√©el + Cumul Obj. + Cumul + Tendance -->
        <td class="plan-td plan-td-prev" style="background: rgba(96, 165, 250, 0.08); min-width: 110px;">${mktgVal.toFixed(1)} h</td>
        <td class="plan-td" style="background: rgba(96, 165, 250, 0.03); min-width: 140px;">
          <input type="text" id="plan-w${i}-mktg-reel" value="-" class="plan-input plan-reel-input" readonly data-linked="false">
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(96, 165, 250, 0.08); min-width: 110px;">
          <span id="plan-w${i}-mktg-cumul-obj">-</span>
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(96, 165, 250, 0.03); min-width: 110px;">
          <span id="plan-w${i}-mktg-cumul">-</span>
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(96, 165, 250, 0.03); min-width: 110px;">
          <span id="plan-w${i}-mktg-tendance">-</span>
        </td>

        <!-- Estimations: Pr√©v + R√©el + Cumul Obj. + Cumul + Tendance + Ratio -->
        <td class="plan-td plan-td-prev" style="background: rgba(52, 211, 153, 0.08); min-width: 110px;">${estimVal}</td>
        <td class="plan-td" style="background: rgba(52, 211, 153, 0.03); min-width: 140px;">
          <input type="text" id="plan-w${i}-estim-reel" value="0" class="plan-input plan-reel-input" readonly data-linked="false">
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(52, 211, 153, 0.08); min-width: 110px;">
          <span id="plan-w${i}-estim-cumul-obj">0</span>
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(52, 211, 153, 0.03); min-width: 110px;">
          <span id="plan-w${i}-estim-cumul">0</span>
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(52, 211, 153, 0.03); min-width: 110px;">
          <span id="plan-w${i}-estim-tendance">0</span>
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(52, 211, 153, 0.08); min-width: 110px;">
          <span id="plan-w${i}-ratio">0.00</span>
        </td>

        <!-- Contrats: Pr√©v + R√©el + Cumul Obj. + Cumul + Tendance -->
        <td class="plan-td plan-td-prev" style="background: rgba(251, 146, 60, 0.08); min-width: 110px;">${contratVal}</td>
        <td class="plan-td" style="background: rgba(251, 146, 60, 0.03); min-width: 140px;">
          <input type="text" id="plan-w${i}-contrat-reel" value="0" class="plan-input plan-reel-input" readonly data-linked="false">
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(251, 146, 60, 0.08); min-width: 110px;">
          <span id="plan-w${i}-contrat-cumul-obj">0</span>
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(251, 146, 60, 0.03); min-width: 110px;">
          <span id="plan-w${i}-contrat-cumul">0</span>
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(251, 146, 60, 0.03); min-width: 110px;">
          <span id="plan-w${i}-contrat-tendance">0</span>
        </td>

        <!-- $ Sign√©s: Pr√©v + R√©el + Cumul Obj. + Cumul + Tendance -->
        <td class="plan-td plan-td-prev" style="background: rgba(244, 114, 182, 0.08); min-width: 110px;">${Math.round(dollarVal).toLocaleString('fr-CA')} $</td>
        <td class="plan-td" style="background: rgba(244, 114, 182, 0.03); min-width: 140px;">
          <input type="text" id="plan-w${i}-dollar-reel" value="0 $" class="plan-input plan-reel-input" readonly data-linked="false">
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(244, 114, 182, 0.08); min-width: 110px;">
          <span id="plan-w${i}-dollar-cumul-obj">0 $</span>
        </td>
        <td class="plan-td" style="background: rgba(244, 114, 182, 0.03); min-width: 110px;">
          <span id="plan-w${i}-dollar-cumul">0 $</span>
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(244, 114, 182, 0.03); min-width: 110px;">
          <span id="plan-w${i}-dollar-tendance">0 $</span>
        </td>

        <!-- % Objectif + TV -->
        <td class="plan-td" style="background: rgba(167, 139, 250, 0.18); font-weight: 600; min-width: 110px;">
          <span id="plan-w${i}-pct-sem">${pctSem >= 0.01 ? pctSem.toFixed(2) + '%' : '0.0%'}</span>
        </td>
        <td class="plan-td" style="background: rgba(167, 139, 250, 0.12); font-weight: 600; min-width: 110px;">
          <span id="plan-w${i}-pct-cumul">0.00%</span>
        </td>
        <td class="plan-td" style="background: rgba(167, 139, 250, 0.18); font-weight: 600; min-width: 110px;">
          <span id="plan-w${i}-tv-val">${tvVal === '-' ? '-' : tvVal + '%'}</span>
        </td>

        <!-- Production: Obj. + R√©el + Cumul Obj. + Cumul + Tendance + % -->
        <td class="plan-td plan-td-prev" style="background: rgba(45, 212, 191, 0.08); min-width: 110px;">
          <span id="plan-w${i}-prod-vise">${Math.round(prodViseVal).toLocaleString('fr-CA') + ' $'}</span>
        </td>
        <td class="plan-td" style="background: rgba(45, 212, 191, 0.03); min-width: 140px;">
          <input type="text" id="plan-w${i}-prod-reel" value="0 $" class="plan-input" readonly oninput="calculatePlan()">
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(45, 212, 191, 0.08); min-width: 110px;">
          <span id="plan-w${i}-prod-cumul-obj">0 $</span>
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(45, 212, 191, 0.03); min-width: 110px;">
          <span id="plan-w${i}-prod-cumul">0 $</span>
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(45, 212, 191, 0.03); min-width: 110px;">
          <span id="plan-w${i}-prod-tendance">0 $</span>
        </td>
        <td class="plan-td plan-td-prev" style="background: rgba(45, 212, 191, 0.08); min-width: 110px;">
          <span id="plan-w${i}-prod-pct" data-prod-pct="${prodPct}">${prodPct > 0 ? prodPct + '%' : '0%'}</span>
        </td>
      </tr>
    `;
  }

  tbody.innerHTML = html;

  // NE PAS sauvegarder automatiquement ici!
  // Cela √©craserait les modifications manuelles (obj_modifier) √† chaque g√©n√©ration
  // La sauvegarde est faite uniquement quand l'Objectif CA change (dans reloadPlanWithAnimation)

  // Stocker les patterns pour usage ult√©rieur si besoin
  window.planWeeklyTargets = {
    mktg: mktgPattern,
    estim: estimPattern,
    contrat: contratPattern,
    dollar: dollarPattern,
    prod: prodPattern
  };

  // Calculer imm√©diatement apr√®s g√©n√©ration
  setTimeout(() => calculatePlan(), 100);

  // G√©n√©rer aussi la version mobile
  generatePlanMobile();

  // Rafra√Æchir les tableaux RPO hebdomadaires si affich√©s
  if (typeof refreshWeeklyTables === 'function') {
    refreshWeeklyTables();
  }
}

// G√©n√©rer la version mobile (cartes) du plan d'affaire
function generatePlanMobile() {
  const container = document.getElementById('plan-mobile-container');
  if (!container) return;

  const startDate = createTorontoDate(2026, 0, 5); // 5 janvier 2026 (lundi)
  const weeks = 52;

  // R√©cup√©rer les m√™mes param√®tres
  const objectif = parseFloat(document.getElementById('plan-objectif')?.dataset.value) || 0;
  const contratMoyen = parseFloat(document.getElementById('plan-cm-prev')?.dataset.value) || 2500;
  const ratioMktg = parseFloat(document.getElementById('plan-ratio-mktg')?.dataset.value) || 85;
  const tauxVente = parseFloat(document.getElementById('plan-taux-vente')?.dataset.value) || 30;

  // M√™mes patterns que desktop
  const percentagePattern = [
    0, 0, 0, 0,
    -1, -1, -1, -1, -1, -1, -1, -1, -1,
    0,
    0.5, 2.0, 2.0,
    2.5, 2.5, 3.0, 3.0,
    3.0, 3.5, 3.5, 5.5,
    3.0, 6.5, 5.5, 6.0, 6.0,
    4.5, 4.5, 4.5, 4.5,
    3.0, 3.0, 3.0, 3.0,
    3.0, 3.0, 3.0, 2.0, 1.0,
    1.0, 1.0, 1.0, 1.0,
    0, 0, 0, 0, 0
  ];

  const productionIntensity = [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    1, 4, 5, 5,
    5, 6, 7, 7, 7,
    7, 7, 7, 7,
    6, 5, 5, 4, 3.6,
    0.1, 0.1, 0.1, 0.1
  ];

  const intensityPattern = percentagePattern;
  const totalIntensity = intensityPattern.reduce((sum, val) => sum + (val > 0 ? val : 0), 0);

  // Calculer les patterns
  const mktgPattern = [];
  const estimPattern = [];
  const contratPattern = [];
  const dollarPattern = [];
  const prodPattern = [];

  for (let i = 0; i < weeks; i++) {
    const intensity = intensityPattern[i];

    if (intensity <= 0) {
      mktgPattern.push(0);
      estimPattern.push(0);
      contratPattern.push(0);
      dollarPattern.push(0);
    } else {
      const dollarSemaine = (objectif * 1.10) * (intensity / totalIntensity);
      dollarPattern.push(Math.round(dollarSemaine));

      const contratSemaine = Math.ceil(dollarSemaine / contratMoyen);
      contratPattern.push(contratSemaine);

      const estimSemaine = Math.ceil(contratSemaine / (tauxVente / 100));
      estimPattern.push(estimSemaine);

      const mktgSemaine = estimSemaine * (ratioMktg / 100);
      mktgPattern.push(mktgSemaine);
    }

    const prodIntensity = productionIntensity[i];
    if (prodIntensity > 0) {
      const prodSemaine = (objectif * 1.10) * (prodIntensity / 100);
      prodPattern.push(Math.round(prodSemaine));
    } else {
      prodPattern.push(0);
    }
  }

  // Ajuster les totaux
  const totalDollarCalcule = dollarPattern.reduce((sum, val) => sum + val, 0);
  const diffDollar = (objectif * 1.10) - totalDollarCalcule;
  if (diffDollar !== 0) {
    for (let i = dollarPattern.length - 1; i >= 0; i--) {
      if (dollarPattern[i] > 0) {
        dollarPattern[i] += diffDollar;
        break;
      }
    }
  }

  const totalProdCalcule = prodPattern.reduce((sum, val) => sum + val, 0);
  const diffProd = (objectif * 1.10) - totalProdCalcule;
  if (diffProd !== 0) {
    for (let i = prodPattern.length - 1; i >= 0; i--) {
      if (prodPattern[i] > 0) {
        prodPattern[i] += diffProd;
        break;
      }
    }
  }

  let html = '';

  // G√©n√©rer les cartes pour chaque semaine
  for (let i = 1; i <= weeks; i++) {
    const weekStartDate = new Date(startDate.getTime() + ((i - 1) * 7 * 24 * 60 * 60 * 1000));
    const weekEndDate = new Date(weekStartDate.getTime() + (6 * 24 * 60 * 60 * 1000));

    // Skip hidden weeks
    if (intensityPattern[i - 1] === -1) {
      continue;
    }

    const startDay = weekStartDate.getDate();
    const endDay = weekEndDate.getDate();
    const startMonth = weekStartDate.toLocaleDateString('fr-FR', { month: 'short' });
    const endMonth = weekEndDate.toLocaleDateString('fr-FR', { month: 'short' });
    const startYear = weekStartDate.getFullYear();

    let dateRangeStr;
    if (startYear === 2025) {
      if (startMonth === endMonth) {
        dateRangeStr = `${startDay} - ${endDay} ${startMonth.replace('.', '')} 2025`;
      } else {
        dateRangeStr = `${startDay} ${startMonth.replace('.', '')} - ${endDay} ${endMonth.replace('.', '')} 2025`;
      }
    } else {
      if (startMonth === endMonth) {
        dateRangeStr = `${startDay} - ${endDay} ${startMonth}`;
      } else {
        dateRangeStr = `${startDay} ${startMonth} - ${endDay} ${endMonth}`;
      }
    }

    const mktgVal = mktgPattern[i - 1] || 0;
    const estimVal = estimPattern[i - 1] || 0;
    const contratVal = contratPattern[i - 1] || 0;
    const dollarVal = dollarPattern[i - 1] || 0;
    const prodViseVal = prodPattern[i - 1] || 0;
    const pctSem = intensityPattern[i - 1] || 0;

    let tvVal = '-';
    if (i >= 15) {
      tvVal = 25;
      if (i >= 21) tvVal = 30;
      if (i >= 33) tvVal = 35;
    }

    const monthNum = weekStartDate.getMonth() + 1;
    const yearNum = weekStartDate.getFullYear();

    html += `
      <div class="plan-mobile-card" data-month="${monthNum}" data-year="${yearNum}" data-week="${i}">
        <!-- En-t√™te: Semaine + dates -->
        <div class="plan-mobile-card-header">
          <h4>Semaine ${i}</h4>
          <p>${dateRangeStr}</p>
        </div>

        <!-- Section H. Marketing -->
        <div class="plan-mobile-section" style="background: linear-gradient(135deg, rgba(96, 165, 250, 0.15), rgba(96, 165, 250, 0.05)); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
          <div class="plan-mobile-section-title" style="color: #60a5fa;">
            <i class="fas fa-bullhorn"></i>
            <span>H. Marketing</span>
          </div>
          <div class="plan-mobile-grid">
            <div class="plan-mobile-item">
              <div class="plan-mobile-item-label">Objectif</div>
              <div class="plan-mobile-item-value">${mktgVal.toFixed(1)} h</div>
            </div>
            <div class="plan-mobile-item">
              <div class="plan-mobile-item-label">R√©el</div>
              <div class="plan-mobile-item-value">
                <input type="text" id="plan-w${i}-mktg-reel-mobile" value="-" readonly class="plan-input plan-mobile-input">
              </div>
            </div>
            <div class="plan-mobile-item plan-mobile-item-full">
              <div class="plan-mobile-item-label">Cumul</div>
              <div class="plan-mobile-item-value" id="plan-w${i}-mktg-cumul-mobile">-</div>
            </div>
          </div>
        </div>

        <!-- Section Estimations -->
        <div class="plan-mobile-section" style="background: linear-gradient(135deg, rgba(52, 211, 153, 0.15), rgba(52, 211, 153, 0.05)); border: 1px solid rgba(52, 211, 153, 0.3); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
          <div class="plan-mobile-section-title" style="color: #34d399;">
            <i class="fas fa-file-alt"></i>
            <span>Estimations</span>
          </div>
          <div class="plan-mobile-grid">
            <div class="plan-mobile-item">
              <div class="plan-mobile-item-label">Objectif</div>
              <div class="plan-mobile-item-value">${estimVal}</div>
            </div>
            <div class="plan-mobile-item">
              <div class="plan-mobile-item-label">R√©el</div>
              <div class="plan-mobile-item-value">
                <input type="text" id="plan-w${i}-estim-reel-mobile" value="0" readonly class="plan-input plan-mobile-input">
              </div>
            </div>
            <div class="plan-mobile-item">
              <div class="plan-mobile-item-label">Cumul</div>
              <div class="plan-mobile-item-value" id="plan-w${i}-estim-cumul-mobile">0</div>
            </div>
            <div class="plan-mobile-item">
              <div class="plan-mobile-item-label">Ratio</div>
              <div class="plan-mobile-item-value" id="plan-w${i}-ratio-mobile">0.00</div>
            </div>
          </div>
        </div>

        <!-- Section Contrats -->
        <div class="plan-mobile-section" style="background: linear-gradient(135deg, rgba(251, 146, 60, 0.15), rgba(251, 146, 60, 0.05)); border: 1px solid rgba(251, 146, 60, 0.3); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
          <div class="plan-mobile-section-title" style="color: #fb923c;">
            <i class="fas fa-handshake"></i>
            <span>Contrats</span>
          </div>
          <div class="plan-mobile-grid">
            <div class="plan-mobile-item">
              <div class="plan-mobile-item-label">Objectif</div>
              <div class="plan-mobile-item-value">${contratVal}</div>
            </div>
            <div class="plan-mobile-item">
              <div class="plan-mobile-item-label">R√©el</div>
              <div class="plan-mobile-item-value">
                <input type="text" id="plan-w${i}-contrat-reel-mobile" value="0" readonly class="plan-input plan-mobile-input">
              </div>
            </div>
            <div class="plan-mobile-item plan-mobile-item-full">
              <div class="plan-mobile-item-label">Cumul</div>
              <div class="plan-mobile-item-value" id="plan-w${i}-contrat-cumul-mobile">0</div>
            </div>
          </div>
        </div>

        <!-- Section $ Sign√©s -->
        <div class="plan-mobile-section" style="background: linear-gradient(135deg, rgba(244, 114, 182, 0.15), rgba(244, 114, 182, 0.05)); border: 1px solid rgba(244, 114, 182, 0.3); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
          <div class="plan-mobile-section-title" style="color: #f472b6;">
            <i class="fas fa-dollar-sign"></i>
            <span>$ Sign√©s</span>
          </div>
          <div class="plan-mobile-grid">
            <div class="plan-mobile-item">
              <div class="plan-mobile-item-label">Objectif</div>
              <div class="plan-mobile-item-value">${dollarVal.toLocaleString()} $</div>
            </div>
            <div class="plan-mobile-item">
              <div class="plan-mobile-item-label">R√©el</div>
              <div class="plan-mobile-item-value">
                <input type="text" id="plan-w${i}-dollar-reel-mobile" value="0 $" readonly class="plan-input plan-mobile-input">
              </div>
            </div>
            <div class="plan-mobile-item plan-mobile-item-full">
              <div class="plan-mobile-item-label">Cumul</div>
              <div class="plan-mobile-item-value" id="plan-w${i}-dollar-cumul-mobile">0 $</div>
            </div>
          </div>
        </div>

        <!-- Section % Objectif -->
        <div class="plan-mobile-section" style="background: linear-gradient(135deg, rgba(167, 139, 250, 0.25), rgba(167, 139, 250, 0.15)); border: 1px solid rgba(167, 139, 250, 0.4); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
          <div class="plan-mobile-section-title" style="color: #a78bfa;">
            <i class="fas fa-bullseye"></i>
            <span>% Objectif</span>
          </div>
          <div class="plan-mobile-grid">
            <div class="plan-mobile-item">
              <div class="plan-mobile-item-label">Sem.</div>
              <div class="plan-mobile-item-value" id="plan-w${i}-pct-sem-mobile">${pctSem}%</div>
            </div>
            <div class="plan-mobile-item">
              <div class="plan-mobile-item-label">Cumul</div>
              <div class="plan-mobile-item-value" id="plan-w${i}-pct-cumul-mobile">0%</div>
            </div>
            <div class="plan-mobile-item plan-mobile-item-full">
              <div class="plan-mobile-item-label">TV %</div>
              <div class="plan-mobile-item-value" id="plan-w${i}-tv-mobile">${tvVal}${tvVal !== '-' ? '%' : ''}</div>
            </div>
          </div>
        </div>

        <!-- Section Production -->
        <div class="plan-mobile-section" style="background: linear-gradient(135deg, rgba(45, 212, 191, 0.15), rgba(45, 212, 191, 0.05)); border: 1px solid rgba(45, 212, 191, 0.3); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
          <div class="plan-mobile-section-title" style="color: #2dd4bf;">
            <i class="fas fa-cogs"></i>
            <span>Production</span>
          </div>
          <div class="plan-mobile-grid">
            <div class="plan-mobile-item">
              <div class="plan-mobile-item-label">Obj.</div>
              <div class="plan-mobile-item-value">${prodViseVal.toLocaleString()} $</div>
            </div>
            <div class="plan-mobile-item">
              <div class="plan-mobile-item-label">R√©el</div>
              <div class="plan-mobile-item-value">
                <input type="text" id="plan-w${i}-prod-reel-mobile" value="0 $" readonly class="plan-input plan-mobile-input">
              </div>
            </div>
            <div class="plan-mobile-item plan-mobile-item-full">
              <div class="plan-mobile-item-label">%</div>
              <div class="plan-mobile-item-value" id="plan-w${i}-prod-pct-mobile">0%</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Ajouter la carte TOTAL √† la fin
  html += `
    <div class="plan-mobile-card plan-mobile-total-card">
      <div class="plan-mobile-card-header">
        <h4>R√©sum√© annuel</h4>
      </div>

      <div class="plan-mobile-section">
        <!-- En-t√™tes des colonnes -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem; padding: 0.5rem; background: rgba(30, 41, 59, 0.4); border-radius: 8px;">
          <div style="text-align: center; font-size: 0.75rem; font-weight: 700; color: #60a5fa; text-transform: uppercase; letter-spacing: 0.05em;">Pr√©vision</div>
          <div style="text-align: center; font-size: 0.75rem; font-weight: 700; color: #34d399; text-transform: uppercase; letter-spacing: 0.05em;">R√©el</div>
        </div>

        <!-- H. Marketing -->
        <div style="margin-bottom: 0.75rem;">
          <div style="font-size: 0.7rem; color: var(--text-gray); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em;">H. Marketing</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
            <div style="text-align: center; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; font-weight: 600; color: var(--text-light);" id="total-mktg-prev-mobile">0 h</div>
            <div style="text-align: center; padding: 0.5rem; background: rgba(52, 211, 153, 0.1); border-radius: 6px; font-weight: 600; color: var(--text-light);" id="total-mktg-reel-mobile">0 h</div>
          </div>
        </div>

        <!-- Estimations -->
        <div style="margin-bottom: 0.75rem;">
          <div style="font-size: 0.7rem; color: var(--text-gray); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em;">Estimations</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
            <div style="text-align: center; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; font-weight: 600; color: var(--text-light);" id="total-estim-prev-mobile">0</div>
            <div style="text-align: center; padding: 0.5rem; background: rgba(52, 211, 153, 0.1); border-radius: 6px; font-weight: 600; color: var(--text-light);" id="total-estim-reel-mobile">0</div>
          </div>
        </div>

        <!-- Contrats -->
        <div style="margin-bottom: 0.75rem;">
          <div style="font-size: 0.7rem; color: var(--text-gray); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em;">Contrats</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
            <div style="text-align: center; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; font-weight: 600; color: var(--text-light);" id="total-contrat-prev-mobile">0</div>
            <div style="text-align: center; padding: 0.5rem; background: rgba(52, 211, 153, 0.1); border-radius: 6px; font-weight: 600; color: var(--text-light);" id="total-contrat-reel-mobile">0</div>
          </div>
        </div>

        <!-- $ Sign√©s -->
        <div style="margin-bottom: 0.75rem;">
          <div style="font-size: 0.7rem; color: var(--text-gray); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em;">$ Sign√©s</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
            <div style="text-align: center; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; font-weight: 600; color: var(--text-light);" id="total-dollar-prev-mobile">0 $</div>
            <div style="text-align: center; padding: 0.5rem; background: rgba(52, 211, 153, 0.1); border-radius: 6px; font-weight: 600; color: var(--text-light);" id="total-dollar-reel-mobile">0 $</div>
          </div>
        </div>

        <!-- Production -->
        <div style="margin-bottom: 0.75rem;">
          <div style="font-size: 0.7rem; color: var(--text-gray); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em;">Production</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
            <div style="text-align: center; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 6px; font-weight: 600; color: var(--text-light);" id="total-prod-prev-mobile">0 $</div>
            <div style="text-align: center; padding: 0.5rem; background: rgba(52, 211, 153, 0.1); border-radius: 6px; font-weight: 600; color: var(--text-light);" id="total-prod-reel-mobile">0 $</div>
          </div>
        </div>
      </div>
    </div>
  `;

  container.innerHTML = html;

  // Calculer et afficher les totaux Pr√©v dans le r√©sum√© annuel
  const totalMktgPrev = mktgPattern.reduce((sum, val) => sum + val, 0);
  const totalEstimPrev = estimPattern.reduce((sum, val) => sum + val, 0);
  const totalContratPrev = contratPattern.reduce((sum, val) => sum + val, 0);
  const totalDollarPrev = dollarPattern.reduce((sum, val) => sum + val, 0);
  const totalProdPrev = prodPattern.reduce((sum, val) => sum + val, 0);

  // Mettre √† jour les √©l√©ments du r√©sum√© annuel avec les totaux Pr√©v
  const totalMktgPrevEl = document.getElementById('total-mktg-prev-mobile');
  const totalEstimPrevEl = document.getElementById('total-estim-prev-mobile');
  const totalContratPrevEl = document.getElementById('total-contrat-prev-mobile');
  const totalDollarPrevEl = document.getElementById('total-dollar-prev-mobile');
  const totalProdPrevEl = document.getElementById('total-prod-prev-mobile');

  if (totalMktgPrevEl) totalMktgPrevEl.textContent = totalMktgPrev.toFixed(1) + ' h';
  if (totalEstimPrevEl) totalEstimPrevEl.textContent = totalEstimPrev;
  if (totalContratPrevEl) totalContratPrevEl.textContent = totalContratPrev;
  if (totalDollarPrevEl) totalDollarPrevEl.textContent = totalDollarPrev.toLocaleString() + ' $';
  if (totalProdPrevEl) totalProdPrevEl.textContent = totalProdPrev.toLocaleString() + ' $';

  // Initialiser les dropdowns mobiles apr√®s g√©n√©ration
  setTimeout(() => {
    initPlanMobileDropdowns();
  }, 150);
}

// Initialiser les dropdowns Mois + Semaine pour le plan mobile
function initPlanMobileDropdowns() {
  const monthSelector = document.getElementById('planMonthSelector');
  const weekSelector = document.getElementById('planWeekSelector');

  if (!monthSelector || !weekSelector) return;

  // Map des donn√©es de semaines par mois (format: year-month)
  const weeksByMonth = {};
  const allCards = document.querySelectorAll('.plan-mobile-card:not(.plan-mobile-total-card)');

  allCards.forEach((card) => {
    const month = card.getAttribute('data-month');
    const year = card.getAttribute('data-year');
    const weekNumber = parseInt(card.getAttribute('data-week'));
    const key = `${year}-${month}`;

    if (!weeksByMonth[key]) {
      weeksByMonth[key] = [];
    }

    // Extraire le texte de date depuis le header de la carte
    const dateText = card.querySelector('.plan-mobile-card-header p')?.textContent || '';

    weeksByMonth[key].push({
      weekNumber,
      dateText,
      card
    });
  });

  // Stocker weeksByMonth globalement pour l'utiliser dans les handlers
  window.planWeeksByMonth = weeksByMonth;

  // === Initialiser le dropdown MOIS manuellement ===
  const monthButton = monthSelector.querySelector('.custom-select-button');

  // Retirer les anciens listeners si pr√©sents
  const newMonthButton = monthButton.cloneNode(true);
  monthButton.parentNode.replaceChild(newMonthButton, monthButton);

  newMonthButton.addEventListener('click', (e) => {
    e.stopPropagation();
    // Fermer les autres dropdowns
    document.querySelectorAll('.custom-select').forEach(s => {
      if (s !== monthSelector) s.classList.remove('open');
    });
    monthSelector.classList.toggle('open');
    log('[Plan Mobile] Dropdown mois clicked, open:', monthSelector.classList.contains('open'));
  });

  // G√©rer les options du mois
  const monthOptions = monthSelector.querySelectorAll('.custom-select-option');
  monthOptions.forEach(option => {
    option.addEventListener('click', (e) => {
      e.stopPropagation();

      const selectedMonth = option.getAttribute('data-value');
      monthSelector.querySelector('.custom-select-text').textContent = option.textContent;
      monthSelector.classList.remove('open');

      log('[Plan Mobile] Mois s√©lectionn√©:', selectedMonth);
      updatePlanWeekDropdown(selectedMonth, window.planWeeksByMonth);
    });
  });

  // === Initialiser le dropdown SEMAINE ===
  const weekButton = weekSelector.querySelector('.custom-select-button');

  // Retirer les anciens listeners si pr√©sents
  const newWeekButton = weekButton.cloneNode(true);
  weekButton.parentNode.replaceChild(newWeekButton, weekButton);

  newWeekButton.addEventListener('click', (e) => {
    e.stopPropagation();
    // Fermer les autres dropdowns
    document.querySelectorAll('.custom-select').forEach(s => {
      if (s !== weekSelector) s.classList.remove('open');
    });
    weekSelector.classList.toggle('open');
    log('[Plan Mobile] Dropdown semaine clicked, open:', weekSelector.classList.contains('open'));
  });

  // Fermer les dropdowns en cliquant ailleurs
  document.addEventListener('click', () => {
    monthSelector.classList.remove('open');
    weekSelector.classList.remove('open');
  });

  // Initialiser avec le premier mois disponible (D√©cembre 2025)
  const firstMonth = monthOptions[0].getAttribute('data-value');
  monthSelector.querySelector('.custom-select-text').textContent = monthOptions[0].textContent;
  updatePlanWeekDropdown(firstMonth, weeksByMonth);

  log('[Plan Mobile] Dropdowns initialis√©s - Mois:', firstMonth);
}

// Mettre √† jour le dropdown semaine en fonction du mois s√©lectionn√©
function updatePlanWeekDropdown(selectedMonth, weeksByMonth) {
  const weekDropdown = document.getElementById('planWeekSelectorDropdown');
  const weekSelector = document.getElementById('planWeekSelector');

  if (!weekDropdown || !weekSelector) return;

  const weeks = weeksByMonth[selectedMonth] || [];

  // Vider le dropdown
  weekDropdown.innerHTML = '';

  let firstWeekLabel = null;

  // Cr√©er les options avec event listeners
  weeks.forEach((week, index) => {
    const weekLabel = week.dateText;

    // Garder le label de la premi√®re semaine
    if (index === 0) {
      firstWeekLabel = weekLabel;
    }

    const option = document.createElement('div');
    option.className = 'custom-select-option';
    if (index === 0) {
      option.classList.add('selected');
    }
    option.dataset.week = week.weekNumber;
    option.textContent = weekLabel;

    // Event listener pour cette option
    option.addEventListener('click', (e) => {
      e.stopPropagation();

      // Mettre √† jour la s√©lection
      weekDropdown.querySelectorAll('.custom-select-option').forEach(opt => opt.classList.remove('selected'));
      option.classList.add('selected');

      // Update button text
      const text = weekSelector.querySelector('.custom-select-text');
      if (text) text.textContent = weekLabel;

      // Close dropdown
      weekSelector.classList.remove('open');

      log('[Plan Mobile] Semaine s√©lectionn√©e:', week.weekNumber);
      // Afficher uniquement cette semaine
      showOnlySelectedWeek(week.weekNumber);
    });

    weekDropdown.appendChild(option);
  });

  // Mettre √† jour le texte du bouton avec la premi√®re semaine
  if (firstWeekLabel) {
    const text = weekSelector.querySelector('.custom-select-text');
    if (text) {
      text.textContent = firstWeekLabel;
    }
  }

  // Afficher la premi√®re semaine par d√©faut
  if (weeks.length > 0) {
    showOnlySelectedWeek(weeks[0].weekNumber);
  }
}

// Afficher uniquement la semaine s√©lectionn√©e
function showOnlySelectedWeek(weekNumber) {
  const allCards = document.querySelectorAll('.plan-mobile-card:not(.plan-mobile-total-card)');

  allCards.forEach((card) => {
    const cardWeekNumber = parseInt(card.getAttribute('data-week'));

    if (cardWeekNumber === weekNumber) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
}

// Filtrer le plan par p√©riode (mois)
function filterPlanByPeriod(selectedValue) {
  // Filtrer les lignes du tableau desktop
  const allRows = document.querySelectorAll('#plan-weeks-body tr.plan-row');

  allRows.forEach(row => {
    if (selectedValue === 'all') {
      row.style.display = '';
    } else {
      const rowMonth = row.getAttribute('data-month');
      const rowYear = row.getAttribute('data-year');

      // Parse selectedValue (format: "2025-10" or "2026-1")
      const [selectedYear, selectedMonth] = selectedValue.split('-');

      // Compare year and month
      if (rowMonth === selectedMonth && rowYear === selectedYear) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    }
  });

  // Filtrer les cartes mobiles
  const allCards = document.querySelectorAll('.plan-mobile-card:not(.plan-mobile-total-card)');

  allCards.forEach(card => {
    if (selectedValue === 'all') {
      card.style.display = '';
    } else {
      const cardMonth = card.getAttribute('data-month');
      const cardYear = card.getAttribute('data-year');

      // Parse selectedValue (format: "2025-10" or "2026-1")
      const [selectedYear, selectedMonth] = selectedValue.split('-');

      // Compare year and month
      if (cardMonth === selectedMonth && cardYear === selectedYear) {
        card.style.display = '';
      } else {
        card.style.display = 'none';
      }
    }
  });

  // Recalculer les totaux en fonction des lignes visibles
  calculatePlan();
}

// Toggle edit mode pour le plan
function toggleEditPlan() {
  const editBtn = document.getElementById('editPlanBtn');
  const saveBtn = document.getElementById('savePlanBtn');

  // Inputs modifiables: SEULEMENT CM Pr√©vision, Ratio Marketing, Taux de vente
  // (plan-objectif reste readonly, plan-taux-horaire est cach√©)
  const headerInputs = [
    document.getElementById('plan-cm-prev'),
    document.getElementById('plan-ratio-mktg'),
    document.getElementById('plan-taux-vente')
  ].filter(input => input !== null);

  const isReadonly = headerInputs.length > 0 ? headerInputs[0].hasAttribute('readonly') : true;

  // Toggle UNIQUEMENT les 3 inputs de pr√©vision (pas le tableau en bas)
  headerInputs.forEach(input => {
    if (isReadonly) {
      input.removeAttribute('readonly');
      input.style.background = 'rgba(96, 165, 250, 0.1)';
      input.style.borderBottom = '2px solid var(--primary-blue)';
      input.style.padding = '4px 8px';
      input.style.borderRadius = '4px';
    } else {
      input.setAttribute('readonly', true);
      input.style.background = 'transparent';
      input.style.borderBottom = 'none';
      input.style.padding = '0';
      input.style.borderRadius = '0';
    }
  });

  // Toggle buttons
  if (isReadonly) {
    editBtn.classList.add('hidden');
    saveBtn.classList.remove('hidden');
  } else {
    editBtn.classList.remove('hidden');
    saveBtn.classList.add('hidden');
  }
}

// Mettre √† jour la visibilit√© des labels "(par d√©faut)"
function updatePlanDefaultLabels() {
  const DEFAULT_VALUES = {
    'plan-cm-prev': 2500,
    'plan-ratio-mktg': 85,
    'plan-taux-vente': 30
  };

  const LABELS = {
    'plan-cm-prev': 'cm-prev-default-label',
    'plan-ratio-mktg': 'ratio-mktg-default-label',
    'plan-taux-vente': 'taux-vente-default-label'
  };

  Object.keys(DEFAULT_VALUES).forEach(inputId => {
    const input = document.getElementById(inputId);
    const label = document.getElementById(LABELS[inputId]);

    if (input && label) {
      const currentValue = parseFloat(input.dataset.value) || 0;
      const defaultValue = DEFAULT_VALUES[inputId];

      // Afficher "(par d√©faut)" seulement si la valeur = valeur par d√©faut
      if (currentValue === defaultValue) {
        label.style.display = 'inline';
      } else {
        label.style.display = 'none';
      }
    }
  });
}

// Sauvegarder et calculer
async function savePlan() {
  const saveBtn = document.getElementById('savePlanBtn');
  const originalHTML = saveBtn.innerHTML;

  // Afficher le spinner
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i><span class="text-xs font-semibold">Enregistrement...</span>';
  saveBtn.disabled = true;
  saveBtn.style.cursor = 'not-allowed';
  saveBtn.style.opacity = '0.7';

  try {
    // Formater les inputs header et mettre √† jour dataset.value
    formatMetricInput('plan-objectif', '$');
    formatMetricInput('plan-cm-prev', '$');
    formatMetricInput('plan-taux-horaire', '$');
    formatRatioMktgInput('plan-ratio-mktg');
    formatMetricInput('plan-taux-vente', '%');

    // Sauvegarder les donn√©es annuelles (incluant cm_prevision, ratio_mktg, taux_vente)
    await saveAnnualData();

    // R√©g√©n√©rer le plan d'affaire avec animation
    await reloadPlanWithAnimation();

    // Les donn√©es R√âEL ne doivent JAMAIS √™tre sauvegard√©es!
    // Elles sont toujours en lecture seule et charg√©es depuis RPO hebdo

    toggleEditPlan();

    // Recharger les donn√©es R√âEL depuis RPO hebdo pour s'assurer qu'elles sont correctes
    await loadRPODataIntoPlan();

    calculatePlan();

    // Mettre √† jour les labels "(par d√©faut)"
    updatePlanDefaultLabels();
  } finally {
    // Restaurer le bouton
    saveBtn.innerHTML = originalHTML;
    saveBtn.disabled = false;
    saveBtn.style.cursor = '';
    saveBtn.style.opacity = '';
  }
}

// Calculer tous les cumuls et pourcentages
function calculatePlan() {
  const weeks = 52; // Doit correspondre √† generatePlanWeeks()
  const tauxHoraire = parseFloat(document.getElementById('plan-taux-horaire').dataset.value) || 43;
  const objectif = parseFloat(document.getElementById('plan-objectif').dataset.value) || 0;

  let cumulMktg = 0;
  let cumulEstim = 0;
  let cumulContrat = 0;
  let cumulDollar = 0;
  let cumulDollarPrev = 0;  // Cumulatif des dollars pr√©vus pour le % Objectif
  let cumulPctPattern = 0;  // Cumul des pourcentages directs du pattern

  // Cumuls objectifs progressifs (√† partir de la semaine 2)
  let cumulMktgObj = 0;
  let cumulEstimObj = 0;
  let cumulContratObj = 0;
  let cumulDollarObj = 0;
  let cumulProdObj = 0;

  // Totaux pour toutes les semaines
  let totalMktgPrev = 0;
  let totalMktgReel = 0;
  let totalMktgCumul = 0; // Somme de tous les cumuls MKTG affich√©s
  let totalEstimPrev = 0;
  let totalEstimReel = 0;
  let totalEstimCumul = 0; // Somme de tous les cumuls ESTIM affich√©s
  let totalContratPrev = 0;
  let totalContratReel = 0;
  let totalContratCumul = 0; // Somme de tous les cumuls CONTRAT affich√©s
  let totalDollarPrev = 0;
  let totalDollarReel = 0;
  let totalDollarCumul = 0; // Somme de tous les cumuls DOLLAR affich√©s
  let totalProdVise = 0;
  let totalProdReel = 0;
  let totalPctSem = 0; // Total des % hebdomadaires

  // Cumuls progressifs pour les calculs de tendance
  let cumulProd = 0; // Cumul de production pour tendance
  let totalProdPctDistribution = 0; // Total des % de distribution de production
  let totalTV = 0; // Somme des TV%
  let countTV = 0; // Nombre de semaines avec TV

  for (let i = 1; i <= weeks; i++) {
    // V√©rifier si la ligne est visible (pas filtr√©e)
    const row = document.querySelector(`#plan-w${i}-mktg-reel`)?.closest('tr');
    if (!row || row.style.display === 'none') {
      continue; // Ignorer les lignes cach√©es
    }

    // R√©cup√©rer les valeurs R√âELLES de la semaine
    const mktgReel = parseFloat(document.getElementById(`plan-w${i}-mktg-reel`)?.value) || 0;
    const estimReel = parseFloat(document.getElementById(`plan-w${i}-estim-reel`)?.value) || 0;
    const contratReel = parseFloat(document.getElementById(`plan-w${i}-contrat-reel`)?.value) || 0;
    const dollarReelText = document.getElementById(`plan-w${i}-dollar-reel`)?.value.replace(/[^\d]/g, '') || '0';
    const dollarReel = parseFloat(dollarReelText) || 0;
    const prodReelText = document.getElementById(`plan-w${i}-prod-reel`)?.value.replace(/[^\d]/g, '') || '0';
    const prodReel = parseFloat(prodReelText) || 0;

    // R√©cup√©rer les valeurs PR√âVUES (depuis les cellules du tableau)
    let mktgPrev = 0;
    let estimPrev = 0;
    let contratPrev = 0;
    let dollarPrev = 0;
    let prodPrev = 0;

    if (row) {
      const cells = row.querySelectorAll('td');
      // Structure des colonnes (avec Cumul Obj):
      // 0: Semaine
      // 1: Mktg Obj, 2: Mktg R√©el, 3: Mktg Cumul Obj, 4: Mktg Cumul, 5: Mktg Tendance
      // 6: Estim Obj, 7: Estim R√©el, 8: Estim Cumul Obj, 9: Estim Cumul, 10: Estim Tendance, 11: Ratio
      // 12: Contrat Obj, 13: Contrat R√©el, 14: Contrat Cumul Obj, 15: Contrat Cumul, 16: Contrat Tendance
      // 17: Dollar Obj, 18: Dollar R√©el, 19: Dollar Cumul Obj, 20: Dollar Cumul, 21: Dollar Tendance
      // 22: Pct Sem, 23: Pct Cumul, 24: TV
      // 25: Prod Obj, 26: Prod R√©el, 27: Prod Cumul Obj, 28: Prod Cumul, 29: Prod Tendance, 30: Prod %
      mktgPrev = parseFloat(cells[1]?.textContent) || 0;
      estimPrev = parseFloat(cells[6]?.textContent) || 0;
      contratPrev = parseFloat(cells[12]?.textContent) || 0;
      const dollarText = cells[17]?.textContent.replace(/[^\d]/g, '') || '0';
      dollarPrev = parseFloat(dollarText) || 0;
      const prodText = cells[25]?.textContent.replace(/[^\d]/g, '') || '0';
      prodPrev = parseFloat(prodText) || 0;
    }

    // Calculer cumuls (R√©el)
    cumulMktg += mktgReel;
    cumulEstim += estimReel;
    cumulContrat += contratReel;
    cumulDollar += dollarReel;
    cumulProd += prodReel;

    // Lire le % de la semaine depuis l'√©l√©ment (valeur fixe du pattern)
    const pctSemElem = document.getElementById(`plan-w${i}-pct-sem`);
    let pctSemVal = 0;
    if (pctSemElem) {
      const pctSemText = pctSemElem.textContent.replace('%', '');
      pctSemVal = parseFloat(pctSemText) || 0;
      totalPctSem += pctSemVal; // Accumuler pour le total
    }

    // Accumuler les pourcentages du pattern √† partir de la semaine 2 (12 janvier)
    if (i >= 2) {
      cumulDollarPrev += dollarPrev;
      cumulPctPattern += pctSemVal;

      // Accumuler les objectifs pour les colonnes "Cumul Obj."
      cumulMktgObj += mktgPrev;
      cumulEstimObj += estimPrev;
      cumulContratObj += contratPrev;
      cumulDollarObj += dollarPrev;
      cumulProdObj += prodPrev;
    }

    // Ajouter aux totaux
    totalMktgPrev += mktgPrev;
    totalMktgReel += mktgReel;
    totalEstimPrev += estimPrev;
    totalEstimReel += estimReel;
    totalContratPrev += contratPrev;
    totalContratReel += contratReel;
    totalDollarPrev += dollarPrev;
    totalDollarReel += dollarReel;

    // Ratio Marketing (Estimations R√©el / H. Marketing R√©el)
    const ratio = mktgReel > 0 ? (estimReel / mktgReel).toFixed(2) : '0.00';

    // % Objectif cumulatif bas√© sur les pourcentages directs du pattern (pas sur les dollars arrondis)
    // Semaine 1 (5-11 janv) vide, objectifs commencent semaine 2 (12 janv)
    let pctCumul;
    if (i < 1) {
      // Semaine 1: 0%
      pctCumul = "0.00";
    } else {
      // √Ä partir de la semaine 2: cumul normal du pattern
      pctCumul = cumulPctPattern.toFixed(2);
    }

    // Lire la production vis√©e depuis le span (d√©j√† calcul√©e lors de la g√©n√©ration)
    const prodViseElem = document.getElementById(`plan-w${i}-prod-vise`);
    let prodVise = 0;
    if (prodViseElem && prodViseElem.textContent !== '-') {
      const prodText = prodViseElem.textContent.replace(/[^\d]/g, '');
      prodVise = parseFloat(prodText) || 0;
    }
    totalProdVise += prodVise;
    totalProdReel += prodReel;

    // Lire le % de production de distribution depuis l'attribut data (valeur fixe d√©finie lors de la g√©n√©ration)
    const prodPctElem = document.getElementById(`plan-w${i}-prod-pct`);
    let prodPctDistribution = '0';
    if (prodPctElem && prodPctElem.dataset.prodPct) {
      const pctVal = parseFloat(prodPctElem.dataset.prodPct);
      prodPctDistribution = pctVal > 0 ? pctVal + '' : '0';
      totalProdPctDistribution += pctVal; // Accumuler le total des %
    }

    // Lire le TV% de la semaine
    const tvElem = document.getElementById(`plan-w${i}-tv-val`);
    if (tvElem) {
      const tvText = tvElem.textContent.replace('%', '');
      const tvVal = parseFloat(tvText) || 0;
      if (tvVal > 0) {
        totalTV += tvVal;
        countTV++;
      }
    }

    // Ajouter aux totaux des colonnes CUMUL
    totalMktgCumul += cumulMktg;
    totalEstimCumul += cumulEstim;
    totalContratCumul += cumulContrat;
    totalDollarCumul += cumulDollar;

    // Calculer les tendances: (Cumul / Cumul %) √ó 100
    // Seulement si cumul % > 0 pour √©viter division par z√©ro
    const cumulPercentValue = parseFloat(pctCumul) || 0;

    // Debug: afficher le cumul pour la semaine 8 (19 janvier)
    if (i === 8) {
      log(`[CUMUL SEMAINE ${i}] H. Marketing Cumul: ${cumulMktg.toFixed(1)} h | Cumul %: ${cumulPercentValue}%`);
    }

    let tendanceMktg = '-';
    let tendanceEstim = '-';
    let tendanceContrat = '-';
    let tendanceDollar = '-';

    if (cumulPercentValue > 0) {
      // H. Marketing tendance
      if (cumulMktg > 0) {
        const tendanceMktgVal = (cumulMktg / cumulPercentValue) * 100;
        tendanceMktg = tendanceMktgVal.toFixed(1) + ' h';
      }

      // Estimations tendance
      if (cumulEstim > 0) {
        const tendanceEstimVal = (cumulEstim / cumulPercentValue) * 100;
        tendanceEstim = Math.round(tendanceEstimVal).toString();
      }

      // Contrats tendance
      if (cumulContrat > 0) {
        const tendanceContratVal = (cumulContrat / cumulPercentValue) * 100;
        tendanceContrat = tendanceContratVal.toFixed(1);
      }

      // $ Sign√©s tendance
      if (cumulDollar > 0) {
        const tendanceDollarVal = (cumulDollar / cumulPercentValue) * 100;
        tendanceDollar = Math.round(tendanceDollarVal).toLocaleString('fr-CA') + ' $';
      }
    }

    // Mettre √† jour les affichages (avec v√©rifications)
    // H. Marketing - Cumul Obj. et Cumul
    const mktgCumulObjElem = document.getElementById(`plan-w${i}-mktg-cumul-obj`);
    if (mktgCumulObjElem) mktgCumulObjElem.textContent = i >= 2 ? parseFloat(cumulMktgObj.toFixed(1)) + ' h' : '-';

    const mktgCumulElem = document.getElementById(`plan-w${i}-mktg-cumul`);
    if (mktgCumulElem) mktgCumulElem.textContent = parseFloat(cumulMktg.toFixed(1)) + ' h';

    const mktgTendanceElem = document.getElementById(`plan-w${i}-mktg-tendance`);
    if (mktgTendanceElem) mktgTendanceElem.textContent = tendanceMktg;

    // Estimations - Cumul Obj. et Cumul
    const estimCumulObjElem = document.getElementById(`plan-w${i}-estim-cumul-obj`);
    if (estimCumulObjElem) estimCumulObjElem.textContent = i >= 2 ? Math.round(cumulEstimObj) : '0';

    const estimCumulElem = document.getElementById(`plan-w${i}-estim-cumul`);
    if (estimCumulElem) estimCumulElem.textContent = Math.round(cumulEstim);

    const estimTendanceElem = document.getElementById(`plan-w${i}-estim-tendance`);
    if (estimTendanceElem) estimTendanceElem.textContent = tendanceEstim;

    const ratioElem = document.getElementById(`plan-w${i}-ratio`);
    if (ratioElem) ratioElem.textContent = ratio;

    // Contrats - Cumul Obj. et Cumul
    const contratCumulObjElem = document.getElementById(`plan-w${i}-contrat-cumul-obj`);
    if (contratCumulObjElem) contratCumulObjElem.textContent = i >= 2 ? parseFloat(cumulContratObj.toFixed(1)) : '0';

    const contratCumulElem = document.getElementById(`plan-w${i}-contrat-cumul`);
    if (contratCumulElem) contratCumulElem.textContent = parseFloat(cumulContrat.toFixed(1));

    const contratTendanceElem = document.getElementById(`plan-w${i}-contrat-tendance`);
    if (contratTendanceElem) contratTendanceElem.textContent = tendanceContrat;

    // $ Sign√©s - Cumul Obj. et Cumul
    const dollarCumulObjElem = document.getElementById(`plan-w${i}-dollar-cumul-obj`);
    if (dollarCumulObjElem) dollarCumulObjElem.textContent = i >= 2 ? Math.round(cumulDollarObj).toLocaleString('fr-CA') + ' $' : '0 $';

    const dollarCumulElem = document.getElementById(`plan-w${i}-dollar-cumul`);
    if (dollarCumulElem) dollarCumulElem.textContent = Math.round(cumulDollar).toLocaleString('fr-CA') + ' $';

    const dollarTendanceElem = document.getElementById(`plan-w${i}-dollar-tendance`);
    if (dollarTendanceElem) dollarTendanceElem.textContent = tendanceDollar;

    // Ne pas √©craser plan-w${i}-pct-sem car il contient le % fixe du pattern, pas le % r√©alis√©
    const pctCumulElem = document.getElementById(`plan-w${i}-pct-cumul`);
    if (pctCumulElem) pctCumulElem.textContent = pctCumul + '%';

    // Afficher le % de distribution de production (pas le % de r√©alisation)
    // prodPctElem d√©j√† d√©clar√© plus haut dans la boucle
    if (prodPctElem) prodPctElem.textContent = prodPctDistribution + '%';

    // Production - Cumul Obj. et Cumul
    const prodCumulObjElem = document.getElementById(`plan-w${i}-prod-cumul-obj`);
    if (prodCumulObjElem) prodCumulObjElem.textContent = i >= 2 ? Math.round(cumulProdObj).toLocaleString('fr-CA') + ' $' : '0 $';

    const prodCumulElem = document.getElementById(`plan-w${i}-prod-cumul`);
    if (prodCumulElem) prodCumulElem.textContent = Math.round(cumulProd).toLocaleString('fr-CA') + ' $';

    // Production tendance: (cumul prod / % cumul) √ó 100
    let tendanceProd = '-';
    if (cumulPercentValue > 0 && cumulProd > 0) {
      const tendanceProdVal = (cumulProd / cumulPercentValue) * 100;
      tendanceProd = Math.round(tendanceProdVal).toLocaleString('fr-CA') + ' $';
    }

    const prodTendanceElem = document.getElementById(`plan-w${i}-prod-tendance`);
    if (prodTendanceElem) prodTendanceElem.textContent = tendanceProd;
  }

  // Mettre √† jour la ligne TOTAL
  document.getElementById('total-mktg-prev').textContent = parseFloat(totalMktgPrev.toFixed(1)) + ' h';
  document.getElementById('total-mktg-reel').textContent = parseFloat(totalMktgReel.toFixed(1)) + ' h';
  document.getElementById('total-mktg-cumul').textContent = '-';
  document.getElementById('total-estim-prev').textContent = Math.round(totalEstimPrev);
  document.getElementById('total-estim-reel').textContent = Math.round(totalEstimReel);
  document.getElementById('total-estim-cumul').textContent = '-';
  document.getElementById('total-contrat-prev').textContent = parseFloat(totalContratPrev.toFixed(1));
  document.getElementById('total-contrat-reel').textContent = parseFloat(totalContratReel.toFixed(1));
  document.getElementById('total-contrat-cumul').textContent = '-';
  document.getElementById('total-dollar-prev').textContent = Math.round(totalDollarPrev).toLocaleString('fr-CA') + ' $';
  document.getElementById('total-dollar-reel').textContent = Math.round(totalDollarReel).toLocaleString('fr-CA') + ' $';
  document.getElementById('total-dollar-cumul').textContent = '-';
  document.getElementById('total-prod-vise').textContent = Math.round(totalProdVise).toLocaleString('fr-CA') + ' $';
  document.getElementById('total-prod-reel').textContent = Math.round(totalProdReel).toLocaleString('fr-CA') + ' $';

  // Ratio total
  const totalRatio = totalMktgReel > 0 ? (totalEstimReel / totalMktgReel).toFixed(2) : '0.00';
  document.getElementById('total-ratio').textContent = totalRatio;

  // % objectif total (bas√© sur le cumul final du pattern √† partir de la semaine 2)
  // cumulPctPattern contient la somme exacte des pourcentages du pattern
  const totalPctCumul = cumulPctPattern.toFixed(2);
  document.getElementById('total-pct-cumul').textContent = totalPctCumul + '%';

  // Production tendance total: (cumul prod / % cumul) √ó 100
  let totalProdTendance = '-';
  if (parseFloat(totalPctCumul) > 0 && cumulProd > 0) {
    const totalProdTendanceVal = (cumulProd / parseFloat(totalPctCumul)) * 100;
    totalProdTendance = Math.round(totalProdTendanceVal).toLocaleString('fr-CA') + ' $';
  }
  document.getElementById('total-prod-tendance').textContent = totalProdTendance;

  // % objectif sem. total (somme des % hebdomadaires visibles)
  document.getElementById('total-pct-sem').textContent = totalPctSem.toFixed(1) + '%';

  // TV% total (afficher "-" pour le total)
  document.getElementById('total-tv').textContent = '-';

  // % production total (somme des % de distribution)
  document.getElementById('total-prod-pct').textContent = totalProdPctDistribution.toFixed(1) + '%';

  // Mettre √† jour "Ventes" et "% Atteint" dans la section Pr√©vision
  document.getElementById('plan-ventes-actuel').textContent = parseFloat(totalDollarReel.toFixed(2)).toLocaleString('fr-CA') + ' $';
  document.getElementById('plan-pct-atteint').textContent = totalPctCumul + '%';

  // Synchroniser les totaux du plan avec les objectifs annuels RPO
  syncPlanTotalsToAnnualObjectives(totalMktgPrev, totalEstimPrev, totalContratPrev, totalDollarPrev);

  // Calculer "Devrait √™tre √†" bas√© sur les pr√©visions jusqu'√† aujourd'hui
  calculateExpectedToDate();
}

// Synchroniser les totaux du plan d'affaires avec les objectifs annuels RPO
function syncPlanTotalsToAnnualObjectives(totalMktgPrev, totalEstimPrev, totalContratPrev, totalDollarPrev) {
  log('üîÑ Synchronisation des totaux Plan ‚Üí Objectifs RPO annuels');

  // Mettre √† jour HEURES P√ÄP (H. Marketing Pr√©v.)
  const hrpapInput = document.getElementById('hrpap-vise');
  if (hrpapInput) {
    const hours = Math.round(totalMktgPrev);
    hrpapInput.value = hours + ' h';
    hrpapInput.dataset.value = hours;
    log(`   ‚úì HR P√ÄP: ${hours} h`);
  }

  // Mettre √† jour # D'ESTIMATION
  const estimInput = document.getElementById('estimation-vise');
  if (estimInput) {
    const estim = Math.round(totalEstimPrev);
    estimInput.value = estim.toString();
    estimInput.dataset.value = estim;
    log(`   ‚úì Estimation: ${estim}`);
  }

  // Mettre √† jour # CONTRACT SIGN√â
  const contractInput = document.getElementById('contract-vise');
  if (contractInput) {
    const contracts = Math.round(totalContratPrev);
    contractInput.value = contracts.toString();
    contractInput.dataset.value = contracts;
    log(`   ‚úì Contrats: ${contracts}`);
  }

  // Mettre √† jour $ SIGN√â
  const dollarInput = document.getElementById('dollar-vise');
  if (dollarInput) {
    const dollars = Math.round(totalDollarPrev);
    const formatted = dollars.toLocaleString('fr-CA').replace(/\s/g, ' ');
    dollarInput.value = formatted + ' $';
    dollarInput.dataset.value = dollars;
    log(`   ‚úì $ Sign√©: ${formatted} $`);
  }

  // Synchroniser les param√®tres du plan d'affaires vers les objectifs

  // TAUX MKTG (Ratio Marketing depuis le plan)
  const planRatioMktg = document.getElementById('plan-ratio-mktg');
  const mktgViseInput = document.getElementById('mktg-vise');
  if (planRatioMktg && mktgViseInput) {
    const ratioValue = parseFloat(planRatioMktg.dataset.value) || 0;
    mktgViseInput.value = ratioValue + '%';
    mktgViseInput.dataset.value = ratioValue;
    log(`   ‚úì Taux MKTG: ${ratioValue}%`);
  }

  // TAUX DE VENTE (depuis le plan)
  const planTauxVente = document.getElementById('plan-taux-vente');
  const venteViseInput = document.getElementById('vente-vise');
  if (planTauxVente && venteViseInput) {
    const tauxValue = parseFloat(planTauxVente.dataset.value) || 0;
    venteViseInput.value = tauxValue + '%';
    venteViseInput.dataset.value = tauxValue;
    log(`   ‚úì Taux de vente: ${tauxValue}%`);
  }

  // CONTRAT MOYEN (CM Pr√©vision depuis le plan)
  const planCmPrev = document.getElementById('plan-cm-prev');
  const moyenViseInput = document.getElementById('moyen-vise');
  if (planCmPrev && moyenViseInput) {
    const cmValue = parseFloat(planCmPrev.dataset.value) || 0;
    const formatted = Math.round(cmValue).toLocaleString('fr-CA').replace(/\s/g, ' ');
    moyenViseInput.value = formatted + ' $';
    moyenViseInput.dataset.value = cmValue;
    log(`   ‚úì Contrat moyen: ${formatted} $`);
  }

  // Recalculer les pourcentages apr√®s la mise √† jour
  ['hrpap', 'estimation', 'contract', 'dollar', 'mktg', 'vente', 'moyen'].forEach(metric => calculatePercentage(metric));

  log('‚úÖ Synchronisation termin√©e');
}

// Calculer "Devrait √™tre √†" bas√© sur le Cumul Obj. de la semaine actuelle
function calculateExpectedToDate() {
  log('üìÖ Calcul "Devrait √™tre √†" depuis Cumul Obj. de la semaine actuelle');

  const today = new Date(); // Date d'aujourd'hui
  const planStartDate = createTorontoDate(2026, 0, 5); // 5 janvier 2026
  const weeks = 52;

  // Valeurs Cumul Obj. de la semaine actuelle
  let expectedMktg = 0;
  let expectedEstim = 0;
  let expectedContrat = 0;
  let expectedDollar = 0;

  // Trouver la semaine actuelle (celle qui contient aujourd'hui)
  let weekFound = false;
  for (let i = 1; i <= weeks; i++) {
    // Calculer la date de d√©but et fin de la semaine i
    const weekStart = new Date(planStartDate);
    weekStart.setDate(weekStart.getDate() + ((i - 1) * 7));
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate() + 6); // Dimanche de la semaine

    // Si aujourd'hui est dans cette semaine
    if (today >= weekStart && today <= weekEnd) {
      weekFound = true;
      log(`   ‚úì Semaine actuelle trouv√©e: ${i} (${weekStart.toDateString()} - ${weekEnd.toDateString()})`);

      // Lire les valeurs "Cumul Obj." directement depuis les spans avec IDs
      const mktgCumulObjSpan = document.getElementById(`plan-w${i}-mktg-cumul-obj`);
      const estimCumulObjSpan = document.getElementById(`plan-w${i}-estim-cumul-obj`);
      const contratCumulObjSpan = document.getElementById(`plan-w${i}-contrat-cumul-obj`);
      const dollarCumulObjSpan = document.getElementById(`plan-w${i}-dollar-cumul-obj`);

      const mktgCumulText = mktgCumulObjSpan?.textContent || '0';
      const estimCumulText = estimCumulObjSpan?.textContent || '0';
      const contratCumulText = contratCumulObjSpan?.textContent || '0';
      const dollarCumulText = dollarCumulObjSpan?.textContent || '0';

      log(`   üìä Valeurs lues - Mktg: "${mktgCumulText}", Estim: "${estimCumulText}", Contrat: "${contratCumulText}", Dollar: "${dollarCumulText}"`);

      expectedMktg = parseFloat(mktgCumulText.replace(/[^\d.]/g, '')) || 0;
      expectedEstim = parseFloat(estimCumulText.replace(/[^\d.]/g, '')) || 0;
      expectedContrat = parseFloat(contratCumulText.replace(/[^\d.]/g, '')) || 0;
      expectedDollar = parseFloat(dollarCumulText.replace(/[^\d]/g, '')) || 0;

      log(`   ‚úÖ Cumul Obj - Mktg: ${expectedMktg}h, Estim: ${expectedEstim}, Contrat: ${expectedContrat}, Dollar: ${expectedDollar}$`);
      break; // Sortir de la boucle une fois la semaine actuelle trouv√©e
    }
  }

  if (!weekFound) {
    log(`   ‚ö†Ô∏è Aucune semaine trouv√©e pour la date: ${today.toDateString()}`);
  }

  // Mettre √† jour les champs "Devrait √™tre √†" (tendance)
  const hrpapTendance = document.getElementById('hrpap-tendance');
  if (hrpapTendance) {
    hrpapTendance.textContent = expectedMktg.toFixed(1) + ' h';
    hrpapTendance.dataset.value = expectedMktg;
  }

  const estimTendance = document.getElementById('estimation-tendance');
  if (estimTendance) {
    // Afficher avec 1 d√©cimale si < 10, sinon arrondir
    const displayValue = expectedEstim < 10 ? expectedEstim.toFixed(1) : Math.round(expectedEstim).toString();
    estimTendance.textContent = displayValue;
    estimTendance.dataset.value = expectedEstim;
  }

  const contractTendance = document.getElementById('contract-tendance');
  if (contractTendance) {
    // Afficher avec 1 d√©cimale si < 10, sinon arrondir
    const displayValue = expectedContrat < 10 ? expectedContrat.toFixed(1) : Math.round(expectedContrat).toString();
    contractTendance.textContent = displayValue;
    contractTendance.dataset.value = expectedContrat;
  }

  const dollarTendance = document.getElementById('dollar-tendance');
  if (dollarTendance) {
    const formatted = Math.round(expectedDollar).toLocaleString('fr-CA').replace(/\s/g, ' ');
    dollarTendance.textContent = formatted + ' $';
    dollarTendance.dataset.value = expectedDollar;
  }

  // Afficher/cacher les badges "Conseils" selon le retard
  updateAdviceBadges();

  // Recalculer les pourcentages pour mettre √† jour les couleurs
  ['hrpap', 'estimation', 'contract', 'dollar'].forEach(metric => calculatePercentage(metric));

  log('‚úÖ Calcul "Devrait √™tre √†" termin√©');
}

// Afficher/cacher les badges "Conseils" si en retard
function updateAdviceBadges() {
  const metrics = [
    { name: 'hrpap', tendanceId: 'hrpap-tendance', reelId: 'annual-hrpap-reel' },
    { name: 'estimation', tendanceId: 'estimation-tendance', reelId: 'annual-estimation-reel' },
    { name: 'contract', tendanceId: 'contract-tendance', reelId: 'annual-contract-reel' },
    { name: 'dollar', tendanceId: 'dollar-tendance', reelId: 'annual-dollar-reel' }
  ];

  metrics.forEach(metric => {
    const tendanceElement = document.getElementById(metric.tendanceId);
    const reelElement = document.getElementById(metric.reelId);
    const badge = document.getElementById(`${metric.name}-advice-badge`);

    if (tendanceElement && reelElement && badge) {
      const tendance = parseFloat(tendanceElement.dataset.value) || 0;
      const reel = parseFloat(reelElement.dataset.value) || 0;

      // Afficher le badge si en retard (tendance > reel)
      if (tendance > reel) {
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }
  });
}

// Afficher le popup de conseils
function showAdvice(metricName) {
  const tendanceElement = document.getElementById(`${metricName}-tendance`);
  const reelElement = document.getElementById(`annual-${metricName}-reel`);

  if (!tendanceElement || !reelElement) return;

  const tendance = parseFloat(tendanceElement.dataset.value) || 0;
  const reel = parseFloat(reelElement.dataset.value) || 0;
  const retard = tendance - reel;

  if (retard <= 0) return; // Pas de retard

  // Calculer combien de semaines jusqu'√† la fin de l'ann√©e fiscale
  const today = new Date();
  const fiscalYearEnd = createTorontoDate(2026, 9, 4); // 4 octobre 2026
  const weeksRemaining = Math.ceil((fiscalYearEnd - today) / (7 * 24 * 60 * 60 * 1000));

  // Calculer combien il faut faire par semaine
  const perWeek = weeksRemaining > 0 ? (retard / weeksRemaining).toFixed(1) : retard.toFixed(1);

  // Date limite (fin de l'ann√©e fiscale)
  const dateLimite = fiscalYearEnd.toLocaleDateString('fr-CA', { day: 'numeric', month: 'long', year: 'numeric' });

  // G√©n√©rer le message selon la m√©trique
  let metricLabel, unit, action;
  switch(metricName) {
    case 'hrpap':
      metricLabel = "heures de marketing";
      unit = "h";
      action = "travailler";
      break;
    case 'estimation':
      metricLabel = "estimations";
      unit = "";
      action = "faire";
      break;
    case 'contract':
      metricLabel = "contrats sign√©s";
      unit = "";
      action = "signer";
      break;
    case 'dollar':
      metricLabel = "dollars sign√©s";
      unit = " $";
      action = "g√©n√©rer";
      break;
  }

  const message = `
    <div style="padding: 20px;">
      <h3 style="color: var(--text-light); font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; display: flex; align-items: center;">
        <i class="fas fa-lightbulb" style="color: #fbbf24; margin-right: 0.5rem;"></i>
        Conseil pour rattraper le retard
      </h3>
      <div style="background: rgba(251, 191, 36, 0.1); border-left: 4px solid #fbbf24; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
        <p style="color: var(--text-light); margin: 0;">
          <strong>Retard actuel :</strong> ${retard.toFixed(1)}${unit} ${metricLabel}
        </p>
      </div>
      <div style="color: var(--text-gray); line-height: 1.6;">
        <p style="margin-bottom: 0.75rem;">
          <i class="fas fa-calendar-check" style="color: #3b82f6; margin-right: 0.5rem;"></i>
          Pour rattraper le retard d'ici le <strong style="color: var(--text-light);">${dateLimite}</strong>, vous devez :
        </p>
        <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 0.5rem; margin: 1rem 0;">
          <p style="color: var(--text-light); font-size: 1.1rem; margin: 0; text-align: center;">
            <strong style="color: #3b82f6;">${action} ${perWeek}${unit}</strong> de plus par semaine
          </p>
        </div>
        <p style="margin: 0.75rem 0 0 0; font-size: 0.9rem; color: rgba(148, 163, 184, 0.9);">
          <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
          Il reste environ <strong>${weeksRemaining} semaines</strong> jusqu'√† la fin de l'ann√©e fiscale.
        </p>
      </div>
    </div>
  `;

  showNotificationPopup('Conseils', message, 'info');
}

// Synchroniser les pr√©visions du plan d'affaire vers les objectifs RPO hebdo
function syncPlanToRPO() {
  // Le plan d'affaire commence le 5 janvier 2026 avec 52 semaines
  const planStartDate = createTorontoDate(2026, 0, 5); // 5 janvier 2026 - Toronto timezone
  const totalPlanWeeks = 52;

  // Obtenir les semaines RPO pour le mois actuellement affich√©
  if (typeof currentWeeklyMonthIndex === 'undefined') return;

  const rpoWeeks = getWeeksForMonth(currentWeeklyMonthIndex);
  if (!rpoWeeks || rpoWeeks.length === 0) return;

  log(`üîÑ Synchronisation pour mois ${currentWeeklyMonthIndex}, ${rpoWeeks.length} semaines RPO`);

  // Pour chaque semaine RPO affich√©e
  rpoWeeks.forEach((rpoWeek, rpoIndex) => {
    const weekNum = rpoIndex + 1; // data-week = 1, 2, 3, ...

    // Parser les dates de la semaine RPO depuis le label (ex: "2 mars - 8 mars")
    const rpoWeekLabel = rpoWeek.label;
    log(`[DEBUG] Traitement RPO semaine: ${rpoWeekLabel}`);
    const [startStr, endStr] = rpoWeekLabel.split(' - ');

    // Extraire jour et mois
    const monthNames = ['janv.', 'f√©vr.', 'mars', 'avril', 'mai', 'juin', 'juil.', 'ao√ªt', 'sept.', 'oct.', 'nov.', 'd√©c.'];
    const startParts = startStr.trim().split(' ');
    const endParts = endStr.trim().split(' ');
    const startDay = parseInt(startParts[0]);
    const startMonthIdx = monthNames.indexOf(startParts[1]);
    const endDay = parseInt(endParts[0]);
    const endMonthIdx = monthNames.indexOf(endParts[1]);

    // D√©terminer l'ann√©e (ann√©e fiscale commence en janvier 2026)
    let startYear = 2026; // Ann√©e fiscale 2026
    let endYear = endMonthIdx === 0 && startMonthIdx === 11 ? 2026 : startYear;
    if (endMonthIdx < startMonthIdx) endYear = startYear + 1;

    const rpoWeekStart = createTorontoDate(startYear, startMonthIdx, startDay);
    const rpoWeekEnd = createTorontoDate(endYear, endMonthIdx, endDay);

    log(`   [DATE] RPO date: ${rpoWeekStart.toLocaleDateString('fr-CA')} (${rpoWeekStart.getFullYear()}-${rpoWeekStart.getMonth()+1}-${rpoWeekStart.getDate()})`);

    // Exclure la semaine 5-11 janvier 2026
    if (startYear === 2026 && startMonthIdx === 0 && startDay === 5) {
      log(`‚è≠Ô∏è Semaine ${rpoWeekLabel} exclue (5-11 janvier)`);
      return;
    }

    // Chercher la semaine correspondante dans le plan d'affaire
    let matchedPlanWeek = null;
    for (let planIdx = 0; planIdx < totalPlanWeeks; planIdx++) {
      // Ajouter des semaines en utilisant les millisecondes pour √©viter les probl√®mes de timezone
      const planWeekStart = new Date(planStartDate.getTime() + (planIdx * 7 * 24 * 60 * 60 * 1000));
      const planWeekEnd = new Date(planWeekStart.getTime() + (6 * 24 * 60 * 60 * 1000));

      // V√©rifier si les dates correspondent (m√™me ann√©e, mois, jour)
      const sameYear = planWeekStart.getFullYear() === rpoWeekStart.getFullYear();
      const sameMonth = planWeekStart.getMonth() === rpoWeekStart.getMonth();
      const sameDay = planWeekStart.getDate() === rpoWeekStart.getDate();

      if (sameYear && sameMonth && sameDay) {
        matchedPlanWeek = planIdx + 1; // +1 car ligne 1 = test (6-12 oct)
        log(`   [OK] Match trouv√©: plan semaine ${matchedPlanWeek} (${planWeekStart.toLocaleDateString('fr-CA')})`);
        break;
      }
    }

    if (!matchedPlanWeek) {
      log(`   [WARN] Aucune correspondance plan pour RPO ${rpoWeekLabel}`);
      return;
    }

    // R√©cup√©rer les valeurs du plan d'affaire
    const planRow = document.querySelector(`#plan-w${matchedPlanWeek}-mktg-reel`)?.closest('tr');
    if (!planRow) {
      log(`[WARN] plan-w${matchedPlanWeek} introuvable`);
      return;
    }

    const cells = planRow.querySelectorAll('td');
    const mktgPrev = parseFloat(cells[1]?.textContent) || 0;
    const estimPrev = parseFloat(cells[4]?.textContent) || 0;
    const contratPrev = parseFloat(cells[8]?.textContent) || 0;
    const dollarText = cells[11]?.textContent.replace(/[^\d]/g, '') || '0';
    const dollarPrev = parseFloat(dollarText) || 0;

    log(`   [DATA] Valeurs plan: mktg=${mktgPrev}h, estim=${estimPrev}, contrat=${contratPrev}, $=${dollarPrev}`);

    // Mettre √† jour RPO
    const rpoInputReel = document.querySelector(`[data-week="${weekNum}"][data-field="h_marketing"]`);
    if (!rpoInputReel) return;

    const tr = rpoInputReel.closest('tr');
    if (!tr) return;

    const tds = tr.querySelectorAll('td');
    const rpoMktgVise = tds[1]?.querySelector('input');
    const rpoEstimVise = tds[3]?.querySelector('input');
    const rpoContratVise = tds[5]?.querySelector('input');
    const rpoDollarVise = tds[7]?.querySelector('input');

    // Arrondir h_marketing pour affichage dans RPO (0.3h ‚Üí 1h)
    if (rpoMktgVise) rpoMktgVise.value = `${Math.ceil(mktgPrev)} h`;
    if (rpoEstimVise) rpoEstimVise.value = `${Math.round(estimPrev)}`;
    if (rpoContratVise) rpoContratVise.value = `${Math.round(contratPrev)}`;
    if (rpoDollarVise) rpoDollarVise.value = `${dollarPrev.toLocaleString('fr-CA')} $`;

    log(`[OK] ${rpoWeekLabel} ‚Üê plan-w${matchedPlanWeek}`);
  });
}

// Synchroniser les donn√©es r√©elles RPO hebdo vers le plan d'affaire
function syncRPOToPlan() {
  // Parcourir tous les inputs avec data-field dans le DOM actuel (mois affich√©)
  const rpoInputs = document.querySelectorAll('[data-field][data-week]');

  rpoInputs.forEach(input => {
    const weekNum = parseInt(input.dataset.week);
    const field = input.dataset.field;

    if (!weekNum || !field) return;

    // Calculer le num√©ro de semaine global bas√© sur le mois actuel
    // currentWeeklyMonthIndex est d√©fini globalement
    // IMPORTANT: D√©cembre 2025 = monthIndex -2, donc besoin d'un traitement sp√©cial
    let globalWeek;
    if (currentWeeklyMonthIndex === -2) {
      // D√©cembre 2025: semaines 1-4 correspondent directement aux semaines 1-4 du plan
      globalWeek = weekNum;
    } else {
      // Janvier 2026+ (monthIndex 0, 1, 2...): d√©caler de 6 (car 6 semaines de d√©cembre dans le plan)
      globalWeek = 6 + (currentWeeklyMonthIndex * 4) + weekNum;
    }

    if (globalWeek > 52) return; // Ne pas d√©passer la semaine 52 du plan

    // Le plan n'a pas de ligne test, donc globalWeek correspond directement √† l'index
    const planWeekIndex = globalWeek;

    // Mapper les champs RPO vers les IDs du plan
    let planInputId = '';
    switch (field) {
      case 'h_marketing':
        planInputId = `plan-w${planWeekIndex}-mktg-reel`;
        break;
      case 'estimation':
        planInputId = `plan-w${planWeekIndex}-estim-reel`;
        break;
      case 'contract':
        planInputId = `plan-w${planWeekIndex}-contrat-reel`;
        break;
      case 'dollar':
        planInputId = `plan-w${planWeekIndex}-dollar-reel`;
        break;
      default:
        return;
    }

    const planInput = document.getElementById(planInputId);
    if (planInput && input.dataset.value !== undefined) {
      // Si la valeur est "-", garder "-" pour h_marketing
      if (input.dataset.value === '-' && field === 'h_marketing') {
        planInput.value = '-';
      } else {
        const value = parseFloat(input.dataset.value) || 0;
        // Formater selon le type de champ
        if (field === 'h_marketing') {
          planInput.value = value > 0 ? value + ' h' : '-';
        } else if (field === 'dollar') {
          planInput.value = Math.round(value).toLocaleString('fr-CA') + ' $';
        } else {
          planInput.value = value;
        }
      }
    }
  });

  // Recalculer le plan apr√®s synchronisation
  calculatePlan();
}

// Charger les donn√©es hebdomadaires depuis window.weeklyData vers le plan d'affaire
function loadWeeklyDataToPlan() {
  if (!window.weeklyData) {
    log('[PLAN] window.weeklyData non disponible');
    return;
  }

  log('[PLAN] Chargement des donn√©es depuis window.weeklyData...');

  // IMPORTANT: R√©initialiser TOUTES les valeurs R√âEL √† 0 avant de charger
  // Cela √©vite que les anciennes valeurs persistent dans les semaines futures
  resetPlanReelValues();

  // Fonction de normalisation robuste des labels (identique √† loadRPODataIntoPlan)
  const normalizeLabel = (label) => {
    return label.toLowerCase()
      .replace(/\./g, '')
      .replace(/janvier|janv/g, 'janv')
      .replace(/f√©vrier|f√©vr|f√©v/g, 'fevr')
      .replace(/mars/g, 'mars')
      .replace(/avril|avr/g, 'avr')
      .replace(/mai/g, 'mai')
      .replace(/juin/g, 'juin')
      .replace(/juillet|juil/g, 'juil')
      .replace(/ao√ªt|aout/g, 'aout')
      .replace(/septembre|sept/g, 'sept')
      .replace(/octobre|oct/g, 'oct')
      .replace(/novembre|nov/g, 'nov')
      .replace(/d√©cembre|d√©c|dec/g, 'dec')
      .replace(/\s+/g, ' ')
      .trim();
  };

  // Janvier 2026+ (monthIndex 0-11): matcher par week_label
  for (let monthIndex = 0; monthIndex < 12; monthIndex++) {
    const monthKey = String(monthIndex);
    if (window.weeklyData[monthKey]) {
      Object.keys(window.weeklyData[monthKey]).forEach(weekNumber => {
        const weekData = window.weeklyData[monthKey][weekNumber];

        // NOUVEAU: Matcher par week_label avec normalisation robuste
        const rpoLabel = normalizeLabel(weekData.week_label || '');

        if (!rpoLabel) {
          log(`[PLAN] Pas de week_label pour mois ${monthIndex} semaine ${weekNumber}, skip`);
          return;
        }

        // Chercher dans toutes les lignes du plan d'affaires celle qui a le m√™me label
        const planRows = document.querySelectorAll('#plan-weeks-body tr.plan-row');
        let matchedPlanWeekIndex = null;

        planRows.forEach((row, idx) => {
          const planLabel = normalizeLabel(row.querySelector('td:first-child')?.textContent || '');
          if (planLabel === rpoLabel) {
            matchedPlanWeekIndex = idx + 1; // idx commence √† 0, mais les semaines commencent √† 1
          }
        });

        if (!matchedPlanWeekIndex || matchedPlanWeekIndex > 52) {
          log(`[PLAN] Aucune correspondance trouv√©e pour "${rpoLabel}"`);
          return;
        }

        // H. Marketing
        if (weekData.h_marketing !== undefined) {
          const input = document.getElementById(`plan-w${matchedPlanWeekIndex}-mktg-reel`);
          if (input) {
            const val = weekData.h_marketing;
            input.value = (val !== null && val !== undefined && val !== '-') ? val + ' h' : '-';
          }
        }

        // Estimation
        if (weekData.estimation !== undefined) {
          const input = document.getElementById(`plan-w${matchedPlanWeekIndex}-estim-reel`);
          if (input) input.value = weekData.estimation;
        }

        // Contrat
        if (weekData.contract !== undefined) {
          const input = document.getElementById(`plan-w${matchedPlanWeekIndex}-contrat-reel`);
          if (input) input.value = weekData.contract;
        }

        // Dollar
        if (weekData.dollar !== undefined) {
          const input = document.getElementById(`plan-w${matchedPlanWeekIndex}-dollar-reel`);
          if (input) {
            const dollarValue = Math.round(weekData.dollar);
            // Formatage manuel avec espaces pour les milliers
            const formattedDollar = dollarValue.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            input.value = formattedDollar + ' $';
          }
        }
      });
    }
  }

  // Charger aussi les ventes produit pour la colonne Production R√©el
  if (typeof loadVentesProduitIntoPlan === 'function') {
    loadVentesProduitIntoPlan().then(() => {
      log('[PLAN] Ventes produit charg√©es');
      // Recalculer le plan apr√®s avoir charg√© toutes les donn√©es
      log('[PLAN] Toutes les donn√©es charg√©es, recalcul du plan...');
      calculatePlan();
    });
  } else {
    // Recalculer le plan m√™me si loadVentesProduitIntoPlan n'est pas disponible
    log('[PLAN] Donn√©es charg√©es, recalcul du plan...');
    calculatePlan();
  }
}

// R√©initialiser toutes les valeurs R√âEL du plan d'affaires √† 0 ou "-"
function resetPlanReelValues() {
  log('[PLAN] R√©initialisation de toutes les valeurs R√âEL √† 0...');

  const planRows = document.querySelectorAll('#plan-weeks-body tr.plan-row');
  planRows.forEach((row, idx) => {
    const weekNum = idx + 1;

    // H. Marketing R√©el -> "-"
    const mktgInput = document.getElementById(`plan-w${weekNum}-mktg-reel`);
    if (mktgInput) mktgInput.value = '-';

    // Estimation R√©el -> 0
    const estimInput = document.getElementById(`plan-w${weekNum}-estim-reel`);
    if (estimInput) estimInput.value = 0;

    // Contrat R√©el -> 0
    const contratInput = document.getElementById(`plan-w${weekNum}-contrat-reel`);
    if (contratInput) contratInput.value = 0;

    // Dollar R√©el -> "0 $"
    const dollarInput = document.getElementById(`plan-w${weekNum}-dollar-reel`);
    if (dollarInput) dollarInput.value = '0 $';

    // Production R√©el -> "0 $"
    const prodInput = document.getElementById(`plan-w${weekNum}-prod-reel`);
    if (prodInput) prodInput.value = '0 $';
  });

  log('[PLAN] Toutes les valeurs R√âEL r√©initialis√©es');
}

// Charger les donn√©es hebdomadaires du RPO dans le plan d'affaire
async function loadRPODataIntoPlan() {
  const username = getCurrentUsername();
  log('[PLAN] Chargement de toutes les donn√©es hebdomadaires pour le plan...');

  // IMPORTANT: R√©initialiser TOUTES les valeurs R√âEL √† 0 avant de charger
  // Cela √©vite que les anciennes valeurs persistent dans les semaines futures
  resetPlanReelValues();

  try {
    // OPTIMISATION: Charger tous les 12 mois EN PARALL√àLE au lieu de s√©quentiellement
    const monthPromises = [];
    for (let monthIndex = 0; monthIndex < 12; monthIndex++) {
      monthPromises.push(
        fetch(`/api/rpo/${username}/weekly/${monthIndex}`)
          .then(response => response.ok ? response.json() : null)
          .then(monthData => ({ monthIndex, monthData }))
      );
    }

    // Attendre que TOUS les mois soient charg√©s en parall√®le
    const allMonthsResults = await Promise.all(monthPromises);
    log('[PLAN] Tous les mois charg√©s en parall√®le');

    // Traiter les donn√©es de chaque mois
    allMonthsResults.forEach(({ monthIndex, monthData }) => {
      if (!monthData) return;

      log(`[PLAN] Traitement mois ${monthIndex}:`, monthData);

      Object.keys(monthData).forEach(weekNumber => {
        const weekData = monthData[weekNumber];

        // NOUVEAU: Matcher par week_label au lieu d'index
        // Normaliser le label du RPO avec normalisation robuste des mois
        const normalizeLabel = (label) => {
          return label.toLowerCase()
            .replace(/\./g, '')
            .replace(/janvier|janv/g, 'janv')
            .replace(/f√©vrier|f√©vr|f√©v/g, 'fevr')
            .replace(/mars/g, 'mars')
            .replace(/avril|avr/g, 'avr')
            .replace(/mai/g, 'mai')
            .replace(/juin/g, 'juin')
            .replace(/juillet|juil/g, 'juil')
            .replace(/ao√ªt|aout/g, 'aout')
            .replace(/septembre|sept/g, 'sept')
            .replace(/octobre|oct/g, 'oct')
            .replace(/novembre|nov/g, 'nov')
            .replace(/d√©cembre|d√©c|dec/g, 'dec')
            .replace(/\s+/g, ' ')
            .trim();
        };

        const rpoLabel = normalizeLabel(weekData.week_label || '');

        if (!rpoLabel) {
          log(`[PLAN] Pas de week_label pour mois ${monthIndex} semaine ${weekNumber}, skip`);
          return;
        }

        // Chercher dans toutes les lignes du plan d'affaires celle qui a le m√™me label
        const planRows = document.querySelectorAll('#plan-weeks-body tr.plan-row');
        let matchedPlanWeekIndex = null;

        planRows.forEach((row, idx) => {
          const planLabel = normalizeLabel(row.querySelector('td:first-child')?.textContent || '');
          if (planLabel === rpoLabel) {
            matchedPlanWeekIndex = idx + 1; // idx commence √† 0, mais les semaines commencent √† 1
          }
        });

        if (!matchedPlanWeekIndex) {
          log(`[PLAN] Aucune correspondance trouv√©e pour "${rpoLabel}"`, weekData);
          return;
        }

        log(`[PLAN] Match trouv√©: "${rpoLabel}" -> plan-w${matchedPlanWeekIndex}:`, weekData);

        // H. Marketing
        if (weekData.h_marketing !== undefined) {
          const input = document.getElementById(`plan-w${matchedPlanWeekIndex}-mktg-reel`);
          if (input) {
            const val = weekData.h_marketing;
            input.value = (val !== null && val !== undefined && val !== '-') ? val + ' h' : '-';
          }
        }

        // Estimation
        if (weekData.estimation !== undefined) {
          const input = document.getElementById(`plan-w${matchedPlanWeekIndex}-estim-reel`);
          if (input) input.value = weekData.estimation;
        }

        // Contrat
        if (weekData.contract !== undefined) {
          const input = document.getElementById(`plan-w${matchedPlanWeekIndex}-contrat-reel`);
          if (input) input.value = weekData.contract;
        }

        // Dollar
        if (weekData.dollar !== undefined) {
          const input = document.getElementById(`plan-w${matchedPlanWeekIndex}-dollar-reel`);
          if (input) {
            const dollarValue = Math.round(weekData.dollar);
            // Formatage manuel avec espaces pour les milliers
            const formattedDollar = dollarValue.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            input.value = formattedDollar + ' $';
          }
        }
      });
    });

    // Charger les ventes produit pour Production R√©el
    await loadVentesProduitIntoPlan();

    // Recalculer apr√®s avoir charg√© les donn√©es
    log('[PLAN] Toutes les donn√©es charg√©es, recalcul du plan...');
    calculatePlan();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LOG PLAN D'AFFAIRES - Afficher toutes les valeurs H Marketing R√©el
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    console.log('');
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë           PLAN D\'AFFAIRES - H MARKETING R√âEL (TOUTES)         ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    console.log('');

    const planRows = document.querySelectorAll('#plan-weeks-body tr.plan-row');
    planRows.forEach((row, idx) => {
      const weekNum = idx + 1;
      const weekLabel = row.querySelector('td:first-child')?.textContent.trim();
      const mktgInput = document.getElementById(`plan-w${weekNum}-mktg-reel`);
      const mktgValue = mktgInput?.value || '-';

      // Afficher seulement si la valeur n'est pas "-"
      if (mktgValue !== '-') {
        console.log(`üìä Semaine ${weekNum.toString().padStart(2, ' ')}: ${weekLabel.padEnd(25, ' ')} ‚ûú ${mktgValue}`);
      }
    });

    console.log('');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('');

  } catch (error) {
    error('[PLAN] Erreur lors du chargement des donn√©es:', error);
  }
}

// Charger les ventes produit et calculer Production R√©el
async function loadVentesProduitIntoPlan() {
  const username = getCurrentUsername();

  try {
    const response = await fetch(`/ventes/produit/${username}`);
    if (!response.ok) return;

    const ventesProduit = await response.json();

    // Initialiser un tableau pour stocker la somme des prix par semaine
    const productionParSemaine = {};

    // Date de d√©but du plan: 5 janvier 2026
    const startDate = createTorontoDate(2026, 0, 5);

    // Parcourir toutes les ventes produit
    ventesProduit.forEach(vente => {
      // R√©cup√©rer la date et le prix
      let dateVente;
      if (vente.date) {
        // Parser la date avec timezone Toronto
        dateVente = parseTorontoDate(vente.date);
      }

      if (!dateVente || isNaN(dateVente.getTime())) return;

      // V√©rifier si la date est dans la p√©riode du plan (6 d√©c 2025 - 18 oct 2026)
      const endDate = createTorontoDate(2026, 9, 18); // 18 octobre 2026 (fin semaine 41)
      if (dateVente < startDate || dateVente > endDate) return;

      // Calculer le num√©ro de semaine global (1-41, o√π 1 = semaine test)
      const diffTime = dateVente - startDate;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      const weekNumber = Math.floor(diffDays / 7) + 1;

      if (weekNumber < 1 || weekNumber > 41) return;

      // Parser le prix (peut √™tre "1 000,00 $" ou "1000" ou "1000.00")
      let prix = 0;
      if (vente.prix) {
        const prixStr = String(vente.prix).replace(/\s/g, '').replace('$', '').replace(',', '.');
        prix = parseFloat(prixStr) || 0;
      }

      // Ajouter au total de la semaine
      if (!productionParSemaine[weekNumber]) {
        productionParSemaine[weekNumber] = 0;
      }
      productionParSemaine[weekNumber] += prix;
    });

    // Mettre √† jour les inputs de Production R√©el
    for (let week = 1; week <= 41; week++) {
      const input = document.getElementById(`plan-w${week}-prod-reel`);
      if (input) {
        const prodValue = productionParSemaine[week] || 0;
        input.value = Math.round(prodValue).toLocaleString('fr-CA') + ' $';
      }
    }

  } catch (error) {
    error('Erreur chargement ventes produit:', error);
  }
}

// NOTE: savePlanDataToRPO() a √©t√© supprim√©e car elle faisait l'inverse de ce qu'elle devrait faire
// Les donn√©es R√âEL ne doivent JAMAIS √™tre sauvegard√©es - elles sont toujours en lecture seule
// et charg√©es depuis les donn√©es hebdomadaires RPO via loadRPODataIntoPlan()

// Initialiser le plan au chargement
document.addEventListener('DOMContentLoaded', async () => {
  // ‚ö° V√âRIFIER si on doit charger les donn√©es RPO
  const userRole = localStorage.getItem('userRole');
  const isCoach = userRole === 'coach' || userRole === 'direction';
  const urlParams = new URLSearchParams(window.location.search);
  const userParam = urlParams.get('user');

  // V√©rifier si un entrepreneur est s√©lectionn√©
  const hasSelection = document.body.classList.contains('has-selection') ||
                      window.selectedEntrepreneurUsername ||
                      (userParam && userParam !== localStorage.getItem('username'));

  // ‚ö° NE PAS charger si coach/direction SANS s√©lection entrepreneur
  if (isCoach && !hasSelection) {
    console.log('[RPO] Coach/Direction sans s√©lection - chargement diff√©r√© jusqu\'√† s√©lection entrepreneur');
    // Activer quand m√™me le drag-to-scroll pour l'interface
    enableDragScroll();
    return; // Arr√™ter ici - loadRPOData() sera appel√© par la s√©lection entrepreneur
  }

  console.log('[RPO] Chargement initial des donn√©es (entrepreneur ou s√©lection active)');

  // D'abord charger les donn√©es RPO pour avoir le bon Objectif CA
  await loadRPODataInternal();

  // Ensuite g√©n√©rer le plan avec les param√®tres corrects (objectif CA charg√©)
  generatePlanWeeks();

  // Charger les objectifs hebdomadaires sauvegard√©s depuis le backend
  // Cela remplacera les valeurs calcul√©es par les valeurs sauvegard√©es (si elles existent)
  await loadSavedWeeklyTargetsIntoPlan();

  // IMPORTANT: Charger d'abord les donn√©es r√©elles hebdomadaires du backend
  // avant toute synchronisation pour √©viter d'√©craser les donn√©es
  await loadRPODataIntoPlan();

  // Calculer tous les cumuls, totaux et tendances
  calculatePlan();

  // S'assurer que les "Devrait √™tre √†" sont calcul√©s
  setTimeout(() => {
    calculateExpectedToDate();
    console.log('[RPO] "Devrait √™tre √†" recalcul√©s apr√®s chargement');
  }, 150);

  // Ajouter des listeners sur les param√®tres du plan pour recalculer automatiquement
  setupPlanParameterListeners();

  // Activer le drag-to-scroll sur le tableau
  enableDragScroll();

  console.log('[RPO] Chargement initial termin√©');
});

// Activer le scroll horizontal avec la souris (drag to scroll)
function enableDragScroll() {
  const scrollContainer = document.querySelector('.plan-scroll-container');
  if (!scrollContainer) return;

  let isDown = false;
  let startX;
  let scrollLeft;
  let hasMoved = false;

  scrollContainer.addEventListener('mousedown', (e) => {
    isDown = true;
    hasMoved = false;
    scrollContainer.style.cursor = 'grabbing';
    scrollContainer.style.userSelect = 'none';
    startX = e.pageX - scrollContainer.offsetLeft;
    scrollLeft = scrollContainer.scrollLeft;
  });

  scrollContainer.addEventListener('mouseleave', () => {
    isDown = false;
    scrollContainer.style.cursor = 'grab';
    scrollContainer.style.userSelect = 'auto';
  });

  scrollContainer.addEventListener('mouseup', (e) => {
    isDown = false;
    scrollContainer.style.cursor = 'grab';
    scrollContainer.style.userSelect = 'auto';

    // Si on a fait un drag (boug√© la souris), emp√™cher le focus sur l'input
    if (hasMoved && e.target.tagName === 'INPUT') {
      e.preventDefault();
      e.target.blur();
    }
  });

  scrollContainer.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    hasMoved = true;
    const x = e.pageX - scrollContainer.offsetLeft;
    const walk = (x - startX) * 2; // La vitesse du scroll (multiplier pour aller plus vite)
    scrollContainer.scrollLeft = scrollLeft - walk;
  });

  // Emp√™cher le focus sur les inputs pendant le drag
  scrollContainer.addEventListener('click', (e) => {
    if (hasMoved && e.target.tagName === 'INPUT') {
      e.preventDefault();
      e.stopPropagation();
    }
  }, true);

  // D√©finir le curseur initial
  scrollContainer.style.cursor = 'grab';
}

// Configurer les listeners pour les param√®tres du plan
function setupPlanParameterListeners() {
  const paramInputs = document.querySelectorAll('.plan-param-input');

  paramInputs.forEach(input => {
    // √âcouter les changements quand on est en mode √©dition
    input.addEventListener('input', () => {
      if (!input.hasAttribute('readonly')) {
        // Formater la valeur
        let value = input.value.replace(/[^\d.,]/g, '');
        value = value.replace(',', '.');
        const numValue = parseFloat(value) || 0;
        input.dataset.value = numValue;
      }
    });

    // Quand on quitte le champ, recalculer les pr√©visions
    input.addEventListener('blur', () => {
      if (!input.hasAttribute('readonly')) {
        // Formater l'affichage
        formatMetricInput(input);

        // R√©g√©n√©rer les pr√©visions avec les nouveaux param√®tres
        regeneratePlanForecasts();
      }
    });
  });
}

// R√©g√©n√©rer uniquement les pr√©visions sans perdre les donn√©es r√©elles
async function regeneratePlanForecasts() {
  const weeks = 52; // Doit correspondre √† generatePlanWeeks() et calculatePlan()

  // R√©cup√©rer les param√®tres utilisateur
  const objectif = parseFloat(document.getElementById('plan-objectif')?.dataset.value) || 0;
  const contratMoyen = parseFloat(document.getElementById('plan-cm-prev')?.dataset.value) || 2500;
  const ratioMktg = parseFloat(document.getElementById('plan-ratio-mktg')?.dataset.value) || 85;
  const tauxVente = parseFloat(document.getElementById('plan-taux-vente')?.dataset.value) || 30;

  // Utiliser EXACTEMENT le m√™me pattern que generatePlanWeeks() (52 semaines)
  // IMPORTANT: Doit √™tre identique pour que totalIntensity soit le m√™me!
  const intensityPattern = [
    0,  // Index 0: 5-11 janv 2026 (semaine vide)
    0.5, 2.0, 2.0,  // Index 1-3: 12 janv - 1 f√©v
    3.0, 2.5, 3.0, 3.0,  // Index 4-7: 2 f√©v - 1 mars (2-8 f√©v: +0.5% = 3.0%)
    3.5, 4.0, 4.5, 5.5,  // Index 8-11: 2 mars - 29 mars
    4.5, 6.5, 5.5, 6.0, 6.0,  // Index 12-16: 30 mars - 4 mai
    4.5, 4.5, 4.5, 4.5,  // Index 17-20: 5 mai - 1 juin
    3.5, 4.0, 3.5, 3.0,  // Index 21-24: 2 juin - 29 juin
    3.0, 3.0, 3.0, 2.0, 1.0,  // Index 25-29: 30 juin - 3 ao√ªt
    1.0, 1.0, 1.0, 1.0,  // Index 30-33: 4 ao√ªt - 31 ao√ªt
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  // Index 34-51: reste (0%)
  ];

  // Calculer le total d'intensit√© pour distribuer l'objectif (exclure les semaines cach√©es = -1)
  const totalIntensity = intensityPattern.reduce((sum, val) => sum + (val > 0 ? val : 0), 0);

  // Calculer les patterns dynamiquement
  const mktgPattern = [];
  const estimPattern = [];
  const contratPattern = [];
  const dollarPattern = [];

  for (let i = 0; i < weeks; i++) {
    const intensity = intensityPattern[i];

    if (intensity === 0 || intensity === -1) {
      mktgPattern.push(0);
      estimPattern.push(0);
      contratPattern.push(0);
      dollarPattern.push(0);
    } else {
      // Calculer $ sign√© pour cette semaine bas√© sur l'intensit√© (avec +10% distribu√© uniform√©ment)
      const dollarSemaine = ((objectif * 1.10) / totalIntensity) * intensity;
      dollarPattern.push(Math.round(dollarSemaine));

      // Calculer nombre de contrats ($ sign√© / contrat moyen)
      const nbContrats = dollarSemaine / contratMoyen;
      contratPattern.push(parseFloat(nbContrats.toFixed(1)));

      // Calculer estimations (contrats / taux de vente)
      const nbEstimations = nbContrats / (tauxVente / 100);
      estimPattern.push(Math.round(nbEstimations));

      // Calculer heures marketing (estimations / ratio marketing)
      const heuresMarketing = nbEstimations / (ratioMktg / 100);
      mktgPattern.push(parseFloat(heuresMarketing.toFixed(1)));
    }
  }

  // V√©rifier le total calcul√©
  const totalDollarCalcule = dollarPattern.reduce((sum, val) => sum + val, 0);

  // Ajuster la derni√®re valeur non nulle pour corriger les erreurs d'arrondi
  const objectifAvecMarge = objectif * 1.10;
  const diffDollar = objectifAvecMarge - totalDollarCalcule;
  if (diffDollar !== 0) {
    for (let i = dollarPattern.length - 1; i >= 0; i--) {
      if (dollarPattern[i] > 0) {
        dollarPattern[i] += diffDollar;
        break;
      }
    }
  }

  // Mettre √† jour uniquement les colonnes de pr√©vision (pas les r√©elles)
  for (let i = 1; i <= weeks; i++) {
    // Valeurs selon les patterns du CSV
    const mktgVal = mktgPattern[i - 1] || 0;
    const estimVal = estimPattern[i - 1] || 0;
    const contratVal = contratPattern[i - 1] || 0;
    const dollarVal = dollarPattern[i - 1] || 0;

    // Trouver les cellules de pr√©vision dans le tableau
    const row = document.querySelector(`#plan-w${i}-mktg-reel`)?.closest('tr');
    if (row) {
      const cells = row.querySelectorAll('td');
      // Les colonnes de pr√©vision sont: 1 (mktg), 4 (estim), 8 (contrat), 11 (dollar)
      // IMPORTANT: Ne PAS toucher aux colonnes R√âEL (2, 5, 9, 12) qui sont des inputs li√©s √† RPO hebdo!
      if (cells[1]) cells[1].textContent = mktgVal.toFixed(1) + ' h';
      if (cells[4]) cells[4].textContent = estimVal;
      if (cells[8]) cells[8].textContent = contratVal;
      if (cells[11]) cells[11].textContent = dollarVal.toLocaleString('fr-CA') + ' $';
    }
  }

  // Recalculer les cumuls avec les nouvelles donn√©es
  calculatePlan();
}

// ============================================
// ACCOUNT DROPDOWN
// ============================================

// Toggle du dropdown de compte
document.addEventListener('DOMContentLoaded', () => {
  const toggleBtn = document.getElementById('account-dropdown-toggle');
  const dropdown = document.getElementById('account-dropdown');

  if (toggleBtn && dropdown) {
    toggleBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      dropdown.classList.toggle('hidden');
    });

    // Fermer le dropdown en cliquant ailleurs
    document.addEventListener('click', (e) => {
      if (!dropdown.contains(e.target) && !toggleBtn.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    });
  }
});

// Fonction de d√©connexion
function logout() {
  // Nettoyer le localStorage et sessionStorage
  localStorage.clear();
  sessionStorage.clear();

  // Rediriger vers la page de connexion
  window.location.href = '/';
}

// ========================================
// SYST√àME D'√âDITION √âTATS DES R√âSULTATS
// ========================================

// Fonction pour parser une valeur mon√©taire (supporte formats fran√ßais et anglais)
function parseMoneyValue(value) {
  if (typeof value === 'number') return value;
  if (!value || value === '-') return 0;

  // Convertir en string et enlever $, espaces, etc.
  let cleaned = String(value).trim();

  // D√©tecter le format: si contient √† la fois espace et virgule, c'est du fran√ßais (ex: "2 000,00 $")
  if (cleaned.includes(' ') && cleaned.includes(',')) {
    // Format fran√ßais: "2 000,00 $" -> enlever espaces et remplacer virgule par point
    cleaned = cleaned.replace(/\s/g, '').replace(/[^\d,]/g, '').replace(',', '.');
  } else {
    // Format anglais ou simple: "2,000.00" ou "2000"
    cleaned = cleaned.replace(/[^\d.,-]/g, '').replace(/,/g, '');
  }

  return parseFloat(cleaned) || 0;
}

// Fonction pour formater une valeur en montant ("150000" -> "150 000,00$")
function formatMoneyValue(value) {
  const number = parseFloat(value) || 0;
  return number.toLocaleString('fr-FR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }) + ' $';
}

// Fonction pour formater un pourcentage
function formatPercentValue(value) {
  const number = parseFloat(value) || 0;
  return number.toFixed(2) + '%';
}

// Charger le chiffre d'affaires depuis les donn√©es weekly (somme des $ sign√©s)
async function loadChiffreAffaires() {
  log('üìä Chargement CA depuis weekly data ($ SIGN√â)');

  try {
    // Calculer le CA directement depuis window.weeklyData pour √©viter le doublement
    let caActuel = 0;
    if (window.weeklyData) {
      // Seulement les mois 0-11 (ann√©e 2026, pas d√©cembre 2025)
      for (let monthIndex = 0; monthIndex <= 11; monthIndex++) {
        const monthKey = String(monthIndex);
        const monthWeeklyData = window.weeklyData[monthKey];
        if (monthWeeklyData) {
          Object.keys(monthWeeklyData).forEach(weekNumber => {
            const weekData = monthWeeklyData[weekNumber];
            if (weekData.dollar !== '-' && weekData.dollar !== undefined) {
              caActuel += parseFloat(weekData.dollar) || 0;
            }
          });
        }
      }
    }
    log('   CA sign√© (calcul√© depuis weekly): ' + caActuel + '$');

    // Mettre √† jour la cellule Ventes Actuel (Montant)
    const ventesActuelCell = document.querySelector('[data-category="ventes"][data-field="actuel-montant"]');

    if (ventesActuelCell) {
      const formattedValue = formatMoneyValue(caActuel);
      ventesActuelCell.textContent = formattedValue;
      log('   ‚úì Ventes Actuel mis √† jour: ' + formattedValue);
    } else {
      error('[ERROR] ventesActuelCell NOT FOUND!');
    }

    // Mettre √† jour le pourcentage Actuel (toujours 100%)
    const ventesPercentCell = document.querySelector('[data-category="ventes"][data-field="actuel-percent"]');

    if (ventesPercentCell) {
      ventesPercentCell.textContent = '100%';
      log('   ‚úì Ventes % toujours 100%');
    }

    // Recalculer les totaux et √©carts
    updateAllCalculations();

    log('‚úÖ Chiffre d\'affaires charg√©:', caActuel + '$');
  } catch (error) {
    error('[ERROR] Erreur lors du chargement du CA:', error);
  }
}

// Calculer l'√©cart entre Budget/CIBL√â et Actuel pour une cat√©gorie
function calculateEcart(category) {
  // R√©cup√©rer les cellules Budget/CIBL√â et Actuel
  let budgetCell = document.querySelector(`[data-category="${category}"][data-field="budget-montant"]`);

  // Si budget-montant n'existe pas, utiliser cible-montant (pour les d√©penses avec inputs CIBL√â)
  if (!budgetCell) {
    budgetCell = document.querySelector(`[data-category="${category}"][data-field="cible-montant"]`);
  }

  const actuelCell = document.querySelector(`[data-category="${category}"][data-field="actuel-montant"]`);

  if (!budgetCell || !actuelCell) return { montant: 0, percent: 0 };

  // Extraire la valeur Budget/CIBL√â (peut √™tre dans un input ou directement dans le textContent)
  const budgetInput = budgetCell.querySelector('input');
  const budget = parseMoneyValue(budgetInput ? budgetInput.value : budgetCell.textContent);

  // Extraire la valeur Actuel
  const actuelInput = actuelCell.querySelector('input');
  const actuel = parseMoneyValue(actuelInput ? actuelInput.value : actuelCell.textContent);

  // Pour les revenus: √©cart = actuel - budget (positif si on d√©passe l'objectif)
  // Pour les d√©penses: √©cart = budget - actuel (positif si on d√©pense moins que pr√©vu)
  const isRevenue = category === 'ventes';
  const ecartMontant = isRevenue ? (actuel - budget) : (budget - actuel);

  // Calculer le pourcentage d'√©cart
  let ecartPercent = 0;
  if (budget !== 0) {
    ecartPercent = (ecartMontant / budget) * 100;
  }

  return { montant: ecartMontant, percent: ecartPercent };
}

// Mettre √† jour les cellules √âCART avec les couleurs appropri√©es
function updateEcartCell(category) {
  const ecart = calculateEcart(category);

  // R√©cup√©rer les cellules √âCART
  const ecartMontantCell = document.querySelector(`[data-category="${category}"][data-field="ecart-montant"]`);
  const ecartPercentCell = document.querySelector(`[data-category="${category}"][data-field="ecart-percent"]`);

  if (!ecartMontantCell || !ecartPercentCell) return;

  // Ne pas afficher d'√©cart pour Ventes (laisser vide)
  if (category === 'ventes') {
    ecartMontantCell.textContent = '';
    ecartPercentCell.textContent = '';
    ecartMontantCell.style.background = 'rgba(15, 23, 42, 0.35)';
    ecartPercentCell.style.background = 'rgba(15, 23, 42, 0.35)';
    return;
  }

  // Pas d'√©cart pour Total des d√©penses et PROFIT (laisser vide)
  if (category === 'total-depenses' || category === 'profit') {
    ecartMontantCell.textContent = '';
    ecartPercentCell.textContent = '';
    ecartMontantCell.style.background = '';
    ecartPercentCell.style.background = '';
    return;
  }

  // Mettre √† jour le contenu
  ecartMontantCell.textContent = formatMoneyValue(ecart.montant);
  ecartPercentCell.textContent = formatPercentValue(ecart.percent);

  // D√©terminer la couleur selon le signe de l'√©cart (pour les d√©penses seulement)
  let backgroundColor = '';
  if (ecart.montant > 0) {
    backgroundColor = 'rgba(34, 197, 94, 0.2)'; // Vert pour positif
  } else if (ecart.montant < 0) {
    backgroundColor = 'rgba(239, 68, 68, 0.2)'; // Rouge pour n√©gatif
  } else {
    backgroundColor = 'rgba(15, 23, 42, 0.35)'; // Gris pour z√©ro
  }

  ecartMontantCell.style.background = backgroundColor;
  ecartPercentCell.style.background = backgroundColor;
}

// Calculer et afficher le TOTAL √âCART
function calculateTotalEcart() {
  const categories = [
    'assurance-qe', 'concours', 'essence', 'entretien-voiture',
    'fourniture-bureau', 'frais-bancaires', 'frais-cellulaire',
    'frais-garanties', 'leads', 'peinture', 'petits-outils',
    'repas', 'redevances', 'salaire-peintres', 'salaires-representant'
  ];

  let totalEcartMontant = 0;

  // Sommer tous les √©carts des d√©penses
  categories.forEach(category => {
    const ecart = calculateEcart(category);
    totalEcartMontant += ecart.montant;
  });

  // R√©cup√©rer les Ventes Budget
  const ventesBudgetCell = document.querySelector('[data-category="ventes"][data-field="budget-montant"]');
  const ventesBudget = parseMoneyValue(ventesBudgetCell?.textContent || '0');

  // Calculer le pourcentage total d'√©cart
  const totalEcartPercent = ventesBudget > 0 ? (totalEcartMontant / ventesBudget) * 100 : 0;

  // Mettre √† jour les cellules TOTAL √âCART
  const totalEcartMontantCell = document.querySelector('[data-category="total-ecart"][data-field="ecart-montant"]');
  const totalEcartPercentCell = document.querySelector('[data-category="total-ecart"][data-field="ecart-percent"]');

  if (totalEcartMontantCell) {
    totalEcartMontantCell.textContent = formatMoneyValue(totalEcartMontant);

    // Couleur selon le signe
    if (totalEcartMontant > 0) {
      totalEcartMontantCell.style.color = '#22c55e'; // Vert
    } else if (totalEcartMontant < 0) {
      totalEcartMontantCell.style.color = '#ef4444'; // Rouge
    } else {
      totalEcartMontantCell.style.color = 'var(--text-light)';
    }
  }

  if (totalEcartPercentCell) {
    totalEcartPercentCell.textContent = formatPercentValue(totalEcartPercent);

    // Couleur selon le signe
    if (totalEcartMontant > 0) {
      totalEcartPercentCell.style.color = '#22c55e'; // Vert
    } else if (totalEcartMontant < 0) {
      totalEcartPercentCell.style.color = '#ef4444'; // Rouge
    } else {
      totalEcartPercentCell.style.color = 'var(--text-light)';
    }
  }

  log('[DATA] Total √âcart calcul√©:', totalEcartMontant, totalEcartPercent + '%');
}

// Recalculer les totaux (Total des d√©penses et PROFIT)
function calculateTotals() {
  const categories = [
    'assurance-qe', 'concours', 'essence', 'entretien-voiture',
    'fourniture-bureau', 'frais-bancaires', 'frais-cellulaire',
    'frais-garanties', 'leads', 'peinture', 'petits-outils',
    'repas', 'redevances', 'salaire-peintres', 'salaires-representant'
  ];

  // R√©cup√©rer les Ventes Actuel et Budget
  const ventesActuelCell = document.querySelector('[data-category="ventes"][data-field="actuel-montant"]');
  const ventesActuel = parseMoneyValue(ventesActuelCell?.textContent || '0');
  const ventesBudgetCell = document.querySelector('[data-category="ventes"][data-field="budget-montant"]');
  const ventesBudget = parseMoneyValue(ventesBudgetCell?.textContent || '0');

  // Mettre √† jour le pourcentage des ventes (toujours 100%)
  const ventesPercentCell = document.querySelector('[data-category="ventes"][data-field="actuel-percent"]');
  if (ventesPercentCell) {
    ventesPercentCell.textContent = '100%';
  }

  // Calculer le total des d√©penses actuelles
  let totalDepensesActuel = 0;
  categories.forEach(category => {
    const cell = document.querySelector(`[data-category="${category}"][data-field="actuel-montant"]`);
    if (cell) {
      const input = cell.querySelector('input');
      const montantActuel = parseMoneyValue(input ? input.value : cell.textContent);
      totalDepensesActuel += montantActuel;

      // Mettre √† jour le pourcentage actuel de cette cat√©gorie
      const percentCell = document.querySelector(`[data-category="${category}"][data-field="actuel-percent"]`);
      if (percentCell && ventesActuel > 0) {
        const percent = (montantActuel / ventesActuel) * 100;
        percentCell.textContent = formatPercentValue(percent);
      } else if (percentCell) {
        percentCell.textContent = '0%';
      }
    }
  });

  // Mettre √† jour Total des d√©penses Actuel
  const totalDepensesCell = document.querySelector('[data-category="total-depenses"][data-field="actuel-montant"]');
  const totalDepensesPercentCell = document.querySelector('[data-category="total-depenses"][data-field="actuel-percent"]');
  if (totalDepensesCell) {
    totalDepensesCell.textContent = formatMoneyValue(totalDepensesActuel);
  }
  if (totalDepensesPercentCell && ventesActuel > 0) {
    const percent = (totalDepensesActuel / ventesActuel) * 100;
    totalDepensesPercentCell.textContent = formatPercentValue(percent);
  }

  // Calculer le PROFIT Actuel
  const profitActuel = ventesActuel - totalDepensesActuel;

  // Mettre √† jour PROFIT Actuel
  const profitCell = document.querySelector('[data-category="profit"][data-field="actuel-montant"]');
  const profitPercentCell = document.querySelector('[data-category="profit"][data-field="actuel-percent"]');
  if (profitCell) {
    profitCell.textContent = formatMoneyValue(profitActuel);
  }
  if (profitPercentCell && ventesActuel > 0) {
    const percent = (profitActuel / ventesActuel) * 100;
    profitPercentCell.textContent = formatPercentValue(percent);
  }
}

// Mettre √† jour tous les calculs (√©carts + totaux)
function updateAllCalculations(saveData = false) {
  const allCategories = [
    'ventes', 'assurance-qe', 'concours', 'essence', 'entretien-voiture',
    'fourniture-bureau', 'frais-bancaires', 'frais-cellulaire',
    'frais-garanties', 'leads', 'peinture', 'petits-outils',
    'repas', 'redevances', 'salaire-peintres', 'salaires-representant',
    'total-depenses', 'profit'
  ];

  // Calculer tous les √©carts (y compris total-depenses et profit)
  allCategories.forEach(category => {
    updateEcartCell(category);
  });

  // Calculer le total des √©carts
  calculateTotalEcart();

  // Recalculer les totaux
  calculateTotals();

  // Synchroniser les % vers les spans mobile
  if (typeof syncMobilePercents === 'function') {
    syncMobilePercents();
  }

  // Sauvegarder les donn√©es SEULEMENT si demand√© explicitement
  // (pas lors du chargement initial pour ne pas √©craser les donn√©es sauvegard√©es)
  if (saveData) {
    saveEtatsResultatsData();
  }
}

// Sauvegarder les donn√©es Actuel dans le backend
async function saveEtatsResultatsData() {
  const username = getCurrentUsername();
  const actuelData = {};
  const cibleData = {};

  // Sauvegarder toutes les valeurs Actuel (sauf Ventes, Total d√©penses et Profit)
  const allActuelCells = document.querySelectorAll('[data-field="actuel-montant"]');
  log(`üíæ Nombre total de cellules Actuel trouv√©es: ${allActuelCells.length}`);

  allActuelCells.forEach(cell => {
    const category = cell.getAttribute('data-category');
    // Ne pas sauvegarder Ventes (vient du dashboard), Total d√©penses et Profit (calcul√©s)
    if (category !== 'ventes' && category !== 'total-depenses' && category !== 'profit') {
      const input = cell.querySelector('input');
      const value = parseMoneyValue(input ? input.value : cell.textContent);
      actuelData[category] = value;
      log(`   ‚úì Actuel ${category}: ${value}`);
    }
  });

  // Sauvegarder toutes les valeurs CIBL√â (sauf Total d√©penses, Profit, et cat√©gories non-√©ditables)
  const allCibleInputs = document.querySelectorAll('.etats-resultats-cible-input');
  const nonEditableCategories = ['ventes', 'profit', 'total-ecart', 'total-depenses', 'assurance-qe', 'frais-garanties', 'redevances'];
  log(`üíæ Nombre total d'inputs CIBL√â trouv√©s: ${allCibleInputs.length}`);

  allCibleInputs.forEach(input => {
    const category = input.closest('td')?.getAttribute('data-category');
    // Ne pas sauvegarder: total-depenses, profit, et les cat√©gories non-√©ditables
    if (category &&
        category !== 'total-depenses' &&
        category !== 'profit' &&
        !nonEditableCategories.includes(category)) {
      const value = parseMoneyValue(input.value);
      cibleData[category] = value;
      log(`   ‚úì CIBL√â ${category}: ${value}`);
    } else if (category) {
      log(`   ‚ö†Ô∏è CIBL√â ${category}: ignor√© (${nonEditableCategories.includes(category) ? 'non-√©ditable' : 'calcul√©'})`);
    }
  });

  try {
    // DEBUG: Log what we're about to send
    console.log('üíæ [SAVE DEBUG] window.customBudgetPercent:', window.customBudgetPercent);
    console.log('üíæ [SAVE DEBUG] cible_percent to send:', window.customBudgetPercent || {});

    const response = await fetch(`/api/etats-resultats/actuel/${username}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        actuel_data: actuelData,
        cible_data: cibleData,
        cible_percent: window.customBudgetPercent || {}
      })
    });

    if (!response.ok) {
      throw new Error('Erreur lors de la sauvegarde');
    }

    log('üíæ Donn√©es Actuel et CIBL√â sauvegard√©es dans le backend:', { actuelData, cibleData, cible_percent: window.customBudgetPercent });
  } catch (error) {
    error('[ERROR] Erreur lors de la sauvegarde des donn√©es:', error);
  }
}

// ========================================
// CALCUL DYNAMIQUE DES REDEVANCES
// ========================================

/**
 * Calcule le pourcentage de redevance selon le grade et le CA annuel
 * @param {string} grade - Grade de l'entrepreneur (recrue, senior1, senior2, senior3)
 * @param {number} ca - Chiffre d'affaires annuel
 * @returns {number} Pourcentage de redevance
 */
function calculateRedevancePercent(grade, ca) {
  // Par d√©faut 20% si grade non d√©fini
  if (!grade) {
    return 20;
  }

  // RECRUES
  if (grade === 'recrue') {
    if (ca >= 125000) return 15;
    if (ca >= 100000) return 20;
    if (ca >= 50000) return 22;
    return 24; // 0-50k
  }

  // SENIORS (tous niveaux)
  if (grade === 'senior1' || grade === 'senior2' || grade === 'senior3') {
    if (ca >= 300000) return 0;
    if (ca >= 200000) return 3;
    if (ca >= 150000) return 7.5;
    if (ca >= 75000) return 15;
    return 22; // 0-75k
  }

  // Fallback
  return 20;
}

/**
 * Met √† jour le pourcentage de redevance dans le tableau Budget
 */
async function updateRedevancePercent() {
  try {
    const username = getCurrentUsername();

    // R√©cup√©rer le grade de l'utilisateur
    const infoResponse = await fetch(`/api/get-info/${username}`);
    if (!infoResponse.ok) {
      log('[WARN] Impossible de r√©cup√©rer le grade, utilisation de 20%');
      return;
    }

    const infoData = await infoResponse.json();
    const userGrade = infoData.data?.grade;

    // R√©cup√©rer le CA (Ventes Budget)
    const ventesBudgetCell = document.querySelector('[data-category="ventes"][data-field="budget-montant"]');
    const ventesBudget = parseMoneyValue(ventesBudgetCell?.textContent || '0');

    // Calculer le pourcentage
    const redevancePercent = calculateRedevancePercent(userGrade, ventesBudget);

    // Mettre √† jour le pourcentage dans le tableau (cible-percent)
    const redevanceCiblePercentCell = document.querySelector('[data-category="redevances"][data-field="cible-percent"]');
    if (redevanceCiblePercentCell) {
      redevanceCiblePercentCell.textContent = formatPercentValue(redevancePercent);
      log(`[REDEVANCE] ${userGrade} | CA: ${ventesBudget}$ | Taux: ${redevancePercent}%`);
    }

    // Mettre √† jour le montant cible des redevances
    const redevanceCibleMontantCell = document.querySelector('[data-category="redevances"][data-field="cible-montant"] input');
    if (redevanceCibleMontantCell) {
      const redevanceMontant = Math.round(ventesBudget * redevancePercent / 100);
      redevanceCibleMontantCell.value = formatMoneyValue(redevanceMontant);
      log(`[REDEVANCE] Montant cible: ${redevanceMontant}$`);
    }

  } catch (error) {
    error('[ERROR] Erreur calcul redevance:', error);
  }
}

// Charger les donn√©es Actuel depuis le backend
async function loadEtatsResultatsData() {
  log('üîÑ [LOAD] D√©but de loadEtatsResultatsData()');

  const username = getCurrentUsername();
  log(`üîÑ [LOAD] Username: ${username}`);

  try {
    log(`üîÑ [LOAD] Fetch de /api/etats-resultats/actuel/${username}`);
    const response = await fetch(`/api/etats-resultats/actuel/${username}`);
    log(`üîÑ [LOAD] Response re√ßue, status: ${response.status}`);

    if (!response.ok) {
      log('‚ÑπÔ∏è Aucune donn√©e Actuel/CIBL√â sauvegard√©e (status not OK)');
      return;
    }

    log('üîÑ [LOAD] Parsing JSON...');
    const result = await response.json();
    log('üîÑ [LOAD] JSON pars√©:', result);
    log('üîÑ [LOAD] actuel_data brut:', JSON.stringify(result.actuel_data));
    log('üîÑ [LOAD] cible_data brut:', JSON.stringify(result.cible_data));

    const actuelData = result.actuel_data || {};
    const cibleData = result.cible_data || {};
    const ciblePercent = result.cible_percent || {};

    // Charger les % CIBL√â personnalis√©s dans la variable globale
    window.customBudgetPercent = ciblePercent;
    log(`üîÑ [LOAD] actuelData keys: ${Object.keys(actuelData).length}, cibleData keys: ${Object.keys(cibleData).length}, ciblePercent keys: ${Object.keys(ciblePercent).length}`);
    log(`üîÑ [LOAD] actuelData contenu:`, actuelData);
    log(`üîÑ [LOAD] ciblePercent contenu:`, ciblePercent);

    // Restaurer toutes les valeurs Actuel
    let actuelCount = 0;
    Object.keys(actuelData).forEach(category => {
      const cell = document.querySelector(`[data-category="${category}"][data-field="actuel-montant"]`);
      log(`üîÑ [LOAD] Restauration ${category}: cell trouv√©e? ${!!cell}, valeur √† restaurer: ${actuelData[category]}`);
      if (cell) {
        const input = cell.querySelector('input');
        if (input) {
          const formattedValue = formatMoneyValue(actuelData[category]);
          log(`üîÑ [LOAD]   -> input trouv√©, nouvelle valeur: ${formattedValue}`);
          input.value = formattedValue;
          actuelCount++;
        } else {
          const formattedValue = formatMoneyValue(actuelData[category]);
          log(`üîÑ [LOAD]   -> pas d'input, textContent: ${formattedValue}`);
          cell.textContent = formattedValue;
          actuelCount++;
        }
      } else {
        log(`üîÑ [LOAD]   -> CELL NON TROUV√âE pour ${category}`);
      }
    });

    // Restaurer toutes les valeurs CIBL√â
    let cibleCount = 0;
    Object.keys(cibleData).forEach(category => {
      const input = document.querySelector(`td[data-category="${category}"][data-field="cible-montant"] .etats-resultats-cible-input`);
      if (input) {
        input.value = formatMoneyValue(cibleData[category]);
        cibleCount++;
        log(`   ‚úì CIBL√â ${category}: ${formatMoneyValue(cibleData[category])}`);
      } else {
        log(`   ‚ö†Ô∏è CIBL√â ${category}: input non trouv√©`);
      }
    });

    log(`üìÇ Donn√©es charg√©es - ${actuelCount} Actuel, ${cibleCount} CIBL√â`);
    log('   Actuel:', actuelData);
    log('   CIBL√â:', cibleData);
    log('   CIBL√â %:', ciblePercent);

    // Afficher les % CIBL√â charg√©s dans les cellules (sans recalculer les montants)
    log('üîÑ [LOAD] Affichage des % CIBL√â charg√©s...');
    displayLoadedCiblePercents();

    // Recalculer les totaux (sans √©craser les montants Actuel charg√©s)
    log('üîÑ [LOAD] Appel de recalculateTotalsOnly()');
    recalculateTotalsOnly();
    log('‚úÖ [LOAD] loadEtatsResultatsData() termin√©e avec succ√®s');
  } catch (error) {
    error('‚ùå [ERROR] Erreur lors du chargement des donn√©es:', error);
    error('‚ùå [ERROR] Stack:', error.stack);
    throw error;
  }
}

// Afficher les % CIBL√â charg√©s depuis le backend (sans recalculer les montants)
function displayLoadedCiblePercents() {
  const categories = [
    'assurance-qe', 'concours', 'essence', 'entretien-voiture',
    'fourniture-bureau', 'frais-bancaires', 'frais-cellulaire',
    'frais-garanties', 'leads', 'peinture', 'petits-outils',
    'repas', 'redevances', 'salaire-peintres', 'salaires-representant'
  ];

  categories.forEach(category => {
    // R√©cup√©rer le % depuis window.customBudgetPercent ou utiliser le d√©faut
    let percent = window.customBudgetPercent?.[category];

    // Si pas de % personnalis√©, utiliser le d√©faut
    if (percent === undefined || percent === null) {
      percent = DEFAULT_CIBLE_PERCENT?.[category] ?? 0;
    }

    // Mettre √† jour la cellule %
    const percentCell = document.querySelector(`[data-category="${category}"][data-field="cible-percent"]`);
    if (percentCell) {
      percentCell.textContent = formatPercentValue(percent);
      // Colorier en rouge si > 0
      if (percent > 0) {
        percentCell.style.color = '#ef4444';
      } else {
        percentCell.style.color = 'var(--text-gray)';
      }
      log(`   ‚úì ${category}: ${formatPercentValue(percent)}`);
    }
  });

  // Calculer et afficher le total des d√©penses %
  let totalDepensesPercent = 0;
  categories.forEach(category => {
    if (category !== 'redevances') { // Redevances est calcul√© s√©par√©ment
      const percent = window.customBudgetPercent?.[category] ?? DEFAULT_CIBLE_PERCENT?.[category] ?? 0;
      totalDepensesPercent += percent;
    }
  });

  // Ajouter redevances au total
  const redevanceInput = document.querySelector('td[data-category="redevances"][data-field="cible-montant"] input');
  const objectifCAInput = document.getElementById('objectifCA');
  const objectifCA = parseFloat(objectifCAInput?.dataset?.value) || parseMoneyValue(objectifCAInput?.value) || 0;
  if (redevanceInput && objectifCA > 0) {
    const redevanceMontant = parseMoneyValue(redevanceInput.value);
    const redevancePercent = (redevanceMontant / objectifCA) * 100;
    totalDepensesPercent += redevancePercent;
  }

  const totalDepensesPercentCell = document.querySelector('[data-category="total-depenses"][data-field="cible-percent"]');
  if (totalDepensesPercentCell) {
    totalDepensesPercentCell.textContent = formatPercentValue(totalDepensesPercent);
  }

  // Calculer et afficher le profit %
  const profitPercent = 100 - totalDepensesPercent;
  const profitPercentCell = document.querySelector('[data-category="profit"][data-field="cible-percent"]');
  if (profitPercentCell) {
    profitPercentCell.textContent = formatPercentValue(profitPercent);
    profitPercentCell.style.color = profitPercent >= 0 ? '#10b981' : '#ef4444';
  }

  log('‚úÖ [LOAD] % CIBL√â affich√©s depuis les donn√©es charg√©es');
}

// Sauvegarder les donn√©es Budget dans le backend
async function saveBudgetData() {
  const username = getCurrentUsername();
  const data = {};

  // Sauvegarder tous les pourcentages Budget (sauf Ventes qui vient de objectifCA et sauf Redevances qui est dynamique)
  const allCells = document.querySelectorAll('[data-field="budget-percent"][contenteditable="true"]');
  allCells.forEach(cell => {
    const category = cell.getAttribute('data-category');

    // Ne PAS sauvegarder les redevances car elles sont calcul√©es dynamiquement
    if (category === 'redevances') {
      log('[INFO] Redevances exclues de la sauvegarde (calcul dynamique)');
      return;
    }

    const percentText = cell.textContent.replace('%', '').trim();
    const value = parseFloat(percentText) || 0;
    data[category] = value;
  });

  try {
    const response = await fetch(`/api/etats-resultats/budget/${username}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ budget_percent_data: data })
    });

    if (!response.ok) {
      throw new Error('Erreur lors de la sauvegarde');
    }

    log('üíæ Budget % sauvegard√© dans le backend:', data);
  } catch (error) {
    error('[ERROR] Erreur lors de la sauvegarde du budget:', error);
  }
}

// Charger les donn√©es Budget depuis le backend
async function loadBudgetData() {
  const username = getCurrentUsername();

  try {
    const response = await fetch(`/api/etats-resultats/budget/${username}`);

    if (!response.ok) {
      log('‚ÑπÔ∏è Aucune donn√©e Budget sauvegard√©e');
      return;
    }

    const result = await response.json();
    const data = result.budget_percent_data || {};

    // Restaurer tous les pourcentages Budget (SAUF redevances qui est calcul√© dynamiquement)
    Object.keys(data).forEach(category => {
      // Ignorer les redevances car elles sont calcul√©es dynamiquement selon le grade
      if (category === 'redevances') {
        log('[INFO] Redevances ignor√©es lors du chargement (calcul dynamique activ√©)');
        return;
      }

      const percentCell = document.querySelector(`[data-category="${category}"][data-field="budget-percent"]`);
      if (percentCell && percentCell.hasAttribute('contenteditable')) {
        percentCell.textContent = formatPercentValue(data[category]);

        // Calculer le montant Budget
        const ventesBudgetCell = document.querySelector('[data-category="ventes"][data-field="budget-montant"]');
        const ventesBudget = parseMoneyValue(ventesBudgetCell?.textContent || '0');

        const montantCell = document.querySelector(`[data-category="${category}"][data-field="budget-montant"]`);
        if (montantCell && ventesBudget > 0) {
          const montant = (ventesBudget * data[category]) / 100;
          montantCell.textContent = formatMoneyValue(montant);
        }
      }
    });

    log('üìÇ Budget % charg√© depuis le backend:', data);

    // Mettre √† jour le pourcentage de redevance selon le grade (TOUJOURS calcul√© dynamiquement)
    await updateRedevancePercent();
  } catch (error) {
    error('[ERROR] Erreur lors du chargement du budget:', error);
  }
}

// Synchroniser Objectif CA avec Ventes Budget
function syncObjectifCAWithVentesBudget() {
  const objectifCAInput = document.getElementById('objectifCA');
  const ventesBudgetCell = document.querySelector('[data-category="ventes"][data-field="budget-montant"]');

  if (!objectifCAInput || !ventesBudgetCell) return;

  // R√©cup√©rer la valeur de objectifCA (data-value contient le nombre brut)
  const objectifValue = parseFloat(objectifCAInput.dataset.value) || 0;

  // Mettre √† jour la cellule Ventes Budget
  ventesBudgetCell.textContent = formatMoneyValue(objectifValue);

  // Mettre √† jour le pourcentage Budget (100% car c'est la cible de r√©f√©rence)
  const ventesBudgetPercentCell = document.querySelector('[data-category="ventes"][data-field="budget-percent"]');
  if (ventesBudgetPercentCell && objectifValue > 0) {
    ventesBudgetPercentCell.textContent = '100%';
  }

  // Mettre √† jour le pourcentage de redevance selon le grade et le nouveau CA
  updateRedevancePercent().then(() => {
    // Recalculer tous les montants Budget bas√©s sur les pourcentages et le nouveau total
    recalculateBudgetAmounts();

    // Recalculer les totaux
    calculateBudgetTotals();
  });

  log('üîÑ Objectif CA synchronis√© avec Ventes Budget:', objectifValue);
}

// Recalculer tous les montants Budget √† partir des pourcentages
function recalculateBudgetAmounts() {
  const ventesBudgetCell = document.querySelector('[data-category="ventes"][data-field="budget-montant"]');
  const ventesBudget = parseMoneyValue(ventesBudgetCell?.textContent || '0');

  const categories = [
    'assurance-qe', 'concours', 'essence', 'entretien-voiture',
    'fourniture-bureau', 'frais-bancaires', 'frais-cellulaire',
    'frais-garanties', 'leads', 'peinture', 'petits-outils',
    'repas', 'redevances', 'salaire-peintres', 'salaires-representant'
  ];

  categories.forEach(category => {
    const percentCell = document.querySelector(`[data-category="${category}"][data-field="budget-percent"]`);
    const montantCell = document.querySelector(`[data-category="${category}"][data-field="budget-montant"]`);

    if (percentCell && montantCell) {
      const percentText = percentCell.textContent.replace('%', '').trim();
      const percent = parseFloat(percentText) || 0;

      // Si Ventes Budget = 0, tous les montants Budget = 0
      const montant = ventesBudget === 0 ? 0 : (ventesBudget * percent) / 100;
      montantCell.textContent = formatMoneyValue(montant);
    }
  });

  log('üîÑ Montants Budget recalcul√©s, Ventes Budget:', ventesBudget);
}

// Recalculer les totaux Budget (Total des d√©penses et PROFIT)
function calculateBudgetTotals() {
  const categories = [
    'assurance-qe', 'concours', 'essence', 'entretien-voiture',
    'fourniture-bureau', 'frais-bancaires', 'frais-cellulaire',
    'frais-garanties', 'leads', 'peinture', 'petits-outils',
    'repas', 'redevances', 'salaire-peintres', 'salaires-representant'
  ];

  // R√©cup√©rer les Ventes Budget
  const ventesBudgetCell = document.querySelector('[data-category="ventes"][data-field="budget-montant"]');
  const ventesBudget = parseMoneyValue(ventesBudgetCell?.textContent || '0');

  // Calculer le total des d√©penses budg√©t√©es
  let totalDepensesBudget = 0;
  categories.forEach(category => {
    const cell = document.querySelector(`[data-category="${category}"][data-field="budget-montant"]`);
    if (cell) {
      totalDepensesBudget += parseMoneyValue(cell.textContent);
    }
  });

  // Mettre √† jour Total des d√©penses Budget
  const totalDepensesCell = document.querySelector('[data-category="total-depenses"][data-field="budget-montant"]');
  const totalDepensesPercentCell = document.querySelector('[data-category="total-depenses"][data-field="budget-percent"]');
  if (totalDepensesCell) {
    totalDepensesCell.textContent = formatMoneyValue(totalDepensesBudget);
  }
  if (totalDepensesPercentCell && ventesBudget > 0) {
    const percent = (totalDepensesBudget / ventesBudget) * 100;
    totalDepensesPercentCell.textContent = formatPercentValue(percent);
  }

  // Calculer le PROFIT Budget
  const profitBudget = ventesBudget - totalDepensesBudget;

  // Mettre √† jour PROFIT Budget
  const profitCell = document.querySelector('[data-category="profit"][data-field="budget-montant"]');
  const profitPercentCell = document.querySelector('[data-category="profit"][data-field="budget-percent"]');
  if (profitCell) {
    profitCell.textContent = formatMoneyValue(profitBudget);
  }
  if (profitPercentCell && ventesBudget > 0) {
    const percent = (profitBudget / ventesBudget) * 100;
    profitPercentCell.textContent = formatPercentValue(percent);
  }

  // Sauvegarder les donn√©es Budget
  saveBudgetData();

  // Synchroniser les % vers les spans mobile
  if (typeof syncMobilePercents === 'function') {
    syncMobilePercents();
  }
}

// ========================================
// CALCULS AUTOMATIQUES POUR CIBL√â
// ========================================

// Pourcentages cibl√©s par d√©faut (modifiables)
// Ces % sont fixes et les montants sont calcul√©s √† partir de l'objectif CA
const DEFAULT_CIBLE_PERCENT = {
  'assurance-qe': 1.50,
  'concours': 0,
  'essence': 1.67,
  'entretien-voiture': 0.50,
  'fourniture-bureau': 0.10,
  'frais-bancaires': 0.10,
  'frais-cellulaire': 0.17,
  'frais-garanties': 3.00,
  'leads': 0.13,
  'peinture': 9.00,
  'petits-outils': 4.00,
  'repas': 0.33,
  'redevances': null, // Calcul√© dynamiquement par le syst√®me actuel
  'salaire-peintres': 30.00,
  'salaires-representant': 1.33
};

// Pourcentages personnalis√©s (sauvegard√©s quand l'utilisateur modifie les $)
// Initialis√© depuis le backend au chargement
window.customBudgetPercent = {};

// Recalculer les totaux et pourcentages CIBL√â automatiquement
function updateCibleCalculations() {
  log('========================================');
  log('[CIBL√â DEBUG] ‚úì Function called');
  log('========================================');

  const categories = [
    'assurance-qe', 'concours', 'essence', 'entretien-voiture',
    'fourniture-bureau', 'frais-bancaires', 'frais-cellulaire',
    'frais-garanties', 'leads', 'peinture', 'petits-outils',
    'repas', 'redevances', 'salaire-peintres', 'salaires-representant'
  ];

  // R√©cup√©rer l'objectif CA (revenu total)
  const objectifCAInput = document.getElementById('objectifCA');
  log('[CIBL√â DEBUG] objectifCAInput:', objectifCAInput);
  log('[CIBL√â DEBUG] objectifCAInput.dataset.value:', objectifCAInput?.dataset.value);

  const objectifCA = parseFloat(objectifCAInput?.dataset.value) || 0;
  log('[CIBL√â DEBUG] objectifCA (parsed):', objectifCA);

  if (objectifCA <= 0) {
    warn('[CIBL√â] Objectif CA est 0, montants Cibl√© = 0$ mais % par d√©faut affich√©s');

    let totalPercentCible = 0;

    // S'assurer que window.customBudgetPercent est initialis√©
    if (!window.customBudgetPercent) {
      window.customBudgetPercent = {};
    }

    // Mettre les montants √† 0 mais afficher les % par d√©faut
    categories.forEach(category => {
      try {
        const input = document.querySelector(`td[data-category="${category}"][data-field="cible-montant"] .etats-resultats-cible-input`);
        if (input) {
          input.value = '0,00 $';
        }

        // Afficher le % personnalis√© s'il existe, sinon le % par d√©faut
        let percent = 0;

        // V√©rifier d'abord si un % personnalis√© existe
        if (window.customBudgetPercent && window.customBudgetPercent[category] !== undefined && window.customBudgetPercent[category] !== null) {
          percent = window.customBudgetPercent[category];
          log(`[CIBL√â CA=0] ${category}: utilise % CUSTOM = ${percent}`);
        }
        // Sinon utiliser le % par d√©faut
        else if (DEFAULT_CIBLE_PERCENT[category] !== undefined && DEFAULT_CIBLE_PERCENT[category] !== null) {
          percent = DEFAULT_CIBLE_PERCENT[category];
          log(`[CIBL√â CA=0] ${category}: utilise % DEFAULT = ${percent}`);
        }
        else {
          log(`[CIBL√â CA=0] ${category}: aucun %, utilise 0`);
        }

        const percentCell = document.querySelector(`[data-category="${category}"][data-field="cible-percent"]`);
        if (percentCell) {
          percentCell.textContent = formatPercentValue(percent);

          // Colorier en rouge si > 0 (sauf redevances qui est calcul√© dynamiquement)
          if (percent > 0 && category !== 'redevances') {
            percentCell.style.color = '#ef4444';
          } else {
            percentCell.style.color = '';
          }
          log(`[CIBL√â CA=0] ${category}: cellule mise √† jour avec ${formatPercentValue(percent)}`);
        } else {
          log(`[CIBL√â CA=0] ${category}: ‚ö†Ô∏è CELLULE PERCENT NON TROUV√âE`);
        }

        // Accumuler les % pour le total (sauf redevances)
        if (category !== 'redevances') {
          totalPercentCible += percent;
        }
      } catch (error) {
        console.error(`[CIBL√â CA=0] Erreur pour ${category}:`, error);
      }
    });

    // Mettre √† jour les totaux: montants = 0$, mais % = somme des %
    const totalDepensesInput = document.querySelector(`td[data-category="total-depenses"][data-field="cible-montant"]`);
    if (totalDepensesInput) totalDepensesInput.textContent = '0,00 $';

    const totalDepensesPercent = document.querySelector(`[data-category="total-depenses"][data-field="cible-percent"]`);
    if (totalDepensesPercent) {
      totalDepensesPercent.textContent = formatPercentValue(totalPercentCible);
      if (totalPercentCible > 0) {
        totalDepensesPercent.style.color = '#ef4444';
      }
    }

    // Profit = 100% - total des d√©penses %
    const profitPercent = 100 - totalPercentCible;
    const profitInput = document.querySelector(`[data-category="profit"][data-field="cible-montant"]`);
    if (profitInput) profitInput.textContent = '0,00 $';

    const profitPercentCell = document.querySelector(`[data-category="profit"][data-field="cible-percent"]`);
    if (profitPercentCell) {
      profitPercentCell.textContent = formatPercentValue(profitPercent);
      if (profitPercent >= 0) {
        profitPercentCell.style.color = '#10b981'; // Vert
      } else {
        profitPercentCell.style.color = '#ef4444'; // Rouge
      }
    }

    log(`[CIBL√â] CA = 0, montants = 0$, total % d√©penses = ${totalPercentCible.toFixed(2)}%, profit % = ${profitPercent.toFixed(2)}%`);
    return;
  }

  // Calculer le total des d√©penses CIBL√â et mettre √† jour les montants/pourcentages
  let totalDepensesCible = 0;
  log('[CIBL√â DEBUG] Starting category loop...');

  categories.forEach(category => {
    // R√©cup√©rer l'input CIBL√â pour cette cat√©gorie (l'input est DANS le td)
    const input = document.querySelector(`td[data-category="${category}"][data-field="cible-montant"] .etats-resultats-cible-input`);

    if (!input) {
      warn(`[CIBL√â DEBUG] ‚úó No input found for category: ${category}`);
      return;
    }

    log(`[CIBL√â DEBUG] ‚úì ${category} input found:`, input);

    // V√©rifier si on est en mode √©dition (input n'a pas readonly)
    const isEditing = !input.hasAttribute('readonly');

    let montant;
    let percent;

    if (isEditing) {
      // MODE √âDITION: Lire la valeur de l'input (ne PAS √©craser)
      montant = parseMoneyValue(input.value);
      percent = objectifCA > 0 ? (montant / objectifCA) * 100 : 0;

      // Sauvegarder le % personnalis√© pour cette cat√©gorie
      window.customBudgetPercent[category] = percent;
      log(`[CIBL√â DEBUG]   - ${category} (√âDITION): valeur=${montant}, %=${percent.toFixed(2)}% sauvegard√©`);
    } else if (category === 'redevances') {
      // Redevances en mode lecture: garder le syst√®me actuel
      montant = parseMoneyValue(input.value);
      percent = (montant / objectifCA) * 100;
      log(`[CIBL√â DEBUG]   - redevances: keeping existing value ${montant}`);
    } else {
      // MODE LECTURE: Utiliser le % personnalis√© s'il existe, sinon le % par d√©faut
      percent = window.customBudgetPercent[category] ?? DEFAULT_CIBLE_PERCENT[category] ?? 0;
      montant = (percent / 100) * objectifCA;

      // Mettre √† jour l'input avec le montant calcul√© ET format√©
      input.value = formatMoneyValue(montant);
      log(`[CIBL√â DEBUG]   - ${category}: ${percent}% of ${objectifCA} = ${montant} ${window.customBudgetPercent[category] ? '(custom %)' : '(default %)'}`);
    }

    totalDepensesCible += montant;
    log(`[CIBL√â DEBUG]   - running total: ${totalDepensesCible}`);

    // Afficher le pourcentage
    const percentCell = document.querySelector(`[data-category="${category}"][data-field="cible-percent"]`);
    if (percentCell) {
      percentCell.textContent = formatPercentValue(percent);
      log(`[CIBL√â DEBUG]   - percent: ${percent.toFixed(2)}%`);

      // Colorier en rouge si > 0
      if (percent > 0) {
        percentCell.style.color = '#ef4444';
      } else {
        percentCell.style.color = 'var(--text-gray)';
      }
    } else {
      warn(`[CIBL√â DEBUG]   ‚úó No percent cell found for ${category}`);
    }
  });

  log('========================================');
  log('[CIBL√â DEBUG] TOTAL CALCULATED:', totalDepensesCible);
  log('========================================');

  // Mettre √† jour Total des d√©penses CIBL√â
  const totalDepensesCell = document.querySelector('[data-category="total-depenses"][data-field="cible-montant"]');
  const totalDepensesPercentCell = document.querySelector('[data-category="total-depenses"][data-field="cible-percent"]');

  log('[CIBL√â DEBUG] totalDepensesCell:', totalDepensesCell);
  log('[CIBL√â DEBUG] totalDepensesPercentCell:', totalDepensesPercentCell);

  if (totalDepensesCell) {
    const formattedTotal = formatMoneyValue(totalDepensesCible);
    log('[CIBL√â DEBUG] Setting total cell to:', formattedTotal);
    totalDepensesCell.textContent = formattedTotal;
    log('[CIBL√â DEBUG] Total cell textContent after setting:', totalDepensesCell.textContent);
  } else {
    error('[CIBL√â DEBUG] ‚úó totalDepensesCell NOT FOUND!');
  }

  if (totalDepensesPercentCell) {
    const totalPercent = (totalDepensesCible / objectifCA) * 100;
    const formattedPercent = formatPercentValue(totalPercent);
    log('[CIBL√â DEBUG] Setting percent cell to:', formattedPercent);
    totalDepensesPercentCell.textContent = formattedPercent;
    log('[CIBL√â DEBUG] Percent cell textContent after setting:', totalDepensesPercentCell.textContent);
  } else {
    error('[CIBL√â DEBUG] ‚úó totalDepensesPercentCell NOT FOUND!');
  }

  // Calculer le PROFIT CIBL√â
  const profitCible = objectifCA - totalDepensesCible;
  const profitPercent = (profitCible / objectifCA) * 100;

  log('[CIBL√â DEBUG] Profit calculation:');
  log('[CIBL√â DEBUG]   - profitCible:', profitCible);
  log('[CIBL√â DEBUG]   - profitPercent:', profitPercent);

  // Mettre √† jour PROFIT CIBL√â
  const profitCell = document.querySelector('[data-category="profit"][data-field="cible-montant"]');
  const profitPercentCell = document.querySelector('[data-category="profit"][data-field="cible-percent"]');

  log('[CIBL√â DEBUG] profitCell:', profitCell);
  log('[CIBL√â DEBUG] profitPercentCell:', profitPercentCell);

  if (profitCell) {
    const formattedProfit = formatMoneyValue(profitCible);
    log('[CIBL√â DEBUG] Setting profit cell to:', formattedProfit);
    profitCell.textContent = formattedProfit;
  } else {
    error('[CIBL√â DEBUG] ‚úó profitCell NOT FOUND!');
  }

  if (profitPercentCell) {
    const formattedProfitPercent = formatPercentValue(profitPercent);
    log('[CIBL√â DEBUG] Setting profit percent cell to:', formattedProfitPercent);
    profitPercentCell.textContent = formattedProfitPercent;
  } else {
    error('[CIBL√â DEBUG] ‚úó profitPercentCell NOT FOUND!');
  }

  // VALIDATION: V√©rifier si le total d√©passe 100%
  const totalPercentValue = (totalDepensesCible / objectifCA) * 100;
  log('[CIBL√â DEBUG] Validation check - totalPercentValue:', totalPercentValue);
  log('========================================');

  // Trouver ou cr√©er le conteneur de message d'avertissement
  let warningContainer = document.getElementById('cible-warning-message');

  if (totalPercentValue > 100) {
    // Afficher un avertissement si > 100%
    if (!warningContainer) {
      // Cr√©er le conteneur s'il n'existe pas
      warningContainer = document.createElement('div');
      warningContainer.id = 'cible-warning-message';
      warningContainer.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: rgba(239, 68, 68, 0.95);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        max-width: 400px;
        animation: slideInRight 0.3s ease-out;
      `;

      warningContainer.innerHTML = `
        <div style="display: flex; align-items: start; gap: 12px;">
          <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; margin-top: 2px;"></i>
          <div>
            <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem;">
              Budget CIBL√â d√©passe 100%!
            </div>
            <div style="font-size: 0.875rem; opacity: 0.95;">
              Le total de vos d√©penses cibl√©es (${totalPercentValue.toFixed(2)}%) d√©passe 100% de votre objectif de revenus.
              Veuillez corriger les montants pour que le budget soit r√©aliste.
            </div>
          </div>
          <button onclick="document.getElementById('cible-warning-message').remove()"
                  style="background: none; border: none; color: white; cursor: pointer; font-size: 1.25rem; padding: 0; margin-left: auto;">
            &times;
          </button>
        </div>
      `;

      document.body.appendChild(warningContainer);

      // Auto-hide apr√®s 10 secondes
      setTimeout(() => {
        if (warningContainer && warningContainer.parentNode) {
          warningContainer.style.animation = 'slideOutRight 0.3s ease-out';
          setTimeout(() => warningContainer.remove(), 300);
        }
      }, 10000);
    } else {
      // Mettre √† jour le message existant
      const percentText = warningContainer.querySelector('div[style*="font-size: 0.875rem"]');
      if (percentText) {
        percentText.textContent = `Le total de vos d√©penses cibl√©es (${totalPercentValue.toFixed(2)}%) d√©passe 100% de votre objectif de revenus.
              Veuillez corriger les montants pour que le budget soit r√©aliste.`;
      }
    }
  } else {
    // Supprimer l'avertissement si le total est <= 100%
    if (warningContainer) {
      warningContainer.remove();
    }
  }

  log(`[CIBL√â] Calculs mis √† jour - Total: ${formatMoneyValue(totalDepensesCible)} (${totalPercentValue.toFixed(2)}%)`);

  // Synchroniser les % vers les spans mobile
  syncMobilePercents();
}

// Fonction pour synchroniser les % du PC vers les spans mobile
function syncMobilePercents() {
  const categories = [
    'ventes', 'assurance-qe', 'concours', 'essence', 'entretien-voiture',
    'fourniture-bureau', 'frais-bancaires', 'frais-cellulaire',
    'frais-garanties', 'leads', 'peinture', 'petits-outils',
    'repas', 'redevances', 'salaire-peintres', 'salaires-representant', 'profit'
  ];

  categories.forEach(category => {
    // Sync CIBL√â %
    const ciblePercentCell = document.querySelector(`#etat-resultats td[data-category="${category}"][data-field="cible-percent"]`);
    const mobileCiblePercent = document.querySelector(`.etats-mobile-cible-percent[data-category="${category}"]`);
    if (ciblePercentCell && mobileCiblePercent) {
      mobileCiblePercent.textContent = ciblePercentCell.textContent.trim();
    }

    // Sync ACTUEL/R√âEL %
    const actuelPercentCell = document.querySelector(`#etat-resultats td[data-category="${category}"][data-field="actuel-percent"]`);
    const mobileActuelPercent = document.querySelector(`.etats-mobile-actuel-percent[data-category="${category}"]`);
    if (actuelPercentCell && mobileActuelPercent) {
      mobileActuelPercent.textContent = actuelPercentCell.textContent.trim();
    }
  });
}

// Ajouter les animations CSS pour le message d'avertissement
if (!document.getElementById('cible-animations-style')) {
  const style = document.createElement('style');
  style.id = 'cible-animations-style';
  style.textContent = `
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  `;
  document.head.appendChild(style);
}

// ========================================
// RECALCUL DES TOTAUX SEULEMENT (sans √©craser les valeurs Actuel)
// ========================================

function recalculateTotalsOnly() {
  log('[TOTALS] Recalcul des totaux uniquement (sans √©craser les valeurs)');

  const categories = [
    'assurance-qe', 'concours', 'essence', 'entretien-voiture',
    'fourniture-bureau', 'frais-bancaires', 'frais-cellulaire',
    'frais-garanties', 'leads', 'peinture', 'petits-outils',
    'repas', 'redevances', 'salaire-peintres', 'salaires-representant'
  ];

  // R√©cup√©rer l'objectif CA (revenu total)
  const objectifCAInput = document.getElementById('objectifCA');
  const objectifCA = parseFloat(objectifCAInput?.dataset.value) || 400000;

  // Calculer le total des d√©penses ACTUEL
  let totalDepensesActuel = 0;

  categories.forEach(category => {
    const cell = document.querySelector(`[data-category="${category}"][data-field="actuel-montant"]`);
    if (cell) {
      const input = cell.querySelector('input');
      const montant = parseMoneyValue(input ? input.value : cell.textContent);
      totalDepensesActuel += montant;

      // Mettre √† jour le pourcentage Actuel
      const percentCell = document.querySelector(`[data-category="${category}"][data-field="actuel-percent"]`);
      if (percentCell) {
        const percent = objectifCA > 0 ? (montant / objectifCA) * 100 : 0;
        percentCell.textContent = formatPercentValue(percent);
      }
    }
  });

  // Mettre √† jour Total des d√©penses ACTUEL
  const totalDepensesActuelCell = document.querySelector('[data-category="total-depenses"][data-field="actuel-montant"]');
  const totalDepensesActuelPercentCell = document.querySelector('[data-category="total-depenses"][data-field="actuel-percent"]');

  if (totalDepensesActuelCell) {
    totalDepensesActuelCell.textContent = formatMoneyValue(totalDepensesActuel);
  }
  if (totalDepensesActuelPercentCell) {
    const totalPercent = objectifCA > 0 ? (totalDepensesActuel / objectifCA) * 100 : 0;
    totalDepensesActuelPercentCell.textContent = formatPercentValue(totalPercent);
  }

  // R√©cup√©rer les ventes actuelles
  const ventesCell = document.querySelector('[data-category="ventes"][data-field="actuel-montant"]');
  const ventesActuel = parseMoneyValue(ventesCell ? ventesCell.textContent : '0');

  // Calculer le PROFIT ACTUEL
  const profitActuel = ventesActuel - totalDepensesActuel;
  const profitPercentActuel = ventesActuel > 0 ? (profitActuel / ventesActuel) * 100 : 0;

  // Mettre √† jour PROFIT ACTUEL
  const profitActuelCell = document.querySelector('[data-category="profit"][data-field="actuel-montant"]');
  const profitActuelPercentCell = document.querySelector('[data-category="profit"][data-field="actuel-percent"]');

  if (profitActuelCell) {
    profitActuelCell.textContent = formatMoneyValue(profitActuel);
  }
  if (profitActuelPercentCell) {
    profitActuelPercentCell.textContent = formatPercentValue(profitPercentActuel);
  }

  log(`[TOTALS] Total d√©penses Actuel: ${formatMoneyValue(totalDepensesActuel)}, Profit: ${formatMoneyValue(profitActuel)}`);
}

// ========================================
// TOGGLE COLONNE √âCART
// ========================================

function toggleEcartColumn() {
  const container = document.getElementById('etat-resultats');
  const btn = document.getElementById('toggleEcartBtn');
  const icon = btn.querySelector('i');

  // Toggle la classe hide-ecart
  const isHidden = container.classList.contains('hide-ecart');

  if (isHidden) {
    // Afficher les colonnes √âCART
    container.classList.remove('hide-ecart');
    // Ic√¥ne = ≈ìil ouvert (visible)
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  } else {
    // Cacher les colonnes √âCART
    container.classList.add('hide-ecart');
    // Ic√¥ne = ≈ìil barr√© (cach√©)
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  }

  // R√©g√©n√©rer les cartes mobiles pour refl√©ter le changement
  if (typeof generateEtatsMobile === 'function') {
    generateEtatsMobile();
  }
}

// ========================================
// MODE √âDITION √âTATS DES R√âSULTATS
// ========================================

// Variable globale pour stocker les valeurs d'origine avant √©dition
let originalEtatsResultatsValues = {};

function toggleEditEtatsResultats() {
  const actuelInputs = document.querySelectorAll('.etats-resultats-input');
  const cibleInputs = document.querySelectorAll('.etats-resultats-cible-input');
  const editBtn = document.getElementById('editEtatsResultatsBtn');
  const saveBtn = document.getElementById('saveEtatsResultatsBtn');
  const cancelBtn = document.getElementById('cancelEtatsResultatsBtn');

  // V√©rifier si on est en mode √©dition en regardant l'√©tat du bouton Modifier
  // (plus fiable car certains inputs restent readonly comme ventes/profit)
  const isInEditMode = editBtn?.classList.contains('hidden');

  console.log('üîç [ETATS] toggleEditEtatsResultats appel√©');
  console.log('üîç [ETATS] Nombre d\'inputs actuel trouv√©s:', actuelInputs.length);
  console.log('üîç [ETATS] Nombre d\'inputs cible trouv√©s:', cibleInputs.length);
  console.log('üîç [ETATS] isInEditMode:', isInEditMode);

  if (!isInEditMode) {
    // Sauvegarder les valeurs d'origine avant d'activer le mode √©dition
    originalEtatsResultatsValues = { actuel: {}, cible: {} };

    actuelInputs.forEach(input => {
      // Chercher la cat√©gorie sur le td parent OU directement sur l'input (mobile)
      const category = input.closest('td')?.getAttribute('data-category') || input.getAttribute('data-category');
      if (category) {
        originalEtatsResultatsValues.actuel[category] = input.value;
      }
    });

    cibleInputs.forEach(input => {
      // Chercher la cat√©gorie sur le td parent OU directement sur l'input (mobile)
      const category = input.closest('td')?.getAttribute('data-category') || input.getAttribute('data-category');
      if (category) {
        originalEtatsResultatsValues.cible[category] = input.value;
      }
    });

    log('üíæ Valeurs d\'origine sauvegard√©es:', originalEtatsResultatsValues);

    // Cat√©gories non-√©ditables (ventes et profit sont calcul√©s automatiquement)
    const nonEditableCategories = ['ventes', 'profit', 'total-ecart', 'total-depenses', 'assurance-qe', 'frais-garanties', 'redevances'];

    // Activer le mode √©dition pour les inputs ACTUEL
    actuelInputs.forEach(input => {
      // Chercher la cat√©gorie sur le td parent OU directement sur l'input (mobile)
      const category = input.closest('td')?.getAttribute('data-category') || input.getAttribute('data-category');

      // Ne PAS rendre √©ditable les cat√©gories sp√©cifiques (ventes, profit)
      if (nonEditableCategories.includes(category)) {
        input.setAttribute('readonly', 'true');
        input.style.cursor = 'not-allowed';
        input.style.opacity = '0.6';
        input.style.background = 'transparent';
        return; // Ne pas modifier ce champ
      }

      input.removeAttribute('readonly');
      input.style.color = 'var(--primary-blue)';
      input.style.outline = 'none';
      input.style.background = 'rgba(96, 165, 250, 0.1)';
      input.style.border = 'none';
      input.style.borderBottom = '2px solid var(--primary-blue)';
      input.style.padding = '0';
      input.style.paddingLeft = '8px';
      input.style.borderRadius = '4px';
      input.style.cursor = 'text';

      // Changer le padding du td parent
      const td = input.closest('td');
      if (td) {
        td.style.paddingLeft = '0.75rem';
      }

      // V√©rifier si la valeur est par d√©faut (0,00 $ ou 0$)
      const parsedValue = parseMoneyValue(input.value);
      if (parsedValue === 0) {
        // Valeur par d√©faut: mettre en placeholder et vider
        input.placeholder = input.value;
        input.value = '';
      } else {
        // Valeur saisie: afficher la valeur num√©rique brute
        input.value = String(parsedValue);
        input.placeholder = '';
      }

      // Ajouter un √©couteur d'√©v√©nements pour recalculer automatiquement les %
      if (!input.dataset.listenerAdded) {
        input.addEventListener('input', () => {
          // Si c'est un input mobile, synchroniser vers PC d'abord
          const category = input.getAttribute('data-category');
          if (category && !input.closest('td')) {
            // C'est un input mobile - sync vers PC
            const pcInput = document.querySelector(`#etat-resultats td[data-category="${category}"][data-field="actuel-montant"] input`);
            if (pcInput) {
              pcInput.value = input.value;
            }
          }
          updateAllCalculations();
        });
        input.dataset.listenerAdded = 'true';
      }
    });

    // Activer le mode √©dition pour les inputs CIBL√â

    console.log('üîç [ETATS] D√©but de la boucle cibleInputs, nombre:', cibleInputs.length);

    cibleInputs.forEach((input, index) => {
      // Chercher la cat√©gorie sur le td parent OU directement sur l'input (mobile)
      const category = input.closest('td')?.getAttribute('data-category') || input.getAttribute('data-category');
      console.log(`üîç [ETATS] Input ${index}: category="${category}", hasReadonly="${input.hasAttribute('readonly')}"`);

      // Ne PAS rendre √©ditable les cat√©gories sp√©cifiques
      if (nonEditableCategories.includes(category)) {
        input.setAttribute('readonly', 'true');
        input.style.cursor = 'not-allowed';
        input.style.opacity = '0.6';
        input.style.background = 'transparent';
        console.log(`üîí [ETATS] Cat√©gorie NON-√âDITABLE: ${category}`);
        return; // Ne pas modifier ce champ
      }

      console.log(`‚úÖ [ETATS] Activation de l'√©dition pour: ${category}`);
      input.removeAttribute('readonly');
      input.style.color = 'var(--primary-green)';
      input.style.outline = 'none';
      input.style.background = 'rgba(52, 211, 153, 0.1)';
      input.style.border = 'none';
      input.style.borderBottom = '2px solid var(--primary-green)';
      input.style.padding = '0';
      input.style.paddingLeft = '8px';
      input.style.borderRadius = '4px';
      input.style.cursor = 'text';
      input.style.opacity = '1';

      // Changer le padding du td parent (seulement si c'est un input PC)
      const td = input.closest('td');
      if (td) {
        td.style.paddingLeft = '0.75rem';
      }

      // Afficher la valeur num√©rique brute pour modification
      const parsedValue = parseMoneyValue(input.value);
      input.value = String(parsedValue);
      input.placeholder = '';

      // Ajouter un √©couteur d'√©v√©nements pour recalculer automatiquement
      if (!input.dataset.listenerAdded) {
        input.addEventListener('input', () => {
          // Si c'est un input mobile, synchroniser vers PC d'abord
          const cat = input.getAttribute('data-category');
          if (cat && !input.closest('td')) {
            // C'est un input mobile - sync vers PC
            const pcInput = document.querySelector(`#etat-resultats td[data-category="${cat}"][data-field="cible-montant"] input`);
            if (pcInput) {
              pcInput.value = input.value;
            }
          }
          updateCibleCalculations();
        });
        input.dataset.listenerAdded = 'true';
      }
    });

    editBtn.classList.add('hidden');
    saveBtn.classList.remove('hidden');
    cancelBtn.classList.remove('hidden');
    log('‚úèÔ∏è Mode √©dition √âtats des R√©sultats activ√© (ACTUEL + CIBL√â)');
  } else {
    // D√©sactiver le mode √©dition pour les inputs ACTUEL
    actuelInputs.forEach(input => {
      input.setAttribute('readonly', 'readonly');
      input.style.background = 'transparent';
      input.style.borderBottom = 'none';
      input.style.border = 'none';
      input.style.color = 'var(--text-light)';
      input.style.padding = '';
      input.style.paddingLeft = '';
      input.style.borderRadius = '';
      input.style.outline = 'none';
      input.style.cursor = 'default';

      // Restaurer le padding du td parent
      const td = input.closest('td');
      if (td) {
        td.style.paddingLeft = '1rem';
      }

      // Retirer le placeholder
      input.placeholder = '';
    });

    // D√©sactiver le mode √©dition pour les inputs CIBL√â
    const nonEditableCategories = ['ventes', 'profit', 'total-ecart', 'total-depenses', 'assurance-qe', 'frais-garanties', 'redevances'];

    cibleInputs.forEach(input => {
      const category = input.closest('td')?.getAttribute('data-category');

      input.setAttribute('readonly', 'readonly');
      input.style.background = 'transparent';
      input.style.borderBottom = 'none';
      input.style.border = 'none';
      input.style.color = 'var(--text-light)';
      input.style.padding = '';
      input.style.paddingLeft = '';
      input.style.borderRadius = '';
      input.style.outline = 'none';

      // Appliquer le style non-√©ditable pour les cat√©gories sp√©cifiques
      if (nonEditableCategories.includes(category)) {
        input.style.cursor = 'not-allowed';
        input.style.opacity = '0.6';
      } else {
        input.style.cursor = 'default';
        input.style.opacity = '1';
      }

      // Restaurer le padding du td parent
      const td = input.closest('td');
      if (td) {
        td.style.paddingLeft = '1rem';
      }

      // Retirer le placeholder
      input.placeholder = '';
    });

    editBtn.classList.remove('hidden');
    saveBtn.classList.add('hidden');
    cancelBtn.classList.add('hidden');
    log('üëÅÔ∏è Mode √©dition √âtats des R√©sultats d√©sactiv√©');
  }
}

// Fonction pour annuler les modifications et restaurer les valeurs d'origine
function cancelEtatsResultatsEdits() {
  const actuelInputs = document.querySelectorAll('.etats-resultats-input');
  const cibleInputs = document.querySelectorAll('.etats-resultats-cible-input');

  log('‚Ü©Ô∏è Annulation des modifications, restauration des valeurs d\'origine...');

  // Restaurer les valeurs ACTUEL
  actuelInputs.forEach(input => {
    // Chercher la cat√©gorie sur le td parent OU directement sur l'input (mobile)
    const category = input.closest('td')?.getAttribute('data-category') || input.getAttribute('data-category');
    if (category && originalEtatsResultatsValues.actuel && originalEtatsResultatsValues.actuel[category]) {
      input.value = originalEtatsResultatsValues.actuel[category];
    }
  });

  // Restaurer les valeurs CIBL√â
  cibleInputs.forEach(input => {
    // Chercher la cat√©gorie sur le td parent OU directement sur l'input (mobile)
    const category = input.closest('td')?.getAttribute('data-category') || input.getAttribute('data-category');
    if (category && originalEtatsResultatsValues.cible && originalEtatsResultatsValues.cible[category]) {
      input.value = originalEtatsResultatsValues.cible[category];
    }
  });

  // Recalculer pour mettre √† jour l'affichage
  updateCibleCalculations();
  updateAllCalculations();

  // D√©sactiver le mode √©dition
  toggleEditEtatsResultats();

  log('‚úì Valeurs restaur√©es avec succ√®s');
}

async function saveEtatsResultatsEdits() {
  log('üíæ Sauvegarde des modifications √âtats des R√©sultats...');

  const saveBtn = document.getElementById('saveEtatsResultatsBtn');
  const originalHTML = saveBtn.innerHTML;

  // Afficher le spinner
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i><span class="text-xs font-semibold">Enregistrement...</span>';
  saveBtn.disabled = true;
  saveBtn.style.cursor = 'not-allowed';
  saveBtn.style.opacity = '0.7';

  try {
    // D√©terminer si on est sur mobile/tablette ou PC
    // Sur mobile/tablette: sync mobile ‚Üí PC (l'utilisateur a √©dit√© sur mobile)
    // Sur PC: sync PC ‚Üí mobile (l'utilisateur a √©dit√© sur PC)
    const isMobileOrTablet = window.innerWidth <= 1024;
    console.log(`üì±üíª [SAVE] Mode: ${isMobileOrTablet ? 'Mobile/Tablette' : 'PC'} (width: ${window.innerWidth}px)`);

    if (isMobileOrTablet) {
      // Sur mobile/tablette: synchroniser mobile ‚Üí PC
      const mobileCibleInputs = document.querySelectorAll('#etats-mobile-container .etats-resultats-cible-input');
      mobileCibleInputs.forEach(mobileInput => {
        const category = mobileInput.getAttribute('data-category');
        if (category) {
          const pcInput = document.querySelector(`#etat-resultats td[data-category="${category}"][data-field="cible-montant"] input`);
          if (pcInput) {
            pcInput.value = mobileInput.value;
            console.log(`üì±‚Üíüíª Sync CIBL√â mobile vers PC: ${category} = ${mobileInput.value}`);
          }
        }
      });

      const mobileActuelInputs = document.querySelectorAll('#etats-mobile-container .etats-resultats-input');
      mobileActuelInputs.forEach(mobileInput => {
        const category = mobileInput.getAttribute('data-category');
        if (category) {
          const pcInput = document.querySelector(`#etat-resultats td[data-category="${category}"][data-field="actuel-montant"] input`);
          if (pcInput) {
            pcInput.value = mobileInput.value;
            console.log(`üì±‚Üíüíª Sync R√âEL mobile vers PC: ${category} = ${mobileInput.value}`);
          }
        }
      });
    } else {
      // Sur PC: synchroniser PC ‚Üí mobile (pour que generateEtatsMobile ait les bonnes valeurs)
      console.log(`üíª‚Üíüì± Mode PC: les valeurs PC sont la source de v√©rit√©`);
    }

    // Formater les cellules ACTUEL contenteditable (celles sans input enfant)
    const actuelCells = document.querySelectorAll('[data-field="actuel-montant"]');
    actuelCells.forEach(cell => {
      // V√©rifier si cette cellule contient un input
      const hasInput = cell.querySelector('input');
      if (!hasInput) {
        // C'est une cellule contenteditable, formater directement
        const value = parseMoneyValue(cell.textContent);
        cell.textContent = formatMoneyValue(value);
      }
      // Si elle contient un input, il sera format√© par le code suivant
    });

    // Formater toutes les valeurs des inputs ACTUEL
    const actuelInputs = document.querySelectorAll('.etats-resultats-input');
    actuelInputs.forEach(input => {
      if (input.value.trim() === '') {
        // Si vide, garder le placeholder comme valeur
        input.value = input.placeholder;
      } else {
        // Sinon, parser et formater la valeur saisie
        const parsed = parseMoneyValue(input.value);
        input.value = formatMoneyValue(parsed);
      }
    });

    // Formater toutes les valeurs des inputs CIBL√â
    const cibleInputs = document.querySelectorAll('.etats-resultats-cible-input');
    cibleInputs.forEach(input => {
      if (input.value.trim() === '') {
        // Si vide, mettre 0$
        input.value = '0$';
      } else {
        // Sinon, parser et formater la valeur saisie
        const parsed = parseMoneyValue(input.value);
        input.value = formatMoneyValue(parsed);
      }
    });

    // Recalculer les totaux et pourcentages CIBL√â
    console.log('üîç [SAVE] √âtape 1: updateCibleCalculations()...');
    updateCibleCalculations();
    console.log('‚úÖ [SAVE] √âtape 1 termin√©e');

    // Calculer explicitement les % CIBL√â depuis les montants actuels pour s'assurer qu'ils sont sauvegard√©s
    console.log('üîç [SAVE] √âtape 1.5: Calcul explicite des % CIBL√â...');
    const objectifCAInput = document.getElementById('objectifCA');
    // Essayer dataset.value d'abord, sinon parser la valeur affich√©e
    let objectifCA = parseFloat(objectifCAInput?.dataset?.value) || 0;
    if (objectifCA === 0 && objectifCAInput) {
      // Fallback: parser la valeur affich√©e (ex: "400 000,00 $")
      objectifCA = parseMoneyValue(objectifCAInput.value);
      console.log(`üìä [SAVE] Objectif CA (fallback from displayed value) = ${objectifCA}`);
    }
    console.log(`üìä [SAVE] Objectif CA = ${objectifCA}`);

    if (objectifCA > 0) {
      const categoriesToCalc = [
        'concours', 'essence', 'entretien-voiture', 'fourniture-bureau',
        'frais-bancaires', 'frais-cellulaire', 'leads', 'peinture',
        'petits-outils', 'repas', 'salaire-peintres', 'salaires-representant'
      ];

      // Initialiser window.customBudgetPercent si n√©cessaire
      if (!window.customBudgetPercent) {
        window.customBudgetPercent = {};
      }

      categoriesToCalc.forEach(category => {
        // S√©lecteur simplifi√© - cherche directement le td avec les attributs
        const pcInput = document.querySelector(`td[data-category="${category}"][data-field="cible-montant"] input`);
        if (pcInput) {
          const montant = parseMoneyValue(pcInput.value);
          const percent = (montant / objectifCA) * 100;
          window.customBudgetPercent[category] = percent;
          console.log(`   üìä ${category}: ${montant}$ ‚Üí ${percent.toFixed(2)}%`);
        } else {
          console.log(`   ‚ö†Ô∏è ${category}: INPUT NON TROUV√â`);
        }
      });
      console.log('‚úÖ [SAVE] √âtape 1.5 termin√©e - % CIBL√â calcul√©s:', window.customBudgetPercent);
    } else {
      console.log('‚ö†Ô∏è [SAVE] Objectif CA = 0, % non calcul√©s');
    }

    // Recalculer tous les totaux et √©carts
    console.log('üîç [SAVE] √âtape 2: updateAllCalculations()...');
    updateAllCalculations();
    console.log('‚úÖ [SAVE] √âtape 2 termin√©e');

    // Sauvegarder dans le backend
    console.log('üîç [SAVE] √âtape 3: saveEtatsResultatsData()...');
    await saveEtatsResultatsData();
    console.log('‚úÖ [SAVE] √âtape 3 termin√©e');

    // Quitter le mode √©dition
    console.log('üîç [SAVE] √âtape 4: toggleEditEtatsResultats()...');
    toggleEditEtatsResultats();
    console.log('‚úÖ [SAVE] √âtape 4 termin√©e - mode √©dition d√©sactiv√©');

    // R√©g√©n√©rer les cartes mobiles avec les nouvelles valeurs
    if (typeof generateEtatsMobile === 'function') {
      console.log('üîç [SAVE] √âtape 5: generateEtatsMobile()...');
      generateEtatsMobile();
      console.log('‚úÖ [SAVE] √âtape 5 termin√©e');
    }

    // Notification de succ√®s
    if (typeof showNotification === 'function') {
      showNotification('√âtats des R√©sultats sauvegard√©s avec succ√®s!', 'success');
    }

    log('[OK] √âtats des R√©sultats sauvegard√©s');
  } catch (error) {
    console.error('‚ùå [SAVE] Erreur lors de la sauvegarde:', error);
    console.error('‚ùå [SAVE] Stack:', error.stack);

    // Notification d'erreur
    if (typeof showNotification === 'function') {
      showNotification('Erreur lors de la sauvegarde: ' + error.message, 'error');
    }

    // Quitter le mode √©dition m√™me en cas d'erreur
    console.log('üîç [SAVE] Tentative de sortie du mode √©dition apr√®s erreur...');
    try {
      toggleEditEtatsResultats();
    } catch (toggleError) {
      console.error('‚ùå [SAVE] Impossible de sortir du mode √©dition:', toggleError);
    }
  } finally {
    setTimeout(() => {
      saveBtn.innerHTML = originalHTML;
      saveBtn.disabled = false;
      saveBtn.style.cursor = '';
      saveBtn.style.opacity = '';
    }, 300);
  }
}

// Reformater toutes les cellules de montant au format fran√ßais
function reformatAllMoneyValues() {
  log('[MONEY] Reformatage de tous les montants au format fran√ßais...');

  // Trouver tous les inputs dans les cellules √âtats des R√©sultats
  const allInputs = document.querySelectorAll('.etats-resultats-input');
  allInputs.forEach(input => {
    const value = input.value.trim();
    if (value && value !== '' && !value.includes('%')) {
      const parsed = parseMoneyValue(value);
      input.value = formatMoneyValue(parsed);
    }
  });

  // Reformater aussi les cellules Budget sans data-field (montants hardcod√©s)
  const etatsResultatsSection = Array.from(document.querySelectorAll('h3')).find(h3 =>
    h3.textContent.includes('√âtats des R√©sultats')
  );

  if (etatsResultatsSection) {
    const table = etatsResultatsSection.closest('.glass-card').querySelector('table');
    if (table) {
      const allCells = table.querySelectorAll('td');
      allCells.forEach(cell => {
        // Skip cells with inputs
        if (cell.querySelector('input')) return;

        const text = cell.textContent.trim();
        // Reformater si contient $ mais pas un data-field d√©j√† trait√© et pas vide
        if (text.includes('$') && text !== '' && !cell.hasAttribute('data-field')) {
          const parsed = parseMoneyValue(text);
          cell.textContent = formatMoneyValue(parsed);
        }
      });
    }
  }

  log('[OK] Tous les montants reformat√©s au format fran√ßais');
}

// Initialiser le syst√®me d'√©dition
async function initEtatsResultatsEditor() {
  log('[LAUNCH] Initialisation de l\'√©diteur √âtats des R√©sultats');

  try {
    // Ajouter les attributs data-field aux cellules Budget et √âCART
    log('[LAUNCH] √âtape 1: addBudgetDataAttributes()');
    addBudgetDataAttributes();

    log('[LAUNCH] √âtape 2: addEcartDataAttributes()');
    addEcartDataAttributes();

    // Reformater tous les montants au format fran√ßais
    log('[LAUNCH] √âtape 3: reformatAllMoneyValues()');
    reformatAllMoneyValues();

    // Charger les pourcentages Budget sauvegard√©s depuis le backend
    log('[LAUNCH] √âtape 4: loadBudgetData()');
    await loadBudgetData();

    // Synchroniser Objectif CA avec Ventes Budget (va recalculer tous les montants)
    log('[LAUNCH] √âtape 5: syncObjectifCAWithVentesBudget()');
    syncObjectifCAWithVentesBudget();

    // Charger les donn√©es Actuel sauvegard√©es depuis le backend
    log('[LAUNCH] √âtape 6: loadEtatsResultatsData()');
    await loadEtatsResultatsData();
    log('[LAUNCH] √âtape 6 termin√©e');

    // Charger le chiffre d'affaires depuis l'API
    log('[LAUNCH] √âtape 7: loadChiffreAffaires()');
    await loadChiffreAffaires();
    log('[LAUNCH] √âtape 7 termin√©e');
  } catch (error) {
    error('[ERROR] Erreur dans initEtatsResultatsEditor:', error);
    error('[ERROR] Stack:', error.stack);
    throw error;
  }

  // Ajouter event listener sur objectifCA pour synchroniser avec Ventes Budget
  const objectifCAInput = document.getElementById('objectifCA');
  if (objectifCAInput) {
    // Observer les changements de valeur (apr√®s formatage)
    const observer = new MutationObserver(() => {
      syncObjectifCAWithVentesBudget();
    });
    observer.observe(objectifCAInput, { attributes: true, attributeFilter: ['data-value'] });
  }

  // Ajouter les event listeners pour les cellules Actuel √©ditables
  const editableActuelCells = document.querySelectorAll('[data-field="actuel-montant"]');

  editableActuelCells.forEach(cell => {
    // √âv√©nement lors de la saisie (mise √† jour en temps r√©el)
    cell.addEventListener('input', (e) => {
      const category = cell.getAttribute('data-category');
      log(`‚úèÔ∏è Modification Actuel: ${category}`);

      // Calculer le pourcentage en temps r√©el pendant la saisie
      const value = parseMoneyValue(cell.textContent);
      const ventesActuelCell = document.querySelector('[data-category="ventes"][data-field="actuel-montant"]');
      const ventesActuel = parseMoneyValue(ventesActuelCell?.textContent || '0');

      const percentCell = document.querySelector(`[data-category="${category}"][data-field="actuel-percent"]`);
      if (percentCell && ventesActuel > 0) {
        const percent = (value / ventesActuel) * 100;
        percentCell.textContent = formatPercentValue(percent);
      }

      // Mettre √† jour tous les calculs en temps r√©el
      updateAllCalculations();
    });

    // √âv√©nement lorsqu'on quitte la cellule (blur)
    // NOTE: Formatage D√âSACTIV√â au blur - se fera seulement √† l'enregistrement
    cell.addEventListener('blur', (e) => {
      const category = cell.getAttribute('data-category');

      // Lire la valeur sans formater
      const value = parseMoneyValue(cell.textContent);

      // Calculer le pourcentage par rapport aux Ventes
      const ventesActuelCell = document.querySelector('[data-category="ventes"][data-field="actuel-montant"]');
      const ventesActuel = parseMoneyValue(ventesActuelCell?.textContent || '0');

      const percentCell = document.querySelector(`[data-category="${category}"][data-field="actuel-percent"]`);
      if (percentCell && ventesActuel > 0) {
        const percent = (value / ventesActuel) * 100;
        percentCell.textContent = formatPercentValue(percent);
      }

      // Mettre √† jour tous les calculs
      updateAllCalculations();
    });

    // Emp√™cher le collage de contenu format√©
    cell.addEventListener('paste', (e) => {
      e.preventDefault();
      const text = e.clipboardData.getData('text/plain');
      document.execCommand('insertText', false, text);
    });
  });

  // Ajouter les event listeners pour les inputs CIBL√â √©ditables
  const editableCibleInputs = document.querySelectorAll('.etats-resultats-cible-input');

  // Cat√©gories qui ne doivent JAMAIS √™tre modifiables
  const nonEditableCategories = ['ventes', 'profit', 'total-ecart', 'total-depenses', 'assurance-qe', 'frais-garanties', 'redevances'];

  editableCibleInputs.forEach(input => {
    const category = input.closest('td')?.getAttribute('data-category');

    // Ne PAS rendre √©ditable les cat√©gories sp√©cifiques
    if (nonEditableCategories.includes(category)) {
      input.setAttribute('readonly', 'true');
      input.style.cursor = 'not-allowed';
      input.style.opacity = '0.6';
      log(`üîí Cat√©gorie NON-√âDITABLE: ${category}`);
      return; // Ne pas ajouter d'event listeners
    }

    // NE PAS rendre l'input √©ditable ici - il sera rendu √©ditable uniquement quand l'utilisateur clique sur "Modifier"
    // input.removeAttribute('readonly'); // COMMENT√â - les inputs doivent rester readonly par d√©faut

    // √âv√©nement lors de la saisie dans l'input CIBL√â (mise √† jour en temps r√©el)
    input.addEventListener('input', (e) => {
      log(`‚úèÔ∏è Modification CIBL√â: ${category}`);

      // Recalculer les pourcentages en temps r√©el pendant la saisie
      updateCibleCalculations();
    });

    // √âv√©nement lorsqu'on quitte l'input (blur)
    // NOTE: Formatage D√âSACTIV√â au blur - se fera seulement √† l'enregistrement
    input.addEventListener('blur', (e) => {
      // Recalculer tous les totaux et pourcentages CIBL√â (sans formater)
      updateCibleCalculations();

      // Recalculer les √©carts
      updateAllCalculations();

      log(`‚úèÔ∏è CIBL√â modifi√©: ${category} = ${input.value}`);
    });

    // Emp√™cher le collage de contenu format√©
    input.addEventListener('paste', (e) => {
      e.preventDefault();
      const text = e.clipboardData.getData('text/plain');
      document.execCommand('insertText', false, text);
    });
  });

  // Les cellules Budget % ne sont plus √©ditables, donc pas besoin d'event listeners pour elles

  log('[OK] √âditeur initialis√©:', editableActuelCells.length, 'cellules Actuel,', editableCibleInputs.length, 'inputs CIBL√â');

  // Forcer le calcul initial des √©carts apr√®s l'initialisation compl√®te
  // NOTE: Ne PAS appeler updateCibleCalculations() ici car les donn√©es CIBL√â
  // ont d√©j√† √©t√© charg√©es par loadEtatsResultatsData(). L'appeler √©craserait
  // les valeurs sauvegard√©es avec des valeurs recalcul√©es √† partir des %.
  setTimeout(() => {
    updateAllCalculations();
    // R√©g√©n√©rer les cartes mobiles APR√àS les calculs pour avoir les √©carts corrects
    if (typeof generateEtatsMobile === 'function') {
      generateEtatsMobile();
      log('üì± Cartes mobiles reg√©n√©r√©es apr√®s calculs');
    }
    log('üîÑ Calculs initiaux des √©carts effectu√©s');
  }, 200);
}

// Ajouter les attributs data-field aux cellules Budget
function addBudgetDataAttributes() {
  const categories = [
    'ventes', 'assurance-qe', 'concours', 'essence', 'entretien-voiture',
    'fourniture-bureau', 'frais-bancaires', 'frais-cellulaire',
    'frais-garanties', 'leads', 'peinture', 'petits-outils',
    'repas', 'redevances', 'salaire-peintres', 'salaires-representant',
    'total-depenses', 'profit'
  ];

  // Pour chaque cat√©gorie, trouver la ligne et ajouter les attributs aux colonnes Budget
  categories.forEach(category => {
    // Trouver la cellule Actuel pour cette cat√©gorie
    const actuelCell = document.querySelector(`[data-category="${category}"][data-field="actuel-montant"]`);
    if (!actuelCell) return;

    // Remonter √† la ligne parente (tr)
    const row = actuelCell.closest('tr');
    if (!row) return;

    // Trouver les cellules Budget (2√®me et 3√®me td)
    const cells = row.querySelectorAll('td');
    if (cells.length >= 7) {
      // 2√®me cellule = Budget Montant
      if (!cells[1].hasAttribute('data-field')) {
        cells[1].setAttribute('data-field', 'budget-montant');
        cells[1].setAttribute('data-category', category);
      }

      // 3√®me cellule = Budget %
      if (!cells[2].hasAttribute('data-field')) {
        cells[2].setAttribute('data-field', 'budget-percent');
        cells[2].setAttribute('data-category', category);

        // Les cellules Budget % sont d√©sormais en lecture seule (non √©ditables)
        cells[2].removeAttribute('contenteditable');
        cells[2].style.cursor = 'default';
      }
    }
  });
}

// Ajouter les attributs data-field aux cellules √âCART
function addEcartDataAttributes() {
  const categories = [
    'ventes', 'assurance-qe', 'concours', 'essence', 'entretien-voiture',
    'fourniture-bureau', 'frais-bancaires', 'frais-cellulaire',
    'frais-garanties', 'leads', 'peinture', 'petits-outils',
    'repas', 'redevances', 'salaire-peintres', 'salaires-representant',
    'total-depenses', 'profit'
  ];

  // Pour chaque cat√©gorie, trouver la ligne et ajouter les attributs aux colonnes √âCART
  categories.forEach(category => {
    // Trouver la cellule Actuel pour cette cat√©gorie
    const actuelCell = document.querySelector(`[data-category="${category}"][data-field="actuel-montant"]`);
    if (!actuelCell) return;

    // Remonter √† la ligne parente (tr)
    const row = actuelCell.closest('tr');
    if (!row) return;

    // Trouver les cellules √âCART (4√®me et 5√®me td)
    const cells = row.querySelectorAll('td');
    if (cells.length >= 7) {
      // 4√®me cellule = √âCART Montant
      if (!cells[3].hasAttribute('data-field')) {
        cells[3].setAttribute('data-field', 'ecart-montant');
        cells[3].setAttribute('data-category', category);
      }

      // 5√®me cellule = √âCART %
      if (!cells[4].hasAttribute('data-field')) {
        cells[4].setAttribute('data-field', 'ecart-percent');
        cells[4].setAttribute('data-category', category);
      }
    }
  });
}

// G√©n√©rer la version mobile (cartes) pour √âtats des r√©sultats
function generateEtatsMobile() {
  const container = document.getElementById('etats-mobile-container');
  if (!container) return;

  let html = '';

  // Structure de donn√©es pour toutes les lignes
  const categories = [
    {
      type: 'header',
      title: 'REVENUS D\'ENTREPRISE',
      icon: 'fas fa-dollar-sign',
      color: '#22c55e'
    },
    {
      type: 'row',
      label: 'Ventes',
      icon: 'fas fa-arrow-right',
      category: 'ventes',
      isHighlight: false
    },
    {
      type: 'header',
      title: 'D√âPENSES',
      icon: 'fas fa-minus-circle',
      color: '#ef4444'
    },
    {
      type: 'row',
      label: 'Assurance QE',
      icon: 'fas fa-arrow-right',
      category: 'assurance-qe',
      isHighlight: true
    },
    {
      type: 'row',
      label: 'Concours',
      icon: 'fas fa-arrow-right',
      category: 'concours',
      isHighlight: false
    },
    {
      type: 'row',
      label: 'Essence',
      icon: 'fas fa-arrow-right',
      category: 'essence',
      isHighlight: false
    },
    {
      type: 'row',
      label: 'Entretien voiture',
      icon: 'fas fa-arrow-right',
      category: 'entretien-voiture',
      isHighlight: false
    },
    {
      type: 'row',
      label: 'Fourniture bureau',
      icon: 'fas fa-arrow-right',
      category: 'fourniture-bureau',
      isHighlight: false
    },
    {
      type: 'row',
      label: 'Frais bancaires',
      icon: 'fas fa-arrow-right',
      category: 'frais-bancaires',
      isHighlight: false
    },
    {
      type: 'row',
      label: 'Frais cellulaire',
      icon: 'fas fa-arrow-right',
      category: 'frais-cellulaire',
      isHighlight: false
    },
    {
      type: 'row',
      label: 'Frais de garanties',
      icon: 'fas fa-arrow-right',
      category: 'frais-garanties',
      isHighlight: true
    },
    {
      type: 'row',
      label: 'Leads',
      icon: 'fas fa-arrow-right',
      category: 'leads',
      isHighlight: false
    },
    {
      type: 'row',
      label: 'Peinture',
      icon: 'fas fa-arrow-right',
      category: 'peinture',
      isHighlight: true
    },
    {
      type: 'row',
      label: 'Petits outils',
      icon: 'fas fa-arrow-right',
      category: 'petits-outils',
      isHighlight: true
    },
    {
      type: 'row',
      label: 'Repas',
      icon: 'fas fa-arrow-right',
      category: 'repas',
      isHighlight: false
    },
    {
      type: 'row',
      label: 'Redevances',
      icon: 'fas fa-arrow-right',
      category: 'redevances',
      isHighlight: true
    },
    {
      type: 'row',
      label: 'Salaire des peintres',
      icon: 'fas fa-arrow-right',
      category: 'salaire-peintres',
      isHighlight: true
    },
    {
      type: 'row',
      label: 'Salaires repr√©sentant',
      icon: 'fas fa-arrow-right',
      category: 'salaires-representant',
      isHighlight: false
    },
    {
      type: 'total',
      label: 'Total des d√©penses',
      icon: 'fas fa-calculator',
      category: 'total-depenses',
      color: '#ef4444'
    },
    {
      type: 'total',
      label: 'TOTAL √âCART',
      icon: 'fas fa-balance-scale',
      category: 'total-ecart',
      color: '#94a3b8'
    },
    {
      type: 'total',
      label: 'PROFIT',
      icon: 'fas fa-trophy',
      category: 'profit',
      color: '#22c55e'
    }
  ];

  // V√©rifier si colonne √©cart est visible
  const hideEcart = document.getElementById('etat-resultats')?.classList.contains('hide-ecart');

  categories.forEach(item => {
    if (item.type === 'header') {
      html += `
        <div class="etats-mobile-section-header" style="background: rgba(${item.color === '#22c55e' ? '34, 197, 94' : '239, 68, 68'}, 0.1);">
          <i class="${item.icon}" style="color: ${item.color};"></i>
          ${item.title}
        </div>
      `;
    } else if (item.type === 'row') {
      // R√©cup√©rer les donn√©es du tableau PC (champs cible/budget et actuel)
      // Note: "ventes" utilise "budget-montant" au lieu de "cible-montant"
      const cibleFieldName = item.category === 'ventes' ? 'budget-montant' : 'cible-montant';
      const ciblePercentFieldName = item.category === 'ventes' ? 'budget-percent' : 'cible-percent';

      const cibleMontantCell = document.querySelector(`#etat-resultats td[data-category="${item.category}"][data-field="${cibleFieldName}"]`);
      const ciblePercentCell = document.querySelector(`#etat-resultats td[data-category="${item.category}"][data-field="${ciblePercentFieldName}"]`);
      const actuelMontantCell = document.querySelector(`#etat-resultats td[data-category="${item.category}"][data-field="actuel-montant"]`);
      const actuelPercentCell = document.querySelector(`#etat-resultats td[data-category="${item.category}"][data-field="actuel-percent"]`);

      // R√©cup√©rer les valeurs (input ou texte)
      const cibleMontant = cibleMontantCell?.querySelector('input')?.value || cibleMontantCell?.textContent.trim() || '0 $';
      // Pour ventes, le % est toujours 100% (pas de data-field pour budget-percent)
      const ciblePercent = item.category === 'ventes' ? '100%' : (ciblePercentCell?.textContent.trim() || '0%');
      const actuelMontant = actuelMontantCell?.querySelector('input')?.value || actuelMontantCell?.textContent.trim() || '0 $';
      const actuelPercent = actuelPercentCell?.textContent.trim() || '0%';

      const labelColor = item.isHighlight ? '#f87171' : 'var(--text-light)';

      html += `
        <div class="etats-mobile-card">
          <div class="etats-mobile-card-header">
            <i class="${item.icon}"></i>
            <span style="color: ${labelColor};">${item.label}</span>
          </div>
          <div class="etats-mobile-row">
            <span class="etats-mobile-label"><i class="fas fa-bullseye mr-1 text-blue-400" style="font-size: 0.7rem;"></i> CIBL√â Montant</span>
            <span class="etats-mobile-value"><input type="text" readonly class="etats-resultats-cible-input bg-transparent border-none" style="color: var(--text-light); outline: none; text-align: right; width: 100%;" value="${cibleMontant}" data-category="${item.category}" data-field="cible-montant-mobile"></span>
          </div>
          <div class="etats-mobile-row">
            <span class="etats-mobile-label"><i class="fas fa-bullseye mr-1 text-blue-400" style="font-size: 0.7rem;"></i> CIBL√â %</span>
            <span class="etats-mobile-value etats-mobile-cible-percent" data-category="${item.category}" style="color: ${item.isHighlight && ciblePercent !== '0%' && ciblePercent !== '0.00%' ? '#ef4444' : 'var(--text-light)'};">${ciblePercent}</span>
          </div>
          ${!hideEcart ? `
          <div class="etats-mobile-row">
            <span class="etats-mobile-label"><i class="fas fa-exchange-alt mr-1 text-yellow-400" style="font-size: 0.7rem;"></i> √âCART Montant</span>
            <span class="etats-mobile-value">-</span>
          </div>
          <div class="etats-mobile-row">
            <span class="etats-mobile-label"><i class="fas fa-exchange-alt mr-1 text-yellow-400" style="font-size: 0.7rem;"></i> √âCART %</span>
            <span class="etats-mobile-value">-</span>
          </div>
          ` : ''}
          <div class="etats-mobile-row">
            <span class="etats-mobile-label"><i class="fas fa-chart-bar mr-1 text-purple-400" style="font-size: 0.7rem;"></i> R√âEL Montant</span>
            <span class="etats-mobile-value"><input type="text" readonly class="etats-resultats-input bg-transparent border-none" style="color: var(--text-light); outline: none; text-align: right; width: 100%;" value="${actuelMontant}" data-category="${item.category}" data-field="actuel-montant-mobile"></span>
          </div>
          <div class="etats-mobile-row">
            <span class="etats-mobile-label"><i class="fas fa-chart-bar mr-1 text-purple-400" style="font-size: 0.7rem;"></i> R√âEL %</span>
            <span class="etats-mobile-value etats-mobile-actuel-percent" data-category="${item.category}">${actuelPercent}</span>
          </div>
        </div>
      `;
    } else if (item.type === 'total') {
      // Ne pas afficher TOTAL √âCART si la colonne √©cart est masqu√©e
      if (item.category === 'total-ecart' && hideEcart) {
        return; // Skip cette carte
      }

      // R√©cup√©rer les donn√©es des totaux
      const budgetMontantCell = document.querySelector(`[data-category="${item.category}"][data-field="budget-montant"]`);
      const budgetPercentCell = budgetMontantCell?.nextElementSibling;
      const actuelMontantCell = document.querySelector(`[data-category="${item.category}"][data-field="actuel-montant"]`);
      const actuelPercentCell = document.querySelector(`[data-category="${item.category}"][data-field="actuel-percent"]`);
      const ecartMontantCell = document.querySelector(`[data-category="${item.category}"][data-field="ecart-montant"]`);
      const ecartPercentCell = document.querySelector(`[data-category="${item.category}"][data-field="ecart-percent"]`);

      const budgetMontant = budgetMontantCell?.textContent.trim() || '-';
      const budgetPercent = budgetPercentCell?.textContent.trim() || '-';
      const actuelMontant = actuelMontantCell?.textContent.trim() || '0 $';
      const actuelPercent = actuelPercentCell?.textContent.trim() || '0%';
      const ecartMontant = ecartMontantCell?.textContent.trim() || '-';
      const ecartPercent = ecartPercentCell?.textContent.trim() || '-';

      html += `
        <div class="etats-mobile-total-card">
          <div class="etats-mobile-card-header" style="border-color: ${item.color};">
            <i class="${item.icon}" style="color: ${item.color};"></i>
            <span>${item.label}</span>
          </div>
          ${budgetMontant !== '-' ? `
          <div class="etats-mobile-row">
            <span class="etats-mobile-label"><i class="fas fa-bullseye mr-1 text-blue-400" style="font-size: 0.7rem;"></i> CIBL√â Budget</span>
            <span class="etats-mobile-value" style="color: ${item.color};">${budgetMontant}</span>
          </div>
          <div class="etats-mobile-row">
            <span class="etats-mobile-label"><i class="fas fa-bullseye mr-1 text-blue-400" style="font-size: 0.7rem;"></i> CIBL√â %</span>
            <span class="etats-mobile-value" style="color: ${item.color};">${budgetPercent}</span>
          </div>
          ` : ''}
          ${!hideEcart && item.category === 'total-ecart' ? `
          <div class="etats-mobile-row">
            <span class="etats-mobile-label"><i class="fas fa-exchange-alt mr-1 text-yellow-400" style="font-size: 0.7rem;"></i> √âCART Montant</span>
            <span class="etats-mobile-value">${ecartMontant}</span>
          </div>
          <div class="etats-mobile-row">
            <span class="etats-mobile-label"><i class="fas fa-exchange-alt mr-1 text-yellow-400" style="font-size: 0.7rem;"></i> √âCART %</span>
            <span class="etats-mobile-value">${ecartPercent}</span>
          </div>
          ` : ''}
          <div class="etats-mobile-row">
            <span class="etats-mobile-label"><i class="fas fa-chart-bar mr-1 text-purple-400" style="font-size: 0.7rem;"></i> R√âEL Actuel</span>
            <span class="etats-mobile-value"><input type="text" readonly class="etats-resultats-input bg-transparent border-none" style="color: var(--text-light); outline: none; text-align: right; width: 100%;" value="${actuelMontant}" data-category="${item.category}"></span>
          </div>
          <div class="etats-mobile-row">
            <span class="etats-mobile-label"><i class="fas fa-chart-bar mr-1 text-purple-400" style="font-size: 0.7rem;"></i> R√âEL %</span>
            <span class="etats-mobile-value">${actuelPercent}</span>
          </div>
        </div>
      `;
    }
  });

  container.innerHTML = html;
}

// Initialiser au chargement de la page
document.addEventListener('DOMContentLoaded', async () => {
  log('üöÄ [DOM] DOMContentLoaded √©v√©nement d√©clench√© pour √âtats des R√©sultats');

  // D√©tecter si un coach n'a pas encore s√©lectionn√© d'entrepreneur
  const userRole = localStorage.getItem('userRole');
  const isCoach = userRole === 'coach';
  const urlParams = new URLSearchParams(window.location.search);
  const userParam = urlParams.get('user');
  const coachUsername = localStorage.getItem('username');
  const userParamIsCoach = userParam && userParam === coachUsername;
  const isCoachModeWithoutSelection = isCoach && (!userParam || userParamIsCoach);

  if (isCoachModeWithoutSelection) {
    log('[√âTATS] Mode coach d√©tect√© - L\'initialisation sera faite apr√®s la s√©lection d\'entrepreneur');
    return;
  }

  // Attendre un peu pour que le DOM soit compl√®tement charg√©
  setTimeout(async () => {
    log('‚è∞ [DOM] setTimeout 500ms termin√©, d√©but de l\'initialisation');

    try {
      // Attendre que l'initialisation soit compl√®te (inclut le chargement des donn√©es)
      log('üìã [DOM] Appel de initEtatsResultatsEditor()');
      await initEtatsResultatsEditor();
      log('‚úÖ [DOM] initEtatsResultatsEditor() termin√©');

      log('üì± [DOM] Appel de generateEtatsMobile()');
      generateEtatsMobile();

      // NOTE: Ne PAS appeler updateCibleCalculations() ici car les donn√©es CIBL√â
      // ont d√©j√† √©t√© charg√©es par initEtatsResultatsEditor(). L'appeler √©craserait
      // les valeurs sauvegard√©es avec les valeurs par d√©faut.
      log('‚úÖ [DOM] Initialisation compl√®te des √âtats des R√©sultats');

      // Marquer comme initialis√©
      window.etatsResultatsInitialized = true;
    } catch (error) {
      error('‚ùå [DOM] Erreur lors de l\'initialisation des √âtats des R√©sultats:', error);
      error('‚ùå [DOM] Stack:', error.stack);
    }
  }, 500);
});

// ============================================
// SECTION HEBDOMADAIRE - MOBILE
// ============================================

let currentMobileWeek = 1; // Semaine par d√©faut

// Afficher le weekSelector sur mobile seulement
function initMobileWeekly() {
  if (window.innerWidth <= 600) {
    const weekSelector = document.getElementById('weekSelector');
    if (weekSelector) {
      log('[Mobile Weekly] WeekSelector initialis√©');

      // R√©initialiser les event listeners pour ce dropdown
      const button = weekSelector.querySelector('.custom-select-button');

      // Cloner et remplacer pour supprimer tous les event listeners
      const newButton = button.cloneNode(true);
      button.parentNode.replaceChild(newButton, button);

      // Ajouter le nouveau event listener
      newButton.addEventListener('click', (e) => {
        e.stopPropagation();

        // Close other dropdowns
        document.querySelectorAll('.custom-select').forEach(s => {
          if (s !== weekSelector) s.classList.remove('open');
        });

        weekSelector.classList.toggle('open');
        log('[Mobile Weekly] Dropdown toggled:', weekSelector.classList.contains('open'));
      });

      // Remplir le dropdown avec les vraies dates des semaines APR√àS avoir configur√© les listeners
      setTimeout(() => {
        populateWeekDropdown();
      }, 100);
    }

    // Charger la semaine 1 par d√©faut avec un d√©lai pour s'assurer que les donn√©es sont charg√©es
    setTimeout(() => {
      updateMobileWeeklyView(1);
    }, 400);
  }
}

// Remplir le dropdown de semaines avec les vraies dates
function populateWeekDropdown() {
  const table = document.getElementById('objectifsTable');
  if (!table) {
    log('[populateWeekDropdown] Table non trouv√©e');
    return;
  }

  const rows = table.querySelectorAll('tbody tr');
  const dropdown = document.getElementById('weekSelectorDropdown');
  const weekSelector = document.getElementById('weekSelector');

  if (!dropdown || !weekSelector) {
    log('[populateWeekDropdown] Dropdown ou weekSelector non trouv√©');
    return;
  }

  log('[populateWeekDropdown] Remplissage avec', rows.length, 'semaines');

  // Vider le dropdown
  dropdown.innerHTML = '';

  let firstWeekLabel = null;

  // Parcourir les semaines du tableau
  rows.forEach((row, index) => {
    const weekLabel = row.querySelector('td:first-child')?.textContent.trim();
    if (weekLabel) {
      const weekNumber = index + 1;

      // Garder le label de la premi√®re semaine
      if (weekNumber === 1) {
        firstWeekLabel = weekLabel;
      }

      const option = document.createElement('div');
      option.className = 'custom-select-option';
      if (weekNumber === 1) {
        option.classList.add('selected');
      }
      option.dataset.week = weekNumber;
      option.textContent = weekLabel;

      // Event listener pour cette option
      option.addEventListener('click', (e) => {
        e.stopPropagation();
        log('[Mobile Weekly] Semaine s√©lectionn√©e:', weekNumber, weekLabel);

        // Mettre √† jour la s√©lection
        dropdown.querySelectorAll('.custom-select-option').forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');

        // Update button text avec la vraie date
        const text = weekSelector.querySelector('.custom-select-text');
        if (text) text.textContent = weekLabel;

        // Close dropdown
        weekSelector.classList.remove('open');

        // Mettre √† jour la vue
        updateMobileWeeklyView(weekNumber);
      });

      dropdown.appendChild(option);
    }
  });

  // Mettre √† jour le texte du bouton avec la premi√®re semaine APR√àS avoir cr√©√© toutes les options
  if (firstWeekLabel) {
    const text = weekSelector.querySelector('.custom-select-text');
    if (text) {
      text.textContent = firstWeekLabel;
      log('[populateWeekDropdown] Texte du bouton mis √† jour:', firstWeekLabel);
    }
  }
}

// Mettre √† jour la vue mobile avec les donn√©es de la semaine s√©lectionn√©e
function updateMobileWeeklyView(weekNumber) {
  // V√©rifier si on est sur mobile
  if (window.innerWidth > 768) return;

  currentMobileWeek = weekNumber;

  // R√©cup√©rer les inputs de cette semaine depuis le tableau
  const table = document.getElementById('objectifsTable');
  if (!table) return;

  const rows = table.querySelectorAll('tbody tr');
  const weekRow = rows[weekNumber - 1]; // 0-indexed

  if (!weekRow) {
    log('[Mobile Weekly] Semaine', weekNumber, 'introuvable dans le tableau');
    return;
  }

  log('[Mobile Weekly] Chargement de la semaine', weekNumber);

  // Extraire les donn√©es de la semaine
  const cells = weekRow.querySelectorAll('td');
  const weekLabel = cells[0].textContent.trim();

  // Mettre √† jour le dropdown avec la vraie date
  const weekSelector = document.getElementById('weekSelector');
  if (weekSelector) {
    const weekText = weekSelector.querySelector('.custom-select-text');
    if (weekText) {
      weekText.textContent = weekLabel;
    }
  }

  // Inputs: H Marketing Vis√©, H Marketing R√©el, Estimation Vis√©, Estimation R√©el, etc.
  const hMarketingVise = cells[1].querySelector('input');
  const hMarketingReel = cells[2].querySelector('input');
  const estimationVise = cells[3].querySelector('input');
  const estimationReel = cells[4].querySelector('input');
  const contratVise = cells[5].querySelector('input');
  const contratReel = cells[6].querySelector('input');
  const dollarVise = cells[7].querySelector('input');
  const dollarReel = cells[8].querySelector('input');

  // Construire le HTML mobile pour Objectifs
  const objectifsContainer = document.getElementById('mobileWeeklyObjectifs');
  objectifsContainer.innerHTML = `
    <div style="margin-bottom: 1.25rem; padding: 1rem; background: linear-gradient(135deg, rgba(6, 182, 212, 0.15) 0%, rgba(6, 182, 212, 0.05) 100%); border-radius: 12px; border: 1px solid rgba(6, 182, 212, 0.3); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
      <div style="font-size: 0.95rem; color: var(--text-light); font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
        <i class="fas fa-calendar-week" style="color: #06b6d4; font-size: 1rem;"></i>
        ${weekLabel}
      </div>
    </div>

    <!-- H Marketing -->
    <div class="mobile-weekly-metric">
      <span class="mobile-weekly-metric-title"><i class="fas fa-bullhorn" style="color: #60a5fa;"></i>H Marketing</span>
      <div class="mobile-weekly-metric-values">
        <div class="mobile-weekly-metric-row">
          <span class="mobile-weekly-metric-label">Obj.</span>
          <input type="text" readonly class="mobile-weekly-metric-input rpo-metric-input" value="${hMarketingVise.value}" style="cursor: not-allowed; color: #9ca3af;">
        </div>
        <div class="mobile-weekly-metric-row">
          <span class="mobile-weekly-metric-label">R√©el</span>
          <input type="text" class="mobile-weekly-metric-input week-jan-input rpo-metric-input" value="${hMarketingReel.value}" ${hMarketingReel.hasAttribute('readonly') ? 'readonly style="cursor: not-allowed;"' : ''}>
        </div>
      </div>
    </div>

    <!-- Estimation -->
    <div class="mobile-weekly-metric">
      <span class="mobile-weekly-metric-title"><i class="fas fa-file-invoice" style="color: #34d399;"></i>Estimation #</span>
      <div class="mobile-weekly-metric-values">
        <div class="mobile-weekly-metric-row">
          <span class="mobile-weekly-metric-label">Obj.</span>
          <input type="text" readonly class="mobile-weekly-metric-input rpo-metric-input" value="${estimationVise.value}" style="cursor: not-allowed; color: #9ca3af;">
        </div>
        <div class="mobile-weekly-metric-row">
          <span class="mobile-weekly-metric-label">R√©el</span>
          <input type="text" class="mobile-weekly-metric-input week-jan-input rpo-metric-input" value="${estimationReel.value}" ${estimationReel.hasAttribute('readonly') ? 'readonly style="cursor: not-allowed;"' : ''}>
        </div>
      </div>
    </div>

    <!-- Contrat Sign√© -->
    <div class="mobile-weekly-metric">
      <span class="mobile-weekly-metric-title"><i class="fas fa-file-signature" style="color: #a78bfa;"></i>Contrat Sign√©</span>
      <div class="mobile-weekly-metric-values">
        <div class="mobile-weekly-metric-row">
          <span class="mobile-weekly-metric-label">Obj.</span>
          <input type="text" readonly class="mobile-weekly-metric-input rpo-metric-input" value="${contratVise.value}" style="cursor: not-allowed; color: #9ca3af;">
        </div>
        <div class="mobile-weekly-metric-row">
          <span class="mobile-weekly-metric-label">R√©el</span>
          <input type="text" class="mobile-weekly-metric-input week-jan-input rpo-metric-input" value="${contratReel.value}" ${contratReel.hasAttribute('readonly') ? 'readonly style="cursor: not-allowed;"' : ''}>
        </div>
      </div>
    </div>

    <!-- $ Sign√© -->
    <div class="mobile-weekly-metric">
      <span class="mobile-weekly-metric-title"><i class="fas fa-dollar-sign" style="color: #fb923c;"></i>$ Sign√©</span>
      <div class="mobile-weekly-metric-values">
        <div class="mobile-weekly-metric-row">
          <span class="mobile-weekly-metric-label">Obj.</span>
          <input type="text" readonly class="mobile-weekly-metric-input rpo-metric-input" value="${dollarVise.value}" style="cursor: not-allowed; color: #9ca3af;">
        </div>
        <div class="mobile-weekly-metric-row">
          <span class="mobile-weekly-metric-label">R√©el</span>
          <input type="text" class="mobile-weekly-metric-input week-jan-input rpo-metric-input" value="${dollarReel.value}" ${dollarReel.hasAttribute('readonly') ? 'readonly style="cursor: not-allowed;"' : ''}>
        </div>
      </div>
    </div>
  `;

  // Construire le HTML mobile pour R√©sum√©
  const resumeTable = document.getElementById('resumeTable');
  const resumeRows = resumeTable.querySelectorAll('tbody tr');
  const resumeRow = resumeRows[weekNumber - 1];

  if (resumeRow) {
    const resumeCells = resumeRow.querySelectorAll('td');
    const stars = resumeCells[1].querySelectorAll('.star-rating');
    const problemeInput = resumeCells[2].querySelector('input');
    const focusInput = resumeCells[3].querySelector('input');

    // D√©terminer le rating actuel
    let currentRating = 0;
    stars.forEach((star, index) => {
      if (star.style.color !== 'rgb(55, 65, 81)' && star.style.color !== '#374151') {
        currentRating = index + 1;
      }
    });

    // V√©rifier si en mode √©dition
    const editBtn = document.getElementById('editWeekJanBtn');
    const isEditMode = editBtn && editBtn.classList.contains('hidden');

    // Afficher les √©toiles seulement si rating > 0 OU en mode √©dition
    const showStars = currentRating > 0 || isEditMode;

    const resumeContainer = document.getElementById('mobileWeeklyResume');
    resumeContainer.innerHTML = `
      <div style="margin-bottom: 1.25rem; padding: 1rem; background: linear-gradient(135deg, rgba(6, 182, 212, 0.15) 0%, rgba(6, 182, 212, 0.05) 100%); border-radius: 12px; border: 1px solid rgba(6, 182, 212, 0.3); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
        <div style="font-size: 0.95rem; color: var(--text-light); font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-calendar-week" style="color: #06b6d4; font-size: 1rem;"></i>
          ${weekLabel}
        </div>
      </div>

      <!-- Comment vas-tu -->
      <div class="mobile-weekly-resume-item">
        <span class="mobile-weekly-resume-title"><i class="fas fa-smile" style="color: #fbbf24;"></i>Comment vas-tu</span>
        ${showStars ? `
        <div class="mobile-weekly-stars">
          ${[1, 2, 3, 4, 5].map(rating => `
            <i class="fas fa-star cursor-pointer hover:scale-110 transition-all star-rating"
               style="color: ${rating <= currentRating ? '#fbbf24' : '#374151'};"
               data-week="${weekNumber}"
               data-rating="${rating}"
               onclick="handleMobileStarClick(${weekNumber}, ${rating})"></i>
          `).join('')}
        </div>
        ` : `
        <div style="padding: 0.625rem 0.75rem; background: rgba(15, 23, 42, 0.3); border-radius: 8px; border: 1px solid rgba(51, 65, 85, 0.3); color: var(--text-gray); font-size: 0.875rem; font-style: italic;">
          Aucune √©valuation
        </div>
        `}
      </div>

      <!-- Analyse de la semaine -->
      <div class="mobile-weekly-resume-item">
        <span class="mobile-weekly-resume-title"><i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>Analyse de la semaine pass√©e</span>
        <input type="text" class="mobile-weekly-resume-input week-jan-resume rpo-metric-input"
               value="${problemeInput.value}"
               placeholder="Probl√®me..."
               ${problemeInput.hasAttribute('readonly') ? 'readonly style="cursor: not-allowed; opacity: 0.6;"' : ''}>
      </div>

      <!-- Focus de la semaine -->
      <div class="mobile-weekly-resume-item">
        <span class="mobile-weekly-resume-title"><i class="fas fa-bullseye" style="color: #10b981;"></i>Focus de la semaine</span>
        <input type="text" class="mobile-weekly-resume-input week-jan-resume rpo-metric-input"
               value="${focusInput.value}"
               placeholder="Focus..."
               ${focusInput.hasAttribute('readonly') ? 'readonly style="cursor: not-allowed; opacity: 0.6;"' : ''}>
      </div>
    `;
  }
}

// G√©rer le clic sur les √©toiles mobile
function handleMobileStarClick(weekNumber, rating) {
  // Trouver les √©toiles dans le tableau original
  const resumeTable = document.getElementById('resumeTable');
  const resumeRows = resumeTable.querySelectorAll('tbody tr');
  const resumeRow = resumeRows[weekNumber - 1];

  if (resumeRow) {
    const stars = resumeRow.querySelectorAll('.star-rating');
    // Simuler le clic sur l'√©toile correspondante
    const targetStar = Array.from(stars).find(s => s.dataset.rating == rating);
    if (targetStar) {
      targetStar.click();
      // Mettre √† jour l'affichage mobile
      setTimeout(() => updateMobileWeeklyView(weekNumber), 100);
    }
  }
}

// Initialiser la vue mobile au chargement
document.addEventListener('DOMContentLoaded', () => {
  log('[Mobile Weekly] Initialisation de la vue mobile');

  // Initialiser la vue mobile (les event listeners sont g√©r√©s par initCustomDropdowns)
  initMobileWeekly();

  // R√©initialiser lors du resize
  window.addEventListener('resize', () => {
    initMobileWeekly();
  });
});

</script>

<!-- Entrepreneur Selector - Pour coaches ET direction -->
<style>
  /* Custom scrollbar pour le modal RPO */
  #incomplete-weeks-list::-webkit-scrollbar,
  #quick-fill-form::-webkit-scrollbar {
    width: 6px;
  }

  #incomplete-weeks-list::-webkit-scrollbar-track,
  #quick-fill-form::-webkit-scrollbar-track {
    background: rgba(30, 41, 59, 0.3);
    border-radius: 3px;
  }

  #incomplete-weeks-list::-webkit-scrollbar-thumb,
  #quick-fill-form::-webkit-scrollbar-thumb {
    background: rgba(96, 165, 250, 0.5);
    border-radius: 3px;
  }

  #incomplete-weeks-list::-webkit-scrollbar-thumb:hover,
  #quick-fill-form::-webkit-scrollbar-thumb:hover {
    background: rgba(96, 165, 250, 0.7);
  }
</style>

<!-- Modal Pop-up Notifications RPO -->
<div id="rpo-notifications-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); z-index: 10000; align-items: center; justify-content: center;">
  <div class="stats-modal-content" style="max-width: 1400px; width: 95%; height: 650px; background: var(--bg-card, #1e293b); border-radius: 1.5rem; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column;">
    <!-- Header du modal -->
    <div class="stats-modal-header" style="padding: 1rem 1.5rem; border-bottom: 1px solid rgba(71, 85, 105, 0.3); background: rgba(15, 23, 42, 0.5); border-radius: 1.5rem 1.5rem 0 0; flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;">
      <h2 style="margin: 0; font-size: 1.25rem; font-weight: 700; color: var(--text-light); display: flex; align-items: center;">
        <i class="fas fa-exclamation-triangle" style="color: #ef4444; margin-right: 0.5rem;"></i>
        Donn√©es manquantes - Remplissez tous les champs
      </h2>
      <button id="close-rpo-notifications-modal" onclick="closeRpoNotificationsModal()" style="display: none; align-items: center; justify-content: center; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; transition: all 0.2s; font-size: 1.125rem;" onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'; this.style.borderColor='rgba(239, 68, 68, 0.5)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.borderColor='rgba(239, 68, 68, 0.3)'">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Contenu du modal -->
    <div class="stats-modal-body" style="padding: 1rem 1.5rem; flex: 1; display: flex; flex-direction: column;">
      <!-- Contenu en 2 colonnes -->
      <div style="display: grid; grid-template-columns: 320px 1fr; gap: 1.25rem; flex: 1; overflow: hidden;">
        <!-- Colonne gauche: Liste des semaines -->
        <div style="display: flex; flex-direction: column; min-height: 0;">
          <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--text-gray); margin: 0 0 0.5rem 0; text-transform: uppercase; letter-spacing: 0.5px;">
            <i class="fas fa-list-ul" style="margin-right: 0.375rem;"></i>
            Semaines √† compl√©ter
          </h3>
          <div id="incomplete-weeks-list" style="overflow-y: auto; flex: 1; padding-right: 0.5rem;"></div>
        </div>

        <!-- Colonne droite: Formulaire -->
        <div style="display: flex; flex-direction: column; min-height: 0;">
          <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--text-gray); margin: 0 0 0.5rem 0; text-transform: uppercase; letter-spacing: 0.5px;">
            <i class="fas fa-edit" style="margin-right: 0.375rem;"></i>
            Formulaire de saisie
          </h3>
          <div id="quick-fill-form" style="overflow-y: auto; flex: 1; padding-right: 0.5rem;">
            <div id="quick-fill-inputs"></div>
          </div>
        </div>
      </div>

      <!-- Bouton d'enregistrement -->
      <div style="display: flex; justify-content: flex-end; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(51, 65, 85, 0.3);">
        <button class="btn-primary" id="save-rpo-btn" onclick="saveQuickFillData()" disabled style="opacity: 0.5; cursor: not-allowed;">
          <i class="fas fa-save"></i>
          Enregistrer et acc√©der au RPO
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ===== FONCTIONS POUR LE MODAL DE NOTIFICATIONS RPO =====

// Fermer le modal
function closeNotificationsModal() {
  const modal = document.getElementById('rpo-notifications-modal');
  if (modal) {
    modal.style.display = 'none';
  }

  // D√©bloquer le contenu RPO
  const rpoContent = document.querySelector('.w-full');
  if (rpoContent) {
    rpoContent.style.filter = 'none';
    rpoContent.style.pointerEvents = 'auto';
  }
}

// Alias pour fermer le modal (utilis√© par le bouton X)
function closeRpoNotificationsModal() {
  closeNotificationsModal();
}

// Afficher le modal avec les semaines incompl√®tes
function showNotificationsModal() {
  // NE PAS afficher le modal si c'est un coach sans s√©lection d'entrepreneur
  const userRole = localStorage.getItem('userRole');
  const isCoach = userRole === 'coach' || userRole === 'direction';

  // V√©rifier si un entrepreneur est s√©lectionn√©
  const hasSelection = document.body.classList.contains('has-selection') ||
                      window.selectedEntrepreneurUsername ||
                      document.getElementById('coach-entrepreneur-selector')?.classList.contains('in-header');

  if (isCoach && !hasSelection) {
    console.log('[RPO NOTIFICATIONS] Coach sans s√©lection - modal bloqu√©');
    return;
  }

  // NOUVEAU: Combiner les semaines en d√©tectant TOUS les champs manquants pour chaque semaine
  const allIncompleteWeeks = [];
  const processedWeeks = new Map(); // Pour √©viter les doublons

  // Fonction pour ajouter/mettre √† jour une semaine
  const addOrUpdateWeek = (week, missingType) => {
    const key = `${week.monthIndex}-${week.weekNumber}`;

    if (!processedWeeks.has(key)) {
      // Nouvelle semaine - v√©rifier TOUS les champs manquants
      const monthData = window.weeklyData?.[String(week.monthIndex)]?.[String(week.weekNumber)];

      // V√©rifier h_marketing
      const hMarketing = monthData?.h_marketing;
      const marketingMissing = (hMarketing === '-' || hMarketing === '' || hMarketing === undefined || hMarketing === null);

      // V√©rifier r√©sum√© (probl√®me/focus/rating)
      let probleme = '';
      let focus = '';

      // Prioritize direct fields, fallback to commentaire parsing
      if (monthData?.probleme !== undefined) {
        probleme = monthData.probleme;
      } else {
        const commentaireRaw = monthData?.commentaire || '';
        if (commentaireRaw.includes('|')) {
          const parts = commentaireRaw.split('|');
          parts.forEach(part => {
            const trimmed = part.trim();
            if (trimmed.startsWith('Probl√®me:')) probleme = trimmed.replace('Probl√®me:', '').trim();
          });
        }
      }

      if (monthData?.focus !== undefined) {
        focus = monthData.focus;
      } else {
        const commentaireRaw = monthData?.commentaire || '';
        if (commentaireRaw.includes('|')) {
          const parts = commentaireRaw.split('|');
          parts.forEach(part => {
            const trimmed = part.trim();
            if (trimmed.startsWith('Focus:')) focus = trimmed.replace('Focus:', '').trim();
          });
        }
      }

      const problemeIncomplete = (probleme === '' || probleme === '-');
      const focusIncomplete = (focus === '' || focus === '-');
      const rating = monthData?.rating || 0;
      const ratingIncomplete = (rating === 0);
      const resumeMissing = problemeIncomplete || focusIncomplete || ratingIncomplete;

      // D√©terminer le type en fonction de ce qui manque
      let type;
      if (marketingMissing && resumeMissing) {
        type = 'both';
      } else if (marketingMissing) {
        type = 'marketing';
      } else if (resumeMissing) {
        type = 'resume';
      } else {
        return; // Rien ne manque, ne pas ajouter
      }

      const weekData = {
        ...week,
        type: type,
        label: type === 'both' ? 'Les deux' : (type === 'marketing' ? 'H Marketing' : 'R√©sum√©')
      };

      processedWeeks.set(key, weekData);
      allIncompleteWeeks.push(weekData);
    }
  };

  // Parcourir les semaines d√©tect√©es comme incompl√®tes
  if (window.incompleteObjectifsWeeks) {
    window.incompleteObjectifsWeeks.forEach(week => addOrUpdateWeek(week, 'marketing'));
  }

  if (window.incompleteResumeWeeks) {
    window.incompleteResumeWeeks.forEach(week => addOrUpdateWeek(week, 'resume'));
  }

  if (allIncompleteWeeks.length === 0) {
    console.log('[RPO NOTIFICATIONS] Aucune semaine incompl√®te');
    return;
  }

  // G√©n√©rer la liste des semaines
  generateIncompleteWeeksList(allIncompleteWeeks);

  // G√©n√©rer les inputs
  generateQuickFillInputs(allIncompleteWeeks);

  // Bloquer le contenu RPO en arri√®re-plan
  const rpoContent = document.querySelector('.w-full');
  if (rpoContent) {
    rpoContent.style.filter = 'blur(8px)';
    rpoContent.style.pointerEvents = 'none';
  }

  // Afficher le modal
  const modal = document.getElementById('rpo-notifications-modal');
  if (modal) {
    modal.style.display = 'flex';
  }

  // Afficher le bouton X uniquement pour les coachs
  const closeBtn = document.getElementById('close-rpo-notifications-modal');
  if (closeBtn && isCoach) {
    closeBtn.style.display = 'flex';
  }

  console.log('[RPO NOTIFICATIONS] Modal affich√© avec', allIncompleteWeeks.length, 'semaines incompl√®tes');
}

// Variable globale pour la semaine s√©lectionn√©e
let selectedWeekIndex = 0;

// Calculer les dates de d√©but et fin de semaine + temps √©coul√©
function getWeekDates(monthIndex, weekNumber) {
  const fiscalYearStart = new Date(2026, 0, 5); // 5 janvier 2026

  // Calculer le num√©ro de semaine global
  let globalWeekNumber;
  
    globalWeekNumber = 13 + (monthIndex * 4) + weekNumber;
  

  // Calculer la date de d√©but de la semaine
  const weekStartDate = new Date(fiscalYearStart);
  weekStartDate.setDate(fiscalYearStart.getDate() + (globalWeekNumber - 1) * 7);

  // Date de fin (6 jours apr√®s le d√©but)
  const weekEndDate = new Date(weekStartDate);
  weekEndDate.setDate(weekStartDate.getDate() + 6);

  // Formater les dates
  const startDay = weekStartDate.getDate();
  const endDay = weekEndDate.getDate();
  const monthNames = ['janv.', 'f√©vr.', 'mars', 'avr.', 'mai', 'juin', 'juil.', 'ao√ªt', 'sept.', 'oct.', 'nov.', 'd√©c.'];
  const monthName = monthNames[weekEndDate.getMonth()];

  // Calculer "il y a X semaines"
  const today = new Date();
  const weeksAgo = Math.floor((today - weekEndDate) / (7 * 24 * 60 * 60 * 1000));
  const timeAgo = weeksAgo === 0 ? 'cette semaine' : weeksAgo === 1 ? 'il y a 1 semaine' : `il y a ${weeksAgo} semaines`;

  return {
    dateRange: `Du ${startDay}-${endDay} ${monthName}`,
    timeAgo: timeAgo
  };
}

// G√©n√©rer la liste des semaines incompl√®tes
function generateIncompleteWeeksList(weeks) {
  const container = document.getElementById('incomplete-weeks-list');
  if (!container) return;

  let html = '<div style="display: flex; flex-direction: column; gap: 0.375rem;">';

  weeks.forEach((week, index) => {
    const weekKey = `${week.monthIndex}-${week.weekNumber}`;
    const isValid = window.weekValidation[weekKey];
    const typeLabel = week.type === 'marketing' ? 'H Marketing' : (week.type === 'resume' ? 'R√©sum√©' : 'Les deux');
    const dates = getWeekDates(week.monthIndex, week.weekNumber);
    const isSelected = index === selectedWeekIndex;

    let bgColor, borderColor, iconClass, iconColor;

    if (isValid) {
      bgColor = 'rgba(16, 185, 129, 0.2)';
      borderColor = '#10b981';
      iconClass = 'fa-check-circle';
      iconColor = '#10b981';
    } else if (isSelected) {
      bgColor = 'rgba(59, 130, 246, 0.2)';
      borderColor = '#3b82f6';
      iconClass = 'fa-exclamation-circle';
      iconColor = '#3b82f6';
    } else {
      bgColor = 'rgba(239, 68, 68, 0.1)';
      borderColor = '#ef4444';
      iconClass = 'fa-exclamation-circle';
      iconColor = '#ef4444';
    }

    html += `
      <div onclick="selectWeek(${index})" style="padding: 0.5rem 0.625rem; background: ${bgColor}; border-left: 3px solid ${borderColor}; border-radius: 0.375rem; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; transition: all 0.2s;">
        <i class="fas ${iconClass}" style="color: ${iconColor}; font-size: 0.875rem;"></i>
        <div style="flex: 1;">
          <div style="font-weight: 600; color: var(--text-light); font-size: 0.8rem; line-height: 1.2;">${dates.dateRange}</div>
          <div style="font-size: 0.65rem; color: var(--text-gray); line-height: 1.2; margin-top: 0.125rem;">${dates.timeAgo} ‚Ä¢ ${typeLabel}</div>
        </div>
      </div>
    `;
  });

  html += '</div>';

  container.innerHTML = html;
}

// Sauvegarder les donn√©es de la semaine actuelle dans modalWeekData
function saveCurrentWeekToMemory() {
  const inputs = document.querySelectorAll('#quick-fill-inputs input[type="text"]');
  const textareas = document.querySelectorAll('#quick-fill-inputs textarea');
  const ratingInput = document.getElementById('rating-value');

  if (inputs.length === 0 && textareas.length === 0) return;

  const monthIndex = inputs[0]?.getAttribute('data-month') || textareas[0]?.getAttribute('data-month');
  const weekNumber = inputs[0]?.getAttribute('data-week') || textareas[0]?.getAttribute('data-week');
  const weekKey = `${monthIndex}-${weekNumber}`;

  // Sauvegarder dans modalWeekData
  window.modalWeekData[weekKey] = {
    monthIndex: parseInt(monthIndex),
    weekNumber: parseInt(weekNumber),
    h_marketing: null,
    probleme: null,
    focus: null,
    rating: 0
  };

  // H Marketing
  inputs.forEach(input => {
    const value = input.dataset.value || input.value.replace(/[^\d.-]/g, '');
    if (value && value !== '') {
      window.modalWeekData[weekKey].h_marketing = parseFloat(value);
    }
  });

  // Textareas
  textareas.forEach(textarea => {
    const field = textarea.getAttribute('data-field');
    if (field === 'probleme') {
      window.modalWeekData[weekKey].probleme = textarea.value.trim();
    } else if (field === 'focus') {
      window.modalWeekData[weekKey].focus = textarea.value.trim();
    }
  });

  // Rating
  if (ratingInput) {
    window.modalWeekData[weekKey].rating = parseInt(ratingInput.value) || 0;
  }
}

// S√©lectionner une semaine
function selectWeek(index) {
  // Sauvegarder la semaine actuelle avant de changer
  saveCurrentWeekToMemory();

  selectedWeekIndex = index;
  const allWeeks = [
    ...(window.incompleteObjectifsWeeks || []).map(w => ({ ...w, type: 'marketing', label: 'H Marketing Vis√©' })),
    ...(window.incompleteResumeWeeks || []).map(w => ({ ...w, type: 'resume', label: 'R√©sum√©' }))
  ];

  // Recombiner pour g√©rer les semaines avec les deux types
  const combinedWeeks = [];
  allWeeks.forEach(week => {
    const existing = combinedWeeks.find(w => w.monthIndex === week.monthIndex && w.weekNumber === week.weekNumber);
    if (!existing) {
      combinedWeeks.push(week);
    } else if (existing.type !== week.type) {
      existing.type = 'both';
    }
  });

  generateIncompleteWeeksList(combinedWeeks);
  generateQuickFillInputs(combinedWeeks);

  // Restaurer les donn√©es si elles existent
  const week = combinedWeeks[index];
  if (week) {
    const weekKey = `${week.monthIndex}-${week.weekNumber}`;
    const savedData = window.modalWeekData[weekKey];

    if (savedData) {
      // Restaurer H Marketing
      const hMarketingInput = document.querySelector(`input[data-field="h_marketing"]`);
      if (hMarketingInput && savedData.h_marketing !== null) {
        hMarketingInput.value = savedData.h_marketing;
        hMarketingInput.dataset.value = savedData.h_marketing;
        formatHMarketingInput(hMarketingInput);
      }

      // Restaurer Probl√®me
      const problemeInput = document.querySelector(`textarea[data-field="probleme"]`);
      if (problemeInput && savedData.probleme) {
        problemeInput.value = savedData.probleme;
      }

      // Restaurer Focus
      const focusInput = document.querySelector(`textarea[data-field="focus"]`);
      if (focusInput && savedData.focus) {
        focusInput.value = savedData.focus;
      }

      // Restaurer Rating
      const ratingInput = document.getElementById('rating-value');
      if (ratingInput && savedData.rating > 0) {
        ratingInput.value = savedData.rating;
        const stars = document.querySelectorAll('.star-rating');
        stars.forEach((star, idx) => {
          if (idx < savedData.rating) {
            star.style.color = '#fbbf24';
          } else {
            star.style.color = '#374151';
          }
        });
      }

      // Revalider
      validateCurrentWeek();
    }
  }
}

// Valider la semaine actuelle
function validateCurrentWeek() {
  const inputs = document.querySelectorAll('#quick-fill-inputs input[type="text"]');
  const textareas = document.querySelectorAll('#quick-fill-inputs textarea');
  const ratingInput = document.getElementById('rating-value');

  let isValid = true;

  // V√©rifier les inputs (H Marketing R√©el)
  inputs.forEach(input => {
    const dataValue = input.dataset.value;
    const value = input.value.replace(/[^\d.-]/g, '');
    // Valide si dataset.value existe ou si value n'est pas vide
    if ((!dataValue || dataValue === '') && (!value || value === '')) {
      isValid = false;
    }
  });

  // V√©rifier les textareas
  textareas.forEach(textarea => {
    if (!textarea.value || textarea.value === '') {
      isValid = false;
    }
  });

  // V√©rifier le rating
  if (ratingInput && parseInt(ratingInput.value) === 0) {
    isValid = false;
  }

  // Stocker l'√©tat de validation
  if (inputs.length > 0 || textareas.length > 0) {
    const monthIndex = inputs[0]?.getAttribute('data-month') || textareas[0]?.getAttribute('data-month');
    const weekNumber = inputs[0]?.getAttribute('data-week') || textareas[0]?.getAttribute('data-week');
    const weekKey = `${monthIndex}-${weekNumber}`;
    window.weekValidation[weekKey] = isValid;
  }

  // Sauvegarder automatiquement dans modalWeekData
  saveCurrentWeekToMemory();

  // Mettre √† jour l'affichage de la liste
  updateWeekListColors();

  // Activer/d√©sactiver le bouton
  updateSaveButton();
}

// Mettre √† jour les couleurs de la liste
function updateWeekListColors() {
  const weekItems = document.querySelectorAll('#incomplete-weeks-list > div > div');
  const allWeeks = [
    ...(window.incompleteObjectifsWeeks || []).map(w => ({ ...w, type: 'marketing' })),
    ...(window.incompleteResumeWeeks || []).map(w => ({ ...w, type: 'resume' }))
  ];

  const combinedWeeks = [];
  allWeeks.forEach(week => {
    const existing = combinedWeeks.find(w => w.monthIndex === week.monthIndex && w.weekNumber === week.weekNumber);
    if (!existing) {
      combinedWeeks.push(week);
    } else if (existing.type !== week.type) {
      existing.type = 'both';
    }
  });

  weekItems.forEach((item, index) => {
    const week = combinedWeeks[index];
    if (!week) return;

    const weekKey = `${week.monthIndex}-${week.weekNumber}`;
    const isValid = window.weekValidation[weekKey];

    if (isValid) {
      item.style.background = 'rgba(16, 185, 129, 0.2)';
      item.style.borderLeft = '3px solid #10b981';
      const icon = item.querySelector('i');
      if (icon) {
        icon.className = 'fas fa-check-circle';
        icon.style.color = '#10b981';
      }
    } else if (index === selectedWeekIndex) {
      item.style.background = 'rgba(59, 130, 246, 0.2)';
      item.style.borderLeft = '3px solid #3b82f6';
    } else {
      item.style.background = 'rgba(239, 68, 68, 0.1)';
      item.style.borderLeft = '3px solid #ef4444';
    }
  });
}

// Activer/d√©sactiver le bouton (v√©rifier TOUTES les semaines)
function updateSaveButton() {
  const saveBtn = document.getElementById('save-rpo-btn');
  if (!saveBtn) return;

  // R√©cup√©rer toutes les semaines incompl√®tes
  const allWeeks = [
    ...(window.incompleteObjectifsWeeks || []).map(w => ({ ...w, type: 'marketing' })),
    ...(window.incompleteResumeWeeks || []).map(w => ({ ...w, type: 'resume' }))
  ];

  const combinedWeeks = [];
  allWeeks.forEach(week => {
    const existing = combinedWeeks.find(w => w.monthIndex === week.monthIndex && w.weekNumber === week.weekNumber);
    if (!existing) {
      combinedWeeks.push(week);
    } else if (existing.type !== week.type) {
      existing.type = 'both';
    }
  });

  // V√©rifier si TOUTES les semaines sont valid√©es
  const allValid = combinedWeeks.every(week => {
    const weekKey = `${week.monthIndex}-${week.weekNumber}`;
    return window.weekValidation[weekKey] === true;
  });

  if (allValid && combinedWeeks.length > 0) {
    saveBtn.disabled = false;
    saveBtn.style.opacity = '1';
    saveBtn.style.cursor = 'pointer';
  } else {
    saveBtn.disabled = true;
    saveBtn.style.opacity = '0.5';
    saveBtn.style.cursor = 'not-allowed';
  }
}

// Fonctions pour le syst√®me d'√©toiles
function setRating(star) {
  const rating = parseInt(star.getAttribute('data-rating'));
  const container = star.parentElement;
  const hiddenInput = document.getElementById('rating-value');

  hiddenInput.value = rating;

  // Mettre √† jour les couleurs des √©toiles
  const stars = container.querySelectorAll('.star-rating');
  stars.forEach((s, index) => {
    if (index < rating) {
      s.style.color = '#fbbf24';
    } else {
      s.style.color = '#374151';
    }
  });

  // Valider apr√®s le rating
  validateCurrentWeek();
}

function updateStarColors(container) {
  const hiddenInput = document.getElementById('rating-value');
  const rating = parseInt(hiddenInput.value);
  const stars = container.querySelectorAll('.star-rating');

  stars.forEach((s, index) => {
    if (index < rating) {
      s.style.color = '#fbbf24';
    } else {
      s.style.color = '#374151';
    }
  });
}

// Fonctions de formatage pour H Marketing R√©el
function formatHMarketingInput(input) {
  const value = input.value.replace(/[^\d.-]/g, '');
  const numValue = parseFloat(value);

  if (!isNaN(numValue) && numValue >= 0) {
    // Stocker la valeur num√©rique d√©cimale dans dataset
    input.dataset.value = numValue;

    // Arrondir pour affichage (0.3h ‚Üí 1h)
    const formatted = Math.ceil(numValue);
    input.value = formatted + ' h';
  } else if (value === '' || value === '-') {
    input.value = '';
    input.dataset.value = '';
  }

  // Valider apr√®s formatage
  validateCurrentWeek();
}

function unfocusHMarketingInput(input) {
  // Enlever le formatage pour permettre l'√©dition
  const value = input.dataset.value || input.value.replace(/[^\d.-]/g, '');
  if (value && value !== '') {
    input.value = value;
  }
}

// Stocker l'√©tat de validation de chaque semaine
window.weekValidation = {};

// Stocker temporairement les donn√©es de chaque semaine avant sauvegarde
window.modalWeekData = {};

// G√©n√©rer les inputs pour le remplissage rapide (seulement la semaine s√©lectionn√©e)
function generateQuickFillInputs(weeks) {
  const container = document.getElementById('quick-fill-inputs');
  if (!container) return;

  const week = weeks[selectedWeekIndex];
  if (!week) return;

  const dates = getWeekDates(week.monthIndex, week.weekNumber);
  const weekKey = `${week.monthIndex}-${week.weekNumber}`;

  let html = `
    <div style="padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.5rem; border: 2px solid rgba(59, 130, 246, 0.3);">
      <div style="font-weight: 600; color: var(--text-light); margin-bottom: 0.75rem; font-size: 0.85rem; display: flex; align-items: center; gap: 0.375rem;">
        <i class="fas fa-calendar-alt" style="color: #3b82f6; font-size: 0.875rem;"></i>
        ${dates.dateRange} (${dates.timeAgo})
      </div>
  `;

  // H Marketing R√©el
  if (week.type === 'marketing' || week.type === 'both') {
    html += `
      <div style="margin-bottom: 0.625rem;">
        <label style="display: block; font-size: 0.7rem; font-weight: 600; color: var(--text-gray); margin-bottom: 0.25rem;">
          <i class="fas fa-bullseye" style="margin-right: 0.25rem; color: #60a5fa;"></i>
          H Marketing R√©el
        </label>
        <input type="text"
               data-week-index="${selectedWeekIndex}"
               data-field="h_marketing"
               data-month="${week.monthIndex}"
               data-week="${week.weekNumber}"
               oninput="validateCurrentWeek()"
               onblur="formatHMarketingInput(this)"
               onfocus="unfocusHMarketingInput(this)"
               placeholder="Ex: 5.5"
               style="width: 100%; padding: 0.5rem; background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(71, 85, 105, 0.5); border-radius: 0.375rem; color: var(--text-light); font-size: 0.8rem;">
      </div>
    `;
  }

  // R√©sum√© (Analyse de la semaine, Focus et Rating)
  if (week.type === 'resume' || week.type === 'both') {
    html += `
      <div style="margin-bottom: 0.625rem;">
        <label style="display: block; font-size: 0.7rem; font-weight: 600; color: var(--text-gray); margin-bottom: 0.25rem;">
          <i class="fas fa-exclamation-triangle" style="margin-right: 0.25rem; color: #f59e0b;"></i>
          Analyse de la semaine pass√©e
        </label>
        <textarea
          data-week-index="${selectedWeekIndex}"
          data-field="probleme"
          data-month="${week.monthIndex}"
          data-week="${week.weekNumber}"
          oninput="validateCurrentWeek()"
          placeholder="D√©crivez le probl√®me de la semaine..."
          rows="2"
          style="width: 100%; padding: 0.5rem; background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(71, 85, 105, 0.5); border-radius: 0.375rem; color: var(--text-light); font-size: 0.8rem; resize: none;"></textarea>
      </div>

      <div style="margin-bottom: 0.625rem;">
        <label style="display: block; font-size: 0.7rem; font-weight: 600; color: var(--text-gray); margin-bottom: 0.25rem;">
          <i class="fas fa-crosshairs" style="margin-right: 0.25rem; color: #10b981;"></i>
          Focus
        </label>
        <textarea
          data-week-index="${selectedWeekIndex}"
          data-field="focus"
          data-month="${week.monthIndex}"
          data-week="${week.weekNumber}"
          oninput="validateCurrentWeek()"
          placeholder="Sur quoi allez-vous vous concentrer..."
          rows="2"
          style="width: 100%; padding: 0.5rem; background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(71, 85, 105, 0.5); border-radius: 0.375rem; color: var(--text-light); font-size: 0.8rem; resize: none;"></textarea>
      </div>

      <div style="margin-bottom: 0;">
        <label style="display: block; font-size: 0.7rem; font-weight: 600; color: var(--text-gray); margin-bottom: 0.375rem;">
          <i class="fas fa-star" style="margin-right: 0.25rem; color: #fbbf24;"></i>
          √âvaluation
        </label>
        <div class="star-rating-container" data-month="${week.monthIndex}" data-week="${week.weekNumber}" style="display: flex; gap: 0.375rem; font-size: 1.25rem;">
          <i class="fas fa-star star-rating" data-rating="1" style="color: #374151; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.color='#fbbf24'" onmouseout="updateStarColors(this.parentElement)" onclick="setRating(this)"></i>
          <i class="fas fa-star star-rating" data-rating="2" style="color: #374151; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.color='#fbbf24'" onmouseout="updateStarColors(this.parentElement)" onclick="setRating(this)"></i>
          <i class="fas fa-star star-rating" data-rating="3" style="color: #374151; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.color='#fbbf24'" onmouseout="updateStarColors(this.parentElement)" onclick="setRating(this)"></i>
          <i class="fas fa-star star-rating" data-rating="4" style="color: #374151; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.color='#fbbf24'" onmouseout="updateStarColors(this.parentElement)" onclick="setRating(this)"></i>
          <i class="fas fa-star star-rating" data-rating="5" style="color: #374151; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.color='#fbbf24'" onmouseout="updateStarColors(this.parentElement)" onclick="setRating(this)"></i>
        </div>
        <input type="hidden" id="rating-value" data-week-index="${selectedWeekIndex}" data-field="rating" data-month="${week.monthIndex}" data-week="${week.weekNumber}" value="0">
      </div>
    `;
  }

  html += '</div>';

  container.innerHTML = html;
  validateCurrentWeek();
}

// Sauvegarder les donn√©es du formulaire rapide
async function saveQuickFillData() {
  // Sauvegarder la semaine actuelle dans modalWeekData avant de commencer
  saveCurrentWeekToMemory();

  // V√©rifier que toutes les semaines dans modalWeekData sont valides
  const weekKeys = Object.keys(window.modalWeekData || {});
  if (weekKeys.length === 0) {
    alert('‚ö†Ô∏è Aucune donn√©e √† sauvegarder');
    return;
  }

  console.log('[RPO NOTIFICATIONS] Sauvegarde de', weekKeys.length, 'semaine(s)');

  // D√©sactiver le bouton de sauvegarde pendant le traitement
  const saveBtn = document.getElementById('save-rpo-btn');
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
  }

  // Compteurs pour le suivi
  let successCount = 0;
  let failCount = 0;
  const savedMonths = new Set();

  // Boucle sur toutes les semaines dans modalWeekData
  for (const weekKey of weekKeys) {
    const weekData = window.modalWeekData[weekKey];
    if (!weekData) continue;

    const { monthIndex, weekNumber, h_marketing, probleme, focus, rating } = weekData;

    // CHARGER les donn√©es existantes de cette semaine (si elles existent)
    const existingData = window.weeklyData?.[String(monthIndex)]?.[String(weekNumber)] || {};

    // Pr√©parer les donn√©es pour cette semaine - FUSIONNER avec les donn√©es existantes
    const data = {
      h_marketing: h_marketing !== null && h_marketing !== undefined ? h_marketing : (existingData.h_marketing || '-'),
      estimation: existingData.estimation || 0,
      contract: existingData.contract || 0,
      dollar: existingData.dollar || 0,
      depot: existingData.depot || 0,
      peintre: existingData.peintre || 0,
      ca_cumul: existingData.ca_cumul || 0,
      produit: existingData.produit || 0,
      prod_horaire: existingData.prod_horaire || 0,
      satisfaction: existingData.satisfaction || 0,
      rating: rating || existingData.rating || 0,
      commentaire: ''
    };

    // Utiliser les donn√©es existantes si non remplies
    let problemeText = probleme && probleme.trim() !== '' ? probleme.trim() : (existingData.probleme || '-');
    let focusText = focus && focus.trim() !== '' ? focus.trim() : (existingData.focus || '-');

    // Sauvegarder probleme et focus comme champs s√©par√©s
    data.probleme = problemeText;
    data.focus = focusText;

    // Sauvegarder cette semaine via l'API
    try {
      const response = await fetch(`/api/rpo/${username}/weekly/${monthIndex}/${weekNumber}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        console.error('[RPO NOTIFICATIONS] Erreur sauvegarde semaine', weekNumber, ':', response.status);
        failCount++;
        continue;
      }

      // Mettre √† jour les donn√©es globales
      if (!window.weeklyData[String(monthIndex)]) {
        window.weeklyData[String(monthIndex)] = {};
      }
      window.weeklyData[String(monthIndex)][String(weekNumber)] = data;

      console.log('[RPO NOTIFICATIONS] Semaine sauvegard√©e:', monthIndex, weekNumber);
      successCount++;
      savedMonths.add(monthIndex);

    } catch (error) {
      console.error('[RPO NOTIFICATIONS] Erreur sauvegarde semaine', weekNumber, ':', error);
      failCount++;
    }
  }

  // Recharger les donn√©es pour tous les mois affect√©s
  if (typeof loadWeeklyDataForMonth === 'function') {
    for (const monthIndex of savedMonths) {
      await loadWeeklyDataForMonth(monthIndex);
    }
  }

  // Rafra√Æchir les badges
  updateIncompleteObjectifsBadge();
  updateIncompleteResumeBadge();
  updateMonthDropdownBadges();
  updateTotalBadge();

  // Recalculer les totaux
  if (typeof calculateAllMonthlyTotalsFromWeekly === 'function') {
    calculateAllMonthlyTotalsFromWeekly();
  }

  // Mettre √† jour le graphique
  if (typeof updateAnnualChart === 'function') {
    updateAnnualChart();
  }

  console.log('[RPO NOTIFICATIONS] Sauvegarde termin√©e:', {
    succ√®s: successCount,
    √©checs: failCount,
    total: weekKeys.length
  });

  // Vider modalWeekData et weekValidation apr√®s la sauvegarde
  window.modalWeekData = {};
  window.weekValidation = {};

  // V√©rifier s'il reste des semaines incompl√®tes
  const totalIncomplete = (window.incompleteObjectifsWeeks?.length || 0) + (window.incompleteResumeWeeks?.length || 0);

  console.log('[RPO NOTIFICATIONS] Semaines incompl√®tes apr√®s sauvegarde:', {
    objectifs: window.incompleteObjectifsWeeks?.length || 0,
    resume: window.incompleteResumeWeeks?.length || 0,
    total: totalIncomplete
  });

  // R√©activer le bouton
  if (saveBtn) {
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer et acc√©der au RPO';
  }

  if (failCount > 0) {
    alert(`‚ö†Ô∏è ${successCount} semaine(s) enregistr√©e(s), ${failCount} erreur(s)`);
    return;
  }

  if (totalIncomplete === 0) {
    // Plus de semaines incompl√®tes, d√©bloquer et fermer
    const rpoContent = document.querySelector('.w-full');
    if (rpoContent) {
      rpoContent.style.filter = 'none';
      rpoContent.style.pointerEvents = 'auto';
    }
    closeNotificationsModal();
    // alert(`‚úÖ Toutes les donn√©es ont √©t√© enregistr√©es ! (${successCount} semaine(s)) Vous pouvez maintenant acc√©der au RPO.`); // D√âSACTIV√â: Notification retir√©e
  } else {
    // Il reste des semaines incompl√®tes, r√©g√©n√©rer le modal
    showNotificationsModal();
    // alert(`‚úÖ ${successCount} semaine(s) enregistr√©e(s) ! Il reste ${totalIncomplete} semaine(s) √† compl√©ter.`); // D√âSACTIV√â: Notification retir√©e
  }
}

// Note: Le modal est maintenant affich√© automatiquement depuis updateIncompleteWeeksBadge()
// Plus besoin d'attendre un timeout arbitraire

// Mettre √† jour le badge dans le menu lat√©ral
function updateMenuBadge(count) {
  // Envoyer un message au parent pour mettre √† jour le badge
  if (parent) {
    parent.postMessage({
      type: 'update-rpo-badge',
      count: count
    }, '*');
    console.log('[RPO NOTIFICATIONS] Message envoy√© au parent pour mettre √† jour le badge:', count);
  }
}

// Le modal s'affiche maintenant automatiquement via updateIncompleteWeeksBadge()
</script>

<script>
(function() {
  const userRole = localStorage.getItem('userRole');

  console.log('[RPO SCRIPT LOAD] userRole d√©tect√©:', userRole);

  // Charger entrepreneur-selector.js pour les coaches ET direction
  // Pour direction sur RPO: entrepreneur-selector.js d√©tectera la page RPO et chargera les COACHES
  // Pour coach: entrepreneur-selector.js chargera les ENTREPRENEURS comme avant
  if (userRole === 'coach' || userRole === 'direction') {
    console.log('[RPO SCRIPT LOAD] Chargement de entrepreneur-selector.js...');
    const script = document.createElement('script');
    script.src = '/entrepreneur-selector.js?v=20260114';  // Cache buster pour forcer le rechargement
    script.onload = function() {
      console.log('[RPO SCRIPT LOAD] ‚úÖ entrepreneur-selector.js charg√© avec succ√®s pour', userRole);
    };
    script.onerror = function() {
      console.error('[RPO SCRIPT LOAD] ‚ùå Erreur chargement entrepreneur-selector.js');
    };
    document.body.appendChild(script);
    console.log('[RPO SCRIPT LOAD] Script ajout√© au body');
  } else {
    console.log('[RPO SCRIPT LOAD] entrepreneur-selector.js NON charg√© (r√¥le:', userRole, ')');
  }
})();
</script>
</body>
</html>