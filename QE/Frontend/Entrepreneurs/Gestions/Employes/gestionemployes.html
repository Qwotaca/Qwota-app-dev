<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion des employ√©s</title>

  <!-- ‚õî NO CACHE - D√©sactiver compl√®tement le cache du navigateur -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- üì± PWA Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#60a5fa">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Qwota">
  <meta name="msapplication-TileColor" content="#60a5fa">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Ic√¥nes PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

  <!-- Script Service Worker -->
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      /* DISABLED - Service Worker
      navigator.serviceWorker.register('/sw.js')
        .then((registration) => {
          log('SW registered: ', registration);
        })
        .catch((registrationError) => {
          log('SW registration failed: ', registrationError);
        });
      */
    });
  }
  </script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/base.css">
  <link rel="icon" href="/favicon" type="image/x-icon">

  <!-- Styles centraleadmin pour les modals -->
  <link rel="stylesheet" href="/centraleadmin.css">

  <!-- Fix pour les modals dans les iframes -->
  <style>
    /* Titre du s√©lecteur entrepreneur */
    #coach-entrepreneur-selector .selector-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-light);
      text-align: center;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    #coach-entrepreneur-selector .selector-title i {
      color: var(--primary-blue);
    }

    #coach-entrepreneur-selector.in-header .selector-title {
      display: none;
    }

    /* Bouton copier */
    .btn-copy {
      background: rgba(96, 165, 250, 0.1);
      border: 1px solid rgba(96, 165, 250, 0.3);
      color: #60a5fa;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .btn-copy:hover {
      background: rgba(96, 165, 250, 0.2);
      border-color: rgba(96, 165, 250, 0.5);
    }
    .btn-copy.copied {
      background: rgba(34, 197, 94, 0.1);
      border-color: rgba(34, 197, 94, 0.4);
      color: #22c55e;
    }
    .btn-copy i {
      font-size: 0.7rem;
    }
    @keyframes copyPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .btn-copy.copied {
      animation: copyPulse 0.3s ease;
    }

    /* Animation de succ√®s pour la validation d'employ√© */
    @keyframes successFadeIn {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes checkmarkDraw {
      0% {
        stroke-dashoffset: 100;
      }
      100% {
        stroke-dashoffset: 0;
      }
    }

    .success-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: successFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .success-content {
      text-align: center;
      color: white;
      animation: successFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
    }

    .success-checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      margin: 0 auto 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
    }

    .success-checkmark svg {
      stroke: white;
      stroke-width: 3;
      stroke-dasharray: 100;
      stroke-dashoffset: 100;
      animation: checkmarkDraw 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.4s forwards;
    }

    /* Document Viewer Modal - Style identique √† centralevue */
    #documentViewerOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 10100;
    }

    #documentViewerModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 90vw;
      max-height: 90vh;
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid var(--border-dark);
      z-index: 10101;
      overflow: hidden;
    }

    #documentViewerModal.hidden {
      display: none;
    }

    #documentViewerClose {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid var(--border-dark);
      color: var(--text-light);
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 10000;
      line-height: 1;
    }

    #documentViewerClose:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border-color: #ef4444;
      transform: scale(1.1);
    }

    #documentViewerContent {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      padding: 2rem;
    }

    #documentViewerContent img,
    #documentViewerContent video,
    #documentViewerContent iframe {
      max-width: 100%;
      max-height: 85vh;
      object-fit: contain;
    }

    /* Forcer tous les modals √† √™tre fix√©s par rapport au viewport */
    .modal-overlay, .modal-overlay-opaque, .modal, [class*="modal"] {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      z-index: 9999 !important;
    }

    .modal-content, .modal-dialog, [class*="modal-content"], [class*="modal-dialog"] {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      max-height: 90vh !important;
      overflow-y: auto !important;
      z-index: 10000 !important;
    }

    /* Force les modals avec classe .fixed et .inset-0 √† √™tre vraiment fix√©s */
    .fixed.inset-0 {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
    }

    /* Force les modaux sp√©cifiques √† √™tre fix√©s */
    #modalAjouterEmploye,
    #modalRefuserEmploye,
    #modalActivation {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
    }

    /* Forcer les colonnes du tbody √† respecter les largeurs du thead */
    .modern-table {
      table-layout: fixed !important;
      width: 100% !important;
    }

    /* Largeurs identiques pour th et td - 4 colonnes */
    .modern-table th:nth-child(1),
    .modern-table td:nth-child(1) { width: 22% !important; }
    .modern-table th:nth-child(2),
    .modern-table td:nth-child(2) { width: 25% !important; }
    .modern-table th:nth-child(3),
    .modern-table td:nth-child(3) { width: 18% !important; }
    .modern-table th:nth-child(4),
    .modern-table td:nth-child(4) { width: 35% !important; }

    .modern-table th,
    .modern-table td {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Scroll dans les tbody comme dans employ√©s */
    .modern-table tbody {
      display: block;
      max-height: 400px;
      overflow-y: auto;
    }

    .modern-table thead,
    .modern-table tbody tr {
      display: table;
      width: 100%;
      table-layout: fixed;
    }

    .modern-table thead {
      width: calc(100% - 3px);
    }

    /* Scrollbar personnalis√©e pour tbody */
    .modern-table tbody::-webkit-scrollbar {
      width: 3px;
    }

    .modern-table tbody::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .modern-table tbody::-webkit-scrollbar-thumb {
      background: var(--primary-blue);
      border-radius: 10px;
    }

    .modern-table tbody::-webkit-scrollbar-thumb:hover {
      background: #60a5fa;
    }

    /* ============================================
       STYLES COMPACTS POUR BADGES ET ACTIONS
       ============================================ */

    /* Hauteur uniforme pour toutes les lignes de tableau */
    .modern-table tbody tr td {
      height: 52px;
      vertical-align: middle;
      padding: 0.4rem 0.75rem !important;
    }

    /* Colonne Actions - permettre le wrap pour les badges */
    .modern-table td:last-child {
      white-space: normal !important;
      overflow: visible !important;
    }

    /* Container compact pour badges avec boutons */
    .status-badge-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    /* Badge de statut compact (Refus√©, Termin√©, etc.) */
    .status-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.4rem 0.75rem;
      border-radius: 6px;
      white-space: nowrap;
      line-height: 1;
      vertical-align: middle;
    }

    .status-badge.refused {
      background: #ef4444 !important;
      color: white !important;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 8px 16px !important;
      font-size: 16px !important;
      font-weight: 700 !important;
      border-radius: 28px !important;
    }

    .status-badge.refused:hover {
      background: #dc2626 !important;
      transform: scale(1.05);
    }

    .status-badge.terminated {
      background: rgba(148, 163, 184, 0.15);
      color: #94a3b8;
      border: 1px solid rgba(148, 163, 184, 0.3);
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 8px 16px !important;
      font-size: 16px !important;
      font-weight: 700 !important;
      border-radius: 28px !important;
    }

    .status-badge.terminated:hover {
      background: rgba(148, 163, 184, 0.25);
      border-color: rgba(148, 163, 184, 0.5);
      transform: scale(1.05);
    }

    .status-badge.active {
      background: #22c55e !important;
      color: white !important;
      border: none;
      padding: 8px 16px !important;
      font-size: 16px !important;
      font-weight: 700 !important;
      border-radius: 28px !important;
    }

    .status-badge.pending {
      background: transparent;
      color: #f59e0b;
      border: none;
    }

    .status-badge i {
      font-size: 0.85rem;
      line-height: 1;
    }

    /* Tag NOUVEAU compact */
    .new-tag {
      background: #ef4444;
      color: white;
      font-size: 0.55rem;
      padding: 0.1rem 0.25rem;
      border-radius: 3px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    /* Boutons d'action compacts */
    .action-btns-compact {
      display: flex;
      gap: 0.4rem;
    }

    /* Style uniforme pour TOUS les boutons dans les tableaux - taille normale */
    .modern-table td .btn-primary,
    .modern-table td .btn-secondary,
    .action-btns-compact .btn-primary,
    .action-btns-compact .btn-secondary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    /* Bouton "Voir" pour les raisons */
    .btn-reason {
      font-size: 0.75rem;
      padding: 0.3rem 0.6rem;
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
      transition: all 0.2s ease;
    }

    .btn-reason:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
    }

    /* Spinner en attente - texte orange SANS background */
    .status-pending {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      color: #f59e0b !important;
      font-weight: 600;
      font-size: 0.8rem;
      background: transparent !important;
      background-color: transparent !important;
      box-shadow: none !important;
      border: none !important;
    }

    .status-pending i {
      font-size: 0.75rem;
      color: #f59e0b !important;
      animation: spin-slow 2s linear infinite !important;
    }

    @keyframes spin-slow {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Boutons d√©sactiv√©s/gris√©s */
    .btn-disabled {
      opacity: 0.5 !important;
      cursor: not-allowed !important;
      pointer-events: none !important;
    }

    .btn-disabled:hover {
      transform: none !important;
    }

    /* Retirer le sticky du header des tableaux */
    .nouveaux-employes thead th,
    .employes-actifs thead th,
    .employes-termines thead th {
      position: static !important;
    }

    /* Padding pour toutes les cellules des tableaux */
    .nouveaux-employes tbody tr td,
    .employes-actifs tbody tr td,
    .employes-termines tbody tr td {
      vertical-align: middle;
      padding: 1.25rem 0.75rem !important;
    }

    /* Supprimer toutes les limitations de hauteur et scroll des tableaux */
    .nouveaux-employes tbody,
    .employes-actifs tbody,
    .employes-termines tbody {
      display: table-row-group !important;
      max-height: none !important;
      overflow: visible !important;
    }

    .nouveaux-employes thead,
    .employes-actifs thead,
    .employes-termines thead {
      display: table-header-group !important;
    }

    .nouveaux-employes tbody tr,
    .employes-actifs tbody tr,
    .employes-termines tbody tr {
      display: table-row !important;
    }

    /* Supprimer les limitations de hauteur pour les box des tableaux seulement */
    .box > .box-body {
      max-height: none !important;
      overflow: visible !important;
    }

    .box > .box-body > .table-container {
      max-height: none !important;
      overflow: visible !important;
    }

    /* Largeurs colonnes tableaux 5 colonnes (Nouveaux, Actifs, Termin√©s) */
    .nouveaux-employes th:nth-child(1),
    .nouveaux-employes td:nth-child(1),
    .employes-actifs th:nth-child(1),
    .employes-actifs td:nth-child(1),
    .employes-termines th:nth-child(1),
    .employes-termines td:nth-child(1) { width: 18% !important; }

    .nouveaux-employes th:nth-child(2),
    .nouveaux-employes td:nth-child(2),
    .employes-actifs th:nth-child(2),
    .employes-actifs td:nth-child(2),
    .employes-termines th:nth-child(2),
    .employes-termines td:nth-child(2) { width: 22% !important; }

    .nouveaux-employes th:nth-child(3),
    .nouveaux-employes td:nth-child(3),
    .employes-actifs th:nth-child(3),
    .employes-actifs td:nth-child(3),
    .employes-termines th:nth-child(3),
    .employes-termines td:nth-child(3) { width: 12% !important; }

    .nouveaux-employes th:nth-child(4),
    .nouveaux-employes td:nth-child(4),
    .employes-actifs th:nth-child(4),
    .employes-actifs td:nth-child(4),
    .employes-termines th:nth-child(4),
    .employes-termines td:nth-child(4) { width: 22% !important; }

    .nouveaux-employes th:nth-child(5),
    .nouveaux-employes td:nth-child(5),
    .employes-actifs th:nth-child(5),
    .employes-actifs td:nth-child(5),
    .employes-termines th:nth-child(5),
    .employes-termines td:nth-child(5) { width: 26% !important; }

    /* Style pour les champs modifi√©s (orange) dans le popup de validation */
    .validationModif-row.modifie {
      background: rgba(245, 158, 11, 0.15) !important;
      border-radius: 6px;
      padding-left: 0.5rem !important;
      padding-right: 0.5rem !important;
      margin: 0.125rem 0;
      border-left: 3px solid #f59e0b !important;
    }
    .validationModif-row.modifie .validationModif-label {
      color: #f59e0b !important;
      font-weight: 600 !important;
    }
    .validationModif-row.modifie span:last-child {
      color: #fbbf24 !important;
      font-weight: 600 !important;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-end;
      max-width: 60%;
      white-space: normal !important;
      text-align: right;
    }
    /* Badge "Modifi√©" pour les champs modifi√©s - avant la valeur */
    .validationModif-row.modifie span:last-child::before {
      content: 'Modifi√©';
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
      font-size: 0.6rem;
      font-weight: 700;
      padding: 0.1rem 0.35rem;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .validationModif-row {
      position: relative;
    }

    /* Calendrier orange pour le modal Modifier */
    #calendar-modifierDatePremiere .calendar-nav-btn {
      background: #172033 !important;
      color: #f59e0b !important;
      border: 2px solid var(--border-dark) !important;
    }
    #calendar-modifierDatePremiere .calendar-nav-btn:hover {
      background: #f59e0b !important;
      color: white !important;
      border-color: #f59e0b !important;
    }
    #calendar-modifierDatePremiere .calendar-day {
      color: var(--text-light) !important;
    }
    #calendar-modifierDatePremiere .calendar-day:hover {
      background: rgba(245, 158, 11, 0.2) !important;
      color: #f59e0b !important;
    }
    #calendar-modifierDatePremiere .calendar-day.selected {
      background: #f59e0b !important;
      color: white !important;
    }
    #calendar-modifierDatePremiere .calendar-day.today {
      background: rgba(245, 158, 11, 0.2) !important;
      color: #f59e0b !important;
      border: 1px solid #f59e0b !important;
    }
    #calendar-modifierDatePremiere .calendar-day.other-month {
      color: #64748b !important;
    }

    /* Border radius 12px et padding pour le dropdown genre dans Modifier */
    #modifierGenre-dropdown {
      border-radius: 12px !important;
      padding: 12px 16px !important;
    }
    #modifierGenre-menu {
      border-radius: 12px !important;
    }
    #modifierGenre-menu .dropdown-secondary-option {
      padding: 12px 16px !important;
    }

    /* Custom Calendar */
    .custom-calendar {
      position: absolute;
      width: 280px;
      top: 100%;
      margin-top: 4px;
      left: 0;
      background: #1a2332;
      border: 2px solid var(--border-dark);
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      padding: 16px;
      z-index: 9999 !important;
    }

    /* Calendrier datePremiere s'ouvre vers le haut */
    #calendar-datePremiere {
      top: auto !important;
      bottom: 100% !important;
      margin-top: 0 !important;
      margin-bottom: 4px !important;
    }

    .custom-calendar.hidden {
      display: none;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .calendar-month-year {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-light);
    }

    .calendar-nav-btn {
      background: #172033 !important;
      color: #60a5fa !important;
      border: 2px solid var(--border-dark) !important;
      width: 30px !important;
      height: 30px !important;
      border-radius: 50% !important;
      cursor: pointer !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-size: 16px !important;
      padding: 0 !important;
      transition: all 0.2s ease !important;
    }

    .calendar-nav-btn:hover {
      background: #3b82f6 !important;
      color: white !important;
      border-color: #3b82f6 !important;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .calendar-weekday {
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-gray);
      padding: 4px 0;
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: var(--text-light);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: transparent;
      border: 1px solid transparent;
    }

    .calendar-day:hover:not(.disabled):not(.other-month) {
      background: rgba(59, 130, 246, 0.1);
      border-color: #60a5fa;
    }

    .calendar-day.selected {
      background: #3b82f6;
      color: white;
    }

    .calendar-day.today {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
      border: 1px solid #60a5fa;
      font-weight: 600;
    }

    .calendar-day.disabled {
      color: var(--text-gray);
      opacity: 0.3;
      cursor: not-allowed;
    }

    .calendar-day.other-month {
      opacity: 0.3;
      color: var(--text-gray);
    }

    /* D√©caler les modals de 10px vers le bas pour √©viter la barre coach */
    body.coach-mode.has-selection #modalNotificationCoach,
    body.coach-mode.has-selection #modalAjouterEmploye,
    body.coach-mode.has-selection #modalRefuserEmploye,
    body.coach-mode.has-selection #modalFinEmploi,
    body.coach-mode.has-selection .fixed.inset-0.flex.items-center.justify-center {
      padding-top: 10px !important;
    }
  </style>

  <!-- Emp√™cher base.css d'affecter les popups -->
  <!-- Styles sp√©cifiques √† Gestion Employ√©s -->
  <link rel="stylesheet" href="/gestionemployes.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.min.js"></script>

  <!-- ANTI-FLASH: D√©tection coach AVANT le rendu du body -->
  <script>
    (function() {
      const userRole = localStorage.getItem('userRole');
      const isCoachOrDirection = userRole === 'coach' || userRole === 'direction';
      const urlParams = new URLSearchParams(window.location.search);
      const hasUserParam = urlParams.get('user');

      if (isCoachOrDirection && !hasUserParam) {
        // Injecter le CSS imm√©diatement pour cacher le contenu et afficher le s√©lecteur
        const style = document.createElement('style');
        style.id = 'coach-anti-flash-css';
        style.textContent = `
          .main-content {
            opacity: 0 !important;
            pointer-events: none !important;
          }
          #coach-selector-backdrop {
            display: block !important;
            opacity: 1 !important;
            pointer-events: all !important;
          }
          #coach-entrepreneur-selector {
            display: block !important;
            opacity: 1 !important;
          }
        `;
        document.head.appendChild(style);
      }
    })();
  </script>

  <!-- Variables globales d√©finies dans common.js -->
  <script>
    // ‚ö° D√âSACTIVATION DES LOGS - Performance optimization
    window.log = window.log || (() => {});
    window.warn = window.warn || (() => {});
    window.error = window.error || (() => {});
    window.info = window.info || (() => {});
    window.debug = window.debug || (() => {});

    // Ces variables sont maintenant g√©r√©es par common.js
    // username, userRole, canEditParameters sont disponibles globalement
    
    // Variables globales du calendrier - D√âCLAR√âES T√îT
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let activeCalendarId = null;
    
    window.monthNames = [
      'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
      'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
    ];

    // FONCTIONS CALENDRIER GLOBALES - D√âFINIES T√îT
    window.toggleCalendar = function(inputId) {
      log('üóìÔ∏è toggleCalendar appel√© avec:', inputId);
      const calendar = document.getElementById(`calendar-${inputId}`);
      
      if (!calendar) {
        error('[ERROR] Calendrier non trouv√©:', `calendar-${inputId}`);
        return;
      }
      
      // Fermer autres calendriers
      document.querySelectorAll('.custom-calendar').forEach(cal => {
        if (cal.id !== `calendar-${inputId}`) {
          cal.classList.add('hidden');
        }
      });
      
      // Toggle ce calendrier
      const isHidden = calendar.classList.contains('hidden');
      if (isHidden) {
        calendar.classList.remove('hidden');
        activeCalendarId = inputId;
        // Attendre que le calendrier soit visible avant de le rendre
        setTimeout(() => {
          if (window.renderCalendar) window.renderCalendar(inputId);
        }, 50);
        log('[OK] Calendrier ouvert');
      } else {
        calendar.classList.add('hidden');
        log('üö™ Calendrier ferm√©');
      }
    };

    window.changeMonth = function(inputId, direction) {
      currentMonth += direction;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      if (window.renderCalendar) window.renderCalendar(inputId);
    };
  </script>
  <!-- Styles sp√©cifiques √† Gestion Employ√©s -->

<!-- Styles sp√©cifiques √† Gestion Employ√©s -->

<!-- Styles sp√©cifiques √† Gestion Employ√©s -->

  <style>
    /* Styles pour le bouton V√©rifier - Style btn-primary orange */
    .btn-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
      border: 2px solid rgba(245, 158, 11, 0.3) !important;
      color: white !important;
      padding: 0.5rem 1.25rem !important;
      border-radius: 10px !important;
      font-weight: 600 !important;
      font-size: 0.875rem !important;
      cursor: pointer !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      display: inline-flex !important;
      align-items: center !important;
      gap: 0.5rem !important;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
      position: relative !important;
      overflow: hidden !important;
    }

    .btn-warning::before {
      content: '' !important;
      position: absolute !important;
      top: 0 !important;
      left: -100% !important;
      width: 100% !important;
      height: 100% !important;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent) !important;
      transition: left 0.5s ease !important;
    }

    .btn-warning:hover::before {
      left: 100% !important;
    }

    .btn-warning:hover {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%) !important;
      border-color: rgba(217, 119, 6, 0.5) !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15) !important;
    }

    .btn-warning:active {
      transform: translateY(0) !important;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3) !important;
    }

    .verify-btn {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
      border: 2px solid rgba(245, 158, 11, 0.3) !important;
      color: white !important;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
    }

    .verify-btn:hover {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%) !important;
      border-color: rgba(217, 119, 6, 0.5) !important;
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15) !important;
    }

    /* Styles pour le modal de validation */
    .validation-section {
      background: rgba(30, 41, 59, 0.4);
      border: 1px solid rgba(71, 85, 105, 0.4);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }

    .validation-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(71, 85, 105, 0.3);
      display: flex;
      align-items: center;
    }

    .validation-section-title i {
      color: #f59e0b;
      margin-right: 0.5rem;
    }

    .validation-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    @media (max-width: 600px) {
      .validation-grid {
        grid-template-columns: 1fr;
      }
    }

    .validation-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .validation-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #94a3b8;
    }

    .validation-value {
      font-size: 0.875rem;
      color: var(--text-light);
      font-weight: 500;
    }

    /* Styles pour modal avec header/footer sticky */
    .modal-header-sticky {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg-card);
    }

    .modal-body-scroll {
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer-sticky {
      position: sticky;
      bottom: 0;
      z-index: 10;
      background: var(--bg-card);
    }

    /* Scroll gris pour le modal de validation */
    .modal-body-scroll::-webkit-scrollbar {
      width: 8px;
    }

    .modal-body-scroll::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 10px;
    }

    .modal-body-scroll::-webkit-scrollbar-thumb {
      background: rgba(71, 85, 105, 0.6);
      border-radius: 10px;
    }

    .modal-body-scroll::-webkit-scrollbar-thumb:hover {
      background: rgba(71, 85, 105, 0.8);
    }
  </style>
  <link rel="stylesheet" href="/entrepreneur-selector.css">
</head>
<body class="min-h-screen" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: var(--text-light); overflow-x: hidden; margin: 0; padding: 0;">

  <!-- Backdrop pour le s√©lecteur coach (√©tat centr√©) -->
  <div id="coach-selector-backdrop"></div>

  <!-- Modal Ajouter un employ√© -->
  <div id="modalAjouterEmploye" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none;">
    <div class="status-card p-6 max-w-md w-full" style="max-height: 90vh; overflow-y: auto;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user-plus mr-2" style="color: var(--primary-blue);"></i>
          Ajouter un employ√©
        </h3>
        <button onclick="fermerModalAjouterEmploye()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);" onmouseover="this.style.background='rgba(96, 165, 250, 0.3)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form id="employeForm" class="space-y-4" autocomplete="off">
        <!-- Nom complet -->
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Nom complet *</label>
          <input type="text" id="employeNom" name="employe-nom" required autocomplete="new-password" autocapitalize="off" spellcheck="false" readonly onfocus="this.removeAttribute('readonly');"
                 class="w-full p-2 text-sm rounded-lg"
                 style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);"
                 placeholder="Entrez le nom complet">
        </div>

        <!-- Courriel -->
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Courriel *</label>
          <input type="email" id="employeCourriel" name="employe-email" required autocomplete="new-password" autocapitalize="off" spellcheck="false" readonly onfocus="this.removeAttribute('readonly');"
                 class="w-full p-2 text-sm rounded-lg"
                 style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);"
                 placeholder="exemple@email.com">
        </div>

        <!-- T√©l√©phone -->
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">T√©l√©phone *</label>
          <input type="tel" id="employeTelephone" name="telephone" required autocomplete="off" autocapitalize="off" spellcheck="false"
                 class="w-full p-2 text-sm rounded-lg"
                 style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);"
                 placeholder="000-000-0000" maxlength="12">
        </div>

        <!-- Poste -->
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Poste *</label>
          <input type="text" id="employePoste" name="employe-poste" required autocomplete="new-password" autocapitalize="off" spellcheck="false" readonly onfocus="this.removeAttribute('readonly');"
                 class="w-full p-2 text-sm rounded-lg"
                 style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);"
                 placeholder="Titre du poste">
        </div>

        <!-- Boutons -->
        <div class="flex space-x-3 pt-4">
          <button type="button" onclick="fermerModalAjouterEmploye()"
                  class="btn-secondary px-4 py-2 rounded-lg relative overflow-hidden">
            Annuler
          </button>
          <button type="submit"
                  class="btn-primary px-4 py-2 rounded-lg relative overflow-hidden">
            <span>Ajouter</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Refuser un employ√© -->
  <div id="modalRefuserEmploye" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none;">
    <div class="status-card p-6 max-w-md w-full" style="max-height: 90vh; overflow-y: auto;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-times-circle mr-2" style="color: #ef4444;"></i>
          Refuser l'employ√©
        </h3>
        <button onclick="fermerModalRefuserEmploye()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mb-6">
        <p style="color: var(--text-muted); line-height: 1.6; margin-bottom: 1rem;">
          √ätes-vous s√ªr de vouloir refuser cet employ√©?
        </p>
        <div class="p-4 rounded-lg" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);">
          <div class="flex items-center mb-2">
            <i class="fas fa-user mr-2" style="color: #ef4444;"></i>
            <span id="refuserEmployeNom" style="color: var(--text-light); font-weight: 600;"></span>
          </div>
          <div class="flex items-center">
            <i class="fas fa-briefcase mr-2" style="color: #ef4444;"></i>
            <span id="refuserEmployePoste" style="color: var(--text-muted);"></span>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3">
        <button onclick="fermerModalRefuserEmploye()" class="btn-secondary" style="width: auto;">
          Annuler
        </button>
        <button onclick="confirmerRefusEmploye()" class="btn-primary" style="width: auto; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;">
          Refuser
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Fin d'emploi -->
  <div id="modalFinEmploi" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none;">
    <div class="status-card p-6" style="max-width: 600px; width: 95%; max-height: 98vh; overflow-y: auto;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user-times mr-2" style="color: #ef4444;"></i>
          Fin d'emploi
        </h3>
        <button onclick="fermerModalFinEmploi()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mb-4">
        <p style="color: var(--text-muted); line-height: 1.6; margin-bottom: 1rem;">
          √ätes-vous s√ªr de vouloir mettre fin √† l'emploi de cet employ√©?
        </p>
        <div class="p-4 rounded-lg mb-4" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);">
          <div class="flex items-center mb-2">
            <i class="fas fa-user mr-2" style="color: #ef4444;"></i>
            <span id="finEmploiNom" style="color: var(--text-light); font-weight: 600;"></span>
          </div>
          <div class="flex items-center">
            <i class="fas fa-briefcase mr-2" style="color: #ef4444;"></i>
            <span id="finEmploiPoste" style="color: var(--text-muted);"></span>
          </div>
        </div>

        <!-- Date de fin d'emploi -->
        <div class="mb-4">
          <label for="dateFinEmploi" class="block mb-2" style="color: var(--text-light); font-weight: 500;">
            Date de fin d'emploi <span style="color: #ef4444;">*</span>
          </label>
          <div class="custom-date-container" style="position: relative;">
            <input type="text" id="dateFinEmploi" class="form-input w-full cursor-pointer" placeholder="S√©lectionner une date" readonly autocomplete="off" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-light); padding: 0.75rem; border-radius: 8px;">
            <div class="custom-calendar hidden" id="calendar-date-fin-emploi">
              <!-- Calendar content will be generated here -->
            </div>
          </div>
        </div>

        <!-- Motif de fin d'emploi -->
        <div class="mb-4">
          <label for="motifFinEmploi" class="block mb-2" style="color: var(--text-light); font-weight: 500;">
            Motif de fin d'emploi <span style="color: #ef4444;">*</span>
          </label>
          <select id="motifFinEmploi" class="modal-select form-input w-full" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-light); padding: 0.75rem; border-radius: 8px;">
            <option value="">S√©lectionner un motif</option>
            <option value="Manque de travail">Manque de travail</option>
            <option value="Fin de saison">Fin de saison</option>
            <option value="D√©part volontaire">D√©part volontaire</option>
            <option value="D√©part volontaire : retour aux √©tudes">D√©part volontaire : retour aux √©tudes</option>
            <option value="D√©part volontaire : Vers un autre emploi">D√©part volontaire : Vers un autre emploi</option>
            <option value="Cong√©di√© dans les 3 premiers mois : Manquement disciplinaire">Cong√©di√© dans les 3 premiers mois : Manquement disciplinaire</option>
            <option value="Cong√©di√© dans les 3 premiers mois : Manque comp√©tence">Cong√©di√© dans les 3 premiers mois : Manque comp√©tence</option>
            <option value="Ne s'est jamais pr√©sent√©">Ne s'est jamais pr√©sent√©</option>
            <option value="Cong√© parental">Cong√© parental</option>
          </select>
        </div>

        <!-- Justificatif -->
        <div class="mb-4">
          <label for="justificatifFinEmploi" class="block mb-2" style="color: var(--text-light); font-weight: 500;">
            Justificatif <span id="justificatifRequis" style="color: #ef4444; display: none;">*</span>
          </label>
          <textarea id="justificatifFinEmploi" class="form-input w-full" rows="5" placeholder="Entrez les d√©tails ou justifications..." style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-light); padding: 0.75rem; border-radius: 8px; resize: none;" oninput="updateJustificatifCounter()"></textarea>
          <div id="justificatifCounter" style="display: none; margin-top: 0.5rem; font-size: 0.875rem;">
            <span id="justificatifActuel" style="color: var(--text-muted);">0</span>
            <span style="color: var(--text-muted);">/</span>
            <span id="justificatifMin" style="color: var(--text-muted);">0</span>
            <span style="color: var(--text-muted);"> caract√®res minimum</span>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3">
        <button onclick="fermerModalFinEmploi()" class="btn-secondary" style="width: auto;">
          Annuler
        </button>
        <button onclick="confirmerFinEmploi()" class="btn-primary" style="width: auto; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;">
          Confirmer
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Validation Inactivation (Coach) -->
  <div id="modalValidationInactivation" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none;">
    <div class="status-card p-6" style="max-width: 600px; width: 95%;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user-clock mr-2" style="color: #f59e0b;"></i>
          Validation de fin d'emploi
        </h3>
        <button onclick="fermerPopupValidationInactivation()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Raison de l'inactivation -->
      <div class="mb-4 p-4 rounded-lg" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3);">
        <h4 class="font-semibold mb-3" style="color: #f59e0b;">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          Raison de la fin d'emploi
        </h4>
        <div class="grid grid-cols-1 gap-3">
          <div>
            <span style="color: var(--text-muted); font-size: 0.875rem;">Motif:</span>
            <p id="inactivation-motif" style="color: var(--text-light); margin-top: 0.25rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 0.875rem;"></p>
          </div>
          <div>
            <span style="color: var(--text-muted); font-size: 0.875rem;">Justificatif:</span>
            <p id="inactivation-justificatif" style="color: var(--text-light); margin-top: 0.25rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 0.875rem;"></p>
          </div>
        </div>
      </div>

      <!-- Informations de l'employ√© -->
      <div class="p-4 rounded-lg mb-4" style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1);">
        <h4 class="font-semibold mb-3" style="color: var(--text-light); font-size: 0.875rem;">
          <i class="fas fa-user mr-2" style="color: var(--primary);"></i>
          Informations de l'employ√©
        </h4>
        <div class="space-y-2" style="font-size: 0.875rem;">
          <div style="display: flex; justify-content: space-between;"><span style="color: var(--text-muted); opacity: 0.6;">Nom complet:</span> <span id="inactivation-nom" style="color: var(--text-light); font-weight: 500;"></span></div>
          <div style="display: flex; justify-content: space-between;"><span style="color: var(--text-muted); opacity: 0.6;">Date de derni√®re journ√©e:</span> <span id="inactivation-date-derniere" style="color: var(--text-light);"></span></div>
          <div style="display: flex; justify-content: space-between;"><span style="color: var(--text-muted); opacity: 0.6;">Taux horaire:</span> <span id="inactivation-taux" style="color: var(--text-light);"></span></div>
        </div>
      </div>

      <!-- Boutons -->
      <div class="flex justify-end gap-3">
        <button onclick="refuserInactivationCoach()" class="btn-secondary" style="width: auto;">
          <i class="fas fa-times mr-2"></i>Refuser
        </button>
        <button id="btn-valider-inactivation" onclick="validerInactivationCoach()" class="btn-primary" style="width: auto; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;">
          <i class="fas fa-check mr-2"></i>Valider
        </button>
      </div>
    </div>
  </div>

  <!-- Popup Validation Erreurs -->
  <div id="popupValidationErreurs" class="fixed inset-0 flex items-center justify-center z-[60]" style="background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); display: none;">
    <div class="status-card" style="max-width: 500px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 2px solid #ef4444; box-shadow: 0 20px 60px rgba(239, 68, 68, 0.3);">
      <!-- Header -->
      <div class="flex items-center justify-between p-6 pb-4" style="border-bottom: 1px solid rgba(239, 68, 68, 0.3);">
        <h3 class="text-xl font-bold" style="color: #ef4444;">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          Champs manquants
        </h3>
        <button onclick="fermerPopupValidationErreurs()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Body -->
      <div class="p-6">
        <p class="text-sm mb-4" style="color: #94a3b8;">
          Veuillez remplir les champs obligatoires suivants avant de continuer :
        </p>
        <ul id="listeChampsManquants" class="space-y-2" style="color: #f1f5f9;">
          <!-- Liste dynamique des champs manquants -->
        </ul>
      </div>

      <!-- Footer -->
      <div class="flex justify-end gap-3 p-6 pt-0">
        <button onclick="fermerPopupValidationErreurs()" class="btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;">
          <i class="fas fa-check mr-2"></i>Compris
        </button>
      </div>
    </div>
  </div>

  <!-- Popup Aucune modification d√©tect√©e -->
  <div id="popupAucuneModification" class="fixed inset-0 flex items-center justify-center z-[60]" style="background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); display: none;">
    <div class="status-card" style="max-width: 500px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 2px solid #f59e0b; box-shadow: 0 20px 60px rgba(245, 158, 11, 0.3);">
      <!-- Header -->
      <div class="flex items-center justify-between p-6 pb-4" style="border-bottom: 1px solid rgba(245, 158, 11, 0.3);">
        <h3 class="text-xl font-bold" style="color: #f59e0b;">
          <i class="fas fa-info-circle mr-2"></i>
          Aucune modification
        </h3>
        <button onclick="fermerPopupAucuneModification()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b;" onmouseover="this.style.background='rgba(245, 158, 11, 0.3)'" onmouseout="this.style.background='rgba(245, 158, 11, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Body -->
      <div class="p-6">
        <p class="text-sm mb-4" style="color: #94a3b8;">
          Aucune modification n'a √©t√© d√©tect√©e. Veuillez modifier au moins un champ ou ajouter un document pour envoyer une demande de modification.
        </p>
      </div>

      <!-- Footer -->
      <div class="flex justify-end gap-3 p-6 pt-0">
        <button onclick="fermerPopupAucuneModification()" class="btn-secondary">
          <i class="fas fa-arrow-left mr-2"></i>Retour aux modifications
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Activer un employ√© -->
  <div id="modalActivation" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none;">
    <div class="status-card w-full" style="max-width: 900px; max-height: 75vh; display: flex; flex-direction: column;">
      <!-- Header sticky -->
      <div class="flex items-center justify-between p-6 pb-4" style="position: sticky; top: 0; background: #1a2332; z-index: 10; border-bottom: 1px solid var(--border-dark);">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user-check mr-2" style="color: #10b981;"></i>
          Activer l'employ√©
        </h3>
        <button onclick="fermerModal()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(16, 185, 129, 0.2); color: #10b981;" onmouseover="this.style.background='rgba(16, 185, 129, 0.3)'" onmouseout="this.style.background='rgba(16, 185, 129, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Body scrollable -->
      <div style="flex: 1; overflow-y: auto; padding: 1.5rem;">
        <form id="formActivation" class="space-y-4" autocomplete="off" novalidate>
        <!-- Section: Informations personnelles -->
        <div>
          <h4 class="text-sm font-semibold mb-3" style="color: var(--text-light);">
            <i class="fas fa-user mr-2" style="color: var(--primary-blue);"></i>
            Informations personnelles *
          </h4>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <!-- Nom complet -->
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Nom complet *</label>
              <input type="text" id="nomComplet" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="Nom complet">
            </div>

            <!-- T√©l√©phone -->
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">T√©l√©phone *</label>
              <input type="tel" id="telephone" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="(XXX) XXX-XXXX">
            </div>

            <!-- Courriel -->
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Courriel *</label>
              <input type="email" id="courriel" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="exemple@email.com">
            </div>

            <!-- Poste -->
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Poste *</label>
              <input type="text" id="posteService" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="Titre du poste">
            </div>

            <!-- Genre -->
            <div style="position: relative;">
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Genre *</label>
              <input type="hidden" id="genre" required>
              <div class="dropdown-secondary" id="genre-dropdown" style="width: 100% !important; background: #172033; border: 2px solid var(--border-dark); color: var(--text-light); border-radius: 8px; padding: 0.5rem; font-size: 0.875rem;">
                <span id="genre-selected">S√©lectionner</span>
                <i class="fas fa-chevron-down"></i>
              </div>
              <div class="dropdown-secondary-menu" id="genre-menu" style="background: #0f172a; border: 2px solid var(--border-dark);">
                <div class="dropdown-secondary-option" data-value="homme">Homme</div>
                <div class="dropdown-secondary-option" data-value="Femme">Femme</div>
              </div>
            </div>

            <!-- NAS -->
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">NAS *</label>
              <input type="text" id="nas" required maxlength="9" class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="123456789 (sans tiret)">
            </div>

            <!-- Date de naissance -->
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Date de naissance *</label>
              <input type="text" id="dateNaissance" required maxlength="10" class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="AAAA-MM-JJ">
            </div>
          </div>
        </div>

        <!-- Section: Adresse -->
        <div>
          <h4 class="text-sm font-semibold mb-3" style="color: var(--text-light);">
            <i class="fas fa-map-marker-alt mr-2" style="color: var(--primary-blue);"></i>
            Adresse *
          </h4>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <!-- Adresse -->
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Adresse *</label>
              <input type="text" id="adresse" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="123 Rue Exemple">
            </div>

            <!-- Ville -->
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Ville * <span style="color: #64748b; font-size: 0.75rem;">(Auto)</span></label>
              <input type="text" id="ville" required readonly class="w-full p-2 text-sm rounded-lg" style="background: #0a0f1a; border: 2px solid var(--border-dark); color: #64748b; cursor: not-allowed;" placeholder="Rempli automatiquement">
            </div>

            <!-- Code Postal -->
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Code Postal * <span style="color: #64748b; font-size: 0.75rem;">(Auto)</span></label>
              <input type="text" id="codePostal" required readonly maxlength="7" class="w-full p-2 text-sm rounded-lg" style="background: #0a0f1a; border: 2px solid var(--border-dark); color: #64748b; cursor: not-allowed;" placeholder="Rempli automatiquement">
            </div>

            <!-- Appartement -->
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Appartement <span style="color: #64748b; font-size: 0.75rem;">(facultatif)</span></label>
              <input type="text" id="appartement" class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="App. 101">
            </div>
          </div>
        </div>

        <!-- Section: Informations d'emploi -->
        <div>
          <h4 class="text-sm font-semibold mb-3" style="color: var(--text-light);">
            <i class="fas fa-dollar-sign mr-2" style="color: var(--primary-blue);"></i>
            Informations d'emploi *
          </h4>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <!-- Date premi√®re journ√©e -->
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Date premi√®re journ√©e *</label>
              <div class="custom-date-container" style="position: relative;">
                <input type="text" id="datePremiere" required class="w-full p-2 text-sm rounded-lg cursor-pointer" placeholder="S√©lectionner une date" readonly autocomplete="off" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);">
                <div class="custom-calendar hidden" id="calendar-datePremiere">
                  <!-- Calendar content will be generated here -->
                </div>
              </div>
            </div>

            <!-- Taux horaire -->
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Taux horaire ($) *</label>
              <input type="text" id="tauxHoraire" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="25,00">
            </div>
          </div>
        </div>

        <!-- Section: Documents requis -->
        <div>
          <h4 class="text-sm font-semibold mb-3" style="color: var(--text-light);">
            <i class="fas fa-file-upload mr-2" style="color: var(--primary-blue);"></i>
            Documents requis *
          </h4>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <!-- Sp√©cimen ch√®que -->
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Sp√©cimen ch√®que *</label>
              <div id="dropzoneSpecimen" class="upload-zone-small cursor-pointer">
                <p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Choisir fichier</p>
                <input type="file" id="specimenCheque" required accept="image/*,.pdf" class="hidden">
              </div>
              <div id="previewSpecimen" class="mt-2 hidden relative inline-block">
                <a href="javascript:void(0)" class="file-preview-link">
                  <img class="h-12 rounded shadow" style="border: 2px solid var(--border-dark);" />
                </a>
                <button type="button" onclick="removeFilePreview('specimenCheque')" class="file-remove-btn" style="position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer; border: none;">
                  √ó
                </button>
              </div>
            </div>

            <!-- Certificat de s√©curit√© -->
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Certificat de s√©curit√© *</label>
              <div id="dropzoneCertificat" class="upload-zone-small cursor-pointer">
                <p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Choisir fichier</p>
                <input type="file" id="certificatSecurite" required accept="image/*,.pdf" class="hidden">
              </div>
              <div id="previewCertificat" class="mt-2 hidden relative inline-block">
                <a href="javascript:void(0)" class="file-preview-link">
                  <img class="h-12 rounded shadow" style="border: 2px solid var(--border-dark);" />
                </a>
                <button type="button" onclick="removeFilePreview('certificatSecurite')" class="file-remove-btn" style="position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer; border: none;">
                  √ó
                </button>
              </div>
            </div>

            <!-- Carte d'assurance maladie -->
            <div>
              <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Carte d'assurance maladie *</label>
              <div id="dropzoneCarte" class="upload-zone-small cursor-pointer">
                <p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Choisir fichier</p>
                <input type="file" id="carteAssuranceMaladie" required accept="image/*,.pdf" class="hidden">
              </div>
              <div id="previewCarte" class="mt-2 hidden relative inline-block">
                <a href="javascript:void(0)" class="file-preview-link">
                  <img class="h-12 rounded shadow" style="border: 2px solid var(--border-dark);" />
                </a>
                <button type="button" onclick="removeFilePreview('carteAssuranceMaladie')" class="file-remove-btn" style="position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer; border: none;">
                  √ó
                </button>
              </div>
            </div>
          </div>
        </div>
        </form>
      </div>

      <!-- Footer sticky -->
      <div class="flex space-x-3 p-6 pt-4" style="position: sticky; bottom: 0; background: #1a2332; z-index: 10; border-top: 1px solid var(--border-dark);">
        <button type="button" onclick="fermerModal()" class="btn-secondary px-4 py-2 rounded-lg relative overflow-hidden">
          Annuler
        </button>
        <button type="submit" form="formActivation" id="btn-activer-employe" class="btn-primary px-4 py-2 rounded-lg relative overflow-hidden" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
          <span>Activer l'employ√©</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal viewer (identique √† celui de la Centrale) -->
  <div id="centraleViewerModal" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); display: none; z-index: 99999 !important;">
    <div class="flex flex-col p-6 mx-4" style="width: 90%; max-width: 1200px; height: 85vh; background: #1e293b; border: 1px solid var(--border-dark); border-radius: 12px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
      <!-- Header -->
      <div class="flex items-center justify-between mb-4" style="padding-bottom: 16px; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
        <h3 class="text-lg font-semibold" style="color: var(--text-light);">
          <i class="fas fa-file-alt mr-2" style="color: #60a5fa;"></i>
          <span id="centraleViewerTitle">Aper√ßu du document</span>
        </h3>
        <button id="closeViewer" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Content -->
      <div id="centraleViewerContent" class="viewer-content" style="flex: 1; overflow: auto; display: flex; align-items: center; justify-content: center; background: rgba(15, 23, 42, 0.5); border-radius: 8px;"></div>
    </div>
  </div>

  <!-- Modal Validation Employ√© (pour les coaches) -->
  <div id="modalValidationEmploye" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none;">
    <div class="status-card w-full" style="max-width: 1100px; max-height: 85vh; display: flex; flex-direction: column;">
      <!-- Header sticky -->
      <div class="flex items-center justify-between p-6 pb-4" style="position: sticky; top: 0; background: #1a2332; z-index: 10; border-bottom: 1px solid var(--border-dark);">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user-check mr-2" style="color: #f59e0b;"></i>
          V√©rifier l'employ√©
        </h3>
        <button onclick="fermerPopupValidation()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b;" onmouseover="this.style.background='rgba(245, 158, 11, 0.3)'" onmouseout="this.style.background='rgba(245, 158, 11, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Body scrollable avec grid 2 colonnes -->
      <div style="flex: 1; overflow-y: auto; padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <!-- Colonne gauche -->
          <div class="space-y-4">
            <!-- Section: Informations personnelles -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-user" style="color: #60a5fa;"></i>
                Informations personnelles
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Nom complet</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validation-nom">-</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Genre</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validation-genre">-</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">NAS</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validation-nas">-</span>
              </div>
            </div>

            <!-- Section: Contact -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-phone" style="color: #10b981;"></i>
                Contact
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Courriel</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validation-courriel">-</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">T√©l√©phone</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validation-telephone">-</span>
              </div>
            </div>
          </div>

          <!-- Colonne droite -->
          <div class="space-y-4">
            <!-- Section: Informations d'emploi -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-briefcase" style="color: #f59e0b;"></i>
                Informations d'emploi
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Poste</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validation-poste">-</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Taux horaire</span>
                <span class="text-sm font-medium" style="color: #10b981;" id="validation-taux">-</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Date premi√®re journ√©e</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validation-date-premiere">-</span>
              </div>
            </div>

            <!-- Section: Adresse d√©taill√©e -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-map-marker-alt" style="color: #8b5cf6;"></i>
                Adresse d√©taill√©e
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Adresse</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validation-adresse">-</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Ville</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validation-ville">-</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Code postal</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validation-codePostal">-</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Section: Documents (pleine largeur) -->
        <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem; margin-top: 1rem;">
          <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
            <i class="fas fa-file-alt" style="color: #ec4899;"></i>
            Documents
          </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
            <div class="flex flex-col items-center py-2">
              <span class="text-xs mb-2" style="color: rgba(148, 163, 184, 0.7);">Sp√©cimen ch√®que</span>
              <span id="validation-specimen" class="text-sm font-medium" style="color: #f1f5f9;">-</span>
            </div>
            <div class="flex flex-col items-center py-2">
              <span class="text-xs mb-2" style="color: rgba(148, 163, 184, 0.7);">Certificat s√©curit√©</span>
              <span id="validation-certificat" class="text-sm font-medium" style="color: #f1f5f9;">-</span>
            </div>
            <div class="flex flex-col items-center py-2">
              <span class="text-xs mb-2" style="color: rgba(148, 163, 184, 0.7);">Carte assurance maladie</span>
              <span id="validation-carte" class="text-sm font-medium" style="color: #f1f5f9;">-</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer sticky -->
      <div class="flex justify-end space-x-3 p-6 pt-4" style="position: sticky; bottom: 0; background: #1a2332; z-index: 10; border-top: 1px solid var(--border-dark);">
        <button type="button" onclick="ouvrirModalRefusCoach()" class="btn-secondary">
          Refuser
        </button>
        <button type="button" id="btn-valider-employe" onclick="validerEmployeCoachAvecAnimation()" class="btn-primary" style="position: relative; overflow: hidden;">
          <span id="btn-valider-text">Valider</span>
          <span id="btn-valider-icon" style="display: none;">
            <i class="fas fa-check-circle"></i>
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Refus Coach - Demander la raison du refus -->
  <div id="modalRefusCoach" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: none;">
    <div class="status-card p-6" style="max-width: 500px; width: 100%;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-times-circle mr-2" style="color: #ef4444;"></i>
          Refuser l'employ√©
        </h3>
        <button onclick="fermerModalRefusCoach()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <p class="text-sm mb-4" style="color: var(--text-muted);">
        Veuillez indiquer la raison du refus. Cette information sera visible par l'entrepreneur.
      </p>

      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Raison du refus *</label>
        <textarea id="motifRefusCoach" rows="4" required class="w-full p-3 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light); resize: none;" placeholder="Expliquez pourquoi vous refusez cet employ√©..."></textarea>
      </div>

      <div class="flex justify-end space-x-3">
        <button type="button" onclick="fermerModalRefusCoach()" class="btn-secondary">
          Annuler
        </button>
        <button type="button" onclick="confirmerRefusCoach()" class="btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;">
          <i class="fas fa-times mr-2"></i>Confirmer le refus
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Voir Raison Refus avec Conversation - Style facturation direction -->
  <div id="modalVoirRefus" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: none;">
    <div class="status-card" style="width: 750px; height: 600px; display: flex; flex-direction: column;">
      <!-- Header -->
      <div class="flex items-center justify-between p-4" style="border-bottom: 1px solid rgba(239, 68, 68, 0.2); background: rgba(239, 68, 68, 0.05);">
        <div class="flex items-center gap-3">
          <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-times" style="color: white;"></i>
          </div>
          <div>
            <h3 class="font-bold" style="color: var(--text-light); margin: 0;">Refus√©</h3>
            <span id="refuseNom" style="color: #ef4444; font-size: 0.85rem;">-</span>
          </div>
        </div>
        <button onclick="fermerModalVoirRefus()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Zone de conversation -->
      <div id="refusConversationContainer" class="flex-1 overflow-y-auto p-4" style="min-height: 200px; max-height: 400px;">
        <!-- Messages seront ins√©r√©s ici -->
      </div>

      <!-- Zone de saisie - Style chat -->
      <div class="p-4" style="border-top: 1px solid var(--border-dark);">
        <div class="refus-chat-input-container">
          <textarea
            id="refusMessageInput"
            placeholder="Votre r√©ponse..."
            rows="1"
            class="refus-chat-textarea"
            onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); envoyerReponseRefus(); }"
          ></textarea>
          <button class="refus-btn-envoyer" onclick="envoyerReponseRefus()" title="Envoyer">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Style pour documents existants (refus/r√©essayer) */
    .file-preview-existing {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem;
    }

    /* Styles conversation refus - identiques √† facturation direction */
    #refusConversationContainer {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .refus-chat-message {
      display: flex;
      flex-direction: column;
      margin-bottom: 0.5rem;
    }

    .refus-chat-message.from-comptable {
      align-items: flex-start;
    }

    .refus-chat-message.from-entrepreneur {
      align-items: flex-end;
    }

    .refus-chat-bubble {
      max-width: 85%;
      padding: 0.75rem 1rem;
      border-radius: 16px;
    }

    .refus-chat-message.from-comptable .refus-chat-bubble {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-bottom-left-radius: 4px;
    }

    .refus-chat-message.from-entrepreneur .refus-chat-bubble {
      background: rgba(59, 130, 246, 0.2);
      border-bottom-right-radius: 4px;
    }

    .refus-chat-bubble .refus-sender {
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
      font-weight: 600;
    }

    .refus-chat-message.from-comptable .refus-chat-bubble .refus-sender {
      color: #ef4444;
    }

    .refus-chat-message.from-entrepreneur .refus-chat-bubble .refus-sender {
      color: #60a5fa;
    }

    .refus-chat-bubble .refus-text {
      color: var(--text-light);
      font-size: 0.9rem;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .refus-chat-bubble .refus-time {
      font-size: 0.65rem;
      color: var(--text-gray);
      margin-top: 0.25rem;
      text-align: right;
    }

    .refus-chat-input-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: rgba(30, 41, 59, 0.4);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.1);
    }

    .refus-chat-textarea {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-light);
      font-size: 0.9rem;
      resize: none;
      outline: none;
      padding: 0.25rem;
      max-height: 100px;
      font-family: inherit;
    }

    .refus-chat-textarea::placeholder {
      color: var(--text-gray);
    }

    .refus-btn-envoyer {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .refus-btn-envoyer:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
  </style>

  <!-- Modal Voir Fin d'emploi par Comptable -->
  <div id="modalVoirFinEmploiComptable" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: none;">
    <div class="status-card p-6" style="max-width: 500px; width: 100%;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-info-circle mr-2" style="color: #ef4444;"></i>
          Fin d'emploi
        </h3>
        <button onclick="fermerModalVoirFinEmploiComptable()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mb-4" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 1rem;">
        <div class="flex items-center gap-2 mb-2">
          <i class="fas fa-user" style="color: #ef4444;"></i>
          <span class="font-semibold" style="color: #ef4444;"><span id="finEmploiComptableNom">-</span></span>
        </div>
        <div class="text-sm mb-2" style="color: var(--text-muted);">
          <i class="fas fa-clock mr-1"></i>
          <span id="finEmploiComptableDate">-</span>
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Motif</label>
        <div id="finEmploiComptableMotif" class="p-3 rounded-lg text-sm" style="background: #0f172a; border: 1px solid var(--border-dark); color: var(--text-light);">-</div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Justificatif</label>
        <div id="finEmploiComptableJustificatif" class="p-3 rounded-lg text-sm" style="background: #0f172a; border: 1px solid var(--border-dark); color: var(--text-light); white-space: pre-wrap;">-</div>
      </div>

      <div class="flex justify-end">
        <button type="button" onclick="fermerModalVoirFinEmploiComptable()" class="btn-secondary">
          Fermer
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Voir Fin d'emploi par Moi -->
  <div id="modalVoirFinEmploiMoi" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: none;">
    <div class="status-card p-6" style="max-width: 500px; width: 100%;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-info-circle mr-2" style="color: #ef4444;"></i>
          Fin d'emploi
        </h3>
        <button onclick="fermerModalVoirFinEmploiMoi()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mb-4" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 1rem;">
        <div class="flex items-center gap-2 mb-2">
          <i class="fas fa-user" style="color: #ef4444;"></i>
          <span class="font-semibold" style="color: #ef4444;"><span id="finEmploiMoiNom">-</span></span>
        </div>
        <div class="text-sm mb-2" style="color: var(--text-muted);">
          <i class="fas fa-clock mr-1"></i>
          <span id="finEmploiMoiDate">-</span>
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Motif</label>
        <div id="finEmploiMoiMotif" class="p-3 rounded-lg text-sm" style="background: #0f172a; border: 1px solid var(--border-dark); color: var(--text-light);">-</div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Justificatif</label>
        <div id="finEmploiMoiJustificatif" class="p-3 rounded-lg text-sm" style="background: #0f172a; border: 1px solid var(--border-dark); color: var(--text-light); white-space: pre-wrap;">-</div>
      </div>

      <div class="flex justify-end">
        <button type="button" onclick="fermerModalVoirFinEmploiMoi()" class="btn-secondary">
          Fermer
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Confirmation Annulation (supprimer employ√© refus√©) -->
  <div id="modalAnnulerEmploye" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: none;">
    <div class="status-card p-6" style="max-width: 450px; width: 100%;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-exclamation-triangle mr-2" style="color: #ef4444;"></i>
          Confirmer l'annulation
        </h3>
        <button onclick="fermerModalAnnuler()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mb-4" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 1rem;">
        <p style="color: var(--text-light); margin-bottom: 0.5rem;">
          √ätes-vous s√ªr de vouloir supprimer cet employ√© ?
        </p>
        <p class="font-semibold" style="color: #ef4444; font-size: 1.1rem;">
          <i class="fas fa-user mr-2"></i>
          <span id="nomEmployeAnnuler">-</span>
        </p>
      </div>

      <p class="text-sm mb-4" style="color: var(--text-muted);">
        <i class="fas fa-info-circle mr-1"></i>
        Cette action est irr√©versible. Toutes les donn√©es de cet employ√© seront supprim√©es d√©finitivement.
      </p>

      <div class="flex justify-end gap-3">
        <button type="button" onclick="fermerModalAnnuler()" class="btn-secondary">
          Annuler
        </button>
        <button type="button" onclick="confirmerAnnulerEmploye()" class="btn-primary" style="background: #ef4444 !important; border-color: #ef4444 !important;">
          <i class="fas fa-trash mr-1"></i>
          Supprimer
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Info Employ√© (m√™me style que V√©rifier mais sans boutons copie et sans Refuser/Valider) -->
  <div id="modalDetailsEmploye" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none;">
    <div class="status-card w-full" style="max-width: 1100px; max-height: 80vh; display: flex; flex-direction: column;">
      <!-- Header sticky -->
      <div class="flex items-center justify-between p-6 pb-4" style="position: sticky; top: 0; background: #1a2332; z-index: 10; border-bottom: 1px solid var(--border-dark);">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-info-circle mr-2" style="color: #60a5fa;"></i>
          Informations de l'employ√©
        </h3>
        <button onclick="fermerModalDetails()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2); color: #60a5fa;" onmouseover="this.style.background='rgba(96, 165, 250, 0.3)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Body scrollable avec grid 2 colonnes -->
      <div style="flex: 1; overflow-y: auto; padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <!-- Colonne gauche -->
          <div class="space-y-4">
            <!-- Section: Informations personnelles -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-user" style="color: #60a5fa;"></i>
                Informations personnelles
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Nom complet</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="detailsNom">-</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Genre</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="detailsGenre">-</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">NAS</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="detailsNas">-</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Date de naissance</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="detailsDateNaissance">-</span>
              </div>
            </div>

            <!-- Section: Contact -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-phone" style="color: #10b981;"></i>
                Contact
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Courriel</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="detailsCourriel">-</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">T√©l√©phone</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="detailsTelephone">-</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Adresse</span>
                <span class="text-sm font-medium" style="color: #f1f5f9; white-space: nowrap;" id="detailsAdresseComplete">-</span>
              </div>
            </div>
          </div>

          <!-- Colonne droite -->
          <div class="space-y-4">
            <!-- Section: Informations d'emploi -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-briefcase" style="color: #f59e0b;"></i>
                Informations d'emploi
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Poste</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="detailsPoste">-</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">D√©partement</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="detailsDepartement">0</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Taux horaire</span>
                <span class="text-sm font-medium" style="color: #10b981;" id="detailsTauxHoraire">-</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Date premi√®re journ√©e</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="detailsDateDebut">-</span>
              </div>
            </div>

            <!-- Section: Adresse d√©taill√©e -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-map-marker-alt" style="color: #8b5cf6;"></i>
                Adresse d√©taill√©e
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Adresse</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="detailsAdresse">-</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Ville</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="detailsVille">-</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Code postal</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="detailsCodePostal">-</span>
              </div>
            </div>

            <!-- Section: Documents -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-file-alt" style="color: #60a5fa;"></i>
                Documents
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Sp√©cimen ch√®que</span>
                <span id="details-specimen-preview" style="display: none;">
                  <button onclick="openFileModal(document.getElementById('details-specimen-link').href)" class="text-sm font-medium" style="color: #60a5fa; background: none; border: none; cursor: pointer;">
                    <i class="fas fa-eye mr-1"></i>Voir
                  </button>
                  <a href="#" id="details-specimen-link" style="display: none;"></a>
                </span>
                <span id="details-specimen-none" class="text-sm" style="color: #6b7280;">Aucun fichier</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Certificat s√©curit√©</span>
                <span id="details-certificat-preview" style="display: none;">
                  <button onclick="openFileModal(document.getElementById('details-certificat-link').href)" class="text-sm font-medium" style="color: #60a5fa; background: none; border: none; cursor: pointer;">
                    <i class="fas fa-eye mr-1"></i>Voir
                  </button>
                  <a href="#" id="details-certificat-link" style="display: none;"></a>
                </span>
                <span id="details-certificat-none" class="text-sm" style="color: #6b7280;">Aucun fichier</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Carte assurance maladie</span>
                <span id="details-carte-preview" style="display: none;">
                  <button onclick="openFileModal(document.getElementById('details-carte-link').href)" class="text-sm font-medium" style="color: #60a5fa; background: none; border: none; cursor: pointer;">
                    <i class="fas fa-eye mr-1"></i>Voir
                  </button>
                  <a href="#" id="details-carte-link" style="display: none;"></a>
                </span>
                <span id="details-carte-none" class="text-sm" style="color: #6b7280;">Aucun fichier</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer sticky avec seulement un bouton Fermer -->
      <div class="flex justify-end p-6 pt-4" style="position: sticky; bottom: 0; background: #1a2332; z-index: 10; border-top: 1px solid var(--border-dark);">
        <button type="button" onclick="fermerModalDetails()" class="btn-secondary">
          Fermer
        </button>
      </div>
    </div>
  </div>

  <!-- Modal D√©tails Employ√© Termin√© (m√™me style que Info mais avec motif/justificatif) -->
  <div id="modalDetailsEmployeTermine" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none;">
    <div class="status-card w-full" style="max-width: 1100px; max-height: 80vh; display: flex; flex-direction: column;">
      <!-- Header sticky -->
      <div class="flex items-center justify-between p-6 pb-4" style="position: sticky; top: 0; background: #1a2332; z-index: 10; border-bottom: 1px solid var(--border-dark);">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user-times mr-2" style="color: #ef4444;"></i>
          D√©tails de l'employ√© termin√©
        </h3>
        <button onclick="fermerModalDetailsTermine()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Body scrollable avec grid 2 colonnes -->
      <div style="flex: 1; overflow-y: auto; padding: 1.5rem;">
        <!-- Section Fin d'emploi en haut -->
        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1rem;">
          <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #ef4444; border-bottom: 1px solid rgba(239, 68, 68, 0.2);">
            <i class="fas fa-exclamation-triangle"></i>
            Fin d'emploi
          </div>
          <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(239, 68, 68, 0.2);">
            <span class="text-sm" style="color: rgba(239, 68, 68, 0.7) !important;">Date de fin</span>
            <span class="text-sm font-medium" style="color: #fca5a5;" id="termineDetailsDateFin">-</span>
          </div>
          <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(239, 68, 68, 0.2);">
            <span class="text-sm" style="color: rgba(239, 68, 68, 0.7) !important;">Motif</span>
            <span class="text-sm font-medium" style="color: #fca5a5;" id="termineDetailsMotif">-</span>
          </div>
          <div class="py-2">
            <span class="text-sm" style="color: rgba(239, 68, 68, 0.7) !important;">Justificatif</span>
            <p class="text-sm mt-1" style="color: #f1f5f9; background: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 8px; white-space: pre-wrap;" id="termineDetailsJustificatif">-</p>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <!-- Colonne gauche -->
          <div class="space-y-4">
            <!-- Section: Informations personnelles -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-user" style="color: #60a5fa;"></i>
                Informations personnelles
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Nom complet</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="termineDetailsNom">-</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Genre</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="termineDetailsGenre">-</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">NAS</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="termineDetailsNas">-</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Date de naissance</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="termineDetailsDateNaissance">-</span>
              </div>
            </div>

            <!-- Section: Contact -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-phone" style="color: #10b981;"></i>
                Contact
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Courriel</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="termineDetailsCourriel">-</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">T√©l√©phone</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="termineDetailsTelephone">-</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Adresse</span>
                <span class="text-sm font-medium" style="color: #f1f5f9; white-space: nowrap;" id="termineDetailsAdresseComplete">-</span>
              </div>
            </div>
          </div>

          <!-- Colonne droite -->
          <div class="space-y-4">
            <!-- Section: Informations d'emploi -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-briefcase" style="color: #f59e0b;"></i>
                Informations d'emploi
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Poste</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="termineDetailsPoste">-</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">D√©partement</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="termineDetailsDepartement">0</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Taux horaire</span>
                <span class="text-sm font-medium" style="color: #10b981;" id="termineDetailsTauxHoraire">-</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Date premi√®re journ√©e</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="termineDetailsDateDebut">-</span>
              </div>
            </div>

            <!-- Section: Adresse d√©taill√©e -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-map-marker-alt" style="color: #8b5cf6;"></i>
                Adresse d√©taill√©e
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Adresse</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="termineDetailsAdresse">-</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Ville</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="termineDetailsVille">-</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Code postal</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="termineDetailsCodePostal">-</span>
              </div>
            </div>

            <!-- Section: Documents -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-file-alt" style="color: #60a5fa;"></i>
                Documents
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Sp√©cimen ch√®que</span>
                <span id="termine-specimen-preview" style="display: none;">
                  <button onclick="openFileModal(document.getElementById('termine-specimen-link').href)" class="text-sm font-medium" style="color: #60a5fa; background: none; border: none; cursor: pointer;">
                    <i class="fas fa-eye mr-1"></i>Voir
                  </button>
                  <a href="#" id="termine-specimen-link" style="display: none;"></a>
                </span>
                <span id="termine-specimen-none" class="text-sm" style="color: #6b7280;">Aucun fichier</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Certificat s√©curit√©</span>
                <span id="termine-certificat-preview" style="display: none;">
                  <button onclick="openFileModal(document.getElementById('termine-certificat-link').href)" class="text-sm font-medium" style="color: #60a5fa; background: none; border: none; cursor: pointer;">
                    <i class="fas fa-eye mr-1"></i>Voir
                  </button>
                  <a href="#" id="termine-certificat-link" style="display: none;"></a>
                </span>
                <span id="termine-certificat-none" class="text-sm" style="color: #6b7280;">Aucun fichier</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Carte assurance maladie</span>
                <span id="termine-carte-preview" style="display: none;">
                  <button onclick="openFileModal(document.getElementById('termine-carte-link').href)" class="text-sm font-medium" style="color: #60a5fa; background: none; border: none; cursor: pointer;">
                    <i class="fas fa-eye mr-1"></i>Voir
                  </button>
                  <a href="#" id="termine-carte-link" style="display: none;"></a>
                </span>
                <span id="termine-carte-none" class="text-sm" style="color: #6b7280;">Aucun fichier</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer sticky avec seulement un bouton Fermer -->
      <div class="flex justify-end p-6 pt-4" style="position: sticky; bottom: 0; background: #1a2332; z-index: 10; border-top: 1px solid var(--border-dark);">
        <button type="button" onclick="fermerModalDetailsTermine()" class="btn-secondary">
          Fermer
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Validation R√©activation (pour coach) - Style similaire √† validation activation -->
  <div id="modalValidationReactivation" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none;">
    <div class="status-card w-full" style="max-width: 1100px; max-height: 85vh; display: flex; flex-direction: column;">
      <!-- Header sticky -->
      <div class="flex items-center justify-between p-6 pb-4" style="position: sticky; top: 0; background: #1a2332; z-index: 10; border-bottom: 1px solid var(--border-dark);">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user-check mr-2" style="color: #10b981;"></i>
          V√©rifier la r√©activation
        </h3>
        <button onclick="fermerPopupValidationReactivation()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(16, 185, 129, 0.2); color: #10b981;" onmouseover="this.style.background='rgba(16, 185, 129, 0.3)'" onmouseout="this.style.background='rgba(16, 185, 129, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Body scrollable avec grid 2 colonnes -->
      <div style="flex: 1; overflow-y: auto; padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <!-- Colonne gauche -->
          <div class="space-y-4">
            <!-- Section: Informations personnelles -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-user" style="color: #60a5fa;"></i>
                Informations personnelles
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Nom complet</span>
                <span class="flex items-center gap-2">
                  <span class="text-sm font-medium" style="color: #f1f5f9;" id="reactivation-nom">-</span>
                  <button class="btn-copy" onclick="copierTexteValidation(document.getElementById('reactivation-nom').textContent, this)"><i class="fas fa-copy"></i></button>
                </span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Genre</span>
                <span class="flex items-center gap-2">
                  <span class="text-sm font-medium" style="color: #f1f5f9;" id="reactivation-genre">-</span>
                  <button class="btn-copy" onclick="copierTexteValidation(document.getElementById('reactivation-genre').textContent, this)"><i class="fas fa-copy"></i></button>
                </span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">NAS</span>
                <span class="flex items-center gap-2">
                  <span class="text-sm font-medium" style="color: #f1f5f9;" id="reactivation-nas">-</span>
                  <button class="btn-copy" onclick="copierTexteValidation(document.getElementById('reactivation-nas').textContent, this)"><i class="fas fa-copy"></i></button>
                </span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Date de candidature</span>
                <span class="flex items-center gap-2">
                  <span class="text-sm font-medium" style="color: #f1f5f9;" id="reactivation-date-candidature">-</span>
                  <button class="btn-copy" onclick="copierTexteValidation(document.getElementById('reactivation-date-candidature').textContent, this)"><i class="fas fa-copy"></i></button>
                </span>
              </div>
            </div>

            <!-- Section: Contact -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-phone" style="color: #10b981;"></i>
                Contact
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Courriel</span>
                <span class="flex items-center gap-2">
                  <span class="text-sm font-medium" style="color: #f1f5f9;" id="reactivation-courriel">-</span>
                  <button class="btn-copy" onclick="copierTexteValidation(document.getElementById('reactivation-courriel').textContent, this)"><i class="fas fa-copy"></i></button>
                </span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">T√©l√©phone</span>
                <span class="flex items-center gap-2">
                  <span class="text-sm font-medium" style="color: #f1f5f9;" id="reactivation-telephone">-</span>
                  <button class="btn-copy" onclick="copierTexteValidation(document.getElementById('reactivation-telephone').textContent, this)"><i class="fas fa-copy"></i></button>
                </span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Adresse</span>
                <span class="flex items-center gap-2">
                  <span class="text-sm font-medium" style="color: #f1f5f9; white-space: nowrap;" id="reactivation-adresse-complete">-</span>
                  <button class="btn-copy" onclick="copierTexteValidation(document.getElementById('reactivation-adresse-complete').textContent, this)"><i class="fas fa-copy"></i></button>
                </span>
              </div>
            </div>
          </div>

          <!-- Colonne droite -->
          <div class="space-y-4">
            <!-- Section: Informations d'emploi avec champs modifi√©s en vert -->
            <div style="background: rgba(16, 185, 129, 0.1); border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #10b981; border-bottom: 1px solid rgba(16, 185, 129, 0.2);">
                <i class="fas fa-briefcase"></i>
                Informations d'emploi
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(16, 185, 129, 0.2);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Poste</span>
                <span class="flex items-center gap-2">
                  <span class="text-sm font-medium" style="color: #f1f5f9;" id="reactivation-poste">-</span>
                  <button class="btn-copy" onclick="copierTexteValidation(document.getElementById('reactivation-poste').textContent, this)"><i class="fas fa-copy"></i></button>
                </span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(16, 185, 129, 0.2); background: rgba(16, 185, 129, 0.15); margin: 0 -1.25rem; padding: 0.5rem 1.25rem;">
                <span class="text-sm flex items-center gap-2" style="color: #10b981 !important; font-weight: 600;">
                  <i class="fas fa-edit" style="font-size: 0.7rem;"></i>
                  Taux horaire
                  <span style="font-size: 0.65rem; background: #10b981; color: white; padding: 2px 6px; border-radius: 4px;">MODIFI√â</span>
                </span>
                <span class="flex items-center gap-2">
                  <span class="text-sm font-bold" style="color: #10b981;" id="reactivation-taux">-</span>
                  <button class="btn-copy" onclick="copierTexteValidation(document.getElementById('reactivation-taux').textContent, this)"><i class="fas fa-copy"></i></button>
                </span>
              </div>
              <div class="flex justify-between items-center py-2" style="background: rgba(16, 185, 129, 0.15); margin: 0 -1.25rem; padding: 0.5rem 1.25rem;">
                <span class="text-sm flex items-center gap-2" style="color: #10b981 !important; font-weight: 600;">
                  <i class="fas fa-edit" style="font-size: 0.7rem;"></i>
                  Date premi√®re journ√©e
                  <span style="font-size: 0.65rem; background: #10b981; color: white; padding: 2px 6px; border-radius: 4px;">MODIFI√â</span>
                </span>
                <span class="flex items-center gap-2">
                  <span class="text-sm font-bold" style="color: #10b981;" id="reactivation-date-premiere">-</span>
                  <button class="btn-copy" onclick="copierTexteValidation(document.getElementById('reactivation-date-premiere').textContent, this)"><i class="fas fa-copy"></i></button>
                </span>
              </div>
            </div>

            <!-- Section: Documents -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-file-alt" style="color: #8b5cf6;"></i>
                Documents
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Sp√©cimen ch√®que</span>
                <span id="reactivation-specimen-preview" style="display: none;">
                  <button onclick="openFileModal(document.getElementById('reactivation-specimen-link').href)" class="text-sm font-medium" style="color: #60a5fa; background: none; border: none; cursor: pointer;">
                    <i class="fas fa-eye mr-1"></i>Voir
                  </button>
                  <a href="#" id="reactivation-specimen-link" style="display: none;"></a>
                </span>
                <span id="reactivation-specimen-none" class="text-sm" style="color: #6b7280;">Aucun fichier</span>
              </div>
              <div class="flex justify-between items-center py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Certificat s√©curit√©</span>
                <span id="reactivation-certificat-preview" style="display: none;">
                  <button onclick="openFileModal(document.getElementById('reactivation-certificat-link').href)" class="text-sm font-medium" style="color: #60a5fa; background: none; border: none; cursor: pointer;">
                    <i class="fas fa-eye mr-1"></i>Voir
                  </button>
                  <a href="#" id="reactivation-certificat-link" style="display: none;"></a>
                </span>
                <span id="reactivation-certificat-none" class="text-sm" style="color: #6b7280;">Aucun fichier</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-sm" style="color: rgba(148, 163, 184, 0.7) !important;">Carte assurance maladie</span>
                <span id="reactivation-carte-preview" style="display: none;">
                  <button onclick="openFileModal(document.getElementById('reactivation-carte-link').href)" class="text-sm font-medium" style="color: #60a5fa; background: none; border: none; cursor: pointer;">
                    <i class="fas fa-eye mr-1"></i>Voir
                  </button>
                  <a href="#" id="reactivation-carte-link" style="display: none;"></a>
                </span>
                <span id="reactivation-carte-none" class="text-sm" style="color: #6b7280;">Aucun fichier</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer sticky -->
      <div class="flex justify-end space-x-3 p-6 pt-4" style="position: sticky; bottom: 0; background: #1a2332; z-index: 10; border-top: 1px solid var(--border-dark);">
        <button type="button" onclick="refuserReactivationCoach()" class="btn-secondary">
          Refuser
        </button>
        <button type="button" id="btn-valider-reactivation" onclick="validerReactivationCoach()" class="btn-primary" style="background: #10b981;">
          Valider la r√©activation
        </button>
      </div>
    </div>
  </div>

  <!-- Modal R√©activer Employ√© (m√™me style que Modifier avec champs √©ditables) -->
  <div id="modalConfirmationReactiver" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none;">
    <div class="status-card w-full" style="max-width: 1100px; max-height: 78vh; display: flex; flex-direction: column;">
      <!-- Header sticky -->
      <div class="flex items-center justify-between p-6 pb-4" style="position: sticky; top: 0; background: #1a2332; z-index: 10; border-bottom: 1px solid var(--border-dark);">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-undo mr-2" style="color: #10b981;"></i>
          R√©activer l'employ√©
        </h3>
        <button onclick="fermerModalReactiver()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(16, 185, 129, 0.2); color: #10b981;" onmouseover="this.style.background='rgba(16, 185, 129, 0.3)'" onmouseout="this.style.background='rgba(16, 185, 129, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Body scrollable avec grid 2 colonnes -->
      <form id="formReactiverEmploye" style="flex: 1; overflow-y: auto; padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <!-- Colonne gauche -->
          <div class="space-y-4">
            <!-- Section: Informations personnelles -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-user" style="color: #60a5fa;"></i>
                Informations personnelles
              </div>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Nom complet *</label>
                  <input type="text" id="reactiverNomComplet" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="Nom complet">
                </div>
                <div style="position: relative;">
                  <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Genre *</label>
                  <input type="hidden" id="reactiverGenreHidden" required>
                  <div class="dropdown-secondary" id="reactiverGenre-dropdown" style="width: 100% !important; background: #172033; border: 2px solid var(--border-dark); color: var(--text-light); border-radius: 12px; padding: 12px 16px; font-size: 0.875rem; cursor: pointer;">
                    <span id="reactiverGenre-selected">S√©lectionner</span>
                    <i class="fas fa-chevron-down"></i>
                  </div>
                  <div class="dropdown-secondary-menu" id="reactiverGenre-menu" style="background: #0f172a; border: 2px solid var(--border-dark); border-radius: 12px;">
                    <div class="dropdown-secondary-option" data-value="homme">Homme</div>
                    <div class="dropdown-secondary-option" data-value="Femme">Femme</div>
                  </div>
                </div>
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">NAS *</label>
                  <input type="text" id="reactiverNas" required maxlength="9" class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="123456789">
                </div>
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Date de naissance *</label>
                  <input type="text" id="reactiverDateNaissance" required maxlength="10" class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="AAAA-MM-JJ">
                </div>
              </div>
            </div>

            <!-- Section: Contact -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-phone" style="color: #10b981;"></i>
                Contact
              </div>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Courriel *</label>
                  <input type="email" id="reactiverCourriel" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="exemple@email.com">
                </div>
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">T√©l√©phone *</label>
                  <input type="tel" id="reactiverTelephone" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="(XXX) XXX-XXXX">
                </div>
              </div>
            </div>
          </div>

          <!-- Colonne droite -->
          <div class="space-y-4">
            <!-- Section: Informations d'emploi -->
            <div style="background: rgba(16, 185, 129, 0.1); border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #10b981; border-bottom: 1px solid rgba(16, 185, 129, 0.2);">
                <i class="fas fa-briefcase"></i>
                Informations d'emploi
              </div>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Poste *</label>
                  <input type="text" id="reactiverPoste" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="Titre du poste">
                </div>
                <div>
                  <label class="block text-sm mb-1" style="color: #10b981; font-weight: 600;">Taux horaire ($) * <span style="color: #fbbf24; font-size: 0.75rem;">(√Ä remplir)</span></label>
                  <input type="text" id="reactiverTauxHoraire" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid #10b981; color: var(--text-light);" placeholder="25,00">
                </div>
                <div>
                  <label class="block text-sm mb-1" style="color: #10b981; font-weight: 600;">Date premi√®re journ√©e * <span style="color: #fbbf24; font-size: 0.75rem;">(√Ä remplir)</span></label>
                  <div class="custom-date-container" style="position: relative;">
                    <input type="text" id="reactiverDatePremiere" required class="w-full p-2 text-sm rounded-lg cursor-pointer" placeholder="S√©lectionner une date" readonly autocomplete="off" style="background: #0f172a; border: 2px solid #10b981; color: var(--text-light);">
                    <div class="custom-calendar hidden" id="calendar-reactiverDatePremiere">
                      <!-- Calendar content will be generated here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Section: Adresse -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-map-marker-alt" style="color: #8b5cf6;"></i>
                Adresse
              </div>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Adresse *</label>
                  <input type="text" id="reactiverAdresse" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="123 Rue Exemple">
                </div>
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Ville * <span style="color: #64748b; font-size: 0.75rem;">(Auto)</span></label>
                  <input type="text" id="reactiverVille" required readonly class="w-full p-2 text-sm rounded-lg" style="background: #0a0f1a; border: 2px solid var(--border-dark); color: #64748b; cursor: not-allowed;" placeholder="Rempli automatiquement">
                </div>
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Code postal * <span style="color: #64748b; font-size: 0.75rem;">(Auto)</span></label>
                  <input type="text" id="reactiverCodePostal" required readonly maxlength="7" class="w-full p-2 text-sm rounded-lg" style="background: #0a0f1a; border: 2px solid var(--border-dark); color: #64748b; cursor: not-allowed;" placeholder="Rempli automatiquement">
                </div>
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Appartement <span style="color: #64748b; font-size: 0.75rem;">(facultatif)</span></label>
                  <input type="text" id="reactiverAppartement" class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="Num√©ro d'appartement">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section: Documents -->
        <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem; margin-top: 1rem;">
          <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
            <i class="fas fa-file-alt" style="color: #60a5fa;"></i>
            Documents
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <!-- Sp√©cimen ch√®que -->
            <div>
              <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Sp√©cimen ch√®que</label>
              <div id="dropzoneReactiverSpecimen" class="upload-zone-small cursor-pointer">
                <p><i class="fas fa-upload mr-1"></i> Choisir fichier</p>
                <input type="file" id="reactiverSpecimenCheque" accept="image/*,.pdf" class="hidden">
              </div>
              <div id="previewReactiverSpecimen" class="mt-2 hidden relative inline-block">
                <a href="javascript:void(0)" class="file-preview-link">
                  <img class="h-12 rounded shadow" style="border: 2px solid #60a5fa;" />
                </a>
                <button type="button" onclick="removeReactiverFilePreview('reactiverSpecimenCheque')" class="file-remove-btn" style="position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer; border: none;">
                  √ó
                </button>
              </div>
              <div id="existingReactiverSpecimen" class="mt-2 hidden">
                <button type="button" onclick="openFileModal(this.dataset.fileUrl, 'Sp√©cimen ch√®que actuel')" data-file-url="" class="w-auto text-xs py-1.5 px-2 rounded transition-colors flex items-center justify-center gap-1" style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); color: #60a5fa; margin-bottom: 1rem;">
                  <i class="fas fa-eye mr-1"></i> Voir actuel
                </button>
              </div>
            </div>

            <!-- Certificat de s√©curit√© -->
            <div>
              <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Certificat de s√©curit√©</label>
              <div id="dropzoneReactiverCertificat" class="upload-zone-small cursor-pointer">
                <p><i class="fas fa-upload mr-1"></i> Choisir fichier</p>
                <input type="file" id="reactiverCertificatSecurite" accept="image/*,.pdf" class="hidden">
              </div>
              <div id="previewReactiverCertificat" class="mt-2 hidden relative inline-block">
                <a href="javascript:void(0)" class="file-preview-link">
                  <img class="h-12 rounded shadow" style="border: 2px solid #60a5fa;" />
                </a>
                <button type="button" onclick="removeReactiverFilePreview('reactiverCertificatSecurite')" class="file-remove-btn" style="position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer; border: none;">
                  √ó
                </button>
              </div>
              <div id="existingReactiverCertificat" class="mt-2 hidden">
                <button type="button" onclick="openFileModal(this.dataset.fileUrl, 'Certificat de s√©curit√© actuel')" data-file-url="" class="w-auto text-xs py-1.5 px-2 rounded transition-colors flex items-center justify-center gap-1" style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); color: #60a5fa; margin-bottom: 1rem;">
                  <i class="fas fa-eye mr-1"></i> Voir actuel
                </button>
              </div>
            </div>

            <!-- Carte d'assurance maladie -->
            <div>
              <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Carte d'assurance maladie</label>
              <div id="dropzoneReactiverCarte" class="upload-zone-small cursor-pointer">
                <p><i class="fas fa-upload mr-1"></i> Choisir fichier</p>
                <input type="file" id="reactiverCarteAssurance" accept="image/*,.pdf" class="hidden">
              </div>
              <div id="previewReactiverCarte" class="mt-2 hidden relative inline-block">
                <a href="javascript:void(0)" class="file-preview-link">
                  <img class="h-12 rounded shadow" style="border: 2px solid #60a5fa;" />
                </a>
                <button type="button" onclick="removeReactiverFilePreview('reactiverCarteAssurance')" class="file-remove-btn" style="position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer; border: none;">
                  √ó
                </button>
              </div>
              <div id="existingReactiverCarte" class="mt-2 hidden">
                <button type="button" onclick="openFileModal(this.dataset.fileUrl, 'Carte d\'assurance maladie actuelle')" data-file-url="" class="w-auto text-xs py-1.5 px-2 rounded transition-colors flex items-center justify-center gap-1" style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); color: #60a5fa; margin-bottom: 1rem;">
                  <i class="fas fa-eye mr-1"></i> Voir actuel
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Message info -->
        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 1rem; margin-top: 1rem;">
          <div class="flex items-start gap-3">
            <i class="fas fa-info-circle" style="color: #10b981; margin-top: 2px;"></i>
            <div>
              <p class="text-sm font-medium" style="color: #10b981;">R√©activation</p>
              <p class="text-sm" style="color: rgba(16, 185, 129, 0.8);">Les champs taux horaire et date de premi√®re journ√©e sont obligatoires. Les documents existants seront conserv√©s sauf si vous en t√©l√©chargez de nouveaux. La demande sera envoy√©e pour validation au coach et √† la direction.</p>
            </div>
          </div>
        </div>
      </form>

      <!-- Footer sticky -->
      <div class="flex justify-end space-x-3 p-6 pt-4" style="position: sticky; bottom: 0; background: #1a2332; z-index: 10; border-top: 1px solid var(--border-dark);">
        <button type="button" onclick="fermerModalReactiver()" class="btn-secondary">
          Annuler
        </button>
        <button type="button" onclick="confirmerReactivation()" class="btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;">
          <i class="fas fa-undo mr-2"></i>Envoyer la demande de r√©activation
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Modifier Employ√© (m√™me style que Info mais avec champs √©ditables) -->
  <div id="modalModifierEmploye" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none;">
    <div class="status-card w-full" style="max-width: 1100px; max-height: 78vh; display: flex; flex-direction: column;">
      <!-- Header sticky -->
      <div class="flex items-center justify-between p-6 pb-4" style="position: sticky; top: 0; background: #1a2332; z-index: 10; border-bottom: 1px solid var(--border-dark);">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user-edit mr-2" style="color: #f59e0b;"></i>
          Modifier l'employ√©
        </h3>
        <button onclick="fermerModalModifier()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b;" onmouseover="this.style.background='rgba(245, 158, 11, 0.3)'" onmouseout="this.style.background='rgba(245, 158, 11, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Body scrollable avec grid 2 colonnes -->
      <form id="formModifierEmploye" style="flex: 1; overflow-y: auto; padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <!-- Colonne gauche -->
          <div class="space-y-4">
            <!-- Section: Informations personnelles -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-user" style="color: #60a5fa;"></i>
                Informations personnelles
              </div>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Nom complet *</label>
                  <input type="text" id="modifierNomComplet" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="Nom complet">
                </div>
                <div style="position: relative;">
                  <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Genre *</label>
                  <input type="hidden" id="modifierGenre" required>
                  <div class="dropdown-secondary" id="modifierGenre-dropdown" style="width: 100% !important; background: #172033; border: 2px solid var(--border-dark); color: var(--text-light); border-radius: 8px; padding: 0.5rem; font-size: 0.875rem;">
                    <span id="modifierGenre-selected">S√©lectionner</span>
                    <i class="fas fa-chevron-down"></i>
                  </div>
                  <div class="dropdown-secondary-menu" id="modifierGenre-menu" style="background: #0f172a; border: 2px solid var(--border-dark);">
                    <div class="dropdown-secondary-option" data-value="homme">Homme</div>
                    <div class="dropdown-secondary-option" data-value="Femme">Femme</div>
                  </div>
                </div>
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">NAS *</label>
                  <input type="text" id="modifierNas" required maxlength="9" class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="123456789">
                </div>
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Date de naissance *</label>
                  <input type="text" id="modifierDateNaissance" required maxlength="10" class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="AAAA-MM-JJ">
                </div>
              </div>
            </div>

            <!-- Section: Contact -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-phone" style="color: #10b981;"></i>
                Contact
              </div>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Courriel *</label>
                  <input type="email" id="modifierCourriel" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="exemple@email.com">
                </div>
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">T√©l√©phone *</label>
                  <input type="tel" id="modifierTelephone" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="(XXX) XXX-XXXX">
                </div>
              </div>
            </div>
          </div>

          <!-- Colonne droite -->
          <div class="space-y-4">
            <!-- Section: Informations d'emploi -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-briefcase" style="color: #f59e0b;"></i>
                Informations d'emploi
              </div>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Poste *</label>
                  <input type="text" id="modifierPosteService" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="Titre du poste">
                </div>
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Taux horaire ($) *</label>
                  <input type="text" id="modifierTauxHoraire" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="25,00">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Date premi√®re journ√©e *</label>
                  <div class="custom-date-container" style="position: relative;">
                    <input type="text" id="modifierDatePremiere" required class="w-full p-2 text-sm rounded-lg cursor-pointer" placeholder="S√©lectionner une date" readonly autocomplete="off" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);">
                    <div class="custom-calendar hidden" id="calendar-modifierDatePremiere">
                      <!-- Calendar content will be generated here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Section: Adresse -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-map-marker-alt" style="color: #8b5cf6;"></i>
                Adresse
              </div>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Adresse *</label>
                  <input type="text" id="modifierAdresse" required class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="123 Rue Exemple">
                </div>
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Ville * <span style="color: #64748b; font-size: 0.75rem;">(Auto)</span></label>
                  <input type="text" id="modifierVille" required readonly class="w-full p-2 text-sm rounded-lg" style="background: #0a0f1a; border: 2px solid var(--border-dark); color: #64748b; cursor: not-allowed;" placeholder="Rempli automatiquement">
                </div>
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Code postal * <span style="color: #64748b; font-size: 0.75rem;">(Auto)</span></label>
                  <input type="text" id="modifierCodePostal" required readonly maxlength="7" class="w-full p-2 text-sm rounded-lg" style="background: #0a0f1a; border: 2px solid var(--border-dark); color: #64748b; cursor: not-allowed;" placeholder="Rempli automatiquement">
                </div>
                <div>
                  <label class="block text-sm mb-1" style="color: rgba(148, 163, 184, 0.7);">Appartement <span style="color: #64748b; font-size: 0.75rem;">(facultatif)</span></label>
                  <input type="text" id="modifierAppartement" class="w-full p-2 text-sm rounded-lg" style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);" placeholder="Num√©ro d'appartement">
                </div>
              </div>
            </div>

            <!-- Section: Documents -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-file-alt" style="color: #ec4899;"></i>
                Documents
              </div>

              <!-- Sp√©cimen ch√®que -->
              <div class="py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <label class="block text-sm font-medium mb-2" style="color: rgba(148, 163, 184, 0.7);">Sp√©cimen ch√®que</label>
                <div id="modifier-specimen-preview" style="display: none; text-align: center;">
                  <button type="button" onclick="openFileModal(document.getElementById('modifier-specimen-link').href)" class="text-sm font-medium px-3 py-1.5 rounded-full" style="color: #60a5fa; background: rgba(96, 165, 250, 0.15); border: 1px solid rgba(96, 165, 250, 0.3); cursor: pointer; margin-bottom: 1rem;">
                    <i class="fas fa-eye mr-1"></i> Voir actuel
                  </button>
                  <a href="#" id="modifier-specimen-link" style="display: none;"></a>
                </div>
                <div id="dropzoneModifierSpecimen" class="upload-zone-small cursor-pointer" style="border-color: rgba(148, 163, 184, 0.3);">
                  <p style="color: #94a3b8;"><i class="fas fa-upload mr-1"></i> Remplacer le fichier</p>
                  <input type="file" id="modifierSpecimenCheque" accept="image/*,.pdf" class="hidden">
                </div>
                <div id="previewModifierSpecimen" class="mt-2 hidden relative inline-block">
                  <a href="javascript:void(0)" class="file-preview-link">
                    <img class="h-12 rounded shadow" style="border: 2px solid #60a5fa;" />
                  </a>
                  <button type="button" onclick="removeModifierFilePreview('modifierSpecimenCheque')" class="file-remove-btn" style="position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer; border: none;">
                    √ó
                  </button>
                </div>
              </div>

              <!-- Certificat s√©curit√© -->
              <div class="py-2" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <label class="block text-sm font-medium mb-2" style="color: rgba(148, 163, 184, 0.7);">Certificat s√©curit√©</label>
                <div id="modifier-certificat-preview" style="display: none; text-align: center;">
                  <button type="button" onclick="openFileModal(document.getElementById('modifier-certificat-link').href)" class="text-sm font-medium px-3 py-1.5 rounded-full" style="color: #60a5fa; background: rgba(96, 165, 250, 0.15); border: 1px solid rgba(96, 165, 250, 0.3); cursor: pointer; margin-bottom: 1rem;">
                    <i class="fas fa-eye mr-1"></i> Voir actuel
                  </button>
                  <a href="#" id="modifier-certificat-link" style="display: none;"></a>
                </div>
                <div id="dropzoneModifierCertificat" class="upload-zone-small cursor-pointer" style="border-color: rgba(148, 163, 184, 0.3);">
                  <p style="color: #94a3b8;"><i class="fas fa-upload mr-1"></i> Remplacer le fichier</p>
                  <input type="file" id="modifierCertificatSecurite" accept="image/*,.pdf" class="hidden">
                </div>
                <div id="previewModifierCertificat" class="mt-2 hidden relative inline-block">
                  <a href="javascript:void(0)" class="file-preview-link">
                    <img class="h-12 rounded shadow" style="border: 2px solid #60a5fa;" />
                  </a>
                  <button type="button" onclick="removeModifierFilePreview('modifierCertificatSecurite')" class="file-remove-btn" style="position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer; border: none;">
                    √ó
                  </button>
                </div>
              </div>

              <!-- Carte assurance maladie -->
              <div class="py-2">
                <label class="block text-sm font-medium mb-2" style="color: rgba(148, 163, 184, 0.7);">Carte assurance maladie</label>
                <div id="modifier-carte-preview" style="display: none; text-align: center;">
                  <button type="button" onclick="openFileModal(document.getElementById('modifier-carte-link').href)" class="text-sm font-medium px-3 py-1.5 rounded-full" style="color: #60a5fa; background: rgba(96, 165, 250, 0.15); border: 1px solid rgba(96, 165, 250, 0.3); cursor: pointer; margin-bottom: 1rem;">
                    <i class="fas fa-eye mr-1"></i> Voir actuel
                  </button>
                  <a href="#" id="modifier-carte-link" style="display: none;"></a>
                </div>
                <div id="dropzoneModifierCarte" class="upload-zone-small cursor-pointer" style="border-color: rgba(148, 163, 184, 0.3);">
                  <p style="color: #94a3b8;"><i class="fas fa-upload mr-1"></i> Remplacer le fichier</p>
                  <input type="file" id="modifierCarteAssurance" accept="image/*,.pdf" class="hidden">
                </div>
                <div id="previewModifierCarte" class="mt-2 hidden relative inline-block">
                  <a href="javascript:void(0)" class="file-preview-link">
                    <img class="h-12 rounded shadow" style="border: 2px solid #60a5fa;" />
                  </a>
                  <button type="button" onclick="removeModifierFilePreview('modifierCarteAssurance')" class="file-remove-btn" style="position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer; border: none;">
                    √ó
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Avertissement -->
        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: 1rem; margin-top: 1rem;">
          <div class="flex items-start gap-3">
            <i class="fas fa-exclamation-triangle" style="color: #f59e0b; margin-top: 2px;"></i>
            <div>
              <p class="text-sm font-medium" style="color: #f59e0b;">Attention</p>
              <p class="text-sm" style="color: rgba(245, 158, 11, 0.8);">Les modifications seront envoy√©es pour validation au coach et √† la direction. L'employ√© sera marqu√© "En attente de modification" jusqu'√† l'approbation.</p>
            </div>
          </div>
        </div>
      </form>

      <!-- Footer sticky -->
      <div class="flex justify-end space-x-3 p-6 pt-4" style="position: sticky; bottom: 0; background: #1a2332; z-index: 10; border-top: 1px solid var(--border-dark);">
        <button type="button" onclick="fermerModalModifier()" class="btn-secondary">
          Annuler
        </button>
        <button type="submit" form="formModifierEmploye" class="btn-primary">
          Enregistrer les modifications
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Validation Modification (pour coach) - Style Info avec champs modifi√©s en orange -->
  <div id="modalValidationModification" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none;">
    <div class="status-card w-full" style="max-width: 1100px; max-height: 85vh; display: flex; flex-direction: column;">
      <!-- Header sticky -->
      <div class="flex items-center justify-between p-6 pb-4" style="position: sticky; top: 0; background: #1a2332; z-index: 10; border-bottom: 1px solid var(--border-dark);">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user-edit mr-2" style="color: #f59e0b;"></i>
          V√©rifier les modifications
        </h3>
        <button onclick="fermerPopupValidationModification()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b;" onmouseover="this.style.background='rgba(245, 158, 11, 0.3)'" onmouseout="this.style.background='rgba(245, 158, 11, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Body scrollable avec grid 2 colonnes -->
      <div style="flex: 1; overflow-y: auto; padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <!-- Colonne gauche -->
          <div class="space-y-4">
            <!-- Section: Informations personnelles -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-user" style="color: #60a5fa;"></i>
                Informations personnelles
              </div>
              <div class="flex justify-between items-center py-2 validationModif-row" id="validationModif-nom-row" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm validationModif-label" style="color: rgba(148, 163, 184, 0.7) !important;">Nom complet</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validationModif-nom">-</span>
              </div>
              <div class="flex justify-between items-center py-2 validationModif-row" id="validationModif-genre-row" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm validationModif-label" style="color: rgba(148, 163, 184, 0.7) !important;">Genre</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validationModif-genre">-</span>
              </div>
              <div class="flex justify-between items-center py-2 validationModif-row" id="validationModif-nas-row">
                <span class="text-sm validationModif-label" style="color: rgba(148, 163, 184, 0.7) !important;">NAS</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validationModif-nas">-</span>
              </div>
            </div>

            <!-- Section: Contact -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-phone" style="color: #10b981;"></i>
                Contact
              </div>
              <div class="flex justify-between items-center py-2 validationModif-row" id="validationModif-courriel-row" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm validationModif-label" style="color: rgba(148, 163, 184, 0.7) !important;">Courriel</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validationModif-courriel">-</span>
              </div>
              <div class="flex justify-between items-center py-2 validationModif-row" id="validationModif-telephone-row">
                <span class="text-sm validationModif-label" style="color: rgba(148, 163, 184, 0.7) !important;">T√©l√©phone</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validationModif-telephone">-</span>
              </div>
            </div>
          </div>

          <!-- Colonne droite -->
          <div class="space-y-4">
            <!-- Section: Informations d'emploi -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-briefcase" style="color: #f59e0b;"></i>
                Informations d'emploi
              </div>
              <div class="flex justify-between items-center py-2 validationModif-row" id="validationModif-poste-row" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm validationModif-label" style="color: rgba(148, 163, 184, 0.7) !important;">Poste</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validationModif-poste">-</span>
              </div>
              <div class="flex justify-between items-center py-2 validationModif-row" id="validationModif-taux-row" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm validationModif-label" style="color: rgba(148, 163, 184, 0.7) !important;">Taux horaire</span>
                <span class="text-sm font-medium" style="color: #10b981;" id="validationModif-taux">-</span>
              </div>
              <div class="flex justify-between items-center py-2 validationModif-row" id="validationModif-date-row">
                <span class="text-sm validationModif-label" style="color: rgba(148, 163, 184, 0.7) !important;">Date premi√®re journ√©e</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validationModif-date">-</span>
              </div>
            </div>

            <!-- Section: Adresse d√©taill√©e -->
            <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem;">
              <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <i class="fas fa-map-marker-alt" style="color: #8b5cf6;"></i>
                Adresse d√©taill√©e
              </div>
              <div class="flex justify-between items-center py-2 validationModif-row" id="validationModif-adresseDetail-row" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm validationModif-label" style="color: rgba(148, 163, 184, 0.7) !important;">Adresse</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validationModif-adresseDetail">-</span>
              </div>
              <div class="flex justify-between items-center py-2 validationModif-row" id="validationModif-ville-row" style="border-bottom: 1px dashed rgba(148, 163, 184, 0.1);">
                <span class="text-sm validationModif-label" style="color: rgba(148, 163, 184, 0.7) !important;">Ville</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validationModif-ville">-</span>
              </div>
              <div class="flex justify-between items-center py-2 validationModif-row" id="validationModif-codePostal-row">
                <span class="text-sm validationModif-label" style="color: rgba(148, 163, 184, 0.7) !important;">Code postal</span>
                <span class="text-sm font-medium" style="color: #f1f5f9;" id="validationModif-codePostal">-</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Section: Documents (pleine largeur) -->
        <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 1rem 1.25rem; margin-top: 1rem;">
          <div class="flex items-center gap-2 text-sm font-semibold mb-3 pb-2" style="color: #94a3b8; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
            <i class="fas fa-file-alt" style="color: #ec4899;"></i>
            Documents
          </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
            <div class="flex flex-col items-center py-2 validationModif-row" id="validationModif-specimen-row">
              <span class="text-xs mb-2" style="color: rgba(148, 163, 184, 0.7);">Sp√©cimen ch√®que</span>
              <span id="validationModif-specimen" class="text-sm font-medium" style="color: #f1f5f9;">-</span>
            </div>
            <div class="flex flex-col items-center py-2 validationModif-row" id="validationModif-certificat-row">
              <span class="text-xs mb-2" style="color: rgba(148, 163, 184, 0.7);">Certificat s√©curit√©</span>
              <span id="validationModif-certificat" class="text-sm font-medium" style="color: #f1f5f9;">-</span>
            </div>
            <div class="flex flex-col items-center py-2 validationModif-row" id="validationModif-carte-row">
              <span class="text-xs mb-2" style="color: rgba(148, 163, 184, 0.7);">Carte assurance maladie</span>
              <span id="validationModif-carte" class="text-sm font-medium" style="color: #f1f5f9;">-</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer sticky -->
      <div class="flex justify-end space-x-3 p-6 pt-4" style="position: sticky; bottom: 0; background: #1a2332; z-index: 10; border-top: 1px solid var(--border-dark);">
        <button type="button" onclick="refuserModificationCoach()" class="btn-secondary">
          Refuser
        </button>
        <button type="button" id="btn-valider-modification" onclick="validerModificationCoach()" class="btn-primary">
          Valider
        </button>
      </div>
    </div>
  </div>

  <!-- Overlay pour le viewer de document -->
  <div id="documentViewerOverlay"></div>

  <!-- Modal viewer de document -->
  <div id="documentViewerModal" class="hidden">
    <button id="documentViewerClose" onclick="fermerDocumentViewer()">√ó</button>
    <div id="documentViewerContent"></div>
  </div>

  <!-- Modal Notification Coach - T√¢ches √† compl√©ter -->
  <div id="modalNotificationCoach" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: none;">
    <div class="status-card p-6 max-w-md w-full" style="max-height: 90vh; overflow-y: auto;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-bell mr-2" style="color: #3b82f6;"></i>
          Voici ce que vous devez compl√©ter
        </h3>
      </div>

      <div id="notif-actions-list" class="space-y-3 mb-6">
        <!-- Actions en attente seront ajout√©es dynamiquement ici -->
      </div>

      <button onclick="fermerModalNotificationCoach()" class="w-full px-4 py-3 rounded-lg font-semibold transition-all" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(59, 130, 246, 0.3)'">
        <i class="fas fa-check mr-2"></i>
        Compris
      </button>
    </div>
  </div>

  <!-- S√©lecteur d'entrepreneur (visible uniquement pour les coaches) -->
  <div id="coach-entrepreneur-selector">
    <!-- Titre de la page avec ic√¥ne Gestion Employ√©s -->
    <div class="page-identity">
      <div class="page-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3), 0 0 40px rgba(59, 130, 246, 0.15);">
        <i class="fas fa-users-cog"></i>
      </div>
      <div class="page-name" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #60a5fa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Gestion Employ√©s</div>
    </div>

    <!-- Titre et sous-titre (visibles uniquement en mode centr√©) -->
    <div class="selector-title">
      <i class="fas fa-user-tie"></i>
      S√©lectionnez un entrepreneur
    </div>
    <div class="selector-subtitle">Choisissez l'entrepreneur dont vous souhaitez g√©rer les employ√©s</div>

    <div class="selector-container">
      <div class="selector-label">
        <i class="fas fa-user-tie"></i>
        <span>Entrepreneur:</span>
      </div>
      <div class="coach-dropdown">
        <div class="coach-dropdown-toggle" id="coach-dropdown-toggle">
          <input type="text"
                 class="search-input"
                 id="search-input"
                 placeholder="Rechercher..."
                 autocomplete="off"
                 style="display: none;">
          <span class="placeholder">-- S√©lectionner un entrepreneur --</span>
          <i class="fas fa-chevron-down chevron"></i>
        </div>
        <div class="coach-dropdown-menu" id="coach-dropdown-menu">
          <!-- Options charg√©es dynamiquement -->
        </div>
      </div>
    </div>
  </div>

<!-- Contenu principal -->
<div class="main-content w-full" style="width: 100%; padding: 2rem;">
  <!-- Bouton Retour -->
  <div id="back-button-container">
    <button id="back-to-gestions-btn" onclick="goBackToGestions()" class="back-button">
      <i class="fas fa-arrow-left"></i>
      <span class="back-button-text">Retour √† gestions</span>
    </button>
  </div>

  <!-- Titre principal -->
  <div class="mb-10">
    <div class="relative">
      <h1 class="text-4xl font-bold mb-3" style="color: var(--text-light); overflow: hidden; text-overflow: ellipsis;">
        Gestion des employ√©s
      </h1>
      <span class="absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-blue-600 to-blue-400 rounded-full"></span>
      <div class="flex items-center justify-between">
        <p class="text-xl font-medium" style="color: var(--text-gray);">G√©rez vos employ√©s : nouveaux, actifs et inactifs</p>
        <div class="text-sm flex items-center" style="color: var(--text-gray);">
          <i class="fas fa-calendar-alt mr-2"></i>
          <span id="currentDate">Aujourd'hui</span>
        </div>
        </div>
      </div>
    </div>

  <!-- Gestion des employ√©s -->
  <div class="status-cards-grid grid grid-cols-1 gap-6 mb-8">
    <div class="box">
      <div class="box-header">
        <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
          <div class="box-header-icon" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);">
            <i class="fas fa-user-plus"></i>
          </div>
          <h2 class="box-header-title">Nouveaux employ√©s</h2>
          <span id="compteur-nouveaux" class="px-3 py-1 text-xs font-medium rounded-full" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue); border: 1px solid var(--primary-blue);">0 nouveau</span>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <button id="add-employee-btn" class="btn-primary px-6 py-2" onclick="ouvrirModalAjouterEmploye()">
            <span><i class="fas fa-plus mr-2"></i>Ajouter un employ√©</span>
          </button>
        </div>
      </div>
      <div class="box-body">
        
        <div class="table-container">
          <table class="modern-table nouveaux-employes">
            <thead>
              <tr>
                <th>Nom complet</th>
                <th>Courriel</th>
                <th>Poste</th>
                <th class="text-center" style="text-align: center !important;">Action</th>
                <th class="text-center" style="text-align: center !important;">Statut</th>
              </tr>
            </thead>
            <tbody class="nouveaux-employes-body">
              <!-- √âtat vide par d√©faut -->
              <tr class="empty-state-row">
                <td colspan="5" class="empty-state">
                  <i class="fas fa-user-plus" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
                  <p style="font-size: 1rem;">Aucun nouvel employ√©</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Vue Mobile: Cards pour Nouveaux employ√©s -->
        <div class="employes-mobile-cards">
          <div id="nouveaux-employes-mobile-list">
            <!-- Les cards seront inject√©es ici dynamiquement -->
            <div class="employes-empty-mobile">
              <i class="fas fa-user-plus"></i>
              <p>Aucun nouvel employ√©</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Fermeture box Nouveaux employ√©s -->

    <!-- Table 2: Employ√©s actifs -->
    <div class="box">
      <div class="box-header" style="flex-direction: column; align-items: stretch; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
          <div class="box-header-icon" style="background: linear-gradient(135deg, #34d399 0%, #10b981 100%);">
            <i class="fas fa-user-check"></i>
          </div>
          <h2 class="box-header-title">Employ√©s actifs</h2>
          <span id="compteur-actifs" class="px-3 py-1 text-xs font-medium rounded-full" style="background: rgba(52, 211, 153, 0.2); color: var(--primary-green); border: 1px solid var(--primary-green);">0 actif</span>
        </div>
      </div>
      <div class="box-body">
        
        <div class="table-container">
          <table class="modern-table employes-actifs">
            <thead>
              <tr>
                <th>Nom complet</th>
                <th>Courriel</th>
                <th>Poste</th>
                <th class="text-center" style="text-align: center !important;">Action</th>
                <th class="text-center" style="text-align: center !important;">Statut</th>
              </tr>
            </thead>
            <tbody class="employes-actifs-body">
              <!-- √âtat vide par d√©faut -->
              <tr class="empty-state-row">
                <td colspan="5" class="empty-state">
                  <i class="fas fa-user-check" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
                  <p style="font-size: 1rem;">Aucun employ√© actif</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Vue Mobile: Cards pour Employ√©s actifs -->
        <div class="employes-mobile-cards">
          <div id="employes-actifs-mobile-list">
            <!-- Les cards seront inject√©es ici dynamiquement -->
            <div class="employes-empty-mobile">
              <i class="fas fa-user-check"></i>
              <p>Aucun employ√© actif</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Fermeture box Employ√©s actifs -->

    <!-- Table 3: Employ√©s termin√©s -->
    <div class="box">
      <div class="box-header" style="flex-direction: column; align-items: stretch; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
          <div class="box-header-icon" style="background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);">
            <i class="fas fa-user-times"></i>
          </div>
          <h2 class="box-header-title">Employ√©s termin√©s</h2>
          <span id="compteur-termines" class="px-3 py-1 text-xs font-medium rounded-full" style="background: rgba(248, 113, 113, 0.2); color: var(--primary-red); border: 1px solid var(--primary-red);">0 termin√©</span>
        </div>
      </div>
      <div class="box-body">
        
        <div class="table-container">
          <table class="modern-table employes-termines">
            <thead>
              <tr>
                <th>Nom complet</th>
                <th>Courriel</th>
                <th>Poste</th>
                <th class="text-center" style="text-align: center !important;">Action</th>
                <th class="text-center" style="text-align: center !important;">Statut</th>
              </tr>
            </thead>
            <tbody class="employes-termines-body">
              <!-- √âtat vide par d√©faut -->
              <tr class="empty-state-row">
                <td colspan="5" class="empty-state">
                  <i class="fas fa-user-times" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
                  <p style="font-size: 1rem;">Aucun employ√© inactif</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Vue Mobile: Cards pour Employ√©s termin√©s -->
        <div class="employes-mobile-cards">
          <div id="employes-termines-mobile-list">
            <!-- Les cards seront inject√©es ici dynamiquement -->
            <div class="employes-empty-mobile">
              <i class="fas fa-user-times"></i>
              <p>Aucun employ√© inactif</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Fermeture box Employ√©s termin√©s -->
  </div>
  <!-- Fermeture de status-cards-grid -->
  </section>
  

<!-- Styles sp√©cifiques √† Gestion Employ√©s -->

  <!-- Script pour gestion menu actif -->
  <script>
    // Fonction pour activer le menu bas√© sur la page actuelle
    function activateCurrentPageMenu() {
      const currentPath = window.location.pathname;
      log('üåê Page actuelle d√©tect√©e:', currentPath);
      
      const allMenuLinks = document.querySelectorAll('#sidebar a');
      allMenuLinks.forEach(link => {
        link.classList.remove('menu-active');
        link.removeAttribute('data-menu-state');
      });
      
      const pageMap = {
        '/dashboard': '/dashboard',
        '/centralevue': '/centralevue', 
        '/calcul': '/calcul',
        '/soumissions': '/soumissions',
        '/gqp': '/gqp',
        '/travaux': '/travaux',
        '/facture': '/facture',
        '/gestionemployes': '/gestionemployes',
        '/rpo': '/RPO',
        '/newrpo': '/RPO',
        '/RPO': '/RPO',
        '/avis': '/avis',
        '/centrale': '/centrale',
        '/dashboardcoach': '/dashboardcoach'
      };
      
      const targetPath = pageMap[currentPath];
      let targetLink = null;
      
      if (targetPath) {
        targetLink = document.querySelector(`#sidebar a[data-path="${targetPath}"]`);
        log('[TARGET] Page d√©tect√©e - activation du menu pour:', targetPath);
      }
      
      if (targetLink) {
        targetLink.classList.add('menu-active');
        targetLink.setAttribute('data-menu-state', 'active');
        log('[OK] Menu activ√© pour:', targetLink.textContent.trim());
      } else {
        log('[WARN] Aucun menu trouv√© pour la page:', currentPath);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      activateCurrentPageMenu();
      setTimeout(activateCurrentPageMenu, 150);
      setTimeout(activateCurrentPageMenu, 300);
    });
  </script>

  <script>
    // Fonction iconaccount comme dans les autres fichiers
    const btn = document.getElementById("account-menu-button");
    const dropdown = document.getElementById("account-dropdown");
    const usernameDisplay = document.getElementById("account-username");

    if (btn && dropdown) {
      btn.addEventListener("click", () => {
          dropdown.classList.toggle("hidden");
      });

      window.addEventListener("click", (e) => {
          if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
              dropdown.classList.add("hidden");
          }
      });
    }

    if (window.username && usernameDisplay) {
        usernameDisplay.textContent = "Chargement...";
    }

    function initGenreDropdown() {
      const dropdown = document.getElementById('genre-dropdown');
      const menu = document.getElementById('genre-menu');
      const selectedSpan = document.getElementById('genre-selected');
      const hiddenInput = document.getElementById('genre');
      const options = menu.querySelectorAll('.dropdown-secondary-option');

      if (!dropdown || !menu || !selectedSpan || !hiddenInput) {
        error('√âl√©ments dropdown Genre introuvables');
        return;
      }

      // V√©rifier si d√©j√† initialis√© pour √©viter les event listeners multiples
      if (dropdown.dataset.initialized === 'true') {
        return;
      }
      dropdown.dataset.initialized = 'true';

      // Toggle menu on click
      dropdown.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('active');
        menu.classList.toggle('show');
      });

      // Select option
      options.forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const value = option.getAttribute('data-value');
          const text = option.textContent;

          // Update hidden input
          hiddenInput.value = value;

          // Update visual display
          selectedSpan.textContent = text;

          // Update selected state
          options.forEach(opt => opt.classList.remove('selected'));
          option.classList.add('selected');

          // Close menu
          dropdown.classList.remove('active');
          menu.classList.remove('show');
        });
      });

      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target) && !menu.contains(e.target)) {
          dropdown.classList.remove('active');
          menu.classList.remove('show');
        }
      });
    }

    // Initialiser le dropdown Genre pour le modal Modifier
    function initModifierGenreDropdown() {
      const dropdown = document.getElementById('modifierGenre-dropdown');
      const menu = document.getElementById('modifierGenre-menu');
      const selectedSpan = document.getElementById('modifierGenre-selected');
      const hiddenInput = document.getElementById('modifierGenre');
      const options = menu.querySelectorAll('.dropdown-secondary-option');

      if (!dropdown || !menu || !selectedSpan || !hiddenInput) {
        error('√âl√©ments dropdown Genre Modifier introuvables');
        return;
      }

      // V√©rifier si d√©j√† initialis√© pour √©viter les event listeners multiples
      if (dropdown.dataset.initialized === 'true') {
        return;
      }
      dropdown.dataset.initialized = 'true';

      // Toggle menu on click
      dropdown.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('active');
        menu.classList.toggle('show');
      });

      // Select option
      options.forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const value = option.getAttribute('data-value');
          const text = option.textContent;

          // Update hidden input
          hiddenInput.value = value;

          // Update visual display
          selectedSpan.textContent = text;

          // Update selected state
          options.forEach(opt => opt.classList.remove('selected'));
          option.classList.add('selected');

          // Close menu
          dropdown.classList.remove('active');
          menu.classList.remove('show');
        });
      });

      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target) && !menu.contains(e.target)) {
          dropdown.classList.remove('active');
          menu.classList.remove('show');
        }
      });
    }

    // Fonction pour formater automatiquement le num√©ro de t√©l√©phone en format 000-000-0000
    function formatTelephone(input) {
      // Supprimer tout ce qui n'est pas un chiffre
      let value = input.value.replace(/\D/g, '');

      // Limiter √† 10 chiffres
      value = value.substring(0, 10);

      // Formater avec des tirets
      if (value.length > 6) {
        value = value.substring(0, 3) + '-' + value.substring(3, 6) + '-' + value.substring(6);
      } else if (value.length > 3) {
        value = value.substring(0, 3) + '-' + value.substring(3);
      }

      input.value = value;
    }

    // Initialiser le formatage automatique du t√©l√©phone sur tous les champs t√©l√©phone
    function initTelephoneFormatting() {
      const telephoneInputs = document.querySelectorAll('input[type="tel"], input[id*="elephone"], input[name*="elephone"]');

      telephoneInputs.forEach(input => {
        input.addEventListener('input', function() {
          formatTelephone(this);
        });

        // Formater aussi au focus out pour s'assurer du format correct
        input.addEventListener('blur', function() {
          formatTelephone(this);
        });
      });
    }

    // Initialiser le calendrier pour le modal Modifier (utilise les m√™mes classes que CustomCalendar)
    function initModifierDateCalendar() {
      const input = document.getElementById('modifierDatePremiere');
      const calendar = document.getElementById('calendar-modifierDatePremiere');

      if (!input || !calendar) {
        error('√âl√©ments calendrier Modifier introuvables');
        return;
      }

      let currentDate = new Date();
      const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                         'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
      const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

      function renderCalendar(date) {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        // G√©n√©rer les en-t√™tes de jours
        const dayHeadersHTML = dayNames.map(day =>
          `<div class="calendar-day-header">${day}</div>`
        ).join('');

        // G√©n√©rer les jours du mois pr√©c√©dent
        let prevMonthDaysHTML = '';
        const prevMonth = new Date(year, month, 0);
        for (let i = firstDay - 1; i >= 0; i--) {
          const day = prevMonth.getDate() - i;
          prevMonthDaysHTML += `<div class="calendar-day other-month">${day}</div>`;
        }

        // G√©n√©rer les jours du mois actuel
        let currentMonthDaysHTML = '';
        for (let day = 1; day <= daysInMonth; day++) {
          const dateObj = new Date(year, month, day);
          let classes = 'calendar-day';

          // V√©rifier si c'est aujourd'hui
          if (dateObj.getDate() === today.getDate() &&
              dateObj.getMonth() === today.getMonth() &&
              dateObj.getFullYear() === today.getFullYear()) {
            classes += ' today';
          }

          currentMonthDaysHTML += `<div class="${classes}" data-day="${day}">${day}</div>`;
        }

        calendar.innerHTML = `
          <div class="calendar-header">
            <button type="button" class="calendar-nav-btn prev-btn">‚Äπ</button>
            <div class="calendar-month-year">${monthNames[month]} ${year}</div>
            <button type="button" class="calendar-nav-btn next-btn">‚Ä∫</button>
          </div>
          <div class="calendar-grid">
            ${dayHeadersHTML}
            ${prevMonthDaysHTML}
            ${currentMonthDaysHTML}
          </div>
        `;

        // Ajouter les event listeners
        calendar.querySelector('.prev-btn').addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          currentDate.setMonth(currentDate.getMonth() - 1);
          renderCalendar(currentDate);
        });

        calendar.querySelector('.next-btn').addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          currentDate.setMonth(currentDate.getMonth() + 1);
          renderCalendar(currentDate);
        });

        calendar.querySelectorAll('.calendar-day:not(.other-month)').forEach(dayEl => {
          dayEl.addEventListener('click', (e) => {
            e.stopPropagation();
            const selectedDay = parseInt(dayEl.dataset.day);
            const selectedDate = new Date(year, month, selectedDay);
            input.value = selectedDate.toLocaleDateString('fr-CA');
            calendar.classList.add('hidden');
            calendar.style.display = 'none';
          });
        });
      }

      input.addEventListener('click', (e) => {
        e.stopPropagation();
        if (calendar.classList.contains('hidden')) {
          calendar.classList.remove('hidden');
          calendar.style.setProperty('display', 'block', 'important');
          renderCalendar(currentDate);
        } else {
          calendar.classList.add('hidden');
          calendar.style.display = 'none';
        }
      });

      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !calendar.contains(e.target)) {
          calendar.classList.add('hidden');
          calendar.style.display = 'none';
        }
      });
    }

    function ouvrirModalAjouterEmploye() {
      document.getElementById('modalAjouterEmploye').classList.add('show');
      // Emp√™cher le scroll en arri√®re-plan
      document.body.style.overflow = 'hidden';
      // Initialiser les selects personnalis√©s apr√®s ouverture
      setTimeout(() => {
        initCustomSelects();
      }, 50);
    }
    
    function fermerModalAjouter() {
      document.getElementById('modalAjouterEmploye').classList.remove('show');
      document.getElementById('formAjouterEmploye').reset();
      // R√©activer le scroll en arri√®re-plan
      document.body.style.overflow = 'auto';
    }
    
    // Fonction pour r√©initialiser les pr√©visualisations de fichiers dans le modal d'activation
    function resetFilePreviewsActivation() {
      // Cacher toutes les pr√©visualisations
      const previewSpecimen = document.getElementById('previewSpecimen');
      const previewCertificat = document.getElementById('previewCertificat');
      const previewCarte = document.getElementById('previewCarte');

      if (previewSpecimen) {
        previewSpecimen.classList.add('hidden');
        const img = previewSpecimen.querySelector('img');
        if (img) img.src = '';
      }

      if (previewCertificat) {
        previewCertificat.classList.add('hidden');
        const img = previewCertificat.querySelector('img');
        if (img) img.src = '';
      }

      if (previewCarte) {
        previewCarte.classList.add('hidden');
        const img = previewCarte.querySelector('img');
        if (img) img.src = '';
      }

      // R√©initialiser les inputs de fichiers
      const inputSpecimen = document.getElementById('specimenCheque');
      const inputCertificat = document.getElementById('certificatSecurite');
      const inputCarte = document.getElementById('carteAssuranceMaladie');

      if (inputSpecimen) inputSpecimen.value = '';
      if (inputCertificat) inputCertificat.value = '';
      if (inputCarte) inputCarte.value = '';

      log('[RESET FILES] Pr√©visualisations de fichiers r√©initialis√©es');
    }

    function activerEmploye(employeId) {
      // Ouvrir le modal d'activation avec formulaire complet
      const modal = document.getElementById('modalActivation');
      if (!modal) {
        error('Modal modalActivation non trouv√©');
        return;
      }
      modal.style.display = 'flex';
      modal.classList.add('show');
      modal.dataset.employeId = employeId;
      // Emp√™cher le scroll en arri√®re-plan
      document.body.style.overflow = 'hidden';

      // IMPORTANT: R√©initialiser les pr√©visualisations de fichiers pour √©viter d'afficher les fichiers de l'employ√© pr√©c√©dent
      resetFilePreviewsActivation();

      // IMPORTANT: R√©initialiser le bouton "Activer l'employ√©" pour √©viter de garder le spinner
      const btnActiver = document.getElementById('btn-activer-employe');
      if (btnActiver) {
        btnActiver.disabled = false;
        btnActiver.style.opacity = '1';
        btnActiver.style.cursor = 'pointer';
        btnActiver.innerHTML = '<span>Activer l\'employ√©</span>';
      }

      // Initialiser les selects personnalis√©s et l'autocomplete apr√®s ouverture du modal
      setTimeout(() => {
        initCustomSelects();
        preRemplirActivation(employeId);

        // Initialiser le calendrier personnalis√© pour datePremiere (une seule fois)
        log('Initialisation du calendrier datePremiere');
        const inputElement = document.getElementById('datePremiere');
        const calendarElement = document.getElementById('calendar-datePremiere');
        log('Input trouv√©:', inputElement);
        log('Calendar element trouv√©:', calendarElement);

        if (inputElement && calendarElement && !calendarElement.dataset.initialized) {
          new CustomCalendar('datePremiere', 'calendar-datePremiere');
          calendarElement.dataset.initialized = 'true';
          log('Calendrier initialis√©');
        } else if (calendarElement && calendarElement.dataset.initialized) {
          log('Calendrier d√©j√† initialis√©');
        } else {
          error('√âl√©ments manquants pour le calendrier');
        }

        // Initialiser le dropdown Genre
        initGenreDropdown();

        // Initialiser les dropzones de fichiers
        initFileDropzones();

        // Initialiser le formatage automatique du t√©l√©phone
        initTelephoneFormatting();

        // Formatage simple taux horaire: point ‚Üí virgule et ajouter $
        const tauxHoraireInput = document.getElementById('tauxHoraire');
        if (tauxHoraireInput) {
          tauxHoraireInput.addEventListener('blur', function() {
            let value = this.value.trim();
            if (value) {
              // Enlever les $ et espaces pour traiter
              value = value.replace(/[\$\s]/g, '');
              // Remplacer point par virgule
              value = value.replace(/\./g, ',');
              // Si pas de virgule (pas de d√©cimales), ajouter ,00
              if (!value.includes(',')) {
                value = value + ',00';
              }
              // Ajouter $ √† la fin
              this.value = value + ' $';
            }
          });
        }

        // NAS: seulement 9 chiffres, rien d'autre
        const nasInput = document.getElementById('nas');
        if (nasInput) {
          nasInput.addEventListener('input', function() {
            // Garder seulement les chiffres, max 9
            this.value = this.value.replace(/\D/g, '').substring(0, 9);
          });
        }

        // Initialiser Google Places autocomplete si l'API est charg√©e
        if (googleMapsLoaded && typeof google !== 'undefined' && google.maps && google.maps.places) {
          setupAddressAutocomplete('adresse', 'ville', 'codePostal');
        }
      }, 100);
    }

    // Fonction pour afficher l'aper√ßu d'un fichier
    function showFilePreview(inputId, previewId) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      const file = input.files[0];

      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = preview.querySelector('img');
          const link = preview.querySelector('.file-preview-link');

          // Si c'est un PDF, afficher une ic√¥ne PDF
          if (file.type === 'application/pdf') {
            img.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDQ4IDQ4Ij48cGF0aCBmaWxsPSIjZTUzOTM1IiBkPSJNNDAgNDVINlY1aDI0bDEwIDEwdjMweiIvPjxwYXRoIGZpbGw9IiNmZmZmZmYiIGQ9Ik0yNiAxM2gtN3YyMmg3YzMuODYgMCA3LTMuMTQgNy03cy0zLjE0LTctNy03em0wIDE0aC0zVjE3aDNjMS42NSAwIDMgMS4zNSAzIDNzLTEuMzUgMy0zIDN6Ii8+PC9zdmc+';
          } else {
            // Sinon afficher l'image
            img.src = e.target.result;
          }

          // Ouvrir le fichier dans le modal au lieu d'un nouvel onglet
          link.href = 'javascript:void(0)';
          link.onclick = () => openFileModal(e.target.result);
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    }

    // Fonction pour supprimer l'aper√ßu d'un fichier
    function removeFilePreview(inputId) {
      const input = document.getElementById(inputId);

      // Mapper les IDs d'input vers les IDs de preview et dropzone
      const previewMap = {
        'specimenCheque': { preview: 'previewSpecimen', dropzone: 'dropzoneSpecimen' },
        'certificatSecurite': { preview: 'previewCertificat', dropzone: 'dropzoneCertificat' },
        'carteAssuranceMaladie': { preview: 'previewCarte', dropzone: 'dropzoneCarte' }
      };

      const config = previewMap[inputId];
      if (!config) return;

      const preview = document.getElementById(config.preview);
      const dropzone = document.getElementById(config.dropzone);

      // R√©initialiser l'input
      if (input) {
        input.value = '';
        delete input.dataset.existingFile;
      }

      // Cacher la preview
      if (preview) {
        preview.classList.add('hidden');
        const img = preview.querySelector('img');
        const link = preview.querySelector('.file-preview-link');
        if (img) img.src = '';
        if (link) link.href = '#';
      }

      // R√©afficher la dropzone
      if (dropzone) {
        dropzone.style.display = '';
      }
    }

    // Fonction pour r√©initialiser une dropzone (maintenant redirige vers removeFilePreview)
    function resetDropzone(type) {
      const inputMap = {
        'specimen': 'specimenCheque',
        'certificat': 'certificatSecurite',
        'carte': 'carteAssuranceMaladie'
      };

      const inputId = inputMap[type];
      if (inputId) {
        removeFilePreview(inputId);
      }
    }

    // Fonction pour initialiser les dropzones de fichiers
    let fileDropzonesInitialized = false;
    function initFileDropzones() {
      // √âviter d'ajouter plusieurs fois les event listeners
      if (fileDropzonesInitialized) return;
      fileDropzonesInitialized = true;

      // Sp√©cimen ch√®que
      const dropzoneSpecimen = document.getElementById('dropzoneSpecimen');
      const fileSpecimen = document.getElementById('specimenCheque');

      if (dropzoneSpecimen && fileSpecimen) {
        dropzoneSpecimen.addEventListener('click', () => fileSpecimen.click());
        fileSpecimen.addEventListener('change', (e) => {
          if (e.target.files && e.target.files[0]) {
            showFilePreview('specimenCheque', 'previewSpecimen');
          }
        });
      }

      // Certificat de s√©curit√©
      const dropzoneCertificat = document.getElementById('dropzoneCertificat');
      const fileCertificat = document.getElementById('certificatSecurite');

      if (dropzoneCertificat && fileCertificat) {
        dropzoneCertificat.addEventListener('click', () => fileCertificat.click());
        fileCertificat.addEventListener('change', (e) => {
          if (e.target.files && e.target.files[0]) {
            showFilePreview('certificatSecurite', 'previewCertificat');
          }
        });
      }

      // Carte d'assurance maladie
      const dropzoneCarte = document.getElementById('dropzoneCarte');
      const fileCarte = document.getElementById('carteAssuranceMaladie');

      if (dropzoneCarte && fileCarte) {
        dropzoneCarte.addEventListener('click', () => fileCarte.click());
        fileCarte.addEventListener('change', (e) => {
          if (e.target.files && e.target.files[0]) {
            showFilePreview('carteAssuranceMaladie', 'previewCarte');
          }
        });
      }
    }

    // Fonction pour initialiser les dropzones de fichiers pour r√©activation
    let reactiverDropzonesInitialized = false;
    function initReactiverFileDropzones() {
      // √âviter d'ajouter plusieurs fois les event listeners
      if (reactiverDropzonesInitialized) return;
      reactiverDropzonesInitialized = true;

      // Sp√©cimen ch√®que
      const dropzoneSpecimen = document.getElementById('dropzoneReactiverSpecimen');
      const fileSpecimen = document.getElementById('reactiverSpecimenCheque');

      if (dropzoneSpecimen && fileSpecimen) {
        dropzoneSpecimen.addEventListener('click', () => fileSpecimen.click());
        fileSpecimen.addEventListener('change', (e) => {
          if (e.target.files && e.target.files[0]) {
            showReactiverFilePreview('reactiverSpecimenCheque', 'previewReactiverSpecimen');
          }
        });
      }

      // Certificat de s√©curit√©
      const dropzoneCertificat = document.getElementById('dropzoneReactiverCertificat');
      const fileCertificat = document.getElementById('reactiverCertificatSecurite');

      if (dropzoneCertificat && fileCertificat) {
        dropzoneCertificat.addEventListener('click', () => fileCertificat.click());
        fileCertificat.addEventListener('change', (e) => {
          if (e.target.files && e.target.files[0]) {
            showReactiverFilePreview('reactiverCertificatSecurite', 'previewReactiverCertificat');
          }
        });
      }

      // Carte d'assurance maladie
      const dropzoneCarte = document.getElementById('dropzoneReactiverCarte');
      const fileCarte = document.getElementById('reactiverCarteAssurance');

      if (dropzoneCarte && fileCarte) {
        dropzoneCarte.addEventListener('click', () => fileCarte.click());
        fileCarte.addEventListener('change', (e) => {
          if (e.target.files && e.target.files[0]) {
            showReactiverFilePreview('reactiverCarteAssurance', 'previewReactiverCarte');
          }
        });
      }
    }

    function showReactiverFilePreview(inputId, previewId) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      const file = input.files[0];

      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = preview.querySelector('img');
          const link = preview.querySelector('.file-preview-link');

          if (file.type === 'application/pdf') {
            img.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDQ4IDQ4Ij48cGF0aCBmaWxsPSIjZTUzOTM1IiBkPSJNNDAgNDVINlY1aDI0bDEwIDEwdjMweiIvPjxwYXRoIGZpbGw9IiNmZmZmZmYiIGQ9Ik0yNiAxM2gtN3YyMmg3YzMuODYgMCA3LTMuMTQgNy03cy0zLjE0LTctNy03em0wIDE0aC0zVjE3aDNjMS42NSAwIDMgMS4zNSAzIDNzLTEuMzUgMy0zIDN6Ii8+PC9zdmc+';
          } else {
            img.src = e.target.result;
          }

          // Ouvrir le fichier dans le modal au lieu d'un nouvel onglet
          link.href = 'javascript:void(0)';
          link.onclick = () => openFileModal(e.target.result);
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    }

    function removeReactiverFilePreview(inputId) {
      const input = document.getElementById(inputId);

      const previewMap = {
        'reactiverSpecimenCheque': 'previewReactiverSpecimen',
        'reactiverCertificatSecurite': 'previewReactiverCertificat',
        'reactiverCarteAssurance': 'previewReactiverCarte'
      };

      const previewId = previewMap[inputId];
      const preview = document.getElementById(previewId);

      if (input) {
        input.value = '';
      }

      if (preview) {
        preview.classList.add('hidden');
        const img = preview.querySelector('img');
        if (img) img.src = '';
      }
    }

    // Fonction pour initialiser les dropzones de fichiers pour modification
    let modifierDropzonesInitialized = false;
    function initModifierFileDropzones() {
      // √âviter d'ajouter plusieurs fois les event listeners
      if (modifierDropzonesInitialized) return;
      modifierDropzonesInitialized = true;

      // Sp√©cimen ch√®que
      const dropzoneSpecimen = document.getElementById('dropzoneModifierSpecimen');
      const fileSpecimen = document.getElementById('modifierSpecimenCheque');

      if (dropzoneSpecimen && fileSpecimen) {
        dropzoneSpecimen.addEventListener('click', () => fileSpecimen.click());
        fileSpecimen.addEventListener('change', (e) => {
          if (e.target.files && e.target.files[0]) {
            showModifierFilePreview('modifierSpecimenCheque', 'previewModifierSpecimen');
          }
        });
      }

      // Certificat de s√©curit√©
      const dropzoneCertificat = document.getElementById('dropzoneModifierCertificat');
      const fileCertificat = document.getElementById('modifierCertificatSecurite');

      if (dropzoneCertificat && fileCertificat) {
        dropzoneCertificat.addEventListener('click', () => fileCertificat.click());
        fileCertificat.addEventListener('change', (e) => {
          if (e.target.files && e.target.files[0]) {
            showModifierFilePreview('modifierCertificatSecurite', 'previewModifierCertificat');
          }
        });
      }

      // Carte d'assurance maladie
      const dropzoneCarte = document.getElementById('dropzoneModifierCarte');
      const fileCarte = document.getElementById('modifierCarteAssurance');

      if (dropzoneCarte && fileCarte) {
        dropzoneCarte.addEventListener('click', () => fileCarte.click());
        fileCarte.addEventListener('change', (e) => {
          if (e.target.files && e.target.files[0]) {
            showModifierFilePreview('modifierCarteAssurance', 'previewModifierCarte');
          }
        });
      }
    }

    function showModifierFilePreview(inputId, previewId) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      const file = input.files[0];

      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = preview.querySelector('img');
          const link = preview.querySelector('.file-preview-link');

          if (file.type === 'application/pdf') {
            img.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDQ4IDQ4Ij48cGF0aCBmaWxsPSIjZTUzOTM1IiBkPSJNNDAgNDVINlY1aDI0bDEwIDEwdjMweiIvPjxwYXRoIGZpbGw9IiNmZmZmZmYiIGQ9Ik0yNiAxM2gtN3YyMmg3YzMuODYgMCA3LTMuMTQgNy03cy0zLjE0LTctNy03em0wIDE0aC0zVjE3aDNjMS42NSAwIDMgMS4zNSAzIDNzLTEuMzUgMy0zIDN6Ii8+PC9zdmc+';
          } else {
            img.src = e.target.result;
          }

          // Ouvrir le fichier dans le modal au lieu d'un nouvel onglet
          link.href = 'javascript:void(0)';
          link.onclick = () => openFileModal(e.target.result);
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    }

    function removeModifierFilePreview(inputId) {
      const input = document.getElementById(inputId);

      const previewMap = {
        'modifierSpecimenCheque': 'previewModifierSpecimen',
        'modifierCertificatSecurite': 'previewModifierCertificat',
        'modifierCarteAssurance': 'previewModifierCarte'
      };

      const previewId = previewMap[inputId];
      const preview = document.getElementById(previewId);

      if (input) {
        input.value = '';
      }

      if (preview) {
        preview.classList.add('hidden');
        const img = preview.querySelector('img');
        if (img) img.src = '';
      }
    }

    async function preRemplirActivation(employeId) {
      try {
        const username = window.selectedEntrepreneur || window.username || 'user';
        log('[preRemplirActivation] Chargement pour employeId:', employeId, 'username:', username);
        const response = await fetch(`/api/employes/${username}/nouveaux`);
        const data = await response.json();
        log('[preRemplirActivation] Donn√©es re√ßues:', data);

        // L'API peut retourner soit un tableau soit un objet avec une propri√©t√©
        const employes = Array.isArray(data) ? data : (data.nouveaux || data.employes || []);
        const employe = employes.find(e => e.id === employeId);
        log('[preRemplirActivation] Employ√© trouv√©:', employe);
        if (employe) {
          log('[preRemplirActivation] Donn√©es employ√© pour activation:', employe);

          // Champs de base
          document.getElementById('nomComplet').value = employe.nom || '';
          document.getElementById('telephone').value = employe.telephone || '';
          document.getElementById('courriel').value = employe.courriel || '';
          document.getElementById('posteService').value = employe.posteService || employe.poste || '';
          log('[preRemplirActivation] Champs de base remplis');

          // Champs suppl√©mentaires (pr√©remplir si existants - pour les refus/r√©essayer)
          if (employe.nas) document.getElementById('nas').value = employe.nas;
          if (employe.adresse) document.getElementById('adresse').value = employe.adresse;
          if (employe.appartement && employe.appartement !== '-') {
            const appartInput = document.getElementById('appartement');
            if (appartInput) appartInput.value = employe.appartement;
          }
          if (employe.ville) document.getElementById('ville').value = employe.ville;
          if (employe.codePostal) document.getElementById('codePostal').value = employe.codePostal;
          if (employe.datePremiere) document.getElementById('datePremiere').value = employe.datePremiere;
          if (employe.tauxHoraire) document.getElementById('tauxHoraire').value = employe.tauxHoraire;
          if (employe.dateNaissance) {
            const dateNaissanceInput = document.getElementById('dateNaissance');
            if (dateNaissanceInput) dateNaissanceInput.value = employe.dateNaissance;
          }

          log('Genre:', employe.genre, 'Poste:', employe.poste);

          // G√©rer le genre avec le nouveau dropdown-secondary
          setTimeout(() => {
            let genreValue = employe.genre || employe.sexe || '';

            // Normaliser la valeur pour correspondre aux options (en minuscule)
            if (genreValue) {
              genreValue = genreValue.toLowerCase();
            }

            if (genreValue) {
              const hiddenInput = document.getElementById('genre');
              const selectedSpan = document.getElementById('genre-selected');
              const menu = document.getElementById('genre-menu');

              if (hiddenInput && selectedSpan && menu) {
                // Mettre √† jour l'input cach√©
                hiddenInput.value = genreValue;

                // Mettre √† jour l'affichage visuel
                const displayValue = genreValue.charAt(0).toUpperCase() + genreValue.slice(1);
                selectedSpan.textContent = displayValue;

                // Marquer l'option correspondante comme s√©lectionn√©e
                const options = menu.querySelectorAll('.dropdown-secondary-option');
                options.forEach(option => {
                  option.classList.remove('selected');
                  if (option.getAttribute('data-value') === genreValue) {
                    option.classList.add('selected');
                  }
                });
              }
            }
          }, 150);

          // Afficher les documents existants (si d√©j√† upload√©s avant refus)
          setTimeout(() => {
            // Sp√©cimen de ch√®que
            if (employe.specimen || employe.specimenCheque) {
              const specimenInput = document.getElementById('specimenCheque');
              const specimenDropzone = document.getElementById('dropzoneSpecimen');
              const previewSpecimen = document.getElementById('previewSpecimen');
              const username = window.selectedEntrepreneur || window.username || 'user';
              const fileName = employe.specimen || employe.specimenCheque;
              const fileUrl = `/api/employes/${username}/documents/${employeId}/${fileName}`;

              if (specimenInput && specimenDropzone && previewSpecimen) {
                // Afficher la preview avec le style normal
                specimenDropzone.style.display = 'none';
                const img = previewSpecimen.querySelector('img');
                const link = previewSpecimen.querySelector('.file-preview-link');

                if (img && link) {
                  // Afficher ic√¥ne PDF ou image selon le type
                  if (fileName.toLowerCase().endsWith('.pdf')) {
                    img.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDQ4IDQ4Ij48cGF0aCBmaWxsPSIjZTUzOTM1IiBkPSJNNDAgNDVINlY1aDI0bDEwIDEwdjMweiIvPjxwYXRoIGZpbGw9IiNmZmZmZmYiIGQ9Ik0yNiAxM2gtN3YyMmg3YzMuODYgMCA3LTMuMTQgNy03cy0zLjE0LTctNy03em0wIDE0aC0zVjE3aDNjMS42NSAwIDMgMS4zNSAzIDNzLTEuMzUgMy0zIDN6Ci8+PC9zdmc+';
                  } else {
                    img.src = fileUrl;
                  }
                  link.href = 'javascript:void(0)';
                  link.onclick = () => openFileModal(fileUrl);
                  previewSpecimen.classList.remove('hidden');
                  // Marquer l'input comme ayant un fichier existant
                  specimenInput.dataset.existingFile = fileName;
                }
              }
            }

            // Certificat de s√©curit√©
            if (employe.certificat || employe.certificatSecurite) {
              const certificatInput = document.getElementById('certificatSecurite');
              const certificatDropzone = document.getElementById('dropzoneCertificat');
              const previewCertificat = document.getElementById('previewCertificat');
              const username = window.selectedEntrepreneur || window.username || 'user';
              const fileName = employe.certificat || employe.certificatSecurite;
              const fileUrl = `/api/employes/${username}/documents/${employeId}/${fileName}`;

              if (certificatInput && certificatDropzone && previewCertificat) {
                certificatDropzone.style.display = 'none';
                const img = previewCertificat.querySelector('img');
                const link = previewCertificat.querySelector('.file-preview-link');

                if (img && link) {
                  if (fileName.toLowerCase().endsWith('.pdf')) {
                    img.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDQ4IDQ4Ij48cGF0aCBmaWxsPSIjZTUzOTM1IiBkPSJNNDAgNDVINlY1aDI0bDEwIDEwdjMweiIvPjxwYXRoIGZpbGw9IiNmZmZmZmYiIGQ9Ik0yNiAxM2gtN3YyMmg3YzMuODYgMCA3LTMuMTQgNy03cy0zLjE0LTctNy03em0wIDE0aC0zVjE3aDNjMS42NSAwIDMgMS4zNSAzIDNzLTEuMzUgMy0zIDN6Ii8+PC9zdmc+';
                  } else {
                    img.src = fileUrl;
                  }
                  link.href = 'javascript:void(0)';
                  link.onclick = () => openFileModal(fileUrl);
                  previewCertificat.classList.remove('hidden');
                  certificatInput.dataset.existingFile = fileName;
                }
              }
            }

            // Carte d'assurance maladie
            if (employe.carte || employe.carteAssurance || employe.carteAssuranceMaladie) {
              const carteInput = document.getElementById('carteAssuranceMaladie');
              const carteDropzone = document.getElementById('dropzoneCarte');
              const previewCarte = document.getElementById('previewCarte');
              const username = window.selectedEntrepreneur || window.username || 'user';
              const fileName = employe.carte || employe.carteAssurance || employe.carteAssuranceMaladie;
              const fileUrl = `/api/employes/${username}/documents/${employeId}/${fileName}`;

              if (carteInput && carteDropzone && previewCarte) {
                carteDropzone.style.display = 'none';
                const img = previewCarte.querySelector('img');
                const link = previewCarte.querySelector('.file-preview-link');

                if (img && link) {
                  if (fileName.toLowerCase().endsWith('.pdf')) {
                    img.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDQ4IDQ4Ij48cGF0aCBmaWxsPSIjZTUzOTM1IiBkPSJNNDAgNDVINlY1aDI0bDEwIDEwdjMweiIvPjxwYXRoIGZpbGw9IiNmZmZmZmYiIGQ9Ik0yNiAxM2gtN3YyMmg3YzMuODYgMCA3LTMuMTQgNy03cy0zLjE0LTctNy03em0wIDE0aC0zVjE3aDNjMS42NSAwIDMgMS4zNSAzIDNzLTEuMzUgMy0zIDN6Ii8+PC9zdmc+';
                  } else {
                    img.src = fileUrl;
                  }
                  link.href = 'javascript:void(0)';
                  link.onclick = () => openFileModal(fileUrl);
                  previewCarte.classList.remove('hidden');
                  carteInput.dataset.existingFile = fileName;
                }
              }
            }
          }, 200);
        }
      } catch (err) {
        error('Erreur lors du pr√©-remplissage:', err);
      }
    }
    
    function fermerModal() {
      const modal = document.getElementById('modalActivation');
      if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
      }
      // R√©initialiser le formulaire
      document.getElementById('formActivation').reset();
      // R√©activer le scroll en arri√®re-plan
      document.body.style.overflow = '';

      // R√©initialiser l'affichage du fichier
      const fileNameDisplay = document.getElementById('fileName');
      if (fileNameDisplay) {
        fileNameDisplay.textContent = 'Aucun fichier s√©lectionn√©';
        fileNameDisplay.classList.remove('text-green-600');
        fileNameDisplay.classList.add('text-gray-600');
      }
    }

    // Afficher le popup de validation avec la liste des champs manquants
    window.afficherPopupValidation = function(champsManquants) {
      const popup = document.getElementById('popupValidationErreurs');
      const liste = document.getElementById('listeChampsManquants');

      if (popup && liste) {
        // Vider la liste
        liste.innerHTML = '';

        // Ajouter chaque champ manquant
        champsManquants.forEach(champ => {
          const li = document.createElement('li');
          li.innerHTML = `<i class="fas fa-exclamation-circle mr-2" style="color: #ef4444;"></i>${champ}`;
          li.style.cssText = 'padding: 0.5rem; background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; border-radius: 4px; font-size: 0.875rem;';
          liste.appendChild(li);
        });

        // Afficher le popup
        popup.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    };

    // Fermer le popup de validation
    window.fermerPopupValidationErreurs = function() {
      const popup = document.getElementById('popupValidationErreurs');
      if (popup) {
        popup.style.display = 'none';
        document.body.style.overflow = '';
      }
    };

    window.fermerPopupAucuneModification = function() {
      const popup = document.getElementById('popupAucuneModification');
      if (popup) {
        popup.style.display = 'none';
      }
    };

    // G√©rer la soumission du formulaire
    document.addEventListener('DOMContentLoaded', function() {
      const formActivation = document.getElementById('formActivation');
      if (formActivation) {
        formActivation.addEventListener('submit', function(e) {
          e.preventDefault();

          // Validation des champs requis avec noms lisibles
          const champsRequis = {
            'nomComplet': 'Nom complet',
            'telephone': 'T√©l√©phone',
            'courriel': 'Courriel',
            'posteService': 'Poste',
            'genre': 'Genre',
            'nas': 'NAS',
            'dateNaissance': 'Date de naissance',
            'adresse': 'Adresse',
            'ville': 'Ville',
            'codePostal': 'Code Postal',
            'datePremiere': 'Date premi√®re journ√©e',
            'tauxHoraire': 'Taux horaire',
            'specimenCheque': 'Sp√©cimen ch√®que',
            'certificatSecurite': 'Certificat s√©curit√©',
            'carteAssuranceMaladie': 'Carte assurance maladie'
          };

          let champsManquants = [];

          Object.keys(champsRequis).forEach(champId => {
            const element = document.getElementById(champId);
            if (element) {
              // Pour les fichiers, v√©rifier si un fichier est s√©lectionn√© OU si un fichier existant est pr√©sent
              if (element.type === 'file') {
                const hasNewFile = element.files && element.files.length > 0;
                const hasExistingFile = element.hasAttribute('data-existing-file') && element.getAttribute('data-existing-file');

                if (!hasNewFile && !hasExistingFile) {
                  element.style.borderColor = '#ef4444';
                  champsManquants.push(champsRequis[champId]);
                } else {
                  element.style.borderColor = '';
                }
              }
              // Pour le Genre, rejeter "Non sp√©cifi√©" ou vide
              else if (champId === 'genre') {
                const value = element.value.trim().toLowerCase();
                if (!value || value === '' || value === 'non sp√©cifi√©' || value === 's√©lectionner') {
                  element.style.borderColor = '#ef4444';
                  champsManquants.push(champsRequis[champId]);
                } else {
                  element.style.borderColor = '';
                }
              }
              // Pour les autres champs, v√©rifier la valeur
              else if (!element.value || !element.value.trim()) {
                element.style.borderColor = '#ef4444';
                champsManquants.push(champsRequis[champId]);
              } else {
                element.style.borderColor = '';
              }
            }
          });

          if (champsManquants.length === 0) {
            // Activer via l'API
            activerEmployeAPI();
          } else {
            // Afficher le popup avec la liste des champs manquants
            afficherPopupValidation(champsManquants);
          }
        });
      }

      // Fermer le modal en cliquant √† l'ext√©rieur
      const modalActivation = document.getElementById('modalActivation');
      if (modalActivation) {
        modalActivation.addEventListener('click', function(e) {
          if (e.target === this) {
            fermerModal();
          }
        });
      }
      
      // G√©rer la soumission du formulaire d'ajout
      const formAjouterEmploye = document.getElementById('formAjouterEmploye');
      if (formAjouterEmploye) {
        formAjouterEmploye.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validation des champs requis
        const champsRequis = ['nouveauNomComplet', 'nouveauGenre', 'nouveauCourriel', 'nouveauTelephone', 'nouveauPoste'];
        let valide = true;
        
        champsRequis.forEach(champ => {
          const element = document.getElementById(champ);
          if (!element.value.trim()) {
            element.style.borderColor = '#ef4444';
            valide = false;
          } else {
            element.style.borderColor = '#d1d5db';
          }
        });
        
        if (valide) {
          // Envoyer les donn√©es au serveur
          ajouterNouvelEmployeAPI();
        } else {
          log('Veuillez remplir tous les champs obligatoires.');
        }
      });

      // Fermer le modal d'ajout en cliquant √† l'ext√©rieur
      const modalAjouterEmploye = document.getElementById('modalAjouterEmploye');
      if (modalAjouterEmploye) {
        modalAjouterEmploye.addEventListener('click', function(e) {
          if (e.target === this) {
            fermerModalAjouter();
          }
        });
      }
      } // Fin du if (formAjouterEmploye)

      // Fermer le modal de confirmation refus en cliquant √† l'ext√©rieur
      const modalConfirmationRefus = document.getElementById('modalConfirmationRefus');
      if (modalConfirmationRefus) {
        modalConfirmationRefus.addEventListener('click', function(e) {
          if (e.target === this) {
            fermerModalRefus();
          }
        });
      }
      
      // G√©rer l'affichage du nom de fichier pour le sp√©cimen ch√®que
      const specimenInput = document.getElementById('specimenCheque');
      const fileNameDisplay = document.getElementById('fileName');
      
      if (specimenInput && fileNameDisplay) {
        specimenInput.addEventListener('change', function(e) {
          if (e.target.files.length > 0) {
            fileNameDisplay.textContent = e.target.files[0].name;
            fileNameDisplay.classList.remove('text-gray-600');
            fileNameDisplay.classList.add('text-green-600');
          } else {
            fileNameDisplay.textContent = 'Aucun fichier s√©lectionn√©';
            fileNameDisplay.classList.remove('text-green-600');
            fileNameDisplay.classList.add('text-gray-600');
          }
        });
      }
      
      // G√©rer l'affichage du nom de fichier pour la modification
      const modifierSpecimenInput = document.getElementById('modifierSpecimenCheque');
      const modifierFileNameDisplay = document.getElementById('modifierFileName');
      
      if (modifierSpecimenInput && modifierFileNameDisplay) {
        modifierSpecimenInput.addEventListener('change', function(e) {
          if (e.target.files.length > 0) {
            modifierFileNameDisplay.textContent = e.target.files[0].name;
            modifierFileNameDisplay.classList.remove('text-gray-600');
            modifierFileNameDisplay.classList.add('text-green-600');
          } else {
            modifierFileNameDisplay.textContent = 'Aucun nouveau fichier s√©lectionn√©';
            modifierFileNameDisplay.classList.remove('text-green-600');
            modifierFileNameDisplay.classList.add('text-gray-600');
          }
        });
      }
      
      // G√©rer la soumission du formulaire de modification
      const formModifierEmploye = document.getElementById('formModifierEmploye');
      if (formModifierEmploye) {
        formModifierEmploye.addEventListener('submit', async function(e) {
          e.preventDefault();

          // Validation des champs requis
          const champsRequis = ['modifierNomComplet', 'modifierNas', 'modifierDateNaissance', 'modifierGenre', 'modifierAdresse', 'modifierVille', 'modifierCodePostal', 'modifierTelephone', 'modifierCourriel', 'modifierDatePremiere', 'modifierPosteService', 'modifierTauxHoraire'];
          let valide = true;

          champsRequis.forEach(champ => {
            const element = document.getElementById(champ);
            if (!element.value.trim()) {
              element.style.borderColor = '#ef4444';
              valide = false;
            } else {
              element.style.borderColor = 'var(--border-dark)';
            }
          });

          if (valide) {
            // Pr√©parer les donn√©es modifi√©es pour l'API
            const tauxHoraireValue = document.getElementById('modifierTauxHoraire').value;
            // Nettoyer le taux horaire : remplacer "," par "." puis retirer "$" et espaces
            const tauxHoraireClean = parseFloat(tauxHoraireValue.replace(',', '.').replace(/[\$\s]/g, '')) || 0;

            // R√©cup√©rer les fichiers (optionnels)
            const specimenFile = document.getElementById('modifierSpecimenCheque').files[0];
            const certificatFile = document.getElementById('modifierCertificatSecurite').files[0];
            const carteFile = document.getElementById('modifierCarteAssurance').files[0];

            const employeModifie = {
              nom: document.getElementById('modifierNomComplet').value,
              nas: document.getElementById('modifierNas').value,
              dateNaissance: document.getElementById('modifierDateNaissance').value,
              genre: document.getElementById('modifierGenre').value,
              adresse: document.getElementById('modifierAdresse').value,
              appartement: document.getElementById('modifierAppartement').value || '',
              ville: document.getElementById('modifierVille').value,
              codePostal: document.getElementById('modifierCodePostal').value,
              telephone: document.getElementById('modifierTelephone').value,
              courriel: document.getElementById('modifierCourriel').value,
              datePremiere: document.getElementById('modifierDatePremiere').value,
              posteService: document.getElementById('modifierPosteService').value,
              tauxHoraire: tauxHoraireClean,
              statut: 'en_attente_modification' // Statut sp√©cial pour validation par coach/direction
            };

            // V√©rifier si des modifications ont √©t√© faites
            let modificationDetectee = false;

            if (employeDataOriginal) {
              console.log('Donn√©es originales:', employeDataOriginal);
              console.log('Donn√©es modifi√©es:', employeModifie);

              // Comparer chaque champ (insensible √† la casse)
              const champsAComparer = ['nom', 'nas', 'dateNaissance', 'genre', 'adresse', 'appartement', 'ville', 'codePostal', 'telephone', 'courriel', 'datePremiere', 'posteService'];

              for (const champ of champsAComparer) {
                const valeurOriginale = (employeDataOriginal[champ] || '').toString().trim().toLowerCase();
                const valeurActuelle = (employeModifie[champ] || '').toString().trim().toLowerCase();

                console.log(`Comparaison ${champ}: "${valeurOriginale}" vs "${valeurActuelle}"`);

                if (valeurOriginale !== valeurActuelle) {
                  console.log(`Modification d√©tect√©e sur le champ: ${champ}`);
                  modificationDetectee = true;
                  break;
                }
              }

              // Comparer le taux horaire (en float)
              if (!modificationDetectee) {
                const tauxOriginal = parseFloat(employeDataOriginal.tauxHoraire) || 0;
                console.log(`Comparaison taux horaire: ${tauxOriginal} vs ${tauxHoraireClean}`);
                if (Math.abs(tauxOriginal - tauxHoraireClean) > 0.01) {
                  console.log('Modification d√©tect√©e sur le taux horaire');
                  modificationDetectee = true;
                }
              }

              console.log('Modification d√©tect√©e:', modificationDetectee);
            }

            // V√©rifier si des fichiers ont √©t√© ajout√©s
            const fichiersAjoutes = !!(specimenFile || certificatFile || carteFile);

            // Si aucune modification et aucun fichier, afficher le popup
            if (!modificationDetectee && !fichiersAjoutes) {
              const popup = document.getElementById('popupAucuneModification');
              if (popup) {
                popup.style.display = 'flex';
              }
              return;
            }

            log('Donn√©es pr√©par√©es pour l\'API (en attente de modification):', employeModifie);

            // Appeler l'API pour sauvegarder les modifications avec statut en attente
            const modal = document.getElementById('modalModifierEmploye');
            const employeId = modal.dataset.employeId;

            try {
              await envoyerModificationPourValidation(employeId, employeModifie, specimenFile, certificatFile, carteFile);
              fermerModalModifier();

              // Afficher l'animation de succ√®s
              showSuccessAnimation('Modifications envoy√©es avec succ√®s!');

              // Notifier le parent (appqecoach) pour mettre √† jour le badge INSTANTAN√âMENT
              if (window.parent && window.parent !== window) {
                window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
              }

              // Attendre la fin de l'animation avant de recharger
              setTimeout(() => {
                chargerEmployes(); // Recharger la liste pour montrer le spinner

                // Recharger les badges du s√©lecteur d'entrepreneurs
                if (window.EntrepreneurSelector) {
                  window.EntrepreneurSelector.reload();
                }
              }, 2000);
            } catch (err) {
              console.error('Erreur lors de l\'envoi des modifications:', err);
              showNotification('Erreur lors de l\'envoi des modifications', 'error');
            }
          } else {
            showNotification('Veuillez remplir tous les champs obligatoires', 'error');
          }
        });
      }

      // Fermer le modal de modification en cliquant √† l'ext√©rieur
      const modalModifierEmploye = document.getElementById('modalModifierEmploye');
      if (modalModifierEmploye) {
        modalModifierEmploye.addEventListener('click', function(e) {
          if (e.target === this) {
            fermerModalModifier();
          }
        });
      }

      // Fermer le modal de fin d'emploi en cliquant √† l'ext√©rieur
      const modalFinEmploi = document.getElementById('modalFinEmploi');
      if (modalFinEmploi) {
        modalFinEmploi.addEventListener('click', function(e) {
          if (e.target === this) {
            fermerModalFinEmploi();
          }
        });
      }

      // Fermer le modal de d√©tails en cliquant √† l'ext√©rieur
      const modalDetailsEmploye = document.getElementById('modalDetailsEmploye');
      if (modalDetailsEmploye) {
        modalDetailsEmploye.addEventListener('click', function(e) {
          if (e.target === this) {
            fermerModalDetails();
          }
        });
      }

      // Fermer le modal de r√©activation en cliquant √† l'ext√©rieur
      const modalConfirmationReactiver = document.getElementById('modalConfirmationReactiver');
      if (modalConfirmationReactiver) {
        modalConfirmationReactiver.addEventListener('click', function(e) {
          if (e.target === this) {
            fermerModalReactiver();
          }
        });
      }

    });
    
    function ajouterEmployeATable(employe) {
      const tableBody = document.querySelector('.nouveaux-employes tbody');
      if (!tableBody) return;
      
      const nouvelleRow = document.createElement('tr');
      nouvelleRow.classList.add('hover:bg-gray-50');
      
      nouvelleRow.innerHTML = `
        <td class="px-6 py-4  text-sm font-medium " style="color: var(--text-light); overflow: hidden; text-overflow: ellipsis;" sticky-col">${employe.nom}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.genre}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.courriel}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.telephone}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.poste}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.dateCandidature}</td>
        <td class="px-6 py-4 ">
          <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 " style="color: var(--text-light); overflow: hidden; text-overflow: ellipsis;"">${employe.statut}</span>
        </td>
        <td class="px-6 py-4  text-sm font-medium space-x-2">
          <button class="btn-primary" onclick="activerEmploye('${employe.id}')">
            <i class="fas fa-check"></i> Activer
          </button>
          <button class="btn-primary" onclick="supprimerEmploye(this)">
            <i class="fas fa-times"></i> Refuser
          </button>
        </td>
      `;
      
      tableBody.appendChild(nouvelleRow);
    }
    
    function supprimerEmploye(button) {
      const employeRow = button.closest('tr');
      const nomEmploye = employeRow.querySelector('.sticky-col').textContent.trim();
      
      // Afficher le modal de confirmation personnalis√©
      document.getElementById('modalConfirmationRefus').classList.add('show');
      document.getElementById('nomEmployeRefus').textContent = nomEmploye;
      // Emp√™cher le scroll en arri√®re-plan
      document.body.style.overflow = 'hidden';
      
      // Stocker la r√©f√©rence de la ligne pour suppression
      document.getElementById('modalConfirmationRefus').dataset.employeRow = employeRow;
    }
    
    function confirmerRefus() {
      const modal = document.getElementById('modalConfirmationRefus');
      const employeRow = modal.dataset.employeRow;
      
      // Supprimer la ligne
      if (employeRow && employeRow.remove) {
        employeRow.remove();
      }
      
      // Fermer le modal
      fermerModalRefus();
    }
    
    function fermerModalRefus() {
      document.getElementById('modalConfirmationRefus').classList.remove('show');
      delete document.getElementById('modalConfirmationRefus').dataset.employeRow;
      // R√©activer le scroll en arri√®re-plan
      document.body.style.overflow = 'auto';
    }
    
    function modifierEmploye(employeId) {
      // Ouvrir le modal et stocker l'ID
      document.getElementById('modalModifierEmploye').style.display = 'flex';
      document.getElementById('modalModifierEmploye').dataset.employeId = employeId;
      // Emp√™cher le scroll en arri√®re-plan
      document.body.style.overflow = 'hidden';

      // Pr√©-remplir les donn√©es apr√®s ouverture du modal
      setTimeout(() => {
        preRemplirModification(employeId);

        // Initialiser le dropdown Genre pour le modal Modifier
        initModifierGenreDropdown();

        // Initialiser le calendrier pour la date
        initModifierDateCalendar();

        // Initialiser les dropzones pour les fichiers
        initModifierFileDropzones();

        // Initialiser Google Places autocomplete si l'API est charg√©e
        if (googleMapsLoaded && typeof google !== 'undefined' && google.maps && google.maps.places) {
          setupAddressAutocomplete('modifierAdresse', 'modifierVille', 'modifierCodePostal');
        }

        // Formatage simple taux horaire: point ‚Üí virgule et ajouter $
        const modifierTauxInput = document.getElementById('modifierTauxHoraire');
        if (modifierTauxInput) {
          modifierTauxInput.addEventListener('blur', function() {
            let value = this.value.trim();
            if (value) {
              value = value.replace(/[\$\s]/g, '');
              value = value.replace(/\./g, ',');
              if (!value.includes(',')) {
                value = value + ',00';
              }
              this.value = value + ' $';
            }
          });
        }

        // NAS: seulement 9 chiffres, rien d'autre
        const modifierNasInput = document.getElementById('modifierNas');
        if (modifierNasInput) {
          modifierNasInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').substring(0, 9);
          });
        }
      }, 100);
    }
    
    async function preRemplirModification(employeId) {
      try {
        const username = window.username || 'user';
        const response = await fetch(`/api/employes/${username}/actifs`);
        const data = await response.json();
        
        const employe = data.employes.find(e => e.id === employeId);
        if (employe) {
          log('Donn√©es employ√© pour modification:', employe);
          log('Propri√©t√©s genre disponibles:', {
            genre: employe.genre,
            sexe: employe.sexe,
            gender: employe.gender
          });

          // Sauvegarder les donn√©es originales pour comparaison
          // Normaliser l'appartement: traiter "-" comme vide
          const appartementOriginal = employe.appartement && employe.appartement !== '-' ? employe.appartement : '';

          employeDataOriginal = {
            nom: employe.nom,
            nas: employe.nas,
            dateNaissance: employe.dateNaissance,
            genre: employe.genre || employe.sexe,
            adresse: employe.adresse,
            appartement: appartementOriginal,
            ville: employe.ville,
            codePostal: employe.codePostal,
            telephone: employe.telephone,
            courriel: employe.courriel,
            datePremiere: employe.datePremiere,
            posteService: employe.posteService,
            tauxHoraire: employe.tauxHoraire
          };
          
          // Remplir tous les champs qui existent
          const fields = [
            { id: 'modifierNomComplet', value: employe.nom },
            { id: 'modifierNas', value: employe.nas },
            { id: 'modifierAdresse', value: employe.adresse },
            { id: 'modifierVille', value: employe.ville },
            { id: 'modifierCodePostal', value: employe.codePostal },
            { id: 'modifierAppartement', value: appartementOriginal },
            { id: 'modifierTelephone', value: employe.telephone },
            { id: 'modifierCourriel', value: employe.courriel },
            { id: 'modifierDatePremiere', value: employe.datePremiere },
            { id: 'modifierPosteService', value: employe.posteService },
            { id: 'modifierTauxHoraire', value: employe.tauxHoraire },
            { id: 'modifierDateNaissance', value: employe.dateNaissance }
          ];
          
          fields.forEach(field => {
            const element = document.getElementById(field.id);
            if (element && field.value) {
              element.value = field.value;
              log(`Rempli ${field.id}: ${field.value}`);

              // Formater le taux horaire imm√©diatement apr√®s remplissage
              if (field.id === 'modifierTauxHoraire') {
                let value = field.value.toString().replace(/[\$\s]/g, '');
                value = value.replace(/\./g, ',');
                if (!value.includes(',')) {
                  value = value + ',00';
                }
                element.value = value + ' $';
                log(`Taux horaire format√©: ${element.value}`);
              }
            }
          });

          // Documents - afficher le bouton "Voir actuel" si le document existe
          const specimenFile = employe.specimenCheque || employe.specimen;
          const certificatFile = employe.certificatSecurite || employe.certificat;
          const carteFile = employe.carteAssurance || employe.carte;

          if (specimenFile) {
            document.getElementById('modifier-specimen-preview').style.display = 'inline';
            document.getElementById('modifier-specimen-link').href = `/api/employes/${username}/documents/${employeId}/${specimenFile}`;
          } else {
            document.getElementById('modifier-specimen-preview').style.display = 'none';
          }

          if (certificatFile) {
            document.getElementById('modifier-certificat-preview').style.display = 'inline';
            document.getElementById('modifier-certificat-link').href = `/api/employes/${username}/documents/${employeId}/${certificatFile}`;
          } else {
            document.getElementById('modifier-certificat-preview').style.display = 'none';
          }

          if (carteFile) {
            document.getElementById('modifier-carte-preview').style.display = 'inline';
            document.getElementById('modifier-carte-link').href = `/api/employes/${username}/documents/${employeId}/${carteFile}`;
          } else {
            document.getElementById('modifier-carte-preview').style.display = 'none';
          }

          // G√©rer le genre (dropdown custom)
          setTimeout(() => {
            const hiddenInput = document.getElementById('modifierGenre');
            const selectedSpan = document.getElementById('modifierGenre-selected');
            const menu = document.getElementById('modifierGenre-menu');

            let genreValue = employe.genre || employe.sexe || '';

            // Normaliser la valeur (minuscule)
            if (genreValue) {
              genreValue = genreValue.toLowerCase();
            }

            log('Genre trouv√© dans les donn√©es:', genreValue);

            if (hiddenInput && selectedSpan && genreValue) {
              // Mettre √† jour l'input cach√©
              hiddenInput.value = genreValue;

              // Mettre √† jour l'affichage (premi√®re lettre en majuscule)
              const displayValue = genreValue.charAt(0).toUpperCase() + genreValue.slice(1);
              selectedSpan.textContent = displayValue;

              // Marquer l'option comme s√©lectionn√©e dans le menu
              if (menu) {
                const options = menu.querySelectorAll('.dropdown-secondary-option');
                log('Options custom trouv√©es:', options.length);
                options.forEach(option => {
                  option.classList.remove('selected');
                  const optionValue = option.textContent.trim().toLowerCase();
                  if (optionValue === genreValue) {
                    option.classList.add('selected');
                    log('Option marqu√©e comme s√©lectionn√©e:', option.textContent.trim());
                  }
                });
              }

              log(`Genre pr√©-rempli: ${displayValue}`);
            } else {
              log('Genre vide ou √©l√©ments dropdown non trouv√©s');
            }
          }, 400);
        }
      } catch (err) {
        error('Erreur lors du pr√©-remplissage de modification:', err);
      }
    }
    
    function fermerModalModifier() {
      document.getElementById('modalModifierEmploye').style.display = 'none';
      document.getElementById('formModifierEmploye').reset();
      delete document.getElementById('modalModifierEmploye').dataset.employeId;
      // R√©initialiser les previews des fichiers
      removeModifierFilePreview('modifierSpecimenCheque');
      removeModifierFilePreview('modifierCertificatSecurite');
      removeModifierFilePreview('modifierCarteAssurance');
      // R√©activer le scroll en arri√®re-plan
      document.body.style.overflow = 'auto';
    }
    
    let employeFinEmploiActuel = null;

    async function terminerEmploye(employeId) {
      try {
        const username = window.username || 'user';
        const response = await fetch(`/api/employes/${username}/actifs`);
        const data = await response.json();

        const employe = data.employes.find(e => e.id === employeId);
        if (employe) {
          employeFinEmploiActuel = employe;

          // Mettre √† jour le contenu du modal
          document.getElementById('finEmploiNom').textContent = employe.nom;
          document.getElementById('finEmploiPoste').textContent = employe.poste || employe.posteService?.split(' - ')[0] || 'N/A';

          // Afficher le modal
          document.getElementById('modalFinEmploi').style.display = 'flex';
          document.body.style.overflow = 'hidden';

          // Initialiser les selects personnalis√©s
          setTimeout(() => {
            initCustomSelects();
            // Ajouter l'event listener pour le changement de motif
            const motifSelect = document.getElementById('motifFinEmploi');
            motifSelect.addEventListener('change', onMotifFinEmploiChange);
          }, 50);
        } else {
          showNotification('Employ√© non trouv√©', 'error');
        }
      } catch (err) {
        error('Erreur lors du chargement de l\'employ√©:', error);
        showNotification('Erreur de connexion', 'error');
      }
    }

    async function confirmerFinEmploi() {
      if (!employeFinEmploiActuel) return;

      const motif = document.getElementById('motifFinEmploi').value;
      const dateFinEmploi = document.getElementById('dateFinEmploi').value;
      const justificatif = document.getElementById('justificatifFinEmploi').value;
      const justificatifLength = justificatif.trim().length;

      if (!motif) {
        showNotification('Veuillez s√©lectionner un motif de fin d\'emploi', 'error');
        return;
      }

      if (!dateFinEmploi) {
        showNotification('Veuillez s√©lectionner une date de fin d\'emploi', 'error');
        return;
      }

      // Validation du justificatif selon le motif
      if (motif.startsWith('Cong√©di√©') && justificatifLength < 150) {
        showNotification('Le justificatif doit contenir au moins 150 caract√®res pour un cong√©diement', 'error');
        return;
      }

      if (motif === 'D√©part volontaire' && justificatifLength < 75) {
        showNotification('Le justificatif doit contenir au moins 75 caract√®res pour un d√©part volontaire', 'error');
        return;
      }

      try {
        const username = window.username || 'user';
        const response = await fetch(`/api/employes/${username}/demander-inactivation/${employeFinEmploiActuel.id}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            motif: motif,
            dateFinEmploi: dateFinEmploi,
            justificatif: justificatif
          })
        });

        if (response.ok) {
          fermerModalFinEmploi();

          // Afficher l'animation de succ√®s
          showSuccessAnimation('Demande de fin d\'emploi envoy√©e avec succ√®s!');

          // Notifier le parent (appqecoach) pour mettre √† jour le badge INSTANTAN√âMENT
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
          }

          // Attendre la fin de l'animation avant de recharger
          setTimeout(() => {
            chargerEmployes();

            // Recharger les badges du s√©lecteur d'entrepreneurs
            if (window.EntrepreneurSelector) {
              window.EntrepreneurSelector.reload();
            }
          }, 2000);
        } else {
          const error = await response.json();
          showNotification(error.detail || 'Erreur lors de la demande', 'error');
        }
      } catch (err) {
        error('Erreur lors de la demande de fin d\'emploi:', error);
        showNotification('Erreur de connexion', 'error');
      }
    }

    function fermerModalFinEmploi() {
      document.getElementById('modalFinEmploi').style.display = 'none';
      document.getElementById('motifFinEmploi').value = '';
      document.getElementById('dateFinEmploi').value = '';
      document.getElementById('justificatifFinEmploi').value = '';
      document.getElementById('justificatifCounter').style.display = 'none';
      document.getElementById('justificatifRequis').style.display = 'none';

      // R√©initialiser le calendrier
      CustomCalendarGE.instances.forEach(instance => {
        if (instance.inputElement.id === 'dateFinEmploi') {
          instance.reset();
        }
      });

      employeFinEmploiActuel = null;
      document.body.style.overflow = 'auto';
    }

    function getMinCaracteresJustificatif(motif) {
      if (motif.startsWith('Cong√©di√©')) return 150;
      if (motif === 'D√©part volontaire') return 75;
      return 0;
    }

    function onMotifFinEmploiChange() {
      const motif = document.getElementById('motifFinEmploi').value;
      const minCaracteres = getMinCaracteresJustificatif(motif);

      if (minCaracteres > 0) {
        document.getElementById('justificatifCounter').style.display = 'block';
        document.getElementById('justificatifRequis').style.display = 'inline';
        document.getElementById('justificatifMin').textContent = minCaracteres;
        updateJustificatifCounter();
      } else {
        document.getElementById('justificatifCounter').style.display = 'none';
        document.getElementById('justificatifRequis').style.display = 'none';
      }
    }

    function updateJustificatifCounter() {
      const justificatif = document.getElementById('justificatifFinEmploi').value;
      const motif = document.getElementById('motifFinEmploi').value;
      const minCaracteres = getMinCaracteresJustificatif(motif);
      const actuel = justificatif.trim().length;

      const actuelSpan = document.getElementById('justificatifActuel');
      actuelSpan.textContent = actuel;

      if (actuel >= minCaracteres) {
        actuelSpan.style.color = '#10b981'; // Vert
      } else {
        actuelSpan.style.color = '#ef4444'; // Rouge
      }
    }
    
    function ajouterEmployeTermineATable(employe) {
      const tableBody = document.querySelector('.employes-termines tbody');
      if (!tableBody) return;
      
      const nouvelleRow = document.createElement('tr');
      nouvelleRow.classList.add('hover:bg-gray-50');
      
      nouvelleRow.innerHTML = `
        <td class="px-6 py-4  text-sm font-medium " style="color: var(--text-light); overflow: hidden; text-overflow: ellipsis;" sticky-col">${employe.nom}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.courriel}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.posteService.split(' - ')[0]}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.datePremiere}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.dateTermine}</td>
        <td class="px-6 py-4 ">
          <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 " style="color: var(--text-light); overflow: hidden; text-overflow: ellipsis;"">${employe.motifTermine}</span>
        </td>
        <td class="px-6 py-4  text-sm font-medium space-x-2">
          <button class="btn-primary" onclick="voirDetailsEmploye('${employe.id}')">
            <i class="fas fa-eye"></i> Voir d√©tails
          </button>
          <button class="btn-primary" onclick="reactiverEmploye('${employe.id}')">
            <i class="fas fa-undo"></i> R√©activer
          </button>
        </td>
      `;
      
      tableBody.appendChild(nouvelleRow);
    }
    
    async function voirDetailsEmploye(employeId) {
      try {
        const username = window.username || 'user';
        const response = await fetch(`/api/employes/${username}/termines`);
        const data = await response.json();

        const employe = data.employes.find(e => e.id === employeId);
        if (employe) {
          log('Donn√©es employ√© termin√© pour d√©tails:', employe);

          // Afficher le modal
          const modal = document.getElementById('modalDetailsEmployeTermine');
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';

          // Section Fin d'emploi
          const dateTermine = employe.dateTermine || employe.date_inactivation || employe.date_fin_emploi || '-';
          const motifTermine = employe.motifTermine || employe.motif_fin_emploi || employe.motif_inactivation || 'Non sp√©cifi√©';
          const justificatifTermine = employe.justificatif || employe.justificatif_inactivation || (employe.motif_fin_emploi ? 'Fin d\'emploi par la comptabilit√©' : 'Aucun justificatif fourni');

          document.getElementById('termineDetailsDateFin').textContent = dateTermine;
          document.getElementById('termineDetailsMotif').textContent = motifTermine;
          document.getElementById('termineDetailsJustificatif').textContent = justificatifTermine;

          // Informations personnelles
          document.getElementById('termineDetailsNom').textContent = employe.nom || '-';
          document.getElementById('termineDetailsGenre').textContent = employe.genre || '-';
          document.getElementById('termineDetailsNas').textContent = employe.nas || '-';
          document.getElementById('termineDetailsDateNaissance').textContent = employe.dateNaissance || '-';

          // Contact
          document.getElementById('termineDetailsCourriel').textContent = employe.courriel || '-';
          document.getElementById('termineDetailsTelephone').textContent = employe.telephone || '-';
          const adresseComplete = [employe.adresse, employe.ville, employe.codePostal].filter(Boolean).join(', ') || '-';
          document.getElementById('termineDetailsAdresseComplete').textContent = adresseComplete;

          // Informations d'emploi
          const poste = employe.posteService ? employe.posteService.split(' - ')[0] : (employe.poste || '-');
          document.getElementById('termineDetailsPoste').textContent = poste;
          // Charger le d√©partement depuis le user_info de l'entrepreneur
          fetch('/api/get-info/' + localStorage.getItem('username'))
            .then(r => r.json())
            .then(userInfo => {
              const dept = userInfo?.data?.department || '0';
              document.getElementById('termineDetailsDepartement').textContent = dept;
            })
            .catch(() => {
              document.getElementById('termineDetailsDepartement').textContent = '0';
            });
          document.getElementById('termineDetailsTauxHoraire').textContent = employe.tauxHoraire ? `${employe.tauxHoraire} $/h` : '-';
          document.getElementById('termineDetailsDateDebut').textContent = employe.datePremiere || employe.dateActivation || '-';

          // Adresse d√©taill√©e
          document.getElementById('termineDetailsAdresse').textContent = employe.adresse || '-';
          document.getElementById('termineDetailsVille').textContent = employe.ville || '-';
          document.getElementById('termineDetailsCodePostal').textContent = employe.codePostal || '-';

          // Documents
          const specimenFile = employe.specimenCheque || employe.specimen;
          const certificatFile = employe.certificatSecurite || employe.certificat;
          const carteFile = employe.carteAssurance || employe.carte;

          if (specimenFile) {
            document.getElementById('termine-specimen-preview').style.display = 'inline';
            document.getElementById('termine-specimen-link').href = `/api/employes/${username}/documents/${employeId}/${specimenFile}`;
            document.getElementById('termine-specimen-none').style.display = 'none';
          } else {
            document.getElementById('termine-specimen-preview').style.display = 'none';
            document.getElementById('termine-specimen-none').style.display = 'inline';
          }

          if (certificatFile) {
            document.getElementById('termine-certificat-preview').style.display = 'inline';
            document.getElementById('termine-certificat-link').href = `/api/employes/${username}/documents/${employeId}/${certificatFile}`;
            document.getElementById('termine-certificat-none').style.display = 'none';
          } else {
            document.getElementById('termine-certificat-preview').style.display = 'none';
            document.getElementById('termine-certificat-none').style.display = 'inline';
          }

          if (carteFile) {
            document.getElementById('termine-carte-preview').style.display = 'inline';
            document.getElementById('termine-carte-link').href = `/api/employes/${username}/documents/${employeId}/${carteFile}`;
            document.getElementById('termine-carte-none').style.display = 'none';
          } else {
            document.getElementById('termine-carte-preview').style.display = 'none';
            document.getElementById('termine-carte-none').style.display = 'inline';
          }
        } else {
          error('Employ√© termin√© non trouv√© avec ID:', employeId);
          showNotification('Employ√© non trouv√©', 'error');
        }
      } catch (err) {
        error('Erreur lors du chargement des d√©tails employ√© termin√©:', err);
        showNotification('Erreur lors du chargement des d√©tails', 'error');
      }
    }
    
    function fermerModalDetails() {
      document.getElementById('modalDetailsEmploye').style.display = 'none';
      // R√©activer le scroll en arri√®re-plan
      document.body.style.overflow = 'auto';
    }
    
    function fermerModalDetailsTermine() {
      document.getElementById('modalDetailsEmployeTermine').style.display = 'none';
      // R√©activer le scroll en arri√®re-plan
      document.body.style.overflow = 'auto';
    }
    
    // Fonction pour sauvegarder les modifications d'un employ√© via l'API
    async function sauvegarderModificationEmploye(employeId, employeData) {
      try {
        const username = window.username || 'user';
        const response = await fetch(`/api/employes/${username}/modifier/${employeId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(employeData)
        });
        
        if (response.ok) {
          const result = await response.json();
          log('Modification sauvegard√©e:', result.message);
          // Recharger les donn√©es pour s'assurer que tout est synchronis√©
          chargerEmployes();
        } else {
          const error = await response.json();
          error('Erreur lors de la sauvegarde:', error);
          error('Status:', response.status);
          error('Response compl√®te:', error);
          showNotification(`Erreur lors de la sauvegarde: ${error.detail || JSON.stringify(error)}`, 'error');
        }
      } catch (err) {
        error('Erreur r√©seau lors de la sauvegarde:', err);
        showNotification('Erreur de connexion lors de la sauvegarde', 'error');
      }
    }

    // Fonction pour envoyer les modifications pour validation (statut en_attente_modification)
    async function envoyerModificationPourValidation(employeId, employeData, specimenFile, certificatFile, carteFile) {
      const username = window.username || 'user';

      const formData = new FormData();

      // Nettoyer le taux horaire (enlever $, espaces, et convertir virgule en point)
      let tauxHoraireClean = employeData.tauxHoraire || '';
      if (tauxHoraireClean) {
        tauxHoraireClean = tauxHoraireClean.toString().replace(/[\$\s]/g, '').replace(',', '.');
      }

      // Ajouter tous les champs de donn√©es
      formData.append('nom', employeData.nom);
      formData.append('nas', employeData.nas);
      formData.append('dateNaissance', employeData.dateNaissance);
      formData.append('genre', employeData.genre);
      formData.append('adresse', employeData.adresse);
      formData.append('appartement', employeData.appartement || '');
      formData.append('ville', employeData.ville);
      formData.append('codePostal', employeData.codePostal);
      formData.append('telephone', employeData.telephone);
      formData.append('courriel', employeData.courriel);
      formData.append('datePremiere', employeData.datePremiere);
      formData.append('posteService', employeData.posteService);
      formData.append('tauxHoraire', tauxHoraireClean);

      // Ajouter les fichiers s'ils sont fournis
      if (specimenFile) {
        formData.append('specimenCheque', specimenFile);
      }
      if (certificatFile) {
        formData.append('certificatSecurite', certificatFile);
      }
      if (carteFile) {
        formData.append('carteAssurance', carteFile);
      }

      const response = await fetch(`/api/employes/${username}/demande-modification/${employeId}`, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        let errorMessage = 'Erreur lors de l\'envoi des modifications';
        try {
          const error = await response.json();
          console.error('Erreur serveur compl√®te:', error);

          // Si detail est un tableau, afficher tous les messages
          if (Array.isArray(error.detail)) {
            errorMessage = error.detail.map(e => {
              if (typeof e === 'string') return e;
              if (e.msg) return `${e.loc ? e.loc.join('.') + ': ' : ''}${e.msg}`;
              return JSON.stringify(e);
            }).join(', ');
          } else {
            errorMessage = error.detail || error.message || errorMessage;
          }

          console.error('Message d\'erreur:', errorMessage);
        } catch (e) {
          console.error('Impossible de parser l\'erreur serveur');
        }
        throw new Error(errorMessage);
      }

      return await response.json();
    }

    // Variable pour stocker l'ID de l'employ√© en cours de validation de modification
    let employeModificationEnCours = null;

    // Variable pour stocker les donn√©es originales de l'employ√© en modification
    let employeDataOriginal = null;

    // Fonction pour ouvrir le popup de validation des modifications (coach)
    function ouvrirPopupValidationModification(employeId, employe) {
      employeModificationEnCours = employeId;

      const modal = document.getElementById('modalValidationModification');
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';

      // R√©cup√©rer les anciennes et nouvelles donn√©es (stock√©es par le backend)
      const anciennes = employe.anciennes_donnees || {};
      const nouvelles = employe.nouvelles_donnees || {};

      // Fonction helper pour comparer et marquer les champs modifi√©s
      function remplirEtMarquerSiModifie(elementId, rowId, valeurNouvelle, valeurAncienne) {
        const element = document.getElementById(elementId);
        const row = document.getElementById(rowId);

        if (element) {
          element.textContent = valeurNouvelle || '-';
        }

        if (row) {
          // Retirer la classe modifie d'abord (reset)
          row.classList.remove('modifie');

          // Normaliser les valeurs pour comparaison
          const nouv = (valeurNouvelle || '').toString().trim().toLowerCase();
          const anc = (valeurAncienne || '').toString().trim().toLowerCase();

          // Si les valeurs sont diff√©rentes
          if (nouv !== anc) {
            row.classList.add('modifie');
          }
        }
      }

      // Remplir les informations avec les NOUVELLES donn√©es et comparer avec les anciennes
      remplirEtMarquerSiModifie('validationModif-nom', 'validationModif-nom-row', nouvelles.nom, anciennes.nom);
      remplirEtMarquerSiModifie('validationModif-genre', 'validationModif-genre-row', nouvelles.genre, anciennes.genre);
      remplirEtMarquerSiModifie('validationModif-nas', 'validationModif-nas-row', nouvelles.nas, anciennes.nas);
      remplirEtMarquerSiModifie('validationModif-courriel', 'validationModif-courriel-row', nouvelles.courriel, anciennes.courriel);
      remplirEtMarquerSiModifie('validationModif-telephone', 'validationModif-telephone-row', nouvelles.telephone, anciennes.telephone);

      // D√©tails emploi
      remplirEtMarquerSiModifie('validationModif-poste', 'validationModif-poste-row', nouvelles.posteService, anciennes.posteService);

      // Taux horaire format√©
      const tauxHoraire = nouvelles.tauxHoraire || '';
      let tauxHoraireFormate = '-';
      if (tauxHoraire) {
        const numero = parseFloat(tauxHoraire);
        tauxHoraireFormate = numero.toFixed(2);
      }
      // Comparer les taux bruts (sans formatage) pour d√©tecter les modifications
      remplirEtMarquerSiModifie('validationModif-taux', 'validationModif-taux-row', tauxHoraireFormate, anciennes.tauxHoraire ? parseFloat(anciennes.tauxHoraire).toFixed(2) : '');

      remplirEtMarquerSiModifie('validationModif-date', 'validationModif-date-row', nouvelles.datePremiere, anciennes.datePremiere);

      // Adresse d√©taill√©e
      remplirEtMarquerSiModifie('validationModif-adresseDetail', 'validationModif-adresseDetail-row', nouvelles.adresse, anciennes.adresse);
      remplirEtMarquerSiModifie('validationModif-ville', 'validationModif-ville-row', nouvelles.ville, anciennes.ville);
      remplirEtMarquerSiModifie('validationModif-codePostal', 'validationModif-codePostal-row', nouvelles.codePostal, anciennes.codePostal);

      // Documents - fonction helper pour cr√©er les liens cliquables
      function remplirDocument(elementId, rowId, nouveauDoc, ancienDoc) {
        const element = document.getElementById(elementId);
        const row = document.getElementById(rowId);

        if (element) {
          if (nouveauDoc) {
            element.innerHTML = `<a href="#" onclick="openFileModal('/api/employes/${window.username || 'user'}/documents/${employeId}/${nouveauDoc}'); return false;" class="flex items-center gap-2 text-xs px-3 py-1.5 rounded-full transition-all" style="background: rgba(96, 165, 250, 0.15); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3);" onmouseover="this.style.background='rgba(96, 165, 250, 0.25)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.15)'"><i class="fas fa-eye"></i> Voir</a>`;
          } else {
            element.innerHTML = '<span style="color: rgba(148, 163, 184, 0.5);">Aucun</span>';
          }
        }

        if (row) {
          row.classList.remove('modifie');
          const nouv = (nouveauDoc || '').toString().trim();
          const anc = (ancienDoc || '').toString().trim();
          if (nouv !== anc && nouv) {
            row.classList.add('modifie');
          }
        }
      }

      // Utiliser les documents depuis nouvelles_donnees, ou sinon depuis l'employ√© actuel
      const specimenDoc = nouvelles.specimenCheque || employe.specimenCheque || anciennes.specimenCheque;
      const certificatDoc = nouvelles.certificatSecurite || employe.certificatSecurite || anciennes.certificatSecurite;
      const carteDoc = nouvelles.carteAssurance || employe.carteAssurance || anciennes.carteAssurance;

      remplirDocument('validationModif-specimen', 'validationModif-specimen-row', specimenDoc, anciennes.specimenCheque);
      remplirDocument('validationModif-certificat', 'validationModif-certificat-row', certificatDoc, anciennes.certificatSecurite);
      remplirDocument('validationModif-carte', 'validationModif-carte-row', carteDoc, anciennes.carteAssurance);
    }

    // Fonction pour fermer le popup de validation des modifications
    function fermerPopupValidationModification() {
      document.getElementById('modalValidationModification').style.display = 'none';
      document.body.style.overflow = 'auto';
      employeModificationEnCours = null;
    }

    // Fonction pour valider les modifications (coach)
    async function validerModificationCoach() {
      if (!employeModificationEnCours) return;

      const btn = document.getElementById('btn-valider-modification');
      const originalHtml = showButtonSpinner(btn);

      try {
        const username = window.username || 'user';
        const response = await fetch(`/api/employes/${username}/valider-modification/${employeModificationEnCours}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        if (response.ok) {
          fermerPopupValidationModification();

          // Afficher l'animation de succ√®s
          showSuccessAnimation('Modifications valid√©es avec succ√®s!');

          // Attendre la fin de l'animation avant de recharger
          setTimeout(() => {
            chargerEmployes();

            // Recharger les badges du s√©lecteur d'entrepreneurs
            if (window.EntrepreneurSelector) {
              window.EntrepreneurSelector.reload();
            }

            // Notifier le parent pour mettre √† jour le badge
            window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
          }, 2000);
        } else {
          hideButtonSpinner(btn, originalHtml);
          const error = await response.json();
          showNotification(error.detail || 'Erreur lors de la validation', 'error');
        }
      } catch (err) {
        hideButtonSpinner(btn, originalHtml);
        error('Erreur lors de la validation:', err);
        showNotification('Erreur de connexion', 'error');
      }
    }

    // Fonction pour refuser les modifications (coach)
    async function refuserModificationCoach() {
      if (!employeModificationEnCours) return;

      try {
        const username = window.username || 'user';
        const response = await fetch(`/api/employes/${username}/refuser-modification/${employeModificationEnCours}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        if (response.ok) {
          fermerPopupValidationModification();

          // Afficher l'animation de succ√®s
          showSuccessAnimation('Modifications refus√©es avec succ√®s!');

          // Attendre la fin de l'animation avant de recharger
          setTimeout(() => {
            chargerEmployes();

            // Recharger les badges du s√©lecteur d'entrepreneurs
            if (window.EntrepreneurSelector) {
              window.EntrepreneurSelector.reload();
            }

            // Notifier le parent pour mettre √† jour le badge
            window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
          }, 2000);
        } else {
          const error = await response.json();
          showNotification(error.detail || 'Erreur lors du refus', 'error');
        }
      } catch (err) {
        error('Erreur lors du refus:', err);
        showNotification('Erreur de connexion', 'error');
      }
    }

    async function voirInfoEmploye(employeId) {
      try {
        const username = window.username || 'user';
        const response = await fetch(`/api/employes/${username}/actifs`);
        const data = await response.json();

        const employe = data.employes.find(e => e.id === employeId);
        if (employe) {
          log('Donn√©es employ√© actif pour info:', employe);
          // Afficher les d√©tails dans le modal
          const modal = document.getElementById('modalDetailsEmploye');
          modal.style.display = 'flex';
          // Emp√™cher le scroll en arri√®re-plan
          document.body.style.overflow = 'hidden';

          // Informations personnelles
          document.getElementById('detailsNom').textContent = employe.nom || '-';
          document.getElementById('detailsNas').textContent = employe.nas || '-';
          document.getElementById('detailsGenre').textContent = employe.genre || '-';
          document.getElementById('detailsDateNaissance').textContent = employe.dateNaissance || '-';

          // Adresse d√©taill√©e
          document.getElementById('detailsAdresse').textContent = employe.adresse || '-';
          document.getElementById('detailsVille').textContent = employe.ville || '-';
          document.getElementById('detailsCodePostal').textContent = employe.codePostal || '-';

          // Adresse compl√®te pour la section Contact
          const adresseParts = [employe.adresse, employe.ville, employe.codePostal].filter(p => p);
          document.getElementById('detailsAdresseComplete').textContent = adresseParts.join(', ') || '-';

          // Informations de contact
          document.getElementById('detailsTelephone').textContent = employe.telephone || '-';
          document.getElementById('detailsCourriel').textContent = employe.courriel || '-';

          // Informations d'emploi
          document.getElementById('detailsDateDebut').textContent = employe.datePremiere || '-';
          document.getElementById('detailsPoste').textContent = employe.posteService || '-';
          // Charger le d√©partement depuis le user_info de l'entrepreneur
          fetch('/api/get-info/' + localStorage.getItem('username'))
            .then(r => r.json())
            .then(userInfo => {
              const dept = userInfo?.data?.department || '0';
              document.getElementById('detailsDepartement').textContent = dept;
            })
            .catch(() => {
              document.getElementById('detailsDepartement').textContent = '0';
            });

          // Formatter le taux horaire avec la m√™me logique que le formatage automatique
          const tauxHoraire = employe.tauxHoraire || '';
          let tauxHoraireFormate = '-';
          if (tauxHoraire) {
            // Convertir en nombre puis formatter avec 2 d√©cimales
            const numero = parseFloat(tauxHoraire);
            tauxHoraireFormate = numero.toFixed(2);
          }
          document.getElementById('detailsTauxHoraire').textContent = tauxHoraireFormate;

          // Documents
          const specimenFile = employe.specimenCheque || employe.specimen;
          const certificatFile = employe.certificatSecurite || employe.certificat;
          const carteFile = employe.carteAssurance || employe.carte;

          if (specimenFile) {
            document.getElementById('details-specimen-preview').style.display = 'inline';
            document.getElementById('details-specimen-link').href = `/api/employes/${username}/documents/${employeId}/${specimenFile}`;
            document.getElementById('details-specimen-none').style.display = 'none';
          } else {
            document.getElementById('details-specimen-preview').style.display = 'none';
            document.getElementById('details-specimen-none').style.display = 'inline';
          }

          if (certificatFile) {
            document.getElementById('details-certificat-preview').style.display = 'inline';
            document.getElementById('details-certificat-link').href = `/api/employes/${username}/documents/${employeId}/${certificatFile}`;
            document.getElementById('details-certificat-none').style.display = 'none';
          } else {
            document.getElementById('details-certificat-preview').style.display = 'none';
            document.getElementById('details-certificat-none').style.display = 'inline';
          }

          if (carteFile) {
            document.getElementById('details-carte-preview').style.display = 'inline';
            document.getElementById('details-carte-link').href = `/api/employes/${username}/documents/${employeId}/${carteFile}`;
            document.getElementById('details-carte-none').style.display = 'none';
          } else {
            document.getElementById('details-carte-preview').style.display = 'none';
            document.getElementById('details-carte-none').style.display = 'inline';
          }
        } else {
          error('Employ√© actif non trouv√© avec ID:', employeId);
        }
      } catch (err) {
        error('Erreur lors du chargement des d√©tails employ√© actif:', err);
      }
    }
    
    function reactiverEmploye(employeId) {
      // R√©cup√©rer les infos de l'employ√© pour pr√©-remplir le formulaire
      preRemplirReactivation(employeId);
    }

    async function preRemplirReactivation(employeId) {
      try {
        const username = window.username || 'user';
        const response = await fetch(`/api/employes/${username}/termines`);
        const data = await response.json();

        const employe = data.employes.find(e => e.id === employeId);
        if (employe) {
          // Stocker l'ID de l'employ√©
          document.getElementById('modalConfirmationReactiver').dataset.employeId = employeId;

          // Pr√©-remplir tous les champs
          document.getElementById('reactiverNomComplet').value = employe.nom || '';
          document.getElementById('reactiverNas').value = employe.nas || '';
          document.getElementById('reactiverDateNaissance').value = employe.dateNaissance || '';
          document.getElementById('reactiverCourriel').value = employe.courriel || '';
          document.getElementById('reactiverTelephone').value = employe.telephone || '';

          const poste = employe.posteService ? employe.posteService.split(' - ')[0] : (employe.poste || '');
          document.getElementById('reactiverPoste').value = poste;

          document.getElementById('reactiverAdresse').value = employe.adresse || '';
          document.getElementById('reactiverVille').value = employe.ville || '';
          document.getElementById('reactiverCodePostal').value = employe.codePostal || '';

          // Appartement (traiter "-" comme vide)
          const appartement = employe.appartement && employe.appartement !== '-' ? employe.appartement : '';
          document.getElementById('reactiverAppartement').value = appartement;

          // Vider les champs √† remplir (taux horaire et date premi√®re journ√©e)
          document.getElementById('reactiverTauxHoraire').value = '';
          document.getElementById('reactiverDatePremiere').value = '';

          // Pr√©-remplir le genre via le dropdown
          let genreValue = employe.genre || employe.sexe || '';
          // Traiter "non sp√©cifi√©" comme vide
          if (genreValue.toLowerCase() === 'non sp√©cifi√©') {
            genreValue = '';
          }
          document.getElementById('reactiverGenreHidden').value = genreValue;
          const genreSelected = document.getElementById('reactiverGenre-selected');
          if (genreValue) {
            genreSelected.textContent = genreValue.charAt(0).toUpperCase() + genreValue.slice(1).toLowerCase();
          } else {
            genreSelected.textContent = 'S√©lectionner';
          }

          // Charger les documents existants
          const specimenFile = employe.specimenCheque || employe.specimen;
          const certificatFile = employe.certificatSecurite || employe.certificat;
          const carteFile = employe.carteAssurance || employe.carte;

          // Sp√©cimen existant
          const existingSpecimen = document.getElementById('existingReactiverSpecimen');
          if (specimenFile && existingSpecimen) {
            existingSpecimen.classList.remove('hidden');
            const button = existingSpecimen.querySelector('button');
            if (button) {
              button.dataset.fileUrl = `/api/employes/${username}/documents/${employeId}/${specimenFile}`;
            }
          } else if (existingSpecimen) {
            existingSpecimen.classList.add('hidden');
          }

          // Certificat existant
          const existingCertificat = document.getElementById('existingReactiverCertificat');
          if (certificatFile && existingCertificat) {
            existingCertificat.classList.remove('hidden');
            const button = existingCertificat.querySelector('button');
            if (button) {
              button.dataset.fileUrl = `/api/employes/${username}/documents/${employeId}/${certificatFile}`;
            }
          } else if (existingCertificat) {
            existingCertificat.classList.add('hidden');
          }

          // Carte existante
          const existingCarte = document.getElementById('existingReactiverCarte');
          if (carteFile && existingCarte) {
            existingCarte.classList.remove('hidden');
            const button = existingCarte.querySelector('button');
            if (button) {
              button.dataset.fileUrl = `/api/employes/${username}/documents/${employeId}/${carteFile}`;
            }
          } else if (existingCarte) {
            existingCarte.classList.add('hidden');
          }

          // Afficher le modal
          document.getElementById('modalConfirmationReactiver').style.display = 'flex';
          document.body.style.overflow = 'hidden';

          // Initialiser le calendrier, le dropdown genre et les dropzones
          setTimeout(() => {
            initReactiverDateCalendar();
            initReactiverGenreDropdown();
            initReactiverFileDropzones();

            // Formatage simple taux horaire: point ‚Üí virgule et ajouter $
            const reactiverTauxInput = document.getElementById('reactiverTauxHoraire');
            if (reactiverTauxInput) {
              reactiverTauxInput.addEventListener('blur', function() {
                let value = this.value.trim();
                if (value) {
                  value = value.replace(/[\$\s]/g, '');
                  value = value.replace(/\./g, ',');
                  if (!value.includes(',')) {
                    value = value + ',00';
                  }
                  this.value = value + ' $';
                }
              });
            }

            // NAS: seulement 9 chiffres, rien d'autre
            const reactiverNasInput = document.getElementById('reactiverNas');
            if (reactiverNasInput) {
              reactiverNasInput.addEventListener('input', function() {
                this.value = this.value.replace(/\D/g, '').substring(0, 9);
              });
            }
          }, 100);
        } else {
          showNotification('Employ√© non trouv√©', 'error');
        }
      } catch (err) {
        error('Erreur lors du chargement de l\'employ√© √† r√©activer:', error);
        showNotification('Erreur de connexion', 'error');
      }
    }

    function initReactiverGenreDropdown() {
      const dropdown = document.getElementById('reactiverGenre-dropdown');
      const menu = document.getElementById('reactiverGenre-menu');
      const selected = document.getElementById('reactiverGenre-selected');
      const hidden = document.getElementById('reactiverGenreHidden');

      if (!dropdown || !menu) return;

      // V√©rifier si d√©j√† initialis√© pour √©viter les event listeners multiples
      if (dropdown.dataset.initialized === 'true') {
        return;
      }
      dropdown.dataset.initialized = 'true';

      dropdown.onclick = function(e) {
        e.stopPropagation();
        menu.classList.toggle('show');
      };

      menu.querySelectorAll('.dropdown-secondary-option').forEach(option => {
        option.onclick = function() {
          const value = this.dataset.value;
          selected.textContent = this.textContent;
          hidden.value = value;
          menu.classList.remove('show');
        };
      });

      document.addEventListener('click', function() {
        menu.classList.remove('show');
      });
    }

    // Initialiser le calendrier pour le modal R√©activer
    function initReactiverDateCalendar() {
      const input = document.getElementById('reactiverDatePremiere');
      const calendar = document.getElementById('calendar-reactiverDatePremiere');

      if (!input || !calendar) {
        error('√âl√©ments calendrier R√©activer introuvables');
        return;
      }

      let currentDate = new Date();
      const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                         'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
      const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

      function renderCalendar(date) {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        // G√©n√©rer les en-t√™tes de jours
        const dayHeadersHTML = dayNames.map(day =>
          `<div class="calendar-day-header">${day}</div>`
        ).join('');

        // G√©n√©rer les jours du mois pr√©c√©dent
        let prevMonthDaysHTML = '';
        const prevMonth = new Date(year, month, 0);
        for (let i = firstDay - 1; i >= 0; i--) {
          const day = prevMonth.getDate() - i;
          prevMonthDaysHTML += `<div class="calendar-day other-month">${day}</div>`;
        }

        // G√©n√©rer les jours du mois actuel
        let currentMonthDaysHTML = '';
        for (let day = 1; day <= daysInMonth; day++) {
          const dateObj = new Date(year, month, day);
          let classes = 'calendar-day';

          // V√©rifier si c'est aujourd'hui
          if (dateObj.getDate() === today.getDate() &&
              dateObj.getMonth() === today.getMonth() &&
              dateObj.getFullYear() === today.getFullYear()) {
            classes += ' today';
          }

          currentMonthDaysHTML += `<div class="${classes}" data-day="${day}">${day}</div>`;
        }

        calendar.innerHTML = `
          <div class="calendar-header">
            <button type="button" class="calendar-nav-btn prev-btn">‚Äπ</button>
            <div class="calendar-month-year">${monthNames[month]} ${year}</div>
            <button type="button" class="calendar-nav-btn next-btn">‚Ä∫</button>
          </div>
          <div class="calendar-grid">
            ${dayHeadersHTML}
            ${prevMonthDaysHTML}
            ${currentMonthDaysHTML}
          </div>
        `;

        // Ajouter les event listeners
        calendar.querySelector('.prev-btn').addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          currentDate.setMonth(currentDate.getMonth() - 1);
          renderCalendar(currentDate);
        });

        calendar.querySelector('.next-btn').addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          currentDate.setMonth(currentDate.getMonth() + 1);
          renderCalendar(currentDate);
        });

        calendar.querySelectorAll('.calendar-day:not(.other-month)').forEach(dayEl => {
          dayEl.addEventListener('click', (e) => {
            e.stopPropagation();
            const selectedDay = parseInt(dayEl.dataset.day);
            const selectedDate = new Date(year, month, selectedDay);
            input.value = selectedDate.toLocaleDateString('fr-CA');
            calendar.classList.add('hidden');
            calendar.style.display = 'none';
          });
        });
      }

      input.addEventListener('click', (e) => {
        e.stopPropagation();
        if (calendar.classList.contains('hidden')) {
          calendar.classList.remove('hidden');
          calendar.style.setProperty('display', 'block', 'important');
          renderCalendar(currentDate);
        } else {
          calendar.classList.add('hidden');
          calendar.style.display = 'none';
        }
      });

      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !calendar.contains(e.target)) {
          calendar.classList.add('hidden');
          calendar.style.display = 'none';
        }
      });
    }

    async function confirmerReactivation() {
      const modal = document.getElementById('modalConfirmationReactiver');
      const employeId = modal.dataset.employeId;

      // R√©cup√©rer toutes les valeurs
      const nom = document.getElementById('reactiverNomComplet').value;
      const genre = document.getElementById('reactiverGenreHidden').value;
      const nas = document.getElementById('reactiverNas').value;
      const courriel = document.getElementById('reactiverCourriel').value;
      const telephone = document.getElementById('reactiverTelephone').value;
      const poste = document.getElementById('reactiverPoste').value;
      const tauxHoraire = document.getElementById('reactiverTauxHoraire').value;
      const datePremiere = document.getElementById('reactiverDatePremiere').value;
      const adresse = document.getElementById('reactiverAdresse').value;
      const ville = document.getElementById('reactiverVille').value;
      const codePostal = document.getElementById('reactiverCodePostal').value;
      const dateNaissance = document.getElementById('reactiverDateNaissance').value;

      // R√©cup√©rer les fichiers
      const specimenCheque = document.getElementById('reactiverSpecimenCheque').files[0];
      const certificatSecurite = document.getElementById('reactiverCertificatSecurite').files[0];
      const carteAssurance = document.getElementById('reactiverCarteAssurance').files[0];

      // Validation des champs
      if (!nom || !genre || !nas || !courriel || !telephone || !poste || !tauxHoraire || !datePremiere || !adresse || !ville || !codePostal || !dateNaissance) {
        showNotification('Veuillez remplir tous les champs obligatoires', 'error');
        return;
      }

      // Les fichiers sont optionnels - les documents existants seront conserv√©s

      try {
        const username = window.username || 'user';

        // Cr√©er FormData pour envoyer les fichiers et les donn√©es
        const formData = new FormData();
        formData.append('nom', nom);
        formData.append('genre', genre);
        formData.append('nas', nas);
        formData.append('courriel', courriel);
        formData.append('telephone', telephone);
        formData.append('poste', poste);
        formData.append('tauxHoraire', tauxHoraire);
        formData.append('datePremiere', datePremiere);
        formData.append('adresse', adresse);
        formData.append('ville', ville);
        formData.append('codePostal', codePostal);
        formData.append('dateNaissance', dateNaissance);

        // Ajouter les fichiers seulement s'ils sont fournis (nouveaux fichiers)
        if (specimenCheque) {
          formData.append('specimenCheque', specimenCheque);
        }
        if (certificatSecurite) {
          formData.append('certificatSecurite', certificatSecurite);
        }
        if (carteAssurance) {
          formData.append('carteAssurance', carteAssurance);
        }

        const response = await fetch(`/api/employes/${username}/demande-reactivation/${employeId}`, {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          log('Succ√®s:', result.message);
          fermerModalReactiver();

          // Afficher l'animation de succ√®s
          showSuccessAnimation('Demande de r√©activation envoy√©e avec succ√®s!');

          // Notifier le parent pour mettre √† jour le badge INSTANTAN√âMENT
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
          }

          // Attendre la fin de l'animation avant de recharger
          setTimeout(() => {
            chargerEmployes(); // Recharger toutes les donn√©es

            // Recharger les badges du s√©lecteur d'entrepreneurs
            if (window.EntrepreneurSelector) {
              window.EntrepreneurSelector.reload();
            }
          }, 2000);
        } else {
          const error = await response.json();
          error('Erreur:', error.detail);
          showNotification(error.detail || 'Erreur lors de l\'envoi de la demande', 'error');
        }
      } catch (err) {
        error('Erreur lors de la demande de r√©activation:', err);
        showNotification('Erreur de connexion', 'error');
      }
    }

    function fermerModalReactiver() {
      document.getElementById('modalConfirmationReactiver').style.display = 'none';
      delete document.getElementById('modalConfirmationReactiver').dataset.employeId;
      // R√©initialiser les champs
      document.getElementById('reactiverNomComplet').value = '';
      document.getElementById('reactiverGenreHidden').value = '';
      document.getElementById('reactiverGenre-selected').textContent = 'S√©lectionner';
      document.getElementById('reactiverNas').value = '';
      document.getElementById('reactiverCourriel').value = '';
      document.getElementById('reactiverTelephone').value = '';
      document.getElementById('reactiverPoste').value = '';
      document.getElementById('reactiverTauxHoraire').value = '';
      document.getElementById('reactiverDatePremiere').value = '';
      document.getElementById('reactiverAdresse').value = '';
      document.getElementById('reactiverVille').value = '';
      document.getElementById('reactiverCodePostal').value = '';
      document.getElementById('reactiverDateNaissance').value = '';
      // R√©initialiser les fichiers
      removeReactiverFilePreview('reactiverSpecimenCheque');
      removeReactiverFilePreview('reactiverCertificatSecurite');
      removeReactiverFilePreview('reactiverCarteAssurance');
      // R√©activer le scroll en arri√®re-plan
      document.body.style.overflow = 'auto';
    }
    
    // Fonction pour cr√©er des menus d√©roulants personnalis√©s
    function createCustomSelect(selectElement) {
      log('üèóÔ∏è createCustomSelect() pour:', selectElement.id, selectElement);
      
      // Cr√©er le conteneur personnalis√©
      const customSelect = document.createElement('div');
      customSelect.className = 'custom-select';
      customSelect.setAttribute('data-target', selectElement.id);

      // Cr√©er le bouton principal
      const button = document.createElement('div');
      button.className = 'custom-select-button';
      button.setAttribute('tabindex', '0');

      // Texte du bouton
      const textSpan = document.createElement('span');
      textSpan.className = 'custom-select-text';
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      textSpan.textContent = selectedOption.textContent;

      // Fl√®che
      const arrowSpan = document.createElement('span');
      arrowSpan.className = 'custom-select-arrow';
      arrowSpan.textContent = '‚ñº';

      // Assembler le bouton
      button.appendChild(textSpan);
      button.appendChild(arrowSpan);

      // Cr√©er le dropdown
      const dropdown = document.createElement('div');
      dropdown.className = 'custom-select-dropdown';

      // Cr√©er les options
      Array.from(selectElement.options).forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'custom-select-option';
        optionDiv.textContent = option.textContent;
        optionDiv.setAttribute('data-value', option.value);
        
        if (index === selectElement.selectedIndex) {
          optionDiv.classList.add('selected');
        }
        
        dropdown.appendChild(optionDiv);
      });

      // Assembler le tout
      customSelect.appendChild(button);
      customSelect.appendChild(dropdown);

      // Ins√©rer apr√®s le select original et masquer le select natif
      selectElement.parentNode.insertBefore(customSelect, selectElement.nextSibling);
      selectElement.style.display = 'none';
      
      log('[OK] Custom select cr√©√© pour:', selectElement.id, customSelect);
      
      return customSelect;
    }
    
    function initCustomSelects() {
      log('üîÑ initCustomSelects() appel√©');
      
      // Nettoyer les anciens √©v√©nements et cr√©er de nouveaux selects
      document.querySelectorAll('.custom-select').forEach(el => el.remove());
      
      const modalSelects = document.querySelectorAll('.modal-select');
      log('[DEBUG] Selects .modal-select trouv√©s:', modalSelects.length);
      
      modalSelects.forEach((selectElement, index) => {
        log(`[TARGET] Cr√©ation custom select ${index + 1}:`, selectElement.id, selectElement);
        createCustomSelect(selectElement);
      });
      
      // G√©rer les interactions avec d√©l√©gation d'√©v√©nements
      setTimeout(() => {
        document.querySelectorAll('.custom-select').forEach(customSelect => {
          const button = customSelect.querySelector('.custom-select-button');
          const dropdown = customSelect.querySelector('.custom-select-dropdown');
          const textElement = customSelect.querySelector('.custom-select-text');
          const targetId = customSelect.getAttribute('data-target');
          const originalSelect = document.getElementById(targetId);
          
          // Supprimer les anciens √©v√©nements
          button.replaceWith(button.cloneNode(true));
          dropdown.replaceWith(dropdown.cloneNode(true));
          
          // R√©-obtenir les √©l√©ments apr√®s clonage
          const newButton = customSelect.querySelector('.custom-select-button');
          const newDropdown = customSelect.querySelector('.custom-select-dropdown');
          const newTextElement = customSelect.querySelector('.custom-select-text');
          
          newButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Fermer tous les autres dropdowns
            document.querySelectorAll('.custom-select').forEach(select => {
              if (select !== customSelect) {
                select.classList.remove('open');
              }
            });
            
            // Toggler ce dropdown
            customSelect.classList.toggle('open');
          });
          
          newDropdown.addEventListener('click', function(e) {
            if (e.target.classList.contains('custom-select-option')) {
              const value = e.target.getAttribute('data-value');
              const text = e.target.textContent;
              
              // Mettre √† jour le texte affich√©
              newTextElement.textContent = text;
              
              // Mettre √† jour le select original
              if (originalSelect) {
                originalSelect.value = value;
                
                // D√©clencher l'√©v√©nement change
                const changeEvent = new Event('change', { bubbles: true });
                originalSelect.dispatchEvent(changeEvent);
              }
              
              // Mettre √† jour les classes selected
              newDropdown.querySelectorAll('.custom-select-option').forEach(opt => {
                opt.classList.remove('selected');
              });
              e.target.classList.add('selected');
              
              // Fermer le dropdown
              customSelect.classList.remove('open');
            }
          });
        });
        
        // Fermer les dropdowns en cliquant √† l'ext√©rieur (un seul √©v√©nement global)
        document.removeEventListener('click', closeDropdownsHandler);
        document.addEventListener('click', closeDropdownsHandler);
      }, 10);
    }
    
    function closeDropdownsHandler(e) {
      if (!e.target.closest('.custom-select')) {
        document.querySelectorAll('.custom-select').forEach(select => {
          select.classList.remove('open');
        });
      }
    }
    
    function ajouterEmployeActifATable(employe) {
      const tableBody = document.querySelector('.employes-actifs tbody');
      if (!tableBody) return;
      
      const nouvelleRow = document.createElement('tr');
      nouvelleRow.classList.add('hover:bg-gray-50');
      
      const specimenLink = employe.specimenCheque !== 'Non fourni' ? 
        `<a href="#" class="text-gray-600 hover:" style="color: var(--text-light); overflow: hidden; text-overflow: ellipsis;""><i class="fas fa-file-pdf"></i> Voir PDF</a>` :
        `<span class="text-gray-400">${employe.specimenCheque}</span>`;
      
      nouvelleRow.innerHTML = `
        <td class="px-6 py-4  text-sm font-medium " style="color: var(--text-light); overflow: hidden; text-overflow: ellipsis;" sticky-col">${employe.nom}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.nas}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.genre}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.adresse}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.appartement}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.ville}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.codePostal}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.telephone}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.courriel}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.datePremiere}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.posteService}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${employe.tauxHoraire}</td>
        <td class="px-6 py-4  text-sm text-gray-500">${specimenLink}</td>
        <td class="px-6 py-4  text-sm font-medium space-x-2">
          <button class="btn-primary">
            <i class="fas fa-edit"></i> Modifier
          </button>
          <button class="btn-primary">
            <i class="fas fa-user-times"></i> Fin d'emploi
          </button>
        </td>
      `;
      
      tableBody.appendChild(nouvelleRow);
    }
    
    function mettreAJourCompteurActifs() {
      const tableBody = document.querySelector('.employes-actifs tbody');
      const compteur = tableBody ? tableBody.getElementsByTagName('tr').length : 0;
      const spanCompteur = document.getElementById('compteur-actifs');
      if (spanCompteur) {
        spanCompteur.textContent = `${compteur} employ√©${compteur > 1 ? 's' : ''}`;
      }
    }
    
    // Calendrier personnalis√©
    class CustomCalendar {
      static instances = [];

      constructor(inputId, calendarId) {
        this.inputElement = document.getElementById(inputId);
        this.calendarElement = document.getElementById(calendarId);
        this.currentDate = new Date();
        this.selectedDate = null;

        // Ne PAS d√©finir de date par d√©faut - laisser vide
        this.inputElement.value = '';

        this.monthNames = [
          'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
          'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
        ];

        this.dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

        // Ajouter cette instance √† la liste
        CustomCalendar.instances.push(this);

        this.init();
      }

      init() {
        this.inputElement.addEventListener('click', () => {
          this.toggleCalendar();
        });

        document.addEventListener('click', (e) => {
          if (!e.target.closest('.custom-date-container')) {
            this.hideCalendar();
          }
        });

        this.renderCalendar();
      }

      toggleCalendar() {
        if (this.calendarElement.classList.contains('hidden')) {
          this.showCalendar();
        } else {
          this.hideCalendar();
        }
      }

      showCalendar() {
        CustomCalendar.instances.forEach(instance => {
          if (instance !== this) {
            instance.hideCalendar();
          }
        });

        this.calendarElement.classList.remove('hidden');
        this.calendarElement.style.setProperty('display', 'block', 'important');
        this.renderCalendar();
      }

      hideCalendar() {
        this.calendarElement.classList.add('hidden');
        this.calendarElement.style.display = 'none';
      }

      renderCalendar() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();

        this.calendarElement.innerHTML = `
          <div class="calendar-header">
            <button type="button" class="calendar-nav-btn">‚Äπ</button>
            <div class="calendar-month-year">${this.monthNames[month]} ${year}</div>
            <button type="button" class="calendar-nav-btn">‚Ä∫</button>
          </div>
          <div class="calendar-grid">
            ${this.renderDayHeaders()}
            ${this.renderDays()}
          </div>
        `;

        this.calendarElement.calendar = this;

        // Ajouter les event listeners pour les boutons de navigation
        const prevBtn = this.calendarElement.querySelector('.calendar-nav-btn:first-child');
        const nextBtn = this.calendarElement.querySelector('.calendar-nav-btn:last-child');

        prevBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.previousMonth();
        });

        nextBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.nextMonth();
        });
      }

      renderDayHeaders() {
        return this.dayNames.map(day =>
          `<div class="calendar-day-header">${day}</div>`
        ).join('');
      }

      renderDays() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = firstDay.getDay();

        let daysHTML = '';

        // Jours du mois pr√©c√©dent
        const prevMonth = new Date(year, month - 1, 0);
        for (let i = startingDay - 1; i >= 0; i--) {
          const day = prevMonth.getDate() - i;
          daysHTML += `<div class="calendar-day other-month">${day}</div>`;
        }

        // Jours du mois actuel
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          let classes = 'calendar-day';

          if (this.selectedDate && this.isSameDay(date, this.selectedDate)) {
            classes += ' selected';
          } else if (this.isSameDay(date, today)) {
            classes += ' today';
          }

          daysHTML += `<div class="${classes}" onclick="this.closest('.custom-calendar').calendar.selectDate(${year}, ${month}, ${day})">${day}</div>`;
        }

        // Jours du mois suivant pour compl√©ter la grille
        const totalCells = Math.ceil((startingDay + daysInMonth) / 7) * 7;
        const remainingCells = totalCells - (startingDay + daysInMonth);
        for (let day = 1; day <= remainingCells; day++) {
          daysHTML += `<div class="calendar-day other-month">${day}</div>`;
        }

        return daysHTML;
      }

      prevMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
        this.renderCalendar();
      }

      nextMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
        this.renderCalendar();
      }

      selectDate(year, month, day) {
        this.selectedDate = new Date(year, month, day);
        const formattedDate = this.formatDate(this.selectedDate);
        this.inputElement.value = formattedDate;
        this.hideCalendar();

        // D√©clencher l'√©v√©nement change
        const changeEvent = new Event('change', { bubbles: true });
        this.inputElement.dispatchEvent(changeEvent);
      }

      formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${day}/${month}/${year}`;
      }

      isSameDay(date1, date2) {
        return date1.getFullYear() === date2.getFullYear() &&
               date1.getMonth() === date2.getMonth() &&
               date1.getDate() === date2.getDate();
      }
    }
    
    function logout() {
      fetch('/logout', { method: 'POST' })
        .then(() => window.location.href = '/login')
        .catch(err => error('Erreur logout:', err));
    }

    // Variable globale pour stocker le nom d'utilisateur original du coach
    window.originalCoachUsername = null;

    // Fonction pour g√©rer l'√©tat du bouton "Ajouter un employ√©" pour les coaches
    function updateAddEmployeeButtonState() {
      const userRole = localStorage.getItem('userRole');
      // Utiliser le nom d'utilisateur ORIGINAL du coach, pas celui qui a √©t√© √©cras√© par le s√©lecteur
      const currentUsername = window.originalCoachUsername || localStorage.getItem('username');

      console.log('[BUTTON-STATE] userRole:', userRole);
      console.log('[BUTTON-STATE] currentUsername (original coach):', currentUsername);
      console.log('[BUTTON-STATE] window.selectedEntrepreneur:', window.selectedEntrepreneur);
      console.log('[BUTTON-STATE] window.username:', window.username);

      if (userRole === 'coach' || userRole === 'direction') {
        const addEmployeeBtn = document.getElementById('add-employee-btn');
        if (addEmployeeBtn) {
          // V√©rifier si un entrepreneur est charg√© via window.selectedEntrepreneur OU window.username
          const entrepreneurUsername = window.selectedEntrepreneur || window.username;

          // Pour direction: toujours activer si un entrepreneur est s√©lectionn√©
          // Pour coach: activer seulement si c'est un entrepreneur diff√©rent du coach
          const isViewingEntrepreneur = userRole === 'direction'
            ? !!window.selectedEntrepreneur
            : (entrepreneurUsername && entrepreneurUsername !== currentUsername);

          console.log('[BUTTON-STATE] entrepreneurUsername:', entrepreneurUsername);
          console.log('[BUTTON-STATE] isViewingEntrepreneur:', isViewingEntrepreneur);

          if (isViewingEntrepreneur) {
            // Activer le bouton
            console.log('[BUTTON-STATE] ‚úÖ Activation du bouton');
            addEmployeeBtn.disabled = false;
            addEmployeeBtn.style.opacity = '1';
            addEmployeeBtn.style.cursor = 'pointer';
            addEmployeeBtn.style.transform = '';
            addEmployeeBtn.style.pointerEvents = '';
            addEmployeeBtn.onclick = () => ouvrirModalAjouterEmploye();
          } else {
            // D√©sactiver le bouton
            console.log('[BUTTON-STATE] ‚ùå D√©sactivation du bouton');
            addEmployeeBtn.disabled = true;
            addEmployeeBtn.style.opacity = '0.5';
            addEmployeeBtn.style.cursor = 'not-allowed';
            addEmployeeBtn.style.transform = 'none';
            addEmployeeBtn.style.pointerEvents = 'none';
            addEmployeeBtn.onclick = (e) => {
              e.preventDefault();
              e.stopPropagation();
              return false;
            };
          }
        }
      }
    }

    // Initialiser les calendriers personnalis√©s
    document.addEventListener('DOMContentLoaded', function() {
      // Initialiser window.username pour les entrepreneurs (non-coaches)
      const userRole = localStorage.getItem('userRole');

      // IMPORTANT: Sauvegarder le nom d'utilisateur ORIGINAL du coach AVANT que le s√©lecteur ne le modifie
      if (userRole === 'coach' || userRole === 'direction') {
        window.originalCoachUsername = localStorage.getItem('username');
        console.log('[INIT] Coach username original sauvegard√©:', window.originalCoachUsername);

        // Initialiser le flag pour contr√¥ler l'affichage du modal de notification
        window.shouldShowNotificationModal = false;
        console.log('[INIT] Flag notification modal initialis√©:', window.shouldShowNotificationModal);
      }

      if (userRole !== 'coach' && userRole !== 'direction') {
        // Pour les entrepreneurs, utiliser le username depuis localStorage
        window.username = localStorage.getItem('username') || 'user';
        log('Entrepreneur username initialis√©:', window.username);
      }

      // Mettre √† jour imm√©diatement l'√©tat du bouton (il sera gris√© par d√©faut pour les coaches)
      updateAddEmployeeButtonState();

      // Re-v√©rifier l'√©tat du bouton apr√®s que l'entrepreneur soit charg√© (si un URL param existe)
      setTimeout(() => {
        updateAddEmployeeButtonState();
      }, 550); // Juste apr√®s le chargement de l'entrepreneur (500ms)

      // Account dropdown toggle - NOUVEAU HEADER
      const btn = document.getElementById("account-dropdown-toggle");
      const dropdown = document.getElementById("account-dropdown");
      
      if (btn && dropdown) {
        btn.addEventListener("click", () => {
          dropdown.classList.toggle("hidden");
        });

        // Fermer le dropdown si on clique ailleurs
        document.addEventListener("click", (e) => {
          if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add("hidden");
          }
        });
      }

      // Afficher le username dans le header
      if (window.username) {
        const displayEl = document.getElementById('account-display');
        const usernameEl = document.getElementById('account-username');
        if (displayEl) displayEl.textContent = window.username;
        if (usernameEl) usernameEl.textContent = window.username;
      }

      // Modal d'activation ferm√© par d√©faut
      
      // Modal refuser ferm√© par d√©faut
      
      // Modal info ferm√© par d√©faut

      // Afficher la date actuelle - EXACT COPY from newgqp
      function afficherDateActuelle() {
        const maintenant = new Date();
        const options = {
          weekday: 'long',
          year: 'numeric', 
          month: 'long',
          day: 'numeric'
        };
        const dateFormatee = maintenant.toLocaleDateString('fr-FR', options);
        const dateElement = document.getElementById('currentDate');
        if (dateElement) {
          dateElement.textContent = dateFormatee.charAt(0).toUpperCase() + dateFormatee.slice(1);
        }
      }
      
      // Appeler la fonction d'affichage de la date
      afficherDateActuelle();

      // new CustomCalendar('datePremiere', 'calendar-datePremiere'); // D√©sactiv√© - utilise notre syst√®me
      // new CustomCalendar('modifierDatePremiere', 'calendar-modifierDatePremiere'); // D√©sactiv√©
      
      // Charger les employ√©s au d√©marrage
      chargerEmployes();
    });
    
    // Fonctions pour interagir avec l'API
    async function chargerEmployes() {
      try {
        const username = window.username || 'user'; // Utiliser le username global

        // Charger tous les types d'employ√©s + r√©activations + inactivations
        const [nouveaux, actifs, termines, inactifs, reactivations, inactivations] = await Promise.all([
          fetch(`/api/employes/${username}/nouveaux`).then(r => r.json()),
          fetch(`/api/employes/${username}/actifs`).then(r => r.json()),
          fetch(`/api/employes/${username}/termines`).then(r => r.json()),
          fetch(`/api/employes/${username}/inactifs`).then(r => r.json()),
          fetch(`/api/employes/${username}/reactivations`).then(r => r.json()),
          fetch(`/api/employes/${username}/inactivations`).then(r => r.json())
        ]);

        // Fusionner les r√©activations avec les nouveaux
        const nouveauxAvecReactivations = {
          ...nouveaux,
          employes: [...(nouveaux.employes || []), ...(reactivations.employes || [])]
        };

        // Afficher les employ√©s dans les tables (avec r√©activations fusionn√©es)
        afficherEmployesNouveaux(nouveauxAvecReactivations.employes || []);
        afficherEmployesActifs(actifs.employes || []);
        afficherEmployesTermines(termines.employes || []);

        // Charger les compteurs de messages non lus pour les refus
        await loadRefusUnreadCounts();

        // ‚ö° NOTIFICATION COACH - Afficher le modal si coach et s'il y a des notifications
        const userRole = localStorage.getItem('userRole');
        const isCoach = userRole === 'coach' || userRole === 'direction';
        const hasSelection = document.body.classList.contains('has-selection');

        // V√©rifier le flag pour afficher le modal UNIQUEMENT lors de la s√©lection d'entrepreneur
        if (isCoach && hasSelection && window.shouldShowNotificationModal === true) {
          // Analyser les employ√©s pour d√©tecter les actions en attente coach (avec r√©activations et inactivations)
          const actionsEnAttente = analyserActionsEnAttente(
            nouveauxAvecReactivations.employes || [],
            actifs.employes || [],
            termines.employes || [],
            inactifs.employes || [],
            inactivations.employes || []
          );

          // Afficher le modal seulement s'il y a au moins une action en attente
          if (actionsEnAttente.length > 0) {
            afficherModalNotificationCoach(actionsEnAttente);
          }

          // R√©initialiser le flag apr√®s l'affichage pour √©viter de r√©afficher le modal
          window.shouldShowNotificationModal = false;
          console.log('[NOTIFICATION] Flag r√©initialis√© apr√®s affichage du modal');
        }

        // Mettre √† jour l'√©tat du bouton "Ajouter un employ√©" pour les coaches
        updateAddEmployeeButtonState();

      } catch (err) {
        error('Erreur lors du chargement des employ√©s:', err);
      }
    }

    // Fonction pour analyser les actions en attente de validation coach
    function analyserActionsEnAttente(nouveaux, actifs, termines, inactifs, inactivations) {
      const actions = [];

      // ===== SECTION 1: Nouveau(x) employ√©(s) =====
      const activations = nouveaux.filter(emp =>
        emp.statut === "En attente de validation" &&
        !emp.reactivation &&
        !emp.modification &&
        !emp.fin_emploi
      );

      if (activations.length > 0) {
        // R√©p√©ter "Activation en attente coach" pour chaque employ√©
        const descriptions = Array(activations.length).fill('Activation en attente coach');

        actions.push({
          type: 'nouveaux',
          count: activations.length,
          icon: 'fa-user-plus',
          color: '#ef4444',
          bgColor: 'rgba(239, 68, 68, 0.1)',
          borderColor: 'rgba(239, 68, 68, 0.3)',
          label: 'Nouveau(x) employ√©(s)',
          descriptions: descriptions
        });
      }

      // ===== SECTION 2: Employ√©(s) actif(s) (Modifications + Inactivations) =====
      // IMPORTANT: Ne compter que les items "en attente de validation" (pas "en attente comptable")
      // car seuls ceux "de validation" affichent un bouton "V√©rifier" pour le coach
      const modificationsActifs = actifs.filter(emp =>
        emp.statut === "Modification en attente de validation"
      );
      const modificationsNouveaux = nouveaux.filter(emp =>
        emp.modification === true ||
        emp.statut === "Modification en attente de validation"
      );
      const totalModifications = [...modificationsActifs, ...modificationsNouveaux];

      const inactivationsEnAttente = (inactivations || []).filter(emp =>
        emp.statut === "Inactivation en attente de validation"
      );
      const finEmploisActifs = actifs.filter(emp =>
        emp.statut === "Fin d'emploi en attente de validation"
      );
      const finEmploisNouveaux = nouveaux.filter(emp => emp.fin_emploi === true);
      const totalInactivations = [...finEmploisActifs, ...finEmploisNouveaux, ...inactivationsEnAttente];

      // Compter le total pour la section "Actifs"
      const totalActifs = totalModifications.length + totalInactivations.length;

      if (totalActifs > 0) {
        // Construire la description en r√©p√©tant chaque type autant de fois qu'il y a d'employ√©s
        const descriptions = [];

        // Ajouter "Modification en attente coach" pour chaque modification
        for (let i = 0; i < totalModifications.length; i++) {
          descriptions.push('Modification en attente coach');
        }

        // Ajouter "Inactivation en attente coach" pour chaque inactivation
        for (let i = 0; i < totalInactivations.length; i++) {
          descriptions.push('Inactivation en attente coach');
        }

        actions.push({
          type: 'actifs',
          count: totalActifs,
          icon: 'fa-user-edit',
          color: '#3b82f6',
          bgColor: 'rgba(59, 130, 246, 0.1)',
          borderColor: 'rgba(59, 130, 246, 0.3)',
          label: 'Employ√©(s) actif(s)',
          descriptions: descriptions
        });
      }

      // ===== SECTION 3: Employ√©(s) termin√©(s) (R√©activations) =====
      // IMPORTANT: Ne compter que "R√©activation en attente de validation" (pas "en attente comptable")
      // Chercher dans termines ET inactifs (pas dans nouveaux car le statut n'est pas √† jour dans reactivations.json)
      const reactivationsTermines = (termines || []).filter(emp =>
        emp.statut === "R√©activation en attente de validation"
      );
      const reactivationsInactifs = (inactifs || []).filter(emp =>
        emp.statut === "R√©activation en attente de validation"
      );
      const reactivations = [...reactivationsTermines, ...reactivationsInactifs];

      if (reactivations.length > 0) {
        // R√©p√©ter "R√©activation en attente coach" pour chaque employ√©
        const descriptions = Array(reactivations.length).fill('R√©activation en attente coach');

        actions.push({
          type: 'termines',
          count: reactivations.length,
          icon: 'fa-user-clock',
          color: '#f59e0b',
          bgColor: 'rgba(245, 158, 11, 0.1)',
          borderColor: 'rgba(245, 158, 11, 0.3)',
          label: 'Employ√©(s) termin√©(s)',
          descriptions: descriptions
        });
      }

      return actions;
    }

    // Fonction pour afficher le modal de notification coach
    function afficherModalNotificationCoach(actionsEnAttente) {
      const modal = document.getElementById('modalNotificationCoach');
      const actionsList = document.getElementById('notif-actions-list');
      if (!modal || !actionsList) return;

      // G√©n√©rer le HTML pour chaque action en attente
      actionsList.innerHTML = actionsEnAttente.map(action => {
        // G√©n√©rer la liste de descriptions num√©rot√©e (toujours num√©rot√©e, m√™me pour une seule)
        const descriptionsHTML = action.descriptions.map((desc, idx) =>
          `<div style="color: var(--text-gray); font-size: 0.875rem;">${idx + 1}. ${desc}</div>`
        ).join('');

        return `
          <div class="p-4 rounded-lg" style="background: ${action.bgColor}; border: 1px solid ${action.borderColor};">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-3">
                <i class="fas ${action.icon}" style="color: ${action.color}; font-size: 1.25rem;"></i>
                <span style="color: var(--text-light); font-weight: 500;">${action.label}</span>
              </div>
              <span class="px-3 py-1 rounded-full font-bold" style="background: ${action.color}; color: white;">${action.count}</span>
            </div>
            <div class="ml-9">
              ${descriptionsHTML}
            </div>
          </div>
        `;
      }).join('');

      // Afficher le modal
      modal.style.display = 'flex';
    }

    // Fonction pour fermer le modal de notification coach
    function fermerModalNotificationCoach() {
      const modal = document.getElementById('modalNotificationCoach');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Exposer la fonction globalement pour le onclick
    window.fermerModalNotificationCoach = fermerModalNotificationCoach;
    
    function afficherEmployesNouveaux(employes) {
      const tableBody = document.querySelector('.nouveaux-employes-body');
      const mobileList = document.getElementById('nouveaux-employes-mobile-list');
      const compteur = document.getElementById('compteur-nouveaux');

      tableBody.innerHTML = '';
      if (mobileList) mobileList.innerHTML = '';

      // Mettre √† jour le compteur avec pluriel appropri√©
      const count = employes.length;
      let texteCompteur;
      if (count === 0) {
        texteCompteur = '0 nouveau';
      } else if (count === 1) {
        texteCompteur = '1 nouveau';
      } else {
        texteCompteur = `${count} nouveaux`;
      }
      compteur.textContent = texteCompteur;

      if (employes.length === 0) {
        // Afficher √©tat vide pour desktop
        tableBody.innerHTML = `
          <tr class="empty-state-row">
            <td colspan="5" class="empty-state">
              <i class="fas fa-user-plus" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
              <p style="font-size: 1rem;">Aucun nouvel employ√©</p>
            </td>
          </tr>
        `;

        // Afficher √©tat vide pour mobile
        if (mobileList) {
          mobileList.innerHTML = `
            <div class="employes-empty-mobile">
              <i class="fas fa-user-plus"></i>
              <p>Aucun nouvel employ√©</p>
            </div>
          `;
        }
        return;
      }

      employes.forEach(employe => {
        const nomComplet = `${employe.prenom || ''} ${employe.nom || ''}`.trim();
        // V√©rifier le r√¥le depuis localStorage OU window.userRole (plus fiable avec les iframes)
        const userRole = localStorage.getItem('userRole') || window.userRole || '';

        // Coach/direction voit "En attente de validation" avec bouton V√©rifier (quand statut = "En attente de validation")
        // Coach/direction voit spinner "En attente de validation" (quand statut = "En attente comptable")
        // Entrepreneur voit spinner "En attente de validation" pour les deux statuts: "En attente de validation" et "En attente comptable"
        // ACTIVATION
        const estCoachAvecEnAttente = ((userRole === 'coach' || userRole === 'direction') && employe.statut === 'En attente de validation');
        const estCoachAvecAttenteComptable = ((userRole === 'coach' || userRole === 'direction') && employe.statut === 'En attente comptable');
        const estEntrepreneurAvecValidation = (userRole === 'entrepreneur' && (employe.statut === 'En attente de validation' || employe.statut === 'En attente comptable'));
        // REFUS
        const estRefuseParCoach = (employe.statut === 'Refus√© par coach');
        const estRefuseParComptable = (employe.statut === 'Refus√© par comptable');
        const estRefuse = estRefuseParCoach || estRefuseParComptable;
        // INACTIVATION
        const estCoachAvecInactivationEnAttente = ((userRole === 'coach' || userRole === 'direction') && employe.statut === 'Inactivation en attente de validation');
        const estCoachAvecInactivationComptable = ((userRole === 'coach' || userRole === 'direction') && employe.statut === 'Inactivation en attente comptable');
        const estEntrepreneurAvecInactivation = (userRole === 'entrepreneur' && (employe.statut === 'Inactivation en attente de validation' || employe.statut === 'Inactivation en attente comptable'));

        log('Employ√©:', nomComplet, 'Statut:', employe.statut, 'Role:', userRole, 'localStorage:', localStorage.getItem('userRole'), 'window:', window.userRole);

        // Vue Desktop: Table row
        const row = document.createElement('tr');

        // D√©terminer le motif de refus
        const motifRefus = employe.motif_refus_coach || employe.motif_refus_comptable || '';
        const dateRefus = employe.date_refus_coach || employe.date_refus_comptable || '';
        const refusePar = estRefuseParCoach ? 'Coach' : (estRefuseParComptable ? 'Comptable' : '');

        // D√©terminer si les boutons doivent √™tre d√©sactiv√©s (en attente)
        const estEnAttenteNouveaux = estEntrepreneurAvecValidation || estCoachAvecAttenteComptable;
        const btnDisabledClassNouveaux = estEnAttenteNouveaux ? 'btn-disabled' : '';

        row.innerHTML = `
          <td>${nomComplet}</td>
          <td>${employe.courriel || ''}</td>
          <td>${employe.posteService || employe.poste || ''}</td>
          <td class="text-center" style="text-align: center;">
            ${estCoachAvecEnAttente
              ? `<button class="btn-primary btn-verifier-employe" data-employe-id="${employe.id}" style="background: #f59e0b !important; border-color: #f59e0b !important;">V√©rifier</button>`
              : `<div style="display: flex; gap: 0.4rem; justify-content: center;">
                   <button class="btn-primary ${btnDisabledClassNouveaux}" ${estEnAttenteNouveaux ? '' : `onclick="activerEmploye('${employe.id}')"`}>Activer</button>
                   <button class="btn-secondary ${btnDisabledClassNouveaux}" ${estEnAttenteNouveaux ? '' : `onclick="refuserEmploye('${employe.id}')"`}>Refuser</button>
                 </div>`
            }
          </td>
          <td class="text-center" style="text-align: center;">
            ${estEnAttenteNouveaux
              ? `<div class="status-pending">
                   <i class="fas fa-spinner fa-spin"></i>
                   <span>En attente de validation ${employe.statut === 'En attente comptable' ? 'comptable' : 'coach'}</span>
                 </div>`
              : estCoachAvecEnAttente
              ? `<div class="status-pending">
                   <i class="fas fa-spinner fa-spin"></i>
                   <span>Activation en attente coach</span>
                 </div>`
              : estRefuse
              ? `<span class="status-badge ${((userRole === 'coach' || userRole === 'direction') && estRefuseParComptable) ? 'terminated' : 'refused'} btn-voir-refus-badge" data-motif="${motifRefus.replace(/"/g, '&quot;')}" data-date="${dateRefus}" data-nom="${nomComplet.replace(/"/g, '&quot;')}" data-employe-id="${employe.id}" data-refuse-par="${refusePar}"><i class="fas fa-eye"></i> Refus√© par ${refusePar}</span>`
              : `<span style="color: var(--text-gray); font-size: 0.8rem;">‚Äî</span>`
            }
          </td>
        `;

        // Ajouter listener pour voir la raison du refus (badge cliquable)
        if (estRefuse) {
          const btnVoirRefusBadge = row.querySelector('.btn-voir-refus-badge');
          if (btnVoirRefusBadge) {
            btnVoirRefusBadge.addEventListener('click', () => {
              const motif = btnVoirRefusBadge.dataset.motif;
              const date = btnVoirRefusBadge.dataset.date;
              const nom = btnVoirRefusBadge.dataset.nom;
              const employeId = btnVoirRefusBadge.dataset.employeId;
              const refusePar = btnVoirRefusBadge.dataset.refusePar;
              ouvrirModalVoirRefus(motif, date, nom, employeId, refusePar);
            });
          }
        }

        // Ajouter le listener pour le bouton V√©rifier
        if (estCoachAvecEnAttente) {
          const btnVerifier = row.querySelector('.btn-verifier-employe');
          if (btnVerifier) {
            btnVerifier.addEventListener('click', () => {
              ouvrirPopupValidation(employe.id, employe);
            });
          }
        }

        tableBody.appendChild(row);

        // Vue Mobile: Card
        if (mobileList) {
          const card = document.createElement('div');
          card.className = 'employe-mobile-card';

          card.innerHTML = `
            <div class="employe-card-header">
              <div style="flex: 1;">
                <div class="employe-card-nom">${nomComplet}</div>
                <div class="employe-card-info">
                  <i class="fas fa-envelope"></i>
                  <span>${employe.courriel || '-'}</span>
                </div>
                <div class="employe-card-info">
                  <span class="employe-card-poste">${employe.posteService || employe.poste || '-'}</span>
                </div>
              </div>
            </div>
            ${estRefuse
              ? `<div class="employe-card-actions" style="flex-wrap: wrap; gap: 0.4rem; justify-content: center;">
                   <span class="status-badge ${((userRole === 'coach' || userRole === 'direction') && estRefuseParComptable) ? 'terminated' : 'refused'}"><i class="fas fa-times-circle"></i> Refus√© par ${refusePar}</span>
                   <button class="btn-reason btn-voir-refus-mobile" data-motif="${motifRefus.replace(/"/g, '&quot;')}" data-date="${dateRefus}" data-refuse-par="${refusePar}" data-employe-id="${employe.id}" data-nom="${nomComplet.replace(/"/g, '&quot;')}">Voir</button>
                   <div class="action-btns-compact">
                     <button onclick="supprimerEmployeNouveau('${employe.id}', '${(employe.nom || '').replace(/'/g, "\\'")}')" class="btn-secondary">Annuler</button>
                     <button onclick="activerEmploye('${employe.id}')" class="btn-primary">R√©essayer</button>
                   </div>
                 </div>`
              : estCoachAvecEnAttente
              ? `<div class="employe-card-actions" style="justify-content: center;">
                   <button class="btn-verifier-employe-mobile" data-employe-id="${employe.id}" style="background: #f59e0b !important; border-color: #f59e0b !important; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; gap: 0.4rem;">
                     <i class="fas fa-search"></i> V√©rifier
                   </button>
                 </div>`
              : (estEntrepreneurAvecValidation || estCoachAvecAttenteComptable)
              ? `<div class="employe-card-actions" style="justify-content: center;">
                   <div class="status-pending">
                     <i class="fas fa-spinner fa-spin"></i>
                     <span>En attente</span>
                   </div>
                 </div>`
              : `<div class="employe-card-actions">
                   <button onclick="activerEmploye('${employe.id}')" class="employe-action-btn activate-btn" style="font-size: 0.75rem; padding: 0.4rem 0.6rem;">
                     <i class="fas fa-check"></i> Activer
                   </button>
                   <button onclick="refuserEmploye('${employe.id}')" class="employe-action-btn delete-btn" style="font-size: 0.75rem; padding: 0.4rem 0.6rem;">
                     <i class="fas fa-times"></i> Refuser
                   </button>
                 </div>`
            }
          `;

          // Ajouter le listener pour le bouton V√©rifier mobile
          if (estCoachAvecEnAttente) {
            const btnVerifierMobile = card.querySelector('.btn-verifier-employe-mobile');
            if (btnVerifierMobile) {
              btnVerifierMobile.addEventListener('click', () => {
                ouvrirPopupValidation(employe.id, employe);
              });
            }
          }

          // Ajouter listener pour voir la raison du refus (mobile)
          if (estRefuse) {
            const btnVoirRefusMobile = card.querySelector('.btn-voir-refus-mobile');
            if (btnVoirRefusMobile) {
              btnVoirRefusMobile.addEventListener('click', () => {
                const motif = btnVoirRefusMobile.dataset.motif;
                const date = btnVoirRefusMobile.dataset.date;
                const nom = btnVoirRefusMobile.dataset.nom;
                const employeId = btnVoirRefusMobile.dataset.employeId;
                const refusePar = btnVoirRefusMobile.dataset.refusePar;
                ouvrirModalVoirRefus(motif, date, nom, employeId, refusePar);
              });
            }
          }

          mobileList.appendChild(card);
        }
      });
    }
    
    function afficherEmployesActifs(employes) {
      const tableBody = document.querySelector('.employes-actifs-body');
      const mobileList = document.getElementById('employes-actifs-mobile-list');
      const compteur = document.getElementById('compteur-actifs');

      tableBody.innerHTML = '';
      if (mobileList) mobileList.innerHTML = '';

      // Mettre √† jour le compteur avec pluriel appropri√©
      const count = employes.length;
      let texteCompteur;
      if (count === 0) {
        texteCompteur = '0 actif';
      } else if (count === 1) {
        texteCompteur = '1 actif';
      } else {
        texteCompteur = `${count} actifs`;
      }
      compteur.textContent = texteCompteur;

      if (employes.length === 0) {
        // Afficher √©tat vide pour desktop
        tableBody.innerHTML = `
          <tr class="empty-state-row">
            <td colspan="5" class="empty-state">
              <i class="fas fa-user-check" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
              <p style="font-size: 1rem;">Aucun employ√© actif</p>
            </td>
          </tr>
        `;

        // Afficher √©tat vide pour mobile
        if (mobileList) {
          mobileList.innerHTML = `
            <div class="employes-empty-mobile">
              <i class="fas fa-user-check"></i>
              <p>Aucun employ√© actif</p>
            </div>
          `;
        }
        return;
      }

      employes.forEach(employe => {
        const nomComplet = `${employe.prenom || ''} ${employe.nom || ''}`.trim();
        const userRole = localStorage.getItem('userRole') || window.userRole || '';

        // INACTIVATION - V√©rifier les diff√©rents cas selon le r√¥le
        // Coach/direction avec "Inactivation en attente de validation" -> bouton V√©rifier
        // Coach/direction avec "Inactivation en attente comptable" -> spinner
        // Entrepreneur avec inactivation -> toujours spinner
        const estCoachAvecInactivationEnAttente = ((userRole === 'coach' || userRole === 'direction') && employe.statut === 'Inactivation en attente de validation');
        const estCoachAvecInactivationComptable = ((userRole === 'coach' || userRole === 'direction') && employe.statut === 'Inactivation en attente comptable');
        const estEntrepreneurAvecInactivation = (userRole === 'entrepreneur' && (employe.statut === 'Inactivation en attente de validation' || employe.statut === 'Inactivation en attente comptable'));

        // MODIFICATION - V√©rifier si l'employ√© est en attente de modification
        // Coach/direction avec "Modification en attente de validation" -> bouton V√©rifier modification
        // Coach/direction avec "Modification en attente comptable" -> spinner
        // Entrepreneur avec modification -> toujours spinner
        const estCoachAvecModificationEnAttente = ((userRole === 'coach' || userRole === 'direction') && employe.statut === 'Modification en attente de validation');
        const estCoachAvecModificationComptable = ((userRole === 'coach' || userRole === 'direction') && employe.statut === 'Modification en attente comptable');
        const estEntrepreneurAvecModification = (userRole === 'entrepreneur' && (employe.statut === 'Modification en attente de validation' || employe.statut === 'Modification en attente comptable'));

        // REFUS - V√©rifier les diff√©rents types de refus
        const estModificationRefusee = employe.statut === 'Modification refus√©e';
        const estFinEmploiRefusee = employe.statut === "Fin d'emploi refus√©e";
        const estReactivationRefusee = employe.statut === 'R√©activation refus√©e';
        const estRefuseActif = estModificationRefusee || estFinEmploiRefusee || estReactivationRefusee;

        // D√©terminer le texte du spinner selon le statut
        let spinnerTexte = '';
        if (employe.statut === 'Inactivation en attente de validation') {
          spinnerTexte = 'En attente de validation coach';
        } else if (employe.statut === 'Inactivation en attente comptable') {
          spinnerTexte = 'En attente de validation comptable';
        } else if (employe.statut === 'Modification en attente de validation') {
          spinnerTexte = 'Modification en attente coach';
        } else if (employe.statut === 'Modification en attente comptable') {
          spinnerTexte = 'Modification en attente comptable';
        }

        // D√©terminer le motif et la date de refus selon le type
        let motifRefusActif = '';
        let dateRefusActif = '';
        let typeRefusActif = '';
        if (estModificationRefusee) {
          motifRefusActif = employe.motif_refus_modification || 'Aucune raison sp√©cifi√©e';
          dateRefusActif = employe.date_refus_modification || '';
          typeRefusActif = 'Modification refus√©e';
        } else if (estFinEmploiRefusee) {
          motifRefusActif = employe.motif_refus_inactivation || 'Aucune raison sp√©cifi√©e';
          dateRefusActif = employe.date_refus_inactivation || '';
          typeRefusActif = "Fin d'emploi refus√©e";
        } else if (estReactivationRefusee) {
          motifRefusActif = employe.motif_refus_reactivation || 'Aucune raison sp√©cifi√©e';
          dateRefusActif = employe.date_refus_reactivation || '';
          typeRefusActif = 'R√©activation refus√©e';
        }

        // D√©terminer si les boutons doivent √™tre d√©sactiv√©s (en attente)
        const estEnAttenteActifs = estEntrepreneurAvecInactivation || estCoachAvecInactivationComptable || estEntrepreneurAvecModification || estCoachAvecModificationComptable;
        const btnDisabledClassActifs = estEnAttenteActifs ? 'btn-disabled' : '';

        // Vue Desktop: Table row (5 colonnes: Nom, Courriel, Poste, Action, Statut)
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${nomComplet}</td>
          <td>${employe.courriel || ''}</td>
          <td>${employe.posteService || employe.poste || ''}</td>
          <td class="text-center" style="text-align: center;">
            ${estCoachAvecInactivationEnAttente
              ? `<button class="btn-primary btn-verifier-inactivation" data-employe-id="${employe.id}" style="background: #f59e0b !important; border-color: #f59e0b !important;">V√©rifier</button>`
              : estCoachAvecModificationEnAttente
              ? `<button class="btn-primary btn-verifier-modification" data-employe-id="${employe.id}" style="background: #f59e0b !important; border-color: #f59e0b !important;">V√©rifier</button>`
              : `<div style="display: flex; gap: 0.4rem; justify-content: center;">
                   <button class="btn-secondary ${btnDisabledClassActifs}" ${estEnAttenteActifs ? '' : `onclick="voirInfoEmploye('${employe.id}')"`}>Info</button>
                   <button class="btn-secondary ${btnDisabledClassActifs}" ${estEnAttenteActifs ? '' : `onclick="modifierEmploye('${employe.id}')"`}>Modifier</button>
                   <button class="btn-primary ${btnDisabledClassActifs}" ${estEnAttenteActifs ? '' : `onclick="terminerEmploye('${employe.id}')"`}>Fin d'emploi</button>
                 </div>`
            }
          </td>
          <td class="text-center" style="text-align: center;">
            ${(estEntrepreneurAvecInactivation || estCoachAvecInactivationComptable || estCoachAvecInactivationEnAttente)
              ? `<div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                   <span class="status-badge active"><i class="fas fa-check-circle"></i> Actif</span>
                   <div class="status-pending">
                     <i class="fas fa-spinner fa-spin"></i>
                     <span>Inactivation en attente</span>
                   </div>
                 </div>`
              : (estEntrepreneurAvecModification || estCoachAvecModificationComptable || estCoachAvecModificationEnAttente)
              ? `<div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                   <span class="status-badge active"><i class="fas fa-check-circle"></i> Actif</span>
                   <div class="status-pending">
                     <i class="fas fa-spinner fa-spin"></i>
                     <span>Modification en attente</span>
                   </div>
                 </div>`
              : estRefuseActif
              ? `<span class="status-badge refused btn-voir-refus-actif" data-motif="${motifRefusActif.replace(/"/g, '&quot;')}" data-date="${dateRefusActif}" data-nom="${nomComplet.replace(/"/g, '&quot;')}" data-type="${typeRefusActif}" data-employe-id="${employe.id}" data-refuse-par="Comptable"><i class="fas fa-eye"></i> ${typeRefusActif}</span>`
              : `<span class="status-badge active"><i class="fas fa-check-circle"></i> Actif</span>`
            }
          </td>
        `;

        // Ajouter le listener pour le bouton V√©rifier inactivation (coach)
        if (estCoachAvecInactivationEnAttente) {
          const btnVerifier = row.querySelector('.btn-verifier-inactivation');
          if (btnVerifier) {
            btnVerifier.addEventListener('click', () => {
              ouvrirPopupValidationInactivation(employe.id, employe);
            });
          }
        }

        // Ajouter le listener pour le bouton V√©rifier modification (coach)
        if (estCoachAvecModificationEnAttente) {
          const btnVerifierModif = row.querySelector('.btn-verifier-modification');
          if (btnVerifierModif) {
            btnVerifierModif.addEventListener('click', () => {
              ouvrirPopupValidationModification(employe.id, employe);
            });
          }
        }

        // Ajouter listener pour voir la raison du refus (badge cliquable) - actifs
        if (estRefuseActif) {
          const btnVoirRefusActif = row.querySelector('.btn-voir-refus-actif');
          if (btnVoirRefusActif) {
            btnVoirRefusActif.addEventListener('click', () => {
              const motif = btnVoirRefusActif.dataset.motif;
              const date = btnVoirRefusActif.dataset.date;
              const nom = btnVoirRefusActif.dataset.nom;
              const employeId = btnVoirRefusActif.dataset.employeId;
              const refusePar = btnVoirRefusActif.dataset.refusePar;
              ouvrirModalVoirRefus(motif, date, nom, employeId, refusePar);
            });
          }
        }

        tableBody.appendChild(row);

        // Vue Mobile: Card
        if (mobileList) {
          const card = document.createElement('div');
          card.className = 'employe-mobile-card';
          card.innerHTML = `
            <div class="employe-card-header">
              <div style="flex: 1;">
                <div class="employe-card-nom">${nomComplet}</div>
                <div class="employe-card-info">
                  <i class="fas fa-envelope"></i>
                  <span>${employe.courriel || '-'}</span>
                </div>
                <div class="employe-card-info">
                  <span class="employe-card-poste">${employe.posteService || employe.poste || '-'}</span>
                </div>
              </div>
            </div>
            ${estCoachAvecInactivationEnAttente
              ? `<div class="employe-card-actions" style="justify-content: center;">
                   <button class="btn-verifier-inactivation-mobile" data-employe-id="${employe.id}" style="background: #f59e0b !important; border-color: #f59e0b !important; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; gap: 0.4rem;">
                     <i class="fas fa-user-times"></i> V√©rifier
                   </button>
                 </div>`
              : estCoachAvecModificationEnAttente
              ? `<div class="employe-card-actions" style="justify-content: center;">
                   <button class="btn-verifier-modification-mobile" data-employe-id="${employe.id}" style="background: #f59e0b !important; border-color: #f59e0b !important; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; gap: 0.4rem;">
                     <i class="fas fa-user-edit"></i> V√©rifier
                   </button>
                 </div>`
              : (estEntrepreneurAvecInactivation || estCoachAvecInactivationComptable)
              ? `<div class="employe-card-actions" style="justify-content: center;">
                   <div class="status-pending">
                     <i class="fas fa-spinner fa-spin"></i>
                     <span>Inactivation en attente</span>
                   </div>
                 </div>`
              : (estEntrepreneurAvecModification || estCoachAvecModificationComptable)
              ? `<div class="employe-card-actions" style="justify-content: center;">
                   <div class="status-pending">
                     <i class="fas fa-spinner fa-spin"></i>
                     <span>Modification en attente</span>
                   </div>
                 </div>`
              : estRefuseActif
              ? `<div class="employe-card-actions" style="flex-wrap: wrap; gap: 0.4rem; justify-content: center;">
                   <span class="status-badge refused btn-voir-refus-actif-mobile" data-motif="${motifRefusActif.replace(/"/g, '&quot;')}" data-date="${dateRefusActif}" data-nom="${nomComplet.replace(/"/g, '&quot;')}" data-employe-id="${employe.id}" data-refuse-par="Comptable"><i class="fas fa-times-circle"></i> ${typeRefusActif}</span>
                   <button class="btn-reason btn-voir-refus-actif-mobile-btn" data-motif="${motifRefusActif.replace(/"/g, '&quot;')}" data-date="${dateRefusActif}" data-nom="${nomComplet.replace(/"/g, '&quot;')}" data-employe-id="${employe.id}" data-refuse-par="Comptable">Voir</button>
                 </div>`
              : `<div class="employe-card-actions">
                   <button onclick="voirInfoEmploye('${employe.id}')" class="employe-action-btn edit-btn" style="font-size: 0.7rem; padding: 0.35rem 0.5rem;">
                     <i class="fas fa-info-circle"></i> Info
                   </button>
                   <button onclick="modifierEmploye('${employe.id}')" class="employe-action-btn edit-btn" style="font-size: 0.7rem; padding: 0.35rem 0.5rem;">
                     <i class="fas fa-edit"></i> Modifier
                   </button>
                   <button onclick="terminerEmploye('${employe.id}')" class="employe-action-btn terminate-btn" style="font-size: 0.7rem; padding: 0.35rem 0.5rem;">
                     <i class="fas fa-user-times"></i> Fin
                   </button>
                 </div>`
            }
          `;

          // Ajouter le listener pour le bouton V√©rifier inactivation mobile (coach)
          if (estCoachAvecInactivationEnAttente) {
            const btnVerifierMobile = card.querySelector('.btn-verifier-inactivation-mobile');
            if (btnVerifierMobile) {
              btnVerifierMobile.addEventListener('click', () => {
                ouvrirPopupValidationInactivation(employe.id, employe);
              });
            }
          }

          // Ajouter le listener pour le bouton V√©rifier modification mobile (coach)
          if (estCoachAvecModificationEnAttente) {
            const btnVerifierModifMobile = card.querySelector('.btn-verifier-modification-mobile');
            if (btnVerifierModifMobile) {
              btnVerifierModifMobile.addEventListener('click', () => {
                ouvrirPopupValidationModification(employe.id, employe);
              });
            }
          }

          // Ajouter listener pour voir la raison du refus mobile (badge ou bouton cliquable)
          if (estRefuseActif) {
            const btnVoirRefusMobile = card.querySelector('.btn-voir-refus-actif-mobile-btn');
            if (btnVoirRefusMobile) {
              btnVoirRefusMobile.addEventListener('click', () => {
                const motif = btnVoirRefusMobile.dataset.motif;
                const date = btnVoirRefusMobile.dataset.date;
                const nom = btnVoirRefusMobile.dataset.nom;
                const employeId = btnVoirRefusMobile.dataset.employeId;
                const refusePar = btnVoirRefusMobile.dataset.refusePar;
                ouvrirModalVoirRefus(motif, date, nom, employeId, refusePar);
              });
            }
          }

          mobileList.appendChild(card);
        }
      });
    }
    
    function afficherEmployesTermines(employes) {
      const tableBody = document.querySelector('.employes-termines-body');
      const mobileList = document.getElementById('employes-termines-mobile-list');
      const compteur = document.getElementById('compteur-termines');

      tableBody.innerHTML = '';
      if (mobileList) mobileList.innerHTML = '';

      // Mettre √† jour le compteur avec pluriel appropri√©
      const count = employes.length;
      let texteCompteur;
      if (count === 0) {
        texteCompteur = '0 inactif';
      } else if (count === 1) {
        texteCompteur = '1 inactif';
      } else {
        texteCompteur = `${count} inactifs`;
      }
      compteur.textContent = texteCompteur;

      if (employes.length === 0) {
        // Afficher √©tat vide pour desktop
        tableBody.innerHTML = `
          <tr class="empty-state-row">
            <td colspan="5" class="empty-state">
              <i class="fas fa-user-times" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
              <p style="font-size: 1rem;">Aucun employ√© inactif</p>
            </td>
          </tr>
        `;

        // Afficher √©tat vide pour mobile
        if (mobileList) {
          mobileList.innerHTML = `
            <div class="employes-empty-mobile">
              <i class="fas fa-user-times"></i>
              <p>Aucun employ√© inactif</p>
            </div>
          `;
        }
        return;
      }

      employes.forEach(employe => {
        const nomComplet = `${employe.prenom || ''} ${employe.nom || ''}`.trim();
        const userRole = localStorage.getItem('userRole') || window.userRole || '';

        // R√âACTIVATION - V√©rifier les diff√©rents statuts
        const estReactivationEnAttente = (employe.statut === 'R√©activation en attente de validation');
        const estReactivationComptable = (employe.statut === 'R√©activation en attente comptable');
        const estCoachAvecReactivationEnAttente = ((userRole === 'coach' || userRole === 'direction') && estReactivationEnAttente);
        const estCoachAvecReactivationComptable = ((userRole === 'coach' || userRole === 'direction') && estReactivationComptable);
        const estEntrepreneurAvecReactivation = (userRole === 'entrepreneur' && (estReactivationEnAttente || estReactivationComptable));

        // TERMIN√â PAR COMPTABLE - V√©rifier si c'est une fin d'emploi par comptable
        const estTermineParComptable = (employe.statut === 'Termin√© par comptable');
        const motifFinEmploi = employe.motif_inactivation || employe.motif_fin_emploi || 'Non sp√©cifi√©';
        const justificatifFinEmploi = employe.justificatif_inactivation || 'Aucun justificatif';
        const dateFinEmploi = employe.date_inactivation || employe.date_fin_emploi || '-';
        const estDejaVu = estFinEmploiComptableVu(employe.id);

        // D√©terminer le texte du spinner selon le statut
        let spinnerTexteReactivation = '';
        if (estReactivationEnAttente) {
          spinnerTexteReactivation = 'R√©activation en attente';
        } else if (estReactivationComptable) {
          spinnerTexteReactivation = 'R√©activation en attente comptable';
        }

        // D√©terminer si les boutons doivent √™tre d√©sactiv√©s (en attente)
        const estEnAttente = estReactivationEnAttente || estReactivationComptable;
        const btnDisabledClass = estEnAttente ? 'btn-disabled' : '';

        // Vue Desktop: Table row (5 colonnes: Nom, Courriel, Poste, Action, Statut)
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${nomComplet}</td>
          <td>${employe.courriel || ''}</td>
          <td>${employe.posteService || employe.poste || ''}</td>
          <td class="text-center" style="text-align: center;">
            ${estCoachAvecReactivationEnAttente
              ? `<button class="btn-primary btn-verifier-reactivation" data-employe-id="${employe.id}" style="background: #f59e0b !important; border-color: #f59e0b !important;">V√©rifier</button>`
              : `<div style="display: flex; gap: 0.4rem; justify-content: center;">
                   <button class="btn-secondary ${btnDisabledClass}" ${estEnAttente ? '' : `onclick="voirDetailsEmploye('${employe.id}')"`}>D√©tails</button>
                   <button class="btn-primary ${btnDisabledClass}" ${estEnAttente ? '' : `onclick="reactiverEmploye('${employe.id}')"`}>R√©activer</button>
                 </div>`
            }
          </td>
          <td class="text-center" style="text-align: center;">
            ${estEnAttente
              ? `<div class="status-pending">
                   <i class="fas fa-spinner fa-spin"></i>
                   <span>${spinnerTexteReactivation}</span>
                 </div>`
              : estTermineParComptable
              ? `<span class="status-badge terminated btn-voir-fin-emploi-comptable" data-nom="${nomComplet.replace(/"/g, '&quot;')}" data-date="${dateFinEmploi}" data-motif="${motifFinEmploi.replace(/"/g, '&quot;')}" data-justificatif="${justificatifFinEmploi.replace(/"/g, '&quot;')}" data-id="${employe.id}"><i class="fas fa-eye"></i> Termin√© par comptable</span>`
              : `<span class="status-badge terminated btn-voir-fin-emploi-moi" data-nom="${nomComplet.replace(/"/g, '&quot;')}" data-date="${employe.date_inactivation || '-'}" data-motif="${(employe.motif_inactivation || 'Non sp√©cifi√©').replace(/"/g, '&quot;')}" data-justificatif="${(employe.justificatif_inactivation || 'Aucun justificatif').replace(/"/g, '&quot;')}" data-id="${employe.id}"><i class="fas fa-eye"></i> Termin√© par moi</span>`
            }
          </td>
        `;
        // Ajouter le listener pour le bouton V√©rifier r√©activation (coach)
        if (estCoachAvecReactivationEnAttente) {
          const btnVerifierReact = row.querySelector('.btn-verifier-reactivation');
          if (btnVerifierReact) {
            btnVerifierReact.addEventListener('click', () => {
              ouvrirPopupValidationReactivation(employe.id, employe);
            });
          }
        }

        // Ajouter le listener pour le badge "Termin√© par comptable"
        if (estTermineParComptable) {
          const btnVoirFinEmploi = row.querySelector('.btn-voir-fin-emploi-comptable');
          if (btnVoirFinEmploi) {
            btnVoirFinEmploi.addEventListener('click', function() {
              const nom = this.getAttribute('data-nom');
              const date = this.getAttribute('data-date');
              const motif = this.getAttribute('data-motif');
              const justificatif = this.getAttribute('data-justificatif');
              const id = this.getAttribute('data-id');
              ouvrirModalVoirFinEmploiComptable(nom, date, motif, justificatif, id);
            });
          }
        }

        // Ajouter le listener pour le badge "Termin√© par moi"
        if (!estTermineParComptable && !estEnAttente) {
          const btnVoirFinEmploiMoi = row.querySelector('.btn-voir-fin-emploi-moi');
          if (btnVoirFinEmploiMoi) {
            btnVoirFinEmploiMoi.addEventListener('click', function() {
              const nom = this.getAttribute('data-nom');
              const date = this.getAttribute('data-date');
              const motif = this.getAttribute('data-motif');
              const justificatif = this.getAttribute('data-justificatif');
              const id = this.getAttribute('data-id');
              ouvrirModalVoirFinEmploiMoi(nom, date, motif, justificatif);
            });
          }
        }

        tableBody.appendChild(row);

        // Vue Mobile: Card
        if (mobileList) {
          const card = document.createElement('div');
          card.className = 'employe-mobile-card';
          card.innerHTML = `
            <div class="employe-card-header">
              <div style="flex: 1;">
                <div class="employe-card-nom">${nomComplet}</div>
                <div class="employe-card-info">
                  <i class="fas fa-envelope"></i>
                  <span>${employe.courriel || '-'}</span>
                </div>
                <div class="employe-card-info">
                  <span class="employe-card-poste">${employe.posteService || employe.poste || '-'}</span>
                </div>
              </div>
            </div>
            ${estTermineParComptable
              ? `<div class="employe-card-actions" style="flex-wrap: wrap; gap: 0.4rem; justify-content: center;">
                   <span class="status-badge terminated"><i class="fas fa-times-circle"></i> Termin√©</span>
                   <button class="btn-reason btn-voir-fin-emploi-comptable-mobile" data-nom="${nomComplet.replace(/"/g, '&quot;')}" data-date="${dateFinEmploi}" data-motif="${motifFinEmploi.replace(/"/g, '&quot;')}" data-justificatif="${justificatifFinEmploi.replace(/"/g, '&quot;')}" data-id="${employe.id}">Voir</button>
                   <button class="btn-primary" onclick="reactiverEmploye('${employe.id}')" style="font-size: 0.7rem; padding: 0.3rem 0.6rem;">
                     <i class="fas fa-user-check" style="font-size: 0.6rem;"></i> R√©activer
                   </button>
                 </div>`
              : estCoachAvecReactivationEnAttente
              ? `<div class="employe-card-actions" style="justify-content: center;">
                   <button class="btn-verifier-reactivation-mobile" style="background-color: #f59e0b !important; border-color: #f59e0b !important; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; gap: 0.4rem;">
                     <i class="fas fa-search"></i> V√©rifier
                   </button>
                 </div>`
              : (estEntrepreneurAvecReactivation || estCoachAvecReactivationComptable)
              ? `<div class="employe-card-actions" style="justify-content: center;">
                   <div class="status-pending">
                     <i class="fas fa-spinner fa-spin"></i>
                     <span>${spinnerTexteReactivation}</span>
                   </div>
                 </div>`
              : `<div class="employe-card-actions">
                   <button onclick="voirDetailsEmploye('${employe.id}')" class="employe-action-btn edit-btn" style="font-size: 0.75rem; padding: 0.4rem 0.6rem;">
                     <i class="fas fa-info-circle"></i> D√©tails
                   </button>
                   <button onclick="reactiverEmploye('${employe.id}')" class="employe-action-btn reactivate-btn" style="font-size: 0.75rem; padding: 0.4rem 0.6rem;">
                     <i class="fas fa-user-check"></i> R√©activer
                   </button>
                 </div>`
            }
          `;
          // Ajouter le listener pour le bouton V√©rifier r√©activation mobile (coach)
          if (estCoachAvecReactivationEnAttente) {
            const btnVerifierReactMobile = card.querySelector('.btn-verifier-reactivation-mobile');
            if (btnVerifierReactMobile) {
              btnVerifierReactMobile.addEventListener('click', () => {
                ouvrirPopupValidationReactivation(employe.id, employe);
              });
            }
          }

          // Ajouter le listener pour le bouton "Voir la raison" mobile (Termin√© par comptable)
          if (estTermineParComptable) {
            const btnVoirFinEmploiMobile = card.querySelector('.btn-voir-fin-emploi-comptable-mobile');
            if (btnVoirFinEmploiMobile) {
              btnVoirFinEmploiMobile.addEventListener('click', function() {
                const nom = this.getAttribute('data-nom');
                const date = this.getAttribute('data-date');
                const motif = this.getAttribute('data-motif');
                const justificatif = this.getAttribute('data-justificatif');
                const id = this.getAttribute('data-id');
                ouvrirModalVoirFinEmploiComptable(nom, date, motif, justificatif, id);
              });
            }
          }

          mobileList.appendChild(card);
        }
      });
    }

    // Fonctions API pour les actions
    async function ajouterNouvelEmployeAPI() {
      try {
        const nouvelEmploye = {
          nom: document.getElementById('nouveauNomComplet').value,
          genre: document.getElementById('nouveauGenre').value,
          courriel: document.getElementById('nouveauCourriel').value,
          telephone: document.getElementById('nouveauTelephone').value,
          poste: document.getElementById('nouveauPoste').value,
        };
        
        const username = window.username || 'user';
        const response = await fetch(`/api/employes/${username}/nouveaux`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(nouvelEmploye)
        });
        
        if (response.ok) {
          const result = await response.json();
          log(result.message);
          fermerModalAjouter();
          chargerEmployes();
        } else {
          const error = await response.json();
          error('Erreur: ' + error.detail);
        }
      } catch (err) {
        error('Erreur:', err);
        error('Erreur lors de l\'ajout de l\'employ√©');
      }
    }
    
    async function refuserEmploye(employeId) {
      try {
        // R√©cup√©rer les donn√©es de l'employ√©
        const username = window.selectedEntrepreneur || window.username || 'user';
        let employeType = null;

        // Chercher d'abord dans les nouveaux
        let response = await fetch(`/api/employes/${username}/nouveaux`);
        let data = await response.json();
        let employes = Array.isArray(data) ? data : (data.nouveaux || data.employes || []);
        let employe = employes.find(e => e.id === employeId);
        if (employe) employeType = 'nouveaux';

        // Si pas trouv√© dans nouveaux, chercher dans actifs
        if (!employe) {
          response = await fetch(`/api/employes/${username}/actifs`);
          data = await response.json();
          employes = Array.isArray(data) ? data : (data.actifs || data.employes || []);
          employe = employes.find(e => e.id === employeId);
          if (employe) employeType = 'actifs';
        }

        // Si pas trouv√© dans actifs, chercher dans r√©activations
        if (!employe) {
          response = await fetch(`/api/employes/${username}/reactivations`);
          data = await response.json();
          employes = Array.isArray(data) ? data : (data.reactivations || data.employes || []);
          employe = employes.find(e => e.id === employeId);
          if (employe) employeType = 'reactivations';
        }

        if (!employe) {
          console.error('Employ√© non trouv√© dans nouveaux, actifs ni r√©activations');
          showNotification('Employ√© non trouv√©', 'error');
          return;
        }

        // Stocker le type pour l'utiliser lors de la confirmation
        employeARefuserType = employeType;

        // Ouvrir le nouveau modal simple
        ouvrirModalRefuserEmploye(employeId, employe.nom || employe.prenom, employe.poste || employe.posteService);
      } catch (err) {
        console.error('Erreur:', err);
      }
    }
    
    // Modifier la fonction confirmerRefus
    async function confirmerRefus() {
      try {
        const employeId = document.getElementById('modalConfirmationRefus').dataset.employeId;
        const username = window.username || 'user';
        
        const response = await fetch(`/api/employes/${username}/nouveaux/${employeId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          const result = await response.json();
          log(result.message);
          fermerModalRefus();
          chargerEmployes();
        } else {
          const error = await response.json();
          error('Erreur: ' + error.detail);
        }
      } catch (err) {
        error('Erreur:', err);
      }
    }
    
    // Fonction pour activer un employ√© via l'API
    async function activerEmployeAPI() {
      const btn = document.getElementById('btn-activer-employe');
      const originalHtml = showButtonSpinner(btn);

      try {
        const employeId = document.getElementById('modalActivation').dataset.employeId;
        const username = window.username || 'user';

        // Cr√©er FormData pour envoyer les fichiers ET les donn√©es
        const formData = new FormData();

        // Ajouter les donn√©es de l'employ√©
        formData.append('nom', document.getElementById('nomComplet').value);
        formData.append('nas', document.getElementById('nas').value);
        formData.append('dateNaissance', document.getElementById('dateNaissance').value);
        formData.append('genre', document.getElementById('genre').value);
        formData.append('adresse', document.getElementById('adresse').value);
        formData.append('appartement', document.getElementById('appartement')?.value || '');
        formData.append('ville', document.getElementById('ville').value);
        formData.append('codePostal', document.getElementById('codePostal').value);
        formData.append('telephone', document.getElementById('telephone').value);
        formData.append('courriel', document.getElementById('courriel').value);
        formData.append('datePremiere', document.getElementById('datePremiere').value);
        formData.append('posteService', document.getElementById('posteService').value);
        formData.append('tauxHoraire', parseFloat(document.getElementById('tauxHoraire').value));

        // Ajouter les fichiers s'ils existent
        const specimenInput = document.getElementById('specimenCheque');
        if (specimenInput && specimenInput.files && specimenInput.files[0]) {
          formData.append('specimen', specimenInput.files[0]);
          log('Fichier sp√©cimen ajout√©:', specimenInput.files[0].name);
        }

        const certificatInput = document.getElementById('certificatSecurite');
        if (certificatInput && certificatInput.files && certificatInput.files[0]) {
          formData.append('certificat', certificatInput.files[0]);
          log('Fichier certificat ajout√©:', certificatInput.files[0].name);
        }

        const carteInput = document.getElementById('carteAssuranceMaladie');
        if (carteInput && carteInput.files && carteInput.files[0]) {
          formData.append('carte', carteInput.files[0]);
          log('Fichier carte ajout√©:', carteInput.files[0].name);
        }

        log('Envoi des donn√©es avec fichiers...');

        const response = await fetch(`/api/employes/${username}/activer/${employeId}`, {
          method: 'POST',
          body: formData
          // Ne PAS mettre Content-Type, le navigateur le fait automatiquement avec multipart/form-data
        });

        log('R√©ponse re√ßue:', response.status);

        if (response.ok) {
          const result = await response.json();
          log('Succ√®s:', result.message);
          fermerModal();

          // Afficher l'animation de succ√®s
          showSuccessAnimation('Employ√© activ√© avec succ√®s!');

          // Notifier le parent (appqecoach) pour mettre √† jour le badge INSTANTAN√âMENT
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
          }

          // Attendre la fin de l'animation avant de recharger
          setTimeout(() => {
            chargerEmployes(); // Recharger toutes les donn√©es

            // Recharger les badges du s√©lecteur d'entrepreneurs
            if (window.EntrepreneurSelector) {
              window.EntrepreneurSelector.reload();
            }
          }, 2000);
        } else {
          hideButtonSpinner(btn, originalHtml);
          const error = await response.json();
          error('Erreur:', error.detail);
          showNotification('Erreur: ' + error.detail, 'error');
        }
      } catch (err) {
        hideButtonSpinner(btn, originalHtml);
        error('Erreur:', err);
        showNotification('Erreur de connexion: ' + error.message, 'error');
      }
    }

    // ===== FONCTIONS POUR LA VALIDATION PAR LE COACH =====

    let currentEmployeValidation = null; // Stocker les donn√©es de l'employ√© en cours de validation

    // Fonction pour ouvrir le visualiseur de document
    function ouvrirDocumentViewer(url, titre) {
      const overlay = document.getElementById('documentViewerOverlay');
      const modal = document.getElementById('documentViewerModal');
      const content = document.getElementById('documentViewerContent');

      if (modal && content && overlay) {
        // D√©terminer le type de fichier
        const extension = url.split('.').pop().toLowerCase();
        const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(extension);
        const isPdf = extension === 'pdf';

        if (isImage) {
          content.innerHTML = `<img src="${url}" alt="${titre || 'Document'}" style="max-width: 100%; max-height: 85vh; object-fit: contain;">`;
        } else if (isPdf) {
          content.innerHTML = `<iframe src="${url}" style="width: 80vw; height: 85vh; border: none;"></iframe>`;
        } else {
          // Par d√©faut, essayer d'afficher comme image ou iframe
          content.innerHTML = `<iframe src="${url}" style="width: 80vw; height: 85vh; border: none;"></iframe>`;
        }

        // Afficher overlay et modal
        overlay.style.display = 'block';
        modal.classList.remove('hidden');

        // Bloquer le scroll de la page
        document.body.style.overflow = 'hidden';
      }
    }

    // Fonction pour fermer le visualiseur de document
    function fermerDocumentViewer() {
      const overlay = document.getElementById('documentViewerOverlay');
      const modal = document.getElementById('documentViewerModal');
      const content = document.getElementById('documentViewerContent');

      if (modal && overlay) {
        modal.classList.add('hidden');
        overlay.style.display = 'none';
        if (content) content.innerHTML = '';
        // R√©activer le scroll de la page
        document.body.style.overflow = '';
      }
    }

    // Fonction pour copier le texte dans le presse-papiers
    function copierTexteValidation(texte, btnElement) {
      navigator.clipboard.writeText(texte).then(() => {
        // Changer l'apparence du bouton
        const originalHTML = btnElement.innerHTML;
        btnElement.innerHTML = '<i class="fas fa-check"></i>';
        btnElement.classList.add('copied');

        // Revenir √† l'√©tat original apr√®s 1.5 secondes
        setTimeout(() => {
          btnElement.innerHTML = originalHTML;
          btnElement.classList.remove('copied');
        }, 1500);
      }).catch(err => {
        error('Erreur lors de la copie:', err);
      });
    }

    // Fonction pour ouvrir le popup de validation
    function ouvrirPopupValidation(employeId, employeDataString) {
      try {
        log('=== OUVERTURE POPUP VALIDATION ===');
        log('employeId:', employeId);
        log('employeDataString:', employeDataString);

        // Parser les donn√©es de l'employ√©
        let employe;
        if (typeof employeDataString === 'string') {
          employe = JSON.parse(employeDataString);
        } else {
          employe = employeDataString;
        }

        log('Donn√©es employ√© pars√©es:', employe);

        // Stocker les donn√©es pour les utiliser dans valider/refuser
        currentEmployeValidation = {
          id: employeId,
          data: employe
        };

        // Remplir les champs du popup
        document.getElementById('validation-nom').textContent = employe.nom || '-';
        document.getElementById('validation-genre').textContent = employe.genre || '-';
        document.getElementById('validation-nas').textContent = employe.nas || '-';

        document.getElementById('validation-courriel').textContent = employe.courriel || '-';
        document.getElementById('validation-telephone').textContent = employe.telephone || '-';

        // Adresse d√©taill√©e (s√©par√©e)
        const appartement = employe.appartement && employe.appartement !== '-' ? `, ${employe.appartement}` : '';
        document.getElementById('validation-adresse').textContent = `${employe.adresse || '-'}${appartement}`;
        document.getElementById('validation-ville').textContent = employe.ville || '-';
        document.getElementById('validation-codePostal').textContent = employe.codePostal || '-';

        document.getElementById('validation-poste').textContent = employe.posteService || employe.poste || '-';
        document.getElementById('validation-taux').textContent = employe.tauxHoraire ? `${employe.tauxHoraire} $/h` : '-';
        document.getElementById('validation-date-premiere').textContent = employe.datePremiere || '-';

        // G√©rer l'affichage des documents
        const entrepreneurUsername = window.selectedEntrepreneur || window.username;

        // Sp√©cimen ch√®que
        const specimenElement = document.getElementById('validation-specimen');
        if (specimenElement) {
          if (employe.specimen) {
            specimenElement.innerHTML = `<a href="#" onclick="openFileModal('/api/employes/${entrepreneurUsername}/documents/${employeId}/${employe.specimen}'); return false;" class="flex items-center gap-2 text-xs px-3 py-1.5 rounded-full transition-all" style="background: rgba(96, 165, 250, 0.15); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3);" onmouseover="this.style.background='rgba(96, 165, 250, 0.25)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.15)'"><i class="fas fa-eye"></i> Voir</a>`;
          } else {
            specimenElement.innerHTML = '<span style="color: rgba(148, 163, 184, 0.5);">Aucun</span>';
          }
        }

        // Certificat s√©curit√©
        const certificatElement = document.getElementById('validation-certificat');
        if (certificatElement) {
          if (employe.certificat) {
            certificatElement.innerHTML = `<a href="#" onclick="openFileModal('/api/employes/${entrepreneurUsername}/documents/${employeId}/${employe.certificat}'); return false;" class="flex items-center gap-2 text-xs px-3 py-1.5 rounded-full transition-all" style="background: rgba(96, 165, 250, 0.15); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3);" onmouseover="this.style.background='rgba(96, 165, 250, 0.25)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.15)'"><i class="fas fa-eye"></i> Voir</a>`;
          } else {
            certificatElement.innerHTML = '<span style="color: rgba(148, 163, 184, 0.5);">Aucun</span>';
          }
        }

        // Carte assurance maladie
        const carteElement = document.getElementById('validation-carte');
        if (carteElement) {
          if (employe.carte) {
            carteElement.innerHTML = `<a href="#" onclick="openFileModal('/api/employes/${entrepreneurUsername}/documents/${employeId}/${employe.carte}'); return false;" class="flex items-center gap-2 text-xs px-3 py-1.5 rounded-full transition-all" style="background: rgba(96, 165, 250, 0.15); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3);" onmouseover="this.style.background='rgba(96, 165, 250, 0.25)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.15)'"><i class="fas fa-eye"></i> Voir</a>`;
          } else {
            carteElement.innerHTML = '<span style="color: rgba(148, 163, 184, 0.5);">Aucun</span>';
          }
        }

        // Afficher le modal
        const modal = document.getElementById('modalValidationEmploye');
        if (modal) {
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
        }

        // IMPORTANT: R√©activer le bouton Valider pour permettre la validation de plusieurs employ√©s cons√©cutifs
        const btnValider = document.getElementById('btn-valider-employe');
        if (btnValider) {
          btnValider.disabled = false;
          btnValider.style.opacity = '1';
          btnValider.style.cursor = 'pointer';
          // Restaurer le HTML original du bouton (sans spinner)
          btnValider.innerHTML = `
            <span id="btn-valider-text">Valider</span>
            <span id="btn-valider-icon" style="display: none;">
              <i class="fas fa-check-circle"></i>
            </span>
          `;
        }

        log('Popup de validation ouvert avec succ√®s');
      } catch (err) {
        error('Erreur lors de l\'ouverture du popup de validation:', error);
        showNotification('Erreur lors de l\'ouverture du popup de validation', 'error');
      }
    }

    // Fonction pour fermer le popup de validation
    window.fermerPopupValidation = function() {
      const modal = document.getElementById('modalValidationEmploye');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }
      currentEmployeValidation = null;
    };

    // === HELPER FUNCTIONS POUR SPINNERS SUR BOUTONS ===

    // Afficher un spinner sur un bouton pendant le chargement
    function showButtonSpinner(button) {
      if (!button) return null;

      // Sauvegarder le HTML original
      const originalHtml = button.innerHTML;

      // D√©sactiver le bouton
      button.disabled = true;
      button.style.opacity = '0.7';
      button.style.cursor = 'not-allowed';

      // Afficher le spinner
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement...';

      return originalHtml;
    }

    // Cacher le spinner et restaurer le bouton
    function hideButtonSpinner(button, originalHtml) {
      if (!button || !originalHtml) return;

      // R√©activer le bouton
      button.disabled = false;
      button.style.opacity = '1';
      button.style.cursor = 'pointer';

      // Restaurer le HTML original
      button.innerHTML = originalHtml;
    }

    // Fonction pour afficher l'animation de succ√®s
    function showSuccessAnimation(message) {
      const overlay = document.createElement('div');
      overlay.className = 'success-overlay';
      overlay.innerHTML = `
        <div class="success-content">
          <div class="success-checkmark">
            <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
              <path d="M8 20 L16 28 L32 12" stroke="white" stroke-width="3"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">${message}</h2>
        </div>
      `;

      document.body.appendChild(overlay);

      // Supprimer l'overlay apr√®s l'animation
      setTimeout(() => {
        overlay.remove();
      }, 1500);
    }

    // Fonction pour valider l'employ√© avec animation (coach)
    async function validerEmployeCoachAvecAnimation() {
      if (!currentEmployeValidation) {
        return validerEmployeCoach();
      }

      // Afficher le spinner sur le bouton
      const btn = document.getElementById('btn-valider-employe');
      const originalHtml = showButtonSpinner(btn);

      try {
        // Appeler la fonction de validation
        await validerEmployeCoach();
      } finally {
        // Note: Le bouton sera r√©activ√© lors de la r√©ouverture du popup pour le prochain employ√©
        // On ne restaure pas ici car le popup va se fermer
      }
    }

    // Fonction pour valider l'employ√© (coach)
    async function validerEmployeCoach() {
      try {
        if (!currentEmployeValidation) {
          error('Aucun employ√© en cours de validation');
          return;
        }

        log('=== VALIDATION EMPLOY√â PAR LE COACH ===');
        log('Employ√© √† valider:', currentEmployeValidation);

        const employeId = currentEmployeValidation.id;
        const entrepreneurUsername = window.selectedEntrepreneur || window.username;

        log('ID employ√©:', employeId);
        log('Username entrepreneur:', entrepreneurUsername);

        // Appeler l'API pour valider l'employ√©
        const response = await fetch(`/api/employes/${entrepreneurUsername}/valider/${employeId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        log('R√©ponse API validation:', response.status);

        if (response.ok) {
          const result = await response.json();
          log('Succ√®s validation:', result.message);

          // Fermer le popup
          fermerPopupValidation();

          // Afficher l'animation de succ√®s
          showSuccessAnimation('Employ√© valid√© avec succ√®s!');

          // Attendre la fin de l'animation avant de recharger
          setTimeout(() => {
            // Recharger la liste des employ√©s
            chargerEmployes();

            // Recharger les badges du s√©lecteur d'entrepreneurs
            if (window.EntrepreneurSelector) {
              window.EntrepreneurSelector.reload();
            }

            // Notifier le parent (apppccoach) pour rafra√Æchir le badge
            window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
          }, 1500);
        } else {
          const error = await response.json();
          error('Erreur validation:', error.detail);
          showNotification('Erreur: ' + error.detail, 'error');
        }
      } catch (err) {
        error('Erreur lors de la validation:', err);
        showNotification('Erreur de connexion: ' + error.message, 'error');
      }
    }

    // Ouvrir le modal de refus coach
    function ouvrirModalRefusCoach() {
      if (!currentEmployeValidation) {
        error('Aucun employ√© en cours de validation');
        return;
      }
      document.getElementById('motifRefusCoach').value = '';
      document.getElementById('modalRefusCoach').style.display = 'flex';
    }

    // Fermer le modal de refus coach
    function fermerModalRefusCoach() {
      document.getElementById('modalRefusCoach').style.display = 'none';
      document.getElementById('motifRefusCoach').value = '';
    }

    // Confirmer le refus avec la raison
    async function confirmerRefusCoach() {
      if (!currentEmployeValidation) {
        error('Aucun employ√© en cours de validation');
        return;
      }

      const motifRefus = document.getElementById('motifRefusCoach').value.trim();
      if (!motifRefus) {
        showNotification('Veuillez indiquer la raison du refus', 'error');
        return;
      }

      const employeNom = currentEmployeValidation.data.nom;
      const employeId = currentEmployeValidation.id;
      const entrepreneurUsername = window.selectedEntrepreneur || window.username;

      try {
        log('=== REFUS EMPLOY√â PAR LE COACH ===');
        log('Employ√© √† refuser:', currentEmployeValidation);
        log('ID employ√©:', employeId);
        log('Username entrepreneur:', entrepreneurUsername);
        log('Motif du refus:', motifRefus);

        // Appeler l'API pour refuser l'employ√© avec la raison
        const response = await fetch(`/api/employes/${entrepreneurUsername}/refuser/${employeId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ motif_refus: motifRefus })
        });

        log('R√©ponse API refus:', response.status);

        if (response.ok) {
          const result = await response.json();
          log('Succ√®s refus:', result.message);

          // Fermer les popups
          fermerModalRefusCoach();
          fermerPopupValidation();

          // Afficher l'animation de succ√®s
          showSuccessAnimation('Employ√© refus√© avec succ√®s!');

          // Attendre la fin de l'animation avant de recharger
          setTimeout(() => {
            // Recharger la liste des employ√©s
            chargerEmployes();

            // Recharger les badges du s√©lecteur d'entrepreneurs
            if (window.EntrepreneurSelector) {
              window.EntrepreneurSelector.reload();
            }
          }, 2000);

          // Notifier le parent (apppccoach) pour rafra√Æchir le badge
          window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');

          showNotification('Candidature refus√©e', 'success');
        } else {
          const error = await response.json();
          error('Erreur refus:', error.detail);
          showNotification('Erreur: ' + error.detail, 'error');
        }
      } catch (err) {
        error('Erreur lors du refus:', err);
        showNotification('Erreur de connexion: ' + error.message, 'error');
      }
    }

    // Ancienne fonction pour compatibilit√© (redirige vers le nouveau modal)
    function refuserEmployeCoach() {
      ouvrirModalRefusCoach();
    }

    // Fonction pour calculer le temps relatif (il y a X jours, heures, minutes)
    function tempsRelatif(dateString) {
      if (!dateString || dateString === '-') return '-';

      let date;
      // Essayer de parser la date
      if (dateString.includes(' ')) {
        // Format "2025-12-06 13:35:04"
        date = new Date(dateString.replace(' ', 'T'));
      } else if (dateString.includes('/')) {
        // Format "06/12/2025"
        const parts = dateString.split('/');
        date = new Date(parts[2], parts[1] - 1, parts[0]);
      } else {
        // Format "2025-12-06"
        date = new Date(dateString);
      }

      if (isNaN(date.getTime())) return dateString;

      const maintenant = new Date();
      const diffMs = maintenant - date;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHeure = Math.floor(diffMin / 60);
      const diffJour = Math.floor(diffHeure / 24);

      if (diffMin < 1) return "√Ä l'instant";
      if (diffMin < 60) return `Il y a ${diffMin} minute${diffMin > 1 ? 's' : ''}`;
      if (diffHeure < 24) return `Il y a ${diffHeure} heure${diffHeure > 1 ? 's' : ''}`;
      if (diffJour === 1) return "Hier";
      if (diffJour < 30) return `Il y a ${diffJour} jour${diffJour > 1 ? 's' : ''}`;

      // Plus de 30 jours, afficher la date
      return date.toLocaleDateString('fr-CA');
    }

    // Ouvrir le modal pour voir la raison du refus (entrepreneur)
    // Variable pour stocker le contexte du refus actuel
    let currentRefusContext = {
      employeId: null,
      employeNom: null,
      conversation: [],
      refusePar: null // 'Coach' ou 'Comptable'
    };

    // Ouvrir le modal pour voir la raison du refus avec conversation
    async function ouvrirModalVoirRefus(motif, date, nom, employeId = null, refusePar = null) {
      document.getElementById('refuseNom').textContent = nom || '-';

      // Stocker le contexte
      currentRefusContext.employeId = employeId;
      currentRefusContext.employeNom = nom;
      currentRefusContext.refusePar = refusePar; // 'Coach' ou 'Comptable'

      // Charger la conversation depuis l'API ou utiliser le motif initial
      const container = document.getElementById('refusConversationContainer');

      if (employeId) {
        try {
          const username = window.selectedEntrepreneur || window.username;
          const response = await fetch(`/api/employes/${username}/refus-conversation/${employeId}`);
          if (response.ok) {
            const data = await response.json();
            currentRefusContext.conversation = data.conversation || [];
          } else {
            // Si pas de conversation, cr√©er avec le motif initial
            currentRefusContext.conversation = [{
              de: 'comptable',
              message: motif || 'Aucune raison sp√©cifi√©e',
              date: date || new Date().toISOString()
            }];
          }
        } catch (err) {
          error('Erreur chargement conversation:', err);
          currentRefusContext.conversation = [{
            de: 'comptable',
            message: motif || 'Aucune raison sp√©cifi√©e',
            date: date || new Date().toISOString()
          }];
        }
      } else {
        // Pas d'employeId, utiliser le motif comme premier message
        currentRefusContext.conversation = [{
          de: 'comptable',
          message: motif || 'Aucune raison sp√©cifi√©e',
          date: date || new Date().toISOString()
        }];
      }

      // Afficher la conversation
      afficherConversationRefus();

      // Marquer tous les messages comme lus
      if (employeId) {
        const username = window.selectedEntrepreneur || window.username;
        fetch(`/api/refus-conversation/${username}/${employeId}/mark-all-read`, {
          method: 'POST'
        }).then(() => {
          // Retirer le badge de l'employ√©
          delete refusUnreadCounts[employeId];
          updateRefusBadges();
        }).catch(err => error('Erreur marquage messages lus:', err));
      }

      document.getElementById('modalVoirRefus').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    // Afficher les messages de la conversation
    function afficherConversationRefus() {
      const container = document.getElementById('refusConversationContainer');
      const conversation = currentRefusContext.conversation;

      if (!conversation || conversation.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: var(--text-gray);">
            <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
            <p>Aucun message</p>
          </div>
        `;
        return;
      }

      // D√©terminer qui est "Vous" (celui connect√©)
      const userRole = localStorage.getItem('userRole');
      const isCoachOrDirection = userRole === 'coach' || userRole === 'direction';

      container.innerHTML = conversation.map((msg, index) => {
        let sender, cssClass;

        // IMPORTANT: Le premier message de refus d'un coach/direction est parfois marqu√© comme 'comptable' au lieu de 'coach'
        // Si c'est le premier message ET que l'utilisateur est coach/direction, c'est son propre message de refus initial
        const isPremierMessageCoach = (index === 0 && isCoachOrDirection && msg.de === 'comptable');

        // IMPORTANT: Quand entrepreneur voit le premier message, v√©rifier si c'est du coach ou direction
        const isPremierMessageDeRefus = (index === 0 && !isCoachOrDirection && msg.de === 'comptable');

        if (isPremierMessageCoach) {
          // Premier message de refus du coach = afficher "Vous" √† droite
          sender = 'Vous';
          cssClass = 'from-entrepreneur';
        } else if (isPremierMessageDeRefus) {
          // Premier message vu par entrepreneur - utiliser currentRefusContext.refusePar pour savoir qui a refus√©
          if (currentRefusContext.refusePar === 'Coach') {
            // C'est le refus initial du coach
            if (msg.sender_name || msg.nom || msg.coach_name) {
              sender = `Coach (${msg.sender_name || msg.nom || msg.coach_name})`;
            } else {
              sender = 'Coach';
            }
          } else {
            // C'est un refus de la direction
            if (msg.sender_name || msg.nom) {
              sender = `Direction (${msg.sender_name || msg.nom})`;
            } else {
              sender = 'Direction';
            }
          }
          cssClass = 'from-comptable';
        } else if (msg.de === 'comptable' || msg.de === 'direction') {
          // Messages de la direction - afficher le nom si disponible
          if (msg.sender_name || msg.nom) {
            sender = `Direction (${msg.sender_name || msg.nom})`;
          } else {
            sender = 'Direction';
          }
          cssClass = 'from-comptable';
        } else if (msg.de === 'coach') {
          sender = isCoach ? 'Vous' : 'Coach';
          cssClass = isCoach ? 'from-entrepreneur' : 'from-comptable';
        } else {
          sender = isCoach ? 'Entrepreneur' : 'Vous';
          cssClass = isCoach ? 'from-comptable' : 'from-entrepreneur';
        }

        return `
          <div class="refus-chat-message ${cssClass}">
            <div class="refus-chat-bubble">
              <div class="refus-sender">${sender}</div>
              <div class="refus-text">${msg.message}</div>
              <div class="refus-time">${tempsRelatif(msg.date)}</div>
            </div>
          </div>
        `;
      }).join('');

      // Scroller vers le bas
      container.scrollTop = container.scrollHeight;
    }

    // Envoyer une r√©ponse au refus
    async function envoyerReponseRefus() {
      const input = document.getElementById('refusMessageInput');
      const message = input.value.trim();

      if (!message) return;

      const employeId = currentRefusContext.employeId;
      if (!employeId) {
        showNotification('Erreur: ID employ√© manquant', 'error');
        return;
      }

      try {
        // D√©terminer qui envoie le message
        const userRole = localStorage.getItem('userRole') || window.userRole || '';
        const expediteur = userRole === 'coach' ? 'coach' : 'entrepreneur';

        const username = window.selectedEntrepreneur || window.username;
        const response = await fetch(`/api/employes/${username}/refus-conversation/${employeId}/message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, de: expediteur })
        });

        if (!response.ok) {
          throw new Error('Erreur lors de l\'envoi');
        }

        // Ajouter le message localement
        currentRefusContext.conversation.push({
          de: expediteur,
          message: message,
          date: new Date().toISOString()
        });

        // Vider l'input et rafra√Æchir
        input.value = '';
        afficherConversationRefus();

      } catch (err) {
        error('Erreur envoi message:', err);
        showNotification('Erreur lors de l\'envoi du message', 'error');
      }
    }

    // Fermer le modal de visualisation du refus
    function fermerModalVoirRefus() {
      document.getElementById('modalVoirRefus').style.display = 'none';
      document.body.style.overflow = '';
      document.getElementById('refusMessageInput').value = '';
      currentRefusContext = { employeId: null, employeNom: null, conversation: [], refusePar: null };
    }

    // Ouvrir le modal pour voir la fin d'emploi par comptable
    function ouvrirModalVoirFinEmploiComptable(nom, date, motif, justificatif, employeId) {
      document.getElementById('finEmploiComptableNom').textContent = nom || '-';
      document.getElementById('finEmploiComptableDate').textContent = tempsRelatif(date);
      document.getElementById('finEmploiComptableMotif').textContent = motif || 'Non sp√©cifi√©';
      document.getElementById('finEmploiComptableJustificatif').textContent = justificatif || 'Aucun justificatif';
      document.getElementById('modalVoirFinEmploiComptable').style.display = 'flex';

      // Marquer comme vu
      if (employeId) {
        marquerFinEmploiComptableVu(employeId);
      }
    }

    // Fermer le modal de fin d'emploi comptable
    function fermerModalVoirFinEmploiComptable() {
      document.getElementById('modalVoirFinEmploiComptable').style.display = 'none';
    }

    // Ouvrir le modal pour voir la fin d'emploi par moi
    function ouvrirModalVoirFinEmploiMoi(nom, date, motif, justificatif) {
      document.getElementById('finEmploiMoiNom').textContent = nom || '-';
      document.getElementById('finEmploiMoiDate').textContent = tempsRelatif(date);
      document.getElementById('finEmploiMoiMotif').textContent = motif || 'Non sp√©cifi√©';
      document.getElementById('finEmploiMoiJustificatif').textContent = justificatif || 'Aucun justificatif';
      document.getElementById('modalVoirFinEmploiMoi').style.display = 'flex';
    }

    // Fermer le modal de fin d'emploi par moi
    function fermerModalVoirFinEmploiMoi() {
      document.getElementById('modalVoirFinEmploiMoi').style.display = 'none';
    }

    // Marquer une fin d'emploi comme vue (stockage local)
    function marquerFinEmploiComptableVu(employeId) {
      const username = window.username || 'user';
      const key = `finEmploiComptableVus_${username}`;
      let vus = JSON.parse(localStorage.getItem(key) || '[]');
      if (!vus.includes(employeId)) {
        vus.push(employeId);
        localStorage.setItem(key, JSON.stringify(vus));
      }
    }

    // V√©rifier si une fin d'emploi a √©t√© vue
    function estFinEmploiComptableVu(employeId) {
      const username = window.username || 'user';
      const key = `finEmploiComptableVus_${username}`;
      let vus = JSON.parse(localStorage.getItem(key) || '[]');
      return vus.includes(employeId);
    }

    // Variable pour stocker l'ID de l'employ√© √† supprimer
    let employeASupprimer = null;

    // Ouvrir le modal de confirmation d'annulation
    function ouvrirModalAnnuler(employeId, nomEmploye) {
      employeASupprimer = employeId;
      document.getElementById('nomEmployeAnnuler').textContent = nomEmploye || 'Employ√©';
      document.getElementById('modalAnnulerEmploye').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    // Fermer le modal d'annulation
    function fermerModalAnnuler() {
      document.getElementById('modalAnnulerEmploye').style.display = 'none';
      document.body.style.overflow = 'auto';
      employeASupprimer = null;
    }

    // Confirmer la suppression de l'employ√©
    async function confirmerAnnulerEmploye() {
      if (!employeASupprimer) return;

      try {
        const username = window.username || 'user';
        const response = await fetch(`/api/employes/${username}/supprimer-nouveau/${employeASupprimer}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          showNotification('Employ√© supprim√© avec succ√®s', 'success');
          fermerModalAnnuler();
          chargerEmployes();
        } else {
          const error = await response.json();
          showNotification('Erreur: ' + (error.detail || 'Erreur lors de la suppression'), 'error');
        }
      } catch (err) {
        error('Erreur lors de la suppression:', err);
        showNotification('Erreur de connexion', 'error');
      }
    }

    // Supprimer un employ√© nouveau (annuler apr√®s refus) - ouvre le popup
    function supprimerEmployeNouveau(employeId, nomEmploye) {
      ouvrirModalAnnuler(employeId, nomEmploye);
    }

    // ===== FONCTIONS POUR VALIDATION D'INACTIVATION (COACH) =====
    let currentInactivationValidation = null;

    // Ouvrir le popup de validation d'inactivation (nouveau popup d√©di√©)
    function ouvrirPopupValidationInactivation(employeId, employeDataString) {
      try {
        log('=== OUVERTURE POPUP VALIDATION INACTIVATION ===');
        log('employeId:', employeId);

        // Parser les donn√©es de l'employ√©
        let employe;
        if (typeof employeDataString === 'string') {
          employe = JSON.parse(employeDataString);
        } else {
          employe = employeDataString;
        }

        log('Donn√©es employ√© inactivation:', employe);

        // Stocker les donn√©es pour utiliser dans valider/refuser
        currentInactivationValidation = {
          id: employeId,
          data: employe
        };

        // Remplir les champs du popup d√©di√© √† l'inactivation
        // Section raison de l'inactivation
        document.getElementById('inactivation-motif').textContent = employe.motif_inactivation || 'Non sp√©cifi√©';
        document.getElementById('inactivation-justificatif').textContent = employe.justificatif_inactivation || 'Aucun justificatif fourni';

        // Informations de l'employ√© (nom, date derni√®re journ√©e, taux horaire)
        document.getElementById('inactivation-nom').textContent = employe.nom || '-';
        document.getElementById('inactivation-date-derniere').textContent = employe.dateFinEmploi || '-';
        document.getElementById('inactivation-taux').textContent = employe.tauxHoraire ? `${employe.tauxHoraire} $/h` : '-';

        // Afficher le nouveau modal d√©di√©
        const modal = document.getElementById('modalValidationInactivation');
        if (modal) {
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
        }

        log('Popup de validation inactivation ouvert avec succ√®s');
      } catch (err) {
        error('Erreur lors de l\'ouverture du popup d\'inactivation:', error);
        showNotification('Erreur lors de l\'ouverture du popup', 'error');
      }
    }

    // Fermer le popup de validation d'inactivation
    function fermerPopupValidationInactivation() {
      const modal = document.getElementById('modalValidationInactivation');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }
      currentInactivationValidation = null;
    }

    // Valider l'inactivation (coach)
    async function validerInactivationCoach() {
      const btn = document.getElementById('btn-valider-inactivation');
      const originalHtml = showButtonSpinner(btn);

      try {
        if (!currentInactivationValidation) {
          error('Aucune inactivation en cours de validation');
          hideButtonSpinner(btn, originalHtml);
          return;
        }

        log('=== VALIDATION INACTIVATION PAR LE COACH ===');
        const employeId = currentInactivationValidation.id;
        const entrepreneurUsername = window.selectedEntrepreneur || window.username;

        const response = await fetch(`/api/employes/${entrepreneurUsername}/valider-inactivation/${employeId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          fermerPopupValidationInactivation();

          // Afficher l'animation de succ√®s
          showSuccessAnimation('Fin d\'emploi valid√©e avec succ√®s!');

          // Notifier le parent pour mettre √† jour le badge INSTANTAN√âMENT
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
          }

          // Attendre la fin de l'animation avant de recharger
          setTimeout(() => {
            chargerEmployes();

            // Recharger les badges du s√©lecteur d'entrepreneurs
            if (window.EntrepreneurSelector) {
              window.EntrepreneurSelector.reload();
            }
          }, 2000);
        } else {
          hideButtonSpinner(btn, originalHtml);
          const error = await response.json();
          showNotification('Erreur: ' + error.detail, 'error');
        }
      } catch (err) {
        hideButtonSpinner(btn, originalHtml);
        error('Erreur lors de la validation de l\'inactivation:', error);
        showNotification('Erreur de connexion: ' + error.message, 'error');
      }
    }

    // Refuser l'inactivation (coach)
    async function refuserInactivationCoach() {
      try {
        if (!currentInactivationValidation) {
          error('Aucune inactivation en cours de validation');
          return;
        }

        log('=== REFUS INACTIVATION PAR LE COACH ===');
        const employeId = currentInactivationValidation.id;
        const entrepreneurUsername = window.selectedEntrepreneur || window.username;

        const response = await fetch(`/api/employes/${entrepreneurUsername}/refuser-inactivation/${employeId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          fermerPopupValidationInactivation();

          // Afficher l'animation de succ√®s
          showSuccessAnimation('Fin d\'emploi refus√©e avec succ√®s!');

          // Notifier le parent pour mettre √† jour le badge INSTANTAN√âMENT
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
          }

          // Attendre la fin de l'animation avant de recharger
          setTimeout(() => {
            chargerEmployes();

            // Recharger les badges du s√©lecteur d'entrepreneurs
            if (window.EntrepreneurSelector) {
              window.EntrepreneurSelector.reload();
            }
          }, 2000);
        } else {
          const error = await response.json();
          showNotification('Erreur: ' + error.detail, 'error');
        }
      } catch (err) {
        error('Erreur lors du refus de l\'inactivation:', error);
        showNotification('Erreur de connexion: ' + error.message, 'error');
      }
    }

    // ===== FONCTIONS POUR VALIDATION DE R√âACTIVATION (COACH) =====
    let currentReactivationValidation = null;

    // Ouvrir le popup de validation de r√©activation
    async function ouvrirPopupValidationReactivation(employeId, employeDataString) {
      try {
        log('=== OUVERTURE POPUP VALIDATION R√âACTIVATION ===');
        log('employeId:', employeId);

        // R√©cup√©rer le username de l'entrepreneur (depuis l'URL ou les donn√©es de l'employ√©)
        let entrepreneurUsername = window.username || 'user';

        // Si on est coach, on doit r√©cup√©rer le username depuis l'employ√© pass√© en param√®tre
        let employeBasic;
        if (typeof employeDataString === 'string') {
          employeBasic = JSON.parse(employeDataString);
        } else {
          employeBasic = employeDataString;
        }

        // Si on a un entrepreneur_username dans les donn√©es (vue coach), l'utiliser
        if (employeBasic.entrepreneur_username) {
          entrepreneurUsername = employeBasic.entrepreneur_username;
        }

        log('R√©cup√©ration des donn√©es de r√©activation pour:', entrepreneurUsername, employeId);

        // Appeler l'API pour r√©cup√©rer les donn√©es compl√®tes de r√©activation
        const response = await fetch(`/api/employes/${entrepreneurUsername}/reactivation/${employeId}`);
        const result = await response.json();

        let employe;
        if (result.success && result.data) {
          employe = result.data;
          log('Donn√©es compl√®tes de r√©activation r√©cup√©r√©es:', employe);
        } else {
          // Si l'API √©choue, utiliser les donn√©es pass√©es en param√®tre
          log('API √©chou√©e, utilisation des donn√©es locales');
          employe = employeBasic;
        }

        // Stocker les donn√©es pour utiliser dans valider/refuser
        currentReactivationValidation = {
          id: employeId,
          data: employe,
          entrepreneurUsername: entrepreneurUsername
        };

        // Remplir les champs du popup
        // Informations personnelles
        document.getElementById('reactivation-nom').textContent = employe.nom || '-';
        document.getElementById('reactivation-genre').textContent = employe.genre || '-';
        document.getElementById('reactivation-nas').textContent = employe.nas || '-';
        document.getElementById('reactivation-date-candidature').textContent = employe.dateCandidature || '-';

        // Contact
        document.getElementById('reactivation-courriel').textContent = employe.courriel || '-';
        document.getElementById('reactivation-telephone').textContent = employe.telephone || '-';

        // Adresse compl√®te
        const adresseComplete = [employe.adresse, employe.ville, employe.codePostal].filter(Boolean).join(', ');
        document.getElementById('reactivation-adresse-complete').textContent = adresseComplete || '-';

        // Emploi (avec les champs modifi√©s mis en √©vidence)
        document.getElementById('reactivation-poste').textContent = employe.posteService || employe.poste || '-';
        document.getElementById('reactivation-taux').textContent = employe.tauxHoraire ? `${employe.tauxHoraire} $/h` : '-';
        document.getElementById('reactivation-date-premiere').textContent = employe.datePremiere || '-';

        // Documents
        const username = entrepreneurUsername;
        if (employe.specimenCheque) {
          document.getElementById('reactivation-specimen-preview').style.display = 'inline';
          document.getElementById('reactivation-specimen-link').href = `/api/employes/${username}/documents/${employeId}/${employe.specimenCheque}`;
          document.getElementById('reactivation-specimen-none').style.display = 'none';
        } else {
          document.getElementById('reactivation-specimen-preview').style.display = 'none';
          document.getElementById('reactivation-specimen-none').style.display = 'inline';
        }

        if (employe.certificatSecurite) {
          document.getElementById('reactivation-certificat-preview').style.display = 'inline';
          document.getElementById('reactivation-certificat-link').href = `/api/employes/${username}/documents/${employeId}/${employe.certificatSecurite}`;
          document.getElementById('reactivation-certificat-none').style.display = 'none';
        } else {
          document.getElementById('reactivation-certificat-preview').style.display = 'none';
          document.getElementById('reactivation-certificat-none').style.display = 'inline';
        }

        if (employe.carteAssurance) {
          document.getElementById('reactivation-carte-preview').style.display = 'inline';
          document.getElementById('reactivation-carte-link').href = `/api/employes/${username}/documents/${employeId}/${employe.carteAssurance}`;
          document.getElementById('reactivation-carte-none').style.display = 'none';
        } else {
          document.getElementById('reactivation-carte-preview').style.display = 'none';
          document.getElementById('reactivation-carte-none').style.display = 'inline';
        }

        // Afficher le modal
        const modal = document.getElementById('modalValidationReactivation');
        if (modal) {
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
        }

        log('Popup de validation r√©activation ouvert avec succ√®s');
      } catch (err) {
        error('Erreur lors de l\'ouverture du popup de r√©activation:', error);
        showNotification('Erreur lors de l\'ouverture du popup', 'error');
      }
    }

    // Fermer le popup de validation de r√©activation
    function fermerPopupValidationReactivation() {
      const modal = document.getElementById('modalValidationReactivation');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }
      currentReactivationValidation = null;
    }

    // Valider la r√©activation (coach)
    async function validerReactivationCoach() {
      const btn = document.getElementById('btn-valider-reactivation');
      const originalHtml = showButtonSpinner(btn);

      try {
        if (!currentReactivationValidation) {
          error('Aucune r√©activation en cours de validation');
          hideButtonSpinner(btn, originalHtml);
          return;
        }

        log('=== VALIDATION R√âACTIVATION PAR LE COACH ===');
        const employeId = currentReactivationValidation.id;
        const entrepreneurUsername = window.selectedEntrepreneur || window.username;

        const response = await fetch(`/api/employes/${entrepreneurUsername}/valider-reactivation/${employeId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          fermerPopupValidationReactivation();

          // Afficher l'animation de succ√®s
          showSuccessAnimation('R√©activation valid√©e avec succ√®s!');

          // Notifier le parent pour mettre √† jour le badge INSTANTAN√âMENT
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
          }

          // Attendre la fin de l'animation avant de recharger
          setTimeout(() => {
            chargerEmployes();

            // Recharger les badges du s√©lecteur d'entrepreneurs
            if (window.EntrepreneurSelector) {
              window.EntrepreneurSelector.reload();
            }
          }, 2000);
        } else {
          hideButtonSpinner(btn, originalHtml);
          const error = await response.json();
          showNotification('Erreur: ' + error.detail, 'error');
        }
      } catch (err) {
        hideButtonSpinner(btn, originalHtml);
        error('Erreur lors de la validation de la r√©activation:', err);
        showNotification('Erreur de connexion: ' + error.message, 'error');
      }
    }

    // Refuser la r√©activation (coach)
    async function refuserReactivationCoach() {
      try {
        if (!currentReactivationValidation) {
          error('Aucune r√©activation en cours de validation');
          return;
        }

        log('=== REFUS R√âACTIVATION PAR LE COACH ===');
        const employeId = currentReactivationValidation.id;
        const entrepreneurUsername = window.selectedEntrepreneur || window.username;

        const response = await fetch(`/api/employes/${entrepreneurUsername}/refuser-reactivation/${employeId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          fermerPopupValidationReactivation();

          // Afficher l'animation de succ√®s
          showSuccessAnimation('R√©activation refus√©e avec succ√®s!');

          // Notifier le parent pour mettre √† jour le badge INSTANTAN√âMENT
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'updateEmployesBadge' }, '*');
          }

          // Attendre la fin de l'animation avant de recharger
          setTimeout(() => {
            chargerEmployes();

            // Recharger les badges du s√©lecteur d'entrepreneurs
            if (window.EntrepreneurSelector) {
              window.EntrepreneurSelector.reload();
            }
          }, 2000);
        } else {
          const error = await response.json();
          showNotification('Erreur: ' + error.detail, 'error');
        }
      } catch (err) {
        error('Erreur lors du refus de la r√©activation:', err);
        showNotification('Erreur de connexion: ' + error.message, 'error');
      }
    }

    // ===== FONCTIONS DE NOTIFICATION =====
    function showNotification(message, type = 'success') {
      const isSuccess = type === 'success';
      const bgGradient = isSuccess
        ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)'
        : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
      const shadowColor = isSuccess
        ? 'rgba(16, 185, 129, 0.4)'
        : 'rgba(239, 68, 68, 0.4)';
      const icon = isSuccess ? 'fa-check-circle' : 'fa-exclamation-circle';

      const messageEl = document.createElement('div');
      messageEl.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: ${bgGradient};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px ${shadowColor};
        font-weight: 600;
        z-index: 10000;
        animation: notifSlideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      `;
      messageEl.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${message}</span>
      `;

      // Ajouter les styles d'animation si pas d√©j√† pr√©sents
      if (!document.getElementById('notif-styles')) {
        const styleEl = document.createElement('style');
        styleEl.id = 'notif-styles';
        styleEl.textContent = `
          @keyframes notifSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes notifSlideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
          }
        `;
        document.head.appendChild(styleEl);
      }

      document.body.appendChild(messageEl);

      setTimeout(() => {
        messageEl.style.animation = 'notifSlideOut 0.3s ease';
        setTimeout(() => messageEl.remove(), 300);
      }, 3000);
    }

    // Modal de confirmation personnalis√©
    function showConfirmModal(message, onConfirm, onCancel) {
      const overlay = document.createElement('div');
      overlay.id = 'confirm-overlay-gestion';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
      `;

      const modal = document.createElement('div');
      modal.style.cssText = `
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border-radius: 16px;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
      `;

      modal.innerHTML = `
        <div style="text-align: center; margin-bottom: 1.5rem;">
          <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
            <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; color: white;"></i>
          </div>
          <h3 style="color: white; font-size: 1.25rem; margin-bottom: 0.5rem;">Confirmation</h3>
          <p style="color: #94a3b8; font-size: 0.95rem; line-height: 1.5;">${message}</p>
        </div>
        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button id="confirm-cancel-gestion" style="flex: 1; padding: 0.75rem 1.5rem; border-radius: 8px; border: none; background: rgba(255, 255, 255, 0.1); color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <i class="fas fa-times"></i>
            Annuler
          </button>
          <button id="confirm-ok-gestion" style="flex: 1; padding: 0.75rem 1.5rem; border-radius: 8px; border: none; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <i class="fas fa-check"></i>
            Confirmer
          </button>
        </div>
      `;

      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      const closeModal = () => overlay.remove();

      document.getElementById('confirm-cancel-gestion').addEventListener('click', () => {
        closeModal();
        if (onCancel) onCancel();
      });

      document.getElementById('confirm-ok-gestion').addEventListener('click', () => {
        closeModal();
        if (onConfirm) onConfirm();
      });

      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          closeModal();
          if (onCancel) onCancel();
        }
      });
    }
  </script>

  <script>
    // Fonctions pour le taux horaire
    function isNumberKey(evt) {
      var charCode = (evt.which) ? evt.which : evt.keyCode;
      // Permettre les chiffres, le point d√©cimal et les touches de contr√¥le
      if (charCode > 31 && (charCode < 48 || charCode > 57) && charCode !== 46)
        return false;
      return true;
    }

    // Fonction formatTauxHoraire retir√©e - aucun formatage n√©cessaire

    // Custom Select pour le dropdown - fonction simplifi√©e
    function toggleCustomSelect(selectId) {
      const wrapper = document.querySelector(`#${selectId}`).closest('.custom-select');
      const options = wrapper.querySelector('.custom-options');
      const chevron = wrapper.querySelector('.fa-chevron-down');
      
      // Fermer tous les autres dropdowns
      document.querySelectorAll('.custom-select').forEach(select => {
        if (select !== wrapper) {
          const otherOptions = select.querySelector('.custom-options');
          const otherChevron = select.querySelector('.fa-chevron-down');
          if (otherOptions) otherOptions.classList.add('hidden');
          if (otherChevron) otherChevron.style.transform = 'rotate(0deg)';
        }
      });
      
      // Toggle ce dropdown
      const isHidden = options.classList.contains('hidden');
      if (isHidden) {
        options.classList.remove('hidden');
        chevron.style.transform = 'rotate(180deg)';
      } else {
        options.classList.add('hidden');
        chevron.style.transform = 'rotate(0deg)';
      }
    }
    
    // G√©rer les clics sur les options
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('option')) {
        const wrapper = e.target.closest('.custom-select');
        const select = wrapper.querySelector('select');
        const display = wrapper.querySelector('.selected-text');
        const value = e.target.getAttribute('data-value');
        const text = e.target.textContent.trim();
        
        // Mettre √† jour le select cach√© et l'affichage
        select.value = value;
        display.textContent = text;
        
        // Fermer le dropdown
        wrapper.querySelector('.custom-options').classList.add('hidden');
        wrapper.querySelector('.fa-chevron-down').style.transform = 'rotate(0deg)';
      }
      
      // Fermer les dropdowns en cliquant ailleurs
      if (!e.target.closest('.custom-select')) {
        document.querySelectorAll('.custom-options').forEach(opt => {
          opt.classList.add('hidden');
        });
        document.querySelectorAll('.fa-chevron-down').forEach(chevron => {
          chevron.style.transform = 'rotate(0deg)';
        });
      }
    });

    // Variables d√©j√† d√©finies plus haut dans le header

    // G√©n√©rer le calendrier - FONCTION GLOBALE
    window.renderCalendar = function(inputId) {
      log('üé® renderCalendar appel√© pour:', inputId);
      
      // V√©rifier d'abord si le calendrier lui-m√™me existe
      const calendar = document.getElementById(`calendar-${inputId}`);
      log('[DATE] Calendrier principal:', calendar ? 'TROUV√â' : 'NON TROUV√â');
      
      if (calendar) {
        log('[BAN] Contenu HTML du calendrier:', calendar.innerHTML.substring(0, 200) + '...');
      }
      
      // Utiliser notre structure avec les bons IDs
      const monthYearSpan = document.getElementById(`calendar-month-year-${inputId}`);
      const daysContainer = document.getElementById(`calendar-days-${inputId}`);
      
      log('[DEBUG] √âl√©ments calendrier trouv√©s:', {
        monthYearSpan: monthYearSpan ? 'OK' : 'NON TROUV√â',
        daysContainer: daysContainer ? 'OK' : 'NON TROUV√â'
      });
      
      if (!monthYearSpan || !daysContainer) {
        error('[ERROR] √âl√©ments calendrier manquants - structure inconnue');
        log('[FIX] Structure HTML r√©elle:', calendar.innerHTML);
        return;
      }
      
      monthYearSpan.textContent = `${window.monthNames[currentMonth]} ${currentYear}`;
      
      // Calculer le premier jour du mois et le nombre de jours
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startDate = firstDay.getDay();
      
      // Vider le conteneur
      daysContainer.innerHTML = '';
      
      // Jours du mois pr√©c√©dent
      const prevMonth = new Date(currentYear, currentMonth - 1, 0);
      for (let i = startDate - 1; i >= 0; i--) {
        const day = prevMonth.getDate() - i;
        const dayDiv = createDayElement(day, true, currentMonth - 1, currentYear);
        daysContainer.appendChild(dayDiv);
      }
      
      // Jours du mois actuel
      const today = new Date();
      for (let day = 1; day <= daysInMonth; day++) {
        const isToday = today.getDate() === day && 
                       today.getMonth() === currentMonth && 
                       today.getFullYear() === currentYear;
        const dayDiv = createDayElement(day, false, currentMonth, currentYear, isToday);
        daysContainer.appendChild(dayDiv);
      }
      
      // Jours du mois suivant pour compl√©ter la grille
      const totalCells = daysContainer.children.length;
      const remainingCells = 42 - totalCells; // Grille 6x7
      for (let day = 1; day <= remainingCells && remainingCells < 14; day++) {
        const dayDiv = createDayElement(day, true, currentMonth + 1, currentYear);
        daysContainer.appendChild(dayDiv);
      }
    };

    // Cr√©er un √©l√©ment jour - FONCTION GLOBALE
    window.createDayElement = function(day, isOtherMonth, month, year, isToday = false) {
      const dayDiv = document.createElement('div');
      dayDiv.classList.add('calendar-day');
      if (isOtherMonth) dayDiv.classList.add('other-month');
      if (isToday) dayDiv.classList.add('today');
      
      dayDiv.textContent = day;
      dayDiv.onclick = () => window.selectDate(day, month, year, isOtherMonth);
      
      return dayDiv;
    };

    // S√©lectionner une date - FONCTION GLOBALE
    window.selectDate = function(day, month, year, isOtherMonth) {
      if (isOtherMonth) {
        currentMonth = month;
        currentYear = year;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        } else if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        renderCalendar(activeCalendarId);
        return;
      }
      
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const input = document.getElementById(activeCalendarId);
      input.value = dateStr;
      
      // Fermer le calendrier
      document.getElementById(`calendar-${activeCalendarId}`).classList.add('hidden');
    };

    // Initialiser le calendrier une fois le DOM charg√©
    document.addEventListener('DOMContentLoaded', function() {
      // Initialiser les variables du calendrier
      const today = new Date();
      currentMonth = today.getMonth();
      currentYear = today.getFullYear();

      log('Calendrier initialis√©:', { currentMonth, currentYear });
    });

    // Fonction de formatage de t√©l√©phone r√©utilisable (format: 000-000-0000)
    function setupPhoneFormatting(inputId) {
      const phoneInput = document.getElementById(inputId);
      if (!phoneInput) return;

      phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Garder seulement les chiffres
        let formattedValue = '';

        if (value.length > 0) {
          formattedValue = value.substring(0, 3);
        }
        if (value.length >= 4) {
          formattedValue += '-' + value.substring(3, 6);
        }
        if (value.length >= 7) {
          formattedValue += '-' + value.substring(6, 10);
        }

        e.target.value = formattedValue;
      });

      phoneInput.addEventListener('keydown', function(e) {
        // Si l'utilisateur appuie sur Backspace ou Delete
        if (e.key === 'Backspace' || e.key === 'Delete') {
          const cursorPos = e.target.selectionStart;
          const value = e.target.value;

          // Si le curseur est juste apr√®s un tiret, effacer le tiret + le chiffre avant
          if (e.key === 'Backspace' && cursorPos > 0 && value[cursorPos - 1] === '-') {
            e.preventDefault();
            const newValue = value.substring(0, cursorPos - 2) + value.substring(cursorPos);
            e.target.value = newValue;
            // Re-formater
            const event = new Event('input', { bubbles: true });
            e.target.dispatchEvent(event);
            // Repositionner le curseur
            setTimeout(() => {
              e.target.setSelectionRange(cursorPos - 2, cursorPos - 2);
            }, 0);
          }
        }
      });
    }

    // Fonction de formatage de date de naissance (format: AAAA-MM-JJ)
    function setupDateNaissanceFormatting(inputId) {
      const dateInput = document.getElementById(inputId);
      if (!dateInput) return;

      dateInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Garder seulement les chiffres
        let formattedValue = '';

        if (value.length > 0) {
          formattedValue = value.substring(0, 4); // AAAA
        }
        if (value.length >= 5) {
          formattedValue += '-' + value.substring(4, 6); // MM
        }
        if (value.length >= 7) {
          formattedValue += '-' + value.substring(6, 8); // JJ
        }

        e.target.value = formattedValue;
      });
    }

    // Initialiser le formatage de t√©l√©phone et date de naissance pour tous les champs concern√©s
    document.addEventListener('DOMContentLoaded', function() {
      setupPhoneFormatting('modifierTelephone');  // Modal de modification d'employ√©
      setupPhoneFormatting('nouveauTelephone');   // Modal d'ajout de candidat
      setupPhoneFormatting('telephone');          // Modal d'activation d'employ√©
      setupPhoneFormatting('employeTelephone');   // Modal d'ajout d'employ√©

      setupDateNaissanceFormatting('dateNaissance');  // Modal d'activation d'employ√©
      setupDateNaissanceFormatting('reactiverDateNaissance');  // Modal de r√©activation d'employ√©
      setupDateNaissanceFormatting('modifierDateNaissance');  // Modal de modification d'employ√©
    });

    // AUCUN FORMATAGE pour taux horaire - champ texte normal
    // (Formatage retir√© √† la demande de l'utilisateur)

    // Variable pour stocker les instances d'autocomplete
    let autocompleteInstances = {};
    let googleMapsLoaded = false;

    // Fonction pour initialiser Google Places Autocomplete sur un champ d'adresse
    function setupAddressAutocomplete(addressInputId, cityInputId, postalCodeInputId) {
      if (!googleMapsLoaded) return null;

      const addressInput = document.getElementById(addressInputId);
      if (!addressInput) return null;

      // Si d√©j√† initialis√©, retourner l'instance existante
      if (autocompleteInstances[addressInputId]) {
        return autocompleteInstances[addressInputId];
      }

      try {
        const autocomplete = new google.maps.places.Autocomplete(addressInput, {
          types: ['address'],
          componentRestrictions: { country: 'ca' }
        });

        // Forcer les attributs anti-autocomplete
        addressInput.setAttribute('autocomplete', 'off');
        addressInput.setAttribute('autocorrect', 'off');
        addressInput.setAttribute('autocapitalize', 'off');
        addressInput.setAttribute('spellcheck', 'false');

        autocomplete.addListener('place_changed', () => {
          const place = autocomplete.getPlace();

          if (!place.geometry) return;

          const components = place.address_components;
          let streetNumber = '';
          let route = '';
          let city = '';
          let postalCode = '';

          components.forEach(component => {
            const types = component.types;

            if (types.includes('street_number')) {
              streetNumber = component.long_name;
            }
            if (types.includes('route')) {
              route = component.long_name;
            }
            if (types.includes('locality')) {
              city = component.long_name;
            }
            if (types.includes('postal_code')) {
              postalCode = component.long_name;
            }
          });

          // Remplir seulement num√©ro civique + rue dans le champ adresse
          addressInput.value = `${streetNumber} ${route}`.trim();

          // Remplir ville si le champ existe
          if (cityInputId) {
            const cityInput = document.getElementById(cityInputId);
            if (cityInput) cityInput.value = city;
          }

          // Remplir code postal si le champ existe
          if (postalCodeInputId) {
            const postalInput = document.getElementById(postalCodeInputId);
            if (postalInput) postalInput.value = postalCode;
          }
        });

        // Sauvegarder l'instance
        autocompleteInstances[addressInputId] = autocomplete;
        return autocomplete;
      } catch (err) {
        error('Erreur cr√©ation autocomplete:', err);
        return null;
      }
    }

    // Fonction callback appel√©e par Google Maps API
    window.initGestionEmployesAutocomplete = function() {
      googleMapsLoaded = true;
    };
  </script>

  <!-- Google Places API -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZDi-RMHDdA4l-4sv_5H8GhsUAYXV4DVE&libraries=places&callback=initGestionEmployesAutocomplete&language=fr&region=CA"
    async
    defer
  ></script>

  <!-- Script commun de gestion des permissions et interface -->
  <script src="/common.js"></script>

  <!-- Navigation mobile -->
  <script>
    // Fonction pour retourner √† la page gestions
    function goBackToGestions() {
      window.history.back();
    }
  </script>

  <!-- Inline entrepreneur selector script removed - now handled by shared /entrepreneur-selector.js -->

  <script>
    // Gestion du modal Ajouter un employ√©
    function ouvrirModalAjouterEmploye() {
      const modal = document.getElementById('modalAjouterEmploye');
      if (modal) {
        modal.style.display = 'flex';
        // Bloquer le scroll de la page
        document.body.style.overflow = 'hidden';
      }
    }

    function fermerModalAjouterEmploye() {
      const modal = document.getElementById('modalAjouterEmploye');
      if (modal) {
        modal.style.display = 'none';
        // R√©tablir le scroll
        document.body.style.overflow = '';
        // R√©initialiser le formulaire
        document.getElementById('employeForm').reset();
      }
    }

    // G√©rer la soumission du formulaire
    document.getElementById('employeForm')?.addEventListener('submit', async function(e) {
      e.preventDefault();

      const nom = document.getElementById('employeNom').value.trim();
      const courriel = document.getElementById('employeCourriel').value.trim();
      const telephone = document.getElementById('employeTelephone').value.trim();
      const poste = document.getElementById('employePoste').value.trim();

      if (!nom || !courriel || !telephone || !poste) {
        showNotification('Veuillez remplir tous les champs', 'error');
        return;
      }

      try {
        const username = window.username || 'user';
        const nouvelEmploye = {
          nom: nom,
          genre: 'non sp√©cifi√©',
          courriel: courriel,
          telephone: telephone,
          poste: poste
        };

        const response = await fetch(`/api/employes/${username}/nouveaux`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(nouvelEmploye)
        });

        if (response.ok) {
          const result = await response.json();
          showNotification('Employ√© ajout√© avec succ√®s', 'success');
          fermerModalAjouterEmploye();
          chargerEmployes();
        } else {
          const error = await response.json();
          showNotification(error.detail || 'Erreur lors de l\'ajout', 'error');
        }
      } catch (err) {
        error('Erreur:', err);
        showNotification('Erreur de connexion', 'error');
      }
    });

  // Gestion du modal Refuser un employ√©
  let employeARefuser = null;
  let employeARefuserType = null; // Type: 'nouveaux', 'actifs', ou 'reactivations'

  // Compteurs de messages non lus pour les refus par coach
  let refusUnreadCounts = {};

  // Charger les compteurs de messages non lus
  async function loadRefusUnreadCounts() {
    const username = window.selectedEntrepreneur || window.username || 'user';

    try {
      const response = await fetch(`/api/refus-conversation/unread-counts/${username}`);
      const result = await response.json();
      if (result.success) {
        refusUnreadCounts = result.unread_counts || {};
        // Rafra√Æchir l'affichage des badges
        updateRefusBadges();
      }
    } catch (err) {
      error('Erreur chargement compteurs messages non lus:', err);
    }
  }

  // Mettre √† jour les badges de refus avec les compteurs
  function updateRefusBadges() {
    document.querySelectorAll('.btn-voir-refus-badge').forEach(badge => {
      const employeId = badge.dataset.employeId;
      const unreadCount = refusUnreadCounts[employeId] || 0;

      // Supprimer l'ancien badge s'il existe
      const existingBadge = badge.querySelector('.unread-badge');
      if (existingBadge) {
        existingBadge.remove();
      }

      // Ajouter le nouveau badge si des messages non lus
      if (unreadCount > 0) {
        const notifBadge = document.createElement('span');
        notifBadge.className = 'unread-badge';
        notifBadge.textContent = unreadCount;
        notifBadge.style.cssText = 'display: inline-block; background: white; color: #dc2626; border-radius: 12px; padding: 3px 8px; font-size: 0.75rem; margin-left: 8px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 2px solid #dc2626;';
        badge.appendChild(notifBadge);
      }
    });
  }

  function ouvrirModalRefuserEmploye(employeId, employeNom, employePoste) {
    const modal = document.getElementById('modalRefuserEmploye');
    if (modal) {
      employeARefuser = employeId;
      document.getElementById('refuserEmployeNom').textContent = employeNom || '-';
      document.getElementById('refuserEmployePoste').textContent = employePoste || '-';
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
  }

  function fermerModalRefuserEmploye() {
    const modal = document.getElementById('modalRefuserEmploye');
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = '';
      employeARefuser = null;
      employeARefuserType = null;
    }
  }

  async function confirmerRefusEmploye() {
    if (!employeARefuser || !employeARefuserType) return;

    const username = window.selectedEntrepreneur || window.username || 'user';

    try {
      // Utiliser le bon endpoint selon le type d'employ√©
      const response = await fetch(`/api/employes/${username}/${employeARefuserType}/${employeARefuser}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        const result = await response.json();
        console.log(result.message);
        fermerModalRefuserEmploye();
        chargerEmployes(); // Rafra√Æchir la liste
      } else {
        const errorData = await response.json();
        console.error('Erreur:', errorData.detail);
        alert('Erreur lors du refus: ' + errorData.detail);
      }
    } catch (err) {
      console.error('Erreur:', err);
      alert('Erreur lors du refus de l\'employ√©');
    }
  }

  // ===================================================================
  // MODAL POUR AFFICHER LES FICHIERS (IMAGES ET PDFs) - M√™me syst√®me que Centrale
  // ===================================================================

  function openFileModal(url) {
    const viewerModal = document.getElementById('centraleViewerModal');
    const viewerContent = document.getElementById('centraleViewerContent');

    if (!viewerModal || !viewerContent) {
      error('Modal viewer elements not found');
      return;
    }

    viewerContent.innerHTML = '';

    const ext = url.split('.').pop().toLowerCase();

    if (['png', 'jpg', 'jpeg', 'gif'].includes(ext)) {
      const img = document.createElement('img');
      img.src = url;
      img.style.maxWidth = '100%';
      img.style.maxHeight = '100%';
      img.style.objectFit = 'contain';
      viewerContent.appendChild(img);
    } else {
      // Pour les PDFs - utiliser iframe qui remplit le conteneur
      const iframe = document.createElement('iframe');
      iframe.src = url;
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = 'none';
      iframe.style.borderRadius = '8px';
      viewerContent.appendChild(iframe);
    }

    viewerModal.style.display = 'flex';
  }

  function closeFileModal() {
    const viewerModal = document.getElementById('centraleViewerModal');
    const viewerContent = document.getElementById('centraleViewerContent');

    if (viewerModal) viewerModal.style.display = 'none';
    if (viewerContent) viewerContent.innerHTML = '';
  }

  // Event listener pour le bouton fermer
  document.addEventListener('DOMContentLoaded', () => {
    const closeViewer = document.getElementById('closeViewer');
    if (closeViewer) {
      closeViewer.addEventListener('click', closeFileModal);
    }

    // Initialiser les calendriers pour les filtres
    if (document.getElementById('filter-date-start-actifs-ge')) {
      new CustomCalendarGE('filter-date-start-actifs-ge', 'calendar-filter-date-start-actifs-ge', applyFiltersActifs);
    }
    if (document.getElementById('filter-date-end-actifs-ge')) {
      new CustomCalendarGE('filter-date-end-actifs-ge', 'calendar-filter-date-end-actifs-ge', applyFiltersActifs);
    }
    if (document.getElementById('filter-date-start-termines-ge')) {
      new CustomCalendarGE('filter-date-start-termines-ge', 'calendar-filter-date-start-termines-ge', applyFiltersTermines);
    }
    if (document.getElementById('filter-date-end-termines-ge')) {
      new CustomCalendarGE('filter-date-end-termines-ge', 'calendar-filter-date-end-termines-ge', applyFiltersTermines);
    }

    // Initialiser le calendrier pour la date de fin d'emploi
    if (document.getElementById('dateFinEmploi')) {
      new CustomCalendarGE('dateFinEmploi', 'calendar-date-fin-emploi');
    }
  });

  // Classe CustomCalendar pour gestionemployes
  class CustomCalendarGE {
    static instances = [];

    constructor(inputId, calendarId, onChangeCallback) {
      this.inputElement = document.getElementById(inputId);
      this.calendarElement = document.getElementById(calendarId);
      this.onChangeCallback = onChangeCallback;
      this.currentDate = new Date();
      this.selectedDate = null;
      this.inputElement.value = '';

      this.monthNames = [
        'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
        'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
      ];

      this.dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

      CustomCalendarGE.instances.push(this);
      this.init();
    }

    init() {
      this.inputElement.addEventListener('click', (e) => {
        e.stopPropagation();
        this.toggleCalendar();
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.custom-date-container')) {
          this.hideCalendar();
        }
      });

      this.renderCalendar();
    }

    toggleCalendar() {
      if (this.calendarElement.classList.contains('hidden')) {
        this.showCalendar();
      } else {
        this.hideCalendar();
      }
    }

    showCalendar() {
      CustomCalendarGE.instances.forEach(instance => {
        if (instance !== this) {
          instance.hideCalendar();
        }
      });

      this.calendarElement.classList.remove('hidden');
      this.calendarElement.style.setProperty('display', 'block', 'important');
      this.renderCalendar();
    }

    hideCalendar() {
      this.calendarElement.classList.add('hidden');
      this.calendarElement.style.display = 'none';
    }

    renderCalendar() {
      const year = this.currentDate.getFullYear();
      const month = this.currentDate.getMonth();

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const prevLastDay = new Date(year, month, 0);

      const firstDayWeek = firstDay.getDay();
      const lastDateMonth = lastDay.getDate();
      const prevLastDateMonth = prevLastDay.getDate();

      let calendarHTML = `
        <div class="calendar-header">
          <button type="button" class="calendar-nav-btn">‚Äπ</button>
          <div class="calendar-month-year">${this.monthNames[month]} ${year}</div>
          <button type="button" class="calendar-nav-btn">‚Ä∫</button>
        </div>
        <div class="calendar-weekdays">
      `;

      this.dayNames.forEach(day => {
        calendarHTML += `<div class="calendar-weekday">${day}</div>`;
      });

      calendarHTML += '</div><div class="calendar-days">';

      for (let i = firstDayWeek - 1; i >= 0; i--) {
        const day = prevLastDateMonth - i;
        calendarHTML += `<div class="calendar-day other-month">${day}</div>`;
      }

      const today = new Date();
      for (let day = 1; day <= lastDateMonth; day++) {
        const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
        const isSelected = this.selectedDate && day === this.selectedDate.getDate() &&
                          month === this.selectedDate.getMonth() && year === this.selectedDate.getFullYear();

        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (isSelected) classes += ' selected';

        calendarHTML += `<div class="${classes}" onclick="event.stopPropagation(); this.closest('.custom-calendar').calendar.selectDate(${year}, ${month}, ${day})">${day}</div>`;
      }

      const remainingDays = 42 - (firstDayWeek + lastDateMonth);
      for (let day = 1; day <= remainingDays; day++) {
        calendarHTML += `<div class="calendar-day other-month">${day}</div>`;
      }

      calendarHTML += '</div>';
      this.calendarElement.innerHTML = calendarHTML;
      this.calendarElement.calendar = this;

      // Ajouter les event listeners pour les boutons de navigation
      const prevBtn = this.calendarElement.querySelector('.calendar-nav-btn:first-child');
      const nextBtn = this.calendarElement.querySelector('.calendar-nav-btn:last-child');

      prevBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        this.prevMonth();
      });

      nextBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        this.nextMonth();
      });
    }

    prevMonth() {
      this.currentDate.setMonth(this.currentDate.getMonth() - 1);
      this.renderCalendar();
    }

    nextMonth() {
      this.currentDate.setMonth(this.currentDate.getMonth() + 1);
      this.renderCalendar();
    }

    selectDate(year, month, day) {
      this.selectedDate = new Date(year, month, day);
      const formattedDate = this.formatDate(this.selectedDate);
      this.inputElement.value = formattedDate;
      this.hideCalendar();
      if (this.onChangeCallback) {
        this.onChangeCallback();
      }
    }

    formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${day}/${month}/${year}`;
    }

    reset() {
      this.selectedDate = null;
      this.inputElement.value = '';
      this.currentDate = new Date();
    }
  }

  // Fonction helper pour parser les dates DD/MM/YYYY
  function parseDateGE(dateStr) {
    if (!dateStr) return null;
    const parts = dateStr.split('/');
    if (parts.length !== 3) return null;
    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10) - 1;
    const year = parseInt(parts[2], 10);
    return new Date(year, month, day);
  }

  // Variables globales pour stocker les donn√©es originales
  let employesActifsOriginal = [];
  let employesTerminesOriginal = [];

  // Fonction pour appliquer les filtres sur les employ√©s actifs
  function applyFiltersActifs() {
    const searchValue = document.getElementById('filter-search-actifs')?.value.toLowerCase().trim() || '';
    const dateStartStr = document.getElementById('filter-date-start-actifs-ge')?.value || '';
    const dateEndStr = document.getElementById('filter-date-end-actifs-ge')?.value || '';

    const dateStart = parseDateGE(dateStartStr);
    const dateEnd = parseDateGE(dateEndStr);

    // R√©cup√©rer les donn√©es des employ√©s actifs
    const tbody = document.querySelector('.employes-actifs-body');
    if (!tbody) return;

    // Si pas de donn√©es originales sauvegard√©es, les sauvegarder maintenant
    if (employesActifsOriginal.length === 0) {
      const rows = tbody.querySelectorAll('tr:not(.empty-state-row)');
      rows.forEach(row => {
        employesActifsOriginal.push({
          html: row.outerHTML,
          nom: row.querySelector('td:nth-child(1)')?.textContent.toLowerCase() || '',
          courriel: row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '',
          poste: row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '',
          dateActivation: row.dataset.dateActivation || ''
        });
      });
    }

    // Filtrer les donn√©es
    const filtered = employesActifsOriginal.filter(emp => {
      // Filtre par recherche
      if (searchValue) {
        if (!emp.nom.includes(searchValue) && !emp.courriel.includes(searchValue) && !emp.poste.includes(searchValue)) {
          return false;
        }
      }

      // Filtre par date d'activation
      if (dateStart || dateEnd) {
        const empDate = parseDateGE(emp.dateActivation);
        if (!empDate) return false;
        if (dateStart && empDate < dateStart) return false;
        if (dateEnd && empDate > dateEnd) return false;
      }

      return true;
    });

    // Mettre √† jour l'affichage
    tbody.innerHTML = '';
    if (filtered.length === 0) {
      tbody.innerHTML = `
        <tr class="empty-state-row">
          <td colspan="5" class="empty-state">
            <i class="fas fa-filter" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
            <p style="font-size: 1rem;">Aucun employ√© ne correspond aux filtres</p>
          </td>
        </tr>
      `;
    } else {
      filtered.forEach(emp => {
        tbody.innerHTML += emp.html;
      });
    }
  }

  // Fonction pour appliquer les filtres sur les employ√©s termin√©s
  function applyFiltersTermines() {
    const searchValue = document.getElementById('filter-search-termines')?.value.toLowerCase().trim() || '';
    const dateStartStr = document.getElementById('filter-date-start-termines-ge')?.value || '';
    const dateEndStr = document.getElementById('filter-date-end-termines-ge')?.value || '';

    const dateStart = parseDateGE(dateStartStr);
    const dateEnd = parseDateGE(dateEndStr);

    // R√©cup√©rer les donn√©es des employ√©s termin√©s
    const tbody = document.querySelector('.employes-termines-body');
    if (!tbody) return;

    // Si pas de donn√©es originales sauvegard√©es, les sauvegarder maintenant
    if (employesTerminesOriginal.length === 0) {
      const rows = tbody.querySelectorAll('tr:not(.empty-state-row)');
      rows.forEach(row => {
        employesTerminesOriginal.push({
          html: row.outerHTML,
          nom: row.querySelector('td:nth-child(1)')?.textContent.toLowerCase() || '',
          courriel: row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '',
          poste: row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '',
          dateInactivation: row.dataset.dateInactivation || ''
        });
      });
    }

    // Filtrer les donn√©es
    const filtered = employesTerminesOriginal.filter(emp => {
      // Filtre par recherche
      if (searchValue) {
        if (!emp.nom.includes(searchValue) && !emp.courriel.includes(searchValue) && !emp.poste.includes(searchValue)) {
          return false;
        }
      }

      // Filtre par date d'inactivation
      if (dateStart || dateEnd) {
        const empDate = parseDateGE(emp.dateInactivation);
        if (!empDate) return false;
        if (dateStart && empDate < dateStart) return false;
        if (dateEnd && empDate > dateEnd) return false;
      }

      return true;
    });

    // Mettre √† jour l'affichage
    tbody.innerHTML = '';
    if (filtered.length === 0) {
      tbody.innerHTML = `
        <tr class="empty-state-row">
          <td colspan="5" class="empty-state">
            <i class="fas fa-filter" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
            <p style="font-size: 1rem;">Aucun employ√© ne correspond aux filtres</p>
          </td>
        </tr>
      `;
    } else {
      filtered.forEach(emp => {
        tbody.innerHTML += emp.html;
      });
    }
  }

  // Fonction de r√©initialisation des filtres actifs
  function resetFiltersActifs() {
    if (document.getElementById('filter-search-actifs')) {
      document.getElementById('filter-search-actifs').value = '';
    }
    if (document.getElementById('filter-date-start-actifs-ge')) {
      document.getElementById('filter-date-start-actifs-ge').value = '';
    }
    if (document.getElementById('filter-date-end-actifs-ge')) {
      document.getElementById('filter-date-end-actifs-ge').value = '';
    }

    CustomCalendarGE.instances.forEach(instance => {
      if (instance.inputElement.id === 'filter-date-start-actifs-ge' ||
          instance.inputElement.id === 'filter-date-end-actifs-ge') {
        instance.reset();
      }
    });

    // Restaurer toutes les donn√©es
    const tbody = document.querySelector('.employes-actifs-body');
    if (tbody && employesActifsOriginal.length > 0) {
      tbody.innerHTML = '';
      employesActifsOriginal.forEach(emp => {
        tbody.innerHTML += emp.html;
      });
    }
  }

  // Fonction de r√©initialisation des filtres termin√©s
  function resetFiltersTermines() {
    if (document.getElementById('filter-search-termines')) {
      document.getElementById('filter-search-termines').value = '';
    }
    if (document.getElementById('filter-date-start-termines-ge')) {
      document.getElementById('filter-date-start-termines-ge').value = '';
    }
    if (document.getElementById('filter-date-end-termines-ge')) {
      document.getElementById('filter-date-end-termines-ge').value = '';
    }

    CustomCalendarGE.instances.forEach(instance => {
      if (instance.inputElement.id === 'filter-date-start-termines-ge' ||
          instance.inputElement.id === 'filter-date-end-termines-ge') {
        instance.reset();
      }
    });

    // Restaurer toutes les donn√©es
    const tbody = document.querySelector('.employes-termines-body');
    if (tbody && employesTerminesOriginal.length > 0) {
      tbody.innerHTML = '';
      employesTerminesOriginal.forEach(emp => {
        tbody.innerHTML += emp.html;
      });
    }
  }

  // Global function for entrepreneur selector to reload employee data
  window.loadEmployeesData = async function() {
    log("üîÑ Rechargement des donn√©es des employ√©s pour l'entrepreneur s√©lectionn√©...");
    await chargerEmployes();
  };
  </script>

  <!-- Script commun de gestion des permissions et interface -->
  <script src="/common.js"></script>
  <script src="/entrepreneur-selector.js"></script>
</body>
</html>
