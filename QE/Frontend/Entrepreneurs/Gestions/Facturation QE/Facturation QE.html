<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Facturation QE</title>
  
  <!-- üì± PWA Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#5271ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Qwota">
  <meta name="msapplication-TileColor" content="#5271ff">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Ic√¥nes PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

  <!-- Script Service Worker -->
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      /* DISABLED - Service Worker
      navigator.serviceWorker.register('/sw.js')
        .then((registration) => {
          log('SW registered: ', registration);
        })
        .catch((registrationError) => {
          log('SW registration failed: ', registrationError);
        });
      */
    });
  }
  </script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/base.css">
  <link rel="icon" href="/favicon" type="image/x-icon">

  <!-- Styles sp√©cifiques √† Facturation QE -->
  <link rel="stylesheet" href="/FacturationQE.css">

  <style>
    /* Titre du s√©lecteur entrepreneur */
    #coach-entrepreneur-selector .selector-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-light);
      text-align: center;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    #coach-entrepreneur-selector .selector-title i {
      color: var(--primary-blue);
    }

    #coach-entrepreneur-selector.in-header .selector-title {
      display: none;
    }

    /* Animation de succ√®s pour l'envoi de remboursement */
    @keyframes successFadeIn {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes checkmarkDraw {
      0% {
        stroke-dashoffset: 100;
      }
      100% {
        stroke-dashoffset: 0;
      }
    }

    .success-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: successFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .success-content {
      text-align: center;
      color: white;
      animation: successFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
    }

    .success-checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      margin: 0 auto 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
    }

    .success-checkmark svg {
      stroke: white;
      stroke-width: 3;
      stroke-dasharray: 100;
      stroke-dashoffset: 100;
      animation: checkmarkDraw 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.4s forwards;
    }
  </style>

  <!-- Script anti-flash: d√©tecte page=status AVANT le rendu et inverse les classes CSS -->
  <script>
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const pageParam = urlParams.get('page');
      const userRole = localStorage.getItem('userRole');
      const userParam = urlParams.get('user');

      // D√©tecter si c'est un coach ou direction
      const coachUsernames = ['coach1', 'coach01', 'coach2', 'coach3'];
      const isCoachOrDirection = (userRole === 'coach' || userRole === 'direction') || (userParam && coachUsernames.includes(userParam));

      // Afficher page2 (Status) SEULEMENT si page=status ET c'est un coach/direction
      if (pageParam === 'status' && isCoachOrDirection) {
        // Injecter du CSS TEMPORAIRE pour cacher page1 et afficher page2 AVANT le rendu
        const style = document.createElement('style');
        style.id = 'coach-mode-initial-style';
        style.textContent = '#page1 { display: none !important; } #page2 { display: block !important; }';
        document.head.appendChild(style);

        // Marquer qu'on est en mode coach initial
        window._coachModeInitial = true;
      } else if (pageParam === 'status' && !isCoachOrDirection) {
        // Si c'est un entrepreneur avec ?page=status, retirer le param√®tre de l'URL
        const newUrlParams = new URLSearchParams(window.location.search);
        newUrlParams.delete('page');
        const newUrl = window.location.pathname + (newUrlParams.toString() ? '?' + newUrlParams.toString() : '');
        window.history.replaceState({}, '', newUrl);
      }
    })();
  </script>

  <!-- ANTI-FLASH: D√©tection coach/direction AVANT le rendu du body pour le s√©lecteur centr√© -->
  <script>
    (function() {
      const userRole = localStorage.getItem('userRole');
      const isCoachOrDirection = userRole === 'coach' || userRole === 'direction';
      const urlParams = new URLSearchParams(window.location.search);
      const userParam = urlParams.get('user');

      // D√©tecter si le param√®tre user est un coach (bas√© sur coach_access.py)
      const coachUsernames = ['coach1', 'coach01', 'coach2'];
      const userParamIsCoach = userParam && coachUsernames.includes(userParam);

      // Afficher le s√©lecteur si:
      // 1. userRole === 'coach' OU 'direction' ET pas de param√®tre user
      // 2. OU le param√®tre user est un coach (ex: ?user=coach2)
      if (isCoachOrDirection && (!userParam || userParamIsCoach)) {
        // Injecter le CSS imm√©diatement pour cacher le contenu et afficher le s√©lecteur
        const style = document.createElement('style');
        style.id = 'coach-anti-flash-css';
        style.textContent = `
          .main-content {
            opacity: 0 !important;
            pointer-events: none !important;
          }
          #coach-selector-backdrop {
            display: block !important;
            opacity: 1 !important;
            pointer-events: none !important;
          }
          #coach-entrepreneur-selector {
            display: block !important;
            opacity: 1 !important;
            pointer-events: all !important;
          }
        `;
        document.head.appendChild(style);
      }
    })();
  </script>

  <!-- Variables globales d√©finies dans common.js -->
  <script>
    // ‚ö° ACTIVATION DES LOGS - Debug mode
    window.log = window.log || console.log.bind(console);
    window.warn = window.warn || console.warn.bind(console);
    window.error = window.error || console.error.bind(console);
    window.info = window.info || console.info.bind(console);
    window.debug = window.debug || console.debug.bind(console);

    // Ces variables sont maintenant g√©r√©es par common.js
    // username, userRole, canEditParameters sont disponibles globalement

    // Fonction pour v√©rifier si un username est un coach
    // Cette fonction accepte maintenant tous les usernames, l'API validera le r√¥le
    function isCoachUsername(username) {
      // Accepter tous les usernames valides - l'API v√©rifiera si c'est vraiment un coach
      return username && username.length > 0;
    }

    // Fonction utilitaire pour r√©cup√©rer le username de mani√®re robuste
    // En mode coach: utilise window.username (entrepreneur s√©lectionn√©)
    // En mode entrepreneur: utilise URL param puis fallback
    function getFacturationUsername() {
      // Si window.username est d√©fini ET diff√©rent du URL param, c'est qu'un entrepreneur a √©t√© s√©lectionn√© par le coach
      if (window.username) {
        const urlParams = new URLSearchParams(window.location.search);
        const urlUser = urlParams.get('user');
        // Si URL param est un coach ET qu'un username est d√©fini, utiliser le username s√©lectionn√©
        if (urlUser && isCoachUsername(urlUser) && window.username !== urlUser) {
          log('[COACH] Utilisation du username s√©lectionn√©:', window.username);
          return window.username;
        }
      }
      // Sinon, comportement normal
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('user') || window.username || sessionStorage.getItem('username') || localStorage.getItem('username') || 'demo';
    }

    // Fonction pour v√©rifier et afficher le nombre de clients
    async function verifierClientsAPI() {
      try {
        const username = getFacturationUsername();
        
        log('[DEBUG] V√©rification des clients pour:', username);
        
        const response = await fetch(`/api/facturationqe/clients-count/${username}`);
        
        if (!response.ok) {
          throw new Error(`Erreur v√©rification clients: ${response.status}`);
        }
        
        const result = await response.json();
        log('[OK] Clients disponibles:', result.total_clients, 'pour', result.username);
        
        if (result.total_clients === 0) {
          log('[WARN] Aucun client trouv√© - V√©rifiez les soumissions sign√©es');
        }
        
      } catch (error) {
        error('[ERROR] Erreur v√©rification clients:', error);
      }
    }

    // Function to show/hide pages - d√©finie globalement dans le head
    function showPage(pageId) {
      log('showPage appel√©e avec:', pageId);

      // Supprimer le style anti-flash temporaire si pr√©sent (permet aux tabs de fonctionner)
      const antiFlashStyle = document.getElementById('coach-mode-initial-style');
      if (antiFlashStyle) {
        antiFlashStyle.remove();
        log('[ANTI-FLASH] Style temporaire supprim√©, tabs fonctionnels');
      }

      // Hide all pages
      document.querySelectorAll('.page-content').forEach(page => {
        page.classList.add('hidden');
      });

      // Show selected page
      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        targetPage.classList.remove('hidden');
      }

      // Update tab styles
      document.querySelectorAll('[id$="-tab"]').forEach(tab => {
        tab.classList.remove('btn-primary');
        tab.classList.add('btn-secondary');
      });

      const activeTab = document.getElementById(pageId + '-tab');
      if (activeTab) {
        activeTab.classList.remove('btn-secondary');
        activeTab.classList.add('btn-primary');
      }

      // Afficher le bouton Remboursements uniquement sur page2 (Status)
      const btnRemboursements = document.getElementById('btn-remboursements-nav');
      if (btnRemboursements) {
        if (pageId === 'page2') {
          btnRemboursements.style.display = 'flex';
        } else {
          btnRemboursements.style.display = 'none';
        }
      }

      // Load content based on page (important pour initialisation)
      if (pageId === 'page1') {
        if (typeof chargerClients === 'function') {
          chargerClients();
        }
      } else if (pageId === 'page2') {
        // Charger les donn√©es de Status pour mode coach
        if (typeof utiliserDonneesTestStatus === 'function' && typeof chargerFacturationsColonnes === 'function') {
          utiliserDonneesTestStatus().then(() => {
            chargerFacturationsColonnes();
            // Charger aussi les p√©riodes dans la colonne Trait√©es
            if (typeof chargerPeriodesTraiter === 'function') {
              chargerPeriodesTraiter();
            }
          });
        }
      }
    }

    // Fonction pour afficher la section de paiement s√©lectionn√©e
    function showPaiementSection(section) {
      log('showPaiementSection appel√©e avec:', section);

      // IMPORTANT: G√©rer la visibilit√© des previews pour √©viter la superposition
      const previewRectoDepot = document.getElementById('previewRecto');
      const previewVersoDepot = document.getElementById('previewVerso');
      const previewRectoFinal = document.getElementById('previewRectoFinal');
      const previewVersoFinal = document.getElementById('previewVersoFinal');

      if (section === 'depot') {
        // Afficher les previews du d√©p√¥t, cacher ceux du paiement final
        if (previewRectoDepot) previewRectoDepot.style.display = 'block';
        if (previewVersoDepot) previewVersoDepot.style.display = 'block';
        if (previewRectoFinal) previewRectoFinal.style.display = 'none';
        if (previewVersoFinal) previewVersoFinal.style.display = 'none';
        console.log('‚úÖ Previews d√©p√¥t affich√©s, paiement final cach√©s');
      } else if (section === 'paiement-final') {
        // Afficher les previews du paiement final, cacher ceux du d√©p√¥t
        if (previewRectoFinal) previewRectoFinal.style.display = 'block';
        if (previewVersoFinal) previewVersoFinal.style.display = 'block';
        if (previewRectoDepot) previewRectoDepot.style.display = 'none';
        if (previewVersoDepot) previewVersoDepot.style.display = 'none';
        console.log('‚úÖ Previews paiement final affich√©s, d√©p√¥t cach√©s');
      } else {
        // Pour les autres sections (paiements partiels, etc.), cacher les deux
        if (previewRectoDepot) previewRectoDepot.style.display = 'none';
        if (previewVersoDepot) previewVersoDepot.style.display = 'none';
        if (previewRectoFinal) previewRectoFinal.style.display = 'none';
        if (previewVersoFinal) previewVersoFinal.style.display = 'none';
        console.log('‚úÖ Tous les previews d√©p√¥t/paiement final cach√©s (section:', section, ')');
      }

      // NOTE: La gestion des couleurs de boutons est maintenant enti√®rement d√©l√©gu√©e √†
      // selectionnerClientFacturation() pour √©viter les conflits entre clients
      log('üé® Couleurs de boutons g√©r√©es par selectionnerClientFacturation()');
      
      // G√©rer la visibilit√© du bouton "Envoyer au comptable" selon la section
      const boutonEnvoiContainer = document.getElementById('boutonEnvoiContainer');
      const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
      const statutDepot = clientData.statutDepot || 'non_envoye';
      // Priorit√©: paiementFinal.statut si existe, sinon statutPaiementFinal
      const statutPaiementFinal = clientData.paiementFinal?.statut || clientData.statutPaiementFinal;
      
      // G√©rer l'√©tat du bouton "autres paiements" - d√©sactiver si paiement final en traitement OU si "un seul paiement"
      const btnAutresPaiements = document.getElementById('btn-autres-paiements');
      if (btnAutresPaiements) {
        // V√©rifier si c'est "un seul paiement"
        const autresPaiements = clientData.autresPaiements || [];
        const typePaiementAutres = autresPaiements.length > 0 ? autresPaiements[0]?.typePaiementAutres : null;
        const isUnSeulPaiement = typePaiementAutres === 'un_seul_paiement' ||
                                 (statutDepot === 'non_envoye' && autresPaiements.length > 0);

        const autresPaiementsEnTraitement = autresPaiements.some(p => p.statut === 'traitement' || p.statut === 'traite');

        // V√©rifier si tous les paiements sont complets/trait√©s
        const depotTraite = statutDepot === 'traite' || statutDepot === 'traite_attente_final';
        const paiementFinalTraite = statutPaiementFinal === 'traite';
        const tousAutresPaiementsTraites = autresPaiements.length > 0 && autresPaiements.every(p => p.statut === 'traite');
        const paiementsComplets = depotTraite && (paiementFinalTraite || tousAutresPaiementsTraites);

        if (paiementsComplets) {
          // D√©sactiver si tous les paiements sont complets/trait√©s
          btnAutresPaiements.disabled = true;
          btnAutresPaiements.style.opacity = '0.3';
          btnAutresPaiements.style.cursor = 'not-allowed';
          btnAutresPaiements.style.pointerEvents = 'none';
          log('üö´ Bouton "Autres paiements" d√©sactiv√© (paiements complets)');
        } else if (statutPaiementFinal === 'traitement' || statutPaiementFinal === 'attente_comptable') {
          // D√©sactiver "autres paiements" si paiement final en traitement ou attente_comptable
          btnAutresPaiements.disabled = true;
          btnAutresPaiements.style.opacity = '0.3';
          btnAutresPaiements.style.cursor = 'not-allowed';
          btnAutresPaiements.style.pointerEvents = 'none';
          log('üö´ Bouton "Autres paiements" d√©sactiv√© (paiement final en traitement/attente_comptable)');
        } else if (isUnSeulPaiement && autresPaiementsEnTraitement) {
          // D√©sactiver "autres paiements" si "un seul paiement" en traitement/trait√©
          btnAutresPaiements.disabled = true;
          btnAutresPaiements.style.opacity = '0.3';
          btnAutresPaiements.style.cursor = 'not-allowed';
          btnAutresPaiements.style.pointerEvents = 'none';
          log('üö´ Bouton "Autres paiements" d√©sactiv√© (un seul paiement en traitement)', {isUnSeulPaiement, autresPaiementsEnTraitement});
        } else if (!isUnSeulPaiement && statutPaiementFinal !== 'traitement' && statutPaiementFinal !== 'attente_comptable') {
          // R√©activer SEULEMENT si ce n'est PAS "un seul paiement" ET paiement final pas en traitement/attente_comptable
          btnAutresPaiements.disabled = false;
          btnAutresPaiements.style.opacity = '1';
          btnAutresPaiements.style.cursor = 'pointer';
          btnAutresPaiements.style.pointerEvents = 'auto';
          btnAutresPaiements.style.color = 'white';
          log('[OK] Bouton "Autres paiements" disponible');
        } else {
          log('‚è∏Ô∏è Bouton "Autres paiements" laiss√© dans son √©tat (un seul paiement sans traitement)');
        }
      }
      
      if (boutonEnvoiContainer) {
        // Masquer le bouton seulement si la section COURANTE est d√©j√† trait√©e
        let masquerBouton = false;

        if (section === 'depot' && (statutDepot === 'traitement' || statutDepot === 'traite' || statutDepot === 'attente_comptable' || statutDepot === 'traite_attente_final')) {
          masquerBouton = true;
          log('üö´ Section D√âP√îT d√©j√† trait√©e/en attente, bouton masqu√©');
        } else if (section === 'paiement-final') {
          const statutPaiementFinal = clientData.statutPaiementFinal;
          if (statutPaiementFinal === 'traitement' || statutPaiementFinal === 'traite' || statutPaiementFinal === 'attente_comptable') {
            masquerBouton = true;
            log('üö´ Section PAIEMENT FINAL d√©j√† trait√©e/en attente, bouton masqu√©');
          }
        } else if (section.startsWith('paiement-partiel-')) {
          // Toujours masquer le bouton dans les sections paiement partiel
          masquerBouton = true;
          log('üö´ Section PAIEMENT PARTIEL - bouton masqu√©');
        } else if (section.startsWith('un-seul-paiement-')) {
          // Toujours masquer le bouton dans les sections "un seul paiement"
          masquerBouton = true;
          log('üö´ Section UN SEUL PAIEMENT - bouton masqu√©');
        } else if (section === 'autres-paiements') {
          const statutAutresPaiements = clientData.statutAutresPaiements;
          if (statutAutresPaiements === 'traitement' || statutAutresPaiements === 'traite') {
            masquerBouton = true;
            log('üö´ Section AUTRES PAIEMENTS d√©j√† trait√©e, bouton masqu√©');
          }
        }

        if (masquerBouton) {
          boutonEnvoiContainer.style.display = 'none';
        } else {
          boutonEnvoiContainer.style.display = 'flex';
          log('[OK] Bouton envoyer au comptable affich√© (section:', section, ')');
        }
      }
      
      // R√©initialiser TOUS les boutons de section √† leur couleur de base
      // Inclure les boutons dynamiques de paiements partiels et "un seul paiement"
      let allSectionButtons = ['btn-depot', 'btn-paiement-final', 'btn-autres-paiements'];
      // Ajouter les boutons de paiements partiels s'ils existent
      document.querySelectorAll('[id^="btn-paiement-partiel-"]').forEach(btn => {
        allSectionButtons.push(btn.id);
      });
      // Ajouter les boutons "un seul paiement" s'ils existent
      document.querySelectorAll('[id^="btn-un-seul-paiement-"]').forEach(btn => {
        allSectionButtons.push(btn.id);
      });

      const clientDataSection = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
      const statutDepotSection = clientDataSection.statutDepot || 'non_envoye';
      
      allSectionButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
          // Supprimer la couleur de s√©lection active (btn-primary)
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-secondary');
          
          // R√©initialiser le bouton d√©p√¥t selon son statut quand il n'est plus actif
          if (btnId === 'btn-depot' && statutDepotSection !== 'non_envoye') {
            // Remettre le style de statut normal (pas actif) pour le bouton d√©p√¥t
            changerBoutonDepotStatut(statutDepotSection);
            log('üîÑ Bouton d√©p√¥t remis au style de statut normal:', statutDepotSection);
          } else if (btnId === 'btn-paiement-final') {
            // Remettre le style de statut pour le bouton paiement final (orange si attente_comptable, vert si traite)
            const statutPaiementFinalSection = clientDataSection.paiementFinal?.statut;
            if (statutPaiementFinalSection && statutPaiementFinalSection !== 'non_envoye') {
              changerBoutonPaiementFinalStatut(statutPaiementFinalSection);
              log('üîÑ Bouton paiement final remis au style de statut normal:', statutPaiementFinalSection);
            } else {
              // Si pas de statut, supprimer les couleurs inline
              btn.style.removeProperty('background');
              btn.style.removeProperty('border-color');
              btn.style.removeProperty('color');
            }
          } else if (btnId.startsWith('btn-paiement-partiel-') || btnId.startsWith('btn-un-seul-paiement-')) {
            // Pour les boutons de paiements partiels et "un seul paiement", CONSERVER leurs couleurs (vert/orange)
            // Ne rien faire - les couleurs sont g√©r√©es par genererBoutonsPaiementsPartiels()
            log('üé® Bouton', btnId, 'conserve sa couleur');
          } else if (btnId !== 'btn-depot') {
            // Pour les autres boutons, supprimer les couleurs inline
            btn.style.removeProperty('background');
            btn.style.removeProperty('border-color');
            btn.style.removeProperty('color');
          }
          
          // Supprimer l'indicateur de s√©lection pour tous les boutons
          btn.style.removeProperty('border-width');
          
          log('üîÑ Bouton', btnId, 'remis √† la couleur de base');
        }
      });
      
      // Activer visuellement le bouton de la section courante
      // CAS SP√âCIAL: Si section = 'autres-paiements' et type = 'un_seul_paiement', activer btn-depot au lieu de btn-autres-paiements
      let buttonToActivate = `btn-${section}`;

      if (section === 'autres-paiements') {
        const autresPaiements = clientDataSection.autresPaiements || [];
        const typePaiementAutres = autresPaiements.length > 0 ? autresPaiements[0]?.typePaiementAutres : null;

        // D√©tection fallback
        const detectTypePaiementAutres = typePaiementAutres ||
          (autresPaiements.length > 0 && statutDepotSection === 'non_envoye' ? 'un_seul_paiement' : null);

        if (detectTypePaiementAutres === 'un_seul_paiement') {
          // Activer btn-depot (qui est transform√© en "Un seul paiement")
          buttonToActivate = 'btn-depot';
          log('üîÑ Section autres-paiements avec un_seul_paiement -> activation de btn-depot');
        }
      }

      const currentSectionBtn = document.getElementById(buttonToActivate);
      if (currentSectionBtn) {
        if (currentSectionBtn.id === 'btn-depot') {
          // Pour le bouton d√©p√¥t actif, utiliser btn-primary (bleu) comme les autres
          currentSectionBtn.classList.remove('btn-secondary');
          currentSectionBtn.classList.add('btn-primary');
          log('[OK] Bouton d√©p√¥t activ√© (bleu)');
        } else if (currentSectionBtn.id === 'btn-paiement-final') {
          // Pour le bouton paiement final, v√©rifier si en traitement ou attente_comptable
          const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
          const statutPaiementFinal = clientData.paiementFinal?.statut;

          if (statutPaiementFinal === 'traitement' || statutPaiementFinal === 'attente_comptable' || statutPaiementFinal === 'traite' || statutPaiementFinal === 'traite_attente_final') {
            // Garder le style (orange ou vert selon statut)
            changerBoutonPaiementFinalStatut(statutPaiementFinal);
            log('[OK] Bouton paiement final gard√© avec couleur statut');
          } else {
            // Style normal bleu pour paiement final (pas encore soumis)
            currentSectionBtn.classList.remove('btn-secondary');
            currentSectionBtn.classList.add('btn-primary');
            log('[OK] Bouton paiement final normal activ√©');
          }
        } else {
          // Pour les autres boutons, utiliser btn-primary
          currentSectionBtn.classList.remove('btn-secondary');
          currentSectionBtn.classList.add('btn-primary');
          log('[OK] Bouton section courante activ√©:', section);
        }
      }
      
      // Supprimer l'indicateur de s√©lection des autres boutons si applicable
      allSectionButtons.forEach(btnId => {
        if (btnId !== buttonToActivate) {
          const btn = document.getElementById(btnId);
          if (btn) {
            btn.style.removeProperty('border-width');
          }
        }
      });
      
      // Masquer toutes les sections de contenu sans transition
      document.querySelectorAll('.paiement-content').forEach(content => {
        if (!content.classList.contains('hidden')) {
          content.classList.add('hidden');
        }
      });
      
      // FERMER TOUS LES "√âL√âMENTS √Ä AJOUTER" QUAND ON CHANGE DE SECTION - IND√âPENDANCE COMPL√àTE
      
      // 1. Fermer √©l√©ments √† ajouter D√âP√îT avec !important pour override les styles existants
      const elementsAjouterDepot = document.getElementById('elementsAjouterDepot');
      const virementFieldsDepot = document.getElementById('virementFieldsDepot');
      const chequeFieldsDepot = document.getElementById('chequeFieldsDepot');
      
      if (section !== 'depot') {
        if (elementsAjouterDepot) {
          // Utiliser setProperty avec !important pour override les styles de rendreSectionDepotNonModifiable
          elementsAjouterDepot.style.setProperty('max-height', '0', 'important');
          elementsAjouterDepot.style.setProperty('opacity', '0', 'important');
          elementsAjouterDepot.style.setProperty('display', 'none', 'important');
          elementsAjouterDepot.style.setProperty('visibility', 'hidden', 'important');
          elementsAjouterDepot.style.setProperty('overflow', 'hidden', 'important');
          elementsAjouterDepot.style.setProperty('height', '0', 'important');
        }
        if (virementFieldsDepot) virementFieldsDepot.classList.add('hidden');
        if (chequeFieldsDepot) chequeFieldsDepot.classList.add('hidden');
        log('[LOCK] Fermeture FORC√âE √©l√©ments √† ajouter D√âP√îT avec !important');
      }
      
      // 2. Fermer √©l√©ments √† ajouter PAIEMENT FINAL
      const elementsAjouterPaiementFinal = document.getElementById('elementsAjouterPaiementFinal');
      const virementFieldsPaiementFinal = document.getElementById('virementFieldsPaiementFinal');
      const chequeFieldsPaiementFinal = document.getElementById('chequeFieldsPaiementFinal');
      
      if (section !== 'paiement-final') {
        if (elementsAjouterPaiementFinal) {
          elementsAjouterPaiementFinal.style.maxHeight = '0';
          elementsAjouterPaiementFinal.style.opacity = '0';
        }
        if (virementFieldsPaiementFinal) virementFieldsPaiementFinal.classList.add('hidden');
        if (chequeFieldsPaiementFinal) chequeFieldsPaiementFinal.classList.add('hidden');
        log('[LOCK] Fermeture √©l√©ments √† ajouter PAIEMENT FINAL');
      }
      
      // 3. Fermer √©l√©ments √† ajouter AUTRES PAIEMENTS (s'il y en a)
      const elementsAjouterAutres = document.getElementById('elementsAjouterAutres');
      const virementFieldsAutres = document.getElementById('virementFieldsAutres');
      const chequeFieldsAutres = document.getElementById('chequeFieldsAutres');
      
      if (section !== 'autres-paiements') {
        if (elementsAjouterAutres) {
          elementsAjouterAutres.style.maxHeight = '0';
          elementsAjouterAutres.style.opacity = '0';
        }
        if (virementFieldsAutres) virementFieldsAutres.classList.add('hidden');
        if (chequeFieldsAutres) chequeFieldsAutres.classList.add('hidden');
        log('[LOCK] Fermeture √©l√©ments √† ajouter AUTRES PAIEMENTS');
      }
      
      // 4. R√âINITIALISER TOUS LES DROPDOWNS "PAY√â PAR" SAUF CELUI DE LA SECTION ACTIVE
      const dropdowns = [
        { section: 'depot', toggleId: 'payeParToggle', menuId: 'payeParMenu' },
        { section: 'paiement-final', toggleId: 'payeParFinalToggle', menuId: 'payeParFinalMenu' },
        { section: 'autres-paiements', toggleId: 'payeParAutresToggle', menuId: 'payeParAutresMenu' }
      ];
      
      dropdowns.forEach(dropdown => {
        if (dropdown.section !== section) {
          const toggle = document.getElementById(dropdown.toggleId);
          const menu = document.getElementById(dropdown.menuId);
          
          if (toggle) {
            toggle.innerHTML = '<span class="placeholder" style="color: var(--text-gray);">Choisir m√©thode...</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>';
            toggle.classList.remove('active');
          }
          if (menu) {
            menu.classList.add('hidden');
          }
        }
      });
      
      // R√©initialiser la taille de la card
      const cardContent = document.querySelector('.box-body');
      if (cardContent) cardContent.classList.remove('expanded');
      
      // Activer le bouton s√©lectionn√©
      const activeBtn = document.getElementById(`btn-${section}`);
      if (activeBtn) {
        if (activeBtn.id === 'btn-autres-paiements') {
          // NE PAS colorer le bouton autres paiements - il doit rester avec son style par d√©faut
          log('[OK] Bouton autres-paiements activ√© SANS coloration');
        } else if (activeBtn.id === 'btn-remboursement') {
          // Style actif pour remboursement - couleur rouge
          activeBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
          activeBtn.style.borderColor = '#ef4444';
          activeBtn.style.color = 'white';
        } else {
          // Style actif pour boutons principaux - mais g√©rer sp√©cialement les statuts
          const hasStatusColor = activeBtn.style.background && (
            activeBtn.style.background.includes('f59e0b') || // Orange
            activeBtn.style.background.includes('22c55e')    // Vert
          );
          
          // Cas sp√©cial : bouton d√©p√¥t en traitement -> style orange quand actif
          // V√©rifier si le bouton a le style orange (en traitement)
          const isDepotEnTraitement = activeBtn.id === 'btn-depot' && activeBtn.style.background && activeBtn.style.background.includes('245, 158, 11');
          if (isDepotEnTraitement) {
            activeBtn.style.setProperty('background', 'linear-gradient(135deg, rgb(245, 158, 11), rgb(217, 119, 6))', 'important');
            activeBtn.style.setProperty('border-color', 'rgb(245, 158, 11)', 'important');
            activeBtn.style.setProperty('color', 'white', 'important');
            log('[HOT] Bouton d√©p√¥t (en traitement) activ√© - style orange');
          } else if (!hasStatusColor) {
            // Pas de couleur de statut, appliquer le style actif normal
            activeBtn.classList.remove('btn-secondary');
            activeBtn.classList.add('btn-primary');
          }
          // Si autre couleur de statut pr√©sente, la garder telle quelle
        }
      }
      
      // Afficher le contenu correspondant sans transition
      const activeContent = document.getElementById(`content-${section}`);
      if (activeContent) {
        activeContent.classList.remove('hidden');

        // Restaurer les √©l√©ments √† ajouter quand on revient sur depot
        if (section === 'depot') {
          const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
          const statutDepot = clientData.statutDepot || 'non_envoye';
          const depotMethode = clientData.depot?.methode; // Utiliser "methode" au lieu de "type"

          // Afficher la section √©l√©ments √† ajouter si:
          // - Le d√©p√¥t est en traitement/attente_comptable/trait√© (d√©j√† envoy√© au comptable)
          // - OU si une m√©thode de paiement (virement/ch√®que) a d√©j√† √©t√© s√©lectionn√©e
          const elementsAjouterDepot = document.getElementById('elementsAjouterDepot');
          const virementFieldsDepot = document.getElementById('virementFieldsDepot');
          const chequeFieldsDepot = document.getElementById('chequeFieldsDepot');
          const depotEnTraitement = statutDepot === 'traitement' || statutDepot === 'attente_comptable' || statutDepot === 'traite' || statutDepot === 'traite_attente_final';

          if (elementsAjouterDepot) {
            if (depotEnTraitement || depotMethode) {
              // Forcer la visibilit√© avec !important
              elementsAjouterDepot.style.setProperty('max-height', '1000px', 'important');
              elementsAjouterDepot.style.setProperty('opacity', '1', 'important');
              elementsAjouterDepot.style.setProperty('display', 'block', 'important');
              elementsAjouterDepot.style.setProperty('visibility', 'visible', 'important');
              elementsAjouterDepot.style.setProperty('overflow', 'visible', 'important');
              elementsAjouterDepot.style.setProperty('height', 'auto', 'important');
              log('[RESTORE] Restauration √©l√©ments √† ajouter D√âP√îT (visible) - statut:', statutDepot, 'methode:', depotMethode || 'aucun');

              // Afficher les champs selon la m√©thode
              if (depotMethode === 'virement' && virementFieldsDepot) {
                virementFieldsDepot.classList.remove('hidden');
                virementFieldsDepot.style.setProperty('display', 'grid', 'important');
                if (chequeFieldsDepot) chequeFieldsDepot.classList.add('hidden');
                log('[OK] Champs virement D√âP√îT affich√©s');
              } else if (depotMethode === 'ch√®que' && chequeFieldsDepot) {
                chequeFieldsDepot.classList.remove('hidden');
                chequeFieldsDepot.style.setProperty('display', 'grid', 'important');
                chequeFieldsDepot.style.setProperty('opacity', '1', 'important');
                chequeFieldsDepot.style.setProperty('visibility', 'visible', 'important');
                chequeFieldsDepot.style.setProperty('max-height', 'none', 'important');
                if (virementFieldsDepot) virementFieldsDepot.classList.add('hidden');
                log('[OK] Champs ch√®que D√âP√îT affich√©s');
              }

              // Si en traitement, appeler rendreSectionDepotNonModifiable pour griser les champs
              if (depotEnTraitement) {
                setTimeout(() => {
                  rendreSectionDepotNonModifiable();
                }, 50);
              }
            } else {
              // Garder cach√© si pas en traitement ET pas de m√©thode s√©lectionn√©e
              elementsAjouterDepot.style.setProperty('max-height', '0', 'important');
              elementsAjouterDepot.style.setProperty('opacity', '0', 'important');
              log('[HIDE] Section √©l√©ments √† ajouter D√âP√îT cach√©e (pas en traitement, pas de m√©thode)');
            }
          }
        }

        // Restaurer les √©l√©ments √† ajouter quand on revient sur paiement-final
        if (section === 'paiement-final') {
          const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
          const statutPaiementFinal = clientData.paiementFinal?.statut || clientData.statutPaiementFinal;
          const paiementFinalType = clientData.paiementFinal?.methode || clientData.paiementFinal?.type;

          // Afficher la section √©l√©ments √† ajouter SEULEMENT si:
          // - Le paiement est en traitement/attente_comptable/trait√© (d√©j√† envoy√© au comptable)
          // - OU si un type de paiement (virement/cheque) a d√©j√† √©t√© s√©lectionn√©
          const elementsAjouterPaiementFinal = document.getElementById('elementsAjouterPaiementFinal');
          const paiementFinalEnTraitement = statutPaiementFinal === 'traitement' || statutPaiementFinal === 'attente_comptable' || statutPaiementFinal === 'traite';

          if (elementsAjouterPaiementFinal) {
            if (paiementFinalEnTraitement || paiementFinalType) {
              // Visible si en traitement OU si un type est d√©j√† s√©lectionn√©
              elementsAjouterPaiementFinal.style.maxHeight = '2000px';
              elementsAjouterPaiementFinal.style.opacity = '1';
              log('[RESTORE] Restauration √©l√©ments √† ajouter PAIEMENT FINAL (visible) - statut:', statutPaiementFinal || 'aucun', 'type:', paiementFinalType || 'aucun');
            } else {
              // Garder cach√© si pas en traitement ET pas de type s√©lectionn√©
              elementsAjouterPaiementFinal.style.maxHeight = '0';
              elementsAjouterPaiementFinal.style.opacity = '0';
              log('[HIDE] Section √©l√©ments √† ajouter PAIEMENT FINAL cach√©e (pas en traitement, pas de type)');
            }
          }
        }

        // Griser la section autres paiements si elle est en traitement/trait√©
        if (section === 'autres-paiements') {
          const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
          const autresPaiements = clientData.autresPaiements || [];
          if (autresPaiements.length > 0) {
            const hasTraitement = autresPaiements.some(p => p.statut === 'traitement');
            const hasTraite = autresPaiements.some(p => p.statut === 'traite');
            if (hasTraitement || hasTraite) {
              log('[LOCK] Section autres paiements en traitement/trait√©, appel rendreSectionAutresPaiementsNonModifiable');
              rendreSectionAutresPaiementsNonModifiable();
            }
          }

          // === NOUVEAU: G√©rer la visibilit√© de l'option "Un seul paiement" quand la section s'ouvre ===
          gererVisibiliteUnSeulPaiement();
          log('[OK] Visibilit√© option "Un seul paiement" mise √† jour lors ouverture section');

          // === NOUVEAU: Pr√©-s√©lectionner "Paiement partiel" si le d√©p√¥t est en traitement/trait√© ===
          preselectionnerPaiementPartielSiNecessaire();
        }

        // Pr√©-remplir et griser les champs selon le client s√©lectionn√©
        preremplirChampsSelon(section);
      }

      log(`Section ${section} s√©lectionn√©e`);
    }

    // Fonction pour pr√©-remplir et griser les champs selon le client et la section
    function preremplirChampsSelon(section) {
      const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
      if (!clientData.num) return;
      
      log('[FIX] PR√âREMPLISSAGE pour section:', section, 'clientData:', clientData);
      
      const statutDepot = clientData.statutDepot || 'non_envoye';
      const depotTraiteOuEnTraitement = (statutDepot === 'traitement' || statutDepot === 'traite');
      
      if (section === 'depot') {
        // Section D√©p√¥t
        const paiementInput = document.getElementById('paiement');
        const dateDepotInput = document.getElementById('dateDepot');

        // Fonction helper pour nettoyer et parser les montants
        const cleanAndParseAmount = (montant) => {
          if (!montant) return 0;
          const cleanValue = String(montant)
            .replace(/\s/g, '')
            .replace(/,/g, '.')
            .replace(/[^\d.]/g, '');
          return parseFloat(cleanValue) || 0;
        };

        // CALCULER AUTOMATIQUEMENT 25% DU MONTANT TOTAL + TAXES PAR D√âFAUT
        if (!clientData.depot || !clientData.depot.montant || clientData.depot.montant === '0,00' || clientData.depot.montant === '0,00 $') {
          // Seulement si le montant n'est pas d√©j√† d√©fini
          const totalTravauxInput = document.getElementById('totalTravauxClient');

          if (totalTravauxInput && totalTravauxInput.value && paiementInput) {
            const totalTravaux = cleanAndParseAmount(totalTravauxInput.value);
            const totalAvecTaxes = calculerTotalAvecTaxes(totalTravaux);
            const depotDefaut = totalAvecTaxes * 0.25; // 25% du total avec taxes

            if (depotDefaut > 0) {
              paiementInput.value = formatMontant(depotDefaut);
              log('[INFO] D√âP√îT calcul√© automatiquement (25%):', depotDefaut, '= 25% de', totalAvecTaxes);
            }
          }
        } else if (clientData.depot) {
          // Pr√©-remplir le montant existant - g√®re les formats texte comme "250,00 $"
          if (paiementInput && clientData.depot.montant && clientData.depot.montant !== '0,00' && clientData.depot.montant !== '0,00 $') {
            const montantValue = typeof clientData.depot.montant === 'string' ?
              clientData.depot.montant.replace(/[$ ]/g, '').replace(',', '.') : clientData.depot.montant;
            paiementInput.value = clientData.depot.montant; // Garder le format original avec $
            log('[MONEY] D√âP√îT: Montant pr√©-rempli:', clientData.depot.montant);
          }
        }

        // Toujours pr√©-remplir les autres champs s'il y a des donn√©es
        if (clientData.depot) {
          
          // Pr√©-remplir la date si pr√©sente
          if (dateDepotInput && clientData.depot.date) {
            dateDepotInput.value = clientData.depot.date;
            log('[DATE] D√âP√îT: Date pr√©-remplie:', clientData.depot.date);
          }
          
          // Pr√©-remplir le type de paiement - utiliser 'methode' au lieu de 'type'
          const typeDepot = clientData.depot.methode || clientData.depot.type;
          log('[DEBUG] DEBUG TypeDepot:', {
            typeDepot,
            'clientData.depot.methode': clientData.depot.methode,
            'clientData.depot.type': clientData.depot.type
          });
          if (typeDepot && typeDepot.trim() !== '') {
            const payeParToggle = document.querySelector('#content-depot .modern-dropdown .placeholder');
            if (payeParToggle) {
              const typeText = typeDepot === 'virement' ? 'Virement' : 
                              typeDepot === 'cheque' ? 'Ch√®que' : typeDepot;
              payeParToggle.textContent = typeText;
              
              // ROUVRIR les √©l√©ments √† ajouter SEULEMENT si un type est d√©j√† s√©lectionn√© ET que le client n'est PAS en attente de d√©p√¥t
              const elementsAjouterDepot = document.getElementById('elementsAjouterDepot');
              const virementFieldsDepot = document.getElementById('virementFieldsDepot');
              const chequeFieldsDepot = document.getElementById('chequeFieldsDepot');
              
              // Ne rouvrir QUE si le client a un type d√©fini ET n'est pas en attente de d√©p√¥t ET on est dans la section d√©p√¥t
              if (elementsAjouterDepot && 
                  (typeDepot === 'virement' || typeDepot === 'cheque') && 
                  statutDepot !== 'non_envoye' &&
                  section === 'depot') {
                // Utiliser setProperty avec !important pour override les fermetures pr√©c√©dentes
                elementsAjouterDepot.style.setProperty('max-height', '1000px', 'important');
                elementsAjouterDepot.style.setProperty('opacity', '1', 'important');
                elementsAjouterDepot.style.setProperty('display', 'block', 'important');
                elementsAjouterDepot.style.setProperty('visibility', 'visible', 'important');
                elementsAjouterDepot.style.setProperty('overflow', 'visible', 'important');
                elementsAjouterDepot.style.setProperty('height', 'auto', 'important');
                log('[UNLOCK] R√âOUVERTURE: √âl√©ments d√©p√¥t forc√©s visibles avec !important pour', section);
                
                if (typeDepot === 'virement') {
                  if (virementFieldsDepot) virementFieldsDepot.classList.remove('hidden');
                  if (chequeFieldsDepot) chequeFieldsDepot.classList.add('hidden');
                  
                  // Pr√©-remplir et griser les champs virement si disponibles
                  log('[DEBUG] DEBUG Virement - clientData.depot:', clientData.depot);
                  log('[DEBUG] DEBUG Virement - lienVirement:', clientData.depot?.lienVirement);
                  log('[DEBUG] DEBUG Virement - motDePasse:', clientData.depot?.motDePasse);
                  log('[DEBUG] DEBUG Virement - depotTraiteOuEnTraitement:', depotTraiteOuEnTraitement);
                  
                  const lienInput = document.querySelector('input[name="lien_virement"]');
                  const mdpInput = document.querySelector('input[name="mdp_virement"]');
                  
                  log('[DEBUG] DEBUG √âl√©ments DOM:', {
                    lienInput: !!lienInput,
                    mdpInput: !!mdpInput
                  });
                  
                  // Toujours pr√©-remplir et griser les champs si le d√©p√¥t est en traitement
                  if (lienInput) {
                    // Pr√©-remplir avec la valeur sauvegard√©e (ou vide si pas de valeur)
                    lienInput.value = clientData.depot?.lienVirement || '';
                    log('[OK] Lien virement rempli:', lienInput.value || '(vide)');
                    
                    // Griser si d√©p√¥t trait√© ou en traitement (m√™me si vide)
                    if (depotTraiteOuEnTraitement) {
                      lienInput.readOnly = true;
                      lienInput.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
                      lienInput.style.setProperty('color', 'var(--text-light)', 'important');
                      lienInput.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
                      lienInput.style.setProperty('cursor', 'not-allowed', 'important');
                      lienInput.style.setProperty('opacity', '0.7', 'important');
                      lienInput.style.pointerEvents = 'none';
                      log('[LOCK] Lien virement gris√© uniform√©ment');
                    }
                  }
                  
                  if (mdpInput) {
                    // Pr√©-remplir avec la valeur sauvegard√©e (ou vide si pas de valeur)
                    mdpInput.value = clientData.depot?.motDePasse || '';
                    log('[OK] Mot de passe rempli:', mdpInput.value || '(vide)');
                    
                    // Griser si d√©p√¥t trait√© ou en traitement (m√™me si vide)
                    if (depotTraiteOuEnTraitement) {
                      mdpInput.readOnly = true;
                      mdpInput.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
                      mdpInput.style.setProperty('color', 'var(--text-light)', 'important');
                      mdpInput.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
                      mdpInput.style.setProperty('cursor', 'not-allowed', 'important');
                      mdpInput.style.setProperty('opacity', '0.7', 'important');
                      mdpInput.style.pointerEvents = 'none';

                      // Retirer le placeholder si le champ est vide quand c'est gris√©
                      if (!mdpInput.value || mdpInput.value.trim() === '') {
                        mdpInput.placeholder = '';
                        log('[LOCK] Placeholder retir√© du mot de passe (champ vide et gris√©)');
                      }
                      
                      log('[LOCK] Mot de passe gris√© uniform√©ment');
                    }
                  }
                  log('üîÑ D√âP√îT: √âl√©ments √† ajouter virement r√©ouverts');
                } else if (typeDepot === 'cheque') {
                  if (chequeFieldsDepot) chequeFieldsDepot.classList.remove('hidden');
                  if (virementFieldsDepot) virementFieldsDepot.classList.add('hidden');
                  
                  // Pr√©-remplir et griser le num√©ro de ch√®que si disponible
                  if (clientData.depot.numeroCheque) {
                    const numChequeInput = document.querySelector('input[name="num_cheque"]');
                    if (numChequeInput) {
                      numChequeInput.value = clientData.depot.numeroCheque;
                      // Griser si d√©p√¥t trait√© ou en traitement
                      if (depotTraiteOuEnTraitement) {
                        numChequeInput.readOnly = true;
                        numChequeInput.style.backgroundColor = 'rgba(55, 65, 81, 0.3)';
                        numChequeInput.style.color = '#9ca3af';
                        numChequeInput.style.cursor = 'not-allowed';
                      }
                    }
                  }
                  log('üîÑ D√âP√îT: √âl√©ments √† ajouter ch√®que r√©ouverts');
                }
              } else if (section !== 'depot') {
                // Si on n'est PAS dans la section d√©p√¥t, s'assurer que les √©l√©ments d√©p√¥t sont ferm√©s
                elementsAjouterDepot.style.maxHeight = '0';
                elementsAjouterDepot.style.opacity = '0';
                if (virementFieldsDepot) virementFieldsDepot.classList.add('hidden');
                if (chequeFieldsDepot) chequeFieldsDepot.classList.add('hidden');
                log('[LOCK] D√âP√îT: √âl√©ments √† ajouter forc√©s ferm√©s (pas dans section d√©p√¥t)');
              }
            }
          }
        }
        
        // GRISER LES CHAMPS seulement si PAS "en attente du d√©p√¥t"
        if (statutDepot !== 'non_envoye') {
          log('[LOCK] D√âP√îT: Grisage des champs (statut:', statutDepot + ')');

          // Griser $ D√©p√¥t avec le style exact demand√©
          if (paiementInput) {
            paiementInput.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
            paiementInput.style.setProperty('color', 'var(--text-light)', 'important');
            paiementInput.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
            paiementInput.style.setProperty('cursor', 'not-allowed', 'important');
            paiementInput.style.setProperty('opacity', '0.7', 'important');
            paiementInput.readOnly = true;
            paiementInput.style.pointerEvents = 'none';
          }

          // Griser Date d√©p√¥t avec le style exact demand√©
          if (dateDepotInput) {
            dateDepotInput.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
            dateDepotInput.style.setProperty('color', 'var(--text-light)', 'important');
            dateDepotInput.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
            dateDepotInput.style.setProperty('cursor', 'not-allowed', 'important');
            dateDepotInput.style.setProperty('opacity', '0.7', 'important');
            dateDepotInput.readOnly = true;
            dateDepotInput.style.pointerEvents = 'none';
            dateDepotInput.disabled = true;
          }

          // Griser le dropdown "Pay√© par" avec le style exact demand√©
          const payeParDropdown = document.querySelector('#content-depot .modern-dropdown');
          if (payeParDropdown) {
            payeParDropdown.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
            payeParDropdown.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
            payeParDropdown.style.setProperty('cursor', 'not-allowed', 'important');
            payeParDropdown.style.setProperty('opacity', '0.7', 'important');
            payeParDropdown.style.pointerEvents = 'none';
            const placeholder = payeParDropdown.querySelector('.placeholder');
            if (placeholder) {
              placeholder.style.setProperty('color', 'var(--text-light)', 'important');
            }
          }

          // Griser TOUS les champs dans "√âl√©ments √† ajouter" avec le style exact demand√©
          const elementsAjouterDepotGriser = document.getElementById('elementsAjouterDepot');
          if (elementsAjouterDepotGriser) {
            // Griser tous les inputs dans √©l√©ments √† ajouter
            const inputsElements = elementsAjouterDepotGriser.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="number"]');
            inputsElements.forEach(input => {
              input.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
              input.style.setProperty('color', 'var(--text-light)', 'important');
              input.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
              input.style.setProperty('cursor', 'not-allowed', 'important');
              input.style.setProperty('opacity', '0.7', 'important');
              input.readOnly = true;
              input.style.pointerEvents = 'none';
            });

            // Griser √©galement les zones de dropzone (upload)
            const dropzones = elementsAjouterDepotGriser.querySelectorAll('.upload-zone-small');
            dropzones.forEach(zone => {
              zone.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
              zone.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
              zone.style.setProperty('cursor', 'not-allowed', 'important');
              zone.style.setProperty('opacity', '0.7', 'important');
              zone.style.pointerEvents = 'none';
            });
          }
        } else {
          log('[OK] D√âP√îT: Champs laiss√©s modifiables (en attente du d√©p√¥t)');
          
          // S'ASSURER que tous les champs sont bien normaux pour les clients en attente
          if (paiementInput) {
            paiementInput.style.removeProperty('background-color');
            paiementInput.style.removeProperty('color');
            paiementInput.readOnly = false;
            paiementInput.style.removeProperty('cursor');
            paiementInput.style.removeProperty('pointer-events');
          }
          if (dateDepotInput) {
            dateDepotInput.style.removeProperty('background-color');
            dateDepotInput.style.removeProperty('color');
            dateDepotInput.readOnly = false;
            dateDepotInput.style.removeProperty('pointer-events');
            dateDepotInput.style.removeProperty('cursor');
            dateDepotInput.disabled = false;
          }

          // S'assurer que le dropdown "Pay√© par" est normal
          const payeParDropdown = document.querySelector('#content-depot .modern-dropdown');
          if (payeParDropdown) {
            payeParDropdown.style.removeProperty('background-color');
            payeParDropdown.style.removeProperty('pointer-events');
            payeParDropdown.style.removeProperty('cursor');
            payeParDropdown.style.removeProperty('opacity');
            const placeholder = payeParDropdown.querySelector('.placeholder');
            if (placeholder) {
              placeholder.style.removeProperty('color');
            }
          }

          // S'assurer que les √©l√©ments √† ajouter sont FERM√âS pour les clients en attente de d√©p√¥t
          const elementsAjouterDepot = document.getElementById('elementsAjouterDepot');
          const virementFieldsDepot = document.getElementById('virementFieldsDepot');
          const chequeFieldsDepot = document.getElementById('chequeFieldsDepot');

          if (elementsAjouterDepot) {
            // FERMER la section √©l√©ments √† ajouter pour les clients en attente de d√©p√¥t
            elementsAjouterDepot.style.maxHeight = '0';
            elementsAjouterDepot.style.opacity = '0';
            log('[LOCK] D√âP√îT: √âl√©ments √† ajouter ferm√©s (en attente de d√©p√¥t)');

            // Cacher les champs virement et ch√®que
            if (virementFieldsDepot) virementFieldsDepot.classList.add('hidden');
            if (chequeFieldsDepot) chequeFieldsDepot.classList.add('hidden');

            // S'assurer que les champs sont normaux (pas gris√©s) m√™me si ferm√©s
            elementsAjouterDepot.style.removeProperty('pointer-events');
            const inputsElements = elementsAjouterDepot.querySelectorAll('input');
            inputsElements.forEach(input => {
              input.style.removeProperty('background');
              input.style.removeProperty('background-color');
              input.style.removeProperty('color');
              input.style.removeProperty('cursor');
              input.style.removeProperty('pointer-events');
              input.readOnly = false;
              input.disabled = false;
            });

            // Remettre les dropzones √† l'√©tat normal
            const dropzones = elementsAjouterDepot.querySelectorAll('.upload-zone-small');
            dropzones.forEach(zone => {
              zone.style.removeProperty('background-color');
              zone.style.removeProperty('cursor');
              zone.style.removeProperty('pointer-events');
              zone.style.removeProperty('opacity');
            });
          }

          log('[OK] D√âP√îT: Tous les champs remis en √©tat normal (en attente du d√©p√¥t)');
        }
        
      } else if (section === 'paiement-final') {
        // Section Paiement Final
        
        // AFFICHER DISCLAIMER SI CLIENT EN ATTENTE DE D√âP√îT
        const disclaimerPaiementFinal = document.getElementById('disclaimerPaiementFinal');
        if (disclaimerPaiementFinal) {
          if (statutDepot === 'non_envoye') {
            disclaimerPaiementFinal.classList.remove('hidden');
            log('[WARN] PAIEMENT FINAL: Disclaimer affich√© (client en attente de d√©p√¥t)');
          } else {
            disclaimerPaiementFinal.classList.add('hidden');
            log('[OK] PAIEMENT FINAL: Disclaimer masqu√© (d√©p√¥t trait√©)');
          }
        }
        
        const paiementFinalInput = document.getElementById('paiementFinal');
        const datePaiementFinalInput = document.getElementById('datePaiementFinal');

        log('[DEBUG] DEBUG PAIEMENT FINAL - clientData.paiementFinal:', clientData.paiementFinal);
        log('[DEBUG] DEBUG PAIEMENT FINAL - montant:', clientData.paiementFinal?.montant, 'type:', typeof clientData.paiementFinal?.montant);

        // Fonction helper pour nettoyer et parser les montants
        const cleanAndParseAmount = (montant) => {
          if (!montant) return 0;
          const cleanValue = String(montant)
            .replace(/\s/g, '')
            .replace(/,/g, '.')
            .replace(/[^\d.]/g, '');
          return parseFloat(cleanValue) || 0;
        };

        // CALCULER AUTOMATIQUEMENT LE MONTANT RESTANT √Ä PAYER
        if (!clientData.paiementFinal || !clientData.paiementFinal.montant || parseFloat(clientData.paiementFinal.montant) === 0) {
          // Seulement si le montant n'est pas d√©j√† d√©fini
          const totalTravauxInput = document.getElementById('totalTravauxClient');

          if (totalTravauxInput && totalTravauxInput.value) {
            // 1. Calculer le total AVEC TAXES
            const totalTravaux = cleanAndParseAmount(totalTravauxInput.value);
            const totalAvecTaxes = calculerTotalAvecTaxes(totalTravaux);

            // 2. Calculer tous les montants d√©j√† trait√©s OU en traitement
            let montantsDejaPayes = 0;

            // Ajouter le d√©p√¥t si trait√© ou en traitement (inclure traite_attente_final et attente_comptable)
            if (clientData.depot && (clientData.depot.statut === 'traite' || clientData.depot.statut === 'traitement' || clientData.depot.statut === 'traite_attente_final' || clientData.depot.statut === 'attente_comptable')) {
              montantsDejaPayes += cleanAndParseAmount(clientData.depot.montant);
              log('[MONEY] D√©p√¥t ajout√© aux montants pay√©s:', cleanAndParseAmount(clientData.depot.montant));
            } else if ((clientData.statutDepot === 'traite' || clientData.statutDepot === 'traitement' || clientData.statutDepot === 'traite_attente_final' || clientData.statutDepot === 'attente_comptable')) {
              const paiementInput = document.getElementById('paiement');
              if (paiementInput && paiementInput.value) {
                montantsDejaPayes += cleanAndParseAmount(paiementInput.value);
                log('[MONEY] D√©p√¥t ajout√© aux montants pay√©s (depuis input):', cleanAndParseAmount(paiementInput.value));
              }
            }

            // Ajouter les autres paiements si ils existent et sont trait√©s ou en traitement (inclure attente_comptable)
            if (clientData.autresPaiements && Array.isArray(clientData.autresPaiements)) {
              clientData.autresPaiements.forEach(paiement => {
                if (paiement.statut === 'traite' || paiement.statut === 'traitement' || paiement.statut === 'attente_comptable') {
                  montantsDejaPayes += cleanAndParseAmount(paiement.montant);
                  log('[MONEY] Autre paiement ajout√©:', cleanAndParseAmount(paiement.montant), '(statut:', paiement.statut, ')');
                }
              });
            }

            // 3. Calculer le montant restant
            const montantRestant = totalAvecTaxes - montantsDejaPayes;

            if (montantRestant > 0 && paiementFinalInput) {
              paiementFinalInput.value = formatMontant(montantRestant);
              log('[INFO] PAIEMENT FINAL calcul√© automatiquement:', montantRestant, '= Total avec taxes:', totalAvecTaxes, '- Montants pay√©s:', montantsDejaPayes);
            }
          }
        } else if (clientData.paiementFinal && clientData.paiementFinal.montant && (parseFloat(clientData.paiementFinal.montant) > 0 || clientData.paiementFinal.montant !== '0,00 $')) {
          // Pr√©-remplir avec les vraies valeurs existantes
          if (paiementFinalInput) {
            paiementFinalInput.value = formatMontant(clientData.paiementFinal.montant);
          }
          if (datePaiementFinalInput) {
            datePaiementFinalInput.value = clientData.paiementFinal.date;
          }
          
          // Pr√©-remplir le type de paiement (Pay√© par) SEULEMENT si vraiment d√©fini
          const typePaiement = clientData.paiementFinal.type || clientData.paiementFinal.methode;
          if (typePaiement && typePaiement.trim() !== '') {
            const payeParToggle = document.querySelector('#content-paiement-final .modern-dropdown .placeholder');
            if (payeParToggle) {
              const typeText = typePaiement === 'virement' ? 'Virement' : 
                              typePaiement === 'cheque' ? 'Ch√®que' : typePaiement;
              payeParToggle.textContent = typeText;
              
              // ROUVRIR les √©l√©ments √† ajouter SEULEMENT si un type est d√©j√† s√©lectionn√© ET que le paiement a un statut avanc√©
              const elementsAjouterPaiementFinal = document.getElementById('elementsAjouterPaiementFinal');
              const virementFieldsPaiementFinal = document.getElementById('virementFieldsPaiementFinal');
              const chequeFieldsPaiementFinal = document.getElementById('chequeFieldsPaiementFinal');
              
              // Ne rouvrir QUE si le client a un type d√©fini ET le paiement final est d√©j√† en cours de traitement
              const paiementTraiteOuEnTraitement = (clientData.paiementFinal.statut === 'envoye' ||
                                                   clientData.paiementFinal.statut === 'traitement' ||
                                                   clientData.paiementFinal.statut === 'attente_comptable' ||
                                                   clientData.paiementFinal.statut === 'traite_attente_final' ||
                                                   clientData.paiementFinal.statut === 'traite');

              if (elementsAjouterPaiementFinal &&
                  (typePaiement === 'virement' || typePaiement === 'cheque') &&
                  paiementTraiteOuEnTraitement) {
                // Utiliser !important pour s'assurer que la section s'ouvre
                elementsAjouterPaiementFinal.style.setProperty('max-height', '1000px', 'important');
                elementsAjouterPaiementFinal.style.setProperty('opacity', '1', 'important');
                elementsAjouterPaiementFinal.style.setProperty('display', 'block', 'important');
                elementsAjouterPaiementFinal.style.setProperty('visibility', 'visible', 'important');
                
                if (typePaiement === 'virement') {
                  if (virementFieldsPaiementFinal) virementFieldsPaiementFinal.classList.remove('hidden');
                  if (chequeFieldsPaiementFinal) chequeFieldsPaiementFinal.classList.add('hidden');
                  
                  // Pr√©-remplir et griser les champs virement paiement final
                  const lienVirementFinal = virementFieldsPaiementFinal.querySelector('input[name="lien_virement_final"]');
                  const mdpVirementFinal = virementFieldsPaiementFinal.querySelector('input[name="mdp_virement_final"]');
                  
                  if (lienVirementFinal && clientData.paiementFinal.lienVirement) {
                    lienVirementFinal.value = clientData.paiementFinal.lienVirement;
                    lienVirementFinal.readOnly = true;
                    lienVirementFinal.style.backgroundColor = 'rgba(55, 65, 81, 0.3)';
                    lienVirementFinal.style.color = '#9ca3af';
                  }
                  
                  if (mdpVirementFinal) {
                    if (clientData.paiementFinal.motDePasse) {
                      mdpVirementFinal.value = clientData.paiementFinal.motDePasse;
                    } else {
                      // Retirer placeholder si vide et gris√©  
                      mdpVirementFinal.placeholder = '';
                    }
                    mdpVirementFinal.readOnly = true;
                    mdpVirementFinal.style.backgroundColor = 'rgba(55, 65, 81, 0.3)';
                    mdpVirementFinal.style.color = '#9ca3af';
                    mdpVirementFinal.style.cursor = 'not-allowed';
                  }
                  
                  log('üîÑ PAIEMENT FINAL: √âl√©ments virement pr√©-remplis et gris√©s (statut traitement)');
                } else if (typePaiement === 'cheque') {
                  if (chequeFieldsPaiementFinal) chequeFieldsPaiementFinal.classList.remove('hidden');
                  if (virementFieldsPaiementFinal) virementFieldsPaiementFinal.classList.add('hidden');
                  
                  // Pr√©-remplir et griser les champs ch√®que paiement final si applicable
                  const numeroChequeInput = chequeFieldsPaiementFinal.querySelector('input[name="num_cheque_final"]');
                  if (numeroChequeInput && clientData.paiementFinal.numeroCheque) {
                    numeroChequeInput.value = clientData.paiementFinal.numeroCheque;
                    numeroChequeInput.readOnly = true;
                    numeroChequeInput.style.backgroundColor = 'rgba(55, 65, 81, 0.3)';
                    numeroChequeInput.style.color = '#9ca3af';
                  }
                  
                  log('üîÑ PAIEMENT FINAL: √âl√©ments ch√®que pr√©-remplis et gris√©s (statut traitement)');
                }
              }
            }
          }
          
          // Si envoy√©, en traitement, attente_comptable ou trait√©, griser les champs
          const paiementTraiteOuEnTraitement = (clientData.paiementFinal && (clientData.paiementFinal.statut === 'envoye' ||
                                               clientData.paiementFinal.statut === 'traitement' ||
                                               clientData.paiementFinal.statut === 'attente_comptable' ||
                                               clientData.paiementFinal.statut === 'traite_attente_final' ||
                                               clientData.paiementFinal.statut === 'traite'));
          if (paiementTraiteOuEnTraitement) {
            log('[LOCK] PAIEMENT FINAL: Grisage des champs (statut:', clientData.paiementFinal.statut + ')');

            // Fonction pour appliquer le grisage
            const appliquerGrisagePaiementFinal = () => {
              // Griser $ Paiement final avec le style exact demand√©
              if (paiementFinalInput) {
                paiementFinalInput.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
                paiementFinalInput.style.setProperty('color', 'var(--text-light)', 'important');
                paiementFinalInput.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
                paiementFinalInput.style.setProperty('cursor', 'not-allowed', 'important');
                paiementFinalInput.style.setProperty('opacity', '0.7', 'important');
                paiementFinalInput.readOnly = true;
                paiementFinalInput.style.pointerEvents = 'none';
              }

              // Griser Date paiement final avec le style exact demand√©
              if (datePaiementFinalInput) {
                datePaiementFinalInput.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
                datePaiementFinalInput.style.setProperty('color', 'var(--text-light)', 'important');
                datePaiementFinalInput.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
                datePaiementFinalInput.style.setProperty('cursor', 'not-allowed', 'important');
                datePaiementFinalInput.style.setProperty('opacity', '0.7', 'important');
                datePaiementFinalInput.readOnly = true;
                datePaiementFinalInput.style.pointerEvents = 'none';
                datePaiementFinalInput.disabled = true;
              }

              // Griser le dropdown "Pay√© par" avec le style exact demand√©
              const payeParDropdown = document.querySelector('#content-paiement-final .modern-dropdown');
              if (payeParDropdown) {
                payeParDropdown.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
                payeParDropdown.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
                payeParDropdown.style.setProperty('cursor', 'not-allowed', 'important');
                payeParDropdown.style.setProperty('opacity', '0.7', 'important');
                payeParDropdown.style.pointerEvents = 'none';
                const placeholder = payeParDropdown.querySelector('.placeholder');
                if (placeholder) {
                  placeholder.style.setProperty('color', 'var(--text-light)', 'important');
                }
              }

              // Griser TOUS les champs dans "√âl√©ments √† ajouter" avec le style exact demand√©
              const elementsAjouterPaiementFinalGriser = document.getElementById('elementsAjouterPaiementFinal');
              if (elementsAjouterPaiementFinalGriser) {
                // Griser tous les inputs dans √©l√©ments √† ajouter
                const inputsElements = elementsAjouterPaiementFinalGriser.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="number"]');
                inputsElements.forEach(input => {
                  input.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
                  input.style.setProperty('color', 'var(--text-light)', 'important');
                  input.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
                  input.style.setProperty('cursor', 'not-allowed', 'important');
                  input.style.setProperty('opacity', '0.7', 'important');
                  input.readOnly = true;
                  input.style.pointerEvents = 'none';
                });

                // Griser √©galement les zones de dropzone (upload)
                const dropzones = elementsAjouterPaiementFinalGriser.querySelectorAll('.upload-zone-small');
                dropzones.forEach(zone => {
                  zone.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
                  zone.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
                  zone.style.setProperty('cursor', 'not-allowed', 'important');
                  zone.style.setProperty('opacity', '0.7', 'important');
                  zone.style.pointerEvents = 'none';
                });
              }

              // Afficher les informations de paiement m√™me quand gris√©
              afficherInfosPaiementGrisees('paiement-final');
            };

            // Appliquer imm√©diatement
            appliquerGrisagePaiementFinal();

            // R√©appliquer apr√®s un d√©lai pour s'assurer que √ßa reste appliqu√©
            setTimeout(appliquerGrisagePaiementFinal, 50);
            setTimeout(appliquerGrisagePaiementFinal, 200);
          } else {
            // Pour les paiements finaux normaux (pas en traitement), s'assurer que les √©l√©ments √† ajouter sont ferm√©s
            const elementsAjouterPaiementFinal = document.getElementById('elementsAjouterPaiementFinal');
            const virementFieldsPaiementFinal = document.getElementById('virementFieldsPaiementFinal');
            const chequeFieldsPaiementFinal = document.getElementById('chequeFieldsPaiementFinal');
            
            if (elementsAjouterPaiementFinal) {
              // FERMER la section √©l√©ments √† ajouter par d√©faut
              elementsAjouterPaiementFinal.style.maxHeight = '0';
              elementsAjouterPaiementFinal.style.opacity = '0';
              log('[LOCK] PAIEMENT FINAL: √âl√©ments √† ajouter ferm√©s par d√©faut');
              
              // Cacher les champs virement et ch√®que
              if (virementFieldsPaiementFinal) virementFieldsPaiementFinal.classList.add('hidden');
              if (chequeFieldsPaiementFinal) chequeFieldsPaiementFinal.classList.add('hidden');
              
              // S'assurer que les champs sont normaux (pas gris√©s) m√™me si ferm√©s
              elementsAjouterPaiementFinal.style.removeProperty('pointer-events');
              const inputsElements = elementsAjouterPaiementFinal.querySelectorAll('input');
              inputsElements.forEach(input => {
                input.style.removeProperty('background');
                input.style.removeProperty('color');
                input.style.removeProperty('cursor');
                input.disabled = false;
              });
            }
          }
        }
      }
      
      log(`[FIX] FACTURATION: Champs pr√©-remplis pour section ${section}`);
    }

    // Fonction pour activer/d√©sactiver la section paiements
    function toggleSectionPaiements(activer = false) {
      const sectionPaiements = document.getElementById('sectionPaiements');
      const boutonsPaiement = document.querySelectorAll('[id^="btn-"]');
      const boutonEnvoiContainer = document.getElementById('boutonEnvoiContainer');
      
      if (activer) {
        // Afficher la section
        sectionPaiements.style.display = 'block';
        
        // Afficher le bouton "Envoyer au comptable"
        if (boutonEnvoiContainer) {
          boutonEnvoiContainer.style.display = 'flex';
        }
        
        // Activer les boutons (sauf remboursement qui est toujours actif)
        boutonsPaiement.forEach(btn => {
          // Le bouton remboursement n'est pas g√©r√© ici car il est toujours visible
          if (btn.id !== 'btn-remboursement') {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            
            // Style sp√©cial pour autres paiements
            if (btn.id === 'btn-autres-paiements') {
              btn.classList.remove('border-amber-500', 'text-amber-400');
              btn.classList.add('border-amber-500', 'text-amber-500', 'hover:bg-amber-500', 'hover:text-white');
            }
          }
        });
        
        // Activer le bouton d√©p√¥t par d√©faut
        const btnDepot = document.getElementById('btn-depot');
        if (btnDepot) {
          btnDepot.classList.remove('btn-secondary');
          btnDepot.classList.add('btn-primary');
        }
        
        // Afficher la section d√©p√¥t par d√©faut
        const contentDepot = document.getElementById('content-depot');
        if (contentDepot) {
          contentDepot.classList.remove('hidden');
        }

        // IMPORTANT: R√©initialiser les dropdowns de paiement car ils peuvent ne pas avoir √©t√© initialis√©s correctement
        // quand la section √©tait cach√©e (display: none)
        console.log('[TOGGLE SECTION] R√©initialisation des dropdowns de paiement...');

        // R√©initialiser les flags d'initialisation pour permettre la r√©-initialisation
        const dropdownsToReinit = [
          'typePaiementAutresToggle',
          'payeParToggle',
          'payeParFinalToggle',
          'payeParAutresToggle',
          'payeParRemboursementToggle'
        ];

        dropdownsToReinit.forEach(id => {
          const element = document.getElementById(id);
          if (element && element.dataset.initialized) {
            console.log('[TOGGLE SECTION] R√©initialisation flag pour:', id);
            delete element.dataset.initialized;
          }
        });

        if (typeof initPaiementSelects === 'function') {
          initPaiementSelects();
        }

        log('[OK] Section paiements activ√©e');
      } else {
        // Masquer la section
        sectionPaiements.style.display = 'none';
        
        // Masquer le bouton "Envoyer au comptable"
        if (boutonEnvoiContainer) {
          boutonEnvoiContainer.style.display = 'none';
        }
        
        // Griser les boutons (sauf remboursement qui reste toujours actif)
        boutonsPaiement.forEach(btn => {
          if (btn.id !== 'btn-remboursement') {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-secondary');
          }
        });
        
        // Masquer toutes les sections de contenu
        document.querySelectorAll('.paiement-content').forEach(content => {
          content.classList.add('hidden');
        });
        
        // Fermer la section √©l√©ments √† ajouter d√©p√¥t
        const elementsAjouterDepot = document.getElementById('elementsAjouterDepot');
        
        if (elementsAjouterDepot) {
          elementsAjouterDepot.style.maxHeight = '0';
          elementsAjouterDepot.style.opacity = '0';
        }
        
        log('[ERROR] Section paiements d√©sactiv√©e');
      }
    }
    
    // Function to load facturations in columns format
    function chargerFacturationsColonnes() {
      log('Chargement des facturations en colonnes...');
      // Peupler les sections avec les donn√©es charg√©es
      peuplerSectionsFacturations();
    }

    // ===== SYST√àME DE PAIEMENTS PARTIELS DYNAMIQUES =====
    let paiementsPartielsCount = 0;
    let paiementsPartielsData = []; // Stockage des donn√©es des paiements partiels

    // Fonction pour cr√©er un bouton de paiement partiel (appel√©e apr√®s envoi au comptable)
    function creerBoutonPaiementPartiel(donneesPaiement) {
      paiementsPartielsCount++;
      const paiementId = `paiement-partiel-${paiementsPartielsCount}`;

      log('[ADD] Cr√©ation bouton paiement partiel:', paiementId, donneesPaiement);

      // Cr√©er le bouton entre d√©p√¥t et paiement final
      const container = document.getElementById('workflow-buttons-container');
      const btnPaiementFinal = document.getElementById('btn-paiement-final');

      const newButton = document.createElement('button');
      newButton.type = 'button';
      newButton.id = `btn-${paiementId}`;
      newButton.className = 'btn-secondary px-6 py-3 rounded-lg font-semibold transition-all duration-300';
      newButton.onclick = () => showPaiementSection(paiementId);
      newButton.innerHTML = `<i class="fas fa-coins mr-2"></i>Paiement partiel ${paiementsPartielsCount}`;

      // Colorer le bouton selon le statut
      if (donneesPaiement.statut === 'traitement') {
        newButton.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
        newButton.style.borderColor = '#f59e0b';
        newButton.style.color = 'white';
      } else if (donneesPaiement.statut === 'traite') {
        newButton.style.background = 'linear-gradient(135deg, rgb(16, 185, 129), rgb(5, 150, 105))';
        newButton.style.borderColor = 'rgb(16, 185, 129)';
        newButton.style.color = 'white';
      }

      // Ins√©rer le bouton AVANT le bouton paiement final
      container.insertBefore(newButton, btnPaiementFinal);

      // Cr√©er la section de contenu avec les donn√©es
      creerSectionPaiementPartielAvecDonnees(paiementId, paiementsPartielsCount, donneesPaiement);

      // Sauvegarder les donn√©es
      paiementsPartielsData.push({
        id: paiementId,
        numero: paiementsPartielsCount,
        ...donneesPaiement
      });

      log('[OK] Bouton paiement partiel cr√©√©:', paiementId);

      return paiementId;
    }

    // Fonction pour cr√©er la section HTML d'un paiement partiel avec donn√©es pr√©-remplies
    function creerSectionPaiementPartielAvecDonnees(paiementId, numero, donnees) {
      const container = document.getElementById('paiements-partiels-sections-container');

      const section = document.createElement('div');
      section.id = `content-${paiementId}`;
      section.className = 'paiement-content hidden';

      // D√©terminer quel type de champs afficher
      const afficherVirement = donnees.payePar === 'virement' || donnees.payePar === 'Virement';
      const afficherCheque = donnees.payePar === 'cheque' || donnees.payePar === 'Ch√®que';

      section.innerHTML = `
        <h2 class="text-xl font-bold mb-4 border-b pb-2" style="color: var(--text-light); border-color: var(--border-dark);">
          <i class="fas fa-coins mr-2 text-purple-500"></i>
          Paiement partiel ${numero}
        </h2>

        <!-- Montants et Date (GRIS√âS) -->
        <div class="grid grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
              <i class="fas fa-money-bill-wave mr-2 text-green-500"></i>
              $ Montant
            </label>
            <div class="relative">
              <input type="text" value="${donnees.montant}" class="modern-input pr-10" style="background: rgba(55, 65, 81, 0.3) !important; color: #6b7280 !important; cursor: not-allowed !important;" readonly>
              <span class="absolute right-3 top-1/2 transform -translate-y-1/2 font-medium" style="color: var(--text-gray);">$</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
              <i class="fas fa-calendar-alt mr-2 text-purple-500"></i>
              Date paiement
            </label>
            <input type="text" value="${donnees.date}" class="modern-input" style="background: rgba(55, 65, 81, 0.3) !important; color: #6b7280 !important; cursor: not-allowed !important;" readonly>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
              <i class="fas fa-money-check-alt mr-2 text-teal-500"></i>
              Pay√© par
            </label>
            <input type="text" value="${donnees.payePar}" class="modern-input" style="background: rgba(55, 65, 81, 0.3) !important; color: #6b7280 !important; cursor: not-allowed !important;" readonly>
          </div>
        </div>

        <!-- Section √©l√©ments √† ajouter (GRIS√âS et VISIBLES si donn√©es existent) -->
        ${afficherVirement || afficherCheque ? `
        <div class="mb-4">
          <h2 class="text-xl font-bold mb-4 border-b pb-2" style="color: var(--text-light); border-color: var(--border-dark);">
            <i class="fas fa-plus mr-2 text-orange-500"></i>
            √âl√©ments √† ajouter - Paiement partiel ${numero}
          </h2>

          ${afficherVirement ? `
          <!-- Champs virement (GRIS√âS) -->
          <div class="grid grid-cols-4 gap-4 mb-4">
            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                <i class="fas fa-link mr-2 text-blue-500"></i>
                Lien virement
              </label>
              <input type="text" value="${donnees.lienVirement || ''}" class="modern-input" style="background: rgba(55, 65, 81, 0.3) !important; color: #6b7280 !important; cursor: not-allowed !important;" readonly>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                <i class="fas fa-lock mr-2 text-red-500"></i>
                Mot de passe
              </label>
              <input type="text" value="${donnees.mdpVirement || ''}" class="modern-input" style="background: rgba(55, 65, 81, 0.3) !important; color: #6b7280 !important; cursor: not-allowed !important;" readonly>
            </div>
            <div></div>
            <div></div>
          </div>
          ` : ''}

          ${afficherCheque ? `
          <!-- Champs ch√®que (GRIS√âS) -->
          <div class="grid grid-cols-3 gap-4 mb-4">
            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                <i class="fas fa-image mr-2 text-green-500"></i>
                Recto du ch√®que
              </label>
              <div class="upload-zone-small" style="background: rgba(55, 65, 81, 0.3) !important; cursor: not-allowed !important;">
                <p style="color: #6b7280;"><i class="fas fa-check mr-1"></i> Recto envoy√©</p>
              </div>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                <i class="fas fa-image mr-2 text-orange-500"></i>
                Verso du ch√®que
              </label>
              <div class="upload-zone-small" style="background: rgba(55, 65, 81, 0.3) !important; cursor: not-allowed !important;">
                <p style="color: #6b7280;"><i class="fas fa-check mr-1"></i> Verso envoy√©</p>
              </div>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                <i class="fas fa-hashtag mr-2 text-purple-500"></i>
                Num√©ro ch√®que
              </label>
              <input type="text" value="${donnees.numeroCheque || ''}" class="modern-input" style="background: rgba(55, 65, 81, 0.3) !important; color: #6b7280 !important; cursor: not-allowed !important;" readonly>
            </div>
          </div>
          ` : ''}
        </div>
        ` : ''}
      `;

      container.appendChild(section);
    }

    // ===== FIN SYST√àME DE PAIEMENTS PARTIELS =====

    // Fonction pour voir la soumission sign√©e
    function voirSoumissionSignee() {
      const clientInfo = document.getElementById('clientInfo').value;
      if (!clientInfo) {
        alert('Veuillez d\'abord s√©lectionner un client');
        return;
      }

      // R√©cup√©rer les donn√©es du client s√©lectionn√© (facturation ou remboursement)
      let clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
      if (!clientData.num) {
        // Fallback pour les anciennes donn√©es
        clientData = JSON.parse(sessionStorage.getItem('selectedClientData') || '{}');
      }

      if (!clientData.pdfUrl) {
        alert('Aucune soumission PDF disponible pour ce client');
        return;
      }

      // Ouvrir le modal avec le PDF int√©gr√©
      const modal = document.getElementById('soumissionSigneeModal');
      const content = document.getElementById('soumissionContent');

      if (modal && content) {
        // Afficher le PDF dans un iframe dans le modal avec scroll discret
        content.innerHTML = `
          <!-- Styles sp√©cifiques √† Facturation QE -->
          <div class="pdf-container" style="width: 100%; height: 70vh; background: #1a1a1a; border-radius: 8px; overflow: auto;">
            <iframe src="${clientData.pdfUrl}"
                    type="application/pdf"
                    style="width: 100%; height: 100%; border: none; display: block;">
              <p style="padding: 20px; color: var(--text-light);">
                Impossible d'afficher le PDF.
                <a href="${clientData.pdfUrl}" target="_blank" style="color: #3b82f6; text-decoration: underline;">
                  Cliquez ici pour l'ouvrir dans un nouvel onglet
                </a>
              </p>
            </iframe>
          </div>
        `;

        // Bloquer le scroll de la page
        document.body.style.overflow = 'hidden';

        // Afficher le modal
        modal.classList.remove('hidden');
      }
    }

    // Fonction pour fermer le modal de soumission
    function fermerModalSoumission() {
      const modal = document.getElementById('soumissionSigneeModal');
      modal.classList.add('hidden');

      // Restaurer le titre original "Soumission sign√©e"
      const modalTitle = modal.querySelector('h3.text-xl');
      if (modalTitle) {
        modalTitle.innerHTML = '<i class="fas fa-file-contract mr-2 text-green-500"></i>Soumission sign√©e';
      }

      // R√©activer le scroll de la page
      document.body.style.overflow = '';
    }

    // Fonctions pour le popup d'erreur de remboursement
    function afficherErreurRemboursement(message) {
      const modal = document.getElementById('erreurRemboursementModal');
      const texte = document.getElementById('erreurRemboursementTexte');
      if (modal && texte) {
        texte.textContent = message;
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }
    }

    function fermerErreurRemboursement() {
      const modal = document.getElementById('erreurRemboursementModal');
      if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
      }
    }

    // Variable globale pour le calendrier du remboursement
    let calendrierRemboursement = null;

    // Fonction pour ouvrir le popup de proc√©dure de remboursement
    function ouvrirPopupRemboursement() {
      const modal = document.getElementById('remboursementProcedureModal');
      if (modal) {
        // R√©cup√©rer les donn√©es du client depuis sessionStorage
        const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');

        log('[BAN] Donn√©es client pour remboursement:', clientData);
        log('[DEBUG REMB] depot:', clientData.depot);
        log('[DEBUG REMB] paiementFinal:', clientData.paiementFinal);
        log('[DEBUG REMB] autresPaiements:', clientData.autresPaiements);

        // V√©rifier si au moins un paiement a √©t√© trait√© (v√©rifier les statuts INDIVIDUELS des paiements)
        const depot = clientData.depot || {};
        const paiementFinal = clientData.paiementFinal || {};
        const autresPaiements = Array.isArray(clientData.autresPaiements) ? clientData.autresPaiements : [];

        log('[DEBUG REMB] depot.statut:', depot.statut);
        log('[DEBUG REMB] paiementFinal.statut:', paiementFinal.statut);

        // Collecter tous les paiements trait√©s
        const paiementsTraites = [];

        // Statuts accept√©s pour remboursement: paiements compl√®tement trait√©s
        const statutsAcceptes = ['traite', 'traite_attente_final'];

        // V√©rifier le d√©p√¥t
        if (statutsAcceptes.includes(depot.statut) && depot.montant) {
          paiementsTraites.push({
            type: 'D√©p√¥t',
            montant: depot.montant,
            montantNum: parseFloat(depot.montant.replace(/[^\d,]/g, '').replace(',', '.')) || 0
          });
        }

        // V√©rifier le paiement final
        if (statutsAcceptes.includes(paiementFinal.statut) && paiementFinal.montant) {
          paiementsTraites.push({
            type: 'Paiement final',
            montant: paiementFinal.montant,
            montantNum: parseFloat(paiementFinal.montant.replace(/[^\d,]/g, '').replace(',', '.')) || 0
          });
        }

        // V√©rifier les autres paiements
        autresPaiements.forEach((p, index) => {
          if (statutsAcceptes.includes(p.statut) && p.montant) {
            paiementsTraites.push({
              type: `Autre paiement ${index + 1}`,
              montant: p.montant,
              montantNum: parseFloat(p.montant.replace(/[^\d,]/g, '').replace(',', '.')) || 0
            });
          }
        });

        const aucunPaiementTraite = paiementsTraites.length === 0;

        if (aucunPaiementTraite) {
          // Construire le nom du client
          const nomClient = clientData.prenom && clientData.nom
            ? `${clientData.prenom} ${clientData.nom}`
            : 'ce client';

          afficherErreurRemboursement(`Ne peut pas proc√©der √† un remboursement pour ${nomClient} car aucun paiement n'a √©t√© trait√© pour le moment.`);
          log('[ERROR] Remboursement refus√©: aucun paiement trait√©');
          return;
        }

        // Pr√©-remplir les informations du client
        const clientInput = document.getElementById('remb-client');
        const numSoumissionInput = document.getElementById('remb-num-soumission');

        if (clientData && (clientData.prenom || clientData.nom)) {
          // Construire le nom complet
          const nomComplet = `${clientData.prenom || ''} ${clientData.nom || ''}`.trim();
          clientInput.value = nomComplet;
          numSoumissionInput.value = clientData.num || clientData.numeroSoumission || '';
          log('[OK] Champs remplis - Client:', clientInput.value, 'Num:', numSoumissionInput.value);
        } else {
          // Si pas de client s√©lectionn√©, laisser vide
          clientInput.value = '';
          numSoumissionInput.value = '';
          log('[WARN] Aucun client s√©lectionn√©');
        }

        // Peupler le dropdown des paiements trait√©s
        const montantMenu = document.getElementById('remb-montant-menu');
        const montantSelected = document.getElementById('remb-montant-selected');
        const montantHidden = document.getElementById('remb-montant');

        if (montantMenu) {
          // Vider le dropdown menu
          montantMenu.innerHTML = '';

          // Ajouter chaque paiement trait√© au dropdown
          paiementsTraites.forEach((paiement, index) => {
            const option = document.createElement('div');
            option.className = 'dropdown-secondary-option';
            option.dataset.value = paiement.montant;
            option.dataset.montantNum = paiement.montantNum;
            option.textContent = `${paiement.type} - ${paiement.montant}`;
            montantMenu.appendChild(option);
          });

          // Si 2 paiements ou plus, ajouter l'option "Totalit√©" √† la fin
          if (paiementsTraites.length >= 2) {
            const montantTotal = paiementsTraites.reduce((sum, p) => sum + p.montantNum, 0);
            const montantTotalFormate = montantTotal.toFixed(2).replace('.', ',') + ' $';

            const optionTotal = document.createElement('div');
            optionTotal.className = 'dropdown-secondary-option';
            optionTotal.dataset.value = montantTotalFormate;
            optionTotal.dataset.montantNum = montantTotal;
            optionTotal.textContent = `Totalit√© des paiements trait√©s - ${montantTotalFormate}`;
            montantMenu.appendChild(optionTotal);
          }

          // R√©initialiser la s√©lection
          if (montantSelected && montantHidden) {
            montantSelected.textContent = 'S√©lectionner un paiement';
            montantHidden.value = '';
          }

          // Initialiser le dropdown apr√®s avoir ajout√© les options
          setTimeout(() => {
            initRembMontantDropdown();
          }, 100);
        }

        modal.classList.remove('hidden');
        // Bloquer le scroll de la page
        document.body.style.overflow = 'hidden';
      }
    }

    // Variable pour tracker si le dropdown a √©t√© initialis√©
    let rembMontantDropdownInitialized = false;

    // Fonction pour initialiser le dropdown de montant (une seule fois)
    function initRembMontantDropdown() {
      if (rembMontantDropdownInitialized) return;

      const dropdown = document.getElementById('remb-montant-dropdown');
      const menu = document.getElementById('remb-montant-menu');
      const selected = document.getElementById('remb-montant-selected');
      const hidden = document.getElementById('remb-montant');

      if (!dropdown || !menu || !selected || !hidden) return;

      // Toggle menu au clic sur le dropdown
      dropdown.addEventListener('click', function(e) {
        e.stopPropagation();
        const isVisible = menu.style.display === 'block';
        menu.style.display = isVisible ? 'none' : 'block';

        // Rotation de l'ic√¥ne
        const icon = dropdown.querySelector('.fa-chevron-down');
        if (icon) {
          icon.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
        }
      });

      // Utiliser la d√©l√©gation d'√©v√©nements pour les options (g√®re dynamiquement les options ajout√©es)
      menu.addEventListener('click', function(e) {
        const option = e.target.closest('.dropdown-secondary-option');
        if (!option) return;

        e.stopPropagation();
        const value = option.dataset.value;
        const text = option.textContent;

        // Mettre √† jour l'affichage et la valeur
        selected.textContent = text;
        hidden.value = value;

        // Fermer le menu
        menu.style.display = 'none';
        const icon = dropdown.querySelector('.fa-chevron-down');
        if (icon) {
          icon.style.transform = 'rotate(0deg)';
        }

        log('[REMB] Paiement s√©lectionn√©:', text, 'Valeur:', value);
      });

      // Fermer le menu si on clique ailleurs
      document.addEventListener('click', function(e) {
        if (!dropdown.contains(e.target) && !menu.contains(e.target)) {
          menu.style.display = 'none';
          const icon = dropdown.querySelector('.fa-chevron-down');
          if (icon) {
            icon.style.transform = 'rotate(0deg)';
          }
        }
      });

      rembMontantDropdownInitialized = true;
      log('[REMB] Dropdown initialis√© avec succ√®s');
    }

    // Fonction pour fermer le popup de proc√©dure de remboursement
    function fermerPopupRemboursement() {
      const modal = document.getElementById('remboursementProcedureModal');
      if (modal) {
        modal.classList.add('hidden');
        // R√©activer le scroll de la page
        document.body.style.overflow = '';
        // R√©initialiser le formulaire
        document.getElementById('formRemboursement').reset();

        // R√©initialiser le dropdown de montant
        const montantSelected = document.getElementById('remb-montant-selected');
        const montantMenu = document.getElementById('remb-montant-menu');
        if (montantSelected) {
          montantSelected.textContent = 'S√©lectionner un paiement';
        }
        if (montantMenu) {
          montantMenu.style.display = 'none';
        }

        // R√©initialiser le dropdown de m√©thode
        const placeholder = document.querySelector('#rembMethodeToggle .placeholder');
        if (placeholder) {
          placeholder.textContent = 'Choisir m√©thode...';
          placeholder.style.color = 'var(--text-gray)';
        }
        // R√©initialiser la variable de m√©thode
        rembMethodeSelectionnee = '';
      }
    }

    // Variables pour stocker les valeurs s√©lectionn√©es
    let rembMethodeSelectionnee = '';

    // Fonction pour soumettre le formulaire de remboursement
    document.addEventListener('DOMContentLoaded', function() {
      // Setup dropdown m√©thode remboursement
      const rembMethodeToggle = document.getElementById('rembMethodeToggle');
      const rembMethodeMenu = document.getElementById('rembMethodeMenu');

      if (rembMethodeToggle && rembMethodeMenu) {
        rembMethodeToggle.addEventListener('click', function(e) {
          e.stopPropagation();
          rembMethodeMenu.classList.toggle('hidden');
        });

        const rembMethodeOptions = rembMethodeMenu.querySelectorAll('.custom-select-option');
        rembMethodeOptions.forEach(option => {
          option.addEventListener('click', function(e) {
            e.stopPropagation();
            const value = this.getAttribute('data-value');
            const text = this.textContent;
            const placeholder = rembMethodeToggle.querySelector('.placeholder');

            placeholder.textContent = text;
            placeholder.style.setProperty('color', 'white', 'important');
            rembMethodeSelectionnee = text;

            rembMethodeMenu.classList.add('hidden');
          });
        });

        // Fermer le menu si on clique ailleurs
        document.addEventListener('click', function() {
          rembMethodeMenu.classList.add('hidden');
        });
      }

      // Setup formulaire
      const formRemb = document.getElementById('formRemboursement');
      if (formRemb) {
        formRemb.addEventListener('submit', async function(e) {
          e.preventDefault();

          const client = document.getElementById('remb-client').value;
          const numSoumission = document.getElementById('remb-num-soumission').value;
          const montant = document.getElementById('remb-montant').value;
          const courriel = document.getElementById('remb-courriel').value;

          // Valider que tous les champs sont remplis
          if (!montant) {
            customAlert('Veuillez s√©lectionner un paiement √† rembourser', 'error');
            return;
          }

          if (!courriel) {
            customAlert('Veuillez entrer le courriel du client pour le remboursement', 'error');
            return;
          }

          // R√©cup√©rer le montant num√©rique du paiement s√©lectionn√©
          const montantOption = document.querySelector('#remb-montant-menu .dropdown-secondary-option[data-value="' + montant + '"]');
          const montantNum = montantOption ? parseFloat(montantOption.dataset.montantNum) : 0;

          // G√©n√©rer un ID unique pour le remboursement
          const remboursementId = crypto.randomUUID ? crypto.randomUUID() : Date.now().toString();

          // R√©cup√©rer les donn√©es compl√®tes du client depuis sessionStorage
          const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
          log('[REMB] Donn√©es client:', clientData);

          const remboursement = {
            id: remboursementId,
            client: client,
            num: numSoumission,
            numeroSoumission: numSoumission,
            // Informations client d√©taill√©es
            prenom: clientData.prenom || '',
            nom: clientData.nom || '',
            clientPrenom: clientData.prenom || '',
            clientNom: clientData.nom || '',
            telephone: clientData.tel || clientData.telephone || '',
            adresse: clientData.adresse || '',
            // Informations financi√®res
            montant: montant,
            montantNum: montantNum,
            courriel: courriel,
            // Dates et statut
            date_demande: new Date().toISOString(),
            date_remboursement: new Date().toISOString(),
            dateRemboursement: new Date().toISOString(),
            statut: 'en_attente_coach',
            paiement_source: montantOption ? montantOption.textContent : montant,
            date: new Date().toLocaleDateString('fr-CA'),
            timestamp: new Date().toISOString()
          };

          log('[MONEY] REMBOURSEMENT EN ATTENTE COACH:', remboursement);

          // Sauvegarder le remboursement via l'API
          try {
            const username = getFacturationUsername();
            const response = await fetch(`${window.location.origin}/api/remboursements/${username}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(remboursement)
            });

            if (response.ok) {
              fermerPopupRemboursement();
              showSuccessAnimation('Remboursement envoy√© en attente validation coach!');
            } else {
              customAlert('Erreur lors de l\'enregistrement du remboursement', 'error');
            }
          } catch (error) {
            error('Erreur:', error);
            customAlert('Erreur lors de l\'enregistrement du remboursement', 'error');
          }
        });
      }
    });

    // ============================================
    // ANIMATION DE SUCC√àS (comme soumission.html)
    // ============================================

    function showSuccessAnimation(message) {
      const overlay = document.createElement('div');
      overlay.className = 'success-overlay';
      overlay.innerHTML = `
        <div class="success-content">
          <div class="success-checkmark">
            <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
              <path d="M8 20 L16 28 L32 12" stroke="white" stroke-width="3"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">${message}</h2>
        </div>
      `;

      document.body.appendChild(overlay);

      setTimeout(() => {
        overlay.remove();
        // Recharger pour mettre √† jour l'interface
        if (typeof chargerClientsFacturation === 'function') {
          chargerClientsFacturation();
        }
      }, 2000);
    }

    // ============================================
    // POPUPS PERSONNALIS√âS (remplace alert et confirm)
    // ============================================

    let customConfirmCallback = null;

    // Fonction pour afficher un popup de confirmation personnalis√©
    function customConfirm(message, callback) {
      const modal = document.getElementById('customConfirmModal');
      const messageEl = document.getElementById('customConfirmMessage');
      const confirmBtn = document.getElementById('customConfirmBtn');

      if (!modal || !messageEl || !confirmBtn) return;

      messageEl.textContent = message;
      customConfirmCallback = callback;

      // Ajouter l'event listener au bouton de confirmation
      confirmBtn.onclick = function() {
        customConfirmAccept();
      };

      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function customConfirmAccept() {
      const modal = document.getElementById('customConfirmModal');
      modal.classList.add('hidden');
      document.body.style.overflow = '';

      if (customConfirmCallback) {
        customConfirmCallback(true);
        customConfirmCallback = null;
      }
    }

    function customConfirmCancel() {
      const modal = document.getElementById('customConfirmModal');
      modal.classList.add('hidden');
      document.body.style.overflow = '';

      if (customConfirmCallback) {
        customConfirmCallback(false);
        customConfirmCallback = null;
      }
    }

    // Fonction pour afficher un popup d'alerte personnalis√©
    function customAlert(message, type = 'info') {
      const modal = document.getElementById('customAlertModal');
      const messageEl = document.getElementById('customAlertMessage');
      const titleEl = document.getElementById('customAlertTitle');
      const iconEl = document.getElementById('customAlertIcon');

      if (!modal || !messageEl || !titleEl || !iconEl) return;

      messageEl.textContent = message;

      // Configurer selon le type
      if (type === 'success') {
        titleEl.textContent = 'Succ√®s';
        iconEl.innerHTML = '<i class="fas fa-check-circle text-2xl text-green-500"></i>';
        iconEl.style.background = 'rgba(16, 185, 129, 0.2)';
      } else if (type === 'error') {
        titleEl.textContent = 'Erreur';
        iconEl.innerHTML = '<i class="fas fa-exclamation-circle text-2xl text-red-500"></i>';
        iconEl.style.background = 'rgba(239, 68, 68, 0.2)';
      } else {
        titleEl.textContent = 'Information';
        iconEl.innerHTML = '<i class="fas fa-info-circle text-2xl text-blue-500"></i>';
        iconEl.style.background = 'rgba(59, 130, 246, 0.2)';
      }

      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function customAlertClose() {
      const modal = document.getElementById('customAlertModal');
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // ============================================
    // MODAL IMAGE POUR AFFICHER LES PHOTOS DE CH√àQUE
    // ============================================

    window.ouvrirModalImage = function(urlImage, titre, event) {
      const modal = document.getElementById('modalImage');
      const img = document.getElementById('modalImageContent');
      const titleText = document.getElementById('modalImageTitleText');

      // LOGS pour d√©boguer les photos
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('üì∏ OUVERTURE MODAL PHOTO');
      console.log('Titre du paiement:', titre);
      console.log('URL de la photo:', urlImage);
      console.log('üìç √âl√©ment cliqu√©:', event ? event.target : 'N/A');
      console.log('üìç Parent de l\'√©l√©ment:', event ? event.target.parentElement : 'N/A');
      console.log('üìç ID du parent:', event ? event.target.parentElement?.id : 'N/A');
      console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');

      // Afficher toutes les photos du client pour v√©rification
      const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
      console.log('üìã PHOTOS DU CLIENT:', clientData.prenom, clientData.nom);

      if (clientData.depot) {
        console.log('  üí∞ D√©p√¥t:');
        console.log('    - Recto:', clientData.depot.photoRecto);
        console.log('    - Verso:', clientData.depot.photoVerso);
      }

      if (clientData.paiementFinal) {
        console.log('  ‚úÖ Paiement Final:');
        console.log('    - Recto:', clientData.paiementFinal.photoRecto);
        console.log('    - Verso:', clientData.paiementFinal.photoVerso);
      }

      if (clientData.autresPaiements && clientData.autresPaiements.length > 0) {
        clientData.autresPaiements.forEach((p, index) => {
          console.log(`  üíµ Paiement Partiel ${index + 1} (ID: ${p.id}):`);
          console.log('    - Recto:', p.photoRecto);
          console.log('    - Verso:', p.photoVerso);
        });
      }

      console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
      // V√©rifier si l'URL correspond au bon paiement
      let urlMatch = false;
      if (titre.includes('D√©p√¥t')) {
        urlMatch = clientData.depot && (clientData.depot.photoRecto === urlImage || clientData.depot.photoVerso === urlImage);
        console.log('‚úì V√©rification D√âP√îT:', urlMatch ? '‚úÖ MATCH' : '‚ùå NO MATCH');
      } else if (titre.includes('Paiement Final')) {
        urlMatch = clientData.paiementFinal && (clientData.paiementFinal.photoRecto === urlImage || clientData.paiementFinal.photoVerso === urlImage);
        console.log('‚úì V√©rification PAIEMENT FINAL:', urlMatch ? '‚úÖ MATCH' : '‚ùå NO MATCH');
      } else if (titre.includes('Paiement Partiel')) {
        const match = titre.match(/Paiement Partiel (\d+)/);
        if (match) {
          const numero = parseInt(match[1]) - 1;
          const paiement = clientData.autresPaiements?.[numero];
          urlMatch = paiement && (paiement.photoRecto === urlImage || paiement.photoVerso === urlImage);
          console.log(`‚úì V√©rification PAIEMENT PARTIEL ${numero + 1}:`, urlMatch ? '‚úÖ MATCH' : '‚ùå NO MATCH');
        }
      }
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

      img.src = urlImage;
      titleText.textContent = titre || 'Image du ch√®que';
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';

      // Ajouter l'√©v√©nement ESC pour fermer
      document.addEventListener('keydown', handleEscapeKey);
    }

    window.fermerModalImage = function() {
      const modal = document.getElementById('modalImage');
      modal.classList.add('hidden');
      document.body.style.overflow = '';

      // Retirer l'√©v√©nement ESC
      document.removeEventListener('keydown', handleEscapeKey);
    }

    // Handler pour la touche ESC
    function handleEscapeKey(e) {
      if (e.key === 'Escape') {
        fermerModalImage();
      }
    }

    // ============================================
    // VALIDATION COACH DES REMBOURSEMENTS
    // ============================================

    // Fonction pour charger les remboursements en attente pour l'entrepreneur s√©lectionn√©
    async function chargerRemboursementsEnAttenteCoach() {
      const userRole = localStorage.getItem('userRole');
      if (userRole !== 'coach' && userRole !== 'direction') {
        return; // Cette fonction est uniquement pour les coaches
      }

      const username = getFacturationUsername();
      if (!username) {
        log('[COACH REMB] Pas de username trouv√©');
        return;
      }

      try {
        const response = await fetch(`${window.location.origin}/api/remboursements/${username}`);
        if (!response.ok) {
          throw new Error('Erreur lors du chargement des remboursements');
        }

        const remboursements = await response.json();
        const rembEnAttente = remboursements.filter(r => r.statut === 'en_attente_coach');

        log('[COACH REMB] Remboursements en attente coach:', rembEnAttente);

        if (rembEnAttente.length > 0) {
          afficherPopupValidationCoach(rembEnAttente);
        }
      } catch (error) {
        console.error('[COACH REMB] Erreur:', error);
      }
    }

    // Fonction pour afficher le popup de validation coach
    function afficherPopupValidationCoach(remboursements) {
      const modal = document.getElementById('coachRemboursementValidationModal');
      const liste = document.getElementById('listeRemboursementsCoach');

      if (!modal || !liste) return;

      // Vider la liste
      liste.innerHTML = '';

      // Cr√©er une carte pour chaque remboursement
      remboursements.forEach(remb => {
        const card = document.createElement('div');
        card.className = 'p-6 rounded-xl transition-all';
        card.style.background = 'rgba(23, 32, 51, 0.6)';
        card.style.border = '1px solid var(--border-dark)';
        card.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';

        const dateFormatted = new Date(remb.date_demande).toLocaleDateString('fr-CA', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        // Extraire prenom et nom
        const prenom = remb.prenom || remb.clientPrenom || '';
        const nom = remb.nom || remb.clientNom || '';
        const clientNom = `${prenom} ${nom}`.trim() || remb.client || 'Client';

        card.innerHTML = `
          <div class="flex justify-between items-start mb-5">
            <div>
              <h4 class="text-xl font-bold mb-2" style="color: var(--text-light);">
                ${clientNom}
              </h4>
              <div class="flex items-center gap-3 text-sm" style="color: var(--text-gray);">
                <span><i class="fas fa-hashtag mr-1"></i>${remb.num}</span>
                ${remb.telephone ? `<span><i class="fas fa-phone mr-1"></i>${remb.telephone}</span>` : ''}
              </div>
            </div>
            <div class="px-3 py-1.5 rounded-full text-xs font-semibold" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24;">
              <i class="fas fa-clock mr-1"></i>
              En attente validation
            </div>
          </div>

          <div class="space-y-3 mb-5">
            <div class="p-4 rounded-lg" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2);">
              <p class="text-xs mb-1" style="color: var(--text-gray);">Montant √† rembourser</p>
              <p class="text-2xl font-bold" style="color: #ef4444;">
                <i class="fas fa-dollar-sign mr-1"></i>
                ${remb.montant}
              </p>
            </div>

            <div class="flex items-center gap-2 p-3 rounded-lg" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
              <i class="fas fa-envelope" style="color: #3b82f6; font-size: 1.1rem;"></i>
              <div class="flex-1">
                <p class="text-xs mb-0.5" style="color: var(--text-gray);">Courriel pour virement</p>
                <p class="font-medium" style="color: var(--text-light);">${remb.courriel}</p>
              </div>
            </div>

            <div class="flex items-center gap-2 p-3 rounded-lg" style="background: rgba(148, 163, 184, 0.1); border: 1px solid rgba(148, 163, 184, 0.2);">
              <i class="fas fa-calendar-alt" style="color: var(--text-gray); font-size: 1.1rem;"></i>
              <div class="flex-1">
                <p class="text-xs mb-0.5" style="color: var(--text-gray);">Date de demande</p>
                <p class="font-medium" style="color: var(--text-light);">${dateFormatted}</p>
              </div>
            </div>
          </div>

          <div class="flex justify-end gap-3 pt-4 border-t" style="border-color: var(--border-dark);">
            <button onclick="validerRemboursementCoach('${remb.id}')" class="btn-primary px-6 py-3 rounded-lg font-semibold transition-all duration-300 flex items-center gap-2" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important; border-color: #10b981 !important;">
              <i class="fas fa-check mr-2"></i>
              Valider le remboursement
            </button>
          </div>
        `;

        liste.appendChild(card);
      });

      // Afficher le modal
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // Fonction pour fermer le popup de validation coach
    function fermerPopupCoachValidation() {
      const modal = document.getElementById('coachRemboursementValidationModal');
      if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
      }
    }

    // Fonction pour valider un remboursement (coach)
    async function validerRemboursementCoach(remboursementId) {
      customConfirm('√ätes-vous s√ªr de vouloir valider ce remboursement? Il sera envoy√© au comptable.', async function(confirmed) {
        if (!confirmed) return;

        const username = getFacturationUsername();

        try {
          // Charger tous les remboursements
          const response = await fetch(`${window.location.origin}/api/remboursements/${username}`);
          if (!response.ok) {
            throw new Error('Erreur lors du chargement des remboursements');
          }

          let remboursements = await response.json();

          // Trouver et mettre √† jour le remboursement
          const index = remboursements.findIndex(r => r.id === remboursementId);
          if (index === -1) {
            customAlert('Remboursement non trouv√©', 'error');
            return;
          }

          remboursements[index].statut = 'en_attente_comptable';
          remboursements[index].date_validation_coach = new Date().toISOString();

          // Sauvegarder via l'API (on doit mettre √† jour tout le fichier)
          const updateResponse = await fetch(`${window.location.origin}/api/remboursements/${username}/update`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(remboursements)
          });

          if (updateResponse.ok) {
            // Fermer le popup de confirmation et de validation
            fermerPopupCoachValidation();

            // Afficher l'animation de succ√®s
            showSuccessAnimation('Remboursement valid√© et envoy√© au comptable!');

            // Recharger les donn√©es apr√®s l'animation (2 secondes)
            setTimeout(() => {
              // Recharger pour mettre √† jour les notifications
              if (typeof chargerClientsFacturation === 'function') {
                chargerClientsFacturation();
              }
              // V√©rifier s'il reste d'autres remboursements en attente
              chargerRemboursementsEnAttenteCoach();

              // Recharger les badges du s√©lecteur entrepreneur si on est un coach/direction
              const userRole = localStorage.getItem('userRole');
              if (userRole === 'coach' || userRole === 'direction') {
                if (window.EntrepreneurSelector) {
                  window.EntrepreneurSelector.reload();
                  log('[REMB COACH] Badges entrepreneur recharg√©s apr√®s validation');
                }

                // Notifier le parent (apppccoach) pour rafra√Æchir le badge du menu lat√©ral
                window.parent.postMessage({ type: 'updateFacturationBadge' }, '*');
              }

              // D√©clencher la mise √† jour des notifications dans apppc coach
              if (window.parent && window.parent !== window) {
                window.parent.postMessage({ type: 'UPDATE_REMBOURSEMENT_NOTIFICATIONS' }, '*');
              }
            }, 2000);
          } else {
            customAlert('Erreur lors de la validation du remboursement', 'error');
          }
        } catch (error) {
          console.error('Erreur:', error);
          customAlert('Erreur lors de la validation du remboursement', 'error');
        }
      });
    }

    // √âcouter l'√©v√©nement de s√©lection d'entrepreneur
    document.addEventListener('entrepreneurSelected', function(event) {
      const userRole = localStorage.getItem('userRole');
      if (userRole === 'coach' || userRole === 'direction') {
        log('[COACH REMB] Entrepreneur s√©lectionn√©, v√©rification des remboursements...');
        // Attendre un peu que les donn√©es soient charg√©es
        setTimeout(() => {
          chargerRemboursementsEnAttenteCoach();
        }, 1000);

        // IMPORTANT: Initialiser les dropdowns de paiement apr√®s s√©lection de l'entrepreneur
        console.log('[ENTREPRENEUR SELECTED] Initialisation des dropdowns de paiement...');
        setTimeout(() => {
          const dropdownsToReinit = ['typePaiementAutresToggle', 'payeParToggle', 'payeParFinalToggle', 'payeParAutresToggle', 'payeParRemboursementToggle'];
          dropdownsToReinit.forEach(id => {
            const element = document.getElementById(id);
            if (element && element.dataset.initialized) {
              console.log('[ENTREPRENEUR SELECTED] Reset flag pour:', id);
              delete element.dataset.initialized;
            }
          });
          if (typeof initPaiementSelects === 'function') {
            initPaiementSelects();
            console.log('[ENTREPRENEUR SELECTED] ‚úÖ Dropdowns de paiement initialis√©s');
          }
        }, 500);
      }
    });

    // Fonction pour charger les d√©tails de la soumission sign√©e
    async function chargerSoumissionSignee(numeroSoumission) {
      const content = document.getElementById('soumissionContent');
      
      try {
        // Simuler le chargement - √† remplacer par l'appel API r√©el
        content.innerHTML = `
          <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-600 mb-4">
            <div class="flex items-center mb-2">
              <i class="fas fa-check-circle text-green-500 mr-2"></i>
              <strong>Soumission ${numeroSoumission} - Sign√©e</strong>
            </div>
            <p class="text-sm text-green-200">Cette soumission a √©t√© sign√©e par le client</p>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div class="space-y-3">
              <h4 class="font-semibold text-lg border-b border-gray-600 pb-2">D√©tails de la soumission</h4>
              <div><span class="text-gray-400">Num√©ro :</span> <span class="font-medium">${numeroSoumission}</span></div>
              <div><span class="text-gray-400">Date de signature :</span> <span class="font-medium" id="dateSoumission">-</span></div>
              <div><span class="text-gray-400">Montant total :</span> <span class="font-medium" id="montantSoumission">-</span></div>
              <div><span class="text-gray-400">Statut :</span> <span class="text-green-400 font-medium">‚úì Sign√©e</span></div>
            </div>
            
            <div class="space-y-3">
              <h4 class="font-semibold text-lg border-b border-gray-600 pb-2">Informations client</h4>
              <div><span class="text-gray-400">Nom :</span> <span class="font-medium" id="nomClientSoumission">-</span></div>
              <div><span class="text-gray-400">T√©l√©phone :</span> <span class="font-medium" id="telClientSoumission">-</span></div>
              <div><span class="text-gray-400">Adresse :</span> <span class="font-medium" id="adresseClientSoumission">-</span></div>
            </div>
          </div>
          
          <div class="mt-6">
            <h4 class="font-semibold text-lg border-b border-gray-600 pb-2 mb-3">Travaux demand√©s</h4>
            <div class="bg-gray-800 p-3 rounded" id="travauxSoumission">
              Chargement des d√©tails des travaux...
            </div>
          </div>
        `;
        
        // TODO: Remplacer par l'appel API r√©el pour r√©cup√©rer les donn√©es de la soumission
        // const response = await fetch(`/api/soumission/${numeroSoumission}`);
        // const soumissionData = await response.json();
        
      } catch (error) {
        error('Erreur lors du chargement de la soumission:', error);
        content.innerHTML = `
          <div class="bg-red-900 bg-opacity-20 p-4 rounded-lg border border-red-600">
            <div class="flex items-center">
              <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
              <span>Erreur lors du chargement de la soumission</span>
            </div>
          </div>
        `;
      }
    }

    // Variables globales pour stocker les donn√©es
    let facturationsData = {};
    let facturationsUrgentes = [];
    let facturationsEnCours = [];
    let facturationsTraitement = [];
    let facturationsTraitees = [];

    // Fonction pour formater les montants
    function formatCurrency(value) {
      if (!value) return '0,00 $';
      
      // Nettoyer la valeur - enlever les espaces, $ et caract√®res non-num√©riques
      let cleanValue = value.toString().replace(/[^\d,.-]/g, '');
      
      // Convertir en nombre
      let numValue = parseFloat(cleanValue.replace(',', '.'));
      if (isNaN(numValue)) return '0,00 $';
      
      // Formater avec espace comme s√©parateur de milliers et virgule comme d√©cimale
      return numValue.toLocaleString('fr-CA', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).replace('.', ',') + ' $';
    }

    // Fonctions pour charger les donn√©es depuis le backend
    async function chargerFacturationsDepuisAPI() {
      try {
        const username = getFacturationUsername();

        // Charger les donn√©es depuis l'API facturation QE
        const response = await fetch(`/api/facturationqe/status-columns/${username}`);
        if (!response.ok) {
          throw new Error(`Erreur API: ${response.status}`);
        }

        const statusData = await response.json();
        const urgentes = statusData.urgentes?.clients || [];
        const enCours = statusData.en_traitement?.clients || [];
        const traitement = statusData.en_traitement?.clients || [];
        const traitees = statusData.traitees?.clients || [];

        // IMPORTANT: Ne PAS peupler les tableaux Status ici car les donn√©es ne sont pas transform√©es
        // Les tableaux facturationsUrgentes/Traitement/Traitees doivent √™tre peupl√©s par utiliserDonneesTestStatus()
        // qui appelle transformerPaiementPourStatus() pour chaque paiement
        // facturationsUrgentes = urgentes || [];
        // facturationsEnCours = enCours || [];
        // facturationsTraitement = traitement || [];
        // facturationsTraitees = traitees || [];

        // Construire l'objet facturationsData pour compatibilit√© avec le code existant
        facturationsData = {};

        const allPayments = [...urgentes, ...enCours, ...traitement, ...traitees];
        allPayments.forEach(facturation => {
          if (facturation.numeroSoumission || facturation.num) {
            const numero = facturation.numeroSoumission || facturation.num;
            facturationsData[numero] = {
              numero: numero,
              client: `${facturation.clientPrenom || facturation.prenom || ''} ${facturation.clientNom || facturation.nom || ''}`.trim(),
              montantPaiement: facturation.montantPaiement || facturation.montant || '0,00 $',
              totalTravaux: facturation.totalTravaux || facturation.montantPaiement || facturation.montant || '0,00 $',
              typePaiement: facturation.typePaiement || '',
              payePar: facturation.methodePaiement || '',
              dateDepot: facturation.dateDepot ? formatDateFromISO(facturation.dateDepot) : '',
              motDePasse: facturation.motDePasseVirement || '',
              lienVirement: facturation.lienVirement || '',
              numeroCheque: facturation.numeroCheque || '',
              message: facturation.message || '',
              status: facturation.statut || facturation.statutPaiement || 'en_cours'
            };
          }
        });

        log('Donn√©es de facturationsData charg√©es (pour compatibilit√©):', {
          total: Object.keys(facturationsData).length
        });

        // NOTE: Ne pas appeler mettreAJourCompteursInterface() ici car les tableaux Status
        // ne sont plus peupl√©s par cette fonction. Ils seront peupl√©s par utiliserDonneesTestStatus()
        // qui transforme correctement les donn√©es avec transformerPaiementPourStatus()

        return true;
      } catch (error) {
        error('Erreur lors du chargement des facturations:', error);
        // Utiliser les donn√©es de test de nos 4 clients du workflow
        log('üîÑ STATUS: Utilisation des donn√©es de test synchronis√©es avec le workflow');
        utiliserDonneesTestStatus();
        return false;
      }
    }

    // Fonction pour lire l'√©tat r√©el des boutons dans l'interface et g√©n√©rer la description
    function lireEtatReelBoutons(numeroSoumission) {
      // Simuler la s√©lection du client pour lire son √©tat actuel
      const clientsWorkflow = obtenirDonneesClientsStatiques();
      const client = clientsWorkflow[numeroSoumission];
      
      if (!client) {
        return '√âtat inconnu';
      }
      
      // Lire l'√©tat du bouton d√©p√¥t
      let descriptionDepot = '';
      if (client.statutDepot === 'non_envoye') {
        descriptionDepot = 'D√©p√¥t non envoy√©';
      } else if (client.statutDepot === 'envoye') {
        descriptionDepot = 'D√©p√¥t envoy√©';
      } else if (client.statutDepot === 'traitement') {
        descriptionDepot = 'D√©p√¥t en traitement';
      } else if (client.statutDepot === 'traite') {
        descriptionDepot = 'D√©p√¥t trait√©';
      }
      
      // Lire l'√©tat du bouton paiement final
      let descriptionPaiementFinal = '';
      if (client.statutPaiementFinal === 'attente') {
        descriptionPaiementFinal = 'Paiement final en attente';
      } else if (client.statutPaiementFinal === 'traitement') {
        descriptionPaiementFinal = 'Paiement final en traitement';
      } else if (client.statutPaiementFinal === 'traite') {
        descriptionPaiementFinal = 'Paiement final trait√©';
      }
      
      // Combiner les descriptions
      let description = descriptionDepot;
      if (descriptionPaiementFinal && client.statutDepot === 'traite') {
        description += ' - ' + descriptionPaiementFinal;
      }
      
      return description;
    }

    // Syst√®me de stockage des √©tats r√©els des clients (sera mis √† jour par les actions utilisateur)
    let etatsRelsClients = {
      '24-0001': { statutDepot: 'non_envoye', statutPaiementFinal: null },
      '24-0002': { statutDepot: 'traitement', statutPaiementFinal: null },
      '24-0003': { statutDepot: 'traite', statutPaiementFinal: 'attente' },
      '24-0004': { statutDepot: 'traite', statutPaiementFinal: 'traitement' }
    };

    // Fonction pour obtenir l'√©tat r√©el d'un client
    function obtenirEtatReelClient(numeroSoumission) {
      return etatsRelsClients[numeroSoumission] || { statutDepot: 'non_envoye', statutPaiementFinal: null };
    }

    // Fonction pour mettre √† jour l'√©tat r√©el d'un client via API
    async function mettreAJourEtatReelClient(numeroSoumission, nouvelEtat) {
      try {
        // R√©cup√©rer le username
        const username = getFacturationUsername();
        
        // Mettre √† jour localement d'abord
        if (!etatsRelsClients[numeroSoumission]) {
          etatsRelsClients[numeroSoumission] = {};
        }
        Object.assign(etatsRelsClients[numeroSoumission], nouvelEtat);
        
        log('üîÑ √âtat r√©el mis √† jour localement pour', numeroSoumission, ':', etatsRelsClients[numeroSoumission]);
        
        // Appel API pour chaque type de statut modifi√©
        for (const [cle, valeur] of Object.entries(nouvelEtat)) {
          let typeStatut = '';
          
          if (cle === 'statutDepot') {
            typeStatut = 'depot';
          } else if (cle === 'statutPaiementFinal') {
            typeStatut = 'paiement_final';
          } else if (cle === 'statutAutresPaiements') {
            typeStatut = 'autres_paiements';
          }
          
          if (typeStatut && valeur) {
            // Appel API pour mettre √† jour le statut
            const response = await fetch(`/api/facturationqe/client/${username}/${numeroSoumission}/statut`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                type_statut: typeStatut,
                nouveau_statut: valeur,
                ancien_statut: etatsRelsClients[numeroSoumission][cle] // √âtat pr√©c√©dent si disponible
              })
            });
            
            if (!response.ok) {
              throw new Error(`Erreur API mise √† jour statut: ${response.status}`);
            }
            
            const result = await response.json();
            log('[OK] Statut mis √† jour via API:', result);
          }
        }
        
        // Mettre √† jour l'onglet Status si c'est actuellement visible
        const statusTab = document.getElementById('page2');
        if (statusTab && !statusTab.classList.contains('hidden')) {
          await utiliserDonneesTestStatus();
          chargerFacturationsColonnes();
          log('[DATA] Onglet Status mis √† jour en temps r√©el via API');
        }
        
      } catch (error) {
        error('[ERROR] Erreur mise √† jour √©tat client via API:', error);
        
        // Fallback: mise √† jour locale seulement
        mettreAJourEtatReelClientLocal(numeroSoumission, nouvelEtat);
      }
    }

    // Fonction fallback pour mise √† jour locale seulement
    function mettreAJourEtatReelClientLocal(numeroSoumission, nouvelEtat) {
      if (!etatsRelsClients[numeroSoumission]) {
        etatsRelsClients[numeroSoumission] = {};
      }
      
      Object.assign(etatsRelsClients[numeroSoumission], nouvelEtat);
      log('[WARN] √âtat r√©el mis √† jour localement (fallback) pour', numeroSoumission, ':', etatsRelsClients[numeroSoumission]);
      
      // Mettre √† jour l'onglet Status si c'est actuellement visible
      const statusTab = document.getElementById('page2');
      if (statusTab && !statusTab.classList.contains('hidden')) {
        utiliserDonneesTestStatus();
        chargerFacturationsColonnes();
        log('[DATA] Onglet Status mis √† jour localement');
      }
    }

    // Fonction pour obtenir les donn√©es statiques des √©tats (remplac√©e par syst√®me dynamique)
    function obtenirDonneesClientsStatiques() {
      return etatsRelsClients;
    }

    // Fonction pour d√©terminer dans quelle colonne Status placer le client
    function determinerStatusColumn(statutDepot, statutPaiementFinal) {
      // Si pas de d√©p√¥t envoy√©, n'appara√Æt dans aucune colonne
      if (statutDepot === 'non_envoye') {
        return null;
      }

      // Un d√©p√¥t est consid√©r√© "trait√©" si son statut est "traite" ou "traite_attente_final"
      const depotTraite = statutDepot === 'traite' || statutDepot === 'traite_attente_final';
      const paiementFinalTraite = statutPaiementFinal === 'traite' || statutPaiementFinal === null || statutPaiementFinal === undefined;

      // Si tout est termin√© -> traitees
      if (depotTraite && paiementFinalTraite) {
        return 'traitees';
      }

      // Tous les autres cas sont "en traitement" car il y a une action en cours:
      // - D√©p√¥t envoy√© (en attente traitement)
      // - D√©p√¥t en traitement
      // - D√©p√¥t en attente comptable
      // - Paiement final en traitement
      return 'traitement';
    }

    // Fonction pour obtenir les donn√©es centralis√©es des clients depuis l'API
    async function obtenirDonneesClientsWorkflow() {
      try {
        // R√©cup√©rer le username
        const username = getFacturationUsername();
        
        // Appel API pour r√©cup√©rer les clients avec leurs statuts
        const response = await fetch(`/api/facturationqe/clients/${username}`);
        if (!response.ok) {
          throw new Error(`Erreur API: ${response.status}`);
        }
        
        const data = await response.json();
        const clients = data.clients || [];
        
        const clientsWorkflow = {};
        
        // Transformer les donn√©es API en format attendu
        for (const client of clients) {
          const numeroSoumission = client.num || client.numeroSoumission;
          if (numeroSoumission) {
            clientsWorkflow[numeroSoumission] = {
              numeroSoumission: numeroSoumission,
              clientPrenom: client.prenom,
              clientNom: client.nom,
              statutDepot: client.statutDepot || 'non_envoye',
              statutPaiementFinal: client.statutPaiementFinal,
              description: await genererDescriptionDepuisAPI(username, numeroSoumission),
              statusColumn: determinerStatusColumn(client.statutDepot || 'non_envoye', client.statutPaiementFinal)
            };
          }
        }
        
        log('[OK] Donn√©es clients r√©cup√©r√©es depuis API:', Object.keys(clientsWorkflow).length, 'clients');
        return clientsWorkflow;
        
      } catch (error) {
        error('[ERROR] Erreur lors de la r√©cup√©ration des clients:', error);
        
        // En cas d'erreur, retourner un objet vide pour forcer l'utilisation des vraies donn√©es
        warn('[WARN] Impossible de r√©cup√©rer les donn√©es clients - Aucune donn√©e de test utilis√©e');
        return {};
      }
    }

    // Fonction fallback avec les donn√©es de test
    // Fonction supprim√©e - utilisation exclusive de l'API

    // Fonction pour g√©n√©rer la description depuis l'API
    async function genererDescriptionDepuisAPI(username, numeroSoumission) {
      try {
        const response = await fetch(`/api/facturationqe/client/${username}/${numeroSoumission}/description`);
        if (!response.ok) {
          throw new Error(`Erreur API description: ${response.status}`);
        }
        
        const data = await response.json();
        return data.description || '√âtat inconnu';
        
      } catch (error) {
        error('[ERROR] Erreur g√©n√©ration description:', error);
        return lireEtatReelBoutons(numeroSoumission);
      }
    }

    // Fonction pour synchroniser l'onglet Status avec les donn√©es API
    async function utiliserDonneesTestStatus() {
      log('üîÑ D√©but de la synchronisation des donn√©es Status avec API...');

      try {
        // R√©cup√©rer le username de mani√®re robuste (URL, window.username, storage)
        const username = getFacturationUsername();
        
        // Appel API pour r√©cup√©rer les colonnes de status
        const response = await fetch(`/api/facturationqe/status-columns/${username}`);
        if (!response.ok) {
          throw new Error(`Erreur API status-columns: ${response.status}`);
        }
        
        const data = await response.json();
        log('[BAN] Colonnes de status r√©cup√©r√©es depuis API:', data);
        
        // R√©initialiser les tableaux
        facturationsUrgentes = [];
        facturationsTraitement = [];
        facturationsTraitees = [];
        
        // Traiter chaque colonne - NOUVEAU: traiter chaque paiement individuellement
        if (data.urgentes && data.urgentes.clients) {
          data.urgentes.clients.forEach(payment => {
            const paymentData = transformerPaiementPourStatus(payment, 'urgente');
            facturationsUrgentes.push(paymentData);
            log('üö® Paiement ajout√© en urgente:', paymentData);
          });
        }

        if (data.en_traitement && data.en_traitement.clients) {
          data.en_traitement.clients.forEach(payment => {
            const paymentData = transformerPaiementPourStatus(payment, 'traitement');
            facturationsTraitement.push(paymentData);
            log('‚öôÔ∏è Paiement ajout√© en traitement:', paymentData);
          });
        }

        if (data.traitees && data.traitees.clients) {
          data.traitees.clients.forEach(payment => {
            const paymentData = transformerPaiementPourStatus(payment, 'traitees');
            facturationsTraitees.push(paymentData);
            log('[OK] Paiement ajout√© en trait√©:', paymentData);
          });
        }
        
        log('[DATA] R√©partition finale depuis API:', {
          urgentes: facturationsUrgentes.length,
          traitement: facturationsTraitement.length, 
          traitees: facturationsTraitees.length
        });
        
        // Construire l'objet facturationsData pour compatibilit√©
        facturationsData = {};
        [...facturationsUrgentes, ...facturationsTraitement, ...facturationsTraitees].forEach(facturation => {
          if (facturation.numeroSoumission) {
            facturationsData[facturation.numeroSoumission] = {
              numero: facturation.numeroSoumission,
              client: `${facturation.clientPrenom} ${facturation.clientNom}`,
              montant: facturation.montantPaiement,
              dateDepot: facturation.dateDepot,
              status: facturation.statut,
              description: facturation.description
            };
          }
        });
        
        log('[OK] Donn√©es Status synchronis√©es depuis API');

        // Mettre √† jour l'affichage des colonnes Status
        peuplerSectionsFacturations();

      } catch (error) {
        error('[ERROR] Erreur synchronisation Status API:', error);

        // Fallback vers les donn√©es locales
        await utiliserDonneesTestStatusFallback();
      }
    }

    // Fonction pour transformer un PAIEMENT API en format status (un paiement = une carte)
    function transformerPaiementPourStatus(payment, typeColonne) {
      const numeroSoumission = payment.num || payment.numeroSoumission;
      const typePaiement = payment.typePaiement || 'depot'; // "depot", "paiement_final", "autre_paiement_N"
      const montant = payment.montant || '0,00 $';
      const statutPaiement = payment.statutPaiement || 'traitement';

      // D√©terminer le label selon le type de paiement
      let label = '';
      let icon = 'fa-dollar-sign';

      if (typePaiement === 'depot') {
        label = 'D√©p√¥t';
        icon = 'fa-piggy-bank';
      } else if (typePaiement === 'paiement_final') {
        label = 'Paiement final';
        icon = 'fa-credit-card';
      } else if (typePaiement.startsWith('autre_paiement_')) {
        // Extraire le num√©ro du paiement partiel
        const numero = typePaiement.replace('autre_paiement_', '');
        const typePaiementAutres = payment.typePaiementAutres || 'paiement_partiel';

        if (typePaiementAutres === 'un_seul_paiement') {
          label = 'Paiement complet';
          icon = 'fa-dollar-sign';
        } else {
          label = `Paiement partiel ${numero}`;
          icon = 'fa-coins';
        }
      }

      // D√©terminer le statut textuel selon statutPaiement
      const userRole = localStorage.getItem('userRole');
      let statusText = '';
      if (statutPaiement === 'refuse') {
        statusText = '√† retraiter';
      } else if (statutPaiement === 'traite' || statutPaiement === 'traite_attente_final') {
        statusText = 'trait√©';
      } else if (statutPaiement === 'attente_comptable') {
        // Pour coach/direction: "en traitement comptable", pour entrepreneur: "en traitement"
        statusText = (userRole === 'coach' || userRole === 'direction') ? 'en traitement comptable' : 'en traitement';
      } else if (statutPaiement === 'traitement') {
        statusText = 'en traitement';
      } else if (statutPaiement === 'envoye') {
        statusText = 'envoy√©';
      }

      // V√©rifier si c'est un paiement refus√©
      const aRefus = statutPaiement === 'refuse';

      return {
        numeroSoumission: numeroSoumission,
        clientPrenom: payment.prenom || payment.clientPrenom,
        clientNom: payment.nom || payment.clientNom,
        montantPaiement: montant,
        totalTravaux: payment.total_travaux || payment.prix || '0,00 $',
        typePaiement: typePaiement,
        typePaiementLabel: label,
        typePaiementIcon: icon,
        methodePaiement: payment.methode || '',
        dateDepot: payment.date || '',
        statut: statutPaiement,
        statutPaiement: statutPaiement,

        // Nouveau format simplifi√©: une seule ligne de description
        description: `${label} ${statusText} (${montant})`,

        // Les anciens champs ne sont plus utilis√©s mais gard√©s pour compatibilit√©
        statusDepot: null,
        statusPaiementFinal: null,
        statutDepot: payment.statutDepot || 'non_envoye',
        statutPaiementFinal: payment.statutPaiementFinal || null,
        statutAutresPaiements: payment.statutAutresPaiements || null,
        autresPaiements: payment.autresPaiements || [],
        paiementsPartiels: [],
        paiementsUnSeul: [],
        hideTopPrice: true, // Toujours cacher le prix en haut car on l'affiche dans la description

        // Infos de refus
        aRefus: aRefus,
        refus: payment.refus || null,
        depotRefuse: aRefus && typePaiement === 'depot',
        paiementFinalRefuse: aRefus && typePaiement === 'paiement_final',
        autresRefuses: aRefus && typePaiement.startsWith('autre_paiement_')
      };
    }

    // Fonction pour transformer un client API en format status
    function transformerClientPourStatus(client, typeColonne) {
      const numeroSoumission = client.num || client.numeroSoumission;
      const statusData = getStatusDescriptionForClient(client);

      // Calculer le montant √† afficher: d√©p√¥t OU montant du "un seul paiement" si pas de d√©p√¥t
      let montantAffiche = client.depot?.montant || '0,00 $';
      if (montantAffiche === '0,00 $' && Array.isArray(client.autresPaiements) && client.autresPaiements.length > 0) {
        // Chercher un "un seul paiement" pour afficher son montant
        const unSeulPaiement = client.autresPaiements.find(p => p.typePaiementAutres === 'un_seul_paiement');
        if (unSeulPaiement && unSeulPaiement.montant) {
          montantAffiche = unSeulPaiement.montant;
        }
      }

      // V√©rifier si un paiement a √©t√© refus√©
      const autresPaiements = client.autresPaiements || [];
      const depotRefuse = client.statutDepot === 'refuse';
      const paiementFinalRefuse = client.statutPaiementFinal === 'refuse';
      const autresRefuses = autresPaiements.some(p => p.statut === 'refuse');
      const aRefus = depotRefuse || paiementFinalRefuse || autresRefuses;

      return {
        numeroSoumission: numeroSoumission,
        clientPrenom: client.prenom,
        clientNom: client.nom,
        montantPaiement: montantAffiche,
        totalTravaux: getTotalForClient(numeroSoumission),
        typePaiement: getTypePaiementForClient(numeroSoumission),
        methodePaiement: getMethodePaiementForClient(numeroSoumission),
        dateDepot: getDateForClient(numeroSoumission),
        statut: client.statutPaiementFinal === 'traitement' ? 'paiement_final_traitement' : 'traitement',
        description: statusData.single || '',
        statusDepot: statusData.depot,
        statusPaiementFinal: statusData.paiementFinal,
        statutDepot: client.statutDepot || 'non_envoye',  // Ajout du vrai statutDepot pour la validation coach
        statutPaiementFinal: client.statutPaiementFinal || null,  // Ajout du vrai statutPaiementFinal
        statutAutresPaiements: client.statutAutresPaiements || null,  // Statut global des autres paiements
        autresPaiements: client.autresPaiements || [],  // Array des autres paiements (paiements partiels, un seul paiement)
        paiementsPartiels: statusData.paiementsPartiels || [],  // Array des paiements partiels
        paiementsUnSeul: statusData.paiementsUnSeul || [],      // Array des "un seul paiement"
        hideTopPrice: statusData.hideTopPrice,
        typeTraitement: getTypeTraitementForClient(numeroSoumission),
        // Infos de refus
        aRefus: aRefus,
        refus: client.refus || null,  // Objet refus avec raison, conversation, etc.
        depotRefuse: depotRefuse,
        paiementFinalRefuse: paiementFinalRefuse,
        autresRefuses: autresRefuses
      };
    }
    
    // Fonction pour calculer le statut descriptif d'un client
    function getStatusDescriptionForClient(client) {
      const statutDepot = client.statutDepot || 'non_envoye';
      const statutPaiementFinal = client.statutPaiementFinal || 'attente';

      // Obtenir les montants
      const montantDepot = client.depot?.montant || '0,00 $';
      let montantPaiementFinal = client.paiementFinal?.montant || '0,00 $';

      // Si le paiement final n'est pas encore soumis (montant = 0,00 $), calculer le montant attendu
      const totalSource = client.totalTravaux || client.prix;
      if (montantPaiementFinal === '0,00 $' && totalSource && montantDepot !== '0,00 $') {
        // Convertir les montants pour calculer
        const parseAmount = (str) => {
          return parseFloat(String(str || '0').replace(/\s/g, '').replace(/,/g, '.').replace(/[^\d.]/g, '')) || 0;
        };
        const total = parseAmount(totalSource);
        const depot = parseAmount(montantDepot);
        const paiementFinalCalcule = total - depot;
        if (paiementFinalCalcule > 0) {
          montantPaiementFinal = `${paiementFinalCalcule.toFixed(2).replace('.', ',')} $`;
        }
      }

      // V√©rifier les autres paiements et les s√©parer par type
      let autresPaiements = Array.isArray(client.autresPaiements) ? client.autresPaiements : [];

      // CORRECTION AUTOMATIQUE: Si le d√©p√¥t est non_envoye ET il y a des autres paiements sans typePaiementAutres,
      // les corriger pour √™tre "un_seul_paiement" (sauf les remboursements)
      if (statutDepot === 'non_envoye' && autresPaiements.length > 0) {
        autresPaiements = autresPaiements.map(p => {
          if (p.typePaiementAutres === 'remboursement') {
            return p; // Ne pas toucher aux remboursements
          }
          if (!p.typePaiementAutres || p.typePaiementAutres === 'paiement_partiel') {
            return { ...p, typePaiementAutres: 'un_seul_paiement' };
          }
          return p;
        });
      }

      // Filtrer par type (inclure les remboursements dans paiementsPartiels)
      const paiementsPartiels = autresPaiements.filter(p => !p.typePaiementAutres || p.typePaiementAutres === 'paiement_partiel' || p.typePaiementAutres === 'remboursement');
      const paiementsUnSeul = autresPaiements.filter(p => p.typePaiementAutres === 'un_seul_paiement');

      // Statuts des paiements partiels (traitement OU attente_comptable = en traitement pour l'entrepreneur)
      const autresPaiementsEnTraitement = paiementsPartiels.filter(p => p.statut === 'traitement' || p.statut === 'attente_comptable');
      const autresPaiementsTraites = paiementsPartiels.filter(p => p.statut === 'traite');
      const hasAutresPaiementsEnTraitement = autresPaiementsEnTraitement.length > 0;
      const hasAutresPaiementsTraites = autresPaiementsTraites.length > 0;

      // Statuts des "un seul paiement" (traitement OU attente_comptable = en traitement pour l'entrepreneur)
      const unSeulPaiementEnTraitement = paiementsUnSeul.filter(p => p.statut === 'traitement' || p.statut === 'attente_comptable');
      const unSeulPaiementTraite = paiementsUnSeul.filter(p => p.statut === 'traite');
      const hasUnSeulPaiementEnTraitement = unSeulPaiementEnTraitement.length > 0;
      const hasUnSeulPaiementTraite = unSeulPaiementTraite.length > 0;

      // Calculer le montant total des autres paiements
      let totalAutresPaiements = 0;
      autresPaiements.forEach(p => {
        // Nettoyer le montant correctement (g√©rer espaces, virgules)
        const montantStr = String(p.montant || '0')
          .replace(/\s/g, '')  // Enlever espaces
          .replace(/,/g, '.')  // Remplacer virgule par point
          .replace(/[^\d.]/g, '');  // Garder seulement chiffres et point
        const montant = parseFloat(montantStr) || 0;
        totalAutresPaiements += montant;
        log('[MONEY] Montant autre paiement:', p.montant, '->', montant);
      });
      const montantAutresPaiementsFormate = totalAutresPaiements > 0 ? `${totalAutresPaiements.toFixed(2).replace('.', ',')} $` : '0,00 $';
      log('[MONEY] Total autres paiements calcul√©:', totalAutresPaiements, '->', montantAutresPaiementsFormate);

      // Retourner un objet avec les statuts s√©par√©s pour affichage en 2 <i> diff√©rents
      const result = {
        single: null,
        depot: null,
        paiementFinal: null,
        paiementsPartiels: [],  // Array pour afficher chaque paiement partiel s√©par√©ment
        paiementsUnSeul: [],    // Array pour afficher chaque "un seul paiement" s√©par√©ment
        hideTopPrice: false
      };

      // CAS SP√âCIAL: Un seul paiement (pas de d√©p√¥t mais des "un seul paiement")
      if (statutDepot === 'non_envoye' && hasUnSeulPaiementEnTraitement) {
        // Afficher chaque "un seul paiement" s√©par√©ment
        result.paiementsUnSeul = unSeulPaiementEnTraitement.map((p, index) => ({
          texte: `Un seul paiement en traitement (${p.montant || '0,00 $'})`,
          numero: index + 1
        }));
        result.hideTopPrice = true;
        return result;
      } else if (statutDepot === 'non_envoye' && hasUnSeulPaiementTraite) {
        // Afficher chaque "un seul paiement" trait√© s√©par√©ment
        result.paiementsUnSeul = unSeulPaiementTraite.map((p, index) => ({
          texte: `Un seul paiement trait√© (${p.montant || '0,00 $'})`,
          numero: index + 1
        }));
        result.hideTopPrice = true;
        return result;
      }

      // PRIORIT√â: Gestion des paiements refus√©s EN PREMIER
      const depotRefuseCheck = statutDepot === 'refuse';
      const paiementFinalRefuseCheck = statutPaiementFinal === 'refuse';
      const autresPaiementsRefuses = autresPaiements.filter(p => p.statut === 'refuse');
      const hasAutresPaiementsRefuses = autresPaiementsRefuses.length > 0;

      if (depotRefuseCheck) {
        result.single = `D√©p√¥t √† retraiter (${montantDepot})`;
        result.hideTopPrice = true;
        return result;
      } else if (paiementFinalRefuseCheck) {
        result.single = `Paiement final √† retraiter (${montantPaiementFinal})`;
        result.hideTopPrice = true;
        return result;
      } else if (hasAutresPaiementsRefuses) {
        result.paiementsPartiels = autresPaiementsRefuses.map((p, index) => ({
          texte: `Paiement partiel ${index + 1} √† retraiter (${p.montant || '0,00 $'})`,
          numero: index + 1
        }));
        result.hideTopPrice = true;
        return result;
      }

      // Logique de statut avec affichage s√©par√© pour depot et paiement final
      if (statutDepot === 'non_envoye') {
        result.single = 'En attente du d√©p√¥t';
      } else if (statutDepot === 'envoye') {
        result.single = 'D√©p√¥t envoy√©';
      } else if (statutDepot === 'traitement') {
        if (statutPaiementFinal === 'traitement' && hasAutresPaiementsEnTraitement) {
          // Tous en traitement
          result.depot = `D√©p√¥t en traitement (${montantDepot})`;
          result.paiementFinal = `Paiement final en traitement (${montantPaiementFinal})`;
          // Cr√©er un array avec chaque paiement partiel s√©par√©ment
          result.paiementsPartiels = autresPaiementsEnTraitement.map((p, index) => ({
            texte: `Paiement partiel ${index + 1} en traitement (${p.montant || '0,00 $'})`,
            numero: index + 1
          }));
          result.hideTopPrice = true;
        } else if (statutPaiementFinal === 'traitement') {
          // D√©p√¥t et paiement final en traitement
          result.depot = `D√©p√¥t en traitement (${montantDepot})`;
          result.paiementFinal = `Paiement final en traitement (${montantPaiementFinal})`;
          result.hideTopPrice = true;
        } else if (hasAutresPaiementsEnTraitement) {
          // D√©p√¥t et paiements partiels en traitement
          result.depot = `D√©p√¥t en traitement (${montantDepot})`;
          // Cr√©er un array avec chaque paiement partiel s√©par√©ment
          result.paiementsPartiels = autresPaiementsEnTraitement.map((p, index) => ({
            texte: `Paiement partiel ${index + 1} en traitement (${p.montant || '0,00 $'})`,
            numero: index + 1
          }));
          result.hideTopPrice = true;
        } else if (statutPaiementFinal === 'traite') {
          result.single = `Paiement final trait√© (${montantPaiementFinal})`;
          result.hideTopPrice = true;
        } else {
          result.single = `D√©p√¥t en traitement (${montantDepot})`;
          result.hideTopPrice = true;
        }
      } else if (statutDepot === 'attente_comptable') {
        // D√©p√¥t valid√© par le coach/direction - pour l'entrepreneur afficher "en traitement", pour le coach/direction afficher "en traitement comptable"
        const userRole = localStorage.getItem('userRole');
        const texteTraitement = (userRole === 'coach' || userRole === 'direction') ? 'en traitement comptable' : 'en traitement';

        if (statutPaiementFinal === 'attente_comptable') {
          // Les deux paiements sont valid√©s par coach
          result.depot = `D√©p√¥t ${texteTraitement} (${montantDepot})`;
          result.paiementFinal = `Paiement final ${texteTraitement} (${montantPaiementFinal})`;
        } else if (statutPaiementFinal === 'traitement') {
          // D√©p√¥t valid√©, paiement final soumis - afficher les deux
          result.depot = `D√©p√¥t ${texteTraitement} (${montantDepot})`;
          result.paiementFinal = `Paiement final en traitement (${montantPaiementFinal})`;
        } else if (statutPaiementFinal === 'traite') {
          // D√©p√¥t en attente comptable mais paiement final trait√©
          result.depot = `D√©p√¥t ${texteTraitement} (${montantDepot})`;
          result.paiementFinal = `Paiement final trait√© (${montantPaiementFinal})`;
        } else {
          result.single = `D√©p√¥t ${texteTraitement} (${montantDepot})`;
        }
        result.hideTopPrice = true;
      } else if (statutDepot === 'traite_attente_final') {
        // D√©p√¥t trait√© par la direction
        // PRIORIT√â 1: Paiement final trait√© = Paiements complets
        if (statutPaiementFinal === 'traite') {
          result.depot = `D√©p√¥t trait√© (${montantDepot})`;
          // Ajouter les paiements partiels trait√©s s'il y en a
          if (hasAutresPaiementsTraites) {
            result.paiementsPartiels = autresPaiementsTraites.map((p, index) => ({
              texte: `Paiement partiel ${index + 1} trait√© (${p.montant || '0,00 $'})`,
              numero: index + 1
            }));
          }
          result.paiementFinal = `Paiement final trait√© (${montantPaiementFinal})`;
          result.hideTopPrice = true;
        } else if (hasUnSeulPaiementTraite) {
          // Un seul paiement trait√© = Paiements complets
          result.paiementsUnSeul = unSeulPaiementTraite.map((p, index) => ({
            texte: `Paiement complet trait√© (${p.montant || '0,00 $'})`,
            numero: index + 1
          }));
          result.hideTopPrice = true;
        } else if (statutPaiementFinal === 'traitement') {
          // Paiement final soumis et en traitement - afficher sur 2 lignes
          result.depot = `D√©p√¥t trait√© (${montantDepot})`;
          // Ajouter les paiements partiels trait√©s s'il y en a
          if (hasAutresPaiementsTraites) {
            result.paiementsPartiels = autresPaiementsTraites.map((p, index) => ({
              texte: `Paiement partiel ${index + 1} trait√© (${p.montant || '0,00 $'})`,
              numero: index + 1
            }));
          }
          result.paiementFinal = `Paiement final √† traiter (${montantPaiementFinal})`;
          result.hideTopPrice = true;
        } else if (statutPaiementFinal === 'attente_comptable') {
          // Paiement final valid√© par coach/direction - pour l'entrepreneur afficher "en traitement", pour le coach/direction afficher "en traitement comptable"
          const userRole = localStorage.getItem('userRole');
          const texteTraitement = (userRole === 'coach' || userRole === 'direction') ? 'en traitement comptable' : 'en traitement';

          result.depot = `D√©p√¥t trait√© (${montantDepot})`;
          // Ajouter les paiements partiels trait√©s s'il y en a
          if (hasAutresPaiementsTraites) {
            result.paiementsPartiels = autresPaiementsTraites.map((p, index) => ({
              texte: `Paiement partiel ${index + 1} trait√© (${p.montant || '0,00 $'})`,
              numero: index + 1
            }));
          }
          result.paiementFinal = `Paiement final ${texteTraitement} (${montantPaiementFinal})`;
          result.hideTopPrice = true;
        } else if (hasUnSeulPaiementEnTraitement) {
          // Un seul paiement en traitement
          result.paiementsUnSeul = unSeulPaiementEnTraitement.map((p, index) => ({
            texte: `Paiement complet en traitement (${p.montant || '0,00 $'})`,
            numero: index + 1
          }));
          result.hideTopPrice = true;
        } else if (hasAutresPaiementsEnTraitement || hasAutresPaiementsTraites) {
          // Paiements partiels (combinaison trait√©s + en traitement)
          result.depot = `D√©p√¥t trait√© (${montantDepot})`;
          // Combiner tous les paiements partiels (trait√©s + en traitement)
          let allPaiementsPartiels = [];
          let indexCounter = 1;
          // D'abord les trait√©s
          if (hasAutresPaiementsTraites) {
            autresPaiementsTraites.forEach((p) => {
              allPaiementsPartiels.push({
                texte: `Paiement partiel ${indexCounter} trait√© (${p.montant || '0,00 $'})`,
                numero: indexCounter
              });
              indexCounter++;
            });
          }
          // Puis ceux en traitement
          if (hasAutresPaiementsEnTraitement) {
            autresPaiementsEnTraitement.forEach((p) => {
              allPaiementsPartiels.push({
                texte: `Paiement partiel ${indexCounter} en traitement (${p.montant || '0,00 $'})`,
                numero: indexCounter
              });
              indexCounter++;
            });
          }
          result.paiementsPartiels = allPaiementsPartiels;
          result.paiementFinal = `En attente paiement final`;
          result.hideTopPrice = true;
        } else {
          // En attente du paiement final (pas encore soumis) - sur 2 lignes
          result.depot = `D√©p√¥t trait√© (${montantDepot})`;
          result.paiementFinal = `En attente paiement final`;
          result.hideTopPrice = true;
        }
      } else if (statutDepot === 'traite') {
        // PRIORIT√â 1: Paiement final trait√© = Paiements complets
        if (statutPaiementFinal === 'traite') {
          // Tous paiements trait√©s - afficher les montants sur deux lignes
          result.depot = `D√©p√¥t trait√© (${montantDepot})`;
          // Ajouter les paiements partiels trait√©s s'il y en a
          if (hasAutresPaiementsTraites) {
            result.paiementsPartiels = autresPaiementsTraites.map((p, index) => ({
              texte: `Paiement partiel ${index + 1} trait√© (${p.montant || '0,00 $'})`,
              numero: index + 1
            }));
          }
          result.paiementFinal = `Paiement final trait√© (${montantPaiementFinal})`;
          result.hideTopPrice = true;
        } else if (hasUnSeulPaiementTraite) {
          // Un seul paiement trait√© = Paiements complets
          result.paiementsUnSeul = unSeulPaiementTraite.map((p, index) => ({
            texte: `Paiement complet trait√© (${p.montant || '0,00 $'})`,
            numero: index + 1
          }));
          result.hideTopPrice = true;
        } else if (statutPaiementFinal === 'traitement' && hasAutresPaiementsEnTraitement) {
          // Paiement final en traitement et paiements partiels en traitement
          result.single = `Paiement final en traitement (${montantPaiementFinal})`;
          // Cr√©er un array avec chaque paiement partiel s√©par√©ment
          result.paiementsPartiels = autresPaiementsEnTraitement.map((p, index) => ({
            texte: `Paiement partiel ${index + 1} en traitement (${p.montant || '0,00 $'})`,
            numero: index + 1
          }));
          result.hideTopPrice = true;
        } else if (statutPaiementFinal === 'traitement') {
          result.depot = `D√©p√¥t trait√© (${montantDepot})`;
          result.paiementFinal = `Paiement final en traitement (${montantPaiementFinal})`;
        } else if (hasUnSeulPaiementEnTraitement) {
          // Un seul paiement en traitement
          result.paiementsUnSeul = unSeulPaiementEnTraitement.map((p, index) => ({
            texte: `Paiement complet en traitement (${p.montant || '0,00 $'})`,
            numero: index + 1
          }));
          result.hideTopPrice = true;
        } else if (hasAutresPaiementsEnTraitement) {
          // Cr√©er un array avec chaque paiement partiel s√©par√©ment
          result.paiementsPartiels = autresPaiementsEnTraitement.map((p, index) => ({
            texte: `Paiement partiel ${index + 1} en traitement (${p.montant || '0,00 $'})`,
            numero: index + 1
          }));
          result.hideTopPrice = true;
        } else if (hasAutresPaiementsTraites && statutPaiementFinal === 'attente') {
          // Cr√©er un array avec chaque paiement partiel trait√© s√©par√©ment
          result.paiementsPartiels = autresPaiementsTraites.map((p, index) => ({
            texte: `Paiement partiel ${index + 1} trait√© (${p.montant || '0,00 $'})`,
            numero: index + 1
          }));
          result.single = 'En attente paiement final';
        } else {
          result.single = 'D√©p√¥t trait√©, en attente paiement final';
        }
      }

      // Gestion des paiements refus√©s - afficher quel paiement doit √™tre retrait√©
      if (!result.single && !result.depot && !result.paiementFinal) {
        // V√©rifier si un paiement a √©t√© refus√©
        const depotRefuse = statutDepot === 'refuse';
        const paiementFinalRefuse = statutPaiementFinal === 'refuse';
        const autresPaiementsRefuses = autresPaiements.filter(p => p.statut === 'refuse');
        const hasAutresPaiementsRefuses = autresPaiementsRefuses.length > 0;

        if (depotRefuse) {
          result.single = `D√©p√¥t √† retraiter (${montantDepot})`;
          result.hideTopPrice = true;
        } else if (paiementFinalRefuse) {
          result.single = `Paiement final √† retraiter (${montantPaiementFinal})`;
          result.hideTopPrice = true;
        } else if (hasAutresPaiementsRefuses) {
          // Afficher chaque paiement partiel refus√©
          result.paiementsPartiels = autresPaiementsRefuses.map((p, index) => ({
            texte: `Paiement partiel ${index + 1} √† retraiter (${p.montant || '0,00 $'})`,
            numero: index + 1
          }));
          result.hideTopPrice = true;
        } else {
          result.single = '√âtat ind√©termin√©';
        }
      }

      return result;
    }

    // Fonction fallback pour les donn√©es locales
    async function utiliserDonneesTestStatusFallback() {
      log('[WARN] Utilisation du fallback pour les donn√©es Status');
      const clientsWorkflow = await obtenirDonneesClientsWorkflow();
      
      facturationsUrgentes = [];
      facturationsTraitement = [];
      facturationsTraitees = [];
      
      Object.values(clientsWorkflow).forEach(client => {
        const clientData = transformerClientPourStatus(client, client.statusColumn);
        
        if (client.statusColumn === 'urgente') {
          facturationsUrgentes.push(clientData);
        } else if (client.statusColumn === 'traitement') {
          facturationsTraitement.push(clientData);
        } else if (client.statusColumn === 'traitees') {
          facturationsTraitees.push(clientData);
        }
      });
      
      log('[DATA] Fallback - R√©partition finale:', {
        urgentes: facturationsUrgentes.length,
        traitement: facturationsTraitement.length, 
        traitees: facturationsTraitees.length
      });
    }

    // Fonctions helper pour obtenir les donn√©es sp√©cifiques de chaque client
    async function getMontantForClient(numeroSoumission) {
      try {
        // Acc√®s direct aux donn√©es API
        const username = getFacturationUsername();
        const response = await fetch(`/api/facturationqe/clients/${username}`);
        const data = await response.json();
        
        const client = data.clients.find(c => c.num === numeroSoumission);
        if (client && client.depot && client.depot.montant) {
          log(`[MONEY] Montant trouv√© pour ${numeroSoumission}:`, client.depot.montant);
          return client.depot.montant;
        }
        
        log(`[WARN] Pas de depot.montant trouv√© pour ${numeroSoumission}, client:`, client);
      } catch (error) {
        error(`[ERROR] Erreur getMontantForClient pour ${numeroSoumission}:`, error);
      }
      
      // Fallback vers les donn√©es hardcod√©es pour les anciens clients
      const montants = {
        '24-0001': '2 250,00 $', '24-0002': '2 250,00 $', 
        '24-0003': '8 400,00 $', '24-0004': '5 950,00 $'
      };
      return montants[numeroSoumission] || '0,00 $';
    }

    function getTotalForClient(numeroSoumission) {
      const totaux = {
        '24-0001': '7 500,00 $', '24-0002': '7 500,00 $',
        '24-0003': '12 000,00 $', '24-0004': '8 500,00 $'
      };
      return totaux[numeroSoumission] || '0,00 $';
    }

    function getTypePaiementForClient(numeroSoumission) {
      const types = {
        '24-0001': 'D√©p√¥t', '24-0002': 'D√©p√¥t',
        '24-0003': 'Paiement Final', '24-0004': 'Paiement Final'
      };
      return types[numeroSoumission] || 'D√©p√¥t';
    }

    function getMethodePaiementForClient(numeroSoumission) {
      const methodes = {
        '24-0001': '', '24-0002': 'Virement',
        '24-0003': '', '24-0004': 'Virement'
      };
      return methodes[numeroSoumission] || '';
    }

    function getDateForClient(numeroSoumission) {
      const dates = {
        '24-0001': '', '24-0002': '15/03/2024',
        '24-0003': '20/02/2024', '24-0004': '28/03/2024'
      };
      return dates[numeroSoumission] || '';
    }

    function getTypeTraitementForClient(numeroSoumission) {
      const types = {
        '24-0001': '', '24-0002': 'D√©p√¥t',
        '24-0003': 'D√©p√¥t trait√©', '24-0004': 'D√©p√¥t trait√© + Paiement Final'
      };
      return types[numeroSoumission] || '';
    }

    function formatDateFromISO(isoString) {
      if (!isoString) return '';
      try {
        const date = new Date(isoString);
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (error) {
        error('Erreur format date:', error);
        return '';
      }
    }

    function mettreAJourCompteursInterface() {
      // Mettre √† jour les compteurs des badges
      const urgentBadge = document.querySelector('#page2-tab .bg-red-500');
      const enCoursBadge = document.querySelector('#page2-tab .bg-yellow-500');
      const traitementBadge = document.querySelector('#page2-tab .bg-blue-500');

      if (urgentBadge) urgentBadge.textContent = facturationsUrgentes.length;
      if (enCoursBadge) enCoursBadge.textContent = facturationsEnCours.length;
      if (traitementBadge) traitementBadge.textContent = facturationsTraitement.length;
      
      // Mettre √† jour les compteurs des sections
      const urgenteCount = document.getElementById('urgente-count');
      const traitementCount = document.getElementById('traitement-count');
      const traiteesCount = document.getElementById('traitees-count');

      if (urgenteCount) urgenteCount.textContent = facturationsUrgentes.length;
      if (traitementCount) traitementCount.textContent = facturationsTraitement.length;
      if (traiteesCount) traiteesCount.textContent = facturationsTraitees.length;

      // Peupler les sections avec les vraies donn√©es
      peuplerSectionsFacturations();
    }
    
    function peuplerSectionsFacturations() {
      log('üèóÔ∏è D√©but du peuplement des sections:', {
        urgentes: facturationsUrgentes.length,
        traitement: facturationsTraitement.length,
        traitees: facturationsTraitees.length
      });

      peuplerSection('urgente-content', facturationsUrgentes, 'Urgent', 'rgba(248, 113, 113, 0.2)', '#f87171', false);
      peuplerSection('traitement-content', facturationsTraitement, 'En cours', 'rgba(251, 146, 60, 0.2)', '#fb923c', false);
      // NOTE: La colonne Trait√©es affiche maintenant les p√©riodes via chargerPeriodesTraiter()
      // Ne pas remplir traitees-content ici pour √©viter d'√©craser les p√©riodes

      // Mettre √† jour les compteurs de toutes les colonnes
      const urgenteCount = document.getElementById('urgente-count');
      const traitementCount = document.getElementById('traitement-count');
      const traiteesCount = document.getElementById('traitees-count');

      if (urgenteCount) {
        urgenteCount.textContent = facturationsUrgentes.length;
      }
      if (traitementCount) {
        traitementCount.textContent = facturationsTraitement.length;
      }
      if (traiteesCount) {
        traiteesCount.textContent = facturationsTraitees.length;
      }

      log('[OK] Sections peupl√©es termin√©es');
    }
    
    function peuplerSection(containerId, facturations, statusText, bgColor, textColor, showModifyButton, showTraiterButton = false) {
      const container = document.getElementById(containerId);
      if (!container) return;

      // D√©tecter si l'utilisateur est un coach ou direction
      const userRole = localStorage.getItem('userRole');
      const isCoachOrDirection = userRole === 'coach' || userRole === 'direction';
      const isTraitementSection = containerId === 'traitement-content';
      const isUrgenteSection = containerId === 'urgente-content';

      if (facturations.length === 0) {
        container.innerHTML = `
        <div class="flex flex-col items-center justify-center py-12 px-6 text-center" style="color: var(--text-gray);">
          <i class="fas fa-file-invoice text-4xl mb-4" style="color: var(--text-secondary);"></i>
          <p class="text-sm">Aucune facturation</p>
        </div>
      `;
        // IMPORTANT: Mettre √† jour le total √† 0,00 $ quand il n'y a aucune facturation
        calculerEtMettreAJourTotal(containerId, facturations);
        return;
      }

      container.innerHTML = facturations.map(facturation => {
        const client = `${facturation.clientPrenom || ''} ${facturation.clientNom || ''}`.trim() || 'Client inconnu';
        const montant = formatCurrency(facturation.montantPaiement || '0');
        const dateCreation = facturation.dateCreation ? new Date(facturation.dateCreation).toLocaleDateString('fr-CA') : '';
        const tempsEcoule = facturation.dateCreation ? calculerTempsEcoule(facturation.dateCreation) : '';

        // Pour les coachs/direction dans la section traitement: bouton "√Ä traiter" ou badge "En attente comptable"
        let statusBadgeHTML;
        log('[DEBUG A TRAITER]', facturation.numeroSoumission, {
          isCoachOrDirection, isTraitementSection, userRole,
          statutDepot: facturation.statutDepot,
          statutPaiementFinal: facturation.statutPaiementFinal,
          statutAutresPaiements: facturation.statutAutresPaiements,
          autresPaiements: facturation.autresPaiements,
          aRefus: facturation.aRefus
        });

        // Pour les entrepreneurs ET coaches/direction dans la section urgente avec un refus: bouton "Lire"
        if (isUrgenteSection && facturation.aRefus) {
          statusBadgeHTML = `<button class="btn btn-danger text-xs px-3 py-1 rounded-full cursor-pointer transition-all"
             style="background-color: #ef4444 !important; border-color: #ef4444 !important; color: white;"
             onclick="event.stopPropagation(); ouvrirModalRefusEntrepreneur('${facturation.numeroSoumission}', ${JSON.stringify(facturation).replace(/"/g, '&quot;')})">
             <i class="fas fa-envelope-open-text mr-1"></i>Lire
           </button>`;
        } else if (isCoachOrDirection && isTraitementSection) {
          // Logique simplifi√©e: chaque carte = un paiement unique
          // Utiliser facturation.statutPaiement pour d√©terminer le badge
          const statutPaiement = facturation.statutPaiement || facturation.statut;

          if (statutPaiement === 'traitement') {
            // Paiement en traitement - afficher le bouton "√Ä traiter"
            statusBadgeHTML = `<button class="btn btn-primary btn-a-traiter text-xs px-3 py-1 rounded-full cursor-pointer transition-all"
               style="background-color: #f59e0b !important; border-color: #f59e0b !important;"
               onclick="event.stopPropagation(); ouvrirDetailsTraitement('${facturation.numeroSoumission}', ${JSON.stringify(facturation).replace(/"/g, '&quot;')})">
               <i class="fas fa-tasks mr-1"></i>√Ä traiter
             </button>`;
          } else if (statutPaiement === 'attente_comptable') {
            // Paiement valid√© par coach, en attente comptable
            statusBadgeHTML = '';
          } else {
            // Autres statuts (traite, etc.)
            statusBadgeHTML = '';
          }
        } else {
          statusBadgeHTML = `<span class="text-xs px-2 py-1 rounded-full" style="background: ${bgColor}; color: ${textColor};">${statusText}</span>`;
        }

        return `
          <div class="facturation-item p-4 rounded-lg transition-all cursor-pointer" data-numero="${facturation.numeroSoumission}" style="background: rgba(23, 32, 51, 0.6); border: 1px solid var(--border-dark);">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-medium" style="color: var(--text-light);">${client}</h3>
              <div class="flex items-center space-x-2">
                ${statusBadgeHTML}
                ${showModifyButton ? `<button class="text-xs px-2 py-1 rounded-md bg-blue-600 text-white hover:bg-blue-700 transition-colors" onclick="modifierFacturation('${facturation.numeroSoumission}')"><i class="fas fa-edit mr-1"></i>Modifier</button>` : ''}
                ${showTraiterButton ? `<button class="text-xs px-2 py-1 rounded-md bg-green-600 text-white hover:bg-green-700 transition-colors" onclick="marquerCommeTraite('${facturation.numeroSoumission}')"><i class="fas fa-check mr-1"></i>Trait√©</button>` : ''}
              </div>
            </div>
            <div class="text-sm" style="color: var(--text-gray);">
              <p class="mb-1" style="display: flex; align-items: center; font-weight: normal;"><i class="fas fa-hashtag" style="width: 18px; font-size: 14px;"></i>${facturation.numeroSoumission}</p>

              ${(() => {
                // Afficher le prix en haut seulement si hideTopPrice n'est pas true
                let topPriceHTML = '';
                if (!facturation.hideTopPrice) {
                  topPriceHTML = `<p class="mb-1" style="display: flex; align-items: center; font-weight: normal;"><i class="fas fa-dollar-sign" style="width: 18px; font-size: 14px;"></i>${montant}</p>`;
                }

                return topPriceHTML;
              })()}
              
              ${(() => {
                // NOUVEAU: Afficher UNE SEULE ligne avec le type et le montant du paiement
                let statusHTML = '';

                if (facturation.typePaiementLabel && facturation.description) {
                  const icon = facturation.typePaiementIcon || 'fa-dollar-sign';
                  statusHTML += `<p class="mb-1" style="display: flex; align-items: center; font-weight: normal;"><i class="fas ${icon}" style="width: 18px; font-size: 14px;"></i>${facturation.description}</p>`;
                } else {
                  // Fallback pour ancienne structure (si transformerClientPourStatus encore utilis√©)
                  // Afficher d√©p√¥t s√©par√© si disponible - alignement du texte
                  if (facturation.statusDepot) {
                    statusHTML += `<p class="mb-1" style="display: flex; align-items: center; font-weight: normal;"><i class="fas fa-piggy-bank" style="width: 18px; font-size: 14px;"></i>${facturation.statusDepot}</p>`;
                  }

                  // Afficher chaque paiement partiel sur une ligne s√©par√©e (ENTRE d√©p√¥t et paiement final)
                  if (facturation.paiementsPartiels && facturation.paiementsPartiels.length > 0) {
                    facturation.paiementsPartiels.forEach(pp => {
                      statusHTML += `<p class="mb-1" style="display: flex; align-items: center; font-weight: normal;"><i class="fas fa-coins" style="width: 18px; font-size: 14px;"></i>${pp.texte}</p>`;
                    });
                  }

                  // Afficher paiement final s√©par√© si disponible - alignement du texte (APR√àS les paiements partiels)
                  if (facturation.statusPaiementFinal) {
                    statusHTML += `<p class="mb-1" style="display: flex; align-items: center; font-weight: normal;"><i class="fas fa-credit-card" style="width: 18px; font-size: 14px;"></i>${facturation.statusPaiementFinal}</p>`;
                  }

                  // Afficher chaque "un seul paiement" sur une ligne s√©par√©e
                  if (facturation.paiementsUnSeul && facturation.paiementsUnSeul.length > 0) {
                    facturation.paiementsUnSeul.forEach(usp => {
                      statusHTML += `<p class="mb-1" style="display: flex; align-items: center; font-weight: normal;"><i class="fas fa-dollar-sign" style="width: 18px; font-size: 14px;"></i>${usp.texte}</p>`;
                    });
                  }
                }

                return statusHTML;
              })()}
            </div>
          </div>
        `;
      }).join('');

      // Calculer et mettre √† jour le total pour cette colonne
      calculerEtMettreAJourTotal(containerId, facturations);
    }

    // Fonction pour parser un montant au format "1293,46 $" ou "1293.46"
    function parseMontant(montantStr) {
      if (!montantStr) return 0;
      // Supprimer le symbole $ et les espaces
      let cleaned = String(montantStr).replace(/\$/g, '').trim();
      // Remplacer la virgule par un point pour le format d√©cimal
      cleaned = cleaned.replace(',', '.');
      // Parser en float
      return parseFloat(cleaned) || 0;
    }

    // Fonction pour calculer et afficher le total d'une colonne
    function calculerEtMettreAJourTotal(containerId, facturations) {
      // D√©terminer le span ID du total bas√© sur le containerId
      let totalSpanId = '';
      if (containerId === 'urgente-content') {
        totalSpanId = 'urgente-total';
      } else if (containerId === 'traitement-content') {
        totalSpanId = 'traitement-total';
      } else if (containerId === 'traitees-content') {
        totalSpanId = 'traitees-total';
      }

      if (!totalSpanId) return;

      const totalSpan = document.getElementById(totalSpanId);
      if (!totalSpan) return;

      // Calculer le total
      let total = 0;
      facturations.forEach(facturation => {
        const montant = parseMontant(facturation.montantPaiement);
        total += montant;
      });

      // Formater et afficher le total
      totalSpan.textContent = formatCurrency(total);
    }

    function calculerTempsEcoule(dateCreation) {
      if (!dateCreation) return 'Date inconnue';
      
      const maintenant = new Date();
      const creation = new Date(dateCreation);
      const diffMs = maintenant - creation;
      const diffHeures = Math.floor(diffMs / (1000 * 60 * 60));
      const diffJours = Math.floor(diffHeures / 24);
      
      if (diffJours > 0) {
        return diffJours === 1 ? 'Il y a 1 jour' : `Il y a ${diffJours} jours`;
      } else if (diffHeures > 0) {
        return diffHeures === 1 ? 'Il y a 1 heure' : `Il y a ${diffHeures} heures`;
      } else {
        return 'Il y a moins d\'une heure';
      }
    }

    // Fonction pour filtrer les colonnes Status par recherche
    function filterStatusColumns() {
      const searchTerm = document.getElementById('searchGlobal').value.toLowerCase();

      // R√©cup√©rer toutes les colonnes
      const colonnes = ['urgente-content', 'traitement-content', 'traitees-content'];

      colonnes.forEach(colonneId => {
        const colonne = document.getElementById(colonneId);
        if (!colonne) return;

        const items = colonne.querySelectorAll('.facturation-item');

        items.forEach(item => {
          // R√©cup√©rer le texte complet de l'item
          const textContent = item.textContent.toLowerCase();

          // V√©rifier si le terme de recherche est trouv√©
          if (searchTerm === '' || textContent.includes(searchTerm)) {
            item.style.display = '';
          } else {
            item.style.display = 'none';
          }
        });
      });
    }

    // Fonction pour modifier une facturation - d√©finie globalement
    async function modifierFacturation(numeroFacture) {
      log('Modification de la facture:', numeroFacture);
      
      // Attendre que le DOM soit charg√©
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => modifierFacturation(numeroFacture));
        return;
      }
      
      // Charger les donn√©es si n√©cessaires
      if (Object.keys(facturationsData).length === 0) {
        await chargerFacturationsDepuisAPI();
      }
      
      // R√©cup√©rer les donn√©es de la facturation
      const facturationData = facturationsData[numeroFacture];
      if (!facturationData) {
        error('Donn√©es de facturation non trouv√©es pour:', numeroFacture);
        // Essayer de r√©cup√©rer depuis l'API
        try {
          const username = getFacturationUsername();
          const response = await fetch(`/facturation/${username}/${numeroFacture}`);
          if (response.ok) {
            const apiData = await response.json();
            const facturationData = {
              numero: apiData.numeroSoumission,
              client: `${apiData.clientPrenom || ''} ${apiData.clientNom || ''}`.trim(),
              montantPaiement: apiData.montantPaiement || '0,00 $',
              totalTravaux: apiData.montantPaiement || '0,00 $',
              typePaiement: apiData.typePaiement || '',
              payePar: apiData.methodePaiement || '',
              dateDepot: apiData.dateDepot ? formatDateFromISO(apiData.dateDepot) : '',
              motDePasse: apiData.motDePasseVirement || '',
              lienVirement: apiData.lienVirement || '',
              numeroCheque: apiData.numeroCheque || '',
              message: apiData.message || '',
              status: apiData.statut || 'en_cours'
            };
            facturationsData[numeroFacture] = facturationData;
          } else {
            error('Facturation non trouv√©e dans l\'API');
            return;
          }
        } catch (error) {
          error('Erreur lors de la r√©cup√©ration depuis l\'API:', error);
          return;
        }
      }
      
      // Ouvrir la modal
      const modal = document.getElementById('modificationModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalContent = document.getElementById('modalContent');
      
      if (!modal || !modalTitle || !modalContent) {
        error('√âl√©ments de modal non trouv√©s');
        return;
      }
      
      modalTitle.textContent = `Modification - Facture ${numeroFacture}`;
      
      // Contenu de la modal avec formulaire de modification complet en 3 colonnes
      modalContent.innerHTML = `
        <!-- Message comptable en haut -->
        <div class="mb-6">
          <label class="block text-sm font-medium mb-2"><i class="fas fa-comment-alt mr-2 text-pink-400"></i>Message comptable</label>
          <textarea id="modalMessage" rows="3" placeholder="Aucun message de la comptable" 
                    class="w-full p-3 rounded-lg" style="background: rgba(23, 32, 51, 0.4); border: 1px solid var(--border-dark); color: var(--text-gray); resize: none; outline: none; border-radius: 12px;" readonly>${facturationData.message || ''}</textarea>
        </div>
        
        <div class="grid grid-cols-2 gap-6">
          <!-- Colonne 1: Informations principales -->
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2"><i class="fas fa-user mr-2 text-blue-400"></i>Client (non modifiable)</label>
              <input type="text" id="modalClient" value="${facturationData.client}" 
                     class="w-full p-3 rounded-lg modal-field-readonly" style="background: rgba(23, 32, 51, 0.4); border: 2px solid var(--border-dark); color: var(--text-gray); border-radius: 12px;" readonly>
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-2"><i class="fas fa-hashtag mr-2 text-green-400"></i>Num√©ro de soumission</label>
              <input type="text" id="modalNumero" value="${facturationData.numero}" 
                     class="w-full p-3 rounded-lg modal-field-editable" style="background: #172033; border: 2px solid var(--border-dark); color: var(--text-light); border-radius: 12px;">
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-2"><i class="fas fa-credit-card mr-2 text-orange-400"></i>Type de paiement</label>
              <div class="modern-dropdown modal-field-editable" id="modalTypePaiementToggle" style="border-radius: 12px;">
                <span class="placeholder" style="color: var(--text-gray);">Choisir le type...</span>
                <i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>
              </div>
              <div class="modern-dropdown-menu hidden" id="modalTypePaiementMenu">
                <div class="custom-select-option modal-field-editable" data-value="depot">D√©p√¥t</div>
                <div class="custom-select-option modal-field-editable" data-value="paiement_final">Paiement final</div>
                <div class="custom-select-option modal-field-editable" data-value="paiement_partiel">Paiement partiel</div>
                <div class="custom-select-option modal-field-editable" data-value="un_seul_paiement">Un seul paiement</div>
                <div class="custom-select-option modal-field-editable" data-value="remboursement">Remboursement</div>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-2"><i class="fas fa-dollar-sign mr-2 text-yellow-400"></i>Montant du paiement ($)</label>
              <input type="text" id="modalMontant" value="${facturationData.montantPaiement}" 
                     class="w-full p-3 rounded-lg modal-field-editable" style="background: #172033; border: 2px solid var(--border-dark); color: var(--text-light); border-radius: 12px;">
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-2"><i class="fas fa-calculator mr-2 text-purple-400"></i>Total des travaux ($)</label>
              <input type="text" id="modalTotalTravaux" value="${facturationData.totalTravaux}" 
                     class="w-full p-3 rounded-lg modal-field-editable" style="background: #172033; border: 2px solid var(--border-dark); color: var(--text-light); border-radius: 12px;">
            </div>
          </div>
          
          <!-- Colonne 2: Paiement et options -->
          <div class="space-y-4">
            
            <div class="relative">
              <label class="block text-sm font-medium mb-2"><i class="fas fa-calendar-alt mr-2 text-cyan-400"></i>Date de d√©p√¥t</label>
              <input type="text" id="modalDateDepot" name="date_depot" class="w-full p-3 rounded-lg cursor-pointer modal-field-editable" placeholder="S√©lectionner une date" 
                     value="${facturationData.dateDepot || ''}" style="background: #172033; border: 2px solid var(--border-dark); color: var(--text-light); border-radius: 12px;" readonly>
              <div class="custom-calendar hidden absolute bg-white border border-gray-300 rounded-lg shadow-lg z-50 p-4" id="modal-calendar-dateDepot">
                <div class="calendar-header flex justify-between items-center mb-4">
                  <button type="button" class="calendar-nav-btn" onclick="this.closest('.custom-calendar').calendar.prevMonth()">
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <div class="calendar-month-year font-bold"></div>
                  <button type="button" class="calendar-nav-btn" onclick="this.closest('.custom-calendar').calendar.nextMonth()">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
                <div class="calendar-grid grid grid-cols-7 gap-1 text-center">
                  <div class="calendar-day-header">Dim</div>
                  <div class="calendar-day-header">Lun</div>
                  <div class="calendar-day-header">Mar</div>
                  <div class="calendar-day-header">Mer</div>
                  <div class="calendar-day-header">Jeu</div>
                  <div class="calendar-day-header">Ven</div>
                  <div class="calendar-day-header">Sam</div>
                </div>
                <div class="calendar-days grid grid-cols-7 gap-1 text-center mt-2"></div>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-2"><i class="fas fa-money-check-alt mr-2 text-indigo-400"></i>Pay√© par</label>
              <div class="modern-dropdown modal-field-editable" id="modalPayeParToggle" style="border-radius: 12px;">
                <span class="placeholder" style="color: var(--text-gray);">Choisir m√©thode...</span>
                <i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>
              </div>
              <div class="modern-dropdown-menu hidden" id="modalPayeParMenu">
                <div class="custom-select-option modal-field-editable" data-value="virement">Virement</div>
                <div class="custom-select-option modal-field-editable" data-value="cheque">Ch√®que</div>
              </div>
            </div>
            
            <div id="modalMotDePasseContainer" class="hidden">
              <label class="block text-sm font-medium mb-2"><i class="fas fa-lock mr-2 text-red-400"></i>Mot de passe (si diff√©rent)</label>
              <input type="password" id="modalMotDePasse" placeholder="Saisir le mot de passe si diff√©rent" 
                     class="w-full p-3 rounded-lg modal-field-editable" style="background: #172033; border: 2px solid var(--border-dark); color: var(--text-light); border-radius: 12px;">
            </div>
            
            <div id="modalChampsPaiement" class="space-y-3 hidden">
              <!-- Les champs sp√©cifiques au type de paiement appara√Ætront ici -->
            </div>
          </div>
        </div>
      `;
      
      // Stocker le num√©ro de facture pour la sauvegarde
      modal.setAttribute('data-facture', numeroFacture);
      
      // Afficher la modal d'abord
      modal.classList.remove('hidden');
      
      // D√©sactiver le scroll de l'arri√®re-plan
      document.body.style.overflow = 'hidden';
      
      // Initialiser les dropzones du modal apr√®s affichage
      initModalChequeDropzones();
      
      // Initialiser le calendrier du modal
      new CustomCalendar('modalDateDepot', 'modal-calendar-dateDepot');
      
      // D√©finir la date et les prix apr√®s l'initialisation du calendrier
      setTimeout(() => {
        const dateField = document.getElementById('modalDateDepot');
        if (dateField && facturationData.dateDepot) {
          dateField.value = facturationData.dateDepot;
        }
        
        // Ajouter le formatage automatique aux champs de prix
        const modalMontant = document.getElementById('modalMontant');
        const modalTotalTravaux = document.getElementById('modalTotalTravaux');
        
        const formatPriceOnBlur = (value) => {
          if (!value) return value; // Retourner la valeur originale si vide
          const cleanValue = value.toString().replace(/[^0-9.-]/g, '');
          if (!cleanValue) return value; // Retourner la valeur originale si rien √† formater
          const numValue = parseFloat(cleanValue);
          if (isNaN(numValue)) return value; // Retourner la valeur originale si invalide
          
          // Formater manuellement pour √©viter les probl√®mes de locale
          const wholePart = Math.floor(numValue);
          const decimalPart = Math.round((numValue - wholePart) * 100);
          
          // Formater la partie enti√®re avec des espaces comme s√©parateurs de milliers
          const wholePartFormatted = wholePart.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
          
          // Formater la partie d√©cimale avec 2 chiffres
          const decimalFormatted = decimalPart.toString().padStart(2, '0');
          
          return wholePartFormatted + ',' + decimalFormatted + ' $';
        };
        
        if (modalMontant) {
          let originalMontantValue = modalMontant.value;
          modalMontant.addEventListener('focus', (e) => {
            originalMontantValue = e.target.value;
          });
          modalMontant.addEventListener('blur', (e) => {
            // Seulement formater si la valeur a chang√©
            if (e.target.value !== originalMontantValue) {
              e.target.value = formatPriceOnBlur(e.target.value);
            }
          });
        }
        
        if (modalTotalTravaux) {
          let originalTotalValue = modalTotalTravaux.value;
          modalTotalTravaux.addEventListener('focus', (e) => {
            originalTotalValue = e.target.value;
          });
          modalTotalTravaux.addEventListener('blur', (e) => {
            // Seulement formater si la valeur a chang√©
            if (e.target.value !== originalTotalValue) {
              e.target.value = formatPriceOnBlur(e.target.value);
            }
          });
        }
        
      }, 100);
      
      // Peupler les dropdowns avec les valeurs sauvegard√©es
      setTimeout(() => {
        // Type de paiement
        if (facturationData.typePaiement) {
          const typePaiementToggle = document.getElementById('modalTypePaiementToggle');
          const typePaiementOptions = {
            'depot': 'D√©p√¥t',
            'paiement_final': 'Paiement final',
            'paiement_partiel': 'Paiement partiel',
            'un_seul_paiement': 'Un seul paiement',
            'remboursement': 'Remboursement'
          };
          const selectedTypePaiement = typePaiementOptions[facturationData.typePaiement];
          if (selectedTypePaiement && typePaiementToggle) {
            typePaiementToggle.innerHTML = `<span style="color: var(--text-light);">${selectedTypePaiement}</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>`;
          }
        }
        
        // Pay√© par
        if (facturationData.payePar) {
          const payeParToggle = document.getElementById('modalPayeParToggle');
          const payeParOptions = {
            'virement': 'Virement',
            'cheque': 'Ch√®que'
          };
          const selectedPayePar = payeParOptions[facturationData.payePar];
          if (selectedPayePar && payeParToggle) {
            payeParToggle.innerHTML = `<span style="color: var(--text-light);">${selectedPayePar}</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>`;
            
            // D√©clencher l'affichage des champs conditionnels
            const modalChampsPaiement = document.getElementById('modalChampsPaiement');
            const modalMotDePasseContainer = document.getElementById('modalMotDePasseContainer');
            
            if (facturationData.payePar === 'virement') {
              modalChampsPaiement.innerHTML = '<div>' +
                '<label class="block text-sm font-medium mb-2"><i class="fas fa-link mr-2 text-blue-400"></i>Lien de virement</label>' +
                '<input type="url" id="modalLienVirement" placeholder="https://..." value="' + (facturationData.lienVirement || '') + '" ' +
                       'class="w-full p-3 rounded-lg modal-field-editable" style="background: #172033; border: 2px solid var(--border-dark); color: var(--text-light); border-radius: 12px; height: 49px;">' +
              '</div>';
              modalChampsPaiement.classList.remove('hidden');
              modalMotDePasseContainer.classList.remove('hidden');
              
              // Peupler le mot de passe s'il existe
              const modalMotDePasse = document.getElementById('modalMotDePasse');
              if (modalMotDePasse && facturationData.motDePasse) {
                modalMotDePasse.value = facturationData.motDePasse;
              }
            } else if (facturationData.payePar === 'cheque') {
              modalChampsPaiement.innerHTML = '<div class="space-y-4">' +
              '<div>' +
                '<label class="block text-sm font-medium mb-2"><i class="fas fa-file-invoice mr-2 text-green-400"></i>Num√©ro du ch√®que</label>' +
                '<input type="text" id="modalNumeroCheque" placeholder="Ex: CH123456789" value="' + (facturationData.numeroCheque || '') + '" ' +
                       'class="w-full p-3 rounded-lg modal-field-editable" style="background: #172033; border: 2px solid var(--border-dark); color: var(--text-light); border-radius: 12px; height: 49px;">' +
              '</div>' +
              '<div class="grid grid-cols-2 gap-4">' +
              '<div>' +
                '<label class="block text-sm font-medium mb-2"><i class="fas fa-image mr-2 text-green-400"></i>Recto du ch√®que</label>' +
                '<div id="modalDropzoneRecto" class="upload-zone-small">' +
                  '<p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Recto</p>' +
                  '<input type="file" id="modalPhotoFileRecto" name="modal_photo_cheque_recto" accept="image/*" class="hidden">' +
                '</div>' +
                '<div id="modalPreviewRecto" class="mt-2"></div>' +
              '</div>' +
              '<div>' +
                '<label class="block text-sm font-medium mb-2"><i class="fas fa-image mr-2 text-orange-400"></i>Verso du ch√®que</label>' +
                '<div id="modalDropzoneVerso" class="upload-zone-small">' +
                  '<p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Verso</p>' +
                  '<input type="file" id="modalPhotoFileVerso" name="modal_photo_cheque_verso" accept="image/*" class="hidden">' +
                '</div>' +
                '<div id="modalPreviewVerso" class="mt-2"></div>' +
              '</div>' +
            '</div>' +
            '</div>';
              modalChampsPaiement.classList.remove('hidden');
              modalMotDePasseContainer.classList.add('hidden');
              
              // R√©initialiser les dropzones pour les photos
              setTimeout(() => initModalChequeDropzones(), 100);
            }
          }
        }
      }, 200);
      
      // Utiliser l'√©v√©nement delegation directement sur la modal
      modal.addEventListener('click', (e) => {
        log('üëÜ Click dans la modal sur:', e.target);
        
        // G√©rer les dropdowns avec delegation
        if (e.target.closest('.modern-dropdown')) {
          e.stopPropagation();
          const toggle = e.target.closest('.modern-dropdown');
          const dropdownId = toggle.id;
          let menuId = '';
          
          if (dropdownId === 'modalPayeParToggle') {
            menuId = 'modalPayeParMenu';
          } else if (dropdownId === 'modalTypePaiementToggle') {
            menuId = 'modalTypePaiementMenu';
          }
          
          if (menuId) {
            const menu = document.getElementById(menuId);
            log('[DEBUG] Menu element found:', !!menu, 'for menuId:', menuId);
            if (menu) {
              log('[BAN] Menu classes before:', menu.className);
              log('[FIX] Toggle dropdown:', dropdownId);
              
              // Fermer tous les autres dropdowns du modal ET r√©initialiser leurs styles
              document.querySelectorAll('#modificationModal .modern-dropdown-menu').forEach(m => {
                if (m !== menu) {
                  m.classList.add('hidden');
                  // R√©initialiser les styles position fixed pour les autres menus
                  m.style.position = '';
                  m.style.top = '';
                  m.style.left = '';
                  m.style.width = '';
                  m.style.zIndex = '';
                }
              });
              document.querySelectorAll('#modificationModal .modern-dropdown').forEach(t => {
                if (t !== toggle) t.classList.remove('active');
              });
              
              // Toggle le dropdown actuel
              const wasHidden = menu.classList.contains('hidden');
              menu.classList.toggle('hidden');
              toggle.classList.toggle('active', !menu.classList.contains('hidden'));
              
              // Si on ouvre le menu, ajuster sa position pour qu'il soit au-dessus du modal
              if (wasHidden && !menu.classList.contains('hidden')) {
                const toggleRect = toggle.getBoundingClientRect();
                const modalRect = document.querySelector('#modificationModal > div').getBoundingClientRect();
                
                // Position relative au modal
                menu.style.position = 'fixed';
                menu.style.top = (toggleRect.bottom + 4) + 'px';
                menu.style.left = toggleRect.left + 'px';
                menu.style.width = toggleRect.width + 'px';
                menu.style.zIndex = '999999';
              }
              
            } else {
              error('[ERROR] Menu element not found for:', menuId);
            }
          }
        }
        
        // G√©rer les s√©lections d'options
        else if (e.target.closest('.custom-select-option')) {
          e.stopPropagation();
          const option = e.target.closest('.custom-select-option');
          const menu = option.closest('.modern-dropdown-menu');
          const menuId = menu.id;
          let toggleId = '';
          
          if (menuId === 'modalPayeParMenu') {
            toggleId = 'modalPayeParToggle';
          } else if (menuId === 'modalTypePaiementMenu') {
            toggleId = 'modalTypePaiementToggle';
          }
          
          if (toggleId) {
            const toggle = document.getElementById(toggleId);
            if (toggle) {
              log('[OK] Option s√©lectionn√©e:', option.textContent);
              
              // Mettre √† jour le texte affich√©
              const placeholder = toggle.querySelector('.placeholder');
              placeholder.textContent = option.textContent;
              placeholder.style.color = 'var(--text-light)';
              
              // Fermer le menu et r√©initialiser les styles position fixed
              menu.classList.add('hidden');
              toggle.classList.remove('active');
              
              // R√©initialiser les styles de positionnement
              menu.style.position = '';
              menu.style.top = '';
              menu.style.left = '';
              menu.style.width = '';
              menu.style.zIndex = '';
              
              // G√©rer les champs sp√©ciaux pour "Pay√© par"
              if (toggleId === 'modalPayeParToggle') {
                const modalChampsPaiement = document.getElementById('modalChampsPaiement');
                const modalMotDePasseContainer = document.getElementById('modalMotDePasseContainer');
                const selectedValue = option.dataset.value.toLowerCase();
                
                if (selectedValue === 'virement') {
                  modalChampsPaiement.innerHTML = '<div>' +
                    '<label class="block text-sm font-medium mb-2"><i class="fas fa-link mr-2 text-blue-400"></i>Lien de virement</label>' +
                    '<input type="url" id="modalLienVirement" placeholder="https://..." ' +
                           'class="w-full p-3 rounded-lg modal-field-editable" style="background: #172033; border: 2px solid var(--border-dark); color: var(--text-light); border-radius: 12px; height: 49px;">' +
                  '</div>';
                  modalChampsPaiement.classList.remove('hidden');
                  modalMotDePasseContainer.classList.remove('hidden');
                } else if (selectedValue === 'cheque') {
                  modalChampsPaiement.innerHTML = '<div class="space-y-4">' +
                  '<div>' +
                    '<label class="block text-sm font-medium mb-2"><i class="fas fa-file-invoice mr-2 text-green-400"></i>Num√©ro du ch√®que</label>' +
                    '<input type="text" id="modalNumeroCheque" placeholder="Ex: CH123456789" ' +
                           'class="w-full p-3 rounded-lg modal-field-editable" style="background: #172033; border: 2px solid var(--border-dark); color: var(--text-light); border-radius: 12px; height: 49px;">' +
                  '</div>' +
                  '<div class="grid grid-cols-2 gap-4">' +
                  '<div>' +
                    '<label class="block text-sm font-medium mb-2"><i class="fas fa-image mr-2 text-green-400"></i>Recto du ch√®que</label>' +
                    '<div id="modalDropzoneRecto" class="upload-zone-small">' +
                      '<p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Recto</p>' +
                      '<input type="file" id="modalPhotoFileRecto" name="modal_photo_cheque_recto" accept="image/*" class="hidden">' +
                    '</div>' +
                    '<div id="modalPreviewRecto" class="mt-2"></div>' +
                  '</div>' +
                  '<div>' +
                    '<label class="block text-sm font-medium mb-2"><i class="fas fa-image mr-2 text-orange-400"></i>Verso du ch√®que</label>' +
                    '<div id="modalDropzoneVerso" class="upload-zone-small">' +
                      '<p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Verso</p>' +
                      '<input type="file" id="modalPhotoFileVerso" name="modal_photo_cheque_verso" accept="image/*" class="hidden">' +
                    '</div>' +
                    '<div id="modalPreviewVerso" class="mt-2"></div>' +
                  '</div>' +
                '</div>' +
                '</div>';
                  modalChampsPaiement.classList.remove('hidden');
                  modalMotDePasseContainer.classList.add('hidden');
                } else {
                  modalChampsPaiement.classList.add('hidden');
                  modalMotDePasseContainer.classList.add('hidden');
                }
              }
            }
          }
        }
        
        // Fermer dropdowns si on clique ailleurs
        else if (!e.target.closest('.modern-dropdown-menu')) {
          document.querySelectorAll('#modificationModal .modern-dropdown-menu').forEach(menu => {
            menu.classList.add('hidden');
            // R√©initialiser le style pour position fixed
            menu.style.position = '';
            menu.style.top = '';
            menu.style.left = '';
            menu.style.width = '';
            menu.style.zIndex = '';
          });
          document.querySelectorAll('#modificationModal .modern-dropdown').forEach(toggle => {
            toggle.classList.remove('active');
          });
        }
      });

      // Formatage automatique des montants
      setTimeout(() => {
        const formatCurrency = (value) => {
          if (!value) return '';
          const cleanValue = value.toString().replace(/[^0-9.-]/g, '');
          const numValue = parseFloat(cleanValue);
          if (isNaN(numValue)) return '';
          
          // Formater manuellement pour √©viter les probl√®mes de locale
          const wholePart = Math.floor(numValue);
          const decimalPart = Math.round((numValue - wholePart) * 100);
          
          // Formater la partie enti√®re avec des espaces comme s√©parateurs de milliers
          const wholePartFormatted = wholePart.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
          
          // Formater la partie d√©cimale avec 2 chiffres
          const decimalFormatted = decimalPart.toString().padStart(2, '0');
          
          return wholePartFormatted + ',' + decimalFormatted + ' $';
        };

        // Les champs du modal n'ont pas besoin de formatage automatique
        // car ils sont d√©j√† pr√©format√©s dans les donn√©es
      }, 100);
      
      // Event listener global pour fermer les dropdowns du modal quand on clique ailleurs
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#modificationModal')) {
          document.querySelectorAll('#modificationModal .modern-dropdown-menu').forEach(menu => {
            menu.classList.add('hidden');
            // R√©initialiser les styles position fixed
            menu.style.position = '';
            menu.style.top = '';
            menu.style.left = '';
            menu.style.width = '';
            menu.style.zIndex = '';
          });
          document.querySelectorAll('#modificationModal .modern-dropdown').forEach(toggle => {
            toggle.classList.remove('active');
          });
        }
      });
    }

    // Fonctions pour g√©rer la modal - d√©finies globalement
    function fermerModal() {
      const modal = document.getElementById('modificationModal');
      if (modal) {
        modal.classList.add('hidden');
        // R√©activer le scroll de l'arri√®re-plan
        document.body.style.overflow = 'auto';
      }
    }

    async function sauvegarderModification() {
      try {
        const modal = document.getElementById('modificationModal');
        const numeroFacture = modal.getAttribute('data-facture');
        const username = getFacturationUsername();
        
        // R√©cup√©rer toutes les donn√©es du modal
        const donneesModifiees = {
          montantPaiement: document.getElementById('modalMontant')?.value || '',
          totalTravaux: document.getElementById('modalTotalTravaux')?.value || '',
          typePaiement: getSelectedDropdownValue('modalTypePaiementToggle'),
          methodePaiement: getSelectedDropdownValue('modalPayeParToggle'),
          dateDepot: document.getElementById('modalDateDepot')?.value || '',
          message: document.getElementById('modalMessage')?.value || '',
          motDePasseVirement: document.getElementById('modalMotDePasse')?.value || '',
          lienVirement: document.getElementById('modalLienVirement')?.value || '',
          numeroCheque: document.getElementById('modalNumeroCheque')?.value || ''
        };
        
        log('Sauvegarde modification:', { numeroFacture, donneesModifiees });
        
        // Envoyer √† l'API pour modification
        const response = await fetch(`/facturation/${username}/${numeroFacture}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(donneesModifiees)
        });
        
        if (response.ok) {
          const result = await response.json();
          log('Modification sauvegard√©e:', result);
          
          // Mettre √† jour les donn√©es locales
          if (facturationsData[numeroFacture]) {
            Object.assign(facturationsData[numeroFacture], donneesModifiees);
          }
          
          // Envoyer au comptable (d√©placer vers "En traitement")
          await envoyerAuComptableAPI(numeroFacture, donneesModifiees);
          
        } else {
          error('Erreur lors de la sauvegarde:', response.statusText);
          alert('Erreur lors de la sauvegarde. Veuillez r√©essayer.');
          return;
        }
        
        // Fermer la modal
        fermerModal();
        
        // Recharger les donn√©es pour refl√©ter les changements
        await chargerFacturationsDepuisAPI();
        
      } catch (error) {
        error('Erreur lors de la sauvegarde:', error);
        alert('Erreur lors de la sauvegarde. Veuillez r√©essayer.');
      }
    }
    
    function getSelectedDropdownValue(toggleId) {
      const toggle = document.getElementById(toggleId);
      if (!toggle) return '';
      
      const span = toggle.querySelector('span:not(.fas)');
      if (!span || span.classList.contains('placeholder')) return '';
      
      return span.textContent.trim();
    }

    async function envoyerAuComptableAPI(numeroFacture, donneesModifiees) {
      try {
        const username = getFacturationUsername();
        const facturationData = facturationsData[numeroFacture];
        
        if (!facturationData) {
          error('Donn√©es de facturation non trouv√©es');
          return;
        }
        
        // Utiliser la route existante pour envoyer au comptable
        const response = await fetch('/envoyer-comptable', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: username,
            clientNom: facturationData.client.split(' ').pop() || '',
            clientPrenom: facturationData.client.split(' ')[0] || '',
            numeroSoumission: numeroFacture,
            montantPaiement: donneesModifiees.montantPaiement,
            typePaiement: donneesModifiees.typePaiement,
            pdfUrl: '', // TODO: G√©n√©rer ou r√©cup√©rer l'URL du PDF
            methodePaiement: donneesModifiees.methodePaiement,
            lienVirement: donneesModifiees.lienVirement,
            motDePasseVirement: donneesModifiees.motDePasseVirement,
            numeroCheque: donneesModifiees.numeroCheque
          })
        });
        
        if (response.ok) {
          log('Facturation envoy√©e au comptable avec succ√®s');
        } else {
          error('Erreur lors de l\'envoi au comptable:', response.statusText);
        }
        
      } catch (error) {
        error('Erreur lors de l\'envoi au comptable:', error);
      }
    }
  </script>
  <!-- Styles sp√©cifiques √† Facturation QE -->

  <style>
    /* ============================================
       LOADING OVERLAY - Pour sectionPaiements
       ============================================ */
    .section-loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(4px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      border-radius: 16px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .section-loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .section-loading-overlay .spinner-ring {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(82, 113, 255, 0.2);
      border-top: 4px solid #5271ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .section-loading-overlay .loading-text {
      margin-top: 1rem;
      color: #e2e8f0;
      font-size: 1rem;
      font-weight: 500;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Animation de succ√®s pour la validation de paiement */
    @keyframes successFadeIn {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes checkmarkDraw {
      0% {
        stroke-dashoffset: 100;
      }
      100% {
        stroke-dashoffset: 0;
      }
    }

    .success-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: successFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .success-content {
      text-align: center;
      color: white;
      animation: successFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
    }

    .success-checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      margin: 0 auto 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
    }

    .success-checkmark svg {
      stroke: white;
      stroke-width: 3;
      stroke-dasharray: 100;
      stroke-dashoffset: 100;
      animation: checkmarkDraw 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.4s forwards;
    }

    /* ============================================
       TOAST NOTIFICATION - Succ√®s envoi
       ============================================ */
    .toast-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      min-width: 320px;
      max-width: 450px;
      padding: 1rem 1.5rem;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.95) 0%, rgba(22, 163, 74, 0.95) 100%);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(34, 197, 94, 0.3), 0 4px 15px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 1rem;
      z-index: 10002;
      transform: translateX(120%);
      opacity: 0;
      transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.3s ease;
    }

    .toast-notification.show {
      transform: translateX(0);
      opacity: 1;
    }

    .toast-notification .toast-icon {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .toast-notification .toast-icon i {
      font-size: 1.25rem;
      color: white;
    }

    .toast-notification .toast-content {
      flex: 1;
    }

    .toast-notification .toast-title {
      font-size: 1rem;
      font-weight: 600;
      color: white;
      margin-bottom: 0.25rem;
    }

    .toast-notification .toast-message {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.9);
    }

    .toast-notification .toast-close {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      padding: 0.25rem;
      font-size: 1.25rem;
      transition: color 0.2s ease;
    }

    .toast-notification .toast-close:hover {
      color: white;
    }

  </style>
  <link rel="stylesheet" href="/entrepreneur-selector.css">
</head>
<body class="min-h-screen" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: var(--text-light); margin: 0; padding: 0;">

  <!-- Backdrop pour le s√©lecteur coach (√©tat centr√©) -->
  <div id="coach-selector-backdrop"></div>

  <!-- S√©lecteur d'entrepreneur (visible uniquement pour les coaches) -->
  <div id="coach-entrepreneur-selector">
    <!-- Titre de la page avec ic√¥ne Facturation QE -->
    <div class="page-identity">
      <div class="page-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3), 0 0 40px rgba(16, 185, 129, 0.15);">
        <i class="fas fa-file-invoice-dollar"></i>
      </div>
      <div class="page-name" style="background: linear-gradient(135deg, #10b981 0%, #059669 50%, #34d399 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Facturation QE</div>
    </div>

    <!-- Titre et sous-titre (visibles uniquement en mode centr√©) -->
    <div class="selector-title">
      <i class="fas fa-user-tie"></i>
      S√©lectionnez un entrepreneur
    </div>
    <div class="selector-subtitle">Choisissez l'entrepreneur dont vous souhaitez g√©rer la facturation</div>

    <div class="selector-container">
      <div class="selector-label">
        <i class="fas fa-user-tie"></i>
        <span>Entrepreneur:</span>
      </div>
      <div class="coach-dropdown">
        <div class="coach-dropdown-toggle" id="coach-dropdown-toggle">
          <input type="text"
                 class="search-input"
                 id="search-input"
                 placeholder="Rechercher..."
                 autocomplete="off"
                 style="display: none;">
          <span class="placeholder">-- S√©lectionner un entrepreneur --</span>
          <i class="fas fa-chevron-down chevron"></i>
        </div>
        <div class="coach-dropdown-menu" id="coach-dropdown-menu">
          <!-- Options charg√©es dynamiquement -->
        </div>
      </div>
    </div>
  </div>

<!-- Wrapper pour SPA - extraction du contenu uniquement -->
<div class="main-content w-full" style="width: 100%; padding: 2rem;">

  <!-- Bouton Retour -->
  <div id="back-button-container">
    <button id="back-to-gestions-btn" onclick="goBackToGestions()" class="back-button">
      <i class="fas fa-arrow-left"></i>
    </button>
  </div>

<!-- Contenu principal -->
<div class="w-full" style="width: 100%;">

  <!-- Header Principal -->
  <div class="mb-10">
    <div class="relative">
      <h1 class="text-4xl font-bold mb-3" style="color: var(--text-light);">
        Facturation QE
      </h1>
      <span class="absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-blue-600 to-blue-400 rounded-full"></span>
      <div class="flex items-center justify-between">
        <p class="text-xl font-medium" style="color: var(--text-gray);">Gestion compl√®te des facturations</p>
      </div>
    </div>
  </div>

  <!-- Navigation Pages -->
  <div class="mb-8">
    <div class="tab-spacing" style="display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; gap: 1rem;">
        <button id="page1-tab" class="btn-primary px-6 py-3 rounded-lg font-semibold transition-all duration-300"
                onclick="showPage('page1')">
          <i class="fas fa-table mr-2"></i>Outils
        </button>
        <button id="page2-tab" class="btn-secondary px-6 py-3 rounded-lg font-semibold transition-all duration-300"
                onclick="showPage('page2')">
          <i class="fas fa-columns mr-2"></i>Status
        </button>
      </div>
      <!-- Bouton Remboursements (visible uniquement sur Status) -->
      <button id="btn-remboursements-nav" onclick="voirRemboursements()"
              class="btn-remb-discret text-sm flex items-center space-x-1 px-3 py-2 transition-all"
              style="background: rgba(148, 163, 184, 0.15); color: var(--text-gray); border-radius: 28px; display: none;"
              onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'; this.style.color='#ef4444'"
              onmouseout="this.style.background='rgba(148, 163, 184, 0.15)'; this.style.color='var(--text-gray)'">
        <i class="fas fa-undo" style="font-size: 0.9em;"></i>
        <span>Remboursements</span>
      </button>
    </div>
  </div>

  <!-- Le script anti-flash est maintenant dans le head avec ID 'coach-mode-initial-style' -->
  <!-- Il utilise page=status pour d√©tecter le mode coach et peut √™tre supprim√© par showPage() -->

  <!-- Page 1: Style newgqp/newsoumissiondark -->
  <div id="page1" class="page-content">

    <div class="space-y-8">

  <!-- Facturation QE -->
  <div class="box">
    <div class="box-header">
      <div style="display: flex; align-items: center; gap: 0.75rem;">
        <div class="box-header-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
          <i class="fas fa-file-invoice-dollar"></i>
        </div>
        <h2 class="box-header-title">Facturation QE</h2>
      </div>
    </div>
    <div class="box-body">

      <form id="facturationForm">
        
        <!-- PAGE FACTURATION -->
        <div id="page-facturation" style="display: block;">
          <!-- SECTION INFORMATION CLIENT FACTURATION -->
          <div class="form-section mb-6" id="sectionInformationClient">
            <h2 class="section-title">
              <i class="fas fa-user mr-2 text-blue-500"></i>
              Information client
            </h2>
          
          <!-- Informations client en grid propre -->
          <div class="grid grid-cols-4 gap-6 mb-4">
            <!-- S√©lection du client -->
            <div>
              <div class="custom-select relative">
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-users mr-2 text-green-500"></i>
                  S√©lectionner un client
                </label>
                <!-- Input searchable dropdown -->
                <div class="relative">
                  <input type="text"
                         id="clientSearchFacturation"
                         placeholder="Tapez pour rechercher un client..."
                         class="modern-input w-full pr-8"
                         autocomplete="off"
                         oninput="rechercherClientsFacturation(this.value)"
                         onclick="event.stopPropagation(); ouvrirMenuFacturation()"
                         onfocus="ouvrirMenuFacturation()"
                         style="border-right: 2px solid #e57373 !important;">
                  <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none" style="color: var(--text-gray);"></i>
                </div>
                <!-- Menu d√©roulant -->
                <div class="modern-dropdown-menu hidden absolute z-50 w-full mt-1" id="clientMenuFacturation" style="max-height: 200px;" onclick="event.stopPropagation();">
                  <!-- Les clients seront charg√©s dynamiquement depuis soumissions_signees -->
                </div>
              </div>
            </div>
            
            <!-- N¬∞ Soumission -->
            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-gray);">
                <i class="fas fa-hashtag mr-2 text-gray-500"></i>
                N¬∞ Soumission
              </label>
              <input type="text" id="clientInfo" placeholder="24-0001" class="modern-input cursor-not-allowed" style="background: rgba(55, 65, 81, 0.3); color: var(--text-light); border-color: rgba(75, 85, 99, 0.3);" readonly autocomplete="off">
            </div>
            
            <!-- Total des travaux -->
            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-gray);">
                <i class="fas fa-calculator mr-2 text-gray-500"></i>
                $ Total des travaux
              </label>
              <div class="relative">
                <input type="text" id="totalTravauxClient" name="total_travaux_client" placeholder="0 $" class="modern-input pr-10 cursor-not-allowed" style="background: rgba(55, 65, 81, 0.3); color: var(--text-light); border-color: rgba(75, 85, 99, 0.3); pointer-events: none;" readonly autocomplete="off">
              </div>
            </div>
            
            <!-- Bouton voir soumission -->
            <div class="flex flex-col justify-end">
              <button type="button" id="voirSoumissionBtn" class="btn-secondary px-2 py-2 rounded-lg font-medium transition-all duration-300 text-sm w-fit opacity-50 cursor-not-allowed"
                      onclick="voirSoumissionSignee()" disabled>
                <i class="fas fa-file-contract mr-1"></i>
                <span class="hide-on-tablet">Voir </span>soumission
              </button>
            </div>
          </div>
          
          <!-- Informations client suppl√©mentaires (cach√©es par d√©faut) -->
          <div id="clientDetailsCard" class="hidden mt-4 p-4 rounded-lg" style="background: rgba(23, 32, 51, 0.3); border: 1px solid var(--border-dark);">
            <div class="grid grid-cols-4 gap-4 mb-4">
              <div>
                <span class="text-sm font-medium" style="color: var(--text-gray);">Nom complet :</span>
                <p id="clientNomComplet" class="font-semibold" style="color: white;"></p>
              </div>
              <div>
                <span class="text-sm font-medium" style="color: var(--text-gray);">T√©l√©phone :</span>
                <p id="clientTelephone" class="font-semibold" style="color: white;"></p>
              </div>
              <div>
                <span class="text-sm font-medium" style="color: var(--text-gray);">Adresse :</span>
                <p id="clientAdresse" class="font-semibold" style="color: white;"></p>
              </div>
              <div>
                <span class="text-sm font-medium" style="color: var(--text-gray);">Statut paiement :</span>
                <p id="clientStatutPaiement" class="font-semibold" style="color: white;">En attente du d√©p√¥t</p>
              </div>
            </div>
            
            <!-- Barre de progression des paiements -->
            <div class="mt-4 mb-2">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium" style="color: var(--text-gray);">Progression des paiements</span>
                <span id="progressPercentage" class="text-sm font-semibold" style="color: var(--text-light);">0%</span>
              </div>
              <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
                <div id="progressBar" class="h-3 rounded-full transition-all duration-500 ease-in-out bg-gradient-to-r from-blue-500 to-green-500" style="width: 0%;"></div>
              </div>
              <div class="flex justify-between mt-2">
                <span id="progressTextLeft" class="text-xs" style="color: var(--text-gray);">0$</span>
                <span id="progressTextRight" class="text-xs" style="color: var(--text-gray);">0$</span>
              </div>
            </div>

            <!-- Bouton Remboursement -->
            <div class="mt-4">
              <!-- Note remboursements (affich√©e seulement si des remboursements existent) -->
              <span id="noteRemboursements" class="text-xs" style="color: #ef4444; display: none;"></span>

              <div class="flex justify-end">
                <button type="button"
                        onclick="ouvrirPopupRemboursement()"
                        class="btn-remb-discret text-sm flex items-center space-x-1 px-3 py-2 transition-all"
                        style="background: rgba(148, 163, 184, 0.15); color: var(--text-gray); border-radius: 28px;"
                        onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'; this.style.color='#ef4444'"
                        onmouseout="this.style.background='rgba(148, 163, 184, 0.15)'; this.style.color='var(--text-gray)'">
                  <i class="fas fa-undo" style="font-size: 0.9em;"></i>
                  <span>Remboursement</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- WRAPPER PRINCIPAL POUR TOUTES LES SECTIONS DE PAIEMENTS -->
        <div id="paiementsMainWrapper" style="position: relative;">
          <!-- Loading Overlay pour envoi au comptable - Couvre toutes les sections -->
          <div id="sectionPaiementsOverlay" class="section-loading-overlay">
            <div class="spinner-ring"></div>
            <span class="loading-text">Envoi au comptable en cours...</span>
          </div>

          <!-- Loading Overlay pour chargement client - Couvre toute la page -->
          <div id="loadingClientOverlay" class="section-loading-overlay" style="position: fixed; inset: 0; z-index: 9999;">
            <div class="spinner-ring"></div>
            <span class="loading-text">Chargement du client...</span>
          </div>

        <!-- SECTION PAIEMENTS AVEC BOUTONS -->
        <div class="mb-8" id="sectionPaiements" style="display: none; margin-top: 80px;">
          <!-- Boutons de s√©lection du type de paiement -->
          <div class="flex justify-between items-center mb-6">
            <!-- Workflow principal (gauche) -->
            <div class="tab-spacing" id="workflow-buttons-container" style="display: flex; gap: 0.5rem;">
              <button type="button" id="btn-depot" class="btn-secondary px-6 py-3 rounded-lg font-semibold transition-all duration-300 opacity-50 cursor-not-allowed" onclick="showPaiementSection('depot')" disabled>
                <i class="fas fa-piggy-bank mr-2"></i>
                D√©p√¥t
              </button>
              <!-- Les boutons de paiements partiels seront ins√©r√©s dynamiquement ICI -->
              <button type="button" id="btn-paiement-final" class="btn-secondary px-6 py-3 rounded-lg font-semibold transition-all duration-300 opacity-50 cursor-not-allowed" onclick="showPaiementSection('paiement-final')" disabled>
                <i class="fas fa-check-circle mr-2"></i>
                Paiement final
              </button>
            </div>

            <!-- Autres paiements (droite, plus petit) -->
            <div class="flex space-x-2">
              <button type="button" id="btn-autres-paiements" class="rounded-lg transition-all duration-300 border border-amber-500 text-amber-400 hover:bg-amber-500 hover:text-white px-4 py-2 text-sm btn-secondary" onclick="showPaiementSection('autres-paiements')" style="opacity: 0.3; cursor: not-allowed; pointer-events: none;" disabled>
                <i class="fas fa-exchange-alt mr-1 text-xs"></i>
                Autres paiements
              </button>
            </div>
          </div>

          <!-- CONTENU SECTION D√âP√îT -->
          <div id="content-depot" class="paiement-content">
            <h2 class="text-xl font-bold mb-4 border-b pb-2" style="color: var(--text-light); border-color: var(--border-dark);">
              <i class="fas fa-piggy-bank mr-2 text-blue-500"></i>
              D√©p√¥t
            </h2>
            <!-- Montants et Date d√©p√¥t -->
            <div class="grid grid-cols-4 gap-4 mb-4">
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-money-bill-wave mr-2 text-green-500"></i>
                  $ D√©p√¥t
                </label>
                <div class="relative">
                  <input type="text" id="paiement" name="paiement" placeholder="0,00" class="modern-input pr-10" autocomplete="off">
                  <span class="absolute right-3 top-1/2 transform -translate-y-1/2 font-medium" style="color: var(--text-gray);">$</span>
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-calendar-alt mr-2 text-purple-500"></i>
                  Date d√©p√¥t
                </label>
                <div class="custom-date-container">
                  <input type="text" id="dateDepot" name="date_depot" class="modern-input cursor-pointer" placeholder="S√©lectionner une date" readonly autocomplete="off">
                  <div class="custom-calendar hidden absolute bg-white border border-gray-300 rounded-lg shadow-lg z-50 p-4" id="calendar-dateDepot">
                    <!-- Calendar content will be generated here -->
                  </div>
                </div>
              </div>
              <div>
                <div class="custom-select">
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-money-check-alt mr-2 text-teal-500"></i>
                    Pay√© par
                  </label>
                  <div class="modern-dropdown" id="payeParToggle">
                    <span class="placeholder" style="color: var(--text-gray);">Choisir m√©thode...</span>
                    <i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>
                  </div>
                  <div class="modern-dropdown-menu hidden" id="payeParMenu">
                    <div class="custom-select-option" data-value="virement">Virement</div>
                    <div class="custom-select-option" data-value="cheque">Ch√®que</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- M√©thode de paiement -->
            <div class="grid grid-cols-4 gap-4 mb-4">
            </div>
          </div>

          <!-- CONTENU SECTION PAIEMENT FINAL -->
          <div id="content-paiement-final" class="paiement-content hidden">
            <h2 class="text-xl font-bold mb-4 border-b pb-2" style="color: var(--text-light); border-color: var(--border-dark);">
              <i class="fas fa-check-circle mr-2 text-green-500"></i>
              Paiement final
            </h2>
            
            <!-- MESSAGE DISCLAIMER POUR CLIENTS EN ATTENTE DE D√âP√îT -->
            <div id="disclaimerPaiementFinal" class="mb-4 p-4 rounded-lg border border-amber-500 bg-amber-500/10 hidden">
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                  <i class="fas fa-exclamation-triangle text-amber-500 text-lg mt-0.5"></i>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-amber-500 mb-1">Attention - Paiement sans d√©p√¥t</h3>
                  <p class="text-sm" style="color: var(--text-light);">
                    √ätes-vous s√ªr de vouloir proc√©der √† un paiement final alors qu'aucun d√©p√¥t n'a √©t√© effectu√© ? 
                    Il est recommand√© de traiter le d√©p√¥t avant le paiement final.
                  </p>
                </div>
              </div>
            </div>
            
            <!-- Montants et Date paiement final -->
            <div class="grid grid-cols-4 gap-4 mb-4">
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-money-bill-wave mr-2 text-green-500"></i>
                  $ Paiement final
                </label>
                <div class="relative">
                  <input type="text" id="paiementFinal" name="paiement_final" placeholder="0,00" class="modern-input pr-10" autocomplete="off">
                  <span class="absolute right-3 top-1/2 transform -translate-y-1/2 font-medium" style="color: var(--text-gray);">$</span>
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-calendar-alt mr-2 text-purple-500"></i>
                  Date paiement final
                </label>
                <div class="custom-date-container">
                  <input type="text" id="datePaiementFinal" name="date_paiement_final" class="modern-input cursor-pointer" placeholder="S√©lectionner une date" readonly autocomplete="off">
                  <div class="custom-calendar hidden absolute bg-white border border-gray-300 rounded-lg shadow-lg z-50 p-4" id="calendar-datePaiementFinal">
                    <!-- Calendar content will be generated here -->
                  </div>
                </div>
              </div>
              <div>
                <div class="custom-select">
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-money-check-alt mr-2 text-teal-500"></i>
                    Pay√© par
                  </label>
                  <div class="modern-dropdown" id="payeParFinalToggle">
                    <span class="placeholder" style="color: var(--text-gray);">Choisir m√©thode...</span>
                    <i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>
                  </div>
                  <div class="modern-dropdown-menu hidden" id="payeParFinalMenu">
                    <div class="custom-select-option" data-value="virement">Virement</div>
                    <div class="custom-select-option" data-value="cheque">Ch√®que</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- M√©thode de paiement -->
            <div class="grid grid-cols-4 gap-4 mb-4">
            </div>
          </div>

          <!-- CONTENU SECTION AUTRES PAIEMENTS -->
          <div id="content-autres-paiements" class="paiement-content hidden">
            <h2 class="text-xl font-bold mb-4 border-b pb-2" style="color: var(--text-light); border-color: var(--border-dark);">
              <i class="fas fa-exchange-alt mr-2 text-yellow-500"></i>
              Paiement partiel et un seul paiement
            </h2>
            <!-- Type de paiement, Montants et Date -->
            <div class="grid grid-cols-4 gap-4 mb-4">
              <div>
                <div class="custom-select">
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-credit-card mr-2 text-indigo-500"></i>
                    Type de paiement
                  </label>
                  <div class="modern-dropdown" id="typePaiementAutresToggle">
                    <span class="placeholder" style="color: var(--text-gray);">Choisir le type...</span>
                    <i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>
                  </div>
                  <div class="modern-dropdown-menu hidden" id="typePaiementAutresMenu">
                    <div class="custom-select-option" id="option-paiement-partiel" data-value="paiement_partiel">Paiement partiel</div>
                    <div class="custom-select-option" id="option-un-seul-paiement" data-value="un_seul_paiement">Un seul paiement</div>
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-money-bill-wave mr-2 text-green-500"></i>
                  $ Montant
                </label>
                <div class="relative">
                  <input type="text" id="paiementAutres" name="paiement_autres" placeholder="0,00" class="modern-input pr-10" autocomplete="off">
                  <span class="absolute right-3 top-1/2 transform -translate-y-1/2 font-medium" style="color: var(--text-gray);">$</span>
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-calendar-alt mr-2 text-purple-500"></i>
                  Date paiement
                </label>
                <div class="custom-date-container">
                  <input type="text" id="datePaiementAutres" name="date_paiement_autres" class="modern-input cursor-pointer" placeholder="S√©lectionner une date" readonly autocomplete="off">
                  <div class="custom-calendar hidden absolute bg-white border border-gray-300 rounded-lg shadow-lg z-50 p-4" id="calendar-datePaiementAutres">
                    <!-- Calendar content will be generated here -->
                  </div>
                </div>
              </div>
              <div>
                <div class="custom-select">
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-money-check-alt mr-2 text-teal-500"></i>
                    Pay√© par
                  </label>
                  <div class="modern-dropdown" id="payeParAutresToggle">
                    <span class="placeholder" style="color: var(--text-gray);">Choisir m√©thode...</span>
                    <i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>
                  </div>
                  <div class="modern-dropdown-menu hidden" id="payeParAutresMenu">
                    <div class="custom-select-option" data-value="virement">Virement</div>
                    <div class="custom-select-option" data-value="cheque">Ch√®que</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- SECTION √âL√âMENTS √Ä AJOUTER AUTRES PAIEMENTS (conditionnelle) -->
          <div id="elementsAjouterAutres" class="overflow-hidden transition-all duration-500 ease-in-out" style="max-height: 0; opacity: 0;">
            <h2 class="text-xl font-bold mb-4 border-b pb-2" style="color: var(--text-light); border-color: var(--border-dark);">
              <i class="fas fa-plus mr-2 text-orange-500"></i>
              √âl√©ments √† ajouter - Autres Paiements
            </h2>
            
            <!-- Container pour les champs conditionnels -->
            <div>
              <!-- Champs conditionnels pour virement autres paiements -->
              <div id="virementFieldsAutres" class="hidden grid grid-cols-4 gap-4 mb-4">
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-link mr-2 text-blue-500"></i>
                    Lien virement
                  </label>
                  <input type="text" name="lien_virement_autres" placeholder="Lien du virement" class="modern-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-lock mr-2 text-red-500"></i>
                    Mot de passe (si diff√©rent)
                  </label>
                  <input type="text" name="mdp_virement_autres" placeholder="Mot de passe" class="modern-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                </div>
                <div></div>
                <div></div>
              </div>
              
              <!-- Champs conditionnels pour ch√®que autres paiements -->
              <div id="chequeFieldsAutres" class="hidden grid grid-cols-3 gap-4 mb-4">
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-image mr-2 text-green-500"></i>
                    Recto du ch√®que
                  </label>
                  <div id="dropzoneRectoAutres" class="upload-zone-small">
                    <p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Recto</p>
                    <input type="file" id="photoFileRectoAutres" name="photo_cheque_recto_autres" accept="image/*" class="hidden">
                  </div>
                  <div id="previewRectoAutres" class="mt-2"></div>
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-image mr-2 text-orange-500"></i>
                    Verso du ch√®que
                  </label>
                  <div id="dropzoneVersoAutres" class="upload-zone-small">
                    <p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Verso</p>
                    <input type="file" id="photoFileVersoAutres" name="photo_cheque_verso_autres" accept="image/*" class="hidden">
                  </div>
                  <div id="previewVersoAutres" class="mt-2"></div>
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-hashtag mr-2 text-purple-500"></i>
                    Num√©ro du ch√®que
                  </label>
                  <input type="text" name="num_cheque_autres" placeholder="N¬∞ ch√®que" class="modern-input" autocomplete="off">
                </div>
              </div>
            </div>
          </div>

          <!-- CONTENU SECTION REMBOURSEMENT -->
          <div id="content-remboursement" class="paiement-content hidden">
            <!-- Section remboursement vide -->
          </div>

          <!-- CONTENEUR POUR LES PAIEMENTS PARTIELS DYNAMIQUES -->
          <div id="paiements-partiels-sections-container">
            <!-- Les sections de paiements partiels seront ajout√©es dynamiquement ici -->
          </div>

        </div>

        <!-- SECTION √âL√âMENTS √Ä AJOUTER PAIEMENT FINAL (conditionnelle) -->
        <div id="elementsAjouterPaiementFinal" class="overflow-hidden" style="max-height: 0; opacity: 0;">
          <h2 class="text-xl font-bold mb-4 border-b pb-2" style="color: var(--text-light); border-color: var(--border-dark);">
            <i class="fas fa-plus mr-2 text-green-500"></i>
            √âl√©ments √† ajouter - Paiement Final
          </h2>

          <!-- Container pour les champs conditionnels -->
          <div>
            <!-- Champs conditionnels pour virement paiement final -->
            <div id="virementFieldsPaiementFinal" class="hidden grid grid-cols-4 gap-4 mb-4">
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-link mr-2 text-blue-500"></i>
                  Lien virement
                </label>
                <input type="text" name="lien_virement_final" placeholder="Lien du virement" class="modern-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-lock mr-2 text-red-500"></i>
                  Mot de passe (si diff√©rent)
                </label>
                <input type="text" name="mdp_virement_final" placeholder="Mot de passe" class="modern-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
              </div>
              <!-- Espacement pour aligner avec les champs principaux -->
              <div></div>
              <div></div>
            </div>

            <!-- Champs conditionnels pour ch√®que paiement final -->
            <div id="chequeFieldsPaiementFinal" class="hidden grid grid-cols-3 gap-4 mb-4">
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-image mr-2 text-green-500"></i>
                  Recto du ch√®que
                </label>
                <div id="dropzoneRectoFinal" class="upload-zone-small">
                  <p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Recto</p>
                  <input type="file" id="photoFileRectoFinal" name="photo_cheque_recto_final" accept="image/*" class="hidden">
                </div>
                <div id="previewRectoFinal" class="mt-2"></div>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-image mr-2 text-orange-500"></i>
                  Verso du ch√®que
                </label>
                <div id="dropzoneVersoFinal" class="upload-zone-small">
                  <p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Verso</p>
                  <input type="file" id="photoFileVersoFinal" name="photo_cheque_verso_final" accept="image/*" class="hidden">
                </div>
                <div id="previewVersoFinal" class="mt-2"></div>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-hashtag mr-2 text-purple-500"></i>
                  Num√©ro du ch√®que
                </label>
                <input type="text" name="num_cheque_final" placeholder="N¬∞ ch√®que" class="modern-input" autocomplete="off">
              </div>
            </div>
          </div>
        </div>

        <!-- SECTION √âL√âMENTS √Ä AJOUTER D√âP√îT (conditionnelle) -->
        <div id="elementsAjouterDepot" class="overflow-hidden" style="max-height: 0; opacity: 0;">
          <h2 class="text-xl font-bold mb-4 border-b pb-2" style="color: var(--text-light); border-color: var(--border-dark);">
            <i class="fas fa-plus mr-2 text-yellow-500"></i>
            √âl√©ments √† ajouter - D√©p√¥t
          </h2>
          
          <!-- Container pour les champs conditionnels -->
          <div>
            <!-- Champs conditionnels pour virement d√©p√¥t -->
            <div id="virementFieldsDepot" class="hidden grid grid-cols-4 gap-4 mb-4">
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-link mr-2 text-blue-500"></i>
                  Lien virement
                </label>
                <input type="text" name="lien_virement" placeholder="Lien du virement" class="modern-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-lock mr-2 text-red-500"></i>
                  Mot de passe (si diff√©rent)
                </label>
                <input type="text" name="mdp_virement" placeholder="Mot de passe" class="modern-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
              </div>
              <!-- Colonnes vides pour maintenir l'alignement avec les champs principaux -->
              <div></div>
              <div></div>
            </div>
            
            <!-- Champs conditionnels pour ch√®que d√©p√¥t -->
            <div id="chequeFieldsDepot" class="hidden grid grid-cols-3 gap-4 mb-4">
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-image mr-2 text-green-500"></i>
                  Recto du ch√®que
                </label>
                <div id="dropzoneRecto" class="upload-zone-small">
                  <p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Recto</p>
                  <input type="file" id="photoFileRecto" name="photo_cheque_recto" accept="image/*" class="hidden">
                </div>
                <div id="previewRecto" class="mt-2"></div>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-image mr-2 text-orange-500"></i>
                  Verso du ch√®que
                </label>
                <div id="dropzoneVerso" class="upload-zone-small">
                  <p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Verso</p>
                  <input type="file" id="photoFileVerso" name="photo_cheque_verso" accept="image/*" class="hidden">
                </div>
                <div id="previewVerso" class="mt-2"></div>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-hashtag mr-2 text-purple-500"></i>
                  Num√©ro ch√®que
                </label>
                <input type="text" name="num_cheque" placeholder="N¬∞ ch√®que" class="modern-input" autocomplete="off">
              </div>
            </div>
          </div>
        </div>

          <!-- Message d'avertissement et Bouton d'envoi -->
          <div class="flex flex-col items-end" style="margin-top: 10rem; display: none;" id="boutonEnvoiContainer">
            <p id="validationWarningMessage" class="text-sm mb-2" style="display: block; color: rgb(229, 115, 115);">
              <i class="fas fa-exclamation-circle mr-1"></i>Veuillez remplir les informations requises
            </p>
            <button type="button" class="btn-primary no-border" id="envoyerComptableBtn">
              <i class="fas fa-paper-plane mr-2"></i>Envoy√© au comptable
            </button>
          </div>

        </div> <!-- FIN WRAPPER PRINCIPAL PAIEMENTS (paiementsMainWrapper) -->

        </div> <!-- Fin PAGE FACTURATION -->

        <!-- PAGE REMBOURSEMENT -->
        <div id="page-remboursement" style="display: none;">
          <!-- SECTION INFORMATION CLIENT REMBOURSEMENT -->
          <div class="mb-8" id="sectionInformationClientRemboursement">
            <div class="flex justify-between items-center mb-4 border-b pb-2" style="border-color: var(--border-dark);">
              <h2 class="text-xl font-bold" style="color: var(--text-light);">
                <i class="fas fa-user mr-2 text-blue-500"></i>
                Information client
              </h2>
              
              <!-- Bouton Facturation -->
              <div class="flex" style="gap: 1rem;">
                <button type="button" class="btn-secondary px-4 py-2 text-sm rounded-lg font-medium" onclick="activerModeFacturation()">
                  <i class="fas fa-file-invoice mr-1"></i>
                  Facturation
                </button>
              </div>
            </div>
          
            <!-- Informations client en grid propre -->
            <div class="grid grid-cols-4 gap-6 mb-4">
              <!-- S√©lection du client avec recherche -->
              <div>
                <div class="custom-select relative">
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-users mr-2 text-green-500"></i>
                    S√©lectionner un client
                  </label>
                  <!-- Input searchable dropdown -->
                  <div class="relative">
                    <input type="text" 
                           id="clientSearchRemboursement" 
                           placeholder="Tapez pour rechercher un client..." 
                           class="modern-input w-full pr-8" 
                           autocomplete="off" 
                           oninput="rechercherClientsRemboursement(this.value)"
                           onclick="event.stopPropagation(); ouvrirMenuRemboursement()"
                           onfocus="ouvrirMenuRemboursement()">
                    <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none" style="color: var(--text-gray);"></i>
                  </div>
                  <!-- Menu d√©roulant -->
                  <div class="modern-dropdown-menu hidden absolute z-50 w-full mt-1" id="clientMenuRemboursement" style="max-height: 200px;" onclick="event.stopPropagation();">
                    <!-- Les clients seront charg√©s dynamiquement depuis soumissions_signees -->
                  </div>
                </div>
              </div>
              
              <!-- N¬∞ Soumission -->
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-gray);">
                  <i class="fas fa-hashtag mr-2 text-gray-500"></i>
                  N¬∞ Soumission
                </label>
                <input type="text" id="clientInfoRemboursement" placeholder="24-0001" class="modern-input cursor-not-allowed" style="background: rgba(55, 65, 81, 0.3); color: var(--text-light); border-color: rgba(75, 85, 99, 0.3);" readonly autocomplete="off">
              </div>
              
              <!-- Total des travaux -->
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-gray);">
                  <i class="fas fa-calculator mr-2 text-gray-500"></i>
                  $ Total des travaux
                </label>
                <div class="relative">
                  <input type="text" id="totalTravauxClientRemboursement" name="total_travaux_client_remboursement" placeholder="0 $" class="modern-input pr-10 cursor-not-allowed" style="background: rgba(55, 65, 81, 0.3); color: var(--text-light); border-color: rgba(75, 85, 99, 0.3);" readonly autocomplete="off">
                </div>
              </div>
              
              <!-- Bouton voir soumission -->
              <div class="flex flex-col justify-end">
                <button type="button" id="voirSoumissionBtnRemboursement" class="btn-secondary px-2 py-2 rounded-lg font-medium transition-all duration-300 text-sm w-fit opacity-50 cursor-not-allowed"
                        onclick="voirSoumissionSigneeRemboursement()" disabled>
                  <i class="fas fa-file-contract mr-1"></i>
                  <span class="hide-on-tablet">Voir </span>soumission
                </button>
              </div>
            </div>
            
            <!-- Informations client suppl√©mentaires (cach√©es par d√©faut) -->
            <div id="clientDetailsCardRemboursement" class="hidden mt-4 p-4 rounded-lg" style="background: rgba(23, 32, 51, 0.3); border: 1px solid var(--border-dark);">
              <div class="grid grid-cols-4 gap-4 mb-4">
                <div>
                  <span class="text-sm font-medium" style="color: var(--text-gray);">Nom complet :</span>
                  <p id="clientNomCompletRemboursement" class="font-semibold" style="color: #6b7280;"></p>
                </div>
                <div>
                  <span class="text-sm font-medium" style="color: var(--text-gray);">T√©l√©phone :</span>
                  <p id="clientTelephoneRemboursement" class="font-semibold" style="color: #6b7280;"></p>
                </div>
                <div>
                  <span class="text-sm font-medium" style="color: var(--text-gray);">Adresse :</span>
                  <p id="clientAdresseRemboursement" class="font-semibold" style="color: #6b7280;"></p>
                </div>
                <div>
                  <span class="text-sm font-medium" style="color: var(--text-gray);">Statut paiement :</span>
                  <p id="clientStatutPaiementRemboursement" class="font-semibold" style="color: var(--text-light);">Remboursement</p>
                </div>
              </div>
            </div>
            
          </div>
        </div> <!-- Fin PAGE REMBOURSEMENT -->
        
      </form>
      
    </div>
  </div>

    </div>
  </div>

  <!-- Page 2: Style gestionvente en colonnes -->
  <div id="page2" class="page-content hidden">

    <!-- 3 Search fields above boxes -->
    <div class="flex mb-4" style="gap: 1.5rem;">
      <div class="search-fields-container" style="display: flex; gap: 1.5rem; flex: 1;">
        <!-- Recherche Urgent -->
        <div class="search-field-wrapper">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search" style="color: var(--text-gray);"></i>
            </div>
            <input type="text" id="searchUrgent" placeholder="Rechercher dans urgent..." class="search-field-input block w-full pl-10 pr-3 py-3 rounded-lg text-sm transition-all" style="background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light);" autocomplete="off" />
          </div>
        </div>

        <!-- Recherche En traitement -->
        <div class="search-field-wrapper">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search" style="color: var(--text-gray);"></i>
            </div>
            <input type="text" id="searchTraitement" placeholder="Rechercher en traitement..." class="search-field-input block w-full pl-10 pr-3 py-3 rounded-lg text-sm transition-all" style="background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light);" autocomplete="off" />
          </div>
        </div>

        <!-- Recherche Trait√©es -->
        <div class="search-field-wrapper">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search" style="color: var(--text-gray);"></i>
            </div>
            <input type="text" id="searchTraitees" placeholder="Rechercher dans trait√©es..." class="search-field-input block w-full pl-10 pr-3 py-3 rounded-lg text-sm transition-all" style="background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light);" autocomplete="off" />
          </div>
        </div>
      </div>
    </div>

    <!-- 3 Colonnes: √Ä traiter, En traitement, Trait√©es -->
    <div class="status-cards-container flex mb-8" style="gap: 1.5rem;">
      <!-- Colonne 1: √Ä traiter (Urgente) -->
      <div class="status-card-wrapper" id="urgente-box">
        <!-- Recherche Urgent (visible tablette seulement) -->
        <div class="search-field-tablet hidden">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search" style="color: var(--text-gray);"></i>
            </div>
            <input type="text" class="search-tablet-input search-field-input" data-target="searchUrgent" placeholder="Rechercher..." style="background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); width: 100%; padding: 0.75rem 0.75rem 0.75rem 2.5rem; border-radius: 0.5rem; font-size: 0.875rem;" autocomplete="off" />
          </div>
        </div>
        <div class="status-card p-6" style="--card-color: #f87171; min-height: 800px; max-height: 800px; display: flex; flex-direction: column;">
          <div class="mb-4">
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-bold" style="color: var(--text-light);">Urgent</h2>
              <div class="px-3 py-1 rounded-full text-sm font-medium" style="background: rgba(248, 113, 113, 0.2); color: #f87171;">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                <span id="urgente-count">0</span>
              </div>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-gray);">
              Total: <span id="urgente-total" style="font-weight: 600; color: #f87171;">0,00 $</span>
            </div>
          </div>

          <!-- Contenu dynamique avec scroll -->
          <div class="space-y-3 overflow-y-auto" id="urgente-content" style="flex: 1; margin-right: -20px; padding-right: 10px;">
            <!-- Contenu charg√© dynamiquement depuis l'API -->
          </div>
        </div>
      </div>

      <!-- Colonne 2: En traitement -->
      <div class="status-card-wrapper" id="traitement-box">
        <!-- Recherche En traitement (visible tablette seulement) -->
        <div class="search-field-tablet hidden">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search" style="color: var(--text-gray);"></i>
            </div>
            <input type="text" class="search-tablet-input search-field-input" data-target="searchTraitement" placeholder="Rechercher..." style="background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); width: 100%; padding: 0.75rem 0.75rem 0.75rem 2.5rem; border-radius: 0.5rem; font-size: 0.875rem;" autocomplete="off" />
          </div>
        </div>
        <div class="status-card p-6" style="--card-color: #fb923c; min-height: 800px; max-height: 800px; display: flex; flex-direction: column;">
          <div class="mb-4">
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-bold" style="color: var(--text-light);">En traitement</h2>
              <div class="px-3 py-1 rounded-full text-sm font-medium" style="background: rgba(251, 146, 60, 0.2); color: #fb923c;">
                <i class="fas fa-spinner mr-1"></i>
                <span id="traitement-count">0</span>
              </div>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-gray);">
              Total: <span id="traitement-total" style="font-weight: 600; color: #fb923c;">0,00 $</span>
            </div>
          </div>

          <!-- Contenu dynamique avec scroll -->
          <div class="space-y-3 overflow-y-auto" id="traitement-content" style="flex: 1; margin-right: -20px; padding-right: 10px;">
            <!-- Contenu charg√© dynamiquement depuis l'API -->
          </div>
        </div>
      </div>

      <!-- Colonne 3: Trait√©es -->
      <div class="status-card-wrapper" id="traitees-box">
        <!-- Recherche Trait√©es (visible tablette seulement) -->
        <div class="search-field-tablet hidden">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search" style="color: var(--text-gray);"></i>
            </div>
            <input type="text" class="search-tablet-input search-field-input" data-target="searchTraitees" placeholder="Rechercher..." style="background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); width: 100%; padding: 0.75rem 0.75rem 0.75rem 2.5rem; border-radius: 0.5rem; font-size: 0.875rem;" autocomplete="off" />
          </div>
        </div>
        <div class="status-card p-6" style="--card-color: #10b981; min-height: 800px; max-height: 800px; display: flex; flex-direction: column;">
          <div class="mb-4">
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-bold" style="color: var(--text-light);">Trait√©es</h2>
              <div class="px-3 py-1 rounded-full text-sm font-medium" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">
                <i class="fas fa-check-double mr-1"></i>
                <span id="traitees-count">0</span>
              </div>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-gray);">
              Total: <span id="traitees-total" style="font-weight: 600; color: #10b981;">0,00 $</span>
            </div>
          </div>

          <!-- P√©riodes de paiements trait√©s -->
          <div class="overflow-y-auto" id="traitees-content" style="flex: 1; margin-right: -20px; padding-right: 10px;">
            <div id="traiter-loading" style="display: none; text-align: center; padding: 2rem;">
              <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-blue);"></i>
              <p style="color: var(--text-gray); margin-top: 1rem;">Chargement...</p>
            </div>
            <div id="traiter-empty" class="flex flex-col items-center justify-center py-12 px-6 text-center" style="display: none; color: var(--text-gray);">
              <i class="fas fa-inbox text-4xl mb-4" style="color: var(--text-secondary);"></i>
              <p class="text-sm">Aucune donn√©e disponible</p>
            </div>
            <div id="periodes-container-traiter">
              <!-- Les p√©riodes seront charg√©es ici -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Indicateurs de swipe (tablette seulement) -->
    <div class="swipe-indicators hidden" id="statusSwipeIndicators">
      <div class="swipe-dot active" data-index="0" style="background: #f87171;"></div>
      <div class="swipe-dot" data-index="1" style="background: #fb923c;"></div>
      <div class="swipe-dot" data-index="2" style="background: #10b981;"></div>
    </div>
  </div>
</div>

<!-- Box En d√©veloppement -->
<div class="w-full" style="width: 100%; padding: 2rem; display: none;">
  <div class="flex items-center justify-center min-h-[60vh]">
    <div class="text-center p-12 rounded-2xl" style="background: var(--bg-card); border: 2px solid var(--border-dark); box-shadow: var(--shadow-dark-strong); max-width: 500px;">
      <div class="mb-6">
        <i class="fas fa-tools text-6xl" style="color: var(--primary-blue);"></i>
      </div>
      <h2 class="text-3xl font-bold mb-4" style="color: var(--text-light);">
        En d√©veloppement
      </h2>
      <p class="text-lg" style="color: var(--text-gray);">
        Cette section est actuellement en cours de d√©veloppement.
      </p>
    </div>
  </div>
</div>

  <script>
    // Variables globales pour la facturation
    window.clientsFacturationData = [];
    let clientsFacturationFiltres = [];
    
    // D√©clarations globales pr√©coces pour √©viter les erreurs de r√©f√©rence
    window.ouvrirMenuFacturation = async function() {
      log('[UNLOCK] FACTURATION: Tentative ouverture menu facturation');
      const menu = document.getElementById('clientMenuFacturation');
      log('[DEBUG] FACTURATION: Menu element:', menu);
      
      if (menu) {
        log('[OK] FACTURATION: Menu facturation trouv√©, suppression classe hidden');
        menu.classList.remove('hidden');
        
        // Charger les clients depuis l'API
        // V√©rifier si les clients sont d√©j√† charg√©s
        if (window.clientsFacturationData.length === 0) {
          log('üì• FACTURATION: Aucun client charg√©, charger depuis API');
          await chargerClientsDepuisAPI();
        } else {
          log('[BAN] FACTURATION: Clients d√©j√† charg√©s:', window.clientsFacturationData.length);
        }
        
        // Forcer l'affichage des clients
        if (typeof afficherClientsFacturationFiltres === 'function') {
          log('üñ•Ô∏è FACTURATION: Affichage forc√© des clients...');
          afficherClientsFacturationFiltres();
        }
      } else {
        log('[WARN] FACTURATION: Menu facturation introuvable');
      }
        
      log('üëÅÔ∏è FACTURATION: Menu visible:', menu && !menu.classList.contains('hidden'));
    };

    // showPage() et chargerFacturationsColonnes() sont d√©finis dans le <head>

    // Menu compte utilisateur - s'assurer que le DOM est charg√©
    const accountBtn = document.getElementById("account-dropdown-toggle");
    const accountDropdown = document.getElementById("account-dropdown");
    log('[DEBUG] Bouton account trouv√©:', accountBtn);
    log('[DEBUG] Dropdown trouv√©:', accountDropdown);
    if (accountBtn && accountDropdown) {
      accountBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        log('üëÜ Click sur account button');
        
        if (accountDropdown.classList.contains("hidden")) {
          accountDropdown.classList.remove("hidden");
          log('[UNLOCK] Dropdown ouvert');
        } else {
          accountDropdown.classList.add("hidden");
          log('[LOCK] Dropdown ferm√©');
        }
        
        log('[BAN] Dropdown classes:', accountDropdown.className);
      });
      // D√©lai pour √©viter la fermeture imm√©diate
      setTimeout(() => {
        window.addEventListener("click", (e) => {
          if (!accountBtn.contains(e.target) && !accountDropdown.contains(e.target)) {
            accountDropdown.classList.add("hidden");
          }
        });
      }, 100);
      log('[OK] Event listeners ajout√©s');
    } else {
      // error('[ERROR] Bouton ou dropdown non trouv√©');
    }

    // showPage() est d√©finie une seule fois dans le <head> avec la logique anti-flash

    // Fonction pour envoyer une facturation au comptable et la d√©placer vers "En traitement"
    function envoyerAuComptable(numeroFacture, nomClient) {
      log('Envoi au comptable:', numeroFacture);
      
      // D√©placer de "Urgente" vers "En traitement"
      const urgentContent = document.getElementById('urgente-content');
      const traitementContent = document.getElementById('traitement-content');
      
      // Trouver et supprimer l'√©l√©ment de la colonne urgente
      const facturationItems = urgentContent.querySelectorAll('.facturation-item');
      let itemToMove = null;
      
      facturationItems.forEach(item => {
        const factureText = item.querySelector('.fas.fa-file-invoice').parentNode.textContent;
        if (factureText.includes(numeroFacture)) {
          itemToMove = item;
        }
      });
      
      if (itemToMove) {
        // Modifier le statut et le style
        const statusSpan = itemToMove.querySelector('span:not(.fas)');
        statusSpan.textContent = 'En cours';
        statusSpan.style.background = 'rgba(251, 146, 60, 0.2)';
        statusSpan.style.color = '#fb923c';
        
        // Supprimer le bouton modifier
        const modifyBtn = itemToMove.querySelector('button');
        if (modifyBtn) modifyBtn.remove();
        
        // D√©placer vers la colonne "En traitement"
        urgentContent.removeChild(itemToMove);
        traitementContent.appendChild(itemToMove);
        
        // Mettre √† jour les compteurs
        const urgentCount = document.getElementById('urgente-count');
        const traitementCount = document.getElementById('traitement-count');
        urgentCount.textContent = parseInt(urgentCount.textContent) - 1;
        traitementCount.textContent = parseInt(traitementCount.textContent) + 1;
        
        // Message de succ√®s
        alert(`Facture ${numeroFacture} envoy√©e au comptable et d√©plac√©e vers "En traitement"`);
        
        // Retourner √† la page Status pour voir le changement
        showPage('page2');
      }
    }

    // Fonctions pour g√©rer la modal
    function fermerModal() {
      const modal = document.getElementById('modificationModal');
      modal.classList.add('hidden');
      // R√©activer le scroll de l'arri√®re-plan
      document.body.style.overflow = 'auto';
    }

    function sauvegarderModification() {
      const modal = document.getElementById('modificationModal');
      const numeroFacture = modal.getAttribute('data-facture');
      const montant = document.getElementById('modalMontant').value;
      const typePaiement = document.getElementById('modalTypePaiement').value;
      const message = document.getElementById('modalMessage').value;
      
      log('Sauvegarde modification:', { numeroFacture, montant, typePaiement, message });
      
      // TODO: Envoyer les modifications √† l'API
      
      // Simuler l'envoi au comptable et d√©placement vers "En traitement"
      // Le nom du client sera r√©cup√©r√© depuis les donn√©es de l'API
      const nomClient = facturationData.client || 'Client inconnu';
      
      // Fermer la modal
      fermerModal();
      
      // D√©placer vers "En traitement"
      envoyerAuComptable(numeroFacture, nomClient);
    }

    // Modal ne peut √™tre ferm√©e qu'avec les boutons X, Annuler ou Renvoyer

    // Initialisation au chargement de la page
    document.addEventListener('DOMContentLoaded', async function() {
      // V√©rifier les param√®tres URL pour d√©terminer quelle page afficher
      const urlParams = new URLSearchParams(window.location.search);
      const pageParam = urlParams.get('page');
      const userParam = urlParams.get('user');

      // V√©rifier si on est un coach ou direction
      const userRole = localStorage.getItem('userRole');
      const isCoachOrDirection = userRole === 'coach' || userRole === 'direction';

      // D√©tecter si le param√®tre user est un coach ou un entrepreneur
      const userParamIsCoach = userParam && isCoachUsername(userParam);

      // Mode coach/direction = userRole est 'coach' ou 'direction' ET (pas de param√®tre user OU param√®tre user est un coach)
      const isCoachModeWithoutSelection = isCoachOrDirection && (!userParam || userParamIsCoach);

      // CORRECTION: Afficher page2 (Status) SEULEMENT si c'est un coach/direction
      // Si page=status est demand√© ET c'est un coach/direction, OU si on a un param√®tre user ET c'est un coach/direction
      const shouldShowStatus = isCoachOrDirection && (pageParam === 'status' || urlParams.has('user'));
      log('[INIT] Mode coach sans s√©lection:', isCoachModeWithoutSelection, '| Page param:', pageParam, '| Show Status:', shouldShowStatus);
      showPage(shouldShowStatus ? 'page2' : 'page1');

      if (isCoachModeWithoutSelection) {
        log('[INIT] Mode coach d√©tect√© - Les donn√©es seront charg√©es apr√®s la s√©lection d\'entrepreneur');
        // Ne pas charger les donn√©es maintenant, elles seront charg√©es par selectEntrepreneur
        // Seulement initialiser le menu d√©roulant de s√©lection client
        initClientSelect();
        return;
      }

      // Initialiser le menu d√©roulant de s√©lection client
      initClientSelect();

      // Charger les clients facturation depuis l'API
      log('[INIT] Chargement initial des clients facturation...');
      await chargerClientsDepuisAPI();

      // Ajouter un client test pour les modifications
      ajouterClientTest();

      // Charger les clients depuis les soumissions (pour l'ancien syst√®me)
      chargerClients();

      // Charger toutes les facturations depuis l'API
      await chargerFacturationsDepuisAPI();
      // setupSingleSelect('clientToggle', 'clientMenu', 'Choisir un client...');  // D√©sactiv√© car utilise modern-dropdown
      
      // Initialiser les menus d√©roulants de paiement
      initPaiementSelects();
      // setupSingleSelect('typePaiementToggle', 'typePaiementMenu', 'Choisir le type...');  // D√©sactiv√© car utilise modern-dropdown
      // setupSingleSelect('payeParToggle', 'payeParMenu', 'Choisir m√©thode...');  // D√©sactiv√© car utilise modern-dropdown

      // Setup search listeners for each column
      setupFacturationSearchListeners();

      // Mobile search field management based on visible status card
      if (window.innerWidth <= 768) {
        const cardsContainer = document.querySelector('.status-cards-container');
        const searchWrappers = document.querySelectorAll('.search-field-wrapper');

        if (cardsContainer && searchWrappers.length > 0) {
          // Function to show appropriate search field based on scroll position
          function updateActiveSearchField() {
            const scrollLeft = cardsContainer.scrollLeft;
            const cardWidth = cardsContainer.clientWidth;
            const activeIndex = Math.round(scrollLeft / cardWidth);

            // Hide all search fields
            searchWrappers.forEach(wrapper => wrapper.classList.remove('active'));

            // Show the active search field
            if (searchWrappers[activeIndex]) {
              searchWrappers[activeIndex].classList.add('active');
            }
          }

          // Initialize with second search field active (En traitement - index 1)
          if (searchWrappers[1]) {
            searchWrappers[1].classList.add('active');
          }

          // Scroll to second card (En traitement) by default on mobile
          setTimeout(() => {
            const cardWidth = cardsContainer.clientWidth;
            cardsContainer.scrollLeft = cardWidth; // Scroll to second card (index 1)
          }, 100);

          // Update active search field when cards are swiped
          cardsContainer.addEventListener('scroll', updateActiveSearchField);
        }
      }
    });

    // Setup search listeners for facturation columns
    function setupFacturationSearchListeners() {
      // Recherche Urgent
      const searchUrgent = document.getElementById('searchUrgent');
      if (searchUrgent) {
        searchUrgent.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          filtrerFacturationsGlobales(searchTerm, 0); // Index 0 pour Urgent
        });
      }

      // Recherche En traitement
      const searchTraitement = document.getElementById('searchTraitement');
      if (searchTraitement) {
        searchTraitement.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          filtrerFacturationsGlobales(searchTerm, 1); // Index 1 pour En traitement
        });
      }

      // Recherche Trait√©es
      const searchTraitees = document.getElementById('searchTraitees');
      if (searchTraitees) {
        searchTraitees.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          filtrerFacturationsGlobales(searchTerm, 2); // Index 2 pour Trait√©es
        });
      }
    }

    // Filter facturations globally and auto-swipe to column with results
    function filtrerFacturationsGlobales(searchTerm, currentColumnIndex) {
      const colonnes = [
        { id: 'urgente-content', boxId: 'urgente-box' },
        { id: 'traitement-content', boxId: 'traitement-box' },
        { id: 'traitees-content', boxId: 'traitees-box' }
      ];

      if (!searchTerm) {
        // Si recherche vide, afficher tous les items
        colonnes.forEach(col => {
          const colonne = document.getElementById(col.id);
          if (colonne) {
            const items = colonne.querySelectorAll('.facturation-item');
            items.forEach(item => item.style.display = '');
          }
        });
        return;
      }

      let foundInColumn = -1;
      let hasResults = false;

      // Filtrer dans toutes les colonnes et trouver o√π sont les r√©sultats
      colonnes.forEach((col, index) => {
        const colonne = document.getElementById(col.id);
        if (!colonne) return;

        const items = colonne.querySelectorAll('.facturation-item');
        let columnHasResults = false;

        items.forEach(item => {
          const textContent = item.textContent.toLowerCase();
          if (textContent.includes(searchTerm)) {
            item.style.display = '';
            columnHasResults = true;
            hasResults = true;
            if (foundInColumn === -1) {
              foundInColumn = index;
            }
          } else {
            item.style.display = 'none';
          }
        });
      });

      // Sur mobile, swiper automatiquement vers la colonne avec r√©sultats
      if (window.innerWidth <= 768 && foundInColumn !== -1 && foundInColumn !== currentColumnIndex) {
        const cardsContainer = document.querySelector('.status-cards-container');
        if (cardsContainer) {
          const cardWidth = cardsContainer.clientWidth;
          cardsContainer.scrollLeft = cardWidth * foundInColumn;
        }
      }
    }

    // Fonction pour ajouter un client test temporaire
    function ajouterClientTest() {
      const clientMenu = document.getElementById('clientMenu');
      if (!clientMenu) return;
      
      // Client test avec toutes les donn√©es n√©cessaires
      const clientTest = {
        prenom: "Jean",
        nom: "Dupont", 
        email: "jean.dupont@email.com",
        telephone: "514-123-4567",
        adresse: "123 Rue Test, Montr√©al",
        prix: "5000.00",
        num: "24-TEST-001",
        id: "test-001",
        statutDepot: "non_envoye",
        total_travaux: "5000"
      };
      
      // Nettoyer le localStorage pour ce client test pour √©viter les conflits
      const depotsEnvoyes = JSON.parse(localStorage.getItem('depotsEnvoyes') || '{}');
      if (depotsEnvoyes['24-TEST-001'] || depotsEnvoyes['test-001']) {
        delete depotsEnvoyes['24-TEST-001'];
        delete depotsEnvoyes['test-001'];
        localStorage.setItem('depotsEnvoyes', JSON.stringify(depotsEnvoyes));
        log('üßπ Nettoyage localStorage pour Jean Dupont (test)');
      }
      
      // Cr√©er l'option test
      const optionTest = document.createElement('div');
      optionTest.className = 'custom-select-option';
      optionTest.dataset.clientData = JSON.stringify(clientTest);
      optionTest.innerHTML = `<div class="font-medium">üß™ Jean Dupont (TEST)</div>`;
      optionTest.style.padding = '12px';
      optionTest.style.cursor = 'pointer';
      optionTest.style.borderBottom = '1px solid #334155';
      optionTest.style.background = 'rgba(59, 130, 246, 0.1)';
      optionTest.style.color = '#60a5fa';
      
      // Ajouter au d√©but du menu
      clientMenu.appendChild(optionTest);
      log('üß™ Client test ajout√©:', clientTest);
    }

    // Fonction pour charger les clients depuis les soumissions
    async function chargerClients() {
      try {
        const username = window.username || 'user';
        const response = await fetch(`/soumissions_signees_facturation_qe/${username}`);
        
        if (response.ok) {
          const soumissions = await response.json();
          const clientMenu = document.getElementById('clientMenu');
          
          // V√©rifier si clientMenu existe (cette fonction peut √™tre appel√©e sur une page sans ce menu)
          if (!clientMenu) {
            warn('Element clientMenu introuvable - probablement sur une page diff√©rente');
            return;
          }
          
          // Cr√©er un set pour √©viter les doublons de clients
          const clientsUniques = new Map();

          soumissions.forEach(soumission => {
            // Filtrer les clients dont le paiement final est d√©j√† trait√©
            if (soumission.statutPaiementFinal === 'traite') {
              log('üö´ Client exclu (paiement final trait√©):', soumission.prenom, soumission.nom);
              return; // Ne pas ajouter ce client √† la liste
            }

            const clientKey = `${soumission.prenom} ${soumission.nom}`;
            if (!clientsUniques.has(clientKey)) {
              clientsUniques.set(clientKey, soumission);
            }
          });

          // Remplir le menu d√©roulant (en gardant le client test d√©j√† ajout√©)
          // clientMenu.innerHTML = ''; // Comment√© pour garder le client test

          clientsUniques.forEach((soumission, clientKey) => {
            const option = document.createElement('div');
            option.className = 'custom-select-option';
            option.dataset.clientData = JSON.stringify(soumission);
            option.innerHTML = `<div class="font-medium">${clientKey}</div>`;
            option.style.padding = '12px';
            option.style.cursor = 'pointer';
            option.style.borderBottom = '1px solid #334155';
            clientMenu.appendChild(option);
            log('[ADD] Option client cr√©√©e:', clientKey, option);
          });
          
          log(`${clientsUniques.size} clients uniques charg√©s`);
        } else {
          error('Erreur lors du chargement des soumissions');
        }
      } catch (error) {
        error('Erreur:', error);
      }
    }

    // Fonction pour initialiser le menu d√©roulant client
    function initClientSelect() {
      const toggle = document.getElementById('clientToggle');
      const menu = document.getElementById('clientMenu');
      
      log('[DEBUG] Toggle trouv√©:', toggle);
      log('[DEBUG] Menu trouv√©:', menu);
      
      if (!toggle || !menu) {
        warn('[WARN] √âl√©ments clientToggle/clientMenu non trouv√©s (non utilis√©s dans facturation)');
        return;
      }
      
      // G√©rer l'ouverture des menus avec d√©l√©gation d'√©v√©nements
      document.body.addEventListener('click', (e) => {
        // Ouvrir/fermer le menu client
        if (e.target.closest('#clientToggle')) {
          log('[TARGET] Clic sur clientToggle d√©tect√©');
          e.preventDefault();
          e.stopPropagation();
          
          const clientMenu = document.getElementById('clientMenu');
          const clientToggle = document.getElementById('clientToggle');
          
          // Fermer les autres dropdowns
          document.querySelectorAll('.modern-dropdown-menu').forEach(m => {
            if (m !== clientMenu) m.classList.add('hidden');
          });
          document.querySelectorAll('.modern-dropdown').forEach(t => {
            if (t !== clientToggle) t.classList.remove('active');
          });
          
          clientMenu.classList.toggle('hidden');
          clientToggle.classList.toggle('active', !clientMenu.classList.contains('hidden'));
          log('[BAN] Menu client maintenant:', clientMenu.classList.contains('hidden') ? 'ferm√©' : 'ouvert');
        }
      });
      
      log('üìé Event listener attach√© au menu client');
      
      // G√©rer TOUS les menus avec d√©l√©gation d'√©v√©nements
      document.body.addEventListener('click', (e) => {
        // V√©rifier si le clic est dans le menu client
        if (e.target.closest('#clientMenu')) {
          log('üëÜ Clic d√©tect√© sur le menu client');
          log('[TARGET] Target:', e.target);
          log('[TARGET] Target classList:', e.target.classList);
          
          const option = e.target.closest('.custom-select-option');
          log('[BAN] Option trouv√©e:', option);
          
          if (option) {
            log('[OK] Option valide, parsing data...');
            log('[DEBUG] Dataset clientData:', option.dataset.clientData);
            const clientData = JSON.parse(option.dataset.clientData);
            log('[DATA] Client data parsed:', clientData);
          
            // Mettre √† jour l'affichage du toggle
            const clientName = `${clientData.prenom} ${clientData.nom}`;
            toggle.innerHTML = `<span style="color: var(--text-light);">${clientName}</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>`;
            
            // Remplir le champ num√©ro de soumission
            const clientInfo = document.getElementById('clientInfo');
            
            // Prioriser le vrai num√©ro de soumission (format 24-XXXX) 
            let numeroSoumission = clientData.num || clientData.numero || '000';
            
            // Si c'est un UUID (contient des tirets mais ne commence pas par "24-"), utiliser un fallback
            if (numeroSoumission.includes('-') && !numeroSoumission.startsWith('24-')) {
              numeroSoumission = '24-XXXX'; // Affichage g√©n√©rique pour les anciens UUIDs
            }
            
            clientInfo.value = `${numeroSoumission}`;
            
            // Auto-remplir le champ "Total des travaux" avec le prix format√©
            const totalTravauxField = document.getElementById('totalTravauxClient');
            log('[MONEY] Prix du client:', clientData.prix);
            log('[BAN] Champ total travaux:', totalTravauxField);
            if (clientData.prix) {
              // Formater le prix : 1000 -> "1 000,00 $"
              const prix = parseFloat(clientData.prix);
              const wholePart = Math.floor(prix);
              const decimalPart = Math.round((prix - wholePart) * 100);
              const wholePartFormatted = wholePart.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
              const decimalFormatted = decimalPart.toString().padStart(2, '0');
              const prixFormate = wholePartFormatted + ',' + decimalFormatted + ' $';
              totalTravauxField.value = prixFormate;
              log('[OK] Prix format√© rempli:', prixFormate);
            }
            
            // Sauvegarder les donn√©es client pour le bouton "Envoy√© au comptable"
            sessionStorage.setItem('selectedClientData', JSON.stringify(clientData));
            
            // Activer le bouton "Voir soumission sign√©e"
            const voirSoumissionBtn = document.getElementById('voirSoumissionBtn');
            if (voirSoumissionBtn) {
              voirSoumissionBtn.disabled = false;
              voirSoumissionBtn.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
            }
            
            // Afficher les d√©tails du client
            const clientDetailsCard = document.getElementById('clientDetailsCard');
            const nomComplet = document.getElementById('clientNomComplet');
            const clientTelephone = document.getElementById('clientTelephone');
            const clientAdresse = document.getElementById('clientAdresse');
            
            if (clientDetailsCard && nomComplet && clientTelephone && clientAdresse) {
              nomComplet.textContent = `${clientData.prenom} ${clientData.nom}`;
              clientTelephone.textContent = clientData.telephone || 'Non renseign√©';
              clientAdresse.textContent = clientData.adresse || 'Non renseign√©e';
              clientDetailsCard.classList.remove('hidden');
              
              // Mettre √† jour la progression du paiement
              updateProgressionPaiement(clientData);
            }
            
            // Fermer le menu
            menu.classList.add('hidden');
            toggle.classList.remove('active');
            
            log('Client s√©lectionn√©:', clientName, 'Num√©ro:', numeroSoumission);
            
            // Activer la section paiements apr√®s s√©lection du client
            log('[LAUNCH] Activation des sections paiements...');
            toggleSectionPaiements(true);
            log('[OK] Sections paiements activ√©es');

            // IMPORTANT: Forcer la r√©initialisation des dropdowns pour les coaches
            // Car toggleSectionPaiements peut ne pas d√©clencher l'init si la section est d√©j√† visible
            console.log('[CLIENT SELECT] For√ßage r√©initialisation dropdowns...');
            const dropdownsToReinit = ['typePaiementAutresToggle', 'payeParToggle', 'payeParFinalToggle', 'payeParAutresToggle', 'payeParRemboursementToggle'];
            dropdownsToReinit.forEach(id => {
              const element = document.getElementById(id);
              if (element && element.dataset.initialized) {
                delete element.dataset.initialized;
              }
            });
            if (typeof initPaiementSelects === 'function') {
              initPaiementSelects();
              console.log('[CLIENT SELECT] ‚úÖ Dropdowns r√©initialis√©s');
            }

            // NOTE: Le statut du d√©p√¥t est maintenant g√©r√© dans selectionnerClientFacturation()
            // pour √©viter les conflits entre localStorage et les donn√©es du client
            log('[OK] Statut du d√©p√¥t g√©r√© par selectionnerClientFacturation()');
          }
        }
        
        // V√©rifier si le clic est dans le menu Type de paiement
        else if (e.target.closest('#typePaiementMenu')) {
          log('üëÜ Clic d√©tect√© sur typePaiementMenu');
          log('[TARGET] Target:', e.target);
          const option = e.target.closest('.custom-select-option');
          log('[BAN] Option trouv√©e:', option);
          if (option) {
            const value = option.dataset.value;
            const text = option.textContent;
            const typePaiementToggle = document.getElementById('typePaiementToggle');
            const typePaiementMenu = document.getElementById('typePaiementMenu');
            
            typePaiementToggle.innerHTML = `<span style="color: var(--text-light);">${text}</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>`;
            typePaiementMenu.classList.add('hidden');
            typePaiementToggle.classList.remove('active');
            
            log('[OK] Type de paiement s√©lectionn√©:', value);
          }
        }
        
        // V√©rifier si le clic est dans le menu Pay√© par
        else if (e.target.closest('#payeParMenu')) {
          log('üëÜ Clic d√©tect√© sur payeParMenu');
          log('[TARGET] Target:', e.target);
          const option = e.target.closest('.custom-select-option');
          log('[BAN] Option trouv√©e:', option);
          if (option) {
            const value = option.dataset.value;
            const text = option.textContent;
            const payeParToggle = document.getElementById('payeParToggle');
            const payeParMenu = document.getElementById('payeParMenu');
            
            payeParToggle.innerHTML = `<span style="color: var(--text-light);">${text}</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>`;
            payeParMenu.classList.add('hidden');
            payeParToggle.classList.remove('active');
            
            // Afficher les champs conditionnels selon la s√©lection
            const elementsAjouter = document.getElementById('elementsAjouter');
            const virementFields = document.getElementById('virementFields');
            const chequeFields = document.getElementById('chequeFields');
            
            if (value === 'virement') {
              elementsAjouter.style.maxHeight = '220px';
              virementFields.style.display = 'grid';
              chequeFields.style.display = 'none';
            } else if (value === 'cheque') {
              elementsAjouter.style.maxHeight = '400px';
              virementFields.style.display = 'none';
              chequeFields.style.display = 'grid';
            }
            
            log('[OK] Pay√© par s√©lectionn√©:', value);
          }
        }
      });
      
      // Fermer le menu en cliquant √† l'ext√©rieur
      document.addEventListener('click', (e) => {
        if (!toggle.contains(e.target) && !menu.contains(e.target)) {
          menu.classList.add('hidden');
          toggle.classList.remove('active');
        }
      });
    }

    // Fonction setupSingleSelect de newsoumissiondark pour les dropdowns
    function setupSingleSelect(toggleId, menuId, placeholder) {
      const toggle = document.getElementById(toggleId);
      const menu = document.getElementById(menuId);
      const options = menu.querySelectorAll('.dropdown-option');
      let selectedValue = null;

      toggle.addEventListener('click', () => {
        document.querySelectorAll('.dropdown-menu').forEach(m => {
          if (m !== menu) m.classList.add('hidden');
        });
        document.querySelectorAll('.dropdown-toggle').forEach(t => {
          if (t !== toggle) t.classList.remove('active');
        });
        menu.classList.toggle('hidden');
        toggle.classList.toggle('active', !menu.classList.contains('hidden'));
      });

      options.forEach(option => {
        option.addEventListener('click', () => {
          const value = option.dataset.value;
          if (selectedValue === value) {
            selectedValue = null;
            toggle.innerHTML = `<span class="placeholder" style="color: var(--text-gray);">${placeholder}</span>`;
          } else {
            selectedValue = value;
            toggle.innerHTML = `<span class="tag">${value}</span>`;
          }
          
          // Fermer le menu apr√®s s√©lection
          menu.classList.add('hidden');
          toggle.classList.remove('active');
        });
      });
    }

    // Gestionnaire global pour fermer les dropdowns en cliquant √† l'ext√©rieur
    document.addEventListener('click', e => {
      if (!e.target.closest('.dropdown-toggle') && !e.target.closest('.dropdown-menu') &&
          !e.target.closest('.modern-dropdown') && !e.target.closest('.modern-dropdown-menu')) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.add('hidden'));
        document.querySelectorAll('.dropdown-toggle').forEach(toggle => toggle.classList.remove('active'));
        document.querySelectorAll('.modern-dropdown-menu').forEach(menu => menu.classList.add('hidden'));
        document.querySelectorAll('.modern-dropdown').forEach(toggle => toggle.classList.remove('active'));
        
      }
    });

    // La fonction showPaiementSection est maintenant d√©finie globalement dans le head

    // Fonction pour adapter les boutons de paiement selon le type d'autres paiements
    function adapterBoutonsPaiement(typeAutresPaiements) {
      const btnDepot = document.getElementById('btn-depot');
      const btnPaiementFinal = document.getElementById('btn-paiement-final');
      const btnAutresPaiements = document.getElementById('btn-autres-paiements');

      if (!btnDepot || !btnPaiementFinal || !btnAutresPaiements) return;

      log('üîÑ Adaptation des boutons selon type:', typeAutresPaiements);

      if (typeAutresPaiements === 'un_seul_paiement') {
        // Cacher le bouton D√©p√¥t (car "Un seul paiement" remplace le d√©p√¥t)
        btnDepot.style.setProperty('display', 'none', 'important');

        // Cacher le bouton Paiement Final
        btnPaiementFinal.style.setProperty('display', 'none', 'important');

        // Garder le bouton "Autres paiements" √† droite dans son style d'origine
        btnAutresPaiements.innerHTML = '<i class="fas fa-exchange-alt mr-1 text-xs"></i> Autres paiements';
        btnAutresPaiements.classList.remove('px-6', 'py-3', 'text-base', 'font-semibold');
        btnAutresPaiements.classList.add('btn-secondary', 'px-4', 'py-2', 'text-sm');

        log('[OK] Mode "Un seul paiement" : D√©p√¥t et Paiement final cach√©s');
      } else if (typeAutresPaiements === 'paiement_partiel') {
        // R√©initialiser le bouton d√©p√¥t
        btnDepot.innerHTML = '<i class="fas fa-piggy-bank mr-2"></i>D√©p√¥t';
        btnDepot.onclick = () => showPaiementSection('depot');
        btnDepot.style.removeProperty('display');

        // Afficher le bouton paiement final
        btnPaiementFinal.style.removeProperty('display');

        // GARDER le bouton "Autres paiements" tel quel (ne pas le changer)
        btnAutresPaiements.innerHTML = '<i class="fas fa-exchange-alt mr-1 text-xs"></i> Autres paiements';

        // Garder le style compact avec btn-secondary
        btnAutresPaiements.classList.remove('px-6', 'py-3', 'text-base', 'font-semibold');
        btnAutresPaiements.classList.add('btn-secondary', 'px-4', 'py-2', 'text-sm');

        log('[OK] Mode "Paiement partiel" : Tous les boutons affich√©s, Autres paiements reste inchang√©');
      } else {
        // Mode par d√©faut: r√©initialiser tous les boutons
        btnDepot.innerHTML = '<i class="fas fa-piggy-bank mr-2"></i>D√©p√¥t';
        btnDepot.onclick = () => showPaiementSection('depot');
        btnDepot.style.removeProperty('display');

        btnPaiementFinal.style.removeProperty('display');

        // Reset label
        btnAutresPaiements.innerHTML = '<i class="fas fa-exchange-alt mr-1 text-xs"></i> Autres paiements';

        // Garder le style compact avec btn-secondary
        btnAutresPaiements.classList.remove('px-6', 'py-3', 'text-base', 'font-semibold');
        btnAutresPaiements.classList.add('btn-secondary', 'px-4', 'py-2', 'text-sm');
      }
    }

    // Fonction pour initialiser les menus d√©roulants de paiement
    function initPaiementSelects() {
      console.log('[INIT DROPDOWNS] D√©but initialisation des dropdowns de paiement');
      console.log('[INIT DROPDOWNS] userRole:', localStorage.getItem('userRole'));
      console.log('[INIT DROPDOWNS] username:', window.username);
      console.log('[INIT DROPDOWNS] selectedEntrepreneur:', window.selectedEntrepreneur);

      // Initialiser le menu Type de paiement autres
      const typePaiementAutresToggle = document.getElementById('typePaiementAutresToggle');
      const typePaiementAutresMenu = document.getElementById('typePaiementAutresMenu');

      console.log('[INIT DROPDOWNS] typePaiementAutresToggle existe?', !!typePaiementAutresToggle);
      console.log('[INIT DROPDOWNS] typePaiementAutresToggle.dataset.initialized:', typePaiementAutresToggle?.dataset.initialized);

      if (typePaiementAutresToggle && typePaiementAutresMenu) {
        // V√©rifier si d√©j√† initialis√© pour √©viter les event listeners multiples
        if (typePaiementAutresToggle.dataset.initialized !== 'true') {
          typePaiementAutresToggle.dataset.initialized = 'true';
          console.log('[INIT DROPDOWNS] ‚úÖ Initialisation typePaiementAutresToggle');

          typePaiementAutresToggle.addEventListener('click', () => {
            console.log('[DROPDOWN CLICK] typePaiementAutresToggle cliqu√©!');
          // Fermer les autres dropdowns
          document.querySelectorAll('.modern-dropdown-menu').forEach(m => {
            if (m !== typePaiementAutresMenu) m.classList.add('hidden');
          });
          document.querySelectorAll('.modern-dropdown').forEach(t => {
            if (t !== typePaiementAutresToggle) t.classList.remove('active');
          });

          typePaiementAutresMenu.classList.toggle('hidden');
          typePaiementAutresToggle.classList.toggle('active', !typePaiementAutresMenu.classList.contains('hidden'));
        });
        
        typePaiementAutresMenu.addEventListener('click', (e) => {
          const option = e.target.closest('.custom-select-option');
          if (option) {
            const value = option.dataset.value;
            const text = option.textContent;

            typePaiementAutresToggle.innerHTML = `<span style="color: var(--text-light);">${text}</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>`;
            typePaiementAutresMenu.classList.add('hidden');
            typePaiementAutresToggle.classList.remove('active');

            log('[OK] Type de paiement autres s√©lectionn√©:', value);

            // G√©rer le champ montant selon le type
            const paiementAutresInput = document.getElementById('paiementAutres');
            const totalTravauxInput = document.getElementById('totalTravauxClient');

            if (value === 'un_seul_paiement') {
              // Un seul paiement: calculer total + taxes et rendre non modifiable
              if (totalTravauxInput && totalTravauxInput.value) {
                const totalTravaux = cleanAndParseAmount(totalTravauxInput.value);
                const totalAvecTaxes = calculerTotalAvecTaxes(totalTravaux);
                paiementAutresInput.value = formatMontant(totalAvecTaxes);
                paiementAutresInput.readOnly = true;
                paiementAutresInput.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
                paiementAutresInput.style.setProperty('color', 'var(--text-light)', 'important');
                paiementAutresInput.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
                paiementAutresInput.style.setProperty('cursor', 'not-allowed', 'important');
                paiementAutresInput.style.setProperty('opacity', '0.7', 'important');
                paiementAutresInput.style.pointerEvents = 'none';
                log('[MONEY] Un seul paiement: montant auto-calcul√©:', totalAvecTaxes);
              }
            } else if (value === 'paiement_partiel') {
              // Paiement partiel: rendre modifiable
              paiementAutresInput.value = '';
              paiementAutresInput.readOnly = false;
              paiementAutresInput.style.removeProperty('background');
              paiementAutresInput.style.removeProperty('color');
              paiementAutresInput.style.removeProperty('border-color');
              paiementAutresInput.style.removeProperty('cursor');
              paiementAutresInput.style.removeProperty('opacity');
              paiementAutresInput.style.pointerEvents = 'auto';
              log('[MONEY] Paiement partiel: montant modifiable');
            }

            // Adapter les boutons de paiement selon le type
            adapterBoutonsPaiement(value);
          }
        });
        
        // Fermer le menu en cliquant √† l'ext√©rieur
        document.addEventListener('click', (e) => {
          if (!typePaiementAutresToggle.contains(e.target) && !typePaiementAutresMenu.contains(e.target)) {
            typePaiementAutresMenu.classList.add('hidden');
            typePaiementAutresToggle.classList.remove('active');
          }
        });
        }
      }

      // Le menu Type de paiement n'existe plus - supprim√© car les sections sont maintenant s√©par√©es

      // Initialiser le menu Pay√© par
      const payeParToggle = document.getElementById('payeParToggle');
      const payeParMenu = document.getElementById('payeParMenu');

      console.log('[INIT DROPDOWNS] payeParToggle existe?', !!payeParToggle);
      console.log('[INIT DROPDOWNS] payeParToggle.dataset.initialized:', payeParToggle?.dataset.initialized);
      console.log('[INIT DROPDOWNS] payeParToggle element:', payeParToggle);

      if (payeParToggle && payeParMenu) {
        // V√©rifier si d√©j√† initialis√© pour √©viter les event listeners multiples
        if (payeParToggle.dataset.initialized !== 'true') {
          payeParToggle.dataset.initialized = 'true';
          console.log('[INIT DROPDOWNS] ‚úÖ Initialisation payeParToggle');

          payeParToggle.addEventListener('click', (e) => {
            console.log('[DROPDOWN CLICK] payeParToggle cliqu√©!');
            console.log('[DROPDOWN CLICK] Event:', e);
            console.log('[DROPDOWN CLICK] payeParMenu avant toggle:', payeParMenu);
            console.log('[DROPDOWN CLICK] payeParMenu.classList avant:', payeParMenu.classList.toString());
            console.log('[DROPDOWN CLICK] payeParMenu has hidden?', payeParMenu.classList.contains('hidden'));

        // Fermer les autres dropdowns
        document.querySelectorAll('.modern-dropdown-menu').forEach(m => {
          if (m !== payeParMenu) m.classList.add('hidden');
        });
        document.querySelectorAll('.modern-dropdown').forEach(t => {
          if (t !== payeParToggle) t.classList.remove('active');
        });
        document.querySelectorAll('.dropdown-menu').forEach(m => {
          m.classList.add('hidden');
        });
        document.querySelectorAll('.dropdown-toggle').forEach(t => {
          t.classList.remove('active');
        });

        payeParMenu.classList.toggle('hidden');
        payeParToggle.classList.toggle('active', !payeParMenu.classList.contains('hidden'));

            console.log('[DROPDOWN CLICK] payeParMenu.classList apr√®s:', payeParMenu.classList.toString());
            console.log('[DROPDOWN CLICK] payeParMenu has hidden apr√®s?', payeParMenu.classList.contains('hidden'));
        
      });
      
      payeParMenu.addEventListener('click', (e) => {
        log('üëÜ Clic sur payeParMenu d√©tect√©');
        log('[TARGET] Target:', e.target);
        const option = e.target.closest('.custom-select-option');
        log('[BAN] Option trouv√©e:', option);
        if (option) {
          const value = option.dataset.value;
          const text = option.textContent;
          
          payeParToggle.innerHTML = `<span style="color: var(--text-light);">${text}</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>`;
          payeParMenu.classList.add('hidden');
          payeParToggle.classList.remove('active');
          
          
          // Afficher les champs conditionnels selon la s√©lection - section D√âP√îT
          // SEULEMENT si le d√©p√¥t est en traitement ou trait√©
          const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
          const statutDepot = clientData.statutDepot || 'non_envoye';
          
          const elementsAjouterDepot = document.getElementById('elementsAjouterDepot');
          const virementFieldsDepot = document.getElementById('virementFieldsDepot');
          const chequeFieldsDepot = document.getElementById('chequeFieldsDepot');
          
          // Ouvrir pour TOUS les statuts (non_envoye, traitement, traite) - avec !important pour override
          if (value === 'virement') {
            elementsAjouterDepot.style.setProperty('max-height', '1000px', 'important');
            elementsAjouterDepot.style.setProperty('opacity', '1', 'important');
            elementsAjouterDepot.style.setProperty('display', 'block', 'important');
            elementsAjouterDepot.style.setProperty('visibility', 'visible', 'important');
            elementsAjouterDepot.style.setProperty('overflow', 'visible', 'important');
            elementsAjouterDepot.style.setProperty('height', 'auto', 'important');
            virementFieldsDepot.classList.remove('hidden');
            chequeFieldsDepot.classList.add('hidden');
            log('[OK] √âl√©ments √† ajouter D√âP√îT - virement s√©lectionn√© avec !important (statut:', statutDepot + ')');
          } else if (value === 'cheque') {
            elementsAjouterDepot.style.setProperty('max-height', '1000px', 'important');
            elementsAjouterDepot.style.setProperty('opacity', '1', 'important');
            elementsAjouterDepot.style.setProperty('display', 'block', 'important');
            elementsAjouterDepot.style.setProperty('visibility', 'visible', 'important');
            elementsAjouterDepot.style.setProperty('overflow', 'visible', 'important');
            elementsAjouterDepot.style.setProperty('height', 'auto', 'important');
            chequeFieldsDepot.classList.remove('hidden');
            virementFieldsDepot.classList.add('hidden');
            log('[OK] √âl√©ments √† ajouter D√âP√îT - ch√®que s√©lectionn√© avec !important (statut:', statutDepot + ')');
          } else {
            elementsAjouterDepot.style.setProperty('max-height', '0', 'important');
            elementsAjouterDepot.style.setProperty('opacity', '0', 'important');
            elementsAjouterDepot.style.setProperty('display', 'none', 'important');
            virementFieldsDepot.classList.add('hidden');
            chequeFieldsDepot.classList.add('hidden');
            log('[LOCK] √âl√©ments √† ajouter D√âP√îT ferm√© avec !important (statut:', statutDepot + ')');
          }
          
          log('M√©thode de paiement s√©lectionn√©e:', value);
        }
      });
        }
      }

      // Initialiser le menu Pay√© par Final
      const payeParFinalToggle = document.getElementById('payeParFinalToggle');
      const payeParFinalMenu = document.getElementById('payeParFinalMenu');

      if (payeParFinalToggle && payeParFinalMenu) {
        // V√©rifier si d√©j√† initialis√© pour √©viter les event listeners multiples
        if (payeParFinalToggle.dataset.initialized !== 'true') {
          payeParFinalToggle.dataset.initialized = 'true';

          payeParFinalToggle.addEventListener('click', () => {
          // Fermer les autres dropdowns
          document.querySelectorAll('.modern-dropdown-menu').forEach(m => {
            if (m !== payeParFinalMenu) m.classList.add('hidden');
          });
          document.querySelectorAll('.modern-dropdown').forEach(t => {
            if (t !== payeParFinalToggle) t.classList.remove('active');
          });
          
          payeParFinalMenu.classList.toggle('hidden');
          payeParFinalToggle.classList.toggle('active', !payeParFinalMenu.classList.contains('hidden'));
        });
        
        payeParFinalMenu.addEventListener('click', (e) => {
          const option = e.target.closest('.custom-select-option');
          if (option) {
            const value = option.dataset.value;
            const text = option.textContent;
            
            payeParFinalToggle.innerHTML = `<span style="color: var(--text-light);">${text}</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>`;
            payeParFinalMenu.classList.add('hidden');
            payeParFinalToggle.classList.remove('active');
            
            // Paiement final : Ouvrir NOUVEAUX √©l√©ments √† ajouter (champs vides)
            const elementsAjouterPaiementFinal = document.getElementById('elementsAjouterPaiementFinal');
            const virementFieldsPaiementFinal = document.getElementById('virementFieldsPaiementFinal');
            const chequeFieldsPaiementFinal = document.getElementById('chequeFieldsPaiementFinal');
            
            if (value === 'virement') {
              elementsAjouterPaiementFinal.style.maxHeight = '500px';
              elementsAjouterPaiementFinal.style.opacity = '1';
              virementFieldsPaiementFinal.classList.remove('hidden');
              chequeFieldsPaiementFinal.classList.add('hidden');
              log('[OK] Nouveaux √©l√©ments √† ajouter PAIEMENT FINAL - virement (champs vides)');
            } else if (value === 'cheque') {
              elementsAjouterPaiementFinal.style.maxHeight = '500px';
              elementsAjouterPaiementFinal.style.opacity = '1';
              chequeFieldsPaiementFinal.classList.remove('hidden');
              virementFieldsPaiementFinal.classList.add('hidden');
              log('[OK] Nouveaux √©l√©ments √† ajouter PAIEMENT FINAL - ch√®que (champs vides)');
            } else {
              elementsAjouterPaiementFinal.style.maxHeight = '0';
              elementsAjouterPaiementFinal.style.opacity = '0';
              virementFieldsPaiementFinal.classList.add('hidden');
              chequeFieldsPaiementFinal.classList.add('hidden');
              log('[LOCK] √âl√©ments √† ajouter PAIEMENT FINAL ferm√©s');
            }
            
            log('M√©thode de paiement final s√©lectionn√©e:', value);
          }
        });
        }
      }

      // Initialiser le menu Pay√© par Autres
      const payeParAutresToggle = document.getElementById('payeParAutresToggle');
      const payeParAutresMenu = document.getElementById('payeParAutresMenu');

      if (payeParAutresToggle && payeParAutresMenu) {
        // V√©rifier si d√©j√† initialis√© pour √©viter les event listeners multiples
        if (payeParAutresToggle.dataset.initialized !== 'true') {
          payeParAutresToggle.dataset.initialized = 'true';

          payeParAutresToggle.addEventListener('click', () => {
          // Fermer les autres dropdowns
          document.querySelectorAll('.modern-dropdown-menu').forEach(m => {
            if (m !== payeParAutresMenu) m.classList.add('hidden');
          });
          document.querySelectorAll('.modern-dropdown').forEach(t => {
            if (t !== payeParAutresToggle) t.classList.remove('active');
          });
          
          payeParAutresMenu.classList.toggle('hidden');
          payeParAutresToggle.classList.toggle('active', !payeParAutresMenu.classList.contains('hidden'));
        });
        
        payeParAutresMenu.addEventListener('click', (e) => {
          const option = e.target.closest('.custom-select-option');
          if (option) {
            const value = option.dataset.value;
            const text = option.textContent;
            
            payeParAutresToggle.innerHTML = `<span style="color: var(--text-light);">${text}</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>`;
            payeParAutresMenu.classList.add('hidden');
            payeParAutresToggle.classList.remove('active');
            
            // Autres paiements : Ouvrir √©l√©ments √† ajouter selon la s√©lection
            const elementsAjouterAutres = document.getElementById('elementsAjouterAutres');
            const virementFieldsAutres = document.getElementById('virementFieldsAutres');
            const chequeFieldsAutres = document.getElementById('chequeFieldsAutres');
            
            if (value === 'virement') {
              elementsAjouterAutres.style.maxHeight = '500px';
              elementsAjouterAutres.style.opacity = '1';
              virementFieldsAutres.classList.remove('hidden');
              chequeFieldsAutres.classList.add('hidden');
              log('[OK] √âl√©ments √† ajouter AUTRES PAIEMENTS - virement');
            } else if (value === 'cheque') {
              elementsAjouterAutres.style.maxHeight = '500px';
              elementsAjouterAutres.style.opacity = '1';
              chequeFieldsAutres.classList.remove('hidden');
              virementFieldsAutres.classList.add('hidden');
              log('[OK] √âl√©ments √† ajouter AUTRES PAIEMENTS - ch√®que');
            } else {
              elementsAjouterAutres.style.maxHeight = '0';
              elementsAjouterAutres.style.opacity = '0';
              virementFieldsAutres.classList.add('hidden');
              chequeFieldsAutres.classList.add('hidden');
              log('[LOCK] √âl√©ments √† ajouter AUTRES PAIEMENTS ferm√©s');
            }
            
            log('M√©thode de paiement autres s√©lectionn√©e:', value);
          }
        });
        }
      }

      // Initialiser le menu Pay√© par Remboursement
      const payeParRemboursementToggle = document.getElementById('payeParRemboursementToggle');
      const payeParRemboursementMenu = document.getElementById('payeParRemboursementMenu');

      if (payeParRemboursementToggle && payeParRemboursementMenu) {
        // V√©rifier si d√©j√† initialis√© pour √©viter les event listeners multiples
        if (payeParRemboursementToggle.dataset.initialized !== 'true') {
          payeParRemboursementToggle.dataset.initialized = 'true';

          payeParRemboursementToggle.addEventListener('click', () => {
          // Fermer les autres dropdowns
          document.querySelectorAll('.modern-dropdown-menu').forEach(m => {
            if (m !== payeParRemboursementMenu) m.classList.add('hidden');
          });
          document.querySelectorAll('.modern-dropdown').forEach(t => {
            if (t !== payeParRemboursementToggle) t.classList.remove('active');
          });
          
          payeParRemboursementMenu.classList.toggle('hidden');
          payeParRemboursementToggle.classList.toggle('active', !payeParRemboursementMenu.classList.contains('hidden'));
        });
        
        payeParRemboursementMenu.addEventListener('click', (e) => {
          const option = e.target.closest('.custom-select-option');
          if (option) {
            const value = option.dataset.value;
            const text = option.textContent;
            
            payeParRemboursementToggle.innerHTML = `<span style="color: var(--text-light);">${text}</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>`;
            payeParRemboursementMenu.classList.add('hidden');
            payeParRemboursementToggle.classList.remove('active');
            
            // Afficher les champs conditionnels selon la s√©lection
            const elementsAjouter = document.getElementById('elementsAjouter');
            const virementFields = document.getElementById('virementFields');
            const chequeFields = document.getElementById('chequeFields');
            
            if (value === 'virement') {
              elementsAjouter.style.maxHeight = '500px';
              elementsAjouter.style.opacity = '1';
              virementFields.classList.remove('hidden');
              chequeFields.classList.add('hidden');
            } else if (value === 'cheque') {
              elementsAjouter.style.maxHeight = '500px';
              elementsAjouter.style.opacity = '1';
              chequeFields.classList.remove('hidden');
              virementFields.classList.add('hidden');
            } else {
              elementsAjouter.style.maxHeight = '0';
              elementsAjouter.style.opacity = '0';
              virementFields.classList.add('hidden');
              chequeFields.classList.add('hidden');
            }
            
            log('M√©thode de paiement remboursement s√©lectionn√©e:', value);
          }
        });
        }
      }

      // Fermer tous les menus en cliquant √† l'ext√©rieur
      document.addEventListener('click', (e) => {
        // Pay√© par (section d√©p√¥t)
        if (payeParToggle && payeParMenu && !payeParToggle.contains(e.target) && !payeParMenu.contains(e.target)) {
          payeParMenu.classList.add('hidden');
          payeParToggle.classList.remove('active');
        }
        
        // Pay√© par Final
        if (payeParFinalToggle && payeParFinalMenu && !payeParFinalToggle.contains(e.target) && !payeParFinalMenu.contains(e.target)) {
          payeParFinalMenu.classList.add('hidden');
          payeParFinalToggle.classList.remove('active');
        }
        
        // Pay√© par Autres
        if (payeParAutresToggle && payeParAutresMenu && !payeParAutresToggle.contains(e.target) && !payeParAutresMenu.contains(e.target)) {
          payeParAutresMenu.classList.add('hidden');
          payeParAutresToggle.classList.remove('active');
        }
      });
    }

    // Fonction pour g√©rer les dropzones des ch√®ques
    function initChequeDropzones() {
      // Dropzone Recto
      const dropzoneRecto = document.getElementById('dropzoneRecto');
      const fileInputRecto = document.getElementById('photoFileRecto');
      const previewRecto = document.getElementById('previewRecto');

      dropzoneRecto.addEventListener('click', () => fileInputRecto.click());
      dropzoneRecto.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzoneRecto.classList.add('bg-gray-200');
      });
      dropzoneRecto.addEventListener('dragleave', () => dropzoneRecto.classList.remove('bg-gray-200'));
      dropzoneRecto.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzoneRecto.classList.remove('bg-gray-200');
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
          fileInputRecto.files = e.dataTransfer.files;
          updatePreview(files[0], previewRecto);
        }
      });

      fileInputRecto.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          updatePreview(e.target.files[0], previewRecto);
        }
      });

      // Dropzone Verso
      const dropzoneVerso = document.getElementById('dropzoneVerso');
      const fileInputVerso = document.getElementById('photoFileVerso');
      const previewVerso = document.getElementById('previewVerso');

      dropzoneVerso.addEventListener('click', () => fileInputVerso.click());
      dropzoneVerso.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzoneVerso.classList.add('bg-gray-200');
      });
      dropzoneVerso.addEventListener('dragleave', () => dropzoneVerso.classList.remove('bg-gray-200'));
      dropzoneVerso.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzoneVerso.classList.remove('bg-gray-200');
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
          fileInputVerso.files = e.dataTransfer.files;
          updatePreview(files[0], previewVerso);
        }
      });

      fileInputVerso.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          updatePreview(e.target.files[0], previewVerso);
        }
      });

      // Dropzone Recto Paiement Final
      const dropzoneRectoFinal = document.getElementById('dropzoneRectoFinal');
      const fileInputRectoFinal = document.getElementById('photoFileRectoFinal');
      const previewRectoFinal = document.getElementById('previewRectoFinal');

      if (dropzoneRectoFinal && fileInputRectoFinal && previewRectoFinal) {
        dropzoneRectoFinal.addEventListener('click', () => fileInputRectoFinal.click());
        dropzoneRectoFinal.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropzoneRectoFinal.classList.add('bg-gray-200');
        });
        dropzoneRectoFinal.addEventListener('dragleave', () => dropzoneRectoFinal.classList.remove('bg-gray-200'));
        dropzoneRectoFinal.addEventListener('drop', (e) => {
          e.preventDefault();
          dropzoneRectoFinal.classList.remove('bg-gray-200');
          const files = Array.from(e.dataTransfer.files);
          if (files.length > 0) {
            fileInputRectoFinal.files = e.dataTransfer.files;
            updatePreview(files[0], previewRectoFinal);
          }
        });

        fileInputRectoFinal.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            updatePreview(e.target.files[0], previewRectoFinal);
          }
        });
      }

      // Dropzone Verso Paiement Final
      const dropzoneVersoFinal = document.getElementById('dropzoneVersoFinal');
      const fileInputVersoFinal = document.getElementById('photoFileVersoFinal');
      const previewVersoFinal = document.getElementById('previewVersoFinal');

      if (dropzoneVersoFinal && fileInputVersoFinal && previewVersoFinal) {
        dropzoneVersoFinal.addEventListener('click', () => fileInputVersoFinal.click());
        dropzoneVersoFinal.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropzoneVersoFinal.classList.add('bg-gray-200');
        });
        dropzoneVersoFinal.addEventListener('dragleave', () => dropzoneVersoFinal.classList.remove('bg-gray-200'));
        dropzoneVersoFinal.addEventListener('drop', (e) => {
          e.preventDefault();
          dropzoneVersoFinal.classList.remove('bg-gray-200');
          const files = Array.from(e.dataTransfer.files);
          if (files.length > 0) {
            fileInputVersoFinal.files = e.dataTransfer.files;
            updatePreview(files[0], previewVersoFinal);
          }
        });

        fileInputVersoFinal.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            updatePreview(e.target.files[0], previewVersoFinal);
          }
        });
      }

      // Dropzone Recto Autres Paiements
      const dropzoneRectoAutres = document.getElementById('dropzoneRectoAutres');
      const fileInputRectoAutres = document.getElementById('photoFileRectoAutres');
      const previewRectoAutres = document.getElementById('previewRectoAutres');

      if (dropzoneRectoAutres && fileInputRectoAutres && previewRectoAutres) {
        dropzoneRectoAutres.addEventListener('click', () => fileInputRectoAutres.click());
        dropzoneRectoAutres.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropzoneRectoAutres.classList.add('bg-gray-200');
        });
        dropzoneRectoAutres.addEventListener('dragleave', () => dropzoneRectoAutres.classList.remove('bg-gray-200'));
        dropzoneRectoAutres.addEventListener('drop', (e) => {
          e.preventDefault();
          dropzoneRectoAutres.classList.remove('bg-gray-200');
          const files = Array.from(e.dataTransfer.files);
          if (files.length > 0) {
            fileInputRectoAutres.files = e.dataTransfer.files;
            updatePreview(files[0], previewRectoAutres);
          }
        });

        fileInputRectoAutres.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            updatePreview(e.target.files[0], previewRectoAutres);
          }
        });
      }

      // Dropzone Verso Autres Paiements
      const dropzoneVersoAutres = document.getElementById('dropzoneVersoAutres');
      const fileInputVersoAutres = document.getElementById('photoFileVersoAutres');
      const previewVersoAutres = document.getElementById('previewVersoAutres');

      if (dropzoneVersoAutres && fileInputVersoAutres && previewVersoAutres) {
        dropzoneVersoAutres.addEventListener('click', () => fileInputVersoAutres.click());
        dropzoneVersoAutres.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropzoneVersoAutres.classList.add('bg-gray-200');
        });
        dropzoneVersoAutres.addEventListener('dragleave', () => dropzoneVersoAutres.classList.remove('bg-gray-200'));
        dropzoneVersoAutres.addEventListener('drop', (e) => {
          e.preventDefault();
          dropzoneVersoAutres.classList.remove('bg-gray-200');
          const files = Array.from(e.dataTransfer.files);
          if (files.length > 0) {
            fileInputVersoAutres.files = e.dataTransfer.files;
            updatePreview(files[0], previewVersoAutres);
          }
        });

        fileInputVersoAutres.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            updatePreview(e.target.files[0], previewVersoAutres);
          }
        });
      }
    }

    // Fonction pour g√©rer les dropzones des ch√®ques dans le modal
    function initModalChequeDropzones() {
      // Attendre que les √©l√©ments soient dans le DOM
      setTimeout(() => {
        // Dropzone Recto Modal
        const dropzoneRecto = document.getElementById('modalDropzoneRecto');
        const fileInputRecto = document.getElementById('modalPhotoFileRecto');
        const previewRecto = document.getElementById('modalPreviewRecto');

        if (dropzoneRecto && fileInputRecto && previewRecto) {
          dropzoneRecto.addEventListener('click', () => fileInputRecto.click());
          dropzoneRecto.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzoneRecto.classList.add('bg-gray-200');
          });
          dropzoneRecto.addEventListener('dragleave', () => dropzoneRecto.classList.remove('bg-gray-200'));
          dropzoneRecto.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzoneRecto.classList.remove('bg-gray-200');
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
              fileInputRecto.files = e.dataTransfer.files;
              updatePreview(files[0], previewRecto);
            }
          });

          fileInputRecto.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
              updatePreview(e.target.files[0], previewRecto);
            }
          });
        }

        // Dropzone Verso Modal
        const dropzoneVerso = document.getElementById('modalDropzoneVerso');
        const fileInputVerso = document.getElementById('modalPhotoFileVerso');
        const previewVerso = document.getElementById('modalPreviewVerso');

        if (dropzoneVerso && fileInputVerso && previewVerso) {
          dropzoneVerso.addEventListener('click', () => fileInputVerso.click());
          dropzoneVerso.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzoneVerso.classList.add('bg-gray-200');
          });
          dropzoneVerso.addEventListener('dragleave', () => dropzoneVerso.classList.remove('bg-gray-200'));
          dropzoneVerso.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzoneVerso.classList.remove('bg-gray-200');
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
              fileInputVerso.files = e.dataTransfer.files;
              updatePreview(files[0], previewVerso);
            }
          });

          fileInputVerso.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
              updatePreview(e.target.files[0], previewVerso);
            }
          });
        }
      }, 100);
    }

    // Fonction pour mettre √† jour l'aper√ßu de l'image
    function updatePreview(file, previewElement) {
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewElement.innerHTML = `<img src="${e.target.result}" class="w-16 h-16 object-cover rounded border">`;
        };
        reader.readAsDataURL(file);
      }
    }

    // Calendrier personnalis√©
    class CustomCalendar {
      constructor(inputId, calendarId) {
        this.inputElement = document.getElementById(inputId);
        this.calendarElement = document.getElementById(calendarId);
        
        // V√©rifier que les √©l√©ments existent
        if (!this.inputElement || !this.calendarElement) {
          warn(`CustomCalendar: √âl√©ments manquants - input: ${inputId}, calendar: ${calendarId}`);
          return;
        }
        
        this.currentDate = new Date();
        this.selectedDate = null;
        
        this.monthNames = [
          'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
          'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
        ];
        
        this.dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
        
        // Pas de date par d√©faut
        this.inputElement.value = '';
        
        this.inputElement.addEventListener('click', () => this.toggleCalendar());
        
        // Fermer le calendrier si on clique ailleurs
        document.addEventListener('click', (e) => {
          if (!this.inputElement.contains(e.target) && !this.calendarElement.contains(e.target)) {
            this.hideCalendar();
          }
        });
      }
      
      formatDate(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      }
      
      parseDate(dateString) {
        const parts = dateString.split('/');
        if (parts.length === 3) {
          return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
        }
        return new Date();
      }
      
      toggleCalendar() {
        if (this.calendarElement.classList.contains('hidden')) {
          this.showCalendar();
        } else {
          this.hideCalendar();
        }
      }
      
      showCalendar() {
        this.calendarElement.classList.remove('hidden');
        this.renderCalendar();
      }
      
      hideCalendar() {
        this.calendarElement.classList.add('hidden');
      }
      
      renderCalendar() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        
        this.calendarElement.innerHTML = `
          <div class="calendar-header">
            <button type="button" class="calendar-nav-btn">‚Äπ</button>
            <div class="calendar-month-year">${this.monthNames[month]} ${year}</div>
            <button type="button" class="calendar-nav-btn">‚Ä∫</button>
          </div>
          <div class="calendar-grid">
            ${this.renderDayHeaders()}
            ${this.renderDays()}
          </div>
        `;
        
        this.calendarElement.calendar = this;
        
        // Ajouter les event listeners pour les boutons de navigation
        const prevBtn = this.calendarElement.querySelector('.calendar-nav-btn:first-child');
        const nextBtn = this.calendarElement.querySelector('.calendar-nav-btn:last-child');
        
        prevBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.previousMonth();
        });
        
        nextBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.nextMonth();
        });
      }
      
      renderDayHeaders() {
        return this.dayNames.map(day => 
          `<div class="calendar-day-header">${day}</div>`
        ).join('');
      }
      
      renderDays() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = firstDay.getDay();
        
        let daysHTML = '';
        
        // Jours du mois pr√©c√©dent
        const prevMonth = new Date(year, month, 0);
        for (let i = startingDay - 1; i >= 0; i--) {
          const day = prevMonth.getDate() - i;
          daysHTML += `<div class="calendar-day other-month">${day}</div>`;
        }
        
        // Jours du mois actuel
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          let classes = 'calendar-day';
          
          if (this.selectedDate && this.isSameDay(date, this.selectedDate)) {
            classes += ' selected';
          } else if (this.isSameDay(date, today)) {
            classes += ' today';
          }
          
          daysHTML += `<div class="${classes}" onclick="this.closest('.custom-calendar').calendar.selectDate(${year}, ${month}, ${day})">${day}</div>`;
        }
        
        // Jours du mois suivant pour compl√©ter la grille
        const totalCells = Math.ceil((startingDay + daysInMonth) / 7) * 7;
        const remainingCells = totalCells - (startingDay + daysInMonth);
        for (let day = 1; day <= remainingCells; day++) {
          daysHTML += `<div class="calendar-day other-month">${day}</div>`;
        }
        
        return daysHTML;
      }
      
      selectDate(year, month, day) {
        this.selectedDate = new Date(year, month, day);
        this.inputElement.value = this.formatDate(this.selectedDate);
        this.hideCalendar();
        // D√©clencher la validation imm√©diatement apr√®s s√©lection d'une date
        if (typeof validateCurrentSection === 'function') {
          validateCurrentSection();
        }
      }
      
      previousMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
        this.renderCalendar();
      }
      
      nextMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
        this.renderCalendar();
      }
      
      isSameDay(date1, date2) {
        return date1.getDate() === date2.getDate() &&
               date1.getMonth() === date2.getMonth() &&
               date1.getFullYear() === date2.getFullYear();
      }
    }

    // Initialiser les dropzones et calendrier au chargement de la page
    document.addEventListener('DOMContentLoaded', () => {
      initChequeDropzones();
      new CustomCalendar('dateDepot', 'calendar-dateDepot');
      new CustomCalendar('datePaiementFinal', 'calendar-datePaiementFinal');
      new CustomCalendar('datePaiementAutres', 'calendar-datePaiementAutres');
      new CustomCalendar('dateRemboursement', 'calendar-dateRemboursement');
      initEnvoyerComptable();
      initFormattingMontants();
      initTabletPlaceholders();
      initStatusSwipe();
    });

    // Fonction pour changer les placeholders sur tablette
    function initTabletPlaceholders() {
      function updatePlaceholders() {
        const isTablet = window.innerWidth >= 601 && window.innerWidth <= 1200;
        const clientSearchFacturation = document.getElementById('clientSearchFacturation');
        const clientSearchRemboursement = document.getElementById('clientSearchRemboursement');

        if (clientSearchFacturation) {
          clientSearchFacturation.placeholder = isTablet ? 'Rechercher...' : 'Tapez pour rechercher un client...';
        }
        if (clientSearchRemboursement) {
          clientSearchRemboursement.placeholder = isTablet ? 'Rechercher...' : 'Tapez pour rechercher un client...';
        }
      }

      updatePlaceholders();
      window.addEventListener('resize', updatePlaceholders);
    }

    // Fonction pour initialiser le swipe des colonnes status sur tablette
    function initStatusSwipe() {
      const container = document.querySelector('#page2 .status-cards-container');
      const indicators = document.getElementById('statusSwipeIndicators');
      const dots = indicators ? indicators.querySelectorAll('.swipe-dot') : [];
      const columns = document.querySelectorAll('#page2 .status-card-wrapper');

      if (!container || !indicators || columns.length === 0) return;

      // Synchroniser les inputs de recherche tablette avec les inputs PC
      const tabletInputs = document.querySelectorAll('.search-tablet-input');
      tabletInputs.forEach(input => {
        const targetId = input.getAttribute('data-target');
        const targetInput = document.getElementById(targetId);

        if (targetInput) {
          // Sync tablette -> PC
          input.addEventListener('input', (e) => {
            targetInput.value = e.target.value;
            targetInput.dispatchEvent(new Event('input', { bubbles: true }));
          });
        }
      });

      // Mettre √† jour les indicateurs lors du scroll
      container.addEventListener('scroll', () => {
        const scrollLeft = container.scrollLeft;
        const columnWidth = container.offsetWidth;
        const currentIndex = Math.round(scrollLeft / columnWidth);

        dots.forEach((dot, index) => {
          dot.classList.toggle('active', index === currentIndex);
        });
      });

      // Clic sur les indicateurs pour naviguer
      dots.forEach((dot) => {
        dot.addEventListener('click', () => {
          const index = parseInt(dot.getAttribute('data-index'));
          const columnWidth = container.offsetWidth;
          container.scrollTo({
            left: index * columnWidth,
            behavior: 'smooth'
          });
        });
      });
    }

    // Fonction pour initialiser le bouton "Envoy√© au comptable"
    function initEnvoyerComptable() {
      const envoyerBtn = document.getElementById('envoyerComptableBtn');
      
      envoyerBtn.addEventListener('click', async () => {
        // Sauvegarder originalText d√®s le d√©but pour √©viter les erreurs
        const originalText = envoyerBtn.innerHTML;
        
        try {
          log('[LAUNCH] === D√âBUT ENVOI COMPTABLE ===');
          
          // D'abord, d√©tecter quelle section est active pour r√©cup√©rer les bons champs
          const contentDepot = document.getElementById('content-depot');
          const contentPaiementFinal = document.getElementById('content-paiement-final');
          const contentAutres = document.getElementById('content-autres-paiements');
          
          let sectionActive = 'depot'; // par d√©faut
          let paiementEl, dateEl;
          
          if (contentPaiementFinal && !contentPaiementFinal.classList.contains('hidden')) {
            sectionActive = 'paiement-final';
            paiementEl = document.getElementById('paiementFinal');
            dateEl = document.getElementById('datePaiementFinal');
            log('[TARGET] Section PAIEMENT FINAL d√©tect√©e pour collecte des donn√©es');
          } else if (contentAutres && !contentAutres.classList.contains('hidden')) {
            sectionActive = 'autres-paiements';
            paiementEl = document.getElementById('paiementAutres');
            dateEl = document.getElementById('datePaiementAutres');
            log('[TARGET] Section AUTRES PAIEMENTS d√©tect√©e pour collecte des donn√©es');
          } else {
            sectionActive = 'depot';
            paiementEl = document.getElementById('paiement');
            dateEl = document.getElementById('dateDepot');
            log('[TARGET] Section D√âP√îT d√©tect√©e pour collecte des donn√©es');
          }
          
          // R√©cup√©rer les donn√©es du formulaire avec v√©rification
          const clientInfoEl = document.getElementById('clientInfo');
          const totalTravauxEl = document.getElementById('totalTravauxClient');
          
          log('[DEBUG] √âl√©ments DOM trouv√©s pour section', sectionActive + ':', {
            clientInfoEl: !!clientInfoEl,
            paiementEl: !!paiementEl,
            totalTravauxEl: !!totalTravauxEl,
            dateEl: !!dateEl
          });
          
          const clientInfo = clientInfoEl ? clientInfoEl.value : '';
          const paiement = paiementEl ? paiementEl.value : '';
          const totalTravaux = totalTravauxEl ? totalTravauxEl.value : '';
          const dateDepot = dateEl ? dateEl.value : '';
          
          log('[DEBUG] DEBUG - √âl√©ments DOM d√©taill√©s:', {
            clientInfoEl: clientInfoEl,
            paiementEl: paiementEl,
            paiementElValue: paiementEl?.value,
            paiementElVisible: paiementEl ? getComputedStyle(paiementEl).display !== 'none' : false
          });
          
          log('[DATA] Valeurs formulaire:', {
            clientInfo,
            paiement,
            totalTravaux,
            dateDepot
          });
          
          // V√©rifier les champs obligatoires
          if (!clientInfo || !paiement) {
            error('[ERROR] Champs obligatoires manquants:', { clientInfo, paiement });
            alert('Veuillez s√©lectionner un client et saisir le montant du paiement');
            return;
          }
          
          // R√©cup√©rer les dropdowns selon la section active (d√©j√† d√©tect√©e plus haut)
          let typePaiementText = 'D√©p√¥t';
          let payeParText = 'Choisir m√©thode...';
          let typePaiementAutresText = ''; // Pour stocker le type d'autres paiements

          if (sectionActive === 'paiement-final') {
            typePaiementText = 'Paiement final';
            
            // R√©cup√©rer le dropdown sp√©cifique √† paiement final
            const payeParFinalEl = document.getElementById('payeParFinalToggle');
            payeParText = payeParFinalEl ? payeParFinalEl.textContent.trim() : 'Choisir m√©thode...';
            
            log('[FIX] Dropdowns PAIEMENT FINAL:', {
              payeParFinalEl: !!payeParFinalEl,
              payeParText
            });
          } else if (sectionActive === 'autres-paiements') {
            typePaiementText = 'Autres paiements';

            // R√©cup√©rer le dropdown sp√©cifique aux autres paiements
            const payeParAutresEl = document.getElementById('payeParAutresToggle');
            payeParText = payeParAutresEl ? payeParAutresEl.textContent.trim() : 'Choisir m√©thode...';

            // R√©cup√©rer le type de paiement autres (paiement_partiel ou un_seul_paiement)
            const typePaiementAutresEl = document.getElementById('typePaiementAutresToggle');
            typePaiementAutresText = typePaiementAutresEl ? typePaiementAutresEl.textContent.trim() : '';

            log('[FIX] Dropdowns AUTRES PAIEMENTS:', {
              payeParAutresEl: !!payeParAutresEl,
              payeParText,
              typePaiementAutresText
            });
          } else {
            // Section d√©p√¥t (par d√©faut)
            const typePaiementEl = document.getElementById('typePaiementToggle');
            const payeParEl = document.getElementById('payeParToggle');
            
            typePaiementText = typePaiementEl ? typePaiementEl.textContent.trim() : 'D√©p√¥t';
            payeParText = payeParEl ? payeParEl.textContent.trim() : 'Choisir m√©thode...';
            
            log('[FIX] Dropdowns D√âP√îT:', {
              typePaiementEl: !!typePaiementEl,
              payeParEl: !!payeParEl,
              typePaiementText,
              payeParText
            });
          }
          
          log('[TARGET] Section active d√©tect√©e:', sectionActive);
          log('üéõÔ∏è Valeurs dropdowns finales:', {
            typePaiementText,
            payeParText
          });
          
          if (typePaiementText === 'Choisir le type...' || payeParText === 'Choisir m√©thode...') {
            error('[ERROR] Dropdowns pas s√©lectionn√©s:', { typePaiementText, payeParText });
            alert('Veuillez s√©lectionner le type de paiement et la m√©thode');
            return;
          }
          
          // R√©cup√©rer les donn√©es client s√©lectionn√© depuis le sessionStorage
          const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
          log('üë§ Donn√©es client r√©cup√©r√©es:', clientData);
          
          // Mapper le type de paiement vers les valeurs attendues par le backend
          let typePaiementBackend = 'depot'; // par d√©faut
          if (typePaiementText === 'D√©p√¥t') {
            typePaiementBackend = 'depot';
          } else if (typePaiementText === 'Paiement final') {
            typePaiementBackend = 'paiement_final';
          } else if (typePaiementText === 'Autres paiements') {
            typePaiementBackend = 'autres_paiements';
          }
          
          log('üîÑ Mapping type paiement:', {
            frontend: typePaiementText,
            backend: typePaiementBackend
          });

          // S'assurer que les valeurs ne sont pas vides
          if (!paiement || paiement.trim() === '') {
            error('[ERROR] Montant de paiement manquant');
            alert('Veuillez saisir un montant de paiement');
            return;
          }

          // Pr√©parer les donn√©es √† envoyer
          const facturationData = {
            username: window.username,
            clientNom: clientData.nom || 'N/A',
            clientPrenom: clientData.prenom || 'N/A',
            numeroSoumission: clientInfo,
            montantPaiement: paiement,
            dateDepot: dateDepot,
            typePaiement: typePaiementBackend,
            pdfUrl: clientData.pdfUrl || '#',
            methodePaiement: payeParText.toLowerCase(),
            totalTravaux: totalTravaux
          };

          // Ajouter le type de paiement autres si applicable
          if (sectionActive === 'autres-paiements') {
            // Mapper le texte vers la valeur backend (utiliser includes car le textContent peut contenir l'ic√¥ne chevron)
            let typePaiementAutresValue = '';
            if (typePaiementAutresText && typePaiementAutresText.includes('Paiement partiel')) {
              typePaiementAutresValue = 'paiement_partiel';
            } else if (typePaiementAutresText && typePaiementAutresText.includes('Un seul paiement')) {
              typePaiementAutresValue = 'un_seul_paiement';
            } else {
              // FALLBACK: Si le dropdown n'est pas s√©lectionn√© correctement,
              // d√©tecter automatiquement le type selon le statut du d√©p√¥t (utilise clientData de ligne 7318)
              const statutDepot = clientData.statutDepot || 'non_envoye';

              if (statutDepot === 'non_envoye') {
                // Pas de d√©p√¥t = c'est un "Un seul paiement"
                typePaiementAutresValue = 'un_seul_paiement';
                log('[FALLBACK] Type d√©duit automatiquement: un_seul_paiement (pas de d√©p√¥t)');
              } else {
                // D√©p√¥t existe = c'est un paiement partiel
                typePaiementAutresValue = 'paiement_partiel';
                log('[FALLBACK] Type d√©duit automatiquement: paiement_partiel (d√©p√¥t existe)');
              }
            }

            if (typePaiementAutresValue) {
              facturationData.typePaiementAutres = typePaiementAutresValue;
              log('[OK] Type paiement autres ajout√©:', typePaiementAutresValue);
            }
          }

          log('[PACKAGE] Donn√©es facturation pr√©par√©es:', facturationData);

          // Normaliser le texte pour enlever les accents
          const payeParTextNormalized = payeParText.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

          log('[CHEQUE] M√©thode de paiement d√©tect√©e:', {
            payeParText: payeParText,
            payeParTextLower: payeParText.toLowerCase(),
            payeParTextNormalized: payeParTextNormalized,
            isVirement: payeParTextNormalized === 'virement',
            isCheque: payeParTextNormalized.includes('cheque') || payeParTextNormalized.includes('cheq')
          });

          // Ajouter les champs sp√©cifiques selon la m√©thode et la section active
          if (payeParTextNormalized === 'virement') {
            let lienVirementEl, motDePasseEl;
            
            // Collecter les champs selon la section active
            if (sectionActive === 'paiement-final') {
              // Section paiement final
              lienVirementEl = document.querySelector('input[name="lien_virement_final"]');
              motDePasseEl = document.querySelector('input[name="mdp_virement_final"]');
              log('[MONEY] Recherche champs virement PAIEMENT FINAL:', {
                lienVirementEl: !!lienVirementEl,
                motDePasseEl: !!motDePasseEl
              });
            } else if (sectionActive === 'autres-paiements') {
              // Section autres paiements
              lienVirementEl = document.querySelector('input[name="lien_virement_autres"]');
              motDePasseEl = document.querySelector('input[name="mdp_virement_autres"]');
              log('[MONEY] Recherche champs virement AUTRES PAIEMENTS:', {
                lienVirementEl: !!lienVirementEl,
                motDePasseEl: !!motDePasseEl
              });
            } else {
              // Section d√©p√¥t (par d√©faut)
              lienVirementEl = document.querySelector('input[name="lien_virement"]') || document.getElementById('lienVirement');
              motDePasseEl = document.querySelector('input[name="mdp_virement"]') || document.getElementById('motDePasseVirement');
              log('[MONEY] Recherche champs virement D√âP√îT:', {
                lienVirementEl: !!lienVirementEl,
                motDePasseEl: !!motDePasseEl
              });
            }
            
            facturationData.lienVirement = lienVirementEl ? lienVirementEl.value : '';
            facturationData.motDePasseVirement = motDePasseEl ? motDePasseEl.value : '';
            
            log('[MONEY] Champs virement collect√©s pour section', sectionActive + ':', {
              lienVirementEl: !!lienVirementEl,
              lienValue: facturationData.lienVirement,
              motDePasseEl: !!motDePasseEl,
              mdpValue: facturationData.motDePasseVirement
            });
          } else if (payeParTextNormalized.includes('cheque') || payeParTextNormalized.includes('cheq')) {
            log('[CHEQUE] ‚úÖ Section ch√®que d√©tect√©e!');
            let numeroChequeEl;
            
            // Collecter les champs ch√®que selon la section active
            if (sectionActive === 'paiement-final') {
              numeroChequeEl = document.querySelector('input[name="num_cheque_final"]');
              log('üìú Recherche champ ch√®que PAIEMENT FINAL:', {
                numeroChequeEl: !!numeroChequeEl
              });
            } else if (sectionActive === 'autres-paiements') {
              numeroChequeEl = document.querySelector('input[name="num_cheque_autres"]');
              log('üìú Recherche champ ch√®que AUTRES PAIEMENTS:', {
                numeroChequeEl: !!numeroChequeEl
              });
            } else {
              numeroChequeEl = document.querySelector('input[name="num_cheque"]') || document.getElementById('numeroCheque');
              log('üìú Recherche champ ch√®que D√âP√îT:', {
                numeroChequeEl: !!numeroChequeEl
              });
            }
            
            facturationData.numeroCheque = numeroChequeEl ? numeroChequeEl.value : '';
            
            log('üìú Champs ch√®que collect√©s pour section', sectionActive + ':', {
              numeroChequeEl: !!numeroChequeEl,
              numValue: facturationData.numeroCheque
            });

            // Ajouter les photos du ch√®que en base64
            let photoRectoInput, photoVersoInput;

            log('[CHEQUE] Section active:', sectionActive);

            if (sectionActive === 'paiement-final') {
              photoRectoInput = document.getElementById('photoFileRectoFinal');
              photoVersoInput = document.getElementById('photoFileVersoFinal');
            } else if (sectionActive === 'autres-paiements') {
              photoRectoInput = document.getElementById('photoFileRectoAutres');
              photoVersoInput = document.getElementById('photoFileVersoAutres');
            } else {
              photoRectoInput = document.getElementById('photoFileRecto');
              photoVersoInput = document.getElementById('photoFileVerso');
            }

            log('[CHEQUE] Inputs trouv√©s:', {
              photoRectoInput: !!photoRectoInput,
              photoVersoInput: !!photoVersoInput,
              rectoHasFiles: !!(photoRectoInput?.files?.length),
              versoHasFiles: !!(photoVersoInput?.files?.length),
              rectoFileName: photoRectoInput?.files?.[0]?.name,
              versoFileName: photoVersoInput?.files?.[0]?.name
            });

            // Convertir les photos en base64 et uploader au cloud
            let photoRectoBase64 = null;
            let photoVersoBase64 = null;

            if (photoRectoInput && photoRectoInput.files && photoRectoInput.files[0]) {
              log('[CHEQUE] D√©but conversion recto...');
              const readerRecto = new FileReader();
              await new Promise((resolve) => {
                readerRecto.onload = (e) => {
                  photoRectoBase64 = e.target.result;
                  log('[CHEQUE] ‚úÖ Photo recto convertie en base64, taille:', e.target.result.length, 'caract√®res');
                  resolve();
                };
                readerRecto.readAsDataURL(photoRectoInput.files[0]);
              });
            } else {
              log('[CHEQUE] ‚ö†Ô∏è Aucune photo recto √† convertir');
            }

            if (photoVersoInput && photoVersoInput.files && photoVersoInput.files[0]) {
              log('[CHEQUE] D√©but conversion verso...');
              const readerVerso = new FileReader();
              await new Promise((resolve) => {
                readerVerso.onload = (e) => {
                  photoVersoBase64 = e.target.result;
                  log('[CHEQUE] ‚úÖ Photo verso convertie en base64, taille:', e.target.result.length, 'caract√®res');
                  resolve();
                };
                readerVerso.readAsDataURL(photoVersoInput.files[0]);
              });
            } else {
              log('[CHEQUE] ‚ö†Ô∏è Aucune photo verso √† convertir');
            }

            // Uploader les photos au cloud et r√©cup√©rer les URLs
            if (photoRectoBase64 || photoVersoBase64) {
              log('[CHEQUE] üì§ Upload des photos vers le cloud...');
              try {
                const username = getFacturationUsername();
                const numeroSoumission = clientInfo;

                // D√©terminer le type de paiement pour le nom du fichier
                let typePaiement = 'depot';
                if (sectionActive === 'paiement-final') {
                  typePaiement = 'paiement_final';
                } else if (sectionActive === 'autres-paiements') {
                  // Compter le nombre d'autres paiements existants
                  const autresPaiementsCount = (clientData.autresPaiements || []).length;
                  typePaiement = `autre_paiement_${autresPaiementsCount + 1}`;
                }

                const uploadResponse = await fetch('/api/facturationqe/save-cheque-photos', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    username: username,
                    numeroSoumission: numeroSoumission,
                    typePaiement: typePaiement,
                    photoRecto: photoRectoBase64,
                    photoVerso: photoVersoBase64
                  })
                });

                if (uploadResponse.ok) {
                  const uploadResult = await uploadResponse.json();
                  log('[CHEQUE] ‚úÖ Photos upload√©es au cloud:', uploadResult.urls);

                  // Stocker les URLs cloud (pas les base64!)
                  if (uploadResult.urls.photoRecto) {
                    facturationData.photoRecto = uploadResult.urls.photoRecto;
                  }
                  if (uploadResult.urls.photoVerso) {
                    facturationData.photoVerso = uploadResult.urls.photoVerso;
                  }
                } else {
                  log('[CHEQUE] ‚ùå Erreur upload photos:', await uploadResponse.text());
                  alert('Erreur lors de l\'upload des photos du ch√®que');
                  return;
                }
              } catch (error) {
                log('[CHEQUE] ‚ùå Exception upload photos:', error);
                alert('Erreur lors de l\'upload des photos du ch√®que');
                return;
              }
            }

            log('[CHEQUE] üì¶ URLs cloud ajout√©es √† facturationData:', {
              hasRecto: !!facturationData.photoRecto,
              hasVerso: !!facturationData.photoVerso,
              rectoUrl: facturationData.photoRecto,
              versoUrl: facturationData.photoVerso
            });
          }
          
          // D√©sactiver le bouton pendant l'envoi
          envoyerBtn.disabled = true;
          envoyerBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Envoi en cours...';

          // Afficher l'overlay de chargement sur la section
          const overlay = document.getElementById('sectionPaiementsOverlay');
          if (overlay) {
            overlay.classList.add('active');
          }

          // Note: On ne vide PAS la section ici - selectionnerClientFacturation() s'en occupera
          // pour un rechargement complet et propre

          // Envoyer au backend via l'API facturation QE
          const username = getFacturationUsername();
          const numeroSoumission = clientInfo; // Utiliser le num√©ro affich√© dans l'interface
          
          log('üåê Pr√©paration requ√™te API:', {
            username,
            numeroSoumission,
            url: `/api/facturationqe/envoyer-comptable/${username}/${numeroSoumission}`
          });
          
          const requestBody = {
            ...facturationData
          };
          log('[PACKAGE] Corps de la requ√™te:', requestBody);
          
          const response = await fetch(`/api/facturationqe/envoyer-comptable/${username}/${numeroSoumission}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
          });
          
          log('üì° R√©ponse API:', {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok
          });
          
          if (!response.ok) {
            const errorData = await response.text();
            error('[ERROR] Erreur API:', { status: response.status, errorData });
            throw new Error(`Erreur ${response.status}: ${errorData}`);
          }
          
          const responseData = await response.json();
          log('[OK] R√©ponse API succ√®s:', responseData);

          // Succ√®s
          envoyerBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Envoy√© !';
          envoyerBtn.style.backgroundColor = 'rgb(16, 185, 129)';

          log('[OK] Paiement envoy√© au comptable avec succ√®s');

          // La g√©n√©ration des boutons de paiements partiels se fera automatiquement
          // lors du rechargement du client depuis l'API (plus bas)
          log('üîÑ Les boutons de paiements partiels seront g√©n√©r√©s apr√®s rechargement des donn√©es');

          // Si c'est un paiement final ou un seul paiement, d√©sactiver "Autres paiements"
          if (sectionActive === 'paiement-final' || (sectionActive === 'autres-paiements' && typePaiementAutresText === 'Un seul paiement')) {
            const btnAutresPaiements = document.getElementById('btn-autres-paiements');
            if (btnAutresPaiements) {
              btnAutresPaiements.disabled = true;
              btnAutresPaiements.style.opacity = '0.3';
              btnAutresPaiements.style.cursor = 'not-allowed';
              btnAutresPaiements.style.pointerEvents = 'none';
              log('üö´ Bouton "Autres paiements" d√©sactiv√© (paiement final ou un seul paiement)');
            }
          }

          // Mettre √† jour la progression (optionnel - les donn√©es seront recharg√©es)
          if (typeof updateProgressionPaiement === 'function') {
            clientData.depot_status = 'trait√©';
            clientData.depot_paye = true;
            updateProgressionPaiement(clientData);
          }

          // Mettre √† jour TOUTES les donn√©es du paiement dans sessionStorage AVANT le rechargement API
          const currentClient = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');

          // Convertir payeParText en format lowercase pour correspondre aux valeurs backend
          const methode = payeParText.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

          if (sectionActive === 'depot') {
            currentClient.statutDepot = 'traitement';
            currentClient.depot = {
              montant: paiement,
              date: dateDepot,
              methode: methode,
              statut: 'traitement',
              lienVirement: facturationData.lienVirement || null,
              motDePasse: facturationData.motDePasseVirement || null,
              numeroCheque: facturationData.numeroCheque || null,
              photoRecto: facturationData.photoRecto || null,
              photoVerso: facturationData.photoVerso || null
            };
          } else if (sectionActive === 'paiement-final') {
            currentClient.statutPaiementFinal = 'traitement';
            currentClient.paiementFinal = {
              montant: paiement,
              date: dateDepot,
              methode: methode,
              statut: 'traitement',
              lienVirement: facturationData.lienVirement || null,
              motDePasse: facturationData.motDePasseVirement || null,
              numeroCheque: facturationData.numeroCheque || null,
              photoRecto: facturationData.photoRecto || null,
              photoVerso: facturationData.photoVerso || null
            };
          }

          // Sauvegarder TEMPORAIREMENT les photos avant le rechargement API
          const tempPhotosDepot = currentClient.depot ? {
            photoRecto: currentClient.depot.photoRecto,
            photoVerso: currentClient.depot.photoVerso
          } : null;
          const tempPhotosPaiementFinal = currentClient.paiementFinal ? {
            photoRecto: currentClient.paiementFinal.photoRecto,
            photoVerso: currentClient.paiementFinal.photoVerso
          } : null;
          // Sauvegarder TOUS les autres paiements avec leurs photos
          const tempPhotosAutresPaiements = currentClient.autresPaiements ? currentClient.autresPaiements.map(p => ({
            id: p.id,
            photoRecto: p.photoRecto,
            photoVerso: p.photoVerso
          })) : [];

          sessionStorage.setItem('selectedClientDataFacturation', JSON.stringify(currentClient));
          log('[UPDATE] Donn√©es compl√®tes du paiement mises √† jour dans sessionStorage:', sectionActive, currentClient);

          // Attendre 800ms puis recharger les colonnes et donn√©es
          log('üîÑ Rechargement des donn√©es et colonnes apr√®s envoi...');
          await new Promise(resolve => setTimeout(resolve, 800));

          // Recharger les colonnes de statut ET les donn√©es
          await chargerFacturationsDepuisAPI();

          log('[OK] Donn√©es recharg√©es apr√®s envoi au comptable');

          // RESTAURER les URLs des photos apr√®s le rechargement API (car l'API peut les √©craser)
          const reloadedClient = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
          if (tempPhotosDepot && reloadedClient.depot) {
            reloadedClient.depot.photoRecto = tempPhotosDepot.photoRecto || reloadedClient.depot.photoRecto;
            reloadedClient.depot.photoVerso = tempPhotosDepot.photoVerso || reloadedClient.depot.photoVerso;
          }
          if (tempPhotosPaiementFinal && reloadedClient.paiementFinal) {
            reloadedClient.paiementFinal.photoRecto = tempPhotosPaiementFinal.photoRecto || reloadedClient.paiementFinal.photoRecto;
            reloadedClient.paiementFinal.photoVerso = tempPhotosPaiementFinal.photoVerso || reloadedClient.paiementFinal.photoVerso;
          }
          // RESTAURER les photos des autres paiements (paiements partiels)
          if (tempPhotosAutresPaiements.length > 0 && reloadedClient.autresPaiements) {
            reloadedClient.autresPaiements.forEach(paiement => {
              const tempPhotos = tempPhotosAutresPaiements.find(tp => tp.id === paiement.id);
              if (tempPhotos) {
                paiement.photoRecto = tempPhotos.photoRecto || paiement.photoRecto;
                paiement.photoVerso = tempPhotos.photoVerso || paiement.photoVerso;
              }
            });
            log('[RESTORE] Photos des paiements partiels restaur√©es:', tempPhotosAutresPaiements.length);
          }
          sessionStorage.setItem('selectedClientDataFacturation', JSON.stringify(reloadedClient));
          log('[RESTORE] Photos restaur√©es apr√®s rechargement API');

          // === NOUVEAU: R√©initialiser le formulaire "Autres paiements" apr√®s envoi r√©ussi ===
          if (sectionActive === 'autres-paiements') {
            log('üßπ R√©initialisation du formulaire Autres paiements');

            // R√©initialiser les champs
            if (paiementEl) paiementEl.value = '';
            if (dateEl) dateEl.value = '';

            // R√©initialiser les dropdowns
            const typePaiementAutresToggle = document.getElementById('typePaiementAutresToggle');
            if (typePaiementAutresToggle) {
              typePaiementAutresToggle.innerHTML = '<span class="placeholder" style="color: var(--text-gray);">Choisir le type...</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>';
            }

            const payeParAutresToggle = document.getElementById('payeParAutresToggle');
            if (payeParAutresToggle) {
              payeParAutresToggle.innerHTML = '<span class="placeholder" style="color: var(--text-gray);">Choisir m√©thode...</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>';
            }

            // === NOUVEAU: G√©rer √† nouveau la visibilit√© et pr√©-s√©lection apr√®s r√©initialisation ===
            setTimeout(() => {
              gererVisibiliteUnSeulPaiement();
              preselectionnerPaiementPartielSiNecessaire();
            }, 100);

            // Masquer et vider les champs conditionnels
            const virementFieldsAutres = document.getElementById('virementFieldsAutres');
            const chequeFieldsAutres = document.getElementById('chequeFieldsAutres');
            if (virementFieldsAutres) {
              virementFieldsAutres.classList.add('hidden');
              const lien = virementFieldsAutres.querySelector('input[name="lien_virement_autres"]');
              const mdp = virementFieldsAutres.querySelector('input[name="mdp_virement_autres"]');
              if (lien) lien.value = '';
              if (mdp) mdp.value = '';
            }
            if (chequeFieldsAutres) {
              chequeFieldsAutres.classList.add('hidden');
              const num = chequeFieldsAutres.querySelector('input[name="num_cheque_autres"]');
              if (num) num.value = '';
            }

            // Masquer la section "√âl√©ments √† ajouter"
            const elementsAjouterAutres = document.getElementById('elementsAjouterAutres');
            if (elementsAjouterAutres) {
              elementsAjouterAutres.style.maxHeight = '0';
              elementsAjouterAutres.style.opacity = '0';
            }

            log('[OK] Formulaire Autres paiements r√©initialis√© - pr√™t pour nouveau paiement');
          }

          // RES√âLECTIONNER le client automatiquement pour rafra√Æchir tout l'√©tat
          // (grisage, boutons, sections, etc. - tout sera g√©r√© automatiquement)
          // Le spinner reste actif pendant toute l'op√©ration
          const finalClient = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
          const clientNameForReload = `${finalClient.prenom || ''} ${finalClient.nom || ''}`.trim();

          if (clientInfo && typeof selectionnerClientFacturation === 'function') {
            log('[RELOAD] Res√©lection automatique du client apr√®s envoi:', clientInfo);
            await selectionnerClientFacturation(clientInfo, clientNameForReload, finalClient);
            log('[OK] ‚úÖ Client res√©lectionn√© - √©tat rafra√Æchi automatiquement');
          }

          // Cacher le spinner APR√àS la res√©lection compl√®te
          if (overlay) {
            overlay.classList.remove('active');
          }

          // R√©initialiser le bouton envoi
          envoyerBtn.innerHTML = originalText;
          envoyerBtn.disabled = false;
          envoyerBtn.style.backgroundColor = '';

          // Afficher le toast de succ√®s
          showSuccessToast('Envoi r√©ussi !', 'Le paiement a √©t√© envoy√© au comptable avec succ√®s.');

          log('[OK] Paiement envoy√© et section gris√©e automatiquement');

        } catch (error) {
          error('Erreur envoi comptable:', error);

          // Cacher l'overlay en cas d'erreur
          const overlay = document.getElementById('sectionPaiementsOverlay');
          if (overlay) {
            overlay.classList.remove('active');
          }

          alert('Erreur lors de l\'envoi au comptable');
          envoyerBtn.disabled = false;
          envoyerBtn.innerHTML = originalText;
        }
      });
    }

    // Fonction pour afficher une notification toast de succ√®s
    function showSuccessToast(title, message) {
      // Supprimer les anciens toasts
      const existingToast = document.querySelector('.toast-notification');
      if (existingToast) {
        existingToast.remove();
      }

      // Cr√©er le toast
      const toast = document.createElement('div');
      toast.className = 'toast-notification';
      toast.innerHTML = `
        <div class="toast-icon">
          <i class="fas fa-check"></i>
        </div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;

      document.body.appendChild(toast);

      // Afficher le toast avec animation
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);

      // Auto-fermeture apr√®s 4 secondes
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentElement) {
            toast.remove();
          }
        }, 500);
      }, 4000);
    }

    // Fonction pour charger les facturations en traitement
    // Anciennes fonctions supprim√©es - remplac√©es par chargerFacturationsDepuisAPI()
    
    // Fonction pour r√©initialiser le formulaire
    function resetForm() {
      const clientToggle = document.getElementById('clientToggle');
      const clientInfo = document.getElementById('clientInfo');
      const paiement = document.getElementById('paiement');
      const totalTravauxClient = document.getElementById('totalTravauxClient');
      const produit = document.getElementById('produit');
      const dateDepot = document.getElementById('dateDepot');
      const typePaiementToggle = document.getElementById('typePaiementToggle');
      const payeParToggle = document.getElementById('payeParToggle');
      
      if (clientToggle) clientToggle.innerHTML = '<span class="placeholder" style="color: var(--text-gray);">Choisir un client...</span>';
      if (clientInfo) clientInfo.value = '';
      if (paiement) paiement.value = '';
      if (totalTravauxClient) totalTravauxClient.value = '';
      if (produit) produit.value = '';
      if (dateDepot) dateDepot.value = '';
      
      // Reset dropdowns
      if (typePaiementToggle) typePaiementToggle.innerHTML = '<span class="placeholder" style="color: var(--text-gray);">Choisir le type...</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>';
      if (payeParToggle) payeParToggle.innerHTML = '<span class="placeholder" style="color: var(--text-gray);">Choisir m√©thode...</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>';
      
      // Cacher la section √©l√©ments √† ajouter d√©p√¥t et r√©initialiser la taille de la card
      const elementsAjouterDepot = document.getElementById('elementsAjouterDepot');
      
      if (elementsAjouterDepot) {
        elementsAjouterDepot.style.maxHeight = '0';
        elementsAjouterDepot.style.opacity = '0';
      }
      
      // Cacher aussi les champs virement et ch√®que du d√©p√¥t
      const virementFieldsDepot = document.getElementById('virementFieldsDepot');
      const chequeFieldsDepot = document.getElementById('chequeFieldsDepot');
      
      if (virementFieldsDepot) virementFieldsDepot.classList.add('hidden');
      if (chequeFieldsDepot) chequeFieldsDepot.classList.add('hidden');
      
      // R√©initialiser la taille de la card
      const cardContent = document.querySelector('.box-body');
      if (cardContent) {
        cardContent.classList.remove('expanded');
      }
      
      // D√©sactiver la section paiements
      toggleSectionPaiements(false);
      
      // Masquer la card des d√©tails client
      const clientDetailsCard = document.getElementById('clientDetailsCard');
      if (clientDetailsCard) {
        clientDetailsCard.classList.add('hidden');
      }
      
      // D√©sactiver le bouton "Voir soumission"
      const voirSoumissionBtn = document.getElementById('voirSoumissionBtn');
      if (voirSoumissionBtn) {
        voirSoumissionBtn.disabled = true;
        voirSoumissionBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }

      // D√©sactiver aussi le bouton de remboursement
      const voirSoumissionBtnRemboursement = document.getElementById('voirSoumissionBtnRemboursement');
      if (voirSoumissionBtnRemboursement) {
        voirSoumissionBtnRemboursement.disabled = true;
        voirSoumissionBtnRemboursement.classList.add('opacity-50', 'cursor-not-allowed');
      }
      
      sessionStorage.removeItem('selectedClientData');
    }
    
    // Fonction pour calculer le total avec taxes qu√©b√©coises (TPS 5% + TVQ 9,975%)
    function calculerTotalAvecTaxes(montantHorsTaxes) {
      if (!montantHorsTaxes || montantHorsTaxes <= 0) return 0;
      
      const TPS = 0.05;  // 5%
      const TVQ = 0.09975;  // 9,975%
      const totalTaxes = TPS + TVQ;  // 14,975%
      
      const totalAvecTaxes = montantHorsTaxes * (1 + totalTaxes);
      log(`[MONEY] Calcul taxes: ${montantHorsTaxes} + ${(totalTaxes * 100).toFixed(3)}% = ${totalAvecTaxes.toFixed(2)}`);
      
      return totalAvecTaxes;
    }

    // Fonction pour mettre √† jour la progression du paiement
    function updateProgressionPaiement(clientData) {
      log('üîÑ Mise √† jour progression paiement pour:', clientData);
      
      const progressBar = document.getElementById('progressBar');
      const progressPercentage = document.getElementById('progressPercentage');
      const progressTextLeft = document.getElementById('progressTextLeft');
      const progressTextRight = document.getElementById('progressTextRight');
      const statutPaiement = document.getElementById('clientStatutPaiement');
      const totalTravauxElement = document.getElementById('totalTravauxClient');
      const totalTravauxProgression = document.getElementById('totalTravauxProgression');
      
      log('[DEBUG] DEBUG - Elements trouv√©s:', {
        progressTextRight: !!progressTextRight,
        totalTravauxElement: !!totalTravauxElement,
        totalTravauxElementValue: totalTravauxElement?.value
      });
      
      if (!progressBar || !progressPercentage || !statutPaiement) {
        log('[ERROR] DEBUG - √âl√©ments manquants:', {
          progressBar: !!progressBar,
          progressPercentage: !!progressPercentage,
          statutPaiement: !!statutPaiement
        });
        return;
      }
      
      // R√©cup√©rer le total des travaux
      let totalTravaux = 0;
      if (totalTravauxElement && totalTravauxElement.value) {
        // Nettoyer la cha√Æne pour extraire le nombre
        let cleanValue = totalTravauxElement.value
          .replace(/\s/g, '') // Supprimer espaces
          .replace(/,/g, '.') // Remplacer virgules par points
          .replace(/[^\d.]/g, ''); // Garder seulement chiffres et points
        
        totalTravaux = parseFloat(cleanValue) || 0;
        log('[MONEY] Total travaux extrait:', totalTravaux, 'de:', totalTravauxElement.value);
      }
      
      // Mettre √† jour l'affichage du montant total avec taxes (format canadien fran√ßais)
      if (totalTravauxProgression) {
        if (totalTravaux > 0) {
          const totalAvecTaxesProgression = calculerTotalAvecTaxes(totalTravaux);
          totalTravauxProgression.textContent = formatMontant(totalAvecTaxesProgression);
        } else {
          totalTravauxProgression.textContent = '0$';
        }
      }
      
      // Calculer le total avec taxes pour l'affichage √† droite de la barre de progression
      let totalAvecTaxes = 0;
      let totalAvecTaxesFormate = '0$';
      
      if (totalTravaux > 0) {
        totalAvecTaxes = calculerTotalAvecTaxes(totalTravaux);
        totalAvecTaxesFormate = formatMontant(totalAvecTaxes);
      }
      
      log('[DATA] Total avec taxes calcul√©:', totalAvecTaxes, 'format√©:', totalAvecTaxesFormate);
      log('[TARGET] DEBUG - Condition check: totalTravaux =', totalTravaux, 'totalAvecTaxes =', totalAvecTaxes);
      
      // Toujours mettre √† jour les textes de progression d'abord
      if (progressTextLeft) {
        progressTextLeft.textContent = '0$';
        log('[OK] DEBUG - progressTextLeft:', progressTextLeft.textContent);
      }
      if (progressTextRight) {
        progressTextRight.textContent = totalAvecTaxesFormate;
        log('[OK] DEBUG - progressTextRight mis √† jour avec taxes:', totalAvecTaxesFormate);
      } else {
        log('[ERROR] DEBUG - progressTextRight non trouv√©!');
      }
      
      if (totalTravaux === 0) {
        log('[WARN] DEBUG - Passage par la condition totalTravaux === 0');

        // V√©rifier s'il y a des "autres paiements" (un seul paiement ou paiement partiel)
        const autresPaiementsData = clientData.autresPaiements || [];
        const hasAutresPaiements = Array.isArray(autresPaiementsData) && autresPaiementsData.length > 0;

        if (hasAutresPaiements) {
          // Trouver le montant total des autres paiements
          let totalAutres = 0;
          let hasEnTraitement = false;
          let hasTraite = false;
          let hasUnSeulPaiement = false;

          let hasRemboursement = false;
          let montantRemboursement = 0;
          let nbRemboursements = 0;

          autresPaiementsData.forEach(p => {
            const montant = parseFloat(String(p.montant || '0').replace(/\s/g, '').replace(/,/g, '.').replace(/[^\d.]/g, '')) || 0;

            // D√©tecter les remboursements
            if (p.typePaiementAutres === 'remboursement') {
              hasRemboursement = true;
              montantRemboursement += montant;
              nbRemboursements++;
              log('[RED] REMBOURSEMENT d√©tect√© (totalTravaux=0):', montant);
              return; // Skip ce paiement pour les autres checks
            }

            totalAutres += montant;
            if (p.statut === 'traitement' || p.statut === 'attente_comptable') hasEnTraitement = true;
            if (p.statut === 'traite') hasTraite = true;
            if (p.typePaiementAutres === 'un_seul_paiement') hasUnSeulPaiement = true;
          });

          log('[DEBUG] Autres paiements trouv√©s:', autresPaiementsData.length, 'total:', totalAutres, 'en traitement:', hasEnTraitement, 'trait√©:', hasTraite, 'un seul:', hasUnSeulPaiement, 'remboursement:', hasRemboursement);

          // Mettre √† jour la barre avec le montant des autres paiements
          const totalAvecTaxesAutres = calculerTotalAvecTaxes(totalAutres);

          if (progressTextRight) {
            progressTextRight.textContent = formatMontant(totalAvecTaxesAutres);
          }

          // Ne pas changer la barre pour les remboursements, juste noter leur pr√©sence
          if (hasEnTraitement) {
            progressBar.style.width = '100%';
            progressBar.style.background = '#f59e0b'; // Orange
            progressPercentage.textContent = '100%';
            statutPaiement.textContent = hasUnSeulPaiement ? 'Paiement complet en traitement' : 'Paiement partiel en traitement';
            statutPaiement.style.color = '#f59e0b';
          } else if (hasTraite) {
            progressBar.style.width = '100%';
            progressBar.style.background = '#10b981'; // Vert
            progressPercentage.textContent = '100%';
            statutPaiement.textContent = hasUnSeulPaiement ? 'Paiement complet trait√©' : 'Paiement partiel trait√©';
            statutPaiement.style.color = '#10b981';
          } else {
            progressBar.style.width = '0%';
            progressPercentage.textContent = '0%';
            statutPaiement.textContent = 'En attente du d√©p√¥t';
            statutPaiement.style.color = 'white';
          }

          // Afficher la note des remboursements si des remboursements existent
          const noteRemboursements = document.getElementById('noteRemboursements');
          if (noteRemboursements && hasRemboursement) {
            const texteRemb = nbRemboursements > 1
              ? `${nbRemboursements} remboursements totalisant ${montantRemboursement.toFixed(2).replace('.', ',')} $`
              : `${nbRemboursements} remboursement totalisant ${montantRemboursement.toFixed(2).replace('.', ',')} $`;
            noteRemboursements.textContent = texteRemb;
            noteRemboursements.style.display = 'block';
            log('[RED] Note remboursements affich√©e (totalTravaux=0):', texteRemb);
          } else if (noteRemboursements) {
            noteRemboursements.style.display = 'none';
          }

          return;
        }

        // Pas de total des travaux ET pas d'autres paiements, affichage par d√©faut
        progressBar.style.width = '0%';
        progressPercentage.textContent = '0%';
        statutPaiement.textContent = 'En attente du d√©p√¥t';
        statutPaiement.style.color = 'white';
        return;
      }
      
      log('[OK] DEBUG - Passage par la condition totalTravaux > 0, calcul progression...');
      // Calculer s√©par√©ment les montants trait√©s et en traitement
      let montantTraite = 0;
      let montantEnTraitement = 0;
      let statut = 'En attente du d√©p√¥t';

      // Fonction helper pour nettoyer et parser les montants
      const cleanAndParseAmount = (montant) => {
        if (!montant) return 0;
        const cleanValue = String(montant)
          .replace(/\s/g, '')
          .replace(/,/g, '.')
          .replace(/[^\d.]/g, '');
        return parseFloat(cleanValue) || 0;
      };

      // R√©cup√©rer le montant du d√©p√¥t (depuis les donn√©es OU depuis le champ input)
      let montantDepot = 0;
      if (clientData.depot && clientData.depot.montant) {
        montantDepot = cleanAndParseAmount(clientData.depot.montant);
      }
      // Fallback: lire depuis le champ input si le montant est vide
      if (montantDepot === 0) {
        const paiementInput = document.getElementById('paiement');
        if (paiementInput && paiementInput.value) {
          montantDepot = cleanAndParseAmount(paiementInput.value);
          log('[INFO] Montant d√©p√¥t lu depuis input:', montantDepot);
        }
      }

      // V√©rifier le d√©p√¥t
      if (clientData.depot && clientData.depot.statut === 'traite') {
        montantTraite += montantDepot;
        statut = 'D√©p√¥t trait√© - En attente paiement final';
        log('[MONEY] D√©p√¥t TRAIT√â ajout√©:', montantDepot);
      } else if (clientData.statutDepot === 'traite') {
        montantTraite += montantDepot;
        statut = 'D√©p√¥t trait√© - En attente paiement final';
        log('[MONEY] D√©p√¥t TRAIT√â ajout√© (via statutDepot):', montantDepot);
      } else if (clientData.depot && clientData.depot.statut === 'traite_attente_final') {
        // D√©p√¥t valid√© par direction - consid√©r√© comme trait√© (vert)
        montantTraite += montantDepot;
        statut = 'D√©p√¥t trait√© - En attente paiement final';
        log('[MONEY] D√©p√¥t TRAIT√â (traite_attente_final) ajout√©:', montantDepot);
      } else if (clientData.statutDepot === 'traite_attente_final') {
        montantTraite += montantDepot;
        statut = 'D√©p√¥t trait√© - En attente paiement final';
        log('[MONEY] D√©p√¥t TRAIT√â (traite_attente_final via statutDepot) ajout√©:', montantDepot);
      } else if (clientData.depot && clientData.depot.statut === 'attente_comptable') {
        // D√©p√¥t valid√© par coach, en attente direction - EN TRAITEMENT (orange) pour l'entrepreneur
        montantEnTraitement += montantDepot;
        statut = 'D√©p√¥t en traitement';
        log('[ORANGE] D√©p√¥t EN TRAITEMENT (attente_comptable) ajout√©:', montantDepot);
      } else if (clientData.statutDepot === 'attente_comptable') {
        montantEnTraitement += montantDepot;
        statut = 'D√©p√¥t en traitement';
        log('[ORANGE] D√©p√¥t EN TRAITEMENT (attente_comptable via statutDepot) ajout√©:', montantDepot);
      } else if (clientData.depot && clientData.depot.statut === 'traitement') {
        montantEnTraitement += montantDepot;
        statut = 'D√©p√¥t en traitement';
        log('[ORANGE] D√©p√¥t EN TRAITEMENT ajout√©:', montantDepot);
      } else if (clientData.statutDepot === 'traitement') {
        montantEnTraitement += montantDepot;
        statut = 'D√©p√¥t en traitement';
        log('[ORANGE] D√©p√¥t EN TRAITEMENT ajout√© (via statutDepot):', montantDepot);
      } else if (clientData.depot && clientData.depot.statut === 'envoye') {
        statut = 'D√©p√¥t envoy√© au comptable';
      } else if (clientData.statutDepot === 'envoye') {
        statut = 'D√©p√¥t envoy√© au comptable';
      }

      // V√©rifier le paiement final
      if (clientData.paiementFinal && clientData.paiementFinal.statut === 'traite') {
        montantTraite += cleanAndParseAmount(clientData.paiementFinal.montant);
        if (montantTraite >= totalAvecTaxes * 0.9) {
          statut = 'Paiements complets';
        } else {
          statut = 'Paiement final trait√©';
        }
        log('[MONEY] Paiement final TRAIT√â ajout√©:', cleanAndParseAmount(clientData.paiementFinal.montant));
      } else if (clientData.statutPaiementFinal === 'traite') {
        if (clientData.paiementFinal && clientData.paiementFinal.montant) {
          montantTraite += cleanAndParseAmount(clientData.paiementFinal.montant);
        }
        statut = 'Paiements complets';
        log('[MONEY] Paiement final TRAIT√â ajout√© (via statutPaiementFinal):', cleanAndParseAmount(clientData.paiementFinal?.montant));
      } else if (clientData.paiementFinal && clientData.paiementFinal.statut === 'attente_comptable') {
        // Paiement final valid√© par coach, en attente direction - EN TRAITEMENT (orange) pour l'entrepreneur
        montantEnTraitement += cleanAndParseAmount(clientData.paiementFinal.montant);
        const depotStatut = clientData.depot?.statut || clientData.statutDepot;
        const depotEnTraitement = depotStatut === 'traitement' || depotStatut === 'attente_comptable';
        if (montantTraite > 0) {
          statut = 'D√©p√¥t trait√© - Paiement final en traitement';
        } else if (depotEnTraitement) {
          statut = 'D√©p√¥t et paiement final en traitement';
        } else {
          statut = 'Paiement final en traitement';
        }
        log('[ORANGE] Paiement final EN TRAITEMENT (attente_comptable) ajout√©:', cleanAndParseAmount(clientData.paiementFinal.montant));
      } else if (clientData.statutPaiementFinal === 'attente_comptable') {
        if (clientData.paiementFinal && clientData.paiementFinal.montant) {
          montantEnTraitement += cleanAndParseAmount(clientData.paiementFinal.montant);
        }
        const depotStatut = clientData.depot?.statut || clientData.statutDepot;
        const depotEnTraitement = depotStatut === 'traitement' || depotStatut === 'attente_comptable';
        if (montantTraite > 0) {
          statut = 'D√©p√¥t trait√© - Paiement final en traitement';
        } else if (depotEnTraitement) {
          statut = 'D√©p√¥t et paiement final en traitement';
        } else {
          statut = 'Paiement final en traitement';
        }
        log('[ORANGE] Paiement final EN TRAITEMENT (attente_comptable via statutPaiementFinal) ajout√©:', cleanAndParseAmount(clientData.paiementFinal?.montant));
      } else if (clientData.paiementFinal && clientData.paiementFinal.statut === 'traitement') {
        montantEnTraitement += cleanAndParseAmount(clientData.paiementFinal.montant);
        const depotStatut = clientData.depot?.statut || clientData.statutDepot;
        const depotEnTraitement = depotStatut === 'traitement' || depotStatut === 'attente_comptable';
        if (montantTraite > 0) {
          statut = 'D√©p√¥t trait√© - Paiement final en traitement';
        } else if (depotEnTraitement) {
          statut = 'D√©p√¥t et paiement final en traitement';
        } else {
          statut = 'Paiement final en traitement';
        }
        log('[ORANGE] Paiement final EN TRAITEMENT ajout√©:', cleanAndParseAmount(clientData.paiementFinal.montant));
      } else if (clientData.statutPaiementFinal === 'traitement') {
        if (clientData.paiementFinal && clientData.paiementFinal.montant) {
          montantEnTraitement += cleanAndParseAmount(clientData.paiementFinal.montant);
        }
        const depotStatut = clientData.depot?.statut || clientData.statutDepot;
        const depotEnTraitement = depotStatut === 'traitement' || depotStatut === 'attente_comptable';
        if (montantTraite > 0) {
          statut = 'D√©p√¥t trait√© - Paiement final en traitement';
        } else if (depotEnTraitement) {
          statut = 'D√©p√¥t et paiement final en traitement';
        } else {
          statut = 'Paiement final en traitement';
        }
        log('[ORANGE] Paiement final EN TRAITEMENT ajout√© (via statutPaiementFinal):', cleanAndParseAmount(clientData.paiementFinal?.montant));
      }

      // V√©rifier les autres paiements et d√©tecter les remboursements
      let hasAutresPaiementsTraite = false;
      let hasAutresPaiementsTraitement = false;
      let hasRemboursement = false;
      let montantRemboursement = 0;
      let nbRemboursements = 0;
      if (clientData.autresPaiements && Array.isArray(clientData.autresPaiements)) {
        clientData.autresPaiements.forEach(paiement => {
          const montantAutre = cleanAndParseAmount(paiement.montant);

          // D√©tecter les remboursements
          if (paiement.typePaiementAutres === 'remboursement') {
            hasRemboursement = true;
            montantRemboursement += montantAutre;
            nbRemboursements++;
            log('[RED] REMBOURSEMENT d√©tect√©:', montantAutre, '(statut:', paiement.statut, ')');
            return; // Skip les autres checks pour ce paiement
          }

          if (paiement.statut === 'traite') {
            montantTraite += montantAutre;
            hasAutresPaiementsTraite = true;
            log('[MONEY] Autre paiement TRAIT√â ajout√©:', montantAutre);
          } else if (paiement.statut === 'traitement' || paiement.statut === 'attente_comptable') {
            // attente_comptable = valid√© par coach, en attente direction = toujours "en traitement" pour l'entrepreneur
            montantEnTraitement += montantAutre;
            hasAutresPaiementsTraitement = true;
            log('[ORANGE] Autre paiement EN TRAITEMENT ajout√©:', montantAutre, '(statut:', paiement.statut, ')');
          }
        });
      }

      // Mettre √† jour le statut pour inclure les paiements partiels
      const depotNonEnvoye = !clientData.statutDepot || clientData.statutDepot === 'non_envoye';
      // D√©p√¥t trait√© inclut: traite, traite_attente_final (valid√© par direction = vraiment trait√©)
      // attente_comptable = en traitement (pas encore trait√© par direction)
      const depotTraite = clientData.statutDepot === 'traite' ||
                          clientData.statutDepot === 'traite_attente_final' ||
                          (clientData.depot && (clientData.depot.statut === 'traite' ||
                                                clientData.depot.statut === 'traite_attente_final'));
      const paiementFinalEnTraitement = clientData.statutPaiementFinal === 'traitement' || (clientData.paiementFinal && clientData.paiementFinal.statut === 'traitement');

      // Cas sp√©cial: un seul paiement (pas de d√©p√¥t)
      if (depotNonEnvoye && hasAutresPaiementsTraitement) {
        statut = 'Paiement complet en traitement';
      } else if (depotNonEnvoye && hasAutresPaiementsTraite) {
        statut = 'Paiement complet trait√©';
      }
      // Cas: d√©p√¥t EN TRAITEMENT avec paiements partiels et/ou paiement final en traitement
      else if (!depotNonEnvoye && !depotTraite && (hasAutresPaiementsTraitement || paiementFinalEnTraitement)) {
        const parts = ['D√©p√¥t'];
        if (paiementFinalEnTraitement) {
          parts.push('paiement final');
        }
        if (hasAutresPaiementsTraitement) {
          parts.push('paiement partiel');
        }

        if (parts.length === 1) {
          statut = 'D√©p√¥t en traitement';
        } else if (parts.length === 2) {
          statut = `${parts[0]} et ${parts[1]} en traitement`;
        } else {
          statut = `${parts[0]}, ${parts[1]} et ${parts[2]} en traitement`;
        }
      }
      // Cas: d√©p√¥t trait√© avec paiements partiels et/ou paiement final
      else if (depotTraite && (paiementFinalEnTraitement || hasAutresPaiementsTraitement)) {
        const parts = [];
        if (paiementFinalEnTraitement) {
          parts.push('paiement final');
        }
        if (hasAutresPaiementsTraitement) {
          parts.push('paiement partiel');
        }

        if (parts.length === 1) {
          statut = `${parts[0].charAt(0).toUpperCase() + parts[0].slice(1)} en traitement`;
        } else {
          statut = `${parts[0].charAt(0).toUpperCase() + parts[0].slice(1)} et ${parts[1]} en traitement`;
        }
      }
      // Cas: d√©p√¥t trait√© avec paiement partiel trait√©
      else if (depotTraite && hasAutresPaiementsTraite && !paiementFinalEnTraitement) {
        statut = 'Paiement partiel trait√© - En attente paiement final';
      }

      // Calculer les pourcentages en fonction du total AVEC TAXES
      const pourcentageTraite = Math.min((montantTraite / totalAvecTaxes) * 100, 100);
      const pourcentageEnTraitement = Math.min((montantEnTraitement / totalAvecTaxes) * 100, 100);
      const progression = Math.min(pourcentageTraite + pourcentageEnTraitement, 100);
      
      // Mettre √† jour l'affichage
      progressBar.style.width = `${progression}%`;
      progressPercentage.textContent = `${Math.round(progression)}%`;

      // Mettre √† jour le statut
      statutPaiement.textContent = statut;

      // Cr√©er la barre de progression avec segments distincts
      // Ne pas changer la couleur pour les remboursements, juste afficher normalement
      if (pourcentageTraite > 0 && pourcentageEnTraitement > 0) {
        // D√©p√¥t trait√© (vert) + Paiement en traitement (orange)
        const percentTraite = (pourcentageTraite / progression) * 100;
        progressBar.style.background = `linear-gradient(90deg, #10b981 0%, #10b981 ${percentTraite}%, #f59e0b ${percentTraite}%, #f59e0b 100%)`;
        statutPaiement.style.color = '#f59e0b'; // Orange car il reste un paiement en traitement
      } else if (pourcentageTraite >= 100) {
        // Tout est trait√© (100% vert)
        statutPaiement.style.color = '#10b981'; // Vert pour termin√©
        progressBar.style.background = '#10b981'; // Vert solide
      } else if (pourcentageTraite > 0) {
        // Seulement du trait√© (vert)
        statutPaiement.style.color = '#10b981'; // Vert
        progressBar.style.background = '#10b981'; // Vert solide
      } else if (pourcentageEnTraitement > 0) {
        // Seulement en traitement (orange)
        statutPaiement.style.color = '#f59e0b'; // Orange
        progressBar.style.background = '#f59e0b'; // Orange solide
      } else if (statut.includes('envoy√©')) {
        statutPaiement.style.color = '#3b82f6'; // Bleu pour envoy√©
        progressBar.style.background = '#3b82f6'; // Bleu solide
      } else {
        statutPaiement.style.color = 'white'; // Blanc pour en attente
        progressBar.style.background = '#6b7280'; // Gris solide
      }

      // Afficher la note des remboursements si des remboursements existent
      const noteRemboursements = document.getElementById('noteRemboursements');
      if (noteRemboursements && hasRemboursement) {
        const texteRemb = nbRemboursements > 1
          ? `${nbRemboursements} remboursements totalisant ${montantRemboursement.toFixed(2).replace('.', ',')} $`
          : `${nbRemboursements} remboursement totalisant ${montantRemboursement.toFixed(2).replace('.', ',')} $`;
        noteRemboursements.textContent = texteRemb;
        noteRemboursements.style.display = 'block';
        log('[RED] Note remboursements affich√©e (section principale):', texteRemb);
      } else if (noteRemboursements) {
        noteRemboursements.style.display = 'none';
      }

      log('[OK] Progression mise √† jour:', Math.round(progression) + '%', '- Montant trait√©:', montantTraite, '- Montant en traitement:', montantEnTraitement, '- Total avec taxes:', totalAvecTaxes, '- Statut:', statut);
    }
    
    // Fonctions de recherche supprim√©es - les tables n'existent plus avec le nouveau syst√®me

    // Fonction de recherche trait√©es aussi supprim√©e

    // Fonction pour initialiser le formatage automatique des montants
    function initFormattingMontants() {
      log('[LAUNCH] Initialisation du formatage des montants...');
      const champsMonetaires = ['paiement', 'paiementFinal', 'paiementAutres', 'totalTravauxClient', 'produit'];
      
      champsMonetaires.forEach(champId => {
        const champ = document.getElementById(champId);
        log(`[DEBUG] Champ ${champId}:`, champ ? 'trouv√©' : 'NON TROUV√â');
        
        if (champ && typeof champ.addEventListener === 'function') {
          log(`[OK] Event listeners ajout√©s pour ${champId}`);
          
          // Fonction pour nettoyer la valeur (enlever formatage pour √©dition)
          champ.addEventListener('focus', function() {
            log(`üëÜ Focus sur ${champId}, valeur avant:`, this.value);
            let valeur = this.value;
            // Enlever le formatage (espaces, virgules, $) pour permettre l'√©dition
            valeur = valeur.replace(/\s/g, '').replace(',', '.').replace('$', '').trim();
            this.value = valeur;
            log(`üßπ ${champId} nettoy√© pour √©dition:`, valeur);
          });
          
          // Ajout √©v√©nement input pour formatage en temps r√©el
          champ.addEventListener('input', function() {
            log(`‚å®Ô∏è Saisie dans ${champId}:`, this.value);
          });
          
          // Fonction pour formater la valeur quand on quitte le champ
          champ.addEventListener('blur', function() {
            log(`üëã Blur sur ${champId}, valeur:`, this.value);
            let valeur = this.value.trim();
            if (valeur === '' || isNaN(parseFloat(valeur))) {
              log(`[ERROR] ${champId} - Valeur invalide ou vide:`, valeur);
              return;
            }
            
            // Convertir en nombre
            const nombre = parseFloat(valeur);
            log(`üî¢ ${champId} - Nombre pars√©:`, nombre);
            
            // Formater avec espaces pour milliers et 2 d√©cimales
            const wholePart = Math.floor(nombre);
            const decimalPart = Math.round((nombre - wholePart) * 100);
            const wholePartFormatted = wholePart.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            const decimalFormatted = decimalPart.toString().padStart(2, '0');
            const nombreFormate = wholePartFormatted + ',' + decimalFormatted;
            
            log(`üé® ${champId} - Formatage:`, {
              wholePart,
              decimalPart,
              wholePartFormatted,
              decimalFormatted,
              nombreFormate
            });
            
            // Ajouter le $ √† la fin
            const valeurFinale = nombreFormate + ' $';
            this.value = valeurFinale;
            log(`[OK] ${champId} - Valeur finale:`, valeurFinale);
          });
        }
      });
    }

  </script>

  <!-- Modal pour modification/messages comptable -->
  <div id="modificationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 max-w-4xl w-full mx-4 max-h-[90vh] relative overflow-hidden" style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 20px;">
      <div style="content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(135deg, #60a5fa, #3b82f6); border-radius: 20px 20px 0 0;"></div>
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold" style="color: var(--text-light);" id="modalTitle">
          <i class="fas fa-edit mr-2 text-blue-400"></i>Modification de facturation
        </h3>
        <button onclick="fermerModal()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2) !important; color: #60a5fa;" onmouseover="this.style.background='rgba(96, 165, 250, 0.3) !important'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2) !important'">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div id="modalContent" style="color: var(--text-light);">
        <!-- Le contenu sera charg√© dynamiquement -->
      </div>
      
      <div class="flex justify-between items-center mt-6">
        <!-- Message d'avertissement en jaune √† gauche -->
        <div class="bg-yellow-900 bg-opacity-30 p-3 rounded-lg border border-yellow-600">
          <div class="flex items-center">
            <i class="fas fa-exclamation-triangle text-yellow-500 mr-2 text-xs"></i>
            <span class="text-yellow-200 text-xs">Cette facturation sera d√©plac√©e vers "En traitement" apr√®s l'envoi au comptable.</span>
          </div>
        </div>
        
        <!-- Boutons √† droite -->
        <div class="flex gap-4" style="margin-left: 1rem;">
          <button onclick="fermerModal()" class="btn-secondary">
            Annuler
          </button>
          <button onclick="sauvegarderModification()" class="btn-primary no-border">
            Renvoyer au comptable
          </button>
        </div>
      </div>
    </div>
  </div>

</div><!-- Fin de .main-content pour extraction SPA -->

  <!-- Script pour gestion menu actif -->
  <script>
    // Fonction pour activer le menu bas√© sur la page actuelle
    function activateCurrentPageMenu() {
      const currentPath = window.location.pathname;
      log('üåê Page actuelle d√©tect√©e:', currentPath);
      
      const allMenuLinks = document.querySelectorAll('#sidebar a');
      allMenuLinks.forEach(link => {
        link.classList.remove('menu-active');
        link.removeAttribute('data-menu-state');
      });
      
      const pageMap = {
        '/facturationqe': '/facturationqe',
      };
      
      const targetPath = pageMap[currentPath] || currentPath;
      const targetLink = document.querySelector(`#sidebar a[data-path="${targetPath}"]`);
      
      if (targetLink) {
        targetLink.classList.add('menu-active');
        targetLink.setAttribute('data-menu-state', 'active');
        log('[OK] Menu activ√© pour:', targetLink.textContent.trim());
      } else {
        log('[WARN] Aucun menu trouv√© pour la page:', currentPath);
      }
    }

    // Fonctions pour g√©rer le statut des d√©p√¥ts
    function marquerDepotEnvoye(clientId) {
      const depotsEnvoyes = JSON.parse(localStorage.getItem('depotsEnvoyes') || '{}');
      depotsEnvoyes[clientId] = {
        statut: 'envoye',
        dateEnvoi: new Date().toISOString()
      };
      localStorage.setItem('depotsEnvoyes', JSON.stringify(depotsEnvoyes));
      log('[OK] D√©p√¥t marqu√© comme envoy√© pour client:', clientId);
    }

    function marquerDepotTraite(clientId) {
      const depotsEnvoyes = JSON.parse(localStorage.getItem('depotsEnvoyes') || '{}');
      if (depotsEnvoyes[clientId]) {
        depotsEnvoyes[clientId].statut = 'traite';
        depotsEnvoyes[clientId].dateTraitement = new Date().toISOString();
        localStorage.setItem('depotsEnvoyes', JSON.stringify(depotsEnvoyes));
        log('[OK] D√©p√¥t marqu√© comme trait√© pour client:', clientId);
      }
    }

    function getStatutDepot(clientId) {
      // Priorit√© aux donn√©es du client actuel si disponibles
      const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
      if (clientData.num === clientId && clientData.statutDepot) {
        log('[TARGET] Statut d√©p√¥t depuis clientData pour', clientId, ':', clientData.statutDepot);
        return clientData.statutDepot;
      }
      
      // Fallback vers localStorage
      const depotsEnvoyes = JSON.parse(localStorage.getItem('depotsEnvoyes') || '{}');
      const statutFromStorage = depotsEnvoyes[clientId]?.statut || null;
      log('[PACKAGE] Statut d√©p√¥t depuis localStorage pour', clientId, ':', statutFromStorage);
      return statutFromStorage;
    }

    function griserSectionDepot() {
      const contentDepot = document.getElementById('content-depot');
      if (contentDepot) {
        contentDepot.style.opacity = '0.4';
        contentDepot.style.pointerEvents = 'none';
        
        // Griser tous les inputs dans la section d√©p√¥t
        const inputs = contentDepot.querySelectorAll('input, select, button, .modern-dropdown');
        inputs.forEach(input => {
          if (input.tagName === 'INPUT') {
            input.disabled = true;
            input.style.background = 'rgba(55, 65, 81, 0.2)';
            input.style.color = 'rgba(156, 163, 175, 0.6)';
            input.style.cursor = 'not-allowed';
          } else if (input.classList.contains('modern-dropdown')) {
            input.style.pointerEvents = 'none';
            input.style.opacity = '0.5';
          }
        });
        
        log('[OK] Section d√©p√¥t gris√©e et d√©sactiv√©e');
        
        // Afficher les informations de paiement m√™me quand gris√©
        afficherInfosPaiementGrisees('depot');
      }
    }
    
    // Fonction pour rendre la section d√©p√¥t non-modifiable mais visible (pour traitement)
    function rendreSectionDepotNonModifiable() {
      const contentDepot = document.getElementById('content-depot');
      if (contentDepot) {
        // Section reste visible et cliquable (pas d'opacit√© r√©duite)
        contentDepot.style.opacity = '1';
        contentDepot.style.pointerEvents = 'auto';
        
        // Rendre les inputs non-modifiables mais visibles - AVEC !important pour uniformit√©
        const inputs = contentDepot.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
          if (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA') {
            input.readOnly = true;
            input.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
            input.style.setProperty('color', 'var(--text-light)', 'important');
            input.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
            input.style.setProperty('cursor', 'not-allowed', 'important');
            input.style.setProperty('opacity', '0.7', 'important');
            input.style.pointerEvents = 'none';
          }
        });

        // D√©sactiver les dropdowns mais garder le texte visible - AVEC !important pour uniformit√©
        const dropdowns = contentDepot.querySelectorAll('.modern-dropdown');
        dropdowns.forEach(dropdown => {
          dropdown.style.pointerEvents = 'none';
          dropdown.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
          dropdown.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
          dropdown.style.setProperty('cursor', 'not-allowed', 'important');
          dropdown.style.setProperty('opacity', '0.7', 'important');
          const placeholder = dropdown.querySelector('.placeholder');
          if (placeholder) {
            placeholder.style.setProperty('color', 'var(--text-light)', 'important');
          }
        });
        
        log('[OK] Section d√©p√¥t rendue non-modifiable (traitement)');
        
        // Cette fonction peut √™tre appel√©e dans 2 contextes:
        // 1. Au chargement initial (section peut ne pas √™tre active encore)
        // 2. Quand on clique explicitement sur la section d√©p√¥t
        // On doit forcer l'affichage des √©l√©ments d√©p√¥t seulement si on n'est PAS par d√©faut en paiement final
        const elementsAjouterDepot = document.getElementById('elementsAjouterDepot');
        const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
        const statutDepot = clientData.statutDepot || 'non_envoye';
        
        log('[DEBUG] DEBUG - elementsAjouterDepot trouv√©:', elementsAjouterDepot);
        log('[DEBUG] DEBUG - Statut d√©p√¥t:', statutDepot);
        
        // Stocker dans sessionStorage qu'on veut afficher les √©l√©ments d√©p√¥t
        sessionStorage.setItem('showDepotElements', 'true');
        
        if (elementsAjouterDepot) {
          // Forcer tous les styles pour rendre visible avec maximum de priorit√©
          elementsAjouterDepot.style.setProperty('max-height', '1000px', 'important');
          elementsAjouterDepot.style.setProperty('opacity', '1', 'important');
          elementsAjouterDepot.style.setProperty('display', 'block', 'important');
          elementsAjouterDepot.style.setProperty('visibility', 'visible', 'important');
          elementsAjouterDepot.style.setProperty('overflow', 'visible', 'important');
          elementsAjouterDepot.style.setProperty('height', 'auto', 'important');
          elementsAjouterDepot.style.setProperty('position', 'static', 'important');
          elementsAjouterDepot.classList.remove('hidden');
          
          log('[OK] Section √©l√©ments √† ajouter D√âP√îT FORC√âE visible pour traitement');
          log('[DEBUG] DEBUG - Style complet appliqu√©:', elementsAjouterDepot.style.cssText);
          log('[DEBUG] DEBUG - Classes:', elementsAjouterDepot.classList.toString());
        } else {
          log('[ERROR] DEBUG - elementsAjouterDepot non trouv√©!');
        }
        
        // Afficher les champs sp√©cifiques √† la m√©thode de paiement (virement/ch√®que)
        if (clientData.depot && (clientData.depot.methode || clientData.depot.type)) {

          // Utiliser 'methode' en priorit√©, fallback sur 'type' pour compatibilit√©
          const depotMethode = clientData.depot.methode || clientData.depot.type;

          // D'abord, mettre √† jour le dropdown "Pay√© par"
          const payeParToggle = contentDepot.querySelector('.modern-dropdown .placeholder');
          if (payeParToggle) {
            const typeText = depotMethode === 'virement' ? 'Virement' :
                            depotMethode === 'ch√®que' || depotMethode === 'cheque' ? 'Ch√®que' : depotMethode;
            payeParToggle.textContent = typeText;
            log('[OK] Dropdown Pay√© par mis √† jour:', typeText);
          }

          // Debug pour voir les √©l√©ments disponibles de la section D√âP√îT
          const virementFieldsDepot = document.getElementById('virementFieldsDepot');
          const chequeFieldsDepot = document.getElementById('chequeFieldsDepot');

          log('[DEBUG] DEBUG - virementFieldsDepot trouv√©:', virementFieldsDepot);
          log('[DEBUG] DEBUG - chequeFieldsDepot trouv√©:', chequeFieldsDepot);
          log('[DEBUG] DEBUG - M√©thode de paiement:', depotMethode);

          if (depotMethode === 'virement' && virementFieldsDepot) {
            log('[DEBUG] Affichage des champs virement D√âP√îT...');
            log('[DEBUG] virementFieldsDepot trouv√©:', virementFieldsDepot);
            
            // Forcer l'affichage avec !important
            virementFieldsDepot.classList.remove('hidden');
            virementFieldsDepot.style.setProperty('display', 'grid', 'important');
            virementFieldsDepot.style.setProperty('opacity', '1', 'important');
            virementFieldsDepot.style.setProperty('visibility', 'visible', 'important');
            virementFieldsDepot.style.setProperty('max-height', 'none', 'important');
            
            log('[OK] DEBUG - virementFieldsDepot styles forc√©s:', virementFieldsDepot.style.cssText);
            
            // Remplir les champs virement avec les donn√©es
            const lienVirementInput = virementFieldsDepot.querySelector('input[name="lien_virement"]');
            const mdpVirementInput = virementFieldsDepot.querySelector('input[name="mdp_virement"]');
            
            log('[DEBUG] lienVirementInput:', lienVirementInput);
            log('[DEBUG] mdpVirementInput:', mdpVirementInput);
            
            if (lienVirementInput) {
              if (clientData.depot.lienVirement) {
                lienVirementInput.value = clientData.depot.lienVirement;
              }
              lienVirementInput.readOnly = true;
              lienVirementInput.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
              lienVirementInput.style.setProperty('color', 'var(--text-light)', 'important');
              lienVirementInput.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
              lienVirementInput.style.setProperty('cursor', 'not-allowed', 'important');
              lienVirementInput.style.setProperty('opacity', '0.7', 'important');
              lienVirementInput.style.pointerEvents = 'none';
              log('[OK] Lien virement gris√© uniform√©ment');
            }
            if (mdpVirementInput) {
              if (clientData.depot.motDePasse) {
                mdpVirementInput.value = clientData.depot.motDePasse;
              }
              mdpVirementInput.readOnly = true;
              mdpVirementInput.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
              mdpVirementInput.style.setProperty('color', 'var(--text-light)', 'important');
              mdpVirementInput.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
              mdpVirementInput.style.setProperty('cursor', 'not-allowed', 'important');
              mdpVirementInput.style.setProperty('opacity', '0.7', 'important');
              mdpVirementInput.style.pointerEvents = 'none';
              log('[OK] Mot de passe virement gris√© uniform√©ment');
            }
            
            log('[OK] Champs virement D√âP√îT affich√©s et remplis');

          } else if ((depotMethode === 'ch√®que' || depotMethode === 'cheque') && chequeFieldsDepot) {
            // Forcer l'affichage avec !important (comme virement)
            chequeFieldsDepot.classList.remove('hidden');
            chequeFieldsDepot.style.setProperty('display', 'grid', 'important');
            chequeFieldsDepot.style.setProperty('opacity', '1', 'important');
            chequeFieldsDepot.style.setProperty('visibility', 'visible', 'important');
            chequeFieldsDepot.style.setProperty('max-height', 'none', 'important');

            // Remplir les champs ch√®que avec les donn√©es
            const numeroChequeInput = chequeFieldsDepot.querySelector('input[name="num_cheque"]');
            if (numeroChequeInput) {
              if (clientData.depot.numeroCheque) {
                numeroChequeInput.value = clientData.depot.numeroCheque;
              }
              numeroChequeInput.readOnly = true;
              numeroChequeInput.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
              numeroChequeInput.style.setProperty('color', 'var(--text-light)', 'important');
              numeroChequeInput.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
              numeroChequeInput.style.setProperty('cursor', 'not-allowed', 'important');
              numeroChequeInput.style.setProperty('opacity', '0.7', 'important');
              numeroChequeInput.style.pointerEvents = 'none';
            }

            // Griser les dropzones recto/verso avec !important
            const dropzoneRecto = document.getElementById('dropzoneRecto');
            const dropzoneVerso = document.getElementById('dropzoneVerso');
            const previewRecto = document.getElementById('previewRecto');
            const previewVerso = document.getElementById('previewVerso');

            // IMPORTANT: Cacher les previews du paiement final pour √©viter la superposition
            const previewRectoFinal = document.getElementById('previewRectoFinal');
            const previewVersoFinal = document.getElementById('previewVersoFinal');
            if (previewRectoFinal) {
              previewRectoFinal.style.display = 'none';
              console.log('üö´ previewRectoFinal cach√© pour √©viter superposition');
            }
            if (previewVersoFinal) {
              previewVersoFinal.style.display = 'none';
              console.log('üö´ previewVersoFinal cach√© pour √©viter superposition');
            }

            // R√©afficher les previews du d√©p√¥t
            if (previewRecto) {
              previewRecto.style.display = 'block';
              console.log('‚úÖ previewRecto (depot) affich√©');
            }
            if (previewVerso) {
              previewVerso.style.display = 'block';
              console.log('‚úÖ previewVerso (depot) affich√©');
            }

            // DEBUG: V√©rifier les URLs AVANT de g√©n√©rer le HTML
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîç G√âN√âRATION HTML PHOTOS D√âP√îT');
            console.log('Client:', clientData.prenom, clientData.nom);
            console.log('clientData.depot:', clientData.depot);
            console.log('photoRecto:', clientData.depot?.photoRecto);
            console.log('photoVerso:', clientData.depot?.photoVerso);

            // V√©rifier l'√©tat de TOUS les previews
            const allPreviews = [
              {name: 'previewRecto (depot)', el: previewRecto},
              {name: 'previewVerso (depot)', el: previewVerso},
              {name: 'previewRectoFinal', el: document.getElementById('previewRectoFinal')},
              {name: 'previewVersoFinal', el: document.getElementById('previewVersoFinal')}
            ];
            console.log('üìã √âTAT DES PREVIEWS:');
            allPreviews.forEach(p => {
              if (p.el) {
                const style = window.getComputedStyle(p.el);
                console.log(`  ${p.name}:`, {
                  display: style.display,
                  visibility: style.visibility,
                  opacity: style.opacity,
                  zIndex: style.zIndex,
                  innerHTML: p.el.innerHTML.substring(0, 100)
                });
              }
            });
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            if (dropzoneRecto) {
              dropzoneRecto.style.setProperty('opacity', '0.7', 'important');
              dropzoneRecto.style.setProperty('cursor', 'not-allowed', 'important');
              dropzoneRecto.style.setProperty('pointer-events', 'none', 'important');
              dropzoneRecto.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
            }
            if (dropzoneVerso) {
              dropzoneVerso.style.setProperty('opacity', '0.7', 'important');
              dropzoneVerso.style.setProperty('cursor', 'not-allowed', 'important');
              dropzoneVerso.style.setProperty('pointer-events', 'none', 'important');
              dropzoneVerso.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
            }

            if (previewRecto && clientData.depot.photoRecto) {
              previewRecto.innerHTML = `
                <img src="${clientData.depot.photoRecto}"
                     style="width: 80px; height: 60px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid var(--border-dark);"
                     alt="Recto"
                     onclick="ouvrirModalImage('${clientData.depot.photoRecto}', 'Recto du ch√®que - D√©p√¥t')">
              `;
              console.log('‚úÖ HTML G√âN√âR√â pour previewRecto (d√©p√¥t):', previewRecto.innerHTML);
            }
            if (previewVerso && clientData.depot.photoVerso) {
              previewVerso.innerHTML = `
                <img src="${clientData.depot.photoVerso}"
                     style="width: 80px; height: 60px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid var(--border-dark);"
                     alt="Verso"
                     onclick="ouvrirModalImage('${clientData.depot.photoVerso}', 'Verso du ch√®que - D√©p√¥t')">
              `;
              console.log('‚úÖ HTML G√âN√âR√â pour previewVerso (d√©p√¥t):', previewVerso.innerHTML);
            }

            log('[OK] Champs ch√®que affich√©s et remplis avec !important');
          }
        }
        
        // Afficher les informations de paiement
        afficherInfosPaiementGrisees('depot');
      }
    }
    
    // Fonction pour afficher les informations de paiement dans les sections gris√©es
    function afficherInfosPaiementGrisees(section) {
      const clientData = JSON.parse(sessionStorage.getItem('selectedClientData') || '{}');
      let paiementData = null;
      let sectionElement = null;
      
      if (section === 'depot' && clientData.depot) {
        paiementData = clientData.depot;
        sectionElement = document.getElementById('content-depot');
      } else if (section === 'paiement-final' && clientData.paiementFinal) {
        paiementData = clientData.paiementFinal;
        sectionElement = document.getElementById('content-paiement-final');
      } else if (section === 'autres-paiements' && clientData.autresPaiements) {
        paiementData = clientData.autresPaiements;
        sectionElement = document.getElementById('content-autres-paiements');
      }
      
      if (!paiementData || !sectionElement || !paiementData.type) return;
      
      // Trouver o√π ins√©rer les informations de paiement
      const elementsAjouter = sectionElement.querySelector('#elementsAjouter') || 
                             sectionElement.querySelector('.elements-ajouter');
      
      if (!elementsAjouter) return;
      
      // Cr√©er l'affichage des informations selon le type de paiement
      let infoHTML = '';
      
      if (paiementData.type === 'virement') {
        infoHTML = `
          <div class="payment-info-display mt-4 p-4 rounded-lg" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3);">
            <h4 class="text-sm font-semibold mb-3 flex items-center" style="color: var(--text-light);">
              <i class="fas fa-university mr-2 text-blue-400"></i>
              Informations du virement
            </h4>
            <div class="grid grid-cols-1 gap-3">
              <div>
                <label class="block text-xs font-medium mb-1" style="color: var(--text-gray);">Lien de virement</label>
                <div class="p-2 rounded text-sm" style="background: rgba(55, 65, 81, 0.3); color: var(--text-light);">
                  ${paiementData.lienVirement || 'Non sp√©cifi√©'}
                </div>
              </div>
              ${paiementData.motDePasse ? `
              <div>
                <label class="block text-xs font-medium mb-1" style="color: var(--text-gray);">Mot de passe</label>
                <div class="p-2 rounded text-sm" style="background: rgba(55, 65, 81, 0.3); color: var(--text-light);">
                  ${paiementData.motDePasse}
                </div>
              </div>` : ''}
            </div>
          </div>
        `;
      } else if (paiementData.type === 'cheque') {
        infoHTML = `
          <div class="payment-info-display mt-4 p-4 rounded-lg" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);">
            <h4 class="text-sm font-semibold mb-3 flex items-center" style="color: var(--text-light);">
              <i class="fas fa-money-check mr-2 text-green-400"></i>
              Informations du ch√®que
            </h4>
            <div class="grid grid-cols-1 gap-3">
              <div>
                <label class="block text-xs font-medium mb-1" style="color: var(--text-gray);">Num√©ro du ch√®que</label>
                <div class="p-2 rounded text-sm" style="background: rgba(55, 65, 81, 0.3); color: var(--text-light);">
                  ${paiementData.numeroCheque || 'Non sp√©cifi√©'}
                </div>
              </div>
              ${paiementData.photoRecto || paiementData.photoVerso ? `
              <div class="grid grid-cols-2 gap-2">
                ${paiementData.photoRecto ? `
                <div>
                  <label class="block text-xs font-medium mb-1" style="color: var(--text-gray);">Photo recto</label>
                  <div class="h-20 rounded overflow-hidden" style="background: rgba(55, 65, 81, 0.3);">
                    <img src="${paiementData.photoRecto}" alt="Recto ch√®que" class="w-full h-full object-cover">
                  </div>
                </div>` : ''}
                ${paiementData.photoVerso ? `
                <div>
                  <label class="block text-xs font-medium mb-1" style="color: var(--text-gray);">Photo verso</label>
                  <div class="h-20 rounded overflow-hidden" style="background: rgba(55, 65, 81, 0.3);">
                    <img src="${paiementData.photoVerso}" alt="Verso ch√®que" class="w-full h-full object-cover">
                  </div>
                </div>` : ''}
              </div>` : ''}
            </div>
          </div>
        `;
      }
      
      if (infoHTML) {
        // Supprimer l'ancien affichage s'il existe
        const existingInfo = sectionElement.querySelector('.payment-info-display');
        if (existingInfo) {
          existingInfo.remove();
        }
        
        // Ajouter le nouvel affichage
        elementsAjouter.insertAdjacentHTML('afterend', infoHTML);
        log('[OK] Informations de paiement affich√©es pour section', section, 'type:', paiementData.type);
      }
    }
    
    // Fonction pour rendre la section autres paiements non-modifiable mais visible (pour traitement)
    // ========== NOUVELLE GESTION DES PAIEMENTS PARTIELS ==========
    // La section "Autres paiements" ne se grise PLUS jamais
    // Les paiements envoy√©s deviennent des boutons "Paiement Partiel 1, 2, 3..." entre D√©p√¥t et Paiement Final

    function rendreSectionAutresPaiementsNonModifiable() {
      log('[WARN] rendreSectionAutresPaiementsNonModifiable appel√©e');

      const contentAutresPaiements = document.getElementById('content-autres-paiements');
      if (!contentAutresPaiements) return;

      // Obtenir les donn√©es client
      const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
      const elementsAjouterAutres = document.getElementById('elementsAjouterAutres');
      const chequeFieldsAutres = document.getElementById('chequeFieldsAutres');
      const virementFieldsAutres = document.getElementById('virementFieldsAutres');

      // V√©rifier s'il y a un paiement "autres" actif (le premier dans le tableau)
      if (clientData.autresPaiements && clientData.autresPaiements.length > 0) {
        const paiementActif = clientData.autresPaiements[0];
        const enTraitement = paiementActif.statut === 'traitement' || paiementActif.statut === 'attente_comptable';

        if (enTraitement && paiementActif.methode && elementsAjouterAutres) {
          // Forcer l'affichage de la section √©l√©ments √† ajouter
          elementsAjouterAutres.style.setProperty('max-height', '1000px', 'important');
          elementsAjouterAutres.style.setProperty('opacity', '1', 'important');
          elementsAjouterAutres.style.setProperty('display', 'block', 'important');
          elementsAjouterAutres.style.setProperty('visibility', 'visible', 'important');

          if (paiementActif.methode === 'cheque' && chequeFieldsAutres) {
            // Forcer l'affichage des champs ch√®que avec !important
            chequeFieldsAutres.classList.remove('hidden');
            chequeFieldsAutres.style.setProperty('display', 'grid', 'important');
            chequeFieldsAutres.style.setProperty('opacity', '1', 'important');
            chequeFieldsAutres.style.setProperty('visibility', 'visible', 'important');
            chequeFieldsAutres.style.setProperty('max-height', 'none', 'important');

            // Remplir le num√©ro de ch√®que
            const numeroChequeInput = chequeFieldsAutres.querySelector('input[name="num_cheque_autres"]');
            if (numeroChequeInput && paiementActif.numeroCheque) {
              numeroChequeInput.value = paiementActif.numeroCheque;
              numeroChequeInput.readOnly = true;
              numeroChequeInput.style.backgroundColor = 'rgba(55, 65, 81, 0.3)';
              numeroChequeInput.style.color = '#9ca3af';
              numeroChequeInput.style.cursor = 'not-allowed';
            }

            // Afficher les vignettes des photos sous les dropzones
            const dropzoneRectoAutres = document.getElementById('dropzoneRectoAutres');
            const dropzoneVersoAutres = document.getElementById('dropzoneVersoAutres');
            const previewRectoAutres = document.getElementById('previewRectoAutres');
            const previewVersoAutres = document.getElementById('previewVersoAutres');

            if (dropzoneRectoAutres) {
              dropzoneRectoAutres.style.opacity = '0.7';
              dropzoneRectoAutres.style.cursor = 'not-allowed';
              dropzoneRectoAutres.style.pointerEvents = 'none';
            }
            if (dropzoneVersoAutres) {
              dropzoneVersoAutres.style.opacity = '0.7';
              dropzoneVersoAutres.style.cursor = 'not-allowed';
              dropzoneVersoAutres.style.pointerEvents = 'none';
            }

            if (previewRectoAutres && paiementActif.photoRecto) {
              previewRectoAutres.innerHTML = `
                <img src="${paiementActif.photoRecto}"
                     style="width: 80px; height: 60px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid var(--border-dark);"
                     alt="Recto"
                     onclick="ouvrirModalImage('${paiementActif.photoRecto}', 'Recto du ch√®que')">
              `;
            }
            if (previewVersoAutres && paiementActif.photoVerso) {
              previewVersoAutres.innerHTML = `
                <img src="${paiementActif.photoVerso}"
                     style="width: 80px; height: 60px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid var(--border-dark);"
                     alt="Verso"
                     onclick="ouvrirModalImage('${paiementActif.photoVerso}', 'Verso du ch√®que')">
              `;
            }

            log('[OK] Champs ch√®que AUTRES PAIEMENTS forc√©s visibles avec !important');

          } else if (paiementActif.methode === 'virement' && virementFieldsAutres) {
            // Forcer l'affichage des champs virement avec !important
            virementFieldsAutres.classList.remove('hidden');
            virementFieldsAutres.style.setProperty('display', 'grid', 'important');
            virementFieldsAutres.style.setProperty('opacity', '1', 'important');
            virementFieldsAutres.style.setProperty('visibility', 'visible', 'important');

            log('[OK] Champs virement AUTRES PAIEMENTS forc√©s visibles avec !important');
          }
        }
      }
    }

    /**
     * G√©n√®re dynamiquement les boutons "Paiement Partiel 1, 2, 3..." et "Un seul paiement" depuis clientData.autresPaiements[]
     */
    function genererBoutonsPaiementsPartiels(autresPaiements) {
      log('[FIX] genererBoutonsPaiementsPartiels appel√©e avec', autresPaiements.length, 'paiements');

      const btnDepot = document.getElementById('btn-depot');
      const tabSpacing = btnDepot?.parentElement;

      if (!tabSpacing) {
        error('[ERROR] Container non trouv√©');
        return;
      }

      // Supprimer les anciens boutons (paiement partiel ET un seul paiement)
      const anciensBoutons = tabSpacing.querySelectorAll('[id^="btn-paiement-partiel-"], [id^="btn-un-seul-paiement"]');
      anciensBoutons.forEach(btn => btn.remove());

      // S√©parer les paiements par type (inclure les remboursements dans paiementsPartiels)
      const paiementsPartiels = autresPaiements.filter(p => {
        return !p.typePaiementAutres || p.typePaiementAutres === 'paiement_partiel' || p.typePaiementAutres === 'remboursement';
      });
      const paiementsUnSeul = autresPaiements.filter(p => {
        return p.typePaiementAutres === 'un_seul_paiement';
      });

      log(`[DEBUG] ${paiementsPartiels.length} paiements partiels (avec remboursements), ${paiementsUnSeul.length} un seul paiement`);

      // G√©n√©rer boutons pour paiements partiels (SANS les remboursements)
      paiementsPartiels.forEach((paiement, index) => {
        // SKIP les remboursements - ils n'ont pas de bouton de navigation
        if (paiement.typePaiementAutres === 'remboursement') {
          return;
        }

        const numero = index + 1;
        const newButton = document.createElement('button');
        newButton.type = 'button';
        newButton.id = `btn-paiement-partiel-${numero}`;
        newButton.className = 'btn-secondary px-6 py-3 rounded-lg font-semibold transition-all duration-300';
        // Le gap est g√©r√© par le conteneur parent avec display: flex; gap: 0.5rem;
        newButton.onclick = () => showPaiementSection(`paiement-partiel-${numero}`);

        newButton.innerHTML = `<i class="fas fa-coins mr-2"></i>Paiement Partiel ${numero}`;

        // Couleurs selon statut
        if (paiement.statut === 'traite') {
          newButton.style.setProperty('background', 'linear-gradient(135deg, rgb(16, 185, 129), rgb(5, 150, 105))', 'important');
          newButton.style.setProperty('border-color', 'rgb(16, 185, 129)', 'important');
          newButton.style.setProperty('color', 'white', 'important');
        } else if (paiement.statut === 'traitement' || paiement.statut === 'attente_comptable') {
          newButton.style.setProperty('background', 'linear-gradient(135deg, #f59e0b, #d97706)', 'important');
          newButton.style.setProperty('border-color', '#f59e0b', 'important');
          newButton.style.setProperty('color', 'white', 'important');
        }

        const btnPaiementFinal = document.getElementById('btn-paiement-final');
        if (btnPaiementFinal) {
          tabSpacing.insertBefore(newButton, btnPaiementFinal);
        }
      });

      // G√©n√©rer boutons pour "un seul paiement" - SEULEMENT s'il y en a vraiment (SANS les remboursements)
      if (paiementsUnSeul.length > 0) {
        paiementsUnSeul.forEach((paiement, index) => {
          // SKIP les remboursements - ils n'ont pas de bouton de navigation
          if (paiement.typePaiementAutres === 'remboursement') {
            return;
          }

          const numero = index + 1;
          const newButton = document.createElement('button');
          newButton.type = 'button';
          newButton.id = `btn-un-seul-paiement-${numero}`;
          newButton.className = 'btn-secondary px-6 py-3 rounded-lg font-semibold transition-all duration-300';
          newButton.onclick = () => showPaiementSection(`un-seul-paiement-${numero}`);
          newButton.innerHTML = `<i class="fas fa-dollar-sign mr-2"></i>Un seul paiement`;

          // Couleurs selon statut
          if (paiement.statut === 'traite') {
            newButton.style.setProperty('background', 'linear-gradient(135deg, rgb(16, 185, 129), rgb(5, 150, 105))', 'important');
            newButton.style.setProperty('border-color', 'rgb(16, 185, 129)', 'important');
            newButton.style.setProperty('color', 'white', 'important');
          } else if (paiement.statut === 'traitement' || paiement.statut === 'attente_comptable') {
            newButton.style.setProperty('background', 'linear-gradient(135deg, #f59e0b, #d97706)', 'important');
            newButton.style.setProperty('border-color', '#f59e0b', 'important');
            newButton.style.setProperty('color', 'white', 'important');
          }

          const btnPaiementFinal = document.getElementById('btn-paiement-final');
          if (btnPaiementFinal) {
            tabSpacing.insertBefore(newButton, btnPaiementFinal);
          }
        });
      }

      log(`[OK] ${paiementsPartiels.length + paiementsUnSeul.length} boutons cr√©√©s`);
    }

    /**
     * G√©n√®re les sections de contenu pour afficher les infos des paiements partiels et "un seul paiement" (gris√©es/non-modifiables)
     * Structure IDENTIQUE √† "Autres paiements" avec tous les champs gris√©s
     */
    function genererSectionsPaiementsPartiels(autresPaiements) {
      const contentPaiementFinal = document.getElementById('content-paiement-final');
      if (!contentPaiementFinal) return;

      // Supprimer les anciennes sections (paiement partiel ET un seul paiement)
      document.querySelectorAll('[id^="content-paiement-partiel-"], [id^="content-un-seul-paiement-"]').forEach(s => s.remove());

      // S√©parer les paiements par type (inclure les remboursements dans paiementsPartiels)
      const paiementsPartiels = autresPaiements.filter(p => {
        return !p.typePaiementAutres || p.typePaiementAutres === 'paiement_partiel' || p.typePaiementAutres === 'remboursement';
      });
      const paiementsUnSeul = autresPaiements.filter(p => {
        return p.typePaiementAutres === 'un_seul_paiement';
      });

      log(`[FIX] G√©n√©ration sections: ${paiementsPartiels.length} partielles (avec remboursements), ${paiementsUnSeul.length} un seul paiement`);

      // G√©n√©rer sections pour paiements partiels
      paiementsPartiels.forEach((paiement, index) => {
        const numero = index + 1;
        const newSection = document.createElement('div');
        newSection.id = `content-paiement-partiel-${numero}`;
        newSection.className = 'paiement-content hidden';

        // Normaliser la m√©thode (enlever accents: ch√®que ‚Üí cheque)
        const methodeNormalized = paiement.methode ? paiement.methode.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '') : '';

        // Capitaliser la premi√®re lettre de la m√©thode pour affichage
        const methodeCapitalized = paiement.methode ? paiement.methode.charAt(0).toUpperCase() + paiement.methode.slice(1) : 'N/A';

        // Construire les champs virement (gris√©s)
        let virementFields = '';
        const labelType = paiement.typePaiementAutres === 'remboursement' ? 'Remboursement' : `Paiement Partiel ${numero}`;
        if (methodeNormalized === 'virement') {
          virementFields = `
            <div class="overflow-hidden" style="max-height: 1000px; opacity: 1;">
              <h2 class="text-xl font-bold mb-4 border-b pb-2" style="color: var(--text-light); border-color: var(--border-dark);">
                <i class="fas fa-plus mr-2 text-orange-500"></i>
                √âl√©ments √† ajouter - ${labelType}
              </h2>

              <div class="grid grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-link mr-2 text-blue-500"></i>
                    Lien virement
                  </label>
                  <input type="text" value="${paiement.lienVirement || ''}" class="modern-input" disabled style="background: rgba(55, 65, 81, 0.3) !important; color: var(--text-light) !important; cursor: not-allowed !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; pointer-events: none;">
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-lock mr-2 text-red-500"></i>
                    Mot de passe (si diff√©rent)
                  </label>
                  <input type="text" value="${paiement.motDePasse || ''}" class="modern-input" disabled style="background: rgba(55, 65, 81, 0.3) !important; color: var(--text-light) !important; cursor: not-allowed !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; pointer-events: none;">
                </div>
                <div></div>
                <div></div>
              </div>
            </div>
          `;
        }

        // Construire les champs ch√®que (gris√©s)
        let chequeFields = '';
        if (methodeNormalized === 'cheque') {
          chequeFields = `
            <div class="overflow-hidden" style="max-height: 1000px; opacity: 1;">
              <h2 class="text-xl font-bold mb-4 border-b pb-2" style="color: var(--text-light); border-color: var(--border-dark);">
                <i class="fas fa-plus mr-2 text-orange-500"></i>
                √âl√©ments √† ajouter - ${labelType}
              </h2>

              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-image mr-2 text-green-500"></i>
                    Recto du ch√®que
                  </label>
                  <div class="upload-zone-small" style="background: rgba(55, 65, 81, 0.3) !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; cursor: not-allowed; pointer-events: none;">
                    <p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Recto</p>
                  </div>
                  <div class="mt-2" style="pointer-events: auto;">
                    <img src="${paiement.photoRecto}" style="width: 80px; height: 60px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid var(--border-dark);" alt="Recto" onclick="ouvrirModalImage('${paiement.photoRecto}', 'Recto du ch√®que - Paiement Partiel ${numero}')">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-image mr-2 text-orange-500"></i>
                    Verso du ch√®que
                  </label>
                  <div class="upload-zone-small" style="background: rgba(55, 65, 81, 0.3) !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; cursor: not-allowed; pointer-events: none;">
                    <p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Verso</p>
                  </div>
                  <div class="mt-2" style="pointer-events: auto;">
                    <img src="${paiement.photoVerso}" style="width: 80px; height: 60px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid var(--border-dark);" alt="Verso" onclick="ouvrirModalImage('${paiement.photoVerso}', 'Verso du ch√®que - Paiement Partiel ${numero}')">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-hashtag mr-2 text-purple-500"></i>
                    Num√©ro du ch√®que
                  </label>
                  <input type="text" value="${paiement.numeroCheque || ''}" class="modern-input" disabled style="background: rgba(55, 65, 81, 0.3) !important; color: var(--text-light) !important; cursor: not-allowed !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; pointer-events: none;">
                </div>
              </div>
            </div>
          `;
        }

        // Changer le titre si c'est un remboursement
        const titreSection = paiement.typePaiementAutres === 'remboursement'
          ? `<i class="fas fa-undo mr-2 text-red-500"></i>Remboursement`
          : `<i class="fas fa-coins mr-2 text-purple-500"></i>Paiement Partiel ${numero}`;

        newSection.innerHTML = `
          <div style="margin-bottom: 0.5rem;">
            <h2 class="text-xl font-bold inline-flex items-center" style="color: var(--text-light);">
              ${titreSection}
            </h2>
          </div>

          <!-- Barre de s√©paration sous le titre -->
          <div class="border-b mb-5" style="border-color: var(--border-dark);"></div>

          <!-- Champs principaux (sans Type de paiement car c'est d√©j√† un paiement partiel) -->
          <div style="margin-bottom: 6rem;">
            <div class="grid grid-cols-4 gap-4" style="pointer-events: none;">
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-money-bill-wave mr-2 text-green-500"></i>
                  $ Montant
                </label>
                <div class="relative">
                  <input type="text" value="${paiement.montant || '0,00 $'}" class="modern-input pr-10" disabled style="background: rgba(55, 65, 81, 0.3) !important; color: var(--text-light) !important; cursor: not-allowed !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; pointer-events: none;">
                  <span class="absolute right-3 top-1/2 transform -translate-y-1/2 font-medium" style="color: var(--text-gray);">$</span>
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-calendar-alt mr-2 text-purple-500"></i>
                  Date paiement
                </label>
                <input type="text" value="${paiement.date || ''}" class="modern-input" disabled style="background: rgba(55, 65, 81, 0.3) !important; color: var(--text-light) !important; cursor: not-allowed !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; pointer-events: none;">
              </div>
              <div>
                <div class="custom-select">
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-money-check-alt mr-2 text-teal-500"></i>
                    Pay√© par
                  </label>
                  <div class="modern-dropdown" style="background: rgba(55, 65, 81, 0.3) !important; color: var(--text-light) !important; cursor: not-allowed !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; pointer-events: none;">
                    <span style="color: var(--text-light);">${methodeCapitalized}</span>
                    <i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>
                  </div>
                </div>
              </div>
              <div></div>
            </div>
          </div>

          <!-- Section √âl√©ments √† ajouter (si virement ou ch√®que) -->
          ${virementFields}
          ${chequeFields}
        `;

        contentPaiementFinal.parentElement.insertBefore(newSection, contentPaiementFinal);
      });

      // G√©n√©rer sections pour "un seul paiement"
      paiementsUnSeul.forEach((paiement, index) => {
        const numero = index + 1;
        const newSection = document.createElement('div');
        newSection.id = `content-un-seul-paiement-${numero}`;
        newSection.className = 'paiement-content hidden';

        // Normaliser la m√©thode (enlever accents: ch√®que ‚Üí cheque)
        const methodeNormalized = paiement.methode ? paiement.methode.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '') : '';

        // Capitaliser la premi√®re lettre de la m√©thode pour affichage
        const methodeCapitalized = paiement.methode ? paiement.methode.charAt(0).toUpperCase() + paiement.methode.slice(1) : 'N/A';

        // Construire les champs virement (gris√©s)
        let virementFields = '';
        if (methodeNormalized === 'virement') {
          virementFields = `
            <div class="overflow-hidden" style="max-height: 1000px; opacity: 1;">
              <h2 class="text-xl font-bold mb-4 border-b pb-2" style="color: var(--text-light); border-color: var(--border-dark);">
                <i class="fas fa-plus mr-2 text-orange-500"></i>
                √âl√©ments √† ajouter - Un seul paiement
              </h2>

              <div class="grid grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-link mr-2 text-blue-500"></i>
                    Lien virement
                  </label>
                  <input type="text" value="${paiement.lienVirement || ''}" class="modern-input" disabled style="background: rgba(55, 65, 81, 0.3) !important; color: var(--text-light) !important; cursor: not-allowed !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; pointer-events: none;">
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-lock mr-2 text-red-500"></i>
                    Mot de passe (si diff√©rent)
                  </label>
                  <input type="text" value="${paiement.motDePasse || ''}" class="modern-input" disabled style="background: rgba(55, 65, 81, 0.3) !important; color: var(--text-light) !important; cursor: not-allowed !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; pointer-events: none;">
                </div>
                <div></div>
                <div></div>
              </div>
            </div>
          `;
        }

        // Construire les champs ch√®que (gris√©s)
        let chequeFields = '';
        if (methodeNormalized === 'cheque') {
          chequeFields = `
            <div class="overflow-hidden" style="max-height: 1000px; opacity: 1;">
              <h2 class="text-xl font-bold mb-4 border-b pb-2" style="color: var(--text-light); border-color: var(--border-dark);">
                <i class="fas fa-plus mr-2 text-orange-500"></i>
                √âl√©ments √† ajouter - Un seul paiement
              </h2>

              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-image mr-2 text-green-500"></i>
                    Recto du ch√®que
                  </label>
                  <div class="upload-zone-small" style="background: rgba(55, 65, 81, 0.3) !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; cursor: not-allowed; pointer-events: none;">
                    <p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Recto</p>
                  </div>
                  <div class="mt-2" style="pointer-events: auto;">
                    <img src="${paiement.photoRecto}" style="width: 80px; height: 60px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid var(--border-dark);" alt="Recto" onclick="ouvrirModalImage('${paiement.photoRecto}', 'Recto du ch√®que - Un seul paiement')">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-image mr-2 text-orange-500"></i>
                    Verso du ch√®que
                  </label>
                  <div class="upload-zone-small" style="background: rgba(55, 65, 81, 0.3) !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; cursor: not-allowed; pointer-events: none;">
                    <p style="color: var(--text-light);"><i class="fas fa-upload mr-1"></i> Verso</p>
                  </div>
                  <div class="mt-2" style="pointer-events: auto;">
                    <img src="${paiement.photoVerso}" style="width: 80px; height: 60px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid var(--border-dark);" alt="Verso" onclick="ouvrirModalImage('${paiement.photoVerso}', 'Verso du ch√®que - Un seul paiement')">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-hashtag mr-2 text-purple-500"></i>
                    Num√©ro du ch√®que
                  </label>
                  <input type="text" value="${paiement.numeroCheque || ''}" class="modern-input" disabled style="background: rgba(55, 65, 81, 0.3) !important; color: var(--text-light) !important; cursor: not-allowed !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; pointer-events: none;">
                </div>
              </div>
            </div>
          `;
        }

        newSection.innerHTML = `
          <div style="margin-bottom: 0.5rem;">
            <h2 class="text-xl font-bold inline-flex items-center" style="color: var(--text-light);">
              <i class="fas fa-dollar-sign mr-2 text-purple-500"></i>
              Un seul paiement
            </h2>
          </div>

          <!-- Barre de s√©paration sous le titre -->
          <div class="border-b mb-5" style="border-color: var(--border-dark);"></div>

          <!-- Champs principaux (sans Type de paiement car c'est un seul paiement) -->
          <div style="margin-bottom: 6rem;">
            <div class="grid grid-cols-4 gap-4" style="pointer-events: none;">
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-money-bill-wave mr-2 text-green-500"></i>
                  $ Montant
                </label>
                <div class="relative">
                  <input type="text" value="${paiement.montant || '0,00 $'}" class="modern-input pr-10" disabled style="background: rgba(55, 65, 81, 0.3) !important; color: var(--text-light) !important; cursor: not-allowed !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; pointer-events: none;">
                  <span class="absolute right-3 top-1/2 transform -translate-y-1/2 font-medium" style="color: var(--text-gray);">$</span>
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                  <i class="fas fa-calendar-alt mr-2 text-purple-500"></i>
                  Date paiement
                </label>
                <input type="text" value="${paiement.date || ''}" class="modern-input" disabled style="background: rgba(55, 65, 81, 0.3) !important; color: var(--text-light) !important; cursor: not-allowed !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; pointer-events: none;">
              </div>
              <div>
                <div class="custom-select">
                  <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
                    <i class="fas fa-money-check-alt mr-2 text-teal-500"></i>
                    Pay√© par
                  </label>
                  <div class="modern-dropdown" style="background: rgba(55, 65, 81, 0.3) !important; color: var(--text-light) !important; cursor: not-allowed !important; border-color: rgba(75, 85, 99, 0.3) !important; opacity: 0.7 !important; pointer-events: none;">
                    <span style="color: var(--text-light);">${methodeCapitalized}</span>
                    <i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>
                  </div>
                </div>
              </div>
              <div></div>
            </div>
          </div>

          <!-- Section √âl√©ments √† ajouter (si virement ou ch√®que) -->
          ${virementFields}
          ${chequeFields}
        `;

        contentPaiementFinal.parentElement.insertBefore(newSection, contentPaiementFinal);
      });

      log(`[OK] ${paiementsPartiels.length + paiementsUnSeul.length} sections cr√©√©es avec structure identique`);
    }

    /**
     * Ajoute les badges de statut aux titres D√©p√¥t et Paiement Final
     */
    function ajouterBadgesStatutTitres(clientData) {
      // Badge pour D√©p√¥t
      const titreDepot = document.querySelector('#content-depot h2');
      if (titreDepot) {
        const statutDepot = clientData.depot?.statut || clientData.statutDepot || 'non_envoye';
        let badgeDepot = '';

        if (statutDepot === 'traite') {
          // Pas de badge pour trait√© - le bouton vert suffit
          badgeDepot = '';
        } else if (statutDepot === 'traite_attente_final') {
          // Pour l'entrepreneur, pas de badge sp√©cial - juste vert sans texte
          badgeDepot = '';
        } else if (statutDepot === 'attente_comptable') {
          // Pour l'entrepreneur, attente_comptable = vert (valid√© par coach) - pas de badge sp√©cial
          badgeDepot = '';
        } else if (statutDepot === 'traitement') {
          badgeDepot = '<span class="px-3 py-1 text-xs rounded-full ml-3" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b;">En traitement</span>';
        } else if (statutDepot === 'envoye') {
          badgeDepot = '<span class="px-3 py-1 text-xs rounded-full ml-3" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6;">üì§ Envoy√©</span>';
        }

        titreDepot.innerHTML = `
          <i class="fas fa-piggy-bank mr-2 text-blue-500"></i>
          D√©p√¥t
          ${badgeDepot}
        `;
      }

      // Badge pour Paiement Final
      const titrePaiementFinal = document.querySelector('#content-paiement-final h2');
      if (titrePaiementFinal) {
        const statutPaiementFinal = clientData.paiementFinal?.statut || clientData.statutPaiementFinal;
        let badgePaiementFinal = '';

        if (statutPaiementFinal === 'traite') {
          // Pas de badge pour trait√© - le bouton vert suffit
          badgePaiementFinal = '';
        } else if (statutPaiementFinal === 'attente_comptable') {
          // Pour l'entrepreneur, attente_comptable = vert (valid√© par coach) - pas de badge sp√©cial
          badgePaiementFinal = '';
        } else if (statutPaiementFinal === 'traitement') {
          // Pas de badge pour en traitement - le bouton orange suffit
          badgePaiementFinal = '';
        }

        titrePaiementFinal.innerHTML = `
          <i class="fas fa-check-circle mr-2 text-green-500"></i>
          Paiement final
          ${badgePaiementFinal}
        `;
      }
    }

    /**
     * G√®re la visibilit√© des options du dropdown "Type de paiement" selon le statut du d√©p√¥t
     * - Si le d√©p√¥t est en traitement/trait√©/attente_comptable: cacher "Un seul paiement", afficher "Paiement partiel"
     * - Si le d√©p√¥t n'est pas en traitement: afficher "Un seul paiement", cacher "Paiement partiel"
     */
    function gererVisibiliteUnSeulPaiement() {
      const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
      const statutDepot = clientData.statutDepot || 'non_envoye';
      const optionUnSeulPaiement = document.getElementById('option-un-seul-paiement');
      const optionPaiementPartiel = document.getElementById('option-paiement-partiel');

      const depotEnTraitement = statutDepot === 'traitement' || statutDepot === 'attente_comptable' || statutDepot === 'traite_attente_final' || statutDepot === 'traite';

      // G√©rer l'option "Un seul paiement"
      if (optionUnSeulPaiement) {
        if (depotEnTraitement) {
          optionUnSeulPaiement.style.display = 'none';
          log('üö´ Option "Un seul paiement" cach√©e (d√©p√¥t en', statutDepot + ')');
        } else {
          optionUnSeulPaiement.style.display = 'block';
          log('[OK] Option "Un seul paiement" affich√©e (d√©p√¥t:', statutDepot + ')');
        }
      }

      // G√©rer l'option "Paiement partiel" - disponible seulement si d√©p√¥t en traitement
      if (optionPaiementPartiel) {
        if (depotEnTraitement) {
          optionPaiementPartiel.style.display = 'block';
          log('[OK] Option "Paiement partiel" affich√©e (d√©p√¥t en', statutDepot + ')');
        } else {
          optionPaiementPartiel.style.display = 'none';
          log('üö´ Option "Paiement partiel" cach√©e (d√©p√¥t:', statutDepot + ')');
        }
      }
    }

    /**
     * Pr√©-s√©lectionne automatiquement "Paiement partiel" si le d√©p√¥t est en traitement/trait√©
     */
    function preselectionnerPaiementPartielSiNecessaire() {
      const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
      const statutDepot = clientData.statutDepot || 'non_envoye';
      const typePaiementAutresToggle = document.getElementById('typePaiementAutresToggle');

      if (!typePaiementAutresToggle) return;

      // Si le d√©p√¥t est en traitement, attente_comptable, traite_attente_final ou trait√©, pr√©-s√©lectionner "Paiement partiel"
      if (statutDepot === 'traitement' || statutDepot === 'attente_comptable' || statutDepot === 'traite_attente_final' || statutDepot === 'traite') {
        // V√©rifier si rien n'est d√©j√† s√©lectionn√© (cherche le placeholder)
        const hasPlaceholder = typePaiementAutresToggle.innerHTML.includes('Choisir le type');

        if (hasPlaceholder) {
          // Pr√©-s√©lectionner "Paiement partiel"
          typePaiementAutresToggle.innerHTML = '<span style="color: var(--text-light);">Paiement partiel</span><i class="fas fa-chevron-down" style="color: var(--text-gray);"></i>';
          typePaiementAutresToggle.setAttribute('data-value', 'paiement_partiel');

          // Adapter les boutons pour afficher le bon layout
          adapterBoutonsPaiement('paiement_partiel');

          log('[OK] "Paiement partiel" pr√©-s√©lectionn√© automatiquement (d√©p√¥t en', statutDepot + ')');
        }
      }
    }

    /**
     * Marque un paiement partiel comme trait√©
     */
    async function marquerPaiementPartielTraite(paiementId) {
      try {
        const username = getFacturationUsername();
        const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');

        const response = await fetch(`/api/facturationqe/marquer-traite/${username}/${clientData.num}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: 'autres_paiements', paiementId })
        });

        if (!response.ok) throw new Error(`Erreur ${response.status}`);

        await chargerFacturationsDepuisAPI();
        if (typeof selectionnerClientFacturation === 'function') {
          const updated = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
          await selectionnerClientFacturation(clientData.num, `${updated.prenom} ${updated.nom}`, updated);
        }
      } catch (error) {
        error('Erreur:', error);
        alert('Erreur lors du marquage comme trait√©');
      }
    }

    // Fonction pour rendre la section paiement final non-modifiable mais visible (pour traitement)
    function rendreSectionPaiementFinalNonModifiable() {
      const contentPaiementFinal = document.getElementById('content-paiement-final');
      if (contentPaiementFinal) {
        // Section reste visible et cliquable (pas d'opacit√© r√©duite)
        contentPaiementFinal.style.opacity = '1';
        contentPaiementFinal.style.pointerEvents = 'auto';

        // Rendre les inputs non-modifiables mais visibles - AVEC !important pour uniformit√©
        const inputs = contentPaiementFinal.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
          if (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA') {
            input.readOnly = true;
            input.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
            input.style.setProperty('color', 'var(--text-light)', 'important');
            input.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
            input.style.setProperty('cursor', 'not-allowed', 'important');
            input.style.setProperty('opacity', '0.7', 'important');
            input.style.pointerEvents = 'none';
            // Retirer placeholder pour champs vides si gris√©s
            if (input.value === '' && (input.name === 'mdp_virement_final' || input.name === 'mdp_virement')) {
              input.placeholder = '';
            }
          }
        });

        // D√©sactiver les dropdowns mais garder le texte visible - AVEC !important pour uniformit√©
        const dropdowns = contentPaiementFinal.querySelectorAll('.modern-dropdown');
        dropdowns.forEach(dropdown => {
          dropdown.style.pointerEvents = 'none';
          dropdown.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
          dropdown.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
          dropdown.style.setProperty('cursor', 'not-allowed', 'important');
          dropdown.style.setProperty('opacity', '0.7', 'important');
          const placeholder = dropdown.querySelector('.placeholder');
          if (placeholder) {
            placeholder.style.setProperty('color', 'var(--text-light)', 'important');
          }
        });
        
        log('[OK] Section paiement final rendue non-modifiable (traitement)');
        
        // Obtenir les donn√©es client pour afficher les champs virement/ch√®que avec auto-grisage
        const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataFacturation') || '{}');
        const elementsAjouterPaiementFinal = document.getElementById('elementsAjouterPaiementFinal');
        
        // V√©rifier si le paiement final est en traitement, attente_comptable ou trait√©
        const statutPaiementFinalSection = clientData.paiementFinal?.statut || clientData.statutPaiementFinal;
        const paiementFinalEnTraitement = statutPaiementFinalSection === 'traitement' || statutPaiementFinalSection === 'attente_comptable' || statutPaiementFinalSection === 'traite';

        const paiementFinalMethode = clientData.paiementFinal?.methode || clientData.paiementFinal?.type;

        if (elementsAjouterPaiementFinal && clientData.paiementFinal && paiementFinalMethode && paiementFinalEnTraitement) {
          // Forcer l'affichage de la section √©l√©ments √† ajouter SEULEMENT si en traitement/attente_comptable
          elementsAjouterPaiementFinal.style.setProperty('max-height', '1000px', 'important');
          elementsAjouterPaiementFinal.style.setProperty('opacity', '1', 'important');
          elementsAjouterPaiementFinal.style.setProperty('display', 'block', 'important');
          elementsAjouterPaiementFinal.style.setProperty('visibility', 'visible', 'important');
          elementsAjouterPaiementFinal.style.setProperty('overflow', 'visible', 'important');
          elementsAjouterPaiementFinal.style.setProperty('height', 'auto', 'important');

          log('[OK] Section √©l√©ments √† ajouter PAIEMENT FINAL FORC√âE visible pour traitement/attente_comptable');

          const virementFieldsPaiementFinal = document.getElementById('virementFieldsPaiementFinal');
          const chequeFieldsPaiementFinal = document.getElementById('chequeFieldsPaiementFinal');

          if (paiementFinalMethode === 'virement' && virementFieldsPaiementFinal) {
            // Afficher et griser les champs virement paiement final
            virementFieldsPaiementFinal.classList.remove('hidden');
            virementFieldsPaiementFinal.style.setProperty('display', 'grid', 'important');
            virementFieldsPaiementFinal.style.setProperty('opacity', '1', 'important');
            virementFieldsPaiementFinal.style.setProperty('visibility', 'visible', 'important');
            
            // Remplir et griser TOUS les champs virement - AVEC !important pour uniformit√©
            const lienVirementFinal = virementFieldsPaiementFinal.querySelector('input[name="lien_virement_final"]');
            const mdpVirementFinal = virementFieldsPaiementFinal.querySelector('input[name="mdp_virement_final"]');

            if (lienVirementFinal) {
              if (clientData.paiementFinal.lienVirement) {
                lienVirementFinal.value = clientData.paiementFinal.lienVirement;
              }
              lienVirementFinal.readOnly = true;
              lienVirementFinal.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
              lienVirementFinal.style.setProperty('color', 'var(--text-light)', 'important');
              lienVirementFinal.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
              lienVirementFinal.style.setProperty('cursor', 'not-allowed', 'important');
              lienVirementFinal.style.setProperty('opacity', '0.7', 'important');
              lienVirementFinal.style.pointerEvents = 'none';
              log('[OK] Lien virement final gris√©');
            }

            if (mdpVirementFinal) {
              if (clientData.paiementFinal.motDePasse) {
                mdpVirementFinal.value = clientData.paiementFinal.motDePasse;
              } else {
                // Retirer placeholder si vide et gris√©
                mdpVirementFinal.placeholder = '';
              }
              mdpVirementFinal.readOnly = true;
              mdpVirementFinal.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
              mdpVirementFinal.style.setProperty('color', 'var(--text-light)', 'important');
              mdpVirementFinal.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
              mdpVirementFinal.style.setProperty('cursor', 'not-allowed', 'important');
              mdpVirementFinal.style.setProperty('opacity', '0.7', 'important');
              mdpVirementFinal.style.pointerEvents = 'none';
              log('[OK] Mot de passe virement final gris√©');
            }
            
            log('[OK] Champs virement PAIEMENT FINAL gris√©s automatiquement');

          } else if ((paiementFinalMethode === 'ch√®que' || paiementFinalMethode === 'cheque') && chequeFieldsPaiementFinal) {
            // Afficher et griser les champs ch√®que paiement final - FORCER avec !important
            chequeFieldsPaiementFinal.classList.remove('hidden');
            chequeFieldsPaiementFinal.style.setProperty('display', 'grid', 'important');
            chequeFieldsPaiementFinal.style.setProperty('opacity', '1', 'important');
            chequeFieldsPaiementFinal.style.setProperty('visibility', 'visible', 'important');
            chequeFieldsPaiementFinal.style.setProperty('max-height', 'none', 'important');

            const numeroChequeInput = chequeFieldsPaiementFinal.querySelector('input[name="num_cheque_final"]');
            if (numeroChequeInput) {
              if (clientData.paiementFinal.numeroCheque) {
                numeroChequeInput.value = clientData.paiementFinal.numeroCheque;
              }
              numeroChequeInput.readOnly = true;
              numeroChequeInput.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
              numeroChequeInput.style.setProperty('color', 'var(--text-light)', 'important');
              numeroChequeInput.style.setProperty('border-color', 'rgba(75, 85, 99, 0.3)', 'important');
              numeroChequeInput.style.setProperty('cursor', 'not-allowed', 'important');
              numeroChequeInput.style.setProperty('opacity', '0.7', 'important');
              numeroChequeInput.style.pointerEvents = 'none';
            }

            // Griser les dropzones recto/verso avec !important
            const dropzoneRectoFinal = document.getElementById('dropzoneRectoFinal');
            const dropzoneVersoFinal = document.getElementById('dropzoneVersoFinal');
            const previewRectoFinal = document.getElementById('previewRectoFinal');
            const previewVersoFinal = document.getElementById('previewVersoFinal');

            // IMPORTANT: Cacher les previews du d√©p√¥t pour √©viter la superposition
            const previewRectoDepot = document.getElementById('previewRecto');
            const previewVersoDepot = document.getElementById('previewVerso');
            if (previewRectoDepot) {
              previewRectoDepot.style.display = 'none';
              console.log('üö´ previewRecto (depot) cach√© pour √©viter superposition');
            }
            if (previewVersoDepot) {
              previewVersoDepot.style.display = 'none';
              console.log('üö´ previewVerso (depot) cach√© pour √©viter superposition');
            }

            // R√©afficher les previews du paiement final
            if (previewRectoFinal) {
              previewRectoFinal.style.display = 'block';
              console.log('‚úÖ previewRectoFinal affich√©');
            }
            if (previewVersoFinal) {
              previewVersoFinal.style.display = 'block';
              console.log('‚úÖ previewVersoFinal affich√©');
            }

            if (dropzoneRectoFinal) {
              dropzoneRectoFinal.style.setProperty('opacity', '0.7', 'important');
              dropzoneRectoFinal.style.setProperty('cursor', 'not-allowed', 'important');
              dropzoneRectoFinal.style.setProperty('pointer-events', 'none', 'important');
              dropzoneRectoFinal.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
            }
            if (dropzoneVersoFinal) {
              dropzoneVersoFinal.style.setProperty('opacity', '0.7', 'important');
              dropzoneVersoFinal.style.setProperty('cursor', 'not-allowed', 'important');
              dropzoneVersoFinal.style.setProperty('pointer-events', 'none', 'important');
              dropzoneVersoFinal.style.setProperty('background', 'rgba(55, 65, 81, 0.3)', 'important');
            }

            if (previewRectoFinal && clientData.paiementFinal.photoRecto) {
              previewRectoFinal.innerHTML = `
                <img src="${clientData.paiementFinal.photoRecto}"
                     style="width: 80px; height: 60px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid var(--border-dark);"
                     alt="Recto"
                     onclick="ouvrirModalImage('${clientData.paiementFinal.photoRecto}', 'Recto du ch√®que - Paiement Final')">
              `;
            }
            if (previewVersoFinal && clientData.paiementFinal.photoVerso) {
              previewVersoFinal.innerHTML = `
                <img src="${clientData.paiementFinal.photoVerso}"
                     style="width: 80px; height: 60px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid var(--border-dark);"
                     alt="Verso"
                     onclick="ouvrirModalImage('${clientData.paiementFinal.photoVerso}', 'Verso du ch√®que - Paiement Final')">
              `;
            }

            log('[OK] Champs ch√®que PAIEMENT FINAL gris√©s automatiquement avec !important');
          }
        }
        
        // Afficher les informations de paiement
        afficherInfosPaiementGrisees('paiement-final');
      }
    }

    function changerBoutonDepotStatut(statut) {
      const btnDepot = document.getElementById('btn-depot');
      if (btnDepot) {
        // Enlever les anciennes classes
        btnDepot.classList.remove('btn-secondary', 'btn-primary');
        
        // Mettre √† jour l'√©tat r√©el du client
        const numeroSoumission = sessionStorage.getItem('selectedClientFacturation');
        if (numeroSoumission) {
          mettreAJourEtatReelClient(numeroSoumission, { statutDepot: statut });
        }
        
        if (statut === 'envoye') {
          // Orange pour "envoy√©" 
          // Garder les classes originales et juste surcharger les couleurs
          btnDepot.classList.remove('btn-secondary', 'btn-primary');
          btnDepot.classList.add('btn-secondary'); // Remettre la classe de base
          
          // Appliquer seulement les changements n√©cessaires
          btnDepot.style.setProperty('background', 'linear-gradient(135deg, rgb(245, 158, 11), rgb(217, 119, 6))', 'important');
          btnDepot.style.setProperty('border-color', 'rgb(245, 158, 11)', 'important');
          btnDepot.style.setProperty('color', 'white', 'important');
          btnDepot.style.setProperty('cursor', 'not-allowed', 'important');
          
          btnDepot.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Envoy√©';
          btnDepot.disabled = true;
        } else if (statut === 'traitement') {
          // Orange pour "en traitement" (comme paiements partiels) - CLIQUABLE
          btnDepot.classList.remove('btn-secondary', 'btn-primary');
          btnDepot.classList.add('btn-secondary'); // Classe de base normale

          // Appliquer le style orange
          btnDepot.style.setProperty('background', 'linear-gradient(135deg, #f59e0b, #d97706)', 'important');
          btnDepot.style.setProperty('border-color', '#f59e0b', 'important');
          btnDepot.style.setProperty('color', 'white', 'important');
          btnDepot.style.setProperty('cursor', 'pointer', 'important');

          btnDepot.innerHTML = '<i class="fas fa-piggy-bank mr-2"></i>D√©p√¥t';
          btnDepot.disabled = false;  // Reste cliquable
        } else if (statut === 'traite') {
          // Vert pour "trait√©"
          // Garder les classes originales et juste surcharger les couleurs
          btnDepot.classList.remove('btn-secondary', 'btn-primary');
          btnDepot.classList.add('btn-secondary'); // Remettre la classe de base

          // Appliquer seulement les changements n√©cessaires
          btnDepot.style.setProperty('background', 'linear-gradient(135deg, rgb(16, 185, 129), rgb(5, 150, 105))', 'important');
          btnDepot.style.setProperty('border-color', 'rgb(16, 185, 129)', 'important');
          btnDepot.style.setProperty('color', 'white', 'important');
          btnDepot.style.setProperty('cursor', 'not-allowed', 'important');

          btnDepot.innerHTML = '<i class="fas fa-piggy-bank mr-2"></i>D√©p√¥t';
          btnDepot.disabled = true;
        } else if (statut === 'attente_comptable') {
          // Orange pour "attente comptable" (valid√© par coach, pas encore par direction)
          btnDepot.classList.remove('btn-secondary', 'btn-primary');
          btnDepot.classList.add('btn-secondary');

          btnDepot.style.setProperty('background', 'linear-gradient(135deg, #f59e0b, #d97706)', 'important');
          btnDepot.style.setProperty('border-color', '#f59e0b', 'important');
          btnDepot.style.setProperty('color', 'white', 'important');
          btnDepot.style.setProperty('cursor', 'pointer', 'important');

          btnDepot.innerHTML = '<i class="fas fa-piggy-bank mr-2"></i>D√©p√¥t';
          btnDepot.disabled = false;
          log('[ORANGE] Bouton d√©p√¥t mis en mode attente_comptable (orange - en attente direction)');
        } else if (statut === 'traite_attente_final') {
          // Vert pour "traite_attente_final" - direction a valid√© le d√©p√¥t
          btnDepot.classList.remove('btn-secondary', 'btn-primary');
          btnDepot.classList.add('btn-secondary');

          btnDepot.style.setProperty('background', 'linear-gradient(135deg, rgb(16, 185, 129), rgb(5, 150, 105))', 'important');
          btnDepot.style.setProperty('border-color', 'rgb(16, 185, 129)', 'important');
          btnDepot.style.setProperty('color', 'white', 'important');
          btnDepot.style.setProperty('cursor', 'pointer', 'important');

          btnDepot.innerHTML = '<i class="fas fa-piggy-bank mr-2"></i>D√©p√¥t';
          btnDepot.disabled = false;
          log('[GREEN] Bouton d√©p√¥t mis en mode traite_attente_final (vert - valid√© par direction)');
        } else {
          // Statut non reconnu - remettre le bouton √† l'√©tat par d√©faut
          btnDepot.style.removeProperty('background');
          btnDepot.style.removeProperty('border-color');
          btnDepot.style.removeProperty('color');
          btnDepot.style.removeProperty('cursor');
          btnDepot.innerHTML = '<i class="fas fa-piggy-bank mr-2"></i>D√©p√¥t';
          btnDepot.disabled = false;
          btnDepot.classList.add('btn-secondary');
          log('[WARN] Statut d√©p√¥t non reconnu:', statut, '- remise √† l\'√©tat par d√©faut');
        }
        
        log('[OK] Bouton d√©p√¥t chang√© en statut:', statut);
      }
    }

    // Fonction pour changer l'apparence du bouton paiement final selon son statut
    function changerBoutonPaiementFinalStatut(statutPaiementFinal) {
      const btnPaiementFinal = document.getElementById('btn-paiement-final');
      if (btnPaiementFinal) {
        // R√©initialiser d'abord
        btnPaiementFinal.classList.remove('btn-secondary', 'btn-primary');
        btnPaiementFinal.style.removeProperty('background');
        
        // Mettre √† jour l'√©tat r√©el du client
        const numeroSoumission = sessionStorage.getItem('selectedClientFacturation');
        if (numeroSoumission) {
          mettreAJourEtatReelClient(numeroSoumission, { statutPaiementFinal: statutPaiementFinal });
        }
        btnPaiementFinal.style.removeProperty('border-color');
        btnPaiementFinal.style.removeProperty('color');
        btnPaiementFinal.style.removeProperty('cursor');
        btnPaiementFinal.disabled = false;
        
        if (statutPaiementFinal === 'traitement') {
          // Orange pour "en traitement"
          btnPaiementFinal.classList.add('btn-secondary');
          btnPaiementFinal.style.setProperty('background', 'linear-gradient(135deg, rgb(245, 158, 11), rgb(217, 119, 6))', 'important');
          btnPaiementFinal.style.setProperty('border-color', 'rgb(245, 158, 11)', 'important');
          btnPaiementFinal.style.setProperty('color', 'white', 'important');
          btnPaiementFinal.style.setProperty('cursor', 'pointer', 'important');

          btnPaiementFinal.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Paiement final';
          log('[ORANGE] Bouton paiement final mis en mode traitement (orange)');
        } else if (statutPaiementFinal === 'attente_comptable') {
          // Orange pour "attente comptable" (valid√© par coach, en attente direction) - ACTIF
          btnPaiementFinal.classList.add('btn-secondary');
          btnPaiementFinal.style.setProperty('background', 'linear-gradient(135deg, rgb(245, 158, 11), rgb(217, 119, 6))', 'important');
          btnPaiementFinal.style.setProperty('border-color', 'rgb(245, 158, 11)', 'important');
          btnPaiementFinal.style.setProperty('color', 'white', 'important');
          btnPaiementFinal.style.setProperty('cursor', 'pointer', 'important');

          btnPaiementFinal.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Paiement final';
          btnPaiementFinal.disabled = false;
          log('[ORANGE] Bouton paiement final mis en mode attente_comptable (orange - en attente direction - ACTIF)');
        } else if (statutPaiementFinal === 'traite' || statutPaiementFinal === 'traite_attente_final') {
          // Vert pour "trait√©" ou "traite_attente_final" (valid√© par direction) - RESTE CLIQUABLE
          btnPaiementFinal.classList.add('btn-secondary');
          btnPaiementFinal.style.setProperty('background', 'linear-gradient(135deg, rgb(16, 185, 129), rgb(5, 150, 105))', 'important');
          btnPaiementFinal.style.setProperty('border-color', 'rgb(16, 185, 129)', 'important');
          btnPaiementFinal.style.setProperty('color', 'white', 'important');
          btnPaiementFinal.style.setProperty('cursor', 'pointer', 'important');

          btnPaiementFinal.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Paiement final';
          btnPaiementFinal.disabled = false;
          log('[GREEN] Bouton paiement final mis en mode trait√© (vert - ACTIF)');
        } else {
          // Style normal pour autres statuts
          btnPaiementFinal.classList.add('btn-secondary');
          btnPaiementFinal.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Paiement final';
          log('[WHITE] Bouton paiement final en mode normal');
        }
        
        log('[OK] Bouton paiement final chang√© en statut:', statutPaiementFinal);
      }
    }

    function ouvrirPaiementFinalParDefaut(clientId) {
      const statut = getStatutDepot(clientId);
      if (statut === 'envoye' || statut === 'traite' || statut === 'traitement') {
        // Masquer la section d√©p√¥t
        const contentDepot = document.getElementById('content-depot');
        if (contentDepot) {
          contentDepot.classList.add('hidden');
        }
        
        // Ouvrir la section paiement final
        showPaiementSection('paiement-final');
        
        log('[OK] Paiement final ouvert par d√©faut car d√©p√¥t', statut);
      }
    }

    // Mode Facturation - affiche uniquement la page facturation
    function activerModeFacturation() {
      // Masquer compl√®tement la page remboursement
      const pageRemboursement = document.getElementById('page-remboursement');
      if (pageRemboursement) pageRemboursement.style.display = 'none';
      
      // Afficher uniquement la page facturation
      const pageFacturation = document.getElementById('page-facturation');
      if (pageFacturation) pageFacturation.style.display = 'block';
      
      // Styles des boutons
      const btnFacturation = document.getElementById('btn-mode-facturation');
      const btnRemboursement = document.getElementById('btn-mode-remboursement');
      
      btnFacturation.classList.remove('btn-secondary');
      btnFacturation.classList.add('btn-primary');
      
      btnRemboursement.classList.remove('btn-primary');
      btnRemboursement.classList.add('btn-secondary');
      btnRemboursement.style.removeProperty('background');
      btnRemboursement.style.removeProperty('border-color');
      btnRemboursement.style.removeProperty('color');

      // Charger les clients facturation depuis soumissions sign√©es (tous les statuts)
      chargerClientsDepuisAPI();

      log('[OK] Mode Facturation activ√© - Page ind√©pendante');
    }

    // Mode Remboursement - affiche uniquement la page remboursement
    function activerModeRemboursement() {
      // Masquer compl√®tement la page facturation
      const pageFacturation = document.getElementById('page-facturation');
      if (pageFacturation) pageFacturation.style.display = 'none';
      
      // Afficher uniquement la page remboursement
      const pageRemboursement = document.getElementById('page-remboursement');
      if (pageRemboursement) pageRemboursement.style.display = 'block';
      
      // Charger les clients depuis soumissions_signees original
      chargerClientsRemboursement();
      
      // Styles des boutons
      const btnFacturation = document.getElementById('btn-mode-facturation');
      const btnRemboursement = document.getElementById('btn-mode-remboursement');
      
      btnFacturation.classList.remove('btn-primary');
      btnFacturation.classList.add('btn-secondary');
      
      btnRemboursement.classList.remove('btn-secondary');
      btnRemboursement.classList.add('btn-primary');
      btnRemboursement.style.setProperty('background', 'linear-gradient(135deg, #ef4444, #dc2626)', 'important');
      btnRemboursement.style.setProperty('border-color', '#ef4444', 'important');
      btnRemboursement.style.setProperty('color', 'white', 'important');
      
      log('[OK] Mode Remboursement activ√© - Page ind√©pendante');
    }

    // Variables pour la recherche remboursement
    window.clientsRemboursementData = [];
    let clientsRemboursementFiltres = [];

    // Fonction pour ouvrir le menu remboursement
    function ouvrirMenuRemboursement() {
      log('[UNLOCK] Tentative ouverture menu remboursement');
      const menu = document.getElementById('clientMenuRemboursement');
      if (menu) {
        log('[OK] Menu trouv√©, suppression classe hidden');
        
        // Si les clients ne sont pas charg√©s, les charger
        if (window.clientsRemboursementData.length === 0) {
          log('üì• Chargement des clients remboursement...');
          chargerClientsRemboursement();
        } else {
          log('[BAN] Clients d√©j√† charg√©s:', window.clientsRemboursementData.length);
          // R√©afficher les clients filtr√©s
          afficherClientsRemboursementFiltres();
        }
        
        menu.classList.remove('hidden');
      } else {
        error('[ERROR] Menu remboursement non trouv√©');
      }
    }

    // Fonction pour fermer le menu remboursement
    function fermerMenuRemboursement() {
      const menu = document.getElementById('clientMenuRemboursement');
      if (menu) {
        menu.classList.add('hidden');
      }
    }

    // Fermer le menu si on clique ailleurs
    document.addEventListener('click', function(event) {
      const input = document.getElementById('clientSearchRemboursement');
      const menu = document.getElementById('clientMenuRemboursement');
      
      if (input && menu) {
        // Si on clique pas sur l'input ni sur le menu, fermer
        if (event.target !== input && !menu.contains(event.target)) {
          fermerMenuRemboursement();
        }
      }
    });

    // Fonction de recherche pour les clients remboursement
    function rechercherClientsRemboursement(searchTerm) {
      log('[DEBUG] Recherche remboursement:', searchTerm);
      
      if (!searchTerm || searchTerm.length === 0) {
        // Afficher tous les clients si recherche vide
        clientsRemboursementFiltres = [...clientsRemboursementData];
      } else {
        // Filtrer par nom, pr√©nom ou num√©ro (d√®s le premier caract√®re)
        const terme = searchTerm.toLowerCase();
        clientsRemboursementFiltres = clientsRemboursementData.filter(client => {
          const nomComplet = `${client.prenom} ${client.nom}`.toLowerCase();
          const numeroSoumission = (client.num || '').toString().toLowerCase();
          
          return nomComplet.includes(terme) || numeroSoumission.includes(terme);
        });
      }
      
      // Mettre √† jour l'affichage du dropdown
      afficherClientsRemboursementFiltres();
      
      // Ouvrir le menu automatiquement
      ouvrirMenuRemboursement();
    }

    // Fonction pour afficher les clients filtr√©s
    function afficherClientsRemboursementFiltres() {
      log('üñ•Ô∏è Affichage des clients remboursement filtr√©s:', clientsRemboursementFiltres.length);
      const clientMenu = document.getElementById('clientMenuRemboursement');
      
      if (!clientMenu) {
        error('[ERROR] Menu clientMenuRemboursement non trouv√©');
        return;
      }
      log('[OK] Menu clientMenuRemboursement trouv√©');
      
      // Vider le menu
      clientMenu.innerHTML = '';
      
      // Afficher les r√©sultats
      if (clientsRemboursementFiltres.length === 0) {
        const noResult = document.createElement('div');
        noResult.className = 'px-3 py-2 text-sm';
        noResult.style.color = 'var(--text-gray)';
        noResult.textContent = 'Aucun client trouv√©';
        clientMenu.appendChild(noResult);
        return;
      }
      
      clientsRemboursementFiltres.forEach(client => {
        const option = document.createElement('div');
        option.className = 'custom-select-option cursor-pointer';
        option.onclick = () => selectionnerClientRemboursement(client.num, `${client.prenom} ${client.nom}`, client);
        
        // Contenu de l'option
        option.innerHTML = `
          <div class="flex justify-between items-center">
            <span>${client.prenom} ${client.nom}</span>
            <span class="text-sm opacity-70">${client.num}</span>
          </div>
        `;
        
        // Styles
        option.style.padding = '8px 12px';
        option.style.color = 'var(--text-light)';
        option.style.borderBottom = '1px solid #334155';
        
        clientMenu.appendChild(option);
      });
    }

    // Fonction pour s√©lectionner un client remboursement
    function selectionnerClientRemboursement(numeroSoumission, clientName, clientData) {
      log('[OK] Client s√©lectionn√© (remboursement):', clientName, clientData);
      
      // Mettre √† jour les champs
      const clientInfo = document.getElementById('clientInfoRemboursement');
      const totalTravaux = document.getElementById('totalTravauxClientRemboursement');
      const clientSearch = document.getElementById('clientSearchRemboursement');
      const voirSoumissionBtn = document.getElementById('voirSoumissionBtnRemboursement');
      
      if (clientInfo) clientInfo.value = numeroSoumission;
      if (totalTravaux) totalTravaux.value = formatMontantAvecEspace(clientData.total_travaux || '0');
      if (clientSearch) {
        clientSearch.value = clientName;
        clientSearch.placeholder = clientName; // Placeholder aussi pour garder le nom affich√©
      }
      
      // Activer le bouton voir soumission
      if (voirSoumissionBtn) {
        voirSoumissionBtn.disabled = false;
        voirSoumissionBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        voirSoumissionBtn.classList.add('btn-primary');
        voirSoumissionBtn.classList.remove('btn-secondary');
      }
      
      // Sauvegarder les donn√©es client
      sessionStorage.setItem('selectedClientDataRemboursement', JSON.stringify(clientData));
      
      // Afficher les d√©tails du client
      const clientDetailsCard = document.getElementById('clientDetailsCardRemboursement');
      const nomComplet = document.getElementById('clientNomCompletRemboursement');
      const clientTelephone = document.getElementById('clientTelephoneRemboursement');
      const clientAdresse = document.getElementById('clientAdresseRemboursement');
      
      if (clientDetailsCard && nomComplet && clientTelephone && clientAdresse) {
        nomComplet.textContent = `${clientData.prenom} ${clientData.nom}`;
        clientTelephone.textContent = clientData.telephone || 'Non renseign√©';
        clientAdresse.textContent = clientData.adresse || 'Non renseign√©e';
        clientDetailsCard.classList.remove('hidden');
      }
      
      // Fermer le menu imm√©diatement
      fermerMenuRemboursement();
    }

    // Fonction pour voir la soumission en mode remboursement
    function voirSoumissionSigneeRemboursement() {
      const clientData = JSON.parse(sessionStorage.getItem('selectedClientDataRemboursement') || '{}');
      
      if (!clientData.pdfUrl) {
        alert('Aucune soumission PDF disponible pour ce client');
        return;
      }

      // Ouvrir le PDF dans un popup (m√™me logique que facturation)
      const pdfUrl = clientData.pdfUrl;
      const popup = window.open('', 'soumissionPDF', 'width=1000,height=800,scrollbars=yes,resizable=yes');
      
      if (popup) {
        popup.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>Soumission sign√©e - ${clientData.prenom} ${clientData.nom}</title>
            <!-- Styles sp√©cifiques √† Facturation QE -->
</head>
          <body>
            <iframe src="${pdfUrl}" type="application/pdf">
              <p>Impossible d'afficher le PDF. <a href="${pdfUrl}" target="_blank">Ouvrir dans un nouvel onglet</a></p>
            </iframe>
</body>
          </html>
        `);
        popup.document.close();
      } else {
        window.open(pdfUrl, '_blank');
      }
    }

    // Fonction pour charger les clients depuis soumissions_signees original (pour remboursement)
    async function chargerClientsRemboursement() {
      try {
        const username = getFacturationUsername();
        const response = await fetch(`/soumissions_signees/${username}`);
        
        if (response.ok) {
          const clients = await response.json();
          
          // Sauvegarder les donn√©es pour la recherche
          clientsRemboursementData = clients.map(client => ({
            prenom: client.prenom || '',
            nom: client.nom || '',
            email: client.email || '',
            telephone: client.telephone || '',
            adresse: client.adresse || '',
            total_travaux: client.prix || '0',
            num: client.num || '',
            id: client.id || client.num,
            pdfUrl: client.pdfUrl || '#'
          }));
          
          // Initialiser la liste filtr√©e avec tous les clients
          clientsRemboursementFiltres = [...clientsRemboursementData];
          
          // Afficher tous les clients au d√©but
          afficherClientsRemboursementFiltres();
          
          log(`[OK] ${clients.length} clients charg√©s depuis soumissions_signees original pour remboursement`);
          log('[DATA] Donn√©es clients remboursement:', clientsRemboursementData.slice(0, 3)); // Afficher 3 premiers
        } else {
          error('Erreur lors du chargement des clients remboursement:', response.status);
        }
      } catch (error) {
        error('Erreur lors du chargement des clients remboursement:', error);
        
        // Fallback avec donn√©es de test si pas de serveur
        log('üîÑ Utilisation des donn√©es de test pour remboursement');
        const clientsTest = [
          { prenom: 'Jean', nom: 'Dupont', num: '24-0001', total_travaux: '5000', telephone: '514-123-4567', adresse: '123 Rue Saint-Denis, Montr√©al', pdfUrl: '#' },
          { prenom: 'Marie', nom: 'Martin', num: '24-0002', total_travaux: '7500', telephone: '514-234-5678', adresse: '456 Ave du Parc, Montr√©al', pdfUrl: '#' },
          { prenom: 'Sophie', nom: 'Tremblay', num: '24-0003', total_travaux: '12000', telephone: '514-456-7890', adresse: '321 Rue Sherbrooke, Montr√©al', pdfUrl: '#' }
        ];
        
        clientsRemboursementData = clientsTest.map(client => ({
          prenom: client.prenom,
          nom: client.nom,
          email: '',
          telephone: client.telephone,
          adresse: client.adresse,
          total_travaux: client.total_travaux,
          num: client.num,
          id: client.num,
          pdfUrl: client.pdfUrl
        }));
        
        clientsRemboursementFiltres = [...clientsRemboursementData];
        afficherClientsRemboursementFiltres();
        
        log(`[OK] ${clientsTest.length} clients de test charg√©s pour remboursement`);
      }
    }

    // ===== FONCTIONS DROPDOWN FACTURATION =====
    // (Variables clientsFacturationData et clientsFacturationFiltres d√©clar√©es en haut du script)

    // (Fonction ouvrirMenuFacturation d√©j√† d√©clar√©e en haut du script)

    // Fonction pour fermer le menu facturation - d√©clar√©e globalement
    window.fermerMenuFacturation = function() {
      const menu = document.getElementById('clientMenuFacturation');
      if (menu) {
        menu.classList.add('hidden');
      }
    }

    // Fonction pour rechercher les clients facturation - d√©clar√©e globalement  
    window.rechercherClientsFacturation = function(terme) {
      if (!terme.trim()) {
        // Si pas de terme de recherche, afficher tous les clients
        clientsFacturationFiltres = [...clientsFacturationData];
      } else {
        // Filtrer les clients selon le terme de recherche
        const termeMinuscule = terme.toLowerCase();
        clientsFacturationFiltres = clientsFacturationData.filter(client => 
          (client.prenom && client.prenom.toLowerCase().includes(termeMinuscule)) ||
          (client.nom && client.nom.toLowerCase().includes(termeMinuscule)) ||
          (client.num && client.num.toLowerCase().includes(termeMinuscule)) ||
          (client.telephone && client.telephone.includes(terme))
        );
      }
      
      afficherClientsFacturationFiltres();
    }

    // Fonction pour afficher les clients facturation filtr√©s
    function afficherClientsFacturationFiltres() {
      log('[LAUNCH] FACTURATION: D√©but affichage clients filtr√©s');
      
      const menu = document.getElementById('clientMenuFacturation');
      log('[TARGET] FACTURATION: Menu element trouv√©:', !!menu, menu);
      
      if (!menu) {
        error('[ERROR] FACTURATION: Menu clientMenuFacturation non trouv√©');
        return;
      }
      
      log(`üñ•Ô∏è FACTURATION: Nombre de clients √† afficher: ${clientsFacturationFiltres.length}`);
      log('[BAN] FACTURATION: D√©tails clients:', clientsFacturationFiltres);
      
      // Vider le menu
      menu.innerHTML = '';
      log('[DELETE] FACTURATION: Menu vid√©');
      
      // Afficher les r√©sultats
      if (clientsFacturationFiltres.length === 0) {
        log('[ERROR] FACTURATION: Aucun client √† afficher');
        const noResult = document.createElement('div');
        noResult.className = 'px-3 py-2 text-sm';
        noResult.style.color = 'var(--text-gray)';
        noResult.textContent = 'Aucun client trouv√©';
        menu.appendChild(noResult);
        return;
      }
      
      log('[ADD] FACTURATION: D√©but ajout des clients dans le DOM');
      
      clientsFacturationFiltres.forEach((client, index) => {
        log(`[NOTE] FACTURATION: Ajout client ${index + 1}:`, client.prenom, client.nom);
        
        const option = document.createElement('div');
        option.className = 'custom-select-option cursor-pointer';
        option.onclick = () => selectionnerClientFacturation(client.num, `${client.prenom} ${client.nom}`, client);
        
        const totalFormate = formatMontant(client.total_travaux);
        log(`[MONEY] FACTURATION: Montant format√© pour ${client.prenom}:`, totalFormate);
        
        // Contenu simple comme remboursement: nom et num√©ro seulement
        option.innerHTML = `
          <div class="flex justify-between items-center">
            <span>${client.prenom} ${client.nom}</span>
            <span class="text-sm opacity-70">${client.num}</span>
          </div>
        `;
        
        // Styles identiques au remboursement
        option.style.padding = '8px 12px';
        option.style.color = 'var(--text-light)';
        option.style.borderBottom = '1px solid #334155';
        
        // Hover effect
        option.addEventListener('mouseenter', function() {
          this.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
        });
        
        option.addEventListener('mouseleave', function() {
          this.style.backgroundColor = 'transparent';
        });
        
        menu.appendChild(option);
        log(`[OK] FACTURATION: Client ${index + 1} ajout√© au DOM`);
      });
      
      log('[OK] FACTURATION: Tous les clients ajout√©s au menu');
      log('[DEBUG] FACTURATION: Children du menu:', menu.children.length);
    }

    // Fonction pour s√©lectionner un client facturation - d√©clar√©e globalement
    window.selectionnerClientFacturation = async function(numeroSoumission, clientName, clientData) {
      log('[TARGET] S√©lection client facturation:', numeroSoumission, clientName);

      // Afficher le spinner de chargement de la section paiements
      const sectionPaiementsOverlay = document.getElementById('sectionPaiementsOverlay');
      const loadingText = sectionPaiementsOverlay?.querySelector('.loading-text');
      if (sectionPaiementsOverlay) {
        if (loadingText) {
          loadingText.textContent = 'Chargement du client...';
        }
        sectionPaiementsOverlay.classList.add('active');
      }

      // Enregistrer le moment o√π on commence le chargement (pour d√©lai minimum de 2s)
      const startTime = Date.now();

      try {
        // CRUCIAL: Vider le sessionStorage pour √©viter les donn√©es en cache de l'ancien client
        sessionStorage.removeItem('selectedClientDataFacturation');
        sessionStorage.removeItem('selectedClientFacturation');
        sessionStorage.removeItem('selectedClientNameFacturation');
        log('üßπ SessionStorage vid√© avant le nouveau client');

        // CRUCIAL: R√©initialiser compl√®tement l'interface AVANT de charger les nouvelles donn√©es
        resetCompleteInterface();
        log('üîÑ Interface r√©initialis√©e, chargement du nouveau client...');

        // Fermer le menu
        fermerMenuFacturation();

        // Mettre √† jour l'input avec le nom du client
        const inputSearch = document.getElementById('clientSearchFacturation');
        if (inputSearch) {
          inputSearch.value = clientName;
          // Mettre la bordure en vert quand un client est s√©lectionn√©
          inputSearch.style.setProperty('border-right-color', '#4caf50', 'important');
        }
      
      // R√©cup√©rer les donn√©es centralis√©es du workflow
      const clientsWorkflow = await obtenirDonneesClientsWorkflow();
      const clientWorkflow = clientsWorkflow[numeroSoumission];

      // R√©cup√©rer les d√©tails complets du client via l'API statuts
      const username = getFacturationUsername();
      let detailsComplets = {};
      try {
        const responseDetails = await fetch(`/api/facturationqe/client/${username}/${numeroSoumission}/statuts`);
        if (responseDetails.ok) {
          detailsComplets = await responseDetails.json();
          log('üíæ D√©tails complets r√©cup√©r√©s depuis l\'API pour', numeroSoumission, ':', detailsComplets);
        }
      } catch (error) {
        warn('[WARN] Impossible de r√©cup√©rer les d√©tails complets:', error);
      }
      
      // Fusionner les donn√©es du workflow avec les donn√©es originales du client ET les d√©tails complets
      const clientDataEnriched = {
        ...clientData,
        statutDepot: clientWorkflow ? clientWorkflow.statutDepot : (clientData.statutDepot || 'non_envoye'),
        statutPaiementFinal: clientWorkflow ? clientWorkflow.statutPaiementFinal : undefined,
        description: clientWorkflow ? clientWorkflow.description : undefined,
        // Ajouter les d√©tails complets du d√©p√¥t, paiement final, etc.
        depot: detailsComplets.depot || clientData.depot,
        paiementFinal: detailsComplets.paiementFinal || clientData.paiementFinal,
        autresPaiements: detailsComplets.autresPaiements || clientData.autresPaiements || []
      };

      // Debug: afficher les donn√©es enrichies
      log('[DEBUG] DONN√âES ENRICHIES POUR', numeroSoumission, ':', clientDataEnriched);
      log('[DEBUG] AUTRES PAIEMENTS pour', numeroSoumission, ':', clientDataEnriched.autresPaiements);
      log('[DEBUG] SOURCE autresPaiements - detailsComplets:', detailsComplets.autresPaiements, '| clientData:', clientData.autresPaiements);
      if (clientDataEnriched.depot) {
        log('[MONEY] D√âP√îT ENRICHI:', clientDataEnriched.depot);
      } else {
        warn('[WARN] Aucune donn√©e de d√©p√¥t dans clientDataEnriched');
      }
      
      // Sauvegarder les donn√©es du client enrichies
      sessionStorage.setItem('selectedClientDataFacturation', JSON.stringify(clientDataEnriched));
      sessionStorage.setItem('selectedClientFacturation', numeroSoumission);
      sessionStorage.setItem('selectedClientNameFacturation', clientName);

      // NOTE: resetCompleteInterface() est d√©j√† appel√© au d√©but de cette fonction (ligne 10192)
      // Ne pas rappeler ici sinon √ßa efface tout ce qui vient d'√™tre charg√©!

      // D√©finir les variables de statut selon le workflow centralis√©
      // Priorit√©: depot.statut si existe, sinon statutDepot
      const statutDepot = clientDataEnriched.depot?.statut || clientDataEnriched.statutDepot || 'non_envoye';
      const depotTraiteOuEnTraitement = (statutDepot === 'traitement' || statutDepot === 'traite');

      log('üîÑ Interface r√©initialis√©e pour:', clientName, 'statut d√©p√¥t:', statutDepot, 'depuis:', clientDataEnriched.depot?.statut ? 'depot.statut' : 'statutDepot');
      
      // Ajouter des transitions CSS fluides temporairement
      const elementsWithTransitions = document.querySelectorAll('.modern-input, .paiement-content, button[id^="btn-"], #clientDetailsCard');
      elementsWithTransitions.forEach(el => {
        el.style.transition = 'all 0.3s ease-in-out';
      });
      
      // Remplir les champs du formulaire
      const numeroInput = document.getElementById('clientInfo');
      if (numeroInput) {
        numeroInput.value = numeroSoumission;
        // Appliquer le style gris√© au num√©ro de soumission si n√©cessaire
        if (depotTraiteOuEnTraitement) {
          numeroInput.style.color = '#6b7280';
        } else {
          numeroInput.style.color = 'var(--text-light)';
        }
        log('[BAN] FACTURATION: Num√©ro soumission rempli:', numeroSoumission);
      } else {
        error('[ERROR] FACTURATION: Champ clientInfo non trouv√©');
      }
      
      const totalTravauxInput = document.getElementById('totalTravauxClient');
      if (totalTravauxInput) {
        totalTravauxInput.value = formatMontantAvecEspace(clientData.total_travaux);
        // Griser si d√©p√¥t trait√© ou en traitement
        if (depotTraiteOuEnTraitement) {
          totalTravauxInput.style.color = '#6b7280';
          totalTravauxInput.style.backgroundColor = 'rgba(55, 65, 81, 0.3)';
        } else {
          totalTravauxInput.style.color = 'var(--text-light)';
          totalTravauxInput.style.backgroundColor = 'rgba(55, 65, 81, 0.3)';
        }
        log('[MONEY] FACTURATION: Total travaux rempli:', formatMontant(clientData.total_travaux));
      } else {
        error('[ERROR] FACTURATION: Champ totalTravauxClient non trouv√©');
      }
      
      // Activer le bouton voir soumission (garder btn-secondary)
      const voirSoumissionBtn = document.getElementById('voirSoumissionBtn');
      if (voirSoumissionBtn) {
        voirSoumissionBtn.disabled = false;
        voirSoumissionBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        log('[OK] FACTURATION: Bouton voir soumission activ√©');
      } else {
        error('[ERROR] FACTURATION: Bouton voir soumission non trouv√©');
      }
      
      // Remplir les informations client et la barre de progression
      const clientDetailsCard = document.getElementById('clientDetailsCard');
      const clientNomComplet = document.getElementById('clientNomComplet');
      const clientTelephone = document.getElementById('clientTelephone');
      const clientAdresse = document.getElementById('clientAdresse');
      const totalTravauxProgression = document.getElementById('totalTravauxProgression');
      
      // Remplir les informations du client
      if (clientNomComplet) clientNomComplet.textContent = `${clientData.prenom} ${clientData.nom}`;
      if (clientTelephone) clientTelephone.textContent = clientData.telephone || 'N/A';
      if (clientAdresse) clientAdresse.textContent = clientData.adresse || 'N/A';
      
      // Mettre √† jour le statut de paiement selon l'√©tat du d√©p√¥t
      const clientStatutPaiement = document.getElementById('clientStatutPaiement');

      // Garder les informations client toujours blanches (lisibles)
      if (clientNomComplet) clientNomComplet.style.color = 'white';
      if (clientTelephone) clientTelephone.style.color = 'white';
      if (clientAdresse) clientAdresse.style.color = 'white';

      // D√©terminer le statut en fonction du d√©p√¥t, paiement final ET autres paiements
      // Priorit√©: paiementFinal.statut si existe, sinon statutPaiementFinal
      const statutPaiementFinal = clientDataEnriched.paiementFinal?.statut || clientDataEnriched.statutPaiementFinal || 'attente';

      if (clientStatutPaiement) {

        // V√©rifier si autres paiements en traitement
        const autresPaiements = Array.isArray(clientDataEnriched.autresPaiements) ? clientDataEnriched.autresPaiements : [];
        log('[DEBUG FILTRES] ========== CLIENT:', numeroSoumission, '==========');
        log('[DEBUG FILTRES] statutDepot utilis√©:', statutDepot);
        log('[DEBUG FILTRES] autresPaiements brut:', autresPaiements);

        // Filtrer seulement les paiements partiels et remboursements (exclure "un_seul_paiement")
        const paiementsPartiels = autresPaiements.filter(p => {
          const include = !p.typePaiementAutres || p.typePaiementAutres === 'paiement_partiel' || p.typePaiementAutres === 'remboursement';
          log('[DEBUG FILTRES] Paiement:', p, '| typePaiementAutres:', p.typePaiementAutres, '| inclus dans partiels:', include);
          return include;
        });

        // Filtrer les paiements "un seul paiement"
        const paiementsUnSeul = autresPaiements.filter(p => p.typePaiementAutres === 'un_seul_paiement');
        log('[DEBUG FILTRES] paiementsPartiels:', paiementsPartiels.length, '| paiementsUnSeul:', paiementsUnSeul.length);

        // V√©rifier les statuts (traitement OU attente_comptable = en traitement pour l'entrepreneur)
        const autresPaiementsEnTraitement = paiementsPartiels.filter(p => {
          const inTraitement = p.statut === 'traitement' || p.statut === 'attente_comptable';
          log('[DEBUG FILTRES] Paiement statut:', p.statut, '| en traitement:', inTraitement);
          return inTraitement;
        });
        const hasAutresPaiementsEnTraitement = autresPaiementsEnTraitement.length > 0;
        const autresPaiementsTraites = paiementsPartiels.filter(p => p.statut === 'traite');
        const hasAutresPaiementsTraites = autresPaiementsTraites.length > 0;

        // V√©rifier "un seul paiement" s√©par√©ment
        const unSeulPaiementEnTraitement = paiementsUnSeul.filter(p => p.statut === 'traitement' || p.statut === 'attente_comptable');
        const hasUnSeulPaiementEnTraitement = unSeulPaiementEnTraitement.length > 0;
        const unSeulPaiementTraite = paiementsUnSeul.filter(p => p.statut === 'traite');
        const hasUnSeulPaiementTraite = unSeulPaiementTraite.length > 0;

        log('[DEBUG] DEBUG STATUT - D√©p√¥t:', statutDepot, '| Paiement Final:', statutPaiementFinal, '| Autres paiements en traitement:', autresPaiementsEnTraitement.length, '| Un seul paiement en traitement:', unSeulPaiementEnTraitement.length);
        log('[DEBUG] DEBUG SOURCE - depot:', clientDataEnriched.depot, '| paiementFinal:', clientDataEnriched.paiementFinal, '| autresPaiements:', clientDataEnriched.autresPaiements);
        log('[DEBUG] CONDITION CHECK - statutDepot attente_comptable?', statutDepot === 'attente_comptable', '| statutPaiementFinal attente_comptable?', statutPaiementFinal === 'attente_comptable');

        // D√©tecter les remboursements dans paiementsPartiels
        const hasRemboursement = paiementsPartiels.some(p => p.typePaiementAutres === 'remboursement');
        const remboursementsTraites = paiementsPartiels.filter(p => p.typePaiementAutres === 'remboursement' && p.statut === 'traite');
        const montantRemboursementTotal = remboursementsTraites.reduce((sum, p) => {
          const montant = parseFloat(p.montant?.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
          return sum + montant;
        }, 0);
        log('[RED] D√©tection remboursement - hasRemboursement:', hasRemboursement, '| remboursements trait√©s:', remboursementsTraites.length, '| montant total:', montantRemboursementTotal);

        // Construire le texte du statut
        let statutTexte = '';
        let statutCouleur = 'white';

        log('[DEBUG CONDITIONS] ===== AVANT IF/ELSE =====');
        log('[DEBUG CONDITIONS] statutDepot:', statutDepot, '| typeof:', typeof statutDepot);
        log('[DEBUG CONDITIONS] hasAutresPaiementsEnTraitement:', hasAutresPaiementsEnTraitement);
        log('[DEBUG CONDITIONS] Check traitement:', statutDepot === 'traitement');

        // Ne pas changer le statut pour les remboursements, juste afficher normalement
        // Cas sp√©cial: "un seul paiement" (pas de d√©p√¥t)
        if (statutDepot === 'non_envoye' && hasUnSeulPaiementEnTraitement) {
          statutTexte = 'Paiement complet en traitement';
          statutCouleur = '#f59e0b';
        } else if (statutDepot === 'non_envoye' && hasUnSeulPaiementTraite) {
          statutTexte = 'Paiement complet trait√©';
          statutCouleur = 'rgb(16, 185, 129)';
        // Cas: paiements partiels sans d√©p√¥t (ne devrait pas arriver normalement)
        } else if (statutDepot === 'non_envoye' && hasAutresPaiementsEnTraitement) {
          statutTexte = 'Paiement partiel en traitement';
          statutCouleur = '#f59e0b';
        } else if (statutDepot === 'non_envoye' && hasAutresPaiementsTraites) {
          statutTexte = 'Paiement partiel trait√©';
          statutCouleur = 'rgb(16, 185, 129)';
        } else if (statutDepot === 'non_envoye') {
          statutTexte = 'En attente du d√©p√¥t';
          statutCouleur = 'white';
        } else if (statutDepot === 'envoye') {
          statutTexte = 'D√©p√¥t envoy√©';
          statutCouleur = '#f59e0b';
        } else if (statutDepot === 'traitement' || statutDepot === 'attente_comptable') {
          // D√©p√¥t en traitement (ou valid√© par coach, en attente direction) - v√©rifier autres paiements
          const parts = ['D√©p√¥t'];
          log('[DEBUG TEXTE] Entr√©e condition d√©p√¥t traitement - hasAutresPaiementsEnTraitement:', hasAutresPaiementsEnTraitement, '| autresPaiementsEnTraitement.length:', autresPaiementsEnTraitement.length);
          if (statutPaiementFinal === 'traitement' || statutPaiementFinal === 'attente_comptable') {
            parts.push('paiement final');
          }
          if (hasAutresPaiementsEnTraitement) {
            const nbPartiels = autresPaiementsEnTraitement.length;
            log('[DEBUG TEXTE] Ajout paiement partiel - nbPartiels:', nbPartiels);
            parts.push(nbPartiels > 1 ? `paiement partiel (${nbPartiels})` : 'paiement partiel');
          }

          log('[DEBUG TEXTE] parts finales:', parts, '| length:', parts.length);
          if (parts.length === 1) {
            statutTexte = 'D√©p√¥t en traitement';
          } else if (parts.length === 2) {
            statutTexte = `${parts[0]} et ${parts[1]} en traitement`;
          } else {
            statutTexte = `${parts[0]}, ${parts[1]} et ${parts[2]} en traitement`;
          }
          statutCouleur = '#f59e0b';
        } else if (statutDepot === 'traite') {
          // D√©p√¥t trait√© - v√©rifier le statut du paiement final et autres paiements
          // PRIORIT√â 1: Si paiement final est trait√© = Paiements complets
          if (statutPaiementFinal === 'traite') {
            statutTexte = 'Paiements complets';
            statutCouleur = 'rgb(16, 185, 129)';
          } else if (statutPaiementFinal === 'attente' && !hasAutresPaiementsEnTraitement && !hasAutresPaiementsTraites) {
            statutTexte = 'En attente paiement final';
            statutCouleur = 'rgb(16, 185, 129)';
          } else if (statutPaiementFinal === 'traitement' || hasAutresPaiementsEnTraitement) {
            // Construire le texte selon ce qui est en traitement
            const parts = [];
            if (statutPaiementFinal === 'traitement') {
              parts.push('paiement final');
            }
            if (hasAutresPaiementsEnTraitement) {
              const nbPartiels = autresPaiementsEnTraitement.length;
              parts.push(nbPartiels > 1 ? `paiement partiel (${nbPartiels})` : 'paiement partiel');
            }

            // Si des paiements sont en cours, afficher en traitement
            if (parts.length > 0) {
              if (parts.length === 1) {
                statutTexte = `${parts[0].charAt(0).toUpperCase() + parts[0].slice(1)} en traitement`;
              } else {
                statutTexte = `${parts[0].charAt(0).toUpperCase() + parts[0].slice(1)} et ${parts[1]} en traitement`;
              }
              statutCouleur = '#f59e0b';
            } else {
              statutTexte = 'D√©p√¥t trait√©';
              statutCouleur = 'rgb(16, 185, 129)';
            }
          } else if (hasAutresPaiementsTraites && statutPaiementFinal === 'attente') {
            // Paiement partiel trait√© mais paiement final en attente
            const nbPartielsTraites = autresPaiementsTraites.length;
            statutTexte = nbPartielsTraites > 1
              ? `Paiement partiel (${nbPartielsTraites}) trait√© - En attente paiement final`
              : 'Paiement partiel trait√© - En attente paiement final';
            statutCouleur = 'rgb(16, 185, 129)';
          } else {
            statutTexte = 'D√©p√¥t trait√©';
            statutCouleur = 'rgb(16, 185, 129)';
          }
        }

        log('[DEBUG FINAL ASSIGNATION] Client:', numeroSoumission, '| statutTexte AVANT assignation:', statutTexte, '| hasAutresPaiementsEnTraitement:', hasAutresPaiementsEnTraitement);
        clientStatutPaiement.textContent = statutTexte;
        clientStatutPaiement.style.color = statutCouleur;

        // Afficher la note des remboursements si des remboursements existent
        const noteRemboursements = document.getElementById('noteRemboursements');
        if (noteRemboursements && hasRemboursement) {
          const nbRemb = remboursementsTraites.length;
          const texteRemb = nbRemb > 1
            ? `${nbRemb} remboursements totalisant ${montantRemboursementTotal.toFixed(2).replace('.', ',')} $`
            : `${nbRemb} remboursement totalisant ${montantRemboursementTotal.toFixed(2).replace('.', ',')} $`;
          noteRemboursements.textContent = texteRemb;
          noteRemboursements.style.display = 'block';
          log('[RED] Note remboursements affich√©e:', texteRemb);
        } else if (noteRemboursements) {
          noteRemboursements.style.display = 'none';
        }

        log('[DATA] FACTURATION: Statut paiement affich√©:', statutTexte, '(d√©p√¥t:', statutDepot, ', paiement:', statutPaiementFinal, ', autres:', autresPaiementsEnTraitement.length, ')');
      }
      
      // Remplir la barre de progression avec le montant total
      if (totalTravauxProgression) {
        totalTravauxProgression.textContent = formatMontant(clientData.total_travaux);
      }
      
      // Afficher la carte des d√©tails client avec barre de progression
      if (clientDetailsCard) {
        clientDetailsCard.classList.remove('hidden');
        log('[OK] FACTURATION: Informations client et barre de progression remplies');
        log('[BAN] FACTURATION: Nom:', `${clientData.prenom} ${clientData.nom}`);
        log('üìû FACTURATION: T√©l√©phone:', clientData.telephone);
        log('üè† FACTURATION: Adresse:', clientData.adresse);
        log('[MONEY] FACTURATION: Total travaux:', formatMontant(clientData.total_travaux));
      }
      
      // Activer les boutons de paiement pour saisir les informations
      const sectionPaiements = document.getElementById('sectionPaiements');
      const btnDepot = document.getElementById('btn-depot'); // Red√©claration pour cette fonction
      const btnPaiementFinal = document.getElementById('btn-paiement-final');
      const btnAutresPaiements = document.getElementById('btn-autres-paiements');
      
      // Afficher la section paiements et le bouton envoyer au comptable
      if (sectionPaiements) {
        sectionPaiements.style.display = 'block';
        log('[OK] FACTURATION: Section paiements affich√©e');
      }

      // R√©afficher le container des boutons workflow (peut √™tre cach√© par selectEntrepreneur)
      const workflowButtonsContainer = document.getElementById('workflow-buttons-container');
      if (workflowButtonsContainer) {
        workflowButtonsContainer.style.display = 'flex';
        log('[OK] FACTURATION: Container workflow-buttons r√©affich√©');
      }
      
      // Afficher le bouton "Envoyer au comptable" par d√©faut
      // La gestion sp√©cifique par section se fait dans showPaiementSection()
      const boutonEnvoiContainer = document.getElementById('boutonEnvoiContainer');
      if (boutonEnvoiContainer) {
        boutonEnvoiContainer.style.display = 'flex';
        log('[OK] FACTURATION: Bouton envoyer au comptable affich√© (sera g√©r√© par section)');
      }
      
      // Activer les boutons de paiement
      [btnDepot, btnPaiementFinal, btnAutresPaiements].forEach((btn, index) => {
        if (btn) {
          btn.disabled = false;
          btn.classList.remove('opacity-50', 'cursor-not-allowed');
          log(`[OK] FACTURATION: Bouton paiement ${index + 1} activ√©`);
        }
      });

      // === GRISAGE IMM√âDIAT du bouton "Paiement final" si le d√©p√¥t n'est pas encore en traitement ===
      // Le bouton "Paiement final" ne peut √™tre cliqu√© que si le d√©p√¥t a √©t√© envoy√© au comptable
      if (btnPaiementFinal && statutDepot !== 'traitement' && statutDepot !== 'attente_comptable' && statutDepot !== 'traite' && statutDepot !== 'traite_attente_final') {
        btnPaiementFinal.disabled = true;
        btnPaiementFinal.style.setProperty('opacity', '0.3', 'important');
        btnPaiementFinal.style.setProperty('cursor', 'not-allowed', 'important');
        btnPaiementFinal.style.setProperty('pointer-events', 'none', 'important');
        log('[GRIS IMMEDIAT] Bouton "Paiement final" gris√© - d√©p√¥t non envoy√© (statut d√©p√¥t:', statutDepot, ')');
      }

      // === GRISAGE IMM√âDIAT du bouton "Autres paiements" si paiement final en traitement/attente_comptable ===
      // Ce code s'ex√©cute IMM√âDIATEMENT apr√®s l'activation des boutons pour √©viter le flash
      if (btnAutresPaiements && (statutPaiementFinal === 'traitement' || statutPaiementFinal === 'attente_comptable')) {
        btnAutresPaiements.disabled = true;
        btnAutresPaiements.style.setProperty('opacity', '0.3', 'important');
        btnAutresPaiements.style.setProperty('cursor', 'not-allowed', 'important');
        btnAutresPaiements.style.setProperty('pointer-events', 'none', 'important');
        log('[GRIS IMMEDIAT] Bouton "Autres paiements" gris√© imm√©diatement apr√®s activation (paiement final:', statutPaiementFinal, ')');
      }

      // === NOUVEAU: G√©n√©rer les boutons et sections dynamiques de paiements partiels ===
      let autresPaiementsClient = clientDataEnriched.autresPaiements || [];

      // CORRECTION AUTOMATIQUE: Si le d√©p√¥t est non_envoye ET il y a des autres paiements sans typePaiementAutres,
      // les corriger pour √™tre "un_seul_paiement" (sauf les remboursements)
      if (statutDepot === 'non_envoye' && autresPaiementsClient.length > 0) {
        autresPaiementsClient = autresPaiementsClient.map(p => {
          if (p.typePaiementAutres === 'remboursement') {
            return p; // Ne pas toucher aux remboursements
          }
          if (!p.typePaiementAutres || p.typePaiementAutres === 'paiement_partiel') {
            log('[FIX] CORRECTION AUTO: Paiement sans typePaiementAutres -> un_seul_paiement');
            return { ...p, typePaiementAutres: 'un_seul_paiement' };
          }
          return p;
        });
      }

      if (autresPaiementsClient.length > 0) {
        log('[FIX] G√©n√©ration des paiements partiels dynamiques:', autresPaiementsClient.length);
        log('[BAN] Contenu autresPaiements:', JSON.stringify(autresPaiementsClient, null, 2));
        genererBoutonsPaiementsPartiels(autresPaiementsClient);
        genererSectionsPaiementsPartiels(autresPaiementsClient);
      } else {
        log('[WARN] Aucun autre paiement trouv√© dans clientDataEnriched');
      }

      // === NOUVEAU: G√©rer la visibilit√© de l'option "Un seul paiement" ===
      gererVisibiliteUnSeulPaiement();

      // === NOUVEAU: Ajouter les badges de statut aux titres D√©p√¥t et Paiement Final ===
      ajouterBadgesStatutTitres(clientDataEnriched);

      // D√©terminer le statut du d√©p√¥t et ouvrir la section appropri√©e par d√©faut
      const depotEnvoyeAuComptable = (statutDepot === 'envoye' || statutDepot === 'traitement' || statutDepot === 'traite');
      
      // Appliquer les couleurs selon le statut du d√©p√¥t
      // NOTE: Le bouton reste normal (pas de couleur) pour 'non_envoye' et 'envoye'
      // La couleur n'appara√Æt que lorsque le d√©p√¥t est en traitement ou trait√©
      if (btnDepot) {
        if (statutDepot === 'traitement' || statutDepot === 'attente_comptable') {
          // D√©p√¥t en traitement ou valid√© par coach (pas encore valid√© par direction) - orange
          btnDepot.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          btnDepot.style.borderColor = '#f59e0b';
          btnDepot.style.color = 'white';
          log('[ORANGE] FACTURATION: D√©p√¥t en TRAITEMENT (orange) - statut:', statutDepot);
        } else if (statutDepot === 'traite' || statutDepot === 'traite_attente_final') {
          // D√©p√¥t trait√© par la direction - vert
          btnDepot.style.background = 'linear-gradient(135deg, rgb(16, 185, 129), rgb(5, 150, 105))';
          btnDepot.style.borderColor = 'rgb(16, 185, 129)';
          btnDepot.style.color = 'white';
          log('[GREEN] FACTURATION: D√©p√¥t TRAIT√â (vert) - statut:', statutDepot);
        }
      }

      // Appliquer les couleurs selon le statut du paiement final
      if (btnPaiementFinal && statutPaiementFinal !== 'attente') {
        if (statutPaiementFinal === 'traitement' || statutPaiementFinal === 'attente_comptable') {
          // Paiement final en traitement ou valid√© par coach (pas encore valid√© par direction) - orange
          btnPaiementFinal.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          btnPaiementFinal.style.borderColor = '#f59e0b';
          btnPaiementFinal.style.color = 'white';
          log('[ORANGE] FACTURATION: Paiement final en TRAITEMENT (orange) - statut:', statutPaiementFinal);
        } else if (statutPaiementFinal === 'traite') {
          // Paiement final trait√© par direction - vert
          btnPaiementFinal.style.background = 'linear-gradient(135deg, rgb(16, 185, 129), rgb(5, 150, 105))';
          btnPaiementFinal.style.borderColor = 'rgb(16, 185, 129)';
          btnPaiementFinal.style.color = 'white';
          log('[GREEN] FACTURATION: Paiement final TRAIT√â (vert)');
        }
      }

      // Appliquer les couleurs pour les autres paiements (si au moins un en traitement ou trait√©)
      const autresPaiements = clientDataEnriched.autresPaiements || [];

      // D√©tecter le type de paiement autres depuis le premier paiement
      let typePaiementAutres = autresPaiements.length > 0 ? autresPaiements[0]?.typePaiementAutres : null;

      // Fallback: Si pas de typePaiementAutres mais des autres paiements ET pas de d√©p√¥t, c'est probablement un "un seul paiement"
      if (!typePaiementAutres && autresPaiements.length > 0 && statutDepot === 'non_envoye') {
        typePaiementAutres = 'un_seul_paiement';
        log('[DEBUG] Type de paiement autres d√©duit (fallback):', typePaiementAutres);
      } else {
        log('[DEBUG] Type de paiement autres d√©tect√©:', typePaiementAutres);
      }

      // Adapter les boutons selon le type (m√™me si aucun paiement encore)
      if (typePaiementAutres) {
        adapterBoutonsPaiement(typePaiementAutres);
      } else {
        // Reset au mode par d√©faut
        adapterBoutonsPaiement(null);
      }

      // NOTE: L'ancienne logique de coloration du bouton D√©p√¥t pour "un seul paiement" a √©t√© retir√©e
      // Les boutons "Un seul paiement" sont maintenant cr√©√©s dynamiquement avec leurs propres couleurs

      // D√©terminer quelle section ouvrir selon le statut du d√©p√¥t
      // CAS SP√âCIAL: Si "un seul paiement" existe, ouvrir la premi√®re section dynamique "un-seul-paiement-1"
      if (typePaiementAutres === 'un_seul_paiement' && autresPaiements.length > 0) {
        showPaiementSection('un-seul-paiement-1');
        log('[BAN] FACTURATION: Section Un seul paiement 1 ouverte par d√©faut');
      } else if (statutDepot === 'traite' || statutDepot === 'traitement' || statutDepot === 'traite_attente_final' || statutDepot === 'attente_comptable') {
        // Si d√©p√¥t trait√© OU en traitement OU valid√© coach -> ouvrir Paiement Final par d√©faut
        showPaiementSection('paiement-final');
        log('[BAN] FACTURATION: Section Paiement Final ouverte par d√©faut (d√©p√¥t', statutDepot, ')');

        // S'ASSURER que les √©l√©ments d√©p√¥t sont ferm√©s quand on ouvre paiement final par d√©faut
        // MAIS seulement apr√®s que rendreSectionDepotNonModifiable() a fini de s'ex√©cuter
        setTimeout(() => {
          const elementsAjouterDepot = document.getElementById('elementsAjouterDepot');
          const virementFieldsDepot = document.getElementById('virementFieldsDepot');
          const chequeFieldsDepot = document.getElementById('chequeFieldsDepot');
          
          // V√©rifier qu'on est bien par d√©faut en paiement final (pas en section d√©p√¥t)
          const contentPaiementFinal = document.getElementById('content-paiement-final');
          const isPaiementFinalActive = contentPaiementFinal && !contentPaiementFinal.classList.contains('hidden');
          
          if (elementsAjouterDepot && isPaiementFinalActive) {
            // Utiliser setProperty avec !important pour override les styles de rendreSectionDepotNonModifiable
            elementsAjouterDepot.style.setProperty('max-height', '0', 'important');
            elementsAjouterDepot.style.setProperty('opacity', '0', 'important');
            elementsAjouterDepot.style.setProperty('display', 'none', 'important');
            elementsAjouterDepot.style.setProperty('visibility', 'hidden', 'important');
            elementsAjouterDepot.style.setProperty('overflow', 'hidden', 'important');
            elementsAjouterDepot.style.setProperty('height', '0', 'important');
            
            // Effacer le flag sessionStorage car on ne veut pas afficher les √©l√©ments d√©p√¥t
            sessionStorage.removeItem('showDepotElements');
            
            if (virementFieldsDepot) virementFieldsDepot.classList.add('hidden');
            if (chequeFieldsDepot) chequeFieldsDepot.classList.add('hidden');
            log('[LOCK] FOR√áAGE RENFORC√â: √âl√©ments d√©p√¥t ferm√©s avec !important (paiement final actif)');
          }
        }, 150); // D√©lai plus long pour s'ex√©cuter apr√®s rendreSectionDepotNonModifiable (100ms)
      } else {
        // Sinon (non_envoye, envoye) -> ouvrir D√©p√¥t par d√©faut
        showPaiementSection('depot');
        log('[BAN] FACTURATION: Section D√©p√¥t ouverte par d√©faut (statut:', statutDepot, ')');
      }

      // ENSUITE changer l'apparence du bouton et des champs (apr√®s le changement de section)
      setTimeout(() => {
        if (statutDepot !== 'non_envoye') {
          changerBoutonDepotStatut(statutDepot);
          if (statutDepot === 'traitement') {
            // Pour traitement: section visible mais champs non-modifiables
            log('[FIX] APPEL de rendreSectionDepotNonModifiable() pour Marie Martin');
            rendreSectionDepotNonModifiable();
          } else if (statutDepot === 'envoye' || statutDepot === 'traite') {
            // Pour envoy√©/trait√©: section compl√®tement gris√©e
            griserSectionDepot();
          }
        }

        // Changer l'apparence du bouton paiement final selon son statut
        const statutPaiementFinal = clientDataEnriched.paiementFinal?.statut;
        if (statutPaiementFinal && (statutPaiementFinal === 'traitement' || statutPaiementFinal === 'traite' || statutPaiementFinal === 'attente_comptable')) {
          changerBoutonPaiementFinalStatut(statutPaiementFinal);
          log('üé® Bouton paiement final styl√© selon statut:', statutPaiementFinal);

          // Si en traitement OU attente_comptable OU trait√©, appliquer le grisage automatique
          if (statutPaiementFinal === 'traitement' || statutPaiementFinal === 'attente_comptable' || statutPaiementFinal === 'traite') {
            log('[FIX] APPEL de rendreSectionPaiementFinalNonModifiable() pour paiement final en', statutPaiementFinal);
            rendreSectionPaiementFinalNonModifiable();
          }
        }
      }, 100); // Petit d√©lai pour permettre √† la section de se changer d'abord

      // D√©sactiver le bouton "Autres paiements" APR√àS showPaiementSection pour √©viter r√©activation
      setTimeout(() => {
        const btnAutresPaiements = document.getElementById('btn-autres-paiements');

        // V√©rifier si c'est "un seul paiement"
        const autresPaiementsCheck = clientDataEnriched.autresPaiements || [];
        const typePaiementAutresCheck = autresPaiementsCheck.length > 0 ? autresPaiementsCheck[0]?.typePaiementAutres : null;
        const isUnSeulPaiementCheck = typePaiementAutresCheck === 'un_seul_paiement' ||
                                      (statutDepot === 'non_envoye' && autresPaiementsCheck.length > 0);
        const autresPaiementsEnTraitementCheck = autresPaiementsCheck.some(p => p.statut === 'traitement' || p.statut === 'traite');

        // V√©rifier le statut du paiement final (avec les deux sources possibles)
        const statutPaiementFinalCheck = clientDataEnriched.paiementFinal?.statut || clientDataEnriched.statutPaiementFinal;
        const paiementFinalEnTraitementOuAttente = statutPaiementFinalCheck === 'traitement' || statutPaiementFinalCheck === 'attente_comptable';

        // V√©rifier si tous les paiements sont complets/trait√©s
        const depotTraiteCheck = statutDepot === 'traite' || statutDepot === 'traite_attente_final';
        const paiementFinalTraiteCheck = statutPaiementFinalCheck === 'traite';
        const tousAutresPaiementsTraitesCheck = autresPaiementsCheck.length > 0 && autresPaiementsCheck.every(p => p.statut === 'traite');
        const paiementsCompletsCheck = depotTraiteCheck && (paiementFinalTraiteCheck || tousAutresPaiementsTraitesCheck);

        log('[DEBUG GRISAGE] statutPaiementFinalCheck:', statutPaiementFinalCheck, 'paiementFinalEnTraitementOuAttente:', paiementFinalEnTraitementOuAttente, 'paiementsComplets:', paiementsCompletsCheck);

        if (btnAutresPaiements && (paiementsCompletsCheck || statutDepot === 'traite' || paiementFinalEnTraitementOuAttente || (isUnSeulPaiementCheck && autresPaiementsEnTraitementCheck))) {
          btnAutresPaiements.disabled = true;
          btnAutresPaiements.style.setProperty('opacity', '0.3', 'important');
          btnAutresPaiements.style.setProperty('cursor', 'not-allowed', 'important');
          btnAutresPaiements.style.setProperty('pointer-events', 'none', 'important');

          if (statutDepot === 'traite') {
            log('üö´ [FINAL] Bouton "Autres paiements" d√©sactiv√© (d√©p√¥t trait√©)');
          } else if (paiementFinalEnTraitementOuAttente) {
            log('üö´ [FINAL] Bouton "Autres paiements" d√©sactiv√© (paiement final en', statutPaiementFinalCheck, ')');
          } else if (isUnSeulPaiementCheck && autresPaiementsEnTraitementCheck) {
            log('üö´ [FINAL] Bouton "Autres paiements" d√©sactiv√© (un seul paiement en traitement)');
          }
        } else if (btnAutresPaiements && !isUnSeulPaiementCheck && !paiementFinalEnTraitementOuAttente) {
          // R√©activer SEULEMENT si ce n'est PAS "un seul paiement" et pas en traitement
          btnAutresPaiements.disabled = false;
          btnAutresPaiements.style.removeProperty('opacity');
          btnAutresPaiements.style.removeProperty('cursor');
          btnAutresPaiements.style.removeProperty('pointer-events');
          btnAutresPaiements.style.color = 'white';
          log('[OK] Bouton "Autres paiements" activ√©');
        }
      }, 200); // D√©lai plus long pour s'ex√©cuter APR√àS showPaiementSection (qui peut r√©activer le bouton)

      // Mettre √† jour la progression du paiement
      updateProgressionPaiement(clientDataEnriched);
      
      // Les sections √©l√©ments √† ajouter sont maintenant ind√©pendantes et se g√®rent via les dropdowns
      log('[BAN] Sections √©l√©ments √† ajouter ind√©pendantes pr√™tes');
      
      // Retirer les transitions temporaires apr√®s un d√©lai
      setTimeout(() => {
        const elementsWithTransitions = document.querySelectorAll('.modern-input, .paiement-content, button[id^="btn-"], #clientDetailsCard');
        elementsWithTransitions.forEach(el => {
          el.style.removeProperty('transition');
        });
        log('üé≠ Transitions temporaires supprim√©es');
      }, 500);
      
      log('[OK] Client facturation s√©lectionn√© et donn√©es sauvegard√©es');
    } finally {
      // S'assurer que le spinner reste visible pendant au moins 1 seconde
      const elapsedTime = Date.now() - startTime;
      const minDisplayTime = 1000; // 1 seconde minimum
      const remainingTime = Math.max(0, minDisplayTime - elapsedTime);

      setTimeout(() => {
        // Cacher le spinner de chargement
        const sectionPaiementsOverlay = document.getElementById('sectionPaiementsOverlay');
        if (sectionPaiementsOverlay) {
          sectionPaiementsOverlay.classList.remove('active');
          // Remettre le texte par d√©faut pour le prochain envoi au comptable
          const loadingText = sectionPaiementsOverlay.querySelector('.loading-text');
          if (loadingText) {
            loadingText.textContent = 'Envoi au comptable en cours...';
          }
        }
        log('‚úÖ Spinner de chargement client masqu√© apr√®s', Math.round((Date.now() - startTime) / 1000), 'secondes');
      }, remainingTime);
    }
  }

    // Fonction pour r√©initialiser compl√®tement l'interface avant de changer de client
    function resetCompleteInterface() {
      log('üßπ R√©initialisation compl√®te de l\'interface...');
      
      // 1. R√âINITIALISER TOUS LES BOUTONS DE PAIEMENT
      const btnDepot = document.getElementById('btn-depot');
      const btnPaiementFinal = document.getElementById('btn-paiement-final');
      const btnAutresPaiements = document.getElementById('btn-autres-paiements');
      
      [btnDepot, btnPaiementFinal, btnAutresPaiements].forEach(btn => {
        if (btn) {
          // Supprimer les styles inline de couleur/√©tat uniquement
          btn.style.removeProperty('background');
          btn.style.removeProperty('background-color');
          btn.style.removeProperty('border-color');
          btn.style.removeProperty('color');
          btn.style.removeProperty('cursor');
          btn.style.removeProperty('opacity');
          btn.style.removeProperty('pointer-events');
          
          // Remettre les classes par d√©faut
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-secondary');
          btn.disabled = false;
          
          // Remettre le texte par d√©faut
          if (btn.id === 'btn-depot') {
            btn.innerHTML = '<i class="fas fa-piggy-bank mr-2"></i>D√©p√¥t';
          } else if (btn.id === 'btn-paiement-final') {
            btn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Paiement final';
          }
        }
      });
      
      // 2. R√âINITIALISER TOUTES LES SECTIONS DE CONTENU
      const contentDepot = document.getElementById('content-depot');
      const contentPaiementFinal = document.getElementById('content-paiement-final');
      const contentAutresPaiements = document.getElementById('content-autres-paiements');
      
      [contentDepot, contentPaiementFinal, contentAutresPaiements].forEach(section => {
        if (section) {
          // Supprimer tous les styles inline
          section.style.removeProperty('opacity');
          section.style.removeProperty('pointer-events');
          section.style.removeProperty('background-color');
          section.classList.remove('hidden');
        }
      });
      
      // 3. R√âINITIALISER TOUS LES CHAMPS DE FORMULAIRE
      const allInputs = document.querySelectorAll('#content-depot input, #content-paiement-final input, #content-autres-paiements input, #elementsAjouterDepot input, #elementsAjouterPaiementFinal input, #elementsAjouterAutres input');
      allInputs.forEach(input => {
        if (input && input.type !== 'file') {
          // Vider la valeur
          input.value = '';

          // R√©initialiser l'√©tat
          input.disabled = false;
          input.readOnly = false;

          // SUPPRIMER TOUS LES STYLES INLINE (y compris ceux avec !important)
          input.style.cssText = '';

          // Retirer les classes de validation
          input.classList.remove('field-valid', 'field-invalid');
        }
      });
      
      // 4. R√âINITIALISER LES SECTIONS "√âL√âMENTS √Ä AJOUTER"
      const elementsAjouterDepot = document.getElementById('elementsAjouterDepot');
      const elementsAjouterPaiementFinal = document.getElementById('elementsAjouterPaiementFinal');
      
      [elementsAjouterDepot, elementsAjouterPaiementFinal].forEach(section => {
        if (section) {
          section.style.maxHeight = '0';
          section.style.opacity = '0';
        }
      });
      
      // 4b. SUPPRIMER LES BOUTONS DYNAMIQUES (paiements partiels et un seul paiement)
      const btnDepotContainer = document.getElementById('btn-depot')?.parentElement;
      if (btnDepotContainer) {
        const boutonsDynamiques = btnDepotContainer.querySelectorAll('[id^="btn-paiement-partiel-"], [id^="btn-un-seul-paiement-"]');
        boutonsDynamiques.forEach(btn => btn.remove());
        log(`üßπ ${boutonsDynamiques.length} boutons dynamiques supprim√©s`);
      }

      // 4c. SUPPRIMER LES SECTIONS DYNAMIQUES (paiements partiels et un seul paiement)
      document.querySelectorAll('[id^="content-paiement-partiel-"], [id^="content-un-seul-paiement-"]').forEach(s => s.remove());

      // 5. R√âINITIALISER LES CHAMPS VIREMENT/CH√àQUE (CRUCIAL!)
      const virementFields = document.querySelectorAll('[id*="virementFields"]');
      const chequeFields = document.querySelectorAll('[id*="chequeFields"]');

      [...virementFields, ...chequeFields].forEach(field => {
        if (field) {
          // Cacher le champ
          field.classList.add('hidden');

          // SUPPRIMER TOUS LES STYLES INLINE AVEC !important
          field.style.cssText = '';

          // Nettoyer tous les inputs √† l'int√©rieur
          const inputs = field.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="number"]');
          inputs.forEach(input => {
            input.value = '';
            input.readOnly = false;
            input.disabled = false;
            input.style.cssText = '';
            input.classList.remove('field-valid', 'field-invalid');
          });

          // Nettoyer les dropzones
          const dropzones = field.querySelectorAll('.upload-zone-small');
          dropzones.forEach(zone => {
            zone.style.cssText = '';
          });
        }
      });
      
      // 6. R√âINITIALISER LES DROPDOWNS
      const allDropdowns = document.querySelectorAll('.modern-dropdown');
      allDropdowns.forEach(dropdown => {
        if (dropdown) {
          // SUPPRIMER TOUS LES STYLES INLINE (y compris ceux avec !important)
          dropdown.style.cssText = '';
          dropdown.classList.remove('active');

          // Remettre le texte par d√©faut pour les dropdowns "Pay√© par"
          const placeholder = dropdown.querySelector('.placeholder');
          if (placeholder && (dropdown.id === 'payeParToggle' || dropdown.id === 'payeParFinalToggle' || dropdown.id === 'payeParAutresToggle')) {
            placeholder.textContent = 'Choisir m√©thode...';
            placeholder.style.cssText = '';
          }

          // Retirer les classes de validation
          dropdown.classList.remove('field-valid', 'field-invalid');
        }
      });
      
      // 7. FERMER TOUS LES MENUS DROPDOWNS
      const allMenus = document.querySelectorAll('.modern-dropdown-menu');
      allMenus.forEach(menu => {
        if (menu) {
          menu.classList.add('hidden');
        }
      });

      // 8. NETTOYER TOUTES LES PR√âVISUALISATIONS D'IMAGES (CRUCIAL!)
      const allPreviews = document.querySelectorAll('[id^="preview"]');
      allPreviews.forEach(preview => {
        if (preview) {
          preview.innerHTML = '';
        }
      });
      log('üßπ Pr√©visualisations d\'images nettoy√©es');

      // NOTE: On ne vide PAS le sessionStorage ici car il contient les donn√©es du client actuel
      // Le sessionStorage est vid√© SEULEMENT dans selectionnerClientFacturation() avant de charger un nouveau client

      log('[OK] Interface compl√®tement r√©initialis√©e');
    }

    // Fonction pour charger les clients facturation
    async function chargerClientsFacturation() {
      log('üîÑ FACTURATION: Chargement des clients facturation...');

      const username = getFacturationUsername();
      if (!username || username === 'demo') {
        log('[BAN] FACTURATION: Pas de username - impossible de charger les clients');
        return;
      }

      try {
        log('üîÑ FACTURATION: Tentative de chargement depuis soumissions_signees_facturation_qe...');
        const response = await fetch(`/soumissions_signees_facturation_qe/${username}`);
        
        if (response.ok) {
          const clients = await response.json();
          
          clientsFacturationData = clients.map(client => ({
            prenom: client.clientPrenom || client.prenom || '',
            nom: client.clientNom || client.nom || '',
            email: client.courriel || client.email || '',
            telephone: client.telephone || '',
            adresse: client.adresse || '',
            total_travaux: client.prix || '0',
            num: client.num || '',
            id: client.id || client.num,
            pdfUrl: client.pdfUrl || '#'
          }));
          
          clientsFacturationFiltres = [...clientsFacturationData];
          afficherClientsFacturationFiltres();
          
          log(`[OK] FACTURATION: ${clients.length} clients charg√©s pour facturation`);
          log('[DATA] FACTURATION: Donn√©es clients facturation:', clientsFacturationData.slice(0, 3));
        } else {
          error('FACTURATION: Erreur lors du chargement des clients facturation:', response.status);
          log('[ERROR] Impossible de charger les clients depuis l\'API');
        }
      } catch (error) {
        error('FACTURATION: Erreur de connexion pour facturation:', error);
        log('[ERROR] Impossible de se connecter √† l\'API');
      }
    }

    // Fonction pour charger les clients depuis l'API
    async function chargerClientsDepuisAPI() {
      log('üîÑ FACTURATION API: Chargement des clients depuis l\'API...');

      const username = getFacturationUsername();
      log('[DEBUG] Username:', username);

      if (!username || username === 'demo') {
        log('[ERROR] Pas de username - impossible de charger les clients');
        return;
      }

      try {
        // Charger tous les clients depuis get-clients-by-username pour avoir TOUS les statuts
        log('[DEBUG] Chargement depuis /get-clients-by-username/' + username);
        const response = await fetch(`/get-clients-by-username/${username}`);
        log('[DEBUG] Response status:', response.status);

        if (!response.ok) {
          throw new Error(`Erreur API: ${response.status}`);
        }

        const data = await response.json();
        log('[DEBUG] R√©ponse brute API:', data);
        log('[DEBUG] Keys:', Object.keys(data));

        // Combiner les clients des statuts accepter et produit
        let allClients = [];

        if (data.accepter && Array.isArray(data.accepter)) {
          log(`[INFO] ${data.accepter.length} clients dans ACCEPTER`);
          allClients = allClients.concat(data.accepter);
        }

        if (data.produit && Array.isArray(data.produit)) {
          log(`[INFO] ${data.produit.length} clients dans PRODUIT`);
          allClients = allClients.concat(data.produit);
        }

        log(`[INFO] Total: ${allClients.length} clients (accepter + produit)`);

        if (allClients.length > 0) {
          log('[DEBUG] Premier client:', allClients[0]);
        }

        clientsFacturationData = allClients.map(client => ({
          prenom: client.clientPrenom || client.prenom || '',
          nom: client.clientNom || client.nom || '',
          email: client.courriel || client.email || '',
          telephone: client.telephone || '',
          adresse: client.adresse || '',
          total_travaux: client.prix || client.total_travaux || '0',
          num: client.num || '',
          id: client.id || client.num,
          pdfUrl: client.pdfUrl || '#',
          statutDepot: client.statutDepot || 'non_envoye',
          statutPaiementFinal: client.statutPaiementFinal
        }));

        clientsFacturationFiltres = [...clientsFacturationData];

        log(`[OK] FACTURATION API: ${clientsFacturationData.length} clients charg√©s (accepter + produit)`);
        log('[DEBUG] clientsFacturationData:', clientsFacturationData);
        log('[DEBUG] clientsFacturationFiltres:', clientsFacturationFiltres);

        // Afficher les clients
        log('[DEBUG] V√©rification fonction afficherClientsFacturationFiltres:', typeof afficherClientsFacturationFiltres);
        if (typeof afficherClientsFacturationFiltres === 'function') {
          log('[DEBUG] Appel de afficherClientsFacturationFiltres...');
          afficherClientsFacturationFiltres();
        } else {
          log('[ERROR] afficherClientsFacturationFiltres n\'est pas une fonction!');
        }

        return true;

      } catch (error) {
        error('[ERROR] FACTURATION API: Erreur lors du chargement:', error);
        error('[ERROR] Stack:', error.stack);
        return false;
      }
    }

    // Fonction pour voir la soumission sign√©e facturation
    function voirSoumissionSigneeFacturation(numeroSoumission) {
      const client = clientsFacturationData.find(c => c.num === numeroSoumission);
      if (!client || !client.pdfUrl) {
        alert('Aucune soumission PDF disponible pour ce client');
        return;
      }

      // Ouvrir le PDF dans un popup
      const pdfUrl = client.pdfUrl;
      const popup = window.open('', 'soumissionPDF', 'width=1000,height=800,scrollbars=yes,resizable=yes');
      
      if (popup) {
        popup.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>Soumission sign√©e - ${client.prenom} ${client.nom}</title>
            <!-- Styles sp√©cifiques √† Facturation QE -->
</head>
          <body>
            <iframe src="${pdfUrl}"></iframe>
</body>
          </html>
        `);
        popup.document.close();
      } else {
        // Fallback si le popup est bloqu√©
        alert('Les popups semblent √™tre bloqu√©s. Veuillez autoriser les popups pour ce site ou ouvrir manuellement le PDF.');
        // Ouvrir dans un nouvel onglet comme alternative
        window.open(pdfUrl, '_blank');
      }
    }

    // Fonction pour voir les remboursements
    window.voirRemboursements = async function() {
      try {
        log('[BAN] Chargement des remboursements...');

        // Charger depuis le backend
        const username = getFacturationUsername();
        const response = await fetch(`${window.location.origin}/api/remboursements/${username}`);
        let remboursements = await response.json();

        // V√©rifier que c'est bien un tableau
        if (!Array.isArray(remboursements)) {
          warn('[WARN] remboursements n\'est pas un tableau:', remboursements);
          remboursements = [];
        }

        log(`[OK] ${remboursements.length} remboursements charg√©s`);

        // Afficher les donn√©es brutes pour debug
        if (remboursements.length > 0) {
          log('[DEBUG REMB] Premier remboursement:', remboursements[0]);
        }

        // Cr√©er le popup modal
        const modal = document.createElement('div');
        modal.id = 'remboursementsModal';
        modal.className = 'fixed inset-0 flex items-center justify-center z-50';
        modal.style.background = 'rgba(0, 0, 0, 0.7)';
        modal.style.backdropFilter = 'blur(5px)';

        let contentHTML = '';

        if (remboursements.length === 0) {
          contentHTML = `
            <div class="text-center py-8">
              <i class="fas fa-check-circle text-5xl mb-3" style="color: #10b981;"></i>
              <p class="text-lg" style="color: var(--text-gray);">Aucun remboursement</p>
            </div>
          `;
        } else {
          contentHTML = '<div class="space-y-3">';

          remboursements.forEach((rembours, index) => {
            // Support pour diff√©rents formats de champs API
            let prenom = rembours.prenom || rembours.clientPrenom || '';
            let nom = rembours.nom || rembours.clientNom || '';

            // Fallback: si prenom/nom vides, essayer de diviser le champ 'client'
            if (!prenom && !nom && rembours.client) {
              const parts = rembours.client.split(' ');
              if (parts.length >= 2) {
                prenom = parts[0];
                nom = parts.slice(1).join(' ');
              } else {
                prenom = rembours.client;
              }
            }

            const clientNom = `${prenom} ${nom}`.trim() || 'Client sans nom';

            // Support pour diff√©rents formats de date
            const dateSource = rembours.date_remboursement || rembours.dateRemboursement || rembours.date || rembours.date_demande;
            const dateRemboursement = dateSource ?
              new Date(dateSource).toLocaleDateString('fr-CA') :
              'Date inconnue';

            // G√©rer le montant avec ou sans $ d√©j√† pr√©sent
            let montant = rembours.montant || '0';
            if (typeof montant === 'number') {
              montant = montant.toFixed(2).replace('.', ',');
            } else if (typeof montant === 'string') {
              montant = montant.replace('$', '').trim();
            }

            // Traduire le statut en fran√ßais
            const statutsTraduction = {
              'en_attente_coach': 'En attente coach',
              'en_attente_comptable': 'En attente comptable',
              'traite': 'Trait√©',
              'refuse': 'Refus√©'
            };
            const statut = statutsTraduction[rembours.statut] || rembours.statut || 'En attente';

            // Support pour diff√©rents formats de champs
            const telephone = rembours.telephone || rembours.tel || rembours.clientTelephone || 'N/A';
            const adresse = rembours.adresse || rembours.clientAdresse || '';
            const numeroSoumission = rembours.num || rembours.numeroSoumission || '';

            contentHTML += `
              <div class="p-4 rounded-lg border transition-all relative" style="background: rgba(251, 191, 36, 0.05); border: 1px solid rgba(251, 191, 36, 0.2);">
                <!-- Bouton Supprimer en haut √† droite -->
                <button onclick="supprimerRemboursement(${index})" class="absolute top-3 right-3 w-8 h-8 rounded-full flex items-center justify-center transition-all" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
                  <i class="fas fa-trash"></i>
                </button>

                <div class="flex flex-col">
                  <div class="pr-10">
                    <div class="flex items-center space-x-2 mb-2">
                      <h4 class="font-bold" style="color: var(--text-light);">
                        <i class="fas fa-undo mr-2" style="color: #fbbf24;"></i>
                        ${clientNom}
                      </h4>
                      <span class="px-2 py-0.5 rounded-full text-xs" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24;">
                        ${dateRemboursement}
                      </span>
                    </div>
                    <div class="space-y-1 text-sm mb-3">
                      ${numeroSoumission ? `
                      <div class="flex items-center" style="color: var(--text-gray);">
                        <i class="fas fa-hashtag w-4 mr-1"></i>
                        <span>${numeroSoumission}</span>
                      </div>
                      ` : ''}
                      <div class="flex items-center" style="color: var(--text-gray);">
                        <i class="fas fa-phone w-4 mr-1"></i>
                        <span>${telephone}</span>
                      </div>
                      ${adresse ? `
                      <div class="flex items-center" style="color: var(--text-gray);">
                        <i class="fas fa-map-marker-alt w-4 mr-1"></i>
                        <span>${adresse}</span>
                      </div>
                      ` : ''}
                      <div class="flex items-center" style="color: var(--text-gray);">
                        <i class="fas fa-dollar-sign w-4 mr-1"></i>
                        <span>${montant} $</span>
                      </div>
                      <div class="flex items-center" style="color: var(--text-gray);">
                        <i class="fas fa-info-circle w-4 mr-1"></i>
                        <span>Statut: ${statut}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Boutons en bas √† droite -->
                  <div class="flex justify-end items-center space-x-2">
                    ${rembours.pdfUrl || rembours.pdf_url ? `
                    <a href="${rembours.pdfUrl || rembours.pdf_url}" target="_blank" class="flex items-center justify-center" style="width: 32px; height: 32px;">
                      <img src="https://img.icons8.com/color/48/000000/pdf.png" alt="PDF" style="width: 28px; height: 28px;">
                    </a>
                    ` : ''}
                  </div>
                </div>
              </div>
            `;
          });

          contentHTML += '</div>';
        }

        modal.innerHTML = `
          <div class="p-6 max-w-3xl w-full mx-4 rounded-xl max-h-[80vh] flex flex-col" style="background: #1e293b; border: 1px solid var(--border-dark); box-shadow: var(--shadow-dark-medium);">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold" style="color: var(--text-light);">
                <i class="fas fa-undo mr-2" style="color: #fbbf24;"></i>
                Remboursements (<span id="remboursementsCount">${remboursements.length}</span>)
              </h3>
              <button onclick="closeRemboursementsModal()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24;" onmouseover="this.style.background='rgba(251, 191, 36, 0.3)'" onmouseout="this.style.background='rgba(251, 191, 36, 0.2)'">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <!-- Champ de recherche -->
            <div class="mb-4">
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-search" style="color: var(--text-gray);"></i>
                </div>
                <input type="text" id="searchRemboursements" placeholder="Rechercher dans Remboursements"
                       class="block w-full pl-10 pr-3 py-3 rounded-lg text-sm transition-all"
                       style="background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light);"
                       autocomplete="off"
                       oninput="filterRemboursements()" />
              </div>
            </div>

            <!-- Contenu avec scroll discret -->
            <div id="remboursementsContent" class="overflow-y-auto" style="height: calc(80vh - 140px); min-height: 500px; scrollbar-width: thin; scrollbar-color: rgba(148, 163, 184, 0.3) transparent;">
              ${contentHTML}
            </div>
          </div>

          <!-- Styles sp√©cifiques √† Facturation QE -->
        `;

        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';

        // Sauvegarder globalement pour les fonctions de filtrage et suppression
        window.remboursementsData = remboursements;

      } catch (error) {
        error('[ERROR] Erreur lors du chargement des remboursements:', error);
        alert('Erreur lors du chargement des remboursements');
      }
    };

    // Fonction pour fermer le modal remboursements
    window.closeRemboursementsModal = function() {
      const modal = document.getElementById('remboursementsModal');
      if (modal) {
        modal.remove();
        document.body.style.overflow = '';
      }
    };

    // Fonction pour filtrer les remboursements
    window.filterRemboursements = function() {
      const searchTerm = document.getElementById('searchRemboursements').value.toLowerCase();
      const content = document.getElementById('remboursementsContent');
      const items = content.querySelectorAll('.p-4');

      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? 'block' : 'none';
      });
    };

    // Fonction pour supprimer un remboursement
    window.supprimerRemboursement = async function(index) {
      if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce remboursement ?')) return;

      try {
        const rembours = window.remboursementsData[index];
        const username = getFacturationUsername();

        const response = await fetch(`${window.location.origin}/api/remboursements/${username}/${rembours.num}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          log('[OK] Remboursement supprim√©');
          closeRemboursementsModal();
          voirRemboursements(); // Recharger la liste
        } else {
          alert('Erreur lors de la suppression du remboursement');
        }
      } catch (error) {
        error('[ERROR] Erreur suppression:', error);
        alert('Erreur lors de la suppression');
      }
    };

    // Fonction pour formater les montants
    function formatMontant(montant) {
      if (!montant || montant === '0' || montant === 0) return '0,00 $';

      // Si c'est d√©j√† format√© avec $, le retourner tel quel
      if (montant.toString().includes('$')) {
        return montant.toString();
      }

      // Convertir en nombre si c'est une cha√Æne
      let nombre = parseFloat(montant.toString().replace(/[^0-9.-]/g, ''));
      if (isNaN(nombre)) return '0,00 $';

      // Formater manuellement pour √©viter les probl√®mes de locale
      return nombre.toFixed(2).replace('.', ',') + ' $';
    }

    // Fonction pour formater les montants avec espace pour les milliers
    function formatMontantAvecEspace(montant) {
      if (!montant || montant === '0' || montant === 0) return '0,00 $';

      // Convertir en string
      let strMontant = montant.toString();

      // Remplacer la virgule fran√ßaise par un point pour le parsing
      // D'abord supprimer les espaces (s√©parateurs de milliers)
      strMontant = strMontant.replace(/\s/g, '');
      // Remplacer la virgule par un point (s√©parateur d√©cimal fran√ßais -> anglais)
      strMontant = strMontant.replace(',', '.');
      // Supprimer tous les caract√®res non num√©riques sauf le point et le signe moins
      let cleanMontant = strMontant.replace(/[^0-9.-]/g, '');

      // Convertir en nombre
      let nombre = parseFloat(cleanMontant);
      if (isNaN(nombre)) return '0,00 $';

      // Formater avec deux d√©cimales
      let formatted = nombre.toFixed(2);

      // S√©parer partie enti√®re et d√©cimales
      let parts = formatted.split('.');
      let partieEntiere = parts[0];
      let partieDecimale = parts[1];

      // Ajouter des espaces pour les milliers
      partieEntiere = partieEntiere.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');

      // Retourner avec virgule et $
      return partieEntiere + ',' + partieDecimale + ' $';
    }

    // Fonction pour nettoyer et parser les montants
    function cleanAndParseAmount(montant) {
      if (!montant) return 0;
      const cleanValue = String(montant)
        .replace(/\s/g, '')
        .replace(/,/g, '.')
        .replace(/[^\d.]/g, '');
      return parseFloat(cleanValue) || 0;
    }

    // Event listener pour fermer le menu facturation en cliquant ailleurs
    document.addEventListener('click', function(event) {
      const input = document.getElementById('clientSearchFacturation');
      const menu = document.getElementById('clientMenuFacturation');
      
      if (input && menu) {
        if (event.target !== input && !menu.contains(event.target)) {
          fermerMenuFacturation();
        }
      }
    });

    // S'assurer que le menu correct reste actif selon la page
    document.addEventListener('DOMContentLoaded', function() {
      activateCurrentPageMenu();

      // Re-activer apr√®s un d√©lai pour contrer les autres scripts
      setTimeout(activateCurrentPageMenu, 150);
      setTimeout(activateCurrentPageMenu, 300);
    });

    // Fonction de d√©connexion
    window.logout = function() {
      localStorage.removeItem('username');
      localStorage.removeItem('token');
      window.location.href = '/';
    };
  </script>

  <!-- SCRIPT DE VALIDATION DES CHAMPS DE PAIEMENT -->
  <script>
    // ================================================================
    // SYST√àME DE VALIDATION VISUELLE - Bordures vertes/rouges
    // ================================================================

    // Variable globale pour stocker la section active
    let currentActiveSection = 'depot';

    // Fonction pour valider un champ et ajouter la classe appropri√©e
    function validateField(element, isRequired = true) {
      if (!element) return true;

      element.classList.remove('field-valid', 'field-invalid');

      let hasValue = false;

      // Pour les dropdowns
      if (element.classList.contains('modern-dropdown')) {
        const placeholder = element.querySelector('.placeholder');
        hasValue = !placeholder || placeholder.style.display === 'none' || !element.innerHTML.includes('Choisir');
      }
      // Pour les inputs
      else if (element.tagName === 'INPUT') {
        hasValue = element.value && element.value.trim() !== '' && element.value !== '0,00';
      }

      if (isRequired) {
        if (hasValue) {
          element.classList.add('field-valid');
        } else {
          element.classList.add('field-invalid');
        }
      }

      return hasValue;
    }

    // Fonction pour obtenir la m√©thode de paiement s√©lectionn√©e dans une section
    function getSelectedPaymentMethod(section) {
      let toggleId = '';
      if (section === 'depot') {
        toggleId = 'payeParToggle';
      } else if (section === 'paiement-final') {
        toggleId = 'payeParFinalToggle';
      } else if (section === 'autres-paiements') {
        toggleId = 'payeParAutresToggle';
      }

      const toggle = document.getElementById(toggleId);
      if (!toggle) return null;

      const text = toggle.textContent.toLowerCase();
      if (text.includes('virement')) return 'virement';
      if (text.includes('ch√®que') || text.includes('cheque')) return 'cheque';
      return null;
    }

    // Fonction pour valider la section D√©p√¥t
    function validateDepotSection() {
      let allValid = true;

      // Champs obligatoires: $ D√©p√¥t, Date d√©p√¥t, Pay√© par
      const paiementInput = document.getElementById('paiement');
      const dateDepotInput = document.getElementById('dateDepot');
      const payeParToggle = document.getElementById('payeParToggle');

      if (!validateField(paiementInput)) allValid = false;
      if (!validateField(dateDepotInput)) allValid = false;
      if (!validateField(payeParToggle)) allValid = false;

      // Validation conditionnelle selon la m√©thode de paiement
      const method = getSelectedPaymentMethod('depot');

      if (method === 'virement') {
        const lienVirementInput = document.querySelector('input[name="lien_virement"]');
        if (lienVirementInput && !lienVirementInput.closest('.hidden')) {
          if (!validateField(lienVirementInput)) allValid = false;
        }
        // mdp_virement n'est PAS obligatoire
        const mdpInput = document.querySelector('input[name="mdp_virement"]');
        if (mdpInput) {
          mdpInput.classList.remove('field-valid', 'field-invalid');
        }
      } else if (method === 'cheque') {
        const numChequeInput = document.querySelector('input[name="num_cheque"]');
        if (numChequeInput && !numChequeInput.closest('.hidden')) {
          if (!validateField(numChequeInput)) allValid = false;
        }
        // Photos de ch√®que obligatoires (recto et verso)
        const photoRecto = document.getElementById('photoFileRecto');
        const photoVerso = document.getElementById('photoFileVerso');
        const previewRecto = document.getElementById('previewRecto');
        const previewVerso = document.getElementById('previewVerso');

        // V√©rifier si les photos sont pr√©sentes (soit via input, soit via preview existant)
        const hasRecto = (photoRecto && photoRecto.files && photoRecto.files.length > 0) ||
                         (previewRecto && previewRecto.querySelector('img'));
        const hasVerso = (photoVerso && photoVerso.files && photoVerso.files.length > 0) ||
                         (previewVerso && previewVerso.querySelector('img'));

        if (!hasRecto || !hasVerso) {
          allValid = false;
          // Marquer visuellement les zones de drop comme invalides
          const dropzoneRecto = document.getElementById('dropzoneRecto');
          const dropzoneVerso = document.getElementById('dropzoneVerso');
          if (dropzoneRecto && !hasRecto) dropzoneRecto.classList.add('field-invalid');
          if (dropzoneVerso && !hasVerso) dropzoneVerso.classList.add('field-invalid');
        } else {
          const dropzoneRecto = document.getElementById('dropzoneRecto');
          const dropzoneVerso = document.getElementById('dropzoneVerso');
          if (dropzoneRecto) dropzoneRecto.classList.remove('field-invalid');
          if (dropzoneVerso) dropzoneVerso.classList.remove('field-invalid');
        }
      }

      return allValid;
    }

    // Fonction pour valider la section Paiement Final
    function validatePaiementFinalSection() {
      let allValid = true;

      // Champs obligatoires: $ Paiement final, Date paiement final, Pay√© par
      const paiementFinalInput = document.getElementById('paiementFinal');
      const datePaiementFinalInput = document.getElementById('datePaiementFinal');
      const payeParFinalToggle = document.getElementById('payeParFinalToggle');

      if (!validateField(paiementFinalInput)) allValid = false;
      if (!validateField(datePaiementFinalInput)) allValid = false;
      if (!validateField(payeParFinalToggle)) allValid = false;

      // Validation conditionnelle selon la m√©thode de paiement
      const method = getSelectedPaymentMethod('paiement-final');

      if (method === 'virement') {
        const lienVirementInput = document.querySelector('input[name="lien_virement_final"]');
        if (lienVirementInput && !lienVirementInput.closest('.hidden')) {
          if (!validateField(lienVirementInput)) allValid = false;
        }
        // mdp_virement_final n'est PAS obligatoire
        const mdpInput = document.querySelector('input[name="mdp_virement_final"]');
        if (mdpInput) {
          mdpInput.classList.remove('field-valid', 'field-invalid');
        }
      } else if (method === 'cheque') {
        const numChequeInput = document.querySelector('input[name="num_cheque_final"]');
        if (numChequeInput && !numChequeInput.closest('.hidden')) {
          if (!validateField(numChequeInput)) allValid = false;
        }
        // Photos de ch√®que obligatoires (recto et verso)
        const photoRecto = document.getElementById('photoFileRectoFinal');
        const photoVerso = document.getElementById('photoFileVersoFinal');
        const previewRecto = document.getElementById('previewRectoFinal');
        const previewVerso = document.getElementById('previewVersoFinal');

        const hasRecto = (photoRecto && photoRecto.files && photoRecto.files.length > 0) ||
                         (previewRecto && previewRecto.querySelector('img'));
        const hasVerso = (photoVerso && photoVerso.files && photoVerso.files.length > 0) ||
                         (previewVerso && previewVerso.querySelector('img'));

        if (!hasRecto || !hasVerso) {
          allValid = false;
          const dropzoneRecto = document.getElementById('dropzoneRectoFinal');
          const dropzoneVerso = document.getElementById('dropzoneVersoFinal');
          if (dropzoneRecto && !hasRecto) dropzoneRecto.classList.add('field-invalid');
          if (dropzoneVerso && !hasVerso) dropzoneVerso.classList.add('field-invalid');
        } else {
          const dropzoneRecto = document.getElementById('dropzoneRectoFinal');
          const dropzoneVerso = document.getElementById('dropzoneVersoFinal');
          if (dropzoneRecto) dropzoneRecto.classList.remove('field-invalid');
          if (dropzoneVerso) dropzoneVerso.classList.remove('field-invalid');
        }
      }

      return allValid;
    }

    // Fonction pour valider la section Autres Paiements
    function validateAutresPaiementsSection() {
      let allValid = true;

      // Champs obligatoires: Type de paiement, $ Montant, Date paiement, Pay√© par
      const typePaiementToggle = document.getElementById('typePaiementAutresToggle');
      const paiementAutresInput = document.getElementById('paiementAutres');
      const datePaiementAutresInput = document.getElementById('datePaiementAutres');
      const payeParAutresToggle = document.getElementById('payeParAutresToggle');

      if (!validateField(typePaiementToggle)) allValid = false;
      if (!validateField(paiementAutresInput)) allValid = false;
      if (!validateField(datePaiementAutresInput)) allValid = false;
      if (!validateField(payeParAutresToggle)) allValid = false;

      // Validation conditionnelle selon la m√©thode de paiement
      const method = getSelectedPaymentMethod('autres-paiements');

      if (method === 'virement') {
        const lienVirementInput = document.querySelector('input[name="lien_virement_autres"]');
        if (lienVirementInput && !lienVirementInput.closest('.hidden')) {
          if (!validateField(lienVirementInput)) allValid = false;
        }
        // mdp_virement_autres n'est PAS obligatoire
        const mdpInput = document.querySelector('input[name="mdp_virement_autres"]');
        if (mdpInput) {
          mdpInput.classList.remove('field-valid', 'field-invalid');
        }
      } else if (method === 'cheque') {
        const numChequeInput = document.querySelector('input[name="num_cheque_autres"]');
        if (numChequeInput && !numChequeInput.closest('.hidden')) {
          if (!validateField(numChequeInput)) allValid = false;
        }
      }

      return allValid;
    }

    // Fonction principale de validation bas√©e sur la section active
    function validateCurrentSection() {
      const bouton = document.getElementById('envoyerComptableBtn');
      if (!bouton) return;

      let isValid = false;

      // D√©terminer la section active
      const contentDepot = document.getElementById('content-depot');
      const contentPaiementFinal = document.getElementById('content-paiement-final');
      const contentAutresPaiements = document.getElementById('content-autres-paiements');

      if (contentDepot && !contentDepot.classList.contains('hidden')) {
        currentActiveSection = 'depot';
        isValid = validateDepotSection();
      } else if (contentPaiementFinal && !contentPaiementFinal.classList.contains('hidden')) {
        currentActiveSection = 'paiement-final';
        isValid = validatePaiementFinalSection();
      } else if (contentAutresPaiements && !contentAutresPaiements.classList.contains('hidden')) {
        currentActiveSection = 'autres-paiements';
        isValid = validateAutresPaiementsSection();
      }

      // Activer/d√©sactiver le bouton et afficher/cacher le message d'avertissement
      const warningMessage = document.getElementById('validationWarningMessage');
      if (isValid) {
        bouton.classList.remove('btn-disabled');
        bouton.disabled = false;
        if (warningMessage) warningMessage.style.display = 'none';
      } else {
        bouton.classList.add('btn-disabled');
        bouton.disabled = true;
        if (warningMessage) warningMessage.style.display = 'block';
      }

      log('[VALIDATION] Section:', currentActiveSection, '- Valid:', isValid);
    }

    // Fonction pour r√©initialiser la validation (enlever toutes les classes)
    function resetValidation() {
      document.querySelectorAll('.field-valid, .field-invalid').forEach(el => {
        el.classList.remove('field-valid', 'field-invalid');
      });

      const bouton = document.getElementById('envoyerComptableBtn');
      if (bouton) {
        bouton.classList.add('btn-disabled');
        bouton.disabled = true;
      }
    }

    // Attacher les event listeners au chargement
    document.addEventListener('DOMContentLoaded', function() {
      // Liste des champs √† surveiller pour D√âP√îT
      const depotFields = [
        'paiement',
        'dateDepot'
      ];

      // Liste des champs √† surveiller pour PAIEMENT FINAL
      const paiementFinalFields = [
        'paiementFinal',
        'datePaiementFinal'
      ];

      // Liste des champs √† surveiller pour AUTRES PAIEMENTS
      const autresPaiementsFields = [
        'paiementAutres',
        'datePaiementAutres'
      ];

      // Attacher les listeners sur les inputs
      [...depotFields, ...paiementFinalFields, ...autresPaiementsFields].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', validateCurrentSection);
          field.addEventListener('change', validateCurrentSection);
          field.addEventListener('blur', validateCurrentSection);
        }
      });

      // Surveiller aussi les inputs de virement/ch√®que
      const virementChequeInputs = [
        'input[name="lien_virement"]',
        'input[name="num_cheque"]',
        'input[name="lien_virement_final"]',
        'input[name="num_cheque_final"]',
        'input[name="lien_virement_autres"]',
        'input[name="num_cheque_autres"]'
      ];

      virementChequeInputs.forEach(selector => {
        const input = document.querySelector(selector);
        if (input) {
          input.addEventListener('input', validateCurrentSection);
          input.addEventListener('change', validateCurrentSection);
        }
      });

      // Surveiller les inputs de fichiers photo (ch√®ques)
      const photoInputs = [
        'photoFileRecto', 'photoFileVerso',
        'photoFileRectoFinal', 'photoFileVersoFinal',
        'photoFileRectoAutres', 'photoFileVersoAutres'
      ];
      photoInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          input.addEventListener('change', validateCurrentSection);
        }
      });

      // Observer les changements de dropdowns (Pay√© par et Type de paiement)
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList' || mutation.type === 'characterData') {
            setTimeout(validateCurrentSection, 100);
          }
        });
      });

      const dropdownIds = [
        'payeParToggle',
        'payeParFinalToggle',
        'payeParAutresToggle',
        'typePaiementAutresToggle'
      ];

      dropdownIds.forEach(id => {
        const dropdown = document.getElementById(id);
        if (dropdown) {
          observer.observe(dropdown, { childList: true, subtree: true, characterData: true });

          // Aussi √©couter les clics sur les options du menu associ√©
          const menuId = id.replace('Toggle', 'Menu');
          const menu = document.getElementById(menuId);
          if (menu) {
            menu.addEventListener('click', function() {
              setTimeout(validateCurrentSection, 150);
            });
          }
        }
      });

      // Validation initiale d√©sactiv√©e (bouton gris√© par d√©faut)
      const bouton = document.getElementById('envoyerComptableBtn');
      if (bouton) {
        bouton.classList.add('btn-disabled');
        bouton.disabled = true;
      }

      log('[VALIDATION] Syst√®me de validation initialis√©');
    });

    // Surcharger showPaiementSection pour d√©clencher la validation
    const originalShowPaiementSection = window.showPaiementSection;
    window.showPaiementSection = function(section) {
      if (originalShowPaiementSection) {
        originalShowPaiementSection(section);
      }
      // R√©initialiser et revalider apr√®s changement de section
      setTimeout(function() {
        resetValidation();
        validateCurrentSection();
      }, 200);
    };
  </script>

  <!-- Modal d'erreur remboursement -->
  <div id="erreurRemboursementModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-8 w-[500px] mx-4 relative" style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 20px;">
      <div class="text-center">
        <div class="mb-4">
          <i class="fas fa-exclamation-circle text-6xl text-red-500"></i>
        </div>
        <h3 class="text-2xl font-bold mb-4" style="color: var(--text-light);">
          Remboursement impossible
        </h3>
        <p id="erreurRemboursementTexte" class="text-lg mb-6" style="color: var(--text-gray);">
          <!-- Le message sera ins√©r√© ici -->
        </p>
        <button onclick="fermerErreurRemboursement()" class="btn-primary px-8 py-3 rounded-lg font-semibold">
          <i class="fas fa-check mr-2"></i>
          Compris
        </button>
      </div>
    </div>
  </div>

  <!-- Modal pour voir la soumission sign√©e -->
  <div id="soumissionSigneeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 w-[85vw] mx-4 max-h-[90vh] relative" style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 20px;">
      <!-- En-t√™te avec titre et bouton fermer sur la m√™me ligne -->
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-file-contract mr-2 text-green-500"></i>
          Soumission sign√©e
        </h3>
        <button onclick="fermerModalSoumission()" class="px-3 py-1.5 rounded-lg font-medium transition-all duration-300 text-sm flex items-center gap-2 btn-secondary hover:opacity-80">
          <i class="fas fa-times"></i>
          Fermer
        </button>
      </div>

      <div id="soumissionContent" class="space-y-4" style="color: var(--text-light);">
        <!-- Le contenu de la soumission sera charg√© dynamiquement -->
        <div class="flex items-center justify-center py-8">
          <i class="fas fa-spinner fa-spin mr-2"></i>
          Chargement de la soumission...
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour proc√©der √† un remboursement -->
  <div id="remboursementProcedureModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50" style="backdrop-filter: blur(5px);">
    <div class="bg-white p-8 w-[40vw] mx-4 max-h-[85vh] overflow-y-auto relative" style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 20px;">
      <!-- En-t√™te avec titre et bouton fermer sur la m√™me ligne -->
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-undo mr-2 text-red-500"></i>
          Proc√©der √† un remboursement
        </h3>
        <button onclick="fermerPopupRemboursement()" class="px-3 py-1.5 rounded-lg font-medium transition-all duration-300 text-sm flex items-center gap-2 btn-secondary hover:opacity-80">
          <i class="fas fa-times"></i>
          Fermer
        </button>
      </div>

      <!-- Formulaire de remboursement -->
      <form id="formRemboursement" class="space-y-6">
        <!-- Nom du client -->
        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-user mr-2 text-blue-500"></i>
            Nom du client
          </label>
          <input type="text" id="remb-client" placeholder="Nom du client" class="modern-input w-full" style="background: rgba(55, 65, 81, 0.3) !important; color: var(--text-light) !important; border-color: rgba(75, 85, 99, 0.3) !important; cursor: not-allowed !important; opacity: 0.7 !important; pointer-events: none !important;" readonly>
        </div>

        <!-- N¬∞ Soumission -->
        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-hashtag mr-2 text-gray-500"></i>
            N¬∞ Soumission
          </label>
          <input type="text" id="remb-num-soumission" placeholder="24-0001" class="modern-input w-full" style="background: rgba(55, 65, 81, 0.3) !important; color: var(--text-light) !important; border-color: rgba(75, 85, 99, 0.3) !important; cursor: not-allowed !important; opacity: 0.7 !important; pointer-events: none !important;" readonly>
        </div>

        <!-- Paiement √† rembourser -->
        <div style="position: relative;">
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-dollar-sign mr-2 text-red-500"></i>
            Paiement √† rembourser
          </label>
          <input type="hidden" id="remb-montant" required>
          <div class="dropdown-secondary" id="remb-montant-dropdown" style="width: 100% !important; background: #172033; border: 2px solid var(--border-dark); color: var(--text-light); border-radius: 12px; padding: 12px 16px; font-size: 0.875rem; cursor: pointer;">
            <span id="remb-montant-selected">S√©lectionner un paiement</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="dropdown-secondary-menu" id="remb-montant-menu" style="background: #0f172a; border: 2px solid var(--border-dark); border-radius: 12px; display: none;">
          </div>
        </div>

        <!-- Courriel pour le virement -->
        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-envelope mr-2 text-blue-500"></i>
            Courriel du client pour le remboursement
          </label>
          <input type="email" id="remb-courriel" placeholder="client@exemple.com" class="modern-input w-full" required>
        </div>

        <!-- Boutons d'action -->
        <div class="flex justify-end gap-4 pt-4 border-t" style="border-color: var(--border-dark);">
          <button type="button" onclick="fermerPopupRemboursement()" class="btn-secondary px-3 py-1.5">
            <i class="fas fa-times mr-2"></i>
            Annuler
          </button>
          <button type="submit" class="btn-primary px-3 py-1.5" style="background: #dc2626 !important;">
            <i class="fas fa-check mr-2"></i>
            Confirmer le remboursement
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de confirmation personnalis√© -->
  <div id="customConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[60]" style="backdrop-filter: blur(5px);">
    <div class="bg-white p-6 w-[450px] mx-4 relative" style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
      <div class="flex items-start gap-4 mb-6">
        <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center" style="background: rgba(234, 179, 8, 0.2);">
          <i class="fas fa-question-circle text-2xl text-yellow-500"></i>
        </div>
        <div class="flex-1">
          <h3 class="text-lg font-bold mb-2" style="color: var(--text-light);">Confirmation</h3>
          <p id="customConfirmMessage" style="color: var(--text-gray);"></p>
        </div>
      </div>
      <div class="flex justify-end gap-3">
        <button onclick="customConfirmCancel()" class="btn-secondary px-4 py-2">
          <i class="fas fa-times mr-2"></i>
          Annuler
        </button>
        <button id="customConfirmBtn" class="btn-primary px-4 py-2" style="background: #10b981 !important;">
          <i class="fas fa-check mr-2"></i>
          Confirmer
        </button>
      </div>
    </div>
  </div>

  <!-- Modal d'alerte personnalis√© -->
  <div id="customAlertModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[60]" style="backdrop-filter: blur(5px);">
    <div class="bg-white p-6 w-[450px] mx-4 relative" style="background: var(--bg-card); border: 1px solid var(--border-dark); border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
      <div class="flex items-start gap-4 mb-6">
        <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center" id="customAlertIcon">
          <i class="fas fa-info-circle text-2xl text-blue-500"></i>
        </div>
        <div class="flex-1">
          <h3 class="text-lg font-bold mb-2" id="customAlertTitle" style="color: var(--text-light);">Information</h3>
          <p id="customAlertMessage" style="color: var(--text-gray);"></p>
        </div>
      </div>
      <div class="flex justify-end">
        <button onclick="customAlertClose()" class="btn-primary px-4 py-2">
          <i class="fas fa-check mr-2"></i>
          OK
        </button>
      </div>
    </div>
  </div>

  <!-- Modal pour afficher les images de ch√®que -->
  <div id="modalImage" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-[70]" style="backdrop-filter: blur(8px);" onclick="fermerModalImage()">
    <div class="relative w-[90vw] max-w-5xl mx-4" onclick="event.stopPropagation()">
      <!-- Header avec titre et bouton fermer -->
      <div class="flex items-center justify-between mb-4 px-4">
        <h3 id="modalImageTitle" class="text-xl font-bold text-white">
          <i class="fas fa-image mr-2 text-blue-400"></i>
          <span id="modalImageTitleText"></span>
        </h3>
        <button onclick="fermerModalImage()" class="text-white hover:text-red-400 transition-colors text-2xl" title="Fermer">
          <i class="fas fa-times-circle"></i>
        </button>
      </div>

      <!-- Container de l'image avec style dark -->
      <div class="image-container" style="width: 100%; max-height: 80vh; background: #1a1a1a; border-radius: 12px; overflow: auto; padding: 20px; box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8);">
        <img id="modalImageContent" src="" alt="" style="width: 100%; height: auto; border-radius: 8px; display: block; margin: 0 auto;">
      </div>

      <!-- Bouton d'action en bas -->
      <div class="flex justify-center mt-4">
        <button onclick="fermerModalImage()" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-lg font-medium transition-all duration-300 shadow-lg">
          <i class="fas fa-check mr-2"></i>
          Fermer
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de validation coach pour les remboursements -->
  <div id="coachRemboursementValidationModal" class="fixed inset-0 flex items-center justify-center hidden z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px);">
    <div class="p-8 w-[55vw] mx-4 max-h-[85vh] overflow-y-auto relative" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid var(--border-dark); border-radius: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);">
      <!-- En-t√™te avec titre et bouton fermer -->
      <div class="flex justify-between items-center mb-8 pb-6 border-b" style="border-color: var(--border-dark);">
        <div>
          <h3 class="text-2xl font-bold mb-1" style="color: var(--text-light);">
            <i class="fas fa-undo mr-3" style="color: #fbbf24;"></i>
            Remboursements en attente
          </h3>
          <p class="text-sm ml-10" style="color: var(--text-gray);">Validation coach requise</p>
        </div>
        <button onclick="fermerPopupCoachValidation()" class="w-10 h-10 rounded-full flex items-center justify-center transition-all duration-300" style="background: rgba(148, 163, 184, 0.2); color: var(--text-gray);" onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'; this.style.color='#ef4444'" onmouseout="this.style.background='rgba(148, 163, 184, 0.2)'; this.style.color='var(--text-gray)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Liste des remboursements en attente -->
      <div id="listeRemboursementsCoach" class="space-y-4">
        <!-- Les remboursements seront ins√©r√©s ici par JavaScript -->
      </div>
    </div>
  </div>

  <script>
    // Fonction pour retourner √† la page de gestions
    function goBackToGestions() {
      window.location.href = '/gestionsmobile';
    }
  </script>

  <!-- Inline entrepreneur selector script removed - now handled by shared /entrepreneur-selector.js -->

  <script>
  // Removed old inline entrepreneur selector code (lines 10401-10745)
  // Now using /entrepreneur-selector.js for coach/direction selector
  // This comment preserves line numbers for debugging

  (function() {
    // NOTE: Event listeners are now handled by /entrepreneur-selector.js
    // This script only handles coach-specific data loading and selection logic
    const userRole = localStorage.getItem('userRole');
    const isCoachOrDirection = userRole === 'coach' || userRole === 'direction';

    if (isCoachOrDirection) {
      // NOTE: coach-mode class is now added by /entrepreneur-selector.js
      // document.body.classList.add('coach-mode'); // REMOVED - handled by entrepreneur-selector.js

      // Sauvegarder le username du coach pour les appels API ult√©rieurs
      // Car selectEntrepreneur() va √©craser localStorage avec l'entrepreneur
      const coachUsername = localStorage.getItem('username') || window.username;
      window.coachUsername = coachUsername;
      log('[COACH] Username du coach initial:', coachUsername);

      // NOTE: selector.classList.add('visible') is now handled by /entrepreneur-selector.js
      // const selector = document.getElementById('coach-entrepreneur-selector');
      // if (selector) {
      //   selector.classList.add('visible');
      // }

      // NOTE: loadEntrepreneursForCoach() removed - now handled by /entrepreneur-selector.js
      // The entrepreneur loading and dropdown population is now centralized
      // loadEntrepreneursForCoach();

      // NOTE: Dropdown event listeners removed - now handled by /entrepreneur-selector.js
      // const dropdownToggle = document.getElementById('coach-dropdown-toggle');
      // const dropdownMenu = document.getElementById('coach-dropdown-menu');
      //
      // if (dropdownToggle && dropdownMenu) {
      //   dropdownToggle.addEventListener('click', function(e) {
      //     e.stopPropagation();
      //     this.classList.toggle('active');
      //     dropdownMenu.classList.toggle('show');
      //   });
      //
      //   document.addEventListener('click', function(e) {
      //     if (!dropdownToggle.contains(e.target) && !dropdownMenu.contains(e.target)) {
      //       dropdownToggle.classList.remove('active');
      //       dropdownMenu.classList.remove('show');
      //     }
      //   });
      // }
    }

    async function selectEntrepreneur(username) {
      const dropdownToggle = document.getElementById('coach-dropdown-toggle');
      const dropdownMenu = document.getElementById('coach-dropdown-menu');
      const selector = document.getElementById('coach-entrepreneur-selector');
      const backdrop = document.getElementById('coach-selector-backdrop');

      if (dropdownToggle) {
        dropdownToggle.innerHTML = `
          <span class="selected-text">
            <i class="fas fa-user-circle"></i>
            ${username}
          </span>
          <i class="fas fa-chevron-down chevron"></i>
        `;

        dropdownToggle.classList.remove('active');
        if (dropdownMenu) {
          dropdownMenu.classList.remove('show');
        }

        // Transition vers le mode header
        if (selector) {
          selector.classList.add('in-header');
        }
        if (backdrop) {
          backdrop.classList.remove('visible');
        }

        // R√©v√©ler le contenu principal
        document.body.classList.add('has-selection');

        // Retirer le CSS anti-flash
        const antiFlashCss = document.getElementById('coach-anti-flash-css');
        if (antiFlashCss) {
          antiFlashCss.remove();
        }

        // Forcer l'affichage du contenu principal
        const mainContent = document.querySelector('.main-content');
        if (mainContent) {
          mainContent.style.opacity = '1';
          mainContent.style.pointerEvents = 'all';
        }

        // Nettoyer les donn√©es du client pr√©c√©dent
        sessionStorage.removeItem('selectedClientDataFacturation');
        sessionStorage.removeItem('selectedClientFacturation');
        sessionStorage.removeItem('selectedClientNameFacturation');
        sessionStorage.removeItem('selectedClientData');
        sessionStorage.removeItem('selectedClientDataRemboursement');

        // IMPORTANT: Vider les caches de clients pour forcer un rechargement
        window.clientsFacturationData = [];
        window.clientsRemboursementData = [];

        // R√©initialiser les dropdowns de s√©lection de client
        const clientSearchFacturation = document.getElementById('clientSearchFacturation');
        if (clientSearchFacturation) clientSearchFacturation.value = '';

        const clientMenuFacturation = document.getElementById('clientMenuFacturation');
        if (clientMenuFacturation) {
          clientMenuFacturation.innerHTML = '';
          clientMenuFacturation.classList.add('hidden');
        }

        const clientSearchRemboursement = document.getElementById('clientSearchRemboursement');
        if (clientSearchRemboursement) clientSearchRemboursement.value = '';

        const clientMenuRemboursement = document.getElementById('clientMenuRemboursement');
        if (clientMenuRemboursement) {
          clientMenuRemboursement.innerHTML = '';
          clientMenuRemboursement.classList.add('hidden');
        }

        // R√©initialiser les champs d'information client
        const clientInfo = document.getElementById('clientInfo');
        if (clientInfo) clientInfo.value = '';

        const totalTravauxClient = document.getElementById('totalTravauxClient');
        if (totalTravauxClient) totalTravauxClient.value = '';

        // R√©initialiser l'interface - cacher les sections client
        const detailsClient = document.getElementById('detailsClient');
        if (detailsClient) detailsClient.style.display = 'none';

        const workflowButtonsContainer = document.getElementById('workflow-buttons-container');
        if (workflowButtonsContainer) workflowButtonsContainer.style.display = 'none';

        const boutonEnvoiContainer = document.getElementById('boutonEnvoiContainer');
        if (boutonEnvoiContainer) boutonEnvoiContainer.style.display = 'none';

        // Mettre √† jour le username pour l'entrepreneur s√©lectionn√©
        window.username = username;
        // IMPORTANT: Mettre √† jour aussi sessionStorage et localStorage
        // pour que getFacturationUsername() retourne le bon entrepreneur
        sessionStorage.setItem('username', username);
        localStorage.setItem('username', username);
        log('[COACH] Username mis √† jour vers:', username);

        // Initialiser le menu d√©roulant de s√©lection client
        if (typeof initClientSelect === 'function') {
          initClientSelect();
        }

        // Recharger les clients facturation depuis l'API
        log('[COACH] Chargement des clients facturation pour:', username);
        if (typeof chargerClientsDepuisAPI === 'function') {
          await chargerClientsDepuisAPI();
        }

        // Charger les clients depuis les soumissions (pour l'ancien syst√®me)
        if (typeof chargerClients === 'function') {
          await chargerClients();
        }

        // Charger toutes les facturations depuis l'API
        log('[COACH] Chargement des facturations pour:', username);
        if (typeof chargerFacturationsDepuisAPI === 'function') {
          await chargerFacturationsDepuisAPI();
        }

        // Recharger les colonnes Status automatiquement
        if (typeof utiliserDonneesTestStatus === 'function') {
          log('üîÑ Rechargement automatique des colonnes Status pour:', username);
          await utiliserDonneesTestStatus();
        }

        // Recharger les facturations du nouvel entrepreneur (apr√®s avoir charg√© les donn√©es)
        if (typeof chargerFacturationsColonnes === 'function') {
          chargerFacturationsColonnes();
        }

        // Charger aussi les p√©riodes dans la colonne Trait√©es
        if (typeof chargerPeriodesTraiter === 'function') {
          chargerPeriodesTraiter();
        }

        // IMPORTANT: Initialiser les dropdowns de paiement apr√®s avoir charg√© l'entrepreneur
        console.log('[COACH SELECT] Initialisation des dropdowns de paiement...');
        const dropdownsToReinit = ['typePaiementAutresToggle', 'payeParToggle', 'payeParFinalToggle', 'payeParAutresToggle', 'payeParRemboursementToggle'];
        dropdownsToReinit.forEach(id => {
          const element = document.getElementById(id);
          if (element && element.dataset.initialized) {
            delete element.dataset.initialized;
          }
        });
        if (typeof initPaiementSelects === 'function') {
          initPaiementSelects();
          console.log('[COACH SELECT] ‚úÖ Dropdowns de paiement initialis√©s');
        }
      }
    }

    async function loadEntrepreneursForCoach() {
      // Si entrepreneur-selector.js est charg√©, utiliser celui-ci au lieu de cette fonction legacy
      if (window.EntrepreneurSelector) {
        log('[FACTURATION] Using EntrepreneurSelector.reload() instead of legacy function');
        window.EntrepreneurSelector.reload();
        return;
      }

      try {
        // IMPORTANT: Utiliser le username du coach sauvegard√©
        // On le r√©cup√®re depuis window.coachUsername (sauvegard√© au premier chargement)
        let coachUsername = window.coachUsername;

        if (!coachUsername) {
          // Premi√®re fois : d√©terminer le username du coach
          // 1. V√©rifier le localStorage
          coachUsername = localStorage.getItem('username');

          // 2. Si le localStorage contient un entrepreneur (pas un coach), chercher ailleurs
          if (coachUsername && !isCoachUsername(coachUsername)) {
            // Le localStorage contient un entrepreneur s√©lectionn√© pr√©c√©demment
            // Chercher le coach dans window.username (common.js) ou dans l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const userParam = urlParams.get('user');

            // Si l'URL contient un coach, l'utiliser
            if (userParam && isCoachUsername(userParam)) {
              coachUsername = userParam;
            } else if (window.username && isCoachUsername(window.username)) {
              // Sinon utiliser window.username si c'est un coach
              coachUsername = window.username;
            } else {
              // Cas probl√©matique : on ne peut pas d√©terminer le coach
              error('[COACH] Impossible de d√©terminer le username du coach');
              error('[COACH] localStorage:', localStorage.getItem('username'));
              error('[COACH] window.username:', window.username);
              error('[COACH] URL user param:', userParam);
              return;
            }
          }

          window.coachUsername = coachUsername;
          log('[COACH] Username du coach sauvegard√©:', coachUsername);
        }

        if (!coachUsername || coachUsername === 'demo' || !isCoachUsername(coachUsername)) {
          error('[COACH] Username invalide pour loadEntrepreneursForCoach:', coachUsername);
          return;
        }

        log('[COACH] Chargement entrepreneurs pour coach:', coachUsername);
        const response = await fetch(`/api/users/entrepreneurs?coach_username=${coachUsername}`);
        const data = await response.json();

        // Charger aussi la liste des facturations en traitement pour avoir le count par entrepreneur
        let countByEntrepreneur = {};
        let totalCount = 0;
        try {
          const facturationResponse = await fetch('/api/coach/facturation-en-traitement/count');
          const facturationData = await facturationResponse.json();
          countByEntrepreneur = facturationData.details || {};
          totalCount = facturationData.count || 0;
          log('Facturation en traitement - Count par entrepreneur:', countByEntrepreneur);
          log('Facturation en traitement - Total:', totalCount);
        } catch (err) {
          error('Erreur chargement count facturations:', err);
        }

        const menu = document.getElementById('coach-dropdown-menu');
        const toggle = document.getElementById('coach-dropdown-toggle');
        if (!menu) return;

        menu.innerHTML = '';

        if (data.entrepreneurs && data.entrepreneurs.length > 0) {
          data.entrepreneurs.forEach(entrepreneur => {
            const option = document.createElement('div');
            option.className = 'coach-dropdown-option';
            option.style.display = 'flex';
            option.style.alignItems = 'center';
            option.style.justifyContent = 'space-between';

            const nameSpan = document.createElement('span');
            nameSpan.innerHTML = `
              <i class="fas fa-user-circle"></i>
              <span>${entrepreneur.username}</span>
            `;
            nameSpan.style.display = 'flex';
            nameSpan.style.alignItems = 'center';
            nameSpan.style.gap = '0.75rem';
            option.appendChild(nameSpan);

            // Ajouter le badge si cet entrepreneur a des facturations en traitement
            const count = countByEntrepreneur[entrepreneur.username] || 0;
            log(`Entrepreneur "${entrepreneur.username}" a ${count} facturations en traitement`);

            if (count > 0) {
              log(`‚Üí Ajout du badge pour ${entrepreneur.username}`);
              const badge = document.createElement('span');
              badge.className = 'entrepreneur-badge';
              badge.textContent = count;
              badge.style.cssText = `
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 20px;
                height: 20px;
                padding: 0 6px;
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                color: white;
                font-size: 0.75rem;
                font-weight: 700;
                border-radius: 10px;
              `;
              option.appendChild(badge);
            }

            option.onclick = () => selectEntrepreneur(entrepreneur.username);
            menu.appendChild(option);
          });

          // Ajouter le badge total sur le toggle s'il y a des facturations en traitement
          if (totalCount > 0 && toggle) {
            // Cr√©er le badge pour le toggle s'il n'existe pas d√©j√†
            let toggleBadge = toggle.querySelector('.toggle-badge');
            if (!toggleBadge) {
              toggleBadge = document.createElement('span');
              toggleBadge.className = 'toggle-badge';
              toggleBadge.style.cssText = `
                position: absolute;
                top: -8px;
                right: -8px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 20px;
                height: 20px;
                padding: 0 6px;
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                color: white;
                font-size: 0.7rem;
                font-weight: 700;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
                z-index: 10;
              `;
              toggle.style.position = 'relative';
              toggle.appendChild(toggleBadge);
            }
            toggleBadge.textContent = totalCount;
            toggleBadge.style.display = 'inline-flex';
          } else if (toggle) {
            // Cacher le badge s'il n'y a pas de facturations en traitement
            const toggleBadge = toggle.querySelector('.toggle-badge');
            if (toggleBadge) {
              toggleBadge.style.display = 'none';
            }
          }

          // V√©rifier si un entrepreneur est d√©j√† s√©lectionn√© via URL
          const urlParams = new URLSearchParams(window.location.search);
          const selectedUser = urlParams.get('user');

          // IMPORTANT: Seulement s√©lectionner si c'est un entrepreneur, pas un coach
          if (selectedUser && !isCoachUsername(selectedUser)) {
            // Un entrepreneur est s√©lectionn√© via URL - le marquer comme s√©lectionn√©
            log('[COACH] Entrepreneur d√©tect√© dans URL:', selectedUser);
            selectEntrepreneur(selectedUser);
          } else if (!selectedUser || isCoachUsername(selectedUser)) {
            // Pas de s√©lection OU le param√®tre user est un coach - ne pas auto-s√©lectionner
            log('[COACH] Attente de s√©lection manuelle (user param:', selectedUser, ')');
          }
        } else {
          const option = document.createElement('div');
          option.className = 'coach-dropdown-option-disabled';
          option.textContent = 'Aucun entrepreneur trouv√©';
          menu.appendChild(option);
        }
      } catch (error) {
        error('Erreur chargement entrepreneurs:', error);
      }
    }
  })();
  </script>

  <!-- Modal D√©tails Traitement Coach -->
  <div id="modalDetailsTraitement" class="modal-details-traitement" style="display: none;">
    <div class="modal-details-backdrop" onclick="fermerModalDetailsTraitement()"></div>
    <div class="modal-details-content">
      <div class="modal-details-header">
        <div class="modal-header-title">
          <i class="fas fa-file-invoice-dollar"></i>
          <h2>D√©tails du paiement</h2>
        </div>
        <button class="modal-close-btn" onclick="fermerModalDetailsTraitement()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-details-body" id="modalDetailsBody">
        <!-- Contenu dynamique -->
      </div>

      <div class="modal-details-footer">
        <button class="btn btn-secondary" id="btnRefuser" onclick="refuserDepuisModal()">
          <i class="fas fa-times mr-2"></i>Refuser
        </button>
        <button class="btn btn-primary" id="btnAccepter" onclick="accepterDepuisModal()">
          <i class="fas fa-check mr-2"></i>Accepter
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Refus avec Raison - Coach -->
  <div id="modalRefusCoach" class="modal-refus-coach" style="display: none;">
    <div class="modal-refus-backdrop" onclick="fermerModalRefusCoach()"></div>
    <div class="modal-refus-content">
      <div class="modal-refus-header">
        <div class="modal-header-title">
          <i class="fas fa-times-circle" style="color: #ef4444;"></i>
          <h2>Refuser le paiement</h2>
        </div>
        <button class="modal-close-btn" onclick="fermerModalRefusCoach()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-refus-body">
        <p style="color: var(--text-gray); margin-bottom: 1rem;">
          Veuillez indiquer la raison du refus. Cette information sera transmise √† l'entrepreneur.
        </p>
        <div class="form-group">
          <label for="raisonRefusCoach" style="color: var(--text-light); font-weight: 500; margin-bottom: 0.5rem; display: block;">
            Raison du refus <span style="color: #ef4444;">*</span>
          </label>
          <textarea
            id="raisonRefusCoach"
            placeholder="Ex: Montant incorrect, justificatif manquant, etc."
            rows="4"
            style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border-dark); background: rgba(15, 23, 42, 0.5); color: var(--text-light); font-size: 0.9rem; resize: vertical;"
          ></textarea>
        </div>
      </div>
      <div class="modal-refus-footer">
        <button class="btn-annuler-coach" onclick="fermerModalRefusCoach()">
          <i class="fas fa-arrow-left"></i> Annuler
        </button>
        <button class="btn-confirmer-refus-coach" onclick="confirmerRefusCoach()">
          <i class="fas fa-times"></i> Confirmer le refus
        </button>
      </div>
    </div>
  </div>

  <style>
    /* ============================================
       MODAL REFUS AVEC RAISON - COACH
       ============================================ */
    .modal-refus-coach {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 100000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-refus-coach .modal-refus-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
    }

    .modal-refus-coach .modal-refus-content {
      position: relative;
      background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 30px rgba(239, 68, 68, 0.1);
      animation: modalSlideIn 0.3s ease-out;
    }

    .modal-refus-coach .modal-refus-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      background: rgba(239, 68, 68, 0.1);
      border-bottom: 1px solid rgba(239, 68, 68, 0.2);
    }

    .modal-refus-coach .modal-refus-body {
      padding: 1.5rem;
    }

    .modal-refus-coach .modal-refus-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      background: rgba(15, 23, 42, 0.5);
      border-top: 1px solid rgba(148, 163, 184, 0.1);
    }

    .btn-annuler-coach {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      background: rgba(100, 116, 139, 0.2);
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 10px;
      color: var(--text-gray);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-annuler-coach:hover {
      background: rgba(100, 116, 139, 0.3);
      color: var(--text-light);
    }

    .btn-confirmer-refus-coach {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .btn-confirmer-refus-coach:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .btn-confirmer-refus-coach:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
  </style>

  <!-- Modal Refus Entrepreneur - Lire message et r√©pondre -->
  <div id="modalRefusEntrepreneur" class="modal-refus-entrepreneur" style="display: none;">
    <div class="modal-refus-backdrop" onclick="fermerModalRefusEntrepreneur()"></div>
    <div class="modal-refus-content">
      <div class="modal-refus-header">
        <div class="modal-header-title">
          <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
          <h2>Paiement refus√©</h2>
        </div>
        <button class="modal-close-btn" onclick="fermerModalRefusEntrepreneur()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-refus-body">
        <!-- Layout en 2 colonnes -->
        <div class="refus-modal-layout">
          <!-- Colonne gauche: Infos + Modification -->
          <div class="refus-col-left">
            <div class="refus-client-info" id="refusClientInfo">
              <!-- Info client dynamique -->
            </div>

            <!-- Section √©tats de tous les paiements -->
            <div class="refus-paiements-container" id="refusPaiementsContainer">
              <!-- √âtats de paiements dynamiques -->
            </div>

            <!-- Section modification des informations de paiement -->
            <div class="refus-modification-container" id="refusModificationContainer" style="display: none;">
              <h4>
                <i class="fas fa-edit mr-2"></i>Modifier les informations
              </h4>

              <!-- Section Virement -->
              <div id="refusModifVirement" class="refus-modif-section" style="display: none;">
                <div class="refus-modif-field">
                  <label><i class="fas fa-link"></i> Lien du virement</label>
                  <input type="text" id="refusModifLienVirement" class="modern-input" placeholder="Nouveau lien...">
                </div>
                <div class="refus-modif-field">
                  <label><i class="fas fa-key"></i> Mot de passe du virement</label>
                  <input type="text" id="refusModifMotDePasse" class="modern-input" placeholder="Nouveau mot de passe...">
                </div>
              </div>

              <!-- Section Ch√®que -->
              <div id="refusModifCheque" class="refus-modif-section" style="display: none;">
                <div class="refus-modif-field">
                  <label><i class="fas fa-hashtag"></i> Num√©ro du ch√®que</label>
                  <input type="text" id="refusModifNumeroCheque" class="modern-input" placeholder="Num√©ro du ch√®que...">
                </div>
                <div class="refus-modif-photos">
                  <div class="refus-photo-upload">
                    <label><i class="fas fa-image"></i> Photo recto</label>
                    <div class="photo-preview-container">
                      <img id="refusPhotoRectoPreview" class="photo-preview" style="display: none;">
                      <div id="refusPhotoRectoPlaceholder" class="photo-placeholder">
                        <i class="fas fa-camera"></i>
                        <span>Aucune photo</span>
                      </div>
                    </div>
                    <input type="file" id="refusPhotoRectoInput" accept="image/*" class="hidden">
                    <button type="button" class="btn-upload-photo" onclick="document.getElementById('refusPhotoRectoInput').click()">
                      <i class="fas fa-upload"></i> Changer
                    </button>
                  </div>
                  <div class="refus-photo-upload">
                    <label><i class="fas fa-image"></i> Photo verso</label>
                    <div class="photo-preview-container">
                      <img id="refusPhotoVersoPreview" class="photo-preview" style="display: none;">
                      <div id="refusPhotoVersoPlaceholder" class="photo-placeholder">
                        <i class="fas fa-camera"></i>
                        <span>Aucune photo</span>
                      </div>
                    </div>
                    <input type="file" id="refusPhotoVersoInput" accept="image/*" class="hidden">
                    <button type="button" class="btn-upload-photo" onclick="document.getElementById('refusPhotoVersoInput').click()">
                      <i class="fas fa-upload"></i> Changer
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Colonne droite: Conversation -->
          <div class="refus-col-right">
            <div class="refus-conversation-container">
              <h4>
                <i class="fas fa-comments mr-2"></i>Conversation
              </h4>
              <div class="refus-conversation" id="refusConversation">
                <!-- Messages dynamiques -->
              </div>

              <!-- Zone de saisie style chat -->
              <div class="chat-input-container">
                <textarea
                  id="reponseEntrepreneur"
                  placeholder="Votre message..."
                  rows="1"
                  class="chat-textarea"
                ></textarea>
                <button class="btn-envoyer-chat" onclick="envoyerMessageRefus()" title="Envoyer le message">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-refus-footer">
        <button class="btn-supprimer-paiement" onclick="ouvrirModalSuppressionEntrepreneur()">
          <i class="fas fa-trash"></i> Supprimer
        </button>
        <div style="display: flex; gap: 0.5rem; margin-left: auto;">
          <button class="btn btn-secondary" onclick="fermerModalRefusEntrepreneur()">
            <i class="fas fa-times"></i> Fermer
          </button>
          <button class="btn btn-primary" onclick="renvoyerEnTraitement()">
            <i class="fas fa-check-circle"></i> Renvoyer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Suppression Entrepreneur -->
  <div id="modalSuppressionEntrepreneur" class="modal-suppression-entrepreneur" style="display: none;">
    <div class="modal-suppression-backdrop" onclick="fermerModalSuppressionEntrepreneur()"></div>
    <div class="modal-suppression-content">
      <div class="modal-suppression-header">
        <div class="modal-header-title">
          <i class="fas fa-trash-alt"></i>
          <h2>Supprimer le paiement</h2>
        </div>
        <button class="modal-close-btn" onclick="fermerModalSuppressionEntrepreneur()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-suppression-body">
        <div class="suppression-info">
          <div class="suppression-info-row">
            <span class="suppression-info-label">Client</span>
            <span class="suppression-info-value" id="suppression-ent-client">-</span>
          </div>
          <div class="suppression-info-row">
            <span class="suppression-info-label">Type</span>
            <span class="suppression-info-value" id="suppression-ent-type">-</span>
          </div>
          <div class="suppression-info-row">
            <span class="suppression-info-label">Montant</span>
            <span class="suppression-info-value" id="suppression-ent-montant">-</span>
          </div>
          <div class="suppression-info-row">
            <span class="suppression-info-label">N¬∞ Soumission</span>
            <span class="suppression-info-value" id="suppression-ent-soumission">-</span>
          </div>
        </div>
        <div class="suppression-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <span>Cette action est irr√©versible. Le paiement sera d√©finitivement supprim√©.</span>
        </div>
      </div>
      <div class="modal-suppression-footer">
        <button class="btn-annuler" onclick="fermerModalSuppressionEntrepreneur()">
          <i class="fas fa-arrow-left"></i> Annuler
        </button>
        <button class="btn-confirmer-suppression" onclick="confirmerSuppressionEntrepreneur()">
          <i class="fas fa-trash"></i> Supprimer
        </button>
      </div>
    </div>
  </div>

  <style>
    /* ============================================
       MODAL REFUS ENTREPRENEUR - LIRE ET R√âPONDRE
       ============================================ */
    .modal-refus-entrepreneur {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 100000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-refus-entrepreneur .modal-refus-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
    }

    .modal-refus-entrepreneur .modal-refus-content {
      position: relative;
      background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 16px;
      width: 95%;
      max-width: 900px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 30px rgba(245, 158, 11, 0.1);
      animation: modalSlideIn 0.3s ease-out;
      display: flex;
      flex-direction: column;
    }

    /* Layout 2 colonnes compact */
    .refus-modal-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .refus-col-left,
    .refus-col-right {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .refus-col-right .refus-conversation-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .refus-col-right .refus-conversation {
      flex: 1;
      min-height: 150px;
    }

    @media (max-width: 768px) {
      .refus-modal-layout {
        grid-template-columns: 1fr;
      }

      .refus-col-right .refus-conversation {
        min-height: 120px;
      }
    }

    /* Bouton supprimer dans le footer */
    .btn-supprimer-paiement {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 0.75rem;
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 8px;
      color: #ef4444;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-supprimer-paiement:hover {
      background: rgba(239, 68, 68, 0.25);
      border-color: #ef4444;
    }

    /* Modal suppression entrepreneur */
    .modal-suppression-entrepreneur {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 100001;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-suppression-entrepreneur .modal-suppression-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
    }

    .modal-suppression-entrepreneur .modal-suppression-content {
      position: relative;
      background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 16px;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 30px rgba(239, 68, 68, 0.15);
      animation: modalSlideIn 0.3s ease-out;
    }

    .modal-suppression-entrepreneur .modal-suppression-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      background: rgba(239, 68, 68, 0.1);
      border-bottom: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 16px 16px 0 0;
    }

    .modal-suppression-entrepreneur .modal-header-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .modal-suppression-entrepreneur .modal-header-title i {
      color: #ef4444;
      font-size: 1.25rem;
    }

    .modal-suppression-entrepreneur .modal-header-title h2 {
      color: var(--text-light);
      font-size: 1.1rem;
      margin: 0;
    }

    .modal-suppression-entrepreneur .modal-suppression-body {
      padding: 1.25rem;
    }

    .modal-suppression-entrepreneur .suppression-info {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid var(--border-dark);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .modal-suppression-entrepreneur .suppression-info-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .modal-suppression-entrepreneur .suppression-info-row:last-child {
      border-bottom: none;
    }

    .modal-suppression-entrepreneur .suppression-info-label {
      color: var(--text-gray);
      font-size: 0.85rem;
    }

    .modal-suppression-entrepreneur .suppression-info-value {
      color: var(--text-light);
      font-weight: 500;
      font-size: 0.85rem;
    }

    .modal-suppression-entrepreneur .suppression-warning {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.85rem;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      color: #fca5a5;
      font-size: 0.85rem;
    }

    .modal-suppression-entrepreneur .suppression-warning i {
      color: #ef4444;
      font-size: 1.1rem;
    }

    .modal-suppression-entrepreneur .modal-suppression-footer {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      background: rgba(15, 23, 42, 0.5);
      border-top: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: 0 0 16px 16px;
    }

    .modal-suppression-entrepreneur .btn-annuler {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.6rem 1rem;
      background: rgba(148, 163, 184, 0.1);
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 8px;
      color: var(--text-gray);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-suppression-entrepreneur .btn-annuler:hover {
      background: rgba(148, 163, 184, 0.2);
      color: var(--text-light);
    }

    .modal-suppression-entrepreneur .btn-confirmer-suppression {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.6rem 1.25rem;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-suppression-entrepreneur .btn-confirmer-suppression:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: scale(1.02);
    }

    .modal-refus-entrepreneur .modal-refus-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: rgba(245, 158, 11, 0.1);
      border-bottom: 1px solid rgba(245, 158, 11, 0.2);
    }

    .modal-refus-entrepreneur .modal-refus-header h2 {
      font-size: 1rem;
      margin: 0;
    }

    .modal-refus-entrepreneur .modal-refus-body {
      padding: 1rem;
      overflow-y: auto;
      flex: 1;
    }

    .modal-refus-entrepreneur .modal-refus-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: rgba(15, 23, 42, 0.5);
      border-top: 1px solid rgba(148, 163, 184, 0.1);
    }

    .refus-client-info {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid var(--border-dark);
      border-radius: 8px;
      padding: 0.65rem 0.75rem;
    }

    .refus-client-info p {
      color: var(--text-gray);
      font-size: 0.85rem;
      margin-bottom: 0.3rem;
    }

    .refus-client-info p:last-child {
      margin-bottom: 0;
    }

    .refus-client-info strong {
      color: var(--text-light);
    }

    /* Container pour les √©tats de paiements dans le modal refus */
    .refus-paiements-container {
      background: rgba(15, 23, 42, 0.3);
      border: 1px solid var(--border-dark);
      border-radius: 8px;
      padding: 0.65rem 0.75rem;
    }

    .refus-paiements-container h4 {
      color: var(--text-light);
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }

    .refus-paiement-section {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 6px;
      padding: 0.55rem;
      margin-bottom: 0.5rem;
    }

    .refus-paiement-section:last-child {
      margin-bottom: 0;
    }

    .refus-paiement-header {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.35rem;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .refus-paiement-header i {
      font-size: 0.85rem;
    }

    .refus-paiement-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.2rem 0;
      font-size: 0.8rem;
    }

    .refus-paiement-label {
      color: var(--text-gray);
    }

    .refus-paiement-value {
      color: var(--text-light);
      font-weight: 500;
    }

    .refus-paiement-value.highlight {
      color: rgb(16, 185, 129);
    }

    .refus-paiement-value.warning {
      color: #f59e0b;
    }

    .refus-paiement-value.danger {
      color: #ef4444;
    }

    .refus-paiement-value.success {
      color: rgb(16, 185, 129);
    }

    /* Section modification des informations de paiement */
    .refus-modification-container {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      padding: 0.75rem;
    }

    .refus-modification-container h4 {
      color: var(--text-light);
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }

    .refus-modification-container h4 i {
      color: #60a5fa;
    }

    .refus-modif-section {
      margin-top: 0.5rem;
    }

    .refus-modif-field {
      margin-bottom: 0.6rem;
    }

    .refus-modif-field label {
      display: block;
      color: var(--text-gray);
      font-size: 0.8rem;
      margin-bottom: 0.3rem;
    }

    .refus-modif-field label i {
      margin-right: 0.3rem;
      color: #60a5fa;
    }

    .refus-modif-field .modern-input {
      width: 100%;
      padding: 0.5rem 0.65rem;
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 6px;
      color: var(--text-light);
      font-size: 0.85rem;
      transition: border-color 0.2s;
    }

    .refus-modif-field .modern-input:focus {
      outline: none;
      border-color: #60a5fa;
    }

    .refus-modif-photos {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .refus-photo-upload {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .refus-photo-upload label {
      color: var(--text-gray);
      font-size: 0.75rem;
    }

    .refus-photo-upload label i {
      margin-right: 0.3rem;
      color: #60a5fa;
    }

    .photo-preview-container {
      width: 100%;
      height: 80px;
      border: 2px dashed rgba(148, 163, 184, 0.3);
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.5);
    }

    .photo-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.2rem;
      color: var(--text-gray);
      font-size: 0.7rem;
    }

    .photo-placeholder i {
      font-size: 1.3rem;
      opacity: 0.5;
    }

    .btn-upload-photo {
      padding: 0.35rem 0.6rem;
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.4);
      border-radius: 5px;
      color: #60a5fa;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-upload-photo:hover {
      background: rgba(59, 130, 246, 0.3);
    }

    @media (max-width: 500px) {
      .refus-modif-photos {
        grid-template-columns: 1fr;
      }
    }

    .refus-conversation-container {
      background: rgba(15, 23, 42, 0.3);
      border: 1px solid var(--border-dark);
      border-radius: 8px;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
    }

    .refus-conversation-container h4 {
      color: var(--text-light);
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }

    .refus-conversation-container h4 i {
      color: #60a5fa;
    }

    .refus-conversation {
      flex: 1;
      max-height: 520px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.5rem 0;
    }

    .refus-conversation::-webkit-scrollbar {
      width: 4px;
    }

    .refus-conversation::-webkit-scrollbar-track {
      background: transparent;
    }

    .refus-conversation::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.3);
      border-radius: 2px;
    }

    .message-bubble {
      padding: 0.5rem 0.75rem;
      border-radius: 12px;
      max-width: 85%;
      font-size: 0.8rem;
      line-height: 1.4;
      position: relative;
    }

    .message-bubble.from-coach,
    .message-bubble.from-comptable {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.15) 100%);
      color: var(--text-light);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .message-bubble.from-entrepreneur {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.15) 100%);
      color: var(--text-light);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .message-bubble .message-meta {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.65rem;
      color: var(--text-gray);
      margin-bottom: 0.2rem;
      opacity: 0.8;
    }

    .message-bubble .message-text {
      color: var(--text-light);
      word-wrap: break-word;
    }

    .conversation-message {
      padding: 0.625rem 0.875rem;
      border-radius: 18px;
      max-width: 80%;
      font-size: 0.85rem;
      line-height: 1.45;
    }

    .conversation-message.entrepreneur {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.15) 100%);
      color: var(--text-light);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .conversation-message .message-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.7rem;
      color: var(--text-gray);
      margin-bottom: 0.2rem;
      opacity: 0.8;
    }

    .conversation-message .message-content {
      color: var(--text-light);
      word-wrap: break-word;
    }

    .btn-annuler-entrepreneur {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      background: rgba(100, 116, 139, 0.2);
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 10px;
      color: var(--text-gray);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-annuler-entrepreneur:hover {
      background: rgba(100, 116, 139, 0.3);
      color: var(--text-light);
    }

    /* Zone de saisie style chat - design minimaliste */
    .chat-input-container {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-top: auto;
      padding: 0.4rem 0.6rem;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.15);
    }

    .chat-textarea {
      flex: 1;
      padding: 0.35rem 0;
      border: none;
      background: transparent;
      color: var(--text-light);
      font-size: 0.85rem;
      font-family: inherit;
      resize: none;
      min-height: 22px;
      max-height: 60px;
      line-height: 1.4;
      outline: none;
    }

    .chat-textarea::placeholder {
      color: var(--text-gray);
      opacity: 0.7;
    }

    .btn-envoyer-chat {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .btn-envoyer-chat:hover {
      color: #10b981;
      transform: scale(1.1);
    }

    .btn-envoyer-chat:active {
      transform: scale(0.95);
      color: #059669;
    }

    .btn-envoyer-chat i {
      font-size: 1rem;
    }

    .btn-renvoyer-traitement {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    .btn-renvoyer-traitement:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn-renvoyer-traitement:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
  </style>

  <style>
    /* ============================================
       MODAL D√âTAILS TRAITEMENT - COACH
       ============================================ */
    .modal-details-traitement {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-details-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
    }

    .modal-details-content {
      position: relative;
      background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 20px;
      width: 90%;
      max-width: 700px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      background: rgba(15, 23, 42, 0.5);
      border-bottom: 1px solid #94a3b81a;
    }

    .modal-header-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .modal-header-title i {
      font-size: 1.5rem;
      color: var(--text-light);
    }

    .modal-header-title h2 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-light);
    }

    .modal-close-btn {
      background: rgba(239, 68, 68, 0.2);
      border: none;
      border-radius: 10px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f87171;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-close-btn:hover {
      background: rgba(239, 68, 68, 0.4);
      transform: scale(1.1);
    }

    .modal-details-body {
      padding: 1.5rem;
      overflow-y: auto;
      max-height: calc(85vh - 160px);
    }

    /* Sections du modal */
    .modal-section {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
    }

    .modal-section:last-child {
      margin-bottom: 0;
    }

    .modal-section-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: #94a3b8;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .modal-section-title i {
      font-size: 1rem;
    }

    /* Row pour titre + boutons */
    .modal-section-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .modal-section-title-row .modal-section-title {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    /* Boutons Refuser/Accepter inline */
    .section-action-btns {
      display: flex;
      gap: 0.5rem;
    }

    .btn-section-refuser,
    .btn-section-accepter {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.35rem 0.75rem;
      border: none;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-section-refuser {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .btn-section-refuser:hover {
      background: rgba(239, 68, 68, 0.25);
    }

    .btn-section-accepter {
      background: rgba(16, 185, 129, 0.15);
      color: rgb(16, 185, 129);
    }

    .btn-section-accepter:hover {
      background: rgba(16, 185, 129, 0.25);
    }

    .btn-section-refuser:disabled,
    .btn-section-accepter:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .modal-info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
    }

    .modal-info-row:not(:last-child) {
      border-bottom: 1px dashed rgba(148, 163, 184, 0.1);
    }

    .modal-info-label {
      color: #64748b;
      font-size: 0.875rem;
    }

    .modal-info-value {
      color: var(--text-light);
      font-weight: 500;
      font-size: 0.9rem;
    }

    .modal-info-value.highlight {
      color: rgb(16, 185, 129);
      font-weight: 600;
    }

    .modal-info-value.warning {
      color: #fb923c;
    }

    /* Lien cliquable */
    .modal-link {
      color: #60a5fa;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: all 0.2s ease;
    }

    .modal-link:hover {
      color: #93c5fd;
      text-decoration: underline;
    }

    /* Bouton voir soumission */
    .modal-voir-soumission {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.2) 0%, rgba(59, 130, 246, 0.15) 100%);
      border: 1px solid rgba(96, 165, 250, 0.4);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      color: #60a5fa;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-voir-soumission:hover {
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.3) 0%, rgba(59, 130, 246, 0.25) 100%);
      transform: translateY(-1px);
    }

    .modal-details-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      background: rgba(15, 23, 42, 0.5);
      border-top: 1px solid rgba(148, 163, 184, 0.1);
    }

    .modal-details-footer .btn {
      padding: 0.625rem 1.25rem;
      border-radius: 10px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-details-footer .btn-refuser {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
      border: none !important;
      color: white !important;
    }

    .modal-details-footer .btn-refuser:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .modal-details-footer .btn-accepter {
      background: linear-gradient(135deg, rgb(16, 185, 129) 0%, rgb(5, 150, 105) 100%) !important;
      border: none !important;
      color: white !important;
    }

    .modal-details-footer .btn-accepter:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }

    /* Bouton √Ä traiter hover */
    .btn-a-traiter:hover {
      background: linear-gradient(135deg, rgba(251, 146, 60, 0.5) 0%, rgba(234, 88, 12, 0.5) 100%) !important;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
    }
  </style>

  <script>
    // Variable globale pour stocker les donn√©es du paiement actuel
    let currentTraitementData = null;

    // Fonction pour formater les statuts dans le modal
    function formaterStatutModal(statut, type = null) {
      // Pour le d√©p√¥t
      if (type === 'depot') {
        if (statut === 'traite_attente_final' || statut === 'traite') {
          return 'Trait√©';
        }
        if (statut === 'attente_comptable') {
          return 'Valid√© - En attente comptable';
        }
        if (statut === 'traitement') {
          return '√Ä traiter';
        }
      }
      // Pour le paiement final
      if (type === 'paiement_final') {
        if (statut === 'traite') {
          return 'Trait√©';
        }
        if (statut === 'attente_comptable') {
          return 'Valid√© - En attente comptable';
        }
        if (statut === 'traitement') {
          return '√Ä traiter';
        }
      }
      // Pour les autres paiements
      if (type === 'autres') {
        if (statut === 'traite') {
          return 'Trait√©';
        }
        if (statut === 'attente_comptable') {
          return 'Valid√© - En attente comptable';
        }
        if (statut === 'traitement') {
          return '√Ä traiter';
        }
      }
      // Fallback g√©n√©rique
      const statutsMap = {
        'traitement': '√Ä traiter',
        'attente_comptable': 'Valid√© - En attente comptable',
        'traite': 'Trait√©',
        'traite_attente_final': 'Trait√©',
        'refuse': 'Refus√©',
        'non_envoye': 'Non envoy√©'
      };
      return statutsMap[statut] || statut || 'N/A';
    }

    // Fonction pour ouvrir le modal de d√©tails
    window.ouvrirDetailsTraitement = async function(numeroSoumission, facturationData) {
      log('[MODAL] Ouverture modal pour:', numeroSoumission, facturationData);

      // NOUVEAU: Filtrer pour n'afficher QUE le paiement cliqu√©
      const typePaiementClique = facturationData.typePaiement || 'depot';
      log('[MODAL] Type de paiement cliqu√©:', typePaiementClique);

      currentTraitementData = {
        numeroSoumission: numeroSoumission,
        facturation: facturationData,
        typePaiementClique: typePaiementClique
      };

      // R√©cup√©rer les donn√©es compl√®tes depuis l'API
      const username = getFacturationUsername();
      let detailsComplets = {};
      let clientData = null;

      try {
        // R√©cup√©rer les statuts
        const responseStatuts = await fetch(`/api/facturationqe/client/${username}/${numeroSoumission}/statuts`);
        if (responseStatuts.ok) {
          detailsComplets = await responseStatuts.json();
          log('[MODAL] D√©tails statuts:', detailsComplets);
        }

        // R√©cup√©rer les infos client depuis la liste des clients
        const responseClients = await fetch(`/api/facturationqe/clients/${username}`);
        if (responseClients.ok) {
          const data = await responseClients.json();
          clientData = data.clients.find(c => c.num === numeroSoumission);
          log('[MODAL] Client data:', clientData);
        }
      } catch (error) {
        error('[MODAL] Erreur r√©cup√©ration donn√©es:', error);
      }

      // Construire le contenu du modal
      const modalBody = document.getElementById('modalDetailsBody');
      const clientNom = clientData ? `${clientData.prenom} ${clientData.nom}` : (facturationData.clientPrenom ? `${facturationData.clientPrenom} ${facturationData.clientNom}` : 'Client inconnu');

      let contentHTML = '';

      // Section Client
      contentHTML += `
        <div class="modal-section">
          <div class="modal-section-title">
            <i class="fas fa-user" style="color: #60a5fa;"></i>
            Informations client
          </div>
          <div class="modal-info-row">
            <span class="modal-info-label">Nom complet</span>
            <span class="modal-info-value">${clientNom}</span>
          </div>
          <div class="modal-info-row">
            <span class="modal-info-label">N¬∞ Soumission</span>
            <span class="modal-info-value">${numeroSoumission}</span>
          </div>
          ${clientData?.telephone ? `
          <div class="modal-info-row">
            <span class="modal-info-label">T√©l√©phone</span>
            <span class="modal-info-value">${clientData.telephone}</span>
          </div>` : ''}
          ${clientData?.adresse ? `
          <div class="modal-info-row">
            <span class="modal-info-label">Adresse</span>
            <span class="modal-info-value">${clientData.adresse}</span>
          </div>` : ''}
          ${clientData?.total_travaux ? `
          <div class="modal-info-row">
            <span class="modal-info-label">Total travaux</span>
            <span class="modal-info-value highlight">${formatMontantAvecEspace(clientData.total_travaux)}</span>
          </div>` : ''}
          <div class="modal-info-row">
            <span class="modal-info-label">Soumission</span>
            <button class="modal-voir-soumission" onclick="ouvrirSoumissionDepuisModal('${numeroSoumission}')">
              <i class="fas fa-file-alt"></i>
              Voir la soumission
            </button>
          </div>
        </div>
      `;

      // Section D√©p√¥t si pr√©sent ET si c'est le paiement cliqu√©
      if (detailsComplets.depot && typePaiementClique === 'depot') {
        const depot = detailsComplets.depot;
        // Debug: afficher toutes les propri√©t√©s du depot
        log('[MODAL DEPOT] Donn√©es depot:', depot);
        log('[MODAL DEPOT] photoRecto:', depot.photoRecto);
        log('[MODAL DEPOT] photoVerso:', depot.photoVerso);
        log('[MODAL DEPOT] photo_recto:', depot.photo_recto);
        log('[MODAL DEPOT] photo_verso:', depot.photo_verso);
        contentHTML += `
          <div class="modal-section">
            <div class="modal-section-title-row">
              <div class="modal-section-title">
                <i class="fas fa-piggy-bank" style="color: rgb(16, 185, 129);"></i>
                D√©p√¥t
              </div>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Montant</span>
              <span class="modal-info-value highlight">${depot.montant || 'N/A'}</span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Date</span>
              <span class="modal-info-value">${depot.date || 'N/A'}</span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">M√©thode</span>
              <span class="modal-info-value">${depot.methode || 'N/A'}</span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Statut</span>
              <span class="modal-info-value warning">${formaterStatutModal(depot.statut, 'depot')}</span>
            </div>
            ${depot.lienVirement ? `
            <div class="modal-info-row">
              <span class="modal-info-label">Lien virement</span>
              <a href="${depot.lienVirement.startsWith('http') ? depot.lienVirement : 'https://' + depot.lienVirement}" target="_blank" class="modal-link">
                <i class="fas fa-external-link-alt"></i>
                ${depot.lienVirement}
              </a>
            </div>` : ''}
            ${depot.motDePasse ? `
            <div class="modal-info-row">
              <span class="modal-info-label">Mot de passe</span>
              <span class="modal-info-value">${depot.motDePasse}</span>
            </div>` : ''}
            ${(depot.methode === 'cheque' || depot.methode === 'ch√®que') ? `
            ${depot.numeroCheque ? `
            <div class="modal-info-row">
              <span class="modal-info-label">N¬∞ Ch√®que</span>
              <span class="modal-info-value" style="color: #10b981; font-weight: 600;">${depot.numeroCheque}</span>
            </div>` : ''}
            <div class="modal-info-row">
              <span class="modal-info-label">Ch√®que</span>
              <button class="modal-voir-soumission" onclick="ouvrirPhotosCheque('${numeroSoumission}', 'depot')">
                <i class="fas fa-images"></i>
                Voir le ch√®que
              </button>
            </div>` : ''}
          </div>
        `;
      }

      // Section Autres Paiements si pr√©sent ET si c'est le paiement cliqu√© (ENTRE d√©p√¥t et paiement final)
      if (detailsComplets.autresPaiements && detailsComplets.autresPaiements.length > 0) {
        detailsComplets.autresPaiements.forEach((ap, index) => {
          // V√©rifier si c'est le paiement cliqu√© (ex: autre_paiement_1, autre_paiement_2)
          const indexDansType = typePaiementClique.startsWith('autre_paiement_') ?
            parseInt(typePaiementClique.replace('autre_paiement_', '')) : null;

          // N'afficher que si c'est le paiement cliqu√©
          if (indexDansType !== null && indexDansType === index + 1) {
            // FALLBACK: Si typePaiementAutres est absent, d√©duire selon statutDepot
            let typeAutres = ap.typePaiementAutres;
            if (!typeAutres) {
              // Si pas de d√©p√¥t, c'est un seul paiement
              const statutDepot = detailsComplets.statutDepot || 'non_envoye';
              typeAutres = (statutDepot === 'non_envoye') ? 'un_seul_paiement' : 'paiement_partiel';
              log('[FALLBACK MODAL] typePaiementAutres d√©duit:', typeAutres, '(statutDepot:', statutDepot, ')');
            }
            const typePaiement = typeAutres === 'un_seul_paiement' ? 'Paiement complet' : `Paiement partiel ${index + 1}`;
            contentHTML += `
              <div class="modal-section">
                <div class="modal-section-title-row">
                  <div class="modal-section-title">
                    <i class="fas fa-coins" style="color: #fbbf24;"></i>
                    ${typePaiement}
                  </div>
                </div>
                <div class="modal-info-row">
                  <span class="modal-info-label">Montant</span>
                  <span class="modal-info-value highlight">${ap.montant || 'N/A'}</span>
                </div>
                <div class="modal-info-row">
                  <span class="modal-info-label">Date</span>
                  <span class="modal-info-value">${ap.date || 'N/A'}</span>
                </div>
                <div class="modal-info-row">
                  <span class="modal-info-label">M√©thode</span>
                  <span class="modal-info-value">${ap.methode || 'N/A'}</span>
                </div>
                <div class="modal-info-row">
                  <span class="modal-info-label">Statut</span>
                  <span class="modal-info-value warning">${formaterStatutModal(ap.statut, 'autres')}</span>
                </div>
                ${ap.lienVirement ? `
                <div class="modal-info-row">
                  <span class="modal-info-label">Lien virement</span>
                  <a href="${ap.lienVirement.startsWith('http') ? ap.lienVirement : 'https://' + ap.lienVirement}" target="_blank" class="modal-link">
                    <i class="fas fa-external-link-alt"></i>
                    ${ap.lienVirement}
                  </a>
                </div>` : ''}
                ${ap.motDePasse ? `
                <div class="modal-info-row">
                  <span class="modal-info-label">Mot de passe</span>
                  <span class="modal-info-value">${ap.motDePasse}</span>
                </div>` : ''}
                ${(ap.methode === 'cheque' || ap.methode === 'ch√®que') ? `
                ${ap.numeroCheque ? `
                <div class="modal-info-row">
                  <span class="modal-info-label">N¬∞ Ch√®que</span>
                  <span class="modal-info-value" style="color: #10b981; font-weight: 600;">${ap.numeroCheque}</span>
                </div>` : ''}
                <div class="modal-info-row">
                  <span class="modal-info-label">Ch√®que</span>
                  <button class="modal-voir-soumission" onclick="ouvrirPhotosCheque('${numeroSoumission}', 'autre_paiement_${index + 1}')">
                    <i class="fas fa-images"></i>
                    Voir le ch√®que
                  </button>
                </div>` : ''}
              </div>
            `;
          }
        });
      }

      // Section Paiement Final si pr√©sent ET si c'est le paiement cliqu√© (APR√àS les paiements partiels)
      if (detailsComplets.paiementFinal && detailsComplets.paiementFinal.montant && typePaiementClique === 'paiement_final') {
        const pf = detailsComplets.paiementFinal;
        contentHTML += `
          <div class="modal-section">
            <div class="modal-section-title-row">
              <div class="modal-section-title">
                <i class="fas fa-credit-card" style="color: #a855f7;"></i>
                Paiement Final
              </div>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Montant</span>
              <span class="modal-info-value highlight">${pf.montant || 'N/A'}</span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Date</span>
              <span class="modal-info-value">${pf.date || 'N/A'}</span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">M√©thode</span>
              <span class="modal-info-value">${pf.methode || 'N/A'}</span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Statut</span>
              <span class="modal-info-value warning">${formaterStatutModal(pf.statut, 'paiement_final')}</span>
            </div>
            ${pf.lienVirement ? `
            <div class="modal-info-row">
              <span class="modal-info-label">Lien virement</span>
              <a href="${pf.lienVirement.startsWith('http') ? pf.lienVirement : 'https://' + pf.lienVirement}" target="_blank" class="modal-link">
                <i class="fas fa-external-link-alt"></i>
                ${pf.lienVirement}
              </a>
            </div>` : ''}
            ${pf.motDePasse ? `
            <div class="modal-info-row">
              <span class="modal-info-label">Mot de passe</span>
              <span class="modal-info-value">${pf.motDePasse}</span>
            </div>` : ''}
            ${(pf.methode === 'cheque' || pf.methode === 'ch√®que') ? `
            ${pf.numeroCheque ? `
            <div class="modal-info-row">
              <span class="modal-info-label">N¬∞ Ch√®que</span>
              <span class="modal-info-value" style="color: #10b981; font-weight: 600;">${pf.numeroCheque}</span>
            </div>` : ''}
            <div class="modal-info-row">
              <span class="modal-info-label">Ch√®que</span>
              <button class="modal-voir-soumission" onclick="ouvrirPhotosCheque('${numeroSoumission}', 'paiement_final')">
                <i class="fas fa-images"></i>
                Voir le ch√®que
              </button>
            </div>` : ''}
          </div>
        `;
      }

      modalBody.innerHTML = contentHTML;

      // Afficher le modal et bloquer le scroll
      document.getElementById('modalDetailsTraitement').style.display = 'flex';
      document.body.style.overflow = 'hidden';
      document.documentElement.style.overflow = 'hidden';
      // Bloquer aussi le scroll du parent si dans un iframe
      if (window.parent && window.parent !== window) {
        try {
          window.parent.document.body.style.overflow = 'hidden';
          window.parent.document.documentElement.style.overflow = 'hidden';
        } catch(e) {}
      }
    };

    // Fermer le modal
    window.fermerModalDetailsTraitement = function() {
      document.getElementById('modalDetailsTraitement').style.display = 'none';
      // Restaurer le scroll
      document.body.style.overflow = '';
      document.documentElement.style.overflow = '';
      // Restaurer aussi le scroll du parent si dans un iframe
      if (window.parent && window.parent !== window) {
        try {
          window.parent.document.body.style.overflow = '';
          window.parent.document.documentElement.style.overflow = '';
        } catch(e) {}
      }

      // IMPORTANT: R√©initialiser les boutons √† leur √©tat initial
      const btnAccepter = document.getElementById('btnAccepter');
      if (btnAccepter) {
        btnAccepter.disabled = false;
        btnAccepter.innerHTML = '<i class="fas fa-check mr-2"></i>Accepter';
        btnAccepter.style.background = ''; // Reset to default CSS
      }

      const btnRefuser = document.getElementById('btnRefuser');
      if (btnRefuser) {
        btnRefuser.disabled = false;
        btnRefuser.innerHTML = '<i class="fas fa-times mr-2"></i>Refuser';
      }

      currentTraitementData = null;
    };

    // Ouvrir la soumission depuis le modal (utilise le m√™me modal que voirSoumissionSignee)
    window.ouvrirSoumissionDepuisModal = async function(numeroSoumission) {
      // D'abord chercher dans clientsFacturationData (si d√©j√† charg√©)
      let client = clientsFacturationData.find(c => c.num === numeroSoumission);
      let pdfUrl = client?.pdfUrl;

      // Si pas trouv√© ou pas de pdfUrl, r√©cup√©rer depuis l'API
      if (!pdfUrl || pdfUrl === '#') {
        const username = getFacturationUsername();
        log('[MODAL] R√©cup√©ration PDF depuis API pour:', numeroSoumission, 'username:', username);

        try {
          const response = await fetch(`/soumissions_signees_facturation_qe/${username}`);
          if (response.ok) {
            const clients = await response.json();
            const clientFromAPI = clients.find(c => c.num === numeroSoumission);
            if (clientFromAPI) {
              pdfUrl = clientFromAPI.pdfUrl;
              log('[MODAL] PDF trouv√© depuis API:', pdfUrl);
            }
          }
        } catch (error) {
          error('[MODAL] Erreur r√©cup√©ration API:', error);
        }
      }

      if (!pdfUrl || pdfUrl === '#') {
        alert('Aucune soumission PDF disponible pour ce client');
        return;
      }

      // Utiliser le m√™me modal que voirSoumissionSignee
      const modal = document.getElementById('soumissionSigneeModal');
      const content = document.getElementById('soumissionContent');

      if (modal && content) {
        // Augmenter le z-index pour √™tre au-dessus du modal traitement (qui est √† 99999)
        modal.style.zIndex = '100001';

        // Afficher le PDF dans un iframe dans le modal (m√™me structure exacte que voirSoumissionSignee)
        content.innerHTML = `
          <!-- Styles sp√©cifiques √† Facturation QE -->
          <div class="pdf-container" style="width: 100%; height: 70vh; background: #1a1a1a; border-radius: 8px; overflow: auto;">
            <iframe src="${pdfUrl}"
                    type="application/pdf"
                    style="width: 100%; height: 100%; border: none; display: block;">
              <p style="padding: 20px; color: var(--text-light);">
                Impossible d'afficher le PDF.
                <a href="${pdfUrl}" target="_blank" style="color: #3b82f6; text-decoration: underline;">
                  Cliquez ici pour l'ouvrir dans un nouvel onglet
                </a>
              </p>
            </iframe>
          </div>
        `;

        // Bloquer le scroll de la page
        document.body.style.overflow = 'hidden';

        // Afficher le modal
        modal.classList.remove('hidden');
      }
    };

    // Ouvrir les photos du ch√®que dans un popup
    window.ouvrirPhotosCheque = async function(numeroSoumission, typePaiement) {
      const username = getFacturationUsername();

      try {
        // R√©cup√©rer les d√©tails complets depuis l'API
        const responseStatuts = await fetch(`/api/facturationqe/client/${username}/${numeroSoumission}/statuts`);
        if (!responseStatuts.ok) {
          throw new Error('Erreur lors de la r√©cup√©ration des statuts');
        }

        const detailsComplets = await responseStatuts.json();
        console.log('[MODAL CHEQUE] Details complets:', detailsComplets);
        let paiementData = null;

        // R√©cup√©rer les bonnes donn√©es selon le type de paiement
        if (typePaiement === 'depot') {
          paiementData = detailsComplets.depot;
        } else if (typePaiement === 'paiement_final') {
          paiementData = detailsComplets.paiementFinal;
        } else if (typePaiement.startsWith('autre_paiement_')) {
          const index = parseInt(typePaiement.replace('autre_paiement_', '')) - 1;
          paiementData = detailsComplets.autresPaiements?.[index];
        }

        console.log('[MODAL CHEQUE] Type paiement:', typePaiement);
        console.log('[MODAL CHEQUE] Paiement data:', paiementData);
        console.log('[MODAL CHEQUE] photoRecto:', paiementData?.photoRecto);
        console.log('[MODAL CHEQUE] photoVerso:', paiementData?.photoVerso);
        console.log('[MODAL CHEQUE] photo_recto:', paiementData?.photo_recto);
        console.log('[MODAL CHEQUE] photo_verso:', paiementData?.photo_verso);
        console.log('[MODAL CHEQUE] Toutes les cl√©s:', paiementData ? Object.keys(paiementData) : 'null');

        if (!paiementData) {
          alert('Aucune donn√©e de paiement disponible');
          return;
        }

        // Essayer diff√©rents noms de champs pour les photos
        const photoRecto = paiementData.photoRecto || paiementData.photo_recto || paiementData.recto;
        const photoVerso = paiementData.photoVerso || paiementData.photo_verso || paiementData.verso;

        if (!photoRecto && !photoVerso) {
          alert('Aucune photo de ch√®que disponible pour ce paiement');
          return;
        }

        // Utiliser le m√™me modal que pour les soumissions
        const modal = document.getElementById('soumissionSigneeModal');
        const content = document.getElementById('soumissionContent');

        if (modal && content) {
          // Augmenter le z-index pour √™tre au-dessus du modal traitement
          modal.style.zIndex = '100001';

          // Changer le titre du modal pour "Ch√®que" au lieu de "Soumission sign√©e"
          const modalTitle = modal.querySelector('h3.text-xl');
          if (modalTitle) {
            modalTitle.innerHTML = '<i class="fas fa-money-check-alt mr-2" style="color: #10b981;"></i>Ch√®que';
          }

          // Agrandir le modal et faire que le contenu prenne toute la hauteur
          const modalWrapper = modal.querySelector('.bg-white');
          if (modalWrapper) {
            modalWrapper.style.width = '95vw';
            modalWrapper.style.maxWidth = '1400px';
            modalWrapper.style.height = '85vh';
            modalWrapper.style.maxHeight = '85vh';
          }

          // Afficher les photos - prend toute la hauteur du popup
          content.innerHTML = `
            <div style="width: 100%; height: calc(85vh - 80px); background: #0f1629; border-radius: 8px; padding: 20px; display: flex; flex-direction: column;">
              <h2 style="color: var(--text-light); margin-bottom: 15px; text-align: center; font-size: 1.3rem; flex-shrink: 0;">
                <i class="fas fa-money-check-alt mr-2" style="color: #10b981;"></i>Photos du ch√®que
              </h2>
              <div style="display: grid; grid-template-columns: ${photoRecto && photoVerso ? '1fr 1fr' : '1fr'}; gap: 20px; flex: 1; min-height: 0;">
                ${photoRecto ? `
                <div style="display: flex; flex-direction: column; min-height: 0;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0;">
                    <h3 style="color: var(--text-light); font-size: 1rem; margin: 0;">
                      <i class="fas fa-image mr-2" style="color: #10b981;"></i>Recto
                    </h3>
                    <div style="display: flex; gap: 8px;">
                      <button onclick="rotateImage('cheque-img-recto')" style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.5); color: #60a5fa; padding: 6px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.8rem;">
                        <i class="fas fa-redo"></i> Tourner
                      </button>
                      <button onclick="downloadImage('${photoRecto}', 'cheque_recto')" style="background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.5); color: #10b981; padding: 6px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.8rem;">
                        <i class="fas fa-download"></i> T√©l√©charger
                      </button>
                    </div>
                  </div>
                  <div style="flex: 1; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; min-height: 0; overflow: hidden;">
                    <img id="cheque-img-recto" src="${photoRecto}" alt="Recto du ch√®que"
                         style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 6px; border: 2px solid var(--border-dark); transition: transform 0.3s ease;">
                  </div>
                </div>
                ` : ''}
                ${photoVerso ? `
                <div style="display: flex; flex-direction: column; min-height: 0;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0;">
                    <h3 style="color: var(--text-light); font-size: 1rem; margin: 0;">
                      <i class="fas fa-image mr-2" style="color: #f59e0b;"></i>Verso
                    </h3>
                    <div style="display: flex; gap: 8px;">
                      <button onclick="rotateImage('cheque-img-verso')" style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.5); color: #60a5fa; padding: 6px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.8rem;">
                        <i class="fas fa-redo"></i> Tourner
                      </button>
                      <button onclick="downloadImage('${photoVerso}', 'cheque_verso')" style="background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.5); color: #10b981; padding: 6px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.8rem;">
                        <i class="fas fa-download"></i> T√©l√©charger
                      </button>
                    </div>
                  </div>
                  <div style="flex: 1; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; min-height: 0; overflow: hidden;">
                    <img id="cheque-img-verso" src="${photoVerso}" alt="Verso du ch√®que"
                         style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 6px; border: 2px solid var(--border-dark); transition: transform 0.3s ease;">
                  </div>
                </div>
                ` : ''}
              </div>
            </div>
          `;

          // Bloquer le scroll de la page
          document.body.style.overflow = 'hidden';

          // Afficher le modal
          modal.classList.remove('hidden');
        }
      } catch (error) {
        console.error('[MODAL CHEQUE] Erreur:', error);
        alert('Erreur lors du chargement des photos du ch√®que');
      }
    };

    // Fonction pour tourner une image de 90 degr√©s
    window.rotateImage = function(imageId) {
      const img = document.getElementById(imageId);
      if (!img) return;

      const currentRotation = img.dataset.rotation ? parseInt(img.dataset.rotation) : 0;
      const newRotation = (currentRotation + 90) % 360;
      img.dataset.rotation = newRotation;

      // Rotation simple - l'image s'adapte automatiquement
      img.style.transform = `rotate(${newRotation}deg)`;
    };

    // Fonction pour t√©l√©charger une image
    window.downloadImage = async function(imageUrl, filename) {
      try {
        const response = await fetch(imageUrl);
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename + '.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Erreur t√©l√©chargement:', error);
        // Fallback: ouvrir dans un nouvel onglet
        window.open(imageUrl, '_blank');
      }
    };

    // Accepter le paiement depuis le modal (envoyer vers attente comptable)
    // Envoie TOUS les paiements en "traitement" vers "attente_comptable"
    window.accepterDepuisModal = async function() {
      if (!currentTraitementData) return;

      const numeroSoumission = currentTraitementData.numeroSoumission;
      const typePaiementClique = currentTraitementData.typePaiementClique;
      const username = getFacturationUsername();
      const userRole = localStorage.getItem('userRole');

      // R√©cup√©rer le bouton et ajouter le spinner
      const btnAccepter = document.getElementById('btnAccepter');
      const originalBtnContent = btnAccepter.innerHTML;
      btnAccepter.disabled = true;
      btnAccepter.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Validation en cours...';

      try {
        // D√©terminer quel paiement accepter bas√© sur typePaiementClique
        let bodyData;
        if (typePaiementClique === 'depot') {
          bodyData = { type: 'depot' };
        } else if (typePaiementClique === 'paiement_final') {
          bodyData = { type: 'paiement_final' };
        } else if (typePaiementClique.startsWith('autre_paiement_')) {
          const index = parseInt(typePaiementClique.replace('autre_paiement_', '')) - 1;
          bodyData = { type: 'autres_paiements', index: index };
        } else {
          throw new Error('Type de paiement invalide');
        }

        // Envoyer le paiement vers attente_comptable
        let apiUrl;
        if (userRole === 'coach' || userRole === 'direction') {
          apiUrl = `/api/coach/facturation/${username}/${numeroSoumission}/valider`;
        } else {
          apiUrl = `/api/facturationqe/client/${username}/${numeroSoumission}/traiter`;
        }

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyData)
        });

        if (response.ok) {
          // Afficher succ√®s sur le bouton
          btnAccepter.innerHTML = '<i class="fas fa-check mr-2"></i>Valid√©!';
          btnAccepter.style.background = 'linear-gradient(135deg, rgb(16, 185, 129) 0%, rgb(5, 150, 105) 100%)';

          // Afficher l'animation de succ√®s
          showSuccessAnimation('Paiement valid√© avec succ√®s!');

          // Fermer le modal imm√©diatement
          fermerModalDetailsTraitement();

          // Attendre que l'animation se termine avant de rafra√Æchir
          await new Promise(resolve => setTimeout(resolve, 1500));

          // Rafra√Æchir les donn√©es
          if (typeof utiliserDonneesTestStatus === 'function') {
            await utiliserDonneesTestStatus();
          }

          // Recharger les badges du s√©lecteur entrepreneur si on est un coach/direction
          if (userRole === 'coach' || userRole === 'direction') {
            if (window.EntrepreneurSelector) {
              window.EntrepreneurSelector.reload();
            } else if (typeof loadEntrepreneursForCoach === 'function') {
              loadEntrepreneursForCoach();
            }

            // Notifier le parent (apppccoach) pour rafra√Æchir le badge du menu lat√©ral
            window.parent.postMessage({ type: 'updateFacturationBadge' }, '*');
          }
        } else {
          btnAccepter.disabled = false;
          btnAccepter.innerHTML = originalBtnContent;
          alert('Erreur: Impossible de valider le paiement');
        }
      } catch (error) {
        error('[MODAL] Erreur accepter:', error);
        btnAccepter.disabled = false;
        btnAccepter.innerHTML = originalBtnContent;
        alert('Erreur lors de l\'acceptation');
      }
    };

    // Refuser le paiement depuis le modal - ouvrir le popup de raison
    window.refuserDepuisModal = function() {
      if (!currentTraitementData) return;

      // Ouvrir le modal de refus avec raison
      document.getElementById('modalRefusCoach').style.display = 'flex';
      document.getElementById('raisonRefusCoach').value = '';
      document.getElementById('raisonRefusCoach').focus();
    };

    // Fonction pour afficher l'animation de succ√®s
    function showSuccessAnimation(message) {
      const overlay = document.createElement('div');
      overlay.className = 'success-overlay';
      overlay.innerHTML = `
        <div class="success-content">
          <div class="success-checkmark">
            <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
              <path d="M8 20 L16 28 L32 12" stroke="white" stroke-width="3"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">${message}</h2>
        </div>
      `;

      document.body.appendChild(overlay);

      // Supprimer l'overlay apr√®s l'animation
      setTimeout(() => {
        overlay.remove();
      }, 1500);
    }

    // Fermer le modal de refus Coach
    window.fermerModalRefusCoach = function() {
      document.getElementById('modalRefusCoach').style.display = 'none';
      document.getElementById('raisonRefusCoach').value = '';
    };

    // Variable pour stocker le type de paiement en cours de refus
    let currentRefusingType = null;
    let currentRefusingIndex = null;

    // Accepter un type de paiement sp√©cifique (depot, paiement_final, autres_paiements)
    window.accepterPaiementType = async function(typePaiement, index = 0) {
      if (!currentTraitementData) return;

      const numeroSoumission = currentTraitementData.numeroSoumission;
      const username = getFacturationUsername();
      const userRole = localStorage.getItem('userRole');

      // Trouver le bouton cliqu√© et ajouter le spinner
      const allBtns = document.querySelectorAll('.btn-section-accepter');
      let btn = null;
      allBtns.forEach(b => {
        if (b.onclick && b.onclick.toString().includes(typePaiement)) {
          btn = b;
        }
      });
      // Fallback: utiliser event.target si possible
      if (!btn) btn = event.target.closest('.btn-section-accepter');

      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      }

      try {
        let apiUrl;
        if (userRole === 'coach' || userRole === 'direction') {
          apiUrl = `/api/coach/facturation/${username}/${numeroSoumission}/valider`;
        } else {
          apiUrl = `/api/facturationqe/client/${username}/${numeroSoumission}/traiter`;
        }

        const bodyData = typePaiement === 'autres_paiements'
          ? { type: typePaiement, index: index }
          : { type: typePaiement };

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyData)
        });

        if (response.ok) {
          if (btn) {
            btn.innerHTML = '<i class="fas fa-check"></i>';
            btn.style.background = 'rgba(16, 185, 129, 0.5)';
          }

          // Afficher l'animation de succ√®s
          showSuccessAnimation('Paiement valid√© avec succ√®s!');

          // Fermer le modal imm√©diatement
          fermerModalDetailsTraitement();

          // Attendre que l'animation se termine avant de rafra√Æchir
          await new Promise(resolve => setTimeout(resolve, 1500));

          // Rafra√Æchir les donn√©es
          if (typeof utiliserDonneesTestStatus === 'function') {
            await utiliserDonneesTestStatus();
          }

          // Recharger les badges du s√©lecteur entrepreneur si on est un coach/direction
          if (userRole === 'coach' || userRole === 'direction') {
            if (window.EntrepreneurSelector) {
              window.EntrepreneurSelector.reload();
            } else if (typeof loadEntrepreneursForCoach === 'function') {
              loadEntrepreneursForCoach();
            }

            // Notifier le parent (apppccoach) pour rafra√Æchir le badge du menu lat√©ral
            window.parent.postMessage({ type: 'updateFacturationBadge' }, '*');
          }
        } else {
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check"></i> Accepter';
          }
          alert('Erreur: Impossible de valider le paiement');
        }
      } catch (error) {
        error('[MODAL] Erreur accepterPaiementType:', error);
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-check"></i> Accepter';
        }
        alert('Erreur lors de l\'acceptation');
      }
    };

    // Refuser un type de paiement sp√©cifique - ouvrir le popup de raison
    window.refuserPaiementType = function(typePaiement, index = 0) {
      if (!currentTraitementData) return;

      // Stocker le type et l'index pour la confirmation
      currentRefusingType = typePaiement;
      currentRefusingIndex = index;

      // Ouvrir le modal de refus avec raison
      document.getElementById('modalRefusCoach').style.display = 'flex';
      document.getElementById('raisonRefusCoach').value = '';
      document.getElementById('raisonRefusCoach').focus();
    };

    // Confirmer le refus avec la raison (Coach)
    window.confirmerRefusCoach = async function() {
      const raison = document.getElementById('raisonRefusCoach').value.trim();

      if (!raison) {
        alert('Veuillez indiquer une raison pour le refus.');
        document.getElementById('raisonRefusCoach').focus();
        return;
      }

      if (!currentTraitementData) return;

      const numeroSoumission = currentTraitementData.numeroSoumission;
      const typePaiementClique = currentTraitementData.typePaiementClique;
      const username = getFacturationUsername();
      const userRole = localStorage.getItem('userRole');

      try {
        // Fermer le modal de refus
        fermerModalRefusCoach();

        // R√©cup√©rer le nom de celui qui refuse via l'API
        const loggedInUsername = localStorage.getItem('username') || '';
        let nomRefuseur = loggedInUsername || 'Utilisateur';

        try {
          const userInfoResponse = await fetch(`/api/user/info/${loggedInUsername}`);
          if (userInfoResponse.ok) {
            const userInfo = await userInfoResponse.json();
            nomRefuseur = `${userInfo.prenom || ''} ${userInfo.nom || ''}`.trim() || loggedInUsername || 'Utilisateur';
          }
        } catch (e) {
          console.log('[REFUSER] Impossible de r√©cup√©rer les infos utilisateur');
        }

        // D√©terminer quel paiement refuser et construire le body
        let bodyData;
        if (typePaiementClique === 'depot') {
          bodyData = { type: 'depot', raison: raison, nomRefuseur: nomRefuseur };
        } else if (typePaiementClique === 'paiement_final') {
          bodyData = { type: 'paiement_final', raison: raison, nomRefuseur: nomRefuseur };
        } else if (typePaiementClique.startsWith('autre_paiement_')) {
          const index = parseInt(typePaiementClique.replace('autre_paiement_', '')) - 1;
          bodyData = { type: 'autres_paiements', raison: raison, index: index, nomRefuseur: nomRefuseur };
        } else {
          throw new Error('Type de paiement invalide');
        }

        // D√©terminer quelle API appeler selon le r√¥le
        let apiUrl;
        if (userRole === 'coach' || userRole === 'direction') {
          apiUrl = `/api/coach/facturation/${username}/${numeroSoumission}/refuser`;
        } else if (userRole === 'comptable') {
          apiUrl = `/api/comptable/facturation/${username}/${numeroSoumission}/refuser`;
        } else {
          // Fallback - utiliser coach endpoint
          apiUrl = `/api/coach/facturation/${username}/${numeroSoumission}/refuser`;
        }

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyData)
        });

        if (response.ok) {
          // Afficher l'animation de succ√®s
          showSuccessAnimation('Paiement refus√©');

          // Fermer le modal de d√©tails
          fermerModalDetailsTraitement();

          // Attendre que l'animation se termine avant de rafra√Æchir
          await new Promise(resolve => setTimeout(resolve, 1500));

          // Rafra√Æchir les donn√©es - utiliser utiliserDonneesTestStatus qui transforme les donn√©es correctement
          if (typeof utiliserDonneesTestStatus === 'function') {
            await utiliserDonneesTestStatus();
          }

          // Recharger les badges du s√©lecteur entrepreneur si on est un coach/direction
          if (userRole === 'coach' || userRole === 'direction') {
            if (window.EntrepreneurSelector) {
              window.EntrepreneurSelector.reload();
            } else if (typeof loadEntrepreneursForCoach === 'function') {
              loadEntrepreneursForCoach();
            }

            // Notifier le parent (apppccoach) pour rafra√Æchir le badge du menu lat√©ral
            window.parent.postMessage({ type: 'updateFacturationBadge' }, '*');
          }
        } else {
          const error = await response.json();
          alert('Erreur: ' + (error.detail || 'Impossible de refuser le paiement'));
        }
      } catch (error) {
        error('[MODAL] Erreur refuser:', error);
        alert('Erreur lors du refus');
      }
    };

    // ============================================
    // FONCTIONS MODAL REFUS ENTREPRENEUR
    // ============================================

    // Variable pour stocker les donn√©es du refus en cours
    let currentRefusData = null;
    // Variables pour stocker les nouvelles photos du ch√®que
    let refusNewPhotoRecto = null;
    let refusNewPhotoVerso = null;

    // Ouvrir le modal de refus entrepreneur
    window.ouvrirModalRefusEntrepreneur = async function(numeroSoumission, facturation) {
      log('[MODAL REFUS ENTREPRENEUR] Ouverture pour:', numeroSoumission, facturation);
      currentRefusData = { numeroSoumission, facturation };

      // Remplir les infos client
      const clientInfoDiv = document.getElementById('refusClientInfo');
      const client = `${facturation.clientPrenom || ''} ${facturation.clientNom || ''}`.trim() || 'Client inconnu';
      clientInfoDiv.innerHTML = `
        <p><strong>Client:</strong> ${client}</p>
        <p><strong>N¬∞ Soumission:</strong> ${numeroSoumission}</p>
        <p><strong>Montant:</strong> ${facturation.montantPaiement || '0,00 $'}</p>
      `;

      // R√©cup√©rer tous les √©tats de paiements via l'API
      const paiementsContainer = document.getElementById('refusPaiementsContainer');
      const username = getFacturationUsername();

      try {
        const responseStatuts = await fetch(`/api/facturationqe/client/${username}/${numeroSoumission}/statuts`);
        if (responseStatuts.ok) {
          const statuts = await responseStatuts.json();
          log('[MODAL REFUS] Statuts r√©cup√©r√©s:', statuts);

          // Fonction pour formater le statut avec couleur
          const formaterStatutPaiement = (statut) => {
            const statutsMap = {
              'non_envoye': { text: 'Non envoy√©', class: '' },
              'traitement': { text: 'En traitement', class: 'warning' },
              'attente_comptable': { text: 'Chez comptable', class: 'warning' },
              'traite_attente_final': { text: 'Trait√©', class: 'success' },
              'refuse': { text: 'Refus√©', class: 'danger' },
              'valide': { text: 'Valid√©', class: 'success' }
            };
            return statutsMap[statut] || { text: statut || 'N/A', class: '' };
          };

          let paiementsHTML = `<h4><i class="fas fa-file-invoice-dollar mr-2"></i>√âtats des paiements</h4>`;

          // Section D√©p√¥t
          if (statuts.depot) {
            const depot = statuts.depot;
            const statutInfo = formaterStatutPaiement(depot.statut);
            paiementsHTML += `
              <div class="refus-paiement-section">
                <div class="refus-paiement-header">
                  <i class="fas fa-piggy-bank" style="color: rgb(16, 185, 129);"></i>
                  <span style="color: var(--text-light);">D√©p√¥t</span>
                </div>
                <div class="refus-paiement-row">
                  <span class="refus-paiement-label">Montant</span>
                  <span class="refus-paiement-value highlight">${depot.montant || 'N/A'}</span>
                </div>
                <div class="refus-paiement-row">
                  <span class="refus-paiement-label">Statut</span>
                  <span class="refus-paiement-value ${statutInfo.class}">${statutInfo.text}</span>
                </div>
              </div>
            `;
          }

          // Section Autres Paiements
          if (statuts.autresPaiements && statuts.autresPaiements.length > 0) {
            statuts.autresPaiements.forEach((ap, index) => {
              const statutInfo = formaterStatutPaiement(ap.statut);
              let typeAutres = ap.typePaiementAutres;
              if (!typeAutres) {
                const statutDepot = statuts.statutDepot || 'non_envoye';
                typeAutres = (statutDepot === 'non_envoye') ? 'un_seul_paiement' : 'paiement_partiel';
              }
              const typePaiement = typeAutres === 'un_seul_paiement' ? 'Paiement complet' : `Paiement partiel ${index + 1}`;

              paiementsHTML += `
                <div class="refus-paiement-section">
                  <div class="refus-paiement-header">
                    <i class="fas fa-money-check-alt" style="color: #60a5fa;"></i>
                    <span style="color: var(--text-light);">${typePaiement}</span>
                  </div>
                  <div class="refus-paiement-row">
                    <span class="refus-paiement-label">Montant</span>
                    <span class="refus-paiement-value highlight">${ap.montant || 'N/A'}</span>
                  </div>
                  <div class="refus-paiement-row">
                    <span class="refus-paiement-label">Statut</span>
                    <span class="refus-paiement-value ${statutInfo.class}">${statutInfo.text}</span>
                  </div>
                </div>
              `;
            });
          }

          // Section Paiement Final
          if (statuts.paiementFinal) {
            const pf = statuts.paiementFinal;
            const statutInfo = formaterStatutPaiement(pf.statut);
            paiementsHTML += `
              <div class="refus-paiement-section">
                <div class="refus-paiement-header">
                  <i class="fas fa-flag-checkered" style="color: #a78bfa;"></i>
                  <span style="color: var(--text-light);">Paiement Final</span>
                </div>
                <div class="refus-paiement-row">
                  <span class="refus-paiement-label">Montant</span>
                  <span class="refus-paiement-value highlight">${pf.montant || 'N/A'}</span>
                </div>
                <div class="refus-paiement-row">
                  <span class="refus-paiement-label">Statut</span>
                  <span class="refus-paiement-value ${statutInfo.class}">${statutInfo.text}</span>
                </div>
              </div>
            `;
          }

          paiementsContainer.innerHTML = paiementsHTML;
          paiementsContainer.style.display = 'block';
        } else {
          paiementsContainer.innerHTML = '';
          paiementsContainer.style.display = 'none';
        }
      } catch (error) {
        error('[MODAL REFUS] Erreur r√©cup√©ration statuts:', error);
        paiementsContainer.innerHTML = '';
        paiementsContainer.style.display = 'none';
      }

      // ===== SECTION MODIFICATION DES INFORMATIONS DE PAIEMENT =====
      const modificationContainer = document.getElementById('refusModificationContainer');
      const modifVirement = document.getElementById('refusModifVirement');
      const modifCheque = document.getElementById('refusModifCheque');

      // Reset les champs
      document.getElementById('refusModifLienVirement').value = '';
      document.getElementById('refusModifMotDePasse').value = '';
      document.getElementById('refusModifNumeroCheque').value = '';
      document.getElementById('refusPhotoRectoPreview').style.display = 'none';
      document.getElementById('refusPhotoVersoPreview').style.display = 'none';
      document.getElementById('refusPhotoRectoPlaceholder').style.display = 'flex';
      document.getElementById('refusPhotoVersoPlaceholder').style.display = 'flex';

      // Charger les infos du paiement refus√© depuis l'API
      try {
        const responseStatuts = await fetch(`/api/facturationqe/client/${username}/${numeroSoumission}/statuts`);
        if (responseStatuts.ok) {
          const statuts = await responseStatuts.json();

          // D√©terminer quel paiement est refus√© et sa m√©thode
          let paiementRefuse = null;
          let typePaiement = 'depot';
          let indexPaiement = 0;

          if (statuts.depot && statuts.depot.statut === 'refuse') {
            paiementRefuse = statuts.depot;
            typePaiement = 'depot';
          } else if (statuts.autresPaiements) {
            const autreRefuse = statuts.autresPaiements.find((p, idx) => {
              if (p.statut === 'refuse') {
                indexPaiement = idx;
                return true;
              }
              return false;
            });
            if (autreRefuse) {
              paiementRefuse = autreRefuse;
              typePaiement = 'autres_paiements';
            }
          }
          if (!paiementRefuse && statuts.paiementFinal && statuts.paiementFinal.statut === 'refuse') {
            paiementRefuse = statuts.paiementFinal;
            typePaiement = 'paiement_final';
          }

          // Stocker le type de paiement et l'index dans currentRefusData
          currentRefusData.typePaiement = typePaiement;
          currentRefusData.indexPaiement = indexPaiement;

          // Stocker le refus de l'API pour l'utiliser dans la conversation
          if (paiementRefuse && paiementRefuse.refus) {
            currentRefusData.refusFromAPI = paiementRefuse.refus;
            // Mettre √† jour aussi facturation.refus pour que les messages envoy√©s soient persist√©s correctement
            if (!currentRefusData.facturation.refus) {
              currentRefusData.facturation.refus = paiementRefuse.refus;
            } else {
              // Remplacer par les donn√©es fra√Æches de l'API
              currentRefusData.facturation.refus = paiementRefuse.refus;
            }
          }

          if (paiementRefuse) {
            const methode = paiementRefuse.methode || '';
            currentRefusData.methode = methode;
            log('[MODAL REFUS] Paiement refus√© trouv√©:', paiementRefuse, 'M√©thode:', methode);

            if (methode === 'virement') {
              modificationContainer.style.display = 'block';
              modifVirement.style.display = 'block';
              modifCheque.style.display = 'none';

              // Pr√©-remplir le lien et mot de passe actuels
              if (paiementRefuse.lienVirement) {
                document.getElementById('refusModifLienVirement').value = paiementRefuse.lienVirement;
              }
              if (paiementRefuse.motDePasse) {
                document.getElementById('refusModifMotDePasse').value = paiementRefuse.motDePasse;
              }
            } else if (methode === 'cheque' || methode === 'ch√®que') {
              modificationContainer.style.display = 'block';
              modifVirement.style.display = 'none';
              modifCheque.style.display = 'block';

              // Pr√©-remplir le num√©ro de ch√®que
              if (paiementRefuse.numeroCheque) {
                document.getElementById('refusModifNumeroCheque').value = paiementRefuse.numeroCheque;
              }

              // Afficher les photos existantes
              if (paiementRefuse.photoRecto) {
                const rectoPreview = document.getElementById('refusPhotoRectoPreview');
                rectoPreview.src = paiementRefuse.photoRecto;
                rectoPreview.style.display = 'block';
                document.getElementById('refusPhotoRectoPlaceholder').style.display = 'none';
              }
              if (paiementRefuse.photoVerso) {
                const versoPreview = document.getElementById('refusPhotoVersoPreview');
                versoPreview.src = paiementRefuse.photoVerso;
                versoPreview.style.display = 'block';
                document.getElementById('refusPhotoVersoPlaceholder').style.display = 'none';
              }
            } else {
              // M√©thode inconnue - cacher la section modification
              modificationContainer.style.display = 'none';
            }
          } else {
            modificationContainer.style.display = 'none';
          }
        } else {
          modificationContainer.style.display = 'none';
        }
      } catch (err) {
        log('[MODAL REFUS] Erreur chargement infos paiement:', err);
        modificationContainer.style.display = 'none';
      }

      // Remplir la conversation - utiliser les donn√©es fra√Æches de l'API si disponibles
      const conversationDiv = document.getElementById('refusConversation');
      const refus = currentRefusData.refusFromAPI || currentRefusData.facturation.refus || facturation.refus;

      if (refus && refus.conversation && refus.conversation.length > 0) {
        // D√©terminer le r√¥le de l'utilisateur qui consulte
        const viewerRole = localStorage.getItem('userRole') || 'entrepreneur';

        conversationDiv.innerHTML = refus.conversation.map(msg => {
          // Message de MOI = √† droite (from-me), message des AUTRES = √† gauche (from-other)
          const isFromMe = msg.de === viewerRole;
          const bubbleClass = isFromMe ? 'from-entrepreneur' : 'from-comptable';
          const senderIcon = msg.de === 'entrepreneur' ? 'fa-user' : 'fa-user-tie';
          const dateStr = msg.date ? new Date(msg.date).toLocaleString('fr-CA') : '';

          // Utiliser le nom si disponible, sinon fallback sur le r√¥le
          let senderLabel = msg.nom || '';
          if (!senderLabel) {
            if (msg.de === 'coach') senderLabel = 'Coach';
            else if (msg.de === 'comptable') senderLabel = 'Comptable';
            else if (msg.de === 'direction') senderLabel = 'Direction';
            else senderLabel = 'Entrepreneur';
          }

          return `
            <div class="message-bubble ${bubbleClass}">
              <div class="message-meta">
                <i class="fas ${senderIcon}"></i>
                <span>${senderLabel}</span>
                <span>${dateStr}</span>
              </div>
              <div class="message-text">${msg.message}</div>
            </div>
          `;
        }).join('');
      } else if (refus && refus.raison) {
        // Afficher juste la raison initiale s'il n'y a pas de conversation
        let senderLabel = refus.nomRefusePar || '';
        if (!senderLabel) {
          senderLabel = refus.refusePar === 'coach' ? 'Coach' : (refus.refusePar === 'direction' ? 'Direction' : 'Comptable');
        }
        const dateStr = refus.dateRefus ? new Date(refus.dateRefus).toLocaleString('fr-CA') : '';
        conversationDiv.innerHTML = `
          <div class="message-bubble from-comptable">
            <div class="message-meta">
              <i class="fas fa-user-tie"></i>
              <span>${senderLabel}</span>
              <span>${dateStr}</span>
            </div>
            <div class="message-text">${refus.raison}</div>
          </div>
        `;
      } else {
        conversationDiv.innerHTML = `<p style="color: var(--text-gray); text-align: center;">Aucun message</p>`;
      }

      // Vider le textarea de r√©ponse
      document.getElementById('reponseEntrepreneur').value = '';

      // Ouvrir le modal
      document.getElementById('modalRefusEntrepreneur').style.display = 'flex';

      // Bloquer le scroll en arri√®re-plan
      document.body.style.overflow = 'hidden';
      document.documentElement.style.overflow = 'hidden';
    };

    // Fermer le modal de refus entrepreneur
    window.fermerModalRefusEntrepreneur = function() {
      document.getElementById('modalRefusEntrepreneur').style.display = 'none';
      document.getElementById('reponseEntrepreneur').value = '';
      currentRefusData = null;

      // Reset les photos
      refusNewPhotoRecto = null;
      refusNewPhotoVerso = null;

      // Restaurer le scroll
      document.body.style.overflow = '';
      document.documentElement.style.overflow = '';
    };

    // ===== SUPPRESSION PAIEMENT ENTREPRENEUR =====
    window.ouvrirModalSuppressionEntrepreneur = function() {
      if (!currentRefusData) return;

      const facturation = currentRefusData.facturation;
      const client = `${facturation.clientPrenom || ''} ${facturation.clientNom || ''}`.trim() || 'Client inconnu';

      // Formater le type
      const typeLabels = {
        'depot': 'D√©p√¥t',
        'paiement_final': 'Paiement final',
        'autres_paiements': 'Paiement partiel'
      };

      document.getElementById('suppression-ent-client').textContent = client;
      document.getElementById('suppression-ent-type').textContent = typeLabels[currentRefusData.typePaiement] || currentRefusData.typePaiement;
      document.getElementById('suppression-ent-montant').textContent = facturation.montantPaiement || '0,00 $';
      document.getElementById('suppression-ent-soumission').textContent = currentRefusData.numeroSoumission;

      document.getElementById('modalSuppressionEntrepreneur').style.display = 'flex';
    };

    window.fermerModalSuppressionEntrepreneur = function() {
      document.getElementById('modalSuppressionEntrepreneur').style.display = 'none';
    };

    window.confirmerSuppressionEntrepreneur = async function() {
      if (!currentRefusData) return;

      const username = getFacturationUsername();

      try {
        const response = await fetch('/api/comptable/facturation/supprimer-complet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            entrepreneurUsername: username,
            numeroSoumission: currentRefusData.numeroSoumission,
            type: currentRefusData.typePaiement,
            index: currentRefusData.indexPaiement || 0
          })
        });

        if (response.ok) {
          fermerModalSuppressionEntrepreneur();
          fermerModalRefusEntrepreneur();

          // Afficher un message de succ√®s
          alert('Le paiement a √©t√© supprim√© avec succ√®s');

          // Rafra√Æchir les donn√©es
          if (typeof utiliserDonneesTestStatus === 'function') {
            await utiliserDonneesTestStatus();
          }
          if (typeof chargerFacturationsColonnes === 'function') {
            chargerFacturationsColonnes();
          }

          // Notifier apppc.html de mettre √† jour le badge urgent
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'facturation-urgent-updated' }, '*');
          }
        } else {
          const error = await response.json();
          alert('Erreur: ' + (error.detail || 'Impossible de supprimer le paiement'));
        }
      } catch (error) {
        console.error('[Facturation QE] Erreur suppression:', error);
        alert('Erreur lors de la suppression');
      }
    };

    // ===== GESTION DES FICHIERS PHOTOS POUR LA MODIFICATION =====
    // Handler pour photo recto
    document.getElementById('refusPhotoRectoInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          refusNewPhotoRecto = event.target.result;
          const preview = document.getElementById('refusPhotoRectoPreview');
          preview.src = event.target.result;
          preview.style.display = 'block';
          document.getElementById('refusPhotoRectoPlaceholder').style.display = 'none';
          log('[MODAL REFUS] Nouvelle photo recto charg√©e');
        };
        reader.readAsDataURL(file);
      }
    });

    // Handler pour photo verso
    document.getElementById('refusPhotoVersoInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          refusNewPhotoVerso = event.target.result;
          const preview = document.getElementById('refusPhotoVersoPreview');
          preview.src = event.target.result;
          preview.style.display = 'block';
          document.getElementById('refusPhotoVersoPlaceholder').style.display = 'none';
          log('[MODAL REFUS] Nouvelle photo verso charg√©e');
        };
        reader.readAsDataURL(file);
      }
    });

    // Envoyer un message dans la conversation (sans changer le statut)
    window.envoyerMessageRefus = async function() {
      if (!currentRefusData) return;

      const reponse = document.getElementById('reponseEntrepreneur').value.trim();

      if (!reponse) {
        alert('Veuillez √©crire un message avant d\'envoyer.');
        document.getElementById('reponseEntrepreneur').focus();
        return;
      }

      const numeroSoumission = currentRefusData.numeroSoumission;
      const entrepreneurUsername = getFacturationUsername(); // Username de l'entrepreneur (pour l'API)

      // Utiliser le type et index d√©j√† d√©termin√©s
      const typePaiement = currentRefusData.typePaiement || 'depot';
      const index = currentRefusData.indexPaiement || 0;

      // D√©tecter le r√¥le de l'utilisateur connect√© - utiliser localStorage.userRole (d√©fini au login, ne change pas)
      const userRole = localStorage.getItem('userRole') || 'entrepreneur';

      // Utiliser loggedInUsername si disponible, sinon fallback
      const loggedInUsername = localStorage.getItem('loggedInUsername') || localStorage.getItem('username') || '';

      let expediteur = 'entrepreneur';
      let userFullName = '';

      // D√©terminer l'exp√©diteur selon le r√¥le (localStorage.userRole est fiable)
      if (userRole === 'direction') {
        expediteur = 'direction';
      } else if (userRole === 'coach') {
        expediteur = 'coach';
      } else if (userRole === 'comptable') {
        expediteur = 'comptable';
      }

      // Pour l'affichage imm√©diat, MON message va toujours √† droite (from-entrepreneur)
      const bubbleClass = 'from-entrepreneur';

      // R√©cup√©rer le NOM de l'utilisateur connect√© via l'API
      // Pour coach/direction: utiliser loggedInUsername ou URL param ?user=
      // Pour entrepreneur: utiliser getFacturationUsername()
      let usernameForName = getFacturationUsername();
      if (userRole === 'coach' || userRole === 'direction' || userRole === 'comptable') {
        // Essayer d'abord loggedInUsername, puis URL param, puis fallback
        const urlParams = new URLSearchParams(window.location.search);
        usernameForName = localStorage.getItem('loggedInUsername') || urlParams.get('user') || loggedInUsername;
      }

      try {
        const userInfoResponse = await fetch(`/api/user/info/${usernameForName}`);
        if (userInfoResponse.ok) {
          const userInfo = await userInfoResponse.json();
          userFullName = `${userInfo.prenom || ''} ${userInfo.nom || ''}`.trim();
        }
      } catch (e) {
        console.log('[MODAL] Impossible de r√©cup√©rer les infos utilisateur');
      }

      // Fallback si pas de nom
      if (!userFullName) {
        userFullName = usernameForName || 'Utilisateur';
      }

      try {
        const response = await fetch(`/api/facturationqe/client/${entrepreneurUsername}/${numeroSoumission}/message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: typePaiement,
            message: reponse,
            index: index,
            de: expediteur,
            nomExp√©diteur: userFullName
          })
        });

        if (response.ok) {
          // Vider le textarea
          document.getElementById('reponseEntrepreneur').value = '';

          // Ajouter le nouveau message √† currentRefusData pour qu'il persiste
          const nouveauMessage = {
            de: expediteur,
            nom: userFullName,
            message: reponse,
            date: new Date().toISOString()
          };

          if (currentRefusData && currentRefusData.facturation) {
            if (!currentRefusData.facturation.refus) {
              currentRefusData.facturation.refus = { conversation: [] };
            }
            if (!currentRefusData.facturation.refus.conversation) {
              currentRefusData.facturation.refus.conversation = [];
            }
            currentRefusData.facturation.refus.conversation.push(nouveauMessage);
          }

          // Ajouter le message √† la conversation affich√©e
          const conversationContainer = document.getElementById('refusConversation');
          const newMessageHTML = `
            <div class="message-bubble ${bubbleClass}">
              <div class="message-meta">
                <i class="fas ${expediteur === 'entrepreneur' ? 'fa-user' : 'fa-user-tie'}"></i>
                <span>${userFullName}</span>
                <span>${new Date().toLocaleString('fr-CA')}</span>
              </div>
              <div class="message-text">${reponse}</div>
            </div>
          `;
          conversationContainer.insertAdjacentHTML('beforeend', newMessageHTML);

          // Scroll vers le bas de la conversation
          conversationContainer.scrollTop = conversationContainer.scrollHeight;
        } else {
          const error = await response.json();
          alert('Erreur: ' + (error.detail || 'Impossible d\'envoyer le message'));
        }
      } catch (error) {
        console.error('[MODAL] Erreur envoi message:', error);
        alert('Erreur lors de l\'envoi du message');
      }
    };

    window.renvoyerEnTraitement = async function() {
      if (!currentRefusData) return;

      const reponse = document.getElementById('reponseEntrepreneur').value.trim();

      const numeroSoumission = currentRefusData.numeroSoumission;
      const facturation = currentRefusData.facturation;
      const username = getFacturationUsername();

      // Utiliser le type de paiement et l'index d√©j√† d√©termin√©s √† l'ouverture du modal
      let typePaiement = currentRefusData.typePaiement || 'depot';
      let index = currentRefusData.indexPaiement || 0;

      // Fallback: V√©rifier les statuts r√©els des paiements si pas d√©j√† d√©termin√©
      if (!currentRefusData.typePaiement) {
        if (facturation.statutDepot === 'refuse' || facturation.depotRefuse) {
          typePaiement = 'depot';
        } else if (facturation.statutPaiementFinal === 'refuse' || facturation.paiementFinalRefuse) {
          typePaiement = 'paiement_final';
        } else if (facturation.statutAutresPaiements === 'refuse' || facturation.autresRefuses) {
          typePaiement = 'autres_paiements';
          const autresPaiements = facturation.autresPaiements || [];
          index = autresPaiements.findIndex(p => p.statut === 'refuse');
          if (index === -1) index = 0;
        }
      }

      // ===== R√âCUP√âRER LES DONN√âES MODIFI√âES =====
      const methode = currentRefusData.methode || '';
      let modificationsPayload = {};

      if (methode === 'virement') {
        const nouveauLien = document.getElementById('refusModifLienVirement').value.trim();
        const nouveauMotDePasse = document.getElementById('refusModifMotDePasse').value.trim();
        if (nouveauLien) {
          modificationsPayload.lienVirement = nouveauLien;
        }
        if (nouveauMotDePasse) {
          modificationsPayload.motDePasseVirement = nouveauMotDePasse;
        }
      } else if (methode === 'cheque' || methode === 'ch√®que') {
        const nouveauNumeroCheque = document.getElementById('refusModifNumeroCheque').value.trim();
        if (nouveauNumeroCheque) {
          modificationsPayload.numeroCheque = nouveauNumeroCheque;
        }
        // Ajouter les nouvelles photos si elles ont √©t√© chang√©es
        if (refusNewPhotoRecto) {
          modificationsPayload.photoRecto = refusNewPhotoRecto;
        }
        if (refusNewPhotoVerso) {
          modificationsPayload.photoVerso = refusNewPhotoVerso;
        }
      }

      log('[RENVOYER] Modifications √† envoyer:', modificationsPayload);

      try {
        const response = await fetch(`/api/facturationqe/client/${username}/${numeroSoumission}/renvoyer`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: typePaiement,
            reponse: reponse,
            index: index,
            modifications: modificationsPayload
          })
        });

        if (response.ok) {
          // Fermer le modal
          fermerModalRefusEntrepreneur();

          // Rafra√Æchir les donn√©es - utiliser utiliserDonneesTestStatus qui transforme les donn√©es correctement
          if (typeof utiliserDonneesTestStatus === 'function') {
            await utiliserDonneesTestStatus();
          }

          // Rafra√Æchir l'affichage des colonnes pour mettre √† jour les totaux et compteurs
          if (typeof chargerFacturationsColonnes === 'function') {
            chargerFacturationsColonnes();
          }

          // Recharger les badges du s√©lecteur entrepreneur si on est un coach/direction
          const userRole = localStorage.getItem('userRole');
          if (userRole === 'coach' || userRole === 'direction') {
            if (window.EntrepreneurSelector) {
              window.EntrepreneurSelector.reload();
            } else if (typeof loadEntrepreneursForCoach === 'function') {
              loadEntrepreneursForCoach();
            }
          }

          // Notifier apppc.html de mettre √† jour le badge urgent
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'facturation-urgent-updated' }, '*');
          }
        } else {
          const error = await response.json();
          alert('Erreur: ' + (error.detail || 'Impossible de renvoyer le paiement'));
        }
      } catch (error) {
        error('[MODAL ENTREPRENEUR] Erreur renvoyer:', error);
        alert('Erreur lors du renvoi en traitement');
      }
    };

    // Fermer le modal avec Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        // Fermer d'abord le modal de refus entrepreneur s'il est ouvert
        const modalRefusEntrepreneur = document.getElementById('modalRefusEntrepreneur');
        if (modalRefusEntrepreneur && modalRefusEntrepreneur.style.display === 'flex') {
          fermerModalRefusEntrepreneur();
          return;
        }
        // Fermer le modal de refus coach s'il est ouvert
        const modalRefus = document.getElementById('modalRefusCoach');
        if (modalRefus && modalRefus.style.display === 'flex') {
          fermerModalRefusCoach();
          return;
        }
        // Sinon fermer le modal de d√©tails
        const modal = document.getElementById('modalDetailsTraitement');
        if (modal && modal.style.display === 'flex') {
          fermerModalDetailsTraitement();
        }
      }
    });

    // Global function for entrepreneur selector to reload data
    window.loadFacturationData = async function() {
      await chargerClientsDepuisAPI();
      await chargerFacturationsDepuisAPI();

      // Recharger les colonnes Status si on est sur cet onglet
      const statusTab = document.getElementById('page2');
      if (statusTab && !statusTab.classList.contains('hidden')) {
        if (typeof utiliserDonneesTestStatus === 'function') {
          await utiliserDonneesTestStatus();
        }
        if (typeof chargerFacturationsColonnes === 'function') {
          chargerFacturationsColonnes();
        }
        if (typeof chargerPeriodesTraiter === 'function') {
          chargerPeriodesTraiter();
        }
      }
    };

    // ============================================
    // FONCTION POUR CHARGER LES P√âRIODES TRAITER
    // ============================================
    async function chargerPeriodesTraiter() {
      const container = document.getElementById('periodes-container-traiter');
      const loading = document.getElementById('traiter-loading');
      const empty = document.getElementById('traiter-empty');

      if (!container || !loading || !empty) {
        warn('[PERIODES] √âl√©ments DOM non trouv√©s, skip chargement');
        return;
      }

      try {
        loading.style.display = 'flex';
        container.innerHTML = '';
        empty.style.display = 'none';

        // R√©cup√©rer le username
        const userRole = localStorage.getItem('userRole');
        const username = window.selectedEntrepreneurUsername || window.username || localStorage.getItem('username');

        log('[PERIODES] Chargement pour:', username, 'Role:', userRole);

        // Charger les p√©riodes depuis l'API
        const response = await fetch('/api/comptable/facturation/periodes');
        if (!response.ok) {
          throw new Error('Erreur lors du chargement des p√©riodes');
        }

        const data = await response.json();
        const periodes = data.periodes || {};

        log('[PERIODES] Donn√©es re√ßues:', periodes);

        loading.style.display = 'none';

        if (Object.keys(periodes).length === 0) {
          empty.style.display = 'flex';
          return;
        }

        // Filtrer les paiements selon le r√¥le
        // Structure API: {periode_id: [paiements]}
        const periodesFiltrees = {};
        for (const [periodeId, paiements] of Object.entries(periodes)) {
          // V√©rifier que paiements est bien un tableau
          if (!Array.isArray(paiements)) {
            warn('[PERIODES] P√©riode ignor√©e (pas un tableau):', periodeId, paiements);
            continue;
          }

          const paiementsFiltres = paiements.filter(p => {
            // Toujours filtrer par l'entrepreneur s√©lectionn√©
            // (m√™me si on est coach/direction, on veut voir seulement cet entrepreneur)
            return p.entrepreneurUsername === username;
          });

          if (paiementsFiltres.length > 0) {
            periodesFiltrees[periodeId] = paiementsFiltres;
          }
        }

        // Trier les p√©riodes: 0 en premier, puis 1, 2, 3...
        const periodesTriees = Object.entries(periodesFiltrees).sort((a, b) => {
          const pA = parseInt(a[0]);
          const pB = parseInt(b[0]);
          if (pA === 0) return -1;
          if (pB === 0) return 1;
          return pA - pB;
        });

        // Afficher les p√©riodes
        for (const [periodeId, paiements] of periodesTriees) {
          const periodeHtml = creerPeriodeHTML(periodeId, paiements);
          container.insertAdjacentHTML('beforeend', periodeHtml);
        }

        if (Object.keys(periodesFiltrees).length === 0) {
          empty.style.display = 'flex';
        }

        // Calculer le total de tous les paiements trait√©s
        let totalTraitees = 0;
        for (const [periodeId, paiements] of Object.entries(periodesFiltrees)) {
          paiements.forEach(paiement => {
            // Extraire le montant du paiement avec parsing correct
            const montantMatch = parseMontant(paiement.montant);
            totalTraitees += montantMatch;
          });
        }

        // Mettre √† jour l'affichage du total
        const totalSpan = document.getElementById('traitees-total');
        if (totalSpan) {
          totalSpan.textContent = formatCurrency(totalTraitees);
        }

      } catch (error) {
        error('[PERIODES] Erreur:', error);
        loading.style.display = 'none';
        empty.style.display = 'flex';
      }
    }

    function creerPeriodeHTML(periodeId, paiements) {
      // paiements est maintenant directement un tableau
      const paiementsCount = paiements.length;

      // Extraire le num√©ro de la p√©riode (ex: "periode-1" ‚Üí "1")
      const periodeNumero = periodeId.replace('periode-', '');

      return `
        <div style="background: rgba(23, 32, 51, 0.6); border: 1px solid var(--border-dark); border-radius: 8px; margin-bottom: 0.75rem; overflow: hidden;">
          <div class="periode-header" onclick="togglePeriodeTraiter('${periodeId}')" style="padding: 0.75rem; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s ease;">
            <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
              <i class="fas fa-chevron-right" id="icon-${periodeId}" style="color: rgb(96, 165, 250); transition: transform 0.3s ease; font-size: 0.7rem;"></i>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 0.85rem; color: var(--text-light);">P√©riode ${periodeNumero}</div>
                <div style="font-size: 0.7rem; color: var(--text-gray); margin-top: 0.1rem;">${paiementsCount} paiement${paiementsCount > 1 ? 's' : ''}</div>
              </div>
            </div>
            <div style="background: rgba(16, 185, 129, 0.2); border-radius: 12px; padding: 0.2rem 0.5rem; font-size: 0.7rem; font-weight: 600; color: rgb(16, 185, 129);">${paiementsCount}</div>
          </div>
          <div class="periode-content" id="content-${periodeId}" style="display: none; border-top: 1px solid var(--border-dark); padding: 0.5rem;">
            ${paiements.map(paiement => {
              // D√©terminer le label du type de paiement
              let typeLabel = 'Paiement';
              if (paiement.type === 'depot') {
                typeLabel = 'D√©p√¥t';
              } else if (paiement.type === 'paiement_final') {
                typeLabel = 'Paiement final';
              } else if (paiement.type && paiement.type.startsWith('autre_paiement_')) {
                const numero = paiement.type.replace('autre_paiement_', '');
                typeLabel = 'Paiement partiel #' + numero;
              }

              return '<div style="padding: 0.5rem; border-bottom: 1px solid var(--border-dark); transition: background 0.2s;" onmouseover="this.style.background=\'rgba(59, 130, 246, 0.05)\'" onmouseout="this.style.background=\'\'">' +
                '<div style="font-weight: 500; color: var(--text-light); font-size: 0.8rem; margin-bottom: 0.15rem;">' + (paiement.client || 'Client inconnu') + '</div>' +
                '<div style="color: var(--text-gray); font-size: 0.7rem;">' + typeLabel + ' ‚Ä¢ ' + (paiement.montant || '-') + '</div>' +
                '</div>';
            }).join('')}
          </div>
        </div>
      `;
    }

    function togglePeriodeTraiter(periodeId) {
      const content = document.getElementById(`content-${periodeId}`);
      const icon = document.getElementById(`icon-${periodeId}`);

      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(90deg)';
      } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
      }
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    function formatDateShort(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    // Exposer globalement
    window.chargerPeriodesTraiter = chargerPeriodesTraiter;
  </script>

  <!-- Script commun de gestion des permissions et interface -->
  <script src="/common.js"></script>
  <script src="/entrepreneur-selector.js"></script>
</body>
</html>
