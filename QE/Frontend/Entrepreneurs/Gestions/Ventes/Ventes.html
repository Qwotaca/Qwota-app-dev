<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Ventes</title>

  <!-- Cache Control - D√©sactiver compl√®tement le cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- üì± PWA Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#5271ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Qwota">
  <meta name="msapplication-TileColor" content="#5271ff">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Ic√¥nes PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

  <!-- Script Service Worker -->
  <script>
  /* Service Worker disabled */
  </script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="/favicon" type="image/x-icon" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.min.js"></script>

  <!-- Variables globales d√©finies dans common.js -->
  <script>
    // Ces variables sont maintenant g√©r√©es par common.js
    // username, userRole, canEditParameters sont disponibles globalement
  </script>

  <!-- ANTI-FLASH: D√©tection coach AVANT le rendu du body -->
  <script>
    // ‚ö° D√âSACTIVATION DES LOGS - Performance optimization
    window.log = window.log || (() => {});
    window.warn = window.warn || (() => {});
    window.error = window.error || (() => {});
    window.info = window.info || (() => {});
    window.debug = window.debug || (() => {});

    (function() {
      const userRole = localStorage.getItem('userRole');
      const isCoachOrDirection = userRole === 'coach' || userRole === 'direction';
      const urlParams = new URLSearchParams(window.location.search);
      const userParam = urlParams.get('user');
      const coachUsername = localStorage.getItem('username');

      log('[VENTES ANTI-FLASH] userRole:', userRole, 'isCoachOrDirection:', isCoachOrDirection);
      log('[VENTES ANTI-FLASH] userParam:', userParam, 'coachUsername:', coachUsername);

      // Afficher le s√©lecteur si:
      // - C'est un coach/direction ET (pas de param√®tre user OU le param√®tre user est le coach/direction lui-m√™me)
      const shouldShowSelector = isCoachOrDirection && (!userParam || userParam === coachUsername);

      log('[VENTES ANTI-FLASH] shouldShowSelector:', shouldShowSelector);
      if (shouldShowSelector) {
        // Injecter le CSS imm√©diatement pour cacher le contenu et afficher le s√©lecteur
        const style = document.createElement('style');
        style.id = 'coach-anti-flash-css';
        style.textContent = `
          .main-content {
            opacity: 0 !important;
            pointer-events: none !important;
          }
          #coach-selector-backdrop {
            display: block !important;
            opacity: 1 !important;
            pointer-events: all !important;
          }
          #coach-entrepreneur-selector {
            display: block !important;
            opacity: 1 !important;
          }
        `;
        document.head.appendChild(style);
      }
    })();
  </script>

  <!-- CSS uniquement pour le menu lat√©ral -->
  <link rel="stylesheet" href="/base.css" />

  <!-- Styles centraleadmin pour les sections/tableaux -->
  <link rel="stylesheet" href="/centraleadmin.css" />

  <!-- Styles sp√©cifiques √† Ventes -->
  <link rel="stylesheet" href="/Ventes.css">

  <!-- Fix pour les modals dans les iframes -->
  <style>
    /* Forcer tous les modals √† √™tre fix√©s par rapport au viewport */
    .modal-overlay, .modal-overlay-opaque, .modal, [class*="modal"] {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      z-index: 9999 !important;
    }

    .modal-content, .modal-dialog, [class*="modal-content"], [class*="modal-dialog"] {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      max-height: 90vh !important;
      overflow-y: auto !important;
      z-index: 10000 !important;
    }

    /* ============================================
       PDF MODAL FULL SCREEN - COPI√â DE SOUMISSION.CSS
       ============================================ */

/* PDF Viewer styles - Style Centraleentrepreneur mais plus √©troit */
  #pdfViewerOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 999998;
    display: none;
    padding: 12px;
    pointer-events: none;
  }

  #pdfViewerModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 1400px;
    max-height: 95vh;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    border: 1px solid rgba(148, 163, 184, 0.2);
    z-index: 999999;
    overflow: visible;
    display: flex;
    flex-direction: column;
    padding: 24px;
  }

  #pdfViewerModal.hidden {
    display: none !important;
  }

  #closePdfViewerBtn {
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 10001;
    transition: all 0.2s ease;
    position: static;
    font-size: 20px !important;
  }

  #closePdfViewerBtn:hover {
    background: rgba(248, 113, 113, 0.8) !important;
    transform: scale(1.1);
  }

  #pdfViewerContent {
    width: 100%;
    height: 100%;
    padding: 0;
    display: flex;
    flex-direction: column;
    background: transparent;
    overflow: hidden;
  }

  #pdfViewerControls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 12px 16px;
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
    border-bottom: 1px solid rgba(96, 165, 250, 0.2);
    border-radius: 16px 16px 0 0;
  }

  .pdf-header-title {
    color: var(--text-light);
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .pdf-header-title::before {
    content: "\f15b";
    font-family: "Font Awesome 6 Free";
    font-weight: 400;
    font-size: 1.1rem;
  }

  #closePdfViewerBtn.close-btn {
    background: rgba(248, 113, 113, 0.15);
    color: #f87171;
    border: 1px solid rgba(248, 113, 113, 0.3);
    border-radius: 8px;
    width: 36px;
    height: 36px;
    font-size: 1.25rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }

  #closePdfViewerBtn.close-btn:hover {
    background: rgba(248, 113, 113, 0.3);
    transform: scale(1.05);
    border-color: rgba(248, 113, 113, 0.5);
  }

  #pdfViewerScrollContainer {
    flex: 1;
    overflow: auto;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 16px;
    background: rgba(0, 0, 0, 0.3);
  }

  #pdfViewerScrollContainer > div {
    display: inline-block;
    width: fit-content;
    height: fit-content;
  }

  /* Scrollbar personnalis√©e pour le container PDF */
  #pdfViewerScrollContainer::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  #pdfViewerScrollContainer::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 10px;
  }

  #pdfViewerScrollContainer::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    transition: background 0.2s ease;
  }

  #pdfViewerScrollContainer::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
  }

  #pdfViewerScrollContainer::-webkit-scrollbar-corner {
    background: transparent;
  }

  #pdfViewerCanvas,
  .pdf-page-canvas {
    display: block;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    transition: transform 0.1s ease;
    max-width: 100%;
    height: auto;
  }

  /* Bloquer le scroll en background quand popup PDF ouverte (tous √©crans) */
  body.modal-open {
    overflow: hidden !important;
  }

    /* ===== PDF MODAL MOBILE - Zoom tactile ===== */

  /* S'assurer que le modal reste cach√© quand il a la classe hidden */
  @media (max-width: 600px) {
    #pdfViewerModal.hidden {
      display: none !important;
    }

    /* Styles quand le modal est visible (sans classe hidden) */
    #pdfViewerModal:not(.hidden) {
      position: fixed !important;
      width: 100vw !important;
      max-width: 100vw !important;
      height: 100vh !important;
      max-height: 100vh !important;
      border-radius: 0 !important;
      padding: 0 !important;
      top: 0 !important;
      left: 0 !important;
      transform: none !important;
      display: flex !important;
      flex-direction: column !important;
      z-index: 999999 !important;
    }

    /* Overlay aussi au-dessus de tout sur mobile */
    #pdfViewerOverlay {
      position: fixed !important;
      width: 100vw !important;
      height: 100vh !important;
      top: 0 !important;
      left: 0 !important;
      z-index: 999998 !important;
      padding: 0 !important;
    }

    #pdfViewerContent {
      height: 100% !important;
      display: flex !important;
      flex-direction: column !important;
      padding: 0 !important;
    }

    #pdfViewerControls {
      padding: 8px 12px !important;
      flex-shrink: 0 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 10px !important;
    }

    #pdfViewerScrollContainer {
      flex: 1 !important;
      padding: 4px !important;
      overflow: auto !important;
      -webkit-overflow-scrolling: touch !important;
      touch-action: pan-x pan-y pinch-zoom !important;
      display: flex !important;
      align-items: flex-start !important;
      justify-content: flex-start !important;
      background: rgba(0, 0, 0, 0.5) !important;
    }

    /* Container interne pour scroll - s'adapte au canvas */
    #pdfViewerScrollContainer > div {
      display: inline-block !important;
      width: fit-content !important;
      height: fit-content !important;
      flex-shrink: 0 !important;
    }

    #pdfViewerCanvas,
    .pdf-page-canvas {
      max-width: none !important;
      width: auto !important;
      height: auto !important;
      transform-origin: 0 0 !important;
      display: block !important;
    }

    /* Bouton fermer plus visible sur mobile */
    #closePdfViewerBtn,
    #closePdfViewerBtn.close-btn {
      width: 36px !important;
      height: 36px !important;
      font-size: 18px !important;
    }

    /* Header PDF sur mobile */
    .pdf-header-title {
      font-size: 0.9rem !important;
    }

    .pdf-header-title::before {
      font-size: 1rem !important;
    }
  }

    /* ============================================
       COACH SELECTOR - CENTERED STATE (initial)
       ============================================ */
    #coach-entrepreneur-selector {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) scale(1);
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
      backdrop-filter: blur(20px);
      border: 2px solid var(--border-dark);
      border-radius: 24px;
      padding: 2.5rem 3rem;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 100px rgba(139, 92, 246, 0.1);
      z-index: 10001 !important;
      display: none;
      min-width: 450px;
      max-width: 550px;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #coach-entrepreneur-selector.visible {
      display: block !important;
    }

    /* ============================================
       COACH SELECTOR - HEADER STATE (after selection)
       ============================================ */
    #coach-entrepreneur-selector.in-header {
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      transform: translate(0, 0) scale(1);
      border-radius: 0;
      padding: 0.75rem 2rem;
      min-width: 100%;
      max-width: 100%;
      border: none;
      border-bottom: 2px solid var(--border-dark);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    #coach-entrepreneur-selector .selector-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      transition: all 0.4s ease;
    }

    #coach-entrepreneur-selector.in-header .selector-container {
      flex-direction: row;
      max-width: 1400px;
      gap: 1rem;
    }

    /* Titre centr√© */
    #coach-entrepreneur-selector .selector-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-light);
      text-align: center;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      opacity: 1;
      transition: all 0.4s ease;
    }

    #coach-entrepreneur-selector .selector-title i {
      color: var(--primary-blue);
    }

    #coach-entrepreneur-selector.in-header .selector-title {
      display: none;
    }

    /* Sous-titre */
    #coach-entrepreneur-selector .selector-subtitle {
      font-size: 0.9rem;
      color: var(--text-gray);
      text-align: center;
      margin-bottom: 1rem;
      opacity: 1;
      transition: all 0.4s ease;
    }

    #coach-entrepreneur-selector.in-header .selector-subtitle {
      display: none;
    }

    /* Cacher l'identit√© de page quand en mode header */
    #coach-entrepreneur-selector.in-header .page-identity {
      display: none;
    }

    /* Retirer la ligne de s√©paration du s√©lecteur */
    #coach-entrepreneur-selector {
      border-bottom: none !important;
    }

    #coach-entrepreneur-selector .selector-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-light);
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      opacity: 0;
      transition: all 0.4s ease;
    }

    #coach-entrepreneur-selector.in-header .selector-label {
      opacity: 1;
    }

    #coach-entrepreneur-selector .selector-label i {
      color: var(--primary-blue);
      font-size: 18px;
    }

    /* ============================================
       OVERLAY BACKDROP
       ============================================ */
    #coach-selector-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }

    #coach-selector-backdrop.visible {
      opacity: 1;
      pointer-events: all;
    }

    body.coach-mode.has-selection #coach-selector-backdrop {
      opacity: 0;
      pointer-events: none;
    }

    /* ============================================
       DROPDOWN - Mode centr√© (par d√©faut)
       ============================================ */
    .coach-dropdown {
      position: relative;
      width: 100%;
      max-width: 400px;
      transition: all 0.4s ease;
    }

    #coach-entrepreneur-selector.in-header .coach-dropdown {
      flex: 1;
      max-width: 450px;
    }

    .coach-dropdown-toggle {
      background: rgba(23, 32, 51, 0.8);
      border: 2px solid var(--border-dark);
      border-radius: 16px;
      padding: 14px 20px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text-light);
      font-size: 15px;
      gap: 0.5rem;
    }

    #coach-entrepreneur-selector.in-header .coach-dropdown-toggle {
      height: 44px;
      padding: 10px 16px;
      border-radius: 12px;
      font-size: 14px;
    }

    #coach-entrepreneur-selector.in-header .coach-dropdown-toggle:hover {
      border-color: var(--primary-blue);
      background: rgba(23, 32, 51, 1);
    }

    #coach-entrepreneur-selector.in-header .coach-dropdown-toggle.active {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
    }

    .coach-dropdown-toggle:hover {
      border-color: var(--primary-blue);
      background: rgba(23, 32, 51, 1);
    }

    .coach-dropdown-toggle.active {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
    }

    .coach-dropdown-toggle .placeholder {
      color: var(--text-gray);
      flex: 1;
    }

    .coach-dropdown-toggle .selected-text {
      color: var(--text-light);
      font-weight: 500;
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .coach-dropdown-toggle .selected-text i {
      color: var(--primary-green);
    }

    .coach-dropdown-toggle .chevron {
      color: var(--text-gray);
      transition: transform 0.3s ease;
      font-size: 12px;
    }

    .coach-dropdown-toggle.active .chevron {
      transform: rotate(180deg);
    }

    .coach-dropdown-menu {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      right: 0;
      background: var(--bg-card);
      border: 2px solid var(--border-dark);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      z-index: 10000;
      max-height: 320px;
      overflow-y: auto;
      opacity: 0;
      transform: translateY(-10px);
      pointer-events: none;
      transition: all 0.3s ease;
    }

    .coach-dropdown-menu.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }

    .coach-dropdown-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      color: var(--text-light);
      border-bottom: 1px solid rgba(71, 85, 105, 0.2);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .coach-dropdown-option:hover {
      background: rgba(59, 130, 246, 0.15);
    }

    .coach-dropdown-option:last-child {
      border-bottom: none;
    }

    .coach-dropdown-option i {
      color: var(--primary-green);
      font-size: 16px;
    }

    .coach-dropdown-option-disabled {
      padding: 12px 16px;
      color: var(--text-gray);
      font-style: italic;
      cursor: default;
      text-align: center;
    }

    /* ============================================
       BODY STATES FOR COACH MODE
       ============================================ */
    body.coach-mode {
      padding-top: 0 !important;
    }

    /* ============================================
       MAIN CONTENT - Hidden until selection
       ============================================ */
    body.coach-mode .main-content {
      opacity: 0;
      transform: translateY(30px);
      pointer-events: none;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body.coach-mode.has-selection .main-content {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }

    /* D√©caler les modals de 10px vers le bas pour √©viter la barre coach */
    body.coach-mode.has-selection #clientInfoModal,
    body.coach-mode.has-selection #pdfViewerModal,
    body.coach-mode.has-selection #clientsPerdusModal,
    body.coach-mode.has-selection #clients-perdus-modal,
    body.coach-mode.has-selection #mapsModal,
    body.coach-mode.has-selection #confirmMarquerPerduModal,
    body.coach-mode.has-selection #confirmDeletePerduModal,
    body.coach-mode.has-selection #confirmRecupererModal {
      padding-top: 10px !important;
    }

    /* Pour mobile overlay et autres √©l√©ments directs du body */
    body.coach-mode > .mobile-overlay,
    body.coach-mode > div:not(#coach-entrepreneur-selector):not(.mobile-overlay) {
      margin-top: 0 !important;
    }

    /* Scrollbar personnalis√©e pour le dropdown */
    .coach-dropdown-menu::-webkit-scrollbar {
      width: 8px;
    }

    .coach-dropdown-menu::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 10px;
    }

    .coach-dropdown-menu::-webkit-scrollbar-thumb {
      background: var(--primary-blue);
      border-radius: 10px;
    }

    .coach-dropdown-menu::-webkit-scrollbar-thumb:hover {
      background: #60a5fa;
    }

    /* Forcer les colonnes du tbody √† respecter les largeurs du thead */
    .modern-table {
      table-layout: fixed !important;
      width: 100% !important;
    }

    .modern-table tbody tr td:nth-child(1) { width: 20%; }
    .modern-table tbody tr td:nth-child(2) { width: 15%; }
    .modern-table tbody tr td:nth-child(3) { width: 35%; }
    .modern-table tbody tr td:nth-child(4) { width: 15%; }
    .modern-table tbody tr td:nth-child(5) { width: 15%; }

    .modern-table td {
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Scroll dans les tbody comme dans employ√©s */
    .modern-table tbody {
      display: block;
      overflow-y: visible;
    }

    .modern-table thead,
    .modern-table tbody tr {
      display: table;
      width: 100%;
      table-layout: fixed;
    }

    /* Scrollbar personnalis√©e pour tbody */
    .modern-table tbody::-webkit-scrollbar {
      width: 3px;
    }

    .modern-table tbody::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .modern-table tbody::-webkit-scrollbar-thumb {
      background: var(--primary-blue);
      border-radius: 10px;
    }

    .modern-table tbody::-webkit-scrollbar-thumb:hover {
      background: #60a5fa;
    }

    /* Animation de succ√®s */
    .success-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }

    .success-content {
      text-align: center;
      color: white;
      animation: scaleIn 0.5s ease;
    }

    .success-checkmark {
      width: 80px;
      height: 80px;
      margin: 0 auto 1.5rem;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 0 30px rgba(16, 185, 129, 0.5);
      animation: checkmarkPop 0.6s ease;
    }

    .success-checkmark svg {
      animation: drawCheck 0.5s ease 0.3s forwards;
      stroke-dasharray: 50;
      stroke-dashoffset: 50;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes checkmarkPop {
      0% {
        transform: scale(0);
      }
      50% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
      }
    }

    @keyframes drawCheck {
      to {
        stroke-dashoffset: 0;
      }
    }

    /* ========================================
       CHECKBOX STYLES - S√©lection multiple
       ======================================== */
    .checkbox-column {
      width: 3% !important;
      text-align: center !important;
      vertical-align: middle !important;
      padding: 1rem !important;
    }

    .checkbox-column .prospect-checkbox,
    .checkbox-column .vente-checkbox {
      margin: 0 auto;
      display: block !important;
    }

    .prospect-checkbox,
    .vente-checkbox {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      width: 20px;
      height: 20px;
      min-width: 20px;
      min-height: 20px;
      border: 2px solid rgba(96, 165, 250, 0.6);
      border-radius: 4px;
      background: rgba(30, 41, 59, 0.8);
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
      display: inline-block !important;
      vertical-align: middle;
    }

    .prospect-checkbox:hover,
    .vente-checkbox:hover {
      border-color: rgba(96, 165, 250, 0.6);
      background: rgba(96, 165, 250, 0.05);
    }

    .prospect-checkbox:checked,
    .vente-checkbox:checked {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #3b82f6;
    }

    .prospect-checkbox:checked::after,
    .vente-checkbox:checked::after {
      content: '\f00c';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 10px;
    }

    .prospect-checkbox:indeterminate,
    .vente-checkbox:indeterminate {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      border-color: #8b5cf6;
    }

    .prospect-checkbox:indeterminate::after,
    .vente-checkbox:indeterminate::after {
      content: '\f068';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 10px;
    }

    /* Floating action bar pour s√©lection multiple */
    #floating-action-bar {
      display: none;
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(59, 130, 246, 0.5);
      border-radius: 12px;
      padding: 1rem 1.5rem;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(59, 130, 246, 0.2);
      z-index: 100;
      min-width: 320px;
    }

    #floating-action-bar.visible {
      display: flex;
    }

    /* ========================================
       RESPONSIVE TABLET (iPad) - Cacher Notes + Totaux √† droite
       ======================================== */
    @media (max-width: 1024px) {
      /* Forcer les totaux √† rester √† droite dans les headers sur tablette */
      .box-header {
        display: flex !important;
        flex-wrap: nowrap !important;
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
      }
      .box-header > div:first-child {
        flex: 1 !important;
        min-width: 0 !important;
      }
      #total-attente, #total-accepte, #total-produit {
        flex-shrink: 0 !important;
        margin-left: 1rem !important;
      }

      /* Tablette: garder Checkbox, Nom, T√©l√©phone, Adresse, Prix, Paiement */
      /* Cacher: REP, Provenance, Type travaux, Notes, √âtiquette/Status */
      .modern-table td[data-label="REP"],
      .modern-table td[data-label="Provenance"],
      .modern-table td[data-label="Type travaux"],
      .modern-table td[data-label="Notes"],
      .modern-table td[data-label="√âtiquette"],
      .col-hide-tablet {
        display: none !important;
      }

      /* Override centraleadmin.css - bouton pas full width */
      #add-prospect-btn {
        width: auto !important;
      }
    }

    /* ========================================
       RESPONSIVE MOBILE - Affichage en cartes
       ======================================== */
    @media (max-width: 600px) {
      /* Forcer les totaux √† rester √† droite dans les headers sur mobile */
      .box-header {
        flex-wrap: nowrap !important;
      }
      .box-header > div:first-child {
        flex: 1 !important;
        min-width: 0 !important;
      }
      .box-header > div:first-child h2 {
        font-size: 0.9rem !important;
        white-space: nowrap !important;
      }
      #total-attente, #total-accepte, #total-produit {
        flex-shrink: 0 !important;
        padding: 0.35rem 0.6rem !important;
        font-size: 0.85rem !important;
      }
      #total-attente span, #total-accepte span, #total-produit span {
        font-size: 0.85rem !important;
      }

      /* Cacher les checkboxes et barre d'action sur mobile */
      .prospect-checkbox,
      .vente-checkbox,
      .select-all-ventes,
      #select-all-prospects,
      #floating-action-bar,
      .checkbox-column,
      td[data-label="Select"],
      .modern-table .checkbox-column,
      .modern-table td:first-child:has(.vente-checkbox),
      .modern-table td:first-child:has(.prospect-checkbox),
      tr td.checkbox-column {
        display: none !important;
        width: 0 !important;
        min-width: 0 !important;
        max-width: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
        flex: 0 0 0 !important;
        overflow: hidden !important;
      }

      /* Clients potentiels - bouton en bas sur mobile */
      .box:first-child .box-header {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 0.75rem !important;
      }
      .box:first-child .box-header > div:first-child {
        justify-content: flex-start !important;
      }
      #add-prospect-btn {
        width: auto !important;
        align-self: flex-start !important;
      }

      /* Masquer le thead sur mobile */
      .modern-table thead {
        display: none !important;
      }

      /* Retirer les contraintes de table */
      .modern-table {
        display: block !important;
        width: 100% !important;
        table-layout: auto !important;
      }

      .modern-table tbody {
        display: block !important;
        width: 100% !important;
      }

      .modern-table tbody tr td {
        display: block !important;
      }

      /* Clients perdus container - bg et border sur mobile */
      .perdus-table-container {
        background: #0f172a;
        border: 2px solid var(--border-dark);
      }

      /* Cacher TOUT sauf Nom et Prix sur mobile - aucune place */
      .modern-table td[data-label="REP"],
      .modern-table td[data-label="Provenance"],
      .modern-table td[data-label="Type travaux"],
      .modern-table td[data-label="Notes"],
      .modern-table td[data-label="T√©l√©phone"],
      .modern-table td[data-label="Adresse"],
      .modern-table td[data-label="Actions"],
      .modern-table td[data-label="Paiement"],
      .modern-table td[data-label="√âtiquette"] {
        display: none !important;
        width: 0 !important;
        min-width: 0 !important;
        max-width: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
        flex: 0 0 0 !important;
        overflow: hidden !important;
      }

      /* Cacher toutes les √©tiquettes/badges sur mobile */
      .modern-table .statut-vente-badge,
      .modern-table .provenance-badge,
      .modern-table .type-travaux-badge,
      .modern-table .paiement-badge,
      .modern-table .etiquette-badge {
        display: none !important;
      }

      /* Afficher la colonne Prix mobile */
      .modern-table td.mobile-only-prix {
        display: block !important;
      }

      /* Style carte mobile pour les lignes */
      .modern-table tbody tr {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        align-items: center !important;
        padding: 1rem !important;
        margin-bottom: 0.5rem !important;
        background: rgba(30, 41, 59, 0.5) !important;
        border-radius: 8px !important;
        border: 1px solid var(--border-dark) !important;
        overflow: hidden !important;
      }

      /* Nom √† gauche - une seule ligne */
      .modern-table tbody tr td[data-label="Nom"],
      #potentiel-tbody tr td[data-label="Nom"],
      #attente-tbody tr td[data-label="Nom"],
      #accepte-tbody tr td[data-label="Nom"],
      #produit-tbody tr td[data-label="Nom"] {
        display: inline-block !important;
        flex: 1 1 auto !important;
        width: auto !important;
        max-width: calc(100% - 100px) !important;
        font-weight: 600 !important;
        font-size: 1rem !important;
        padding: 0 !important;
        padding-right: 10px !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        line-height: 1.4 !important;
      }

      /* Prix √† droite - forcer affichage */
      .modern-table tbody tr td[data-label="Prix"],
      .modern-table tbody tr td.mobile-only-prix {
        display: block !important;
        flex: 0 0 auto !important;
        width: auto !important;
        text-align: right !important;
        font-weight: 600 !important;
        color: #ffffff !important;
        padding: 0 !important;
        white-space: nowrap !important;
      }
    }

    /* Loading spinner pour badges */
    .badge-loading {
      position: relative;
      pointer-events: none;
      color: transparent !important; /* Cache le texte */
      opacity: 0.3; /* Tr√®s transparent pour voir la forme mais pas le contenu */
    }

    .badge-loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: badge-spin 0.6s linear infinite;
      z-index: 10; /* Spinner au-dessus */
    }

    @keyframes badge-spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Loading spinner pour ic√¥ne de notes */
    .note-icon-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.2; /* Tr√®s transparent */
    }

    .note-icon-loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 18px;
      height: 18px;
      border: 2px solid rgba(96, 165, 250, 0.3);
      border-top-color: var(--primary-blue);
      border-radius: 50%;
      animation: badge-spin 0.6s linear infinite;
      z-index: 10; /* Spinner au-dessus */
    }
  </style>
  <link rel="stylesheet" href="/entrepreneur-selector.css">
</head>
<body class="min-h-screen" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: var(--text-light); overflow-x: hidden; margin: 0; padding: 0;">

  <!-- Mobile overlay for sidebar -->
  <div class="mobile-overlay" onclick="closeMobileMenu()"></div>

  <!-- Backdrop pour le s√©lecteur coach (√©tat centr√©) -->
  <div id="coach-selector-backdrop"></div>

  <!-- S√©lecteur d'entrepreneur (visible uniquement pour les coaches) -->
  <div id="coach-entrepreneur-selector">
    <!-- Titre de la page avec ic√¥ne Ventes -->
    <div class="page-identity">
      <div class="page-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3), 0 0 40px rgba(139, 92, 246, 0.15);">
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="page-name" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 50%, #a78bfa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Ventes</div>
    </div>

    <!-- Titre et sous-titre (visibles uniquement en mode centr√©) -->
    <div class="selector-title">
      <i class="fas fa-user-tie"></i>
      S√©lectionnez un entrepreneur
    </div>
    <div class="selector-subtitle">Choisissez l'entrepreneur dont vous souhaitez consulter les ventes</div>

    <div class="selector-container">
      <div class="selector-label" style="display: none;">
        <i class="fas fa-user-tie"></i>
        <span>Entrepreneur:</span>
      </div>
      <div class="coach-dropdown">
        <div class="coach-dropdown-toggle" id="coach-dropdown-toggle">
          <input type="text"
                 class="search-input"
                 id="search-input"
                 placeholder="Rechercher..."
                 autocomplete="off"
                 style="display: none;">
          <span class="placeholder">-- S√©lectionner un entrepreneur --</span>
          <i class="fas fa-chevron-down chevron"></i>
        </div>
        <div class="coach-dropdown-menu" id="coach-dropdown-menu">
          <!-- Options charg√©es dynamiquement -->
        </div>
      </div>
    </div>
  </div>

  <!-- Section en d√©veloppement (CACH√âE) -->
  <div class="main-content w-full hidden" style="width: 100%; padding: 2rem;">
    <div class="flex items-center justify-center" style="min-height: 60vh;">
      <div class="status-card p-12 text-center max-w-2xl" style="--card-color: var(--primary-blue); background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(51, 65, 85, 0.95) 100%);">
        <div class="mb-6">
          <i class="fas fa-tools text-6xl mb-4" style="color: var(--primary-blue);"></i>
        </div>
        <h2 class="text-3xl font-bold mb-4" style="color: var(--text-light);">
          Section Ventes en D√©veloppement
        </h2>
        <p class="text-lg mb-6" style="color: var(--text-gray);">
          Cette fonctionnalit√© est actuellement en cours de d√©veloppement et sera bient√¥t disponible.
        </p>
        <div class="inline-flex items-center px-6 py-3 rounded-full text-sm font-medium" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);">
          <i class="fas fa-clock mr-2"></i>
          Disponible prochainement
        </div>
      </div>
    </div>
  </div>

  <!-- Contenu principal (VISIBLE) -->
  <div class="main-content w-full" style="width: 100%; padding: 2rem;">
    <div class="md:hidden h-4"></div>
    <div class="w-full">
    
      <!-- Header -->
      <div class="mb-10 mt-5 md:mt-0">
        <div class="relative">
          <h1 class="text-4xl font-bold mb-3">
            Gestion des Ventes
          </h1>
          <span class="absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-blue-600 to-blue-400 rounded-full"></span>
          <div class="flex items-center justify-between">
            <p class="text-xl font-medium" style="color: var(--text-gray);">
              <span class="hide-mobile">G√©rez vos clients et suivez l'√©tat de vos projets</span>
              <span class="show-mobile">G√©rez vos clients</span>
            </p>
            <button onclick="ouvrirModalClientsPerdus()" class="px-4 py-2 rounded-lg flex items-center gap-2 transition-all font-medium" style="background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3);" onmouseover="this.style.background='rgba(239, 68, 68, 0.25)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.15)'">
              <i class="fas fa-user-times"></i>
              <span>Clients perdus</span>
            </button>
          </div>
        </div>
      </div>

    <!-- Sections Container -->
    <div id="sections-container" style="display: flex; flex-direction: column; gap: 2rem;">

      <!-- Section 1: Clients potentiels -->
      <div class="box">
        <div class="box-header">
          <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
            <div class="box-header-icon" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);">
              <i class="fas fa-user-plus"></i>
            </div>
            <h2 class="box-header-title" style="margin: 0;">Clients potentiels</h2>
          </div>
          <button id="add-prospect-btn" onclick="ouvrirModalProspect()" class="btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-plus"></i>
            <span>Ajouter un client potentiel</span>
          </button>
        </div>
        <div class="box-body">
          <!-- Champ de recherche -->
          <div class="mb-4">
            <div class="relative">
              <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2" style="color: var(--text-gray);"></i>
              <input type="text" id="searchPotentiel" placeholder="Rechercher par nom, t√©l√©phone, adresse, prix..." class="w-full pl-10 pr-4 py-2 rounded-lg" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark); color: var(--text-light);">
            </div>
          </div>
          <div class="table-container">
            <table class="modern-table" style="table-layout: fixed; width: 100%;">
              <thead>
                <tr>
                  <th style="width: 3%; padding: 1rem; text-align: center;">
                    <input type="checkbox" id="select-all-prospects" onchange="toggleSelectAllProspects(this)" class="prospect-checkbox">
                  </th>
                  <th style="width: 11%; padding: 1rem; text-align: left;">Nom</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">REP</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">Provenance</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">Type travaux</th>
                  <th style="width: 10%; padding: 1rem; text-align: left;">T√©l√©phone</th>
                  <th class="col-adresse" style="width: 17%; padding: 1rem; text-align: left;">Adresse</th>
                  <th style="width: 8%; padding: 1rem; text-align: left;">Prix</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">Status</th>
                  <th class="col-hide-tablet" style="width: 5%; padding: 1rem; text-align: left;">Notes</th>
                  <th style="width: 11%; padding: 1rem; text-align: left;">Paiement</th>
                </tr>
              </thead>
              <tbody id="potentiel-tbody">
                <tr class="loading-row">
                  <td colspan="11" class="empty-state">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem; color: var(--primary-blue); display: block;"></i>
                    <p style="font-size: 1rem; color: var(--text-gray);">Chargement des clients potentiels...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Section 2: En attente -->
      <div class="box">
        <div class="box-header" style="display: flex !important; flex-wrap: nowrap !important; justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 0;">
            <div class="box-header-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
              <i class="fas fa-clock"></i>
            </div>
            <h2 class="box-header-title" style="margin: 0;">En attente</h2>
          </div>
          <div id="total-attente" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; flex-shrink: 0; margin-left: 1rem;">
            <span style="color: var(--text-gray); font-size: 1rem; font-weight: 600;">Total:</span>
            <span style="color: #f59e0b; font-weight: 700; font-size: 1rem;">0 $</span>
          </div>
        </div>
        <div class="box-body">
          <!-- Champ de recherche -->
          <div class="mb-4">
            <div class="relative">
              <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2" style="color: var(--text-gray);"></i>
              <input type="text" id="searchAttente" placeholder="Rechercher par nom, t√©l√©phone, adresse, prix..." class="w-full pl-10 pr-4 py-2 rounded-lg" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark); color: var(--text-light);">
            </div>
          </div>
          <div class="table-container">
            <table class="modern-table" style="table-layout: fixed; width: 100%;">
              <thead>
                <tr>
                  <th style="width: 3%; padding: 1rem; text-align: center;">
                    <input type="checkbox" class="select-all-ventes prospect-checkbox" data-category="attente" onchange="toggleSelectAllVentes(this, 'attente')">
                  </th>
                  <th style="width: 11%; padding: 1rem; text-align: left;">Nom</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">REP</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">Provenance</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">Type travaux</th>
                  <th style="width: 10%; padding: 1rem; text-align: left;">T√©l√©phone</th>
                  <th class="col-adresse" style="width: 17%; padding: 1rem; text-align: left;">Adresse</th>
                  <th style="width: 8%; padding: 1rem; text-align: left;">Prix</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">Status</th>
                  <th class="col-hide-tablet" style="width: 5%; padding: 1rem; text-align: left;">Notes</th>
                  <th style="width: 11%; padding: 1rem; text-align: left;">Paiement</th>
                </tr>
              </thead>
              <tbody id="attente-tbody">
                <tr>
                  <td colspan="10" class="empty-state">
                    <i class="fas fa-clock" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
                    <p style="font-size: 1rem;">Aucun client en attente</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Section 3: Accept√©s -->
      <div class="box">
        <div class="box-header" style="display: flex !important; flex-wrap: nowrap !important; justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 0;">
            <div class="box-header-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
              <i class="fas fa-check"></i>
            </div>
            <h2 class="box-header-title" style="margin: 0;">Accept√©s</h2>
          </div>
          <div id="total-accepte" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; flex-shrink: 0; margin-left: 1rem;">
            <span style="color: var(--text-gray); font-size: 1rem; font-weight: 600;">Total:</span>
            <span style="color: #10b981; font-weight: 700; font-size: 1rem;">0 $</span>
          </div>
        </div>
        <div class="box-body">
          <!-- Champ de recherche -->
          <div class="mb-4">
            <div class="relative">
              <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2" style="color: var(--text-gray);"></i>
              <input type="text" id="searchAccepte" placeholder="Rechercher par nom, t√©l√©phone, adresse, prix..." class="w-full pl-10 pr-4 py-2 rounded-lg" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark); color: var(--text-light);">
            </div>
          </div>
          <div class="table-container">
            <table class="modern-table" style="table-layout: fixed; width: 100%;">
              <thead>
                <tr>
                  <th class="checkbox-column" style="width: 3%; padding: 1rem; text-align: center;">
                    <input type="checkbox" class="select-all-ventes prospect-checkbox" data-category="accepte" onchange="toggleSelectAllVentes(this, 'accepte')">
                  </th>
                  <th style="width: 10%; padding: 1rem; text-align: left;">Nom</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">REP</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">Provenance</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">Type travaux</th>
                  <th style="width: 10%; padding: 1rem; text-align: left;">T√©l√©phone</th>
                  <th class="col-adresse" style="width: 16%; padding: 1rem; text-align: left;">Adresse</th>
                  <th style="width: 9%; padding: 1rem; text-align: left;">Prix</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">Status</th>
                  <th class="col-hide-tablet" style="width: 5%; padding: 1rem; text-align: left;">Notes</th>
                  <th style="width: 12%; padding: 1rem; text-align: left;">Paiement</th>
                </tr>
              </thead>
              <tbody id="accepte-tbody">
                <tr>
                  <td colspan="11" class="empty-state">
                    <i class="fas fa-check-circle" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
                    <p style="font-size: 1rem;">Aucun client accept√©</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Section 4: Produits -->
      <div class="box">
        <div class="box-header" style="display: flex !important; flex-wrap: nowrap !important; justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 0;">
            <div class="box-header-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
              <i class="fas fa-box"></i>
            </div>
            <h2 class="box-header-title" style="margin: 0;">Produits</h2>
          </div>
          <div id="total-produit" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; flex-shrink: 0; margin-left: 1rem;">
            <span style="color: var(--text-gray); font-size: 1rem; font-weight: 600;">Total:</span>
            <span style="color: #8b5cf6; font-weight: 700; font-size: 1rem;">0 $</span>
          </div>
        </div>
        <div class="box-body">
          <!-- Champ de recherche -->
          <div class="mb-4">
            <div class="relative">
              <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2" style="color: var(--text-gray);"></i>
              <input type="text" id="searchProduit" placeholder="Rechercher par nom, t√©l√©phone, adresse, prix..." class="w-full pl-10 pr-4 py-2 rounded-lg" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark); color: var(--text-light);">
            </div>
          </div>
          <div class="table-container">
            <table class="modern-table" style="table-layout: fixed; width: 100%;">
              <thead>
                <tr>
                  <th class="checkbox-column" style="width: 3%; padding: 1rem; text-align: center;">
                    <input type="checkbox" class="select-all-ventes prospect-checkbox" data-category="produit" onchange="toggleSelectAllVentes(this, 'produit')">
                  </th>
                  <th style="width: 10%; padding: 1rem; text-align: left;">Nom</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">REP</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">Provenance</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">Type travaux</th>
                  <th style="width: 10%; padding: 1rem; text-align: left;">T√©l√©phone</th>
                  <th class="col-adresse" style="width: 16%; padding: 1rem; text-align: left;">Adresse</th>
                  <th style="width: 9%; padding: 1rem; text-align: left;">Prix</th>
                  <th class="col-hide-tablet" style="width: 8%; padding: 1rem; text-align: left;">Status</th>
                  <th class="col-hide-tablet" style="width: 5%; padding: 1rem; text-align: left;">Notes</th>
                  <th style="width: 12%; padding: 1rem; text-align: left;">Paiement</th>
                </tr>
              </thead>
              <tbody id="produit-tbody">
                <tr>
                  <td colspan="11" class="empty-state">
                    <i class="fas fa-box" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
                    <p style="font-size: 1rem;">Aucun client produit</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>

    </div>
  </div>

  <!-- Modal informations client -->
  <div id="clientInfoModal" class="fixed inset-0 flex items-center justify-center" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; z-index: 80;">
    <div id="clientInfoCard" class="status-card p-6 w-full" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i id="clientInfoIcon" class="fas fa-user mr-2" style="color: var(--primary-blue);"></i>
          Informations client
        </h3>
        <button id="clientInfoCloseBtn" onclick="closeClientInfo()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);" onmouseover="this.style.background='rgba(96, 165, 250, 0.3)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="clientInfoContent" class="space-y-4">
        <!-- Le contenu sera ins√©r√© ici par JavaScript -->
      </div>
    </div>
  </div>

  <!-- Modal confirmation cl√¥ture -->
  <div id="confirmationModal" class="flex" style="display:none;">
    <div class="modal-content">
      <p class="text-lg font-semibold">Confirmer que le projet est termin√© ?</p>
      <div class="modal-buttons">
        <button id="modalConfirm" type="button" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-800">Oui</button>
        <button id="modalCancel" type="button" class="px-4 py-2 bg-white text-gray-600 border border-gray-300 rounded hover:bg-gray-50">Non</button>
      </div>
    </div>
  </div>

  <!-- Modal confirmation retour -->
  <div id="retourModal" class="flex" style="display:none;">
    <div class="modal-content">
      <p class="text-lg font-semibold">√ätes-vous s√ªr de retourner en arri√®re ?</p>
      <p class="text-sm text-gray-600 mt-2">Le courriel d'avis a d√©j√† √©t√© envoy√© au client.</p>
      <div class="modal-buttons">
        <button id="retourConfirm" type="button" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-800">Oui</button>
        <button id="retourCancel" type="button" class="px-4 py-2 bg-white text-gray-600 border border-gray-300 rounded hover:bg-gray-50">Non</button>
      </div>
    </div>
  </div>

  <!-- Modal Ajouter un prospect -->
  <div id="ajouterProspectModal" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none;">
    <div class="status-card p-6 max-w-md w-full" style="max-height: 90vh; overflow-y: auto;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user-plus mr-2" style="color: var(--primary-blue);"></i>
          Ajouter un client potentiel
        </h3>
        <button onclick="fermerModalProspect()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);" onmouseover="this.style.background='rgba(96, 165, 250, 0.3)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form id="prospectForm" class="space-y-4" autocomplete="off">
        <!-- Pr√©nom -->
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Pr√©nom *</label>
          <input type="text" id="prospectPrenom" name="prospect-first-name" required autocomplete="new-password" autocapitalize="off" spellcheck="false" readonly onfocus="this.removeAttribute('readonly');"
                 class="w-full p-2 text-sm rounded-lg" 
                 style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);"
                 placeholder="Ex: Jean">
        </div>
        
        <!-- Nom -->
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Nom *</label>
          <input type="text" id="prospectNom" name="prospect-last-name" required autocomplete="new-password" autocapitalize="off" spellcheck="false" readonly onfocus="this.removeAttribute('readonly');"
                 class="w-full p-2 text-sm rounded-lg" 
                 style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);"
                 placeholder="Ex: Dupont">
        </div>
        
        <!-- T√©l√©phone -->
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">T√©l√©phone *</label>
          <input type="tel" id="prospectTelephone" name="telephone" required autocomplete="off" autocapitalize="off" spellcheck="false"
                 class="w-full p-2 text-sm rounded-lg"
                 style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);"
                 placeholder="Ex: 450-123-4567" maxlength="12">
        </div>
        
        <!-- Adresse -->
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--text-light);">Adresse *</label>
          <input type="text" id="prospectAdresse" name="prospect-address-field-unique-12345" required autocomplete="new-password" autocapitalize="off" spellcheck="false" readonly onfocus="this.removeAttribute('readonly');" data-form-type="other" placeholder="Ex: 123 Rue de la Paix, Montr√©al, QC"
                    class="w-full p-2 text-sm rounded-lg"
                    style="background: #0f172a; border: 2px solid var(--border-dark); color: var(--text-light);">
        </div>
        
        <!-- Boutons -->
        <div class="flex space-x-3 pt-4">
          <button type="button" onclick="fermerModalProspect()" 
                  class="btn-secondary px-4 py-2 rounded-lg relative overflow-hidden">
            Annuler
          </button>
          <button type="submit" 
                  class="btn-primary px-4 py-2 rounded-lg relative overflow-hidden">
            <span>Ajouter</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Google Maps -->
  <div id="mapsModal" class="fixed inset-0 flex items-center justify-center" style="background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: none; z-index: 90;" onclick="if(event.target === this) fermerMapsModal()">
    <div class="p-4 w-full mx-4 rounded-xl" style="background: #1e293b; border: 1px solid var(--border-dark); box-shadow: var(--shadow-dark-strong); max-width: 900px; max-height: 90vh;" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-map-marked-alt mr-2" style="color: var(--primary-blue);"></i>
          Localisation
        </h3>
        <button onclick="fermerMapsModal()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);" onmouseover="this.style.background='rgba(96, 165, 250, 0.3)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="mapsIframeContainer" style="width: 100%; height: 600px; border-radius: 8px; overflow: hidden;">
        <!-- L'iframe sera inject√©e ici -->
      </div>
    </div>
  </div>

  <!-- Modal confirmation Marquer comme perdu -->
  <div id="confirmPerduModal" class="fixed inset-0 flex items-center justify-center" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; z-index: 60;">
    <div class="p-6 max-w-md w-full mx-4 rounded-xl" style="background: #1e293b; border: 1px solid var(--border-dark); box-shadow: var(--shadow-dark-medium);">
      <div class="mb-6">
        <h3 class="text-xl font-bold mb-2" style="color: var(--text-light);">
          <i class="fas fa-exclamation-triangle mr-2" style="color: #ef4444;"></i>
          Confirmer la perte du client
        </h3>
        <p style="color: var(--text-gray);">√ätes-vous s√ªr de vouloir marquer ce client comme perdu ?</p>
      </div>

      <div class="flex space-x-3">
        <button onclick="confirmMarquerPerdu()" class="flex-1 px-4 py-2.5 rounded-lg font-semibold transition-all" style="background: #ef4444; color: white;">
          Oui
        </button>
        <button onclick="closeConfirmPerduModal()" class="flex-1 px-4 py-2.5 rounded-lg font-semibold transition-all" style="background: rgba(148, 163, 184, 0.2); color: var(--text-light);">
          Annuler
        </button>
      </div>
    </div>
  </div>

  <!-- Modal confirmation Production termin√©e -->
  <div id="confirmProductionModal" class="fixed inset-0 flex items-center justify-center" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; z-index: 60;">
    <div class="p-6 max-w-md w-full mx-4 rounded-xl" style="background: #1e293b; border: 1px solid var(--border-dark); box-shadow: var(--shadow-dark-medium);">
      <div class="mb-6">
        <h3 class="text-xl font-bold mb-2" style="color: var(--text-light);">
          <i class="fas fa-check-circle mr-2" style="color: #10b981;"></i>
          Confirmer la production termin√©e
        </h3>
        <p style="color: var(--text-gray);">√ätes-vous s√ªr que la production est termin√©e pour ce client ?</p>
      </div>

      <div class="flex space-x-3">
        <button onclick="confirmTerminerProduction()" class="flex-1 px-4 py-2.5 rounded-lg font-semibold transition-all" style="background: #10b981; color: white;">
          Oui
        </button>
        <button onclick="closeConfirmProductionModal()" class="flex-1 px-4 py-2.5 rounded-lg font-semibold transition-all" style="background: rgba(148, 163, 184, 0.2); color: var(--text-light);">
          Annuler
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Clients perdus -->
  <div id="clients-perdus-modal" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none;" onclick="if(event.target === this) closeClientsPerdusModal();">
    <div class="status-card p-6 max-w-3xl w-full" style="max-height: 90vh; overflow-y: auto;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user-times mr-2" style="color: #ef4444;"></i>
          Clients perdus
        </h3>
        <button onclick="closeClientsPerdusModal(); event.stopPropagation();" type="button" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; cursor: pointer; border: none;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Barre de recherche -->
      <div class="mb-4">
        <div class="relative">
          <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2" style="color: var(--text-gray);"></i>
          <input type="text" id="perdus-search" placeholder="Rechercher par nom, t√©l√©phone, adresse..."
            class="w-full pl-10 pr-4 py-2 rounded-lg"
            style="background: var(--bg-tertiary); border: 1px solid var(--border-dark); color: var(--text-light); padding-left: 2.5rem !important;"
            oninput="filtrerClientsPerdus(this.value)">
        </div>
      </div>

      <div class="table-container">
        <table class="modern-table" style="table-layout: fixed; width: 100%;">
          <thead>
            <tr>
              <th style="width: 20%; padding: 1rem;">Nom</th>
              <th style="width: 16%; padding: 1rem;">T√©l√©phone</th>
              <th style="width: 35%; padding: 1rem;">Adresse</th>
              <th style="width: 11%; padding: 1rem;">Prix</th>
              <th style="width: 18%; padding: 1rem; text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody id="perdus-modal-tbody">
            <tr>
              <td colspan="8" class="empty-state">
                <i class="fas fa-user-times" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
                <p style="font-size: 1rem;">Aucun client perdu</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal confirmation Annulation client accept√© -->
  <div id="confirmAnnulationModal" class="fixed inset-0 flex items-center justify-center" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; z-index: 60;">
    <div class="p-6 max-w-md w-full mx-4 rounded-xl" style="background: #1e293b; border: 1px solid var(--border-dark); box-shadow: var(--shadow-dark-medium);">
      <div class="mb-6">
        <h3 class="text-xl font-bold mb-2" style="color: var(--text-light);">
          <i class="fas fa-exclamation-triangle mr-2" style="color: #ef4444;"></i>
          Confirmer l'annulation
        </h3>
        <p style="color: var(--text-gray);">√ätes-vous s√ªr de vouloir annuler ce client ? Il sera d√©plac√© vers les clients perdus.</p>
      </div>

      <div class="flex space-x-3">
        <button onclick="confirmAnnulerClient()" class="flex-1 px-4 py-2.5 rounded-lg font-semibold transition-all" style="background: #ef4444; color: white;">
          Oui
        </button>
        <button onclick="closeConfirmAnnulationModal()" class="flex-1 px-4 py-2.5 rounded-lg font-semibold transition-all" style="background: rgba(148, 163, 184, 0.2); color: var(--text-light);">
          Non
        </button>
      </div>
    </div>
  </div>

  <!-- Modal confirmation suppression prospect -->
  <div id="confirmDeleteProspectModal" class="fixed inset-0 flex items-center justify-center" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; z-index: 60;">
    <div class="p-6 max-w-md w-full mx-4 rounded-xl" style="background: #1e293b; border: 1px solid var(--border-dark); box-shadow: var(--shadow-dark-medium);">
      <div class="mb-6">
        <h3 class="text-xl font-bold mb-2" style="color: var(--text-light);">
          <i class="fas fa-exclamation-triangle mr-2" style="color: #ef4444;"></i>
          Confirmer la suppression
        </h3>
        <p style="color: var(--text-gray);">√ätes-vous s√ªr de vouloir supprimer ce client potentiel ?</p>
      </div>

      <div class="flex space-x-3">
        <button onclick="confirmDeleteProspect()" class="flex-1 px-4 py-2.5 rounded-lg font-semibold transition-all" style="background: #ef4444; color: white;">
          Oui
        </button>
        <button onclick="closeConfirmDeleteProspectModal()" class="flex-1 px-4 py-2.5 rounded-lg font-semibold transition-all" style="background: rgba(148, 163, 184, 0.2); color: var(--text-light);">
          Annuler
        </button>
      </div>
    </div>
  </div>

  <!-- Modal confirmation marquer vente en attente comme perdue -->
  <div id="confirmMarquerPerduModal" class="fixed inset-0 flex items-center justify-center" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; z-index: 60;">
    <div class="p-6 max-w-md w-full mx-4 rounded-xl" style="background: #1e293b; border: 1px solid var(--border-dark); box-shadow: var(--shadow-dark-medium);">
      <div class="mb-6">
        <h3 class="text-xl font-bold mb-2" style="color: var(--text-light);">
          <i class="fas fa-exclamation-triangle mr-2" style="color: #ef4444;"></i>
          Marquer comme perdu
        </h3>
        <p id="confirmMarquerPerduText" style="color: var(--text-gray);"></p>
      </div>

      <div class="flex space-x-3">
        <button onclick="confirmMarquerPerdu()" class="flex-1 px-4 py-2.5 rounded-lg font-semibold transition-all" style="background: #ef4444; color: white;">
          Oui
        </button>
        <button onclick="closeConfirmMarquerPerduModal()" class="flex-1 px-4 py-2.5 rounded-lg font-semibold transition-all" style="background: rgba(148, 163, 184, 0.2); color: var(--text-light);">
          Annuler
        </button>
      </div>
    </div>
  </div>

  <!-- Modal confirmation suppression client perdu -->
  <div id="confirmDeletePerduModal" class="fixed inset-0 flex items-center justify-center" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; z-index: 90;">
    <div class="p-6 max-w-md w-full mx-4 rounded-xl" style="background: #1e293b; border: 1px solid var(--border-dark); box-shadow: var(--shadow-dark-medium);">
      <div class="mb-6">
        <h3 class="text-xl font-bold mb-2" style="color: var(--text-light);">
          <i class="fas fa-exclamation-triangle mr-2" style="color: #ef4444;"></i>
          Confirmer la suppression
        </h3>
        <p id="confirmDeletePerduText" style="color: var(--text-gray);"></p>
      </div>

      <div class="flex space-x-3">
        <button onclick="confirmDeleteClientPerdu()" class="flex-1 px-4 py-2.5 rounded-lg font-semibold transition-all" style="background: #ef4444; color: white;">
          Oui
        </button>
        <button onclick="closeConfirmDeletePerduModal()" class="flex-1 px-4 py-2.5 rounded-lg font-semibold transition-all" style="background: rgba(148, 163, 184, 0.2); color: var(--text-light);">
          Annuler
        </button>
      </div>
    </div>
  </div>

  <!-- Modal confirmation r√©cup√©ration client perdu -->
  <div id="confirmRecupererModal" class="fixed inset-0 flex items-center justify-center" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; z-index: 80;">
    <div class="p-6 max-w-md w-full mx-4 rounded-xl" style="background: #1e293b; border: 1px solid var(--border-dark); box-shadow: var(--shadow-dark-medium);">
      <div class="mb-6">
        <h3 class="text-xl font-bold mb-2" style="color: var(--text-light);">
          <i class="fas fa-undo mr-2" style="color: #10b981;"></i>
          R√©cup√©rer ce client ?
        </h3>
        <p id="confirmRecupererText" style="color: var(--text-gray);">Vous allez √™tre redirig√© vers la page soumission pour renvoyer une nouvelle soumission √† ce client.</p>
      </div>

      <div class="flex space-x-3">
        <button onclick="confirmRecupererClientPerdu()" class="flex-1 px-4 py-2.5 rounded-lg font-semibold transition-all" style="background: #10b981; color: white;">
          Oui
        </button>
        <button onclick="closeConfirmRecupererModal()" class="flex-1 px-4 py-2.5 rounded-lg font-semibold transition-all" style="background: rgba(148, 163, 184, 0.2); color: var(--text-light);">
          Annuler
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Clients Perdus -->
  <div id="clientsPerdusModal" class="fixed inset-0 flex items-center justify-center" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: none; z-index: 70;">
    <div class="flex flex-col p-6 mx-4" style="width: 95%; max-width: 1100px; max-height: 85vh; background: #1e293b; border: 1px solid var(--border-dark); border-radius: 12px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user-times mr-2" style="color: #ef4444;"></i>
          Clients perdus
        </h3>
        <button onclick="fermerModalClientsPerdus()" class="w-10 h-10 rounded-full flex items-center justify-center transition-colors" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="flex-1 overflow-auto rounded-lg perdus-table-container">
        <table class="w-full modern-table" style="table-layout: fixed; width: 100%;">
          <thead style="background: rgba(30, 41, 59, 0.5); position: sticky; top: 0; z-index: 10;">
            <tr style="border-bottom: 2px solid var(--border-dark);">
              <th class="px-4 py-3 text-left text-sm font-semibold" style="width: 20%; color: var(--text-gray);">Client</th>
              <th class="px-4 py-3 text-left text-sm font-semibold" style="width: 16%; color: var(--text-gray);">T√©l√©phone</th>
              <th class="px-4 py-3 text-left text-sm font-semibold" style="width: 35%; color: var(--text-gray);">Adresse</th>
              <th class="px-4 py-3 text-left text-sm font-semibold" style="width: 11%; color: var(--text-gray);">Prix</th>
              <th class="px-4 py-3 text-sm font-semibold" style="width: 18%; color: var(--text-gray); text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody id="clientsPerdusTableBody">
            <!-- Les clients perdus seront ajout√©s ici -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Les modals PDF/GQP sont cr√©√©s dynamiquement via JavaScript -->

<script>
  // ‚ö° D√âSACTIVATION DES LOGS - Performance optimization
  window.log = window.log || (() => {});
  window.warn = window.warn || (() => {});
  window.error = window.error || (() => {});
  window.info = window.info || (() => {});
  window.debug = window.debug || (() => {});

  // Attendre que common.js soit initialis√© au lieu de rediriger
  function checkUsername() {
    if (!window.username) {
      // R√©essayer dans 100ms si common.js n'est pas encore pr√™t
      setTimeout(checkUsername, 100);
      return;
    }
    // Username disponible, continuer avec l'initialisation de la page
    log('Username disponible:', window.username);
  }
  
  // Lancer la v√©rification avec un d√©lai initial
  setTimeout(checkUsername, 200);

  function formaterPrix(valeur) {
    if (!valeur) return "-";
    let nombre = Number(valeur.toString().replace(/\s/g, '').replace(',', '.'));
    if (isNaN(nombre)) return valeur;
    return nombre.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " $";
  }

  window.addEventListener("load", () => {
    // Dropdown compte g√©r√© par l'event listener DOMContentLoaded plus bas
    
    if (window.username && window.usernameDisplay) {
      window.usernameDisplay.textContent = "Compte: " + window.username;
    }

    // Variables pour g√©rer l'ID du travail √† cl√¥turer
    let eventIdToClose = null;

    // Code legacy supprim√© - nous utilisons maintenant le syst√®me de cartes
    // Recherches supprim√©es - syst√®me de cartes utilis√© maintenant
  });

  // Anciennes fonctions supprim√©es - utiliser les nouvelles √† partir de la ligne 1829

  // ============================================
  // MODAL PROSPECT FUNCTIONS
  // ============================================
  function ouvrirModalProspect() {
    const modal = document.getElementById('ajouterProspectModal');
    if (modal) {
      // Bloquer le scroll en arri√®re-plan
      document.body.style.overflow = 'hidden';

      modal.style.display = 'flex';
      log('[VENTES] Modal prospect ouvert');
    }
  }

  function fermerModalProspect() {
    const modal = document.getElementById('ajouterProspectModal');
    if (modal) {
      modal.style.display = 'none';

      // R√©activer le scroll
      document.body.style.overflow = '';

      // Reset form
      const form = document.getElementById('prospectForm');
      if (form) form.reset();
      log('[VENTES] Modal prospect ferm√©');
    }
  }

  // Fonctions pour le modal Google Maps
  function ouvrirMapsModal(adresse) {
    const modal = document.getElementById('mapsModal');
    const container = document.getElementById('mapsIframeContainer');

    if (modal && container) {
      // Bloquer le scroll en arri√®re-plan
      document.body.style.overflow = 'hidden';

      // Cr√©er l'URL Google Maps embed
      const mapsEmbedUrl = `https://www.google.com/maps?q=${encodeURIComponent(adresse)}&output=embed`;

      // Injecter l'iframe
      container.innerHTML = `
        <iframe
          src="${mapsEmbedUrl}"
          width="100%"
          height="100%"
          style="border:0; border-radius: 8px;"
          allowfullscreen=""
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade">
        </iframe>
      `;

      modal.style.display = 'flex';
      log('[VENTES] Modal Maps ouvert pour:', adresse);
    }
  }

  function fermerMapsModal() {
    const modal = document.getElementById('mapsModal');
    const container = document.getElementById('mapsIframeContainer');

    if (modal) {
      modal.style.display = 'none';

      // R√©activer le scroll
      document.body.style.overflow = '';

      // Nettoyer l'iframe pour √©conomiser les ressources
      if (container) {
        container.innerHTML = '';
      }
      log('[VENTES] Modal Maps ferm√©');
    }
  }

  // Prix formatting helper
  function formatPrix(prix) {
    if (!prix || prix === '-') return '-';

    // Si le prix est d√©j√† format√© correctement (contient " $"), le retourner tel quel
    if (prix.toString().includes(' $')) {
      return prix;
    }

    // Remove $ and spaces first
    let cleanPrix = prix.toString().replace(/[\s$]/g, '');

    // Replace comma with dot for decimal separator (French format to JS format)
    cleanPrix = cleanPrix.replace(',', '.');

    // Parse as float
    let number = parseFloat(cleanPrix);
    if (isNaN(number)) return prix; // Return original if not a valid number

    // Format with space for thousands and comma for decimals
    let formatted = number.toFixed(2).replace('.', ',');
    formatted = formatted.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');

    return formatted + ' $';
  }

  // Global storage for client data
  window.ventesData = {
    prospects: [],
    attente: [],
    acceptees: [],
    produit: [],
    perdus: []
  };

  // Modal Clients Perdus functions
  window.ouvrirModalClientsPerdus = async function() {
    const modal = document.getElementById('clientsPerdusModal');
    if (!modal) return;

    // Bloquer le scroll en arri√®re-plan
    document.body.style.overflow = 'hidden';

    // Charger les clients perdus
    await loadClientsPerdus();

    // Afficher le modal
    modal.style.display = 'flex';
  };

  window.fermerModalClientsPerdus = function() {
    const modal = document.getElementById('clientsPerdusModal');
    if (modal) {
      modal.style.display = 'none';
    }
    // R√©tablir le scroll
    document.body.style.overflow = '';
  };

  async function loadClientsPerdus() {
    try {
      log('[VENTES] üîç Username actuel:', window.username);
      const url = `/clients-perdus/${window.username}`;
      log('[VENTES] üì° URL de chargement:', url);

      const response = await fetch(url);
      log('[VENTES] üì° R√©ponse status:', response.status);

      if (!response.ok) {
        error('[VENTES] ‚ùå Erreur chargement clients perdus, status:', response.status);
        window.ventesData.perdus = [];
        renderClientsPerdusTable();
        return;
      }

      const clientsPerdus = await response.json();
      log('[VENTES] üì¶ Donn√©es brutes re√ßues:', clientsPerdus);

      window.ventesData.perdus = clientsPerdus || [];
      log('[VENTES] ‚úÖ Clients perdus charg√©s:', window.ventesData.perdus.length);
      log('[VENTES] üìä window.ventesData.perdus:', window.ventesData.perdus);

      renderClientsPerdusTable();
    } catch (err) {
      error('[VENTES] ‚ùå Erreur chargement clients perdus:', err);
      window.ventesData.perdus = [];
      renderClientsPerdusTable();
    }
  }

  function renderClientsPerdusTable() {
    const tbody = document.getElementById('clientsPerdusTableBody');
    if (!tbody) return;

    log('[VENTES] üìä Rendu table clients perdus, total:', window.ventesData.perdus.length);

    // Stocker globalement pour acc√®s depuis showClientPerduDetails
    window.clientsPerdusData = window.ventesData.perdus;

    if (window.ventesData.perdus.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="8" class="px-4 py-8 text-center" style="color: var(--text-gray);">
            <i class="fas fa-info-circle mb-2" style="font-size: 2rem; opacity: 0.5;"></i>
            <p>Aucun client perdu</p>
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = window.ventesData.perdus.map((client, index) => {
      log(`[VENTES] üìã Client ${index}:`, client.prenom, client.nom);
      const prenom = client.prenom || client.clientPrenom || '';
      const nom = client.nom || client.clientNom || '';
      const nomComplet = `${prenom} ${nom}`.trim();
      const telephone = client.telephone || '-';
      const adresse = client.adresse || '-';
      const prix = formatPrix(client.prix || '0');

      return `
        <tr style="cursor: pointer;" onclick="showClientPerduDetails(${index})">
          <td data-label="Nom" style="width: 20%; text-align: left;">${nomComplet}</td>
          <td data-label="T√©l√©phone" style="width: 16%; text-align: left;">${telephone}</td>
          <td data-label="Adresse" style="width: 35%; text-align: left;">
            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${adresse}</div>
          </td>
          <td data-label="Prix" style="width: 11%; text-align: left;">${prix}</td>
          <td data-label="Actions" style="width: 18%; text-align: center;" onclick="event.stopPropagation()">
            <div class="flex items-center justify-center gap-2">
              <button onclick="recupererClientPerdu(${index})" class="px-3 py-1.5 rounded-lg transition-all text-sm font-medium" style="background: rgba(16, 185, 129, 0.2); color: #10b981;" onmouseover="this.style.background='rgba(16, 185, 129, 0.3)'" onmouseout="this.style.background='rgba(16, 185, 129, 0.2)'">
                <i class="fas fa-undo mr-1"></i> R√©cup√©rer
              </button>
              <button onclick="supprimerClientPerdu(${index})" class="p-2 rounded-lg transition-all text-sm font-medium" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'" title="Supprimer">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');

    // R√©initialiser l'affichage mobile apr√®s chargement
    if (window.innerWidth <= 600) {
      resetMobileDisplay('clientsPerdusTableBody');
    }
  }

  // Variable globale pour r√©cup√©ration client perdu
  let clientPerduToRecuperer = null;

  window.recupererClientPerdu = function(clientIndex) {
    log('[VENTES] üîÑ R√©cup√©rer client index:', clientIndex);
    log('[VENTES] üìä Total clients perdus:', window.ventesData.perdus.length);
    log('[VENTES] üìã Tous les clients perdus:', window.ventesData.perdus);

    const client = window.ventesData.perdus[clientIndex];
    if (!client) {
      error('[VENTES] ‚ùå Client perdu introuvable √† l\'index', clientIndex);
      error('[VENTES] üìã Donn√©es disponibles:', window.ventesData.perdus);
      return;
    }

    log('[VENTES] ‚úÖ Client trouv√©:', client);

    // Stocker le client √† r√©cup√©rer
    clientPerduToRecuperer = client;

    // Mettre √† jour le message du modal
    const modal = document.getElementById('confirmRecupererModal');
    const message = document.getElementById('confirmRecupererText');

    log('[VENTES] üîç Modal trouv√©:', modal ? 'Oui' : 'Non');
    log('[VENTES] üîç Message trouv√©:', message ? 'Oui' : 'Non');

    if (!modal || !message) {
      error('[VENTES] ‚ùå √âl√©ments du modal introuvables');
      return;
    }

    const nomComplet = `${client.prenom || client.clientPrenom || ''} ${client.nom || client.clientNom || ''}`.trim();
    message.textContent = `Vous allez r√©cup√©rer ${nomComplet}. Les informations seront pr√©-remplies dans la page soumission pour cr√©er une nouvelle soumission.`;

    // Afficher le modal
    modal.style.display = 'flex';
    log('[VENTES] ‚úÖ Modal de confirmation affich√©');
  };

  window.closeConfirmRecupererModal = function() {
    const modal = document.getElementById('confirmRecupererModal');
    modal.style.display = 'none';
    clientPerduToRecuperer = null;
  };

  window.confirmRecupererClientPerdu = async function() {
    log('[VENTES] üöÄ Confirmation r√©cup√©ration...');

    if (!clientPerduToRecuperer) {
      error('[VENTES] ‚ùå Aucun client √† r√©cup√©rer');
      return;
    }

    const modal = document.getElementById('confirmRecupererModal');
    modal.style.display = 'none';

    try {
      log('[VENTES] üìã R√©cup√©ration du client perdu:', clientPerduToRecuperer);

      // DEBUG: Afficher toutes les donn√©es du client perdu
      log('[VENTES] üîç Toutes les cl√©s disponibles dans clientPerduToRecuperer:', Object.keys(clientPerduToRecuperer));
      log('[VENTES] üîç Prix:', clientPerduToRecuperer.prix);
      log('[VENTES] üîç Produit:', clientPerduToRecuperer.produit);
      log('[VENTES] üîç Part:', clientPerduToRecuperer.part);
      log('[VENTES] üîç ProduitCouleurs:', clientPerduToRecuperer.produitCouleurs);
      log('[VENTES] üîç PartTravaux:', clientPerduToRecuperer.partTravaux);

      // Pr√©parer les donn√©es pour la page soumission
      const dataToStore = {
        prenom: clientPerduToRecuperer.prenom || clientPerduToRecuperer.clientPrenom || '',
        nom: clientPerduToRecuperer.nom || clientPerduToRecuperer.clientNom || '',
        telephone: clientPerduToRecuperer.telephone || '',
        adresse: clientPerduToRecuperer.adresse || '',
        courriel: clientPerduToRecuperer.courriel || clientPerduToRecuperer.email || '',
        // Garder les anciennes informations si disponibles - v√©rifier plusieurs noms possibles
        prix: clientPerduToRecuperer.prix || '',
        date2: clientPerduToRecuperer.date2 || clientPerduToRecuperer.date_travaux || '',
        item: clientPerduToRecuperer.item || '',
        temps: clientPerduToRecuperer.temps || '',
        endroit: clientPerduToRecuperer.endroit || clientPerduToRecuperer.endroit_peinture || '',
        produit: clientPerduToRecuperer.produit || clientPerduToRecuperer.produitCouleurs || '',
        part: clientPerduToRecuperer.part || clientPerduToRecuperer.partTravaux || '',
        payer_par: clientPerduToRecuperer.payer_par || 'Virement Interac',
        client_perdu_id: clientPerduToRecuperer.id || clientPerduToRecuperer.num // Pour supprimer apr√®s cr√©ation de la nouvelle soumission
      };

      // Stocker dans localStorage pour la page soumission
      localStorage.setItem('clientSoumission', JSON.stringify(dataToStore));
      log('[VENTES] ‚úÖ Donn√©es stock√©es pour r√©cup√©ration:', dataToStore);
      log('[VENTES] üîç V√©rification localStorage:', localStorage.getItem('clientSoumission'));

      // Attendre un peu pour s'assurer que localStorage est bien √©crit
      await new Promise(resolve => setTimeout(resolve, 100));

      // Rediriger vers la page soumission
      fermerModalClientsPerdus();

      log('[VENTES] üîÑ Redirection vers soumission...');
      log('[VENTES] üîç window.parent:', window.parent);
      log('[VENTES] üîç Dans iframe?', window.parent !== window);

      if (window.parent && window.parent !== window) {
        log('[VENTES] üéØ Redirection via hash: #/soumissions');
        // Forcer le rechargement de l'iframe m√™me si on est d√©j√† sur soumissions
        const currentHash = window.parent.location.hash;
        if (currentHash === '#/soumissions') {
          // Temporairement changer le hash puis revenir pour forcer le reload
          window.parent.location.hash = '#/temp';
          setTimeout(() => {
            window.parent.location.hash = '#/soumissions';
          }, 50);
        } else {
          window.parent.location.hash = '#/soumissions';
        }
      } else {
        log('[VENTES] üéØ Redirection directe: /soumissions');
        window.location.href = '/soumissions';
      }
    } catch (err) {
      error('[VENTES] ‚ùå Erreur r√©cup√©ration client perdu:', err);
    }

    clientPerduToRecuperer = null;
  };

  // Variable globale pour suppression client perdu
  let clientPerduToDelete = null;

  window.supprimerClientPerdu = function(clientIndex) {
    const client = window.ventesData.perdus[clientIndex];
    if (!client) {
      error('[VENTES] Client perdu introuvable');
      return;
    }

    // Stocker le client √† supprimer
    clientPerduToDelete = client;

    // Mettre √† jour le message du modal
    const modal = document.getElementById('confirmDeletePerduModal');
    const message = document.getElementById('confirmDeletePerduText');
    const nomComplet = `${client.prenom || client.clientPrenom || ''} ${client.nom || client.clientNom || ''}`.trim();
    message.textContent = `√ätes-vous s√ªr de vouloir supprimer d√©finitivement ${nomComplet} de la liste des clients perdus ?`;

    // Afficher le modal
    modal.style.display = 'flex';
  };

  window.closeConfirmDeletePerduModal = function() {
    const modal = document.getElementById('confirmDeletePerduModal');
    modal.style.display = 'none';
    clientPerduToDelete = null;
  };

  window.confirmDeleteClientPerdu = async function() {
    if (!clientPerduToDelete) return;

    const modal = document.getElementById('confirmDeletePerduModal');
    modal.style.display = 'none';

    try {
      log('[VENTES] Suppression du client perdu:', clientPerduToDelete);

      // Appeler le backend pour supprimer
      const response = await fetch('/clients-perdus/supprimer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: window.username,
          client_id: clientPerduToDelete.id || clientPerduToDelete.num
        })
      });

      if (response.ok) {
        log('[VENTES] ‚úÖ Client perdu supprim√© avec succ√®s');
        // Recharger les clients perdus
        await loadClientsPerdus();
      } else {
        error('[VENTES] ‚ùå Erreur lors de la suppression');
      }
    } catch (err) {
      error('[VENTES] Erreur suppression client perdu:', err);
    }

    clientPerduToDelete = null;
  };

  // Show client details modal
  window.showClientDetails = async function(index, category) {
    const clientData = window.ventesData[category][index];
    if (!clientData) {
      error('[VENTES] Donn√©es client introuvables');
      return;
    }

    // Store current category and index globally for marquerCommePerdu function
    window.currentClientIndex = index;
    window.currentClientCategory = category;

    const modal = document.getElementById('clientInfoModal');
    const content = document.getElementById('clientInfoContent');
    const modalHeader = modal.querySelector('.flex.items-center.justify-between');

    if (!modal || !content) return;

    // Mettre √† jour le header avec bouton supprimer pour prospects
    if (category === 'prospects') {
      modalHeader.innerHTML = `
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user mr-2" style="color: var(--primary-blue);"></i>
          Informations client
        </h3>
        <div class="flex items-center gap-2">
          <button onclick="supprimerProspect(${index})" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'" title="Supprimer">
            <i class="fas fa-trash"></i>
          </button>
          <button onclick="closeClientInfo()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);" onmouseover="this.style.background='rgba(96, 165, 250, 0.3)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2)'">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
    } else if (category === 'attente') {
      // Header simple pour ventes en attente
      modalHeader.innerHTML = `
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user mr-2" style="color: var(--primary-blue);"></i>
          Informations client
        </h3>
        <button onclick="closeClientInfo()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);" onmouseover="this.style.background='rgba(96, 165, 250, 0.3)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      `;
    } else if (category === 'acceptees' || category === 'produit') {
      // Header simple pour ventes accept√©es et en production
      modalHeader.innerHTML = `
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user mr-2" style="color: var(--primary-blue);"></i>
          Informations client
        </h3>
        <button onclick="closeClientInfo()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);" onmouseover="this.style.background='rgba(96, 165, 250, 0.3)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      `;
    } else {
      // Header normal pour les autres cat√©gories
      modalHeader.innerHTML = `
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user mr-2" style="color: var(--primary-blue);"></i>
          Informations client
        </h3>
        <button onclick="closeClientInfo()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);" onmouseover="this.style.background='rgba(96, 165, 250, 0.3)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      `;
    }

    // Build client info HTML
    const prenom = clientData.prenom || clientData.clientPrenom || '-';
    const nom = clientData.nom || clientData.clientNom || '-';
    const telephone = clientData.telephone || '-';
    const adresse = clientData.adresse || '-';
    const courriel = clientData.courriel || clientData.email || '-';
    const prixRaw = clientData.prix || '-';
    const prix = formatPrix(prixRaw);

    // Clean phone number for tel: link
    const telNumber = telephone.replace(/\D/g, '');

    // Create Google Maps search URL
    const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(adresse)}`;

    let html = ``;

    // Ajouter le bouton "Marquer comme perdu" en haut pour attente/acceptees/produit
    if (category === 'attente' || category === 'acceptees' || category === 'produit') {
      html += `
        <div class="marquer-perdu-top" style="margin-bottom: 1rem;">
          <div class="flex justify-end">
            <button onclick="marquerCommePerdu()" class="px-3 py-1.5 rounded-lg flex items-center gap-2 transition-colors text-sm font-medium" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'" title="Marquer comme perdu">
              <i class="fas fa-times-circle"></i>
              <span>Marquer comme perdu</span>
            </button>
          </div>
        </div>
      `;
    }

    html += `
      <div style="background: rgba(30, 41, 59, 0.5); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
        <!-- Nom complet -->
        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
          <i class="fas fa-user" style="color: var(--primary-blue); width: 20px; text-align: center;"></i>
          <div style="flex: 1;">
            <div style="font-size: 0.75rem; color: var(--text-gray); margin-bottom: 0.25rem;">Nom complet</div>
            <div style="color: var(--text-light); font-weight: 500;">${prenom} ${nom}</div>
          </div>
        </div>

        <!-- T√©l√©phone cliquable -->
        ${telephone !== '-' ? `
        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
          <i class="fas fa-phone" style="color: var(--primary-blue); width: 20px; text-align: center;"></i>
          <div style="flex: 1;">
            <div style="font-size: 0.75rem; color: var(--text-gray); margin-bottom: 0.25rem;">T√©l√©phone</div>
            <a href="tel:${telNumber}" style="color: var(--primary-blue); text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
              <span style="font-weight: 500;">${telephone}</span>
            </a>
          </div>
        </div>
        ` : ''}

        <!-- Adresse cliquable vers Google Maps -->
        ${adresse !== '-' ? `
        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
          <i class="fas fa-map-marker-alt" style="color: var(--primary-blue); width: 20px; text-align: center;"></i>
          <div style="flex: 1;">
            <div style="font-size: 0.75rem; color: var(--text-gray); margin-bottom: 0.25rem;">Adresse</div>
            <a href="javascript:void(0)" onclick="ouvrirMapsModal('${adresse.replace(/'/g, "\\'")}')" style="color: var(--primary-blue); text-decoration: none; transition: opacity 0.2s; cursor: pointer;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
              <span style="font-weight: 500;">${adresse}</span>
            </a>
          </div>
        </div>
        ` : ''}

        <!-- Courriel cliquable -->
        ${courriel !== '-' ? `
        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
          <i class="fas fa-envelope" style="color: var(--primary-blue); width: 20px; text-align: center;"></i>
          <div style="flex: 1;">
            <div style="font-size: 0.75rem; color: var(--text-gray); margin-bottom: 0.25rem;">Courriel</div>
            <a href="mailto:${courriel}" style="color: var(--primary-blue); text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
              <span style="font-weight: 500;">${courriel}</span>
            </a>
          </div>
        </div>
        ` : ''}

        <!-- Prix bien format√© -->
        ${prix !== '-' ? `
        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0;">
          <i class="fas fa-dollar-sign" style="color: #10b981; width: 20px; text-align: center;"></i>
          <div style="flex: 1;">
            <div style="font-size: 0.75rem; color: var(--text-gray); margin-bottom: 0.25rem;">Prix</div>
            <div style="color: #10b981; font-weight: 600; font-size: 1.125rem;">${prix}</div>
          </div>
        </div>
        ` : ''}
      </div>

      <div class="pt-4">
    `;

    // Add action buttons based on category
    if (category === 'prospects') {
      const clientDataStr = encodeURIComponent(JSON.stringify(clientData));
      html += `
        <div class="flex justify-end">
          <button onclick="commencerEstimation('${clientDataStr}')" class="btn-primary px-4 py-2 rounded-lg relative overflow-hidden">
            <span><i class="fas fa-calculator mr-2"></i>Commencer une estimation</span>
          </button>
        </div>
      `;
    } else if (category === 'attente') {
      // V√©rifier si un calcul existe pour ce client
      const hasCalcul = await checkIfCalculExists(clientData);

      // V√©rifier si un GQP existe pour ce client
      const hasGQP = !!(clientData.lien_gqp && clientData.lien_gqp !== '');
      const gqpUrl = clientData.lien_gqp || '';

      const pdfUrl = clientData.pdf_url || clientData.pdfUrl || '';
      html += `
        <div class="flex justify-end space-x-3">
          <button onclick="voirSoumission('${pdfUrl}', '${(clientData.prenom || clientData.clientPrenom || '')} ${(clientData.nom || clientData.clientNom || '')}')" class="btn-secondary btn-action-mobile px-4 py-2 rounded-lg relative overflow-hidden">
            <span><i class="fas fa-file-pdf mr-2"></i><span class="btn-text-desktop">Voir </span>Soumission</span>
          </button>
          <button onclick="${hasGQP ? `voirGQP('${gqpUrl}', '${(clientData.prenom || clientData.clientPrenom || '')} ${(clientData.nom || clientData.clientNom || '')}')` : 'return false;'}" class="btn-secondary btn-action-mobile px-4 py-2 rounded-lg relative overflow-hidden" ${!hasGQP ? 'style="opacity: 0.5; cursor: not-allowed;" disabled' : ''}>
            <i class="fas fa-clipboard-check mr-2"></i><span class="btn-text-desktop">Voir </span>GQP
          </button>
          <button onclick="${hasCalcul ? `voirCalcul('${clientData.id}')` : 'return false;'}" class="btn-secondary btn-action-mobile px-4 py-2 rounded-lg relative overflow-hidden" ${!hasCalcul ? 'style="opacity: 0.5; cursor: not-allowed;" disabled' : ''}>
            <i class="fas fa-calculator mr-2"></i><span class="btn-text-desktop">Voir </span>Calcul
          </button>
        </div>
      `;
    } else if (category === 'acceptees') {
      // V√©rifier si un GQP existe pour ce client
      const hasGQP = !!(clientData.lien_gqp && clientData.lien_gqp !== '');
      const gqpUrl = clientData.lien_gqp || '';

      // V√©rifier si un calcul existe pour ce client
      const hasCalcul = await checkIfCalculExists(clientData);

      html += `
        <div class="space-y-3">
          <!-- Boutons de consultation -->
          <div class="flex justify-end space-x-3">
            <button onclick="voirPDF('${clientData.pdfUrl || ''}', '${(clientData.prenom || clientData.clientPrenom || '')} ${(clientData.nom || clientData.clientNom || '')}')" class="btn-secondary btn-action-mobile px-4 py-2 rounded-lg relative overflow-hidden">
              <i class="fas fa-file-pdf mr-2"></i><span class="btn-text-desktop">Voir </span>Soumission
            </button>
            <button onclick="${hasGQP ? `voirGQP('${gqpUrl}', '${(clientData.prenom || clientData.clientPrenom || '')} ${(clientData.nom || clientData.clientNom || '')}')` : 'return false;'}" class="btn-secondary btn-action-mobile px-4 py-2 rounded-lg relative overflow-hidden" ${!hasGQP ? 'style="opacity: 0.5; cursor: not-allowed;" disabled' : ''}>
              <i class="fas fa-clipboard-list mr-2"></i><span class="btn-text-desktop">Voir </span>GQP
            </button>
            <button onclick="${hasCalcul ? `voirCalcul('${clientData.id}')` : 'return false;'}" class="btn-secondary btn-action-mobile px-4 py-2 rounded-lg relative overflow-hidden" ${!hasCalcul ? 'style="opacity: 0.5; cursor: not-allowed;" disabled' : ''}>
              <i class="fas fa-calculator mr-2"></i><span class="btn-text-desktop">Voir </span>Calcul
            </button>
          </div>

          <!-- S√©parateur -->
          <div style="border-top: 1px solid rgba(71, 85, 105, 0.3); margin: 1rem 0;"></div>

          <!-- Action de finalisation -->
          <div class="flex justify-end">
            <button onclick="terminerProduction('${clientData.id}')" class="px-6 py-2.5 rounded-lg relative overflow-hidden font-medium transition-all" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(16, 185, 129, 0.3)'">
              <i class="fas fa-check-circle mr-2"></i>Terminer production
            </button>
          </div>
        </div>
      `;
    } else if (category === 'produit') {
      // V√©rifier si un GQP existe pour ce client
      const hasGQP = !!(clientData.lien_gqp && clientData.lien_gqp !== '');
      const gqpUrl = clientData.lien_gqp || '';

      // V√©rifier si un calcul existe pour ce client
      const hasCalcul = await checkIfCalculExists(clientData);

      html += `
        <div class="flex justify-end space-x-3">
          <button onclick="voirPDF('${clientData.pdfUrl || ''}', '${(clientData.prenom || clientData.clientPrenom || '')} ${(clientData.nom || clientData.clientNom || '')}')" class="btn-secondary btn-action-mobile px-4 py-2 rounded-lg relative overflow-hidden">
            <i class="fas fa-file-pdf mr-2"></i><span class="btn-text-desktop">Voir </span>Soumission
          </button>
          <button onclick="${hasGQP ? `voirGQP('${gqpUrl}', '${(clientData.prenom || clientData.clientPrenom || '')} ${(clientData.nom || clientData.clientNom || '')}')` : 'return false;'}" class="btn-secondary btn-action-mobile px-4 py-2 rounded-lg relative overflow-hidden" ${!hasGQP ? 'style="opacity: 0.5; cursor: not-allowed;" disabled' : ''}>
            <i class="fas fa-clipboard-list mr-2"></i><span class="btn-text-desktop">Voir </span>GQP
          </button>
          <button onclick="${hasCalcul ? `voirCalcul('${clientData.id}')` : 'return false;'}" class="btn-secondary btn-action-mobile px-4 py-2 rounded-lg relative overflow-hidden" ${!hasCalcul ? 'style="opacity: 0.5; cursor: not-allowed;" disabled' : ''}>
            <i class="fas fa-calculator mr-2"></i><span class="btn-text-desktop">Voir </span>Calcul
          </button>
        </div>
      `;
    }

    html += `</div>`;
    content.innerHTML = html;

    // Bloquer le scroll en arri√®re-plan
    document.body.style.overflow = 'hidden';

    modal.style.display = 'flex';
  };

  window.closeClientInfo = function() {
    const modal = document.getElementById('clientInfoModal');
    if (modal) {
      modal.style.display = 'none';

      // R√©activer le scroll
      document.body.style.overflow = '';
    }
  };

  // Action functions
  window.commencerEstimation = function(clientDataStr) {
    closeClientInfo();
    try {
      const clientData = JSON.parse(decodeURIComponent(clientDataStr));
      log('[VENTES] Commencer estimation pour:', clientData);

      // Store client data for prefill in calcul page
      const dataToStore = {
        prenom: clientData.prenom || '',
        nom: clientData.nom || '',
        telephone: clientData.telephone || '',
        adresse: clientData.adresse || '',
        courriel: clientData.courriel || clientData.email || ''
      };
      localStorage.setItem('clientEstimation', JSON.stringify(dataToStore));
      log('[VENTES] ‚úÖ Donn√©es stock√©es dans localStorage.clientEstimation:', dataToStore);
      log('[VENTES] üîç V√©rification imm√©diate:', localStorage.getItem('clientEstimation'));

      // Store selected entrepreneur for auto-selection in calculateur
      const selectedEntrepreneur = window.selectedEntrepreneurUsername || window.username;
      if (selectedEntrepreneur) {
        sessionStorage.setItem('autoSelectEntrepreneur', selectedEntrepreneur);
        log('[VENTES] üìå Entrepreneur √† auto-s√©lectionner:', selectedEntrepreneur);
      }

      // Navigate to calculateur page
      if (window.parent && window.parent !== window && window.parent.router) {
        // Use parent router to load calculateur (preserves entrepreneur selection)
        log('[VENTES] Navigation via parent.router.loadPage(calculateur)');
        window.parent.router.loadPage('calculateur');
      } else if (window.parent && window.parent !== window) {
        window.parent.location.hash = '#/calculateur';
      } else {
        window.location.href = '/calcul';
      }
    } catch (err) {
      error('[VENTES] Erreur commencer estimation:', err);
    }
  };

  // Variables globales pour la suppression
  let prospectToDelete = null;

  window.supprimerProspect = function(prospectIndex) {
    closeClientInfo();

    const prospect = window.ventesData.prospects[prospectIndex];
    if (!prospect) {
      error('[VENTES] Prospect introuvable');
      return;
    }

    // Stocker le prospect √† supprimer
    prospectToDelete = prospect;

    // Mettre √† jour le message du modal
    const modal = document.getElementById('confirmDeleteProspectModal');
    const message = modal.querySelector('p');
    message.textContent = `√ätes-vous s√ªr de vouloir supprimer ${prospect.prenom} ${prospect.nom} de la liste des clients potentiels ?`;

    // Afficher le modal
    modal.style.display = 'flex';
  };

  window.closeConfirmDeleteProspectModal = function() {
    const modal = document.getElementById('confirmDeleteProspectModal');
    modal.style.display = 'none';
    prospectToDelete = null;
  };

  window.confirmDeleteProspect = async function() {
    if (!prospectToDelete) return;

    const modal = document.getElementById('confirmDeleteProspectModal');
    modal.style.display = 'none';

    try {
      log('[VENTES] Suppression du prospect:', prospectToDelete);

      // Appeler le backend pour supprimer
      const response = await fetch('/supprimer-prospect', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: window.username,
          id: prospectToDelete.id
        })
      });

      if (response.ok) {
        log('[VENTES] ‚úÖ Prospect supprim√© avec succ√®s');
        // Recharger les donn√©es
        await loadVentesDataInternal();
      } else {
        error('[VENTES] ‚ùå Erreur lors de la suppression');
      }
    } catch (err) {
      error('[VENTES] Erreur suppression prospect:', err);
    }

    prospectToDelete = null;
  };

  // Variables globales pour marquer comme perdu
  let venteToMarkPerdu = null;

  window.marquerCommePerdu = function() {
    closeClientInfo();

    // Use stored category and index from showClientDetails()
    const category = window.currentClientCategory;
    const venteIndex = window.currentClientIndex;

    if (!category || venteIndex === undefined) {
      error('[VENTES] Cat√©gorie ou index non d√©fini');
      return;
    }

    const vente = window.ventesData[category][venteIndex];
    if (!vente) {
      error('[VENTES] Vente introuvable');
      return;
    }

    // Stocker la vente √† marquer comme perdue avec sa cat√©gorie et son index
    venteToMarkPerdu = {
      vente: vente,
      category: category,
      index: venteIndex
    };

    // Mettre √† jour le message du modal
    const modal = document.getElementById('confirmMarquerPerduModal');
    const message = document.getElementById('confirmMarquerPerduText');
    const nomComplet = `${vente.prenom || vente.clientPrenom || ''} ${vente.nom || vente.clientNom || ''}`.trim();
    message.textContent = `√ätes-vous s√ªr de vouloir marquer ${nomComplet} comme client perdu ?`;

    // Afficher le modal
    modal.style.display = 'flex';
  };

  window.closeConfirmMarquerPerduModal = function() {
    const modal = document.getElementById('confirmMarquerPerduModal');
    modal.style.display = 'none';
    venteToMarkPerdu = null;
  };

  window.confirmMarquerPerdu = async function() {
    if (!venteToMarkPerdu) return;

    const modal = document.getElementById('confirmMarquerPerduModal');
    modal.style.display = 'none';

    // Extract vente data, category and index
    const { vente, category, index } = venteToMarkPerdu;

    try {
      log('[VENTES] Marquer comme perdu:', vente);

      // Appeler le backend pour marquer comme perdu
      const response = await fetch('/ventes/marquer-perdu', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: window.username,
          vente_id: vente.id || vente.num
        })
      });

      if (response.ok) {
        log('[VENTES] ‚úÖ Vente marqu√©e comme perdue avec succ√®s');

        // ‚ö° INSTANT REMOVAL - Remove the row from DOM immediately
        const tbodyMap = {
          'attente': 'attente-tbody',
          'acceptees': 'accepte-tbody',
          'produit': 'produit-tbody'
        };

        const tbodyId = tbodyMap[category];
        if (tbodyId) {
          const tbody = document.getElementById(tbodyId);
          if (tbody && tbody.children[index]) {
            // Remove the row at the specified index
            tbody.children[index].remove();
            log(`[VENTES] üóëÔ∏è Ligne ${index} retir√©e de ${category}`);

            // If no rows left, show empty state
            if (tbody.children.length === 0) {
              showEmptyTable(tbody, category);
            }
          }
        }

        // Recharger les donn√©es pour la persistance
        await loadVentesDataInternal();
      } else {
        error('[VENTES] ‚ùå Erreur lors du marquage comme perdu');
      }
    } catch (err) {
      error('[VENTES] Erreur marquer comme perdu:', err);
    }

    venteToMarkPerdu = null;
  };

  window.signerSoumission = function(venteId) {
    closeClientInfo();
    log('[VENTES] Signer soumission:', venteId);
    // TODO: Open signature modal or navigate
  };

  window.creerGQP = function(venteId) {
    closeClientInfo();
    log('[VENTES] Cr√©er GQP pour:', venteId);
    // TODO: Navigate to GQP creation
  };

  window.terminerProduction = async function(venteId) {
    closeClientInfo();
    log('[VENTES] Terminer production:', venteId);

    try {
      // Appeler le backend pour marquer la production comme termin√©e
      const response = await fetch('/ventes/production-terminee', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: window.username,
          id: venteId
        })
      });

      if (response.ok) {
        log('[VENTES] ‚úÖ Production termin√©e avec succ√®s');

        // Afficher l'animation de succ√®s
        showSuccessAnimation('production');

        // Recharger les donn√©es apr√®s 2 secondes (pour laisser l'animation se terminer)
        setTimeout(async () => {
          await loadVentesDataInternal();
        }, 2000);
      } else {
        error('[VENTES] ‚ùå Erreur lors de la finalisation de production');
        alert('Erreur lors de la finalisation de production');
      }
    } catch (err) {
      error('[VENTES] Erreur terminer production:', err);
      alert('Erreur r√©seau lors de la finalisation');
    }
  };

  // Animation de succ√®s (m√™me style que soumission.html)
  function showSuccessAnimation(messageKey) {
    const messages = {
      'production': 'Production termin√©e avec succ√®s!',
      'perdu': 'Client marqu√© comme perdu'
    };

    const message = messages[messageKey] || 'Op√©ration r√©ussie!';

    const overlay = document.createElement('div');
    overlay.className = 'success-overlay';
    overlay.innerHTML = `
      <div class="success-content">
        <div class="success-checkmark">
          <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
            <path d="M8 20 L16 28 L32 12" stroke="white" stroke-width="3"
                  stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">${message}</h2>
      </div>
    `;

    document.body.appendChild(overlay);

    setTimeout(() => {
      overlay.remove();
      // Recharger les ventes
      loadVentesDataInternal();
    }, 2000);
  }

  window.voirSoumission = function(pdfUrl, clientName) {
    log('[VENTES] voirSoumission appel√©e avec:', pdfUrl, clientName);
    closeClientInfo();

    if (!pdfUrl || pdfUrl === '') {
      log('[VENTES] Aucun PDF disponible');
      return;
    }

    // Cr√©er un modal avec iframe pour afficher le PDF
    const modal = document.createElement('div');
    modal.id = 'soumissionViewerModal';
    modal.className = 'fixed inset-0 flex items-center justify-center';
    modal.style.cssText = 'background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 80; display: flex;';

    modal.innerHTML = `
      <div class="status-card p-6 flex flex-col" style="width: 90%; max-width: 1000px; height: 85vh; max-height: 85vh;">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold" style="color: var(--text-light);">
            <i class="fas fa-file-pdf mr-2" style="color: var(--primary-blue);"></i>
            Soumission - ${clientName}
          </h3>
          <button onclick="closeSoumissionViewer()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);" onmouseover="this.style.background='rgba(96, 165, 250, 0.3)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2)'">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="flex-1 rounded-lg overflow-hidden" style="background: #0f172a; border: 2px solid var(--border-dark);">
          <iframe src="${pdfUrl}" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
      </div>
    `;

    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';

    log('[VENTES] Modal soumission affich√©');
  };

  window.closeSoumissionViewer = function() {
    const modal = document.getElementById('soumissionViewerModal');
    if (modal) {
      modal.remove();
    }
    document.body.style.overflow = '';
  };

  // Ancienne fonction closePDFViewer supprim√©e - on utilise maintenant closePDFViewerSimple()

  async function checkIfCalculExists(clientData) {
    try {
      // D√©sactiver le cache pour toujours avoir les donn√©es √† jour
      const timestamp = new Date().getTime();
      const response = await fetch(`/api/projets/${window.username}?t=${timestamp}`, {
        cache: 'no-store',
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      });
      if (!response.ok) return false;

      const projets = await response.json();

      // Chercher un projet qui correspond au client (par adresse et nom)
      const nomComplet = `${clientData.prenom || clientData.clientPrenom || ''} ${clientData.nom || clientData.clientNom || ''}`.trim();
      const adresse = clientData.adresse || '';

      const projetTrouve = projets.find(p =>
        p.client === nomComplet && p.adresse === adresse
      );

      return !!projetTrouve;
    } catch (err) {
      error('[VENTES] Erreur v√©rification calcul:', err);
      return false;
    }
  }

  window.voirCalcul = async function(venteId) {
    closeClientInfo();

    try {
      // R√©cup√©rer les donn√©es de la vente (chercher dans toutes les cat√©gories)
      let vente = window.ventesData.attente.find(v => v.id === venteId || v.num === venteId);
      if (!vente) {
        vente = window.ventesData.acceptees.find(v => v.id === venteId || v.num === venteId);
      }
      if (!vente) {
        vente = window.ventesData.produit.find(v => v.id === venteId || v.num === venteId);
      }
      if (!vente) {
        error('[VENTES] Vente non trouv√©e');
        return;
      }

      const nomComplet = `${vente.prenom || vente.clientPrenom || ''} ${vente.nom || vente.clientNom || ''}`.trim();
      const adresse = vente.adresse || '';

      // R√©cup√©rer la liste des projets (sans cache)
      const timestamp = new Date().getTime();
      const response = await fetch(`/api/projets/${window.username}?t=${timestamp}`, {
        cache: 'no-store',
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      });
      if (!response.ok) {
        error('[VENTES] Erreur chargement projets');
        return;
      }

      const projets = await response.json();
      const projet = projets.find(p => p.client === nomComplet && p.adresse === adresse);

      if (!projet) {
        error('[VENTES] Projet non trouv√©');
        return;
      }

      // Stocker l'ID du projet dans localStorage pour le charger dans calcul
      localStorage.setItem('pendingProjectLoad', projet.id);
      log('[VENTES] üìå Projet √† charger:', projet.id);

      // Store selected entrepreneur for auto-selection in calculateur
      const selectedEntrepreneur = window.selectedEntrepreneurUsername || window.username;
      if (selectedEntrepreneur) {
        sessionStorage.setItem('autoSelectEntrepreneur', selectedEntrepreneur);
        log('[VENTES] üìå Entrepreneur √† auto-s√©lectionner:', selectedEntrepreneur);
      }

      // Naviguer vers calculateur
      if (window.parent && window.parent !== window && window.parent.router) {
        // Use parent router to load calculateur (preserves entrepreneur selection)
        log('[VENTES] Navigation via parent.router.loadPage(calculateur)');
        window.parent.router.loadPage('calculateur');
      } else if (window.parent && window.parent !== window) {
        window.parent.location.hash = '#/calculateur';
      } else {
        window.location.href = '/calcul';
      }
    } catch (err) {
      error('[VENTES] Erreur voir calcul:', err);
    }
  };

  // Fonction pour voir soumission dans popup (pour Accept√©es et Produit)
  // Fonction pour voir PDF dans un popup (sections Accept√©es et Produit)
  window.voirPDF = function(pdfUrl, clientName) {
    log('[VENTES] voirPDF appel√©e avec:', pdfUrl, clientName);
    closeClientInfo();

    if (!pdfUrl || pdfUrl === '') {
      log('[VENTES] Aucun PDF disponible');
      return;
    }

    // Cr√©er un modal avec iframe pour afficher le PDF
    const modal = document.createElement('div');
    modal.id = 'pdfViewerModalSimple';
    modal.className = 'fixed inset-0 flex items-center justify-center';
    modal.style.cssText = 'background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 80; display: flex;';

    modal.innerHTML = `
      <div class="status-card p-6 flex flex-col" style="width: 90%; max-width: 1000px; height: 85vh; max-height: 85vh;">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold" style="color: var(--text-light);">
            <i class="fas fa-file-pdf mr-2" style="color: var(--primary-blue);"></i>
            Soumission - ${clientName}
          </h3>
          <button onclick="closePDFViewerSimple()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);" onmouseover="this.style.background='rgba(96, 165, 250, 0.3)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2)'">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="flex-1 rounded-lg overflow-hidden" style="background: #0f172a; border: 2px solid var(--border-dark);">
          <iframe src="${pdfUrl}" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
      </div>
    `;

    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';

    log('[VENTES] Modal PDF affich√©');
  };

  window.closePDFViewerSimple = function() {
    const modal = document.getElementById('pdfViewerModalSimple');
    if (modal) {
      modal.remove();
    }
    document.body.style.overflow = '';
  };

  // Fonction pour voir GQP dans un popup
  window.voirGQP = function(gqpUrl, clientName) {
    log('[VENTES] voirGQP appel√©e avec:', gqpUrl, clientName);
    closeClientInfo();

    if (!gqpUrl || gqpUrl === '') {
      log('[VENTES] Aucun GQP disponible');
      return;
    }

    // Cr√©er un modal avec iframe pour afficher le GQP
    const modal = document.createElement('div');
    modal.id = 'gqpViewerModal';
    modal.className = 'fixed inset-0 flex items-center justify-center';
    modal.style.cssText = 'background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 80; display: flex;';

    modal.innerHTML = `
      <div class="status-card p-6 flex flex-col" style="width: 90%; max-width: 1000px; height: 85vh; max-height: 85vh;">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold" style="color: var(--text-light);">
            <i class="fas fa-file-alt mr-2" style="color: var(--primary-blue);"></i>
            GQP - ${clientName}
          </h3>
          <button onclick="closeGQPViewer()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);" onmouseover="this.style.background='rgba(96, 165, 250, 0.3)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2)'">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="flex-1 rounded-lg overflow-hidden" style="background: #0f172a; border: 2px solid var(--border-dark);">
          <iframe src="${gqpUrl}" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
      </div>
    `;

    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';

    log('[VENTES] Modal GQP affich√©');
  };

  window.closeGQPViewer = function() {
    const modal = document.getElementById('gqpViewerModal');
    if (modal) {
      modal.remove();
    }
    document.body.style.overflow = '';
  };


  // Handle prospect form submission
  document.addEventListener('DOMContentLoaded', function() {
    // Format phone number with dashes
    const prospectTelephone = document.getElementById('prospectTelephone');
    if (prospectTelephone) {
      prospectTelephone.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits

        if (value.length > 10) {
          value = value.substring(0, 10);
        }

        // Format as 000-000-0000
        if (value.length >= 6) {
          e.target.value = `${value.substring(0, 3)}-${value.substring(3, 6)}-${value.substring(6)}`;
        } else if (value.length >= 3) {
          e.target.value = `${value.substring(0, 3)}-${value.substring(3)}`;
        } else {
          e.target.value = value;
        }
      });
    }

    const prospectForm = document.getElementById('prospectForm');
    if (prospectForm) {
      prospectForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const prenom = document.getElementById('prospectPrenom').value.trim();
        const nom = document.getElementById('prospectNom').value.trim();
        const telephone = document.getElementById('prospectTelephone').value.trim();
        const adresse = document.getElementById('prospectAdresse').value.trim();

        if (!prenom || !nom || !telephone || !adresse) {
          log('[VENTES] Tous les champs sont requis');
          return;
        }

        // Save to backend
        try {
          const response = await fetch('/ajouter-prospect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: window.username,
              prenom: prenom,
              nom: nom,
              telephone: telephone,
              adresse: adresse
            })
          });

          if (response.ok) {
            log('[VENTES] Prospect ajout√© avec succ√®s');
            fermerModalProspect();
            // Reload data to show new prospect
            await loadVentesDataInternal();
          } else {
            error('[VENTES] Erreur ajout prospect:', await response.text());
          }
        } catch (err) {
          error('[VENTES] Erreur r√©seau:', err);
        }
      });
    }
  });
</script>

  <!-- Script pour toggle clients perdus -->
  <script>
    // Variable pour stocker l'√©tat du modal
    let perdusModalOpen = false;

    function toggleClientsPerdus() {
      const modal = document.getElementById('clients-perdus-modal');
      if (!modal) return;

      perdusModalOpen = true;
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden'; // Bloquer le scroll en arri√®re-plan
      chargerClientsPerdus();
    }

    function closeClientsPerdusModal() {
      const modal = document.getElementById('clients-perdus-modal');
      if (!modal) return;

      perdusModalOpen = false;
      modal.style.display = 'none';
      document.body.style.overflow = ''; // R√©tablir le scroll
    }

    // Variable globale pour stocker les clients perdus
    let allClientsPerdus = [];

    async function chargerClientsPerdus() {
      try {
        const response = await fetch(`${window.location.origin}/clients-perdus/${window.username}`);
        allClientsPerdus = await response.json();

        afficherClientsPerdus(allClientsPerdus);
      } catch (err) {
        error('Erreur chargement clients perdus:', err);
      }
    }

    function afficherClientsPerdus(clientsPerdus) {
      const tbody = document.getElementById('perdus-modal-tbody');
      if (!tbody) return;

      // Stocker globalement pour acc√®s depuis showClientPerduDetails
      window.clientsPerdusData = clientsPerdus;

      if (!clientsPerdus || clientsPerdus.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              <i class="fas fa-user-times" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
              <p style="font-size: 1rem;">Aucun client perdu</p>
            </td>
          </tr>
        `;
      } else {
        tbody.innerHTML = clientsPerdus.map((client, index) => {
          const clientId = client.id || `${client.prenom || client.clientPrenom}_${client.nom || client.clientNom}_${client.telephone}`;
          // Supporter les deux formats de nom: prenom/nom ou clientPrenom/clientNom
          const prenom = client.prenom || client.clientPrenom || '';
          const nom = client.nom || client.clientNom || '';
          const nomComplet = `${prenom} ${nom}`.trim() || 'N/A';
          return `
          <tr style="cursor: pointer;" onclick="showClientPerduDetails(${index})">
            <td data-label="Nom" style="width: 20%; text-align: left;">${nomComplet}</td>
            <td data-label="T√©l√©phone" style="width: 16%; text-align: left;">${client.telephone || '-'}</td>
            <td data-label="Adresse" style="width: 35%; text-align: left;">
              <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${client.adresse || '-'}</div>
            </td>
            <td data-label="Prix" style="width: 11%; text-align: left;">${client.prix || '-'}</td>
            <td data-label="Actions" style="width: 18%; text-align: center;" onclick="event.stopPropagation()">
              <div style="display: flex; gap: 8px; justify-content: center;">
                <button onclick="recupererClientPerdu('${clientId}')" title="R√©cup√©rer" style="background: rgba(16, 185, 129, 0.15); color: #10b981; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(16, 185, 129, 0.3)'" onmouseout="this.style.background='rgba(16, 185, 129, 0.15)'">
                  <i class="fas fa-undo"></i>
                </button>
                <button onclick="supprimerClientPerdu('${prenom}', '${nom}', '${client.telephone || ''}')" title="Supprimer" style="background: rgba(239, 68, 68, 0.15); color: #ef4444; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.15)'">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `}).join('');

        // R√©initialiser l'affichage mobile apr√®s chargement des donn√©es
        if (window.innerWidth <= 600) {
          resetMobileDisplay('perdus-modal-tbody');
        }
      }
    }

    function filtrerClientsPerdus(searchTerm) {
      if (!searchTerm || searchTerm.trim() === '') {
        afficherClientsPerdus(allClientsPerdus);
        return;
      }

      const term = searchTerm.toLowerCase().trim();
      const filtered = allClientsPerdus.filter(client => {
        const prenom = client.prenom || client.clientPrenom || '';
        const nomClient = client.nom || client.clientNom || '';
        const nom = `${prenom} ${nomClient}`.toLowerCase();
        const telephone = (client.telephone || '').toLowerCase();
        const adresse = (client.adresse || '').toLowerCase();
        const prix = (client.prix || '').toString().toLowerCase();
        return nom.includes(term) || telephone.includes(term) || adresse.includes(term) || prix.includes(term);
      });

      afficherClientsPerdus(filtered);
    }

    // Fonction pour afficher les d√©tails d'un client perdu dans un popup
    window.showClientPerduDetails = function(index) {
      const clientData = window.clientsPerdusData[index];
      if (!clientData) {
        error('[VENTES] Client perdu introuvable');
        return;
      }

      const modal = document.getElementById('clientInfoModal');
      const content = document.getElementById('clientInfoContent');
      const modalHeader = modal.querySelector('.flex.items-center.justify-between');

      if (!modal || !content) return;

      // Header simple
      modalHeader.innerHTML = `
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-user mr-2" style="color: var(--primary-blue);"></i>
          Client perdu
        </h3>
        <button onclick="closeClientInfo()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);" onmouseover="this.style.background='rgba(96, 165, 250, 0.3)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      `;

      const prenom = clientData.prenom || clientData.clientPrenom || '-';
      const nom = clientData.nom || clientData.clientNom || '-';
      const telephone = clientData.telephone || '-';
      const adresse = clientData.adresse || '-';
      const courriel = clientData.courriel || clientData.email || '-';
      const prixRaw = clientData.prix || '-';
      const prix = formatPrix(prixRaw);
      const clientId = clientData.id || `${prenom}_${nom}_${telephone}`;

      // Clean phone number for tel: link
      const telNumber = telephone.replace(/\D/g, '');

      let html = `
        <div style="background: rgba(30, 41, 59, 0.5); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
          <!-- Nom complet -->
          <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
            <i class="fas fa-user" style="color: var(--primary-blue); width: 20px; text-align: center;"></i>
            <div style="flex: 1;">
              <div style="font-size: 0.75rem; color: var(--text-gray); margin-bottom: 0.25rem;">Nom complet</div>
              <div style="color: var(--text-light); font-weight: 500;">${prenom} ${nom}</div>
            </div>
          </div>

          <!-- T√©l√©phone cliquable -->
          ${telephone !== '-' ? `
          <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
            <i class="fas fa-phone" style="color: var(--primary-blue); width: 20px; text-align: center;"></i>
            <div style="flex: 1;">
              <div style="font-size: 0.75rem; color: var(--text-gray); margin-bottom: 0.25rem;">T√©l√©phone</div>
              <a href="tel:${telNumber}" style="color: var(--primary-blue); text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                <span style="font-weight: 500;">${telephone}</span>
              </a>
            </div>
          </div>
          ` : ''}

          <!-- Adresse cliquable -->
          ${adresse !== '-' ? `
          <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
            <i class="fas fa-map-marker-alt" style="color: var(--primary-blue); width: 20px; text-align: center;"></i>
            <div style="flex: 1;">
              <div style="font-size: 0.75rem; color: var(--text-gray); margin-bottom: 0.25rem;">Adresse</div>
              <a href="javascript:void(0)" onclick="ouvrirMapsModal('${adresse.replace(/'/g, "\\'")}')" style="color: var(--primary-blue); text-decoration: none; transition: opacity 0.2s; cursor: pointer;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                <span style="font-weight: 500;">${adresse}</span>
              </a>
            </div>
          </div>
          ` : ''}

          <!-- Courriel cliquable -->
          ${courriel !== '-' ? `
          <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(71, 85, 105, 0.3);">
            <i class="fas fa-envelope" style="color: var(--primary-blue); width: 20px; text-align: center;"></i>
            <div style="flex: 1;">
              <div style="font-size: 0.75rem; color: var(--text-gray); margin-bottom: 0.25rem;">Courriel</div>
              <a href="mailto:${courriel}" style="color: var(--primary-blue); text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                <span style="font-weight: 500;">${courriel}</span>
              </a>
            </div>
          </div>
          ` : ''}

          <!-- Prix -->
          ${prix !== '-' ? `
          <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0;">
            <i class="fas fa-dollar-sign" style="color: #10b981; width: 20px; text-align: center;"></i>
            <div style="flex: 1;">
              <div style="font-size: 0.75rem; color: var(--text-gray); margin-bottom: 0.25rem;">Prix</div>
              <div style="color: #10b981; font-weight: 600; font-size: 1.125rem;">${prix}</div>
            </div>
          </div>
          ` : ''}
        </div>

        <div class="pt-4">
          <!-- Boutons d'action -->
          <div class="flex justify-end space-x-3">
            <button onclick="recupererClientPerdu(${index}); closeClientInfo();" class="btn-secondary btn-action-mobile px-4 py-2 rounded-lg relative overflow-hidden" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">
              <i class="fas fa-undo mr-2"></i>R√©cup√©rer
            </button>
            <button onclick="supprimerClientPerdu(${index}); closeClientInfo();" class="btn-secondary btn-action-mobile px-4 py-2 rounded-lg relative overflow-hidden" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">
              <i class="fas fa-trash mr-2"></i>Supprimer
            </button>
          </div>
        </div>
      `;

      content.innerHTML = html;

      // Bloquer le scroll en arri√®re-plan
      document.body.style.overflow = 'hidden';

      modal.style.display = 'flex';
    };

  </script>

  <!-- Script pour gestion menu actif -->
  <script>
    // Fonction pour activer le menu bas√© sur la page actuelle
    function activateCurrentPageMenu() {
      const currentPath = window.location.pathname;
      log('üåê Page actuelle d√©tect√©e:', currentPath);
      
      const allMenuLinks = document.querySelectorAll('#sidebar a');
      allMenuLinks.forEach(link => {
        link.classList.remove('menu-active');
        link.removeAttribute('data-menu-state');
      });
      
      const pageMap = {
        '/dashboard': '/dashboard',
        '/centralevue': '/centralevue', 
        '/calcul': '/calcul',
        '/soumissions': '/soumissions',
        '/gqp': '/gqp',
        '/travaux': '/travaux',
        '/facture': '/facture',
        '/avis': '/avis',
        '/centrale': '/centrale',
        '/dashboardcoach': '/dashboardcoach'
      };
      
      const targetPath = pageMap[currentPath];
      let targetLink = null;
      
      if (targetPath) {
        targetLink = document.querySelector(`#sidebar a[data-path="${targetPath}"]`);
        log('[TARGET] Page d√©tect√©e - activation du menu pour:', targetPath);
      }
      
      if (targetLink) {
        targetLink.classList.add('menu-active');
        targetLink.setAttribute('data-menu-state', 'active');
        log('[OK] Menu activ√© pour:', targetLink.textContent.trim());
      } else {
        log('[WARN] Aucun menu trouv√© pour la page:', currentPath);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      activateCurrentPageMenu();
      setTimeout(activateCurrentPageMenu, 150);
      setTimeout(activateCurrentPageMenu, 300);
    });

    // Fonctions utilitaires pour le loading des badges
    function showBadgeLoading(badgeElement) {
      if (badgeElement) {
        badgeElement.classList.add('badge-loading');
        badgeElement.style.pointerEvents = 'none';
      }
    }

    function hideBadgeLoading(badgeElement) {
      if (badgeElement) {
        badgeElement.classList.remove('badge-loading');
        badgeElement.style.pointerEvents = '';
      }
    }

    function findBadgeByVenteId(venteId, badgeClass) {
      return document.querySelector(`.${badgeClass}[data-vente-id="${venteId}"]`);
    }

    // Menu mobile functions - EXACT COPY from newgqp
    function setupMobileMenu() {
      const mobileToggle = document.getElementById('mobile-menu-toggle');
      const mobileAccountBtn = document.getElementById('mobile-account-menu-button');
      const mobileAccountDropdown = document.getElementById('mobile-account-dropdown');
      
      if (mobileToggle) {
        mobileToggle.addEventListener('click', toggleMobileMenu);
      }
      
      if (mobileAccountBtn && mobileAccountDropdown) {
        mobileAccountBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          mobileAccountDropdown.classList.toggle('hidden');
        });
      }
    }

    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.mobile-overlay');
      
      sidebar.classList.toggle('mobile-open');
      overlay.classList.toggle('active');
    }

    window.closeMobileMenu = function() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.mobile-overlay');

      if (sidebar) {
        sidebar.classList.remove('mobile-open');
      }
      if (overlay) {
        overlay.classList.remove('active');
      }
    }

    // Account dropdown functionality - EXACT COPY from newgqp
    document.addEventListener('DOMContentLoaded', function() {
      const btn = document.getElementById("account-dropdown-toggle");
      const dropdown = document.getElementById("account-dropdown");

      log('[DEBUG] Bouton account trouv√©:', btn);
      log('[DEBUG] Dropdown trouv√©:', dropdown);

      if (btn && dropdown) {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          log('üëÜ Click sur account button');
          
          if (dropdown.classList.contains("hidden")) {
            dropdown.classList.remove("hidden");
            dropdown.style.display = 'block';
            dropdown.style.visibility = 'visible';
            log('[UNLOCK] Dropdown ouvert');
          } else {
            dropdown.classList.add("hidden");
            dropdown.style.display = 'none';
            log('[LOCK] Dropdown ferm√©');
          }
        });

        document.addEventListener("click", (e) => {
          if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add("hidden");
          }
        });
      }

      // Setup mobile menu
      setupMobileMenu();
    });
  </script>

  <!-- Initialiser window.username AVANT common.js pour √©viter la redirection -->
  <script>
  (function() {
    const urlParams = new URLSearchParams(window.location.search);
    const userParam = urlParams.get('user');
    if (userParam) {
      window.username = userParam;
      log('[VENTES INIT] window.username initialis√© depuis URL:', userParam);
    }
  })();
  </script>

  <!-- Script commun de gestion des permissions et interface -->
  <script src="/common.js"></script>

  <!-- Inline entrepreneur selector script removed - now handled by shared /entrepreneur-selector.js -->

<!-- Styles pour Google Places Autocomplete -->
<!-- Styles sp√©cifiques √† Ventes -->

<!-- Google Places API et Autocompl√©tion Adresse -->
<script>
  // Variable globale pour tracker si une adresse Google a √©t√© s√©lectionn√©e
  window.googleProspectAddressSelected = false;

  window.initProspectAutocomplete = function() {
    const input = document.getElementById('prospectAdresse');
    if (!input) return;

    // Forcer la d√©sactivation de l'autocomplete navigateur
    input.setAttribute('autocomplete', 'new-password');
    input.setAttribute('autocorrect', 'off');
    input.setAttribute('autocapitalize', 'off');
    input.setAttribute('spellcheck', 'false');

    const autocomplete = new google.maps.places.Autocomplete(input, {
      types: ['address'],
      componentRestrictions: { country: 'ca' }
    });

    // Reset flag when user types manually
    input.addEventListener('input', () => {
      window.googleProspectAddressSelected = false;
      // R√©appliquer les attributs anti-autocomplete
      input.setAttribute('autocomplete', 'new-password');
    });

    // Supprimer l'autocomplete navigateur sur focus
    input.addEventListener('focus', () => {
      input.setAttribute('autocomplete', 'new-password');
      input.removeAttribute('readonly');
    });

    autocomplete.addListener('place_changed', () => {
      const place = autocomplete.getPlace();
      if (!place.geometry) {
        log("Adresse invalide");
        window.googleProspectAddressSelected = false;
        return;
      }

      // Marquer qu'une adresse Google a √©t√© s√©lectionn√©e
      window.googleProspectAddressSelected = true;

      const components = place.address_components;
      let streetNumber = '';
      let route = '';
      let city = '';
      let province = '';
      let postalCode = '';

      components.forEach(component => {
        const types = component.types;

        if (types.includes('street_number')) {
          streetNumber = component.long_name;
        }
        if (types.includes('route')) {
          route = component.long_name;
        }
        if (types.includes('locality')) {
          city = component.long_name;
        }
        if (types.includes('administrative_area_level_1')) {
          province = component.short_name;
        }
        if (types.includes('postal_code')) {
          postalCode = component.long_name;
        }
      });

      const fullAddress = `${streetNumber} ${route}, ${city}, ${province} ${postalCode}`;
      input.value = fullAddress.trim();
    });
  };

  // Fonction globale pour r√©initialiser l'affichage mobile
  function resetMobileDisplay(tableId) {
    const tbody = document.getElementById(tableId);
    if (!tbody) return;

    const rows = tbody.getElementsByTagName('tr');
    const isMobile = window.innerWidth <= 600;

    Array.from(rows).forEach(row => {
      if (!row.querySelector('.empty-state')) {
        // Sur mobile forcer flex, sur desktop supprimer le style
        if (isMobile) {
          row.style.display = 'flex';
        } else {
          row.style.display = '';
        }
      }
    });
  }

  // Fonctions de recherche pour les tables
  function setupTableSearch(searchInputId, tableId) {
    const searchInput = document.getElementById(searchInputId);
    const tbody = document.getElementById(tableId);

    if (!searchInput || !tbody) return;

    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase().trim();
      const rows = tbody.getElementsByTagName('tr');
      const isMobile = window.innerWidth <= 600;

      Array.from(rows).forEach(row => {
        // Ignorer les lignes "empty-state"
        if (row.querySelector('.empty-state')) {
          return;
        }

        const cells = row.getElementsByTagName('td');
        let found = false;

        // Si pas de terme de recherche, afficher toutes les lignes
        if (searchTerm === '') {
          found = true;
        } else {
          // Rechercher dans toutes les cellules (nom, t√©l√©phone, adresse, prix, paiement)
          Array.from(cells).forEach(cell => {
            const text = cell.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
              found = true;
            }
          });
        }

        // Afficher ou cacher la ligne selon le r√©sultat
        if (found) {
          // Sur mobile forcer flex, sur desktop laisser le CSS d√©cider
          if (isMobile) {
            row.style.display = 'flex';
          } else {
            row.style.display = '';
          }
        } else {
          row.style.display = 'none';
        }
      });
    });
  }

  // Initialiser la recherche pour toutes les tables apr√®s le chargement de la page
  document.addEventListener('DOMContentLoaded', function() {
    // Attendre un peu pour s'assurer que les tables sont charg√©es
    setTimeout(function() {
      setupTableSearch('searchPotentiel', 'potentiel-tbody');
      setupTableSearch('searchAttente', 'attente-tbody');
      setupTableSearch('searchAccepte', 'accepte-tbody');
      setupTableSearch('searchProduit', 'produit-tbody');
    }, 500);
  });
</script>

  <!-- Modaux pour gestion sections -->
  <div id="sectionModal" class="modal-overlay-opaque" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
      <h3 class="modal-title">
        <i class="fas fa-icons mr-2"></i>
        Choisir une ic√¥ne
      </h3>
      <div class="modal-body">
        <div id="iconGrid" class="icon-grid"></div>
      </div>
      <div class="modal-footer">
        <button id="sectionCancel" class="btn-secondary">Annuler</button>
        <button id="sectionSave" class="btn-primary">Enregistrer</button>
      </div>
    </div>
  </div>

  <div id="columnModal" class="modal-overlay-opaque" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <h3 class="modal-title">
        <i class="fas fa-columns mr-2"></i>
        Ajouter une colonne
      </h3>
      <div class="modal-body">
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">S√©lectionnez le type de colonne :</p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="column-type-card" data-type="texte">
            <i class="fas fa-font" style="font-size: 2rem; color: var(--primary-blue); margin-bottom: 0.75rem;"></i>
            <h4 style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Texte</h4>
            <p style="font-size: 0.75rem; color: var(--text-secondary);">Champ texte</p>
          </div>
          <div class="column-type-card" data-type="numero">
            <i class="fas fa-hashtag" style="font-size: 2rem; color: var(--primary-blue); margin-bottom: 0.75rem;"></i>
            <h4 style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Num√©ro</h4>
            <p style="font-size: 0.75rem; color: var(--text-secondary);">Montant/Num√©ro</p>
          </div>
          <div class="column-type-card" data-type="date">
            <i class="fas fa-calendar" style="font-size: 2rem; color: var(--primary-blue); margin-bottom: 0.75rem;"></i>
            <h4 style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Date</h4>
            <p style="font-size: 0.75rem; color: var(--text-secondary);">Date projet</p>
          </div>
          <div class="column-type-card" data-type="statut">
            <i class="fas fa-tag" style="font-size: 2rem; color: var(--primary-blue); margin-bottom: 0.75rem;"></i>
            <h4 style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Statut</h4>
            <p style="font-size: 0.75rem; color: var(--text-secondary);">√âtat projet</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="columnCancel" class="btn-secondary">Annuler</button>
        <button id="columnSave" class="btn-primary">Ajouter</button>
      </div>
    </div>
  </div>

  <div id="confirmModal" class="modal-overlay-opaque" style="display: none;">
    <div class="modal-content" style="max-width: 450px;">
      <h3 class="modal-title" id="confirmTitle">
        <i class="fas fa-exclamation-triangle mr-2" style="color: #f59e0b;"></i>
        Confirmation
      </h3>
      <div class="modal-body">
        <p id="confirmMessage" style="color: var(--text-secondary);"></p>
      </div>
      <div class="modal-footer">
        <button id="confirmCancel" class="btn-secondary">Annuler</button>
        <button id="confirmOk" class="btn-primary" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">Confirmer</button>
      </div>
    </div>
  </div>

  <div id="alertModal" class="modal-overlay-opaque" style="display: none;">
    <div class="modal-content" style="max-width: 450px;">
      <h3 class="modal-title" id="alertTitle">
        <i class="fas fa-info-circle mr-2"></i>
        Information
      </h3>
      <div class="modal-body">
        <p id="alertMessage" style="color: var(--text-secondary);"></p>
      </div>
      <div class="modal-footer">
        <button id="alertOk" class="btn-primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Modal confirmation marquer comme perdu -->
  <div id="perduConfirmModal" class="modal-overlay-opaque" style="display: none;">
    <div class="modal-content" style="max-width: 450px;">
      <h3 class="modal-title">
        <i class="fas fa-exclamation-triangle mr-2" style="color: #ef4444;"></i>
        Confirmer
      </h3>
      <div class="modal-body">
        <p id="perduConfirmMessage" style="color: var(--text-secondary); font-size: 1rem; line-height: 1.5;"></p>
      </div>
      <div class="modal-footer">
        <button id="perduConfirmCancel" class="btn-secondary">Annuler</button>
        <button id="perduConfirmOk" class="btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
          <i class="fas fa-times-circle mr-2"></i>Marquer comme perdu
        </button>
      </div>
    </div>
  </div>

  <!-- Modal succ√®s -->
  <div id="perduSuccessModal" class="modal-overlay-opaque" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
      <h3 class="modal-title">
        <i class="fas fa-check-circle mr-2" style="color: #10b981;"></i>
        Succ√®s
      </h3>
      <div class="modal-body">
        <p id="perduSuccessMessage" style="color: var(--text-secondary); font-size: 1rem; line-height: 1.5;"></p>
      </div>
      <div class="modal-footer">
        <button id="perduSuccessOk" class="btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">OK</button>
      </div>
    </div>
  </div>

  <!-- Modal erreur -->
  <div id="perduErrorModal" class="modal-overlay-opaque" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
      <h3 class="modal-title">
        <i class="fas fa-times-circle mr-2" style="color: #ef4444;"></i>
        Erreur
      </h3>
      <div class="modal-body">
        <p id="perduErrorMessage" style="color: var(--text-secondary); font-size: 1rem; line-height: 1.5;"></p>
      </div>
      <div class="modal-footer">
        <button id="perduErrorOk" class="btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">OK</button>
      </div>
    </div>
  </div>

  <!-- JavaScript sections management -->
  <!-- <script src="/Ventes_sections.js"></script> -->

<script>
  // Initialisation imm√©diate des fonctions globales
  log('[VENTES] üöÄ Initialisation des fonctions de paiement...');

  // Create payment status badge (Monday.com style) - Fonction globale
  window.createPaymentBadge = function(statut, venteId, category) {
    if (!statut || statut === '-') {
      return '<span style="color: var(--text-gray);">-</span>';
    }

    let bgColor, textColor, label;

    // Normalize status text
    const statutLower = statut.toLowerCase();

    if (statutLower.includes('final') && (statutLower.includes('re√ßu') || statutLower.includes('recu'))) {
      // Paiement final re√ßu - Vert
      bgColor = '#00c875';
      textColor = '#fff';
      label = 'Paiement final re√ßu';
    } else if (statutLower.includes('d√©p√¥t') || statutLower.includes('depot')) {
      // D√©p√¥t re√ßu - Orange
      bgColor = '#fdab3d';
      textColor = '#fff';
      label = 'D√©p√¥t re√ßu';
    } else {
      // Par d√©faut: En attente - Rouge
      bgColor = '#e2445c';
      textColor = '#fff';
      label = 'En attente';
    }

    // Utiliser data attributes au lieu de onclick inline pour √©viter les probl√®mes de timing
    return `<span
      class="payment-status-badge"
      data-vente-id="${venteId}"
      data-current-statut="${label}"
      data-category="${category}"
      style="
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      background-color: ${bgColor};
      color: ${textColor};
      font-size: 0.875rem;
      font-weight: 500;
      white-space: nowrap;
      cursor: pointer;
      transition: opacity 0.2s;
    "
    onmouseover="this.style.opacity='0.8'"
    onmouseout="this.style.opacity='1'"
    >${label}</span>`;
  }

  // Change payment status - Fonction globale
  window.changerStatutPaiement = function(venteId, currentStatut, category, event) {
    // Prevent event bubbling
    if (event) {
      event.stopPropagation();
    }

    log(`[VENTES] üîµ Ouverture dropdown paiement - ID: ${venteId}, Statut: ${currentStatut}, Cat√©gorie: ${category}`);

    // Fermer tous les dropdowns
    closeAllDropdowns();

    // Create dropdown menu
    const dropdown = document.createElement('div');
    dropdown.id = 'payment-status-dropdown';
    dropdown.style.cssText = `
      position: fixed;
      background: #1e293b;
      border: 2px solid var(--border-dark);
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      z-index: 10001;
      min-width: 200px;
      overflow: hidden;
    `;

    // Status options with Monday.com colors
    const statuts = [
      { label: 'En attente', color: '#e2445c', textColor: '#fff' },
      { label: 'D√©p√¥t re√ßu', color: '#fdab3d', textColor: '#fff' },
      { label: 'Paiement final re√ßu', color: '#00c875', textColor: '#fff' }
    ];

    // Create options
    statuts.forEach(statut => {
      const option = document.createElement('div');
      option.style.cssText = `
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        transition: background 0.2s;
      `;

      // Add color badge preview
      const badge = document.createElement('span');
      badge.style.cssText = `
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: ${statut.color};
      `;

      const label = document.createElement('span');
      label.textContent = statut.label;
      label.style.cssText = `
        color: var(--text-light);
        font-size: 14px;
        flex: 1;
      `;

      // Add checkmark if current status
      if (statut.label === currentStatut) {
        const checkmark = document.createElement('i');
        checkmark.className = 'fas fa-check';
        checkmark.style.cssText = 'color: var(--primary-blue); font-size: 12px;';
        option.appendChild(checkmark);
      }

      option.appendChild(badge);
      option.appendChild(label);

      // Hover effect
      option.addEventListener('mouseenter', () => {
        option.style.background = 'rgba(59, 130, 246, 0.15)';
      });
      option.addEventListener('mouseleave', () => {
        option.style.background = 'transparent';
      });

      // Click handler
      option.addEventListener('click', async () => {
        if (statut.label !== currentStatut) {
          log(`[VENTES] üí∞ Changement statut paiement - ID: ${venteId}, ${currentStatut} ‚Üí ${statut.label}, Cat√©gorie: ${category}`);

          // Save to backend - use the category passed as parameter
          try {
            const response = await fetch('/ventes/update-statut-paiement', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                username: window.username,
                id: venteId,
                statut: statut.label,
                category: category
              })
            });

            if (response.ok) {
              log('[VENTES] ‚úÖ Statut paiement sauvegard√© avec succ√®s');
              // Reload data to show updated status
              await loadVentesDataInternal();
            } else {
              const errorText = await response.text();
              error('[VENTES] ‚ùå Erreur sauvegarde statut:', errorText);
              alert(`Erreur lors de la sauvegarde: ${errorText}`);
            }
          } catch (err) {
            error('[VENTES] ‚ùå Erreur r√©seau:', err);
            alert('Erreur r√©seau lors de la mise √† jour du statut');
          }
        }
        dropdown.remove();
      });

      dropdown.appendChild(option);
    });

    // Position dropdown near the clicked badge
    document.body.appendChild(dropdown);

    // Get click position from event if available, otherwise center
    if (event && event.target) {
      const rect = event.target.getBoundingClientRect();
      dropdown.style.top = `${rect.bottom + 5}px`;
      dropdown.style.left = `${rect.left}px`;
    } else {
      // Fallback: center of screen
      dropdown.style.top = '50%';
      dropdown.style.left = '50%';
      dropdown.style.transform = 'translate(-50%, -50%)';
    }

    // Close dropdown when clicking outside
    setTimeout(() => {
      document.addEventListener('click', function closeDropdown() {
        dropdown.remove();
        document.removeEventListener('click', closeDropdown);
      });
    }, 100);
  };

  // Confirmation que les fonctions sont charg√©es
  log('[VENTES] ‚úÖ Fonctions de paiement charg√©es:', {
    createPaymentBadge: typeof window.createPaymentBadge,
    changerStatutPaiement: typeof window.changerStatutPaiement
  });

  // D√âL√âGATION D'√âV√âNEMENTS - √âcouter les clics sur tous les badges de paiement
  // Utiliser capture phase pour s'assurer que √ßa fonctionne m√™me avec stopPropagation
  document.addEventListener('click', function(event) {
    // V√©rifier si le clic est sur un badge de paiement
    const badge = event.target.closest('.payment-status-badge');
    if (badge) {
      event.stopPropagation();
      const venteId = badge.getAttribute('data-vente-id');
      const currentStatut = badge.getAttribute('data-current-statut');
      const category = badge.getAttribute('data-category');

      log('[VENTES] üéØ Clic sur badge paiement d√©tect√©:', { venteId, currentStatut, category });

      if (venteId && currentStatut && category) {
        window.changerStatutPaiement(venteId, currentStatut, category, event);
      } else {
        error('[VENTES] ‚ùå Donn√©es manquantes sur le badge:', { venteId, currentStatut, category });
      }
    }
  }, true); // true = capture phase

  log('[VENTES] üéØ D√©l√©gation d\'√©v√©nements activ√©e pour les badges de paiement');

  // ===============================
  // FONCTIONS POUR NOUVEAUX BADGES
  // ===============================

  // Variable globale pour stocker les √©tiquettes personnalis√©es (vides par d√©faut)
  window.etiquettesPersonnalisees = {
    statuts: [],
    provenances: [],
    types_travaux: [],
    paiements: [],
    etiquettes: [
      { label: '√Ä confirmer', color: '#ef4444' },
      { label: 'Confirm√©', color: '#22c55e' },
      { label: '√Ä rappeler', color: '#f59e0b' }
    ]
  };

  // Charger les √©tiquettes personnalis√©es de l'entrepreneur
  async function chargerEtiquettesPersonnalisees() {
    try {
      const response = await fetch(`/api/ventes/etiquettes/${window.username}`);
      if (response.ok) {
        const etiquettes = await response.json();
        // S'assurer que tous les champs existent
        window.etiquettesPersonnalisees = {
          statuts: etiquettes.statuts || [],
          provenances: etiquettes.provenances || [],
          types_travaux: etiquettes.types_travaux || [],
          paiements: etiquettes.paiements || [],
          etiquettes: etiquettes.etiquettes || [
            { label: '√Ä confirmer', color: '#ef4444' },
            { label: 'Confirm√©', color: '#22c55e' },
            { label: '√Ä rappeler', color: '#f59e0b' }
          ]
        };
        log('[VENTES] √âtiquettes personnalis√©es charg√©es:', window.etiquettesPersonnalisees);
      }
    } catch (err) {
      error('[VENTES] Erreur chargement √©tiquettes:', err);
    }
  }

  // Charger les √©tiquettes au d√©marrage
  chargerEtiquettesPersonnalisees();

  // Fonction globale pour g√©rer les tooltips personnalis√©s
  window.customTooltip = {
    element: null,

    show: function(text, targetElement) {
      // Cr√©er le tooltip s'il n'existe pas
      if (!this.element) {
        this.element = document.createElement('div');
        this.element.style.cssText = `
          position: fixed;
          background: #1e293b;
          color: #e2e8f0;
          padding: 8px 12px;
          border-radius: 6px;
          font-size: 0.875rem;
          font-weight: 500;
          z-index: 10002;
          pointer-events: none;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
          border: 1px solid rgba(96, 165, 250, 0.3);
          opacity: 0;
          transition: opacity 0.2s;
        `;
        document.body.appendChild(this.element);
      }

      // Mettre √† jour le texte
      this.element.textContent = text;

      // Positionner le tooltip
      const rect = targetElement.getBoundingClientRect();
      const tooltipRect = this.element.getBoundingClientRect();

      // Position au-dessus de l'√©l√©ment, centr√© horizontalement
      let top = rect.top + window.scrollY - tooltipRect.height - 8;
      let left = rect.left + window.scrollX + (rect.width / 2) - (tooltipRect.width / 2);

      // S'assurer que le tooltip reste dans le viewport (√©cran)
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;

      // Emp√™cher le d√©bordement horizontal
      if (left < 10) {
        left = 10;
      } else if (left + tooltipRect.width > viewportWidth - 10) {
        left = viewportWidth - tooltipRect.width - 10;
      }

      // Si pas assez d'espace en haut, positionner en dessous
      if (rect.top - tooltipRect.height - 8 < 0) {
        top = rect.bottom + window.scrollY + 8;
      }

      this.element.style.top = `${top}px`;
      this.element.style.left = `${left}px`;

      // Afficher le tooltip
      setTimeout(() => {
        if (this.element) this.element.style.opacity = '1';
      }, 50);
    },

    hide: function() {
      if (this.element) {
        this.element.style.opacity = '0';
        setTimeout(() => {
          if (this.element && this.element.parentNode) {
            this.element.parentNode.removeChild(this.element);
            this.element = null;
          }
        }, 200);
      }
    }
  };

  // Create statut badge
  window.createStatutBadge = function(statut, venteId, category) {
    // Si pas de statut ou vide, afficher badge gris vide (sans texte)
    if (!statut || statut === '-' || statut === '√Ä traiter' || statut.trim() === '') {
      return `<span
        class="statut-vente-badge"
        data-vente-id="${venteId}"
        data-current-statut=""
        data-category="${category}"
        style="
          display: block;
          width: 100%;
          height: 28px;
          border-radius: 4px;
          background-color: #cbd5e1;
          border: 1px solid #94a3b8;
          cursor: pointer;
          transition: all 0.2s;
        "
        onmouseover="this.style.backgroundColor='#94a3b8'"
        onmouseout="this.style.backgroundColor='#cbd5e1'"
        title="Cliquer pour modifier"
      ></span>`;
    }

    // Chercher la couleur personnalis√©e de l'√©tiquette
    let bgColor = '#3b82f6'; // Couleur par d√©faut
    const etiquetteObj = window.etiquettesPersonnalisees?.statuts?.find(item =>
      (typeof item === 'string' ? item : item.label) === statut
    );
    if (etiquetteObj && typeof etiquetteObj === 'object' && etiquetteObj.color) {
      bgColor = etiquetteObj.color;
    } else if (!etiquetteObj) {
      // Fallback sur les anciennes couleurs bas√©es sur le texte
      const statutLower = statut.toLowerCase();
      if (statutLower.includes('termin√©') || statutLower.includes('termine')) {
        bgColor = '#00c875';
      } else if (statutLower.includes('en cours')) {
        bgColor = '#fdab3d';
      } else {
        bgColor = '#e2445c';
      }
    }

    return `<span
      class="statut-vente-badge"
      data-vente-id="${venteId}"
      data-current-statut="${statut}"
      data-category="${category}"
      data-tooltip="${statut}"
      style="
        display: block;
        padding: 4px 12px;
        border-radius: 4px;
        background-color: ${bgColor};
        color: #fff;
        font-size: 0.875rem;
        font-weight: 500;
        white-space: nowrap;
        cursor: pointer;
        transition: opacity 0.2s;
        width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
      "
      onmouseenter="this.style.opacity='0.8'; window.customTooltip.show(this.getAttribute('data-tooltip'), this);"
      onmouseleave="this.style.opacity='1'; window.customTooltip.hide();"
    >${statut}</span>`;
  };

  // Create provenance badge
  window.createProvenanceBadge = function(provenance, venteId, category) {
    // Si pas de provenance ou vide, afficher badge gris vide (sans texte)
    if (!provenance || provenance === '-' || provenance === 'Non d√©finie' || provenance.trim() === '') {
      return `<span
        class="provenance-badge"
        data-vente-id="${venteId}"
        data-current-provenance=""
        data-category="${category}"
        style="
          display: block;
          width: 100%;
          height: 28px;
          border-radius: 4px;
          background-color: #cbd5e1;
          border: 1px solid #94a3b8;
          cursor: pointer;
          transition: all 0.2s;
        "
        onmouseover="this.style.backgroundColor='#94a3b8'"
        onmouseout="this.style.backgroundColor='#cbd5e1'"
        title="Cliquer pour modifier"
      ></span>`;
    }

    // Chercher la couleur personnalis√©e de l'√©tiquette
    let bgColor = '#0891b2'; // Couleur par d√©faut
    const etiquetteObj = window.etiquettesPersonnalisees?.provenances?.find(item =>
      (typeof item === 'string' ? item : item.label) === provenance
    );
    if (etiquetteObj && typeof etiquetteObj === 'object' && etiquetteObj.color) {
      bgColor = etiquetteObj.color;
    }

    return `<span
      class="provenance-badge"
      data-vente-id="${venteId}"
      data-current-provenance="${provenance}"
      data-category="${category}"
      data-tooltip="${provenance}"
      style="
        display: block;
        padding: 4px 12px;
        border-radius: 4px;
        background-color: ${bgColor};
        color: #fff;
        font-size: 0.875rem;
        font-weight: 500;
        white-space: nowrap;
        cursor: pointer;
        transition: opacity 0.2s;
        width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
      "
      onmouseenter="this.style.opacity='0.8'; window.customTooltip.show(this.getAttribute('data-tooltip'), this);"
      onmouseleave="this.style.opacity='1'; window.customTooltip.hide();"
    >${provenance}</span>`;
  };

  // Create type travaux badge
  window.createTypeTravauxBadge = function(typeTravaux, venteId, category) {
    // Si pas de type travaux ou vide, afficher badge gris vide (sans texte)
    if (!typeTravaux || typeTravaux === '-' || typeTravaux === 'Non d√©fini' || typeTravaux.trim() === '') {
      return `<span
        class="type-travaux-badge"
        data-vente-id="${venteId}"
        data-current-type=""
        data-category="${category}"
        style="
          display: block;
          width: 100%;
          height: 28px;
          border-radius: 4px;
          background-color: #cbd5e1;
          border: 1px solid #94a3b8;
          cursor: pointer;
          transition: all 0.2s;
        "
        onmouseover="this.style.backgroundColor='#94a3b8'"
        onmouseout="this.style.backgroundColor='#cbd5e1'"
        title="Cliquer pour modifier"
      ></span>`;
    }

    // Chercher la couleur personnalis√©e de l'√©tiquette
    let bgColor = '#8b5cf6'; // Couleur par d√©faut
    const etiquetteObj = window.etiquettesPersonnalisees?.types_travaux?.find(item =>
      (typeof item === 'string' ? item : item.label) === typeTravaux
    );
    if (etiquetteObj && typeof etiquetteObj === 'object' && etiquetteObj.color) {
      bgColor = etiquetteObj.color;
    }

    return `<span
      class="type-travaux-badge"
      data-vente-id="${venteId}"
      data-current-type="${typeTravaux}"
      data-category="${category}"
      data-tooltip="${typeTravaux}"
      style="
        display: block;
        padding: 4px 12px;
        border-radius: 4px;
        background-color: ${bgColor};
        color: #fff;
        font-size: 0.875rem;
        font-weight: 500;
        white-space: nowrap;
        cursor: pointer;
        transition: opacity 0.2s;
        width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
      "
      onmouseenter="this.style.opacity='0.8'; window.customTooltip.show(this.getAttribute('data-tooltip'), this);"
      onmouseleave="this.style.opacity='1'; window.customTooltip.hide();"
    >${typeTravaux}</span>`;
  };

  // Create paiement badge (syst√®me d'√©tiquettes personnalisables)
  window.createPaiementBadge = function(paiement, venteId, category) {
    // Si pas de paiement ou vide, utiliser "En attente" par d√©faut
    if (!paiement || paiement === '-' || paiement.trim() === '') {
      paiement = 'En attente';
    }

    // Chercher la couleur personnalis√©e de l'√©tiquette
    let bgColor = '#e2445c'; // Couleur par d√©faut (rouge)
    const etiquetteObj = window.etiquettesPersonnalisees?.paiements?.find(item =>
      (typeof item === 'string' ? item : item.label) === paiement
    );
    if (etiquetteObj && typeof etiquetteObj === 'object' && etiquetteObj.color) {
      bgColor = etiquetteObj.color;
    }

    return `<span
      class="paiement-badge"
      data-vente-id="${venteId}"
      data-current-paiement="${paiement}"
      data-category="${category}"
      data-tooltip="${paiement}"
      style="
        display: block;
        padding: 4px 12px;
        border-radius: 4px;
        background-color: ${bgColor};
        color: #fff;
        font-size: 0.875rem;
        font-weight: 500;
        white-space: nowrap;
        cursor: pointer;
        transition: opacity 0.2s;
        width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
      "
      onmouseenter="this.style.opacity='0.8'; window.customTooltip.show(this.getAttribute('data-tooltip'), this);"
      onmouseleave="this.style.opacity='1'; window.customTooltip.hide();"
    >${paiement}</span>`;
  };

  // Create paiement progress bar (barre de progression pour accept√©es et produit)
  // Bas√© sur montant pay√© vs total avec taxes
  // Vert = trait√© (compl√©t√©), Orange = en traitement (en cours)
  window.createPaiementProgressBar = function(statutClient, prixAvantTaxes) {
    let percentageTraite = 0;      // Vert - paiements compl√©t√©s
    let percentageEnTraitement = 0; // Orange - paiements en cours
    let statusText = 'En attente';

    if (statutClient && prixAvantTaxes) {
      // Calculer le total avec taxes (TPS 5% + TVQ 9.975%)
      const prixNum = parseFloat(String(prixAvantTaxes).replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
      const totalAvecTaxes = prixNum * 1.14975;

      let montantTraite = 0;       // Paiements compl√©t√©s (vert)
      let montantEnTraitement = 0; // Paiements en cours (orange)

      // Statuts consid√©r√©s comme "trait√©" (compl√©t√©)
      const statutsTraites = ['traite', 'traite_attente_final'];
      // Statuts consid√©r√©s comme "en traitement" (en cours)
      const statutsEnTraitement = ['traitement', 'attente_comptable', 'attente_direction'];

      // D√©p√¥t
      if (statutClient.depot && statutClient.depot.montant) {
        const depotMontant = parseFloat(String(statutClient.depot.montant || '0').replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
        if (statutsTraites.includes(statutClient.depot.statut)) {
          montantTraite += depotMontant;
        } else if (statutsEnTraitement.includes(statutClient.depot.statut)) {
          montantEnTraitement += depotMontant;
        }
      }

      // Paiement final
      if (statutClient.paiementFinal && statutClient.paiementFinal.montant) {
        const finalMontant = parseFloat(String(statutClient.paiementFinal.montant || '0').replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
        if (statutsTraites.includes(statutClient.paiementFinal.statut)) {
          montantTraite += finalMontant;
        } else if (statutsEnTraitement.includes(statutClient.paiementFinal.statut)) {
          montantEnTraitement += finalMontant;
        }
      }

      // Autres paiements
      if (statutClient.autresPaiements && Array.isArray(statutClient.autresPaiements)) {
        statutClient.autresPaiements.forEach(p => {
          if (p.montant) {
            const autreMontant = parseFloat(String(p.montant || '0').replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
            if (statutsTraites.includes(p.statut)) {
              montantTraite += autreMontant;
            } else if (statutsEnTraitement.includes(p.statut)) {
              montantEnTraitement += autreMontant;
            }
          }
        });
      }

      // Calculer les pourcentages
      if (totalAvecTaxes > 0) {
        percentageTraite = Math.min(100, Math.round((montantTraite / totalAvecTaxes) * 100));
        percentageEnTraitement = Math.min(100 - percentageTraite, Math.round((montantEnTraitement / totalAvecTaxes) * 100));
      }

      // D√©terminer le texte de statut
      const totalPercentage = percentageTraite + percentageEnTraitement;
      if (percentageTraite >= 100) {
        statusText = 'Paiement complet';
      } else if (totalPercentage > 0) {
        statusText = `${percentageTraite}% compl√©t√©, ${percentageEnTraitement}% en traitement`;
      }
    }

    const totalPercentage = percentageTraite + percentageEnTraitement;

    return `<div
      style="width: 100%; cursor: default;"
      title="${statusText}"
    >
      <div style="
        display: flex;
        align-items: center;
        gap: 6px;
      ">
        <div style="
          flex: 1;
          height: 8px;
          background: rgba(100, 116, 139, 0.3);
          border-radius: 4px;
          overflow: hidden;
          display: flex;
        ">
          <div style="
            width: ${percentageTraite}%;
            height: 100%;
            background: #10b981;
            transition: width 0.3s ease;
          "></div>
          <div style="
            width: ${percentageEnTraitement}%;
            height: 100%;
            background: #f59e0b;
            transition: width 0.3s ease;
          "></div>
        </div>
        <span style="
          font-size: 0.75rem;
          font-weight: 600;
          color: #ffffff;
          min-width: 32px;
          text-align: right;
        ">${totalPercentage}%</span>
      </div>
    </div>`;
  };

  // Create etiquette badge (√Ä confirmer, Confirm√©, √Ä rappeler, etc.)
  window.createEtiquetteBadge = function(etiquette, venteId, category) {
    // Si pas d'√©tiquette ou vide, afficher badge gris vide (sans texte)
    if (!etiquette || etiquette === '-' || etiquette.trim() === '') {
      return `<span
        class="etiquette-badge"
        data-vente-id="${venteId}"
        data-current-etiquette=""
        data-category="${category}"
        style="
          display: block;
          width: 100%;
          height: 28px;
          border-radius: 4px;
          background-color: #cbd5e1;
          border: 1px solid #94a3b8;
          cursor: pointer;
          transition: all 0.2s;
        "
        onmouseover="this.style.backgroundColor='#94a3b8'"
        onmouseout="this.style.backgroundColor='#cbd5e1'"
        title="Cliquer pour modifier"
      ></span>`;
    }

    // Chercher la couleur personnalis√©e de l'√©tiquette
    let bgColor = '#6b7280'; // Couleur par d√©faut (gris)
    const etiquetteObj = window.etiquettesPersonnalisees?.etiquettes?.find(item =>
      (typeof item === 'string' ? item : item.label) === etiquette
    );
    if (etiquetteObj && typeof etiquetteObj === 'object' && etiquetteObj.color) {
      bgColor = etiquetteObj.color;
    }

    return `<span
      class="etiquette-badge"
      data-vente-id="${venteId}"
      data-current-etiquette="${etiquette}"
      data-category="${category}"
      data-tooltip="${etiquette}"
      style="
        display: block;
        padding: 4px 12px;
        border-radius: 4px;
        background-color: ${bgColor};
        color: #fff;
        font-size: 0.875rem;
        font-weight: 500;
        white-space: nowrap;
        cursor: pointer;
        transition: opacity 0.2s;
        width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
      "
      onmouseenter="this.style.opacity='0.8'; window.customTooltip.show(this.getAttribute('data-tooltip'), this);"
      onmouseleave="this.style.opacity='1'; window.customTooltip.hide();"
    >${etiquette}</span>`;
  };

  // Change statut vente
  // Fonction pour fermer tous les dropdowns
  function closeAllDropdowns() {
    const dropdowns = [
      'statut-vente-dropdown',
      'provenance-dropdown',
      'type-travaux-dropdown',
      'paiement-dropdown',
      'etiquette-dropdown'
    ];
    dropdowns.forEach(id => {
      const dropdown = document.getElementById(id);
      if (dropdown) dropdown.remove();
    });
  }

  window.changerStatutVente = function(venteId, currentStatut, category, event) {
    if (event) event.stopPropagation();

    closeAllDropdowns();

    const dropdown = document.createElement('div');
    dropdown.id = 'statut-vente-dropdown';
    dropdown.className = 'dropdown-secondary-menu';

    // Utiliser les √©tiquettes personnalis√©es de l'entrepreneur
    const labels = window.etiquettesPersonnalisees?.statuts || [];

    // D√©finir les couleurs bas√©es sur le texte de l'√©tiquette (fallback)
    const getColorForStatut = (label) => {
      const labelLower = label.toLowerCase();
      if (labelLower.includes('termin√©') || labelLower.includes('termine') || labelLower.includes('compl√©t√©') || labelLower.includes('complete')) {
        return '#00c875'; // Vert
      } else if (labelLower.includes('en cours') || labelLower.includes('traitement') || labelLower.includes('progress')) {
        return '#fdab3d'; // Orange
      } else {
        return '#e2445c'; // Rouge
      }
    };

    // Convertir les strings en objets {label, color} si n√©cessaire
    const labelsAsObjects = labels.map(item =>
      typeof item === 'string' ? { label: item, color: getColorForStatut(item) } : item
    );

    // Ajouter l'option vide au d√©but
    const allStatuts = [{ label: '', color: '#cbd5e1', isEmpty: true }, ...labelsAsObjects];

    // Calculer le nombre de colonnes: maximum 5 items par colonne
    const totalOptions = allStatuts.length;
    const maxItemsPerColumn = 5;
    const columns = Math.ceil(totalOptions / maxItemsPerColumn);

    dropdown.style.cssText = `
      position: absolute;
      display: flex;
      flex-direction: column;
      min-width: 200px;
      max-height: 400px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      z-index: 10001;
    `;

    // Cr√©er un conteneur grid pour les options (scrollable)
    const optionsContainer = document.createElement('div');
    optionsContainer.style.cssText = `
      display: grid;
      grid-template-columns: repeat(${columns}, 1fr);
      grid-template-rows: repeat(${maxItemsPerColumn}, auto);
      grid-auto-flow: column;
      gap: 0;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
    `;

    allStatuts.forEach(statut => {
      const option = document.createElement('div');
      option.style.cssText = `
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        transition: background 0.2s;
      `;

      if (statut.isEmpty) {
        // Option vide - rectangle gris vide + texte "(Vide)" √† droite
        const emptyBox = document.createElement('span');
        emptyBox.style.cssText = `
          display: inline-block;
          width: 140px;
          height: 24px;
          border-radius: 4px;
          background-color: #cbd5e1;
          border: 1px solid #94a3b8;
        `;

        const label = document.createElement('span');
        label.textContent = '(Vide)';
        label.style.cssText = `color: var(--text-gray); font-size: 14px; margin-left: 8px;`;

        const spacer = document.createElement('span');
        spacer.style.cssText = `flex: 1;`;

        option.appendChild(emptyBox);
        option.appendChild(label);
        option.appendChild(spacer);

        if (statut.label === currentStatut || currentStatut === '' || !currentStatut) {
          const checkmark = document.createElement('i');
          checkmark.className = 'fas fa-check';
          checkmark.style.cssText = 'color: var(--primary-blue); font-size: 12px;';
          option.appendChild(checkmark);
        }
      } else {
        // √âtiquette remplie - rectangle color√© avec texte dedans
        const badge = document.createElement('span');
        badge.style.cssText = `
          display: inline-block;
          width: 140px;
          height: 24px;
          border-radius: 4px;
          background-color: ${statut.color};
          color: #fff;
          font-size: 0.75rem;
          font-weight: 500;
          text-overflow: ellipsis;
          overflow: hidden;
          white-space: nowrap;
          padding: 0 8px;
          line-height: 24px;
          text-align: center;
        `;
        badge.textContent = statut.label;
        badge.addEventListener('mouseenter', function() {
          window.customTooltip.show(statut.label, this);
        });
        badge.addEventListener('mouseleave', function() {
          window.customTooltip.hide();
        });

        const spacer = document.createElement('span');
        spacer.style.cssText = `flex: 1;`;

        option.appendChild(badge);
        option.appendChild(spacer);

        if (statut.label === currentStatut) {
          const checkmark = document.createElement('i');
          checkmark.className = 'fas fa-check';
          checkmark.style.cssText = 'color: var(--primary-blue); font-size: 12px;';
          option.appendChild(checkmark);
        }
      }

      option.addEventListener('mouseenter', () => option.style.background = 'rgba(59, 130, 246, 0.15)');
      option.addEventListener('mouseleave', () => option.style.background = 'transparent');

      option.addEventListener('click', async () => {
        if (statut.label !== currentStatut) {
          // Fermer le dropdown imm√©diatement
          dropdown.remove();

          // Afficher le loading sur le badge
          const badgeElement = findBadgeByVenteId(venteId, 'statut-vente-badge');
          showBadgeLoading(badgeElement);

          try {
            const response = await fetch('/ventes/update-statut-vente', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                username: window.username,
                id: venteId,
                statut: statut.label,
                category: category
              })
            });

            if (response.ok) {
              log('[VENTES] ‚úÖ Statut vente sauvegard√©');
              await loadVentesDataInternal();
            } else {
              error('[VENTES] ‚ùå Erreur sauvegarde statut vente');
            }
          } catch (err) {
            error('[VENTES] ‚ùå Erreur r√©seau:', err);
          } finally {
            hideBadgeLoading(badgeElement);
          }
        } else {
          dropdown.remove();
        }
      });

      optionsContainer.appendChild(option);
    });

    // Ajouter le conteneur d'options au dropdown
    dropdown.appendChild(optionsContainer);

    // Cr√©er un bouton pour g√©rer les √©tiquettes (STICKY en bas)
    const manageButton = document.createElement('div');
    manageButton.style.cssText = `
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary-blue);
      font-weight: 500;
      border-top: 2px solid var(--border-dark);
      transition: background 0.2s;
      width: 100%;
      position: sticky;
      bottom: 0;
      z-index: 10;
    `;
    manageButton.innerHTML = '<i class="fas fa-cog"></i><span>G√©rer les √©tiquettes</span>';
    manageButton.addEventListener('mouseenter', () => manageButton.style.background = 'rgba(59, 130, 246, 0.2)');
    manageButton.addEventListener('mouseleave', () => manageButton.style.background = 'rgba(59, 130, 246, 0.1)');
    manageButton.addEventListener('click', () => {
      dropdown.remove();
      ouvrirGestionEtiquettes('statuts');
    });

    // Ajouter le bouton directement au dropdown (pas dans le grid)
    dropdown.appendChild(manageButton);

    document.body.appendChild(dropdown);

    if (event && event.target) {
      const rect = event.target.getBoundingClientRect();
      dropdown.style.top = `${rect.bottom + window.scrollY + 5}px`;
      dropdown.style.left = `${rect.left + window.scrollX}px`;
      dropdown.style.right = 'auto';
    }

    const closeOnClick = () => {
      dropdown.remove();
      document.removeEventListener('click', closeOnClick);
    };

    setTimeout(() => {
      document.addEventListener('click', closeOnClick);
    }, 100);
  };

  // Change provenance
  window.changerProvenance = function(venteId, currentProvenance, category, event) {
    if (event) event.stopPropagation();

    closeAllDropdowns();

    const dropdown = document.createElement('div');
    dropdown.id = 'provenance-dropdown';
    dropdown.className = 'dropdown-secondary-menu';

    // Utiliser les √©tiquettes personnalis√©es de l'entrepreneur
    const provenances = window.etiquettesPersonnalisees?.provenances || [];

    // Convertir les strings en objets {label, color} si n√©cessaire
    const provenancesAsObjects = provenances.map(item =>
      typeof item === 'string' ? { label: item, color: '#0891b2' } : item
    );

    // Ajouter l'option vide au d√©but
    const allProvenances = [{ label: '', color: '#cbd5e1', isEmpty: true }, ...provenancesAsObjects];

    // Calculer le nombre de colonnes: maximum 5 items par colonne
    const totalOptions = allProvenances.length;
    const maxItemsPerColumn = 5;
    const columns = Math.ceil(totalOptions / maxItemsPerColumn);

    dropdown.style.cssText = `
      position: absolute;
      display: flex;
      flex-direction: column;
      min-width: 200px;
      max-height: 400px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      z-index: 10001;
    `;

    // Cr√©er un conteneur grid pour les options (scrollable)
    const optionsContainer = document.createElement('div');
    optionsContainer.style.cssText = `
      display: grid;
      grid-template-columns: repeat(${columns}, 1fr);
      grid-template-rows: repeat(${maxItemsPerColumn}, auto);
      grid-auto-flow: column;
      gap: 0;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
    `;

    allProvenances.forEach(prov => {
      const option = document.createElement('div');
      option.style.cssText = `
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        transition: background 0.2s;
        color: var(--text-light);
      `;

      if (prov.isEmpty) {
        // Option vide - rectangle gris vide + texte "(Vide)" √† droite
        const emptyBox = document.createElement('span');
        emptyBox.style.cssText = `
          display: inline-block;
          width: 140px;
          height: 24px;
          border-radius: 4px;
          background-color: #cbd5e1;
          border: 1px solid #94a3b8;
        `;

        const label = document.createElement('span');
        label.textContent = '(Vide)';
        label.style.cssText = `color: var(--text-gray); font-size: 14px; margin-left: 8px;`;

        const spacer = document.createElement('span');
        spacer.style.cssText = `flex: 1;`;

        option.appendChild(emptyBox);
        option.appendChild(label);
        option.appendChild(spacer);

        if (prov.label === currentProvenance || currentProvenance === '' || !currentProvenance) {
          const checkmark = document.createElement('i');
          checkmark.className = 'fas fa-check';
          checkmark.style.cssText = 'color: var(--primary-blue); font-size: 12px;';
          option.appendChild(checkmark);
        }
      } else {
        // √âtiquette remplie - rectangle color√© avec texte dedans
        const badge = document.createElement('span');
        badge.style.cssText = `
          display: inline-block;
          width: 140px;
          height: 24px;
          border-radius: 4px;
          background-color: ${prov.color};
          color: #fff;
          font-size: 0.75rem;
          font-weight: 500;
          text-overflow: ellipsis;
          overflow: hidden;
          white-space: nowrap;
          padding: 0 8px;
          line-height: 24px;
          text-align: center;
        `;
        badge.textContent = prov.label;
        badge.addEventListener('mouseenter', function() {
          window.customTooltip.show(prov.label, this);
        });
        badge.addEventListener('mouseleave', function() {
          window.customTooltip.hide();
        });

        const spacer = document.createElement('span');
        spacer.style.cssText = `flex: 1;`;

        option.appendChild(badge);
        option.appendChild(spacer);

        if (prov.label === currentProvenance) {
          const checkmark = document.createElement('i');
          checkmark.className = 'fas fa-check';
          checkmark.style.cssText = 'color: var(--primary-blue); font-size: 12px;';
          option.appendChild(checkmark);
        }
      }

      option.addEventListener('mouseenter', () => option.style.background = 'rgba(59, 130, 246, 0.15)');
      option.addEventListener('mouseleave', () => option.style.background = 'transparent');

      option.addEventListener('click', async () => {
        if (prov.label !== currentProvenance) {
          // Fermer le dropdown imm√©diatement
          dropdown.remove();

          // Afficher le loading sur le badge
          const badgeElement = findBadgeByVenteId(venteId, 'provenance-badge');
          showBadgeLoading(badgeElement);

          try {
            const response = await fetch('/ventes/update-provenance', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                username: window.username,
                id: venteId,
                provenance: prov.label,
                category: category
              })
            });

            if (response.ok) {
              log('[VENTES] ‚úÖ Provenance sauvegard√©e');
              await loadVentesDataInternal();
            } else {
              error('[VENTES] ‚ùå Erreur sauvegarde provenance');
            }
          } catch (err) {
            error('[VENTES] ‚ùå Erreur r√©seau:', err);
          } finally {
            // Retirer le loading (sera retir√© apr√®s le rechargement des donn√©es)
            hideBadgeLoading(badgeElement);
          }
        } else {
          dropdown.remove();
        }
      });

      optionsContainer.appendChild(option);
    });

    // Ajouter le conteneur d'options au dropdown
    dropdown.appendChild(optionsContainer);

    // Cr√©er un bouton pour g√©rer les √©tiquettes (STICKY en bas)
    const manageButton = document.createElement('div');
    manageButton.style.cssText = `
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary-blue);
      font-weight: 500;
      border-top: 2px solid var(--border-dark);
      transition: background 0.2s;
      width: 100%;
      position: sticky;
      bottom: 0;
      z-index: 10;
    `;
    manageButton.innerHTML = '<i class="fas fa-cog"></i><span>G√©rer les √©tiquettes</span>';
    manageButton.addEventListener('mouseenter', () => manageButton.style.background = 'rgba(59, 130, 246, 0.2)');
    manageButton.addEventListener('mouseleave', () => manageButton.style.background = 'rgba(59, 130, 246, 0.1)');
    manageButton.addEventListener('click', () => {
      dropdown.remove();
      ouvrirGestionEtiquettes('provenances');
    });

    // Ajouter le bouton directement au dropdown (pas dans le grid)
    dropdown.appendChild(manageButton);

    document.body.appendChild(dropdown);

    if (event && event.target) {
      const rect = event.target.getBoundingClientRect();
      dropdown.style.top = `${rect.bottom + window.scrollY + 5}px`;
      dropdown.style.left = `${rect.left + window.scrollX}px`;
      dropdown.style.right = 'auto';
    }

    const closeOnClick = () => {
      dropdown.remove();
      document.removeEventListener('click', closeOnClick);
    };

    setTimeout(() => {
      document.addEventListener('click', closeOnClick);
    }, 100);
  };

  // Change type travaux
  window.changerTypeTravaux = function(venteId, currentType, category, event) {
    if (event) event.stopPropagation();

    closeAllDropdowns();

    const dropdown = document.createElement('div');
    dropdown.id = 'type-travaux-dropdown';
    dropdown.className = 'dropdown-secondary-menu';

    // Utiliser les √©tiquettes personnalis√©es de l'entrepreneur
    const types = window.etiquettesPersonnalisees?.types_travaux || [];

    // Convertir les strings en objets {label, color} si n√©cessaire
    const typesAsObjects = types.map(item =>
      typeof item === 'string' ? { label: item, color: '#8b5cf6' } : item
    );

    // Ajouter l'option vide au d√©but
    const allTypes = [{ label: '', color: '#cbd5e1', isEmpty: true }, ...typesAsObjects];

    // Calculer le nombre de colonnes: maximum 5 items par colonne
    const totalOptions = allTypes.length;
    const maxItemsPerColumn = 5;
    const columns = Math.ceil(totalOptions / maxItemsPerColumn);

    dropdown.style.cssText = `
      position: absolute;
      display: flex;
      flex-direction: column;
      min-width: 200px;
      max-height: 400px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      z-index: 10001;
    `;

    // Cr√©er un conteneur grid pour les options (scrollable)
    const optionsContainer = document.createElement('div');
    optionsContainer.style.cssText = `
      display: grid;
      grid-template-columns: repeat(${columns}, 1fr);
      grid-template-rows: repeat(${maxItemsPerColumn}, auto);
      grid-auto-flow: column;
      gap: 0;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
    `;

    allTypes.forEach(type => {
      const option = document.createElement('div');
      option.style.cssText = `
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        transition: background 0.2s;
        color: var(--text-light);
      `;

      if (type.isEmpty) {
        // Option vide - rectangle gris vide + texte "(Vide)" √† droite
        const emptyBox = document.createElement('span');
        emptyBox.style.cssText = `
          display: inline-block;
          width: 140px;
          height: 24px;
          border-radius: 4px;
          background-color: #cbd5e1;
          border: 1px solid #94a3b8;
        `;

        const label = document.createElement('span');
        label.textContent = '(Vide)';
        label.style.cssText = `color: var(--text-gray); font-size: 14px; margin-left: 8px;`;

        const spacer = document.createElement('span');
        spacer.style.cssText = `flex: 1;`;

        option.appendChild(emptyBox);
        option.appendChild(label);
        option.appendChild(spacer);

        if (type.label === currentType || currentType === '' || !currentType) {
          const checkmark = document.createElement('i');
          checkmark.className = 'fas fa-check';
          checkmark.style.cssText = 'color: var(--primary-blue); font-size: 12px;';
          option.appendChild(checkmark);
        }
      } else {
        // √âtiquette remplie - rectangle color√© avec texte dedans
        const badge = document.createElement('span');
        badge.style.cssText = `
          display: inline-block;
          width: 140px;
          height: 24px;
          border-radius: 4px;
          background-color: ${type.color};
          color: #fff;
          font-size: 0.75rem;
          font-weight: 500;
          text-overflow: ellipsis;
          overflow: hidden;
          white-space: nowrap;
          padding: 0 8px;
          line-height: 24px;
          text-align: center;
        `;
        badge.textContent = type.label;
        badge.addEventListener('mouseenter', function() {
          window.customTooltip.show(type.label, this);
        });
        badge.addEventListener('mouseleave', function() {
          window.customTooltip.hide();
        });

        const spacer = document.createElement('span');
        spacer.style.cssText = `flex: 1;`;

        option.appendChild(badge);
        option.appendChild(spacer);

        if (type.label === currentType) {
          const checkmark = document.createElement('i');
          checkmark.className = 'fas fa-check';
          checkmark.style.cssText = 'color: var(--primary-blue); font-size: 12px;';
          option.appendChild(checkmark);
        }
      }

      option.addEventListener('mouseenter', () => option.style.background = 'rgba(59, 130, 246, 0.15)');
      option.addEventListener('mouseleave', () => option.style.background = 'transparent');

      option.addEventListener('click', async () => {
        if (type.label !== currentType) {
          // Fermer le dropdown imm√©diatement
          dropdown.remove();

          // Afficher le loading sur le badge
          const badgeElement = findBadgeByVenteId(venteId, 'type-travaux-badge');
          showBadgeLoading(badgeElement);

          try {
            const response = await fetch('/ventes/update-type-travaux', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                username: window.username,
                id: venteId,
                type_travaux: type.label,
                category: category
              })
            });

            if (response.ok) {
              log('[VENTES] ‚úÖ Type travaux sauvegard√©');
              await loadVentesDataInternal();
            } else {
              error('[VENTES] ‚ùå Erreur sauvegarde type travaux');
            }
          } catch (err) {
            error('[VENTES] ‚ùå Erreur r√©seau:', err);
          } finally {
            hideBadgeLoading(badgeElement);
          }
        } else {
          dropdown.remove();
        }
      });

      optionsContainer.appendChild(option);
    });

    // Ajouter le conteneur d'options au dropdown
    dropdown.appendChild(optionsContainer);

    // Cr√©er un bouton pour g√©rer les √©tiquettes (STICKY en bas)
    const manageButton = document.createElement('div');
    manageButton.style.cssText = `
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary-blue);
      font-weight: 500;
      border-top: 2px solid var(--border-dark);
      transition: background 0.2s;
      width: 100%;
      position: sticky;
      bottom: 0;
      z-index: 10;
    `;
    manageButton.innerHTML = '<i class="fas fa-cog"></i><span>G√©rer les √©tiquettes</span>';
    manageButton.addEventListener('mouseenter', () => manageButton.style.background = 'rgba(59, 130, 246, 0.2)');
    manageButton.addEventListener('mouseleave', () => manageButton.style.background = 'rgba(59, 130, 246, 0.1)');
    manageButton.addEventListener('click', () => {
      dropdown.remove();
      window.ouvrirGestionEtiquettes('types_travaux');
    });

    // Ajouter le bouton directement au dropdown (pas dans le grid)
    dropdown.appendChild(manageButton);

    document.body.appendChild(dropdown);

    if (event && event.target) {
      const rect = event.target.getBoundingClientRect();
      dropdown.style.top = `${rect.bottom + window.scrollY + 5}px`;
      dropdown.style.left = `${rect.left + window.scrollX}px`;
      dropdown.style.right = 'auto';
    }

    const closeOnClick = () => {
      dropdown.remove();
      document.removeEventListener('click', closeOnClick);
    };

    setTimeout(() => {
      document.addEventListener('click', closeOnClick);
    }, 100);
  };

  // Change paiement
  window.changerPaiement = function(venteId, currentPaiement, category, event) {
    if (event) event.stopPropagation();

    closeAllDropdowns();

    const dropdown = document.createElement('div');
    dropdown.id = 'paiement-dropdown';
    dropdown.className = 'dropdown-secondary-menu';

    // Utiliser les √©tiquettes personnalis√©es de l'entrepreneur
    const paiements = window.etiquettesPersonnalisees?.paiements || [];

    // Convertir les strings en objets {label, color} si n√©cessaire
    const paiementsAsObjects = paiements.map(item =>
      typeof item === 'string' ? { label: item, color: '#e2445c' } : item
    );

    // PAS d'option vide pour les paiements
    const allPaiements = paiementsAsObjects;

    // Calculer le nombre de colonnes: maximum 5 items par colonne
    const totalOptions = allPaiements.length;
    const maxItemsPerColumn = 5;
    const columns = Math.ceil(totalOptions / maxItemsPerColumn);

    dropdown.style.cssText = `
      position: absolute;
      display: flex;
      flex-direction: column;
      min-width: 200px;
      max-height: 400px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      z-index: 10001;
    `;

    // Cr√©er un conteneur grid pour les options (scrollable)
    const optionsContainer = document.createElement('div');
    optionsContainer.style.cssText = `
      display: grid;
      grid-template-columns: repeat(${columns}, 1fr);
      grid-template-rows: repeat(${maxItemsPerColumn}, auto);
      grid-auto-flow: column;
      gap: 0;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
    `;

    allPaiements.forEach(paiement => {
      const option = document.createElement('div');
      option.style.cssText = `
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        transition: background 0.2s;
        color: var(--text-light);
      `;

      // Badge color√© avec texte dedans (comme Type de travaux)
      const badge = document.createElement('span');
      badge.style.cssText = `
        display: inline-block;
        width: 140px;
        height: 24px;
        border-radius: 4px;
        background-color: ${paiement.color};
        color: #fff;
        font-size: 0.75rem;
        font-weight: 500;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        padding: 0 8px;
        line-height: 24px;
        text-align: center;
      `;
      badge.textContent = paiement.label;
      badge.addEventListener('mouseenter', function() {
        window.customTooltip.show(paiement.label, this);
      });
      badge.addEventListener('mouseleave', function() {
        window.customTooltip.hide();
      });

      const spacer = document.createElement('span');
      spacer.style.cssText = `flex: 1;`;

      option.appendChild(badge);
      option.appendChild(spacer);

      // Checkmark si c'est le paiement actuel
      if (paiement.label === currentPaiement) {
        const checkmark = document.createElement('i');
        checkmark.className = 'fas fa-check';
        checkmark.style.cssText = 'color: var(--primary-blue); font-size: 12px;';
        option.appendChild(checkmark);
      }

      option.addEventListener('mouseenter', () => option.style.background = 'rgba(59, 130, 246, 0.15)');
      option.addEventListener('mouseleave', () => option.style.background = 'transparent');

      option.addEventListener('click', async () => {
        if (paiement.label !== currentPaiement) {
          // Fermer le dropdown imm√©diatement
          dropdown.remove();

          // Afficher le loading sur le badge
          const badgeElement = findBadgeByVenteId(venteId, 'paiement-badge');
          showBadgeLoading(badgeElement);

          try {
            const response = await fetch('/ventes/update-paiement', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                username: window.username,
                id: venteId,
                paiement: paiement.label,
                category: category
              })
            });

            if (response.ok) {
              log('[VENTES] ‚úÖ Paiement sauvegard√©');
              await loadVentesDataInternal();
            } else {
              error('[VENTES] ‚ùå Erreur sauvegarde paiement');
            }
          } catch (err) {
            error('[VENTES] ‚ùå Erreur r√©seau:', err);
          } finally {
            hideBadgeLoading(badgeElement);
          }
        } else {
          dropdown.remove();
        }
      });

      optionsContainer.appendChild(option);
    });

    // Ajouter le conteneur d'options au dropdown
    dropdown.appendChild(optionsContainer);

    // Cr√©er un bouton pour g√©rer les √©tiquettes (STICKY en bas)
    const manageButton = document.createElement('div');
    manageButton.style.cssText = `
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary-blue);
      font-weight: 500;
      border-top: 2px solid var(--border-dark);
      transition: background 0.2s;
      width: 100%;
      position: sticky;
      bottom: 0;
      z-index: 10;
    `;
    manageButton.innerHTML = '<i class="fas fa-cog"></i><span>G√©rer les √©tiquettes</span>';
    manageButton.addEventListener('mouseenter', () => manageButton.style.background = 'rgba(59, 130, 246, 0.2)');
    manageButton.addEventListener('mouseleave', () => manageButton.style.background = 'rgba(59, 130, 246, 0.1)');
    manageButton.addEventListener('click', () => {
      dropdown.remove();
      ouvrirGestionEtiquettes('paiements');
    });

    // Ajouter le bouton directement au dropdown (pas dans le grid)
    dropdown.appendChild(manageButton);

    document.body.appendChild(dropdown);

    if (event && event.target) {
      const rect = event.target.getBoundingClientRect();
      dropdown.style.top = `${rect.bottom + window.scrollY + 5}px`;
      dropdown.style.left = `${rect.left + window.scrollX}px`;
      dropdown.style.right = 'auto';
    }

    const closeOnClick = () => {
      dropdown.remove();
      document.removeEventListener('click', closeOnClick);
    };

    setTimeout(() => {
      document.addEventListener('click', closeOnClick);
    }, 100);
  };

  // Changer √©tiquette
  window.changerEtiquette = function(venteId, currentEtiquette, category, event) {
    if (event) event.stopPropagation();

    closeAllDropdowns();

    const dropdown = document.createElement('div');
    dropdown.id = 'etiquette-dropdown';
    dropdown.className = 'dropdown-secondary-menu';

    // Utiliser les √©tiquettes personnalis√©es
    const etiquettes = window.etiquettesPersonnalisees?.etiquettes || [
      { label: '√Ä confirmer', color: '#ef4444' },
      { label: 'Confirm√©', color: '#22c55e' },
      { label: '√Ä rappeler', color: '#f59e0b' }
    ];

    // Option vide pour effacer l'√©tiquette
    const allEtiquettes = [
      { label: '', color: '#cbd5e1', isEmpty: true },
      ...etiquettes.map(item => typeof item === 'string' ? { label: item, color: '#6b7280' } : item)
    ];

    dropdown.style.cssText = `
      position: absolute;
      display: flex;
      flex-direction: column;
      max-width: 250px;
      max-height: 300px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      z-index: 10001;
    `;

    const optionsContainer = document.createElement('div');
    optionsContainer.style.cssText = `
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      flex: 1;
    `;

    allEtiquettes.forEach(etiquette => {
      const option = document.createElement('div');
      option.style.cssText = `
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid rgba(71, 85, 105, 0.2);
        transition: background 0.2s;
        color: var(--text-light);
      `;

      const badge = document.createElement('span');
      badge.style.cssText = `
        display: inline-block;
        width: 120px;
        height: 24px;
        border-radius: 4px;
        background-color: ${etiquette.color};
        color: ${etiquette.isEmpty ? 'transparent' : '#fff'};
        font-size: 0.75rem;
        font-weight: 500;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        padding: 0 8px;
        line-height: 24px;
        text-align: center;
        ${etiquette.isEmpty ? 'border: 1px solid #94a3b8;' : ''}
      `;
      badge.textContent = etiquette.isEmpty ? 'Aucune' : etiquette.label;

      const spacer = document.createElement('span');
      spacer.style.cssText = `flex: 1;`;

      option.appendChild(badge);
      option.appendChild(spacer);

      if (etiquette.label === currentEtiquette) {
        const checkmark = document.createElement('i');
        checkmark.className = 'fas fa-check';
        checkmark.style.cssText = 'color: var(--primary-blue); font-size: 12px;';
        option.appendChild(checkmark);
      }

      option.addEventListener('mouseenter', () => option.style.background = 'rgba(255, 255, 255, 0.05)');
      option.addEventListener('mouseleave', () => option.style.background = 'transparent');

      option.addEventListener('click', async (e) => {
        e.stopPropagation();
        const newEtiquette = etiquette.isEmpty ? '' : etiquette.label;

        if (newEtiquette !== currentEtiquette) {
          const badgeElement = document.querySelector(`.etiquette-badge[data-vente-id="${venteId}"]`);
          if (badgeElement) showBadgeLoading(badgeElement);

          try {
            const response = await fetch('/ventes/update-etiquette', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                username: window.username,
                category: category,
                vente_id: venteId,
                value: newEtiquette
              })
            });

            if (response.ok) {
              log('[VENTES] ‚úÖ √âtiquette sauvegard√©e');
              await loadVentesDataInternal();
            } else {
              error('[VENTES] ‚ùå Erreur sauvegarde √©tiquette');
            }
          } catch (err) {
            error('[VENTES] ‚ùå Erreur r√©seau:', err);
          } finally {
            if (badgeElement) hideBadgeLoading(badgeElement);
          }
        }
        dropdown.remove();
      });

      optionsContainer.appendChild(option);
    });

    dropdown.appendChild(optionsContainer);

    // Bouton pour g√©rer les √©tiquettes
    const manageButton = document.createElement('div');
    manageButton.style.cssText = `
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary-blue);
      font-weight: 500;
      border-top: 2px solid var(--border-dark);
      transition: background 0.2s;
      width: 100%;
      position: sticky;
      bottom: 0;
      z-index: 10;
    `;
    manageButton.innerHTML = '<i class="fas fa-cog"></i><span>G√©rer les √©tiquettes</span>';
    manageButton.addEventListener('mouseenter', () => manageButton.style.background = 'rgba(59, 130, 246, 0.2)');
    manageButton.addEventListener('mouseleave', () => manageButton.style.background = 'rgba(59, 130, 246, 0.1)');
    manageButton.addEventListener('click', () => {
      dropdown.remove();
      ouvrirGestionEtiquettes('etiquettes');
    });

    dropdown.appendChild(manageButton);
    document.body.appendChild(dropdown);

    if (event && event.target) {
      const rect = event.target.getBoundingClientRect();
      dropdown.style.top = `${rect.bottom + window.scrollY + 5}px`;
      dropdown.style.left = `${rect.left + window.scrollX}px`;
      dropdown.style.right = 'auto';
    }

    const closeOnClick = () => {
      dropdown.remove();
      document.removeEventListener('click', closeOnClick);
    };

    setTimeout(() => {
      document.addEventListener('click', closeOnClick);
    }, 100);
  };

  // Edit notes
  window.editNotes = function(venteId, category, currentNotes) {
    const modal = document.createElement('div');
    modal.id = 'notes-edit-modal';
    modal.style.cssText = `
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    `;

    modal.innerHTML = `
      <div class="status-card p-6" style="width: 90%; max-width: 600px;">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold" style="color: var(--text-light);">
            <i class="fas fa-sticky-note mr-2" style="color: var(--primary-blue);"></i>
            Modifier les notes
          </h3>
          <button onclick="document.getElementById('notes-edit-modal').remove(); document.body.style.overflow = '';"
            class="w-8 h-8 rounded-full flex items-center justify-center transition-colors"
            style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <textarea
          id="notes-textarea"
          rows="6"
          style="
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background: #0f172a;
            border: 2px solid var(--border-dark);
            color: var(--text-light);
            font-size: 0.875rem;
            resize: none;
            font-family: inherit;
          "
          placeholder="Entrez vos notes ici..."
        >${currentNotes === '-' ? '' : currentNotes}</textarea>
        <div class="flex gap-3 mt-4 justify-end">
          <button
            onclick="document.getElementById('notes-edit-modal').remove(); document.body.style.overflow = '';"
            class="btn-secondary px-4 py-2">
            Annuler
          </button>
          <button
            id="save-notes-btn"
            class="btn-primary px-4 py-2">
            <i class="fas fa-save mr-2"></i>Enregistrer
          </button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';

    document.getElementById('save-notes-btn').addEventListener('click', async () => {
      const notes = document.getElementById('notes-textarea').value.trim();

      // Ajouter le spinner sur l'ic√¥ne de note
      const noteIcon = document.querySelector(`.note-icon-${venteId}`);
      if (noteIcon) {
        noteIcon.classList.add('note-icon-loading');
      }

      // Fermer le modal imm√©diatement
      modal.remove();
      document.body.style.overflow = '';

      try {
        const response = await fetch('/ventes/update-notes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: window.username,
            id: venteId,
            notes: notes,
            category: category
          })
        });

        if (response.ok) {
          log('[VENTES] ‚úÖ Notes sauvegard√©es');
          await loadVentesDataInternal();
        } else {
          error('[VENTES] ‚ùå Erreur sauvegarde notes');
        }
      } catch (err) {
        error('[VENTES] ‚ùå Erreur r√©seau:', err);
      } finally {
        // Retirer le spinner
        if (noteIcon) {
          noteIcon.classList.remove('note-icon-loading');
        }
      }
    });
  };

  // Palette de couleurs globale (Monday.com style)
  window.colorPalette = [
    '#e2445c', '#ff6f61', '#ff8c42', '#ffa07a',
    '#fdab3d', '#ffd93d', '#6bcf7f', '#00c875',
    '#00d4ff', '#0091ff', '#3b82f6', '#5559df',
    '#a25ddc', '#e876a9', '#ff66c4', '#94a3b8',
    '#64748b', '#1e293b'
  ];

  // Fonction pour ouvrir la gestion des √©tiquettes personnalis√©es
  window.ouvrirGestionEtiquettes = function(type) {
    const modal = document.createElement('div');
    modal.id = 'etiquettes-modal';
    modal.style.cssText = `
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
    `;

    const currentStatuts = [...window.etiquettesPersonnalisees.statuts];
    const currentProvenances = [...window.etiquettesPersonnalisees.provenances];
    const currentTypeTravaux = [...window.etiquettesPersonnalisees.types_travaux];
    const currentPaiements = [...window.etiquettesPersonnalisees.paiements];
    const currentEtiquettes = [...(window.etiquettesPersonnalisees.etiquettes || [])];

    // D√©finir le titre et l'ic√¥ne selon le type
    const config = {
      statuts: {
        title: 'G√©rer les statuts de vente',
        icon: 'fa-circle-notch',
        placeholder: 'Nouvelle √©tiquette de statut...',
        listId: 'statuts-list',
        inputId: 'nouveau-statut-input',
        btnId: 'add-statut-btn'
      },
      provenances: {
        title: 'G√©rer les provenances',
        icon: 'fa-map-marker-alt',
        placeholder: 'Nouvelle provenance...',
        listId: 'provenances-list',
        inputId: 'nouvelle-provenance-input',
        btnId: 'add-provenance-btn'
      },
      types_travaux: {
        title: 'G√©rer les types de travaux',
        icon: 'fa-tools',
        placeholder: 'Nouveau type de travaux...',
        listId: 'types-travaux-list',
        inputId: 'nouveau-type-travaux-input',
        btnId: 'add-type-travaux-btn'
      },
      paiements: {
        title: 'G√©rer les paiements',
        icon: 'fa-dollar-sign',
        placeholder: 'Nouveau statut de paiement...',
        listId: 'paiements-list',
        inputId: 'nouveau-paiement-input',
        btnId: 'add-paiement-btn'
      },
      etiquettes: {
        title: 'G√©rer les status',
        icon: 'fa-tag',
        placeholder: 'Nouveau status...',
        listId: 'etiquettes-list',
        inputId: 'nouvelle-etiquette-input',
        btnId: 'add-etiquette-btn'
      }
    };

    const cfg = config[type];

    modal.innerHTML = `
      <div class="status-card p-6" style="width: 90%; max-width: 700px; height: 600px; display: flex; flex-direction: column;">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold" style="color: var(--text-light);">
            <i class="fas ${cfg.icon} mr-2" style="color: var(--primary-blue);"></i>
            ${cfg.title}
          </h3>
          <button onclick="document.getElementById('etiquettes-modal').remove(); document.body.style.overflow = '';"
            class="w-8 h-8 rounded-full flex items-center justify-center transition-colors"
            style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- Liste des √©tiquettes existantes -->
        <div style="flex: 1; overflow-y: auto; margin-bottom: 1rem;">
          <h4 style="color: var(--text-gray); font-size: 0.875rem; margin-bottom: 0.75rem; font-weight: 600;">√âTIQUETTES EXISTANTES</h4>
          <div id="${cfg.listId}" class="mb-3"></div>
        </div>

        <!-- Ajouter une nouvelle √©tiquette -->
        <div style="border-top: 2px solid var(--border-dark); padding-top: 1rem;">
          <h4 style="color: var(--text-gray); font-size: 0.875rem; margin-bottom: 0.75rem; font-weight: 600;">AJOUTER UNE √âTIQUETTE</h4>
          <div class="flex gap-2 mb-3">
            <input
              type="text"
              id="${cfg.inputId}"
              placeholder="${cfg.placeholder}"
              style="
                flex: 1;
                padding: 10px;
                border-radius: 6px;
                background: #0f172a;
                border: 2px solid var(--border-dark);
                color: var(--text-light);
                font-size: 0.875rem;
              "
            />
            <button
              id="${cfg.inputId}-color-btn"
              class="px-4 py-2 rounded-lg transition-colors"
              style="background: #cbd5e1; color: #475569; border: 2px solid #94a3b8; min-width: 50px;"
              title="Choisir la couleur">
              <i class="fas fa-palette"></i>
            </button>
            <button
              id="${cfg.btnId}"
              class="px-4 py-2 rounded-lg transition-colors"
              style="background: rgba(71, 85, 105, 0.3); color: var(--text-light);">
              <i class="fas fa-plus"></i> Ajouter
            </button>
          </div>
        </div>

        <!-- Boutons d'action -->
        <div class="flex gap-3" style="justify-content: flex-end; border-top: 2px solid var(--border-dark); padding-top: 1rem;">
          <button
            onclick="document.getElementById('etiquettes-modal').remove(); document.body.style.overflow = '';"
            class="btn-secondary px-4 py-2">
            Annuler
          </button>
          <button
            id="save-etiquettes-btn"
            class="btn-primary px-4 py-2">
            <i class="fas fa-save mr-2"></i>Enregistrer
          </button>
        </div>
      </div>
    `;

    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';

    // Variables temporaires pour stocker les modifications
    // Convertir les strings en objets {label, color} si n√©cessaire
    const convertToObjects = (arr) => arr.map(item =>
      typeof item === 'string' ? { label: item, color: '#3b82f6' } : item
    );

    let tempStatuts = convertToObjects([...currentStatuts]);
    let tempProvenances = convertToObjects([...currentProvenances]);
    let tempTypeTravaux = convertToObjects([...currentTypeTravaux]);
    let tempPaiements = convertToObjects([...currentPaiements]);
    let tempEtiquettes = convertToObjects([...currentEtiquettes]);

    // Choisir la liste temporaire selon le type
    let tempData = type === 'statuts' ? tempStatuts : (type === 'provenances' ? tempProvenances : (type === 'types_travaux' ? tempTypeTravaux : (type === 'paiements' ? tempPaiements : tempEtiquettes)));

    // Fonction pour afficher la liste
    function afficherListe() {
      const liste = document.getElementById(cfg.listId);

      if (tempData.length === 0) {
        liste.innerHTML = '<div style="color: var(--text-gray); font-size: 0.875rem; text-align: center; padding: 2rem;">Aucune √©tiquette. Ajoutez-en une ci-dessous.</div>';
        return;
      }

      liste.innerHTML = tempData.map((item, index) => `
        <div class="flex items-center gap-3 mb-2 p-3 rounded" style="background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-dark);">
          <div
            class="color-badge-preview"
            data-index="${index}"
            style="
              width: 220px;
              height: 40px;
              border-radius: 6px;
              background-color: ${item.color || '#3b82f6'};
              cursor: pointer;
              display: block;
              line-height: 40px;
              text-align: center;
              color: white;
              font-size: 1rem;
              font-weight: 600;
              transition: opacity 0.2s;
              padding: 0 12px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
            "
            onmouseover="this.style.opacity='0.8'"
            onmouseout="this.style.opacity='1'"
            title="${item.label}">
            ${item.label}
          </div>
          <button
            class="delete-item-btn px-3 py-1 rounded transition-colors"
            data-index="${index}"
            style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `).join('');

      // Ajouter les event listeners pour changer la couleur
      liste.querySelectorAll('.color-badge-preview').forEach(badge => {
        badge.addEventListener('click', (e) => {
          const index = parseInt(e.currentTarget.getAttribute('data-index'));
          showColorPaletteForItem(index);
        });
      });

      // Ajouter les event listeners pour les boutons de suppression
      liste.querySelectorAll('.delete-item-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.currentTarget.getAttribute('data-index'));
          tempData.splice(index, 1);
          afficherListe();
        });
      });
    }

    // Fonction pour afficher la palette de couleurs pour un item existant
    function showColorPaletteForItem(index) {
      // Cr√©er un modal pour choisir la couleur
      const colorModal = document.createElement('div');
      colorModal.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
      `;

      const colorsHTML = window.colorPalette.map(color => `
        <div
          class="color-option-item"
          data-color="${color}"
          style="
            min-width: 50px;
            min-height: 50px;
            width: 100%;
            height: 50px;
            border-radius: 8px;
            background: ${color} !important;
            cursor: pointer;
            border: 3px solid ${tempData[index].color === color ? '#3b82f6' : '#475569'};
            box-sizing: border-box;
          "
        >&nbsp;</div>
      `).join('');

      colorModal.innerHTML = `
        <div style="width: 90%; max-width: 400px; padding: 1.5rem; background: #1e293b; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
          <h4 style="color: #e2e8f0; margin-bottom: 1rem; font-weight: 600; font-size: 1.1rem;">Choisir une couleur</h4>
          <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 1rem;">
            ${colorsHTML}
          </div>
          <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button style="padding: 0.5rem 1rem; background: rgba(71, 85, 105, 0.3); color: #e2e8f0; border: none; border-radius: 8px; cursor: pointer;" onclick="this.closest('[style*=fixed]').remove()">Annuler</button>
          </div>
        </div>
      `;

      document.body.appendChild(colorModal);

      colorModal.querySelectorAll('.color-option-item').forEach(option => {
        option.addEventListener('click', () => {
          const color = option.getAttribute('data-color');
          tempData[index].color = color;
          afficherListe();
          colorModal.remove();
        });
      });

      colorModal.addEventListener('click', (e) => {
        if (e.target === colorModal) colorModal.remove();
      });
    }

    // Afficher la liste initiale
    afficherListe();

    // Variable pour stocker la couleur s√©lectionn√©e
    let selectedColor = '#cbd5e1'; // Gris par d√©faut

    // Fonction pour ouvrir la palette de couleurs
    function openColorPalette() {
      console.log('[DEBUG] openColorPalette called, colorPalette:', window.colorPalette);

      const colorModal = document.createElement('div');
      colorModal.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
      `;

      const colorsHTML = window.colorPalette.map(color => `
        <div
          data-color="${color}"
          style="
            min-width: 50px;
            min-height: 50px;
            width: 100%;
            height: 50px;
            border-radius: 8px;
            background: ${color} !important;
            cursor: pointer;
            border: 3px solid ${selectedColor === color ? '#3b82f6' : '#475569'};
            box-sizing: border-box;
            display: block;
          "
        >&nbsp;</div>
      `).join('');

      console.log('[DEBUG] colorsHTML length:', colorsHTML.length);

      colorModal.innerHTML = `
        <div style="width: 90%; max-width: 450px; padding: 1.5rem; background: #1e293b; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
          <h4 style="color: #e2e8f0; margin-bottom: 1rem; font-weight: 600; font-size: 1.1rem;">Choisir une couleur</h4>
          <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 1rem; min-height: 200px;">
            ${colorsHTML}
          </div>
          <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button style="padding: 0.5rem 1rem; background: rgba(71, 85, 105, 0.3); color: #e2e8f0; border: none; border-radius: 8px; cursor: pointer;" onclick="this.closest('[style*=fixed]').remove()">Annuler</button>
          </div>
        </div>
      `;

      document.body.appendChild(colorModal);

      // G√©rer la s√©lection de couleur
      colorModal.querySelectorAll('[data-color]').forEach(option => {
        option.addEventListener('click', () => {
          const color = option.getAttribute('data-color');
          selectedColor = color;
          // Mettre √† jour le bouton couleur
          const colorBtn = document.getElementById(cfg.inputId + '-color-btn');
          if (colorBtn) {
            colorBtn.style.backgroundColor = color;
            colorBtn.style.color = '#fff';
          }
          colorModal.remove();
        });
      });

      // Fermer en cliquant en dehors
      colorModal.addEventListener('click', (e) => {
        if (e.target === colorModal) colorModal.remove();
      });
    }

    // Ajouter event listener sur le bouton couleur
    document.getElementById(cfg.inputId + '-color-btn').addEventListener('click', openColorPalette);

    // Ajouter un item
    document.getElementById(cfg.btnId).addEventListener('click', () => {
      const input = document.getElementById(cfg.inputId);
      const valeur = input.value.trim();

      if (valeur && !tempData.some(item => item.label === valeur)) {
        tempData.push({ label: valeur, color: selectedColor });
        afficherListe();
        input.value = '';
        // R√©initialiser la couleur s√©lectionn√©e au gris
        selectedColor = '#cbd5e1';
        const colorBtn = document.getElementById(cfg.inputId + '-color-btn');
        if (colorBtn) {
          colorBtn.style.backgroundColor = '#cbd5e1';
          colorBtn.style.color = '#475569';
        }
      }
    });

    // Ajouter avec Enter
    document.getElementById(cfg.inputId).addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById(cfg.btnId).click();
    });

    // Sauvegarder les modifications
    document.getElementById('save-etiquettes-btn').addEventListener('click', async () => {
      try {
        // Mettre √† jour les donn√©es selon le type
        if (type === 'statuts') {
          tempStatuts = tempData;
        } else if (type === 'provenances') {
          tempProvenances = tempData;
        } else if (type === 'types_travaux') {
          tempTypeTravaux = tempData;
        } else if (type === 'paiements') {
          tempPaiements = tempData;
        } else if (type === 'etiquettes') {
          tempEtiquettes = tempData;
        }

        const response = await fetch('/api/ventes/etiquettes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: window.username,
            statuts: tempStatuts,
            provenances: tempProvenances,
            types_travaux: tempTypeTravaux,
            paiements: tempPaiements,
            etiquettes: tempEtiquettes
          })
        });

        if (response.ok) {
          log('[VENTES] ‚úÖ √âtiquettes sauvegard√©es');
          // Mettre √† jour les √©tiquettes globales
          window.etiquettesPersonnalisees.statuts = tempStatuts;
          window.etiquettesPersonnalisees.provenances = tempProvenances;
          window.etiquettesPersonnalisees.types_travaux = tempTypeTravaux;
          window.etiquettesPersonnalisees.paiements = tempPaiements;
          window.etiquettesPersonnalisees.etiquettes = tempEtiquettes;
          modal.remove();
          document.body.style.overflow = '';
          // Recharger les donn√©es pour refl√©ter les changements
          await loadVentesDataInternal();
        } else {
          error('[VENTES] ‚ùå Erreur sauvegarde √©tiquettes');
          alert('Erreur lors de la sauvegarde des √©tiquettes');
        }
      } catch (err) {
        error('[VENTES] ‚ùå Erreur r√©seau:', err);
        alert('Erreur r√©seau lors de la sauvegarde');
      }
    });
  };

  // Event delegation for all new badges
  document.addEventListener('click', function(event) {
    const statutBadge = event.target.closest('.statut-vente-badge');
    if (statutBadge) {
      event.stopPropagation();
      const venteId = statutBadge.getAttribute('data-vente-id');
      const currentStatut = statutBadge.getAttribute('data-current-statut');
      const category = statutBadge.getAttribute('data-category');
      // Accepter les valeurs vides (cha√Æne vide pour badges vides)
      if (venteId && category && currentStatut !== null) {
        window.changerStatutVente(venteId, currentStatut, category, event);
      }
      return;
    }

    const provenanceBadge = event.target.closest('.provenance-badge');
    if (provenanceBadge) {
      event.stopPropagation();
      const venteId = provenanceBadge.getAttribute('data-vente-id');
      const currentProvenance = provenanceBadge.getAttribute('data-current-provenance');
      const category = provenanceBadge.getAttribute('data-category');
      // Accepter les valeurs vides (cha√Æne vide pour badges vides)
      if (venteId && category && currentProvenance !== null) {
        window.changerProvenance(venteId, currentProvenance, category, event);
      }
      return;
    }

    const typeTravauxBadge = event.target.closest('.type-travaux-badge');
    if (typeTravauxBadge) {
      event.stopPropagation();
      const venteId = typeTravauxBadge.getAttribute('data-vente-id');
      const currentType = typeTravauxBadge.getAttribute('data-current-type');
      const category = typeTravauxBadge.getAttribute('data-category');
      // Accepter les valeurs vides (cha√Æne vide pour badges vides)
      if (venteId && category && currentType !== null) {
        window.changerTypeTravaux(venteId, currentType, category, event);
      }
      return;
    }

    const paiementBadge = event.target.closest('.paiement-badge');
    if (paiementBadge) {
      event.stopPropagation();
      const venteId = paiementBadge.getAttribute('data-vente-id');
      const currentPaiement = paiementBadge.getAttribute('data-current-paiement');
      const category = paiementBadge.getAttribute('data-category');
      // Accepter les valeurs vides (cha√Æne vide pour badges vides)
      if (venteId && category && currentPaiement !== null) {
        window.changerPaiement(venteId, currentPaiement, category, event);
      }
      return;
    }

    const etiquetteBadge = event.target.closest('.etiquette-badge');
    if (etiquetteBadge) {
      event.stopPropagation();
      const venteId = etiquetteBadge.getAttribute('data-vente-id');
      const currentEtiquette = etiquetteBadge.getAttribute('data-current-etiquette');
      const category = etiquetteBadge.getAttribute('data-category');
      // Accepter les valeurs vides (cha√Æne vide pour badges vides)
      if (venteId && category && currentEtiquette !== null) {
        window.changerEtiquette(venteId, currentEtiquette, category, event);
      }
      return;
    }
  }, true);

  log('[VENTES] ‚úÖ Nouvelles fonctions de badges charg√©es');

  // Load ventes data from backend
  async function loadVentesDataInternal() {
    const username = window.username;
    if (!username) {
      error('[VENTES] Aucun username d√©fini');
      return;
    }

    // Le chargement est permis pour entrepreneurs, coaches et direction
    // Coaches et direction peuvent consulter les ventes de leurs entrepreneurs via le s√©lecteur

    log('[VENTES] Chargement des donn√©es pour:', username);

    // Load all categories
    await Promise.all([
      loadProspects('potentiel-tbody'),
      loadVentesCategory('attente', 'attente-tbody'),
      loadVentesCategory('acceptees', 'accepte-tbody'),
      loadVentesCategory('produit', 'produit-tbody')
    ]);

    log('[VENTES] Toutes les donn√©es charg√©es');
  }

  // ============================================
  // GESTION S√âLECTION MULTIPLE - TOUTES LES TABLES
  // ============================================

  // State pour chaque cat√©gorie
  const selectionState = {
    potentiel: { lastCheckedIndex: null, wasIndeterminate: false },
    attente: { lastCheckedIndex: null, wasIndeterminate: false },
    accepte: { lastCheckedIndex: null, wasIndeterminate: false },
    produit: { lastCheckedIndex: null, wasIndeterminate: false }
  };

  // Mapping tbody IDs
  const tbodyIds = {
    potentiel: 'potentiel-tbody',
    attente: 'attente-tbody',
    accepte: 'accepte-tbody',
    produit: 'produit-tbody'
  };

  // Toggle toutes les checkboxes d'une cat√©gorie (Prospects)
  function toggleSelectAllProspects(checkbox) {
    toggleSelectAllForCategory(checkbox, 'potentiel');
  }

  // Toggle toutes les checkboxes d'une cat√©gorie (Ventes: attente, accepte, produit)
  function toggleSelectAllVentes(checkbox, category) {
    toggleSelectAllForCategory(checkbox, category);
  }

  // Fonction g√©n√©rique pour toggle select all
  function toggleSelectAllForCategory(checkbox, category) {
    const tbodyId = tbodyIds[category];
    const checkboxes = document.querySelectorAll(`#${tbodyId} .prospect-checkbox, #${tbodyId} .vente-checkbox`);
    const state = selectionState[category];

    if (state.wasIndeterminate) {
      checkboxes.forEach(cb => cb.checked = false);
      checkbox.checked = false;
    } else {
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
    }

    state.wasIndeterminate = false;
    state.lastCheckedIndex = null;
    updateGlobalActionBar();
  }

  // Capturer l'√©tat indeterminate avant le click pour toutes les checkboxes "select all"
  document.addEventListener('DOMContentLoaded', function() {
    // Prospects
    const selectAllProspects = document.getElementById('select-all-prospects');
    if (selectAllProspects) {
      selectAllProspects.addEventListener('mousedown', function() {
        selectionState.potentiel.wasIndeterminate = this.indeterminate;
      });
    }

    // Ventes (attente, accepte, produit)
    document.querySelectorAll('.select-all-ventes').forEach(checkbox => {
      checkbox.addEventListener('mousedown', function() {
        const category = this.dataset.category;
        if (category && selectionState[category]) {
          selectionState[category].wasIndeterminate = this.indeterminate;
        }
      });
    });

    // Support Ctrl+A pour s√©lectionner tout
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
        // V√©rifier si on est dans un champ de texte
        const activeElement = document.activeElement;
        if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
          return; // Laisser le comportement par d√©faut dans les champs de texte
        }

        e.preventDefault();

        // S√©lectionner toutes les checkboxes de toutes les tables
        Object.keys(tbodyIds).forEach(category => {
          const tbodyId = tbodyIds[category];
          const checkboxes = document.querySelectorAll(`#${tbodyId} .prospect-checkbox, #${tbodyId} .vente-checkbox`);
          checkboxes.forEach(cb => cb.checked = true);

          // Mettre √† jour le select all header
          const selectAllHeader = document.querySelector(`#${tbodyId}`).closest('.table-container').querySelector('thead .prospect-checkbox, thead .select-all-ventes');
          if (selectAllHeader) {
            selectAllHeader.checked = true;
            selectAllHeader.indeterminate = false;
          }
        });

        updateGlobalActionBar();
      }
    });
  });

  // Gestion du clic sur checkbox prospect (avec Shift+Click)
  function handleProspectCheckboxClick(event, checkbox) {
    handleCheckboxClick(event, checkbox, 'potentiel');
  }

  // Gestion du clic sur checkbox vente (avec Shift+Click)
  function handleVenteCheckboxClick(event, checkbox, category) {
    handleCheckboxClick(event, checkbox, category);
  }

  // Fonction g√©n√©rique pour g√©rer les clics sur checkbox
  function handleCheckboxClick(event, checkbox, category) {
    const tbodyId = tbodyIds[category];
    const checkboxes = Array.from(document.querySelectorAll(`#${tbodyId} .prospect-checkbox, #${tbodyId} .vente-checkbox`));
    const currentIndex = checkboxes.indexOf(checkbox);
    const state = selectionState[category];

    if (event.shiftKey && state.lastCheckedIndex !== null && state.lastCheckedIndex !== currentIndex) {
      const start = Math.min(state.lastCheckedIndex, currentIndex);
      const end = Math.max(state.lastCheckedIndex, currentIndex);
      const shouldCheck = checkbox.checked;

      for (let i = start; i <= end; i++) {
        checkboxes[i].checked = shouldCheck;
      }
    }

    state.lastCheckedIndex = currentIndex;
    updateGlobalActionBar();
  }

  // Mettre √† jour la barre d'actions globale flottante
  function updateGlobalActionBar() {
    let totalSelected = 0;

    // Compter les s√©lections de toutes les cat√©gories et mettre √† jour les headers
    Object.keys(tbodyIds).forEach(category => {
      const tbodyId = tbodyIds[category];
      const tbody = document.getElementById(tbodyId);
      if (!tbody) return;

      const checkboxes = tbody.querySelectorAll('.prospect-checkbox, .vente-checkbox');
      const checked = Array.from(checkboxes).filter(cb => cb.checked);
      totalSelected += checked.length;

      // Mettre √† jour la checkbox "select all" du header
      const table = tbody.closest('table');
      if (table) {
        const selectAll = table.querySelector('thead .prospect-checkbox, thead .select-all-ventes');
        if (selectAll && checkboxes.length > 0) {
          if (checked.length === 0) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
          } else if (checked.length === checkboxes.length) {
            selectAll.checked = true;
            selectAll.indeterminate = false;
          } else {
            selectAll.checked = false;
            selectAll.indeterminate = true;
          }
        }
      }
    });

    // Mettre √† jour la barre flottante
    const actionBar = document.getElementById('floating-action-bar');
    const selectedCount = document.getElementById('global-selected-count');

    if (selectedCount) {
      selectedCount.textContent = totalSelected === 0 ? '0 s√©lectionn√©' : totalSelected === 1 ? '1 s√©lectionn√©' : `${totalSelected} s√©lectionn√©s`;
    }

    if (actionBar) {
      if (totalSelected > 0) {
        actionBar.classList.add('visible');
      } else {
        actionBar.classList.remove('visible');
      }
    }
  }

  // D√©s√©lectionner tout
  function deselectionnerTout() {
    Object.keys(tbodyIds).forEach(category => {
      const tbodyId = tbodyIds[category];
      const checkboxes = document.querySelectorAll(`#${tbodyId} .prospect-checkbox, #${tbodyId} .vente-checkbox`);
      checkboxes.forEach(cb => cb.checked = false);

      // Reset header checkbox
      const tbody = document.getElementById(tbodyId);
      if (tbody) {
        const table = tbody.closest('table');
        if (table) {
          const selectAll = table.querySelector('thead .prospect-checkbox, thead .select-all-ventes');
          if (selectAll) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
          }
        }
      }
    });

    updateGlobalActionBar();
  }

  // Backward compatibility
  function deselectionnerTousProspects() {
    deselectionnerTout();
  }

  // Marquer toute la s√©lection comme perdue
  // Fonction pour afficher le modal de confirmation perdu
  function showPerduConfirmModal(count) {
    return new Promise((resolve) => {
      const modal = document.getElementById('perduConfirmModal');
      const message = document.getElementById('perduConfirmMessage');
      const btnOk = document.getElementById('perduConfirmOk');
      const btnCancel = document.getElementById('perduConfirmCancel');

      message.textContent = `√ätes-vous s√ªr de vouloir marquer ${count} client(s) comme perdu(s) ?`;
      modal.style.display = 'flex';

      const handleConfirm = () => {
        modal.style.display = 'none';
        btnOk.removeEventListener('click', handleConfirm);
        btnCancel.removeEventListener('click', handleCancel);
        resolve(true);
      };

      const handleCancel = () => {
        modal.style.display = 'none';
        btnOk.removeEventListener('click', handleConfirm);
        btnCancel.removeEventListener('click', handleCancel);
        resolve(false);
      };

      btnOk.addEventListener('click', handleConfirm);
      btnCancel.addEventListener('click', handleCancel);
    });
  }

  async function marquerSelectionCommePerdus() {
    // Collecter toutes les s√©lections
    const selections = {
      prospects: [],
      attente: [],
      accepte: [],
      produit: []
    };

    // Prospects
    document.querySelectorAll('#potentiel-tbody .prospect-checkbox:checked').forEach(cb => {
      selections.prospects.push(cb.dataset.prospectId);
    });

    // Ventes (attente, accepte, produit)
    ['attente', 'accepte', 'produit'].forEach(category => {
      const tbodyId = tbodyIds[category];
      document.querySelectorAll(`#${tbodyId} .vente-checkbox:checked`).forEach(cb => {
        selections[category].push({
          venteId: cb.dataset.venteId,
          index: parseInt(cb.dataset.index)
        });
      });
    });

    const totalCount = selections.prospects.length + selections.attente.length + selections.accepte.length + selections.produit.length;

    if (totalCount === 0) return;

    // Afficher le modal de confirmation personnalis√©
    const confirmed = await showPerduConfirmModal(totalCount);
    if (!confirmed) {
      return;
    }

    try {
      // Marquer les prospects comme perdus
      for (const prospectId of selections.prospects) {
        await fetch(`/prospects/${window.username}/${prospectId}/perdu`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
      }

      // Marquer les ventes comme perdues (attente, accepte, produit)
      const categoryMapping = {
        attente: 'attente',
        accepte: 'acceptees',
        produit: 'produit'
      };

      for (const category of ['attente', 'accepte', 'produit']) {
        for (const item of selections[category]) {
          const apiCategory = categoryMapping[category];
          // R√©cup√©rer les donn√©es de la vente
          const venteData = window.ventesData[apiCategory] ? window.ventesData[apiCategory][item.index] : null;
          if (venteData) {
            await fetch(`/ventes/${window.username}/${apiCategory}/${item.venteId}/perdu`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(venteData)
            });
          }
        }
      }

      // Rafra√Æchir toutes les listes
      await Promise.all([
        loadProspects('potentiel-tbody'),
        loadVentesCategory('attente', 'attente-tbody'),
        loadVentesCategory('acceptees', 'accepte-tbody'),
        loadVentesCategory('produit', 'produit-tbody')
      ]);

      // R√©initialiser la s√©lection
      deselectionnerTout();

      // Message de succ√®s avec modal personnalis√©
      showSuccessModal(`${totalCount} client(s) marqu√©(s) comme perdu(s)`);

    } catch (error) {
      console.error('Erreur lors du marquage comme perdu:', error);
      showErrorModal('Erreur lors du marquage comme perdu');
    }
  }

  // Fonction pour afficher un modal de succ√®s
  function showSuccessModal(message) {
    const modal = document.getElementById('perduSuccessModal');
    const msgEl = document.getElementById('perduSuccessMessage');
    const btnOk = document.getElementById('perduSuccessOk');

    msgEl.textContent = message;
    modal.style.display = 'flex';

    const handleClose = () => {
      modal.style.display = 'none';
      btnOk.removeEventListener('click', handleClose);
    };

    btnOk.addEventListener('click', handleClose);
  }

  // Fonction pour afficher un modal d'erreur
  function showErrorModal(message) {
    const modal = document.getElementById('perduErrorModal');
    const msgEl = document.getElementById('perduErrorMessage');
    const btnOk = document.getElementById('perduErrorOk');

    msgEl.textContent = message;
    modal.style.display = 'flex';

    const handleClose = () => {
      modal.style.display = 'none';
      btnOk.removeEventListener('click', handleClose);
    };

    btnOk.addEventListener('click', handleClose);
  }

  // Backward compatibility
  async function marquerProspectsCommePerdus() {
    await marquerSelectionCommePerdus();
  }

  async function loadProspects(tbodyId) {
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;

    // Afficher le loading pendant le chargement
    tbody.innerHTML = `
      <tr class="loading-row">
        <td colspan="10" class="empty-state">
          <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem; color: var(--primary-blue); display: block;"></i>
          <p style="font-size: 1rem; color: var(--text-gray);">Chargement des clients potentiels...</p>
        </td>
      </tr>
    `;

    try {
      // D√©sactiver compl√®tement le cache avec timestamp et cache: 'no-store'
      const timestamp = new Date().getTime();
      const response = await fetch(`/prospects/${window.username}?t=${timestamp}`, {
        cache: 'no-store',
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      });

      if (!response.ok) {
        showEmptyTable(tbody, 'potentiel');
        return;
      }

      const prospects = await response.json();

      if (!prospects || prospects.length === 0) {
        showEmptyTable(tbody, 'potentiel');
        return;
      }

      // Store data globally
      window.ventesData.prospects = prospects;

      // Populate table
      tbody.innerHTML = prospects.map((prospect, index) => {
        const nomComplet = `${prospect.prenom || ''} ${prospect.nom || ''}`.trim() || '-';
        const prospectId = prospect.id || prospect.num || `prospect-${Math.random()}`;

        // Pour les prospects, cr√©er tous les badges (vides par d√©faut)
        const statutBadge = createStatutBadge(prospect.statut_vente || '', prospectId, 'prospects');
        const provenanceBadge = createProvenanceBadge(prospect.provenance || '', prospectId, 'prospects');
        const typeTravauxBadge = createTypeTravauxBadge(prospect.type_travaux || '', prospectId, 'prospects');
        const etiquetteBadge = createEtiquetteBadge(prospect.etiquette || '', prospectId, 'prospects');
        const notesText = prospect.notes || '';
        const hasNotes = notesText && notesText.trim() !== '';

        const prixFormate = prospect.prix ? formatPrix(prospect.prix) : '-';

        return `
        <tr style="cursor: pointer;" onclick='showClientDetails(${index}, "prospects")'>
          <td data-label="Select" style="width: 3%; text-align: center;" onclick="event.stopPropagation()">
            <input type="checkbox" class="prospect-checkbox" data-prospect-index="${index}" data-prospect-id="${prospectId}" onclick="handleProspectCheckboxClick(event, this)">
          </td>
          <td data-label="Nom" style="width: 11%; text-align: left;">${nomComplet}</td>
          <td data-label="REP" style="width: 8%; text-align: left;" onclick="event.stopPropagation()">${statutBadge}</td>
          <td data-label="Provenance" style="width: 8%; text-align: left;" onclick="event.stopPropagation()">${provenanceBadge}</td>
          <td data-label="Type travaux" style="width: 8%; text-align: left;" onclick="event.stopPropagation()">${typeTravauxBadge}</td>
          <td data-label="T√©l√©phone" style="width: 10%; text-align: left;">${prospect.telephone || '-'}</td>
          <td data-label="Adresse" style="width: 17%; text-align: left;" onmouseenter="window.customTooltip.show('${(prospect.adresse || '-').replace(/'/g, "\\'")}', this);" onmouseleave="window.customTooltip.hide();">
            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${prospect.adresse || '-'}</div>
          </td>
          <td data-label="Prix" style="width: 8%; text-align: left;">${prixFormate}</td>
          <td data-label="√âtiquette" style="width: 8%; text-align: left;" onclick="event.stopPropagation()">${etiquetteBadge}</td>
          <td data-label="Notes" style="width: 5%; text-align: center;" onclick="event.stopPropagation()">
            <div style="position: relative; display: inline-block; cursor: pointer;"
                 onclick="editNotes('${prospectId}', 'prospects', \`${notesText.replace(/`/g, '\\`').replace(/\n/g, '\\n')}\`)"
                 title="${hasNotes ? 'Voir/modifier la note' : 'Ajouter une note'}">
              <i class="fas fa-comment-dots note-icon-${prospectId}"
                style="font-size: 1.2rem; color: ${hasNotes ? 'var(--primary-blue)' : 'var(--text-gray)'};">
              </i>
              ${hasNotes ? '<span style="position: absolute; top: -5px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; pointer-events: none;">1</span>' : ''}
            </div>
          </td>
          <td data-label="Paiement" style="width: 11%; text-align: left;">-</td>
        </tr>
      `}).join('');

      log(`[VENTES] ${prospects.length} prospect(s) charg√©(s)`);

      // R√©initialiser l'affichage mobile apr√®s chargement des donn√©es
      if (window.innerWidth <= 600) {
        resetMobileDisplay('potentiel-tbody');
      }

    } catch (err) {
      // Silently handle network errors - file might not exist yet
      showEmptyTable(tbody, 'potentiel');
    }
  }

  async function loadVentesCategory(category, tbodyId) {
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;

    try {
      // D√©sactiver compl√®tement le cache avec timestamp et cache: 'no-store'
      const timestamp = new Date().getTime();
      const response = await fetch(`/cloud/ventes_${category}/${window.username}/ventes.json?t=${timestamp}`, {
        cache: 'no-store',
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      });

      if (!response.ok) {
        log(`[VENTES] Pas de donn√©es ${category} pour ${window.username}`);
        showEmptyTable(tbody, category);
        return;
      }

      const ventes = await response.json();

      if (!ventes || ventes.length === 0) {
        showEmptyTable(tbody, category);
        return;
      }

      // Store data globally
      window.ventesData[category] = ventes;

      // Charger les statuts de facturation pour acceptees/produit
      let statutsFacturation = {};
      if (category === 'acceptees' || category === 'produit') {
        try {
          const entrepreneurUsername = window.selectedEntrepreneurUsername || window.username;
          const statutsResponse = await fetch(`/cloud/facturation_qe_statuts/${entrepreneurUsername}/statuts_clients.json?t=${new Date().getTime()}`);
          if (statutsResponse.ok) {
            statutsFacturation = await statutsResponse.json();
            log('[VENTES] Statuts facturation charg√©s:', Object.keys(statutsFacturation).length);
          }
        } catch (e) {
          log('[VENTES] Pas de statuts facturation disponibles');
        }
      }

      // Populate table
      tbody.innerHTML = ventes.map((vente, index) => {
        // Support both formats: prenom/nom (attente) and clientPrenom/clientNom (acceptees/produit)
        const prenom = vente.prenom || vente.clientPrenom || '';
        const nom = vente.nom || vente.clientNom || '';
        const nomComplet = `${prenom} ${nom}`.trim() || '-';

        // Format price if it's a number without formatting
        let prixFormate = vente.prix || '-';
        if (prixFormate !== '-' && !prixFormate.includes('$')) {
          // Convert "1500.00" to "1 500,00 $"
          const prixNum = parseFloat(prixFormate);
          if (!isNaN(prixNum)) {
            prixFormate = prixNum.toLocaleString('fr-FR', {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            }).replace(/\s/g, '\u00A0') + '\u00A0$';
          }
        }

        // Create paiement display
        const venteId = vente.id || vente.num || `vente-${Math.random()}`;
        // Pour attente: "-", pour acceptees/produit: barre de progression
        let paiementDisplay;
        if (category === 'attente') {
          paiementDisplay = '-';
        } else {
          // acceptees ou produit - barre de progression bas√©e sur les statuts de facturation
          const numeroSoumission = vente.numeroSoumission || vente.num;
          const statutClient = statutsFacturation[numeroSoumission] || null;
          const prixVente = vente.prix || '0';
          paiementDisplay = createPaiementProgressBar(statutClient, prixVente);
        }

        // Cr√©er les badges pour les nouvelles colonnes (vides par d√©faut)
        const statutBadge = createStatutBadge(vente.statut_vente || '', venteId, category);
        const provenanceBadge = createProvenanceBadge(vente.provenance || '', venteId, category);
        const typeTravauxBadge = createTypeTravauxBadge(vente.type_travaux || '', venteId, category);
        const etiquetteBadge = createEtiquetteBadge(vente.etiquette || '', venteId, category);
        const notesText = vente.notes || '';
        const hasNotes = notesText && notesText.trim() !== '';

        // Mapper category pour l'identifiant du tbody
        const tbodyMapping = {
          'attente': 'attente',
          'acceptees': 'accepte',
          'produit': 'produit'
        };
        const categoryId = tbodyMapping[category] || category;

        return `
        <tr style="cursor: pointer;" onclick='showClientDetails(${index}, "${category}")'>
          <td class="checkbox-column" style="width: 3%; text-align: center; padding: 0.5rem;" onclick="event.stopPropagation()">
            <input type="checkbox" class="vente-checkbox prospect-checkbox" data-vente-id="${venteId}" data-category="${categoryId}" data-index="${index}" onclick="handleVenteCheckboxClick(event, this, '${categoryId}')">
          </td>
          <td data-label="Nom" style="width: 10%; text-align: left;">${nomComplet}</td>
          <td data-label="REP" style="width: 8%; text-align: left;" onclick="event.stopPropagation()">${statutBadge}</td>
          <td data-label="Provenance" style="width: 8%; text-align: left;" onclick="event.stopPropagation()">${provenanceBadge}</td>
          <td data-label="Type travaux" style="width: 8%; text-align: left;" onclick="event.stopPropagation()">${typeTravauxBadge}</td>
          <td data-label="T√©l√©phone" style="width: 10%; text-align: left;">${vente.telephone || '-'}</td>
          <td data-label="Adresse" style="width: 16%; text-align: left;" onmouseenter="window.customTooltip.show('${(vente.adresse || '-').replace(/'/g, "\\'")}', this);" onmouseleave="window.customTooltip.hide();">
            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${vente.adresse || '-'}</div>
          </td>
          <td data-label="Prix" style="width: 9%; text-align: left;">${prixFormate}</td>
          <td data-label="√âtiquette" style="width: 8%; text-align: left;" onclick="event.stopPropagation()">${etiquetteBadge}</td>
          <td data-label="Notes" style="width: 5%; text-align: center;" onclick="event.stopPropagation()">
            <div style="position: relative; display: inline-block; cursor: pointer;"
                 onclick="editNotes('${venteId}', '${category}', \`${notesText.replace(/`/g, '\\`').replace(/\n/g, '\\n')}\`)"
                 title="${hasNotes ? 'Voir/modifier la note' : 'Ajouter une note'}">
              <i class="fas fa-comment-dots note-icon-${venteId}"
                style="font-size: 1.2rem; color: ${hasNotes ? 'var(--primary-blue)' : 'var(--text-gray)'};">
              </i>
              ${hasNotes ? '<span style="position: absolute; top: -5px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; pointer-events: none;">1</span>' : ''}
            </div>
          </td>
          <td data-label="Paiement" style="width: 12%; text-align: left;">${paiementDisplay}</td>
        </tr>
      `}).join('');

      log(`[VENTES] ${ventes.length} vente(s) ${category} charg√©e(s)`);

      // Calculer et afficher le total $ pour cette cat√©gorie
      updateCategoryTotal(category, ventes);

      // R√©initialiser l'affichage mobile apr√®s chargement des donn√©es
      if (window.innerWidth <= 600) {
        resetMobileDisplay(tbodyId);
      }

    } catch (err) {
      error(`[VENTES] Erreur chargement ${category}:`, err);
      showEmptyTable(tbody, category);
      // R√©initialiser le total √† 0 en cas d'erreur
      updateCategoryTotal(category, []);
    }
  }

  // Fonction pour calculer et afficher le total $ d'une cat√©gorie
  function updateCategoryTotal(category, ventes) {
    // Mapping des cat√©gories vers les IDs des √©l√©ments total
    const totalIds = {
      'attente': 'total-attente',
      'acceptees': 'total-accepte',
      'produit': 'total-produit'
    };

    const totalId = totalIds[category];
    if (!totalId) return; // Pas de total pour "potentiel"

    const totalElement = document.getElementById(totalId);
    if (!totalElement) return;

    // Calculer le total
    let total = 0;
    if (ventes && ventes.length > 0) {
      ventes.forEach(vente => {
        let prix = vente.prix || '0';
        // Nettoyer le prix (enlever $, espaces, remplacer , par .)
        if (typeof prix === 'string') {
          prix = prix.replace(/\s/g, '').replace('$', '').replace(',', '.').replace(/[^\d.]/g, '');
        }
        const prixNum = parseFloat(prix);
        if (!isNaN(prixNum)) {
          total += prixNum;
        }
      });
    }

    // Formater et afficher le total
    const totalFormate = Math.round(total).toLocaleString('fr-CA');
    const spanTotal = totalElement.querySelector('span:last-child');
    if (spanTotal) {
      spanTotal.textContent = `${totalFormate} $`;
    }

    log(`[VENTES] Total ${category}: ${totalFormate} $`);
  }

  function showEmptyTable(tbody, category) {
    const icons = {
      'potentiel': 'fa-user-plus',
      'attente': 'fa-clock',
      'acceptees': 'fa-check-circle',
      'produit': 'fa-box'
    };
    const labels = {
      'potentiel': 'potentiel',
      'attente': 'en attente',
      'acceptees': 'accept√©',
      'produit': 'produit'
    };
    // Colspan 11 pour les tables avec checkbox (attente, acceptees, produit), 8 pour potentiel
    const colspan = (category === 'potentiel') ? '8' : '11';

    tbody.innerHTML = `
      <tr>
        <td colspan="${colspan}" class="empty-state">
          <i class="fas ${icons[category]}" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
          <p style="font-size: 1rem;">Aucun client ${labels[category]}</p>
        </td>
      </tr>
    `;
  }

  // Function called by entrepreneur-selector.js when coach selects an entrepreneur
  window.loadVentesData = async function() {
    log('[VENTES] Chargement des donn√©es pour le nouvel entrepreneur:', window.username);

    // Supprimer l'anti-flash CSS pour rendre le contenu visible
    const antiFlashStyle = document.getElementById('coach-anti-flash-css');
    if (antiFlashStyle) {
      antiFlashStyle.remove();
      log('[VENTES] Anti-flash CSS supprim√©');
    }

    // Load ventes data
    await loadVentesDataInternal();

    log('[VENTES] Interface pr√™te pour:', window.username);
  };

  // Load data on page load if username is already set
  window.addEventListener('DOMContentLoaded', function() {
    setTimeout(async function() {
      if (window.username) {
        log('[VENTES] Chargement initial des donn√©es pour:', window.username);
        await loadVentesDataInternal();
      }
    }, 500);
  });
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZDi-RMHDdA4l-4sv_5H8GhsUAYXV4DVE&libraries=places&callback=initProspectAutocomplete&language=fr&region=CA"
  async
  defer
></script>
  <script src="/entrepreneur-selector.js"></script>

  <!-- Floating action bar pour s√©lection multiple -->
  <div id="floating-action-bar">
    <div style="display: flex; align-items: center; gap: 0.75rem;">
      <span id="global-selected-count" style="color: #60a5fa; font-weight: 600; font-size: 0.95rem;">0 s√©lectionn√©(s)</span>
    </div>
    <div style="display: flex; gap: 0.5rem;">
      <button onclick="marquerSelectionCommePerdus()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; color: white; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; font-weight: 500; transition: all 0.2s ease;">
        <i class="fas fa-times-circle"></i> Marquer comme perdu
      </button>
      <button onclick="deselectionnerTout()" style="background: rgba(148, 163, 184, 0.2); border: 1px solid rgba(148, 163, 184, 0.3); color: var(--text-light); padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.2s ease;">
        <i class="fas fa-times"></i> Annuler
      </button>
    </div>
  </div>
</body>
</html>
