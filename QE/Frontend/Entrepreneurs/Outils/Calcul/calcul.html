<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Calculateur</title>

  <!-- üì± PWA Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#5271ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Qwota">
  <meta name="msapplication-TileColor" content="#5271ff">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Ic√¥nes PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

  <!-- Script Service Worker -->
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      /* DISABLED - Service Worker
      navigator.serviceWorker.register('/sw.js')
        .then((registration) => {
        })
        .catch((registrationError) => {
        });
      */
    });
  }
  </script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="/favicon" type="image/x-icon">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/base.css">
  <link rel="stylesheet" href="/entrepreneur-selector.css">

<!-- Variables globales d√©finies dans common.js -->
<script src="/common.js"></script>
<script>
  // Ces variables sont maintenant g√©r√©es par common.js
  // username, userRole, canEditParameters sont disponibles globalement

  // Script anti-flash pour coach/direction
  (function() {
    const userRole = localStorage.getItem('userRole');
    const isCoachOrDirection = userRole === 'coach' || userRole === 'direction';
    const urlParams = new URLSearchParams(window.location.search);
    const userParam = urlParams.get('user');
    const coachUsername = localStorage.getItem('username');
    const pendingProjectLoad = localStorage.getItem('pendingProjectLoad');
    const selectedEntrepreneurBeforeReload = sessionStorage.getItem('selectedEntrepreneurBeforeReload');

    // Ne PAS afficher le s√©lecteur si:
    // - On est en train de charger un projet
    // - Un entrepreneur √©tait s√©lectionn√© avant le reload
    const shouldShowSelector = isCoachOrDirection &&
                               (!userParam || userParam === coachUsername) &&
                               !pendingProjectLoad &&
                               !selectedEntrepreneurBeforeReload;

    if (shouldShowSelector) {
      // Injecter le CSS imm√©diatement pour cacher le contenu et afficher le s√©lecteur
      const style = document.createElement('style');
      style.id = 'coach-anti-flash-css';
      style.textContent = `
        .main-content {
          opacity: 0 !important;
          pointer-events: none !important;
        }
        #coach-selector-backdrop {
          display: block !important;
          opacity: 1 !important;
          pointer-events: all !important;
        }
        #coach-entrepreneur-selector {
          display: block !important;
          opacity: 1 !important;
        }
      `;
      document.head.appendChild(style);
    }
  })();
</script>

<!-- Styles sp√©cifiques au Calculateur -->
<link rel="stylesheet" href="/calcul.css">

<style>
  /* Titre du s√©lecteur entrepreneur */
  #coach-entrepreneur-selector .selector-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-light);
    text-align: center;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  #coach-entrepreneur-selector .selector-title i {
    color: var(--primary-blue);
  }

  #coach-entrepreneur-selector.in-header .selector-title {
    display: none;
  }

  /* Sous-titre du s√©lecteur */
  #coach-entrepreneur-selector .selector-subtitle {
    font-size: 0.9rem;
    color: var(--text-gray);
    text-align: center;
    margin-bottom: 1.5rem;
  }

  #coach-entrepreneur-selector.in-header .selector-subtitle {
    display: none;
  }

  /* D√©sactiver les effets hover sur les boutons d√©sactiv√©s */
  button:disabled,
  button[disabled] {
    pointer-events: none !important;
    cursor: not-allowed !important;
    opacity: 0.5 !important;
  }

  button:disabled:hover,
  button[disabled]:hover {
    transform: none !important;
    box-shadow: none !important;
  }

  .btn-primary:disabled:hover,
  .btn-secondary:disabled:hover,
  .blue-hover:disabled:hover {
    transform: none !important;
    box-shadow: none !important;
  }

  /* Animation de chargement/succ√®s */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgb(15, 23, 42);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
  }

  .loading-content {
    text-align: center;
    color: white;
    animation: scaleIn 0.5s ease;
  }

  .loading-spinner {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
    animation: pulse 1.5s ease infinite;
  }

  .loading-spinner i {
    font-size: 32px;
    color: white;
    animation: spin 1s linear infinite;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes scaleIn {
    from {
      transform: scale(0.8);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
      box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
    }
    50% {
      transform: scale(1.05);
      box-shadow: 0 0 50px rgba(59, 130, 246, 0.7);
    }
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* ============================================
     MOBILE & TABLETTE STYLES
     ============================================ */
  /* Container mobile: dropdown + bouton sur la m√™me ligne */
  .mobile-header-row {
    display: flex !important;
    flex-direction: row !important;
    align-items: stretch !important;
    gap: 0.75rem;
    width: 100%;
  }

  .mobile-header-row .mobile-tabs-dropdown {
    flex: 1;
    display: block !important;
  }

  /* Style du trigger dropdown pour correspondre √† la hauteur du bouton */
  .mobile-header-row .mobile-tabs-dropdown-trigger {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    background: rgba(23, 32, 51, 0.8) !important;
    border: 1px solid var(--border-dark) !important;
    border-radius: 12px !important;
    padding: 12px 16px !important;
    height: 60px !important;
    min-height: 60px !important;
    max-height: 60px !important;
    cursor: pointer !important;
    transition: all 0.2s ease;
    box-sizing: border-box !important;
  }

  .mobile-header-row .mobile-tabs-dropdown-trigger:hover {
    border-color: var(--primary-blue);
    background: rgba(23, 32, 51, 1);
  }

  .mobile-header-row .mobile-complete-btn {
    flex-shrink: 0;
    height: 60px !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    padding: 12px 16px !important;
    white-space: nowrap;
    border-radius: 12px !important;
  }

  @media (max-width: 1024px) {
    /* Cacher l'indicateur auto-save sur mobile/tablette */
    #auto-save-status {
      display: none !important;
    }

    /* Afficher le header mobile (dropdown + bouton) */
    #mobile-header-row {
      display: flex !important;
    }

    /* Cacher les tabs desktop */
    .desktop-tabs-container {
      display: none !important;
    }
  }

  @media (min-width: 1025px) {
    /* Cacher le header mobile sur desktop */
    #mobile-header-row {
      display: none !important;
    }

    /* Afficher les tabs desktop */
    .desktop-tabs-container {
      display: flex !important;
    }
  }

  /* Bouton flottant Total pour mobile */
  #mobile-total-btn {
    position: fixed;
    top: 80px;
    right: 15px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 10px 16px;
    border-radius: 25px;
    font-weight: 600;
    font-size: 14px;
    border: none;
    cursor: pointer;
    z-index: 9998;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    display: none;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
  }

  #mobile-total-btn:active {
    transform: scale(0.95);
  }

</style>

</head>
<body class="min-h-screen" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: var(--text-light); margin: 0; padding: 0;">

  <!-- Bouton flottant Total pour mobile (visible uniquement dans un projet) -->
  <button id="mobile-total-btn" onclick="openMobileTotalPopup()" style="display: none;">
    <i class="fas fa-dollar-sign"></i>
    <span id="mobile-total-value">0,00 $</span>
  </button>

  <!-- Backdrop pour le s√©lecteur coach (√©tat centr√©) -->
  <div id="coach-selector-backdrop"></div>

  <!-- S√©lecteur d'entrepreneur (visible uniquement pour les coaches) -->
  <div id="coach-entrepreneur-selector">
    <!-- Titre de la page avec ic√¥ne Calculateur -->
    <div class="page-identity">
      <div class="page-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3), 0 0 40px rgba(59, 130, 246, 0.15);">
        <i class="fas fa-calculator"></i>
      </div>
      <div class="page-name" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #60a5fa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Calculateur</div>
    </div>

    <!-- Titre et sous-titre (visibles uniquement en mode centr√©) -->
    <div class="selector-title">
      <i class="fas fa-user-tie"></i>
      S√©lectionnez un entrepreneur
    </div>
    <div class="selector-subtitle">Choisissez l'entrepreneur dont vous souhaitez utiliser le calculateur</div>

    <div class="selector-container">
      <div class="selector-label">
        <i class="fas fa-user-tie"></i>
        <span>Entrepreneur:</span>
      </div>
      <div class="coach-dropdown">
        <div class="coach-dropdown-toggle" id="coach-dropdown-toggle">
          <span class="placeholder">-- S√©lectionner un entrepreneur --</span>
          <input type="text" class="search-input" id="search-input" placeholder="Rechercher..." autocomplete="off" style="display: none;">
          <i class="fas fa-chevron-down chevron"></i>
        </div>
        <div class="coach-dropdown-menu" id="coach-dropdown-menu">
          <!-- Options charg√©es dynamiquement -->
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Wrapper pour les transitions coach -->
  <div id="main-content-wrapper">

  <!-- Popup de s√©lection client (mobile uniquement) -->
  <div id="clientSelectionPopup" class="client-selection-popup">
    <div class="client-selection-popup-content">
      <div class="client-selection-popup-header">
        <h3>
          <i class="fas fa-users mr-2"></i>
          S√©lectionner un client
        </h3>
        <button class="client-selection-popup-close" onclick="closeClientSelectionPopup()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="clientSelectionPopupList" class="client-selection-popup-list">
        <div class="client-selection-empty">
          <i class="fas fa-users text-3xl mb-2" style="opacity: 0.3;"></i>
          <p>Aucun client disponible</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Wrapper pour SPA - extraction du contenu uniquement -->
  <div class="main-content w-full" style="width: 100%; padding: 2rem;">

  <!-- Bouton Retour -->
  <div id="back-button-container" class="mb-6">
    <button id="back-to-outils-btn" onclick="goBackToOutils()" class="back-button">
      <i class="fas fa-arrow-left"></i>
      <span class="back-button-text">Retour aux outils</span>
    </button>
  </div>

  <!-- Contenu principal -->
  <div class="w-full">

    <!-- Header -->
    <div class="mb-10">
      <div class="relative">
        <h1 class="text-4xl font-bold mb-3" style="color: var(--text-light);">
          Calculateur d'Estimation
        </h1>
        <span class="absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-blue-600 to-blue-400 rounded-full"></span>
        <div class="flex items-center justify-between">
          <p class="text-xl font-medium">Calculateur pour peinture ext√©rieure et int√©rieure</p>
          <div class="text-sm flex items-center">
            <i class="fas fa-calendar-alt mr-2"></i>
            <span id="currentDate">Aujourd'hui</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Section Info Client -->
    <div class="box mb-6">
      <div class="box-header">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          <div class="box-header-icon" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);">
            <i class="fas fa-user"></i>
          </div>
          <h2 class="box-header-title">Informations Client</h2>
        </div>
      </div>
      <div class="box-body">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
          <p id="clientInfoValidationMessage" class="text-sm" style="color: #e57373; margin: 0;">
            <i class="fas fa-info-circle mr-1"></i>
            Pour cr√©er un projet, remplissez les informations client ci-dessous
          </p>
          <div style="display: flex; align-items: center; gap: 10px; margin-left: auto;">
            <button type="button" id="editClientInfoBtn" onclick="toggleEditClientInfo()"
                    style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 14px; border: none; cursor: pointer; transition: all 0.3s ease; display: none; align-items: center; gap: 8px;">
              <i class="fas fa-user-edit"></i>
              Modifier les infos
            </button>
            <button id="createProjectBtn" onclick="createProjectFromButton()" disabled
                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 14px; border: none; cursor: not-allowed; opacity: 0.5; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-plus-circle"></i>
              Cr√©er le projet
            </button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">
              <i class="fas fa-user mr-2" style="color: #60a5fa;"></i>Pr√©nom
            </label>
            <input type="text" id="clientPrenom" class="input-field" placeholder="Pr√©nom" style="border-right: 2px solid #e57373 !important;" oninput="this.style.setProperty('border-right-color', this.value.trim() ? '#4caf50' : '#e57373', 'important'); setTimeout(() => updateClientValidationMessage(), 0);">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">
              <i class="fas fa-user mr-2" style="color: var(--primary-purple);"></i>Nom
            </label>
            <input type="text" id="clientNom" class="input-field" placeholder="Nom" style="border-right: 2px solid #e57373 !important;" oninput="this.style.setProperty('border-right-color', this.value.trim() ? '#4caf50' : '#e57373', 'important'); setTimeout(() => updateClientValidationMessage(), 0);">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">
              <i class="fas fa-map-marker-alt mr-2" style="color: var(--primary-green);"></i>Adresse
            </label>
            <input type="text"
                   id="clientAddress"
                   class="input-field"
                   placeholder="123 Rue de la Paix, Montr√©al, QC"
                   autocomplete="new-password"
                   autocorrect="off"
                   autocapitalize="off"
                   spellcheck="false"
                   readonly
                   onfocus="this.removeAttribute('readonly');"
                   oninput="this.style.setProperty('border-right-color', this.value.trim() ? '#4caf50' : '#e57373', 'important'); setTimeout(() => updateClientValidationMessage(), 0);"
                   data-form-type="other"
                   style="border-right: 2px solid #e57373 !important;">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">
              <i class="fas fa-phone mr-2" style="color: var(--primary-orange);"></i>T√©l√©phone
            </label>
            <input type="tel" id="clientPhone" class="input-field" placeholder="000-000-0000" maxlength="12" style="border-right: 2px solid #e57373 !important;" oninput="const isValidPhone = /^\d{3}-\d{3}-\d{4}$/.test(this.value.trim()); this.style.setProperty('border-right-color', isValidPhone ? '#4caf50' : '#e57373', 'important'); setTimeout(() => updateClientValidationMessage(), 0);">
          </div>
        </div>

        <!-- Clients √† compl√©ter aujourd'hui -->
        <div class="pt-6" style="border-top: 1px solid var(--border-dark);">
          <div class="p-4 rounded-lg cursor-pointer transition-all duration-300 hover:bg-opacity-70" 
               style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.4) 0%, rgba(51, 65, 85, 0.4) 100%); border: 1px solid var(--border-dark);" 
               onclick="toggleClientsMenu()">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center" 
                     style="background: linear-gradient(135deg, var(--primary-teal) 0%, #14b8a6 100%); box-shadow: 0 4px 12px rgba(45, 212, 191, 0.3);">
                  <i class="fas fa-users text-white text-lg"></i>
                </div>
                <div>
                  <h3 class="text-lg font-bold" style="color: var(--text-light);">
                    Clients √† compl√©ter aujourd'hui
                  </h3>
                  <p class="text-sm opacity-80">
                    Synchronisation avec Google Agenda
                  </p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <span class="px-3 py-1 rounded-full text-xs font-medium" 
                      style="background: rgba(45, 212, 191, 0.2); color: var(--primary-teal); border: 1px solid rgba(45, 212, 191, 0.3);">
                  0 client(s)
                </span>
                <i id="clients-arrow" class="fas fa-chevron-up transition-transform duration-300 text-lg" 
                  ></i>
              </div>
            </div>
          </div>
          <div id="clients-content" class="mt-4 transition-all duration-300 ease-in-out clients-collapsed" style="max-height: 0; opacity: 0;">
            <div class="table-container">
              <table class="modern-table">
                <thead>
                  <tr>
                    <th>Pr√©nom</th>
                    <th>Nom</th>
                    <th>Adresse</th>
                    <th>T√©l√©phone</th>
                    <th class="text-center" style="text-align: center !important;">Action</th>
                  </tr>
                </thead>
                <tbody id="clients-body">
                  <tr>
                    <td colspan="5" class="empty-state">
                      <i class="fas fa-calendar-times"></i>
                      <p>Aucun client √† compl√©ter aujourd'hui</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <!-- Liste mobile simple -->
            <div id="mobile-clients-list" class="mobile-clients-list" style="display: none;">
              <!-- Sera peupl√© dynamiquement -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="mb-6">
      <!-- Container mobile: dropdown + bouton sur la m√™me ligne -->
      <div id="mobile-header-row" class="mobile-header-row" style="display: none;">
        <!-- Menu dropdown mobile pour les tabs -->
        <div id="mobile-tabs-dropdown" class="mobile-tabs-dropdown">
          <div class="mobile-tabs-dropdown-trigger" onclick="toggleMobileTabsDropdown()">
            <div class="flex items-center gap-2">
              <i id="mobile-tabs-icon" class="fas fa-calculator" style="color: var(--primary-blue);"></i>
              <span id="mobile-tabs-current" style="font-weight: 600; color: var(--text-light);">Ext√©rieur</span>
            </div>
            <i id="mobile-tabs-arrow" class="fas fa-chevron-down transition-transform" style="color: var(--text-gray);"></i>
          </div>
          <div id="mobile-tabs-menu" class="mobile-tabs-menu" style="display: none;">
            <div class="mobile-tab-option" onclick="switchTabMobile('estimation')">
              <i class="fas fa-calculator" style="color: var(--primary-blue);"></i>
              <span>Ext√©rieur</span>
            </div>
            <div class="mobile-tab-option" onclick="switchTabMobile('interieur')">
              <i class="fas fa-home" style="color: var(--primary-green);"></i>
              <span>Int√©rieur</span>
            </div>
            <div class="mobile-tab-option" onclick="switchTabMobile('produits')">
              <i class="fas fa-paint-roller" style="color: var(--primary-orange);"></i>
              <span>Produits</span>
            </div>
            <div class="mobile-tab-option" id="mobile-parametres-option" onclick="switchTabMobile('parametres-admin')" style="display: none !important;">
              <i class="fas fa-tools" style="color: var(--primary-purple);"></i>
              <span>Param√®tres</span>
            </div>
            <div class="mobile-tab-option" onclick="switchTabMobile('mes-projets')">
              <i class="fas fa-folder" style="color: var(--primary-teal);"></i>
              <span>Mes Projets</span>
            </div>
          </div>
        </div>

        <!-- Bouton Compl√©ter mobile (sur la m√™me ligne) -->
        <button id="completer-btn-mobile" class="mobile-action-btn mobile-complete-btn" onclick="completerSoumission()" disabled>
          <i class="fas fa-paper-plane"></i>
          <span>Compl√©ter</span>
        </button>
      </div>

      <!-- Tabs desktop (cach√©s sur mobile) -->
      <div class="tab-spacing flex justify-between items-center desktop-tabs-container">
        <div class="flex" style="gap: 1rem;">
          <button id="estimation-tab-btn" class="btn-primary" onclick="switchTab('estimation')" style="font-size: 12px !important; padding: 8px 12px !important;">
            <i class="fas fa-calculator mr-2"></i>Ext√©rieur
          </button>
          <button id="interieur-tab-btn" class="btn-secondary" onclick="switchTab('interieur')" style="font-size: 12px !important; padding: 8px 12px !important;">
            <i class="fas fa-home mr-2"></i>Int√©rieur
          </button>
          <button id="produits-tab-btn" class="btn-secondary" onclick="switchTab('produits')" style="font-size: 12px !important; padding: 8px 12px !important;">
            <i class="fas fa-paint-roller mr-2"></i>Produits
          </button>
          <button id="parametres-admin-tab-btn" class="btn-secondary" onclick="switchTab('parametres-admin')" data-role="direction" style="display: none !important; font-size: 12px !important; padding: 8px 12px !important;">
            <i class="fas fa-tools mr-2"></i>Param√®tres
          </button>
          <button id="mes-projets-tab-btn" class="btn-secondary" onclick="switchTab('mes-projets')" style="font-size: 12px !important; padding: 8px 12px !important;">
            <i class="fas fa-folder mr-2"></i>Mes Projets
          </button>
        </div>

        <!-- Bouton Compl√©ter soumission (activ√© uniquement dans un projet) -->
        <div class="flex" style="gap: 1rem;">
          <button id="completer-btn" onclick="completerSoumission()" class="btn-primary" style="font-size: 12px !important; padding: 8px 12px !important;" disabled>
            <i class="fas fa-file-alt mr-2"></i>Compl√©ter soumission
          </button>
        </div>
      </div>

    </div>

    <!-- Popup Modal pour Total/D√©tails/Configuration sur mobile -->
    <div id="total-popup-overlay" class="total-popup-overlay" style="display: none;" onclick="closeTotalPopup(event)">
      <div class="total-popup-content" onclick="event.stopPropagation()">
        <div class="total-popup-header">
          <h2 id="total-popup-title">Total et D√©tails</h2>
          <button class="total-popup-close" onclick="closeTotalPopup()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="total-popup-body" class="total-popup-body">
          <!-- Le contenu sera inject√© dynamiquement -->
        </div>
      </div>
    </div>

    <!-- Estimation Tab -->
    <div id="estimation-tab" class="tab-content">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column: Input Forms -->
        <div class="lg:col-span-2 space-y-6">
          <!-- SECTION LAVAGE -->
          <div class="box">
            <div class="box-header">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="box-header-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                  <i class="fas fa-spray-can"></i>
                </div>
                <h2 class="box-header-title">Travaux de Lavage</h2>
              </div>
            </div>
            <div class="box-body">
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">S√©lectionner un type de lavage :</label>
                <select id="lavage-select" class="select-field">
                  <option value="">Choisir un type...</option>
                  <option value="lavage_pression">Lavage √† pression (ft¬≤)</option>
                  <option value="lavage_main_lineaire">Lavage √† la main lin√©aire (ft)</option>
                  <option value="lavage_main">Lavage √† la main surface (ft¬≤)</option>
                  <option value="lavage_plancher_balcon">Lavage √† pression intense sur plancher balcon (ft¬≤)</option>
                  <option value="lavage_portes_fenetres">Lavage portes et fen√™tres √† l'unit√© (qte)</option>
                </select>
              </div>
              <button id="ajouter-lavage" class="btn-primary" onclick="ajouterLavage()">
                <i class="fas fa-plus"></i> Ajouter ce lavage
              </button>
              
              <!-- Container des Lavages dans la m√™me bo√Æte -->
              <div id="lavages-container" class="mt-6">
                <!-- Les lavages ajout√©s appara√Ætront ici dynamiquement -->
              </div>
            </div>
          </div>

          <!-- SECTION PR√âPARATION -->
          <div class="box">
            <div class="box-header">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="box-header-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                  <i class="fas fa-tools"></i>
                </div>
                <h2 class="box-header-title">Travaux de Pr√©paration</h2>
              </div>
            </div>
            <div class="box-body">
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">S√©lectionner un type de pr√©paration :</label>
                <select id="preparation-select" class="select-field">
                  <option value="">Choisir un type...</option>
                  <option value="grattage_40min">Grat. spot de 40 minutes ou fen√™tre compl√®te (# spot)</option>
                  <option value="grattage_20min">Grat. spot de 20 minutes ou demi-fen√™tre (# spot)</option>
                  <option value="grattage_10min">Grat. spot de 10 minutes ou quart de fen√™tre (# spot)</option>
                  <option value="grat_mur_ecaille_peu">Grat. mur complet (√©caille un peu) (ft¬≤)</option>
                  <option value="grat_mur_ecaille_beaucoup">Grat. mur complet (√©caille consid√©rablement) (ft¬≤)</option>
                  <option value="grat_mur_ecaille_tout">Grat. mur complet (toute la peinture est √©caill√©e) (ft¬≤)</option>
                  <option value="grat_corniches_1er_peu">Grat. corniches 1er (√©caille un peu par endroit) (ft)</option>
                  <option value="grat_corniches_1er_tout">Grat. corniches 1er (presque tout √©caill√©) (ft)</option>
                  <option value="grat_corniches_2e_peu">Grat. corniches 2e (√©caille un peu par endroit) (ft)</option>
                  <option value="grat_corniches_2e_tout">Grat. corniches 2e (presque tout √©caill√©) (ft)</option>
                  <option value="sablage_surface">Sablage de surface (ft¬≤)</option>
                </select>
              </div>
              <button id="ajouter-preparation" class="btn-primary" onclick="ajouterPreparation()">
                <i class="fas fa-plus"></i> Ajouter cette pr√©paration
              </button>
              
              <!-- Container des Pr√©parations dans la m√™me bo√Æte -->
              <div id="preparations-container" class="mt-6">
                <!-- Les pr√©parations ajout√©es appara√Ætront ici dynamiquement -->
              </div>
            </div>
          </div>

          <!-- PRIMER SURFACE COMPL√àTE -->
          <div class="box">
            <div class="box-header">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="box-header-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                  <i class="fas fa-brush"></i>
                </div>
                <h2 class="box-header-title">Primer surface compl√®te</h2>
              </div>
            </div>
            <div class="box-body">
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">S√©lectionner un type de surface :</label>
                <select id="primer-surface-select" class="select-field">
                  <option value="">Choisir une surface...</option>
                  <option value="surface_facile">Primer surface compl√®te ‚Äì facile (ft¬≤)</option>
                  <option value="surface_difficile">Primer surface compl√®te ‚Äì difficile (ft¬≤) ‚Äì 100 ft</option>
                  <option value="lineaire_1er">Primer lin√©aire (moulures, corniches) 1er (ft)</option>
                  <option value="lineaire_2eme">Primer lin√©aire (moulures, corniches) 2e (ft)</option>
                </select>
              </div>
              <button id="ajouter-primer" class="btn-primary" onclick="ajouterPrimer()">
                <i class="fas fa-plus"></i> Ajouter cette surface
              </button>

              <!-- Container des Primers Ajout√©s dans la m√™me bo√Æte -->
              <div id="primers-container" class="mt-6">
                <!-- Les surfaces primer ajout√©es appara√Ætront ici dynamiquement -->
              </div>
            </div>
          </div>

          <!-- ENDROITS √Ä PEINTURER -->
          <div class="box">
            <div class="box-header">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="box-header-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                  <i class="fas fa-plus-circle"></i>
                </div>
                <h2 class="box-header-title">Endroit √† peinturer</h2>
              </div>
            </div>
            <div class="box-body">
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">S√©lectionner un type d'endroit :</label>
                <select id="endroit-select" class="select-field">
                  <option value="">Choisir un endroit...</option>
                  <option value="revetement">Rev√™tement</option>
                  <option value="corniches">Corniche et moulure</option>
                  <option value="fenetres">Fen√™tre et volet</option>
                  <option value="portes">Porte et cadre de porte</option>
                  <option value="balcon">Balcon</option>
                  <option value="cloture">Cl√¥ture</option>
                  <option value="fer_forge">Fer forg√©</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              <button id="ajouter-endroit" class="btn-primary" onclick="ajouterEndroit()">
                <i class="fas fa-plus"></i> Ajouter cet endroit
              </button>
              
              <!-- Container des Endroits Ajout√©s dans la m√™me bo√Æte -->
              <div id="endroits-container" class="mt-6">
                <!-- Les endroits ajout√©s appara√Ætront ici dynamiquement -->
              </div>
            </div>
          </div>

        </div>

        <!-- Right Column: Results -->
        <div class="space-y-6">
          <!-- Total Cost -->
          <div class="result-card shadow">
            <h3 class="text-2xl font-bold mb-2">Total ext√©rieur</h3>
            <div class="text-5xl font-bold mb-4" id="subTotal">$0.00</div>
            <div class="text-lg opacity-90 mb-2">
              <span id="totalHours">0</span> heures de travail
            </div>
            <!-- Total combin√© ext + int -->
            <div class="text-sm opacity-70 border-t border-gray-600 pt-3 mt-3 text-center">
              <span>Total des travaux: </span>
              <span class="font-bold text-green-400 text-lg" id="totalCombine">$0.00</span>
            </div>
          </div>

          <!-- Cost Breakdown -->
          <div class="glass-card shadow" style="overflow: hidden !important;">
            <div class="section-header">
              <i class="fas fa-chart-pie"></i>
              D√©tail des Co√ªts Ext√©rieurs
            </div>
            <div class="p-6 space-y-4">
              <div class="cost-breakdown">
                <div class="flex justify-between items-center mb-2">
                  <span class="font-semibold">Lavage</span>
                  <span id="costLavage" class="font-bold text-blue-400">$0.00</span>
                </div>
                <div class="text-sm text-gray-400">
                  <span id="heuresLavage">0</span> √ó <span id="tauxHoraireLavageDisplay">43</span>$/h
                </div>
              </div>

              <div class="cost-breakdown">
                <div class="flex justify-between items-center mb-2">
                  <span class="font-semibold">Pr√©paration</span>
                  <span id="costPreparation" class="font-bold text-blue-400">$0.00</span>
                </div>
                <div class="text-sm text-gray-400">
                  <span id="heuresPreparation">0</span>h √ó <span id="tauxHorairePreparationDisplay">43</span>$/h
                </div>
              </div>

              <div class="cost-breakdown">
                <div class="flex justify-between items-center mb-2">
                  <span class="font-semibold">Main d'oeuvre</span>
                  <span id="costPeinture" class="font-bold text-blue-400">$0.00</span>
                </div>
                <div class="text-sm text-gray-400">
                  <span id="heuresPeinture">0</span> √ó <span id="tauxHorairePeintureDisplay">43</span>$/h
                </div>
              </div>

              <div class="cost-breakdown">
                <div class="flex justify-between items-center mb-2">
                  <span class="font-semibold">Co√ªt des Produits</span>
                  <span id="costProduits" class="font-bold text-blue-400">$0.00</span>
                </div>
                <div class="text-sm text-gray-400">
                  Produits appliqu√©s aux sections
                </div>
              </div>

              <div class="cost-breakdown">
                <div class="flex justify-between items-center mb-2">
                  <span class="font-semibold">Frais administratifs</span>
                  <span id="fraisAdministratifs" class="font-bold text-blue-400">$0.00</span>
                </div>
                <div class="text-sm text-gray-400">
                  1% des co√ªts pr√©c√©dents
                </div>
              </div>

              <div class="border-t-2 border-gray-600 pt-4">
                <div class="flex justify-between items-center">
                  <span class="font-bold text-lg text-white">Sous-total</span>
                  <span id="subTotalBreakdown" class="font-bold text-lg text-green-400">$0.00</span>
                </div>
                <div class="flex justify-between items-center mt-2">
                  <span class="text-sm text-white">TPS (5%)</span>
                  <span id="tpsAmount" class="text-sm text-gray-400">$0.00</span>
                </div>
                <div class="flex justify-between items-center mt-1">
                  <span class="text-sm text-white">TVQ (9.975%)</span>
                  <span id="tvqAmount" class="text-sm text-gray-400">$0.00</span>
                </div>
              </div>

              <!-- Section Produits -->
              <div class="mt-6 pt-4 border-t-2 border-gray-600">
                <h4 class="font-medium text-white mb-3">
                  D√©tail des produits
                </h4>
                <div id="products-details" class="space-y-2">
                  <!-- Les d√©tails des produits appara√Ætront ici -->
                </div>
              </div>
            </div>
          </div>

          <!-- Configuration -->
          <div class="glass-card shadow" style="overflow: hidden !important;">
            <div class="section-header">
              <i class="fas fa-sliders-h"></i>
              Configuration
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Marge de profit (%)</label>
                <input type="number" id="profitMargin" class="input-field" value="25" min="0" max="100" onchange="updateCalculation(); autoSaveParameters();">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Taux horaire ($/h)</label>
                <input type="number" id="tauxHoraire" class="input-field" value="43" min="20" max="100" step="0.01" readonly style="cursor: not-allowed !important; background-color: #1e293b !important; color: #9ca3af !important; border: 2px solid #374151 !important;" onchange="syncTauxHoraire('tauxHoraire'); updateCalculation(); autoSaveParameters();">
              </div>
              <div class="pt-2 flex justify-between items-center">
                <span class="text-sm text-gray-300">Marge de profit :</span>
                <span id="profitAmountConfig" class="text-green-400 font-semibold">$0.00</span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Int√©rieur Tab -->
    <div id="interieur-tab" class="tab-content hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column: Input Forms -->
        <div class="lg:col-span-2 space-y-6">
          
          <!-- Ajouter Pi√®ce Int√©rieure -->
          <div class="box">
            <div class="box-header">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="box-header-icon" style="background: linear-gradient(135deg, #14b8a6 0%, #0f766e 100%);">
                  <i class="fas fa-plus-circle"></i>
                </div>
                <h2 class="box-header-title">Ajouter une Pi√®ce</h2>
              </div>
            </div>
            <div class="box-body">
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">S√©lectionner un type de pi√®ce :</label>
                <select id="typePiece" class="select-field">
                  <option value="">Choisir un type...</option>
                  <option value="chambre_1">Chambre 1</option>
                  <option value="chambre_2">Chambre 2</option>
                  <option value="chambre_3">Chambre 3</option>
                  <option value="chambre_4">Chambre 4</option>
                  <option value="chambre_5">Chambre 5</option>
                  <option value="chambre_6">Chambre 6</option>
                  <option value="chambre_7">Chambre 7</option>
                  <option value="chambre_8">Chambre 8</option>
                  <option value="salon_1">Salon 1</option>
                  <option value="salon_2">Salon 2</option>
                  <option value="salon_3">Salon 3</option>
                  <option value="cuisine_1">Cuisine 1</option>
                  <option value="cuisine_2">Cuisine 2</option>
                  <option value="cuisine_3">Cuisine 3</option>
                  <option value="cuisine_4">Cuisine 4</option>
                  <option value="salle_bain_1">Salle de bain 1</option>
                  <option value="salle_bain_2">Salle de bain 2</option>
                  <option value="salle_bain_3">Salle de bain 3</option>
                  <option value="salle_bain_4">Salle de bain 4</option>
                  <option value="couloir_rdc_1">Couloir RDC 1</option>
                  <option value="couloir_rdc_2">Couloir RDC 2</option>
                  <option value="couloir_rdc_3">Couloir RDC 3</option>
                  <option value="couloir_1er_etage_1">Couloir 1er √©tage 1</option>
                  <option value="couloir_1er_etage_2">Couloir 1er √©tage 2</option>
                  <option value="couloir_1er_etage_3">Couloir 1er √©tage 3</option>
                  <option value="couloir_sous_sol_1">Couloir sous-sol 1</option>
                  <option value="couloir_sous_sol_2">Couloir sous-sol 2</option>
                  <option value="couloir_sous_sol_3">Couloir sous-sol 3</option>
                  <option value="entree_1">Entr√©e 1</option>
                  <option value="entree_2">Entr√©e 2</option>
                  <option value="entree_3">Entr√©e 3</option>
                  <option value="cage_escaliers_1er_1">Cage d'escaliers vers 1er √©tage 1</option>
                  <option value="cage_escaliers_1er_2">Cage d'escaliers vers 1er √©tage 2</option>
                  <option value="cage_escaliers_1er_3">Cage d'escaliers vers 1er √©tage 3</option>
                  <option value="cage_escaliers_sous_sol_1">Cage d'escaliers vers sous-sol 1</option>
                  <option value="cage_escaliers_sous_sol_2">Cage d'escaliers vers sous-sol 2</option>
                  <option value="cage_escaliers_sous_sol_3">Cage d'escaliers vers sous-sol 3</option>
                  <option value="salle_manger_1">Salle √† manger 1</option>
                  <option value="salle_manger_2">Salle √† manger 2</option>
                  <option value="salle_manger_3">Salle √† manger 3</option>
                  <option value="salle_manger_4">Salle √† manger 4</option>
                  <option value="aire_commune_1">Aire commune 1</option>
                  <option value="aire_commune_2">Aire commune 2</option>
                  <option value="aire_commune_3">Aire commune 3</option>
                  <option value="walk_in_1">Walk-in 1</option>
                  <option value="walk_in_2">Walk-in 2</option>
                  <option value="walk_in_3">Walk-in 3</option>
                  <option value="walk_in_4">Walk-in 4</option>
                  <option value="bureau_1">Bureau 1</option>
                  <option value="bureau_2">Bureau 2</option>
                  <option value="bureau_3">Bureau 3</option>
                  <option value="atelier_1">Atelier</option>
                  <option value="atelier_2">Atelier 2</option>
                  <option value="atelier_3">Atelier 3</option>
                  <option value="autres">Autres</option>
                  <option value="custom">Custom</option>
                </select>
              </div>

              <div class="mb-4" id="nomPersonnaliseContainer" style="display: none;">
                <label class="block text-sm font-medium text-gray-300 mb-2">Nom personnalis√©</label>
                <input type="text" id="nomPiecePersonnalise" class="input-field" placeholder="Ex: Chambre principale">
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Largeur (ft)</label>
                  <input type="number" id="largeurPiece" class="input-field" placeholder="0.0" step="0.1">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Profondeur (ft)</label>
                  <input type="number" id="profondeurPiece" class="input-field" placeholder="0.0" step="0.1">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Hauteur (ft)</label>
                  <input type="number" id="hauteurPiece" class="input-field" value="8" step="0.1">
                </div>
              </div>

              <div class="mb-4">
                <label class="flex items-center cursor-pointer p-3 rounded-lg border border-gray-600 hover:border-gray-500 transition-all duration-200 group" style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(51, 65, 85, 0.6) 100%);">
                  <input type="checkbox" id="inclureMoulures" class="modern-checkbox mr-3">
                  <div class="flex-1">
                    <span class="font-medium text-white group-hover:text-blue-100 transition-colors duration-200">Inclure les moulures</span>
                    <p class="text-xs text-gray-400 group-hover:text-gray-300 transition-colors duration-200 mt-0.5">Calcul automatique des moulures sur le p√©rim√®tre</p>
                  </div>
                </label>
              </div>

              <button class="btn-primary" onclick="ajouterPiece()">
                <i class="fas fa-plus"></i> Ajouter cette pi√®ce
              </button>
            </div>
          </div>

          <!-- Sections Globales Int√©rieur -->
          <div class="box">
            <div class="box-header">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="box-header-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                  <i class="fas fa-tools"></i>
                </div>
                <h2 class="box-header-title">Travaux Additionnels</h2>
              </div>
            </div>
            <div class="box-body space-y-6">
              
              <!-- Section Portes Globale -->
              <div class="border-l-4 border-red-500 pl-4">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-lg font-semibold text-white">Portes Int√©rieures</h4>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="togglePorteGlobal" class="sr-only peer" onchange="togglePorteGlobalSection()">
                    <div class="w-11 h-6 bg-gray-700 dark-switch peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-500 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                  </label>
                </div>
                <div id="porteGlobalSection" style="display: none;">
                  <div class="mb-4">
                    <button type="button" onclick="ajouterPorteGlobale()" class="btn-primary" style="padding: 4px 10px !important; font-size: 12px !important;">
                      <i class="fas fa-plus"></i> Ajouter une porte
                    </button>
                  </div>
                  <div id="listPortesGlobales" class="space-y-3">
                    <!-- Les portes seront ajout√©es ici dynamiquement -->
                  </div>
                </div>
              </div>

              <!-- Section Fen√™tres Globale -->
              <div class="border-l-4 border-red-500 pl-4">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-lg font-semibold text-white">Fen√™tres Int√©rieures</h4>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggleFenetreGlobal" class="sr-only peer" onchange="toggleFenetreGlobalSection()">
                    <div class="w-11 h-6 bg-gray-700 dark-switch peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-500 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                  </label>
                </div>
                <div id="fenetreGlobalSection" style="display: none;">
                  <div class="mb-4">
                    <button type="button" onclick="ajouterFenetreGlobale()" class="btn-primary" style="padding: 4px 10px !important; font-size: 12px !important;">
                      <i class="fas fa-plus"></i> Ajouter une fen√™tre
                    </button>
                  </div>
                  <div id="listFenetresGlobales" class="space-y-3">
                    <!-- Les fen√™tres seront ajout√©es ici dynamiquement -->
                  </div>
                </div>
              </div>

              <!-- Section Divers Globale -->
              <div class="border-l-4 border-red-500 pl-4">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-lg font-semibold text-white">Divers Int√©rieur</h4>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggleDiversGlobal" class="sr-only peer" onchange="toggleDiversGlobalSection()">
                    <div class="w-11 h-6 bg-gray-700 dark-switch peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-500 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                  </label>
                </div>
                <div id="diversGlobalSection" style="display: none;">
                  <div class="mb-4">
                    <button type="button" onclick="ajouterDiversGlobal()" class="btn-primary" style="padding: 4px 10px !important; font-size: 12px !important;">
                      <i class="fas fa-plus"></i> Ajouter un item divers
                    </button>
                  </div>
                  <div id="listDiversGlobaux" class="space-y-3">
                    <!-- Les items divers seront ajout√©s ici dynamiquement -->
                  </div>
                </div>
              </div>

              <!-- Section Plafond S√©par√© Globale -->
              <div class="border-l-4 border-red-500 pl-4">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-lg font-semibold text-white">Plafond S√©par√©</h4>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="togglePlafondGlobal" class="sr-only peer" onchange="togglePlafondGlobalSection()">
                    <div class="w-11 h-6 bg-gray-700 dark-switch peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-500 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                  </label>
                </div>
                <div id="plafondGlobalSection" style="display: none;">
                  <div class="mb-4">
                    <button type="button" onclick="ajouterPlafondGlobal()" class="btn-primary" style="padding: 4px 10px !important; font-size: 12px !important;">
                      <i class="fas fa-plus"></i> Ajouter un plafond
                    </button>
                  </div>
                  <div id="listPlafondsGlobaux" class="space-y-3">
                    <!-- Les plafonds seront ajout√©s ici dynamiquement -->
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- Section Pr√©paration -->
          <div class="box">
            <div class="box-header">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="box-header-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                  <i class="fas fa-tools"></i>
                </div>
                <h2 class="box-header-title">Pr√©paration</h2>
              </div>
            </div>
            <div class="box-body space-y-6">

              <div class="border-l-4 border-orange-500 pl-4">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-lg font-semibold text-white">Pr√©paration sur pi√®ces s√©lectionn√©es</h4>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="togglePreparationGlobal" class="sr-only peer" onchange="togglePreparationGlobalSection()">
                    <div class="w-11 h-6 bg-gray-700 dark-switch peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-500 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                  </label>
                </div>
                <div id="preparationGlobalSection" style="display: none;">
                  <div class="mb-4">
                    <div class="text-sm text-gray-400 mb-3" id="preparationGlobalLabel">S√©lectionnez les pi√®ces pour la pr√©paration :</div>
                    <div id="listPiecesPreparation" class="space-y-2 mb-4">
                      <!-- Les pi√®ces avec pr√©parations appara√Ætront ici -->
                    </div>
                    <div class="grid grid-cols-2 gap-3 p-3 bg-gray-800 rounded" id="preparationGlobalSummary">
                      <div>
                        <div class="text-xs text-gray-400 mb-1">Heures pr√©paration</div>
                        <div class="text-lg font-bold text-blue-400" id="preparationGlobalHeures">0.0</div>
                      </div>
                      <div>
                        <div class="text-xs text-gray-400 mb-1">Co√ªt MO</div>
                        <div class="text-lg font-bold text-green-400" id="preparationGlobalCoutMO">$0.00</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- Section Appr√™t -->
          <div class="box">
            <div class="box-header">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="box-header-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                  <i class="fas fa-spray-can"></i>
                </div>
                <h2 class="box-header-title">Appr√™t</h2>
              </div>
            </div>
            <div class="box-body space-y-6">

              <div class="border-l-4 border-purple-500 pl-4">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-lg font-semibold text-white">Appr√™t sur pi√®ces s√©lectionn√©es</h4>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggleAppretGlobal" class="sr-only peer" onchange="toggleAppretGlobalSection()">
                    <div class="w-11 h-6 bg-gray-700 dark-switch peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-500 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                  </label>
                </div>
                <div id="appretGlobalSection" style="display: none;">
                  <div class="mb-4">
                    <div class="text-sm text-gray-400 mb-3" id="appretGlobalLabel">S√©lectionnez les pi√®ces √† appr√™ter :</div>
                    <div id="listPiecesAppret" class="space-y-2 mb-4">
                      <!-- Les checkboxes des pi√®ces appara√Ætront ici -->
                    </div>
                    <div class="grid grid-cols-2 gap-3 p-3 bg-gray-800 rounded" id="appretGlobalSummary">
                      <div>
                        <div class="text-xs text-gray-400 mb-1">Gallons appr√™t</div>
                        <div class="text-lg font-bold text-blue-400" id="appretGlobalGallons">0</div>
                      </div>
                      <div>
                        <div class="text-xs text-gray-400 mb-1">Heures MO</div>
                        <div class="text-lg font-bold text-blue-400" id="appretGlobalHeures">0.0</div>
                      </div>
                      <div>
                        <div class="text-xs text-gray-400 mb-1">Co√ªt produit</div>
                        <div class="text-lg font-bold text-green-400" id="appretGlobalCoutProduit">$0.00</div>
                      </div>
                      <div>
                        <div class="text-xs text-gray-400 mb-1">Co√ªt MO</div>
                        <div class="text-lg font-bold text-green-400" id="appretGlobalCoutMO">$0.00</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>


          <!-- Liste des Pi√®ces -->
          <div id="listePieces" class="space-y-4">
            <!-- Les pi√®ces ajout√©es appara√Ætront ici -->
          </div>
        </div>

        <!-- Right Column: Summary & Details -->
        <div class="space-y-6">
          <!-- Total Cost Int√©rieur -->
          <div class="result-card shadow">
            <h3 class="text-2xl font-bold mb-2">Total Int√©rieur</h3>
            <div class="text-5xl font-bold mb-4 text-center" id="subTotalInt">$0.00</div>
            <div class="text-lg opacity-90 mb-2">
              <span id="totalHeuresInt">0.0</span> heures de travail
            </div>
            <!-- Total combin√© ext + int -->
            <div class="text-sm opacity-70 border-t border-gray-600 pt-3 mt-3 text-center">
              <span>Total des travaux: </span>
              <span class="font-bold text-green-400 text-lg" id="totalCombineInt">$0.00</span>
            </div>
          </div>
          

          <!-- Cost Breakdown Int√©rieur -->
          <div class="glass-card shadow" style="overflow: hidden !important;">
            <div class="section-header">
              <i class="fas fa-chart-pie"></i>
              D√©tail des Co√ªts Int√©rieurs
            </div>
            <div class="p-6 space-y-4">

              <div class="cost-breakdown">
                <div class="flex justify-between items-center mb-2">
                  <span class="font-semibold">Pr√©paration</span>
                  <span id="costPreparationInt" class="font-bold text-blue-400">$0.00</span>
                </div>
                <div class="text-sm text-gray-400">
                  <span id="heuresPreparationInt">0</span>h √ó $<span id="tauxHorairePreparationIntDisplay">43</span>/h
                </div>
              </div>

              <div class="cost-breakdown">
                <div class="flex justify-between items-center mb-2">
                  <span class="font-semibold">Main d'oeuvre</span>
                  <span id="costMainOeuvreInt" class="font-bold text-blue-400">$0.00</span>
                </div>
                <div class="text-sm text-gray-400 space-y-1">
                  <div class="flex justify-between">
                    <span>Appr√™t</span>
                    <span>$<span id="coutAppretGlobalInt">0.00</span></span>
                  </div>
                  <div class="flex justify-between">
                    <span>Pi√®ces</span>
                    <span>$<span id="coutPiecesInt">0.00</span></span>
                  </div>
                  <div class="flex justify-between">
                    <span>Portes</span>
                    <span>$<span id="coutPortesInt">0.00</span></span>
                  </div>
                  <div class="flex justify-between">
                    <span>Fen√™tres</span>
                    <span>$<span id="coutFenetresInt">0.00</span></span>
                  </div>
                  <div class="flex justify-between">
                    <span>Divers</span>
                    <span>$<span id="coutDiversInt">0.00</span></span>
                  </div>
                  <div class="flex justify-between border-t border-gray-600 pt-1 mt-1">
                    <span class="font-semibold">Total</span>
                    <span class="font-semibold"><span id="heuresMainOeuvreInt">0</span>h √ó $<span id="tauxHoraireIntDisplay">43</span>/h = $<span id="coutTotalMOInt">0.00</span></span>
                  </div>
                </div>
              </div>

              <div class="cost-breakdown">
                <div class="flex justify-between items-center mb-2">
                  <span class="font-semibold">Co√ªt des Produits</span>
                  <span id="costProduitsInt" class="font-bold text-blue-400">$0.00</span>
                </div>
                <div class="text-sm text-gray-400">
                  Produits appliqu√©s aux sections
                </div>
              </div>

              <div class="cost-breakdown">
                <div class="flex justify-between items-center mb-2">
                  <span class="font-semibold">Temps de pr√©paration</span>
                  <span id="fraisAdministratifsInt" class="font-bold text-blue-400">$0.00</span>
                </div>
                <div class="text-sm text-gray-400">
                  Pr√©paration int√©rieur
                </div>
              </div>

              <div class="border-t-2 border-gray-600 pt-4">
                <div class="flex justify-between items-center">
                  <span class="font-bold text-lg text-white">Sous-total</span>
                  <span id="subTotalIntBreakdown" class="font-bold text-lg text-green-400">$0.00</span>
                </div>
                <div class="flex justify-between items-center mt-2">
                  <span class="text-sm text-white">TPS (5%)</span>
                  <span id="tpsAmountInt" class="text-sm text-gray-400">$0.00</span>
                </div>
                <div class="flex justify-between items-center mt-1">
                  <span class="text-sm text-white">TVQ (9.975%)</span>
                  <span id="tvqAmountInt" class="text-sm text-gray-400">$0.00</span>
                </div>
              </div>
              <!-- Section Produits Int√©rieur -->
              <div class="mt-6 pt-4 border-t-2 border-gray-600">
                <h4 class="font-medium text-white mb-3">
                  D√©tail des produits
                </h4>
                <div id="products-details-int" class="space-y-2">
                  <!-- Les d√©tails des produits int√©rieurs appara√Ætront ici -->
                </div>
              </div>
            </div>
          </div>

          <!-- Configuration Int√©rieur -->
          <div class="glass-card shadow" style="overflow: hidden !important;">
            <div class="section-header">
              <i class="fas fa-sliders-h"></i>
              Configuration
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Marge de profit (%)</label>
                <input type="number" id="profitMarginInt" class="input-field" value="25" min="0" max="100" onchange="updateCalculation(); autoSaveParameters();">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Taux horaire ($/h)</label>
                <input type="number" id="tauxHoraireInt" class="input-field" value="43" min="20" max="100" step="0.01" readonly style="cursor: not-allowed !important; background-color: #1e293b !important; color: #9ca3af !important; border: 2px solid #374151 !important;" onchange="syncTauxHoraire('tauxHoraireInt'); updateCalculation(); autoSaveParameters();">
              </div>
              <div class="pt-2 flex justify-between items-center">
                <span class="text-sm text-gray-300">Marge de profit :</span>
                <span id="profitAmountInt" class="text-green-400 font-semibold">$0.00</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Products Tab -->
    <!-- Produits Tab -->
    <div id="produits-tab" class="tab-content hidden">
      <div class="box">
        <div class="box-header">
          <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div class="box-header-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
              <i class="fas fa-paint-roller"></i>
            </div>
            <h2 class="box-header-title">Gestion des Produits</h2>
          </div>
        </div>
        <div class="box-body">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-white">Produits Disponibles</h3>
            <button class="btn-primary" onclick="addNewProduct()" data-role="direction" style="display: none !important;">
              <i class="fas fa-plus"></i> Ajouter un Produit
            </button>
          </div>
          
          <div class="overflow-x-auto">
            <table class="w-full border-collapse rounded-lg overflow-hidden shadow" style="min-width: 800px; background: var(--bg-card); border: 1px solid var(--border-dark);">
              <thead>
                <tr style="background: #1e293b;">
                  <th class="px-4 py-3 text-left font-semibold text-white" style="width: 60%; border: 1px solid var(--border-dark);">Type</th>
                  <th class="px-4 py-3 text-left font-semibold text-white" style="width: 20%; border: 1px solid var(--border-dark);">Ratio (ft¬≤/gal)</th>
                  <th class="px-4 py-3 text-left font-semibold text-white" style="width: 15%; border: 1px solid var(--border-dark);">Prix ($)</th>
                  <th class="px-4 py-3 text-center font-semibold text-white" style="width: 5%; border: 1px solid var(--border-dark); display: none !important;">Actions</th>
                </tr>
              </thead>
              <tbody id="products-table-body">
                <tr class="hover:bg-slate-700/50">
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">Dulux Gripper</div>
                    <input type="hidden" data-field="type" value="Dulux Gripper">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">200</div>
                    <input type="hidden" data-field="ratio" value="200">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">100</div>
                    <input type="hidden" data-field="prix" value="100">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3 text-center" style="display: none !important;">
                    <button class="btn-secondary text-xs px-2 py-1" onclick="removeProduct(this)" title="Supprimer">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr class="hover:bg-slate-700/50">
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">Dulux huile ST</div>
                    <input type="hidden" data-field="type" value="Dulux huile ST">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">200</div>
                    <input type="hidden" data-field="ratio" value="200">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">80</div>
                    <input type="hidden" data-field="prix" value="80">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3 text-center" style="display: none !important;">
                    <button class="btn-secondary text-xs px-2 py-1" onclick="removeProduct(this)" title="Supprimer">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr class="hover:bg-slate-700/50">
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">Dulux Hybride OPQ</div>
                    <input type="hidden" data-field="type" value="Dulux Hybride OPQ">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">200</div>
                    <input type="hidden" data-field="ratio" value="200">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">80</div>
                    <input type="hidden" data-field="prix" value="80">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3 text-center" style="display: none !important;">
                    <button class="btn-secondary text-xs px-2 py-1" onclick="removeProduct(this)" title="Supprimer">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr class="hover:bg-slate-700/50">
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">Dulux √©mail √† planchers</div>
                    <input type="hidden" data-field="type" value="Dulux √©mail √† planchers">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">350</div>
                    <input type="hidden" data-field="ratio" value="350">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">80</div>
                    <input type="hidden" data-field="prix" value="80">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3 text-center" style="display: none !important;">
                    <button class="btn-secondary text-xs px-2 py-1" onclick="removeProduct(this)" title="Supprimer">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr class="hover:bg-slate-700/50">
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">Sikkens ST</div>
                    <input type="hidden" data-field="type" value="Sikkens ST">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">200</div>
                    <input type="hidden" data-field="ratio" value="200">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">140</div>
                    <input type="hidden" data-field="prix" value="140">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3 text-center" style="display: none !important;">
                    <button class="btn-secondary text-xs px-2 py-1" onclick="removeProduct(this)" title="Supprimer">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr class="hover:bg-slate-700/50">
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">Diamant</div>
                    <input type="hidden" data-field="type" value="Diamant">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">350</div>
                    <input type="hidden" data-field="ratio" value="350">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">95</div>
                    <input type="hidden" data-field="prix" value="95">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3 text-center" style="display: none !important;">
                    <button class="btn-secondary text-xs px-2 py-1" onclick="removeProduct(this)" title="Supprimer">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr class="hover:bg-slate-700/50">
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">Produit client</div>
                    <input type="hidden" data-field="type" value="Produit client">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">300</div>
                    <input type="hidden" data-field="ratio" value="300">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3">
                    <div class="w-full px-2 py-1 bg-gray-100 text-white rounded cursor-not-allowed" style="background-color: #172033; color: var(--text-light);">0</div>
                    <input type="hidden" data-field="prix" value="0">
                  </td>
                  <td class="border: 1px solid var(--border-dark); px-4 py-3 text-center" style="display: none !important;">
                    <button class="btn-secondary text-xs px-2 py-1" onclick="removeProduct(this)" title="Supprimer">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="mt-6 p-4 rounded-lg" style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(51, 65, 85, 0.9) 100%); border: 1px solid var(--border-dark); display: none !important;">
            <h4 class="font-semibold text-white mb-2">
              <i class="fas fa-info-circle text-blue-400"></i> Instructions
            </h4>
            <p class="text-sm text-gray-300">
              ‚Ä¢ Cliquez sur n'importe quel champ pour le modifier<br>
              ‚Ä¢ Les modifications sont automatiquement prises en compte dans les calculs<br>
              ‚Ä¢ Utilisez "Ajouter un Produit" pour cr√©er de nouveaux produits<br>
              ‚Ä¢ Le bouton de suppression permet de retirer un produit de la liste
            </p>
          </div>
        </div>
      </div>
    </div>


    <!-- Parameters Admin Tab -->
    <div id="parametres-admin-tab" class="tab-content hidden">
      
      <!-- Actions Rapides Admin -->
      <div style="background: var(--bg-card); border-radius: 20px; padding: 20px; box-shadow: var(--shadow-dark); margin-bottom: 20px;">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-left" style="color: var(--text-light);">
            <i class="fas fa-tools mr-2"></i>Actions Rapides Admin
          </h2>
          <span class="text-xs px-2 py-1 rounded" style="background: var(--primary-green); color: var(--text-light);">
            <i class="fas fa-sync-alt"></i> Synchronis√© automatiquement pour tous les utilisateurs
          </span>
        </div>
        <div class="param-section">
          <div class="param-section-content">
            <div class="flex flex-wrap gap-4">
              <button class="btn-primary" onclick="saveAllParameters()">
                <i class="fas fa-save"></i> Sauvegarder Tous
              </button>
              <button class="btn-secondary" onclick="loadDefaultParameters()">
                <i class="fas fa-undo"></i> Valeurs par D√©faut
              </button>
              <button class="btn-primary" onclick="exportParameters()">
                <i class="fas fa-download"></i> Exporter
              </button>
              <button class="btn-primary" onclick="importParameters()">
                <i class="fas fa-upload"></i> Importer
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Section des param√®tres g√©n√©raux -->
      <div style="/* background: var(--bg-card); */
    /* border-radius: 20px; */
    /* padding: 20px; */
    /* box-shadow: var(--shadow-dark); */
    margin-bottom: 20px;">
        <div class="text-left mb-4">
          <h2 class="text-2xl font-bold text-left" style="color: var(--text-light);">Taux horaire par d√©faut</h2>
        </div>

        <div class="param-section">
          <div class="param-section-content">
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Taux horaire</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Taux</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Taux/h</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">
                  <input type="number" id="param_taux_horaire" value="43" step="1" onchange="updateTauxHoraire(); updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Facteur deuxi√®me couche</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">
                  <input type="number" id="param_facteur_deuxieme_couche" value="0.7" step="0.1" min="0" max="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ratio</td>
              </tr>
            </table>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-6">

        <!-- Colonne de gauche: Param√®tres ext√©rieurs -->
        <div class="space-y-4">
          <!-- Titre Ext√©rieur -->
          <div class="text-left mb-4">
            <h2 class="text-2xl font-bold text-left" style="color: var(--primary-blue);">EXT√âRIEUR</h2>
          </div>


        <!-- Lavage -->
        <div class="param-section">
          <div class="param-section-content">
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Lavage</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Lavage √† pression (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_lavage_pression" value="400" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Lavage √† la main lin√©aire (ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_lavage_main_lineaire" value="100" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Lavage √† la main surface (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_lavage_main_surface" value="225" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Lavage √† pression intense SUR PLANCHER BALCON(ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_lavage_intense_balcon" value="150" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Lavage portes et fen√™tres √† l'unit√© (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_lavage_portes_fenetres" value="20" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">qte/h</td>
              </tr>
            </table>
          </div>
        </div>

        <!-- Pr√©paration -->
        <div class="param-section">
          <div class="param-section-content">
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Pr√©paration</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Grat. spot de 40 minutes ou fen√™tre compl√®te(# spot)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_grat_spot_40min" value="0.66" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Grat. Spot de 20 minutes ou demi-fen√™tre(# spot)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_grat_spot_20min" value="0.33" step="0.000000000000001" onchange="updateCalculation(); autoSaveParameters();" onfocus="this.value='0.333333333333333'" onblur="if(this.value==='0.333333333333333') this.value='0.33'" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Grat. spot de 10 minutes ou quart de fen√™tre (# spot)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_grat_spot_10min" value="0.17" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Grat. mur complet (√©caille un peu)(ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_grat_mur_peu" value="70.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Grat. mur complet (√©caille consid√©rablement )(ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_grat_mur_beaucoup" value="60.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Grat. mur complet (Toute la peinture est √©caill√©e)(ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_grat_mur_tout" value="40.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Grat. corniches 1er(√©caille un peu par endroit)(ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_grat_corniche_1er_peu" value="20.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Grat. corniches 1er (presque tout √©caille)(ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_grat_corniche_1er_tout" value="15.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Grat. corniches 2eme  (√©caille un peu par endroit)(ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_grat_corniche_2eme_peu" value="15.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Grat. corniches 2 eme (presque tout √©caille)(ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_grat_corniche_2eme_tout" value="10.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Sablage de surface (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_sablage_surface" value="100.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
            </table>
          </div>
        </div>


        <!-- Primer -->
        <div class="param-section">
          <div class="param-section-content">
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Primer</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Primer surface compl√®te - facile (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_primer_surface_facile" value="110.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Primer surface compl√®te - difficile (ft¬≤) -100ft</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_primer_surface_difficile" value="70.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Primer lin√©aire (moulures, corniches) 1er (ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_primer_lineaire_1er" value="25.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Primer lin√©aire (moulures, corniches) 2eme (ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_primer_lineaire_2eme" value="20.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
            </table>
          </div>
        </div>

        <!-- Rev√™tement -->
        <div class="param-section">
          <div class="param-section-content">
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Rev√™tement</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Peinture latte horizontale 4 pouces- et t√¥le verticale (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_peinture_latte_horizontale_4" value="55" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Peinture rev√™tement horizontal 6po. et plus   (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_peinture_revetement_horizontal_6" value="75" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Teindre Bardeau de c√®dre neuf (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_teindre_bardeau_neuf" value="55" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Teindre Bardeau de c√®dre vieux (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_teindre_bardeau_vieux" value="40" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Stucco avec faible relief (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_stucco_faible_relief" value="65" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Stucco avec fort relief (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_stucco_fort_relief" value="45" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Brique (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_brique" value="45" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Solage FACILE D'ACC√àS (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_solage_facile" value="85" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Solage DIFFICILE D'ACC√àS(ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_solage_difficile" value="55" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
            </table>
          </div>
        </div>


        <!-- Corniches et moulures -->
        <div class="param-section">
          <div class="param-section-content">
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Corniches et moulures</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fascia Moulure plate ou 1re √©tage (ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_fascia_plate_1er" value="30" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fascia Moulure complexe ou 2e √©tage (ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_fascia_complexe_2e" value="20" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Corniche plate - 1er √©tage (ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_corniche_plate_1er" value="22" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Corniche textur√©e ou courb√©e - 1er √©tage (ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_corniche_texturee_1er" value="18" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Corniche complexe - 1er √©tage (ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_corniche_complexe_1er" value="13" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Corniche plate - 2e √©tage (ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_corniche_plate_2e" value="18" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Corniche textur√©e ou courb√©e - 2e √©tage (ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_corniche_texturee_2e" value="13" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Corniche complexe - 2e √©tage (ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_corniche_complexe_2e" value="9" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
            </table>
          </div>
        </div>


        <!-- Fen√™tres et volets -->
        <div class="param-section">
          <div class="param-section-content">
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Fen√™tres et volets</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fen√™tre de sous-sol (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_fenetre_sous_sol" value="0.25" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fen√™tre facile - cadre seulement (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_fenetre_facile_cadre" value="0.33" step="0.000000000000001" onchange="updateCalculation(); autoSaveParameters();" onfocus="this.value='0.333333333333333'" onblur="if(this.value==='0.333333333333333') this.value='0.33'" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fen√™tre moyenne - cadre + int√©rieur des fen√™tres (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_fenetre_moyenne" value="0.50" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fen√™tre difficile </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_fenetre_difficile" value="1.25" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fen√™tre avec 3-6 carreaux (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_fenetre_3_6_carreaux" value="1.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fen√™tre √† carreaux (si plus de 6) (qte de carreaux)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_fenetre_carreaux_6plus" value="0.17" step="0.001" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Volet plat - tr√®s simple (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_volet_plat_simple" value="0.50" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Volet avec motifs - plux complexe (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_volet_avec_motifs" value="1.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Grande fen√™tre (style bay-window) - cadre (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_grande_fenetre_bay" value="0.75" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
            </table>
          </div>
        </div>


        <!-- 8. PORTES ET CADRES -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);" class="mb-6">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Portes et cadres de portes</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte facile (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_porte_facile" value="0.33" step="0.000000000000001" onchange="updateCalculation(); autoSaveParameters();" onfocus="this.value='0.333333333333333'" onblur="if(this.value==='0.333333333333333') this.value='0.33'" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte moyenne (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_porte_moyenne" value="0.66" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte difficile (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_porte_difficile" value="1.25" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte de garage simple (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_porte_garage_simple" value="1.50" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte de garage difficile (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_porte_garage_difficile" value="2.50" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">moulure du cadre de porte facile (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_moulure_cadre_facile" value="0.25" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">moulure du cadre de porte moyenne (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_moulure_cadre_moyenne" value="0.50" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">moulure du cadre de porte difficile (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_moulure_cadre_difficile" value="1.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">moulure porte de garage facile (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_moulure_garage_facile" value="0.66" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">moulure porte de garage moyen (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_moulure_garage_moyen" value="1.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">moulure porte de garage difficile (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_moulure_garage_difficile" value="1.50" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Carreaux de portes et de cadres de portes (si plus de 6 carreaux) (qte de carreaux)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_carreaux_portes" value="0.17" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
            </table>



        <!-- 13. QUANTIT√â PEINTURE -->
        <div class="param-section">
          <div class="param-section-content">
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Surface</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Peinture latte horizontale 4 pouces- et t√¥le verticale (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_peinture_latte_horizontale" value="1" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">r√©ducteur ratio peinture</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Peinture rev√™tement horizontal 6po. et plus (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_peinture_revetement_horizontal" value="1" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">r√©ducteur ratio peinture</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Teindre Bardeau de c√®dre neuf (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_reducteur_bardeau_neuf" value="0.9" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">r√©ducteur ratio peinture</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Teindre Bardeau de c√®dre vieux (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_reducteur_bardeau_vieux" value="1" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">r√©ducteur ratio peinture</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Stucco avec faible relief (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_ratio_stucco_faible_relief" value="0.85" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">r√©ducteur ratio peinture</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Stucco avec fort relief (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_ratio_stucco_fort_relief" value="0.9" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">r√©ducteur ratio peinture</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Brique (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_ratio_brique" value="0.95" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">r√©ducteur ratio peinture</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Solage FACILE D'ACC√àS (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_solage_facile_acces" value="0.75" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">r√©ducteur ratio peinture</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Solage DIFFICILE D'ACC√àS(ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_solage_difficile_acces" value="1" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">r√©ducteur ratio peinture</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Lucarne</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_lucarne" value="8" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">lucarne/gallon</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Autre 20 min</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_autre_20min_gallon" value="6.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">1/6 de gallon/20 min</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Autre 30 min</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_autre_30min_gallon" value="4.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">1/4 de gallon/30 min</td>
              </tr>
            </table>
          </div>
        </div>

        <!-- 9. BALCON -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);" class="mb-6">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Balcon</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Plancher teinture semi-transparente (Pinceaux) (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_plancher_teinture_semi" value="75.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Plancher opaque ou peinture(Rouleau+pinceaux) (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_plancher_opaque_peinture" value="100.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Mains courantes (ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_mains_courantes" value="50" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Marches (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_marches_balcon" value="4.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">4/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Rampes (barreau simple) (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_rampes_barreau_simple" value="16.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">16/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Rampes (barreau mod√©r√©) (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_rampes_barreau_modere" value="12.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">12/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Rampes (barreau complexe) (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_rampes_barreau_complexe" value="8.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">8/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Pilliers simples (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_pilliers_simples" value="3.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">3/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Pilliers complexes (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_pilliers_complexes" value="1.50" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">1.5/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Treillis (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_treillis" value="40.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Pergola (qte de piliers)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_pergola_piliers" value="2.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">qte/h</td>
              </tr>
            </table>

        <!-- 10. CL√îTURE -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);" class="mb-6">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Cl√¥ture</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Panneau planches verticales facile (1 c√¥t√©) (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_panneau_verticales_facile" value="0.50" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/panneau</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Panneau planches verticales moyenne(1 c√¥t√©) (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_panneau_verticales_moyenne" value="1.25" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/panneau</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Panneau planches verticales difficile ou avec treillis (1 c√¥t√©) (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_panneau_verticales_difficile" value="2.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/panneau</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Treillis (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_treillis_cloture" value="40.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
            </table>

        <!-- 11. AUTRES -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);" class="mb-6">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Autres</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Treillis (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_treillis_autres" value="40.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Lucarne facile d'acc√®s (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_lucarne_facile_acces" value="2.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Lucarne difficile d'acc√®s (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_lucarne_difficile_acces" value="3.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">D. Goutti√®re (ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_d_gouttiere" value="20.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Autre 20 min (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_autre_20min" value="0.33" step="0.000000000000001" onchange="updateCalculation(); autoSaveParameters();" onfocus="this.value='0.333333333333333'" onblur="if(this.value==='0.333333333333333') this.value='0.33'" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Autre 30 min (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_autre_30min" value="0.50" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Autre 1h (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_autre_1h" value="1.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Sablage surface</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_sablage_surface_autre" value="65.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
            </table>

        <!-- 12. FER FORG√â -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);" class="mb-6">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Fer Forg√© pr√©p. incluse</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">rampe complexe tr√®s rouill√©e 16.5$/ft (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_rampe_complexe_tres_rouillee" value="17.33" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">rampe complexe moyennement rouill√©e 13$/ft (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_rampe_complexe_moyennement_rouillee" value="13.65" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">rampe barreaux droits verticaux rouille moyenne 11$/ft  (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_rampe_barreaux_droits_verticaux" value="11.55" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">rampe horizontale moyenne - tr√®s rouill√©e 9$/ft (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_rampe_horizontale_moyenne_tres_rouillee" value="9.5" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">rampe horizontale facile - moyennement rouill√©e 7$/ft (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_rampe_horizontale_facile_moyennement_rouillee" value="7.35" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Marches en languettes rouill√©es LIMONS INCLUS 31$ch (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_marches_languettes_rouillees" value="31" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Marches en languettes tr√®s rouill√©es (ou bois) LIMONS INCLUS37.5$ch (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_marches_languettes_tres_rouillees" value="37.5" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Dessous balcon 4x8 avec poutres qui s'entrecroisent 200$ch (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_dessous_balcon_4x8" value="210" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Planchers industriels 4$/ft¬≤</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_planchers_industriels" value="4" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Marches industrielles LIMONS 45$ch (checkered) (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_marches_industrielles" value="45" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Ornements 200$ch (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_ornements" value="200" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Poteaux 25$/poteau (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_poteaux" value="25" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fascia sous balcon 2.2/$/ft (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_fascia_sous_balcon" value="2.5" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Peinture Fer Forg√©</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_peinture_fer_forge" value="47.50" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/gallon</td>
              </tr>
            </table>

        </div>

        <!-- Colonne de droite: Param√®tres int√©rieurs -->
        <div class="space-y-4">
          <!-- Titre Int√©rieur -->
          <div class="text-left mb-4">
            <h2 class="text-2xl font-bold text-left" style="color: var(--primary-green);">INT√âRIEUR</h2>
          </div>

        <!-- Param√®tres Int√©rieurs -->
        <div class="param-section">
          <div class="param-section-content">
            
            <!-- LAVAGE INT√âRIEUR -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light); margin-bottom: 46px;">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Lavage Int√©rieur</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Lavage mur simple</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_lavage_mur_simple" value="180" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Lavage mur complexe</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_lavage_mur_complexe" value="140" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Lavage plafond</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_lavage_plafond" value="120" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Lavage boiserie</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_lavage_boiserie" value="80" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
            </table>
            
            <!-- PR√âPARATION INT√âRIEUR -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light); margin-bottom: 46px;">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Pr√©paration Int√©rieur</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Grattage l√©ger</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_grattage_leger" value="100" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Grattage moyen</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_grattage_moyen" value="80" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Grattage intensif</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_grattage_intensif" value="50" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Sablage boiserie</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_sablage_boiserie" value="30" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Calfeutrage int√©rieur</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_calfeutrage_int" value="60" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
            </table>
            
            <!-- PRIX ENDROITS INT√âRIEURS -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light); margin-bottom: 46px;">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Prix Endroits Int√©rieurs</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Mur salon</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_mur_salon" value="0.65" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/ft¬≤</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Mur cuisine</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_mur_cuisine" value="0.70" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/ft¬≤</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Mur chambre</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_mur_chambre" value="0.60" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/ft¬≤</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Mur salle de bain</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_mur_salle_bain" value="0.85" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/ft¬≤</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Plafond salon</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_plafond_salon" value="0.75" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/ft¬≤</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Plafond cuisine</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_plafond_cuisine" value="0.80" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/ft¬≤</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Plafond chambre</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_plafond_chambre" value="0.70" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/ft¬≤</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Boiserie porte</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_boiserie_porte" value="3.50" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/ft</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Boiserie fen√™tre</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_boiserie_fenetre" value="3.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/ft</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Boiserie plinthe</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_boiserie_plinte" value="2.50" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/ft</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Armoire cuisine</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_armoire_cuisine" value="2.20" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/ft¬≤</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Escalier bois</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_escalier_bois" value="85.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Rampe escalier</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_rampe_escalier" value="6.50" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/ft</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Radiateur</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_radiateur" value="35.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Autre int√©rieur</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="param_autre_int" value="25.00" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/unit√©</td>
              </tr>
            </table>

            <!-- PRODUCTIVIT√â APPR√äT INT√âRIEUR -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light); margin-bottom: 46px;">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Productivit√© Appr√™t Int√©rieur</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Appr√™t mur ‚â§200ft¬≤</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="appret_mur_moins_200" value="100" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Appr√™t mur >200ft¬≤</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="appret_mur_plus_200" value="125" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Appr√™t plafond ‚â§200ft¬≤</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="appret_plafond_moins_200" value="100" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Appr√™t plafond >200ft¬≤</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="appret_plafond_plus_200" value="125" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
            </table>

            <!-- PRODUCTIVIT√â PORTES INT√âRIEURES -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light); margin-bottom: 46px;">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Productivit√© Portes Int√©rieures</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte facile</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="porte_facile_int" value="2" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">portes/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte moyenne</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="porte_moyenne_int" value="1.33" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">portes/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte difficile</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="porte_difficile_int" value="1" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">portes/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte fran√ßaise</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="porte_francaise_int" value="0.5" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">portes/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Cadre de porte</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="cadre_porte_int" value="2" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">cadres/h</td>
              </tr>
            </table>

            <!-- PRODUCTIVIT√â FEN√äTRES INT√âRIEURES -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light); margin-bottom: 46px;">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Productivit√© Fen√™tres Int√©rieures</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fen√™tre facile</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="fenetre_facile_int" value="2" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">fen√™tres/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fen√™tre moyenne</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="fenetre_moyenne_int" value="1.33" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">fen√™tres/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fen√™tre difficile</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="fenetre_difficile_int" value="1" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">fen√™tres/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Cadre fen√™tre facile</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="cadre_fenetre_facile_int" value="2" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">cadres/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Cadre fen√™tre difficile</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="cadre_fenetre_difficile_int" value="1" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">cadres/h</td>
              </tr>
            </table>

            <!-- PRODUCTIVIT√â PEINTURE INT√âRIEURE -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light); margin-bottom: 46px;">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Productivit√© Peinture Int√©rieure</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Ratio murs</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="ratio_murs_int" value="150" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Ratio plafonds</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="ratio_plafonds_int" value="140" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Ratio moulures</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="ratio_moulures_int" value="100" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/h</td>
              </tr>
            </table>

            <!-- CO√õTS MAT√âRIAUX INT√âRIEURS -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light); margin-bottom: 46px;">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Co√ªts Mat√©riaux Int√©rieurs</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Appr√™t int√©rieur</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="cout_appret_int" value="55" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/gallon</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Peinture Lifemaster</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="cout_lifemaster_int" value="60" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/gallon</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Peinture Glidden 7700</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="cout_glidden_7700_int" value="60" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/gallon</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Produit client int√©rieur</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="cout_produit_client_int" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/gallon</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Primer int√©rieur</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="cout_primer_int" value="55" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$/gallon</td>
              </tr>
            </table>

            <!-- COUVERTURE PEINTURE INT√âRIEURE -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light); margin-bottom: 46px;">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Couverture Peinture Int√©rieure</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Couverture murs</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="couverture_murs_int" value="400" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/gallon</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Couverture plafonds</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="couverture_plafonds_int" value="400" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/gallon</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Couverture moulures</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="couverture_moulures_int" value="400" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft/gallon</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Couverture appr√™t</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="couverture_appret_int" value="250" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/gallon</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Portes par gallon</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="portes_par_gallon_int" value="15" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">portes/gallon</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fen√™tres par gallon</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="fenetres_par_gallon_int" value="25" step="1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">fen√™tres/gallon</td>
              </tr>
            </table>

            <!-- PARAM√àTRES G√âN√âRAUX INT√âRIEUR -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light); margin-bottom: 46px;">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Param√®tres G√©n√©raux Int√©rieur</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Heures minimum int√©rieur</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="heures_min_int" value="4" step="0.5" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">heures</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Frais d√©placement int√©rieur</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="frais_deplacement_int" value="100" step="5" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">$</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Productivit√© peinture int√©rieur</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="productivite_peinture_int" value="400" step="10" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
            </table>

            <!-- HEURES PORTES INT√âRIEURES (nouveau format) -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light); margin-bottom: 46px;">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Heures Portes Int√©rieures</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte facile</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_porte_facile" value="0.5" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/porte</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte moyenne</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_porte_moyenne" value="0.752" step="0.001" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/porte (1.33 portes/h)</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte difficile</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_porte_difficile" value="1.0" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/porte</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte fran√ßaise</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_porte_francaise" value="2.0" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/porte</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Cadres porte</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_porte_cadres" value="0.5" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/cadre</td>
              </tr>
            </table>

            <!-- HEURES FEN√äTRES INT√âRIEURES (nouveau format) -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light); margin-bottom: 46px;">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Heures Fen√™tres Int√©rieures</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fen√™tre facile</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_fenetre_facile" value="0.5" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/fen√™tre</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fen√™tre moyenne</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_fenetre_moyenne" value="0.75" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/fen√™tre</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fen√™tre difficile</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_fenetre_difficile" value="1.0" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/fen√™tre</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Cadre fen√™tre facile</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_fenetre_cadres_faciles" value="0.5" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/cadre</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Cadre fen√™tre difficile</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_fenetre_cadres_difficiles" value="1.0" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/cadre</td>
              </tr>
            </table>

            <!-- HEURES ITEMS DIVERS INT√âRIEURS -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light); margin-bottom: 46px;">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Heures Items Divers Int√©rieurs</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Garde-robe</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_garde_robe" value="1.0" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Calorif√®re</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_calorifere" value="0.5" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Radiateur 1h</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_radiateur_1h" value="1.0" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Radiateur 2h</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_radiateur_2h" value="2.0" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Marche escalier</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_marche_escalier" value="0.25" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/marche</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Contre-marche</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_contre_marche" value="0.25" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Int√©rieur armoire</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_interieur_armoire" value="0.5" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Complication 0.5h</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_complication_05h" value="0.5" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Complication 1h</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_complication_1h" value="1.0" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">D√©placement 0.5h</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_deplacement_05h" value="0.5" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">D√©placement 1h</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_deplacement_1h" value="1.0" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Tuyau chauffage</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_tuyau_chauffage" value="0.25" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Cadrage</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_cadrage" value="0.25" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h/unit√©</td>
              </tr>
            </table>

            <!-- PRODUCTIVIT√â PLAFONDS SP√âCIAUX -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light); margin-bottom: 46px;">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Productivit√© Plafonds Sp√©ciaux</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Angle cath√©drale</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_angle_cathedrale" value="150" step="5" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Stucco plafond</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_stucco" value="100" step="5" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Plus de 10 pieds</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="int_plus_10pi" value="120" step="5" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">ft¬≤/h</td>
              </tr>
            </table>

            <!-- PARAM√àTRES PR√âPARATION SP√âCIALIS√âS -->
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light); margin-bottom: 46px;">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Param√®tres Pr√©paration Sp√©cialis√©s</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Pr√©paration lavage</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="preparation_lavage" value="0.35" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Pr√©paration grattage</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="preparation_grattage" value="0.5" step="0.05" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Pr√©paration Dry-Dex</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="preparation_fry_dex" value="1.0" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Pr√©paration sablage</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="preparation_sablage" value="2.0" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Pr√©paration autres</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="preparation_autres" value="5.0" step="0.1" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">h</td>
              </tr>
            </table>

          </div>
        </div>

        </div>

      </div>

      <!-- Section Reset -->
      <div class="reset-section mt-6">
        <h3 class="font-bold text-lg mb-4 text-red-700">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          Zone de R√©initialisation
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button class="btn-secondary" onclick="resetParametersSection('productivite')">
            <i class="fas fa-undo"></i> Reset Productivit√©
          </button>
          <button class="btn-secondary" onclick="resetParametersSection('produits')">
            <i class="fas fa-undo"></i> Reset Produits
          </button>
          <button class="btn-secondary" onclick="resetParametersSection('all')">
            <i class="fas fa-undo-alt"></i> Reset Complet
          </button>
        </div>
        <p class="text-sm text-white mt-2">
         [WARN] Attention: Ces actions sont irr√©versibles. Assurez-vous d'exporter vos param√®tres avant de r√©initialiser.
        </p>
      </div>

    </div>

    <!-- Mes Projets Tab -->
    <div id="mes-projets-tab" class="tab-content hidden">
      <div class="box">
        <div class="box-header">
          <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div class="box-header-icon" style="background: linear-gradient(135deg, #14b8a6 0%, #0f766e 100%);">
              <i class="fas fa-folder"></i>
            </div>
            <h2 class="box-header-title">Gestion des Projets</h2>
          </div>
        </div>
        <div class="box-body">
          <div class="mb-4">
            <h3 class="text-lg font-semibold text-white">Projets Sauvegard√©s</h3>
            <p class="text-sm text-white mt-1">Les projets sont sauvegard√©s automatiquement lors de la saisie des informations client</p>
          </div>

          <!-- Vue desktop: Tableau -->
          <div class="overflow-x-auto projects-desktop-view">
            <table class="w-full border-collapse rounded-lg overflow-hidden shadow" style="min-width: 800px; background: var(--bg-card); border: 1px solid var(--border-dark);">
              <thead>
                <tr style="background: #1e293b;">
                  <th class="px-4 py-3 text-left font-semibold text-white" style="width: 30%; border: 1px solid var(--border-dark);">Nom du Client</th>
                  <th class="px-4 py-3 text-left font-semibold text-white" style="width: 20%; border: 1px solid var(--border-dark);">Date de Cr√©ation</th>
                  <th class="px-4 py-3 text-center font-semibold text-white" style="width: 15%; border: 1px solid var(--border-dark);">Type</th>
                  <th class="px-4 py-3 text-left font-semibold text-white" style="width: 20%; border: 1px solid var(--border-dark);">Total ($)</th>
                  <th class="px-4 py-3 text-center font-semibold text-white" style="width: 15%; border: 1px solid var(--border-dark);">Actions</th>
                </tr>
              </thead>
              <tbody id="projects-table-body">
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center" style="border: 1px solid var(--border-dark); color: var(--text-gray);">
                    <i class="fas fa-folder-open text-4xl mb-3 opacity-50 text-blue-400"></i>
                    <p class="text-lg font-medium text-white">Aucun projet sauvegard√©</p>
                    <p class="text-sm mt-2 text-gray-300">Commencez par remplir les informations client pour cr√©er automatiquement un projet</p>
                    <div class="flex justify-center mt-4 space-x-4 text-xs text-gray-400">
                      <div class="flex items-center">
                        <i class="fas fa-save mr-1 text-green-400"></i>
                        Sauvegarder
                      </div>
                      <div class="flex items-center">
                        <i class="fas fa-edit mr-1 text-yellow-400"></i>
                        Modifier
                      </div>
                      <div class="flex items-center">
                        <i class="fas fa-file-pdf mr-1 text-red-400"></i>
                        Exporter PDF
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Vue mobile: Liste de cartes -->
          <div class="projects-mobile-view" style="display: none;">
            <div id="projects-mobile-list" class="space-y-3">
              <!-- √âtat vide -->
              <div class="text-center py-8">
                <i class="fas fa-folder-open text-4xl mb-3 opacity-50 text-blue-400"></i>
                <p class="text-lg font-medium text-white">Aucun projet sauvegard√©</p>
                <p class="text-sm mt-2 text-gray-300">Commencez par remplir les informations client</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Popup D√©tails du Projet (Mobile) -->
    <div id="project-details-overlay" class="total-popup-overlay" style="display: none;" onclick="closeProjectDetails(event)">
      <div class="total-popup-content" onclick="event.stopPropagation()">
        <div class="total-popup-header">
          <h2 id="project-details-title">D√©tails du Projet</h2>
          <button class="total-popup-close" onclick="closeProjectDetails()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="project-details-body" class="total-popup-body">
          <!-- Le contenu sera inject√© dynamiquement -->
        </div>
      </div>
    </div>

  </div>

  </div><!-- Fin de .main-content pour extraction SPA -->


  <!-- Product Database & JavaScript -->
  <script>
    // ‚ö° ACTIVATION DES LOGS - Debug mode
    window.log = console.log.bind(console);
    window.warn = console.warn.bind(console);
    window.error = console.error.bind(console);
    window.info = console.info.bind(console);
    window.debug = console.debug.bind(console);

    // Fonction pour retourner √† la page Outils
    function goBackToOutils() {
      // V√©rifier si on est dans une iframe (syst√®me outils-mobile.html)
      if (window.parent && window.parent !== window && typeof window.parent.returnToToolsGrid === 'function') {
        // Nouveau syst√®me: appeler la fonction du parent pour retourner √† la grille
        console.log('[CALCUL] Retour √† la grille via parent.returnToToolsGrid()');
        window.parent.returnToToolsGrid();
      } else if (window.parent && window.parent !== window) {
        // Ancien syst√®me: utiliser l'historique (pour compatibilit√©)
        console.log('[CALCUL] Retour via history.back()');
        window.history.back();
      } else if (window.top && window.top !== window) {
        // Deuxi√®me niveau d'iframe
        window.history.back();
      } else {
        // Pas dans un iframe - redirection directe
        window.location.href = 'outilsmobile.html';
      }
    }

    // Fonction pour assurer la visibilit√© du bouton retour - D√âSACTIV√âE (g√©r√© par CSS)
    function ensureBackButtonVisible() {
      // Ne rien faire - la visibilit√© est g√©r√©e par CSS responsive
    }

    // Fonction pour forcer les permissions et visibilit√© des √©l√©ments selon le r√¥le
    function enforceRoleBasedVisibility() {
      ensureBackButtonVisible();

      // Forcer la v√©rification des permissions pour l'option Param√®tres mobile
      if (typeof toggleParametersAdminTab === 'function') {
        toggleParametersAdminTab();
        log('Role-based visibility enforced - User:', username, 'Role:', userRole, 'CanEdit:', canEditParameters);
      }
    }

    // S'assurer que le bouton est toujours visible - TOUS les √©v√©nements possibles
    document.addEventListener('DOMContentLoaded', enforceRoleBasedVisibility);
    window.addEventListener('load', enforceRoleBasedVisibility);
    window.addEventListener('pageshow', enforceRoleBasedVisibility);

    // Ex√©cution imm√©diate si le DOM est d√©j√† charg√©
    if (document.readyState !== 'loading') {
      enforceRoleBasedVisibility();
    }

    // V√©rification r√©p√©t√©e pour s'assurer que tout reste correct
    setTimeout(enforceRoleBasedVisibility, 100);
    setTimeout(enforceRoleBasedVisibility, 500);
    setTimeout(enforceRoleBasedVisibility, 1000);

    // ========================================
    // D√âSACTIVER SCROLL MOLETTE SUR INPUTS NUMBER
    // ========================================
    document.addEventListener('wheel', function(e) {
      if (e.target.type === 'number') {
        e.target.blur();
      }
    }, { passive: true });

    // ========================================
    // VALIDATION BOUTON "COMPL√âTER SOUMISSION"
    // ========================================

    // Fonction pour v√©rifier si tous les champs requis sont remplis
    // NOTE: Les boutons "Compl√©ter soumission" sont g√©r√©s par enableCompleterButtons/disableCompleterButtons
    // et ne sont activ√©s que quand on est DANS un projet (currentLoadedProjectId est d√©fini)
    function validateCompleterButton() {
      // Cette fonction ne fait plus rien pour les boutons Compl√©ter
      // Ils sont maintenant contr√¥l√©s par createProjectFromButton et quitProject
      // On garde la fonction pour la compatibilit√© avec les appels existants
    }

    // Fonction pour mettre √† jour la bordure d'un champ client
    function updateClientFieldBorder(field) {
      if (!field) return;
      const value = field.value.trim();

      // Validation sp√©cifique pour le t√©l√©phone (format XXX-XXX-XXXX)
      let isValid;
      if (field.id === 'clientPhone') {
        isValid = /^\d{3}-\d{3}-\d{4}$/.test(value);
      } else {
        // Pour les autres champs, v√©rifier si non vide
        isValid = value !== '';
      }

      field.style.setProperty('border-right-color', isValid ? '#4caf50' : '#e57373', 'important');

      // Mettre √† jour le message de validation
      updateClientValidationMessage();
    }

    // Fonction pour v√©rifier si un champ a une bordure verte (comme soumission.html)
    function hasGreenBorderCalc(element) {
      if (!element) return false;
      // D'abord v√©rifier le style inline (plus fiable)
      const inlineStyle = element.style.borderRightColor;
      if (inlineStyle) {
        if (inlineStyle.includes('4caf50') || inlineStyle.includes('76, 175, 80') || inlineStyle === 'rgb(76, 175, 80)') {
          return true;
        }
        if (inlineStyle.includes('e57373') || inlineStyle.includes('229, 115, 115') || inlineStyle === 'rgb(229, 115, 115)') {
          return false;
        }
      }
      // Fallback sur getComputedStyle
      const borderColor = getComputedStyle(element).borderRightColor;
      const match = borderColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
      if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        return g > r && g > b;
      }
      return false;
    }

    // Fonction pour afficher/cacher le message de validation client
    function updateClientValidationMessage() {
      const validationMessage = document.getElementById('clientInfoValidationMessage');
      if (!validationMessage) return;

      const clientPrenomField = document.getElementById('clientPrenom');
      const clientNomField = document.getElementById('clientNom');
      const clientAddressField = document.getElementById('clientAddress');
      const clientPhoneField = document.getElementById('clientPhone');

      // V√©rifier si tous les champs ont une bordure verte
      const allValid = hasGreenBorderCalc(clientPrenomField) &&
                       hasGreenBorderCalc(clientNomField) &&
                       hasGreenBorderCalc(clientAddressField) &&
                       hasGreenBorderCalc(clientPhoneField);

      const createBtn = document.getElementById('createProjectBtn');

      // Si on est d√©j√† dans un projet, ne pas toucher au bouton
      if (currentLoadedProjectId) return;

      if (allValid) {
        validationMessage.style.display = 'none';
        // Activer le bouton "Cr√©er le projet"
        if (createBtn) {
          createBtn.disabled = false;
          createBtn.style.opacity = '1';
          createBtn.style.cursor = 'pointer';
        }
      } else {
        validationMessage.style.display = 'block';
        // D√©sactiver le bouton "Cr√©er le projet"
        if (createBtn) {
          createBtn.disabled = true;
          createBtn.style.opacity = '0.5';
          createBtn.style.cursor = 'not-allowed';
        }
      }
    }

    // Fonction pour activer les boutons de compl√©tion
    function enableCompleterButtons() {
      const buttons = document.querySelectorAll('.completer-soumission-btn, .envoyer-estimation-btn, #completer-btn, #completer-btn-mobile');
      buttons.forEach(btn => {
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        btn.style.pointerEvents = 'auto';
        btn.disabled = false;
      });
    }

    // Fonction pour d√©sactiver les boutons de compl√©tion
    function disableCompleterButtons() {
      const buttons = document.querySelectorAll('.completer-soumission-btn, .envoyer-estimation-btn, #completer-btn, #completer-btn-mobile');
      buttons.forEach(btn => {
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
        btn.style.pointerEvents = 'none';
        btn.disabled = true;
      });
    }

    // ============================================
    // AUTO-SAVE & SECTION LOCKING SYSTEM
    // ============================================

    let autoSaveTimeout = null;
    let isAutoSaveEnabled = false;
    let sectionsUnlocked = false;
    let isCreatingProject = false; // Flag pour √©viter les cr√©ations multiples
    const AUTO_SAVE_DELAY = 800; // 800ms apr√®s le dernier changement (rapide)

    // Fonction pour d√©sactiver le contenu des sections de calcul
    function lockCalculationSections() {
      // Permettre le re-verrouillage (pour quitter un projet)
      const tabsToLock = ['estimation-tab', 'interieur-tab', 'produits-tab'];

      tabsToLock.forEach(tabId => {
        const tab = document.getElementById(tabId);
        if (!tab) return;

        // Trouver toutes les boxes, glass-cards ET result-cards dans ce tab
        const sections = tab.querySelectorAll('.box, .glass-card, .result-card');

        sections.forEach(section => {
          // Ajouter un overlay visuel sur chaque section (bloque tous les clics)
          if (!section.querySelector('.lock-overlay')) {
            const overlay = document.createElement('div');
            overlay.className = 'lock-overlay';
            overlay.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.6); z-index: 100; border-radius: 18px; cursor: default;';
            section.style.position = 'relative';
            section.appendChild(overlay);
          }
        });
      });

      log('[LOCK] Sections de calcul verrouill√©es (par box/glass-card)');
    }

    // Fonction pour activer le contenu des sections de calcul
    function unlockCalculationSections() {
      if (sectionsUnlocked) return; // D√©j√† d√©verrouill√©

      const tabsToUnlock = ['estimation-tab', 'interieur-tab', 'produits-tab'];

      tabsToUnlock.forEach(tabId => {
        const tab = document.getElementById(tabId);
        if (!tab) return;

        // Trouver toutes les boxes, glass-cards ET result-cards dans ce tab
        const sections = tab.querySelectorAll('.box, .glass-card, .result-card');

        sections.forEach(section => {
          // Retirer l'overlay
          const overlay = section.querySelector('.lock-overlay');
          if (overlay) {
            overlay.remove();
          }
        });
      });

      sectionsUnlocked = true;
      isAutoSaveEnabled = true;
      log('[UNLOCK] Sections de calcul d√©verrouill√©es (par box/glass-card) - Auto-save activ√©');
    }

    // Fonction pour cr√©er automatiquement un projet
    async function autoCreateProject() {
      // Ne pas cr√©er si un projet est d√©j√† charg√© ou en cours de cr√©ation
      if (currentLoadedProjectId) {
        log('[AUTO-CREATE] Projet d√©j√† charg√©, pas de cr√©ation');
        return;
      }
      if (isCreatingProject) {
        log('[AUTO-CREATE] Cr√©ation d√©j√† en cours, ignor√©');
        return;
      }

      // Marquer comme en cours de cr√©ation AVANT tout
      isCreatingProject = true;

      const username = localStorage.getItem('username') || 'default';
      const prenom = document.getElementById('clientPrenom')?.value.trim() || '';
      const nom = document.getElementById('clientNom')?.value.trim() || '';
      const clientAddress = document.getElementById('clientAddress')?.value.trim() || '';
      const clientPhone = document.getElementById('clientPhone')?.value.trim() || '';

      // Cr√©er un nouveau projet avec les infos client
      const clientName = `${prenom} ${nom}`.trim() || 'Nouveau projet';
      const newProjectId = Date.now().toString();

      try {
        showAutoSaveStatus('creating');

        // Collecter les donn√©es du formulaire (utilise la fonction existante)
        const formData = typeof collecterToutesDonnees === 'function' ? collecterToutesDonnees() : {};

        // R√©cup√©rer le total depuis #totalCombine
        const totalCombineEl = document.getElementById('totalCombine');
        const totalText = totalCombineEl ? totalCombineEl.textContent : '0';
        // Convertir "800,00 $" en nombre 800.00
        const totalValue = parseFloat(totalText.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;

        // Utiliser le m√™me format que completerSoumission
        const projet = {
          id: newProjectId,
          client: clientName,
          adresse: clientAddress,
          telephone: clientPhone,
          dateCreation: (() => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${day}/${month}/${year}`;
          })(),
          total: totalValue,
          formData: formData
        };

        const response = await fetch('/api/projets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: username,
            projet: projet,
            updateExisting: false
          })
        });

        if (response.ok) {
          currentLoadedProjectId = newProjectId;
          log(`[AUTO-CREATE] Projet cr√©√© automatiquement: ${clientName} (ID: ${currentLoadedProjectId})`);
          showAutoSaveStatus('saved');
        } else {
          error('[AUTO-CREATE] Erreur cr√©ation projet:', response.status);
          showAutoSaveStatus('error');
          isCreatingProject = false; // Permettre une nouvelle tentative
        }
      } catch (err) {
        error('[AUTO-CREATE] Erreur:', err);
        showAutoSaveStatus('error');
        isCreatingProject = false; // Permettre une nouvelle tentative
      }
    }

    // Fonction pour d√©clencher l'auto-save avec debounce
    function triggerAutoSave() {
      // Ne sauvegarder que si auto-save est activ√© et un projet existe
      if (!isAutoSaveEnabled || !currentLoadedProjectId) return;

      // Annuler le timeout pr√©c√©dent
      if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
      }

      // Afficher "Sauvegarde..."
      showAutoSaveStatus('saving');

      // Nouveau timeout pour sauvegarder
      autoSaveTimeout = setTimeout(async () => {
        try {
          await autoSaveProject();
          showAutoSaveStatus('saved');
        } catch (err) {
          error('[AUTO-SAVE] Erreur:', err);
          showAutoSaveStatus('error');
        }
      }, AUTO_SAVE_DELAY);
    }

    // Fonction pour sauvegarder le projet automatiquement
    async function autoSaveProject() {
      if (!currentLoadedProjectId) return;

      const username = localStorage.getItem('username') || 'default';
      const prenom = document.getElementById('clientPrenom')?.value.trim() || '';
      const nom = document.getElementById('clientNom')?.value.trim() || '';
      const clientName = `${prenom} ${nom}`.trim() || 'Projet';
      const clientAddress = document.getElementById('clientAddress')?.value.trim() || '';
      const clientPhone = document.getElementById('clientPhone')?.value.trim() || '';

      const formData = typeof collecterToutesDonnees === 'function' ? collecterToutesDonnees() : {};

      // R√©cup√©rer le total depuis #totalCombine
      const totalCombineEl = document.getElementById('totalCombine');
      const totalText = totalCombineEl ? totalCombineEl.textContent : '0';
      // Convertir "800,00 $" en nombre 800.00
      const totalValue = parseFloat(totalText.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;

      // Utiliser le m√™me format que completerSoumission
      const projet = {
        id: currentLoadedProjectId,
        client: clientName,
        adresse: clientAddress,
        telephone: clientPhone,
        dateCreation: (() => {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          return `${day}/${month}/${year}`;
        })(),
        total: totalValue,
        formData: formData
      };

      const response = await fetch('/api/projets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: username,
          projet: projet,
          updateExisting: true
        })
      });

      if (!response.ok) {
        throw new Error(`Erreur sauvegarde: ${response.status}`);
      }

      log(`[AUTO-SAVE] Projet sauvegard√©: ${clientName}`);
    }

    // Fonction pour afficher le statut de sauvegarde (toujours visible en haut √† droite)
    function showAutoSaveStatus(status) {
      let statusEl = document.getElementById('auto-save-status');

      if (!statusEl) {
        // Cr√©er l'√©l√©ment de statut s'il n'existe pas (en haut √† droite, toujours visible)
        statusEl = document.createElement('div');
        statusEl.id = 'auto-save-status';
        statusEl.style.cssText = 'position: fixed; top: 80px; right: 20px; padding: 10px 18px; border-radius: 8px; font-size: 14px; font-weight: 500; z-index: 9999; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);';
        document.body.appendChild(statusEl);
        // Afficher "√Ä jour" par d√©faut
        showAutoSaveStatus('saved');
        return;
      }

      switch(status) {
        case 'saving':
          statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sauvegarde...';
          statusEl.style.background = 'rgba(59, 130, 246, 0.95)';
          statusEl.style.color = 'white';
          break;
        case 'creating':
          statusEl.innerHTML = '<i class="fas fa-plus-circle"></i> Cr√©ation...';
          statusEl.style.background = 'rgba(139, 92, 246, 0.95)';
          statusEl.style.color = 'white';
          break;
        case 'saved':
          // R√©cup√©rer le nom du client pour l'afficher
          const prenomVal = document.getElementById('clientPrenom')?.value.trim() || '';
          const nomVal = document.getElementById('clientNom')?.value.trim() || '';
          const clientNameDisplay = `${prenomVal} ${nomVal}`.trim();

          if (clientNameDisplay) {
            statusEl.innerHTML = `<i class="fas fa-check-circle"></i> ${clientNameDisplay} - √Ä jour`;
          } else {
            statusEl.innerHTML = '<i class="fas fa-check-circle"></i> √Ä jour';
          }
          statusEl.style.background = 'rgba(34, 197, 94, 0.95)';
          statusEl.style.color = 'white';
          // Ne pas cacher - toujours visible
          break;
        case 'error':
          statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erreur';
          statusEl.style.background = 'rgba(239, 68, 68, 0.95)';
          statusEl.style.color = 'white';
          // Revenir √† "√Ä jour" apr√®s 3 secondes
          setTimeout(() => {
            showAutoSaveStatus('saved');
          }, 3000);
          break;
      }
    }

    // Initialiser l'indicateur au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
      // Cr√©er l'indicateur de sauvegarde (cach√© jusqu'√† ce qu'un projet soit actif)
      setTimeout(() => {
        if (currentLoadedProjectId || sectionsUnlocked) {
          showAutoSaveStatus('saved');
        }
      }, 1000);
    });

    // Fonction appel√©e quand on clique sur "Cr√©er le projet"
    async function createProjectFromButton() {
      const createBtn = document.getElementById('createProjectBtn');
      if (!createBtn || createBtn.disabled) return;

      log('[PROJECT] Cr√©ation du projet via bouton');

      // Cr√©er le projet
      await autoCreateProject();

      // Si le projet a √©t√© cr√©√© avec succ√®s
      if (currentLoadedProjectId) {
        // Verrouiller les champs client (les griser)
        lockClientInfoFields();

        // D√©verrouiller les sections de calcul
        unlockCalculationSections();

        // Activer les boutons de compl√©tion
        enableCompleterButtons();

        // Changer le bouton en "Quitter le projet"
        createBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Quitter le projet';
        createBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
        createBtn.onclick = quitProject;
        createBtn.disabled = false;
        createBtn.style.opacity = '1';
        createBtn.style.cursor = 'pointer';
      }

      // Afficher le bouton total mobile
      if (typeof updateMobileTotalButton === 'function') {
        updateMobileTotalButton();
      }
    }

    // Fonction pour verrouiller les champs client (quand on est dans un projet)
    function lockClientInfoFields() {
      const fields = ['clientPrenom', 'clientNom', 'clientAddress', 'clientPhone'];
      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.disabled = true;
          field.style.opacity = '0.6';
          field.style.cursor = 'not-allowed';
          field.style.background = 'rgba(30, 41, 59, 0.5)';
        }
      });

      // Afficher le bouton "Modifier les infos" (bleu)
      const editClientBtn = document.getElementById('editClientInfoBtn');
      if (editClientBtn) {
        editClientBtn.style.display = 'flex';
        editClientBtn.innerHTML = '<i class="fas fa-user-edit"></i> Modifier les infos';
        editClientBtn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
        editClientBtn.dataset.editing = 'false';
        editClientBtn.disabled = false;
        editClientBtn.style.opacity = '1';
      }
    }

    // Fonction pour d√©verrouiller les champs client (quand on quitte un projet)
    function unlockClientInfoFields() {
      const fields = ['clientPrenom', 'clientNom', 'clientAddress', 'clientPhone'];
      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.disabled = false;
          field.style.opacity = '1';
          field.style.cursor = 'text';
          field.style.background = '';
        }
      });
    }

    // Modifier / Enregistrer les infos client (calculateur)
    async function toggleEditClientInfo() {
      const btn = document.getElementById('editClientInfoBtn');
      if (!btn) return;

      const isEditing = btn.dataset.editing === 'true';

      if (!isEditing) {
        // === Mode √©dition : d√©verrouiller les champs client ===
        const fields = ['clientPrenom', 'clientNom', 'clientAddress', 'clientPhone'];
        // Sauvegarder les valeurs actuelles avant modification
        window._editClientOriginal = {
          prenom: document.getElementById('clientPrenom')?.value || '',
          nom: document.getElementById('clientNom')?.value || '',
          telephone: document.getElementById('clientPhone')?.value || '',
          adresse: document.getElementById('clientAddress')?.value || ''
        };
        fields.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field) {
            field.disabled = false;
            field.style.opacity = '1';
            field.style.cursor = 'text';
            field.style.background = '';
          }
        });
        btn.innerHTML = '<i class="fas fa-save"></i> Enregistrer les modifications';
        btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        btn.dataset.editing = 'true';
      } else {
        // === Mode sauvegarde : enregistrer et re-verrouiller ===
        const prenom = document.getElementById('clientPrenom')?.value || '';
        const nom = document.getElementById('clientNom')?.value || '';
        const telephone = document.getElementById('clientPhone')?.value || '';
        const adresse = document.getElementById('clientAddress')?.value || '';

        try {
          btn.disabled = true;
          btn.style.opacity = '0.6';
          const response = await fetch(`${window.location.origin}/api/update-client-info-calcul`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: window.username,
              project_id: currentLoadedProjectId,
              prenom,
              nom,
              telephone,
              adresse,
              old_prenom: window._editClientOriginal?.prenom || '',
              old_nom: window._editClientOriginal?.nom || '',
              old_telephone: window._editClientOriginal?.telephone || '',
              old_adresse: window._editClientOriginal?.adresse || ''
            })
          });
          const result = await response.json();
          if (result.status === 'success') {
            showNotification('Infos client mises √† jour avec succ√®s', 'success');
          } else {
            showNotification('Erreur lors de la mise √† jour: ' + (result.detail || 'Erreur inconnue'), 'error');
          }
        } catch (err) {
          console.error('[EDIT-CLIENT] Erreur:', err);
          showNotification('Erreur r√©seau lors de la mise √† jour', 'error');
        }

        // Re-verrouiller les champs
        lockClientInfoFields();
        btn.disabled = false;
        btn.style.opacity = '1';
      }
    }

    // Fonction pour quitter le projet actuel
    function quitProject() {
      log('[PROJECT] Quitter le projet - R√âINITIALISATION COMPL√àTE');

      // Appeler resetFormFields pour tout remettre √† z√©ro (incluant compteurs)
      if (typeof resetFormFields === 'function') {
        resetFormFields();
      }

      // S'assurer que les flags sont r√©initialis√©s
      currentLoadedProjectId = null;
      isAutoSaveEnabled = false;
      sectionsUnlocked = false;
      isCreatingProject = false;

      // Verrouiller les sections de calcul
      lockCalculationSections();

      // D√©verrouiller les champs client
      unlockClientInfoFields();

      // R√©initialiser les champs client (vider et mettre bordure rouge)
      const clientFields = ['clientPrenom', 'clientNom', 'clientAddress', 'clientPhone'];
      clientFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.value = '';
          field.style.setProperty('border-right-color', '#e57373', 'important');
        }
      });

      // Cacher le bouton "Modifier les infos"
      const editClientBtn = document.getElementById('editClientInfoBtn');
      if (editClientBtn) {
        editClientBtn.style.display = 'none';
        editClientBtn.dataset.editing = 'false';
      }

      // D√©sactiver les boutons de compl√©tion
      disableCompleterButtons();

      // Remettre le bouton en "Cr√©er le projet" (d√©sactiv√©)
      const createBtn = document.getElementById('createProjectBtn');
      if (createBtn) {
        createBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Cr√©er le projet';
        createBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        createBtn.onclick = createProjectFromButton;
        createBtn.disabled = true;
        createBtn.style.opacity = '0.5';
        createBtn.style.cursor = 'not-allowed';
      }

      // Afficher le message de validation
      const validationMessage = document.getElementById('clientInfoValidationMessage');
      if (validationMessage) {
        validationMessage.style.display = 'block';
      }

      // Cacher l'indicateur de sauvegarde
      const statusEl = document.getElementById('auto-save-status');
      if (statusEl) {
        statusEl.style.display = 'none';
      }

      // Cacher le bouton total mobile
      const mobileTotalBtn = document.getElementById('mobile-total-btn');
      if (mobileTotalBtn) {
        mobileTotalBtn.style.display = 'none';
      }

      // Forcer la mise √† jour des calculs √† 0
      if (typeof updateCalculation === 'function') {
        setTimeout(() => updateCalculation(), 100);
      }

      log('[PROJECT] Projet quitt√©, tout r√©initialis√©, pr√™t pour un nouveau projet');
    }

    // Ajouter des √©couteurs d'√©v√©nements sur les champs
    document.addEventListener('DOMContentLoaded', function() {
      const fields = ['clientPrenom', 'clientNom', 'clientAddress', 'clientPhone'];

      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', function() {
            validateCompleterButton();
            updateClientFieldBorder(this);
          });
          field.addEventListener('change', function() {
            validateCompleterButton();
            updateClientFieldBorder(this);
          });
          // Mise √† jour initiale de la bordure
          updateClientFieldBorder(field);
        }
      });

      // Validation initiale
      validateCompleterButton();

      // Verrouiller les sections au d√©marrage si pas de projet charg√© et infos client incompl√®tes
      setTimeout(() => {
        if (!currentLoadedProjectId) {
          const prenom = document.getElementById('clientPrenom')?.value.trim() || '';
          const nom = document.getElementById('clientNom')?.value.trim() || '';
          const adresse = document.getElementById('clientAddress')?.value.trim() || '';
          const telephone = document.getElementById('clientPhone')?.value.trim() || '';

          if (!(prenom && nom && adresse && telephone)) {
            lockCalculationSections();
            disableCompleterButtons();
          }
        }
      }, 500);
    });

    // Validation initiale si le DOM est d√©j√† charg√©
    if (document.readyState !== 'loading') {
      const fields = ['clientPrenom', 'clientNom', 'clientAddress', 'clientPhone'];

      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', function() {
            validateCompleterButton();
            updateClientFieldBorder(this);
          });
          field.addEventListener('change', function() {
            validateCompleterButton();
            updateClientFieldBorder(this);
          });
          // Mise √† jour initiale de la bordure
          updateClientFieldBorder(field);
        }
      });

      validateCompleterButton();
    }

    // Param√®tres complets bas√©s sur l'analyse Excel
    const DEFAULT_PARAMETERS = {
      // Param√®tres g√©n√©raux (du fichier Excel)
      frais_deplacement: 100,
      heures_min_prep: 4,
      accessoires: 1,
      
      // Lavage (du fichier Excel)
      lavage_pression: 400,
      lavage_main_surface: 225,
      lavage_main_lineaire: 100,
      lavage_intense_balcon: 150,
      lavage_portes_fenetres: 20,
      
      // Pr√©paration (du fichier Excel)
      grat_spot_40min: 0.66,  // 0.66 heures par pied (40min arrondi)
      grat_spot_20min: 1/3,  // 0.333333... (20min = 1/3 heure)
      grat_spot_10min: 1/6,  // 0.166666... (10min = 1/6 heure)
      grattage_spot_1h: 1,
      grattage_spot_2h: 2,
      grattage_complet: 60,
      grat_mur_peu: 70,
      grat_mur_beaucoup: 60,
      grat_mur_tout: 40,
      grat_corniche_1er_peu: 20,
      grat_corniche_1er_tout: 15,
      grat_corniche_2eme_peu: 15,
      grat_corniche_2eme_tout: 10,
      calfeutrage_lineaire: 50,
      sablage_main_surface: 90,
      sablage_main_lineaire: 40,
      sablage_mecanique_surface: 225,
      sablage_mecanique_lineaire: 100,
      masquage_surface: 600,
      masquage_lineaire: 250,
      sablage_surface: 100,
      
      // Facteurs de pr√©paration
      facteur_preparation_portes: 1.4,
      
      // Primer (du fichier Excel)
      primer_surface_facile: 110,
      primer_surface_difficile: 70,
      primer_lineaire_1er: 25,
      primer_lineaire_2eme: 20,
      
      // Rev√™tement/Peinture (du fichier Excel)
      peinture_latte_4po: 55,
      peinture_revetement_6po: 75,
      teindre_bardeau_neuf: 55,
      teindre_bardeau_vieux: 40,
      stucco_faible_relief: 65,
      stucco_fort_relief: 45,
      brique: 45,
      solage_facile: 85,
      solage_difficile: 55,
      
      // Corniches et moulures (du fichier Excel)
      fascia_plate_1er: 30,
      fascia_complexe_2e: 20,
      corniche_plate_1er: 22,
      corniche_texturee_1er: 18,
      corniche_complexe_1er: 13,
      corniche_plate_2e: 18,
      corniche_texturee_2e: 13,
      corniche_complexe_2e: 9,
      
      // Fen√™tres et volets (du fichier Excel)
      fenetre_sous_sol: 1/4,  // 0.25
      fenetre_facile_cadre: 0.333333333333333,  // 1/3 exact avec toutes les d√©cimales
      fenetre_moyenne: 1/2,  // 0.5
      fenetre_difficile: 1.25,
      fenetre_3_6_carreaux: 1.0,
      fenetre_carreaux_6plus: 0.17,  // Ajust√© pour donner 0.85h avec qt√© 5
      volet_plat_simple: 0.5,
      volet_avec_motifs: 1.0,
      grande_fenetre_bay: 0.75,
      
      // Portes (du fichier Excel)
      porte_facile: 1/3,  // 0.333333...
      porte_moyenne: 0.66,  // 0.66 heures par porte
      porte_difficile: 1.25,
      porte_garage_simple: 1.5,
      porte_garage_difficile: 2.5,

      // Moulures et carreaux portes (bas√© sur HTML)
      moulure_cadre_porte_facile: 0.25,
      moulure_cadre_porte_moyenne: 0.50,
      moulure_cadre_porte_difficile: 1.00,
      moulure_porte_garage_facile: 0.66,
      moulure_porte_garage_moyen: 1.00,
      moulure_porte_garage_difficile: 1.50,
      carreaux_portes_cadres: 0.17,
      
      // Balcon (du fichier Excel)
      plancher_teinture_semi: 75,
      plancher_opaque_peinture: 100,
      mains_courantes: 50,
      marches_balcon: 4,
      rampes_barreaux_simple: 16,
      rampes_barreaux_modere: 12,
      rampes_barreaux_complexe: 8,
      piliers_simples: 3,
      piliers_complexes: 1.5,
      treillis: 40,
      pergola: 2,
      treillis_cloture: 40,
      treillis_autres: 40,

      // Lucarnes (section Autres)
      lucarne_facile_acces: 2.0,
      lucarne_difficile_acces: 3.0,

      // Descente goutti√®re (section Autres)
      d_gouttiere: 20,  // 20 ft/h

      // Facteur deuxi√®me couche
      facteur_deuxieme_couche: 0.7,

      // Ratios quantit√© peinture (du fichier Excel)
      reducteur_bardeau_neuf: 0.9,
      reducteur_bardeau_vieux: 1.0,
      reducteur_stucco_faible: 0.85,
      reducteur_stucco_fort: 0.9,
      reducteur_brique: 0.95,
      reducteur_solage_facile: 0.75,
      reducteur_solage_difficile: 1.0,
      
      // √âl√©ments sp√©cifiques (du fichier Excel)
      barreaux_gallon: 135,
      piliers_gallon: 20,
      fenetres_gallon: 35,
      fenetre_sous_sol_gallon: 35,
      fenetre_facile_cadre_gallon: 35,
      fenetre_moyenne_gallon: 35,
      fenetre_difficile_gallon: 35,
      volet_plat_simple_gallon: 20,
      volet_avec_motifs_gallon: 20,
      grande_fenetre_bay_gallon: 35,
      porte_facile_gallon: 20,
      porte_moyenne_gallon: 20,
      porte_difficile_gallon: 20,
      porte_garage_simple_gallon: 10,
      porte_garage_difficile_gallon: 10,
      moulure_cadre_porte_facile_gallon: 35,
      moulure_cadre_porte_moyenne_gallon: 35,
      moulure_cadre_porte_difficile_gallon: 35,
      moulure_porte_garage_facile_gallon: 35,
      moulure_porte_garage_moyen_gallon: 35,
      moulure_porte_garage_difficile_gallon: 35,
      carreaux_portes_cadres_gallon: 35,
      portes_gallon: 20,
      portes_garage_gallon: 10,
      cadres_portes_gallon: 35,
      corniches_gallon: 200,
      moulures_gallon: 400,
      volets_gallon: 20,
      marches_gallon: 20,
      gouttiere_gallon: 400,
      cloture_panneau_gallon: 6,
      cloture_treillis_gallon: 200,
      panneau_verticales_facile_gallon: 6,     // 6 panneaux/gallon
      panneau_verticales_moyenne_gallon: 5,    // 5 panneaux/gallon
      panneau_verticales_difficile_gallon: 5,  // 5 panneaux/gallon

      // Ratios fer forg√© (quantit√© √∑ ratio = gallons)
      fer_forge_rampes_gallon: 135,           // comme barreaux_gallon
      fer_forge_marches_gallon: 20,           // comme marches_gallon
      fer_forge_planchers_gallon: 50,         // pour planchers industriels
      fer_forge_ornements_gallon: 200,        // √©l√©ments complexes
      fer_forge_poteaux_gallon: 25,           // comme piliers
      fer_forge_fascia_gallon: 100,           // √©l√©ments lin√©aires
      cloture_pergola_gallon: 5,
      treillis_gallon: 200,              // Ratio pour treillis balcon
      lucarnes_gallon: 8,
      mains_courantes_gallon: 400,       // AJOUT√â: ratio pour mains courantes
      pergola_gallon: 20,                // AJOUT√â: ratio pour pergola (piliers)
      autre_20min_gallon: 6,
      autre_30min_gallon: 4,
      autre_1h_gallon: 2,
      
      // === RATIOS POUR FORMULE 1 (Bar√®me CSV) ===
      // Section Rev√™tement
      ratio_latte_horizontale_4po: 1,
      ratio_revetement_horizontal_6po: 1,
      ratio_bardeau_cedre_neuf: 0.9,
      ratio_bardeau_cedre_vieux: 1,
      ratio_stucco_faible_relief: 0.85,
      ratio_stucco_fort_relief: 0.9,
      ratio_brique: 0.95,
      ratio_solage_facile: 0.75,
      ratio_solage_difficile: 1,

      // Section Primer (surface compl√®te)
      ratio_primer_surface_facile: 1,
      ratio_primer_surface_difficile: 1,
      ratio_primer_lineaire_1er: 300,
      ratio_primer_lineaire_2eme: 300,

      // Section Fascia et Corniches
      ratio_fascia_plate_1er: 400,
      ratio_fascia_complexe_2e: 400,
      ratio_corniche_plate_1er: 200,
      ratio_corniche_texturee_1er: 200,
      ratio_corniche_complexe_1er: 200,
      ratio_corniche_plate_2e: 200,
      ratio_corniche_texturee_2e: 200,
      ratio_corniche_complexe_2e: 200,

      // Section Fen√™tres et Volets
      ratio_fenetre_sous_sol: 35,
      ratio_fenetre_facile_cadre: 35,
      ratio_fenetre_moyenne: 35,
      ratio_fenetre_difficile: 35,
      ratio_fenetre_3_6_carreaux: 35,
      ratio_fenetre_carreaux: 35,
      ratio_volet_plat_simple: 20,
      ratio_volet_avec_motifs: 20,
      ratio_grande_fenetre_bay: 35,

      // Section Balcon
      ratio_plancher_teinture_semi: 1,
      ratio_plancher_opaque_peinture: 1,
      ratio_mains_courantes: 400,
      ratio_marches: 20,
      ratio_rampes_barreau_simple: 135,
      ratio_rampes_barreau_modere: 135,
      ratio_rampes_barreau_complexe: 135,
      ratio_piliers_simples: 20,
      ratio_piliers_complexes: 20,
      ratio_treillis: 200,
      ratio_pergola: 20,

      // Note: Param√®tres des produits maintenant g√©r√©s dans l'onglet Produits
      produit_client_couverture: 300,
      produit_client_prix: 20,
      excel_scellant_couverture: 190,
      excel_scellant_prix: 50,
      dulux_eau_st_couverture: 200,
      dulux_eau_st_prix: 80,
      perma_crete_couverture: 100,
      perma_crete_prix: 350,
      pitt_glaze_couverture: 300,
      pitt_glaze_prix: 110,
      hc_color_top_couverture: 150,
      hc_color_top_prix: 90,
      
      // Primers (du fichier Excel)
      dulux_gripper_couverture: 200,
      dulux_gripper_prix: 100,
      jammer_huile_couverture: 200,
      jammer_huile_prix: 100,
      gripper_couvrant_couverture: 200,
      gripper_couvrant_prix: 100,
      
      // Param√®tres peintures sp√©cialis√©es
      peinture_bois_couverture: 325,
      peinture_bois_prix: 58.00,
      peinture_ciment_couverture: 300,
      peinture_ciment_prix: 52.00,
      teinture_bois_couverture: 150,
      teinture_bois_prix: 70.00,
      
      // Param√®tres financiers
      tvq_taxes: 14.975,
      
      // Prix fer forg√© (du fichier Excel - valeurs exactes)
      rampe_complexe_tres_rouillee: 17.33,
      rampe_complexe_moyennement_rouillee: 13.65,
      rampe_barreaux_droits_verticaux: 11.55,
      rampe_horizontale_moyenne_tres_rouillee: 9.5,
      rampe_horizontale_facile_moyennement_rouillee: 7.35,
      marches_languettes_rouillees: 31,
      marches_languettes_tres_rouillees: 37.5,
      dessous_balcon_4x8: 210,
      planchers_industriels: 4,
      marches_industrielles: 45,
      ornements: 200,
      poteaux: 25,
      fascia_sous_balcon: 2.5,

      // Prix peinture fer forg√© ($/gallon)
      peinture_fer_forge: 47.50,
      
      // Param√®tres Int√©rieurs
      // Lavage int√©rieur (productivit√© en ft¬≤/h ou ft/h)
      lavage_mur_simple: 180,
      lavage_mur_complexe: 140,
      lavage_plafond: 120,
      lavage_boiserie: 80,
      
      // Pr√©paration int√©rieur (productivit√© en ft¬≤/h ou ft/h)
      grattage_leger: 100,
      grattage_moyen: 80,
      grattage_intensif: 50,
      sablage_boiserie: 30,
      calfeutrage_int: 60,
      
      // Prix endroits int√©rieurs ($/ft¬≤ ou $/ft ou $/qte)
      mur_salon: 0.65,
      mur_cuisine: 0.70,
      mur_chambre: 0.60,
      mur_salle_bain: 0.85,
      plafond_salon: 0.75,
      plafond_cuisine: 0.80,
      plafond_chambre: 0.70,
      boiserie_porte: 3.50,
      boiserie_fenetre: 3.00,
      boiserie_plinte: 2.50,
      armoire_cuisine: 2.20,
      escalier_bois: 85.00,
      rampe_escalier: 6.50,
      radiateur: 35.00,
      autre_int: 25.00,
      
      // Param√®tres int√©rieurs pour calculs sp√©cialis√©s
      // Pr√©paration int√©rieure (heures fixes selon justificatif)
      preparation_lavage: 0.35,
      preparation_grattage: 0.5,
      preparation_fry_dex: 1.0,
      preparation_sablage: 2.0,
      preparation_autres: 0.5,
      
      // Appr√™t int√©rieur (productivit√© ft¬≤/h)
      appret_mur_plus_200: 125,
      appret_mur_moins_200: 100,
      appret_plafond_plus_200: 125,
      appret_plafond_moins_200: 100,
      
      // Portes int√©rieures (heures par porte selon type)
      int_porte_facile: 0.5,
      int_porte_moyenne: 1/1.33,  // 1.33 portes/h ‚Üí 1√∑1.33 h/porte
      int_porte_difficile: 1.0,
      int_porte_francaise: 2.0,
      int_porte_cadres: 0.5,
      
      // Fen√™tres int√©rieures (heures par fen√™tre selon type)
      int_fenetre_facile: 0.5,
      int_fenetre_moyenne: 0.75,
      int_fenetre_difficile: 1.0,
      int_fenetre_cadres_faciles: 0.5,
      int_fenetre_cadres_difficiles: 1.0,
      
      // Divers int√©rieur (heures par item)
      int_garde_robe: 1.0,
      int_calorifere: 0.5,
      int_radiateur_1h: 1.0,
      int_radiateur_2h: 2.0,
      int_marche_escalier: 0.25,
      int_contre_marche: 0.25,
      int_interieur_armoire: 0.5,
      int_complication_05h: 0.5,
      int_complication_1h: 1.0,
      int_deplacement_05h: 0.5,
      int_deplacement_1h: 1.0,
      int_tuyau_chauffage: 0.25,
      int_cadrage: 0.25,
      
      // Plafond √† part (productivit√© ft¬≤/h selon type)
      int_angle_cathedrale: 150,
      int_stucco: 100,
      int_plus_10pi: 120,
      
      // Param√®tres g√©n√©raux
      taux_horaire: 43,

      // Param√®tres cl√¥tures (h/panneau)
      panneau_verticales_facile: 0.50,     // h/panneau
      panneau_verticales_moyenne: 1.25,    // h/panneau
      panneau_verticales_difficile: 2.00,  // h/panneau

      // Param√®tres g√©n√©raux int√©rieur
      taux_horaire_int: 43,
      heures_min_int: 4,
      frais_deplacement_int: 100
    };

    const PRODUCTS_DB = {
      diamant: {
        name: "Diamant Blanc",
        color: "Blanc",
        coverage: 350,
        price: 95,
        thirdCoat: false,
        primer: false
      },
      dulux_huile: {
        name: "Dulux huile ST C√®dre",
        color: "C√®dre", 
        coverage: 200,
        price: 80,
        thirdCoat: false,
        primer: false
      },
      dulux_hybride: {
        name: "Dulux Hybride OPQ blanc",
        color: "Blanc",
        coverage: 200,
        price: 80,
        thirdCoat: false,
        primer: false
      },
      dulux_email: {
        name: "Dulux √©mail √† planchers gris",
        color: "Gris",
        coverage: 350,
        price: 80,
        thirdCoat: false,
        primer: false
      },
      client: {
        name: "Produit client",
        color: "Variable",
        coverage: 300,
        price: 0,
        thirdCoat: false,
        primer: false
      }
    };

    // Variables globales pour les pi√®ces
    let pieceCounter = 0;
    let piecesInterieur = [];

    // Fonctions pour la gestion des pi√®ces int√©rieures
    function ajouterPiece() {
      const typePieceSelect = document.getElementById('typePiece');
      const typePiece = typePieceSelect.value;
      const typePieceText = typePieceSelect.options[typePieceSelect.selectedIndex].text;
      const nomPersonnalise = document.getElementById('nomPiecePersonnalise').value;
      const largeur = parseFloat(document.getElementById('largeurPiece').value) || 0;
      const profondeur = parseFloat(document.getElementById('profondeurPiece').value) || 0;
      const hauteur = parseFloat(document.getElementById('hauteurPiece').value) || 8;
      const inclureMoulures = document.getElementById('inclureMoulures').checked;

      if (!typePiece || largeur <= 0 || profondeur <= 0 || hauteur <= 0) {
        showNotification('Veuillez remplir tous les champs avec des valeurs valides', 'error');
        return;
      }

      pieceCounter++;
      const pieceId = `piece-${pieceCounter}`;
      const nomPiece = nomPersonnalise || typePieceText;

      // Calculs automatiques
      const surfacePlafond = largeur * profondeur;
      const perimetrePiece = 2 * (largeur + profondeur);
      const surfaceMurs = perimetrePiece * hauteur;
      const surfaceMoulures = inclureMoulures ? perimetrePiece : 0;

      const piece = {
        id: pieceId,
        nom: nomPiece,
        type: typePiece,
        largeur: largeur,
        profondeur: profondeur,
        hauteur: hauteur,
        inclureMoulures: inclureMoulures,
        surfacePlafond: surfacePlafond,
        surfaceMurs: surfaceMurs,
        surfaceMoulures: surfaceMoulures,
        perimetre: perimetrePiece
      };

      piecesInterieur.push(piece);
      afficherPiece(piece);
      resetFormulairePiece();
      // updateCalculation(); // Supprim√© - les calculs se feront quand on s√©lectionne les surfaces
      updateSurfaceTotaleInterieur(); // Mettre √† jour juste l'affichage du total (qui sera 0 au d√©but)
      updateAppretGlobalList(); // Mettre √† jour la liste des pi√®ces dans appr√™t global
      updatePreparationGlobalList(); // Mettre √† jour la liste des pi√®ces dans pr√©paration globale
      showNotification(`Pi√®ce "${nomPiece}" ajout√©e avec succ√®s! S√©lectionnez les surfaces √† peindre.`, 'success');

      // Scroll automatique vers la nouvelle pi√®ce (sauf pendant le chargement d'un projet)
      if (!isLoadingProject) {
        setTimeout(() => {
          const newPiece = document.getElementById(pieceId);
          if (newPiece) {
            newPiece.scrollIntoView({ behavior: 'smooth', block: 'end' });
          }
        }, 100);
      }
    }

    function afficherPiece(piece) {
      const listePieces = document.getElementById('listePieces');
      const pieceNumber = piecesInterieur.length;
      const pieceHtml = `
        <div id="${piece.id}" class="box">
          <div class="box-header">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <div class="box-header-icon" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);">
                <i class="fas fa-door-open"></i>
              </div>
              <h2 class="box-header-title">Pi√®ce ${pieceNumber}</h2>
            </div>
          </div>
          <div class="box-body">
            <div class="mb-4 flex justify-between items-center">
              <div class="font-semibold text-gray-300">${piece.nom}</div>
              <button class="btn-secondary text-xs px-2 py-1" onclick="supprimerPiece('${piece.id}')" title="Supprimer cette pi√®ce" style="display: flex !important; align-items: center !important; justify-content: center !important;">
                <i class="fas fa-trash" style="color: white !important; margin: 0 !important;"></i>
              </button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-${piece.inclureMoulures ? '4' : '3'} gap-4 text-sm">
              <div class="bg-slate-700/30 p-3 rounded-lg border border-gray-600">
                <div class="font-semibold text-white">Dimensions</div>
                <div id="dimensions_${piece.id}" class="text-white">${piece.largeur} √ó ${piece.profondeur} √ó ${piece.hauteur} ft</div>
              </div>
              <div class="bg-slate-700/30 p-3 rounded-lg border border-gray-600">
                <div class="font-semibold text-white">Plafond</div>
                <div id="surfacePlafondAffichage_${piece.id}" class="text-white">${piece.surfacePlafond.toFixed(1)} ft¬≤</div>
              </div>
              <div class="bg-slate-700/30 p-3 rounded-lg border border-gray-600">
                <div class="font-semibold text-white">Murs</div>
                <div id="surfaceMursAffichage_${piece.id}" class="text-white">${piece.surfaceMurs.toFixed(1)} ft¬≤</div>
              </div>
              ${piece.inclureMoulures ? `
              <div class="bg-slate-700/30 p-3 rounded-lg border border-gray-600">
                <div class="font-semibold text-white">Moulures</div>
                <div id="surfaceMouluresAffichage_${piece.id}" class="text-white">${piece.surfaceMoulures.toFixed(1)} ft</div>
              </div>
              ` : ''}
            </div>
            
            <!-- Section Peinture -->
            <div class="mt-4 pt-4 border-t border-gray-700/50">
              <div class="flex items-center justify-between mb-3">
                <h4 class="text-sm font-semibold text-white">Surfaces √† peindre</h4>
              </div>
              <!-- Surfaces des murs et plafond -->
              <div class="mb-4">
                <label class="block text-xs font-medium text-gray-300 mb-3">Surfaces √† peindre (ft¬≤)</label>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                  <div>
                    <label class="flex items-center text-xs text-white mb-1">
                      <input type="checkbox" id="mur1_${piece.id}" data-piece="${piece.id}" data-type="mur1" onchange="updatePiecePainting('${piece.id}')" class="custom-checkbox mr-1" checked>
                      Mur 1 (ft¬≤)
                    </label>
                    <input type="number" id="surfaceMur1_${piece.id}" class="input-field text-l" placeholder="${(piece.largeur * piece.hauteur).toFixed(0)}" 
                           value="${(piece.largeur * piece.hauteur).toFixed(0)}" step="1" min="0" onchange="updatePiecePainting('${piece.id}')">
                  </div>
                  <div>
                    <label class="flex items-center text-xs text-white mb-1">
                      <input type="checkbox" id="mur2_${piece.id}" data-piece="${piece.id}" data-type="mur2" onchange="updatePiecePainting('${piece.id}')" class="custom-checkbox mr-1" checked>
                      Mur 2 (ft¬≤)
                    </label>
                    <input type="number" id="surfaceMur2_${piece.id}" class="input-field text-l" placeholder="${(piece.profondeur * piece.hauteur).toFixed(0)}" 
                           value="${(piece.profondeur * piece.hauteur).toFixed(0)}" step="1" min="0" onchange="updatePiecePainting('${piece.id}')">
                  </div>
                  <div>
                    <label class="flex items-center text-xs text-white mb-1">
                      <input type="checkbox" id="mur3_${piece.id}" data-piece="${piece.id}" data-type="mur3" onchange="updatePiecePainting('${piece.id}')" class="custom-checkbox mr-1" checked>
                      Mur 3 (ft¬≤)
                    </label>
                    <input type="number" id="surfaceMur3_${piece.id}" class="input-field text-l" placeholder="${(piece.largeur * piece.hauteur).toFixed(0)}" 
                           value="${(piece.largeur * piece.hauteur).toFixed(0)}" step="1" min="0" onchange="updatePiecePainting('${piece.id}')">
                  </div>
                  <div>
                    <label class="flex items-center text-xs text-white mb-1">
                      <input type="checkbox" id="mur4_${piece.id}" data-piece="${piece.id}" data-type="mur4" onchange="updatePiecePainting('${piece.id}')" class="custom-checkbox mr-1" checked>
                      Mur 4 (ft¬≤)
                    </label>
                    <input type="number" id="surfaceMur4_${piece.id}" class="input-field text-l" placeholder="${(piece.profondeur * piece.hauteur).toFixed(0)}" 
                           value="${(piece.profondeur * piece.hauteur).toFixed(0)}" step="1" min="0" onchange="updatePiecePainting('${piece.id}')">
                  </div>
                  <div>
                    <label class="block text-xs text-white mb-1">Plafond</label>
                    <select class="select-field text-xs w-full" id="plafond_${piece.id}" data-piece="${piece.id}" data-type="plafond" onchange="updatePiecePainting('${piece.id}')">
                      <option value="non">Non</option>
                      <option value="oui">Oui</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- Affichage surface s√©lectionn√©e -->
              <div class="mt-3 p-4 rounded-lg border border-blue-500/30 bg-slate-700/20">
                <div class="flex items-center justify-between mb-3">
                  <div class="text-white font-bold flex items-center">
                    <i class="fas fa-paint-brush text-blue-400 mr-2"></i>
                    Surface √† peindre
                  </div>
                  <div id="surfaceSelectionnee_${piece.id}" class="surface-display text-2xl font-bold text-blue-400">0 ft¬≤</div>
                </div>
                <div class="text-xs text-gray-300 bg-slate-800/50 p-2 rounded border border-gray-600">
                  Murs: <span id="surfaceMursSelectionnee_${piece.id}" class="text-white font-semibold">0 ft¬≤</span> |
                  Plafond: <span id="surfacePlafondSelectionnee_${piece.id}" class="text-white font-semibold">0 ft¬≤</span>${piece.inclureMoulures ? ' | Moulures: <span id="surfaceMouluresSelectionnee_' + piece.id + '" class="text-white font-semibold">0 ft</span>' : ''}
                </div>

                <!-- Produit client toggle simple -->
                <div class="mt-3 flex items-center space-x-3">
                  <span class="text-xs text-white">Produit client</span>
                  <div class="flex">
                    <button type="button" id="product_client_non_${piece.id}" onclick="toggleProductClient('${piece.id}', false)"
                            class="toggle-button-active toggle-button-non">Non</button>
                    <button type="button" id="product_client_oui_${piece.id}" onclick="toggleProductClient('${piece.id}', true)"
                            class="toggle-button-inactive toggle-button-oui">Oui</button>
                  </div>
                  <input type="checkbox" id="product_client_${piece.id}" class="hidden" onchange="updateCalculation();">
                </div>
              </div>
            </div>

          </div>
        </div>
      `;
      
      listePieces.insertAdjacentHTML('beforeend', pieceHtml);
      
      // Pr√©s√©lectionner les produits par d√©faut en d√©clenchant updatePiecePainting apr√®s insertion
      setTimeout(() => {
        updatePiecePainting(piece.id);
      }, 100);
      
      
      
      // Ajouter l'event listener pour les dropdowns de cette pi√®ce
      const currentPieceId = piece.id;
      setTimeout(() => {
        // Removed duplicate listener - handled by custom dropdown
      }, 100);
      
      // Convertir les nouveaux dropdowns en custom dropdowns
      setTimeout(() => {
        convertToCustomDropdowns();
        initCustomSelects();
        
        // Ajouter les event listeners apr√®s la conversion custom
        setTimeout(() => {
          // Event listener pour la dur√©e de pr√©paration
          const preparationSelect = document.querySelector('select[data-piece="' + currentPieceId + '"][data-type="preparation"]');
          if (preparationSelect && !preparationSelect.hasAttribute('custom-listener')) {
            preparationSelect.setAttribute('custom-listener', 'true');
            
            const customDropdown = preparationSelect.parentElement.querySelector('.custom-select');
            if (customDropdown) {
              const options = customDropdown.querySelectorAll('.custom-select-option');
              options.forEach(option => {
                option.addEventListener('click', function() {
                  const value = this.getAttribute('data-value');
                  const text = this.textContent.trim();
                  preparationSelect.value = value;
                  preparationSelect.dispatchEvent(new Event('change'));
                });
              });
            }
          }
          
          // Event listener pour le justificatif de pr√©paration
          const justificatifSelect = document.querySelector('select[data-piece="' + currentPieceId + '"][data-type="justificatif"]');
          if (justificatifSelect && !justificatifSelect.hasAttribute('custom-listener')) {
            justificatifSelect.setAttribute('custom-listener', 'true');
            
            const customDropdown = justificatifSelect.parentElement.querySelector('.custom-select');
            if (customDropdown) {
              const options = customDropdown.querySelectorAll('.custom-select-option');
              options.forEach(option => {
                option.addEventListener('click', function() {
                  const value = this.getAttribute('data-value');
                  const text = this.textContent.trim();
                  if (value) {
                  }
                  justificatifSelect.value = value;
                  justificatifSelect.dispatchEvent(new Event('change'));
                });
              });
            }
          }
          
          // Event listener pour le type d'appr√™t
          const appretSelect = document.querySelector('select[data-piece="' + currentPieceId + '"][data-type="appret"]');
          if (appretSelect && !appretSelect.hasAttribute('custom-listener')) {
            appretSelect.setAttribute('custom-listener', 'true');
            
            const customDropdown = appretSelect.parentElement.querySelector('.custom-select');
            if (customDropdown) {
              const options = customDropdown.querySelectorAll('.custom-select-option');
              options.forEach(option => {
                option.addEventListener('click', function() {
                  const value = this.getAttribute('data-value');
                  const text = this.textContent.trim();
                  if (value) {
                  }
                  appretSelect.value = value;
                  appretSelect.dispatchEvent(new Event('change'));
                });
              });
            }
          }
          
          // Event listener pour la peinture client appr√™t
          const peintureClientSelect = document.querySelector('select[data-piece="' + currentPieceId + '"][data-type="peinture-client"]');
          if (peintureClientSelect && !peintureClientSelect.hasAttribute('custom-listener')) {
            peintureClientSelect.setAttribute('custom-listener', 'true');
            
            const customDropdown = peintureClientSelect.parentElement.querySelector('.custom-select');
            if (customDropdown) {
              const options = customDropdown.querySelectorAll('.custom-select-option');
              options.forEach(option => {
                option.addEventListener('click', function() {
                  const value = this.getAttribute('data-value');
                  const text = this.textContent.trim();
                  if (value) {
                  }
                  peintureClientSelect.value = value;
                  peintureClientSelect.dispatchEvent(new Event('change'));
                });
              });
            }
          }
          
        }, 200);
      }, 150);
    }

    function updatePiecePainting(pieceId) {
      // Trouver la pi√®ce correspondante
      const piece = piecesInterieur.find(p => p.id === pieceId);
      if (!piece) return;

      // R√©cup√©rer les s√©lections des murs individuels
      const mur1Checked = document.getElementById(`mur1_${pieceId}`)?.checked || false;
      const mur2Checked = document.getElementById(`mur2_${pieceId}`)?.checked || false;
      const mur3Checked = document.getElementById(`mur3_${pieceId}`)?.checked || false;
      const mur4Checked = document.getElementById(`mur4_${pieceId}`)?.checked || false;

      // R√©cup√©rer les surfaces de chaque mur
      const surfaceMur1 = mur1Checked ? (parseFloat(document.getElementById(`surfaceMur1_${pieceId}`)?.value) || 0) : 0;
      const surfaceMur2 = mur2Checked ? (parseFloat(document.getElementById(`surfaceMur2_${pieceId}`)?.value) || 0) : 0;
      const surfaceMur3 = mur3Checked ? (parseFloat(document.getElementById(`surfaceMur3_${pieceId}`)?.value) || 0) : 0;
      const surfaceMur4 = mur4Checked ? (parseFloat(document.getElementById(`surfaceMur4_${pieceId}`)?.value) || 0) : 0;

      // Total des murs s√©lectionn√©s
      const surfaceMursSelectionnee = surfaceMur1 + surfaceMur2 + surfaceMur3 + surfaceMur4;

      // Plafond
      const plafondValue = document.getElementById(`plafond_${pieceId}`)?.value || 'non';
      const plafondChecked = plafondValue === 'oui';
      const surfacePlafondSelectionnee = plafondChecked ? piece.surfacePlafond : 0;

      // Mettre √† jour la liste d'appr√™t si cette pi√®ce est s√©lectionn√©e dans l'appr√™t
      updateAppretGlobalList();
      
      // Auto-s√©lection Lifemaster si des murs sont s√©lectionn√©s (sauf si produit client s√©lectionn√©)
      const lifemasterCheckbox = document.getElementById(`product_lifemaster_${pieceId}`);
      const clientCheckbox = document.getElementById(`product_client_${pieceId}`);
      const hasMursSelected = mur1Checked || mur2Checked || mur3Checked || mur4Checked;
      const isClientSelected = clientCheckbox && clientCheckbox.checked;
      
      if (!isClientSelected) {
        if (hasMursSelected && (!lifemasterCheckbox || !lifemasterCheckbox.checked)) {
          // Activer Lifemaster automatiquement - simuler clic sur la card
          const lifemasterCard = document.querySelector(`#produitsInt_${pieceId} .product-card[onclick*="lifemaster"]`);
          if (lifemasterCard && !lifemasterCard.classList.contains('selected')) {
            lifemasterCard.click();
          }
        } else if (!hasMursSelected && lifemasterCheckbox && lifemasterCheckbox.checked) {
          // D√©sactiver Lifemaster si aucun mur s√©lectionn√©
          const lifemasterCard = document.querySelector(`#produitsInt_${pieceId} .product-card[onclick*="lifemaster"]`);
          if (lifemasterCard && lifemasterCard.classList.contains('selected')) {
            lifemasterCard.click();
          }
        }
      }
      
      // Auto-s√©lection Glidden 7700 si plafond = "Oui" (sauf si produit client s√©lectionn√©)
      const gliddenCheckbox = document.getElementById(`product_glidden_${pieceId}`);
      if (!isClientSelected) {
        if (plafondChecked && (!gliddenCheckbox || !gliddenCheckbox.checked)) {
          // Activer Glidden 7700 automatiquement
          const gliddenCard = document.querySelector(`#produitsInt_${pieceId} .product-card[onclick*="glidden"]`);
          if (gliddenCard && !gliddenCard.classList.contains('selected')) {
            gliddenCard.click();
          }
        } else if (!plafondChecked && gliddenCheckbox && gliddenCheckbox.checked) {
          // D√©sactiver Glidden 7700 si plafond = "Non"
          const gliddenCard = document.querySelector(`#produitsInt_${pieceId} .product-card[onclick*="glidden"]`);
          if (gliddenCard && gliddenCard.classList.contains('selected')) {
            gliddenCard.click();
          }
        }
      }
      
      // Auto-s√©lection Primer si des surfaces sont s√©lectionn√©es (sauf si produit client s√©lectionn√©)
      const primerCheckbox = document.getElementById(`product_primer_${pieceId}`);
      const hasSurfacesSelected = hasMursSelected || plafondChecked;
      if (!isClientSelected) {
        if (hasSurfacesSelected && (!primerCheckbox || !primerCheckbox.checked)) {
          // Activer Primer automatiquement
          const primerCard = document.querySelector(`#produitsInt_${pieceId} .product-card[onclick*="primer"]`);
          if (primerCard && !primerCard.classList.contains('selected')) {
            primerCard.click();
          }
        } else if (!hasSurfacesSelected && primerCheckbox && primerCheckbox.checked) {
          // D√©sactiver Primer si aucune surface s√©lectionn√©e
          const primerCard = document.querySelector(`#produitsInt_${pieceId} .product-card[onclick*="primer"]`);
          if (primerCard && primerCard.classList.contains('selected')) {
            primerCard.click();
          }
        }
      }
      
      // Moulures - Calculer automatiquement selon les murs s√©lectionn√©s (si activ√©es √† la cr√©ation)
      let surfaceMouluresSelectionnee = 0;
      
      if (piece.inclureMoulures) {
        // Calculer moulures uniquement pour les murs s√©lectionn√©s
        if (mur1Checked) surfaceMouluresSelectionnee += piece.largeur; // Mur 1: largeur
        if (mur2Checked) surfaceMouluresSelectionnee += piece.profondeur; // Mur 2: profondeur  
        if (mur3Checked) surfaceMouluresSelectionnee += piece.largeur; // Mur 3: largeur
        if (mur4Checked) surfaceMouluresSelectionnee += piece.profondeur; // Mur 4: profondeur
      }
      
      // Total de la pi√®ce (murs + plafond en ft¬≤, moulures en ft)
      const surfaceTotaleSelectionnee = surfaceMursSelectionnee + surfacePlafondSelectionnee;
      
      // Mettre √† jour l'affichage de la pi√®ce
      const surfaceSelectionneeEl = document.getElementById(`surfaceSelectionnee_${pieceId}`);
      const surfaceMursEl = document.getElementById(`surfaceMursSelectionnee_${pieceId}`);
      const surfacePlafondEl = document.getElementById(`surfacePlafondSelectionnee_${pieceId}`);
      const surfaceMouluresEl = document.getElementById(`surfaceMouluresSelectionnee_${pieceId}`);
      
      if (surfaceSelectionneeEl) {
        surfaceSelectionneeEl.textContent = surfaceTotaleSelectionnee.toFixed(1) + ' ft¬≤';
      }
      if (surfaceMursEl) {
        surfaceMursEl.textContent = surfaceMursSelectionnee.toFixed(1) + ' ft¬≤';
      }
      if (surfacePlafondEl) {
        surfacePlafondEl.textContent = surfacePlafondSelectionnee.toFixed(1) + ' ft¬≤';
      }
      if (surfaceMouluresEl && piece.inclureMoulures) {
        surfaceMouluresEl.textContent = surfaceMouluresSelectionnee.toFixed(1) + ' ft';
      }
      
      // Mettre √† jour les dimensions affich√©es en haut
      const surfaceMursTotal = (parseFloat(document.getElementById(`surfaceMur1_${pieceId}`)?.value) || 0) +
                              (parseFloat(document.getElementById(`surfaceMur2_${pieceId}`)?.value) || 0) +
                              (parseFloat(document.getElementById(`surfaceMur3_${pieceId}`)?.value) || 0) +
                              (parseFloat(document.getElementById(`surfaceMur4_${pieceId}`)?.value) || 0);
                              
      // L'affichage des moulures en haut reste toujours le total de la pi√®ce (pas dynamique)
      if (piece.inclureMoulures) {
        const surfaceMouluresAffichage = document.getElementById(`surfaceMouluresAffichage_${pieceId}`);
        if (surfaceMouluresAffichage) {
          // Toujours afficher le total de la pi√®ce, pas le dynamique
          surfaceMouluresAffichage.textContent = piece.surfaceMoulures.toFixed(1) + ' ft';
        }
      }
      
      const surfaceMursAffichageEl = document.getElementById(`surfaceMursAffichage_${pieceId}`);
      if (surfaceMursAffichageEl) {
        surfaceMursAffichageEl.textContent = surfaceMursTotal.toFixed(1) + ' ft¬≤';
      }
      
      // Recalculer le total de toutes les pi√®ces
      updateSurfaceTotaleInterieur();
      
      // D√©clencher le calcul des produits pour mettre √† jour les gallons
      updatePieceProductCalculation(pieceId);
      
      // D√©clencher la mise √† jour des calculs
      updateCalculation();
      
      // Mettre √† jour dynamiquement les surfaces d'appr√™t existantes
      updateAppretSurfacesDynamically(pieceId, surfaceTotaleSelectionnee);
      
      const selectedWalls = [
        mur1Checked ? `Mur1:${surfaceMur1}ft¬≤` : '',
        mur2Checked ? `Mur2:${surfaceMur2}ft¬≤` : '',
        mur3Checked ? `Mur3:${surfaceMur3}ft¬≤` : '',
        mur4Checked ? `Mur4:${surfaceMur4}ft¬≤` : ''
      ].filter(w => w).join(', ');
      
    }
    
    function updateSurfaceTotaleInterieur() {
      let surfaceTotaleGlobale = 0;
      
      // Parcourir toutes les pi√®ces et additionner les surfaces s√©lectionn√©es
      piecesInterieur.forEach(piece => {
        const pieceId = piece.id;
        
        // R√©cup√©rer les murs individuels
        const mur1Checked = document.getElementById(`mur1_${pieceId}`)?.checked || false;
        const mur2Checked = document.getElementById(`mur2_${pieceId}`)?.checked || false;
        const mur3Checked = document.getElementById(`mur3_${pieceId}`)?.checked || false;
        const mur4Checked = document.getElementById(`mur4_${pieceId}`)?.checked || false;
        
        const surfaceMur1 = mur1Checked ? (parseFloat(document.getElementById(`surfaceMur1_${pieceId}`)?.value) || 0) : 0;
        const surfaceMur2 = mur2Checked ? (parseFloat(document.getElementById(`surfaceMur2_${pieceId}`)?.value) || 0) : 0;
        const surfaceMur3 = mur3Checked ? (parseFloat(document.getElementById(`surfaceMur3_${pieceId}`)?.value) || 0) : 0;
        const surfaceMur4 = mur4Checked ? (parseFloat(document.getElementById(`surfaceMur4_${pieceId}`)?.value) || 0) : 0;
        
        const surfaceMursSelectionnee = surfaceMur1 + surfaceMur2 + surfaceMur3 + surfaceMur4;
        
        // Plafond
        const plafondValue = document.getElementById(`plafond_${pieceId}`)?.value || 'non';
        const plafondChecked = plafondValue === 'oui';
        const surfacePlafondSelectionnee = plafondChecked ? piece.surfacePlafond : 0;
        
        surfaceTotaleGlobale += surfaceMursSelectionnee + surfacePlafondSelectionnee;
      });
      
      // Mettre √† jour l'affichage global
      if (document.getElementById('surfaceTotaleInt')) {
        document.getElementById('surfaceTotaleInt').textContent = surfaceTotaleGlobale.toFixed(0) + ' ft¬≤';
      }
      
    }

    function supprimerPiece(pieceId) {
      piecesInterieur = piecesInterieur.filter(p => p.id !== pieceId);
      document.getElementById(pieceId).remove();
      updateSurfaceTotaleInterieur(); // Recalculer le total sans cette pi√®ce
      updateAppretGlobalList(); // Mettre √† jour la liste des pi√®ces dans appr√™t global
      updatePreparationGlobalList(); // Mettre √† jour la liste des pi√®ces dans pr√©paration globale
      updateCalculation(); // Mettre √† jour les calculs de co√ªts
      showNotification('Pi√®ce supprim√©e', 'info');
    }


    function toggleAppretSection(pieceId) {
      const checkbox = document.getElementById(`toggleAppret_${pieceId}`);
      const section = document.getElementById(`appretSection_${pieceId}`);
      if (checkbox && section) {
        section.style.display = checkbox.checked ? 'block' : 'none';
        
        // Auto-s√©lection primer si appr√™t activ√© (sauf si produit client s√©lectionn√©)
        const primerCheckbox = document.getElementById(`product_primer_${pieceId}`);
        const clientCheckbox = document.getElementById(`product_client_${pieceId}`);
        const isClientSelected = clientCheckbox && clientCheckbox.checked;
        
        if (primerCheckbox && !isClientSelected) {
          primerCheckbox.checked = checkbox.checked;
          // Appliquer le style visuel
          applyProductSelectionStyle(primerCheckbox, checkbox.checked);
          updatePieceProductCalculation(pieceId);
        }
      }
      updateCalculation(); // Trigger recalculation
    }

    function togglePorteSection(pieceId) {
      const checkbox = document.getElementById(`togglePorte_${pieceId}`);
      const section = document.getElementById(`porteSection_${pieceId}`);
      if (checkbox && section) {
        section.style.display = checkbox.checked ? 'block' : 'none';
      }
      updateCalculation(); // Trigger recalculation
    }

    function toggleFenetreSection(pieceId) {
      const checkbox = document.getElementById(`toggleFenetre_${pieceId}`);
      const section = document.getElementById(`fenetreSection_${pieceId}`);
      if (checkbox && section) {
        section.style.display = checkbox.checked ? 'block' : 'none';
      }
      updateCalculation(); // Trigger recalculation
    }

    function toggleDiversSection(pieceId) {
      const checkbox = document.getElementById(`toggleDivers_${pieceId}`);
      const section = document.getElementById(`diversSection_${pieceId}`);
      if (checkbox && section) {
        section.style.display = checkbox.checked ? 'block' : 'none';
      }
      updateCalculation(); // Trigger recalculation
    }

    function togglePlafondSection(pieceId) {
      const checkbox = document.getElementById(`togglePlafond_${pieceId}`);
      const section = document.getElementById(`plafondSection_${pieceId}`);
      if (checkbox && section) {
        section.style.display = checkbox.checked ? 'block' : 'none';
      }
      updateCalculation(); // Trigger recalculation
    }

    function handlePreparationChange(selectElement, pieceId) {
      updateCalculation();
    }
    
    function togglePreparationSection(pieceId) {
      const checkbox = document.getElementById(`togglePreparation_${pieceId}`);
      const section = document.getElementById(`preparationSection_${pieceId}`);
      if (checkbox && section) {
        section.style.display = checkbox.checked ? 'block' : 'none';
        
      }
      updateCalculation(); // Trigger recalculation
    }

    // Fonctions pour les sections globales
    function togglePorteGlobalSection() {
      const checkbox = document.getElementById('togglePorteGlobal');
      const section = document.getElementById('porteGlobalSection');
      if (checkbox && section) {
        section.style.display = checkbox.checked ? 'block' : 'none';
                updateCalculation();
      }
    }

    function toggleFenetreGlobalSection() {
      const checkbox = document.getElementById('toggleFenetreGlobal');
      const section = document.getElementById('fenetreGlobalSection');
      if (checkbox && section) {
        section.style.display = checkbox.checked ? 'block' : 'none';
        updateCalculation();
      }
    }

    function toggleDiversGlobalSection() {
      const checkbox = document.getElementById('toggleDiversGlobal');
      const section = document.getElementById('diversGlobalSection');
      if (checkbox && section) {
        section.style.display = checkbox.checked ? 'block' : 'none';
        updateCalculation();
      }
    }

    function togglePlafondGlobalSection() {
      const checkbox = document.getElementById('togglePlafondGlobal');
      const section = document.getElementById('plafondGlobalSection');
      if (checkbox && section) {
        section.style.display = checkbox.checked ? 'block' : 'none';
        updateCalculation();
      }
    }

    function toggleAppretGlobalSection() {
      const checkbox = document.getElementById('toggleAppretGlobal');
      const section = document.getElementById('appretGlobalSection');
      if (checkbox && section) {
        section.style.display = checkbox.checked ? 'block' : 'none';
        updateAppretGlobalList();
        updateCalculation();
      }
    }

    // Variables globales pour les compteurs d'items
    let porteGlobaleCounter = 0;
    let fenetreGlobaleCounter = 0;
    let diversGlobalCounter = 0;
    let plafondGlobalCounter = 0;

    // FONCTION POUR G√âN√âRER LA LISTE DES PI√àCES
    function getPiecesOptions() {
      if (typeof piecesInterieur === 'undefined' || piecesInterieur.length === 0) {
        return '<option value="">Aucune pi√®ce n\'a √©t√© cr√©√©e</option>';
      }

      let options = '<option value="">S√©lectionner une pi√®ce...</option>';
      piecesInterieur.forEach(piece => {
        options += `<option value="${piece.id}">${piece.nom}</option>`;
      });
      return options;
    }

    // FONCTIONS POUR TRAVAUX ADDITIONNELS MULTIPLES
    function ajouterPorteGlobale() {
      porteGlobaleCounter++;
      const listContainer = document.getElementById('listPortesGlobales');

      // R√©cup√©rer les pi√®ces cr√©√©es
      const piecesOptions = getPiecesOptions();

      const porteHtml = `
        <div id="porteGlobale_${porteGlobaleCounter}" class="p-3 bg-gray-800/50 rounded border border-gray-600">
          <div class="flex justify-between items-center mb-2">
            <h5 class="font-medium text-white">Porte #${porteGlobaleCounter}</h5>
            <button type="button" onclick="supprimerPorteGlobale(${porteGlobaleCounter})" class="btn-secondary text-xs px-2 py-1" title="Supprimer cette porte">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-xs font-medium text-gray-300 mb-1">Pi√®ce</label>
              <select class="select-field text-sm" id="piecePorteGlobal_${porteGlobaleCounter}" onchange="calculerPortesGlobales()">
                ${piecesOptions}
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-300 mb-1">Type de porte</label>
              <select class="select-field text-sm" id="typePorteGlobal_${porteGlobaleCounter}" onchange="calculerPortesGlobales()">
                <option value="">S√©lectionner...</option>
                <option value="facile">Porte facile (2 portes/h)</option>
                <option value="moyenne">Porte moyenne (1.33 portes/h)</option>
                <option value="difficile">Porte difficile (1 porte/h)</option>
                <option value="francaise">Porte fran√ßaise (0.5 porte/h)</option>
                <option value="cadre">Cadre de porte (2 cadres/h)</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-300 mb-1">Nombre</label>
              <input type="number" class="input-field text-sm" id="nombrePorteGlobal_${porteGlobaleCounter}" min="1" step="1" value="1" onchange="calculerPortesGlobales()">
            </div>
          </div>
          <input type="hidden" id="heuresPorteGlobal_${porteGlobaleCounter}" value="0">
        </div>
      `;

      listContainer.insertAdjacentHTML('beforeend', porteHtml);

      // Convertir les nouveaux select en dropdowns personnalis√©s
      convertToCustomDropdowns();

      calculerPortesGlobales();
    }

    function supprimerPorteGlobale(id) {
      const element = document.getElementById(`porteGlobale_${id}`);
      if (element) {
        element.remove();
        calculerPortesGlobales();
      }
    }

    function calculerPortesGlobales() {
      let totalHeures = 0;
      const containers = document.querySelectorAll('[id^="porteGlobale_"]');

      containers.forEach(container => {
        const id = container.id.split('_')[1];
        const type = document.getElementById(`typePorteGlobal_${id}`)?.value;
        const nombre = parseInt(document.getElementById(`nombrePorteGlobal_${id}`)?.value) || 0;

        let heuresParItem = 0;
        switch(type) {
          case 'facile': heuresParItem = 1/2; break; // 2 portes/h
          case 'moyenne': heuresParItem = 1/1.33; break; // 1.33 portes/h ‚Üí 1√∑1.33 h/porte
          case 'difficile': heuresParItem = 1; break; // 1 porte/h
          case 'francaise': heuresParItem = 2; break; // 0.5 porte/h
          case 'cadre': heuresParItem = 1/2; break; // 2 cadres/h
          case 'cadre_facile': heuresParItem = 1/2; break;
          case 'cadre_difficile': heuresParItem = 1; break;
        }

        const heuresItem = nombre * heuresParItem;
        totalHeures += heuresItem;

        const heuresField = document.getElementById(`heuresPorteGlobal_${id}`);
        if (heuresField) {
          heuresField.value = heuresItem.toFixed(2);
        }
      });

      updateCalculation();
    }

    function getTotalHeuresPortesInterieures() {
      let totalHeures = 0;

      // V√©rifier si la section portes est activ√©e
      const porteSection = document.getElementById('porteGlobalSection');
      const porteCheckbox = document.getElementById('togglePorteGlobal');
      if (!porteCheckbox?.checked || porteSection?.style.display === 'none') {
        return 0; // Section d√©sactiv√©e
      }

      const containers = document.querySelectorAll('[id^="porteGlobale_"]');

      containers.forEach(container => {
        const id = container.id.split('_')[1];
        const type = document.getElementById(`typePorteGlobal_${id}`)?.value;
        const nombre = parseInt(document.getElementById(`nombrePorteGlobal_${id}`)?.value) || 0;

        let heuresParItem = 0;
        switch(type) {
          case 'facile': heuresParItem = 1/2; break;
          case 'moyenne': heuresParItem = 1/1.33; break;  // 1.33 portes/h ‚Üí 1√∑1.33 h/porte
          case 'difficile': heuresParItem = 1; break;
          case 'francaise': heuresParItem = 2; break;
          case 'cadre': heuresParItem = 1/2; break;
          case 'cadre_facile': heuresParItem = 1/2; break;
          case 'cadre_difficile': heuresParItem = 1; break;
        }

        totalHeures += nombre * heuresParItem;
      });

      return totalHeures;
    }

    function getTotalHeuresFenetresInterieures() {
      let totalHeures = 0;

      // V√©rifier si la section fen√™tres est activ√©e
      const fenetreSection = document.getElementById('fenetreGlobalSection');
      const fenetreCheckbox = document.getElementById('toggleFenetreGlobal');
      if (!fenetreCheckbox?.checked || fenetreSection?.style.display === 'none') {
        return 0; // Section d√©sactiv√©e
      }

      const containers = document.querySelectorAll('[id^="fenetreGlobale_"]');

      containers.forEach(container => {
        const id = container.id.split('_')[1];
        const type = document.getElementById(`typeFenetreGlobal_${id}`)?.value;
        const nombre = parseInt(document.getElementById(`nombreFenetreGlobal_${id}`)?.value) || 0;

        let heuresParItem = 0;
        switch(type) {
          case 'facile': heuresParItem = 1/2; break;
          case 'moyenne': heuresParItem = 3/4; break;
          case 'difficile': heuresParItem = 1; break;
          case 'francaise': heuresParItem = 2; break;
          case 'cadre': heuresParItem = 1/2; break;
          case 'cadre_facile': heuresParItem = 1/2; break;
          case 'cadre_difficile': heuresParItem = 1; break;
        }

        totalHeures += nombre * heuresParItem;
      });

      return totalHeures;
    }

    function getTotalHeuresDiversInterieures() {
      let totalHeures = 0;

      // V√©rifier si la section divers est activ√©e
      const diversSection = document.getElementById('diversGlobalSection');
      const diversCheckbox = document.getElementById('toggleDiversGlobal');
      if (!diversCheckbox?.checked || diversSection?.style.display === 'none') {
        return 0; // Section d√©sactiv√©e
      }

      const containers = document.querySelectorAll('[id^="diversGlobal_"]');

      containers.forEach(container => {
        const id = container.id.split('_')[1];
        const type = document.getElementById(`typeDiversGlobal_${id}`)?.value;
        const quantite = parseInt(document.getElementById(`quantiteDiversGlobal_${id}`)?.value) || 0;

        let heuresParItem = 0;
        switch(type) {
          case 'garde_robe': heuresParItem = 0.5; break;
          case 'calorifere': heuresParItem = 0.25; break;
          case 'radiateur_1h': heuresParItem = 1; break;
          case 'radiateur_2h': heuresParItem = 2; break;
          case 'marche_escalier': heuresParItem = 0.1; break;
          case 'contre_marche': heuresParItem = 0.1; break;
          case 'interieur_armoire': heuresParItem = 0.5; break;
          case 'complication_05h': heuresParItem = 0.5; break;
          case 'complication_1h': heuresParItem = 1; break;
          case 'deplacement_05h': heuresParItem = 0.5; break;
          case 'deplacement_1h': heuresParItem = 1; break;
          case 'installation_05h': heuresParItem = 0.5; break;
          case 'installation_1h': heuresParItem = 1; break;
        }

        totalHeures += quantite * heuresParItem;
      });

      return totalHeures;
    }

    function getTotalHeuresPlafonds() {
      let totalHeures = 0;

      // V√©rifier si la section plafonds est activ√©e
      const plafondSection = document.getElementById('plafondGlobalSection');
      const plafondCheckbox = document.getElementById('togglePlafondGlobal');
      if (!plafondCheckbox?.checked || plafondSection?.style.display === 'none') {
        return 0; // Section d√©sactiv√©e
      }

      const containers = document.querySelectorAll('[id^="plafondGlobal_"]');
      const params = getCurrentParameterValues();

      containers.forEach(container => {
        const id = container.id.split('_')[1];
        const type = document.getElementById(`typePlafondGlobal_${id}`)?.value;
        const surface = parseFloat(document.getElementById(`surfacePlafondGlobal_${id}`)?.value) || 0;

        let heuresItem = 0;
        if (surface > 0 && type && type !== '') {
          let productivity = 400; // Valeur par d√©faut

          switch(type) {
            case 'angle_cathedrale':
              productivity = params.int_angle_cathedrale || 150;
              break;
            case 'stucco':
              productivity = params.int_stucco || 100;
              break;
            case 'plus_10pi':
              productivity = params.int_plus_10pi || 120;
              break;
          }

          heuresItem = surface / productivity;
        }

        totalHeures += heuresItem;
      });

      return totalHeures;
    }

    // ========== CALCUL GALLONS TRAVAUX ADDITIONNELS ==========
    function getTotalGallonsPortesInterieures() {
      let totalQuantite = 0;
      const porteCheckbox = document.getElementById('togglePorteGlobal');
      if (!porteCheckbox?.checked) return 0;

      const containers = document.querySelectorAll('[id^="porteGlobale_"]');
      containers.forEach(container => {
        const id = container.id.split('_')[1];
        const nombre = parseInt(document.getElementById(`nombrePorteGlobal_${id}`)?.value) || 0;
        totalQuantite += nombre;
      });

      const ratioGallons = 15; // 15 portes = 1 gallon
      return totalQuantite / ratioGallons;
    }

    function getTotalGallonsMouluresPortes() {
      let totalQuantite = 0;
      const porteCheckbox = document.getElementById('togglePorteGlobal');
      if (!porteCheckbox?.checked) return 0;

      const containers = document.querySelectorAll('[id^="porteGlobale_"]');
      containers.forEach(container => {
        const id = container.id.split('_')[1];
        const type = document.getElementById(`typePorteGlobal_${id}`)?.value;
        const nombre = parseInt(document.getElementById(`nombrePorteGlobal_${id}`)?.value) || 0;

        // Seulement les portes fran√ßaises et cadres ont des moulures
        if (type === 'francaise' || type === 'cadre') {
          totalQuantite += nombre;
        }
      });

      const ratioGallons = 25; // 25 moulures de portes = 1 gallon
      return totalQuantite / ratioGallons;
    }

    function getTotalGallonsFenetresInterieures() {
      let totalQuantite = 0;
      const fenetreCheckbox = document.getElementById('toggleFenetreGlobal');
      if (!fenetreCheckbox?.checked) return 0;

      const containers = document.querySelectorAll('[id^="fenetreGlobale_"]');
      containers.forEach(container => {
        const id = container.id.split('_')[1];
        const type = document.getElementById(`typeFenetreGlobal_${id}`)?.value;
        const nombre = parseInt(document.getElementById(`nombreFenetreGlobal_${id}`)?.value) || 0;
        // Pour les cadres, compter 2x la quantit√© (fen√™tre + cadre)
        if (type === 'cadre_facile' || type === 'cadre_difficile' || type === 'cadre') {
          totalQuantite += nombre * 2;
        } else {
          totalQuantite += nombre;
        }
      });

      const ratioGallons = 25; // 25 fen√™tres = 1 gallon
      return totalQuantite / ratioGallons;
    }

    function getTotalGallonsDiversInterieurs() {
      let totalGallons = 0;
      const diversCheckbox = document.getElementById('toggleDiversGlobal');
      if (!diversCheckbox?.checked) return 0;

      const containers = document.querySelectorAll('[id^="diversGlobal_"]');
      containers.forEach(container => {
        const id = container.id.split('_')[1];
        const type = document.getElementById(`typeDiversGlobal_${id}`)?.value;
        const nombre = parseInt(document.getElementById(`nombreDiversGlobal_${id}`)?.value) || 0;

        let ratioGallons = 1;
        switch(type) {
          case 'marche': ratioGallons = 75; break; // Marches/Contre-marches
          case 'garde_robe': ratioGallons = 64; break; // Gardes-robes
          case 'radiateur': ratioGallons = 15; break; // Radiateur
          case 'calorifere': ratioGallons = 25; break; // Calorif√®re
          default: ratioGallons = 50; break;
        }

        totalGallons += nombre / ratioGallons;
      });

      return totalGallons;
    }

    function ajouterFenetreGlobale() {
      fenetreGlobaleCounter++;
      const listContainer = document.getElementById('listFenetresGlobales');

      // R√©cup√©rer les pi√®ces cr√©√©es
      const piecesOptions = getPiecesOptions();

      const fenetreHtml = `
        <div id="fenetreGlobale_${fenetreGlobaleCounter}" class="p-3 bg-gray-800/50 rounded border border-gray-600">
          <div class="flex justify-between items-center mb-2">
            <h5 class="font-medium text-white">Fen√™tre #${fenetreGlobaleCounter}</h5>
            <button type="button" onclick="supprimerFenetreGlobale(${fenetreGlobaleCounter})" class="btn-secondary text-xs px-2 py-1" title="Supprimer cette fen√™tre">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-xs font-medium text-gray-300 mb-1">Pi√®ce</label>
              <select class="select-field text-sm" id="pieceFenetreGlobal_${fenetreGlobaleCounter}" onchange="calculerFenetresGlobales()">
                ${piecesOptions}
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-300 mb-1">Type de fen√™tre</label>
              <select class="select-field text-sm" id="typeFenetreGlobal_${fenetreGlobaleCounter}" onchange="calculerFenetresGlobales()">
                <option value="">S√©lectionner...</option>
                <option value="facile">Fen√™tre facile (2 fen√™tres/h)</option>
                <option value="moyenne">Fen√™tre moyenne (1.33 fen√™tres/h)</option>
                <option value="difficile">Fen√™tre difficile (1 fen√™tre/h)</option>
                <option value="cadre_facile">Cadre facile (2 cadres/h)</option>
                <option value="cadre_difficile">Cadre difficile (1 cadre/h)</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-300 mb-1">Nombre</label>
              <input type="number" class="input-field text-sm" id="nombreFenetreGlobal_${fenetreGlobaleCounter}" min="1" step="1" value="1" onchange="calculerFenetresGlobales()">
            </div>
          </div>
          <input type="hidden" id="heuresFenetreGlobal_${fenetreGlobaleCounter}" value="0">
        </div>
      `;

      listContainer.insertAdjacentHTML('beforeend', fenetreHtml);

      // Convertir les nouveaux select en dropdowns personnalis√©s
      convertToCustomDropdowns();

      calculerFenetresGlobales();
    }

    function supprimerFenetreGlobale(id) {
      const element = document.getElementById(`fenetreGlobale_${id}`);
      if (element) {
        element.remove();
        calculerFenetresGlobales();
      }
    }

    function calculerFenetresGlobales() {
      let totalHeures = 0;
      const containers = document.querySelectorAll('[id^="fenetreGlobale_"]');
      
      containers.forEach(container => {
        const id = container.id.split('_')[1];
        const type = document.getElementById(`typeFenetreGlobal_${id}`)?.value;
        const nombre = parseInt(document.getElementById(`nombreFenetreGlobal_${id}`)?.value) || 0;
        
        let heuresParItem = 0;
        switch(type) {
          case 'facile': heuresParItem = 1/2; break; // 2 fen√™tres/h
          case 'moyenne': heuresParItem = 3/4; break; // 1.33 fen√™tres/h = 4/3 fen√™tres/h, donc 3/4 h/fen√™tre
          case 'difficile': heuresParItem = 1; break; // 1 fen√™tre/h
          case 'cadre_facile': heuresParItem = 1/2; break; // 2 cadres/h
          case 'cadre_difficile': heuresParItem = 1; break; // 1 cadre/h
        }
        
        const heuresItem = nombre * heuresParItem;
        totalHeures += heuresItem;
        
        const heuresField = document.getElementById(`heuresFenetreGlobal_${id}`);
        if (heuresField) {
          heuresField.value = heuresItem.toFixed(2);
        }
      });
      
      
      updateCalculation();
    }

    function ajouterDiversGlobal() {
      diversGlobalCounter++;
      const listContainer = document.getElementById('listDiversGlobaux');

      // R√©cup√©rer les pi√®ces cr√©√©es
      const piecesOptions = getPiecesOptions();

      const diversHtml = `
        <div id="diversGlobal_${diversGlobalCounter}" class="p-3 bg-gray-800/50 rounded border border-gray-600">
          <div class="flex justify-between items-center mb-2">
            <h5 class="font-medium text-white">Item Divers #${diversGlobalCounter}</h5>
            <button type="button" onclick="supprimerDiversGlobal(${diversGlobalCounter})" class="btn-secondary text-xs px-2 py-1" title="Supprimer cet item">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-xs font-medium text-gray-300 mb-1">Pi√®ce</label>
              <select class="select-field text-sm" id="pieceDiversGlobal_${diversGlobalCounter}" onchange="calculerDiversGlobaux()">
                ${piecesOptions}
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-300 mb-1">Type</label>
              <select class="select-field text-sm" id="typeDiversGlobal_${diversGlobalCounter}" onchange="calculerDiversGlobaux()">
                <option value="">S√©lectionner...</option>
                <option value="garde_robe">Garde robe 1 couche</option>
                <option value="calorifere">Calorif√®re √©lectrique</option>
                <option value="radiateur_1h">Ancien radiateur 1h</option>
                <option value="radiateur_2h">Ancien radiateur 2h</option>
                <option value="marche_escalier">Marche d'escalier</option>
                <option value="contre_marche">Contre-marche</option>
                <option value="interieur_armoire">Int√©rieur d'armoire (1 couche/porte)</option>
                <option value="complication_05h">Complication / difficult√©s 0,5h</option>
                <option value="complication_1h">Complication / difficult√©s 1h</option>
                <option value="deplacement_05h">D√©placement de meubles 0,5h</option>
                <option value="deplacement_1h">D√©placement de meubles 1h</option>
                <option value="installation_05h">Installation/nettoyage suppl√©mentaire 0,5h</option>
                <option value="installation_1h">Installation/nettoyage suppl√©mentaire 1h</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-300 mb-1">Quantit√©</label>
              <input type="number" class="input-field text-sm" id="quantiteDiversGlobal_${diversGlobalCounter}" min="1" step="1" value="1" onchange="calculerDiversGlobaux()">
            </div>
          </div>
          <input type="hidden" id="heuresDiversGlobal_${diversGlobalCounter}" value="0">
        </div>
      `;

      listContainer.insertAdjacentHTML('beforeend', diversHtml);

      // Convertir les nouveaux select en dropdowns personnalis√©s
      convertToCustomDropdowns();

      calculerDiversGlobaux();
    }

    function supprimerDiversGlobal(id) {
      const element = document.getElementById(`diversGlobal_${id}`);
      if (element) {
        element.remove();
        calculerDiversGlobaux();
      }
    }

    function calculerDiversGlobaux() {
      let totalHeures = 0;
      const containers = document.querySelectorAll('[id^="diversGlobal_"]');
      
      containers.forEach(container => {
        const id = container.id.split('_')[1];
        const type = document.getElementById(`typeDiversGlobal_${id}`)?.value;
        const quantite = parseInt(document.getElementById(`quantiteDiversGlobal_${id}`)?.value) || 0;
        
        let heuresParItem = 0;
        switch(type) {
          case 'garde_robe': heuresParItem = 0.5; break;
          case 'calorifere': heuresParItem = 0.25; break;
          case 'radiateur_1h': heuresParItem = 1; break;
          case 'radiateur_2h': heuresParItem = 2; break;
          case 'marche_escalier': heuresParItem = 0.1; break;
          case 'contre_marche': heuresParItem = 0.1; break;
          case 'interieur_armoire': heuresParItem = 0.5; break;
          case 'complication_05h': heuresParItem = 0.5; break;
          case 'complication_1h': heuresParItem = 1; break;
          case 'deplacement_05h': heuresParItem = 0.5; break;
          case 'deplacement_1h': heuresParItem = 1; break;
          case 'installation_05h': heuresParItem = 0.5; break;
          case 'installation_1h': heuresParItem = 1; break;
        }
        
        const heuresItem = quantite * heuresParItem;
        totalHeures += heuresItem;
        
        const heuresField = document.getElementById(`heuresDiversGlobal_${id}`);
        if (heuresField) {
          heuresField.value = heuresItem.toFixed(2);
        }
      });
      
      
      updateCalculation();
    }

    function ajouterPlafondGlobal() {
      plafondGlobalCounter++;
      const listContainer = document.getElementById('listPlafondsGlobaux');

      const plafondHtml = `
        <div id="plafondGlobal_${plafondGlobalCounter}" class="p-3 bg-gray-800/50 rounded border border-gray-600">
          <div class="flex justify-between items-center mb-2">
            <h5 class="font-medium text-white">Plafond #${plafondGlobalCounter}</h5>
            <button type="button" onclick="supprimerPlafondGlobal(${plafondGlobalCounter})" class="btn-secondary text-xs px-2 py-1" title="Supprimer ce plafond">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-xs font-medium text-gray-300 mb-1">Type</label>
              <select class="select-field text-sm" id="typePlafondGlobal_${plafondGlobalCounter}" onchange="calculerPlafondsGlobaux()">
                <option value="">S√©lectionner un plafond</option>
                <option value="angle_cathedrale">Angle cath√©drale</option>
                <option value="stucco">Stucco plafond</option>
                <option value="plus_10pi">Plus de 10 pieds hauteur</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-300 mb-1">Surface (ft¬≤)</label>
              <input type="number" class="input-field text-sm" id="surfacePlafondGlobal_${plafondGlobalCounter}" placeholder="0.0" step="0.1" min="0" onchange="calculerPlafondsGlobaux()">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-300 mb-1">Primer</label>
              <select class="select-field text-sm" id="primerPlafondGlobal_${plafondGlobalCounter}" onchange="calculerPlafondsGlobaux()">
                <option value="non">Non</option>
                <option value="oui">Oui</option>
              </select>
            </div>
          </div>
          <input type="hidden" id="heuresPlafondGlobal_${plafondGlobalCounter}" value="0">
        </div>
      `;

      listContainer.insertAdjacentHTML('beforeend', plafondHtml);

      // Convertir les nouveaux select en dropdowns personnalis√©s
      convertToCustomDropdowns();

      calculerPlafondsGlobaux();
    }

    function supprimerPlafondGlobal(id) {
      const element = document.getElementById(`plafondGlobal_${id}`);
      if (element) {
        element.remove();
        calculerPlafondsGlobaux();
      }
    }

    function calculerPlafondsGlobaux() {
      let totalHeures = 0;
      const containers = document.querySelectorAll('[id^="plafondGlobal_"]');
      const params = getCurrentParameterValues();

      containers.forEach(container => {
        const id = container.id.split('_')[1];
        const type = document.getElementById(`typePlafondGlobal_${id}`)?.value;
        const surface = parseFloat(document.getElementById(`surfacePlafondGlobal_${id}`)?.value) || 0;
        const isPrimer = document.getElementById(`primerPlafondGlobal_${id}`)?.value === 'oui';

        let heuresItem = 0;
        if (surface > 0 && type && type !== '') {
          let productivity = 400; // Valeur par d√©faut

          switch(type) {
            case 'angle_cathedrale':
              productivity = params.int_angle_cathedrale || 150;
              break;
            case 'stucco':
              productivity = params.int_stucco || 100;
              break;
            case 'plus_10pi':
              productivity = params.int_plus_10pi || 120;
              break;
          }

          heuresItem = surface / productivity;

          // Ajouter heures de primer si checkbox coch√©e (m√™me formule que peinture normale)
          if (isPrimer) {
            heuresItem += surface / productivity;
          }
        }

        totalHeures += heuresItem;

        const heuresField = document.getElementById(`heuresPlafondGlobal_${id}`);
        if (heuresField) {
          heuresField.value = heuresItem.toFixed(2);
        }
      });


      updateCalculation();
    }

    // FONCTION POUR CALCULER LES GALLONS DES PLAFONDS S√âPAR√âS
    function getTotalGallonsPlafondsSepares() {
      let gallonsPeinture = 0;
      let gallonsPrimer = 0;
      const containers = document.querySelectorAll('[id^="plafondGlobal_"]');

      containers.forEach(container => {
        const id = container.id.split('_')[1];
        const surface = parseFloat(document.getElementById(`surfacePlafondGlobal_${id}`)?.value) || 0;
        const isPrimer = document.getElementById(`primerPlafondGlobal_${id}`)?.value === 'oui';

        if (surface > 0) {
          // Calcul peinture plafond: 1√®re couche + 2√®me couche √ó 0.7 (m√™me formule que plafonds normaux)
          const premiereCouche = surface / 350;
          const deuxiemeCouche = premiereCouche * 0.7;
          gallonsPeinture += premiereCouche + deuxiemeCouche;

          // Calcul primer si checkbox coch√©e
          if (isPrimer) {
            gallonsPrimer += surface / 350; // 1 couche seulement pour primer
          }
        }
      });

      return {
        gallonsPeinture: gallonsPeinture,
        gallonsPrimer: gallonsPrimer
      };
    }

    // FONCTIONS POUR APPR√äT GLOBAL
    function updateAppretGlobalList() {
      const listContainer = document.getElementById('listPiecesAppret');
      const summaryContainer = document.getElementById('appretGlobalSummary');
      const labelContainer = document.getElementById('appretGlobalLabel');
      if (!listContainer) return;

      // Sauvegarder les √©tats actuels avant de recr√©er le HTML
      const savedStates = {};
      if (typeof piecesInterieur !== 'undefined' && piecesInterieur.length > 0) {
        piecesInterieur.forEach(piece => {
          const surfacesDiv = document.getElementById(`appretSurfaces_${piece.id}`);
          savedStates[piece.id] = {
            pieceChecked: document.getElementById(`appretPiece_${piece.id}`)?.checked || false,
            surfacesVisible: surfacesDiv ? surfacesDiv.style.display === 'flex' : false,
            mur1: document.getElementById(`appretMur1_${piece.id}`)?.checked || false,
            mur2: document.getElementById(`appretMur2_${piece.id}`)?.checked || false,
            mur3: document.getElementById(`appretMur3_${piece.id}`)?.checked || false,
            mur4: document.getElementById(`appretMur4_${piece.id}`)?.checked || false,
            plafond: document.getElementById(`appretPlafond_${piece.id}`)?.checked || false,
            moulures: document.getElementById(`appretMoulures_${piece.id}`)?.checked || false
          };
        });
      }

      listContainer.innerHTML = '';

      if (typeof piecesInterieur === 'undefined' || piecesInterieur.length === 0) {
        listContainer.innerHTML = '<div class="text-sm text-gray-400 italic">Aucune pi√®ce cr√©√©e. Ajoutez des pi√®ces pour utiliser l\'appr√™t global.</div>';
        if (summaryContainer) {
          summaryContainer.style.display = 'none';
        }
        if (labelContainer) {
          labelContainer.style.display = 'none';
        }
        calculerAppretGlobal();
        return;
      }

      if (summaryContainer) {
        summaryContainer.style.display = 'grid';
      }
      if (labelContainer) {
        labelContainer.style.display = 'block';
      }

      piecesInterieur.forEach((piece, index) => {
        // V√©rifier si le plafond est s√©lectionn√© dans la pi√®ce
        const plafondSelect = document.getElementById(`plafond_${piece.id}`);
        const plafondSelectionne = plafondSelect && plafondSelect.value === 'oui';

        const checkboxHtml = `
          <div class="p-3 bg-gray-800/70 rounded-lg border border-gray-600 transition-all">
            <!-- En-t√™te de la pi√®ce -->
            <label class="custom-checkbox-container flex items-center cursor-pointer">
              <input type="checkbox" id="appretPiece_${piece.id}" onchange="toggleAppretPieceSelection('${piece.id}')">
              <span class="custom-checkbox-checkmark"></span>
              <span class="text-white font-semibold ml-3">${piece.nom}</span>
              <span class="text-gray-400 text-sm ml-2">(${piece.largeur} √ó ${piece.profondeur} √ó ${piece.hauteur} ft)</span>
            </label>

            <!-- S√©lection des surfaces (cach√© par d√©faut) -->
            <div id="appretSurfaces_${piece.id}" style="display: none;" class="flex items-center gap-4 mt-3 pt-3 border-t border-gray-700">
              <label class="custom-checkbox-container flex items-center cursor-pointer text-sm whitespace-nowrap">
                <input type="checkbox" id="appretMur1_${piece.id}" onchange="calculerAppretGlobal()">
                <span class="custom-checkbox-checkmark"></span>
                <span class="text-white ml-2">Mur 1</span>
              </label>
              <label class="custom-checkbox-container flex items-center cursor-pointer text-sm whitespace-nowrap">
                <input type="checkbox" id="appretMur2_${piece.id}" onchange="calculerAppretGlobal()">
                <span class="custom-checkbox-checkmark"></span>
                <span class="text-white ml-2">Mur 2</span>
              </label>
              <label class="custom-checkbox-container flex items-center cursor-pointer text-sm whitespace-nowrap">
                <input type="checkbox" id="appretMur3_${piece.id}" onchange="calculerAppretGlobal()">
                <span class="custom-checkbox-checkmark"></span>
                <span class="text-white ml-2">Mur 3</span>
              </label>
              <label class="custom-checkbox-container flex items-center cursor-pointer text-sm whitespace-nowrap">
                <input type="checkbox" id="appretMur4_${piece.id}" onchange="calculerAppretGlobal()">
                <span class="custom-checkbox-checkmark"></span>
                <span class="text-white ml-2">Mur 4</span>
              </label>
              ${piece.inclureMoulures ? `
              <label class="custom-checkbox-container flex items-center cursor-pointer text-sm whitespace-nowrap">
                <input type="checkbox" id="appretMoulures_${piece.id}" onchange="calculerAppretGlobal()">
                <span class="custom-checkbox-checkmark"></span>
                <span class="text-white ml-2">Moulures</span>
              </label>
              ` : ''}
              ${plafondSelectionne ? `
              <label class="custom-checkbox-container flex items-center cursor-pointer text-sm whitespace-nowrap">
                <input type="checkbox" id="appretPlafond_${piece.id}" onchange="calculerAppretGlobal()">
                <span class="custom-checkbox-checkmark"></span>
                <span class="text-white ml-2">Plafond</span>
              </label>
              ` : ''}
            </div>
          </div>
        `;
        listContainer.insertAdjacentHTML('beforeend', checkboxHtml);

        // Restaurer les √©tats sauvegard√©s SEULEMENT s'ils existent
        if (savedStates[piece.id]) {
          const state = savedStates[piece.id];
          const pieceCheckbox = document.getElementById(`appretPiece_${piece.id}`);
          const surfacesDiv = document.getElementById(`appretSurfaces_${piece.id}`);

          if (pieceCheckbox) {
            pieceCheckbox.checked = state.pieceChecked;
          }
          if (surfacesDiv) {
            // Restaurer la visibilit√© SEULEMENT si elle √©tait visible avant
            if (state.surfacesVisible) {
              surfacesDiv.style.display = 'flex';
            } else {
              surfacesDiv.style.display = 'none';
            }
          }

          const mur1Checkbox = document.getElementById(`appretMur1_${piece.id}`);
          const mur2Checkbox = document.getElementById(`appretMur2_${piece.id}`);
          const mur3Checkbox = document.getElementById(`appretMur3_${piece.id}`);
          const mur4Checkbox = document.getElementById(`appretMur4_${piece.id}`);
          const plafondCheckbox = document.getElementById(`appretPlafond_${piece.id}`);
          const moululresCheckbox = document.getElementById(`appretMoulures_${piece.id}`);

          if (mur1Checkbox) mur1Checkbox.checked = state.mur1;
          if (mur2Checkbox) mur2Checkbox.checked = state.mur2;
          if (mur3Checkbox) mur3Checkbox.checked = state.mur3;
          if (mur4Checkbox) mur4Checkbox.checked = state.mur4;
          if (plafondCheckbox) plafondCheckbox.checked = state.plafond;
          if (moululresCheckbox) moululresCheckbox.checked = state.moulures;
        }
        // Si pas d'√©tat sauvegard√©, on ne fait rien - le display: none du HTML reste
      });

      calculerAppretGlobal();
    }

    function toggleAppretPieceSelection(pieceId) {
      const mainCheckbox = document.getElementById(`appretPiece_${pieceId}`);
      const surfacesDiv = document.getElementById(`appretSurfaces_${pieceId}`);

      if (mainCheckbox && surfacesDiv) {
        if (mainCheckbox.checked) {
          surfacesDiv.style.display = 'flex';
          // Cocher uniquement les murs par d√©faut
          document.getElementById(`appretMur1_${pieceId}`).checked = true;
          document.getElementById(`appretMur2_${pieceId}`).checked = true;
          document.getElementById(`appretMur3_${pieceId}`).checked = true;
          document.getElementById(`appretMur4_${pieceId}`).checked = true;

          // Ne PAS cocher automatiquement plafond et moulures
          const plafondCheckbox = document.getElementById(`appretPlafond_${pieceId}`);
          if (plafondCheckbox) {
            plafondCheckbox.checked = false;
          }
          const moululresCheckbox = document.getElementById(`appretMoulures_${pieceId}`);
          if (moululresCheckbox) {
            moululresCheckbox.checked = false;
          }
        } else {
          surfacesDiv.style.display = 'none';
          // D√©cocher tous les murs, plafond et moulures
          document.getElementById(`appretMur1_${pieceId}`).checked = false;
          document.getElementById(`appretMur2_${pieceId}`).checked = false;
          document.getElementById(`appretMur3_${pieceId}`).checked = false;
          document.getElementById(`appretMur4_${pieceId}`).checked = false;
          const plafondCheckbox = document.getElementById(`appretPlafond_${pieceId}`);
          if (plafondCheckbox) {
            plafondCheckbox.checked = false;
          }
          const moululresCheckbox = document.getElementById(`appretMoulures_${pieceId}`);
          if (moululresCheckbox) {
            moululresCheckbox.checked = false;
          }
        }
      }

      calculerAppretGlobal();
    }

    function calculerAppretGlobal() {
      const params = getCurrentParameterValues();
      const couvertureAppret = params.couverture_appret_int || 250;
      const tauxHoraire = params.tauxHoraireInt || 43;
      const coutPrimer = params.cout_primer_int || 55;
      const appretMoins200 = params.appret_mur_moins_200 || 100;
      const appretPlus200 = params.appret_mur_plus_200 || 125;

      let surfaceTotale = 0;
      let heuresTotales = 0;

      // Fonction d'arrondi personnalis√©e: arrondir seulement si d√©cimale <= 0.40
      function customRound(value) {
        const decimal = value - Math.floor(value);
        if (decimal <= 0.40) {
          return Math.floor(value);
        } else {
          return Math.ceil(value);
        }
      }

      if (typeof piecesInterieur !== 'undefined' && piecesInterieur.length > 0) {
        piecesInterieur.forEach(piece => {
          const mainCheckbox = document.getElementById(`appretPiece_${piece.id}`);
          if (mainCheckbox && mainCheckbox.checked) {
            // Calculer surfaces individuelles
            const largeur = piece.largeur || 0;
            const profondeur = piece.profondeur || 0;
            const hauteur = piece.hauteur || 8;

            // Calculer surfaces des murs et plafond s√©par√©ment PAR PI√àCE
            let surfaceMursPiece = 0;
            let surfacePlafondPiece = 0;

            // V√©rifier chaque mur individuellement
            if (document.getElementById(`appretMur1_${piece.id}`)?.checked) {
              surfaceMursPiece += largeur * hauteur;
            }
            if (document.getElementById(`appretMur2_${piece.id}`)?.checked) {
              surfaceMursPiece += profondeur * hauteur;
            }
            if (document.getElementById(`appretMur3_${piece.id}`)?.checked) {
              surfaceMursPiece += largeur * hauteur;
            }
            if (document.getElementById(`appretMur4_${piece.id}`)?.checked) {
              surfaceMursPiece += profondeur * hauteur;
            }

            // V√©rifier moulures et les ajouter aux murs pour le calcul +200/-200
            if (document.getElementById(`appretMoulures_${piece.id}`)?.checked) {
              surfaceMursPiece += piece.surfaceMoulures;
            }

            // V√©rifier plafond
            if (document.getElementById(`appretPlafond_${piece.id}`)?.checked) {
              surfacePlafondPiece += piece.surfacePlafond;
            }

            // Calculer heures pour MURS + MOULURES de cette pi√®ce (s√©par√©ment)
            if (surfaceMursPiece > 0) {
              const productivityMurs = surfaceMursPiece >= 200 ? appretPlus200 : appretMoins200;
              heuresTotales += surfaceMursPiece / productivityMurs;
              surfaceTotale += surfaceMursPiece;
            }

            // Calculer heures pour PLAFOND de cette pi√®ce (s√©par√©ment)
            if (surfacePlafondPiece > 0) {
              const productivityPlafond = surfacePlafondPiece >= 200 ? appretPlus200 : appretMoins200;
              heuresTotales += surfacePlafondPiece / productivityPlafond;
              surfaceTotale += surfacePlafondPiece;
            }
          }
        });
      }

      // Calculer gallons
      const gallonsAppret = surfaceTotale > 0 ? customRound(surfaceTotale / couvertureAppret) : 0;

      // Calculer co√ªts
      const coutProduit = gallonsAppret * coutPrimer;
      const coutMO = heuresTotales * tauxHoraire;

      // Mettre √† jour l'affichage
      document.getElementById('appretGlobalGallons').textContent = gallonsAppret;
      document.getElementById('appretGlobalHeures').textContent = heuresTotales.toFixed(2);
      document.getElementById('appretGlobalCoutProduit').textContent = '$' + coutProduit.toFixed(2);
      document.getElementById('appretGlobalCoutMO').textContent = '$' + coutMO.toFixed(2);

      updateCalculation();
    }

    function getAppretGlobalData() {
      const checkbox = document.getElementById('toggleAppretGlobal');
      if (!checkbox || !checkbox.checked) {
        return { gallons: 0, heures: 0, coutProduit: 0, coutMO: 0 };
      }

      const gallons = parseInt(document.getElementById('appretGlobalGallons')?.textContent) || 0;
      const heures = parseFloat(document.getElementById('appretGlobalHeures')?.textContent) || 0;
      const coutProduit = parseFloat(document.getElementById('appretGlobalCoutProduit')?.textContent.replace(/[^\d.]/g, '')) || 0;
      const coutMO = parseFloat(document.getElementById('appretGlobalCoutMO')?.textContent.replace(/[^\d.]/g, '')) || 0;

      return { gallons, heures, coutProduit, coutMO };
    }

    // ========== PR√âPARATION GLOBALE ==========
    let preparationsGlobales = {}; // {pieceId: [{type: 'lavage', surface: 100}, ...]}

    function togglePreparationGlobalSection() {
      const checkbox = document.getElementById('togglePreparationGlobal');
      const section = document.getElementById('preparationGlobalSection');
      if (checkbox && section) {
        section.style.display = checkbox.checked ? 'block' : 'none';
        updatePreparationGlobalList();
        updateCalculation();
      }
    }

    function updatePreparationGlobalList() {
      const listContainer = document.getElementById('listPiecesPreparation');
      const summaryContainer = document.getElementById('preparationGlobalSummary');
      const labelContainer = document.getElementById('preparationGlobalLabel');
      if (!listContainer) return;

      listContainer.innerHTML = '';

      if (typeof piecesInterieur === 'undefined' || piecesInterieur.length === 0) {
        listContainer.innerHTML = '<div class="text-sm text-gray-400 italic">Aucune pi√®ce cr√©√©e. Ajoutez des pi√®ces pour utiliser la pr√©paration globale.</div>';
        if (summaryContainer) summaryContainer.style.display = 'none';
        if (labelContainer) labelContainer.style.display = 'none';
        calculerPreparationGlobal();
        return;
      }

      if (summaryContainer) summaryContainer.style.display = 'grid';
      if (labelContainer) labelContainer.style.display = 'block';

      piecesInterieur.forEach((piece) => {
        const pieceHtml = `
          <div class="p-3 bg-gray-800/70 rounded-lg border border-gray-600 transition-all">
            <label class="custom-checkbox-container flex items-center cursor-pointer">
              <input type="checkbox" id="prepGlobalPiece_${piece.id}" onchange="togglePreparationGlobalPiece('${piece.id}')">
              <span class="custom-checkbox-checkmark"></span>
              <span class="text-white font-semibold ml-3">${piece.nom}</span>
              <span class="text-gray-400 text-sm ml-2">(${piece.largeur} √ó ${piece.profondeur} √ó ${piece.hauteur} ft)</span>
            </label>

            <div id="prepGlobalPreps_${piece.id}" style="display: none;" class="mt-3 pt-3 border-t border-gray-700">
              <div class="mb-3">
                <button type="button" onclick="ajouterPreparationGlobalePiece('${piece.id}')" class="btn-primary" style="padding: 4px 8px !important; font-size: 11px !important;">
                  <i class="fas fa-plus"></i> Ajouter pr√©paration
                </button>
              </div>
              <div id="prepGlobalList_${piece.id}" class="space-y-2"></div>
            </div>
          </div>
        `;
        listContainer.insertAdjacentHTML('beforeend', pieceHtml);

        // Restaurer les pr√©parations existantes
        if (preparationsGlobales[piece.id] && preparationsGlobales[piece.id].length > 0) {
          document.getElementById(`prepGlobalPiece_${piece.id}`).checked = true;
          document.getElementById(`prepGlobalPreps_${piece.id}`).style.display = 'block';
          preparationsGlobales[piece.id].forEach((prep, index) => {
            ajouterPreparationGlobaleHTML(piece.id, index, prep.type, prep.heures);
          });
        }
      });

      calculerPreparationGlobal();
    }

    function togglePreparationGlobalPiece(pieceId) {
      const checkbox = document.getElementById(`prepGlobalPiece_${pieceId}`);
      const prepsDiv = document.getElementById(`prepGlobalPreps_${pieceId}`);

      if (checkbox && prepsDiv) {
        if (checkbox.checked) {
          prepsDiv.style.display = 'block';
          if (!preparationsGlobales[pieceId]) {
            preparationsGlobales[pieceId] = [];
          }
        } else {
          prepsDiv.style.display = 'none';
          preparationsGlobales[pieceId] = [];
          document.getElementById(`prepGlobalList_${pieceId}`).innerHTML = '';
        }
      }

      calculerPreparationGlobal();
    }

    function ajouterPreparationGlobalePiece(pieceId) {
      if (!preparationsGlobales[pieceId]) {
        preparationsGlobales[pieceId] = [];
      }

      const index = preparationsGlobales[pieceId].length;
      preparationsGlobales[pieceId].push({ type: 'Lavage', heures: 1 });

      ajouterPreparationGlobaleHTML(pieceId, index, 'Lavage', 1);
      calculerPreparationGlobal();
    }

    function ajouterPreparationGlobaleHTML(pieceId, index, type, heures) {
      const listContainer = document.getElementById(`prepGlobalList_${pieceId}`);
      if (!listContainer) return;

      const prepHtml = `
        <div class="flex items-center gap-2 p-2 bg-gray-700/50 rounded" id="prepGlobalItem_${pieceId}_${index}">
          <div class="flex-1">
            <select id="prepGlobalType_${pieceId}_${index}" class="select-field" onchange="updatePreparationGlobalePiece('${pieceId}', ${index})">
              <option value="Lavage" ${type === 'Lavage' ? 'selected' : ''}>Lavage</option>
              <option value="Grattage" ${type === 'Grattage' ? 'selected' : ''}>Grattage</option>
              <option value="Dry Dex" ${type === 'Dry Dex' ? 'selected' : ''}>Dry Dex</option>
              <option value="Sablage" ${type === 'Sablage' ? 'selected' : ''}>Sablage</option>
              <option value="Autres" ${type === 'Autres' ? 'selected' : ''}>Autres</option>
            </select>
            <div class="custom-select" data-target="prepGlobalType_${pieceId}_${index}" style="min-height: auto;">
              <div class="custom-select-button" style="padding: 8px 12px; min-height: auto; font-size: 13px;">
                <span class="custom-select-text">${type || 'Lavage'}</span>
                <span class="custom-select-arrow">‚ñº</span>
              </div>
              <div class="custom-select-dropdown">
                <div class="custom-select-option" data-value="Lavage">Lavage</div>
                <div class="custom-select-option" data-value="Grattage">Grattage</div>
                <div class="custom-select-option" data-value="Dry Dex">Dry Dex</div>
                <div class="custom-select-option" data-value="Sablage">Sablage</div>
                <div class="custom-select-option" data-value="Autres">Autres</div>
              </div>
            </div>
          </div>
          <div style="width: 80px;">
            <select id="prepGlobalHeures_${pieceId}_${index}" class="select-field" onchange="updatePreparationGlobalePiece('${pieceId}', ${index})">
              <option value="1" ${heures == 1 ? 'selected' : ''}>1h</option>
              <option value="1.5" ${heures == 1.5 ? 'selected' : ''}>1.5h</option>
              <option value="2" ${heures == 2 ? 'selected' : ''}>2h</option>
              <option value="2.5" ${heures == 2.5 ? 'selected' : ''}>2.5h</option>
              <option value="3" ${heures == 3 ? 'selected' : ''}>3h</option>
              <option value="3.5" ${heures == 3.5 ? 'selected' : ''}>3.5h</option>
              <option value="4" ${heures == 4 ? 'selected' : ''}>4h</option>
              <option value="4.5" ${heures == 4.5 ? 'selected' : ''}>4.5h</option>
              <option value="5" ${heures == 5 ? 'selected' : ''}>5h</option>
              <option value="5.5" ${heures == 5.5 ? 'selected' : ''}>5.5h</option>
              <option value="6" ${heures == 6 ? 'selected' : ''}>6h</option>
              <option value="6.5" ${heures == 6.5 ? 'selected' : ''}>6.5h</option>
              <option value="7" ${heures == 7 ? 'selected' : ''}>7h</option>
              <option value="7.5" ${heures == 7.5 ? 'selected' : ''}>7.5h</option>
              <option value="8" ${heures == 8 ? 'selected' : ''}>8h</option>
              <option value="8.5" ${heures == 8.5 ? 'selected' : ''}>8.5h</option>
              <option value="9" ${heures == 9 ? 'selected' : ''}>9h</option>
              <option value="9.5" ${heures == 9.5 ? 'selected' : ''}>9.5h</option>
              <option value="10" ${heures == 10 ? 'selected' : ''}>10h</option>
            </select>
            <div class="custom-select" data-target="prepGlobalHeures_${pieceId}_${index}" style="min-height: auto;">
              <div class="custom-select-button" style="padding: 8px 12px; min-height: auto; font-size: 13px;">
                <span class="custom-select-text">${heures}h</span>
                <span class="custom-select-arrow">‚ñº</span>
              </div>
              <div class="custom-select-dropdown">
                <div class="custom-select-option" data-value="1">1h</div>
                <div class="custom-select-option" data-value="1.5">1.5h</div>
                <div class="custom-select-option" data-value="2">2h</div>
                <div class="custom-select-option" data-value="2.5">2.5h</div>
                <div class="custom-select-option" data-value="3">3h</div>
                <div class="custom-select-option" data-value="3.5">3.5h</div>
                <div class="custom-select-option" data-value="4">4h</div>
                <div class="custom-select-option" data-value="4.5">4.5h</div>
                <div class="custom-select-option" data-value="5">5h</div>
                <div class="custom-select-option" data-value="5.5">5.5h</div>
                <div class="custom-select-option" data-value="6">6h</div>
                <div class="custom-select-option" data-value="6.5">6.5h</div>
                <div class="custom-select-option" data-value="7">7h</div>
                <div class="custom-select-option" data-value="7.5">7.5h</div>
                <div class="custom-select-option" data-value="8">8h</div>
                <div class="custom-select-option" data-value="8.5">8.5h</div>
                <div class="custom-select-option" data-value="9">9h</div>
                <div class="custom-select-option" data-value="9.5">9.5h</div>
                <div class="custom-select-option" data-value="10">10h</div>
              </div>
            </div>
          </div>
          <div style="width: 30px; display: flex; align-items: center; justify-content: center;">
            <button type="button" onclick="supprimerPreparationGlobalePiece('${pieceId}', ${index})" style="background: none !important; border: none; padding: 0; transition: transform 0.2s;" class="text-white" onmouseenter="this.style.transform='scale(1.2)'" onmouseleave="this.style.transform='scale(1)'">
              <i class="fas fa-trash text-sm"></i>
            </button>
          </div>
        </div>
      `;
      listContainer.insertAdjacentHTML('beforeend', prepHtml);

      // Initialiser les custom selects pour cette nouvelle pr√©paration
      initCustomSelectsForPreparation(pieceId, index);
    }

    function initCustomSelectsForPreparation(pieceId, index) {
      const typeSelect = document.querySelector(`[data-target="prepGlobalType_${pieceId}_${index}"]`);
      const heuresSelect = document.querySelector(`[data-target="prepGlobalHeures_${pieceId}_${index}"]`);

      [typeSelect, heuresSelect].forEach(customSelect => {
        if (!customSelect) return;

        const button = customSelect.querySelector('.custom-select-button');
        const dropdown = customSelect.querySelector('.custom-select-dropdown');
        const textElement = customSelect.querySelector('.custom-select-text');
        const targetId = customSelect.getAttribute('data-target');
        const originalSelect = document.getElementById(targetId);

        if (!button || !dropdown || !originalSelect) return;

        // Ouvrir/fermer le dropdown
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = customSelect.classList.contains('open');
          document.querySelectorAll('.custom-select.open').forEach(s => s.classList.remove('open'));
          if (!isOpen) {
            customSelect.classList.add('open');
          }
        });

        // S√©lectionner une option
        dropdown.querySelectorAll('.custom-select-option').forEach(option => {
          option.addEventListener('click', (e) => {
            e.stopPropagation();
            const value = option.getAttribute('data-value');
            originalSelect.value = value;
            textElement.textContent = option.textContent;
            customSelect.classList.remove('open');

            // D√©clencher l'√©v√©nement change
            originalSelect.dispatchEvent(new Event('change'));
          });
        });
      });

      // Fermer les dropdowns en cliquant ailleurs
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.custom-select')) {
          document.querySelectorAll('.custom-select.open').forEach(s => s.classList.remove('open'));
        }
      });
    }

    function updatePreparationGlobalePiece(pieceId, index) {
      const typeInput = document.getElementById(`prepGlobalType_${pieceId}_${index}`);
      const heuresInput = document.getElementById(`prepGlobalHeures_${pieceId}_${index}`);

      if (preparationsGlobales[pieceId] && preparationsGlobales[pieceId][index]) {
        preparationsGlobales[pieceId][index].type = typeInput.value;
        preparationsGlobales[pieceId][index].heures = parseFloat(heuresInput.value) || 1;
      }

      calculerPreparationGlobal();
    }

    function supprimerPreparationGlobalePiece(pieceId, index) {
      const item = document.getElementById(`prepGlobalItem_${pieceId}_${index}`);
      if (item) item.remove();

      if (preparationsGlobales[pieceId]) {
        preparationsGlobales[pieceId].splice(index, 1);
      }

      // Reconstruire la liste pour mettre √† jour les indices
      const listContainer = document.getElementById(`prepGlobalList_${pieceId}`);
      if (listContainer) {
        listContainer.innerHTML = '';
        preparationsGlobales[pieceId].forEach((prep, idx) => {
          ajouterPreparationGlobaleHTML(pieceId, idx, prep.type, prep.heures);
        });
      }

      calculerPreparationGlobal();
    }

    function calculerPreparationGlobal() {
      const params = getCurrentParameterValues();
      const tauxHoraire = params.tauxHoraireInt || 43;

      let heuresTotales = 0;

      Object.keys(preparationsGlobales).forEach(pieceId => {
        preparationsGlobales[pieceId].forEach(prep => {
          heuresTotales += prep.heures || 0;
        });
      });

      const coutMO = heuresTotales * tauxHoraire;

      document.getElementById('preparationGlobalHeures').textContent = heuresTotales.toFixed(2);
      document.getElementById('preparationGlobalCoutMO').textContent = '$' + coutMO.toFixed(2);

      updateCalculation();
    }

    function getPreparationGlobalData() {
      const checkbox = document.getElementById('togglePreparationGlobal');
      if (!checkbox || !checkbox.checked) {
        return { heures: 0, coutMO: 0 };
      }

      const heures = parseFloat(document.getElementById('preparationGlobalHeures')?.textContent) || 0;
      const coutMO = parseFloat(document.getElementById('preparationGlobalCoutMO')?.textContent.replace(/[^\d.]/g, '')) || 0;

      return { heures, coutMO };
    }

    // FONCTIONS POUR PR√âPARATIONS ET APPR√äTS MULTIPLES PAR PI√àCE
    let preparationPieceCounters = {};
    let appretPieceCounters = {};

    function ajouterPreparationPiece(pieceId) {
      if (!preparationPieceCounters[pieceId]) {
        preparationPieceCounters[pieceId] = 0;
      }
      preparationPieceCounters[pieceId]++;
      
      const listContainer = document.getElementById('listPreparationsPiece_' + pieceId);
      const counter = preparationPieceCounters[pieceId];
      
      const preparationHtml = 
        '<div id="preparationPiece_' + pieceId + '_' + counter + '" class="p-4 bg-slate-700/40 rounded-lg border border-gray-600 shadow-sm">' +
          '<div class="flex justify-between items-center mb-2">' +
            '<h6 class="font-medium text-white flex items-center"><i class="fas fa-tools text-blue-400 mr-2"></i>Pr√©paration #' + counter + '</h6>' +
            '<button type="button" onclick="supprimerPreparationPiece(\'' + pieceId + '\', ' + counter + ')" class="btn-secondary text-xs px-2 py-1" title="Supprimer cette pr√©paration">' +
              '<i class="fas fa-trash"></i>' +
            '</button>' +
          '</div>' +
          '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-300 mb-1">Justificatif</label>' +
              '<select class="select-field text-sm" id="justificatifPreparation_' + pieceId + '_' + counter + '" onchange="updateCalculation(); autoSaveParameters();">' +
                '<option value="">S√©lectionner...</option>' +
                '<option value="lavage">Lavage</option>' +
                '<option value="grattage">Grattage</option>' +
                '<option value="Dry-dex">Dry-dex</option>' +
                '<option value="sablage">Sablage</option>' +
                '<option value="autres">Autres</option>' +
              '</select>' +
            '</div>' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-300 mb-1">Dur√©e (heures)</label>' +
              '<select class="select-field text-sm" id="dureePreparation_' + pieceId + '_' + counter + '" onchange="updateCalculation(); autoSaveParameters();">' +
                '<option value="">Aucune</option>' +
                '<option value="0.35">0.35 heure</option>' +
                '<option value="0.5">0.5 heure</option>' +
                '<option value="1">1 heure</option>' +
                '<option value="2">2 heures</option>' +
                '<option value="5">5 heures</option>' +
                '<option value="10">10 heures</option>' +
              '</select>' +
            '</div>' +
          '</div>' +
        '</div>';
      
      listContainer.insertAdjacentHTML('beforeend', preparationHtml);
      convertToCustomDropdowns();
      updateCalculation();
    }

    function supprimerPreparationPiece(pieceId, counter) {
      const element = document.getElementById('preparationPiece_' + pieceId + '_' + counter);
      if (element) {
        element.remove();
        updateCalculation();
      }
    }

    function ajouterAppretPiece(pieceId) {
      if (!appretPieceCounters[pieceId]) {
        appretPieceCounters[pieceId] = 0;
      }
      appretPieceCounters[pieceId]++;
      
      const listContainer = document.getElementById('listAppretsPiece_' + pieceId);
      const counter = appretPieceCounters[pieceId];
      
      const appretHtml = 
        '<div id="appretPiece_' + pieceId + '_' + counter + '" class="p-4 bg-slate-700/40 rounded-lg border border-gray-600 shadow-sm">' +
          '<div class="flex justify-between items-center mb-2">' +
            '<h6 class="font-medium text-white flex items-center"><i class="fas fa-spray-can text-purple-400 mr-2"></i>Appr√™t #' + counter + '</h6>' +
            '<button type="button" onclick="supprimerAppretPiece(\'' + pieceId + '\', ' + counter + ')" class="btn-secondary text-xs px-2 py-1" title="Supprimer cet appr√™t">' +
              '<i class="fas fa-trash"></i>' +
            '</button>' +
          '</div>' +
          '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-300 mb-1">Type d\'appr√™t</label>' +
              '<select class="select-field text-sm" id="typeAppret_' + pieceId + '_' + counter + '" onchange="updateCalculation(); autoSaveParameters();">' +
                '<option value="">S√©lectionner...</option>' +
                '<option value="mur_plus">Appr√™t mur 200ft¬≤ et +</option>' +
                '<option value="mur_moins">Appr√™t mur -200 pied carr√©</option>' +
                '<option value="plafond_plus">Appr√™t plafond 200ft¬≤ et +</option>' +
                '<option value="plafond_moins">Appr√™t plafond -200 pied carr√©</option>' +
              '</select>' +
            '</div>' +
            '<div>' +
              '<label class="block text-xs font-medium text-gray-300 mb-1">Surface (ft¬≤)</label>' +
              '<input type="number" class="input-field text-sm" id="surfaceAppret_' + pieceId + '_' + counter + '" placeholder="0.0" step="0.1" min="0" onchange="updateCalculation(); autoSaveParameters();">' +
            '</div>' +
          '</div>' +
        '</div>';
      
      listContainer.insertAdjacentHTML('beforeend', appretHtml);
      
      // Pr√©remplir la surface avec la surface totale √† peindre de cette pi√®ce
      setTimeout(() => {
        const piece = piecesInterieur.find(p => p.id === pieceId);
        if (piece) {
          // Calculer la surface totale s√©lectionn√©e de cette pi√®ce
          let surfaceTotalePiece = 0;
          
          // V√©rifier les murs s√©lectionn√©s
          const mur1Checked = document.getElementById(`mur1_${pieceId}`)?.checked || false;
          const mur2Checked = document.getElementById(`mur2_${pieceId}`)?.checked || false;
          const mur3Checked = document.getElementById(`mur3_${pieceId}`)?.checked || false;
          const mur4Checked = document.getElementById(`mur4_${pieceId}`)?.checked || false;
          
          if (mur1Checked) surfaceTotalePiece += parseFloat(document.getElementById(`surfaceMur1_${pieceId}`)?.value) || 0;
          if (mur2Checked) surfaceTotalePiece += parseFloat(document.getElementById(`surfaceMur2_${pieceId}`)?.value) || 0;
          if (mur3Checked) surfaceTotalePiece += parseFloat(document.getElementById(`surfaceMur3_${pieceId}`)?.value) || 0;
          if (mur4Checked) surfaceTotalePiece += parseFloat(document.getElementById(`surfaceMur4_${pieceId}`)?.value) || 0;
          
          // V√©rifier le plafond
          const plafondValue = document.getElementById(`plafond_${pieceId}`)?.value || 'non';
          if (plafondValue === 'oui') {
            surfaceTotalePiece += piece.surfacePlafond || 0;
          }
          
          // Pr√©remplir le champ surface
          const surfaceInput = document.getElementById('surfaceAppret_' + pieceId + '_' + counter);
          if (surfaceInput && surfaceTotalePiece > 0) {
            surfaceInput.value = surfaceTotalePiece.toFixed(1);
          }
        }
      }, 100);
      
      convertToCustomDropdowns();
      updateCalculation();
    }

    function supprimerAppretPiece(pieceId, counter) {
      const element = document.getElementById('appretPiece_' + pieceId + '_' + counter);
      if (element) {
        element.remove();
        updateCalculation();
      }
    }

    function updateAppretSurfacesDynamically(pieceId, surfaceTotaleSelectionnee) {
      // Trouver tous les appr√™ts de cette pi√®ce et mettre √† jour leurs surfaces
      if (!appretPieceCounters[pieceId]) return;
      
      const counter = appretPieceCounters[pieceId];
      for (let i = 1; i <= counter; i++) {
        const surfaceInput = document.getElementById('surfaceAppret_' + pieceId + '_' + i);
        if (surfaceInput) {
          // Mettre √† jour uniquement si la surface calcul√©e a chang√©
          const currentValue = parseFloat(surfaceInput.value) || 0;
          const newValue = surfaceTotaleSelectionnee;
          
          if (Math.abs(currentValue - newValue) > 0.1) { // √âviter les micro-changements
            surfaceInput.value = newValue.toFixed(1);
          }
        }
      }
    }

    function resetFormulairePiece() {
      const typePieceSelect = document.getElementById('typePiece');
      typePieceSelect.value = '';
      typePieceSelect.selectedIndex = 0;

      // Forcer la mise √† jour du custom dropdown pour typePiece
      const customSelect = typePieceSelect.previousElementSibling;
      if (customSelect && customSelect.classList.contains('custom-select')) {
        // Mettre √† jour le texte affich√©
        const textElement = customSelect.querySelector('.custom-select-text');
        if (textElement && typePieceSelect.options[0]) {
          textElement.textContent = typePieceSelect.options[0].textContent;
        }

        // Retirer 'selected' de toutes les options et l'ajouter seulement au placeholder
        const allOptions = customSelect.querySelectorAll('.custom-select-option');
        allOptions.forEach((opt, idx) => {
          if (idx === 0) {
            opt.classList.add('selected');
          } else {
            opt.classList.remove('selected');
          }
        });

        // Fermer le dropdown
        customSelect.classList.remove('open');
      }

      document.getElementById('nomPiecePersonnalise').value = '';
      document.getElementById('largeurPiece').value = '';
      document.getElementById('profondeurPiece').value = '';
      document.getElementById('hauteurPiece').value = '8';
      document.getElementById('inclureMoulures').checked = false;
    }


    // FONCTIONS PRODUITS INT√âRIEURS
    function updateInteriorProductSelection() {
      const params = getCurrentParameterValues();
      let totalCost = 0;
      
      // Appr√™t Int√©rieur
      const appretChecked = document.getElementById('produit_appret_int')?.checked || false;
      const appretGallons = parseInt(document.getElementById('gallons_appret_int')?.value) || 1;
      const appretPrice = params.cout_appret_int || 55;
      const appretCost = appretChecked ? (appretGallons * appretPrice) : 0;
      if (document.getElementById('cost_appret_int')) {
        document.getElementById('cost_appret_int').textContent = appretCost.toFixed(2) + '$';
      }
      totalCost += appretCost;
      
      // Peinture Lifemaster
      const lifemasterChecked = document.getElementById('produit_lifemaster_int')?.checked || false;
      const lifemasterGallons = parseInt(document.getElementById('gallons_lifemaster_int')?.value) || 1;
      const lifemasterPrice = params.cout_lifemaster_int || 60;
      const lifemasterCost = lifemasterChecked ? (lifemasterGallons * lifemasterPrice) : 0;
      if (document.getElementById('cost_lifemaster_int')) {
        document.getElementById('cost_lifemaster_int').textContent = lifemasterCost.toFixed(2) + '$';
      }
      totalCost += lifemasterCost;
      
      // Peinture Glidden 7700
      const gliddenChecked = document.getElementById('produit_glidden_int')?.checked || false;
      const gliddenGallons = parseInt(document.getElementById('gallons_glidden_int')?.value) || 1;
      const gliddenPrice = params.cout_glidden_7700_int || 60;
      const gliddenCost = gliddenChecked ? (gliddenGallons * gliddenPrice) : 0;
      if (document.getElementById('cost_glidden_int')) {
        document.getElementById('cost_glidden_int').textContent = gliddenCost.toFixed(2) + '$';
      }
      totalCost += gliddenCost;
      
      // Mettre √† jour le total
      if (document.getElementById('totalProduitsInt')) {
        document.getElementById('totalProduitsInt').textContent = totalCost.toFixed(2) + '$';
      }
      
      updateCalculation();
    }
    
    function calculateAutoGallonsInterior() {
      const params = getCurrentParameterValues();
      const surfaceData = collectNewSurfaceData();
      
      // Calculer la surface totale int√©rieure (murs + plafonds)
      let surfaceTotaleMurs = 0;
      let surfaceTotalePlafonds = 0;
      
      // Parcourir toutes les pi√®ces pour calculer la surface
      piecesInterieur.forEach(piece => {
        const hauteur = piece.hauteur || 8;
        const perimetre = 2 * (piece.largeur + piece.profondeur);
        const surfaceMurs = perimetre * hauteur;
        const surfacePlafond = piece.largeur * piece.profondeur;
        
        surfaceTotaleMurs += surfaceMurs;
        surfaceTotalePlafonds += surfacePlafond;
      });
      
      const surfaceTotale = surfaceTotaleMurs + surfaceTotalePlafonds;
      
      // Mettre √† jour l'affichage de la surface totale
      if (document.getElementById('surfaceTotaleInt')) {
        document.getElementById('surfaceTotaleInt').textContent = surfaceTotale.toFixed(0) + ' ft¬≤';
      }
      
      // Calcul automatique des gallons selon la couverture
      const couvertureMurs = params.couverture_murs_int || 400;
      const couvertureAppret = params.couverture_appret_int || 250;
      
      // Gallons Lifemaster (pour les murs et plafonds)
      const gallonsLifemaster = Math.ceil(surfaceTotale / couvertureMurs);
      if (document.getElementById('gallons_lifemaster_int')) {
        document.getElementById('gallons_lifemaster_int').value = gallonsLifemaster;
      }
      
      // Gallons Appr√™t (si s√©lectionn√©, pour toute la surface)
      const gallonsAppret = Math.ceil(surfaceTotale / couvertureAppret);
      if (document.getElementById('gallons_appret_int')) {
        document.getElementById('gallons_appret_int').value = gallonsAppret;
      }
      
      
      // Mettre √† jour les co√ªts
      updateInteriorProductSelection();
    }
    
    function getSelectedInteriorProducts() {
      const params = getCurrentParameterValues();
      const products = [];
      
      if (document.getElementById('produit_appret_int')?.checked) {
        products.push({
          nom: 'Appr√™t Int√©rieur',
          gallons: parseInt(document.getElementById('gallons_appret_int')?.value) || 1,
          prix: params.cout_appret_int || 55,
          couverture: params.couverture_appret_int || 250
        });
      }
      
      if (document.getElementById('produit_lifemaster_int')?.checked) {
        products.push({
          nom: 'Peinture Lifemaster',
          gallons: parseInt(document.getElementById('gallons_lifemaster_int')?.value) || 1,
          prix: params.cout_lifemaster_int || 60,
          couverture: params.couverture_murs_int || 400
        });
      }
      
      if (document.getElementById('produit_glidden_int')?.checked) {
        products.push({
          nom: 'Peinture Glidden 7700',
          gallons: parseInt(document.getElementById('gallons_glidden_int')?.value) || 1,
          prix: params.cout_glidden_7700_int || 60,
          couverture: params.couverture_murs_int || 400
        });
      }
      
      return products;
    }

    function updatePieceProductCalculation(pieceId) {
      const params = getCurrentParameterValues();
      
      // Find the piece data
      const piece = piecesInterieur.find(p => p.id === pieceId);
      if (!piece) return;
      
      // Calculate piece surface area
      const hauteur = piece.hauteur || 8;
      const perimetre = 2 * (piece.largeur + piece.profondeur);
      const surfaceMurs = perimetre * hauteur;
      const surfacePlafond = piece.largeur * piece.profondeur;
      const surfaceTotalePiece = surfaceMurs + surfacePlafond;
      
      
      // Get coverage parameters
      const couvertureMurs = params.couverture_murs_int || 400;
      const couvertureAppret = params.couverture_appret_int || 250;
      const coutAppret = params.cout_appret_int || 55;
      const coutLifemaster = params.cout_lifemaster_int || 60;
      const coutGlidden = params.cout_glidden_7700_int || 60;
      const coutClient = params.cout_produit_client_int || 0;
      const coutPrimer = params.cout_primer_int || 55;
      
      
      // Calculate surface of selected walls only for Lifemaster
      // (piece d√©j√† d√©fini plus haut)
      let surfaceMursSelectionnee = 0;
      if (piece) {
        const mur1Checked = document.getElementById(`mur1_${pieceId}`)?.checked || false;
        const mur2Checked = document.getElementById(`mur2_${pieceId}`)?.checked || false;
        const mur3Checked = document.getElementById(`mur3_${pieceId}`)?.checked || false;
        const mur4Checked = document.getElementById(`mur4_${pieceId}`)?.checked || false;
        
        const surfaceMur1 = mur1Checked ? (parseFloat(document.getElementById(`surfaceMur1_${pieceId}`)?.value) || 0) : 0;
        const surfaceMur2 = mur2Checked ? (parseFloat(document.getElementById(`surfaceMur2_${pieceId}`)?.value) || 0) : 0;
        const surfaceMur3 = mur3Checked ? (parseFloat(document.getElementById(`surfaceMur3_${pieceId}`)?.value) || 0) : 0;
        const surfaceMur4 = mur4Checked ? (parseFloat(document.getElementById(`surfaceMur4_${pieceId}`)?.value) || 0) : 0;
        
        surfaceMursSelectionnee = surfaceMur1 + surfaceMur2 + surfaceMur3 + surfaceMur4;
      }
      
      // Update Lifemaster calculations based on selected walls only
      const lifemasterCheckbox = document.getElementById('product_lifemaster_' + pieceId);
      const lifemasterGallonsInput = document.getElementById('gallons_lifemaster_' + pieceId);
      const lifemasterCostSpan = document.getElementById('cost_lifemaster_' + pieceId);
      
      if (lifemasterCheckbox && lifemasterGallonsInput && lifemasterCostSpan) {
        if (lifemasterCheckbox.checked && surfaceMursSelectionnee > 0) {
          const baseGallons = surfaceMursSelectionnee / couvertureMurs;
          const lifemasterGallons = Math.max(1, Math.ceil(baseGallons * 2)); // x2, minimum 1, arrondi vers le haut
          const lifemasterCost = lifemasterGallons * coutLifemaster;
          lifemasterGallonsInput.value = lifemasterGallons;
          lifemasterCostSpan.textContent = '$' + lifemasterCost.toFixed(2);
        } else {
          lifemasterGallonsInput.value = '0';
          lifemasterCostSpan.textContent = '$0.00';
        }
      }
      
      // Update Glidden calculations
      const gliddenCheckbox = document.getElementById('product_glidden_' + pieceId);
      const gliddenGallonsInput = document.getElementById('gallons_glidden_' + pieceId);
      const gliddenCostSpan = document.getElementById('cost_glidden_' + pieceId);
      
      if (gliddenCheckbox && gliddenGallonsInput && gliddenCostSpan) {
        if (gliddenCheckbox.checked) {
          const baseGallons = surfaceTotalePiece / couvertureMurs;
          const gliddenGallons = Math.max(2, Math.ceil((baseGallons * 2) - 1)); // x2 - 1, minimum 2, arrondi vers le haut
          const gliddenCost = gliddenGallons * coutGlidden;
          gliddenGallonsInput.value = gliddenGallons;
          gliddenCostSpan.textContent = '$' + gliddenCost.toFixed(2);
        } else {
          gliddenGallonsInput.value = '0.0';
          gliddenCostSpan.textContent = '$0.00';
        }
      }
      
      // Update Client Product calculations
      const clientCheckbox = document.getElementById('product_client_' + pieceId);
      const clientGallonsInput = document.getElementById('gallons_client_' + pieceId);
      const clientCostSpan = document.getElementById('cost_client_' + pieceId);
      
      if (clientCheckbox && clientGallonsInput && clientCostSpan) {
        if (clientCheckbox.checked) {
          const baseGallons = surfaceTotalePiece / couvertureMurs;
          const clientGallons = Math.max(2, Math.ceil((baseGallons * 2) - 1)); // x2 - 1, minimum 2, arrondi vers le haut
          const clientCost = clientGallons * coutClient; // Toujours $0
          clientGallonsInput.value = clientGallons;
          clientCostSpan.textContent = '$' + clientCost.toFixed(2);
        } else {
          clientGallonsInput.value = '0';
          clientCostSpan.textContent = '$0.00';
        }
      }
      
      // Update Primer calculations based on total piece surface (like Glidden)
      const primerCheckbox = document.getElementById('product_primer_' + pieceId);
      const primerGallonsInput = document.getElementById('gallons_primer_' + pieceId);
      const primerCostSpan = document.getElementById('cost_primer_' + pieceId);
      
      if (primerCheckbox && primerGallonsInput && primerCostSpan) {
        if (primerCheckbox.checked) {
          const baseGallons = surfaceTotalePiece / couvertureAppret; // 250 ft¬≤/gal pour primer
          const primerGallons = Math.max(1, Math.ceil(baseGallons)); // minimum 1, arrondi vers le haut
          const primerCost = primerGallons * coutPrimer;
          primerGallonsInput.value = primerGallons;
          primerCostSpan.textContent = '$' + primerCost.toFixed(2);
        } else {
          primerGallonsInput.value = '0';
          primerCostSpan.textContent = '$0.00';
        }
      }
      
      // Trigger main calculation update
      updateCalculation();
    }

    function calculateInteriorProductGallons() {
      // Calculer automatiquement les totaux globaux selon les ratios et s√©lections r√©elles
      let totalLifemasterGallons = 0;
      let totalGliddenGallons = 0;
      let totalSurfaceMurs = 0;
      let totalSurfacePlafonds = 0;
      let totalSurfaceMoulures = 0;

      // D√©clarer les variables de gallons ici pour qu'elles soient accessibles partout
      let gallonsMurs = 0;
      let gallonsMoulures = 0;
      let gallonsPlafonds = 0;

      if (typeof piecesInterieur !== 'undefined' && piecesInterieur.length > 0) {
        // D'abord vider tous les champs individuels des pi√®ces
        piecesInterieur.forEach(piece => {
          const pieceId = piece.id;

          // Vider les champs gallons individuels
          const lifemasterGallonsInput = document.getElementById(`gallons_lifemaster_${pieceId}`);
          if (lifemasterGallonsInput) lifemasterGallonsInput.value = '';

          const gliddenGallonsInput = document.getElementById(`gallons_glidden_${pieceId}`);
          if (gliddenGallonsInput) gliddenGallonsInput.value = '';

          // D√©cocher les produits individuels
          const lifemasterCheckbox = document.getElementById(`product_lifemaster_${pieceId}`);
          if (lifemasterCheckbox) lifemasterCheckbox.checked = false;

          const gliddenCheckbox = document.getElementById(`product_glidden_${pieceId}`);
          if (gliddenCheckbox) gliddenCheckbox.checked = false;
        });

        // Calculer les totaux de toutes les pi√®ces (sauf celles avec produit client)
        piecesInterieur.forEach(piece => {
          const pieceId = piece.id;

          // V√©rifier si cette pi√®ce a "Produit client = Oui"
          const clientCheckbox = document.getElementById(`product_client_${pieceId}`);
          if (clientCheckbox && clientCheckbox.checked) {
            log('‚è≠Ô∏è Pi√®ce', pieceId, 'exclue du calcul (produit client)');
            return; // Skip cette pi√®ce
          }

          // MURS - Calculer surface totale s√©lectionn√©e
          const mur1Checked = document.getElementById(`mur1_${pieceId}`)?.checked || false;
          const mur2Checked = document.getElementById(`mur2_${pieceId}`)?.checked || false;
          const mur3Checked = document.getElementById(`mur3_${pieceId}`)?.checked || false;
          const mur4Checked = document.getElementById(`mur4_${pieceId}`)?.checked || false;

          let surfaceMursSelectionnee = 0;
          if (mur1Checked) surfaceMursSelectionnee += piece.largeur * piece.hauteur;
          if (mur2Checked) surfaceMursSelectionnee += piece.profondeur * piece.hauteur;
          if (mur3Checked) surfaceMursSelectionnee += piece.largeur * piece.hauteur;
          if (mur4Checked) surfaceMursSelectionnee += piece.profondeur * piece.hauteur;

          totalSurfaceMurs += surfaceMursSelectionnee;

          // MOULURES - Calculer selon les murs s√©lectionn√©s
          if (piece.inclureMoulures) {
            let surfaceMouluresSelectionnee = 0;
            if (mur1Checked) surfaceMouluresSelectionnee += piece.largeur;
            if (mur2Checked) surfaceMouluresSelectionnee += piece.profondeur;
            if (mur3Checked) surfaceMouluresSelectionnee += piece.largeur;
            if (mur4Checked) surfaceMouluresSelectionnee += piece.profondeur;
            totalSurfaceMoulures += surfaceMouluresSelectionnee;
          }

          // PLAFONDS - Selon s√©lection
          const plafondValue = document.getElementById(`plafond_${pieceId}`)?.value || 'non';
          if (plafondValue === 'oui') {
            totalSurfacePlafonds += piece.surfacePlafond || 0;
          }
        });

        // Calculer les gallons totaux avec nouvelles formules
        // MURS: 1√®re couche (surface √∑ 350) + 2e couche (1√®re √ó 0.7)
        if (totalSurfaceMurs > 0) {
          const premiereCoucheMurs = totalSurfaceMurs / 350;
          const deuxiemeCoucheMurs = premiereCoucheMurs * 0.7;
          gallonsMurs = premiereCoucheMurs + deuxiemeCoucheMurs;
        }

        // MOULURES: (pi.lin √∑ 350) √ó 1.70
        if (totalSurfaceMoulures > 0) {
          gallonsMoulures = (totalSurfaceMoulures / 350) * 1.7;
        }

        // PLAFONDS: 1√®re couche (surface √∑ 350) + 2e couche (1√®re √ó 0.7) - M√äME FORMULE QUE MURS
        if (totalSurfacePlafonds > 0) {
          const premiereCouchePlafonds = totalSurfacePlafonds / 350;
          const deuxiemeCouchePlafonds = premiereCouchePlafonds * 0.7;
          gallonsPlafonds = premiereCouchePlafonds + deuxiemeCouchePlafonds;
        }

        // Total Lifemaster = Murs + Moulures
        totalLifemasterGallons = gallonsMurs + gallonsMoulures;

        // Total Glidden = Plafonds
        totalGliddenGallons = gallonsPlafonds;

      }

      // Fonction d'arrondi personnalis√©e: arrondir seulement si d√©cimale <= 0.40
      function customRound(value) {
        const decimal = value - Math.floor(value);
        if (decimal <= 0.40) {
          return Math.floor(value);
        } else {
          return Math.ceil(value);
        }
      }

      // Retourner les totaux pour utilisation dans le calcul des co√ªts
      return {
        lifemasterGallons: customRound(totalLifemasterGallons),
        gliddenGallons: customRound(totalGliddenGallons),
        gallonsMurs: customRound(gallonsMurs),
        gallonsMoulures: customRound(gallonsMoulures),
        gallonsPlafonds: customRound(gallonsPlafonds),
        surfaceMurs: totalSurfaceMurs,
        surfaceMoulures: totalSurfaceMoulures,
        surfacePlafonds: totalSurfacePlafonds
      };
    }

    function getSelectedInteriorProductsFromPieces() {
      const params = getCurrentParameterValues();
      let totalCost = 0;
      
      // Loop through all pieces and collect selected products
      piecesInterieur.forEach(piece => {
        const pieceId = piece.id;
        
        
        // Check Lifemaster
        const lifemasterCheckbox = document.getElementById('product_lifemaster_' + pieceId);
        const lifemasterGallonsInput = document.getElementById('gallons_lifemaster_' + pieceId);
        if (lifemasterCheckbox && lifemasterCheckbox.checked && lifemasterGallonsInput) {
          const gallons = parseFloat(lifemasterGallonsInput.value) || 0;
          const cost = gallons * (params.cout_lifemaster_int || 60);
          totalCost += cost;
        }
        
        // Check Glidden
        const gliddenCheckbox = document.getElementById('product_glidden_' + pieceId);
        const gliddenGallonsInput = document.getElementById('gallons_glidden_' + pieceId);
        if (gliddenCheckbox && gliddenCheckbox.checked && gliddenGallonsInput) {
          const gallons = parseFloat(gliddenGallonsInput.value) || 0;
          const cost = gallons * (params.cout_glidden_7700_int || 60);
          totalCost += cost;
        }
        
        // Check Client Product
        const clientCheckbox = document.getElementById('product_client_' + pieceId);
        const clientGallonsInput = document.getElementById('gallons_client_' + pieceId);
        if (clientCheckbox && clientCheckbox.checked && clientGallonsInput) {
          const gallons = parseFloat(clientGallonsInput.value) || 0;
          const cost = gallons * (params.cout_produit_client_int || 0); // Toujours $0
          totalCost += cost;
        }
        
        // Check Primer
        const primerCheckbox = document.getElementById('product_primer_' + pieceId);
        const primerGallonsInput = document.getElementById('gallons_primer_' + pieceId);
        if (primerCheckbox && primerCheckbox.checked && primerGallonsInput) {
          const gallons = parseFloat(primerGallonsInput.value) || 0;
          const cost = gallons * (params.cout_primer_int || 55);
          totalCost += cost;
        }
      });
      
      return totalCost;
    }

    function toggleInteriorProductSelection(pieceId, productKey, event = null) {
      // Trouver la product card cliqu√©e
      let productCard = null;
      if (event && event.target) {
        productCard = event.target.closest('.surface-card');
      }
      
      if (productCard) {
        // V√©rifier l'√©tat actuel bas√© sur la classe selected
        const isSelected = productCard.classList.contains('selected');
        
        // Logique de s√©lection exclusive pour produit client
        if (productKey === 'client' && !isSelected) {
          // D√©s√©lectionner tous les autres produits de cette pi√®ce
          const allCards = document.querySelectorAll(`[onclick*="toggleInteriorProductSelection('${pieceId}'"]`);
          allCards.forEach(card => {
            if (card !== productCard && card.classList.contains('selected')) {
              card.classList.remove('selected');
              card.style.border = '';
              card.style.borderColor = '';
            }
          });
        }
        
        // Si un autre produit est s√©lectionn√©, d√©s√©lectionner le produit client
        if (productKey !== 'client' && !isSelected) {
          const clientCard = document.querySelector(`[onclick*="toggleInteriorProductSelection('${pieceId}', 'client'"]`);
          if (clientCard && clientCard.classList.contains('selected')) {
            clientCard.classList.remove('selected');
            clientCard.style.border = '';
            clientCard.style.borderColor = '';
          }
        }
        
        // Toggle de la s√©lection de la carte actuelle
        if (isSelected) {
          productCard.classList.remove('selected');
          productCard.style.border = '';
          productCard.style.borderColor = '';
        } else {
          productCard.classList.add('selected');
          productCard.style.border = '2px solid var(--primary-blue)';
          productCard.style.borderColor = 'var(--primary-blue)';
        }
        
        // Cr√©er/mettre √† jour checkbox cach√©e pour les calculs
        const checkboxId = `product_${productKey}_${pieceId}`;
        let checkbox = document.getElementById(checkboxId);
        if (!checkbox) {
          checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = checkboxId;
          checkbox.style.display = 'none';
          productCard.appendChild(checkbox);
        }
        checkbox.checked = !isSelected;
        
        // Recalculer les co√ªts
        updatePieceProductCalculation(pieceId);
        updateCalculation();
      } else {
        // Fallback si pas de card trouv√©e
        const checkboxId = `product_${productKey}_${pieceId}`;
        const checkbox = document.getElementById(checkboxId);
        if (checkbox) {
          checkbox.checked = !checkbox.checked;
          updatePieceProductCalculation(pieceId);
          updateCalculation();
        }
      }
    }

    function applyProductSelectionStyle(checkbox, isSelected) {
      if (checkbox) {
        // Style de la checkbox
        if (isSelected) {
          checkbox.style.border = '2px solid #000000';
          checkbox.style.borderColor = '#000000';
        } else {
          checkbox.style.border = '2px solid #d1d5db';
          checkbox.style.borderColor = '#d1d5db';
        }
        
        // Style de la carte produit
        const productCard = checkbox.closest('.surface-card');
        if (productCard) {
          if (isSelected) {
            productCard.style.border = '2px solid var(--primary-blue)';
            productCard.style.borderColor = 'var(--primary-blue)';
            productCard.classList.add('selected');
          } else {
            productCard.style.border = '';
            productCard.style.borderColor = '';
            productCard.classList.remove('selected');
          }
        }
      }
    }

    // FONCTIONS PRODUITS EXT√âRIEURS (Section globale supprim√©e - seules les sections individuelles sont utilis√©es)
    
    function calculerSurfaceTotaleEndroits() {
      let surfaceTotale = 0;
      
      // Parcourir tous les endroits ajout√©s
      const endroitsContainer = document.getElementById('endroits-container');
      if (endroitsContainer) {
        const endroits = endroitsContainer.querySelectorAll('.endroit-item');
        endroits.forEach(endroit => {
          const surfaceInput = endroit.querySelector('input[data-type="surface"]');
          if (surfaceInput && surfaceInput.value) {
            surfaceTotale += parseFloat(surfaceInput.value) || 0;
          }
        });
      }
      
      return surfaceTotale;
    }
    
    function getSelectedExteriorProducts() {
      let totalCost = 0;

      // DEBUG getSelectedExteriorProducts supprim√©

      // Utiliser le nouveau syst√®me selectedProducts, SAUF les primers
      Object.keys(selectedProducts).forEach(productKey => {
        const product = selectedProducts[productKey];
        if (product && product.total) {
          // Exclure les primers qui sont compt√©s s√©par√©ment
          if (product.name !== 'Dulux Gripper' && product.name !== 'Cover Stain') {
            totalCost += product.total;
            // DEBUG produit ext√©rieur supprim√©
          }
        }
      });

      // DEBUG co√ªt total ext√©rieur supprim√©
      return totalCost;
    }

    function getSelectedPrimerProducts() {
      let totalCost = 0;

      // Collecter tous les inputs de gallons des primers "surface compl√®te"
      const duluxInputs = document.querySelectorAll('[id^="gallons_dulux_gripper_"]');
      const jammerInputs = document.querySelectorAll('[id^="gallons_jammer_huile_"]');

      // Dulux Gripper
      duluxInputs.forEach(input => {
        const gallons = parseFloat(input.value) || 0;
        if (gallons > 0) {
          const sectionId = input.id.replace('gallons_dulux_gripper_', '');
          const costSpan = document.getElementById(`cost_dulux_gripper_${sectionId}`);
          const costText = costSpan?.textContent || '$0.00';
          const cost = parseFloat(costText.replace('$', '').replace(',', '')) || 0;

          totalCost += cost;
        }
      });

      // Cover Stain
      jammerInputs.forEach(input => {
        const gallons = parseFloat(input.value) || 0;
        if (gallons > 0) {
          const sectionId = input.id.replace('gallons_jammer_huile_', '');
          const costSpan = document.getElementById(`cost_jammer_huile_${sectionId}`);
          const costText = costSpan?.textContent || '$0.00';
          const cost = parseFloat(costText.replace('$', '').replace(',', '')) || 0;

          totalCost += cost;
        }
      });

      // Aussi collecter depuis selectedProducts (pour compatibilit√© avec les anciens primers)
      Object.keys(selectedProducts).forEach(productKey => {
        const product = selectedProducts[productKey];
        if (product && product.total &&
            (product.name === 'Dulux Gripper' || product.name === 'Cover Stain')) {
          totalCost += product.total;
        }
      });

      return totalCost;
    }

    // FONCTION SUPPRIM√âE: generatePrimerSection() - Plus utilis√©e car primer g√©r√© dans "Primer surface compl√®te" seulement

    function generateExteriorProductsSection(sectionId) {
      const params = getCurrentParameterValues();
      const produitClientPrix = params.produit_client_prix || 20;
      return `
        <div class="mt-3 pt-3 border-t border-gray-700/50">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-xs font-semibold text-white">Produits Ext√©rieur</h4>
          </div>
          <div class="grid grid-cols-3 gap-2" id="produitsExt_${sectionId}">

            <!-- Dulux huile ST -->
            <div class="surface-card product-card p-2 cursor-pointer transition-all duration-200 hover:scale-105"
                 onclick="selectProduct('${sectionId}', 'dulux_huile_st', 'Dulux huile ST', 200, 80, event)"
                 style="border: 2px solid var(--border-dark) !important;"
                 onmouseover="this.style.backgroundColor='#065f46'; this.style.setProperty('border', '2px solid #10b981', 'important');"
                 onmouseout="if(!this.classList.contains('selected')) { this.style.backgroundColor=''; this.style.setProperty('border', '2px solid var(--border-dark)', 'important'); }">
              <div class="flex items-center space-x-2">
                <div class="flex-1">
                  <div class="text-sm font-medium text-white">Dulux huile ST</div>
                  <div class="flex items-center justify-between text-xs mt-1">
                    <span class="product-badge px-1.5 py-0.5 rounded text-xs">200 ft¬≤/gal</span>
                    <span class="font-semibold text-white">$80/gal</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Dulux Hybride OPQ -->
            <div class="surface-card product-card p-2 cursor-pointer transition-all duration-200 hover:scale-105"
                 onclick="selectProduct('${sectionId}', 'dulux_hybride_opq', 'Dulux hybride OPQ', 200, 80, event)"
                 style="border: 2px solid var(--border-dark) !important;"
                 onmouseover="this.style.backgroundColor='#065f46'; this.style.setProperty('border', '2px solid #10b981', 'important');"
                 onmouseout="if(!this.classList.contains('selected')) { this.style.backgroundColor=''; this.style.setProperty('border', '2px solid var(--border-dark)', 'important'); }">
              <div class="flex items-center space-x-2">
                <div class="flex-1">
                  <div class="text-sm font-medium text-white">Dulux Hybride OPQ</div>
                  <div class="flex items-center justify-between text-xs mt-1">
                    <span class="product-badge px-1.5 py-0.5 rounded text-xs">200 ft¬≤/gal</span>
                    <span class="font-semibold text-white">$80/gal</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Dulux √©mail √† planchers -->
            <div class="surface-card product-card p-2 cursor-pointer transition-all duration-200 hover:scale-105"
                 onclick="selectProduct('${sectionId}', 'dulux_email_planchers', 'Dulux √©mail planchers', 350, 80, event)"
                 style="border: 2px solid var(--border-dark) !important;"
                 onmouseover="this.style.backgroundColor='#065f46'; this.style.setProperty('border', '2px solid #10b981', 'important');"
                 onmouseout="if(!this.classList.contains('selected')) { this.style.backgroundColor=''; this.style.setProperty('border', '2px solid var(--border-dark)', 'important'); }">
              <div class="flex items-center space-x-2">
                <div class="flex-1">
                  <div class="text-sm font-medium text-white">Dulux √©mail √† planchers</div>
                  <div class="flex items-center justify-between text-xs mt-1">
                    <span class="product-badge px-1.5 py-0.5 rounded text-xs">350 ft¬≤/gal</span>
                    <span class="font-semibold text-white">$80/gal</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sikkens ST -->
            <div class="surface-card product-card p-2 cursor-pointer transition-all duration-200 hover:scale-105"
                 onclick="selectProduct('${sectionId}', 'sikkens_st', 'Sikkens ST', 200, 140, event)"
                 style="border: 2px solid var(--border-dark) !important;"
                 onmouseover="this.style.backgroundColor='#065f46'; this.style.setProperty('border', '2px solid #10b981', 'important');"
                 onmouseout="if(!this.classList.contains('selected')) { this.style.backgroundColor=''; this.style.setProperty('border', '2px solid var(--border-dark)', 'important'); }">
              <div class="flex items-center space-x-2">
                <div class="flex-1">
                  <div class="text-sm font-medium text-white">Sikkens ST</div>
                  <div class="flex items-center justify-between text-xs mt-1">
                    <span class="product-badge px-1.5 py-0.5 rounded text-xs">200 ft¬≤/gal</span>
                    <span class="font-semibold text-white">$150/gal</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Diamant -->
            <div class="surface-card product-card p-2 cursor-pointer transition-all duration-200 hover:scale-105"
                 onclick="selectProduct('${sectionId}', 'diamant', 'Diamant', 350, 95, event)"
                 style="border: 2px solid var(--border-dark) !important;"
                 onmouseover="this.style.backgroundColor='#065f46'; this.style.setProperty('border', '2px solid #10b981', 'important');"
                 onmouseout="if(!this.classList.contains('selected')) { this.style.backgroundColor=''; this.style.setProperty('border', '2px solid var(--border-dark)', 'important'); }">
              <div class="flex items-center space-x-2">
                <div class="flex-1">
                  <div class="text-sm font-medium text-white">Diamant</div>
                  <div class="flex items-center justify-between text-xs mt-1">
                    <span class="product-badge px-1.5 py-0.5 rounded text-xs">350 ft¬≤/gal</span>
                    <span class="font-semibold text-white">$95/gal</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Produit client -->
            <div class="surface-card product-card p-2 cursor-pointer transition-all duration-200 hover:scale-105"
                 onclick="selectProduct('${sectionId}', 'produit_client', 'Produit client', 300, ${produitClientPrix}, event)"
                 style="border: 2px solid var(--border-dark) !important;"
                 onmouseover="this.style.backgroundColor='#065f46'; this.style.setProperty('border', '2px solid #10b981', 'important');"
                 onmouseout="if(!this.classList.contains('selected')) { this.style.backgroundColor=''; this.style.setProperty('border', '2px solid var(--border-dark)', 'important'); }">
              <div class="flex items-center space-x-2">
                <div class="flex-1">
                  <div class="text-sm font-medium text-white">Produit client</div>
                  <div class="flex items-center justify-between text-xs mt-1">
                    <span class="product-badge px-1.5 py-0.5 rounded text-xs">300 ft¬≤/gal</span>
                    <span class="font-semibold text-white">$${produitClientPrix}/gal</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Option troisi√®me couche -->
          <div class="mt-3 pt-3 border-t border-gray-700/50">
            <div class="flex items-center space-x-3 p-2 rounded-lg bg-slate-700/30">
              <div class="flex items-center">
                <input type="checkbox" id="troisieme_couche_${sectionId}"
                       class="modern-checkbox"
                       onchange="handleTroisiemeCoucheChange('${sectionId}', this)"
                       style="width: 18px; height: 18px;">
              </div>
              <div class="flex-1">
                <label for="troisieme_couche_${sectionId}" class="text-sm font-medium text-white cursor-pointer">
                  Troisi√®me couche
                </label>
                <div class="text-xs text-gray-400 mt-1">
                  Ajouter une couche suppl√©mentaire pour cette endroit
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function handleTroisiemeCoucheChange(sectionId, checkbox) {

      // Recalculer tous les produits s√©lectionn√©s pour prendre en compte la troisi√®me couche
      recalculateSelectedProducts();

      // Mettre √† jour les d√©tails des produits
      updateProductDetails();

      // D√©clencher le recalcul complet pour inclure le co√ªt MO de la troisi√®me couche
      updateCalculation();

      // Notification √† l'utilisateur
      if (checkbox.checked) {
        showNotification('Troisi√®me couche activ√©e', 'success');
      } else {
        showNotification('Troisi√®me couche d√©sactiv√©e', 'info');
      }
    }

    function getRatioForSection(sectionId) {
      // Fonction pour d√©terminer le ratio (pi¬≤/h) selon le type de section
      // Bas√© sur les param√®tres de l'√©l√©ment s√©lectionn√© dans la section

      const sectionElement = document.getElementById(sectionId);
      if (!sectionElement) return 75; // valeur par d√©faut

      // Chercher le dropdown dans cette section
      const dropdown = sectionElement.querySelector('select');
      if (!dropdown || !dropdown.value) return 75;

      const selectedValue = dropdown.value;
      const params = getCurrentParameterValues();

      // Mapper les valeurs vers les param√®tres de ratio
      const ratioMap = {
        // Rev√™tement
        'latte_horizontale_4po': params.peinture_latte_4po || 55,
        'revetement_horizontal_6po': params.peinture_revetement_6po || 75,
        'bardeau_neuf_teinture': params.teindre_bardeau_neuf || 55,
        'bardeau_vieux_teinture': params.teindre_bardeau_vieux || 40,
        'stucco_faible_relief': params.stucco_faible_relief || 65,
        'stucco_fort_relief': params.stucco_fort_relief || 45,
        'brique': params.brique || 60,
        'solage_facile': params.solage_facile || 65,
        'solage_difficile': params.solage_difficile || 45,

        // Corniche et moulure
        'fascia_plate_1er': params.fascia_plate_1er || 40,
        'fascia_complexe_2e': params.fascia_complexe_2e || 25,
        'corniche_plate_1er': params.corniche_plate_1er || 25,
        'corniche_texturee_1er': params.corniche_texturee_1er || 18,
        'corniche_complexe_1er': params.corniche_complexe_1er || 15,
        'corniche_plate_2e': params.corniche_plate_2e || 20,
        'corniche_texturee_2e': params.corniche_texturee_2e || 14,
        'corniche_complexe_2e': params.corniche_complexe_2e || 12,

        // D√©faut pour d'autres types
      };

      return ratioMap[selectedValue] || 75; // Valeur par d√©faut si non trouv√©
    }

    function getProductParametersFromTable(productName) {
      // Lire les param√®tres depuis le tableau des produits
      const rows = document.querySelectorAll('#products-table-body tr');
      for (let row of rows) {
        const typeInput = row.querySelector('[data-field="type"]');
        if (typeInput && typeInput.value === productName) {
          const ratioInput = row.querySelector('[data-field="ratio"]');
          const prixInput = row.querySelector('[data-field="prix"]');
          return {
            coverage: ratioInput ? parseFloat(ratioInput.value) || 200 : 200,
            cost: prixInput ? parseFloat(prixInput.value) || 0 : 0
          };
        }
      }
      // Valeurs par d√©faut si pas trouv√© dans le tableau
      return { coverage: 200, cost: 0 };
    }

    // Fonction helper pour v√©rifier si une section utilise la formule 1 du bar√®me
    function isFormula1Section(sectionId) {
      // Sections qui utilisent la formule 1: revetement, balcon (pour 2 premiers √©l√©ments)
      const formula1Sections = ['revetement', 'balcon'];
      return formula1Sections.includes(sectionId);
    }

    // Fonction helper pour v√©rifier si un √©l√©ment balcon utilise la formule 1
    function isBalconFormula1Element(selectedValue) {
      const formula1BalconElements = ['plancher_teinture_semi', 'plancher_opaque_peinture'];
      return formula1BalconElements.includes(selectedValue);
    }

    // Fonction helper pour obtenir le ratio selon l'√©l√©ment s√©lectionn√©
    function getRatioForElement(sectionId) {
      // Pour les sous-sections d'endroits, le type est dans l'ID: endroit_X_TYPE_timestamp
      // Extraire le type depuis l'ID
      let selectedValue = '';

      // Pattern: endroit_X_TYPE_timestamp (ex: endroit_1_teindre_bardeau_neuf_1767900782120)
      const parts = sectionId.split('_');
      if (parts.length >= 4) {
        // Le type est entre le num√©ro d'endroit et le timestamp
        // Ex: ['endroit', '1', 'teindre', 'bardeau', 'neuf', '1767900782120']
        // On prend tout sauf le premier, le deuxi√®me et le dernier
        selectedValue = parts.slice(2, -1).join('_');
      }

      // Mapping des √©l√©ments vers les ratios (formule 1 seulement)
      const ratioMap = {
        // Section revetement
        'peinture_latte_4po': 'ratio_latte_horizontale_4po',
        'peinture_revetement_6po': 'ratio_revetement_horizontal_6po',
        'teindre_bardeau_neuf': 'ratio_bardeau_cedre_neuf',
        'teindre_bardeau_vieux': 'ratio_bardeau_cedre_vieux',
        'stucco_faible_relief': 'ratio_stucco_faible_relief',
        'stucco_fort_relief': 'ratio_stucco_fort_relief',
        'brique': 'ratio_brique',
        'solage_facile': 'ratio_solage_facile',
        'solage_difficile': 'ratio_solage_difficile',

        // Section primer (surface compl√®te)
        'primer_surface_facile': 'ratio_primer_surface_facile',
        'primer_surface_difficile': 'ratio_primer_surface_difficile',

        // Section balcon (2 premiers √©l√©ments)
        'plancher_teinture_semi': 'ratio_plancher_teinture_semi',
        'plancher_opaque_peinture': 'ratio_plancher_opaque_peinture'
      };

      const params = getCurrentParameterValues();
      const ratioParam = ratioMap[selectedValue];
      const ratioValue = ratioParam ? (params[ratioParam] || 1) : 1;
      return ratioValue;
    }

    function updateProductInSection(sectionId, productKey, defaultCoverage, defaultCost) {
      const params = getCurrentParameterValues();
      const surfaceSection = calculerSurfaceSection(sectionId);
      
      const productChecked = document.getElementById(`product_${productKey}_${sectionId}`)?.checked || false;
      let productCost = 0;
      
      // Mapper les cl√©s vers les noms de produits du tableau
      const productNameMap = {
        'dulux_huile_st': 'Dulux huile ST',
        'dulux_hybride_opq': 'Dulux Hybride OPQ', 
        'dulux_email_planchers': 'Dulux √©mail √† planchers',
        'sikkens_st': 'Sikkens ST',
        'diamant': 'Diamant',
        'client': 'Produit client'
      };
      
      if (productChecked && surfaceSection > 0) {
        // Lire les param√®tres depuis le tableau des produits
        const productName = productNameMap[productKey];
        const productParams = productName ? getProductParametersFromTable(productName) : { coverage: defaultCoverage, cost: defaultCost };

        const couverture = productParams.coverage;
        const cout = productParams.cost;
        // V√©rifier si on doit utiliser la formule 1 (Quantit√© √∑ (Ratio √ó Couverture))
        const ratio = getRatioForElement(sectionId);

        // D√©terminer le type d'endroit depuis le sectionId ou les attributs data
        let endroitType = '';
        const sectionElement = document.getElementById(sectionId);
        if (sectionElement) {
          // Chercher les inputs avec attributs data pour d√©terminer le type
          const dataInputs = sectionElement.querySelectorAll('[data-revetement], [data-balcon], [data-cloture], [data-corniches], [data-fenetres], [data-portes], [data-fer_forge], [data-autre]');
          if (dataInputs.length > 0) {
            const firstInput = dataInputs[0];
            if (firstInput.hasAttribute('data-revetement')) endroitType = 'revetement';
            else if (firstInput.hasAttribute('data-balcon')) endroitType = 'balcon';
            else if (firstInput.hasAttribute('data-cloture')) endroitType = 'cloture';
            // ... autres types
          }
        }

        // D√©terminer si on utilise la formule 1
        let useFormula1 = false;
        const selectedDropdown = sectionElement?.querySelector('select');
        const selectedValue = selectedDropdown?.value || '';

        if (endroitType === 'balcon') {
          useFormula1 = isBalconFormula1Element(selectedValue);
        } else if (endroitType === 'revetement') {
          useFormula1 = true; // Tous les √©l√©ments rev√™tement utilisent formule 1
        } else {
          useFormula1 = ratio !== 1;
        }

        let firstCoatGallons;
        if (useFormula1) {
          // FORMULE 1: Quantit√© √∑ (Ratio √ó Couverture)
          firstCoatGallons = surfaceSection / (ratio * couverture);
        } else {
          // Formule standard: Quantit√© √∑ Couverture
          firstCoatGallons = surfaceSection / couverture;
        }

        const secondCoatGallons = firstCoatGallons * (params.facteur_deuxieme_couche || 0.7);
        const calculatedGallons = Math.ceil(firstCoatGallons + secondCoatGallons);
        
        const gallonsElement = document.getElementById(`gallons_${productKey}_${sectionId}`);
        const costElement = document.getElementById(`cost_${productKey}_${sectionId}`);
        
        // Si l'utilisateur n'a pas encore modifi√© les gallons (valeur = 0), utiliser le calcul automatique
        // Sinon, utiliser la valeur saisie manuellement par l'utilisateur
        let finalGallons = calculatedGallons;
        if (gallonsElement && parseFloat(gallonsElement.value) > 0) {
          // L'utilisateur a d√©j√† modifi√© la valeur, la garder
          finalGallons = parseFloat(gallonsElement.value);
        } else if (gallonsElement) {
          // Premi√®re fois ou valeur √† 0, utiliser le calcul automatique
          gallonsElement.value = calculatedGallons;
        }
        
        productCost = finalGallons * cout;
        if (costElement) costElement.textContent = '$' + productCost.toFixed(2);
      } else {
        const gallonsElement = document.getElementById(`gallons_${productKey}_${sectionId}`);
        const costElement = document.getElementById(`cost_${productKey}_${sectionId}`);
        
        if (gallonsElement) gallonsElement.value = 0;
        if (costElement) costElement.textContent = '$0.00';
      }
      
      return productCost;
    }

    function updateSectionProductCalculation(sectionId) {
      const params = getCurrentParameterValues();
      let totalCost = 0;
      
      // Calculer la surface de cette section sp√©cifique
      const surfaceSection = calculerSurfaceSection(sectionId);
      
      // Mettre √† jour chaque produit en utilisant la fonction helper s√©curis√©e
      totalCost += updateProductInSection(sectionId, 'dulux_huile_st', 200, 80);
      totalCost += updateProductInSection(sectionId, 'dulux_hybride_opq', 200, 80);
      totalCost += updateProductInSection(sectionId, 'dulux_email_planchers', 350, 80);
      totalCost += updateProductInSection(sectionId, 'sikkens_st', 200, 140);
      totalCost += updateProductInSection(sectionId, 'diamant', 350, 95);
      totalCost += updateProductInSection(sectionId, 'produit_client', 300, 0);
      
          }

    function updateSectionPrimerCalculation(sectionId) {
      const params = getCurrentParameterValues();
      let primerCost = 0;
      
      // Calculer la surface de cette section sp√©cifique
      const surfaceSection = calculerSurfaceSection(sectionId);
      
      // Mettre √† jour le primer en utilisant la fonction helper s√©curis√©e
      primerCost += updatePrimerInSection(sectionId, 200, 100);
      
    }

    function updatePrimerInSection(sectionId, defaultCoverage, defaultCost) {
      const params = getCurrentParameterValues();
      const surfaceSection = calculerSurfaceSection(sectionId);
      
      const primerChecked = document.getElementById(`product_primer_${sectionId}`)?.checked || false;
      let primerCost = 0;
      
      if (primerChecked && surfaceSection > 0) {
        // Lire les param√®tres du Dulux Gripper depuis le tableau
        const productParams = getProductParametersFromTable('Dulux Gripper');
        const couverture = productParams.coverage;
        const cout = productParams.cost;
        const calculatedGallons = Math.ceil(surfaceSection / couverture);
        
        const gallonsElement = document.getElementById(`gallons_primer_${sectionId}`);
        const costElement = document.getElementById(`cost_primer_${sectionId}`);
        
        // Si l'utilisateur n'a pas encore modifi√© les gallons (valeur = 0), utiliser le calcul automatique
        // Sinon, utiliser la valeur saisie manuellement par l'utilisateur
        let finalGallons = calculatedGallons;
        if (gallonsElement && parseFloat(gallonsElement.value) > 0) {
          // L'utilisateur a d√©j√† modifi√© la valeur, la garder
          finalGallons = parseFloat(gallonsElement.value);
        } else if (gallonsElement) {
          // Premi√®re fois ou valeur √† 0, utiliser le calcul automatique
          gallonsElement.value = calculatedGallons;
        }
        
        primerCost = finalGallons * cout;
        if (costElement) costElement.textContent = '$' + primerCost.toFixed(2);
      } else {
        const gallonsElement = document.getElementById(`gallons_primer_${sectionId}`);
        const costElement = document.getElementById(`cost_primer_${sectionId}`);
        
        if (gallonsElement) gallonsElement.value = 0;
        if (costElement) costElement.textContent = '$0.00';
      }
      
      return primerCost;
    }

    
    function calculerSurfaceSection(sectionId) {
      let surfaceTotale = 0;

      // Chercher tous les inputs de surface dans cette section
      const sectionElement = document.getElementById(sectionId);
      if (sectionElement) {
        const inputs = sectionElement.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
          // Pour les sous-sections d'endroits (ex: endroit_1_1_1),
          // chercher les inputs avec data-section (avant, droit, arri√®re, gauche)
          if (input.dataset.section &&
              ['avant', 'droit', 'arriere', 'gauche'].includes(input.dataset.section)) {
            const value = parseFloat(input.value) || 0;
            surfaceTotale += value;
            // DEBUG: Input trouv√© - supprim√©
          }
        });
      }

      // DEBUG calculerSurfaceSection supprim√©
      return surfaceTotale;
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();

      // V√©rifier si on arrive depuis travaux.html avec un nom de client
      setTimeout(async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const clientNom = urlParams.get('client');

        if (clientNom) {
          log('[DEBUG] Recherche du projet pour le client:', clientNom);

          try {
            const username = localStorage.getItem('username') || 'default';
            const response = await fetch(`/api/projets/${username}`);
            if (response.ok) {
              const projets = await response.json();

              // Chercher le projet correspondant au nom du client
              const projet = projets.find(p => p.client && p.client.trim().toLowerCase() === clientNom.trim().toLowerCase());

              if (projet) {
                log('[OK] Projet trouv√©:', projet);
                // Charger le projet
                await chargerProjet(projet.id);
                // Ouvrir l'onglet estimation
                switchTab('estimation');
                showNotification(`Projet de ${clientNom} charg√©`, 'success');
              } else {
                log('[WARN] Aucun projet trouv√© pour:', clientNom);
                showNotification(`Aucun projet trouv√© pour ${clientNom}`, 'warning');
              }
            }
          } catch (error) {
            error('[ERROR] Erreur chargement projet:', error);
          }
        }
      }, 1000);

      // Plus besoin de formatting - les valeurs par d√©faut sont d√©j√† correctes

      // Global event delegation for interior dropdowns and inputs
      document.addEventListener('change', function(e) {
        const target = e.target;
        if ((target.tagName === 'SELECT' || target.tagName === 'INPUT') && target.hasAttribute('data-piece')) {
          const pieceId = target.getAttribute('data-piece');
          const type = target.getAttribute('data-type');
          
          // Log specific dropdown types
          if (type === 'justificatif') {
          } else if (type === 'preparation') {
            updateCalculation();
          } else if (type === 'appret') {
          } else if (type === 'peinture-client') {
          } else if (type === 'pied-carre') {
            // Log handled in blur event
          } else if (type === 'type-porte') {
          } else if (type === 'type-fenetre') {
          }
          
          updateCalculation();
        }
      });
      
      // Additional event listener for blur events (when leaving input fields)
      document.addEventListener('blur', function(e) {
        const target = e.target;
        if (target.tagName === 'INPUT' && target.hasAttribute('data-piece')) {
          const pieceId = target.getAttribute('data-piece');
          const type = target.getAttribute('data-type');
          
          if (type === 'pied-carre') {
          }
          
          updateCalculation();
        }
      }, true);
      
      // Force additional refresh after full DOM load
      setTimeout(() => {
        refreshProductSelection();
      }, 500);
    });

    // Final refresh when everything is fully loaded
    window.addEventListener('load', function() {
      setTimeout(() => {
          refreshProductSelection();
      }, 200);
    });

    async function initializeApp() {
      // Synchroniser tous les taux horaires au d√©marrage
      updateAllTauxHoraireDisplays();

      // Set current date (√©l√©ment supprim√© - plus n√©cessaire)
      // document.getElementById('estimationDate').value = new Date().toISOString().split('T')[0];

      // Initialiser canEditParameters √† false par d√©faut
      canEditParameters = false;

      // Load user permissions from API
      await loadUserPermissions();

      // Solution directe: forcer l'affichage pour les comptes admin/direction
      if (username === 'admin' || username === 'direction') {
        userRole = 'direction';
        canEditParameters = true;

        // Forcer l'affichage de l'onglet imm√©diatement
        const adminTabButton = document.getElementById('parametres-admin-tab-btn');
        if (adminTabButton) {
          adminTabButton.style.display = 'flex';
        }

        // Activer les param√®tres pour les utilisateurs direction
        enableParameterInputs();
      } else {
        // S'assurer que les param√®tres sont cach√©s pour les non-direction
        canEditParameters = false;
        toggleParametersAdminTab();
      }
      
      // Add event listeners
      addEventListeners();
      
      // Load global parameters (synchronized for all users)
      await loadAllParameters();
      
      // Load saved products
      loadProductsFromStorage();
      
      // Force refresh product selection immediately after full page load
      setTimeout(() => {
        refreshProductSelection();
        updateCalculation();
      }, 300); // D√©lai plus long pour s'assurer que tout est charg√©
      
      // D√©marrer la synchronisation p√©riodique des param√®tres (seulement si admin)
      if (canEditParameters) {
        startParameterSync();
      }
      
      // Force check permissions apr√®s un d√©lai pour s'assurer que l'onglet est visible
      setTimeout(() => {
        toggleParametersAdminTab();
      }, 2000);
      
      // Test direct de l'API permissions apr√®s 3 secondes
      setTimeout(async () => {
        
        try {
          // Test d'abord si le serveur r√©pond
          const testPing = await fetch('/');
          
          const testResponse = await fetch(`/api/user/${encodeURIComponent(username)}/permissions`);
          
          if (testResponse.ok) {
            const testResult = await testResponse.json();
            
            // Forcer la mise √† jour si on a une r√©ponse valide
            if (testResult.role && testResult.canEditParameters !== undefined) {
                            userRole = testResult.role;
              canEditParameters = testResult.canEditParameters;
              toggleParametersAdminTab();
            }
          } else {
            const testError = await testResponse.text();
          }
        } catch (testError) {
        }
      }, 3000);
      
      // R√©cup√©rer les donn√©es du prospect depuis sessionStorage avec un d√©lai pour s'assurer que le DOM est pr√™t
      setTimeout(() => {
        const prospectData = sessionStorage.getItem('submissionData');
        
        if (prospectData) {
          try {
            const prospect = JSON.parse(prospectData);
            
            // Pr√©-remplir les champs client avec v√©rification des √©l√©ments
            const clientPrenomField = document.getElementById('clientPrenom');
            const clientNomField = document.getElementById('clientNom');
            const clientAddressField = document.getElementById('clientAddress');
            const clientPhoneField = document.getElementById('clientPhone');
            
            if (clientPrenomField && prospect.prenom) {
              clientPrenomField.value = prospect.prenom;
            }
            if (clientNomField && prospect.nom) {
              clientNomField.value = prospect.nom;
                          }
            if (clientAddressField && prospect.adresse) {
              clientAddressField.value = prospect.adresse;
            }
            if (clientPhoneField && prospect.telephone) {
              clientPhoneField.value = prospect.telephone;
            }


            // NE PAS nettoyer sessionStorage ici - il sera utilis√© pour bypasser la validation d'adresse
            // sessionStorage.removeItem('submissionData'); // Sera nettoy√© apr√®s "Compl√©ter la soumission"
            
          } catch (error) {
            error('[ERROR] Erreur lors du parsing des donn√©es prospect:', error);
          }
        } else {
        }
      }, 1000); // D√©lai de 1 seconde pour s'assurer que le DOM est pr√™t
      
    }

    function addEventListeners() {
      // Surface inputs (zone-based)
      document.querySelectorAll('.surface-input').forEach(input => {
        input.addEventListener('input', updateCalculation);
      });

      // Autres travaux inputs
      const autresTravauxIds = ['lavage_main_lineaire', 'lavage_plancher_balcon', 'lavage_portes_fenetres'];
      autresTravauxIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', updateCalculation);
        }
      });

      // Pr√©paration inputs
      const preparationIds = ['grattage_40min', 'grattage_20min', 'grattage_10min', 'grattage_5min', 'poncer_reboucher', 'retouche_primer'];
      preparationIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', updateCalculation);
        }
      });

      // Surface material inputs
      const surfaceMateriaux = ['bardeau_cedre_neuf', 'bardeau_cedre_vieux', 'stucco_faible_relief', 
                               'stucco_fort_relief', 'brique', 'solage_facile', 'solage_difficile'];
      surfaceMateriaux.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', updateCalculation);
        }
      });

      // Special elements inputs
      const specialElements = ['barreaux', 'piliers', 'fenetres_faciles', 'fenetres_moyennes', 'fenetres_difficiles',
                              'volet_plat_simple', 'volet_avec_motifs', 'grande_fenetre_bay', 'portes_faciles',
                              'portes_moyennes', 'portes_difficiles', 'portes_garage_simples', 'portes_garage_difficiles',
                              'moulure_cadre_facile', 'moulure_cadre_moyenne', 'corniches', 'moulures_decoupees',
                              'marches', 'descente_gouttiere', 'cloture_panneau_6x8', 'cloture_avec_treillis',
                              'treillis', 'lucarnes'];

      specialElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', updateCalculation);
        }
      });

      // Product table inputs
      document.addEventListener('change', function(e) {
        if (e.target.hasAttribute('data-field')) {
          // Auto-refresh product selection when table data changes
          refreshProductSelection();
          updateCalculation();
        }
      });

      // Product table input changes (for real-time updates)
      document.addEventListener('input', function(e) {
        if (e.target.hasAttribute('data-field')) {
          // Auto-refresh and save for input changes
          clearTimeout(window.productUpdateTimeout);
          window.productUpdateTimeout = setTimeout(() => {
            refreshProductSelection(); // Auto-refresh list
            saveProductsToStorage();
          }, 300); // Reduced delay for more responsive updates
        }
      });

      // Client info inputs
      document.querySelectorAll('#clientName, #clientAddress, #clientPhone').forEach(input => {
        input.addEventListener('input', function() {
          updateProgress();
        });
      });

      // Parameter inputs - Add listeners to all parameter inputs
      document.querySelectorAll('[id^="param_"]').forEach(input => {
        input.addEventListener('input', updateCalculation);
      });

      // Special calculation inputs
      const thirdCoat = document.getElementById('thirdCoat');
      const profitMargin = document.getElementById('profitMargin');
      const tauxHoraire = document.getElementById('tauxHoraire');
      const profitMarginInt = document.getElementById('profitMarginInt');
      const tauxHoraireInt = document.getElementById('tauxHoraireInt');
      if (thirdCoat) thirdCoat.addEventListener('change', updateCalculation);
      if (profitMargin) profitMargin.addEventListener('input', updateCalculation);
      if (tauxHoraire) tauxHoraire.addEventListener('input', updateCalculation);
      if (profitMarginInt) profitMarginInt.addEventListener('input', updateCalculation);
      if (tauxHoraireInt) tauxHoraireInt.addEventListener('input', updateCalculation);

      // Type de pi√®ce dropdown
      const typePiece = document.getElementById('typePiece');
      if (typePiece) {
        typePiece.addEventListener('change', function() {
          const nomPersonnaliseContainer = document.getElementById('nomPersonnaliseContainer');
          if (this.value === 'custom' || this.value === 'autres') {
            nomPersonnaliseContainer.style.display = 'block';
          } else {
            nomPersonnaliseContainer.style.display = 'none';
          }
        });
      }
    }

// Removed duplicate switchTab function - using the one below

function toggleProductClient(pieceId, isClient) {
  const checkbox = document.getElementById(`product_client_${pieceId}`);
  const nonBtn = document.getElementById(`product_client_non_${pieceId}`);
  const ouiBtn = document.getElementById(`product_client_oui_${pieceId}`);

  if (checkbox && nonBtn && ouiBtn) {
    checkbox.checked = isClient;

    if (isClient) {
      // Style pour "Oui" s√©lectionn√© (btn-primary actif)
      nonBtn.className = "toggle-button-inactive toggle-button-non";
      ouiBtn.className = "toggle-button-active toggle-button-oui";

      // Vider tous les produits de cette pi√®ce
      clearAllProductsForPiece(pieceId);
    } else {
      // Style pour "Non" s√©lectionn√© (par d√©faut - btn-primary actif)
      nonBtn.className = "toggle-button-active toggle-button-non";
      ouiBtn.className = "toggle-button-inactive toggle-button-oui";
    }

    updateCalculation();
  }
}

function clearAllProductsForPiece(pieceId) {
  log('üßπ CLEAR PRODUCTS - D√©but pour piece:', pieceId);

  // 1. Vider les inputs globaux des gallons int√©rieurs
  const lifemasterGallonsGlobal = document.getElementById('gallons_lifemaster_int');
  log('ü•§ Lifemaster gallons global:', lifemasterGallonsGlobal ? `TROUV√â (${lifemasterGallonsGlobal.value})` : 'NON TROUV√â');
  if (lifemasterGallonsGlobal) {
    lifemasterGallonsGlobal.value = '0';
    log('[OK] Lifemaster gallons remis √† 0');
  }

  const gliddenGallonsGlobal = document.getElementById('gallons_glidden_int');
  log('ü•§ Glidden gallons global:', gliddenGallonsGlobal ? `TROUV√â (${gliddenGallonsGlobal.value})` : 'NON TROUV√â');
  if (gliddenGallonsGlobal) {
    gliddenGallonsGlobal.value = '0';
    log('[OK] Glidden gallons remis √† 0');
  }

  // 2. Vider les affichages globaux des co√ªts
  const costProduitsInt = document.getElementById('costProduitsInt');
  log('[MONEY] Cost produits int global:', costProduitsInt ? `TROUV√â (${costProduitsInt.textContent})` : 'NON TROUV√â');
  if (costProduitsInt) {
    costProduitsInt.textContent = formatCurrency(0);
    log('[OK] Cost produits int remis √† $0.00');
  }

  // 3. Forcer les variables costs √† 0
  if (typeof window.costs !== 'undefined') {
    log('[DATA] costs.produits_appliques_int avant:', window.costs.produits_appliques_int);
    window.costs.produits_appliques_int = 0;
    log('[OK] costs.produits_appliques_int remis √† 0');
  }

  // 4. Vider piecesInterieur si elles existent
  if (typeof piecesInterieur !== 'undefined' && piecesInterieur.length > 0) {
    log('üè† Nettoyage de', piecesInterieur.length, 'pi√®ces int√©rieures');
    piecesInterieur.forEach(piece => {
      const id = piece.id;

      // Vider les checkboxes par pi√®ce s'ils existent
      const lifemasterCheckbox = document.getElementById(`product_lifemaster_${id}`);
      if (lifemasterCheckbox) {
        lifemasterCheckbox.checked = false;
        log('[ERROR] D√©coch√© lifemaster pour pi√®ce', id);
      }

      const gliddenCheckbox = document.getElementById(`product_glidden_${id}`);
      if (gliddenCheckbox) {
        gliddenCheckbox.checked = false;
        log('[ERROR] D√©coch√© glidden pour pi√®ce', id);
      }
    });
  }

  // 5. Nettoyer selectedProducts
  const keysToDelete = Object.keys(selectedProducts).filter(key =>
    key.includes('lifemaster') || key.includes('glidden') || key.includes('int')
  );
  log('[DATA] Cl√©s √† supprimer:', keysToDelete);
  keysToDelete.forEach(key => {
    delete selectedProducts[key];
    log('[DELETE] Supprim√©:', key);
  });

  // 6. Mettre √† jour l'affichage
  log('üîÑ Appel updateProductDetailsInt()');
  updateProductDetailsInt();
  log('[OK] CLEAR PRODUCTS - Termin√© pour piece:', pieceId);
}

function updateCalculation() {
  try {
    // Synchroniser tous les affichages de taux horaire avec les param√®tres
    updateAllTauxHoraireDisplays();

    // Mettre √† jour les produits des sections ext√©rieures (seulement si nous sommes dans l'onglet ext√©rieur)
    if (document.getElementById('estimation-tab') && !document.getElementById('estimation-tab').classList.contains('hidden')) {
      // Les produits des sections seront mis √† jour individuellement par leurs event listeners
      // Plus besoin d'appeler updateSectionProductCalculation ici pour √©viter la r√©cursion
    }
    
    const surfaceData = collectNewSurfaceData();
    const selectedProduct = getSelectedProductFromTable();
    // DEBUG selectedProduct supprim√©
    
    // Calculate hours needed
    const hours = calculateNewHours(surfaceData);
    
    // Calculate costs
    const costs = calculateNewCosts(hours, surfaceData, selectedProduct);
    
    // Update progress first
    updateProgress();
    
    // SIMPLE AND CLEAN CALCULATIONS - No complex forcing logic
    
    // Fonction utilitaire pour arrondir √† 2 d√©cimales et √©viter les erreurs de pr√©cision binaire
    const roundTo2 = (num) => {
      // Utilise Number.EPSILON pour compenser les erreurs de pr√©cision binaire
      return Math.round((num + Number.EPSILON) * 100) / 100;
    };

    // Fonction alternative plus robuste pour les calculs mon√©taires
    const roundMoney = (num) => {
      // Convertit en string avec toFixed pour √©viter les erreurs binaires, puis reparse
      return parseFloat(num.toFixed(3));
    };

    // Simple calculation correction
    const tauxHoraire = 43;

    // 1. LAVAGE = hours √ó 43$
    const finalLavage = roundMoney((hours.lavage || 0) * tauxHoraire);

    // 2. PREPARATION = Nouvelle formule compl√®te avec 5 composants

    // Calcul du total des heures de la job pour d√©terminer les heures de nettoyage
    // CORRECTION: inclure les vraies heures de main-d'≈ìuvre peinture (75.6h), pas hours.peinture
    // CORRECTION: ne pas inclure hours.interieur dans le calcul du total job pour nettoyage
    const heuresMainOeuvrePeinture = (hours.revetement || 0) + (hours.corniches_moulures || 0) +
                                   (hours.fenetres_volets || 0) + (hours.portes || 0) +
                                   (hours.balcon || 0) + (hours.cloture || 0) + (hours.autre || 0);
    const totalHeuresJob = roundMoney((hours.lavage || 0) + (hours.preparation || 0) + heuresMainOeuvrePeinture + (hours.primer || 0));


    // 1. D√©placement
    const deplacement = 100;

    // 2. Prix M-O Pr√©paration: (primer + pr√©paration) √ó taux horaire
    // Pr√©server les fractions exactes dans les multiplications
    const heuresPreparationTotales = (hours.primer || 0) + (hours.preparation || 0);
    const prixMOPreparationExact = heuresPreparationTotales * tauxHoraire;
    // Pr√©server les fractions exactes si hours.preparation est une fraction exacte
    const prixMOPreparation = (hours.preparation === 11/3 || hours.preparation === 10/3 || hours.preparation === 5/3 || hours.preparation === 20/3)
      ? prixMOPreparationExact
      : roundMoney(prixMOPreparationExact);

    // 3. Prix primer pour spots: (lavage + pr√©paration) en dollars directs
    // Pr√©server les fractions exactes pour cette composante aussi
    const heuresPrimerSpots = (hours.lavage || 0) + (hours.preparation || 0);
    const prixPrimerSpots = (hours.preparation === 11/3 || hours.preparation === 10/3 || hours.preparation === 5/3)
      ? heuresPrimerSpots
      : roundMoney(heuresPrimerSpots);

    // 4. Prix M-O nettoyage/set up: calcul selon total des heures
    // 0-40h = 4h fixes, > 40h = 10% du total
    let heuresNettoyage = 0;
    if (totalHeuresJob <= 40) {
      heuresNettoyage = 4;
    } else {
      heuresNettoyage = roundMoney(totalHeuresJob * 0.1); // 10%
    }
    const prixMONettoyage = roundMoney(heuresNettoyage * tauxHoraire);

    // 5. Prix Accessoires: TOUTE la MO (lavage + pr√©paration + nettoyage + peinture + 3i√®me couche + fer forg√©) -> arrondi au millier sup√©rieur √∑ 100
    const totalJobDollars = roundMoney(totalHeuresJob * tauxHoraire); // Ancienne valeur (incorrecte)
    const vraieMOPeinture = (costs.peinture || 0) - (costs.fer_forge || 0); // MO peinture SANS fer forg√© pour √©viter double comptage
    const ferForgeDollars = roundMoney((hours.fer_forge || 0) * tauxHoraire);
    const troisiemeCoucheDollars = costs.troisieme_couche_mo || 0;
    const totalPourAccessoires = roundMoney(prixMOPreparation + prixPrimerSpots + prixMONettoyage + vraieMOPeinture + ferForgeDollars + troisiemeCoucheDollars);
    const millierSuperieur = Math.ceil(totalPourAccessoires / 1000) * 1000;
    const prixAccessoires = roundMoney(millierSuperieur / 100);


    // Total pr√©paration (arrondi final)
    const prepBase = roundMoney(deplacement + prixMOPreparation + prixPrimerSpots + prixMONettoyage + prixAccessoires);


    // Calculer le produit fer forg√©
    const ferForgeCost = costs.fer_forge || 0;
    if (ferForgeCost > 0) {
      const params = getCurrentParameterValues();
      const coutProduitExact = ferForgeCost * 0.15; // 15% du co√ªt MO exact
      const prixArrondi = Math.round(coutProduitExact); // Prix arrondi pour affichage
      const gallonsFerForge = Math.ceil(coutProduitExact / params.peinture_fer_forge); // Gallons bas√©s sur prix exact
          }




    // 3. PEINTURE = Use the same logic as display (consistent with updateNewResultsUI)
    // IMPORTANT: Inclure fer_forge dans le calcul des heures
    const endroitsHours = (hours.revetement || 0) + (hours.corniches_moulures || 0) +
                         (hours.fenetres_volets || 0) + (hours.portes || 0) +
                         (hours.balcon || 0) + (hours.cloture || 0) + (hours.autre || 0) +
                         (hours.fer_forge || 0);
    const peintureHours = endroitsHours > 0 ? endroitsHours : (hours.peinture || 0);
    // DEBUG HEURES PAR CAT√âGORIE supprim√©
    // Utiliser la pr√©cision exacte pour le calcul final, pas roundMoney qui limite √† 3 d√©cimales
    const finalPeinture = peintureHours * tauxHoraire;

    // 4. PRODUITS = utiliser la valeur d√©j√† correctement calcul√©e dans costs.produits_appliques
    let finalProduits = costs.produits_appliques || 0;
    // DEBUG finalProduits supprim√©

    // 5. FRAIS ADMINISTRATIFS (1% des co√ªts de base)
    const baseCostsWithoutAccessories = finalLavage + prepBase + finalPeinture + finalProduits;
    const fraisAdministratifs = baseCostsWithoutAccessories * 0.01;

    // PREPARATION FINALE (sans accessoires)
    const finalPreparation = prepBase;

    // Update costs object with corrected values
    costs.lavage = finalLavage;
    costs.preparation = finalPreparation;
    costs.peinture = finalPeinture;
    costs.produits_appliques = finalProduits;
    costs.frais_administratifs = fraisAdministratifs;

    // Calculate subtotal = addition des co√ªts + frais administratifs
    const subtotal = costs.lavage + costs.preparation + costs.peinture + costs.produits_appliques + fraisAdministratifs;

    // Calculate TPS and TVQ
    const tpsAmount = subtotal * 0.05; // 5%
    const tvqAmount = subtotal * 0.09975; // 9.975%
    const subtotalWithTaxes = subtotal + tpsAmount + tvqAmount;

    // La marge de profit est INCLUSE dans le prix, pas ajout√©e
    const profitMarginPercent = parseFloat(document.getElementById('profitMargin')?.value) || 25;
    const total = subtotalWithTaxes; // Le total final = sous-total avec taxes
    const profitAmount = total / (1 + profitMarginPercent / 100) * (profitMarginPercent / 100); // Marge incluse
    
    // DEBUG logs simplifi√©s - plus de valeurs hardcod√©es
    
    // Store final values in costs object for UI updates
    costs.lavage = finalLavage;
    costs.preparation = finalPreparation;
    costs.peinture = finalPeinture;
    costs.produits_appliques = finalProduits;
    costs.subtotal = subtotal;
    costs.tps = tpsAmount;
    costs.tvq = tvqAmount;
    costs.subtotalWithTaxes = subtotalWithTaxes;
    costs.profit = profitAmount;
    costs.total = total;

    // ===== CALCULER LE CO√õT MAIN D'≈íUVRE POUR LES TROISI√àMES COUCHES =====
    costs.troisieme_couche_mo = 0;
    const troisiemeCoucheCheckboxes = document.querySelectorAll('[id^="troisieme_couche_"]');

    // Obtenir les param√®tres actuels
    const paramsForThirdCoat = getCurrentParameterValues();

    troisiemeCoucheCheckboxes.forEach(checkbox => {
      if (checkbox.checked) {
        const sectionId = checkbox.id.replace('troisieme_couche_', '');
        const surfaceSection = calculerSurfaceSection(sectionId);
        if (surfaceSection > 0) {
          const ratio = getRatioForSection(sectionId);
          const heuresBase = surfaceSection / ratio;
          const heuresTroisiemeCouche = heuresBase * 0.7;
          const coutTroisiemeCouche = heuresTroisiemeCouche * paramsForThirdCoat.taux_horaire;
          costs.troisieme_couche_mo += coutTroisiemeCouche;
        }
      }
    });

    
    // S'assurer que costs.peinture existe avant d'ajouter
    if (typeof costs.peinture !== 'number') {
      costs.peinture = 0;
    }

    // Ajouter le co√ªt des troisi√®mes couches √† la main d'≈ìuvre peinture
    costs.peinture += costs.troisieme_couche_mo;

    // ===== FIN CALCUL TROISI√àME COUCHE =====

    // ===== RECALCULER LES ACCESSOIRES MAINTENANT QUE LA 3√àME COUCHE EST INCLUSE =====
    const prixMOPreparationRecalc = 0; // √Ä ajuster selon votre logique
    const prixPrimerSpotsRecalc = 0; // √Ä ajuster selon votre logique
    const prixMONettoyageRecalc = 172; // Valeur du debug pr√©c√©dent
    const totalJobDollarsRecalc = 779.72; // Valeur du debug pr√©c√©dent
    const ferForgeDollarsRecalc = 0; // Pas de fer forg√©
    const troisiemeCoucheDollarsRecalc = costs.troisieme_couche_mo || 0; // Maintenant calcul√© !

    const totalPourAccessoiresRecalc = prixMOPreparationRecalc + prixPrimerSpotsRecalc + prixMONettoyageRecalc + totalJobDollarsRecalc + ferForgeDollarsRecalc + troisiemeCoucheDollarsRecalc;
    const millierSuperieurRecalc = Math.ceil(totalPourAccessoiresRecalc / 1000) * 1000;
    const prixAccessoiresRecalc = millierSuperieurRecalc / 100;


    // Mettre √† jour costs.preparation avec le nouveau prix accessoires
    const anciennePreparation = costs.preparation;
    const differenceAccessoires = prixAccessoiresRecalc - 10; // Diff√©rence entre nouveau ($20) et ancien ($10)
    costs.preparation = anciennePreparation + differenceAccessoires;


    // Mettre √† jour l'affichage de la pr√©paration
    if (document.getElementById('costPreparation')) {
      document.getElementById('costPreparation').textContent = formatCurrency(costs.preparation);
    }
    // ===== FIN RECALCUL ACCESSOIRES =====

    // Log r√©capitulatif des composants pr√©paration avant mise √† jour UI

    // Update UI APR√àS avoir corrig√© les valeurs
    updateNewResultsUI(costs, hours, selectedProduct, surfaceData);
    
    // FORCER DIRECTEMENT les valeurs dans les √©l√©ments HTML - utiliser costs.peinture qui inclut la 3√®me couche
    if (document.getElementById('costPeinture')) {
      document.getElementById('costPeinture').textContent = formatCurrency(costs.peinture);
    }
    if (document.getElementById('costProduits')) {
      document.getElementById('costProduits').textContent = formatCurrency(finalProduits);
    }
    if (document.getElementById('fraisAdministratifs')) {
      document.getElementById('fraisAdministratifs').textContent = formatCurrency(fraisAdministratifs);
    }
    // SOUS-TOTAL = recalculer les produits en temps r√©el pour avoir la valeur exacte
    const produitsCoutActuel = Object.values(selectedProducts).reduce((sum, product) => sum + product.total, 0);

    // Ajouter les primers "surface compl√®te" qui ne sont pas dans selectedProducts
    const primerCostActuel = getSelectedPrimerProducts();

    const sousTotal_SIMPLE = costs.lavage + costs.preparation + costs.peinture + produitsCoutActuel + primerCostActuel + fraisAdministratifs;

    // FORCER dans l'objet costs pour que les autres fonctions utilisent la bonne valeur
    costs.subtotal = sousTotal_SIMPLE;
    
    // ANCIEN SYST√àME D√âSACTIV√â - le sous-total est maintenant g√©r√© par updateSubtotal()
    
    
    // Recalculer les produits s√©lectionn√©s quand les surfaces changent
    recalculateSelectedProducts();

    // Mettre √† jour la section d√©tail des produits
    updateProductDetails();
    updateProductDetailsInt();

    // Mettre √† jour le sous-total apr√®s que tous les calculs soient termin√©s
    setTimeout(() => {
      updateSubtotal();
    }, 100);

    // ===== LOGS D√âTAILL√âS DES CALCULS √Ä L'OUVERTURE =====
    console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üìä D√âTAIL COMPLET DES CALCULS - OUVERTURE DE PAGE');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

    console.log('üßÆ HEURES DE TRAVAIL:');
    console.log('  ‚îú‚îÄ Lavage:', (hours.lavage || 0).toFixed(2), 'h');
    console.log('  ‚îú‚îÄ Pr√©paration:', (hours.preparation || 0).toFixed(2), 'h');
    console.log('  ‚îú‚îÄ Primer:', (hours.primer || 0).toFixed(2), 'h');
    console.log('  ‚îú‚îÄ Rev√™tement:', (hours.revetement || 0).toFixed(2), 'h');
    console.log('  ‚îú‚îÄ Corniches/Moulures:', (hours.corniches_moulures || 0).toFixed(2), 'h');
    console.log('  ‚îú‚îÄ Fen√™tres/Volets:', (hours.fenetres_volets || 0).toFixed(2), 'h');
    console.log('  ‚îú‚îÄ Portes:', (hours.portes || 0).toFixed(2), 'h');
    console.log('  ‚îú‚îÄ Balcon:', (hours.balcon || 0).toFixed(2), 'h');
    console.log('  ‚îú‚îÄ Cl√¥ture:', (hours.cloture || 0).toFixed(2), 'h');
    console.log('  ‚îú‚îÄ Autre:', (hours.autre || 0).toFixed(2), 'h');
    console.log('  ‚îú‚îÄ Fer forg√©:', (hours.fer_forge || 0).toFixed(2), 'h');
    console.log('  ‚îú‚îÄ Int√©rieur:', (hours.interieur || 0).toFixed(2), 'h');
    console.log('  ‚îî‚îÄ TOTAL JOB:', totalHeuresJob.toFixed(2), 'h\n');

    console.log('üí∞ CO√õTS MAIN D\'≈íUVRE (Taux horaire: ' + tauxHoraire + '$/h):');
    console.log('  ‚îú‚îÄ Lavage:', finalLavage.toFixed(2), '$ = (' + (hours.lavage || 0).toFixed(2) + 'h √ó ' + tauxHoraire + '$/h)');
    console.log('  ‚îú‚îÄ Pr√©paration TOTALE:', costs.preparation.toFixed(2), '$');
    console.log('  ‚îÇ  ‚îú‚îÄ D√©placement:', deplacement.toFixed(2), '$');
    console.log('  ‚îÇ  ‚îú‚îÄ Prix M-O Pr√©paration:', prixMOPreparation.toFixed(2), '$ = (' + heuresPreparationTotales.toFixed(2) + 'h √ó ' + tauxHoraire + '$/h)');
    console.log('  ‚îÇ  ‚îú‚îÄ Prix primer spots:', prixPrimerSpots.toFixed(2), '$ = (' + heuresPrimerSpots.toFixed(2) + 'h lavage+prep)');
    console.log('  ‚îÇ  ‚îú‚îÄ Prix M-O Nettoyage:', prixMONettoyage.toFixed(2), '$ = (' + heuresNettoyage.toFixed(2) + 'h √ó ' + tauxHoraire + '$/h)');
    console.log('  ‚îÇ  ‚îî‚îÄ Prix Accessoires:', prixAccessoiresRecalc.toFixed(2), '$ = (arrondi ' + millierSuperieurRecalc + ' √∑ 100)');
    console.log('  ‚îú‚îÄ Peinture (incl. 3√®me couche):', costs.peinture.toFixed(2), '$');
    console.log('  ‚îÇ  ‚îú‚îÄ Main d\'≈ìuvre peinture:', vraieMOPeinture.toFixed(2), '$');
    console.log('  ‚îÇ  ‚îú‚îÄ Fer forg√©:', costs.fer_forge.toFixed(2), '$');
    console.log('  ‚îÇ  ‚îî‚îÄ 3√®me couche:', costs.troisieme_couche_mo.toFixed(2), '$');
    console.log('  ‚îî‚îÄ TOTAL M-O:', (costs.lavage + costs.preparation + costs.peinture).toFixed(2), '$\n');

    console.log('üé® PRODUITS:');
    console.log('  ‚îú‚îÄ Produits s√©lectionn√©s:', produitsCoutActuel.toFixed(2), '$');
    console.log('  ‚îú‚îÄ Primers surface compl√®te:', primerCostActuel.toFixed(2), '$');
    console.log('  ‚îî‚îÄ TOTAL PRODUITS:', (produitsCoutActuel + primerCostActuel).toFixed(2), '$\n');

    console.log('üìã FRAIS ADMINISTRATIFS:', fraisAdministratifs.toFixed(2), '$\n');

    console.log('üíµ SOUS-TOTAL:', sousTotal_SIMPLE.toFixed(2), '$');
    console.log('   = Lavage + Pr√©paration + Peinture + Produits + Frais Admin');
    console.log('   = ' + costs.lavage.toFixed(2) + ' + ' + costs.preparation.toFixed(2) + ' + ' + costs.peinture.toFixed(2) + ' + ' + (produitsCoutActuel + primerCostActuel).toFixed(2) + ' + ' + fraisAdministratifs.toFixed(2) + '\n');

    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
    // ===== FIN LOGS D√âTAILL√âS =====

    // ===== AUTO-SAVE =====
    // D√©clencher l'auto-save apr√®s chaque calcul (si activ√© et projet existant)
    if (typeof triggerAutoSave === 'function') {
      triggerAutoSave();
    }

  } catch (error) {
    error('Erreur de calcul:', error);
  }
}

// Stockage des produits s√©lectionn√©s
let selectedProducts = {};

// Tracker le projet actuellement charg√©
let currentLoadedProjectId = null;
let isLoadingProject = false; // Flag pour d√©sactiver les notifications et le scroll pendant le chargement

function selectProduct(sectionId, productType, productName, coverage, price, event) {
  const productKey = `${productType}_${sectionId}`;
  const productCard = event.target.closest('.product-card');

  // Si on s√©lectionne "Produit client", d√©s√©lectionner tous les autres produits de cette section
  if (productType === 'produit_client') {
    // Trouver tous les produits de cette section et les d√©s√©lectionner
    Object.keys(selectedProducts).forEach(key => {
      if (key.endsWith(`_${sectionId}`) && !key.startsWith('produit_client_')) {
        delete selectedProducts[key];

        // Enlever le style visuel des autres produits
        const otherProductCards = document.querySelectorAll(`[onclick*="'${sectionId}'"] .product-card`);
        otherProductCards.forEach(card => {
          if (!card.closest('[onclick*="produit_client"]')) {
            card.style.backgroundColor = '';
            card.style.setProperty('border', '2px solid var(--border-dark)', 'important');
            card.classList.remove('selected');
          }
        });
      }
    });
  }

  // V√©rifier si le produit est d√©j√† s√©lectionn√©
  if (selectedProducts[productKey]) {
    // D√©s√©lectionner le produit
    delete selectedProducts[productKey];

    // Feedback visuel - enlever la s√©lection
    productCard.style.backgroundColor = '';
    productCard.style.setProperty('border', '2px solid var(--border-dark)', 'important');
    productCard.classList.remove('selected');

    showNotification(`${productName} d√©s√©lectionn√©`, 'info');
  } else {
    // Calculer la surface totale de la section
    const surfaceTotal = calculerSurfaceSection(sectionId);

    if (surfaceTotal > 0) {
      // Obtenir le facteur deuxi√®me couche
      const params = getCurrentParameterValues();
      const facteurDeuxiemeCouche = params.facteur_deuxieme_couche || 0.7;

      // V√©rifier si la troisi√®me couche est activ√©e pour cette section
      const troisiemeCoucheCheckbox = document.getElementById(`troisieme_couche_${sectionId}`);
      const hasTroisiemeCouche = troisiemeCoucheCheckbox && troisiemeCoucheCheckbox.checked;

      // Calculer avec facteur deuxi√®me couche: surface √ó (1 + facteur)
      let surfaceTotal2Couches = surfaceTotal * (1 + facteurDeuxiemeCouche);

      // Ajouter troisi√®me couche si activ√©e
      let surfaceTotalFinal = surfaceTotal2Couches;
      if (hasTroisiemeCouche) {
        const surfaceTroisiemeCouche = surfaceTotal * facteurDeuxiemeCouche; // M√™me facteur que 2i√®me couche
        surfaceTotalFinal += surfaceTroisiemeCouche;
      }

      // NOUVELLE LOGIQUE: V√©rifier si c'est un √©l√©ment en quantit√©
      let gallonsNeeded;
      const isQuantityBasedElement = sectionId.includes('panneau_verticales_facile') || sectionId.includes('panneau_verticales_moyenne') ||
                                   sectionId.includes('panneau_verticales_difficile') || sectionId.includes('rampes_barreau_simple') ||
                                   sectionId.includes('marches_balcon') || sectionId.includes('piliers') ||
                                   sectionId.includes('mains_courantes') || sectionId.includes('pergola') || sectionId.includes('treillis') ||
                                   sectionId.includes('fascia') || sectionId.includes('corniche') ||
                                   sectionId.includes('fenetre_sous_sol') || sectionId.includes('fenetre_facile_cadre') ||
                                   sectionId.includes('fenetre_moyenne') || sectionId.includes('fenetre_difficile') ||
                                   sectionId.includes('fenetre_3_6_carreaux') || sectionId.includes('fenetre_carreaux_6plus') ||
                                   sectionId.includes('volet_plat_simple') || sectionId.includes('volet_avec_motifs') ||
                                   sectionId.includes('grande_fenetre_bay') || sectionId.includes('porte_facile') ||
                                   sectionId.includes('porte_moyenne') || sectionId.includes('porte_difficile') ||
                                   sectionId.includes('porte_garage') ||
                                   sectionId.includes('moulure_cadre_porte_facile') || sectionId.includes('moulure_cadre_porte_moyenne') ||
                                   sectionId.includes('moulure_cadre_porte_difficile') || sectionId.includes('moulure_porte_garage') ||
                                   sectionId.includes('carreaux_portes_cadres') ||
                                   sectionId.includes('lucarne_facile') || sectionId.includes('lucarne_difficile');


      if (isQuantityBasedElement) {
        // Pour les √©l√©ments en quantit√©, utiliser les ratios gallons sp√©ciaux
        let ratioGallon;
        if (sectionId.includes('panneau_verticales_facile')) {
          ratioGallon = params.panneau_verticales_facile_gallon || 6;
        } else if (sectionId.includes('panneau_verticales_moyenne')) {
          ratioGallon = params.panneau_verticales_moyenne_gallon || 5;
        } else if (sectionId.includes('panneau_verticales_difficile')) {
          ratioGallon = params.panneau_verticales_difficile_gallon || 5;
        } else if (sectionId.includes('rampes_barreau_simple')) {
          ratioGallon = params.barreaux_gallon || 135;
        } else if (sectionId.includes('marches_balcon')) {
          ratioGallon = params.marches_gallon || 20;
        } else if (sectionId.includes('rampes_barreau')) {
          ratioGallon = params.barreaux_gallon || 135;
        } else if (sectionId.includes('piliers')) {
          ratioGallon = params.piliers_gallon || 20;
        } else if (sectionId.includes('mains_courantes')) {
          ratioGallon = params.mains_courantes_gallon || 400;
        } else if (sectionId.includes('pergola')) {
          ratioGallon = params.pergola_gallon || 20;
        } else if (sectionId.includes('treillis')) {
          ratioGallon = params.treillis_gallon || 200;
        } else if (sectionId.includes('fascia_plate_1er')) {
          ratioGallon = 400;
        } else if (sectionId.includes('fascia_complexe_2e')) {
          ratioGallon = 400;
        } else if (sectionId.includes('corniche')) {
          ratioGallon = 200;
        } else if (sectionId.includes('fenetre_sous_sol')) {
          ratioGallon = params.fenetre_sous_sol_gallon || 35;
        } else if (sectionId.includes('fenetre_facile_cadre')) {
          ratioGallon = params.fenetre_facile_cadre_gallon || 35;
        } else if (sectionId.includes('fenetre_moyenne')) {
          ratioGallon = params.fenetre_moyenne_gallon || 35;
        } else if (sectionId.includes('fenetre_difficile')) {
          ratioGallon = params.fenetre_difficile_gallon || 35;
        } else if (sectionId.includes('fenetre_3_6_carreaux')) {
          ratioGallon = 35;
        } else if (sectionId.includes('fenetre_carreaux_6plus')) {
          ratioGallon = 35;
        } else if (sectionId.includes('volet_plat_simple')) {
          ratioGallon = params.volet_plat_simple_gallon || 20;
        } else if (sectionId.includes('volet_avec_motifs')) {
          ratioGallon = params.volet_avec_motifs_gallon || 20;
        } else if (sectionId.includes('grande_fenetre_bay')) {
          ratioGallon = params.grande_fenetre_bay_gallon || 35;
        } else if (sectionId.includes('moulure_cadre_porte_facile')) {
          ratioGallon = params.moulure_cadre_porte_facile_gallon || 35;
        } else if (sectionId.includes('moulure_cadre_porte_moyenne')) {
          ratioGallon = params.moulure_cadre_porte_moyenne_gallon || 35;
        } else if (sectionId.includes('moulure_cadre_porte_difficile')) {
          ratioGallon = params.moulure_cadre_porte_difficile_gallon || 35;
        } else if (sectionId.includes('moulure_porte_garage_facile')) {
          ratioGallon = params.moulure_porte_garage_facile_gallon || 35;
        } else if (sectionId.includes('moulure_porte_garage_moyen')) {
          ratioGallon = params.moulure_porte_garage_moyen_gallon || 35;
        } else if (sectionId.includes('moulure_porte_garage_difficile')) {
          ratioGallon = params.moulure_porte_garage_difficile_gallon || 35;
        } else if (sectionId.includes('porte_facile')) {
          ratioGallon = params.porte_facile_gallon || 20;
        } else if (sectionId.includes('porte_moyenne')) {
          ratioGallon = params.porte_moyenne_gallon || 20;
        } else if (sectionId.includes('porte_difficile')) {
          ratioGallon = params.porte_difficile_gallon || 20;
        } else if (sectionId.includes('porte_garage_simple')) {
          ratioGallon = params.porte_garage_simple_gallon || 10;
        } else if (sectionId.includes('porte_garage_difficile')) {
          ratioGallon = params.porte_garage_difficile_gallon || 10;
        } else if (sectionId.includes('porte_garage')) {
          ratioGallon = params.portes_garage_gallon || 10;
        } else if (sectionId.includes('carreaux_portes_cadres')) {
          ratioGallon = params.carreaux_portes_cadres_gallon || 35;
        } else if (sectionId.includes('lucarne_facile') || sectionId.includes('lucarne_difficile')) {
          ratioGallon = params.lucarnes_gallon || 8;
        } else {
          ratioGallon = coverage; // fallback
        }

        // Calculer gallons: quantit√© √∑ ratio √ó facteur couches
        const quantite = surfaceTotal; // pour les quantit√©s, surfaceTotal est en fait la quantit√©
        const gallons1ereCouche = quantite / ratioGallon;
        const gallons2emeCouche = gallons1ereCouche * facteurDeuxiemeCouche;
        gallonsNeeded = gallons1ereCouche + gallons2emeCouche;

        log(`[DEBUG] CALCUL QUANTIT√â - ${sectionId}:`);
        log(`   Quantit√©: ${quantite}`);
        log(`   Ratio gallon: ${ratioGallon}`);
        log(`   Facteur 2√®me couche: ${facteurDeuxiemeCouche}`);
        log(`   1√®re couche: ${quantite} / ${ratioGallon} = ${gallons1ereCouche.toFixed(6)} gal`);
        log(`   2√®me couche: ${gallons1ereCouche.toFixed(6)} √ó ${facteurDeuxiemeCouche} = ${gallons2emeCouche.toFixed(6)} gal`);
        log(`   Total avant arrondi: ${gallonsNeeded.toFixed(6)} gal`);
        log(`   Total arrondi: ${Math.ceil(gallonsNeeded)} gal`);

        if (hasTroisiemeCouche) {
          const gallons3emeCouche = gallons1ereCouche * facteurDeuxiemeCouche;
          gallonsNeeded += gallons3emeCouche;
          log(`   + 3√®me couche: ${gallons3emeCouche.toFixed(6)} gal`);
          log(`   Total avec 3√®me: ${gallonsNeeded.toFixed(6)} gal`);
        }

      } else {
        // Pour les √©l√©ments en surface, utiliser la logique avec ratio
        const ratio = getRatioForElement(sectionId);
        gallonsNeeded = surfaceTotalFinal / (coverage * ratio);
      }

      const gallons = Math.ceil(gallonsNeeded); // Arrondi pour affichage seulement
      const totalCost = gallons * price;

      // Stocker le produit s√©lectionn√© avec valeur exacte
      selectedProducts[productKey] = {
        name: productName,
        quantity: gallons, // Arrondi pour affichage individuel
        gallonsExact: gallonsNeeded, // Valeur exacte pour calcul total
        price: price,
        total: totalCost
      };

      // Feedback visuel - marquer comme s√©lectionn√©
      productCard.style.backgroundColor = '#065f46';
      productCard.style.setProperty('border', '2px solid #10b981', 'important');
      productCard.classList.add('selected');

      showNotification(`${productName} s√©lectionn√© - ${gallons} gal`, 'success');
    } else {
      showNotification('Veuillez d\'abord saisir les surfaces de cette section', 'warning');
    }
  }

  // Mettre √† jour l'affichage
  updateProductDetails();
  updateCalculation();
}

function recalculateSelectedProducts() {

  // Recalculer tous les produits s√©lectionn√©s quand les surfaces changent
  Object.keys(selectedProducts).forEach(productKey => {

    // Extraire productType et sectionId du productKey
    // Format: dulux_huile_st_endroit_1_revetement_1234567
    let productType = '';
    let sectionId = '';

    if (productKey.includes('dulux_huile_st')) {
      productType = 'dulux_huile_st';
      sectionId = productKey.substring(productType.length + 1);
    } else if (productKey.includes('dulux_hybride_opq')) {
      productType = 'dulux_hybride_opq';
      sectionId = productKey.substring(productType.length + 1);
    } else if (productKey.includes('dulux_email_planchers')) {
      productType = 'dulux_email_planchers';
      sectionId = productKey.substring(productType.length + 1);
    } else if (productKey.includes('sikkens_st')) {
      productType = 'sikkens_st';
      sectionId = productKey.substring(productType.length + 1);
    } else if (productKey.includes('diamant')) {
      productType = 'diamant';
      sectionId = productKey.substring(productType.length + 1);
    } else if (productKey.includes('produit_client')) {
      productType = 'produit_client';
      sectionId = productKey.substring(productType.length + 1);
    }

    if(productKey.includes('fenetre_3_6_carreaux') || productKey.includes('fenetre_carreaux_6plus')) {
      log(`\n[DEBUG] RECALCUL - ${productKey}:`);
      log(`   sectionId extrait: "${sectionId}"`);
      log(`   productType: "${productType}"`);
    }

    const product = selectedProducts[productKey];
    const surfaceTotal = calculerSurfaceSection(sectionId);

    if(productKey.includes('fenetre_3_6_carreaux') || productKey.includes('fenetre_carreaux_6plus')) {
      log(`   surfaceTotal: ${surfaceTotal}`);
    }


    if (surfaceTotal > 0) {
      // Obtenir le facteur deuxi√®me couche
      const params = getCurrentParameterValues();
      const facteurDeuxiemeCouche = params.facteur_deuxieme_couche || 0.7;

      // V√©rifier si la troisi√®me couche est activ√©e pour cette section
      const troisiemeCoucheCheckbox = document.getElementById(`troisieme_couche_${sectionId}`);
      const hasTroisiemeCouche = troisiemeCoucheCheckbox && troisiemeCoucheCheckbox.checked;

      // Calculer avec facteur deuxi√®me couche
      let surfaceTotal2Couches = surfaceTotal * (1 + facteurDeuxiemeCouche);

      // Ajouter troisi√®me couche si activ√©e
      let surfaceTotalFinal = surfaceTotal2Couches;
      if (hasTroisiemeCouche) {
        const surfaceTroisiemeCouche = surfaceTotal * facteurDeuxiemeCouche;
        surfaceTotalFinal += surfaceTroisiemeCouche;
      }

      // Recalculer les gallons et le co√ªt
      let coverage = 200; // valeur par d√©faut
      if (product.name.includes('Dulux huile ST') || product.name.includes('Dulux hybride OPQ')) coverage = 200;
      else if (product.name.includes('Dulux √©mail planchers') || product.name.includes('Diamant')) coverage = 350;
      else if (product.name.includes('Sikkens ST')) coverage = 200;
      else if (product.name.includes('Produit client')) coverage = 300;

      // NOUVELLE LOGIQUE: V√©rifier si c'est un √©l√©ment en quantit√© (m√™me que selectProduct)
      let gallonsNeeded;
      const isQuantityBasedElement = sectionId.includes('panneau_verticales_facile') || sectionId.includes('panneau_verticales_moyenne') ||
                                   sectionId.includes('panneau_verticales_difficile') || sectionId.includes('rampes_barreau_simple') ||
                                   sectionId.includes('marches_balcon') || sectionId.includes('piliers') ||
                                   sectionId.includes('mains_courantes') || sectionId.includes('pergola') || sectionId.includes('treillis') ||
                                   sectionId.includes('fascia') || sectionId.includes('corniche') ||
                                   sectionId.includes('fenetre_sous_sol') || sectionId.includes('fenetre_facile_cadre') ||
                                   sectionId.includes('fenetre_moyenne') || sectionId.includes('fenetre_difficile') ||
                                   sectionId.includes('fenetre_3_6_carreaux') || sectionId.includes('fenetre_carreaux_6plus') ||
                                   sectionId.includes('volet_plat_simple') || sectionId.includes('volet_avec_motifs') ||
                                   sectionId.includes('grande_fenetre_bay') || sectionId.includes('porte_facile') ||
                                   sectionId.includes('porte_moyenne') || sectionId.includes('porte_difficile') ||
                                   sectionId.includes('porte_garage') ||
                                   sectionId.includes('moulure_cadre_porte_facile') || sectionId.includes('moulure_cadre_porte_moyenne') ||
                                   sectionId.includes('moulure_cadre_porte_difficile') || sectionId.includes('moulure_porte_garage') ||
                                   sectionId.includes('carreaux_portes_cadres') ||
                                   sectionId.includes('lucarne_facile') || sectionId.includes('lucarne_difficile');


      if (isQuantityBasedElement) {
        // Pour les √©l√©ments en quantit√©, utiliser les ratios gallons sp√©ciaux
        let ratioGallon;
        if (sectionId.includes('panneau_verticales_facile')) {
          ratioGallon = params.panneau_verticales_facile_gallon || 6;
        } else if (sectionId.includes('panneau_verticales_moyenne')) {
          ratioGallon = params.panneau_verticales_moyenne_gallon || 5;
        } else if (sectionId.includes('panneau_verticales_difficile')) {
          ratioGallon = params.panneau_verticales_difficile_gallon || 5;
        } else if (sectionId.includes('rampes_barreau_simple')) {
          ratioGallon = params.barreaux_gallon || 135;
        } else if (sectionId.includes('marches_balcon')) {
          ratioGallon = params.marches_gallon || 20;
        } else if (sectionId.includes('rampes_barreau')) {
          ratioGallon = params.barreaux_gallon || 135;
        } else if (sectionId.includes('piliers')) {
          ratioGallon = params.piliers_gallon || 20;
        } else if (sectionId.includes('mains_courantes')) {
          ratioGallon = params.mains_courantes_gallon || 400;
        } else if (sectionId.includes('pergola')) {
          ratioGallon = params.pergola_gallon || 20;
        } else if (sectionId.includes('treillis')) {
          ratioGallon = params.treillis_gallon || 200;
        } else if (sectionId.includes('fascia_plate_1er')) {
          ratioGallon = 400;
        } else if (sectionId.includes('fascia_complexe_2e')) {
          ratioGallon = 400;
        } else if (sectionId.includes('corniche')) {
          ratioGallon = 200;
        } else if (sectionId.includes('fenetre_sous_sol')) {
          ratioGallon = params.fenetre_sous_sol_gallon || 35;
        } else if (sectionId.includes('fenetre_facile_cadre')) {
          ratioGallon = params.fenetre_facile_cadre_gallon || 35;
        } else if (sectionId.includes('fenetre_moyenne')) {
          ratioGallon = params.fenetre_moyenne_gallon || 35;
        } else if (sectionId.includes('fenetre_difficile')) {
          ratioGallon = params.fenetre_difficile_gallon || 35;
        } else if (sectionId.includes('fenetre_3_6_carreaux')) {
          ratioGallon = 35;
        } else if (sectionId.includes('fenetre_carreaux_6plus')) {
          ratioGallon = 35;
        } else if (sectionId.includes('volet_plat_simple')) {
          ratioGallon = params.volet_plat_simple_gallon || 20;
        } else if (sectionId.includes('volet_avec_motifs')) {
          ratioGallon = params.volet_avec_motifs_gallon || 20;
        } else if (sectionId.includes('grande_fenetre_bay')) {
          ratioGallon = params.grande_fenetre_bay_gallon || 35;
        } else if (sectionId.includes('moulure_cadre_porte_facile')) {
          ratioGallon = params.moulure_cadre_porte_facile_gallon || 35;
        } else if (sectionId.includes('moulure_cadre_porte_moyenne')) {
          ratioGallon = params.moulure_cadre_porte_moyenne_gallon || 35;
        } else if (sectionId.includes('moulure_cadre_porte_difficile')) {
          ratioGallon = params.moulure_cadre_porte_difficile_gallon || 35;
        } else if (sectionId.includes('moulure_porte_garage_facile')) {
          ratioGallon = params.moulure_porte_garage_facile_gallon || 35;
        } else if (sectionId.includes('moulure_porte_garage_moyen')) {
          ratioGallon = params.moulure_porte_garage_moyen_gallon || 35;
        } else if (sectionId.includes('moulure_porte_garage_difficile')) {
          ratioGallon = params.moulure_porte_garage_difficile_gallon || 35;
        } else if (sectionId.includes('porte_facile')) {
          ratioGallon = params.porte_facile_gallon || 20;
        } else if (sectionId.includes('porte_moyenne')) {
          ratioGallon = params.porte_moyenne_gallon || 20;
        } else if (sectionId.includes('porte_difficile')) {
          ratioGallon = params.porte_difficile_gallon || 20;
        } else if (sectionId.includes('porte_garage_simple')) {
          ratioGallon = params.porte_garage_simple_gallon || 10;
        } else if (sectionId.includes('porte_garage_difficile')) {
          ratioGallon = params.porte_garage_difficile_gallon || 10;
        } else if (sectionId.includes('porte_garage')) {
          ratioGallon = params.portes_garage_gallon || 10;
        } else if (sectionId.includes('carreaux_portes_cadres')) {
          ratioGallon = params.carreaux_portes_cadres_gallon || 35;
        } else if (sectionId.includes('lucarne_facile') || sectionId.includes('lucarne_difficile')) {
          ratioGallon = params.lucarnes_gallon || 8;
        } else {
          ratioGallon = coverage; // fallback
        }

        // Calculer gallons: quantit√© √∑ ratio √ó facteur couches
        const quantite = surfaceTotal; // pour les quantit√©s, surfaceTotal est en fait la quantit√©
        const gallons1ereCouche = quantite / ratioGallon;
        const gallons2emeCouche = gallons1ereCouche * facteurDeuxiemeCouche;
        gallonsNeeded = gallons1ereCouche + gallons2emeCouche;

        log(`[DEBUG] CALCUL QUANTIT√â - ${sectionId}:`);
        log(`   Quantit√©: ${quantite}`);
        log(`   Ratio gallon: ${ratioGallon}`);
        log(`   Facteur 2√®me couche: ${facteurDeuxiemeCouche}`);
        log(`   1√®re couche: ${quantite} / ${ratioGallon} = ${gallons1ereCouche.toFixed(6)} gal`);
        log(`   2√®me couche: ${gallons1ereCouche.toFixed(6)} √ó ${facteurDeuxiemeCouche} = ${gallons2emeCouche.toFixed(6)} gal`);
        log(`   Total avant arrondi: ${gallonsNeeded.toFixed(6)} gal`);
        log(`   Total arrondi: ${Math.ceil(gallonsNeeded)} gal`);

        if (hasTroisiemeCouche) {
          const gallons3emeCouche = gallons1ereCouche * facteurDeuxiemeCouche;
          gallonsNeeded += gallons3emeCouche;
          log(`   + 3√®me couche: ${gallons3emeCouche.toFixed(6)} gal`);
          log(`   Total avec 3√®me: ${gallonsNeeded.toFixed(6)} gal`);
        }

      } else {
        // Pour les √©l√©ments en surface, utiliser la logique avec ratio
        const ratio = getRatioForElement(sectionId);
        gallonsNeeded = surfaceTotalFinal / (coverage * ratio);
      }

      const gallons = Math.ceil(gallonsNeeded);
      const totalCost = gallons * product.price;

      // Mettre √† jour le produit avec valeur exacte
      selectedProducts[productKey] = {
        ...product,
        quantity: gallons, // Arrondi pour affichage individuel
        gallonsExact: gallonsNeeded, // Valeur exacte pour calcul total
        total: totalCost
      };

    } else {
    }
  });

  // IMPORTANT: Mettre √† jour l'affichage du co√ªt des produits apr√®s recalcul
  const totalProductCost = Object.values(selectedProducts).reduce((sum, product) => sum + product.total, 0);

  if (document.getElementById('costProduits')) {
    document.getElementById('costProduits').textContent = formatCurrency(totalProductCost);
  }

  // IMPORTANT: Forcer la mise √† jour de costs.produits_appliques pour que finalProduits soit correct
  if (window.costs) {
    window.costs.produits_appliques = totalProductCost;
  }

  // NOTE: updateSubtotal() est appel√© dans updateProductDetails() apr√®s que tous les produits soient mis √† jour
}

function updateSubtotal() {
  setTimeout(() => {
    let lavage_html = 0, prep_html = 0, peinture_html = 0, produits_html = 0;

    if (document.getElementById('costLavage')) {
      const text = document.getElementById('costLavage').textContent;
      lavage_html = parseFloat(text.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
    }
    if (document.getElementById('costPreparation')) {
      const text = document.getElementById('costPreparation').textContent;
      prep_html = parseFloat(text.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
    }
    if (document.getElementById('costPeinture')) {
      const text = document.getElementById('costPeinture').textContent;
      peinture_html = parseFloat(text.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
    }
    if (document.getElementById('costProduits')) {
      const costProduitsText = document.getElementById('costProduits').textContent;
      produits_html = parseFloat(costProduitsText.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
    }

    const baseCostsWithoutAdmin = lavage_html + prep_html + peinture_html + produits_html;
    const nouveauxFraisAdmin = baseCostsWithoutAdmin * 0.01;

    if (document.getElementById('fraisAdministratifs')) {
      document.getElementById('fraisAdministratifs').textContent = formatCurrency(nouveauxFraisAdmin);
    }

    const nouveauSousTotal = lavage_html + prep_html + peinture_html + produits_html + nouveauxFraisAdmin;

    if (document.getElementById('subTotal')) {
      document.getElementById('subTotal').textContent = formatCurrency(nouveauSousTotal);
    }

    if (document.getElementById('subTotalBreakdown')) {
      document.getElementById('subTotalBreakdown').textContent = formatCurrency(nouveauSousTotal);
    }

    updateTaxes(nouveauSousTotal);
    updateTotalCombine(); // Mettre √† jour le total combin√©
  }, 50);
}

function updateTotalCombine() {
  // R√©cup√©rer le total ext√©rieur
  const totalExtText = document.getElementById('subTotal')?.textContent || '$0.00';
  // Remplacer virgule par point avant de parser pour g√©rer "101,00 $"
  const totalExt = parseFloat(totalExtText.replace(/,/g, '.').replace(/[^0-9.-]/g, '')) || 0;

  // R√©cup√©rer le total int√©rieur (d√©j√† calcul√© et affich√©)
  const totalIntText = document.getElementById('subTotalInt')?.textContent || '$0.00';
  const totalInt = parseFloat(totalIntText.replace(/,/g, '.').replace(/[^0-9.-]/g, '')) || 0;

  // Calculer le total combin√© avec minimum de 800$
  const totalCombineCalcule = totalExt + totalInt;
  const totalCombine = Math.max(800, totalCombineCalcule);

  // Calculer les heures combin√©es
  const heuresExtText = document.getElementById('totalHours')?.textContent || '0';
  const heuresExt = parseFloat(heuresExtText.replace(/,/g, '.')) || 0;

  const heuresIntText = document.getElementById('totalHeuresInt')?.textContent || '0';
  const heuresInt = parseFloat(heuresIntText.replace(/,/g, '.')) || 0;

  const heuresCombine = heuresExt + heuresInt;

  // Mettre √† jour l'affichage
  if (document.getElementById('totalCombine')) {
    document.getElementById('totalCombine').textContent = formatCurrency(totalCombine);
  }
  if (document.getElementById('totalCombineInt')) {
    document.getElementById('totalCombineInt').textContent = formatCurrency(totalCombine);
  }
  // Mettre √† jour le bouton total mobile
  if (document.getElementById('mobile-total-value')) {
    document.getElementById('mobile-total-value').textContent = formatCurrency(totalCombine);
  }
  if (document.getElementById('totalHoursCombine')) {
    document.getElementById('totalHoursCombine').textContent = heuresCombine.toFixed(1);
  }
}

function updateTaxes(subtotal) {
  const tpsRate = 0.05; // 5%
  const tvqRate = 0.09975; // 9.975%

  const tpsAmount = subtotal * tpsRate;
  const tvqAmount = subtotal * tvqRate;

  if (document.getElementById('tpsAmount')) {
    document.getElementById('tpsAmount').textContent = formatCurrency(tpsAmount);
  }
  if (document.getElementById('tvqAmount')) {
    document.getElementById('tvqAmount').textContent = formatCurrency(tvqAmount);
  }

  // DEBUG taxes supprim√©
}

function updateProductDetails() {
  const productDetailsContainer = document.getElementById('products-details');
  if (!productDetailsContainer) return;

  // DEBUG updateProductDetails appel√©e supprim√©
  // DEBUG selectedProducts count supprim√©

  // DEBUG d√©taill√© produits supprim√©

  productDetailsContainer.innerHTML = '';

  // Collecter tous les produits s√©lectionn√©s et les regrouper par nom
  const productGroups = {};

  let productCounter = 0;

  // Utiliser selectedProducts au lieu de chercher des inputs
  Object.values(selectedProducts).forEach(product => {
    const productName = product.name;
    productCounter++;

    log(`\n[DEBUG] PRODUIT #${productCounter} - ${productName}:`);
    log(`   gallonsExact: ${product.gallonsExact}`);
    log(`   quantity (arrondi): ${product.quantity}`);
    log(`   Valeur utilis√©e pour somme: ${product.gallonsExact || product.quantity}`);

    // Regrouper par nom de produit
    if (!productGroups[productName]) {
      productGroups[productName] = {
        name: productName,
        quantityExact: 0, // Somme des valeurs exactes
        totalExact: 0, // Co√ªt bas√© sur quantit√© exacte
        price: product.price,
        total: 0 // Initialiser total √† 0 pour √©viter NaN
      };
      log(`   -> NOUVEAU groupe cr√©√© pour ${productName}`);
    }

    const avantAjout = productGroups[productName].quantityExact;
    // Utiliser gallonsExact au lieu de quantity pour le calcul correct
    productGroups[productName].quantityExact += product.gallonsExact || product.quantity;
    const apresAjout = productGroups[productName].quantityExact;

    log(`   -> Cumul ${productName}: ${avantAjout.toFixed(6)} + ${(product.gallonsExact || product.quantity).toFixed(6)} = ${apresAjout.toFixed(6)} gal`);

    // Pour fer forg√©, reset total √† 0 car il sera recalcul√© par la logique fer forg√©
    if (productName === 'Peinture fer forg√©') {
      productGroups[productName].total = 0;
    }
  });

  // Collecter les primers "surface compl√®te" depuis les inputs
  const duluxInputs = document.querySelectorAll('[id^="gallons_dulux_gripper_"]');
  const jammerInputs = document.querySelectorAll('[id^="gallons_jammer_huile_"]');

  duluxInputs.forEach(input => {
    const gallons = parseFloat(input.value) || 0;
    if (gallons > 0) {
      const sectionId = input.id.replace('gallons_dulux_gripper_', '');
      const costSpan = document.getElementById(`cost_dulux_gripper_${sectionId}`);
      const costText = costSpan?.textContent || '$0.00';
      const cost = parseFloat(costText.replace('$', '').replace(',', '')) || 0;
      const pricePerGallon = gallons > 0 ? cost / gallons : 100;

      if (!productGroups['Dulux Gripper']) {
        productGroups['Dulux Gripper'] = {
          name: 'Dulux Gripper',
          quantityExact: 0,
          totalExact: 0,
          price: pricePerGallon,
          total: 0
        };
      }
      productGroups['Dulux Gripper'].quantityExact += gallons;
      productGroups['Dulux Gripper'].total += cost;
    }
  });

  jammerInputs.forEach(input => {
    const gallons = parseFloat(input.value) || 0;
    if (gallons > 0) {
      const sectionId = input.id.replace('gallons_jammer_huile_', '');
      const costSpan = document.getElementById(`cost_jammer_huile_${sectionId}`);
      const costText = costSpan?.textContent || '$0.00';
      const cost = parseFloat(costText.replace('$', '').replace(',', '')) || 0;
      const pricePerGallon = gallons > 0 ? cost / gallons : 100;

      if (!productGroups['Cover Stain']) {
        productGroups['Cover Stain'] = {
          name: 'Cover Stain',
          quantityExact: 0,
          totalExact: 0,
          price: pricePerGallon,
          total: 0
        };
      }
      productGroups['Cover Stain'].quantityExact += gallons;
      productGroups['Cover Stain'].total += cost;
    }
  });

  // DEBUG productGroups supprim√©

  // Calculer les quantit√©s finales arrondies et co√ªts apr√®s regroupement
  let totalProductDetailsCost = 0;
  Object.keys(productGroups).forEach(productName => {
    const group = productGroups[productName];

    // Pour les primers, quantityExact est d√©j√† arrondi (depuis l'input), pas besoin de re-arrondir
    if (productName === 'Dulux Gripper' || productName === 'Cover Stain') {
      group.quantity = group.quantityExact; // D√©j√† arrondi dans updatePrimerCalculation
      // group.total est d√©j√† calcul√© (pas besoin de recalculer)
      log(`   Type: Primer (d√©j√† arrondi)`);
      log(`   Quantit√© finale: ${group.quantity} gal`);
    } else {
      group.quantity = Math.ceil(group.quantityExact); // Arrondir seulement le total final
      log(`   Type: Produit standard`);
      log(`   Arrondi: Math.ceil(${group.quantityExact.toFixed(6)}) = ${group.quantity} gal`);

      // Pour fer forg√©, garder le co√ªt exact au lieu de recalculer, mais arrondir √† l'entier
      if (productName !== 'Peinture fer forg√©') {
        group.total = group.quantity * group.price; // Co√ªt bas√© sur quantit√© arrondie
      } else {
        // Pour fer forg√©, arrondir le montant √† l'entier (548.40$ -> 548$)
        group.total = Math.round(group.total);
      }
    }

    totalProductDetailsCost += group.total; // Additionner pour le total
    // DEBUG FINAL quantity arrondie supprim√©
  });

  // DEBUG total calcul√© supprim√©

  // Produits fer forg√© - v√©rifier si besoin de recalculer
  const ferForgeInSelected = Object.keys(selectedProducts).find(key =>
    selectedProducts[key].name === 'Peinture fer forg√©'
  );
  const needsRecalculation = !ferForgeInSelected ||
    isNaN(selectedProducts[ferForgeInSelected]?.total) ||
    selectedProducts[ferForgeInSelected]?.total === 0;

  // DEBUG fer forg√© logs supprim√©s

  if (needsRecalculation) {
    const ferForgeElements = document.querySelectorAll('[data-fer_forge]');
    // DEBUG ferForgeElements trouv√©s supprim√©
    // NOUVEAU: Chercher et corriger tous les √©l√©ments fer forg√© existants
    function attachFerForgeAttributes() {
    // DEBUG recherche fer forg√© supprim√©

    // Chercher tous les inputs qui pourraient √™tre fer forg√© par leur ID
    const allInputs = document.querySelectorAll('input[type="number"]');
    let foundCount = 0;

    allInputs.forEach(input => {
      let ferForgeType = null;

      if (input.id && input.id.includes('rampe_complexe_tres_rouillee')) {
        ferForgeType = 'rampe_complexe_tres_rouillee';
      } else if (input.id && input.id.includes('rampe_complexe_moyennement_rouillee')) {
        ferForgeType = 'rampe_complexe_moyennement_rouillee';
      } else if (input.id && input.id.includes('rampe_barreaux_droits_verticaux')) {
        ferForgeType = 'rampe_barreaux_droits_verticaux';
      } else if (input.id && input.id.includes('rampe_horizontale_moyenne_tres_rouillee')) {
        ferForgeType = 'rampe_horizontale_moyenne_tres_rouillee';
      } else if (input.id && input.id.includes('rampe_horizontale_facile_moyennement_rouillee')) {
        ferForgeType = 'rampe_horizontale_facile_moyennement_rouillee';
      } else if (input.id && input.id.includes('marches_languettes_rouillees')) {
        ferForgeType = 'marches_languettes_rouillees';
      } else if (input.id && input.id.includes('marches_languettes_tres_rouillees')) {
        ferForgeType = 'marches_languettes_tres_rouillees';
      } else if (input.id && input.id.includes('dessous_balcon_4x8')) {
        ferForgeType = 'dessous_balcon_4x8';
      } else if (input.id && input.id.includes('planchers_industriels')) {
        ferForgeType = 'planchers_industriels';
      } else if (input.id && input.id.includes('marches_industrielles')) {
        ferForgeType = 'marches_industrielles';
      } else if (input.id && input.id.includes('ornements')) {
        ferForgeType = 'ornements';
      } else if (input.id && input.id.includes('poteaux')) {
        ferForgeType = 'poteaux';
      } else if (input.id && input.id.includes('fascia_sous_balcon')) {
        ferForgeType = 'fascia_sous_balcon';
      }

      if (ferForgeType && !input.hasAttribute('data-fer_forge')) {
        input.setAttribute('data-fer_forge', ferForgeType);
        foundCount++;

        // Ajouter updateProductDetails() √† onchange
        const currentOnchange = input.getAttribute('onchange') || '';
        if (!currentOnchange.includes('updateProductDetails()')) {
          input.setAttribute('onchange', currentOnchange + ' updateProductDetails();');
        }
      } else if (input.hasAttribute('data-fer_forge')) {
        const currentType = input.getAttribute('data-fer_forge');

        // Corriger les √©l√©ments avec un mauvais type "endroit_X"
        if (currentType.startsWith('endroit_') && input.value > 0) {
          // Essayer de d√©terminer le bon type √† partir de l'ID ou du contexte
          let correctType = null;
          const inputValue = parseFloat(input.value) || 0;

          // Si c'est un √©l√©ment d'une section fer forg√© avec une valeur, essayer de deviner le type
          if (inputValue === 200) {
            // Probablement rampe complexe tr√®s rouill√©e bas√© sur la valeur de test
            correctType = 'rampe_complexe_tres_rouillee';
            input.setAttribute('data-fer_forge', correctType);
          }
        }

        // DEBUG attach supprim√©
      }
    });

    // DEBUG total attach√© supprim√©
  }

  // Ex√©cuter la correction
  attachFerForgeAttributes();

  // DEBUG FER FORG√â supprim√©

  ferForgeElements.forEach(element => {
    const value = parseFloat(element.value) || 0;
    // DEBUG fer forg√© √©l√©ment supprim√©

    // Ignorer les √©l√©ments des param√®tres (qui commencent par param_)
    if (element.id && element.id.startsWith('param_')) {
      // DEBUG param√®tre ignor√© supprim√©
      return; // Skip les param√®tres
    }

    if (value > 0) {
      // Le type peut √™tre dans data-fer_forge OU data-type selon comment l'√©l√©ment a √©t√© cr√©√©
      let ferForgeType = element.getAttribute('data-fer_forge');
      // Si data-fer_forge contient un ID (commence par "endroit_"), lire data-type
      if (ferForgeType && ferForgeType.startsWith('endroit_')) {
        ferForgeType = element.getAttribute('data-type');
      }
      const params = getCurrentParameterValues();

      // Calculer le co√ªt produit fer forg√©
      let ferForgeCost = 0;
      switch(ferForgeType) {
        case 'rampe_complexe_tres_rouillee':
          ferForgeCost = value * params.rampe_complexe_tres_rouillee;
          break;
        case 'rampe_complexe_moyennement_rouillee':
          ferForgeCost = value * params.rampe_complexe_moyennement_rouillee;
          break;
        case 'rampe_barreaux_droits_verticaux':
          ferForgeCost = value * params.rampe_barreaux_droits_verticaux;
          break;
        case 'rampe_horizontale_moyenne_tres_rouillee':
          ferForgeCost = value * params.rampe_horizontale_moyenne_tres_rouillee;
          break;
        case 'rampe_horizontale_facile_moyennement_rouillee':
          ferForgeCost = value * params.rampe_horizontale_facile_moyennement_rouillee;
          break;
        case 'marches_languettes_rouillees':
          ferForgeCost = value * params.marches_languettes_rouillees;
          break;
        case 'marches_languettes_tres_rouillees':
          ferForgeCost = value * params.marches_languettes_tres_rouillees;
          break;
        case 'dessous_balcon_4x8':
          ferForgeCost = value * params.dessous_balcon_4x8;
          break;
        case 'planchers_industriels':
          ferForgeCost = value * params.planchers_industriels;
          break;
        case 'marches_industrielles':
          ferForgeCost = value * params.marches_industrielles;
          break;
        case 'ornements':
          ferForgeCost = value * params.ornements;
          break;
        case 'poteaux':
          ferForgeCost = value * params.poteaux;
          break;
        case 'fascia_sous_balcon':
          ferForgeCost = value * params.fascia_sous_balcon;
          break;
        default:
          ferForgeCost = 0;
          break;
      }

      if (ferForgeCost > 0) {
        // Calculer le co√ªt produit (15% du co√ªt MO, deuxi√®me couche d√©j√† incluse)
        const coutProduitExact = ferForgeCost * 0.15; // Prix exact
        const prixArrondi = Math.round(coutProduitExact); // Prix arrondi pour affichage
        const gallonsFerForge = Math.ceil(coutProduitExact / params.peinture_fer_forge); // Gallons bas√©s sur prix exact

        const productName = 'Peinture fer forg√©';
        if (!productGroups[productName]) {
          productGroups[productName] = {
            name: productName,
            quantity: 0,
            total: 0,
            price: params.peinture_fer_forge
          };
        }

        productGroups[productName].quantity += gallonsFerForge;
        productGroups[productName].total += prixArrondi; // Utiliser le prix arrondi
      }
    }
  });
  } // Fin du if (!ferForgeAlreadyInSelected)

  // Afficher les produits regroup√©s
  const allProducts = Object.values(productGroups);
  if (allProducts.length === 0) {
    productDetailsContainer.innerHTML = '<p class="text-gray-400 text-sm">Aucun produit s√©lectionn√©</p>';
  } else {
    allProducts.forEach(product => {
      const productDiv = document.createElement('div');
      productDiv.className = 'flex justify-between items-center text-sm';
      // Cr√©er les √©l√©ments s√©par√©ment pour √©viter la concat√©nation
      const leftDiv = document.createElement('div');
      leftDiv.className = 'flex-1';

      const nameDiv = document.createElement('div');
      nameDiv.className = 'text-white';
      // FINAL DISPLAY supprim√©
      nameDiv.textContent = product.name; // Utiliser textContent au lieu d'innerHTML
      // RESULT logs supprim√©s

      const detailDiv = document.createElement('div');
      detailDiv.className = 'text-gray-400 text-xs';

      // Pour fer forg√©, afficher seulement les gallons sans le prix unitaire
      if (product.name === 'Peinture fer forg√©') {
        detailDiv.textContent = `${product.quantity} gal`;
      } else {
        detailDiv.textContent = `${product.quantity} gal √ó ${formatCurrency(product.price)}`;
      }

      const rightDiv = document.createElement('div');
      rightDiv.className = 'text-green-400 font-medium';

      // √âviter NaN pour fer forg√© - afficher 0$ si total est NaN ou undefined
      const totalAmount = isNaN(product.total) || product.total === undefined ? 0 : product.total;
      rightDiv.textContent = formatCurrency(totalAmount);

      leftDiv.appendChild(nameDiv);
      leftDiv.appendChild(detailDiv);
      productDiv.appendChild(leftDiv);
      productDiv.appendChild(rightDiv);
      productDetailsContainer.appendChild(productDiv);
    });

    // Calculer le total final de tous les produits (incluant fer forg√©)
    const finalTotalCost = Object.values(productGroups).reduce((sum, product) => {
      return sum + (isNaN(product.total) ? 0 : product.total);
    }, 0);
    // DEBUG total final supprim√©

    // Mettre √† jour costProduits avec le bon calcul des d√©tails produits
    if (document.getElementById('costProduits')) {
      document.getElementById('costProduits').textContent = formatCurrency(finalTotalCost);
      // DEBUG costProduits supprim√©
    }
  }

  // Mettre √† jour le sous-total avec la nouvelle valeur des produits
  updateSubtotal();
}

function updateProductDetailsInt() {
  const productDetailsContainer = document.getElementById('products-details-int');
  if (!productDetailsContainer) return;

  productDetailsContainer.innerHTML = '';

  // Calculer les produits en excluant les pi√®ces avec "Produit client = Oui"
  let totalLifemasterGallons = 0;
  let totalGliddenGallons = 0;
  let piecesWithProducts = [];

  if (typeof piecesInterieur !== 'undefined' && piecesInterieur.length > 0) {
    for (const piece of piecesInterieur) {
      const clientCheckbox = document.getElementById(`product_client_${piece.id}`);

      if (clientCheckbox && clientCheckbox.checked) {
        log('üö´ Pi√®ce', piece.id, '- Produit client activ√©, exclus du calcul');
        continue; // Skip cette pi√®ce
      }

      // Calculer les produits pour cette pi√®ce seulement
      piecesWithProducts.push(piece);

      // Ici on devrait calculer les gallons pour cette pi√®ce sp√©cifique
      // Pour l'instant, on utilise le calcul global mais on pourrait l'am√©liorer
    }
  }


  // Collecter les donn√©es des produits int√©rieurs depuis le syst√®me automatique
  const productTotals = calculateInteriorProductGallons();

  // V√©rifier aussi les travaux additionnels
  const gallonsPortes = getTotalGallonsPortesInterieures();
  const gallonsMouluresPortes = getTotalGallonsMouluresPortes();
  const gallonsFenetres = getTotalGallonsFenetresInterieures();
  const gallonsDivers = getTotalGallonsDiversInterieurs();
  const appretGlobalData = getAppretGlobalData();

  const hasProducts = (productTotals && (productTotals.lifemasterGallons > 0 || productTotals.gliddenGallons > 0)) ||
                      gallonsPortes > 0 || gallonsMouluresPortes > 0 || gallonsFenetres > 0 || gallonsDivers > 0 ||
                      appretGlobalData.gallons > 0;

  if (!hasProducts) {
    productDetailsContainer.innerHTML = '<p class="text-gray-400 text-sm">Aucun produit s√©lectionn√©</p>';
    // Mettre le co√ªt des produits √† 0 quand il n'y a pas de produits
    if (document.getElementById('costProduitsInt')) {
      document.getElementById('costProduitsInt').textContent = formatCurrency(0);
    }
    // IMPORTANT: Mettre √† jour la variable costs.produits_appliques_int pour le sous-total
    const currentCosts = window.costs || {};
    currentCosts.produits_appliques_int = 0;

    // Fonction helper pour parser les co√ªts du DOM
    const getCost = (id) => {
      const element = document.getElementById(id);
      if (!element) return 0;
      const text = element.textContent.replace(/[$\s]/g, '').replace(',', '.');
      return parseFloat(text) || 0;
    };

    // Recalculer et mettre √† jour le sous-total int√©rieur
    const preparationCost = getCost('costPreparationInt') || 0;
    const mainOeuvreCost = getCost('costMainOeuvreInt') || 0;
    const produitsCost = 0; // Pas de produits dans ce cas
    // Temps de pr√©paration = 2% de (pr√©paration + main d'≈ìuvre + produits)
    const tempsPreparationCost = (preparationCost + mainOeuvreCost + produitsCost) * 0.02;

    const sousTotal = preparationCost + mainOeuvreCost + produitsCost + tempsPreparationCost;
    if (document.getElementById('subTotalInt')) {
      document.getElementById('subTotalInt').textContent = formatCurrency(sousTotal);
    }
    if (document.getElementById('subTotalIntBreakdown')) {
      document.getElementById('subTotalIntBreakdown').textContent = formatCurrency(sousTotal);
    }
    // Mettre √† jour l'affichage du temps de pr√©paration
    if (document.getElementById('fraisAdministratifsInt')) {
      document.getElementById('fraisAdministratifsInt').textContent = formatCurrency(tempsPreparationCost);
    }

    // Recalculer TPS et TVQ
    const tpsInt = sousTotal * 0.05;
    const tvqInt = sousTotal * 0.09975;
    if (document.getElementById('tpsAmountInt')) {
      document.getElementById('tpsAmountInt').textContent = formatCurrency(tpsInt);
    }
    if (document.getElementById('tvqAmountInt')) {
      document.getElementById('tvqAmountInt').textContent = formatCurrency(tvqInt);
    }
    return;
  }

  const allProducts = [];

  // Les gallons des travaux additionnels sont d√©j√† calcul√©s au-dessus

  // Lifemaster (Murs) - s√©par√©
  if (productTotals.gallonsMurs > 0) {
    const lifemasterPrice = parseInt(document.getElementById('cout_lifemaster_int')?.value) || 60;
    const lifemasterCostMurs = productTotals.gallonsMurs * lifemasterPrice;
    allProducts.push({
      name: 'Lifemaster (Murs)',
      quantity: productTotals.gallonsMurs,
      price: lifemasterPrice,
      total: lifemasterCostMurs
    });
  }

  // Glidden 7700 (Plafonds)
  if (productTotals.gallonsPlafonds > 0) {
    const gliddenPrice = parseInt(document.getElementById('cout_glidden_7700_int')?.value) || 60;
    const gliddenCost = productTotals.gallonsPlafonds * gliddenPrice;
    allProducts.push({
      name: 'Glidden 7700 (Plafonds)',
      quantity: productTotals.gallonsPlafonds,
      price: gliddenPrice,
      total: gliddenCost
    });
  }

  // Lifemaster (Moulures) - s√©par√©
  if (productTotals.gallonsMoulures > 0) {
    const lifemasterPrice = parseInt(document.getElementById('cout_lifemaster_int')?.value) || 60;
    const lifemasterCostMoulures = productTotals.gallonsMoulures * lifemasterPrice;
    allProducts.push({
      name: 'Lifemaster (Moulures)',
      quantity: productTotals.gallonsMoulures,
      price: lifemasterPrice,
      total: lifemasterCostMoulures
    });
  }

  // Appr√™t Global
  if (appretGlobalData.gallons > 0) {
    allProducts.push({
      name: 'Appr√™t (Primer)',
      quantity: appretGlobalData.gallons,
      price: parseInt(document.getElementById('cout_primer_int')?.value) || 55,
      total: appretGlobalData.coutProduit
    });
  }

  // Plafonds s√©par√©s - Peinture
  const plafondsSeparesData = getTotalGallonsPlafondsSepares();
  if (plafondsSeparesData.gallonsPeinture > 0) {
    const gliddenPrice = parseInt(document.getElementById('cout_glidden_7700_int')?.value) || 60;
    const gallonsArrondis = Math.ceil(plafondsSeparesData.gallonsPeinture);
    allProducts.push({
      name: 'Glidden 7700 (Plafonds s√©par√©s)',
      quantity: gallonsArrondis,
      price: gliddenPrice,
      total: gallonsArrondis * gliddenPrice
    });
  }

  // Plafonds s√©par√©s - Primer
  if (plafondsSeparesData.gallonsPrimer > 0) {
    const primerPrice = parseInt(document.getElementById('cout_primer_int')?.value) || 55;
    const gallonsArrondis = Math.ceil(plafondsSeparesData.gallonsPrimer);
    allProducts.push({
      name: 'Appr√™t (Plafonds s√©par√©s)',
      quantity: gallonsArrondis,
      price: primerPrice,
      total: gallonsArrondis * primerPrice
    });
  }

  // Travaux additionnels - Portes
  if (gallonsPortes > 0) {
    const lifemasterPrice = parseInt(document.getElementById('cout_lifemaster_int')?.value) || 60;
    allProducts.push({
      name: 'Lifemaster (Portes)',
      quantity: Math.ceil(gallonsPortes), // Arrondir vers le haut
      price: lifemasterPrice,
      total: Math.ceil(gallonsPortes) * lifemasterPrice
    });
  }

  // Travaux additionnels - Moulures de portes
  if (gallonsMouluresPortes > 0) {
    const lifemasterPrice = parseInt(document.getElementById('cout_lifemaster_int')?.value) || 60;
    allProducts.push({
      name: 'Lifemaster (Moulures portes)',
      quantity: Math.ceil(gallonsMouluresPortes),
      price: lifemasterPrice,
      total: Math.ceil(gallonsMouluresPortes) * lifemasterPrice
    });
  }

  // Travaux additionnels - Fen√™tres
  if (gallonsFenetres > 0) {
    const lifemasterPrice = parseInt(document.getElementById('cout_lifemaster_int')?.value) || 60;
    allProducts.push({
      name: 'Lifemaster (Fen√™tres)',
      quantity: Math.ceil(gallonsFenetres),
      price: lifemasterPrice,
      total: Math.ceil(gallonsFenetres) * lifemasterPrice
    });
  }

  // Travaux additionnels - Divers
  if (gallonsDivers > 0) {
    const lifemasterPrice = parseInt(document.getElementById('cout_lifemaster_int')?.value) || 60;
    allProducts.push({
      name: 'Lifemaster (Divers)',
      quantity: Math.ceil(gallonsDivers),
      price: lifemasterPrice,
      total: Math.ceil(gallonsDivers) * lifemasterPrice
    });
  }

  // Cr√©er les √©l√©ments DOM exactement comme dans l'ext√©rieur
  let totalProductCost = 0;
  allProducts.forEach(product => {
    totalProductCost += product.total;

    const productDiv = document.createElement('div');
    productDiv.className = 'flex justify-between items-center text-sm';

    const leftDiv = document.createElement('div');
    leftDiv.className = 'flex-1';

    const nameDiv = document.createElement('div');
    nameDiv.className = 'text-white';
    nameDiv.textContent = product.name;

    const detailDiv = document.createElement('div');
    detailDiv.className = 'text-gray-400 text-xs';
    detailDiv.textContent = `${product.quantity} gal √ó ${formatCurrency(product.price)}`;

    const rightDiv = document.createElement('div');
    rightDiv.className = 'text-green-400 font-medium';
    rightDiv.textContent = formatCurrency(product.total);

    leftDiv.appendChild(nameDiv);
    leftDiv.appendChild(detailDiv);
    productDiv.appendChild(leftDiv);
    productDiv.appendChild(rightDiv);
    productDetailsContainer.appendChild(productDiv);
  });

  // Mettre √† jour le co√ªt total des produits dans l'affichage ET dans la variable costs
  if (document.getElementById('costProduitsInt')) {
    document.getElementById('costProduitsInt').textContent = formatCurrency(totalProductCost);
  }

  // IMPORTANT: Mettre √† jour la variable costs.produits_appliques_int pour le sous-total
  // et recalculer le sous-total int√©rieur
  const currentCosts = window.costs || {};
  currentCosts.produits_appliques_int = totalProductCost;

  // Fonction helper pour parser les co√ªts du DOM
  const getCost = (id) => {
    const element = document.getElementById(id);
    if (!element) return 0;
    const text = element.textContent.replace(/[$\s]/g, '').replace(',', '.');
    return parseFloat(text) || 0;
  };

  // Recalculer et mettre √† jour le sous-total int√©rieur
  const preparationCost = getCost('costPreparationInt') || 0;
  const mainOeuvreCost = getCost('costMainOeuvreInt') || 0;
  const produitsCost = totalProductCost; // Utiliser directement la valeur calcul√©e
  // Temps de pr√©paration = 2% de (pr√©paration + main d'≈ìuvre + produits)
  const tempsPreparationCost = (preparationCost + mainOeuvreCost + produitsCost) * 0.02;

  const sousTotal = preparationCost + mainOeuvreCost + produitsCost + tempsPreparationCost;
  if (document.getElementById('subTotalInt')) {
    document.getElementById('subTotalInt').textContent = formatCurrency(sousTotal);
  }
  if (document.getElementById('subTotalIntBreakdown')) {
    document.getElementById('subTotalIntBreakdown').textContent = formatCurrency(sousTotal);
  }
  // Mettre √† jour l'affichage du temps de pr√©paration
  if (document.getElementById('fraisAdministratifsInt')) {
    document.getElementById('fraisAdministratifsInt').textContent = formatCurrency(tempsPreparationCost);
  }

  // Recalculer TPS et TVQ
  const tpsInt = sousTotal * 0.05;
  const tvqInt = sousTotal * 0.09975;
  if (document.getElementById('tpsAmountInt')) {
    document.getElementById('tpsAmountInt').textContent = formatCurrency(tpsInt);
  }
  if (document.getElementById('tvqAmountInt')) {
    document.getElementById('tvqAmountInt').textContent = formatCurrency(tvqInt);
  }
}

function collectNewSurfaceData() {
  const params = getCurrentParameterValues();
  const surfaceData = {
    endroits: {},
    preparations: {},
    lavages: {},
    totals: {
      lavage_pression: 0,
      lavage_main: 0,
      lavage_main_lineaire: 0,
      lavage_plancher_balcon: 0,
      lavage_portes_fenetres: 0,
      peinture: 0,
      preparation: 0,
      // Totaux int√©rieurs
      lavage_int: 0,
      preparation_int: 0,
      peinture_int: 0
    }
  };

  // Collect dynamic lavage data
  const lavageSections = document.querySelectorAll('[data-lavage]');
  const lavageGroups = {};
  
  // Group inputs by lavage ID
  lavageSections.forEach(input => {
    const lavageId = input.getAttribute('data-lavage');
    if (!lavageGroups[lavageId]) {
      lavageGroups[lavageId] = [];
    }
    lavageGroups[lavageId].push(input);
  });

  // Process each lavage group
  Object.keys(lavageGroups).forEach(lavageId => {
    const inputs = lavageGroups[lavageId];
    const lavageData = {
      type: '',
      sections: {
        avant: 0,
        droit: 0,
        arriere: 0,
        gauche: 0
      },
      total: 0
    };

    inputs.forEach(input => {
      const type = input.getAttribute('data-type');
      const section = input.getAttribute('data-section');
      const value = parseFloat(input.value) || 0;

      if (!lavageData.type) {
        lavageData.type = type;
      }

      lavageData.sections[section] = value;
      lavageData.total += value;
    });

    surfaceData.lavages[lavageId] = lavageData;
    
    // Add to totals by type
    surfaceData.totals[lavageData.type] += lavageData.total;
  });

  // Calculate combined lavage totals
  surfaceData.totals.lavage_pression = surfaceData.totals.lavage_pression || 0;
  surfaceData.totals.lavage_main = (surfaceData.totals.lavage_main || 0) + 
                                   (surfaceData.totals.lavage_main_lineaire || 0) + 
                                   (surfaceData.totals.lavage_plancher_balcon || 0);

  // Collect dynamic endroit data (peinture uniquement)
  const endroitSections = document.querySelectorAll('[data-endroit]');
  const endroitGroups = {};
  
  // Group inputs by endroit ID
  endroitSections.forEach(input => {
    const endroitId = input.getAttribute('data-endroit');
    if (!endroitGroups[endroitId]) {
      endroitGroups[endroitId] = [];
    }
    endroitGroups[endroitId].push(input);
  });

  // Process each endroit group
  Object.keys(endroitGroups).forEach(endroitId => {
    const inputs = endroitGroups[endroitId];
    const endroitData = {
      type: '',
      peinture: 0,
      preparation: 0,
      details: {}
    };

    inputs.forEach(input => {
      const type = input.getAttribute('data-type');
      const option = input.getAttribute('data-option');
      const value = parseFloat(input.value) || 0;

      // Determine endroit type from first input
      if (!endroitData.type && input.closest('[data-endroit]')) {
        const container = input.closest('.box');
        if (container) {
          const header = container.querySelector('.box-header-title');
          if (header) {
            endroitData.type = header.textContent.trim().replace('Peinture - ', '');
          }
        }
      }

      // Categorize the measurement (seulement peinture et pr√©paration maintenant)
      if (type === 'surface' || type === 'largeur' || type === 'hauteur') {
        endroitData.peinture += value;
      } else if (type === 'unite') {
        if (option && option.includes('preparation')) {
          endroitData.preparation += value;
        } else {
          endroitData.peinture += value;
        }
      }

      // Store detailed measurement
      const key = option || type;
      if (!endroitData.details[key]) {
        endroitData.details[key] = 0;
      }
      endroitData.details[key] += value;
    });

    surfaceData.endroits[endroitId] = endroitData;
    
    // Add to totals (seulement peinture)
    surfaceData.totals.peinture += endroitData.peinture;
    surfaceData.totals.preparation += endroitData.preparation;
  });

  // Collect dynamic preparation data
  const preparationSections = document.querySelectorAll('[data-preparation]');
  const preparationGroups = {};
  
  // Group inputs by preparation ID
  preparationSections.forEach(input => {
    const preparationId = input.getAttribute('data-preparation');
    if (!preparationGroups[preparationId]) {
      preparationGroups[preparationId] = [];
    }
    preparationGroups[preparationId].push(input);
  });

  // Process each preparation group
  Object.keys(preparationGroups).forEach(preparationId => {
    const inputs = preparationGroups[preparationId];
    const preparationData = {
      type: '',
      sections: {
        avant: 0,
        droit: 0,
        arriere: 0,
        gauche: 0
      },
      total: 0
    };

    inputs.forEach(input => {
      const type = input.getAttribute('data-type');
      const section = input.getAttribute('data-section');
      const value = parseFloat(input.value) || 0;

      if (!preparationData.type) {
        preparationData.type = type;
      }

      preparationData.sections[section] = value;
      preparationData.total += value;
    });

    surfaceData.preparations[preparationId] = preparationData;
    
    // Add to totals
    surfaceData.totals.preparation += preparationData.total;
  });

  // Collect interior pieces data
  surfaceData.totals.heures_int = {
    preparation: 0,
    appret: 0,
    porte: 0,
    fenetre: 0,
    divers: 0,
    plafond: 0
  };
  
  // Get all interior pieces from DOM
  const piecesInterieur = [];
  const togglePreparations = document.querySelectorAll('[id^="togglePreparation_"]');
  togglePreparations.forEach(toggle => {
    const pieceId = toggle.id.replace('togglePreparation_', '');
    piecesInterieur.push({ id: pieceId });
  });
  
  
  piecesInterieur.forEach(piece => {
    
    // Pr√©paration (seulement si toggle activ√©)
    const preparationCheckbox = document.getElementById(`togglePreparation_${piece.id}`);
    
    if (preparationCheckbox && preparationCheckbox.checked) {
      
      // Collecter toutes les pr√©parations multiples pour cette pi√®ce
      const preparationSelects = document.querySelectorAll(`select[id^="dureePreparation_${piece.id}_"]`);

      preparationSelects.forEach(select => {
        const preparationValue = select.value;
        if (preparationValue) {
          // Utiliser les param√®tres correspondants
          switch(preparationValue) {
            case '0.35':
              surfaceData.totals.heures_int.preparation += params.preparation_lavage || 0.35;
              break;
            case '0.5':
              surfaceData.totals.heures_int.preparation += params.preparation_grattage || 0.5;
              break;
            case '1':
              surfaceData.totals.heures_int.preparation += params.preparation_fry_dex || 1.0;
              break;
            case '2':
              surfaceData.totals.heures_int.preparation += params.preparation_sablage || 2.0;
              break;
            case '5':
              surfaceData.totals.heures_int.preparation += params.preparation_autres || 5.0;
              break;
            case '10':
              surfaceData.totals.heures_int.preparation += params.preparation_autres * 2 || 10.0;
              break;
            default:
              surfaceData.totals.heures_int.preparation += parseFloat(preparationValue) || 0;
          }
        }
      });
    }
    
    // Appr√™t
    const appretCheckbox = document.getElementById(`toggleAppret_${piece.id}`);
    if (appretCheckbox && appretCheckbox.checked) {
      const appretSelect = document.querySelector(`select[data-piece="${piece.id}"][data-type="appret"]`);
      const piedCarre = document.querySelector(`input[data-piece="${piece.id}"][data-type="pied-carre"]`);
      const peintureClient = document.querySelector(`select[data-piece="${piece.id}"][data-type="peinture-client"]`);
      const appretValue = appretSelect ? appretSelect.value : '';
      const piedCarreValue = piedCarre ? parseFloat(piedCarre.value) || 0 : 0;
      const peintureClientValue = peintureClient ? peintureClient.value : '';
      
      if (appretValue && piedCarreValue > 0) {
        // Calculer heures selon type d'appr√™t et surface
        let productivite = 100; // d√©faut
        switch(appretValue) {
          case 'mur_plus': productivite = params.appret_mur_plus_200 || 125; break;
          case 'mur_moins': productivite = params.appret_mur_moins_200 || 100; break;
          case 'plafond_plus': productivite = params.appret_plafond_plus_200 || 125; break;
          case 'plafond_moins': productivite = params.appret_plafond_moins_200 || 100; break;
        }
        
        let heuresAppret = piedCarreValue / productivite;
        
        // Ajuster selon peinture client (si "oui", on ne facture que l'appr√™t, pas la peinture)
        // Pour l'instant, on compte toujours les heures d'appr√™t
        surfaceData.totals.heures_int.appret += heuresAppret;
        
      }
    }
    
    // Porte
    const porteCheckbox = document.getElementById(`togglePorte_${piece.id}`);
    if (porteCheckbox && porteCheckbox.checked) {
      const typePorte = document.querySelector(`select[data-piece="${piece.id}"][data-type="type-porte"]`);
      const nombrePortes = document.querySelector(`select[data-piece="${piece.id}"][data-type="nombre-portes"]`);
      const typeValue = typePorte ? typePorte.value : '';
      const nombre = nombrePortes ? parseInt(nombrePortes.value) || 0 : 0;
      
      if (typeValue && nombre > 0) {
        switch(typeValue) {
          case 'facile': surfaceData.totals.heures_int.porte += nombre * (params.int_porte_facile || 0.5); break;
          case 'moyenne': surfaceData.totals.heures_int.porte += nombre * (params.int_porte_moyenne || 1/1.33); break;
          case 'difficile': surfaceData.totals.heures_int.porte += nombre * (params.int_porte_difficile || 1.0); break;
          case 'francaise': surfaceData.totals.heures_int.porte += nombre * (params.int_porte_francaise || 2.0); break;
          case 'cadres': surfaceData.totals.heures_int.porte += nombre * (params.int_porte_cadres || 0.5); break;
        }
      }
    }
    
    // Fen√™tre
    const fenetreCheckbox = document.getElementById(`toggleFenetre_${piece.id}`);
    if (fenetreCheckbox && fenetreCheckbox.checked) {
      const typeFenetre = document.querySelector(`select[data-piece="${piece.id}"][data-type="type-fenetre"]`);
      const nombreFenetres = document.querySelector(`select[data-piece="${piece.id}"][data-type="nombre-fenetres"]`);
      const typeValue = typeFenetre ? typeFenetre.value : '';
      const nombre = nombreFenetres ? parseInt(nombreFenetres.value) || 0 : 0;
      
      if (typeValue && nombre > 0) {
        switch(typeValue) {
          case 'facile': surfaceData.totals.heures_int.fenetre += nombre * (params.int_fenetre_facile || 0.5); break;
          case 'moyenne': surfaceData.totals.heures_int.fenetre += nombre * (params.int_fenetre_moyenne || 0.75); break;
          case 'difficile': surfaceData.totals.heures_int.fenetre += nombre * (params.int_fenetre_difficile || 1.0); break;
          case 'cadres_faciles': surfaceData.totals.heures_int.fenetre += nombre * (params.int_fenetre_cadres_faciles || 0.5); break;
          case 'cadres_difficiles': surfaceData.totals.heures_int.fenetre += nombre * (params.int_fenetre_cadres_difficiles || 1.0); break;
        }
      }
    }
    
    // Divers
    const diversCheckbox = document.getElementById(`toggleDivers_${piece.id}`);
    if (diversCheckbox && diversCheckbox.checked) {
      const typeDivers = document.querySelector(`select[data-piece="${piece.id}"][data-type="type-divers"]`);
      const nombreDivers = document.querySelector(`select[data-piece="${piece.id}"][data-type="nombre-divers"]`);
      const typeValue = typeDivers ? typeDivers.value : '';
      const nombre = nombreDivers ? parseInt(nombreDivers.value) || 0 : 0;
      
      if (typeValue && nombre > 0) {
        // Heures fix√©es selon le type
        let heuresParItem = 0;
        switch(typeValue) {
          case 'garde_robe': heuresParItem = params.int_garde_robe || 1.0; break;
          case 'calorifere': heuresParItem = params.int_calorifere || 0.5; break;
          case 'radiateur_1h': heuresParItem = params.int_radiateur_1h || 1.0; break;
          case 'radiateur_2h': heuresParItem = params.int_radiateur_2h || 2.0; break;
          case 'marche_escalier': heuresParItem = params.int_marche_escalier || 0.25; break;
          case 'contre_marche': heuresParItem = params.int_contre_marche || 0.25; break;
          case 'interieur_armoire': heuresParItem = params.int_interieur_armoire || 0.5; break;
          case 'complication_05h': heuresParItem = params.int_complication_05h || 0.5; break;
          case 'complication_1h': heuresParItem = params.int_complication_1h || 1.0; break;
          case 'deplacement_05h': heuresParItem = params.int_deplacement_05h || 0.5; break;
          case 'deplacement_1h': heuresParItem = params.int_deplacement_1h || 1.0; break;
          case 'tuyau_chauffage': heuresParItem = params.int_tuyau_chauffage || 0.25; break;
          case 'cadrage': heuresParItem = params.int_cadrage || 0.25; break;
        }
        surfaceData.totals.heures_int.divers += nombre * heuresParItem;
      }
    }
    
    // Plafond √† part
    const plafondCheckbox = document.getElementById(`togglePlafond_${piece.id}`);
    if (plafondCheckbox && plafondCheckbox.checked) {
      const typePlafond = document.querySelector(`select[data-piece="${piece.id}"][data-type="type-plafond"]`);
      const piedsCarres = document.querySelector(`input[data-piece="${piece.id}"][data-type="plafond-pieds-carres"]`);
      const typeValue = typePlafond ? typePlafond.value : '';
      const surface = piedsCarres ? parseFloat(piedsCarres.value) || 0 : 0;
      
      if (typeValue && surface > 0) {
        // Calculer heures selon type de plafond
        switch(typeValue) {
          case 'angle_cathedrale': surfaceData.totals.heures_int.plafond += surface / (params.int_angle_cathedrale || 150); break;
          case 'stucco': surfaceData.totals.heures_int.plafond += surface / (params.int_stucco || 100); break;
          case 'plus_10pi': surfaceData.totals.heures_int.plafond += surface / (params.int_plus_10pi || 120); break;
        }
      }
    }
  });

  // SECTIONS GLOBALES INT√âRIEUR
  
  // Portes Globales (multiples)
  const porteGlobalCheckbox = document.getElementById('togglePorteGlobal');
  if (porteGlobalCheckbox && porteGlobalCheckbox.checked) {
    const containers = document.querySelectorAll('[id^="porteGlobale_"]');
    containers.forEach(container => {
      const id = container.id.split('_')[1];
      const type = document.getElementById(`typePorteGlobal_${id}`)?.value;
      const nombre = parseInt(document.getElementById(`nombrePorteGlobal_${id}`)?.value) || 0;
      
      if (type && nombre > 0) {
        let heuresParPorte = 0;
        switch(type) {
          case 'facile': heuresParPorte = 1/2; break; // 2 portes/h
          case 'moyenne': heuresParPorte = 1/1.33; break; // 1.33 portes/h ‚Üí 1√∑1.33 h/porte
          case 'difficile': heuresParPorte = 1; break; // 1 porte/h
          case 'francaise': heuresParPorte = 2; break; // 0.5 porte/h
          case 'cadre': heuresParPorte = 1/2; break; // 2 cadres/h
        }
        surfaceData.totals.heures_int.porte += nombre * heuresParPorte;
      }
    });
  }
  
  // Fen√™tres Globales (multiples)
  const fenetreGlobalCheckbox = document.getElementById('toggleFenetreGlobal');
  if (fenetreGlobalCheckbox && fenetreGlobalCheckbox.checked) {
    const containers = document.querySelectorAll('[id^="fenetreGlobale_"]');
    containers.forEach(container => {
      const id = container.id.split('_')[1];
      const type = document.getElementById(`typeFenetreGlobal_${id}`)?.value;
      const nombre = parseInt(document.getElementById(`nombreFenetreGlobal_${id}`)?.value) || 0;
      
      if (type && nombre > 0) {
        let heuresParFenetre = 0;
        switch(type) {
          case 'facile': heuresParFenetre = 1/2; break; // 2 fen√™tres/h
          case 'moyenne': heuresParFenetre = 3/4; break; // 1.33 fen√™tres/h = 4/3 fen√™tres/h, donc 3/4 h/fen√™tre
          case 'difficile': heuresParFenetre = 1; break; // 1 fen√™tre/h
          case 'cadre_facile': heuresParFenetre = 1/2; break; // 2 cadres/h
          case 'cadre_difficile': heuresParFenetre = 1; break; // 1 cadre/h
        }
        surfaceData.totals.heures_int.fenetre += nombre * heuresParFenetre;
      }
    });
  }
  
  // Divers Globaux (multiples)
  const diversGlobalCheckbox = document.getElementById('toggleDiversGlobal');
  if (diversGlobalCheckbox && diversGlobalCheckbox.checked) {
    const containers = document.querySelectorAll('[id^="diversGlobal_"]');
    containers.forEach(container => {
      const id = container.id.split('_')[1];
      const type = document.getElementById(`typeDiversGlobal_${id}`)?.value;
      const quantite = parseInt(document.getElementById(`quantiteDiversGlobal_${id}`)?.value) || 0;
      
      if (type && quantite > 0) {
        let heuresParItem = 0;
        switch(type) {
          case 'garde_robe': heuresParItem = 0.5; break;
          case 'calorifere': heuresParItem = 0.25; break;
          case 'radiateur_1h': heuresParItem = 1; break;
          case 'radiateur_2h': heuresParItem = 2; break;
          case 'marche_escalier': heuresParItem = 0.1; break;
          case 'contre_marche': heuresParItem = 0.1; break;
          case 'interieur_armoire': heuresParItem = 0.5; break;
          case 'complication_05h': heuresParItem = 0.5; break;
          case 'complication_1h': heuresParItem = 1; break;
          case 'deplacement_05h': heuresParItem = 0.5; break;
          case 'deplacement_1h': heuresParItem = 1; break;
          case 'installation_05h': heuresParItem = 0.5; break;
          case 'installation_1h': heuresParItem = 1; break;
        }
        surfaceData.totals.heures_int.divers += quantite * heuresParItem;
      }
    });
  }
  
  // Plafonds Globaux (multiples)
  const plafondGlobalCheckbox = document.getElementById('togglePlafondGlobal');
  if (plafondGlobalCheckbox && plafondGlobalCheckbox.checked) {
    const containers = document.querySelectorAll('[id^="plafondGlobal_"]');
    containers.forEach(container => {
      const id = container.id.split('_')[1];
      const surface = parseFloat(document.getElementById(`surfacePlafondGlobal_${id}`)?.value) || 0;
      const couleur = document.getElementById(`couleurPlafondGlobal_${id}`)?.value;
      
      if (surface > 0) {
        const productivity = params.productivite_plafond_int || 400;
        let heures = surface / productivity;
        
        if (couleur === 'couleur') {
          heures *= 1.2; // 20% de plus pour couleur
        }
        
        surfaceData.totals.heures_int.plafond += heures;
      }
    });
  }

  return surfaceData;
}

function getSelectedProductFromTable() {
  const selectedProducts = getSelectedProducts();
  
  if (selectedProducts.length === 0) {
    return { name: 'Aucun produit s√©lectionn√©', coverage: 400, price: 60 };
  }

  // For calculations, use the first selected product as primary
  // (we'll handle multiple products in the cost calculation)
  const primaryProduct = selectedProducts[0];

  return {
    name: primaryProduct.produit,
    coverage: primaryProduct.ratio,
    price: primaryProduct.prix
  };
}

function calculateNewHours(surfaceData) {
  const params = getCurrentParameterValues();

  // Fonction pour arrondir les heures et √©viter les erreurs de pr√©cision binaire
  const roundMoney = (num) => parseFloat(num.toFixed(3));

  const totalHours = {
    lavage: 0,
    preparation: 0,
    peinture: 0,
    interieur: 0,
    primer: 0
  };

  // Calculate lavage hours from dynamic lavages
  Object.values(surfaceData.lavages || {}).forEach(lavage => {
    switch(lavage.type) {
      case 'lavage_pression':
        totalHours.lavage += roundMoney(lavage.total / params.lavage_pression);
        break;
      case 'lavage_main':
        totalHours.lavage += roundMoney(lavage.total / params.lavage_main_surface);
        break;
      case 'lavage_main_lineaire':
        totalHours.lavage += roundMoney(lavage.total / params.lavage_main_lineaire);
        break;
      case 'lavage_plancher_balcon':
        totalHours.lavage += roundMoney(lavage.total / params.lavage_intense_balcon);
        break;
      case 'lavage_portes_fenetres':
        totalHours.lavage += roundMoney(lavage.total / params.lavage_portes_fenetres);
        break;
      default:
        totalHours.lavage += roundMoney(lavage.total / params.lavage_main_surface);
        break;
    }
  });

  // Calculate peinture hours from endroits
  if (surfaceData.totals) {
    totalHours.peinture = roundMoney(surfaceData.totals.peinture / params.peinture_latte_4po);
  } else {
    // Fallback for individual endroit calculations
    Object.values(surfaceData.endroits || {}).forEach(endroit => {
      totalHours.peinture += roundMoney(endroit.peinture / params.peinture_latte_4po);
    });
  }

  // Calculate preparation hours from dynamic preparations
  Object.values(surfaceData.preparations || {}).forEach(preparation => {
    switch(preparation.type) {
      case 'grattage_40min':
        totalHours.preparation += roundMoney(preparation.total * params.grat_spot_40min);
        break;
      case 'grattage_20min':
        totalHours.preparation += roundMoney(preparation.total * params.grat_spot_20min);
        break;
      case 'grattage_10min':
        totalHours.preparation += roundMoney(preparation.total * params.grat_spot_10min);
        break;
      case 'grat_mur_ecaille_peu':
        totalHours.preparation += roundMoney(preparation.total / (params.grat_mur_peu || 70));
        break;
      case 'grat_mur_ecaille_beaucoup':
        totalHours.preparation += roundMoney(preparation.total / (params.grat_mur_beaucoup || 60));
        break;
      case 'grat_mur_ecaille_tout':
        totalHours.preparation += roundMoney(preparation.total / (params.grat_mur_tout || 40));
        break;
      case 'grat_corniches_1er_peu':
        totalHours.preparation += roundMoney(preparation.total / (params.grat_corniche_1er_peu || 20));
        break;
      case 'grat_corniches_1er_tout':
        totalHours.preparation += roundMoney(preparation.total / (params.grat_corniche_1er_tout || 15));
        break;
      case 'grat_corniches_2e_peu':
        totalHours.preparation += roundMoney(preparation.total / (params.grat_corniche_2eme_peu || 15));
        break;
      case 'grat_corniches_2e_tout':
        totalHours.preparation += roundMoney(preparation.total / (params.grat_corniche_2eme_tout || 10));
        break;
      case 'sablage_surface':
        totalHours.preparation += roundMoney(preparation.total / params.sablage_surface);
        break;
      default:
        totalHours.preparation += roundMoney(preparation.total * 0.25);
        break;
    }
  });

  // Ne pas ajouter les 4h minimum - utiliser les heures calcul√©es directement

  // Calculate interior hours (somme de toutes les heures des sections)
  if (surfaceData.totals && surfaceData.totals.heures_int) {
    totalHours.interieur = 
      (surfaceData.totals.heures_int.preparation || 0) +
      (surfaceData.totals.heures_int.appret || 0) +
      (surfaceData.totals.heures_int.porte || 0) +
      (surfaceData.totals.heures_int.fenetre || 0) +
      (surfaceData.totals.heures_int.divers || 0) +
      (surfaceData.totals.heures_int.plafond || 0);
  }

  // Calculate primer hours from primer surface sections
  const primerSections = document.querySelectorAll('[data-primer]');
  const primerGroups = {};

  // Group inputs by primer section ID
  primerSections.forEach(input => {
    const primerId = input.getAttribute('data-primer');
    if (!primerGroups[primerId]) {
      primerGroups[primerId] = [];
    }
    primerGroups[primerId].push(input);
  });

  // Calculate hours for each primer section
  Object.keys(primerGroups).forEach(primerId => {
    const inputs = primerGroups[primerId];
    let totalSurface = 0;

    inputs.forEach(input => {
      totalSurface += parseFloat(input.value) || 0;
    });

    if (totalSurface > 0) {
      const surfaceType = inputs[0]?.getAttribute('data-surface-type');
      let productivity = 0;

      switch(surfaceType) {
        case 'surface_facile':
          productivity = params.primer_surface_facile || 110;
          break;
        case 'surface_difficile':
          productivity = params.primer_surface_difficile || 70;
          break;
        case 'lineaire_1er':
          productivity = params.primer_lineaire_1er || 25;
          break;
        case 'lineaire_2eme':
          productivity = params.primer_lineaire_2eme || 20;
          break;
      }

      if (productivity > 0) {
        totalHours.primer += roundMoney(totalSurface / productivity);
      }
    }
  });

  // Arrondir tous les totaux finaux pour √©viter les erreurs de pr√©cision binaire
  // MAIS pr√©server les fractions exactes pour les valeurs communes
  const preserveExactFractions = (value) => {
    // Convertir vers fractions exactes si c'est une approximation d'une fraction connue
    const rounded = Math.round(value * 100) / 100;
    if (Math.abs(rounded - 3.33) < 0.001) return 10/3;  // 3.333333...
    if (Math.abs(rounded - 3.67) < 0.001) return 11/3;  // 3.666666...
    if (Math.abs(rounded - 6.67) < 0.001) return 20/3;  // 6.666666...
    if (Math.abs(rounded - 1.67) < 0.001) return 5/3;   // 1.666666...
    return roundMoney(value);
  };

  totalHours.lavage = roundMoney(totalHours.lavage);
  const originalPrep = totalHours.preparation;
  totalHours.preparation = preserveExactFractions(totalHours.preparation);

  // Debug du calcul de pr√©paration
  // DEBUG CALCUL PR√âPARATION supprim√©

  totalHours.peinture = roundMoney(totalHours.peinture);
  totalHours.interieur = roundMoney(totalHours.interieur);
  totalHours.primer = roundMoney(totalHours.primer);

  return totalHours;
}

function calculateNewCosts(hours, surfaceData, selectedProduct) {
  const params = getCurrentParameterValues();
  const selectedProducts = getSelectedProducts();
  
  const tauxHoraireValue = getCurrentTauxHoraire();

  
  const costs = {
    lavage: hours.lavage * tauxHoraireValue,
    preparation: (hours.preparation * tauxHoraireValue) + (params.frais_deplacement || 100) + ((hours.preparation * tauxHoraireValue) + (params.frais_deplacement || 100)) * 0.01,
    peinture: hours.peinture * tauxHoraireValue,
    materiaux: 0,
    thirdCoat: 0
  };

  // Calculate total paint surface from new dynamic data structure
  let totalPaintSurface = 0;
  
  if (surfaceData.totals) {
    // Use simplified totals
    totalPaintSurface = surfaceData.totals.peinture;
  } else {
    // Fallback: sum from individual endroits
    Object.values(surfaceData.endroits || {}).forEach(endroit => {
      totalPaintSurface += endroit.peinture;
    });
  }

  // Calculate main paint costs using selected products with user-specified gallons
  if (selectedProducts.length > 0) {
    selectedProducts.forEach(product => {
      // Use user-specified gallons instead of calculated gallons
      costs.materiaux += product.totalPrice;
    });
  } else {
    // Fallback to primary product
    const mainGallonsNeeded = Math.ceil(totalPaintSurface / selectedProduct.coverage);
    costs.materiaux += mainGallonsNeeded * selectedProduct.price;
  }

  // Third coat and primer costs for individual products
  costs.thirdCoat = 0;
  costs.primer = 0;
  
  if (selectedProducts.length > 0) {
    selectedProducts.forEach(product => {
      // Calculate third coat cost for this product if needed
      if (product.needsThirdCoat) {
        // Calculate proportion of painting hours for this product
        const productPaintHours = (hours.peinture * product.gallons) / totalGallons;
        costs.thirdCoat += productPaintHours * params.taux_horaire * 0.5;
      }
      
      // Calculate primer cost for this product if needed
      if (product.needsPrimer) {
        // Use default primer price and coverage from parameters
        const primerPrice = parseFloat(document.getElementById('param_dulux_gripper_prix')?.value) || 100;
        const primerCoverage = parseFloat(document.getElementById('param_dulux_gripper_couverture')?.value) || 200;
        
        // Estimate primer gallons needed based on product coverage
        // PRIMER = UNE SEULE COUCHE
        // product.gallons contient 2 couches (1√®re + 0.7*2√®me), on doit retrouver la surface
        // Surface = product.gallons * product.ratio / 1.7 (car 1 + 0.7 = 1.7 pour 2 couches)
        const productSurface = (product.gallons * product.ratio) / 1.7;
        const primerGallons = Math.ceil(productSurface / primerCoverage);
        costs.primer += primerGallons * primerPrice;
      }
    });
  } else {
    // Fallback to global third coat setting if no products selected
    if (document.getElementById('thirdCoat')?.value === 'oui') {
      costs.thirdCoat = hours.peinture * params.taux_horaire * 0.5;
    }
  }

  // Calculate fer forg√© costs, hours, and products
  costs.fer_forge = 0;
  hours.fer_forge = 0;
  costs.produits_fer_forge = 0;
  console.log('\nüî® D√âTAIL FER FORG√â:');
  document.querySelectorAll('[data-fer_forge]').forEach(input => {
    // IGNORER les champs de param√®tres (param_*)
    if (input.id && input.id.startsWith('param_')) {
      return; // Skip les param√®tres
    }

    const value = parseFloat(input.value) || 0;
    if (value > 0) {
      // Le type peut √™tre dans data-fer_forge OU data-type selon comment l'√©l√©ment a √©t√© cr√©√©
      let ferForgeType = input.getAttribute('data-fer_forge');
      // Si data-fer_forge contient un ID (commence par "endroit_"), lire data-type
      if (ferForgeType && ferForgeType.startsWith('endroit_')) {
        ferForgeType = input.getAttribute('data-type');
      }

      console.log('  ‚îú‚îÄ Type:', ferForgeType, '| Quantit√©:', value, '| Input ID:', input.id);

      // Calculate cost and hours based on fer forg√© type
      let ferForgeCost = 0;
      switch(ferForgeType) {
        case 'rampe_complexe_tres_rouillee':
          ferForgeCost = value * params.rampe_complexe_tres_rouillee;
          costs.fer_forge += ferForgeCost;
          hours.fer_forge += ferForgeCost / params.taux_horaire;
          break;
        case 'rampe_complexe_moyennement_rouillee':
          ferForgeCost = value * params.rampe_complexe_moyennement_rouillee;
          costs.fer_forge += ferForgeCost;
          hours.fer_forge += ferForgeCost / params.taux_horaire;
          break;
        case 'rampe_barreaux_droits_verticaux':
          ferForgeCost = value * params.rampe_barreaux_droits_verticaux;
          costs.fer_forge += ferForgeCost;
          hours.fer_forge += ferForgeCost / params.taux_horaire;
          break;
        case 'rampe_horizontale_moyenne_tres_rouillee':
          ferForgeCost = value * params.rampe_horizontale_moyenne_tres_rouillee;
          costs.fer_forge += ferForgeCost;
          hours.fer_forge += ferForgeCost / params.taux_horaire;
          break;
        case 'rampe_horizontale_facile_moyennement_rouillee':
          ferForgeCost = value * params.rampe_horizontale_facile_moyennement_rouillee;
          costs.fer_forge += ferForgeCost;
          hours.fer_forge += ferForgeCost / params.taux_horaire;
          break;
        case 'marches_languettes_rouillees':
          ferForgeCost = value * params.marches_languettes_rouillees;
          costs.fer_forge += ferForgeCost;
          hours.fer_forge += ferForgeCost / params.taux_horaire;
          break;
        case 'marches_languettes_tres_rouillees':
          ferForgeCost = value * params.marches_languettes_tres_rouillees;
          costs.fer_forge += ferForgeCost;
          hours.fer_forge += ferForgeCost / params.taux_horaire;
          break;
        case 'dessous_balcon_4x8':
          ferForgeCost = value * params.dessous_balcon_4x8;
          costs.fer_forge += ferForgeCost;
          hours.fer_forge += ferForgeCost / params.taux_horaire;
          break;
        case 'planchers_industriels_marches':
          // This has two parts: planchers at 4$/ft¬≤ and marches at 45$/ch
          // For now, we'll treat the input as mixed units - user needs to specify
          ferForgeCost = value * params.planchers_industriels; // Assuming ft¬≤
          costs.fer_forge += ferForgeCost;
          hours.fer_forge += ferForgeCost / params.taux_horaire;
          break;
        case 'planchers_industriels':
          ferForgeCost = value * params.planchers_industriels;
          costs.fer_forge += ferForgeCost;
          hours.fer_forge += ferForgeCost / params.taux_horaire;
          break;
        case 'marches_industrielles':
          ferForgeCost = value * params.marches_industrielles;
          costs.fer_forge += ferForgeCost;
          hours.fer_forge += ferForgeCost / params.taux_horaire;
          break;
        case 'ornements':
          ferForgeCost = value * params.ornements;
          costs.fer_forge += ferForgeCost;
          hours.fer_forge += ferForgeCost / params.taux_horaire;
          break;
        case 'poteaux':
          ferForgeCost = value * params.poteaux;
          costs.fer_forge += ferForgeCost;
          hours.fer_forge += ferForgeCost / params.taux_horaire;
          break;
        case 'fascia_sous_balcon':
          ferForgeCost = value * params.fascia_sous_balcon;
          costs.fer_forge += ferForgeCost;
          hours.fer_forge += ferForgeCost / params.taux_horaire;
          break;
      }

      if (ferForgeCost > 0) {
        console.log('  ‚îÇ  ‚îú‚îÄ Co√ªt M-O:', ferForgeCost.toFixed(2), '$');
        console.log('  ‚îÇ  ‚îú‚îÄ Heures:', (ferForgeCost / params.taux_horaire).toFixed(2), 'h');
      }

      // Calcul produit fer forg√© avec formule simple: Prix MO √ó 0.15
      if (ferForgeCost > 0) {
        const coutProduitExact = ferForgeCost * 0.15; // Co√ªt exact pour produits
        const gallonsFerForge = Math.ceil(coutProduitExact / params.peinture_fer_forge); // Nombre entier de gallons pour commande
        costs.produits_fer_forge += coutProduitExact; // Utiliser le montant exact, pas les gallons arrondis
        console.log('  ‚îÇ  ‚îî‚îÄ Produits fer forg√©:', coutProduitExact.toFixed(2), '$');
      }
    }
  });
  console.log('  ‚îî‚îÄ TOTAL FER FORG√â: Co√ªt M-O =', costs.fer_forge.toFixed(2), '$ | Heures =', hours.fer_forge.toFixed(2), 'h | Produits =', costs.produits_fer_forge.toFixed(2), '$\n');

  // Calculate rev√™tement costs and hours (main d'≈ìuvre rev√™tement, pas pr√©paration)
  costs.revetement = 0;
  hours.revetement = 0;
  document.querySelectorAll('[data-revetement]').forEach(input => {
    const value = parseFloat(input.value) || 0;
    if (value > 0) {
      const dataType = input.getAttribute('data-type');
      console.log('[REVETEMENT DEBUG] dataType:', dataType, 'value:', value, 'params:', {
        peinture_latte_4po: params.peinture_latte_4po,
        peinture_revetement_6po: params.peinture_revetement_6po,
        teindre_bardeau_neuf: params.teindre_bardeau_neuf,
        teindre_bardeau_vieux: params.teindre_bardeau_vieux
      });
      // Calcul bas√© sur les ratios de productivit√© (ft¬≤/h) * taux horaire
      switch(dataType) {
        case 'peinture_latte_4po':
        case 'latte_horizontale_4':
          console.log('[LATTE 4PO] Calcul:', {
            value,
            param: params.peinture_latte_4po,
            facteur: params.facteur_deuxieme_couche,
            taux: params.taux_horaire
          });
          const latteFirstCoat = value / params.peinture_latte_4po;
          const latteSecondCoat = latteFirstCoat * params.facteur_deuxieme_couche;
          const latteTotalHours = latteFirstCoat + latteSecondCoat;
          console.log('[LATTE 4PO] R√©sultat:', { latteFirstCoat, latteSecondCoat, latteTotalHours });
          costs.revetement += latteTotalHours * params.taux_horaire;
          hours.revetement += latteTotalHours;
          break;
        case 'peinture_revetement_6po':
        case 'revetement_6_75':
          console.log('[REVETEMENT 6PO] Calcul:', {
            value,
            param: params.peinture_revetement_6po,
            facteur: params.facteur_deuxieme_couche,
            taux: params.taux_horaire
          });
          const revetementFirstCoat = value / params.peinture_revetement_6po;
          const revetementSecondCoat = revetementFirstCoat * params.facteur_deuxieme_couche;
          const revetementTotalHours = revetementFirstCoat + revetementSecondCoat;
          console.log('[REVETEMENT 6PO] R√©sultat:', { revetementFirstCoat, revetementSecondCoat, revetementTotalHours });
          costs.revetement += revetementTotalHours * params.taux_horaire;
          hours.revetement += revetementTotalHours;
          break;
        case 'teindre_bardeau_neuf':
        case 'bardeau_neuf':
          console.log('[BARDEAU NEUF] Calcul:', {
            value,
            param: params.teindre_bardeau_neuf,
            facteur: params.facteur_deuxieme_couche,
            taux: params.taux_horaire
          });
          const bardeauNeufFirstCoat = value / params.teindre_bardeau_neuf;
          const bardeauNeufSecondCoat = bardeauNeufFirstCoat * params.facteur_deuxieme_couche;
          const bardeauNeufTotalHours = bardeauNeufFirstCoat + bardeauNeufSecondCoat;
          console.log('[BARDEAU NEUF] R√©sultat:', { bardeauNeufFirstCoat, bardeauNeufSecondCoat, bardeauNeufTotalHours });
          costs.revetement += bardeauNeufTotalHours * params.taux_horaire;
          hours.revetement += bardeauNeufTotalHours;
          break;
        case 'teindre_bardeau_vieux':
        case 'bardeau_vieux':
          console.log('[BARDEAU VIEUX] Calcul:', {
            value,
            param: params.teindre_bardeau_vieux,
            facteur: params.facteur_deuxieme_couche,
            taux: params.taux_horaire
          });
          const bardeauVieuxFirstCoat = value / params.teindre_bardeau_vieux;
          const bardeauVieuxSecondCoat = bardeauVieuxFirstCoat * params.facteur_deuxieme_couche;
          const bardeauVieuxTotalHours = bardeauVieuxFirstCoat + bardeauVieuxSecondCoat;
          console.log('[BARDEAU VIEUX] R√©sultat:', { bardeauVieuxFirstCoat, bardeauVieuxSecondCoat, bardeauVieuxTotalHours });
          costs.revetement += bardeauVieuxTotalHours * params.taux_horaire;
          hours.revetement += bardeauVieuxTotalHours;
          break;
        case 'stucco_faible_relief':
          const stuccoFaibleFirstCoat = value / params.stucco_faible_relief;
          const stuccoFaibleSecondCoat = stuccoFaibleFirstCoat * params.facteur_deuxieme_couche;
          const stuccoFaibleTotalHours = stuccoFaibleFirstCoat + stuccoFaibleSecondCoat;
          costs.revetement += stuccoFaibleTotalHours * params.taux_horaire;
          hours.revetement += stuccoFaibleTotalHours;
          break;
        case 'stucco_fort_relief':
          const stuccoFortFirstCoat = value / params.stucco_fort_relief;
          const stuccoFortSecondCoat = stuccoFortFirstCoat * params.facteur_deuxieme_couche;
          const stuccoFortTotalHours = stuccoFortFirstCoat + stuccoFortSecondCoat;
          costs.revetement += stuccoFortTotalHours * params.taux_horaire;
          hours.revetement += stuccoFortTotalHours;
          break;
        case 'brique':
          const briqueFirstCoat = value / params.brique;
          const briqueSecondCoat = briqueFirstCoat * params.facteur_deuxieme_couche;
          const briqueTotalHours = briqueFirstCoat + briqueSecondCoat;
          costs.revetement += briqueTotalHours * params.taux_horaire;
          hours.revetement += briqueTotalHours;
          break;
        case 'solage_facile':
          const solageFacileFirstCoat = value / params.solage_facile;
          const solageFacileSecondCoat = solageFacileFirstCoat * params.facteur_deuxieme_couche;
          const solageFacileTotalHours = solageFacileFirstCoat + solageFacileSecondCoat;
          costs.revetement += solageFacileTotalHours * params.taux_horaire;
          hours.revetement += solageFacileTotalHours;
          break;
        case 'solage_difficile':
          const solageDifficileFirstCoat = value / params.solage_difficile;
          const solageDifficileSecondCoat = solageDifficileFirstCoat * params.facteur_deuxieme_couche;
          const solageDifficileTotalHours = solageDifficileFirstCoat + solageDifficileSecondCoat;
          costs.revetement += solageDifficileTotalHours * params.taux_horaire;
          hours.revetement += solageDifficileTotalHours;
          break;
        default:
          console.warn(`[REVETEMENT] Type non reconnu: ${dataType}`);
          break;
      }
    }
  });

  // Calculate corniches et moulures costs and hours
  costs.corniches_moulures = 0;
  hours.corniches_moulures = 0;
  document.querySelectorAll('[data-corniches]').forEach(input => {
    const value = parseFloat(input.value) || 0;
    if (value > 0) {
      const dataType = input.getAttribute('data-type');
      // Fonction helper pour calculer automatiquement les gallons (Formule 2)
      const updateCornicheGallons = (inputElement, surface, ratio) => {
        if (surface > 0) {
          const premiereCouche = surface / ratio;
          const deuxiemeCouche = premiereCouche * 0.7;
          const gallonsRequis = Math.ceil(premiereCouche + deuxiemeCouche);
          // Trouver la section parent pour mettre √† jour les gallons
          const sectionId = inputElement.closest('[id^="endroit_"]')?.id;
          if (sectionId) {
            // Mettre √† jour les gallons dans tous les produits de cette section
            const productInputs = document.querySelectorAll(`[id^="gallons_"][id*="${sectionId}"]`);
            productInputs.forEach(gallonInput => {
              if (gallonInput.value === '0' || gallonInput.value === '') {
                gallonInput.value = gallonsRequis;
                // D√©clencher le recalcul du co√ªt
                gallonInput.dispatchEvent(new Event('change'));
              }
            });
          }
        }
      };

      // Calcul bas√© sur les ratios de productivit√© (ft/h) * taux horaire
      switch(dataType) {
        case 'fascia_plate_1er':
          const fasciaPlate1erFirstCoat = value / params.fascia_plate_1er;
          const fasciaPlate1erSecondCoat = fasciaPlate1erFirstCoat * params.facteur_deuxieme_couche;
          const fasciaPlate1erTotalHours = fasciaPlate1erFirstCoat + fasciaPlate1erSecondCoat;
          costs.corniches_moulures += fasciaPlate1erTotalHours * params.taux_horaire;
          hours.corniches_moulures += fasciaPlate1erTotalHours;
          // FORMULE 2: surface √∑ ratio (400 pour fascia plate 1er) - calcul au clic produit
          break;
        case 'fascia_complexe_2e':
          const fasciaComplexe2eFirstCoat = value / params.fascia_complexe_2e;
          const fasciaComplexe2eSecondCoat = fasciaComplexe2eFirstCoat * params.facteur_deuxieme_couche;
          const fasciaComplexe2eTotalHours = fasciaComplexe2eFirstCoat + fasciaComplexe2eSecondCoat;
          costs.corniches_moulures += fasciaComplexe2eTotalHours * params.taux_horaire;
          hours.corniches_moulures += fasciaComplexe2eTotalHours;
          // FORMULE 2: surface √∑ ratio (600 pour fascia complexe 2e) - calcul au clic produit
          break;
        case 'corniche_plate_1er':
          const cornichePlate1erFirstCoat = value / params.corniche_plate_1er;
          const cornichePlate1erSecondCoat = cornichePlate1erFirstCoat * params.facteur_deuxieme_couche;
          const cornichePlate1erTotalHours = cornichePlate1erFirstCoat + cornichePlate1erSecondCoat;
          costs.corniches_moulures += cornichePlate1erTotalHours * params.taux_horaire;
          hours.corniches_moulures += cornichePlate1erTotalHours;
          // FORMULE 2: surface √∑ ratio (200 pour corniche plate 1er) - calcul au clic produit
          break;
        case 'corniche_texturee_1er':
          const cornicheTexturee1erFirstCoat = value / params.corniche_texturee_1er;
          const cornicheTexturee1erSecondCoat = cornicheTexturee1erFirstCoat * params.facteur_deuxieme_couche;
          const cornicheTexturee1erTotalHours = cornicheTexturee1erFirstCoat + cornicheTexturee1erSecondCoat;
          costs.corniches_moulures += cornicheTexturee1erTotalHours * params.taux_horaire;
          hours.corniches_moulures += cornicheTexturee1erTotalHours;
          // FORMULE 2: surface √∑ ratio (200 pour corniche texturee 1er) - calcul au clic produit
          break;
        case 'corniche_complexe_1er':
          const cornicheComplexe1erFirstCoat = value / params.corniche_complexe_1er;
          const cornicheComplexe1erSecondCoat = cornicheComplexe1erFirstCoat * params.facteur_deuxieme_couche;
          const cornicheComplexe1erTotalHours = cornicheComplexe1erFirstCoat + cornicheComplexe1erSecondCoat;
          costs.corniches_moulures += cornicheComplexe1erTotalHours * params.taux_horaire;
          hours.corniches_moulures += cornicheComplexe1erTotalHours;
          // FORMULE 2: surface √∑ ratio (200 pour corniche complexe 1er) - calcul au clic produit
          break;
        case 'corniche_plate_2e':
          const cornichePlate2eFirstCoat = value / params.corniche_plate_2e;
          const cornichePlate2eSecondCoat = cornichePlate2eFirstCoat * params.facteur_deuxieme_couche;
          const cornichePlate2eTotalHours = cornichePlate2eFirstCoat + cornichePlate2eSecondCoat;
          costs.corniches_moulures += cornichePlate2eTotalHours * params.taux_horaire;
          hours.corniches_moulures += cornichePlate2eTotalHours;
          // FORMULE 2: surface √∑ ratio (200 pour corniche plate 2e) - calcul au clic produit
          break;
        case 'corniche_texturee_2e':
          const cornicheTexturee2eFirstCoat = value / params.corniche_texturee_2e;
          const cornicheTexturee2eSecondCoat = cornicheTexturee2eFirstCoat * params.facteur_deuxieme_couche;
          const cornicheTexturee2eTotalHours = cornicheTexturee2eFirstCoat + cornicheTexturee2eSecondCoat;
          costs.corniches_moulures += cornicheTexturee2eTotalHours * params.taux_horaire;
          hours.corniches_moulures += cornicheTexturee2eTotalHours;
          // FORMULE 2: surface √∑ ratio (200 pour corniche texturee 2e) - calcul au clic produit
          break;
        case 'corniche_complexe_2e':
          const cornicheComplexe2eFirstCoat = value / params.corniche_complexe_2e;
          const cornicheComplexe2eSecondCoat = cornicheComplexe2eFirstCoat * params.facteur_deuxieme_couche;
          const cornicheComplexe2eTotalHours = cornicheComplexe2eFirstCoat + cornicheComplexe2eSecondCoat;
          costs.corniches_moulures += cornicheComplexe2eTotalHours * params.taux_horaire;
          hours.corniches_moulures += cornicheComplexe2eTotalHours;
          // FORMULE 2: surface √∑ ratio (200 pour corniche complexe 2e) - calcul au clic produit
          break;
      }
    }
  });

  // Calculate fen√™tres et volets costs and hours
  costs.fenetres_volets = 0;
  hours.fenetres_volets = 0;
  document.querySelectorAll('[data-fenetres]').forEach(input => {
    const value = parseFloat(input.value) || 0;
    if (value > 0) {
      const dataType = input.getAttribute('data-type');

      // Fonction helper pour calculer automatiquement les gallons (Formule 2)
      const updateFenetreGallons = (inputElement, qte, ratio) => {
        if (qte > 0) {
          const premiereCouche = qte / ratio;
          const deuxiemeCouche = premiereCouche * 0.7;
          const gallonsRequis = Math.ceil(premiereCouche + deuxiemeCouche);
          // Trouver la section parent pour mettre √† jour les gallons
          const sectionId = inputElement.closest('[id^="endroit_"]')?.id;
          if (sectionId) {
            // Mettre √† jour les gallons dans tous les produits de cette section
            const productInputs = document.querySelectorAll(`[id^="gallons_"][id*="${sectionId}"]`);
            productInputs.forEach(gallonInput => {
              if (gallonInput.value === '0' || gallonInput.value === '') {
                gallonInput.value = gallonsRequis;
                // D√©clencher le recalcul du co√ªt
                gallonInput.dispatchEvent(new Event('change'));
              }
            });
          }
        }
      };

      // Calcul bas√© sur les heures par unit√© * taux horaire
      switch(dataType) {
        case 'fenetre_sous_sol':
          const fenetreSousSolFirstCoat = value * params.fenetre_sous_sol;
          const fenetreSousSolSecondCoat = fenetreSousSolFirstCoat * params.facteur_deuxieme_couche;
          const fenetreSousSolTotalHours = fenetreSousSolFirstCoat + fenetreSousSolSecondCoat;
          costs.fenetres_volets += fenetreSousSolTotalHours * params.taux_horaire;
          hours.fenetres_volets += fenetreSousSolTotalHours;
          // FORMULE 2: qte √∑ ratio (35 pour fen√™tres) - calcul au clic produit
          break;
        case 'fenetre_facile_cadre':
          const fenetreFacileFirstCoat = value * params.fenetre_facile_cadre;
          const fenetreFacileSecondCoat = fenetreFacileFirstCoat * params.facteur_deuxieme_couche;
          const fenetreFacileTotalHours = fenetreFacileFirstCoat + fenetreFacileSecondCoat;
          costs.fenetres_volets += fenetreFacileTotalHours * params.taux_horaire;
          hours.fenetres_volets += fenetreFacileTotalHours;
          // FORMULE 2: qte √∑ ratio (35 pour fen√™tres) - calcul au clic produit
          break;
        case 'fenetre_moyenne':
          const fenetreMoyenneFirstCoat = value * params.fenetre_moyenne;
          const fenetreMoyenneSecondCoat = fenetreMoyenneFirstCoat * params.facteur_deuxieme_couche;
          const fenetreMoyenneTotalHours = fenetreMoyenneFirstCoat + fenetreMoyenneSecondCoat;
          costs.fenetres_volets += fenetreMoyenneTotalHours * params.taux_horaire;
          hours.fenetres_volets += fenetreMoyenneTotalHours;
          // FORMULE 2: qte √∑ ratio (35 pour fen√™tres) - calcul au clic produit
          break;
        case 'fenetre_difficile':
          const fenetreDifficileFirstCoat = value * params.fenetre_difficile;
          const fenetreDifficileSecondCoat = fenetreDifficileFirstCoat * params.facteur_deuxieme_couche;
          const fenetreDifficileTotalHours = fenetreDifficileFirstCoat + fenetreDifficileSecondCoat;
          costs.fenetres_volets += fenetreDifficileTotalHours * params.taux_horaire;
          hours.fenetres_volets += fenetreDifficileTotalHours;
          // FORMULE 2: qte √∑ ratio (35 pour fen√™tres) - calcul au clic produit
          break;
        case 'fenetre_3_6_carreaux':
          const fenetre3_6FirstCoat = value * params.fenetre_3_6_carreaux;
          const fenetre3_6SecondCoat = fenetre3_6FirstCoat * params.facteur_deuxieme_couche;
          const fenetre3_6TotalHours = fenetre3_6FirstCoat + fenetre3_6SecondCoat;
          costs.fenetres_volets += fenetre3_6TotalHours * params.taux_horaire;
          hours.fenetres_volets += fenetre3_6TotalHours;
          // FORMULE 2: qte √∑ ratio (35 pour fen√™tres) - calcul au clic produit
          break;
        case 'fenetre_carreaux_6plus':
          const fenetre6plusFirstCoat = value * params.fenetre_carreaux_6plus;
          const fenetre6plusSecondCoat = fenetre6plusFirstCoat * params.facteur_deuxieme_couche;
          const fenetre6plusTotalHours = fenetre6plusFirstCoat + fenetre6plusSecondCoat;
          costs.fenetres_volets += fenetre6plusTotalHours * params.taux_horaire;
          hours.fenetres_volets += fenetre6plusTotalHours;
          // FORMULE 2: qte √∑ ratio (35 pour fen√™tres) - calcul au clic produit
          break;
        case 'volet_plat_simple':
          const voletPlatFirstCoat = value * params.volet_plat_simple;
          const voletPlatSecondCoat = voletPlatFirstCoat * params.facteur_deuxieme_couche;
          const voletPlatTotalHours = voletPlatFirstCoat + voletPlatSecondCoat;
          costs.fenetres_volets += voletPlatTotalHours * params.taux_horaire;
          hours.fenetres_volets += voletPlatTotalHours;
          // FORMULE 2: qte √∑ ratio (20 pour volets) - calcul au clic produit
          break;
        case 'volet_avec_motifs':
          const voletMotifsFirstCoat = value * params.volet_avec_motifs;
          const voletMotifsSecondCoat = voletMotifsFirstCoat * params.facteur_deuxieme_couche;
          const voletMotifsTotalHours = voletMotifsFirstCoat + voletMotifsSecondCoat;
          costs.fenetres_volets += voletMotifsTotalHours * params.taux_horaire;
          hours.fenetres_volets += voletMotifsTotalHours;
          // FORMULE 2: qte √∑ ratio (20 pour volets) - calcul au clic produit
          break;
        case 'grande_fenetre_bay':
          const grandeFenetreFirstCoat = value * params.grande_fenetre_bay;
          const grandeFenetreSecondCoat = grandeFenetreFirstCoat * params.facteur_deuxieme_couche;
          const grandeFenetreTotalHours = grandeFenetreFirstCoat + grandeFenetreSecondCoat;
          costs.fenetres_volets += grandeFenetreTotalHours * params.taux_horaire;
          hours.fenetres_volets += grandeFenetreTotalHours;
          // FORMULE 2: qte √∑ ratio (35 pour fen√™tres) - calcul au clic produit
          break;
      }
    }
  });

  // Calculate portes costs and hours
  costs.portes = 0;
  hours.portes = 0;
  document.querySelectorAll('[data-portes]').forEach(input => {
    const value = parseFloat(input.value) || 0;
    if (value > 0) {
      const dataType = input.getAttribute('data-type');
      // Fonction helper pour calculer automatiquement les gallons (Formule 2)
      const updatePorteGallons = (inputElement, qte, ratio) => {
        if (qte > 0) {
          const premiereCouche = qte / ratio;
          const deuxiemeCouche = premiereCouche * 0.7;
          const gallonsRequis = Math.ceil(premiereCouche + deuxiemeCouche);
          // Trouver la section parent pour mettre √† jour les gallons
          const sectionId = inputElement.closest('[id^="endroit_"]')?.id;
          if (sectionId) {
            // Mettre √† jour les gallons dans tous les produits de cette section
            const productInputs = document.querySelectorAll(`[id^="gallons_"][id*="${sectionId}"]`);
            productInputs.forEach(gallonInput => {
              if (gallonInput.value === '0' || gallonInput.value === '') {
                gallonInput.value = gallonsRequis;
                // D√©clencher le recalcul du co√ªt
                gallonInput.dispatchEvent(new Event('change'));
              }
            });
          }
        }
      };

      // Calcul bas√© sur les heures par unit√© * taux horaire
      switch(dataType) {
        case 'porte_facile':
          const porteFacileFirstCoat = value * params.porte_facile;
          const porteFacileSecondCoat = porteFacileFirstCoat * params.facteur_deuxieme_couche;
          const porteFacileTotalHours = porteFacileFirstCoat + porteFacileSecondCoat;
          costs.portes += porteFacileTotalHours * params.taux_horaire;
          hours.portes += porteFacileTotalHours;
          // FORMULE 2: qte √∑ ratio (20 pour porte facile) - calcul au clic produit
          break;
        case 'porte_moyenne':
          const porteMoyenneFirstCoat = value * params.porte_moyenne;
          const porteMoyenneSecondCoat = porteMoyenneFirstCoat * params.facteur_deuxieme_couche;
          const porteMoyenneTotalHours = porteMoyenneFirstCoat + porteMoyenneSecondCoat;
          costs.portes += porteMoyenneTotalHours * params.taux_horaire;
          hours.portes += porteMoyenneTotalHours;
          // FORMULE 2: qte √∑ ratio (20 pour porte moyenne) - calcul au clic produit
          break;
        case 'porte_difficile':
          const porteDifficileFirstCoat = value * params.porte_difficile;
          const porteDifficileSecondCoat = porteDifficileFirstCoat * params.facteur_deuxieme_couche;
          const porteDifficileTotalHours = porteDifficileFirstCoat + porteDifficileSecondCoat;
          costs.portes += porteDifficileTotalHours * params.taux_horaire;
          hours.portes += porteDifficileTotalHours;
          // FORMULE 2: qte √∑ ratio (20 pour porte difficile) - calcul au clic produit
          break;
        case 'porte_garage_simple':
          const porteGarageSimpleFirstCoat = value * params.porte_garage_simple;
          const porteGarageSimpleSecondCoat = porteGarageSimpleFirstCoat * params.facteur_deuxieme_couche;
          const porteGarageSimpleTotalHours = porteGarageSimpleFirstCoat + porteGarageSimpleSecondCoat;
          costs.portes += porteGarageSimpleTotalHours * params.taux_horaire;
          hours.portes += porteGarageSimpleTotalHours;
          // FORMULE 2: qte √∑ ratio (10 pour porte garage simple) - calcul au clic produit
          break;
        case 'porte_garage_difficile':
          const porteGarageDifficileFirstCoat = value * params.porte_garage_difficile;
          const porteGarageDifficileSecondCoat = porteGarageDifficileFirstCoat * params.facteur_deuxieme_couche;
          const porteGarageDifficileTotalHours = porteGarageDifficileFirstCoat + porteGarageDifficileSecondCoat;
          costs.portes += porteGarageDifficileTotalHours * params.taux_horaire;
          hours.portes += porteGarageDifficileTotalHours;
          // FORMULE 2: qte √∑ ratio (10 pour porte garage difficile) - calcul au clic produit
          break;
        case 'moulure_cadre_porte_facile':
          const moulureCadrePorteFacileFirstCoat = value * params.moulure_cadre_porte_facile;
          const moulureCadrePorteFacileSecondCoat = moulureCadrePorteFacileFirstCoat * params.facteur_deuxieme_couche;
          const moulureCadrePorteFacileTotalHours = moulureCadrePorteFacileFirstCoat + moulureCadrePorteFacileSecondCoat;
          costs.portes += moulureCadrePorteFacileTotalHours * params.taux_horaire;
          hours.portes += moulureCadrePorteFacileTotalHours;
          break;
        case 'moulure_cadre_porte_moyenne':
          const moulureCadrePorteMoyenneFirstCoat = value * params.moulure_cadre_porte_moyenne;
          const moulureCadrePorteMoyenneSecondCoat = moulureCadrePorteMoyenneFirstCoat * params.facteur_deuxieme_couche;
          const moulureCadrePorteMoyenneTotalHours = moulureCadrePorteMoyenneFirstCoat + moulureCadrePorteMoyenneSecondCoat;
          costs.portes += moulureCadrePorteMoyenneTotalHours * params.taux_horaire;
          hours.portes += moulureCadrePorteMoyenneTotalHours;
          break;
        case 'moulure_cadre_porte_difficile':
          const moulureCadrePorteDifficileFirstCoat = value * params.moulure_cadre_porte_difficile;
          const moulureCadrePorteDifficileSecondCoat = moulureCadrePorteDifficileFirstCoat * params.facteur_deuxieme_couche;
          const moulureCadrePorteDifficileTotalHours = moulureCadrePorteDifficileFirstCoat + moulureCadrePorteDifficileSecondCoat;
          costs.portes += moulureCadrePorteDifficileTotalHours * params.taux_horaire;
          hours.portes += moulureCadrePorteDifficileTotalHours;
          break;
        case 'moulure_porte_garage_facile':
          const moulurePorteGarageFacileFirstCoat = value * params.moulure_porte_garage_facile;
          const moulurePorteGarageFacileSecondCoat = moulurePorteGarageFacileFirstCoat * params.facteur_deuxieme_couche;
          const moulurePorteGarageFacileTotalHours = moulurePorteGarageFacileFirstCoat + moulurePorteGarageFacileSecondCoat;
          costs.portes += moulurePorteGarageFacileTotalHours * params.taux_horaire;
          hours.portes += moulurePorteGarageFacileTotalHours;
          break;
        case 'moulure_porte_garage_moyen':
          const moulurePorteGarageMoyenFirstCoat = value * params.moulure_porte_garage_moyen;
          const moulurePorteGarageMoyenSecondCoat = moulurePorteGarageMoyenFirstCoat * params.facteur_deuxieme_couche;
          const moulurePorteGarageMoyenTotalHours = moulurePorteGarageMoyenFirstCoat + moulurePorteGarageMoyenSecondCoat;
          costs.portes += moulurePorteGarageMoyenTotalHours * params.taux_horaire;
          hours.portes += moulurePorteGarageMoyenTotalHours;
          break;
        case 'moulure_porte_garage_difficile':
          const moulurePorteGarageDifficileFirstCoat = value * params.moulure_porte_garage_difficile;
          const moulurePorteGarageDifficileSecondCoat = moulurePorteGarageDifficileFirstCoat * params.facteur_deuxieme_couche;
          const moulurePorteGarageDifficileTotalHours = moulurePorteGarageDifficileFirstCoat + moulurePorteGarageDifficileSecondCoat;
          costs.portes += moulurePorteGarageDifficileTotalHours * params.taux_horaire;
          hours.portes += moulurePorteGarageDifficileTotalHours;
          break;
        case 'carreaux_portes_cadres':
          const carreauxPortesCadresFirstCoat = value * params.carreaux_portes_cadres;
          const carreauxPortesCadresSecondCoat = carreauxPortesCadresFirstCoat * params.facteur_deuxieme_couche;
          const carreauxPortesCadresTotalHours = carreauxPortesCadresFirstCoat + carreauxPortesCadresSecondCoat;
          costs.portes += carreauxPortesCadresTotalHours * params.taux_horaire;
          hours.portes += carreauxPortesCadresTotalHours;
          break;
      }
    }
  });

  // Calculate balcon costs and hours
  costs.balcon = 0;
  hours.balcon = 0;
  document.querySelectorAll('[data-balcon]').forEach(input => {
    const value = parseFloat(input.value) || 0;
    if (value > 0) {
      const dataType = input.getAttribute('data-type');
      // Fonction helper pour calculer automatiquement les gallons (Formule 2)
      const updateBalconGallons = (inputElement, quantite, ratio) => {
        if (quantite > 0) {
          const premiereCouche = quantite / ratio;
          const deuxiemeCouche = premiereCouche * 0.7;
          const gallonsRequis = Math.ceil(premiereCouche + deuxiemeCouche);
          // Trouver la section parent pour mettre √† jour les gallons
          const sectionId = inputElement.closest('[id^="endroit_"]')?.id;
          if (sectionId) {
            // Mettre √† jour les gallons dans tous les produits de cette section
            const productInputs = document.querySelectorAll(`[id^="gallons_"][id*="${sectionId}"]`);
            productInputs.forEach(gallonInput => {
              if (gallonInput.value === '0' || gallonInput.value === '') {
                gallonInput.value = gallonsRequis;
                // D√©clencher le recalcul du co√ªt
                gallonInput.dispatchEvent(new Event('change'));
              }
            });
          }
        }
      };

      // Calcul bas√© sur les ratios de productivit√© du fichier Excel
      switch(dataType) {
        case 'marches_balcon':
          const marchesHours = value / params.marches_balcon;
          const marchesSecondCoat = marchesHours * params.facteur_deuxieme_couche;
          const marchesTotalHours = marchesHours + marchesSecondCoat;
          costs.balcon += marchesTotalHours * params.taux_horaire;
          hours.balcon += marchesTotalHours;
          break;
        case 'rampes_barreaux_simple':
          const rampeSimpleHours = value / params.rampes_barreaux_simple;
          const rampeSimpleSecondCoat = rampeSimpleHours * params.facteur_deuxieme_couche;
          const rampeSimpleTotalHours = rampeSimpleHours + rampeSimpleSecondCoat;
          costs.balcon += rampeSimpleTotalHours * params.taux_horaire;
          hours.balcon += rampeSimpleTotalHours;
          break;
        case 'rampes_barreaux_modere':
          const rampeModereHours = value / params.rampes_barreaux_modere;
          const rampeModereSecondCoat = rampeModereHours * params.facteur_deuxieme_couche;
          const rampeModeregTotalHours = rampeModereHours + rampeModereSecondCoat;
          costs.balcon += rampeModeregTotalHours * params.taux_horaire;
          hours.balcon += rampeModeregTotalHours;
          break;
        case 'rampes_barreaux_complexe':
          const rampeComplexeHours = value / params.rampes_barreaux_complexe;
          const rampeComplexeSecondCoat = rampeComplexeHours * params.facteur_deuxieme_couche;
          const rampeComplexeTotalHours = rampeComplexeHours + rampeComplexeSecondCoat;
          costs.balcon += rampeComplexeTotalHours * params.taux_horaire;
          hours.balcon += rampeComplexeTotalHours;
          break;
        case 'piliers_simples':
          const piliersSimplesCost = value / params.piliers_simples;
          const piliersSimplesSecondCoat = piliersSimplesCost * params.facteur_deuxieme_couche;
          const piliersSimplesTotalHours = piliersSimplesCost + piliersSimplesSecondCoat;
          costs.balcon += piliersSimplesTotalHours * params.taux_horaire;
          hours.balcon += piliersSimplesTotalHours;
          break;
        case 'piliers_complexes':
          const piliersComplexesHours = value / params.piliers_complexes;
          const piliersComplexesSecondCoat = piliersComplexesHours * params.facteur_deuxieme_couche;
          const piliersComplexesTotalHours = piliersComplexesHours + piliersComplexesSecondCoat;
          costs.balcon += piliersComplexesTotalHours * params.taux_horaire;
          hours.balcon += piliersComplexesTotalHours;
          break;
        case 'pergola':
          const pergolaHours = value / params.pergola;
          const pergolaSecondCoat = pergolaHours * params.facteur_deuxieme_couche;
          const pergolaTotalHours = pergolaHours + pergolaSecondCoat;
          costs.balcon += pergolaTotalHours * params.taux_horaire;
          hours.balcon += pergolaTotalHours;
          break;
        case 'plancher_teinture_semi':
          const plancherTeintureHours = value / params.plancher_teinture_semi;
          const plancherTeintureSecondCoat = plancherTeintureHours * params.facteur_deuxieme_couche;
          const plancherTeintureTotalHours = plancherTeintureHours + plancherTeintureSecondCoat;
          costs.balcon += plancherTeintureTotalHours * params.taux_horaire;
          hours.balcon += plancherTeintureTotalHours;
          break;
        case 'plancher_opaque_peinture':
          const plancherOpaqueHours = value / params.plancher_opaque_peinture;
          const plancherOpaqueSecondCoat = plancherOpaqueHours * params.facteur_deuxieme_couche;
          const plancherOpaqueTotalHours = plancherOpaqueHours + plancherOpaqueSecondCoat;
          costs.balcon += plancherOpaqueTotalHours * params.taux_horaire;
          hours.balcon += plancherOpaqueTotalHours;
          break;
        case 'mains_courantes':
          const mainsCourantesHours = value / params.mains_courantes;
          const mainsCourantesSecondCoat = mainsCourantesHours * params.facteur_deuxieme_couche;
          const mainsCourantesTotalHours = mainsCourantesHours + mainsCourantesSecondCoat;
          costs.balcon += mainsCourantesTotalHours * params.taux_horaire;
          hours.balcon += mainsCourantesTotalHours;
          break;
        case 'treillis':
          const treillisHours = value / params.treillis;
          const treillisSecondCoat = treillisHours * params.facteur_deuxieme_couche;
          const treillisTotalHours = treillisHours + treillisSecondCoat;
          costs.balcon += treillisTotalHours * params.taux_horaire;
          hours.balcon += treillisTotalHours;
          break;
      }
    }
  });

  // Calculate cl√¥ture costs and hours
  costs.cloture = 0;
  hours.cloture = 0;
  document.querySelectorAll('[data-cloture]').forEach(input => {
    const value = parseFloat(input.value) || 0;
    if (value > 0) {
      const dataType = input.getAttribute('data-type');
      // Fonction helper pour calculer automatiquement les gallons (Formule 2)
      const updateClotureGallons = (inputElement, quantite, ratio) => {
        if (quantite > 0) {
          const premiereCouche = quantite / ratio;
          const deuxiemeCouche = premiereCouche * 0.7;
          const gallonsRequis = Math.ceil(premiereCouche + deuxiemeCouche);
          // Trouver la section parent pour mettre √† jour les gallons
          const sectionId = inputElement.closest('[id^="endroit_"]')?.id;
          if (sectionId) {
            // Mettre √† jour les gallons dans tous les produits de cette section
            const productInputs = document.querySelectorAll(`[id^="gallons_"][id*="${sectionId}"]`);
            productInputs.forEach(gallonInput => {
              if (gallonInput.value === '0' || gallonInput.value === '') {
                gallonInput.value = gallonsRequis;
                // D√©clencher le recalcul des co√ªts
                gallonInput.dispatchEvent(new Event('input', { bubbles: true }));
              }
            });
          }
        }
      };
      // Utiliser des ratios de productivit√© standards pour cl√¥ture
      switch(dataType) {
        case 'panneau_verticales_facile':
          // CORRECTION: utiliser le param√®tre h/panneau au lieu de productivit√© fixe
          const panneauFacileHours = value * params.panneau_verticales_facile; // 0.50 h/panneau
          const panneauFacileSecondCoat = panneauFacileHours * params.facteur_deuxieme_couche;
          const panneauFacileTotalHours = panneauFacileHours + panneauFacileSecondCoat;
          costs.cloture += panneauFacileTotalHours * params.taux_horaire;
          hours.cloture += panneauFacileTotalHours;
          // FORMULE 2: qte √∑ ratio (6 pour panneau verticales facile) - calcul au clic produit
          break;
        case 'panneau_verticales_moyenne':
          // CORRECTION: utiliser le param√®tre h/panneau (1.25h/panneau)
          const panneauMoyenneHours = value * params.panneau_verticales_moyenne;
          const panneauMoyenneSecondCoat = panneauMoyenneHours * params.facteur_deuxieme_couche;
          const panneauMoyenneTotalHours = panneauMoyenneHours + panneauMoyenneSecondCoat;
          costs.cloture += panneauMoyenneTotalHours * params.taux_horaire;
          hours.cloture += panneauMoyenneTotalHours;
          // FORMULE 2: qte √∑ ratio (6 pour panneau verticales moyenne) - calcul au clic produit
          break;
        case 'panneau_verticales_difficile':
          // CORRECTION: utiliser le param√®tre h/panneau au lieu de productivit√© fixe
          const panneauDifficileHours = value * params.panneau_verticales_difficile;
          const panneauDifficileSecondCoat = panneauDifficileHours * params.facteur_deuxieme_couche;
          const panneauDifficileTotalHours = panneauDifficileHours + panneauDifficileSecondCoat;
          costs.cloture += panneauDifficileTotalHours * params.taux_horaire;
          hours.cloture += panneauDifficileTotalHours;
          // FORMULE 2: qte √∑ ratio (6 pour panneau verticales difficile) - calcul au clic produit
          break;
        case 'treillis':
          const treillisHours = value / params.treillis_cloture;
          const treillisSecondCoat = treillisHours * params.facteur_deuxieme_couche;
          const treillisTotalHours = treillisHours + treillisSecondCoat;
          costs.cloture += treillisTotalHours * params.taux_horaire;
          hours.cloture += treillisTotalHours;
          // FORMULE 2: ft¬≤ √∑ ratio (50 pour treillis cl√¥ture) - calcul au clic produit
          break;
      }
    }
  });

  // Calculate autre costs and hours (heures additionnelles)
  costs.autre = 0;
  hours.autre = 0;
  document.querySelectorAll('[data-autre]').forEach(input => {
    const value = parseFloat(input.value) || 0;
    if (value > 0) {
      const dataType = input.getAttribute('data-type');
      // Fonction helper pour calculer automatiquement les gallons (Formule 2)
      const updateAutreGallons = (inputElement, quantite, ratio) => {
        if (quantite > 0) {
          const premiereCouche = quantite / ratio;
          const deuxiemeCouche = premiereCouche * 0.7;
          const gallonsRequis = Math.ceil(premiereCouche + deuxiemeCouche);
          // Trouver la section parent pour mettre √† jour les gallons
          const sectionId = inputElement.closest('[id^="endroit_"]')?.id;
          if (sectionId) {
            // Mettre √† jour les gallons dans tous les produits de cette section
            const productInputs = document.querySelectorAll(`[id^="gallons_"][id*="${sectionId}"]`);
            productInputs.forEach(gallonInput => {
              if (gallonInput.value === '0' || gallonInput.value === '') {
                gallonInput.value = gallonsRequis;
                // D√©clencher le recalcul des co√ªts
                gallonInput.dispatchEvent(new Event('input', { bubbles: true }));
              }
            });
          }
        }
      };
      // Calcul bas√© sur l'ajout d'heures de travail
      switch(dataType) {
        case 'autre_20min':
          const autre20minHours = value * (20/60); // 20 min = 0.33h
          costs.autre += autre20minHours * params.taux_horaire;
          hours.autre += autre20minHours;
          // FORMULE 2: qte √∑ ratio (6 pour autre 20min) - calcul au clic produit
          break;
        case 'autre_30min':
          const autre30minHours = value * (30/60); // 30 min = 0.5h
          costs.autre += autre30minHours * params.taux_horaire;
          hours.autre += autre30minHours;
          // FORMULE 2: qte √∑ ratio (4 pour autre 30min) - calcul au clic produit
          break;
        case 'autre_1h':
          const autre1hHours = value * 1; // 1 heure
          costs.autre += autre1hHours * params.taux_horaire;
          hours.autre += autre1hHours;
          // FORMULE 2: qte √∑ ratio (2 pour autre 1h) - calcul au clic produit
          break;
        case 'treillis':
          const treillisAutresFirstCoat = value / params.treillis_autres;
          const treillisAutresSecondCoat = treillisAutresFirstCoat * params.facteur_deuxieme_couche;
          const treillisAutresTotalHours = treillisAutresFirstCoat + treillisAutresSecondCoat;
          costs.autre += treillisAutresTotalHours * params.taux_horaire;
          hours.autre += treillisAutresTotalHours;
          // FORMULE 2: ft¬≤ √∑ ratio (200 pour treillis autres) - calcul au clic produit
          break;
        case 'lucarne_facile':
          const lucarneFacileFirstCoat = value * (params.lucarne_facile_acces || 2.0);
          const lucarneFacileSecondCoat = lucarneFacileFirstCoat * params.facteur_deuxieme_couche;
          const lucarneFacileTotalHours = lucarneFacileFirstCoat + lucarneFacileSecondCoat;
          costs.autre += lucarneFacileTotalHours * params.taux_horaire;
          hours.autre += lucarneFacileTotalHours;
          // FORMULE 2: qte √∑ ratio (8 pour lucarne facile) - calcul au clic produit
          break;
        case 'lucarne_difficile':
          const lucarneDifficileFirstCoat = value * (params.lucarne_difficile_acces || 3.0);
          const lucarneDifficileSecondCoat = lucarneDifficileFirstCoat * params.facteur_deuxieme_couche;
          const lucarneDifficileTotalHours = lucarneDifficileFirstCoat + lucarneDifficileSecondCoat;
          costs.autre += lucarneDifficileTotalHours * params.taux_horaire;
          hours.autre += lucarneDifficileTotalHours;
          // FORMULE 2: qte √∑ ratio (8 pour lucarne difficile) - calcul au clic produit
          break;
        case 'descente_gouttiere':
          const descenteFirstCoat = value / (params.d_gouttiere || 20);  // 20 ft/h
          const descenteSecondCoat = descenteFirstCoat * params.facteur_deuxieme_couche;
          const descenteTotalHours = descenteFirstCoat + descenteSecondCoat;
          costs.autre += descenteTotalHours * params.taux_horaire;
          hours.autre += descenteTotalHours;
          // FORMULE 2: ft √∑ ratio (400 pour descente goutti√®re) - calcul au clic produit
          break;
        case 'sablage_surface':
          const sablageHours = value / params.sablage_surface; // 100 ft¬≤/h
          costs.autre += sablageHours * params.taux_horaire;
          hours.autre += sablageHours;
          break;
      }
    }
  });

  // Add all endroit √† peinturer costs to peinture (main d'≈ìuvre peinture), INCLUDING rev√™tement
  costs.peinture += costs.revetement + costs.corniches_moulures + costs.fenetres_volets + costs.portes + costs.balcon + costs.cloture + costs.autre;



  // Calculate interior costs using new section-based data
  costs.interieur = 0;
  costs.preparation_int = 0;
  costs.main_oeuvre_int = 0;
  costs.peinture_int = 0;
  costs.produits_appliques_int = 0;
  
  // Get taux horaire int√©rieur
  const tauxHoraireIntValue = getCurrentTauxHoraire();
  
  // Calculate costs from all interior sections using hours data
  if (surfaceData.totals && surfaceData.totals.heures_int) {
    // Pr√©paration int√©rieure : MO pr√©paration = heures pr√©paration √ó taux horaire
    const totalPreparationHours = surfaceData.totals.heures_int.preparation || 0;
    const preparationGlobaleData = getPreparationGlobalData();
    const heuresPreparationGlobale = preparationGlobaleData.heures || 0;
    costs.preparation_int = (totalPreparationHours + heuresPreparationGlobale) * tauxHoraireIntValue;
    
    // Main d'≈ìuvre int√©rieur : MO murs + MO plafond + MO moulures avec facteur 1.7 pour 2 couches
    let moMursHeures = 0;
    let moPlafondHeures = 0;
    let moMouluresHeures = 0;

    // Parcourir toutes les pi√®ces int√©rieures pour calculer les heures MO selon les s√©lections r√©elles
    if (typeof piecesInterieur !== 'undefined' && piecesInterieur.length > 0) {
      piecesInterieur.forEach(piece => {
        const pieceId = piece.id;

        // MO Murs : seulement les murs s√©lectionn√©s (coch√©s)
        const mur1Checked = document.getElementById(`mur1_${pieceId}`)?.checked || false;
        const mur2Checked = document.getElementById(`mur2_${pieceId}`)?.checked || false;
        const mur3Checked = document.getElementById(`mur3_${pieceId}`)?.checked || false;
        const mur4Checked = document.getElementById(`mur4_${pieceId}`)?.checked || false;

        let surfaceMursSelectionnee = 0;
        if (mur1Checked) surfaceMursSelectionnee += piece.largeur * piece.hauteur; // Mur 1
        if (mur2Checked) surfaceMursSelectionnee += piece.profondeur * piece.hauteur; // Mur 2
        if (mur3Checked) surfaceMursSelectionnee += piece.largeur * piece.hauteur; // Mur 3
        if (mur4Checked) surfaceMursSelectionnee += piece.profondeur * piece.hauteur; // Mur 4

        moMursHeures += surfaceMursSelectionnee / 150 * 1.7;

        // MO Plafond : seulement si dropdown = "oui"
        const plafondValue = document.getElementById(`plafond_${pieceId}`)?.value || 'non';
        if (plafondValue === 'oui') {
          moPlafondHeures += (piece.surfacePlafond || 0) / 140 * 1.7;
        }

        // MO Moulures : automatique selon la pi√®ce (comme avant)
        moMouluresHeures += (piece.surfaceMoulures || 0) / 100 * 1.7;
      });
    }

    // Ajouter les heures des portes, fen√™tres, divers et plafonds int√©rieures depuis travaux additionnels
    const heuresPortesInterieures = getTotalHeuresPortesInterieures();
    const heuresFenetresInterieures = getTotalHeuresFenetresInterieures();
    const heuresDiversInterieures = getTotalHeuresDiversInterieures();
    const heuresPlafonds = getTotalHeuresPlafonds();

    // Ajouter les heures d'appr√™t global
    const appretGlobalData = getAppretGlobalData();
    const heuresAppretGlobal = appretGlobalData.heures || 0;

    const totalMainOeuvreHours = moMursHeures + moPlafondHeures + moMouluresHeures + heuresPortesInterieures + heuresFenetresInterieures + heuresDiversInterieures + heuresPlafonds + heuresAppretGlobal;
    costs.main_oeuvre_int = totalMainOeuvreHours * tauxHoraireIntValue;
    
    
    // Frais de d√©placement
    const fraisDeplacement = params.frais_deplacement_int || 100;
    
    // NOUVEAU: Calculer automatiquement les gallons selon les ratios et s√©lections
    const productTotals = calculateInteriorProductGallons();

    // Calculer le co√ªt directement avec les totaux
    costs.produits_appliques_int =
      (productTotals.lifemasterGallons * (params.cout_lifemaster_int || 60)) +
      (productTotals.gliddenGallons * (params.cout_glidden_7700_int || 60));

    
    // Pas d'accessoires dans la pr√©paration - co√ªt direct seulement
    costs.accessoires_int = 0; // Pas de section accessoire s√©par√©e
    
    // Total interior cost (pr√©paration inclut d√©j√† d√©placement + main d'oeuvre + produits)
    costs.interieur = costs.preparation_int + costs.main_oeuvre_int + costs.produits_appliques_int;
    
    // Total hours for display (pr√©paration + main d'≈ìuvre calcul√©e)
    hours.interieur = totalPreparationHours + totalMainOeuvreHours;
  } else {
    // Fallback: always calculate minimum 4h preparation + 100$ d√©placement
    const minPreparationHours = 4;
    costs.preparation_int = minPreparationHours * tauxHoraireIntValue;
    
    // FALLBACK: Calculer heures peinture depuis les pi√®ces
    let heuresPeintureAutoFallback = 0;
    document.querySelectorAll('[id^="piece-"]').forEach(piece => {
      const surfaceDisplay = piece.querySelector('.surface-display');
      if (surfaceDisplay && surfaceDisplay.textContent.includes('ft¬≤')) {
        const surfaceMatch = surfaceDisplay.textContent.match(/([\d,]+(?:\.\d+)?)\s*ft¬≤/);
        if (surfaceMatch) {
          const surface = parseFloat(surfaceMatch[1].replace(/,/g, ''));
          if (surface > 0) {
            heuresPeintureAutoFallback += surface / (params.productivite_peinture_int || 400);
          }
        }
      }
    });
    
    costs.main_oeuvre_int = heuresPeintureAutoFallback * tauxHoraireIntValue;
    
    
    const fraisDeplacement = params.frais_deplacement_int || 100;
    
    // Co√ªt des produits int√©rieurs s√©lectionn√©s (per-piece calculation - fallback)
    costs.produits_appliques_int = getSelectedInteriorProductsFromPieces();
    
    // Calcul du sous-total avant accessoires (fallback)
    const subtotalIntFallback = costs.preparation_int + costs.main_oeuvre_int + fraisDeplacement + costs.produits_appliques_int;
    
    // Pas d'accessoires dans la pr√©paration - fallback
    costs.accessoires_int = 0;
    
    costs.interieur = costs.preparation_int + costs.main_oeuvre_int + costs.produits_appliques_int;
    hours.interieur = minPreparationHours + heuresPeintureAutoFallback;
  }

  // Legacy interior costs (keeping for backwards compatibility)
  costs.lavage_int = 0;

  // Lavage int√©rieur (legacy)
  const lavageIntType = document.getElementById('lavageInterieur')?.value;
  const lavageIntQte = parseFloat(document.getElementById('lavageInterieurQte')?.value) || 0;
  const lavageIntUnit = document.getElementById('lavageInterieurUnit')?.value;
  
  costs.hours_lavage_int = 0;
  if (lavageIntType && lavageIntQte > 0) {
    const productivity = params[lavageIntType] || 100;
    costs.hours_lavage_int = lavageIntQte / productivity;
    costs.lavage_int = costs.hours_lavage_int * tauxHoraireValue;
  }

  // Pr√©paration int√©rieur (legacy)
  const prepIntType = document.getElementById('preparationInterieur')?.value;
  const prepIntQte = parseFloat(document.getElementById('preparationInterieurQte')?.value) || 0;
  
  costs.hours_preparation_int = 0;
  if (prepIntType && prepIntQte > 0) {
    const productivity = params[prepIntType] || 80;
    costs.hours_preparation_int = prepIntQte / productivity;
    costs.preparation_int = costs.hours_preparation_int * tauxHoraireValue;
  }

  // Peinture int√©rieur (endroit √† peinturer)
  const endroitIntType = document.getElementById('endroitInterieur')?.value;
  const endroitIntQte = parseFloat(document.getElementById('endroitInterieurQte')?.value) || 0;
  
  if (endroitIntType && endroitIntQte > 0) {
    const pricePerUnit = params[endroitIntType] || 1;
    costs.peinture_int = endroitIntQte * pricePerUnit;
  }

  // Calculer le co√ªt des produits appliqu√©s dans les sections
  costs.produits_appliques = calculateAppliedProductsCost();
    
  // Ajouter les produits ext√©rieurs s√©lectionn√©s dans la nouvelle section
  const exteriorProductsCost = getSelectedExteriorProducts();
  costs.produits_appliques += exteriorProductsCost;

  // Ajouter le primer s√©par√©
  const primerProductsCost = getSelectedPrimerProducts();
  costs.produits_appliques += primerProductsCost;
  
  // Int√©grer les co√ªts dans les bonnes cat√©gories
  costs.produits_appliques += costs.materiaux; // Peinture ext√©rieure -> Co√ªt des Produits
  costs.produits_appliques += costs.produits_fer_forge; // Produits fer forg√© -> Co√ªt des Produits
  // Ajouter fer forg√© dans peinture POUR L'AFFICHAGE main d'≈ìuvre uniquement
  costs.peinture += costs.fer_forge; // Pour affichage main d'≈ìuvre
  hours.peinture += hours.fer_forge; // Pour affichage heures
  
  // Calculate exterior subtotal only
  // Note: costs.peinture contient maintenant costs.revetement + costs.fer_forge
  const subtotal = costs.lavage + costs.preparation + costs.peinture + costs.thirdCoat + costs.primer + costs.produits_appliques;

  // Add accessories (create separate category, don't add to preparation)
  // Accessoires = 1% de TOUTE la main d'≈ìuvre SEULEMENT (pas d√©placement, pas produits)
  const totalMainOeuvre = costs.lavage + costs.preparation + costs.peinture; // peinture contient d√©j√† fer forg√©
  const totalMainOeuvreArrondi = Math.ceil(totalMainOeuvre / 1000) * 1000; // Arrondi au millier SUP√âRIEUR
  const accessoryCost = totalMainOeuvreArrondi / 100; // 1%
  costs.accessoires = accessoryCost;

  // Calculate profit
  const profitMargin = parseFloat(document.getElementById('profitMargin')?.value) || 25;
  // subtotal contient d√©j√† fer forg√© via costs.peinture
  const newSubtotal = subtotal + accessoryCost;
  const profit = newSubtotal * (profitMargin / 100);

  costs.profit = profit;
  costs.subtotal = newSubtotal;
  costs.total = newSubtotal + profit;
  
  // Calculate total gallons from all selected products
  let totalGallons = 0;
  if (selectedProducts.length > 0) {
    selectedProducts.forEach(product => {
      totalGallons += product.gallons;
    });
  } else {
    totalGallons = Math.ceil(totalPaintSurface / selectedProduct.coverage);
  }
  costs.gallons = totalGallons;

  // === CALCUL DES CO√õTS INT√âRIEURS ===
  // (tauxHoraireIntValue d√©j√† d√©fini plus haut)
  
  // Calculer heures peinture depuis les surfaces s√©lectionn√©es individuellement
  let heuresPeintureInt = 0;
  let surfaceTotaleSelectionnee = 0;
  
  // Parcourir toutes les pi√®ces et calculer les surfaces s√©lectionn√©es
  if (typeof piecesInterieur !== 'undefined' && piecesInterieur.length > 0) {
    piecesInterieur.forEach(piece => {
      const pieceId = piece.id;
      
      // R√©cup√©rer les s√©lections des murs individuels
      const mur1Checked = document.getElementById(`mur1_${pieceId}`)?.checked || false;
      const mur2Checked = document.getElementById(`mur2_${pieceId}`)?.checked || false;
      const mur3Checked = document.getElementById(`mur3_${pieceId}`)?.checked || false;
      const mur4Checked = document.getElementById(`mur4_${pieceId}`)?.checked || false;
      
      // R√©cup√©rer les surfaces de chaque mur
      const surfaceMur1 = mur1Checked ? (parseFloat(document.getElementById(`surfaceMur1_${pieceId}`)?.value) || 0) : 0;
      const surfaceMur2 = mur2Checked ? (parseFloat(document.getElementById(`surfaceMur2_${pieceId}`)?.value) || 0) : 0;
      const surfaceMur3 = mur3Checked ? (parseFloat(document.getElementById(`surfaceMur3_${pieceId}`)?.value) || 0) : 0;
      const surfaceMur4 = mur4Checked ? (parseFloat(document.getElementById(`surfaceMur4_${pieceId}`)?.value) || 0) : 0;
      
      const surfaceMursSelectionnee = surfaceMur1 + surfaceMur2 + surfaceMur3 + surfaceMur4;
      
      // Plafond
      const plafondValue = document.getElementById(`plafond_${pieceId}`)?.value || 'non';
      const plafondChecked = plafondValue === 'oui';
      const surfacePlafondSelectionnee = plafondChecked ? piece.surfacePlafond : 0;
      
      // Moulures - Calculer automatiquement selon les murs s√©lectionn√©s (si activ√©es √† la cr√©ation)
      let surfaceMouluresSelectionnee = 0;
      
      if (piece.inclureMoulures) {
        // Calculer moulures uniquement pour les murs s√©lectionn√©s
        if (mur1Checked) surfaceMouluresSelectionnee += piece.largeur; // Mur 1: largeur
        if (mur2Checked) surfaceMouluresSelectionnee += piece.profondeur; // Mur 2: profondeur  
        if (mur3Checked) surfaceMouluresSelectionnee += piece.largeur; // Mur 3: largeur
        if (mur4Checked) surfaceMouluresSelectionnee += piece.profondeur; // Mur 4: profondeur
        
        // Ajouter heures moulures (pieds lin√©aires √∑ productivit√©)
        if (surfaceMouluresSelectionnee > 0) {
          const productiviteMoulures = parseFloat(document.getElementById('ratio_moulures_int')?.value) || 100;
          const heuresMoulures = surfaceMouluresSelectionnee / productiviteMoulures;
          heuresPeintureInt += heuresMoulures;
        }
      }
      
      surfaceTotaleSelectionnee += surfaceMursSelectionnee + surfacePlafondSelectionnee;
    });
    
    if (surfaceTotaleSelectionnee > 0) {
      heuresPeintureInt += surfaceTotaleSelectionnee / (params.productivite_peinture_int || 400);
    }
  }
  
  // Ajouter les heures des travaux additionnels
  let heuresTravaux = 0;
  
  // Portes globales
  const porteGlobalCheckbox = document.getElementById('togglePorteGlobal');
  if (porteGlobalCheckbox && porteGlobalCheckbox.checked) {
    const containers = document.querySelectorAll('[id^="porteGlobale_"]');
    containers.forEach(container => {
      const id = container.id.split('_')[1];
      const heuresField = document.getElementById(`heuresPorteGlobal_${id}`);
      if (heuresField && heuresField.value) {
        heuresTravaux += parseFloat(heuresField.value) || 0;
      }
    });
  }
  
  // Fen√™tres globales
  const fenetreGlobalCheckbox = document.getElementById('toggleFenetreGlobal');
  if (fenetreGlobalCheckbox && fenetreGlobalCheckbox.checked) {
    const containers = document.querySelectorAll('[id^="fenetreGlobale_"]');
    containers.forEach(container => {
      const id = container.id.split('_')[1];
      const heuresField = document.getElementById(`heuresFenetreGlobal_${id}`);
      if (heuresField && heuresField.value) {
        heuresTravaux += parseFloat(heuresField.value) || 0;
      }
    });
  }
  
  // Divers globaux
  const diversGlobalCheckbox = document.getElementById('toggleDiversGlobal');
  if (diversGlobalCheckbox && diversGlobalCheckbox.checked) {
    const containers = document.querySelectorAll('[id^="diversGlobal_"]');
    containers.forEach(container => {
      const id = container.id.split('_')[1];
      const heuresField = document.getElementById(`heuresDiversGlobal_${id}`);
      if (heuresField && heuresField.value) {
        heuresTravaux += parseFloat(heuresField.value) || 0;
      }
    });
  }
  
  // Plafonds globaux
  const plafondGlobalCheckbox = document.getElementById('togglePlafondGlobal');
  if (plafondGlobalCheckbox && plafondGlobalCheckbox.checked) {
    const containers = document.querySelectorAll('[id^="plafondGlobal_"]');
    containers.forEach(container => {
      const id = container.id.split('_')[1];
      const heuresField = document.getElementById(`heuresPlafondGlobal_${id}`);
      if (heuresField && heuresField.value) {
        heuresTravaux += parseFloat(heuresField.value) || 0;
      }
    });
  }
  
  
  // Ajouter les heures de pr√©paration multiples par pi√®ce
  let heuresPreparationsMultiples = 0;
  
  if (typeof piecesInterieur !== 'undefined' && piecesInterieur.length > 0) {
    piecesInterieur.forEach(piece => {
      const pieceId = piece.id;
      
      // V√©rifier si la section pr√©paration est activ√©e pour cette pi√®ce
      const togglePreparation = document.getElementById(`togglePreparation_${pieceId}`);
      if (togglePreparation && togglePreparation.checked) {
        // R√©cup√©rer toutes les pr√©parations multiples de cette pi√®ce
        const preparationContainers = document.querySelectorAll(`[id^="preparationPiece_${pieceId}_"]`);
        preparationContainers.forEach(container => {
          const parts = container.id.split('_');
          if (parts.length >= 3) {
            const counter = parts[2];
            const dureeField = document.getElementById(`dureePreparation_${pieceId}_${counter}`);
            if (dureeField && dureeField.value) {
              const heures = parseFloat(dureeField.value) || 0;
              heuresPreparationsMultiples += heures;
            }
          }
        });
      }
    });
  }
  
  
  // Ajouter les heures et co√ªts d'appr√™t multiples par pi√®ce
  let heuresAppretsMultiples = 0;
  let coutGallonsAppret = 0;
  
  if (typeof piecesInterieur !== 'undefined' && piecesInterieur.length > 0) {
    piecesInterieur.forEach(piece => {
      const pieceId = piece.id;
      
      // V√©rifier si la section appr√™t est activ√©e pour cette pi√®ce
      const toggleAppret = document.getElementById(`toggleAppret_${pieceId}`);
      if (toggleAppret && toggleAppret.checked) {
        // R√©cup√©rer tous les appr√™ts multiples de cette pi√®ce
        const appretContainers = document.querySelectorAll(`[id^="appretPiece_${pieceId}_"]`);
        appretContainers.forEach(container => {
          const parts = container.id.split('_');
          if (parts.length >= 3) {
            const counter = parts[2];
            const typeSelect = document.getElementById(`typeAppret_${pieceId}_${counter}`);
            const surfaceField = document.getElementById(`surfaceAppret_${pieceId}_${counter}`);
            
            if (typeSelect && typeSelect.value && surfaceField && surfaceField.value) {
              const typeAppret = typeSelect.value;
              const surface = parseFloat(surfaceField.value) || 0;
              
              if (surface > 0) {
                // Calculer heures selon type d'appr√™t et surface
                let productivite = 100; // d√©faut
                switch(typeAppret) {
                  case 'mur_plus': productivite = parseFloat(document.getElementById('appret_mur_plus_200')?.value) || 125; break;
                  case 'mur_moins': productivite = parseFloat(document.getElementById('appret_mur_moins_200')?.value) || 100; break;
                  case 'plafond_plus': productivite = parseFloat(document.getElementById('appret_plafond_plus_200')?.value) || 125; break;
                  case 'plafond_moins': productivite = parseFloat(document.getElementById('appret_plafond_moins_200')?.value) || 100; break;
                }
                
                const heuresAppret = surface / productivite;
                heuresAppretsMultiples += heuresAppret;
                
                // Calculer gallons d'appr√™t (250 ft¬≤/gal, toujours arrondi vers le haut)
                const gallonsAppret = Math.ceil(surface / 250);
                coutGallonsAppret += gallonsAppret * 55; // 55$/gal
              }
            }
          }
        });
      }
    });
  }


  // Ajouter les heures d'appr√™t global
  const appretGlobalData = getAppretGlobalData();
  const heuresAppretGlobal = appretGlobalData.heures;

  // Total des heures de main d'≈ìuvre (peinture + travaux additionnels + appr√™ts + appr√™t global)
  const heuresTotalesMainOeuvre = heuresPeintureInt + heuresTravaux + heuresAppretsMultiples + heuresAppretGlobal;
  
  // Calculer heures de pr√©paration totales (4h minimum + pr√©parations multiples)
  const heuresTotalesPreparation = 4 + heuresPreparationsMultiples;
  
  // Co√ªts int√©rieurs (main d'≈ìuvre d√©j√† calcul√© avec nouvelle formule MO murs+plafond+moulures)
  // costs.main_oeuvre_int = heuresTotalesMainOeuvre * tauxHoraireIntValue; // D√âSACTIV√â - √©crasait le bon calcul
  // costs.preparation_int = (heuresTotalesPreparation * tauxHoraireIntValue + 100) * 1.01; // D√âSACTIV√â - pr√©paration √† 0$ pour l'instant

  // Calculer co√ªt des travaux additionnels
  const lifemasterPrice = parseInt(document.getElementById('cout_lifemaster_int')?.value) || 60;
  const coutTravauxAdditionnels =
    (getTotalGallonsPortesInterieures() * lifemasterPrice) +
    (getTotalGallonsMouluresPortes() * lifemasterPrice) +
    (getTotalGallonsFenetresInterieures() * lifemasterPrice) +
    (getTotalGallonsDiversInterieurs() * lifemasterPrice);

  costs.produits_appliques_int = getSelectedInteriorProductsFromPieces() + coutGallonsAppret + coutTravauxAdditionnels;
  
  // Calculer le sous-total int√©rieur
  costs.interieur = costs.preparation_int + costs.main_oeuvre_int + costs.produits_appliques_int;
  
  // Calculer les heures int√©rieures totales (heures pr√©paration + heures peinture + travaux additionnels)
  hours.interieur = heuresTotalesPreparation + heuresTotalesMainOeuvre;
  
  // Calculer les vraies heures MO √† partir du co√ªt pour le log
  const vraiHeuresMOInt = (costs.main_oeuvre_int || 0) / tauxHoraireIntValue;

  return costs;
}

function updateNewResultsUI(costs, hours, selectedProduct, surfaceData) {
  // Note: Total ext√©rieur now uses subTotal ID and is updated by main calculation functions
  // (removed duplicate update to avoid overriding the correct subtotal calculation)
  // Update cost breakdown with corrected values
  if (document.getElementById('costLavage')) {
    document.getElementById('costLavage').textContent = formatCurrency(costs.lavage || 0);
  }
  if (document.getElementById('costPreparation')) {
    document.getElementById('costPreparation').textContent = formatCurrency(costs.preparation || 0);
  }
  // Mettre √† jour les heures de pr√©paration et taux horaire
  // Calculer les heures √©quivalentes bas√©es sur le co√ªt r√©el de pr√©paration
  if (document.getElementById('heuresPreparation')) {
    const tauxHoraire = getCurrentTauxHoraire();
    const heuresEquivalentes = tauxHoraire > 0 ? (costs.preparation || 0) / tauxHoraire : 0;
    document.getElementById('heuresPreparation').textContent = heuresEquivalentes.toFixed(1);
  }
  if (document.getElementById('tauxHorairePreparationDisplay')) {
    document.getElementById('tauxHorairePreparationDisplay').textContent = getCurrentTauxHoraire();
  }
  if (document.getElementById('costPeinture')) {
    document.getElementById('costPeinture').textContent = formatCurrency(costs.peinture || 0);
  }
  if (document.getElementById('costProduits')) {
    document.getElementById('costProduits').textContent = formatCurrency(costs.produits_appliques || 0);
  }
  
  // Update subtotal and totals
  // NOTE: Le sous-total est maintenant g√©r√© par updateSubtotal() qui lit les valeurs du DOM
  // pour inclure correctement les primers "surface compl√®te"
  // if (document.getElementById('subTotal')) {
  //   document.getElementById('subTotal').textContent = formatCurrency(costs.subtotal || 0);
  // }
  // if (document.getElementById('subTotalBreakdown')) {
  //   document.getElementById('subTotalBreakdown').textContent = formatCurrency(costs.subtotal || 0);
  // }
  if (document.getElementById('profitAmountConfig')) {
    document.getElementById('profitAmountConfig').textContent = formatCurrency(costs.profit || 0);
  }
  if (document.getElementById('totalEstimate')) {
    document.getElementById('totalEstimate').textContent = formatCurrency(costs.total || 0); // Total final avec taxes et profit
  }
  
  if (document.getElementById('costRevetement')) {
    document.getElementById('costRevetement').textContent = formatCurrency(costs.revetement || 0);
  }
  if (document.getElementById('costCornichesMoulures')) {
    document.getElementById('costCornichesMoulures').textContent = formatCurrency(costs.corniches_moulures || 0);
  }
  if (document.getElementById('costFenetresVolets')) {
    document.getElementById('costFenetresVolets').textContent = formatCurrency(costs.fenetres_volets || 0);
  }
  if (document.getElementById('costPortes')) {
    document.getElementById('costPortes').textContent = formatCurrency(costs.portes || 0);
  }
  if (document.getElementById('costBalcon')) {
    document.getElementById('costBalcon').textContent = formatCurrency(costs.balcon || 0);
  }
  if (document.getElementById('costCloture')) {
    document.getElementById('costCloture').textContent = formatCurrency(costs.cloture || 0);
  }
  if (document.getElementById('costAutre')) {
    document.getElementById('costAutre').textContent = formatCurrency(costs.autre || 0);
  }
  
  // Affichage des co√ªts de primer et 3e couche individuels
  if (document.getElementById('costPrimer')) {
    document.getElementById('costPrimer').textContent = formatCurrency(costs.primer || 0);
  }
  if (document.getElementById('costThirdCoat')) {
    document.getElementById('costThirdCoat').textContent = formatCurrency(costs.thirdCoat || 0);
  }

  if (document.getElementById('heuresLavage')) {
    document.getElementById('heuresLavage').textContent = hours.lavage.toFixed(1).replace('.', ',') + 'h';
  }
  if (document.getElementById('heuresPeinture')) {
    // Afficher les heures de TOUS les endroits personnalis√©s + 3√®me couche
    const endroitsHours = (hours.revetement || 0) + (hours.corniches_moulures || 0) +
                         (hours.fenetres_volets || 0) + (hours.portes || 0) +
                         (hours.balcon || 0) + (hours.cloture || 0) + (hours.autre || 0);
    // hours.peinture contient maintenant les heures de 3√®me couche ajout√©es
    const params = getCurrentParameterValues();
    const displayHours = endroitsHours > 0 ? (endroitsHours + (costs.troisieme_couche_mo / params.taux_horaire)) : hours.peinture;
    // Afficher avec 2 d√©cimales visuellement, mais utiliser la valeur exacte pour les calculs
    document.getElementById('heuresPeinture').textContent = displayHours.toFixed(1).replace('.', ',') + 'h';
  }
  if (document.getElementById('gallonsPeinture')) {
    document.getElementById('gallonsPeinture').textContent = costs.gallons;
  }

  // Calculer le VRAI total des heures en lisant les valeurs affich√©es
  if (document.getElementById('totalHours')) {
    // Fonction pour parser les heures affich√©es (format: "2,3h")
    const parseHeures = (elementId) => {
      const element = document.getElementById(elementId);
      if (!element) return 0;
      const text = element.textContent || '0';
      // Enlever le 'h' et remplacer ',' par '.'
      const value = parseFloat(text.replace('h', '').replace(',', '.').trim()) || 0;
      return value;
    };

    // Lire les vraies valeurs affich√©es dans le breakdown
    const heuresLavage = parseHeures('heuresLavage');
    const heuresPreparation = parseHeures('heuresPreparation');
    const heuresPeinture = parseHeures('heuresPeinture');

    // Calculer le total r√©el
    const totalHeuresReelles = heuresLavage + heuresPreparation + heuresPeinture;
    document.getElementById('totalHours').textContent = totalHeuresReelles.toFixed(1);
  }

  // NOTE: Le sous-total est maintenant g√©r√© par updateSubtotal()
  // if (document.getElementById('subTotal')) {
  //   document.getElementById('subTotal').textContent = formatCurrency(costs.subtotal);
  // }
  // if (document.getElementById('subTotalBreakdown')) {
  //   document.getElementById('subTotalBreakdown').textContent = formatCurrency(costs.subtotal);
  // }
  if (document.getElementById('tpsAmount')) {
    document.getElementById('tpsAmount').textContent = formatCurrency(costs.tps);
  }
  if (document.getElementById('tvqAmount')) {
    document.getElementById('tvqAmount').textContent = formatCurrency(costs.tvq);
  }
  if (document.getElementById('profitAmountConfig')) {
    document.getElementById('profitAmountConfig').textContent = formatCurrency(costs.profit);
  }

  // Update int√©rieur costs - affichage simplifi√© (pr√©paration, main d'≈ìuvre, co√ªt peinture)
  const params = getCurrentParameterValues();
  const tauxHoraireIntValue = getCurrentTauxHoraire();
  
  // Always update interior UI (handle both cases: with/without heures_int data)
  
  // Pr√©paration (d√©j√† inclut minimum + d√©placement + 1% accessoires)
  if (document.getElementById('costPreparationInt')) {
    document.getElementById('costPreparationInt').textContent = formatCurrency(costs.preparation_int || 0);
  }
  
  // Main d'≈ìuvre - Peinture (toutes les autres sections)
  if (document.getElementById('costMainOeuvreInt')) {
    document.getElementById('costMainOeuvreInt').textContent = formatCurrency(costs.main_oeuvre_int || 0);
  }

  // D√©composition MO: Calculer MO pi√®ce, MO porte, MO fen√™tre, MO divers, MO plafond et MO appr√™t global
  const heuresPortesInterieures = getTotalHeuresPortesInterieures();
  const heuresFenetresInterieures = getTotalHeuresFenetresInterieures();
  const heuresDiversInterieures = getTotalHeuresDiversInterieures();
  const heuresPlafonds = getTotalHeuresPlafonds();
  const appretGlobalData = getAppretGlobalData();
  const heuresAppretGlobal = appretGlobalData.heures || 0;

  // Calculer les heures MO pi√®ce = utiliser les vraies heures totales int√©rieur
  // Le $370.37 est correct, donc on doit calculer les heures √† partir du co√ªt
  const vraiHeuresMOTotal = (costs.main_oeuvre_int || 0) / tauxHoraireIntValue;
  let heuresMOPiece = vraiHeuresMOTotal - heuresPortesInterieures - heuresFenetresInterieures - heuresDiversInterieures - heuresPlafonds - heuresAppretGlobal;

  // Co√ªts
  const costMOAppretGlobal = heuresAppretGlobal * tauxHoraireIntValue;
  const costMOPiece = heuresMOPiece * tauxHoraireIntValue;
  const costMOPorte = heuresPortesInterieures * tauxHoraireIntValue;
  const costMOFenetre = heuresFenetresInterieures * tauxHoraireIntValue;
  const costMODivers = heuresDiversInterieures * tauxHoraireIntValue;
  const costMOPlafond = heuresPlafonds * tauxHoraireIntValue;
  const totalMOHours = vraiHeuresMOTotal;

    // Mise √† jour MO Appr√™t Global
    if (document.getElementById('heuresAppretGlobalInt')) {
      document.getElementById('heuresAppretGlobalInt').textContent = heuresAppretGlobal.toFixed(2);
    }
    if (document.getElementById('coutAppretGlobalInt')) {
      document.getElementById('coutAppretGlobalInt').textContent = costMOAppretGlobal.toFixed(2);
    }

    // Mise √† jour MO pi√®ce
    if (document.getElementById('heuresPiecesInt')) {
      document.getElementById('heuresPiecesInt').textContent = heuresMOPiece.toFixed(2);
    }
    if (document.getElementById('tauxHorairePiecesIntDisplay')) {
      document.getElementById('tauxHorairePiecesIntDisplay').textContent = tauxHoraireIntValue;
    }
    if (document.getElementById('coutPiecesInt')) {
      document.getElementById('coutPiecesInt').textContent = costMOPiece.toFixed(2);
    }

    // Mise √† jour MO porte
    if (document.getElementById('heuresPortesInt')) {
      document.getElementById('heuresPortesInt').textContent = heuresPortesInterieures.toFixed(2);
    }
    if (document.getElementById('tauxHorairePortesIntDisplay')) {
      document.getElementById('tauxHorairePortesIntDisplay').textContent = tauxHoraireIntValue;
    }
    if (document.getElementById('coutPortesInt')) {
      document.getElementById('coutPortesInt').textContent = costMOPorte.toFixed(2);
    }

    // Mise √† jour MO fen√™tre
    if (document.getElementById('heuresFenetresInt')) {
      document.getElementById('heuresFenetresInt').textContent = heuresFenetresInterieures.toFixed(2);
    }
    if (document.getElementById('tauxHoraireFenetresIntDisplay')) {
      document.getElementById('tauxHoraireFenetresIntDisplay').textContent = tauxHoraireIntValue;
    }
    if (document.getElementById('coutFenetresInt')) {
      document.getElementById('coutFenetresInt').textContent = costMOFenetre.toFixed(2);
    }

    // Mise √† jour MO divers
    if (document.getElementById('heuresDiversInt')) {
      document.getElementById('heuresDiversInt').textContent = heuresDiversInterieures.toFixed(2);
    }
    if (document.getElementById('tauxHoraireDiversIntDisplay')) {
      document.getElementById('tauxHoraireDiversIntDisplay').textContent = tauxHoraireIntValue;
    }
    if (document.getElementById('coutDiversInt')) {
      document.getElementById('coutDiversInt').textContent = costMODivers.toFixed(2);
    }

    // Mise √† jour du total MO
    if (document.getElementById('coutTotalMOInt')) {
      document.getElementById('coutTotalMOInt').textContent = (costs.main_oeuvre_int || 0).toFixed(2);
    }

    // Mise √† jour MO plafond
    if (document.getElementById('heuresMOPlafond')) {
      document.getElementById('heuresMOPlafond').textContent = heuresPlafonds.toFixed(1);
    }
    if (document.getElementById('tauxHoraireMOPlafondDisplay')) {
      document.getElementById('tauxHoraireMOPlafondDisplay').textContent = tauxHoraireIntValue;
    }
    if (document.getElementById('costMOPlafond')) {
      document.getElementById('costMOPlafond').textContent = formatCurrency(costMOPlafond);
    }

  // Produits int√©rieur
  if (document.getElementById('costProduitsInt')) {
    document.getElementById('costProduitsInt').textContent = formatCurrency(costs.produits_appliques_int || 0);
  }

  // Heures de pr√©paration int√©rieur
  if (document.getElementById('heuresPreparationInt')) {
    const heuresPreparation = surfaceData.totals?.heures_int?.preparation || 0;
    const preparationGlobaleData = getPreparationGlobalData();
    const heuresPreparationGlobale = preparationGlobaleData.heures || 0;
    const heuresTotalesPreparation = heuresPreparation + heuresPreparationGlobale;
    document.getElementById('heuresPreparationInt').textContent = heuresTotalesPreparation.toFixed(1);
  }

  // Synchroniser les affichages du taux horaire int√©rieur (utilise la variable d√©j√† d√©finie)
  if (document.getElementById('tauxHorairePreparationIntDisplay')) {
    document.getElementById('tauxHorairePreparationIntDisplay').textContent = tauxHoraireIntValue;
  }
  if (document.getElementById('tauxHoraireIntDisplay')) {
    document.getElementById('tauxHoraireIntDisplay').textContent = tauxHoraireIntValue;
  }

  // Temps de pr√©paration int√©rieur = 2% de (pr√©paration + main d'≈ìuvre + produits)
  const coutTempsPreparation = ((costs.preparation_int || 0) + (costs.main_oeuvre_int || 0) + (costs.produits_appliques_int || 0)) * 0.02;

  if (document.getElementById('fraisAdministratifsInt')) {
    document.getElementById('fraisAdministratifsInt').textContent = formatCurrency(coutTempsPreparation);
  }

  // Sous-total int√©rieur (pr√©paration + main d'≈ìuvre + produits + temps de pr√©paration)
  const sousTotal = (costs.preparation_int || 0) + (costs.main_oeuvre_int || 0) + (costs.produits_appliques_int || 0) + coutTempsPreparation;
  if (document.getElementById('subTotalInt')) {
    document.getElementById('subTotalInt').textContent = formatCurrency(sousTotal);
  }
  if (document.getElementById('subTotalIntBreakdown')) {
    document.getElementById('subTotalIntBreakdown').textContent = formatCurrency(sousTotal);
  }

  // TPS et TVQ int√©rieur (pour affichage seulement, comme l'ext√©rieur)
  const tpsInt = sousTotal * 0.05;
  const tvqInt = sousTotal * 0.09975;
  if (document.getElementById('tpsAmountInt')) {
    document.getElementById('tpsAmountInt').textContent = formatCurrency(tpsInt);
  }
  if (document.getElementById('tvqAmountInt')) {
    document.getElementById('tvqAmountInt').textContent = formatCurrency(tvqInt);
  }
  
  if (document.getElementById('heuresMainOeuvreInt')) {
    document.getElementById('heuresMainOeuvreInt').textContent = totalMOHours.toFixed(1);
  }
  
  if (document.getElementById('tauxHoraireIntDisplay')) {
    document.getElementById('tauxHoraireIntDisplay').textContent = tauxHoraireIntValue;
  }
  
  // Co√ªt des Produits
  if (document.getElementById('costPeintureInt')) {
    document.getElementById('costPeintureInt').textContent = formatCurrency(costs.produits_appliques_int || 0);
  }

  // Accessoires int√©rieurs
  if (document.getElementById('costAccessoiresInt')) {
    document.getElementById('costAccessoiresInt').textContent = formatCurrency(costs.accessoires_int || 0);
  }
  
  // Affichage du pourcentage d'accessoires
  const accessoryPercentage = params.accessoires || 1;
  if (document.getElementById('accessoryPercentageIntDisplay')) {
    document.getElementById('accessoryPercentageIntDisplay').textContent = accessoryPercentage;
  }

  // Note: subTotalInt is now updated by the main calculation functions above
  // (removed duplicate update to avoid overriding the correct calculation)
  
  // Calculate and update interior profit margin
  const profitMarginIntValue = parseFloat(document.getElementById('profitMarginInt')?.value) || 25;
  const profitAmountInt = (costs.interieur || 0) * (profitMarginIntValue / 100);
  if (document.getElementById('profitAmountInt')) {
    document.getElementById('profitAmountInt').textContent = formatCurrency(profitAmountInt);
  }

  // Update interior total with profit margin
  const totalInteriorWithProfit = (costs.interieur || 0) + profitAmountInt;
  if (document.getElementById('totalCostInt')) {
    document.getElementById('totalCostInt').textContent = formatCurrency(totalInteriorWithProfit);
  }

  // Update interior total hours - calculer √† partir des co√ªts r√©els
  if (document.getElementById('totalHeuresInt')) {
    const tauxHoraire = getCurrentTauxHoraire();
    if (tauxHoraire > 0) {
      const heuresPreparation = (costs.preparation_int || 0) / tauxHoraire;
      const heuresMainOeuvre = (costs.main_oeuvre_int || 0) / tauxHoraire;
      const heuresTotal = heuresPreparation + heuresMainOeuvre;
      document.getElementById('totalHeuresInt').textContent = heuresTotal.toFixed(1);
    } else {
      document.getElementById('totalHeuresInt').textContent = (hours.interieur || 0).toFixed(1);
    }
  }
  
}

function switchTab(tabName, skipRefresh = false) {
  // V√©rification des permissions pour l'onglet param√®tres-admin
  // TEMPORAIRE: Acc√®s libre aux param√®tres pour d√©veloppement
  // if (tabName === 'parametres-admin' && !canEditParameters) {
  //   warn('Acc√®s refus√©: Permissions insuffisantes pour les Param√®tres Admin');
  //   showNotification('[ERROR] Acc√®s refus√©: Vous n\'avez pas les permissions pour acc√©der aux Param√®tres Admin', 'error');
  //   return; // Emp√™cher l'acc√®s
  // }

  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.add('hidden');
  });

  // Remove active class from all buttons
  document.querySelectorAll('[id$="-tab-btn"]').forEach(btn => {
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-secondary');
  });

  // Show selected tab
  document.getElementById(tabName + '-tab').classList.remove('hidden');

  // CORRECTION: Trouver le bon bouton par le param√®tre tabName
  const activeButton = document.getElementById(tabName + '-tab-btn');
  if (activeButton) {
    activeButton.classList.remove('btn-secondary');
    activeButton.classList.add('btn-primary');
  }

  // AJOUT: Relancer les calculs et actualiser la liste quand on revient sur l'onglet estimation
  // skipRefresh = true quand appel√© depuis chargerProjet pour √©viter double chargement
  if (tabName === 'estimation' && !skipRefresh) {
    setTimeout(() => {
      refreshProductSelection(); // Force l'actualisation de la liste
      updateCalculation();
      updateProgress();
    }, 50);
  }
  
  // Charger la liste des projets si c'est l'onglet projets
  if (tabName === 'mes-projets') {
    afficherListeProjets();
  }

  // Mettre √† jour l'affichage du bouton "Voir Total" sur mobile
  updateVoirTotalButton();
}

// Fonction pour mettre √† jour le bouton "Voir Total" sur mobile
function updateVoirTotalButton() {
  // Fonction placeholder - le bouton est g√©r√© ailleurs si n√©cessaire
}

// Fonction pour basculer le dropdown mobile
function toggleMobileTabsDropdown() {
  const menu = document.getElementById('mobile-tabs-menu');
  const arrow = document.getElementById('mobile-tabs-arrow');

  if (!menu || !arrow) return;

  if (menu.style.display === 'none' || menu.style.display === '') {
    menu.style.display = 'block';
    arrow.style.transform = 'rotate(180deg)';
  } else {
    menu.style.display = 'none';
    arrow.style.transform = 'rotate(0deg)';
  }
}

// Fonction pour switcher les tabs depuis le dropdown mobile
function switchTabMobile(tabName) {
  // Fermer le dropdown
  const menu = document.getElementById('mobile-tabs-menu');
  const arrow = document.getElementById('mobile-tabs-arrow');
  if (menu) menu.style.display = 'none';
  if (arrow) arrow.style.transform = 'rotate(0deg)';

  // Appeler la fonction switchTab existante
  switchTab(tabName);

  // Mettre √† jour le texte et l'ic√¥ne du trigger
  const currentText = document.getElementById('mobile-tabs-current');
  const currentIcon = document.getElementById('mobile-tabs-icon');

  if (!currentText || !currentIcon) return;

  const tabInfo = {
    'estimation': { text: 'Ext√©rieur', icon: 'fa-calculator', color: 'var(--primary-blue)' },
    'interieur': { text: 'Int√©rieur', icon: 'fa-home', color: 'var(--primary-green)' },
    'produits': { text: 'Produits', icon: 'fa-paint-roller', color: 'var(--primary-orange)' },
    'parametres-admin': { text: 'Param√®tres', icon: 'fa-tools', color: 'var(--primary-purple)' },
    'mes-projets': { text: 'Mes Projets', icon: 'fa-folder', color: 'var(--primary-teal)' }
  };

  const info = tabInfo[tabName];
  if (info) {
    currentText.textContent = info.text;
    currentIcon.className = `fas ${info.icon}`;
    currentIcon.style.color = info.color;
  }
}

// Fermer le dropdown mobile quand on clique ailleurs
document.addEventListener('click', function(e) {
  const dropdown = document.getElementById('mobile-tabs-dropdown');
  const menu = document.getElementById('mobile-tabs-menu');
  const arrow = document.getElementById('mobile-tabs-arrow');

  if (!dropdown || !menu || !arrow) return;

  // Si le menu est ouvert et qu'on clique en dehors du dropdown
  if (menu.style.display === 'block' && !dropdown.contains(e.target)) {
    menu.style.display = 'none';
    arrow.style.transform = 'rotate(0deg)';
  }
});

    function getSelectedProductData() {
      
      // R√©cup√©rer les vrais produits s√©lectionn√©s (Dulux, etc.)
      const products = [];
      let totalGallons = 0;
      let totalCost = 0;
      
      // DEBUG: V√©rifier combien d'√©l√©ments sont trouv√©s
      const elements = document.querySelectorAll('[data-price-per-gallon]');
      
      // DEBUG: Lister tous les √©l√©ments trouv√©s
      elements.forEach((el, i) => {
      });
      
      // Chercher tous les inputs avec data-price-per-gallon
      elements.forEach((element, index) => {
        const gallons = parseFloat(element.value) || 0;
        const pricePerGallon = parseFloat(element.getAttribute('data-price-per-gallon')) || 0;
        
        
        if (gallons > 0) {
          
          // Utiliser d'abord data-product-name si disponible (plus fiable)
          let productName = element.getAttribute('data-product-name') || 'Produit inconnu';
          
          // Si pas trouv√© dans l'attribut, chercher dans le HTML parent
          if (productName === 'Produit inconnu') {
            let parent = element.parentElement;
            
            for (let i = 0; i < 5; i++) {
              if (parent) {
                // Chercher dans tous les h5/h6, pas seulement ceux contenant "Dulux"
                const h5Match = parent.innerHTML.match(/<h5[^>]*>([^<]*)<\/h5>/);
                const h6Match = parent.innerHTML.match(/<h6[^>]*>([^<]*)<\/h6>/);
                
                if (h5Match && h5Match[1].trim()) {
                  productName = h5Match[1].trim();
                  break;
                } else if (h6Match && h6Match[1].trim()) {
                  productName = h6Match[1].trim();
                  break;
                }
              }
              parent = parent.parentElement;
              if (!parent) break;
            }
          }
          
          const productCost = gallons * pricePerGallon;
          totalGallons += gallons;
          totalCost += productCost;
          
          const productObj = {
            name: productName,
            gallons: gallons,
            pricePerGallon: pricePerGallon,
            totalCost: productCost,
            sectionName: element.getAttribute('data-section-name') || '',
            sectionId: element.getAttribute('data-section-id') || ''
          };
          
          products.push(productObj);
        } else {
        }
      });
      
      
      if (products.length === 0) {
        return { 
          name: 'Aucun produit s√©lectionn√©', 
          brand: '', 
          price: 0, 
          coverage: 350, 
          gallons: 0, 
          totalCost: 0,
          products: [],
          description: 'Aucun produit trouv√©' 
        };
      }
      
      // Cr√©er le r√©sum√©
      const productNames = products.map(p => `${p.name} (${p.gallons}gal)`).join(', ');
      
      
      const result = {
        name: products.length === 1 ? products[0].name : products.map(p => p.name).join(', '),
        brand: 'Dulux',
        price: products[0]?.pricePerGallon || 0,
        coverage: 350,
        gallons: totalGallons,
        totalCost: totalCost,
        products: products,
        description: `${Math.ceil(totalGallons)} gallons - ${totalCost.toFixed(0)}$`
      };
      
      
      return result;
    }

    function collectSurfaceData() {
      const sections = ['avant', 'droit', 'arriere', 'gauche'];
      const data = {};
      
      // COLLECTE EXT√âRIEUR - comme avant
      const allInputs = document.querySelectorAll('[data-section][data-type]');
      const allTypes = new Set();
      
      allInputs.forEach(input => {
        // Exclude inputs that are part of endroits personnalis√©s (they have data-revetement, data-cloture, etc.)
        const isEndroitInput = input.hasAttribute('data-revetement') || 
                              input.hasAttribute('data-cloture') || 
                              input.hasAttribute('data-corniches') || 
                              input.hasAttribute('data-fenetres') || 
                              input.hasAttribute('data-portes') || 
                              input.hasAttribute('data-balcon') || 
                              input.hasAttribute('data-fer_forge') || 
                              input.hasAttribute('data-autre');
        
        if (!isEndroitInput) {
          const type = input.getAttribute('data-type');
          if (type) {
            allTypes.add(type);
          }
        }
      });
      
      sections.forEach(section => {
        data[section] = {};
        allTypes.forEach(type => {
          // Only look for base surface inputs, not endroit inputs
          const input = document.querySelector(`[data-section="${section}"][data-type="${type}"]:not([data-revetement]):not([data-cloture]):not([data-corniches]):not([data-fenetres]):not([data-portes]):not([data-balcon]):not([data-fer_forge]):not([data-autre])`);
          const value = input ? (parseFloat(input.value) || 0) : 0;
          if (value > 0) {  // Only include non-zero values to reduce data size
            data[section][type] = value;
          }
        });
      });
      
      // COLLECTE INT√âRIEUR - NOUVELLES PI√àCES
      
      // Trouver toutes les pi√®ces int√©rieures cr√©√©es
      const pieces = document.querySelectorAll('[id^="piece-"]');
      
      pieces.forEach((pieceElement, index) => {
        const pieceId = pieceElement.id; // piece-1, piece-2, etc.
        
        // R√©cup√©rer le type de pi√®ce depuis l'√©l√©ment
        const pieceTypeEl = pieceElement.querySelector('.piece-type');
        const pieceType = pieceTypeEl ? pieceTypeEl.textContent.toLowerCase().replace(/\s+/g, '_') : 'piece';
        
        // Chercher les inputs de pr√©paration et autres travaux dans cette pi√®ce
        const preparationCheckbox = pieceElement.querySelector('input[type="checkbox"]:checked');
        const durationInput = pieceElement.querySelector('input[placeholder="Dur√©e (heures)"]');
        
        if (preparationCheckbox) {
          const duration = parseFloat(durationInput?.value || 0);
          if (duration > 0) {
            const surfaceKey = `int_${pieceType}_preparation`;
            data[surfaceKey] = duration * 100; // Convertir les heures en "surface" pour la coh√©rence
            log(`DEBUG COLLECTE: Ajout√© ${surfaceKey} = ${data[surfaceKey]}`);
          }
        }
        
        // Chercher les calculs de produits pour cette pi√®ce
        const surfaceDisplay = pieceElement.querySelector('.surface-display');
        if (surfaceDisplay && surfaceDisplay.textContent.includes('ft¬≤')) {
          const surfaceMatch = surfaceDisplay.textContent.match(/([\d,]+(?:\.\d+)?)\s*ft¬≤/);
          if (surfaceMatch) {
            const surface = parseFloat(surfaceMatch[1].replace(/,/g, ''));
            if (surface > 0) {
              const surfaceKey = `int_${pieceType}_peinture`;
              data[surfaceKey] = surface;
              log(`DEBUG COLLECTE: Ajout√© ${surfaceKey} = ${surface} ft¬≤`);
            }
          }
        }
      });
      
      log('DEBUG COLLECTE: Donn√©es finales collect√©es:', data);
      return data;
    }

    function collectEndroitData() {
      const data = {};
      
      // Collecter seulement les containers d'endroits principaux
      document.querySelectorAll('[id^="endroit_"][id$="-container"]').forEach(endroitContainer => {
        const endroitId = endroitContainer.id;
        const endroitData = {};
        
        // Trouver la cat√©gorie principale de l'endroit
        let endroitCategory = 'Autre';
        let endroitTitle = '';
        
        // Mapper les codes d'endroit vers les cat√©gories principales
        const categoryMapping = {
          'revetement': 'Rev√™tement',
          'corniches': 'Corniches et moulures', 
          'fenetres': 'Fen√™tres et volets',
          'portes': 'Portes et cadres de porte',
          'balcon': 'Balcon',
          'cloture': 'Cl√¥ture',
          'fer_forge': 'Fer forg√©',
          'autre': 'Autre'
        };
        
        // Chercher le type d'endroit dans les inputs de ce container
        const endroitInputs = endroitContainer.querySelectorAll('[data-revetement], [data-cloture], [data-corniches], [data-fenetres], [data-portes], [data-balcon], [data-fer_forge], [data-autre]');
        if (endroitInputs.length > 0) {
          const firstInput = endroitInputs[0];
          for (const [key, value] of Object.entries(categoryMapping)) {
            if (firstInput.hasAttribute(`data-${key}`)) {
              endroitCategory = value;
              break;
            }
          }
        }
        
        // R√©cup√©rer le titre technique depuis le h5 
        const titleElement = endroitContainer.querySelector('h5');
        if (titleElement) {
          const fullTitle = titleElement.textContent.trim();
          // Format: "Peinture - Cl√¥ture" -> extraire "Cl√¥ture" mais on l'ignore car on a d√©j√† la cat√©gorie
          if (fullTitle.includes(' - ')) {
            endroitTitle = fullTitle.split(' - ')[1];
          } else {
            endroitTitle = fullTitle;
          }
        }
        
        // Fallback
        if (!endroitTitle) {
          endroitTitle = endroitCategory;
        }
        
        // Collecter les sous-sections avec leurs donn√©es
        const sousSections = endroitContainer.querySelectorAll('[id*="_"][class*="border-l-4"]');
        sousSections.forEach(sousSection => {
          const sousSectionId = sousSection.id;
          
          // Trouver le titre de la sous-section (type de travail)
          const titleElement = sousSection.querySelector('h6');
          const sousTypeTitle = titleElement ? titleElement.textContent.trim() : '';
          
          // Collecter les inputs de surface (4 c√¥t√©s: avant, droit, arri√®re, gauche)
          const inputs = sousSection.querySelectorAll('input[type="number"]');
          const surfaces = {};
          let totalSurface = 0;
          
          inputs.forEach((input, index) => {
            const value = parseFloat(input.value) || 0;
            if (value > 0) {
              const coteNames = ['avant', 'droit', 'arri√®re', 'gauche'];
              const coteName = coteNames[index] || `surface_${index + 1}`;
              surfaces[coteName] = value;
              totalSurface += value;
            }
          });
          
          // Collecter les selects (type de produit, etc.)
          const selects = sousSection.querySelectorAll('select');
          const options = {};
          selects.forEach(select => {
            if (select.value) {
              const optionName = select.getAttribute('data-option') || 'type';
              options[optionName] = select.value;
            }
          });
          
          // Collecter les informations sur les produits (primer, 3√®me couche, gallons)
          const productInfo = {};
          
          // Chercher les produits dans ce conteneur
          const productElements = sousSection.querySelectorAll('[data-price-per-gallon]');
          productElements.forEach(productEl => {
            const gallons = parseFloat(productEl.value) || 0;
            if (gallons > 0) {
              const productContainer = productEl.closest('div');
              
              // Chercher primer et 3√®me couche
              const primer = productContainer.querySelector('input[id*="primer"]:checked');
              const thirdCoat = productContainer.querySelector('input[id*="third"]:checked, input[id*="couche"]:checked');
              
              // Trouver le nom du produit
              let productName = 'Produit standard';
              if (productContainer.innerHTML.includes('Dulux')) {
                const duluxMatch = productContainer.innerHTML.match(/Dulux[^<"]*/);
                if (duluxMatch) productName = duluxMatch[0].trim();
              }
              
              productInfo.produit = productName;
              productInfo.gallons = gallons;
              productInfo.primer = primer ? 'Oui' : 'Non';
              productInfo.troisieme_couche = thirdCoat ? 'Oui' : 'Non';
            }
          });
          
          if (totalSurface > 0 || Object.keys(options).length > 0) {
            endroitData[sousSectionId] = {
              type: sousTypeTitle,
              surfaces: surfaces,
              totalSurface: totalSurface,
              options: options,
              product: productInfo
            };
          }
        });
        
        if (Object.keys(endroitData).length > 0) {
          data[endroitId] = {
            title: endroitTitle,
            category: endroitCategory || endroitTitle, // Nouvelle propri√©t√© pour la cat√©gorie principale
            sections: endroitData
          };
        }
      });
      
      return data;
    }

    function calculateEndroitHours(endroitData) {
      const params = getCurrentParameterValues();
      let totalHours = {
        lavage: 0,
        preparation: 0,
        peinture: 0
      };
      
      // Parcourir chaque endroit
      Object.values(endroitData).forEach(endroit => {
        if (endroit.sections) {
          // Parcourir chaque section de l'endroit
          Object.values(endroit.sections).forEach(section => {
            const totalSurface = section.totalSurface || 0;
            const type = section.type || '';
            
            if (totalSurface > 0) {
              // Calculer les heures bas√©es sur le type de travail
              if (type.includes('Fascia') || type.includes('Moulure')) {
                // Fascia/Moulure - exemple: 30 ft/h
                const rate = type.includes('30 ft/h') ? 30 : 25;
                totalHours.peinture += totalSurface / rate;
              } else if (type.includes('bardeau')) {
                // Bardeau - exemple: 55 ft¬≤/h
                const rate = type.includes('55 ft¬≤/h') ? 55 : 45;
                totalHours.peinture += totalSurface / rate;
              } else if (type.includes('Rev√™tement')) {
                // Rev√™tement - exemple: 75 ft¬≤/h
                const rate = type.includes('75 ft¬≤/h') ? 75 : 65;
                totalHours.peinture += totalSurface / rate;
              } else {
                // Taux par d√©faut
                totalHours.peinture += totalSurface / params.peinture_latte_4po;
              }
            }
          });
        }
      });
      
      return totalHours;
    }

    function calculateEndroitCosts(endroitData) {
      const params = getCurrentParameterValues();
      const endroitHours = calculateEndroitHours(endroitData);
      
      // Calculer les gallons de peinture n√©cessaires
      let totalSurface = 0;
      let totalGallons = 0;
      let totalMateriauxCost = 0;
      
      Object.values(endroitData).forEach(endroit => {
        if (endroit.sections) {
          Object.values(endroit.sections).forEach(section => {
            const surface = section.totalSurface || 0;
            totalSurface += surface;
            
            // Calculer gallons bas√©s sur le taux de couverture (d√©faut: 350 ft¬≤/gallon)
            const coverage = params.couverture_peinture || 350;
            const gallons = Math.ceil(surface / coverage);
            totalGallons += gallons;
            
            // Calculer co√ªt des mat√©riaux (d√©faut: 45$ par gallon)
            const prixParGallon = params.prix_peinture || 45;
            totalMateriauxCost += gallons * prixParGallon;
          });
        }
      });
      
      return {
        lavage: endroitHours.lavage * params.taux_horaire,
        preparation: endroitHours.preparation * params.taux_horaire,
        peinture: endroitHours.peinture * params.taux_horaire,
        materiaux: totalMateriauxCost,
        gallons: totalGallons,
        surface: totalSurface
      };
    }

    function calculateHours(surfaceData) {
      let totalHours = {
        lavage: 0,
        preparation: 0,
        peinture: 0
      };
      
      // Get current parameter values
      const params = getCurrentParameterValues();
      
      Object.values(surfaceData).forEach(section => {
        totalHours.lavage += section.lavage_pression / params.lavage_pression;
        totalHours.lavage += section.lavage_main / params.lavage_main_surface;
        totalHours.preparation += section.sablage / params.sablage_surface;
        totalHours.peinture += section.peinture / params.peinture_latte_4po; // Default painting rate
      });
      
      // Apply minimum preparation hours
      log(`[FIX] DEBUG HEURES MIN PREP: calcul√©=${totalHours.preparation}h, minimum=${params.heures_min_prep}h`);
      totalHours.preparation = Math.max(totalHours.preparation, params.heures_min_prep);
      log(`[FIX] APR√àS Math.max: ${totalHours.preparation}h`);
      
      return totalHours;
    }

    function calculateCosts(hours, surfaceData, selectedProduct) {
      const params = getCurrentParameterValues();
      
      const costs = {
        lavage: hours.lavage * params.taux_horaire,
        preparation: (hours.preparation * params.taux_horaire) + params.frais_deplacement,
        peinture: hours.peinture * params.taux_horaire,
        materiaux: 0,
        thirdCoat: 0
      };
      
      // Calculate total paint surface
      let totalPaintSurface = 0;
      Object.values(surfaceData).forEach(section => {
        totalPaintSurface += section.peinture;
      });
      
      // Calculate paint needed and cost
      const gallonsNeeded = Math.ceil(totalPaintSurface / selectedProduct.coverage);
      costs.materiaux = gallonsNeeded * selectedProduct.price;
      
      // Third coat and primer costs for individual products (legacy function)
      costs.primer = 0;
      const selectedProducts = getSelectedProducts();
      
      if (selectedProducts.length > 0) {
        selectedProducts.forEach(product => {
          // Calculate third coat cost for this product if needed
          if (product.needsThirdCoat) {
            // Calculate proportion of painting hours for this product
            const totalGallons = selectedProducts.reduce((sum, p) => sum + p.gallons, 0);
            const productPaintHours = (hours.peinture * product.gallons) / totalGallons;
            costs.thirdCoat += productPaintHours * params.taux_horaire * 0.5;
          }
          
          // Calculate primer cost for this product if needed
          if (product.needsPrimer) {
            // Use default primer price and coverage from parameters
            const primerPrice = parseFloat(document.getElementById('param_dulux_gripper_prix')?.value) || 100;
            const primerCoverage = parseFloat(document.getElementById('param_dulux_gripper_couverture')?.value) || 200;
            
            // Estimate primer gallons needed based on product coverage
            // PRIMER = UNE SEULE COUCHE
            // product.gallons contient 2 couches, on doit retrouver la surface
            const productSurface = (product.gallons * product.ratio) / 1.7;
            const primerGallons = Math.ceil(productSurface / primerCoverage);
            costs.primer += primerGallons * primerPrice;
          }
        });
      } else {
        // Fallback to global third coat setting if no products selected
        if (document.getElementById('thirdCoat')?.value === 'oui') {
          costs.thirdCoat = hours.peinture * params.taux_horaire * 0.5;
        }
      }
      
      // Calculate subtotal
      const subtotal = costs.lavage + costs.preparation + costs.peinture + costs.materiaux + costs.thirdCoat + costs.primer;
      
      // Add products costs from the new products section
      costs.produits = 0;
      document.querySelectorAll('[id^="produit_existant_"]').forEach(produitDiv => {
        const produitId = produitDiv.id;
        const prixElement = document.getElementById(`${produitId}-prix`);
        const gallonsElement = document.getElementById(`${produitId}-gallons`);
        
        if (prixElement && gallonsElement) {
          const prix = parseFloat(prixElement.value) || 0;
          const gallonsText = gallonsElement.textContent || '0.0 gal';
          const gallons = parseFloat(gallonsText.replace(' gal', '')) || 0;
          
          costs.produits += prix * gallons;
        }
      });

      // Add accessories (create separate category, don't add to preparation)
      const accessoryCost = subtotal * (params.accessoires / 100);
      costs.accessoires = accessoryCost;
      
      // Calculate profit
      const profitMargin = parseFloat(document.getElementById('profitMargin')?.value) || 25;
      const newSubtotal = subtotal + accessoryCost + costs.produits;
      const profit = newSubtotal * (profitMargin / 100);
      
      costs.profit = profit;
      costs.subtotal = newSubtotal;
      costs.total = newSubtotal + profit;
      costs.gallons = gallonsNeeded;
      
      return costs;
    }

    function getCurrentTauxHoraire() {
      return parseFloat(document.getElementById('param_taux_horaire')?.value) || 43;
    }

    function updateAllTauxHoraireDisplays() {
      const tauxHoraire = getCurrentTauxHoraire();

      // Tous les affichages de taux horaire
      const displays = [
        'tauxHoraireLavageDisplay',
        'tauxHorairePreparationDisplay',
        'tauxHorairePeintureDisplay',
        'tauxHorairePreparationIntDisplay',
        'tauxHoraireMOPieceDisplay',
        'tauxHoraireMOPorteDisplay',
        'tauxHoraireMOFenetreDisplay',
        'tauxHoraireMODiversDisplay',
        'tauxHoraireMOPlafondDisplay',
        'tauxHoraireIntDisplay'
      ];

      displays.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = tauxHoraire;
        }
      });

      // Mettre √† jour aussi les inputs
      const inputs = ['tauxHoraire', 'tauxHoraireInt'];
      inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.value = tauxHoraire;
        }
      });
    }

    function getCurrentParameterValues() {
      const params = {};

      // Fonction pour convertir les valeurs d√©cimales vers leurs fractions exactes
      const convertToExactFraction = (value) => {
        const rounded = Math.round(value * 100) / 100; // Arrondir √† 2 d√©cimales

        // Convertir les valeurs communes vers leurs fractions exactes
        if (Math.abs(rounded - 0.33) < 0.01) return 1/3;   // 0.333333... (tol√®re 0.32-0.34)
        if (Math.abs(rounded - 0.66) < 0.01) return 2/3;   // 0.666666... (tol√®re 0.65-0.68)
        if (Math.abs(rounded - 0.67) < 0.01) return 2/3;   // 0.666666... (tol√®re 0.66-0.68)
        if (Math.abs(rounded - 0.17) < 0.01) return 1/6;   // 0.166666... (tol√®re 0.16-0.18)
        if (Math.abs(rounded - 0.16) < 0.01) return 1/6;   // 0.166666... (tol√®re 0.15-0.17)

        return value; // Retourner la valeur originale si pas de conversion
      };

      // Get all parameter values from inputs
      Object.keys(DEFAULT_PARAMETERS).forEach(key => {
        const element = document.getElementById(`param_${key}`);
        if (element) {
          // Debug pour taux_horaire
          if (key === 'taux_horaire') {
          }
          let rawValue = element.value;
          // Convertir l'affichage "0.33" vers la valeur exacte 1/3
          if (rawValue === '0.33' && (key === 'grat_spot_20min' || key === 'porte_facile' || key === 'autre_20min' || key === 'fenetre_facile_cadre')) {
            rawValue = 0.333333333333333;
          } else {
            rawValue = parseFloat(rawValue.replace(',', '.')) || DEFAULT_PARAMETERS[key];
          }
          params[key] = rawValue;
        } else {
          params[key] = DEFAULT_PARAMETERS[key];
        }
      });
      
      return params;
    }

    // D√âSACTIV√â: Fonction de normalisation des fractions
    // function normalizeParameterDisplays() { ... }

    // === PRODUCT SYNCHRONIZATION FUNCTIONS ===

    function refreshProductSelection() {
      const checkboxesContainer = document.getElementById('productCheckboxes');
      if (!checkboxesContainer) return;

      // Clear existing checkboxes
      checkboxesContainer.innerHTML = '';

      // Get all products from the table
      const products = getAllProductsFromTable();
      
      products.forEach((product, index) => {
        const productCard = document.createElement('div');
        productCard.className = 'surface-card p-3 relative';
        
        productCard.innerHTML = `
          <div class="flex items-start space-x-3">
            <input type="checkbox" id="product_${index}" name="selectedProducts" value="${index}" 
                   class="form-checkbox h-4 w-4 text-blue-600 mt-1" onchange="updateCalculation(); autoSaveParameters();">
            <div class="flex-1">
              <div class="font-medium text-white mb-2">${product.produit}</div>
              <div class="text-sm text-white mb-2">${product.type}</div>
              <div class="flex justify-between items-center text-xs mb-2">
                <span class="product-badge px-2 py-1 rounded">
                  ${product.ratio} ft¬≤/gal
                </span>
                <span class="font-semibold text-white">
                  $${product.prix}/gal
                </span>
              </div>
              <div class="flex items-center space-x-2 mt-2">
                <label class="text-xs text-white flex-shrink-0">Gallons:</label>
                <input type="number" id="gallons_${index}" value="1" min="0" step="0.5" 
                       class="input-field text-xs w-16 h-6 px-2 py-1" 
                       onchange="updateProductPrice(${index}); updateCalculation();"
                       oninput="updateProductPrice(${index})">
                <span class="text-xs font-semibold text-red-600" id="total_price_${index}">
                  $${(product.prix * 1).toFixed(2)}
                </span>
              </div>
              <!-- Options individuelles pour primer et 3e couche -->
              <div class="flex items-center space-x-4 mt-3 pt-2 border-t border-gray-700/50">
                <div class="flex items-center space-x-1">
                  <input type="checkbox" id="primer_${index}" 
                         class="form-checkbox h-3 w-3 text-green-600" 
                         onchange="updateCalculation(); autoSaveParameters();">
                  <label for="primer_${index}" class="text-xs text-white">Primer n√©cessaire</label>
                </div>
                <div class="flex items-center space-x-1">
                  <input type="checkbox" id="thirdCoat_${index}" 
                         class="form-checkbox h-3 w-3 text-orange-600" 
                         onchange="updateCalculation(); autoSaveParameters();">
                  <label for="thirdCoat_${index}" class="text-xs text-white">3e couche n√©cessaire</label>
                </div>
              </div>
            </div>
          </div>
        `;
        
        checkboxesContainer.appendChild(productCard);
      });

      // No products pre-selected by default - user must manually select
    }

    function getAllProductsFromTable() {
      const products = [];
      const tbody = document.getElementById('products-table-body');
      if (!tbody) return products;

      const rows = tbody.querySelectorAll('tr');
      rows.forEach(row => {
        const typeInput = row.querySelector('[data-field="type"]');
        const ratioInput = row.querySelector('[data-field="ratio"]');
        const prixInput = row.querySelector('[data-field="prix"]');

        if (typeInput && ratioInput && prixInput) {
          products.push({
            type: typeInput.value,
            ratio: parseFloat(ratioInput.value) || 0,
            prix: parseFloat(prixInput.value) || 0
          });
        }
      });

      return products;
    }

    function getSelectedProducts() {
      const checkboxes = document.querySelectorAll('input[name="selectedProducts"]:checked');
      const products = getAllProductsFromTable();
      const selectedProducts = [];

      checkboxes.forEach(checkbox => {
        const index = parseInt(checkbox.value);
        if (products[index]) {
          const gallonsInput = document.getElementById(`gallons_${index}`);
          const gallons = parseFloat(gallonsInput?.value) || 1;
          
          // Capturer les options primer et 3e couche individuelles
          const primerCheckbox = document.getElementById(`primer_${index}`);
          const thirdCoatCheckbox = document.getElementById(`thirdCoat_${index}`);
          
          selectedProducts.push({
            ...products[index],
            gallons: gallons,
            totalPrice: products[index].prix * gallons,
            needsPrimer: primerCheckbox?.checked || false,
            needsThirdCoat: thirdCoatCheckbox?.checked || false,
            index: index // Ajouter l'index pour r√©f√©rence
          });
        }
      });

      return selectedProducts;
    }

    function updateProductPrice(productIndex) {
      const products = getAllProductsFromTable();
      const gallonsInput = document.getElementById(`gallons_${productIndex}`);
      const totalPriceSpan = document.getElementById(`total_price_${productIndex}`);

      if (gallonsInput && totalPriceSpan && products[productIndex]) {
        const gallons = parseFloat(gallonsInput.value) || 0;
        const pricePerGallon = products[productIndex].prix;
        const totalPrice = gallons * pricePerGallon;

        totalPriceSpan.textContent = `$${totalPrice.toFixed(2)}`;

        // Synchroniser avec selectedProducts si le produit correspond
        const productType = products[productIndex].type.toLowerCase().replace(/\s+/g, '_');
        Object.keys(selectedProducts).forEach(productKey => {
          if (productKey.startsWith(productType)) {
            selectedProducts[productKey].quantity = gallons;
            selectedProducts[productKey].total = gallons * selectedProducts[productKey].price;
          }
        });

        // Mettre √† jour l'affichage des d√©tails des produits
        updateProductDetails();
      }
    }

    // === PRODUCT STORAGE FUNCTIONS ===

    function saveProductsToStorage() {
      try {
        const products = getAllProductsFromTable();
        const saveKey = `estimationProducts_${username}`;
        localStorage.setItem(saveKey, JSON.stringify(products));
        log('Produits sauvegard√©s automatiquement');
      } catch (error) {
        error('Erreur lors de la sauvegarde des produits:', error);
      }
    }

    function loadProductsFromStorage() {
      try {
        const saveKey = `estimationProducts_${username}`;
        const saved = localStorage.getItem(saveKey);
        
        if (saved) {
          const products = JSON.parse(saved);
          populateProductsTable(products);
          log('Produits charg√©s depuis localStorage');
        }
      } catch (error) {
        error('Erreur lors du chargement des produits:', error);
      }
    }

    function populateProductsTable(products) {
      const tbody = document.getElementById('products-table-body');
      if (!tbody) return;

      // V√©rifier le r√¥le - entrepreneurs ne peuvent PAS modifier les produits
      const currentRole = localStorage.getItem('userRole') || 'entrepreneur';
      const canEditProducts = (currentRole === 'coach' || currentRole === 'direction');

      // Clear existing products except the first few defaults
      tbody.innerHTML = '';

      products.forEach(product => {
        const newRow = document.createElement('tr');
        newRow.className = 'hover:bg-slate-700/50';

        if (canEditProducts) {
          // Coach/Direction: inputs modifiables
          newRow.innerHTML = `
            <td class="border: 1px solid var(--border-dark); px-4 py-3">
              <input type="text" value="${product.type}" class="input-field" data-field="type" onchange="syncProductChanges()">
            </td>
            <td class="border: 1px solid var(--border-dark); px-4 py-3">
              <input type="number" value="${product.ratio}" class="input-field" data-field="ratio" onchange="syncProductChanges()">
            </td>
            <td class="border: 1px solid var(--border-dark); px-4 py-3">
              <input type="number" value="${product.prix}" class="input-field" data-field="prix" onchange="syncProductChanges()">
            </td>
            <td class="border: 1px solid var(--border-dark); px-4 py-3 text-center">
              <button class="btn-secondary text-xs px-2 py-1" onclick="removeProduct(this)" title="Supprimer">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
        } else {
          // Entrepreneur: lecture seule (divs non modifiables)
          newRow.innerHTML = `
            <td class="border: 1px solid var(--border-dark); px-4 py-3">
              <div class="w-full px-2 py-1 rounded" style="background-color: #172033; color: var(--text-light);">${product.type}</div>
              <input type="hidden" data-field="type" value="${product.type}">
            </td>
            <td class="border: 1px solid var(--border-dark); px-4 py-3">
              <div class="w-full px-2 py-1 rounded" style="background-color: #172033; color: var(--text-light);">${product.ratio}</div>
              <input type="hidden" data-field="ratio" value="${product.ratio}">
            </td>
            <td class="border: 1px solid var(--border-dark); px-4 py-3">
              <div class="w-full px-2 py-1 rounded" style="background-color: #172033; color: var(--text-light);">${product.prix}</div>
              <input type="hidden" data-field="prix" value="${product.prix}">
            </td>
            <td class="border: 1px solid var(--border-dark); px-4 py-3 text-center" style="display: none;">
            </td>
          `;
        }

        tbody.appendChild(newRow);
      });
    }

    function updateResultsUI(costs, hours, selectedProduct) {
      // Note: Total ext√©rieur now uses subTotal ID and is updated by main calculation functions

      // Update cost breakdown
      document.getElementById('costLavage').textContent = formatCurrency(costs.lavage);
      document.getElementById('costPreparation').textContent = formatCurrency(costs.preparation);
      document.getElementById('costPeinture').textContent = formatCurrency(costs.peinture);
      document.getElementById('costProduits').textContent = formatCurrency(costs.produits_appliques || 0);

      // Affichage des co√ªts de primer et 3e couche individuels (legacy function)
      if (document.getElementById('costPrimer')) {
        document.getElementById('costPrimer').textContent = formatCurrency(costs.primer || 0);
      }
      if (document.getElementById('costThirdCoat')) {
        document.getElementById('costThirdCoat').textContent = formatCurrency(costs.thirdCoat || 0);
      }

      document.getElementById('heuresLavage').textContent = hours.lavage.toFixed(1).replace('.', ',') + 'h';

      // Mettre √† jour les heures de pr√©paration
      if (document.getElementById('heuresPreparation')) {
        const tauxHoraire = getCurrentTauxHoraire();
        const heuresEquivalentes = tauxHoraire > 0 ? (costs.preparation || 0) / tauxHoraire : 0;
        document.getElementById('heuresPreparation').textContent = heuresEquivalentes.toFixed(1);
      }

      // Afficher les heures de TOUS les endroits personnalis√©s
      const endroitsHours = (hours.revetement || 0) + (hours.corniches_moulures || 0) +
                           (hours.fenetres_volets || 0) + (hours.portes || 0) +
                           (hours.balcon || 0) + (hours.cloture || 0) + (hours.autre || 0);
      // Inclure les heures de 3√®me couche
      const params = getCurrentParameterValues();
      const displayHours = endroitsHours > 0 ? (endroitsHours + (costs.troisieme_couche_mo / params.taux_horaire)) : hours.peinture;
      // Afficher avec 2 d√©cimales visuellement, mais utiliser la valeur exacte pour les calculs
      document.getElementById('heuresPeinture').textContent = displayHours.toFixed(1).replace('.', ',') + 'h';
      document.getElementById('gallonsPeinture').textContent = costs.gallons;

      // Calculer le VRAI total des heures en lisant les valeurs affich√©es
      // Fonction pour parser les heures affich√©es (format: "2,3h")
      const parseHeures = (elementId) => {
        const element = document.getElementById(elementId);
        if (!element) return 0;
        const text = element.textContent || '0';
        // Enlever le 'h' et remplacer ',' par '.'
        const value = parseFloat(text.replace('h', '').replace(',', '.').trim()) || 0;
        return value;
      };

      // Lire les vraies valeurs affich√©es dans le breakdown
      const heuresLavage = parseHeures('heuresLavage');
      const heuresPreparation = parseHeures('heuresPreparation');
      const heuresPeinture = parseHeures('heuresPeinture');

      // Calculer le total r√©el
      const totalHeuresReelles = heuresLavage + heuresPreparation + heuresPeinture;
      document.getElementById('totalHours').textContent = totalHeuresReelles.toFixed(1);

      // NOTE: Le sous-total est maintenant g√©r√© par updateSubtotal()
      // document.getElementById('subTotal').textContent = formatCurrency(costs.subtotal);
      document.getElementById('profitAmountConfig').textContent = formatCurrency(costs.profit);
    }

    function updateProgress() {
      // Client info progress
      const clientFields = ['clientName', 'clientAddress', 'clientPhone'];
      const clientProgress = clientFields.filter(id => {
        const element = document.getElementById(id);
        return element && element.value.trim() !== '';
      }).length / clientFields.length * 100;
      
      const progressClient = document.getElementById('progressClient');
      const progressBarClient = document.getElementById('progressBarClient');
      if (progressClient) {
        progressClient.textContent = Math.round(clientProgress) + '%';
      }
      if (progressBarClient) {
        progressBarClient.style.width = clientProgress + '%';
      }
      
      // Measurements progress
      const surfaceInputs = document.querySelectorAll('.surface-input');
      const filledInputs = Array.from(surfaceInputs).filter(input => parseFloat(input.value) > 0).length;
      const measuresProgress = surfaceInputs.length > 0 ? (filledInputs / surfaceInputs.length * 100) : 0;
      
      const progressMesures = document.getElementById('progressMesures');
      const progressBarMesures = document.getElementById('progressBarMesures');
      if (progressMesures) {
        progressMesures.textContent = Math.round(measuresProgress) + '%';
      }
      if (progressBarMesures) {
        progressBarMesures.style.width = measuresProgress + '%';
      }
    }

    // === PARAMETER MANAGEMENT FUNCTIONS ===

    async function saveAllParameters() {
      // V√©rifier les permissions avant de sauvegarder
      if (!canEditParameters) {
        showNotification('[ERROR] Acc√®s refus√©: Vous n\'avez pas les permissions pour modifier les param√®tres', 'error');
        warn('Tentative de sauvegarde sans permissions:', username);
        return;
      }
      
      const params = getCurrentParameterValues();
      
      try {
        // Sauvegarder via l'API (param√®tres globaux pour tous)
        const response = await fetch(`/api/parameters?username=${encodeURIComponent(username)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            parameters: params
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          showNotification('[OK] Param√®tres globaux sauvegard√©s et synchronis√©s pour tous les utilisateurs!', 'success');
          log('Param√®tres sauvegard√©s globalement:', params);
        } else {
          throw new Error('Erreur r√©seau');
        }
      } catch (error) {
        error('Erreur lors de la sauvegarde:', error);
        showNotification('Erreur lors de la sauvegarde des param√®tres.', 'error');
        // Fallback vers localStorage en cas d'erreur
        const saveKey = `estimationParams_${username}`;
        localStorage.setItem(saveKey, JSON.stringify(params));
      }
      
      updateCalculation();
    }

    async function loadAllParameters() {
      try {
        // Charger les param√®tres globaux depuis l'API
        const response = await fetch('/api/parameters');
        
        if (response.ok) {
          const result = await response.json();
          const params = result.parameters;
          
          if (params && Object.keys(params).length > 0) {
            // Load each parameter into its input field
            Object.keys(params).forEach(key => {
              const element = document.getElementById(`param_${key}`);
              if (element) {
                element.value = params[key];
              }
            });
            
            log('Param√®tres globaux charg√©s depuis l\'API:', params);
          } else {
            loadDefaultParameters();
          }
        } else {
          throw new Error('Erreur r√©seau');
        }
      } catch (error) {
        error('Erreur lors du chargement des param√®tres:', error);
        // Fallback vers localStorage puis defaults
        const saveKey = `estimationParams_${username}`;
        const saved = localStorage.getItem(saveKey);
        
        if (saved) {
          try {
            const params = JSON.parse(saved);
            Object.keys(params).forEach(key => {
              const element = document.getElementById(`param_${key}`);
              if (element) {
                element.value = params[key];
              }
            });
            log('Fallback: Param√®tres charg√©s depuis localStorage');
          } catch (localError) {
            loadDefaultParameters();
          }
        } else {
          loadDefaultParameters();
        }
      }
    }

    function loadDefaultParameters() {
      Object.keys(DEFAULT_PARAMETERS).forEach(key => {
        const element = document.getElementById(`param_${key}`);
        if (element) {
          element.value = DEFAULT_PARAMETERS[key];
        }
      });
      
      log('Param√®tres par d√©faut charg√©s');
      updateCalculation();
    }

    // Fonction de sauvegarde automatique avec debounce
    let saveParametersTimeout;
    async function updateTauxHoraire() {
  const newTauxHoraire = getCurrentTauxHoraire();

  // Synchroniser tous les affichages avec la nouvelle fonction
  updateAllTauxHoraireDisplays();

  log(`[MONEY] Taux horaire mis √† jour: ${newTauxHoraire}$/h - Forcer recalcul des prix...`);

  // Forcer le recalcul imm√©diat avec le nouveau taux horaire
  setTimeout(() => {
    updateCalculation();
    log(`üîÑ Recalcul forc√© avec taux horaire ${newTauxHoraire}$/h`);
  }, 100);
}

function syncTauxHoraire(sourceId) {
  const sourceValue = parseFloat(document.getElementById(sourceId)?.value) || 43;

  // Mettre √† jour le param√®tre principal
  const paramTauxHoraire = document.getElementById('param_taux_horaire');
  if (paramTauxHoraire) paramTauxHoraire.value = sourceValue;

  // Synchroniser tous les affichages
  updateAllTauxHoraireDisplays();

  log(`[MONEY] Taux horaire synchronis√© depuis ${sourceId}: ${sourceValue}$/h - Forcer recalcul des prix...`);

  // Forcer le recalcul imm√©diat avec le nouveau taux horaire
  setTimeout(() => {
    updateCalculation();
    log(`üîÑ Recalcul forc√© depuis ${sourceId} avec taux horaire ${sourceValue}$/h`);
  }, 100);
}

function autoSaveParameters() {
      // V√©rifier les permissions avant de sauvegarder automatiquement
      if (typeof canEditParameters !== 'undefined' && !canEditParameters) {
        return; // Ne pas sauvegarder si pas les permissions
      }
      
      // Annuler le timeout pr√©c√©dent s'il existe
      if (saveParametersTimeout) {
        clearTimeout(saveParametersTimeout);
      }
      
      // Programmer la sauvegarde locale apr√®s 1 seconde d'inactivit√©
      saveParametersTimeout = setTimeout(() => {
        const params = getCurrentParameterValues();

        try {
          // Sauvegarder localement dans le localStorage
          localStorage.setItem('userParameters', JSON.stringify(params));

          // Notification discr√®te
          const notificationEl = document.createElement('div');
          notificationEl.textContent = '‚úì Sauvegard√©';
          notificationEl.style.cssText = 'position:fixed;top:10px;right:10px;background:#4CAF50;color:white;padding:5px 10px;border-radius:4px;font-size:12px;z-index:9999;';
          document.body.appendChild(notificationEl);
          setTimeout(() => notificationEl.remove(), 1500);
        } catch (error) {
          error('Erreur lors de la sauvegarde locale:', error);
        }
      }, 1000);
    }

    // Fonction de synchronisation p√©riodique pour r√©cup√©rer les changements d'autres utilisateurs
    let syncInterval;
    function startParameterSync() {
      // V√©rifier les param√®tres toutes les 30 secondes
      syncInterval = setInterval(async () => {
        try {
          const response = await fetch('/api/parameters');
          if (response.ok) {
            const result = await response.json();
            const newParams = result.parameters;
            
            if (newParams && Object.keys(newParams).length > 0) {
              // Comparer avec les param√®tres actuels
              const currentParams = getCurrentParameterValues();
              let hasChanges = false;
              
              Object.keys(newParams).forEach(key => {
                if (currentParams[key] !== newParams[key]) {
                  hasChanges = true;
                  const element = document.getElementById(`param_${key}`);
                  if (element && element !== document.activeElement) { // Ne pas changer si l'utilisateur est en train d'√©diter
                    element.value = newParams[key];
                  }
                }
              });
              
              if (hasChanges) {
                log('Param√®tres synchronis√©s depuis le serveur');
                updateCalculation(); // Recalculer avec les nouveaux param√®tres
              }
            }
          }
        } catch (error) {
          error('Erreur lors de la synchronisation:', error);
        }
      }, 30000); // 30 secondes
    }

    function stopParameterSync() {
      if (syncInterval) {
        clearInterval(syncInterval);
        syncInterval = null;
      }
    }

    // Fonction pour r√©cup√©rer les permissions de l'utilisateur
    async function loadUserPermissions() {
      try {
        log('[DEBUG] Chargement des permissions pour:', username);
        log('üåê URL compl√®te:', `/api/user/${encodeURIComponent(username)}/permissions`);
        log('üåê Domaine actuel:', window.location.hostname);
        
        const response = await fetch(`/api/user/${encodeURIComponent(username)}/permissions`);
        log('üì° Statut r√©ponse API permissions:', response.status);
        log('üì° Response headers:', [...response.headers.entries()]);
        
        if (response.ok) {
          const result = await response.json();
          log('[OK] R√©ponse compl√®te API permissions:', result);
          
          userRole = result.role;
          canEditParameters = result.canEditParameters;
          
          log('üîë Permissions utilisateur charg√©es:', { 
            username, 
            userRole, 
            canEditParameters,
            success: result.success
          });
          
          // Masquer/afficher l'onglet Param√®tres Admin selon les permissions
          toggleParametersAdminTab();
          
          // Mettre √† jour l'affichage du nom d'utilisateur imm√©diatement
          updateUsernameDisplay();
          
          return result;
        } else {
          const errorText = await response.text();
          error('[ERROR] Erreur API permissions:', response.status, errorText);
          error('[ERROR] URL tent√©e:', `/api/user/${encodeURIComponent(username)}/permissions`);
          throw new Error(`Erreur ${response.status}: ${errorText}`);
        }
      } catch (error) {
        error('üí• Erreur lors du chargement des permissions:', error);
        error('üí• Utilisateur concern√©:', username);
        error('Stack trace:', error.stack);
        // Par d√©faut, pas d'acc√®s aux param√®tres admin
        userRole = 'entrepreneur';
        canEditParameters = false;
        toggleParametersAdminTab();
      }
    }

    // Fonction pour masquer/afficher l'onglet Param√®tres Admin
    function toggleParametersAdminTab() {
      const adminTabButton = document.getElementById('parametres-admin-tab-btn');
      const adminTabContent = document.getElementById('parametres-admin-tab');
      const mobileParametresOption = document.getElementById('mobile-parametres-option');

      // V√©rifier explicitement le r√¥le ET canEditParameters
      const hasAccess = (canEditParameters && (userRole === 'direction' || username === 'admin' || username === 'direction'));

      if (hasAccess) {
        // Afficher l'onglet SEULEMENT si l'utilisateur a les permissions
        if (adminTabButton) {
          adminTabButton.style.display = 'flex';
          log('[UNLOCK] Onglet Param√®tres Admin activ√© pour:', username, '- R√¥le:', userRole, '- canEditParameters:', canEditParameters);
        }
        // Afficher l'option dans le menu dropdown mobile avec !important
        if (mobileParametresOption) {
          mobileParametresOption.style.setProperty('display', 'flex', 'important');
          log('[UNLOCK MOBILE] Option Param√®tres mobile activ√©e');
        }
        if (adminTabContent) {
          // R√©activer les champs pour les admins
          enableParameterInputs();
        }
      } else {
        // Garder l'onglet compl√®tement cach√© pour les non-admins
        if (adminTabButton) {
          adminTabButton.style.display = 'none';
        }
        // Cacher l'option dans le menu dropdown mobile avec !important
        if (mobileParametresOption) {
          mobileParametresOption.style.setProperty('display', 'none', 'important');
          log('[LOCK MOBILE] Option Param√®tres mobile masqu√©e pour:', username, '- R√¥le:', userRole);
        }
        if (adminTabContent) {
          adminTabContent.classList.add('hidden');
        }

        // Si l'utilisateur √©tait sur l'onglet admin, le rediriger vers un autre onglet
        if (adminTabContent && !adminTabContent.classList.contains('hidden')) {
          switchTab('estimation'); // Rediriger vers l'onglet estimation
        }

        // D√©sactiver tous les champs de param√®tres pour les non-admins
        disableParameterInputs();
        log('[LOCK] Onglet Param√®tres Admin masqu√© pour:', username, '- R√¥le:', userRole, '- canEditParameters:', canEditParameters);
      }
    }

    // Fonction pour d√©sactiver tous les champs de param√®tres
    function disableParameterInputs() {
      log('[LOCK] disableParameterInputs() appel√©e');

      document.querySelectorAll('[id^="param_"]').forEach(input => {
        if (input.tagName === 'INPUT' || input.tagName === 'SELECT') {
          input.disabled = true;
          input.style.opacity = '0.6';
          input.style.cursor = 'not-allowed';
        }
      });

      // Griser aussi le taux horaire dans la section Configuration
      const tauxHoraireConfig = document.getElementById('tauxHoraire');
      log('[LOCK] tauxHoraire trouv√©:', tauxHoraireConfig);
      if (tauxHoraireConfig) {
        tauxHoraireConfig.disabled = true;
        tauxHoraireConfig.style.opacity = '0.6';
        tauxHoraireConfig.style.cursor = 'not-allowed';
        log('[LOCK] tauxHoraire d√©sactiv√©');
      } else {
        log('[LOCK] tauxHoraire NON trouv√©');
      }
    }

    // Fonction pour r√©activer les champs de param√®tres
    function enableParameterInputs() {
      document.querySelectorAll('[id^="param_"]').forEach(input => {
        if (input.tagName === 'INPUT' || input.tagName === 'SELECT') {
          input.disabled = false;
          input.style.opacity = '';
          input.style.cursor = '';
        }
      });

      // R√©activer aussi le taux horaire dans la section Configuration
      const tauxHoraireConfig = document.getElementById('tauxHoraire');
      if (tauxHoraireConfig) {
        tauxHoraireConfig.disabled = false;
        tauxHoraireConfig.style.opacity = '';
        tauxHoraireConfig.style.cursor = '';
      }
    }

    // Fonction updateUsernameDisplay supprim√©e - maintenant g√©r√©e par common.js

    function resetParametersSection(section) {
      if (!confirm(`√ätes-vous s√ªr de vouloir r√©initialiser les param√®tres de la section "${section}" ?`)) {
        return;
      }
      
      let keysToReset = [];
      
      switch(section) {
        case 'productivite':
          keysToReset = Object.keys(DEFAULT_PARAMETERS).filter(key => 
            key.includes('lavage_') || key.includes('grattage_') || key.includes('primer_') || 
            key.includes('peinture_') || key.includes('sablage_') || key.includes('taux_')
          );
          break;
        case 'produits':
          keysToReset = Object.keys(DEFAULT_PARAMETERS).filter(key => 
            key.includes('_couverture') || key.includes('_prix') || key.includes('gallon')
          );
          break;
        case 'all':
          keysToReset = Object.keys(DEFAULT_PARAMETERS);
          break;
      }
      
      keysToReset.forEach(key => {
        const element = document.getElementById(`param_${key}`);
        if (element) {
          element.value = DEFAULT_PARAMETERS[key];
        }
      });
      
      showNotification(`Section "${section}" r√©initialis√©e`, 'success');
      updateCalculation();
    }

    function exportParameters() {
      const params = getCurrentParameterValues();
      const exportData = {
        version: "1.0",
        exportDate: new Date().toISOString(),
        username: username,
        parameters: params
      };
      
      showNotification('Donn√©es d\'exportation pr√©par√©es. Utilisez "T√©l√©charger JSON" pour sauvegarder.', 'info');
      return exportData;
    }

    function exportParametersToFile() {
      const exportData = exportParameters();
      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], {type:'application/json'});
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `parametres_estimation_${username}_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      showNotification('Fichier de param√®tres t√©l√©charg√©!', 'success');
    }

    function copyParametersToClipboard() {
      const exportData = exportParameters();
      const dataStr = JSON.stringify(exportData, null, 2);
      
      navigator.clipboard.writeText(dataStr).then(() => {
        showNotification('Param√®tres copi√©s vers le presse-papier!', 'success');
      }).catch(err => {
        error('Erreur lors de la copie:', err);
        showNotification('Erreur lors de la copie vers le presse-papier.', 'error');
      });
    }

// Fonction pour convertir tous les selects en dropdowns personnalis√©s
function convertToCustomDropdowns() {
  document.querySelectorAll('.select-field').forEach(selectElement => {
    if (!selectElement.nextElementSibling || !selectElement.nextElementSibling.classList.contains('custom-select')) {
      createCustomDropdown(selectElement);
    }
  });
  initCustomSelects();
}

    // === FONCTIONS DE CR√âATION ET GESTION DES DROPDOWNS ===

    function createCustomDropdown(selectElement) {
      // Cr√©er le conteneur principal
      const customSelect = document.createElement('div');
      customSelect.className = 'custom-select';
      customSelect.setAttribute('data-target', selectElement.id);

      // Cr√©er le bouton principal
      const button = document.createElement('div');
      button.className = 'custom-select-button';
      button.setAttribute('tabindex', '0');

      // Texte du bouton (ce qui est affich√©)
      const textSpan = document.createElement('span');
      textSpan.className = 'custom-select-text';
      
      // CORRIG√â: Prendre en compte l'option s√©lectionn√©e par d√©faut
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      textSpan.textContent = selectedOption.textContent;

      // Fl√®che du dropdown
      const arrowSpan = document.createElement('span');
      arrowSpan.className = 'custom-select-arrow';
      arrowSpan.textContent = '‚ñº';

      // Assembler le bouton
      button.appendChild(textSpan);
      button.appendChild(arrowSpan);

      // Cr√©er le dropdown
      const dropdown = document.createElement('div');
      dropdown.className = 'custom-select-dropdown';

      // Cr√©er les options
      Array.from(selectElement.options).forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'custom-select-option';
        
        // CORRIG√â: Marquer l'option s√©lectionn√©e par d√©faut
        if (index === selectElement.selectedIndex) {
          optionDiv.classList.add('selected');
        }
        
        optionDiv.setAttribute('data-value', option.value);
        optionDiv.textContent = option.textContent;
        dropdown.appendChild(optionDiv);
      });

      // Assembler le dropdown complet
      customSelect.appendChild(button);
      customSelect.appendChild(dropdown);

      // CORRIG√â: Ins√©rer AVANT le select original, pas apr√®s
      selectElement.parentNode.insertBefore(customSelect, selectElement);
      
      return customSelect;
    }

    function initCustomSelects() {
      document.querySelectorAll('.custom-select').forEach(customSelect => {
        const button = customSelect.querySelector('.custom-select-button');
        const dropdown = customSelect.querySelector('.custom-select-dropdown');
        const textElement = customSelect.querySelector('.custom-select-text');
        const targetId = customSelect.getAttribute('data-target');
        const originalSelect = document.getElementById(targetId);
        
        // CORRIG√â: Supprimer tous les anciens event listeners
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        // Event listener pour ouvrir/fermer le dropdown
        newButton.addEventListener('click', function(e) {
          e.stopPropagation();
          
          // CORRIG√â: Toggle complet - si ouvert on ferme, si ferm√© on ouvre
          if (customSelect.classList.contains('open')) {
            // Si d√©j√† ouvert, on ferme
            customSelect.classList.remove('open');
          } else {
            // Si ferm√©, on ferme d'abord tous les autres puis on ouvre celui-ci
            closeAllDropdowns();
            customSelect.classList.add('open');
            
          }
        });
        
        // CORRIG√â: Event listener pour les options - utiliser event delegation
        dropdown.addEventListener('click', function(e) {
          e.stopPropagation();
          
          if (e.target.classList.contains('custom-select-option')) {
            const value = e.target.getAttribute('data-value');
            const text = e.target.textContent;
            
            // CORRIG√â: Mettre √† jour le texte affich√©
            const currentTextElement = customSelect.querySelector('.custom-select-text');
            currentTextElement.textContent = text;
            
            // CORRIG√â: Mettre √† jour le select original
            if (originalSelect) {
              originalSelect.value = value;
              
              // D√©clencher l'√©v√©nement change sur le select original
              const changeEvent = new Event('change', { bubbles: true });
              originalSelect.dispatchEvent(changeEvent);
            }
            
            // Mettre √† jour les classes selected
            dropdown.querySelectorAll('.custom-select-option').forEach(opt => {
              opt.classList.remove('selected');
            });
            e.target.classList.add('selected');
            
            // Fermer le dropdown
            customSelect.classList.remove('open');
            
            // AJOUT: Mettre √† jour l'affichage de test
            updateTestDisplay();
          }
        });
        
        // Gestion du clavier
        newButton.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            newButton.click();
          }
        });
      });
      
      // Fermer les dropdowns quand on clique ailleurs
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.custom-select')) {
          closeAllDropdowns();
        }
      });
    }

    function closeAllDropdowns() {
      document.querySelectorAll('.custom-select').forEach(select => {
        select.classList.remove('open');
      });
    }

    function convertToCustomDropdowns() {
      // Trouver tous les selects et les convertir
      document.querySelectorAll('.select-field').forEach(selectElement => {
        // V√©rifier qu'il n'y a pas d√©j√† un dropdown custom
        if (!selectElement.previousElementSibling || 
            !selectElement.previousElementSibling.classList.contains('custom-select')) {
          createCustomDropdown(selectElement);
        }
      });
      
      // Initialiser les interactions
      initCustomSelects();
    }

    // === FONCTIONS DE TEST ===
    
    function updateTestDisplay() {
      // V√©rifier si les √©l√©ments existent avant de les mettre √† jour
      const paintType = document.getElementById('paintType');
      const thirdCoat = document.getElementById('thirdCoat');
      const primer = document.getElementById('primer');
      
      const selectedValue1 = document.getElementById('selectedValue1');
      const selectedValue2 = document.getElementById('selectedValue2');
      const selectedValue3 = document.getElementById('selectedValue3');
      
      if (selectedValue1 && paintType) {
        selectedValue1.textContent = paintType.value;
      }
      if (selectedValue2 && thirdCoat) {
        selectedValue2.textContent = thirdCoat.value;
      }
      if (selectedValue3 && primer) {
        selectedValue3.textContent = primer.value;
      }
      
      // Mettre √† jour le r√©sultat g√©n√©ral
      const results = document.getElementById('results');
      if (results && paintType && thirdCoat && primer) {
        results.innerHTML = `
          <strong>Valeurs actuelles:</strong><br>
          ‚Ä¢ Type de peinture: ${paintType.value}<br>
          ‚Ä¢ 3e couche: ${thirdCoat.value}<br>
          ‚Ä¢ Primer: ${primer.value}
        `;
      }
    }

    // Ajouter des listeners aux selects originaux pour le test
    function addTestListeners() {
      document.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', updateTestDisplay);
      });
    }

    // === INITIALISATION ===
    
    document.addEventListener('DOMContentLoaded', function() {
      log('Initialisation des dropdowns...');
      
      // Convertir les selects en dropdowns custom
      convertToCustomDropdowns();
      
      // Ajouter les listeners de test
      addTestListeners();
      
      // Affichage initial
      updateTestDisplay();
      
      log('Dropdowns initialis√©s avec succ√®s!');
    });
    function closeAllDropdowns() {
      document.querySelectorAll('.custom-select').forEach(select => {
        select.classList.remove('open');
      });
    }

    function convertToCustomDropdowns() {
      // Trouver tous les selects et les convertir
      document.querySelectorAll('.select-field').forEach(selectElement => {
        // V√©rifier qu'il n'y a pas d√©j√† un dropdown custom
        if (!selectElement.previousElementSibling || 
            !selectElement.previousElementSibling.classList.contains('custom-select')) {
          createCustomDropdown(selectElement);
        }
      });
      
      // Initialiser les interactions
      initCustomSelects();
    }

    // === FONCTIONS DE TEST ===
    
    function updateTestDisplay() {
      // V√©rifier si les √©l√©ments existent avant de les mettre √† jour
      const paintType = document.getElementById('paintType');
      const thirdCoat = document.getElementById('thirdCoat');
      const primer = document.getElementById('primer');
      
      const selectedValue1 = document.getElementById('selectedValue1');
      const selectedValue2 = document.getElementById('selectedValue2');
      const selectedValue3 = document.getElementById('selectedValue3');
      
      if (selectedValue1 && paintType) {
        selectedValue1.textContent = paintType.value;
      }
      if (selectedValue2 && thirdCoat) {
        selectedValue2.textContent = thirdCoat.value;
      }
      if (selectedValue3 && primer) {
        selectedValue3.textContent = primer.value;
      }
      
      // Mettre √† jour le r√©sultat g√©n√©ral
      const results = document.getElementById('results');
      if (results && paintType && thirdCoat && primer) {
        results.innerHTML = `
          <strong>Valeurs actuelles:</strong><br>
          ‚Ä¢ Type de peinture: ${paintType.value}<br>
          ‚Ä¢ 3e couche: ${thirdCoat.value}<br>
          ‚Ä¢ Primer: ${primer.value}
        `;
      }
    }

    // Ajouter des listeners aux selects originaux pour le test
    function addTestListeners() {
      document.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', updateTestDisplay);
      });
    }

    // === INITIALISATION ===
    
    document.addEventListener('DOMContentLoaded', function() {
      log('Initialisation des dropdowns...');
      
      // Convertir les selects en dropdowns custom
      convertToCustomDropdowns();
      
      // Ajouter les listeners de test
      addTestListeners();
      
      // Affichage initial
      updateTestDisplay();
      
      log('Dropdowns initialis√©s avec succ√®s!');
    });
function closeAllDropdowns() {
  document.querySelectorAll('.custom-select').forEach(select => {
    select.classList.remove('open');
  });
}

// V√©rifier IMM√âDIATEMENT s'il y a un projet √† charger (avant tout)
// Le masquage initial est fait dans <head>, ici on affiche juste l'animation
(function() {
  const pendingProjectId = localStorage.getItem('pendingProjectLoad');
  if (pendingProjectId) {
    // Afficher l'animation d√®s que possible (le masquage est d√©j√† fait dans <head>)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        // Rendre visible et afficher l'animation
        document.documentElement.style.visibility = 'visible';
        document.documentElement.style.overflow = '';
        showLoadingAnimation('Chargement du projet...');
      });
    } else {
      document.documentElement.style.visibility = 'visible';
      document.documentElement.style.overflow = '';
      showLoadingAnimation('Chargement du projet...');
    }
  }
})();

// Appelez cette fonction dans votre initializeApp()
function initializeApp() {
  // Set current date (√©l√©ment supprim√© - plus n√©cessaire)
  // document.getElementById('estimationDate').value = new Date().toISOString().split('T')[0];

  // Add event listeners
  addEventListeners();

  // Load saved parameters
  loadAllParameters();

  // Initial calculation
  updateCalculation();

  // Ajouter √† la fin :
  convertToCustomDropdowns();
  
  // R√©cup√©rer les donn√©es du prospect depuis sessionStorage avec un d√©lai pour s'assurer que le DOM est pr√™t
  setTimeout(() => {
    const prospectData = sessionStorage.getItem('submissionData');
    log('[DEBUG] Recherche des donn√©es prospect dans sessionStorage...');
    
    if (prospectData) {
      try {
        const prospect = JSON.parse(prospectData);
        log('[NOTE] Donn√©es prospect d√©tect√©es:', prospect);
        
        // Pr√©-remplir les champs client avec v√©rification des √©l√©ments
        const clientPrenomField = document.getElementById('clientPrenom');
        const clientNomField = document.getElementById('clientNom');
        const clientAddressField = document.getElementById('clientAddress');
        const clientPhoneField = document.getElementById('clientPhone');
        
        log('[DEBUG] √âl√©ments trouv√©s:', {
          prenom: clientPrenomField ? 'OK' : 'MANQUANT',
          nom: clientNomField ? 'OK' : 'MANQUANT', 
          adresse: clientAddressField ? 'OK' : 'MANQUANT',
          telephone: clientPhoneField ? 'OK' : 'MANQUANT'
        });
        
        if (clientPrenomField && prospect.prenom) {
          clientPrenomField.value = prospect.prenom;
          clientPrenomField.style.setProperty('border-right-color', '#4caf50', 'important');
          log('[OK] Pr√©nom d√©fini:', prospect.prenom);
        }
        if (clientNomField && prospect.nom) {
          clientNomField.value = prospect.nom;
          clientNomField.style.setProperty('border-right-color', '#4caf50', 'important');
        }
        if (clientAddressField && prospect.adresse) {
          clientAddressField.value = prospect.adresse;
          clientAddressField.style.setProperty('border-right-color', '#4caf50', 'important');
          log('[OK] Adresse d√©finie:', prospect.adresse);
        }
        if (clientPhoneField && prospect.telephone) {
          clientPhoneField.value = prospect.telephone;
          clientPhoneField.style.setProperty('border-right-color', '#4caf50', 'important');
          log('[OK] T√©l√©phone d√©fini:', prospect.telephone);
        }

        // Mettre √† jour le message de validation client et activer les boutons
        setTimeout(() => {
          if (typeof updateClientValidationMessage === 'function') {
            updateClientValidationMessage();
          }
          if (typeof validateCompleterButton === 'function') {
            validateCompleterButton();
          }
        }, 100);

        log('[OK] Pr√©-remplissage termin√© avec bordures vertes');

        // NE PAS nettoyer sessionStorage ici - il sera utilis√© pour bypasser la validation d'adresse
        // sessionStorage.removeItem('submissionData'); // Sera nettoy√© apr√®s "Compl√©ter la soumission"
        log('üíæ SessionStorage conserv√© pour validation');

      } catch (error) {
        error('[ERROR] Erreur lors du parsing des donn√©es prospect:', error);
      }
    } else {
      log('‚ÑπÔ∏è Aucune donn√©e prospect trouv√©e dans sessionStorage');
    }

    // V√©rifier √©galement localStorage.clientEstimation (depuis page Ventes)
    log('[DEBUG] V√©rification localStorage.clientEstimation...');
    const clientEstimationData = localStorage.getItem('clientEstimation');
    log('[DEBUG] clientEstimationData:', clientEstimationData);
    if (clientEstimationData) {
      try {
        const clientData = JSON.parse(clientEstimationData);
        log('[VENTES] Donn√©es client estimation d√©tect√©es:', clientData);

        // Pr√©-remplir les champs client
        const clientPrenomField = document.getElementById('clientPrenom');
        const clientNomField = document.getElementById('clientNom');
        const clientAddressField = document.getElementById('clientAddress');
        const clientPhoneField = document.getElementById('clientPhone');

        if (clientPrenomField && clientData.prenom) {
          clientPrenomField.value = clientData.prenom;
          clientPrenomField.style.setProperty('border-right-color', '#4caf50', 'important');
          log('[OK] Pr√©nom d√©fini:', clientData.prenom);
        }
        if (clientNomField && clientData.nom) {
          clientNomField.value = clientData.nom;
          clientNomField.style.setProperty('border-right-color', '#4caf50', 'important');
          log('[OK] Nom d√©fini:', clientData.nom);
        }
        if (clientAddressField && clientData.adresse) {
          clientAddressField.value = clientData.adresse;
          clientAddressField.style.setProperty('border-right-color', '#4caf50', 'important');
          // Marquer l'adresse comme valid√©e (vient d'un prospect, d√©j√† v√©rifi√©e)
          window.googleClientAddressSelected = true;
          log('[OK] Adresse d√©finie:', clientData.adresse);
          log('[OK] Adresse marqu√©e comme pr√©-valid√©e (bypass Google validation)');
        }
        if (clientPhoneField && clientData.telephone) {
          clientPhoneField.value = clientData.telephone;
          clientPhoneField.style.setProperty('border-right-color', '#4caf50', 'important');
          log('[OK] T√©l√©phone d√©fini:', clientData.telephone);
        }

        // Mettre √† jour le message de validation client
        setTimeout(() => {
          if (typeof updateClientValidationMessage === 'function') {
            updateClientValidationMessage();
          }
          if (typeof validateCompleterButton === 'function') {
            validateCompleterButton();
          }
        }, 100);

        log('[OK] Client estimation pr√©-rempli avec bordures vertes');

        // Nettoyer localStorage apr√®s utilisation
        localStorage.removeItem('clientEstimation');
        log('üóëÔ∏è localStorage.clientEstimation nettoy√©');

      } catch (error) {
        error('[ERROR] Erreur lors du parsing des donn√©es client estimation:', error);
      }
    }

    // V√©rifier s'il y a un projet en attente de chargement (apr√®s page reload)
    const pendingProjectId = localStorage.getItem('pendingProjectLoad');
    if (pendingProjectId) {
      log('üîÑ [CHARGEMENT] Projet en attente d√©tect√©:', pendingProjectId);

      // Restaurer l'entrepreneur s√©lectionn√© pour coach/direction
      const selectedEntrepreneurBeforeReload = sessionStorage.getItem('selectedEntrepreneurBeforeReload');
      if (selectedEntrepreneurBeforeReload) {
        window.selectedEntrepreneur = selectedEntrepreneurBeforeReload;
        window.username = selectedEntrepreneurBeforeReload;
        localStorage.setItem('username', selectedEntrepreneurBeforeReload);
        sessionStorage.removeItem('selectedEntrepreneurBeforeReload'); // Nettoyer
        log('üîÑ [CHARGEMENT] Entrepreneur restaur√©:', selectedEntrepreneurBeforeReload);

        // Retirer le CSS anti-flash s'il existe
        const antiFlashStyle = document.getElementById('coach-anti-flash-css');
        if (antiFlashStyle) {
          antiFlashStyle.remove();
          log('üîÑ [CHARGEMENT] Anti-flash CSS retir√©');
        }

        // Mettre le s√©lecteur en mode header et r√©v√©ler le contenu
        const selector = document.getElementById('coach-entrepreneur-selector');
        const backdrop = document.getElementById('coach-selector-backdrop');
        if (selector) {
          selector.classList.add('in-header');
          log('üîÑ [CHARGEMENT] S√©lecteur mis en mode header');
        }
        if (backdrop) {
          backdrop.classList.remove('visible');
          log('üîÑ [CHARGEMENT] Backdrop cach√©');
        }
        document.body.classList.add('has-selection');
        log('üîÑ [CHARGEMENT] Contenu r√©v√©l√©');
      }

      // Nettoyer le flag pour √©viter de recharger √† chaque refresh
      localStorage.removeItem('pendingProjectLoad');

      // L'animation est d√©j√† affich√©e (depuis le d√©but du chargement de la page)
      // Charger le projet apr√®s un petit d√©lai pour s'assurer que tout est initialis√©
      setTimeout(() => {
        chargerProjetInternal(pendingProjectId);
      }, 500);
    }
  }, 1000); // D√©lai de 1 seconde pour s'assurer que le DOM est pr√™t

  log('Application initialis√©e avec succ√®s');

  // D√©sactiver tous les champs de param√®tres par d√©faut
  disableParameterInputs();
}

    function importParameters() {
      // This function will be triggered by the file input
      showNotification('S√©lectionnez un fichier JSON √† importer...', 'info');
    }

    function importParametersFromFile() {
      const fileInput = document.getElementById('importFile');
      const file = fileInput.files[0];
      
      if (!file) {
        showNotification('Veuillez s√©lectionner un fichier √† importer.', 'warning');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importData = JSON.parse(e.target.result);
          
          if (!importData.parameters) {
            throw new Error('Format de fichier invalide');
          }
          
          // Load imported parameters
          Object.keys(importData.parameters).forEach(key => {
            const element = document.getElementById(`param_${key}`);
            if (element) {
              element.value = importData.parameters[key];
            }
          });
          
          showNotification(`Param√®tres import√©s avec succ√®s depuis le fichier (version ${importData.version || 'inconnue'})!`, 'success');
          updateCalculation();
          
        } catch (error) {
          error('Erreur lors de l\'importation:', error);
          showNotification('Erreur lors de l\'importation: fichier invalide.', 'error');
        }
      };
      
      reader.readAsText(file);
    }

    // === UTILITY FUNCTIONS ===

    function formatCurrency(amount) {
      return new Intl.NumberFormat('fr-CA', {
        style: 'currency',
        currency: 'CAD'
      }).format(amount);
    }

    function resetForm() {
      showCustomConfirm(
        'R√©initialiser le calculateur',
        '√ätes-vous s√ªr de vouloir r√©initialiser compl√®tement le calculateur ? Toutes les donn√©es saisies seront perdues.',
        'R√©initialiser',
        'Annuler',
        function() {
          // Confirmer - recharger la page
          window.location.reload();
        }
      );
    }

    // Animation de chargement (m√™me style que Ventes et Soumission)
    function showLoadingAnimation(message = 'Chargement du projet...') {
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'loadingOverlay';
      overlay.innerHTML = `
        <div class="loading-content">
          <div class="loading-spinner">
            <i class="fas fa-sync-alt"></i>
          </div>
          <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">${message}</h2>
        </div>
      `;

      document.body.appendChild(overlay);

      // Retirer le loader CSS instantan√© (celui du <head>)
      const instantLoader = document.getElementById('instant-loader-style');
      if (instantLoader) {
        instantLoader.remove();
      }
    }

    function hideLoadingAnimation() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.remove();
      }
      // Retirer le loader CSS instantan√© au cas o√π
      const instantLoader = document.getElementById('instant-loader-style');
      if (instantLoader) {
        instantLoader.remove();
      }
      // Restaurer le scroll et la visibilit√© de la page
      document.documentElement.style.visibility = '';
      document.documentElement.style.overflow = '';
      document.documentElement.style.background = '';
      document.body.style.overflow = '';
    }
    
    function showCustomConfirm(title, message, confirmText, cancelText, onConfirm) {
      // Cr√©er l'overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        z-index: 200;
        display: flex;
        align-items: center;
        justify-content: center;
      `;
      
      // Cr√©er la modal
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border-radius: 16px;
        padding: 32px;
        max-width: 450px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(71, 85, 105, 0.3);
        transform: scale(0.9);
        opacity: 0;
        transition: all 0.3s ease;
      `;
      
      modal.innerHTML = `
        <div style="text-align: center;">
          <div style="width: 64px; height: 64px; background: rgba(239, 68, 68, 0.2); border-radius: 50%; margin: 0 auto 24px; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 28px;"></i>
          </div>
          <h3 style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 16px;">${title}</h3>
          <p style="color: #cbd5e1; font-size: 16px; line-height: 1.5; margin-bottom: 32px;">${message}</p>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="cancelBtn" class="btn-secondary" style="font-size: 16px;">${cancelText}</button>
            <button id="confirmBtn" class="btn-primary" style="
              background: #ef4444 !important;
              border-color: #ef4444 !important;
              border-radius: 24px !important;
              font-size: 16px;
            " onmouseover="this.style.background='#dc2626 !important'"
               onmouseout="this.style.background='#ef4444 !important'">
               <span class="hover-effect" style="
                 display: none;
                 height: 100%;
                 background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                 transition: left 0.3s ease;
                 pointer-events: none;
               "></span>
               ${confirmText}
            </button>
          </div>
        </div>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      // Animation d'entr√©e
      setTimeout(() => {
        modal.style.transform = 'scale(1)';
        modal.style.opacity = '1';
      }, 50);
      
      // Gestion des √©v√©nements
      const cancelBtn = modal.querySelector('#cancelBtn');
      const confirmBtn = modal.querySelector('#confirmBtn');
      
      const closeModal = () => {
        modal.style.transform = 'scale(0.9)';
        modal.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(overlay);
        }, 300);
      };
      
      cancelBtn.onclick = closeModal;
      overlay.onclick = (e) => {
        if (e.target === overlay) closeModal();
      };
      
      confirmBtn.onclick = () => {
        closeModal();
        if (onConfirm) onConfirm();
      };
    }

    async function generatePDF() {
      try {
        // Validation des champs obligatoires
        const clientName = document.getElementById('clientName').value.trim();
        if (!clientName) {
          showNotification('Veuillez remplir le nom du client', 'warning');
          return;
        }

        // Collect all data
        const clientData = {
          name: clientName,
          address: document.getElementById('clientAddress').value,
          phone: document.getElementById('clientPhone').value
        };
        
        const surfaceData = collectSurfaceData();
        const endroitData = collectEndroitData();
        const selectedProduct = getSelectedProductData();
        
        // Calculer les heures pour surfaces de base ET endroits personnalis√©s
        const hours = calculateHours(surfaceData);
        const endroitHours = calculateEndroitHours(endroitData);
        
        // Fusionner les heures
        const totalHours = {
          lavage: hours.lavage + endroitHours.lavage,
          preparation: hours.preparation + endroitHours.preparation,
          peinture: hours.peinture + endroitHours.peinture
        };
        
        // Lire directement les valeurs affich√©es dans le HTML via les ID
        const getCostFromElement = (id) => {
          const element = document.getElementById(id);
          if (!element) return 0;
          const text = element.textContent.replace(/[$\s]/g, '').replace(',', '.');
          return parseFloat(text) || 0;
        };
        
        const getHoursFromElement = (id) => {
          const element = document.getElementById(id);
          if (!element) return 0;
          return parseFloat(element.textContent) || 0;
        };
        
        // Extraire les valeurs directement de l'affichage HTML
        const vraiSousTotal = getCostFromElement('costLavage') + getCostFromElement('costPreparation') + getCostFromElement('costPeinture') + getCostFromElement('costProduits');
        const profitMarginPercent = parseFloat(document.getElementById('profitMargin')?.value) || 25;
        const vraieMargeProfit = vraiSousTotal * (profitMarginPercent / 100);
        
        // Utiliser TOUS les co√ªts int√©rieurs d√©j√† calcul√©s dans l'HTML
        const costPreparationInt = getCostFromElement('costPreparationInt') || 0;
        const costMainOeuvreInt = getCostFromElement('costMainOeuvreInt') || 0;  
        const costPeintureInt = getCostFromElement('costPeintureInt') || 0;
        const subTotalInt = getCostFromElement('subTotalInt') || 0;
        const profitAmountInt = getCostFromElement('profitAmountInt') || 0;
        const totalInterieur = getCostFromElement('totalInterieur') || 0;
        const totalHeuresInt = parseFloat(document.getElementById('totalHeuresInt')?.textContent || '0');
        
        // Debug COMPLET des co√ªts int√©rieur depuis HTML
        log(`DEBUG COLLECTE: === CO√õTS INT√âRIEUR COMPLETS ===`);
        log(`DEBUG COLLECTE: - Pr√©paration int: $${costPreparationInt}`);
        log(`DEBUG COLLECTE: - Main d'≈ìuvre int: $${costMainOeuvreInt}`);
        log(`DEBUG COLLECTE: - Peinture int: $${costPeintureInt}`);
        log(`DEBUG COLLECTE: - Sous-total int: $${subTotalInt}`);
        log(`DEBUG COLLECTE: - Marge profit int: $${profitAmountInt}`);
        log(`DEBUG COLLECTE: - Total int√©rieur: $${totalInterieur}`);
        log(`DEBUG COLLECTE: - Heures totales int: ${totalHeuresInt}h`);
        
        const totalCosts = {
          lavage: getCostFromElement('costLavage'),
          preparation: getCostFromElement('costPreparation'), 
          peinture: getCostFromElement('costPeinture'),
          materiaux: getCostFromElement('costProduits'), // Changer de costMateriau √† costProduits
          sousTotal: vraiSousTotal, // Sous-total = somme exacte des 4 co√ªts affich√©s
          margeProfit: vraieMargeProfit, // Marge de profit bas√©e sur le vrai sous-total
          totalExterieur: getCostFromElement('totalEstimate'),
          // CO√õTS INT√âRIEURS COMPLETS depuis HTML
          lavage_int: 0, // Pas de lavage int√©rieur dans ce projet
          preparation_int: costPreparationInt,
          main_oeuvre_int: costMainOeuvreInt,
          peinture_int: costPeintureInt,
          produits_appliques_int: costPeintureInt, // costPeintureInt contient les produits
          materiaux_int: costPeintureInt,
          sousTotal_int: subTotalInt,
          margeProfit_int: profitAmountInt,
          interieur: totalInterieur,
          totalInterior: totalInterieur
        };
        
        // Extraire les heures directement de l'affichage HTML  
        const actualHours = {
          lavage: totalHours.lavage || 0,
          preparation: totalHours.preparation || 0, 
          peinture: totalHours.peinture || 0,
          totalHours: getHoursFromElement('totalHours'), // Total ext√©rieur
          // HEURES INT√âRIEURES
          lavage_int: 0, // Pas de lavage int√©rieur
          preparation_int: totalHeuresInt > 0 ? Math.max(totalHeuresInt * 0.3, 0) : 0, // Estimation 30% du total pour pr√©paration
          peinture_int: totalHeuresInt > 0 ? Math.max(totalHeuresInt * 0.7, 0) : 0, // Estimation 70% du total pour peinture
          interieur: totalHeuresInt,
          totalHoursInterior: totalHeuresInt
        };
        
        // R√©cup√©rer tous les produits avec leurs vrais gallons depuis le tableau
        const getRealProductsFromTable = () => {
          const productRows = document.querySelectorAll('#products-table-body tr');
          const products = [];
          let totalGallons = 0;
          
          productRows.forEach(row => {
            const nameCell = row.querySelector('[data-field="name"]');
            const gallonsInput = row.querySelector('[data-field="gallons"]');
            const priceInput = row.querySelector('[data-field="pricePerGallon"]');
            
            if (nameCell && gallonsInput && priceInput) {
              const gallons = parseFloat(gallonsInput.value) || 0;
              const pricePerGallon = parseFloat(priceInput.value) || 0;
              
              products.push({
                name: nameCell.textContent.trim(),
                gallons: gallons,
                pricePerGallon: pricePerGallon,
                totalPrice: gallons * pricePerGallon
              });
              
              totalGallons += gallons;
            }
          });
          
          return { products, totalGallons };
        };
        
        const realProductData = getRealProductsFromTable();
        
        // Mettre √† jour selectedProduct avec les vraies donn√©es
        if (selectedProduct) {
          selectedProduct.products = realProductData.products;
          selectedProduct.gallons = realProductData.totalGallons;
          selectedProduct.totalGallons = realProductData.totalGallons;
          selectedProduct.totalCost = realProductData.products.reduce((sum, p) => sum + p.totalPrice, 0);
        }
        
        log('=== PDF DATA FROM HTML ===');
        log('totalCosts:', totalCosts);
        log('actualHours:', actualHours);
        log('realProductData:', realProductData);
        log('selectedProduct:', selectedProduct);
        log('==========================');
        const params = getCurrentParameterValues();
        
        // Create PDF data structure
        // APPELER getSelectedProductData() JUSTE AVANT LE PDF pour √©viter les conflits
        const pdfProductData = getSelectedProductData();
        log('DEBUG: pdfProductData avant envoi PDF:', pdfProductData);
        log('DEBUG: pdfProductData.products:', pdfProductData.products);
        
        const pdfData = {
          username: username,
          client: clientData,
          surfaces: surfaceData,
          endroits: endroitData,
          product: pdfProductData,
          hours: actualHours,
          costs: totalCosts,
          parameters: {
            ...params,
            profitMargin: document.getElementById('profitMargin')?.value || '15',
            thirdCoat: document.getElementById('thirdCoat')?.value || 'false',
            primer: document.getElementById('primer')?.value || 'false'
          }
        };
        
        log('[DATA] Envoi des donn√©es PDF:', pdfData);
        showNotification('G√©n√©ration du PDF en cours...', 'info');
        
        // Appel au backend pour g√©n√©rer le PDF
        const response = await fetch('/creer-pdf-calculateur', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(pdfData)
        });
        
        if (response.ok) {
          // R√©cup√©rer le PDF en tant que blob
          const blob = await response.blob();
          
          // Cr√©er un lien de t√©l√©chargement
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          
          // Nom du fichier bas√© sur le client et la date
          const timestamp = new Date().toISOString().slice(0, 16).replace(/[:-]/g, '');
          const filename = `calculateur_${clientName.replace(/\s+/g, '_')}_${timestamp}.pdf`;
          link.download = filename;
          
          // D√©clencher le t√©l√©chargement
          document.body.appendChild(link);
          link.click();
          
          // Nettoyer
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
          
          // Notification de succ√®s
          showNotification('[OK] PDF g√©n√©r√© et t√©l√©charg√© avec succ√®s! Projet cr√©√© automatiquement.', 'success');
          
          log('[OK] PDF g√©n√©r√© et t√©l√©charg√©:', filename);
          
        } else {
          const errorText = await response.text();
          error('[ERROR] Erreur g√©n√©ration PDF:', errorText);
          showNotification('Erreur lors de la g√©n√©ration du PDF', 'error');
        }
        
      } catch (error) {
        error('[ERROR] Erreur:', error);
        showNotification('Erreur de connexion lors de la g√©n√©ration du PDF', 'error');
      }
    }

    function quickCalculate() {
      // Quick calculation with preset values for demo
      document.querySelector('[data-section="avant"][data-type="lavage_pression"]').value = '250';
      document.querySelector('[data-section="avant"][data-type="sablage"]').value = '250';
      document.querySelector('[data-section="avant"][data-type="peinture"]').value = '500';
      
      updateCalculation();
      showNotification('Calcul rapide appliqu√©!', 'success');
    }

    function addNewProduct() {
      // V√©rifier le r√¥le - seuls coach/direction peuvent ajouter des produits
      const currentRole = localStorage.getItem('userRole') || 'entrepreneur';
      if (currentRole !== 'coach' && currentRole !== 'direction') {
        console.log('[PRODUCTS] Ajout de produit refus√© - r√¥le:', currentRole);
        return;
      }

      const tbody = document.getElementById('products-table-body');
      const newRow = document.createElement('tr');
      newRow.className = 'hover:bg-slate-700/50';

      // Get next radio button value
      const existingRows = tbody.querySelectorAll('tr').length;

      newRow.innerHTML = `
        <td class="border: 1px solid var(--border-dark); px-4 py-3">
          <input type="text" value="" class="input-field" data-field="type" placeholder="Type de produit">
        </td>
        <td class="border: 1px solid var(--border-dark); px-4 py-3">
          <input type="number" value="200" class="input-field" data-field="ratio" onchange="syncProductChanges()">
        </td>
        <td class="border: 1px solid var(--border-dark); px-4 py-3">
          <input type="number" value="0" class="input-field" data-field="prix" onchange="syncProductChanges()">
        </td>
        <td class="border: 1px solid var(--border-dark); px-4 py-3 text-center">
          <button class="btn-secondary text-xs px-2 py-1" onclick="removeProduct(this)" title="Supprimer">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;

      tbody.appendChild(newRow);

      // Focus sur le premier champ du nouveau produit
      newRow.querySelector('input[data-field="type"]').focus();
      
      // Auto-refresh product selection to include new product
      refreshProductSelection();
      
      // Save products
      saveProductsToStorage();
      
      // Recharger les produits dans la section Produits
      chargerProduitsExistants();
      
      showNotification('Nouveau produit ajout√© avec succ√®s!', 'success');
      updateCalculation();
    }

    function removeProduct(button) {
      // V√©rifier le r√¥le - seuls coach/direction peuvent supprimer des produits
      const currentRole = localStorage.getItem('userRole') || 'entrepreneur';
      if (currentRole !== 'coach' && currentRole !== 'direction') {
        console.log('[PRODUCTS] Suppression de produit refus√©e - r√¥le:', currentRole);
        return;
      }

      if (confirm('√ätes-vous s√ªr de vouloir supprimer ce produit?')) {
        const row = button.closest('tr');
        row.remove();
        
        // Auto-refresh product selection after removal
        refreshProductSelection();
        
        // Save products after removal
        saveProductsToStorage();
        
        // Recharger les produits dans la section Produits
        chargerProduitsExistants();
        
        showNotification('Produit supprim√© avec succ√®s!', 'success');
        updateCalculation();
      }
    }

    // Fonction pour collecter toutes les sections cr√©√©es (exclut les sections "autre")
    function getAllCreatedSections() {
      const sections = [];
      const seenSections = new Set(); // Pour √©viter les doublons
      
      // Parcourir tous les conteneurs d'endroits
      document.querySelectorAll('[id^="endroit_"]').forEach(endroitDiv => {
        const endroitId = endroitDiv.id;
        const endroitTitle = endroitDiv.querySelector('h5')?.textContent || 'Section inconnue';
        
        // Exclure les sections "autre" du calcul de gallons
        if (endroitTitle.toLowerCase().includes('autre')) {
          return;
        }
        
        // Chercher toutes les sous-sections (plus flexible)
        endroitDiv.querySelectorAll('[id*="_"]').forEach(sousSectionDiv => {
          // V√©rifier que c'est bien une sous-section et pas l'endroit principal
          if (sousSectionDiv.id === endroitId || !sousSectionDiv.id.startsWith(endroitId)) {
            return;
          }
          
          const sectionTitle = sousSectionDiv.querySelector('h6')?.textContent || 'Sous-section inconnue';
          
          // Exclure aussi les travaux additionnels (temps seulement)
          if (sectionTitle.toLowerCase().includes('travail additionnel')) {
            return;
          }
          
          // V√©rifier les doublons avec une cl√© unique
          const sectionKey = `${endroitId}_${sectionTitle}`;
          if (seenSections.has(sectionKey)) {
            return;
          }
          seenSections.add(sectionKey);
          
          // Calculer la surface totale de cette section
          let totalSurface = 0;
          const inputs = sousSectionDiv.querySelectorAll('input[type="number"]');
          inputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            totalSurface += value;
          });
          
          if (totalSurface > 0) {
            sections.push({
              id: sousSectionDiv.id,
              endroitTitle: endroitTitle.replace('Peinture - ', ''),
              sectionTitle: sectionTitle,
              totalSurface: totalSurface,
              element: sousSectionDiv
            });
          }
        });
      });
      
      log('Sections trouv√©es:', sections); // Debug
      return sections;
    }

    // Fonction pour ouvrir le s√©lecteur de sections
    function openSectionSelector(button) {
      const row = button.closest('tr');
      const productName = row.querySelector('input[data-field="type"]').value;
      const ratio = parseFloat(row.querySelector('input[data-field="ratio"]').value) || 1;
      
      const sections = getAllCreatedSections();
      
      if (sections.length === 0) {
        showNotification('Aucune section cr√©√©e. Cr√©ez d\'abord des sections dans "Endroit √† peinturer".', 'warning');
        return;
      }
      
      // Cr√©er la modal de s√©lection
      const modal = document.createElement('div');
      modal.id = 'section-selector-modal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
          <h3 class="text-lg font-semibold mb-4">Appliquer ${productName} aux sections</h3>
          
          <!-- Options Primer et 3√®me couche -->
          <div class="mb-4 p-3 bg-gray-50 rounded">
            <h4 class="font-medium mb-2">Options additionnelles:</h4>
            <div class="flex space-x-6">
              <label class="flex items-center space-x-2">
                <input type="checkbox" id="primer-option" class="primer-checkbox">
                <span class="text-sm">Primer n√©cessaire</span>
              </label>
              <label class="flex items-center space-x-2">
                <input type="checkbox" id="third-coat-option" class="third-coat-checkbox">
                <span class="text-sm">3√®me couche n√©cessaire</span>
              </label>
            </div>
          </div>
          
          <div class="space-y-2 mb-4">
            ${sections.map(section => `
              <label class="flex items-center space-x-3 p-2 border rounded hover:bg-slate-700/50">
                <input type="checkbox" value="${section.id}" class="section-checkbox">
                <div class="flex-1">
                  <div class="font-medium">${section.endroitTitle} - ${section.sectionTitle}</div>
                  <div class="text-sm text-white">${section.totalSurface.toFixed(1)} ft¬≤ -> ${(() => {
                    const params = getCurrentParameterValues();
                    const firstCoat = section.totalSurface / ratio;
                    const secondCoat = firstCoat * (params.facteur_deuxieme_couche || 0.7);
                    return Math.ceil(firstCoat + secondCoat);
                  })()} gallons</div>
                </div>
              </label>
            `).join('')}
          </div>
          <div class="flex justify-end space-x-2">
            <button class="btn-secondary" onclick="document.getElementById('section-selector-modal').remove()">Annuler</button>
            <button class="btn-primary" onclick="applySectionsToProduct(this, '${row.rowIndex}')">Appliquer</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // Fonction pour appliquer les sections s√©lectionn√©es au produit
    function applySectionsToProduct(button, rowIndex) {
      const modal = document.getElementById('section-selector-modal');
      const checkedSections = modal.querySelectorAll('.section-checkbox:checked');
      const primerChecked = modal.querySelector('.primer-checkbox').checked;
      const thirdCoatChecked = modal.querySelector('.third-coat-checkbox').checked;
      
      if (checkedSections.length === 0) {
        showNotification('Veuillez s√©lectionner au moins une section.', 'warning');
        return;
      }
      
      // R√©cup√©rer les informations du produit
      const tbody = document.getElementById('products-table-body');
      const row = tbody.rows[rowIndex];
      const productName = row.querySelector('input[data-field="type"]').value;
      const productPrice = parseFloat(row.querySelector('input[data-field="prix"]').value) || 0;
      const ratio = parseFloat(row.querySelector('input[data-field="ratio"]').value) || 1;
      
      // R√©cup√©rer les param√®tres primer et 3√®me couche depuis les param√®tres admin
      const primerPrice = parseFloat(document.getElementById('param_dulux_gripper_prix')?.value) || 100;
      const primerCoverage = parseFloat(document.getElementById('param_dulux_gripper_couverture')?.value) || 200;
      
      // Calculer le total des gallons pour toutes les sections s√©lectionn√©es
      let totalGallons = 0;
      let totalPrimerGallons = 0;
      let totalThirdCoatGallons = 0;
      
      checkedSections.forEach(checkbox => {
        const sectionId = checkbox.value;
        const section = getAllCreatedSections().find(s => s.id === sectionId);
        if (section) {
          // Calcul premi√®re couche
          const firstCoatGallons = section.totalSurface / ratio;
          // Calcul deuxi√®me couche avec facteur 0.7
          const params = getCurrentParameterValues();
          const secondCoatGallons = firstCoatGallons * (params.facteur_deuxieme_couche || 0.7);
          const gallonsForSection = Math.ceil(firstCoatGallons + secondCoatGallons);
          totalGallons += gallonsForSection;
          
          // Calculer gallons pour primer et 3√®me couche si n√©cessaires
          if (primerChecked) {
            // PRIMER = UNE SEULE COUCHE
            const primerGallons = section.totalSurface / primerCoverage;
            totalPrimerGallons += primerGallons;
          }
          if (thirdCoatChecked) {
            const thirdCoatGallons = (section.totalSurface / ratio) * 2 - 1;
            totalThirdCoatGallons += thirdCoatGallons;
          }
        }
      });
      
      // Cr√©er UNE seule section produit avec le total des gallons
      addProductToSection('', productName, totalGallons, productPrice);
      
      // Ajouter primer si n√©cessaire
      if (primerChecked && totalPrimerGallons > 0) {
        addProductToSection('', 'Dulux Gripper (Primer)', totalPrimerGallons, primerPrice);
      }
      
      // Ajouter 3√®me couche si n√©cessaire
      if (thirdCoatChecked && totalThirdCoatGallons > 0) {
        addProductToSection('', productName + ' (3√®me couche)', totalThirdCoatGallons, productPrice);
      }
      
      // Nettoyer compl√®tement l'affichage du tableau
      const gallonsDisplay = row.querySelector('.gallons-display');
      gallonsDisplay.textContent = ''; // Vider l'affichage des gallons
      
      // Vider aussi l'affichage des sections appliqu√©es
      const produitId = row.querySelector('input[data-field="type"]').value.replace(/\s+/g, '_').toLowerCase();
      const sectionsDiv = document.getElementById(`${produitId}-sections`);
      if (sectionsDiv) {
        sectionsDiv.classList.add('hidden'); // Cacher la div des sections
      }
      
      // Fermer la modal
      modal.remove();
      
      // Message de notification d√©taill√©
      let message = `Produit "${productName}" appliqu√© avec ${totalGallons.toFixed(2)} gallons`;
      if (primerChecked) {
        message += ` + Primer: ${totalPrimerGallons.toFixed(2)} gallons`;
      }
      if (thirdCoatChecked) {
        message += ` + 3√®me couche: ${totalThirdCoatGallons.toFixed(2)} gallons`;
      }
      
      showNotification(message, 'success');
      
      // Recalculer
      updateCalculation();
    }

    // Fonction pour ajouter un produit comme nouvelle section dans "Endroit √† peinturer"
    function addProductToSection(sectionId, productName, gallons, pricePerGallon, sectionName = '') {
      // Cr√©er une nouvelle section produit dans "Endroit √† peinturer"
      const endroitContainer = document.getElementById('endroits-container');
      if (!endroitContainer) {
        error('Conteneur endroits-container non trouv√©');
        return;
      }

      // Cr√©er l'ID unique pour cette section produit
      const productSectionId = `produit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      
      // Cr√©er la nouvelle section produit
      const productSection = document.createElement('div');
      productSection.id = productSectionId;
      productSection.className = 'mb-6 p-4 border rounded-lg bg-gray-50 mt-4';
      productSection.innerHTML = `
        <div class="mb-3">
          <h6 class="text-lg font-semibold text-white">${productName}</h6>
        </div>
        <div class="grid grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Nombre de gallon</label>
            <input 
              type="number" 
              value="${gallons.toFixed(2)}" 
              step="0.01" 
              min="0"
              class="w-full px-3 py-2 border rounded product-gallons-input"
              data-product-name="${productName}"
              data-price-per-gallon="${pricePerGallon}"
              data-section-name="${sectionName}"
              data-section-id="${sectionId}"
              onchange="updateProductCost(this); updateCalculation();"
            >
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Prix par gallon</label>
            <div class="px-3 py-2 bg-gray-100 border rounded">${pricePerGallon.toFixed(2)}$</div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Co√ªt total</label>
            <div class="px-3 py-2 bg-gray-100 border rounded product-total-cost font-semibold text-gray-300">${(gallons * pricePerGallon).toFixed(2)}$</div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Actions</label>
            <button class="w-full px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600" onclick="removeProductSection('${productSectionId}')">
              - Supprimer
            </button>
          </div>
        </div>
        
        <!-- Options Primer et 3√®me couche -->
        <div class="mt-4 pt-4 border-t border-gray-700/50">
          <h6 class="font-medium text-gray-300 mb-3">Options additionnelles:</h6>
          <div class="flex space-x-8">
            <label class="flex items-center space-x-2">
              <input type="checkbox" id="${productSectionId}-primer" class="primer-option" onchange="updateProductSectionOptions('${productSectionId}')">
              <span class="text-sm">Primer n√©cessaire</span>
            </label>
            <label class="flex items-center space-x-2">
              <input type="checkbox" id="${productSectionId}-third-coat" class="third-coat-option" onchange="updateProductSectionOptions('${productSectionId}')">
              <span class="text-sm">3√®me couche n√©cessaire</span>
            </label>
          </div>
          <!-- √âl√©ments cach√©s pour stocker les valeurs calcul√©es -->
          <span id="${productSectionId}-primer-total" class="hidden">0.00</span>
          <span id="${productSectionId}-third-coat-total" class="hidden">0.00</span>
        </div>
      `;
      
      // Ajouter la section dans le conteneur "Endroit √† peinturer"
      endroitContainer.appendChild(productSection);
      
      // Initialiser les calculs des options
      setTimeout(() => {
        updateProductSectionOptions(productSectionId);
      }, 100);
    }

    function updateProductSectionOptions(productSectionId) {
      const primerCheckbox = document.getElementById(`${productSectionId}-primer`);
      const thirdCoatCheckbox = document.getElementById(`${productSectionId}-third-coat`);
      const gallonsInput = document.querySelector(`#${productSectionId} .product-gallons-input`);
      
      if (!gallonsInput) return;
      
      const baseGallons = parseFloat(gallonsInput.value) || 0;
      const pricePerGallon = parseFloat(gallonsInput.getAttribute('data-price-per-gallon')) || 0;
      
      // R√©cup√©rer les param√®tres primer depuis les param√®tres admin
      const primerPrice = parseFloat(document.getElementById('param_dulux_gripper_prix')?.value) || 100;
      const primerCoverage = parseFloat(document.getElementById('param_dulux_gripper_couverture')?.value) || 200;
      
      // Calculer les co√ªts (sans les afficher)
      // PRIMER = UNE SEULE COUCHE (pas de facteur 2√®me couche)
      // Le baseGallons contient d√©j√† 2 couches du produit principal, on doit recalculer pour le primer
      const estimatedProductCoverage = 200;
      // Pour le primer: on prend la surface totale et on divise par la couverture du primer (1 couche seulement)
      const totalSurfaceForPrimer = baseGallons * estimatedProductCoverage / 1.7; // Annuler l'effet des 2 couches (1 + 0.7)
      const primerGallons = totalSurfaceForPrimer / primerCoverage;
      const thirdCoatGallons = baseGallons;
      
      // Stocker les totaux calcul√©s dans les √©l√©ments cach√©s
      const primerTotalSpan = document.getElementById(`${productSectionId}-primer-total`);
      const thirdCoatTotalSpan = document.getElementById(`${productSectionId}-third-coat-total`);
      
      if (primerTotalSpan) {
        const primerTotal = primerCheckbox.checked ? (primerGallons * primerPrice) : 0;
        primerTotalSpan.textContent = primerTotal.toFixed(2);
      }
      
      if (thirdCoatTotalSpan) {
        const thirdCoatTotal = thirdCoatCheckbox.checked ? (thirdCoatGallons * pricePerGallon) : 0;
        thirdCoatTotalSpan.textContent = thirdCoatTotal.toFixed(2);
      }
      
      // Recalculer les co√ªts totaux
      updateCalculation();
    }

    // Fonction pour mettre √† jour le co√ªt d'un produit quand on modifie les gallons
    function updateProductCost(input) {
      const gallons = parseFloat(input.value) || 0;
      const pricePerGallon = parseFloat(input.getAttribute('data-price-per-gallon'));
      const totalCost = gallons * pricePerGallon;
      
      // Mettre √† jour l'affichage du co√ªt total (chercher dans toute la section produit)
      const productSection = input.closest('.bg-gray-50');
      const costDisplay = productSection.querySelector('.product-total-cost');
      if (costDisplay) {
        costDisplay.textContent = `${totalCost.toFixed(2)}$`;
      }
      
      // Mettre √† jour les calculs des options primer et 3√®me couche
      const productSectionId = productSection.id;
      if (productSectionId) {
        updateProductSectionOptions(productSectionId);
      }
      
      // Mettre √† jour le data-price-per-gallon en cas de changement depuis le tableau
      // Note: fonction syncProductPriceFromTable supprim√©e - pas n√©cessaire
      
      // Recalculer le total g√©n√©ral
      updateCalculation();
    }

    // Fonction pour supprimer une section produit compl√®te
    function removeProductSection(productSectionId) {
      const productSection = document.getElementById(productSectionId);
      if (!productSection) return;
      
      productSection.remove();
      showNotification('Section produit supprim√©e', 'success');
      updateCalculation();
    }

    // Fonction pour dupliquer une section produit
    function duplicateProductSection(productSectionId) {
      const originalSection = document.getElementById(productSectionId);
      if (!originalSection) return;
      
      const productName = originalSection.querySelector('h6').textContent;
      const gallonsInput = originalSection.querySelector('.product-gallons-input');
      const gallons = parseFloat(gallonsInput.value) || 0;
      const pricePerGallon = parseFloat(gallonsInput.getAttribute('data-price-per-gallon')) || 0;
      
      // Cr√©er une nouvelle section identique
      addProductToSection('', productName, gallons, pricePerGallon);
      showNotification('Section produit dupliqu√©e', 'success');
    }

    // Fonction pour retirer un produit d'une section (legacy - pour compatibilit√©)
    function removeProductFromSection(productId, sectionId) {
      const productElement = document.getElementById(productId);
      if (!productElement) return;
      
      productElement.remove();
      
      showNotification('Produit retir√© de la section', 'success');
      updateCalculation();
    }

    // Fonction pour calculer le co√ªt total des produits appliqu√©s dans les sections
    function calculateAppliedProductsCost() {
      let totalCost = 0;
      
      // Parcourir tous les inputs de produits dans les sections
      document.querySelectorAll('.product-gallons-input').forEach(input => {
        const gallons = parseFloat(input.value) || 0;
        const pricePerGallon = parseFloat(input.getAttribute('data-price-per-gallon')) || 0;
        totalCost += gallons * pricePerGallon;
      });
      
      // Ajouter les co√ªts des options primer et 3√®me couche dans les sections produit
      document.querySelectorAll('.primer-option:checked').forEach(checkbox => {
        const sectionId = checkbox.id.replace('-primer', '');
        const totalElement = document.getElementById(`${sectionId}-primer-total`);
        if (totalElement) {
          const cost = parseFloat(totalElement.textContent) || 0;
          totalCost += cost;
        }
      });
      
      document.querySelectorAll('.third-coat-option:checked').forEach(checkbox => {
        const sectionId = checkbox.id.replace('-third-coat', '');
        const totalElement = document.getElementById(`${sectionId}-third-coat-total`);
        if (totalElement) {
          const cost = parseFloat(totalElement.textContent) || 0;
          totalCost += cost;
        }
      });
      
      return totalCost;
    }

    // Fonction pour mettre √† jour les lignes existantes du tableau des produits
    function updateExistingProductRows() {
      const tbody = document.getElementById('products-table-body');
      const rows = tbody.querySelectorAll('tr');
      
      rows.forEach(row => {
        // V√©rifier si la ligne a d√©j√† les nouvelles colonnes
        const cellCount = row.querySelectorAll('td').length;
        if (cellCount < 8) { // Si moins de 8 colonnes, mettre √† jour
          const prixCell = row.querySelector('input[data-field="prix"]')?.closest('td');
          const actionsCell = row.querySelector('button[onclick*="removeProduct"]')?.closest('td');
          
          if (prixCell && actionsCell) {
            // Cr√©er les nouvelles cellules
            const gallonsCell = document.createElement('td');
            gallonsCell.className = 'border: 1px solid var(--border-dark); px-4 py-3 text-center';
            gallonsCell.innerHTML = '<span class="text-sm font-medium gallons-display">0.0 gal</span>';
            
            const applyCell = document.createElement('td');
            applyCell.className = 'border: 1px solid var(--border-dark); px-1 py-1 text-center';
            applyCell.innerHTML = '<button class="btn-primary text-xs" style="width: 60%; height: 50%;" onclick="openSectionSelector(this)" title="Appliquer aux sections"><i class="fas fa-plus"></i> Appliquer</button>';
            
            // Ins√©rer les nouvelles cellules avant les actions
            row.insertBefore(gallonsCell, actionsCell);
            row.insertBefore(applyCell, actionsCell);
          }
        }
      });
    }

    // Mettre √† jour les lignes existantes au chargement
    document.addEventListener('DOMContentLoaded', function() {
      chargerProduitsExistants();
    });

    // Gestion des permissions et affichage maintenant centralis√©e dans common.js

    function updateProductSelector() {
      // Mettre √† jour le s√©lecteur de produits dans la section estimation
      const tbody = document.getElementById('products-table-body');
      const select = document.getElementById('paintType');
      
      if (!select) return;
      
      // Sauvegarder la valeur actuelle
      const currentValue = select.value;
      
      // Vider le s√©lecteur
      select.innerHTML = '';
      
      // Ajouter les produits de la table
      Array.from(tbody.rows).forEach((row, index) => {
        const typeInput = row.querySelector('[data-field="type"]');
        const ratioInput = row.querySelector('[data-field="ratio"]');
        const prixInput = row.querySelector('[data-field="prix"]');
        
        if (typeInput && typeInput.value.trim()) {
          const option = document.createElement('option');
          option.value = `product-${index}`;
          option.textContent = `${typeInput.value} (${ratioInput.value} ft¬≤/gallon - ${prixInput.value}$)`;
          select.appendChild(option);
        }
      });
      
      // Restaurer la valeur si possible
      if (currentValue && document.querySelector(`option[value="${currentValue}"]`)) {
        select.value = currentValue;
      } else if (select.options.length > 0) {
        select.selectedIndex = 0;
      }
      
      // D√©clencher le recalcul
      updateCalculation();
    }

    function showNotification(message, type = 'info') {
      // Ne pas afficher les notifications pendant le chargement d'un projet
      if (isLoadingProject) {
        return;
      }

      // Create notification element
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;

      // Set color based on type
      switch(type) {
        case 'success':
          notification.style.backgroundColor = '#5271ff';
          notification.classList.add('text-white');
          break;
        case 'error':
          notification.classList.add('bg-red-500', 'text-white');
          break;
        case 'warning':
          notification.classList.add('bg-yellow-500', 'text-white');
          break;
        default:
          notification.style.backgroundColor = '#5271ff';
          notification.classList.add('text-white');
      }

      notification.innerHTML = `
        <div class="flex items-center gap-2">
          <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation' : 'info'}-circle"></i>
          <span>${message}</span>
        </div>
      `;

      document.body.appendChild(notification);
      
      // Animate in
      setTimeout(() => {
        notification.classList.remove('translate-x-full');
      }, 100);
      
      // Remove after 4 seconds
      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 300);
      }, 4000);
    }

    // Initialize file input listener
    document.addEventListener('DOMContentLoaded', function() {
      const fileInput = document.getElementById('importFile');
      if (fileInput) {
        fileInput.addEventListener('change', importParametersFromFile);
      }
    });

    // NOUVEAU SYST√àME DYNAMIQUE - Fonctions pour ajouter/g√©rer les lavages, pr√©parations et endroits
    let lavageCounter = 0;
    let preparationCounter = 0;
    let primerCounter = 0;
    let endroitCounter = 0;

    function ajouterLavage() {
      const select = document.getElementById('lavage-select');
      const lavageType = select.value;
      const lavageText = select.options[select.selectedIndex].text;
      
      if (!lavageType) {
        showNotification('Veuillez s√©lectionner un type de lavage', 'warning');
        return;
      }
      
      const container = document.getElementById('lavages-container');
      
      // D√©terminer l'unit√© selon le type
      let unite = 'ft¬≤';
      if (lavageType === 'lavage_main_lineaire') {
        unite = 'ft lin.';
      } else if (lavageType === 'lavage_portes_fenetres') {
        unite = 'unit√©s';
      }
      
      // Ajouter une nouvelle section dans la bo√Æte principale
      lavageCounter++;
      const sectionId = `lavage_${lavageCounter}`;
      
      const sectionDiv = document.createElement('div');
      sectionDiv.className = 'pt-4 first:pt-0';
      sectionDiv.id = sectionId;
      sectionDiv.innerHTML = `
        <div class="mb-2 flex justify-between items-center">
          <h5 class="font-medium text-gray-300">${lavageText}</h5>
          <button class="btn-secondary text-xs px-2 py-1" onclick="retirerLavage('${sectionId}')" title="Supprimer ce lavage">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Avant (${unite})</label>
            <input type="number" class="input-field" data-lavage="${sectionId}" data-type="${lavageType}" data-section="avant" placeholder="0" oninput="updateCalculation()">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Droit (${unite})</label>
            <input type="number" class="input-field" data-lavage="${sectionId}" data-type="${lavageType}" data-section="droit" placeholder="0" oninput="updateCalculation()">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Arri√®re (${unite})</label>
            <input type="number" class="input-field" data-lavage="${sectionId}" data-type="${lavageType}" data-section="arriere" placeholder="0" oninput="updateCalculation()">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Gauche (${unite})</label>
            <input type="number" class="input-field" data-lavage="${sectionId}" data-type="${lavageType}" data-section="gauche" placeholder="0" oninput="updateCalculation()">
          </div>
        </div>
      `;
      
      container.appendChild(sectionDiv);

      // Reset du select natif au placeholder
      select.value = '';
      select.selectedIndex = 0;

      // Forcer la mise √† jour du custom dropdown
      const customSelect = select.previousElementSibling;
      if (customSelect && customSelect.classList.contains('custom-select')) {
        // Mettre √† jour le texte affich√©
        const textElement = customSelect.querySelector('.custom-select-text');
        if (textElement && select.options[0]) {
          textElement.textContent = select.options[0].textContent;
        }

        // Retirer 'selected' de toutes les options et l'ajouter seulement au placeholder
        const allOptions = customSelect.querySelectorAll('.custom-select-option');
        allOptions.forEach((opt, idx) => {
          if (idx === 0) {
            opt.classList.add('selected');
          } else {
            opt.classList.remove('selected');
          }
        });

        // Fermer le dropdown
        customSelect.classList.remove('open');
      }

      showNotification(`${lavageText} ajout√©`, 'success');
      updateCalculation();
    }

    function retirerBoxType(endroitType) {
      const box = document.getElementById(`box-${endroitType}`);
      if (box) {
        log('[DELETE] Suppression section:', endroitType);

        // Approche diff√©rente : afficher une modal de confirmation qui liste les produits
        // et demande confirmation avant suppression

        // 1. R√©cup√©rer TOUS les produits actuellement dans endroits-container
        const endroitsContainer = document.getElementById('endroits-container');
        const allProductSections = endroitsContainer ? endroitsContainer.querySelectorAll('[id^="produit_"]') : [];

        if (allProductSections.length > 0) {
          // Cr√©er une modal de confirmation
          const confirmModal = document.createElement('div');
          confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
          confirmModal.innerHTML = `
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4" style="color: var(--text-light);">
              <h3 class="text-lg font-semibold mb-4">[WARN] Supprimer la section "${endroitType}" ?</h3>
              <p class="mb-4">Cette action va supprimer tous les produits appliqu√©s dans "Endroit √† peinturer".</p>
              <p class="mb-4 text-yellow-400">[WARN] Tous les produits dans "Endroit √† peinturer" seront supprim√©s, pas seulement ceux de cette section.</p>
              <div class="flex justify-end space-x-2">
                <button class="btn-secondary" onclick="this.closest('.fixed').remove()">Annuler</button>
                <button class="btn-primary" onclick="confirmDeleteBoxType('${endroitType}')">Confirmer</button>
              </div>
            </div>
          `;
          document.body.appendChild(confirmModal);
        } else {
          // Pas de produits, supprimer directement
          confirmDeleteBoxType(endroitType);
        }
      }
    }

    function confirmDeleteBoxType(endroitType) {
      const box = document.getElementById(`box-${endroitType}`);
      if (!box) return;

      // Fermer la modal de confirmation
      const modal = document.querySelector('.fixed.inset-0');
      if (modal) modal.remove();

      log('[OK] Confirmation suppression section:', endroitType);

      // 1. Trouver l'ID de l'endroit (ex: endroit_1) dans la box
      const endroitDiv = box.querySelector('[id^="endroit_"]');
      const endroitId = endroitDiv ? endroitDiv.id : null;

      log('[DEBUG] ID de l\'endroit √† supprimer:', endroitId);

      if (!endroitId) {
        error('[ERROR] Impossible de trouver l\'ID de l\'endroit');
        box.remove();
        return;
      }

      // 2. D√©s√©lectionner et supprimer les produits de selectedProducts qui contiennent cet endroitId
      const productKeysToRemove = [];
      Object.keys(selectedProducts).forEach(productKey => {
        if (productKey.includes(`_${endroitId}_`)) {
          productKeysToRemove.push(productKey);
          delete selectedProducts[productKey];
          log('[OK] Produit retir√© de selectedProducts:', productKey);
        }
      });

      log('[PACKAGE] Cl√©s produits supprim√©es:', productKeysToRemove);

      // 3. Retirer la classe 'selected' des cartes produits correspondantes
      document.querySelectorAll('.product-card.selected').forEach(card => {
        const productKey = card.getAttribute('data-product-key');
        if (productKey && productKeysToRemove.includes(productKey)) {
          card.classList.remove('selected');
          log('[OK] Carte produit d√©s√©lectionn√©e:', productKey);
        }
      });

      // 4. Supprimer la box
      box.remove();
      showNotification('Section supprim√©e avec succ√®s', 'success');

      // 5. Recalculer tout
      updateCalculation();
    }

    function ajouterEndroit() {
      const select = document.getElementById('endroit-select');
      const endroitType = select.value;
      const endroitText = select.options[select.selectedIndex].text;


      if (!endroitType) {
        showNotification('Veuillez s√©lectionner un type d\'endroit', 'warning');
        return;
      }

      // V√©rifier s'il existe d√©j√† une box pour ce type
      const existingBox = document.getElementById(`box-${endroitType}`);
      if (existingBox) {
        showNotification(`Une section "${endroitText}" existe d√©j√†. Maximum 1 par type.`, 'warning');
        return;
      }

      endroitCounter++;
      const endroitId = `endroit_${endroitCounter}`;

      // Cr√©er une nouvelle box s√©par√©e pour ce type au lieu d'utiliser le container commun
      // Trouver le container "endroits-container" pour ins√©rer avant
      const endroitsContainer = document.getElementById('endroits-container');
      const mainContainer = endroitsContainer.parentElement;

      const typeBoxDiv = document.createElement('div');
      typeBoxDiv.className = 'box';
      typeBoxDiv.id = `box-${endroitType}`;

      const endroitDiv = document.createElement('div');
      endroitDiv.className = 'pt-4 first:pt-0';
      endroitDiv.id = endroitId;

      // Cr√©er la structure box avec header et contenu
      typeBoxDiv.innerHTML = `
        <div class="box-header">
          <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <div class="box-header-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <i class="fas fa-paint-brush"></i>
              </div>
              <h2 class="box-header-title">${endroitText}</h2>
            </div>
            <button class="btn-secondary text-xs px-2 py-1" onclick="retirerBoxType('${endroitType}')" title="Supprimer cette section ${endroitText}" style="display: flex !important; align-items: center !important; justify-content: center !important;">
              <i class="fas fa-trash" style="color: white !important; margin: 0 !important;"></i>
            </button>
          </div>
        </div>
        <div class="box-body">
        </div>
      `;

      endroitDiv.innerHTML = `
        <div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-300 mb-2">S√©lectionner le type sp√©cifique :</label>
            <select id="${endroitId}-type-select" class="select-field">
              <option value="">Choisir un type...</option>
              ${getOptionsForEndroitType(endroitType)}
            </select>
          </div>
          <button id="${endroitId}-ajouter" class="btn-primary mb-4" onclick="ajouterSousSection('${endroitId}', '${endroitType}')">
            <i class="fas fa-plus"></i> Ajouter ce type
          </button>

          <!-- Container des sous-sections ajout√©es -->
          <div id="${endroitId}-container" class="space-y-4">
            <!-- Les sous-sections appara√Ætront ici -->
          </div>
        </div>
      `;

      // Ajouter l'endroitDiv dans la partie contenu de la box, puis la typeBoxDiv avant endroits-container
      const contentDiv = typeBoxDiv.querySelector('.box-body');
      contentDiv.appendChild(endroitDiv);

      // Trouver le parent de endroits-container qui est le div avec la classe box
      const endroitsParent = endroitsContainer.closest('.box');
      const grandParent = endroitsParent.parentElement;

      // Chercher la derni√®re section ajout√©e (derni√®re box avec id qui commence par "box-")
      const allBoxes = grandParent.querySelectorAll('[id^="box-"]');
      if (allBoxes.length > 0) {
        // Ins√©rer apr√®s la derni√®re box cr√©√©e
        const lastBox = allBoxes[allBoxes.length - 1];
        const nextElement = lastBox.nextElementSibling;
        if (nextElement) {
          grandParent.insertBefore(typeBoxDiv, nextElement);
        } else {
          grandParent.appendChild(typeBoxDiv);
        }
      } else {
        // Premi√®re box, ins√©rer apr√®s endroits-container
        const nextElement = endroitsParent.nextElementSibling;
        if (nextElement) {
          grandParent.insertBefore(typeBoxDiv, nextElement);
        } else {
          grandParent.appendChild(typeBoxDiv);
        }
      }

      // Convertir le nouveau dropdown en custom dropdown
      convertToCustomDropdowns();

      // Ajouter les √©v√©nements pour fer forg√© si c'est une section fer forg√©
      if (endroitType === 'fer_forge') {

        // Utiliser setTimeout pour s'assurer que les √©l√©ments sont cr√©√©s
        setTimeout(() => {
          // Chercher tous les inputs dans la section fer forg√©
          const allInputs = typeBoxDiv.querySelectorAll('input[type="number"]');

          allInputs.forEach(input => {

            // Chercher dans les parents pour trouver le type fer forg√©
            let ferForgeType = null;

            // V√©rifier les diff√©rents patterns d'ID pour identifier le type
            if (input.id && input.id.includes('rampe_complexe_tres_rouillee')) {
              ferForgeType = 'rampe_complexe_tres_rouillee';
            } else if (input.id && input.id.includes('rampe_complexe_moyennement_rouillee')) {
              ferForgeType = 'rampe_complexe_moyennement_rouillee';
            } else if (input.id && input.id.includes('rampe_barreaux_droits_verticaux')) {
              ferForgeType = 'rampe_barreaux_droits_verticaux';
            } else if (input.id && input.id.includes('rampe_horizontale_moyenne_tres_rouillee')) {
              ferForgeType = 'rampe_horizontale_moyenne_tres_rouillee';
            } else if (input.id && input.id.includes('rampe_horizontale_facile_moyennement_rouillee')) {
              ferForgeType = 'rampe_horizontale_facile_moyennement_rouillee';
            }
            // ... plus de types fer forg√©

            if (ferForgeType) {
              input.setAttribute('data-fer-forge', ferForgeType);

              // Ajouter updateProductDetails() √† l'√©v√©nement onchange existant
              const currentOnchange = input.getAttribute('onchange') || '';
              if (!currentOnchange.includes('updateProductDetails()')) {
                input.setAttribute('onchange', currentOnchange + ' updateProductDetails();');
              }
            }
          });

          // V√©rifier imm√©diatement si les √©l√©ments sont d√©tect√©s
          const allFerForgeElements = document.querySelectorAll('[data-fer-forge]');
        }, 100);
      }

      // Reset du select natif au placeholder
      select.value = '';
      select.selectedIndex = 0;

      // Forcer la mise √† jour du custom dropdown
      const customSelect = select.previousElementSibling;
      if (customSelect && customSelect.classList.contains('custom-select')) {
        // Mettre √† jour le texte affich√©
        const textElement = customSelect.querySelector('.custom-select-text');
        if (textElement && select.options[0]) {
          textElement.textContent = select.options[0].textContent;
        }

        // Retirer 'selected' de toutes les options et l'ajouter seulement au placeholder
        const allOptions = customSelect.querySelectorAll('.custom-select-option');
        allOptions.forEach((opt, idx) => {
          if (idx === 0) {
            opt.classList.add('selected');
          } else {
            opt.classList.remove('selected');
          }
        });

        // Fermer le dropdown
        customSelect.classList.remove('open');
      }

      // Scroll vers le bas de la page (sauf pendant le chargement d'un projet)
      if (!isLoadingProject) {
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: 'smooth'
        });
      }

      // Si c'est une section fer forg√©, ajouter automatiquement le produit "Peinture fer forg√©" √† 0 gallon
      if (endroitType === 'fer_forge') {
        const productKey = `peinture_fer_forge_${endroitId}`;
        const params = getCurrentParameterValues();

        selectedProducts[productKey] = {
          name: 'Peinture fer forg√©',
          quantity: 0, // Commence √† 0 gallon
          gallonsExact: 0,
          price: params.peinture_fer_forge || 47.50,
          total: 0
        };


        // Mettre √† jour l'affichage des d√©tails des produits
        updateProductDetails();
      }

      showNotification(`${endroitText} ajout√© avec succ√®s`, 'success');
      updateCalculation();
    }

    function retirerEndroit(endroitId) {
      const endroit = document.getElementById(endroitId);
      if (endroit) {
        // Supprimer les produits associ√©s √† cet endroit
        Object.keys(selectedProducts).forEach(productKey => {
          if (productKey.includes(`_${endroitId}`) || productKey.endsWith(`_${endroitId}`)) {
            delete selectedProducts[productKey];
          }
        });

        endroit.remove();
        showNotification('Endroit supprim√©', 'success');
        updateCalculation();
      }
    }

    function ajouterPreparation() {
      const select = document.getElementById('preparation-select');
      const preparationType = select.value;
      const preparationText = select.options[select.selectedIndex].text;

      if (!preparationType) {
        showNotification('Veuillez s√©lectionner un type de pr√©paration', 'warning');
        return;
      }

      const container = document.getElementById('preparations-container');

      // Ajouter une nouvelle section dans la bo√Æte principale
      preparationCounter++;
      const sectionId = `preparation_${preparationCounter}`;

      // D√©terminer l'unit√© selon le type de pr√©paration
      const isLinear = preparationType.includes('corniches') ||
                       preparationType.includes('lineaire') ||
                       preparationType.includes('grattage_40min') ||
                       preparationType.includes('grattage_20min') ||
                       preparationType.includes('grattage_10min');
      const unit = isLinear ? 'ft' : 'ft¬≤';

      const sectionDiv = document.createElement('div');
      sectionDiv.className = 'pt-4 first:pt-0';
      sectionDiv.id = sectionId;
      sectionDiv.innerHTML = `
        <div class="mb-2 flex justify-between items-center">
          <h5 class="font-medium text-gray-300">${preparationText}</h5>
          <button class="btn-secondary text-xs px-2 py-1" onclick="retirerPreparation('${sectionId}')" title="Supprimer cette pr√©paration">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Avant (${unit})</label>
            <input type="number" class="input-field" data-preparation="${sectionId}" data-type="${preparationType}" data-section="avant" placeholder="0" oninput="updateCalculation()">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Droit (${unit})</label>
            <input type="number" class="input-field" data-preparation="${sectionId}" data-type="${preparationType}" data-section="droit" placeholder="0" oninput="updateCalculation()">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Arri√®re (${unit})</label>
            <input type="number" class="input-field" data-preparation="${sectionId}" data-type="${preparationType}" data-section="arriere" placeholder="0" oninput="updateCalculation()">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Gauche (${unit})</label>
            <input type="number" class="input-field" data-preparation="${sectionId}" data-type="${preparationType}" data-section="gauche" placeholder="0" oninput="updateCalculation()">
          </div>
        </div>
      `;
      
      container.appendChild(sectionDiv);

      // Reset du select natif au placeholder
      select.value = '';
      select.selectedIndex = 0;

      // Forcer la mise √† jour du custom dropdown
      const customSelect = select.previousElementSibling;
      if (customSelect && customSelect.classList.contains('custom-select')) {
        // Mettre √† jour le texte affich√©
        const textElement = customSelect.querySelector('.custom-select-text');
        if (textElement && select.options[0]) {
          textElement.textContent = select.options[0].textContent;
        }

        // Retirer 'selected' de toutes les options et l'ajouter seulement au placeholder
        const allOptions = customSelect.querySelectorAll('.custom-select-option');
        allOptions.forEach((opt, idx) => {
          if (idx === 0) {
            opt.classList.add('selected');
          } else {
            opt.classList.remove('selected');
          }
        });

        // Fermer le dropdown
        customSelect.classList.remove('open');
      }

      showNotification(`${preparationText} ajout√©`, 'success');

      // Log imm√©diat apr√®s ajout
      log(`[FIX] AJOUT PR√âPARATION: ${preparationText}`);
      log('[FIX] Recalcul en cours...');

      updateCalculation();
    }

    function ajouterPrimer() {
      const select = document.getElementById('primer-surface-select');
      const surfaceType = select.value;
      const surfaceText = select.options[select.selectedIndex].text;

      if (!surfaceType) {
        showNotification('Veuillez s√©lectionner un type de surface', 'warning');
        return;
      }

      const container = document.getElementById('primers-container');

      // Ajouter une nouvelle section dans la bo√Æte principale
      primerCounter++;
      const sectionId = `primer_${primerCounter}`;

      // D√©terminer l'unit√© selon le type de surface
      const isLinear = surfaceType.includes('lineaire');
      const unit = isLinear ? 'ft' : 'ft¬≤';

      const sectionDiv = document.createElement('div');
      sectionDiv.className = 'pt-4 first:pt-0 border-b border-gray-600 pb-4';
      sectionDiv.id = sectionId;
      sectionDiv.innerHTML = `
        <div class="mb-3 flex justify-between items-center">
          <h5 class="font-medium text-gray-300">${surfaceText}</h5>
          <button class="btn-secondary text-xs px-2 py-1" onclick="retirerPrimer('${sectionId}')" title="Supprimer cette surface">
            <i class="fas fa-trash"></i>
          </button>
        </div>

        <!-- Inputs pieds carr√©s/lin√©aires -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Avant (${unit})</label>
            <input type="number" class="input-field" data-primer="${sectionId}" data-surface-type="${surfaceType}" data-section="avant" placeholder="0" oninput="updatePrimerCalculation('${sectionId}')">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Droit (${unit})</label>
            <input type="number" class="input-field" data-primer="${sectionId}" data-surface-type="${surfaceType}" data-section="droit" placeholder="0" oninput="updatePrimerCalculation('${sectionId}')">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Arri√®re (${unit})</label>
            <input type="number" class="input-field" data-primer="${sectionId}" data-surface-type="${surfaceType}" data-section="arriere" placeholder="0" oninput="updatePrimerCalculation('${sectionId}')">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Gauche (${unit})</label>
            <input type="number" class="input-field" data-primer="${sectionId}" data-surface-type="${surfaceType}" data-section="gauche" placeholder="0" oninput="updatePrimerCalculation('${sectionId}')">
          </div>
        </div>

        <!-- Surface totale et heures -->
        <div class="mb-4 p-3 bg-slate-700/30 rounded-lg">
          <div class="flex justify-between items-center">
            <span class="text-sm font-medium text-gray-300">Surface totale :</span>
            <span id="totalSurface_${sectionId}" class="font-bold text-blue-400">0 ${unit}</span>
          </div>
          <div class="flex justify-between items-center mt-2">
            <span class="text-sm font-medium text-gray-300">Heures requises :</span>
            <span id="heuresRequises_${sectionId}" class="font-bold text-green-400">0.0h</span>
          </div>
        </div>

        <!-- S√©lection primer (products cliquables) -->
        <div class="mb-4">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-semibold text-white">Primers disponibles</h4>
          </div>
          <div class="grid grid-cols-2 gap-2" id="primerProducts_${sectionId}">

            <!-- Dulux Gripper -->
            <div class="surface-card product-card p-2 cursor-pointer transition-all duration-200 hover:scale-105"
                 onclick="togglePrimerSelection('${sectionId}', 'dulux_gripper', event)"
                 style="border: 2px solid var(--border-dark) !important;"
                 onmouseover="this.style.backgroundColor='#065f46'; this.style.setProperty('border', '2px solid #10b981', 'important');"
                 onmouseout="if(!this.classList.contains('selected')) { this.style.backgroundColor=''; this.style.setProperty('border', '2px solid var(--border-dark)', 'important'); }">
              <div class="flex items-center space-x-2">
                <div class="flex-1">
                  <div class="text-sm font-medium text-white">Dulux Gripper</div>
                  <div class="flex items-center justify-between text-xs mt-1">
                    <span class="product-badge px-1.5 py-0.5 rounded text-xs">200 ft¬≤/gal</span>
                    <span class="font-semibold text-white">$100/gal</span>
                  </div>
                  <!-- Inputs cach√©s pour stocker les valeurs -->
                  <input type="hidden" id="gallons_dulux_gripper_${sectionId}" value="0">
                  <span id="cost_dulux_gripper_${sectionId}" style="display: none;">$0.00</span>
                </div>
              </div>
            </div>

            <!-- Cover Stain -->
            <div class="surface-card product-card p-2 cursor-pointer transition-all duration-200 hover:scale-105"
                 onclick="togglePrimerSelection('${sectionId}', 'jammer_huile', event)"
                 style="border: 2px solid var(--border-dark) !important;"
                 onmouseover="this.style.backgroundColor='#065f46'; this.style.setProperty('border', '2px solid #10b981', 'important');"
                 onmouseout="if(!this.classList.contains('selected')) { this.style.backgroundColor=''; this.style.setProperty('border', '2px solid var(--border-dark)', 'important'); }">
              <div class="flex items-center space-x-2">
                <div class="flex-1">
                  <div class="text-sm font-medium text-white">Cover Stain</div>
                  <div class="flex items-center justify-between text-xs mt-1">
                    <span class="product-badge px-1.5 py-0.5 rounded text-xs">200 ft¬≤/gal</span>
                    <span class="font-semibold text-white">$100/gal</span>
                  </div>
                  <!-- Inputs cach√©s pour stocker les valeurs -->
                  <input type="hidden" id="gallons_jammer_huile_${sectionId}" value="0">
                  <span id="cost_jammer_huile_${sectionId}" style="display: none;">$0.00</span>
                </div>
              </div>
            </div>


          </div>
        </div>
      `;

      container.appendChild(sectionDiv);

      // Reset du select natif au placeholder
      select.value = '';
      select.selectedIndex = 0;

      // Forcer la mise √† jour du custom dropdown
      const customSelect = select.previousElementSibling;
      if (customSelect && customSelect.classList.contains('custom-select')) {
        // Mettre √† jour le texte affich√©
        const textElement = customSelect.querySelector('.custom-select-text');
        if (textElement && select.options[0]) {
          textElement.textContent = select.options[0].textContent;
        }

        // Retirer 'selected' de toutes les options et l'ajouter seulement au placeholder
        const allOptions = customSelect.querySelectorAll('.custom-select-option');
        allOptions.forEach((opt, idx) => {
          if (idx === 0) {
            opt.classList.add('selected');
          } else {
            opt.classList.remove('selected');
          }
        });

        // Fermer le dropdown
        customSelect.classList.remove('open');
      }

      showNotification(`${surfaceText} ajout√©`, 'success');
    }

    function togglePrimerSelection(sectionId, primerType, event) {
      event.stopPropagation();
      const card = event.currentTarget;
      const isSelected = card.classList.contains('selected');

      if (isSelected) {
        // D√©s√©lectionner
        card.classList.remove('selected');
        card.style.backgroundColor = '';
        card.style.borderColor = '';

        // Reset les gallons et co√ªt
        const gallonsInput = document.getElementById(`gallons_${primerType}_${sectionId}`);
        const costSpan = document.getElementById(`cost_${primerType}_${sectionId}`);

        if (gallonsInput) gallonsInput.value = '0';
        if (costSpan) costSpan.textContent = '$0.00';
      } else {
        // D√©s√©lectionner tous les autres primers d'abord
        const primerCards = document.querySelectorAll(`#primerProducts_${sectionId} .product-card`);
        primerCards.forEach(otherCard => {
          otherCard.classList.remove('selected');
          otherCard.style.backgroundColor = '';
          otherCard.style.borderColor = '';
        });

        // Reset tous les gallons/co√ªts des autres primers
        const allGallonsInputs = document.querySelectorAll(`[id*="gallons_"][id*="${sectionId}"]`);
        const allCostSpans = document.querySelectorAll(`[id*="cost_"][id*="${sectionId}"]`);

        allGallonsInputs.forEach(input => input.value = '0');
        allCostSpans.forEach(span => span.textContent = '$0.00');

        // S√©lectionner le nouveau
        card.classList.add('selected');
        card.style.backgroundColor = 'rgba(59, 130, 246, 0.2)';
        card.style.borderColor = '#3b82f6';

        // Calculer les gallons automatiquement
        updatePrimerCalculation(sectionId, primerType);
      }

      // Recalcul global
      updateCalculation();
    }

    function updatePrimerCalculation(sectionId, primerType = null) {
      const params = getCurrentParameterValues();

      // R√©cup√©rer toutes les surfaces de cette section
      const inputs = document.querySelectorAll(`[data-primer="${sectionId}"]`);
      let totalSurface = 0;

      inputs.forEach(input => {
        const value = parseFloat(input.value) || 0;
        totalSurface += value;
      });

      // Mettre √† jour la surface totale
      const totalSurfaceElement = document.getElementById(`totalSurface_${sectionId}`);
      const surfaceType = inputs[0]?.getAttribute('data-surface-type');
      const unit = surfaceType?.includes('lineaire') ? 'ft' : 'ft¬≤';

      if (totalSurfaceElement) {
        totalSurfaceElement.textContent = `${totalSurface} ${unit}`;
      }

      // Calculer les heures selon le type de surface (AVANT la s√©lection primer)
      let productivity = 0;
      switch(surfaceType) {
        case 'surface_facile':
          productivity = params.primer_surface_facile || 110;
          break;
        case 'surface_difficile':
          productivity = params.primer_surface_difficile || 70;
          break;
        case 'lineaire_1er':
          productivity = params.primer_lineaire_1er || 25;
          break;
        case 'lineaire_2eme':
          productivity = params.primer_lineaire_2eme || 20;
          break;
      }

      const heuresRequises = totalSurface > 0 ? totalSurface / productivity : 0;

      // Mettre √† jour l'affichage des heures (m√™me sans primer s√©lectionn√©)
      document.getElementById(`heuresRequises_${sectionId}`).textContent = heuresRequises.toFixed(1) + 'h';

      // Trouver le primer s√©lectionn√© (card avec classe 'selected')
      const selectedCard = document.querySelector(`#primerProducts_${sectionId} .product-card.selected`);
      let selectedPrimerType = primerType;

      if (!selectedPrimerType && selectedCard) {
        // Extraire le type de primer du onclick
        const onclickAttr = selectedCard.getAttribute('onclick');
        const match = onclickAttr.match(/'([^']+)'/g);
        if (match && match[1]) {
          selectedPrimerType = match[1].replace(/'/g, '');
        }
      }

      if (!selectedPrimerType || totalSurface === 0) {
        // Pas de primer s√©lectionn√©, mais heures d√©j√† calcul√©es ci-dessus
        updateCalculation();
        return;
      }

      // Obtenir les param√®tres du primer s√©lectionn√©
      const primerPrice = parseFloat(document.getElementById(`param_${selectedPrimerType}_prix`)?.value) || 100;
      const primerCoverage = parseFloat(document.getElementById(`param_${selectedPrimerType}_couverture`)?.value) || 200;

      // Calculer les gallons requis
      // PRIMER = UNE SEULE COUCHE (pas de 2√®me couche)
      let gallonsRequis;
      if (surfaceType === 'surface_facile' || surfaceType === 'surface_difficile') {
        // FORMULE PRIMER SURFACE: Surface √∑ (Couverture √ó Ratio)
        const ratio = surfaceType === 'surface_facile' ? params.ratio_primer_surface_facile || 1 : params.ratio_primer_surface_difficile || 1;
        const premiereCouche = totalSurface / (primerCoverage * ratio);
        // Pas de deuxi√®me couche pour le primer
        gallonsRequis = Math.ceil(premiereCouche);
      } else {
        // FORMULE PRIMER LIN√âAIRE: Surface √∑ 300 (ratio fixe)
        const premiereCouche = totalSurface / 300;
        // Pas de deuxi√®me couche pour le primer
        gallonsRequis = Math.ceil(premiereCouche);
      }

      const coutTotal = gallonsRequis * primerPrice;

      // Mettre √† jour l'input gallons et co√ªt du primer s√©lectionn√©
      if (selectedPrimerType) {
        const gallonsInput = document.getElementById(`gallons_${selectedPrimerType}_${sectionId}`);
        const costSpan = document.getElementById(`cost_${selectedPrimerType}_${sectionId}`);

        if (gallonsInput) {
          gallonsInput.value = gallonsRequis.toString(); // Nombre entier sans d√©cimales
        }
        if (costSpan) {
          costSpan.textContent = '$' + coutTotal.toFixed(2);
        }
      }

      // D√©clencher le recalcul global
      updateCalculation();
    }

    function retirerPrimer(primerId) {
      const primer = document.getElementById(primerId);
      if (primer) {
        // Supprimer les produits associ√©s √† ce primer
        Object.keys(selectedProducts).forEach(productKey => {
          if (productKey.includes(`_${primerId}`) || productKey.endsWith(`_${primerId}`)) {
            delete selectedProducts[productKey];
          }
        });

        primer.remove();
        showNotification('Primer supprim√©', 'success');
        updateCalculation();
      }
    }

    function retirerLavage(lavageId) {
      const lavage = document.getElementById(lavageId);
      if (lavage) {
        // Supprimer les produits associ√©s √† ce lavage
        Object.keys(selectedProducts).forEach(productKey => {
          if (productKey.includes(`_${lavageId}`) || productKey.endsWith(`_${lavageId}`)) {
            delete selectedProducts[productKey];
          }
        });

        lavage.remove();
        showNotification('Lavage supprim√©', 'success');
        updateCalculation();
      }
    }

    function retirerPreparation(preparationId) {
      const preparation = document.getElementById(preparationId);
      if (preparation) {
        // Supprimer les produits associ√©s √† cette pr√©paration
        Object.keys(selectedProducts).forEach(productKey => {
          if (productKey.includes(`_${preparationId}`) || productKey.endsWith(`_${preparationId}`)) {
            delete selectedProducts[productKey];
          }
        });

        preparation.remove();
        showNotification('Pr√©paration supprim√©e', 'success');
        updateCalculation();
      }
    }

    function getOptionsForEndroitType(endroitType) {
      switch(endroitType) {
        case 'revetement':
          return `
            <option value="peinture_latte_4po">Peinture latte horizontale 4 pouces ‚Äì et t√¥le verticale (ft¬≤)</option>
            <option value="peinture_revetement_6po">Peinture rev√™tement horizontal 6 po. et plus (ft¬≤)</option>
            <option value="teindre_bardeau_neuf">Teindre bardeau de c√®dre neuf (ft¬≤)</option>
            <option value="teindre_bardeau_vieux">Teindre bardeau de c√®dre vieux (ft¬≤)</option>
            <option value="stucco_faible_relief">Stucco avec faible relief (ft¬≤)</option>
            <option value="stucco_fort_relief">Stucco avec fort relief (ft¬≤)</option>
            <option value="brique">Brique (ft¬≤)</option>
            <option value="solage_facile">Solage facile d'acc√®s (ft¬≤)</option>
            <option value="solage_difficile">Solage difficile d'acc√®s (ft¬≤)</option>
          `;
        case 'corniches':
          return `
            <option value="fascia_plate_1er">Fascia moulure plate ou 1er √©tage (ft)</option>
            <option value="fascia_complexe_2e">Fascia moulure complexe ou 2e √©tage (ft)</option>
            <option value="corniche_plate_1er">Corniche plate ‚Äì 1er √©tage (ft)</option>
            <option value="corniche_texturee_1er">Corniche textur√©e ou courb√©e ‚Äì 1er √©tage (ft)</option>
            <option value="corniche_complexe_1er">Corniche complexe ‚Äì 1er √©tage (ft)</option>
            <option value="corniche_plate_2e">Corniche plate ‚Äì 2e √©tage (ft)</option>
            <option value="corniche_texturee_2e">Corniche textur√©e ou courb√©e ‚Äì 2e √©tage (ft)</option>
            <option value="corniche_complexe_2e">Corniche complexe ‚Äì 2e √©tage (ft)</option>
          `;
        case 'fenetres':
          return `
            <option value="fenetre_sous_sol">Fen√™tre de sous-sol (qte)</option>
            <option value="fenetre_facile_cadre">Fen√™tre facile ‚Äì cadre seulement (qte)</option>
            <option value="fenetre_moyenne">Fen√™tre moyenne ‚Äì cadre + int√©rieur des fen√™tres (qte)</option>
            <option value="fenetre_difficile">Fen√™tre difficile (qte)</option>
            <option value="fenetre_3_6_carreaux">Fen√™tre avec 3‚Äì6 carreaux (qte)</option>
            <option value="fenetre_carreaux_6plus">Fen√™tre √† carreaux (si plus de 6) (qte de carreaux)</option>
            <option value="volet_plat_simple">Volet plat ‚Äì tr√®s simple (qte)</option>
            <option value="volet_avec_motifs">Volet avec motifs ‚Äì plus complexe (qte)</option>
            <option value="grande_fenetre_bay">Grande fen√™tre (style bay-window) ‚Äì cadre (qte)</option>
          `;
        case 'portes':
          return `
            <option value="porte_facile">Porte facile (qte)</option>
            <option value="porte_moyenne">Porte moyenne (qte)</option>
            <option value="porte_difficile">Porte difficile (qte)</option>
            <option value="porte_garage_simple">Porte de garage simple (qte)</option>
            <option value="porte_garage_difficile">Porte de garage difficile (qte)</option>
            <option value="moulure_cadre_porte_facile">Moulure du cadre de porte facile (qte)</option>
            <option value="moulure_cadre_porte_moyenne">Moulure du cadre de porte moyenne (qte)</option>
            <option value="moulure_cadre_porte_difficile">Moulure du cadre de porte difficile (qte)</option>
            <option value="moulure_porte_garage_facile">Moulure porte de garage facile (qte)</option>
            <option value="moulure_porte_garage_moyen">Moulure porte de garage moyen (qte)</option>
            <option value="moulure_porte_garage_difficile">Moulure porte de garage difficile (qte)</option>
            <option value="carreaux_portes_cadres">Carreaux de portes et de cadres de portes (si plus de 6 carreaux) (qte de carreaux)</option>
          `;
        case 'balcon':
          return `
            <option value="plancher_teinture_semi">Plancher teinture semi-transparente (pinceaux) (ft¬≤)</option>
            <option value="plancher_opaque_peinture">Plancher opaque ou peinture (rouleau + pinceaux) (ft¬≤)</option>
            <option value="mains_courantes">Mains courantes (ft)</option>
            <option value="marches_balcon">Marches (qte)</option>
            <option value="rampes_barreaux_simple">Rampes (barreau simple) (qte)</option>
            <option value="rampes_barreaux_modere">Rampes (barreau mod√©r√©) (qte)</option>
            <option value="rampes_barreaux_complexe">Rampes (barreau complexe) (qte)</option>
            <option value="piliers_simples">Piliers simples (qte)</option>
            <option value="piliers_complexes">Piliers complexes (qte)</option>
            <option value="treillis">Treillis (ft¬≤)</option>
            <option value="pergola">Pergola (qte de piliers)</option>
          `;
        case 'cloture':
          return `
            <option value="panneau_verticales_facile">Panneau planches verticales facile (1 c√¥t√©) (qte)</option>
            <option value="panneau_verticales_moyenne">Panneau planches verticales moyenne (1 c√¥t√©) (qte)</option>
            <option value="panneau_verticales_difficile">Panneau planches verticales difficile ou avec treillis (1 c√¥t√©) (qte)</option>
            <option value="treillis">Treillis (ft¬≤)</option>
          `;
        case 'fer_forge':
          return `
            <option value="rampe_complexe_tres_rouillee">Rampe complexe tr√®s rouill√©e ‚Äì 16,5 $/ft (qte)</option>
            <option value="rampe_complexe_moyennement_rouillee">Rampe complexe moyennement rouill√©e ‚Äì 13 $/ft (qte)</option>
            <option value="rampe_barreaux_droits_verticaux">Rampe barreaux droits verticaux rouille moyenne ‚Äì 11 $/ft (qte)</option>
            <option value="rampe_horizontale_moyenne_tres_rouillee">Rampe horizontale moyenne tr√®s rouill√©e ‚Äì 9 $/ft (qte)</option>
            <option value="rampe_horizontale_facile_moyennement_rouillee">Rampe horizontale facile moyennement rouill√©e ‚Äì 7 $/ft (qte)</option>
            <option value="marches_languettes_rouillees">Marches en languettes rouill√©es LIMONS inclus ‚Äì 31 $ ch (qte)</option>
            <option value="marches_languettes_tres_rouillees">Marches en languettes tr√®s rouill√©es (ou bois) LIMONS inclus ‚Äì 37,5 $ ch (qte)</option>
            <option value="dessous_balcon_4x8">Dessous balcon 4x8 avec poutres qui s'entrecroisent ‚Äì 200 $ ch (qte)</option>
            <option value="planchers_industriels">Planchers industriels ‚Äì 4 $/ft¬≤</option>
            <option value="marches_industrielles">Marches industrielles LIMONS 45 $ ch (checkered) (qte)</option>
            <option value="ornements">Ornements ‚Äì 200 $ ch (qte)</option>
            <option value="poteaux">Poteaux ‚Äì 25 $/poteau (qte)</option>
            <option value="fascia_sous_balcon">Fascia sous balcon ‚Äì 2,2 $/ft (qte)</option>
          `;
        case 'autre':
          return `
            <option value="treillis">Treillis (ft¬≤)</option>
            <option value="lucarne_facile">Lucarne facile d'acc√®s (qte)</option>
            <option value="lucarne_difficile">Lucarne difficile d'acc√®s (qte)</option>
            <option value="descente_gouttiere">D. Goutti√®re (ft)</option>
            <option value="autre_20min">Autre 20 min (qte)</option>
            <option value="autre_30min">Autre 30 min (qte)</option>
            <option value="autre_1h">Autre 1h (qte)</option>
          `;
        default:
          return '';
      }
    }

    function chargerProduitsExistants() {
      const container = document.getElementById('produits-container');
      if (!container) {
        log('DEBUG: Container produits-container non trouv√©, fonction chargerProduitsExistants ignor√©e');
        return;
      }
      container.innerHTML = ''; // Vider le container
      
      // R√©cup√©rer les produits du tableau
      const tbody = document.getElementById('products-table-body');
      if (!tbody) return;
      
      const rows = tbody.querySelectorAll('tr');
      rows.forEach((row, index) => {
        const typeInput = row.querySelector('[data-field="type"]');
        const ratioInput = row.querySelector('[data-field="ratio"]');
        const prixInput = row.querySelector('[data-field="prix"]');
        
        if (typeInput && typeInput.value.trim()) {
          const produitId = `produit_existant_${index}`;
          const produitDiv = document.createElement('div');
          produitDiv.className = 'pt-4 first:pt-0 border-b border-gray-200 pb-4';
          produitDiv.id = produitId;
          
          const type = typeInput.value;
          const ratio = ratioInput ? ratioInput.value : '200';
          const prix = prixInput ? prixInput.value : '0';
          
          produitDiv.innerHTML = `
            <div class="mb-2">
              <h5 class="font-medium text-gray-300">
                <i class="fas fa-paint-roller mr-2"></i>
                ${type}
              </h5>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- Prix du gallon (lecture seule, vient des param√®tres) -->
              <div class="md:col-span-1">
                <label class="block text-sm font-medium text-gray-300 mb-1">Prix ($/gallon)</label>
                <div class="input-field bg-gray-50 cursor-not-allowed" title="Prix configur√© dans les param√®tres">
                  $${prix}
                </div>
                <input type="hidden" id="${produitId}-prix" value="${prix}">
              </div>
              
              <!-- Couverture (lecture seule, vient des param√®tres) -->
              <div class="md:col-span-1">
                <label class="block text-sm font-medium text-gray-300 mb-1">Couverture (ft¬≤/gal)</label>
                <div class="input-field bg-gray-50 cursor-not-allowed" title="Couverture configur√©e dans les param√®tres">
                  ${ratio} ft¬≤/gal
                </div>
                <input type="hidden" id="${produitId}-couverture" value="${ratio}">
              </div>
              
              <!-- Bouton appliquer -->
              <div class="md:col-span-1">
                <label class="block text-sm font-medium text-gray-300 mb-1">Actions</label>
                <button class="btn-primary text-sm mx-auto" style="margin-top: 5px; width: 60%; height: 50%;" onclick="choisirSectionsPourProduit('${produitId}')" title="Appliquer aux sections">
                  <i class="fas fa-plus mr-2"></i> Appliquer
                </button>
                <!-- Gallons appliqu√©s (cach√© par d√©faut) -->
                <div id="${produitId}-gallons-container" class="mt-2 hidden text-center">
                  <span id="${produitId}-gallons" class="text-sm font-semibold text-green-600"></span>
                </div>
              </div>
            </div>
            
            
            <!-- Sections appliqu√©es -->
            <div id="${produitId}-sections" class="mt-3 hidden">
              <div class="text-sm text-white">
                <strong>Appliqu√© aux sections:</strong>
                <span id="${produitId}-sections-list"></span>
              </div>
            </div>
          `;
          
          container.appendChild(produitDiv);
        }
      });
      
      if (container.children.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">Aucun produit configur√© dans l\'onglet Produits</div>';
      }
    }

    function syncProductChanges() {
      // Recharger la section produits dans l'estimation pour refl√©ter les changements
      chargerProduitsExistants();
      
      // Mettre √† jour toutes les sections produit appliqu√©es
      syncAllAppliedProductSections();
      
      // Mettre √† jour l'affichage des prix dans les sections ext√©rieures
      updateProductPriceDisplays();
      
      // Sauvegarder les modifications
      saveProductsToStorage();
      
      // Recalculer tout
      updateCalculation();
    }

    function toggleProductSelection(sectionId, productKey, isPrimer = false, event = null) {
      // Si on a un √©v√©nement, utiliser la card cliqu√©e directement
      let productCard = null;
      if (event && event.target) {
        productCard = event.target.closest('.surface-card');
      }
      
      if (productCard) {
        // Travailler directement avec la product card
        const isSelected = productCard.classList.contains('selected');
        
        if (isSelected) {
          productCard.style.border = '';
          productCard.style.borderColor = '';
          productCard.classList.remove('selected');
        } else {
          productCard.style.border = '2px solid var(--primary-blue)';
          productCard.style.borderColor = 'var(--primary-blue)';
          productCard.classList.add('selected');
        }
        
        // Cr√©er une checkbox cach√©e pour les calculs si n√©cessaire
        const checkboxId = isPrimer ? `product_primer_${sectionId}` : `product_${productKey}_${sectionId}`;
        let checkbox = document.getElementById(checkboxId);
        if (!checkbox) {
          checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = checkboxId;
          checkbox.style.display = 'none';
          productCard.appendChild(checkbox);
        }
        checkbox.checked = !isSelected;
        
        // D√©clencher les calculs appropri√©s
        if (isPrimer) {
          updateSectionPrimerCalculation(sectionId);
        } else {
          updateSectionProductCalculation(sectionId);
        }
        updateCalculation();
        
      } else {
        // Fallback √† l'ancienne m√©thode si pas de card trouv√©e
        const checkboxId = isPrimer ? `product_primer_${sectionId}` : `product_${productKey}_${sectionId}`;
        const checkbox = document.getElementById(checkboxId);
      
      if (checkbox) {
        // Inverser l'√©tat de la checkbox
        checkbox.checked = !checkbox.checked;
        
        // Forcer le style du contour selon l'√©tat - pour la checkbox
        if (checkbox.checked) {
          checkbox.style.border = '2px solid #000000';
          checkbox.style.borderColor = '#000000';
        } else {
          checkbox.style.border = '2px solid #d1d5db';
          checkbox.style.borderColor = '#d1d5db';
        }
        
        // Forcer le style du contour de toute la carte produit
        const productCard = checkbox.closest('.surface-card');
        if (productCard) {
          if (checkbox.checked) {
            productCard.style.border = '2px solid var(--primary-blue)';
            productCard.style.borderColor = 'var(--primary-blue)';
            productCard.classList.add('selected');
          } else {
            productCard.style.border = '';
            productCard.style.borderColor = '';
            productCard.classList.remove('selected');
          }
        }
        
        // D√©clencher les calculs appropri√©s
        if (isPrimer) {
          updateSectionPrimerCalculation(sectionId);
        } else {
          updateSectionProductCalculation(sectionId);
        }
        updateCalculation();
        
        }
      }
    }

    function updateProductPriceDisplays() {
      log('DEBUG: Mise √† jour de l\'affichage des prix dans les sections');
      
      // Trouver toutes les sections ext√©rieures
      const allSections = document.querySelectorAll('[id^="endroit_"][id*="_"][id*="_"]');
      
      allSections.forEach(section => {
        const sectionId = section.id;
        log('DEBUG: Mise √† jour prix pour section:', sectionId);
        
        // Mapping des produits avec leurs √©l√©ments d'affichage
        const productMap = [
          { key: 'dulux_huile_st', name: 'Dulux huile ST' },
          { key: 'dulux_hybride_opq', name: 'Dulux Hybride OPQ' },
          { key: 'dulux_email_planchers', name: 'Dulux √©mail √† planchers' },
          { key: 'sikkens_st', name: 'Sikkens ST' },
          { key: 'diamant', name: 'Diamant' },
          { key: 'produit_client', name: 'Produit client' }
        ];
        
        // Mettre √† jour l'affichage du prix pour chaque produit
        productMap.forEach(product => {
          const productParams = getProductParametersFromTable(product.name);
          
          // Trouver l'√©l√©ment d'affichage du prix dans cette section
          const priceSpan = section.querySelector(`#product_${product.key}_${sectionId}`)?.parentElement?.parentElement?.querySelector('.font-semibold.text-white');
          
          if (priceSpan) {
            priceSpan.textContent = `$${productParams.cost}/gal`;
            log(`DEBUG: Prix ${product.name} mis √† jour: $${productParams.cost}/gal`);
          }
        });
        
        // Mettre √† jour aussi le primer
        const primerParams = getProductParametersFromTable('Dulux Gripper');
        const primerPriceSpan = section.querySelector(`#product_primer_${sectionId}`)?.parentElement?.parentElement?.querySelector('.font-semibold.text-white');
        if (primerPriceSpan) {
          primerPriceSpan.textContent = `$${primerParams.cost}/gal`;
          log(`DEBUG: Prix Dulux Gripper mis √† jour: $${primerParams.cost}/gal`);
        }
      });
    }

    function syncAllAppliedProductSections() {
      // Parcourir toutes les sections produit dans "Endroit √† peinturer"
      const productSections = document.querySelectorAll('.product-gallons-input');
      
      productSections.forEach(input => {
        const productName = input.getAttribute('data-product-name');
        if (productName) {
          // Trouver le produit correspondant dans le tableau
          const tbody = document.getElementById('products-table-body');
          const rows = tbody.querySelectorAll('tr');
          
          for (const row of rows) {
            const typeInput = row.querySelector('[data-field="type"]');
            const ratioInput = row.querySelector('[data-field="ratio"]');
            const prixInput = row.querySelector('[data-field="prix"]');
            
            if (typeInput && typeInput.value === productName) {
              // Mettre √† jour le prix par gallon
              const newPrice = parseFloat(prixInput.value) || 0;
              input.setAttribute('data-price-per-gallon', newPrice);
              
              // Mettre √† jour l'affichage du prix par gallon
              const priceDisplay = input.closest('.bg-gray-50').querySelector('.px-3.py-2.bg-gray-100');
              if (priceDisplay && priceDisplay.textContent.includes('$')) {
                priceDisplay.textContent = `${newPrice.toFixed(2)}$`;
              }
              
              // Recalculer le co√ªt total pour cette section
              updateProductCost(input);
              break;
            }
          }
        }
      });
    }

    function choisirSectionsPourProduit(produitId) {
      const sections = getAllCreatedSections();
      
      // Debug plus d√©taill√©
      log('Nombre de sections trouv√©es:', sections.length);
      log('Endroits dans le DOM:', document.querySelectorAll('[id^="endroit_"]').length);
      
      if (sections.length === 0) {
        // Essayer une m√©thode alternative pour trouver les sections
        const allEndroits = document.querySelectorAll('[id^="endroit_"]');
        log('Tous les endroits trouv√©s:', allEndroits);
        
        showNotification('Aucune section cr√©√©e. Cr√©ez d\'abord des sections dans "Endroit √† peinturer".', 'warning');
        return;
      }
      
      // Pour les produits existants, r√©cup√©rer le nom depuis le titre
      let produitNom;
      const titleElement = document.querySelector(`#${produitId} h5`);
      if (titleElement) {
        produitNom = titleElement.textContent.replace(/\s*\u{f1b2}\s*/u, '').trim(); // Enlever l'ic√¥ne
      } else {
        produitNom = `Produit #${produitId.split('_')[2] || '1'}`;
      }
      
      const couverture = parseFloat(document.getElementById(`${produitId}-couverture`).value) || 200;
      
      // R√©cup√©rer le prix du produit depuis le DOM
      const prixElement = document.getElementById(`${produitId}-prix`);
      const prix = prixElement ? parseFloat(prixElement.value) || 0 : 0;
      
      log('Sections pour la modal:', sections);
      log('Donn√©es de chaque section:', sections.map(s => ({id: s.id, title: s.sectionTitle, surface: s.totalSurface})));
      
      // Debug d√©taill√© de chaque section
      sections.forEach((section, index) => {
        log(`Section ${index}:`, {
          id: section.id,
          sectionTitle: section.sectionTitle,
          totalSurface: section.totalSurface,
          endroitTitle: section.endroitTitle
        });
      });
      
      // Cr√©er la modal de s√©lection
      const modal = document.createElement('div');
      modal.id = 'section-selector-modal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      
      let sectionsHTML = '';
      if (sections.length === 0) {
        sectionsHTML = '<div class="text-center py-4 text-gray-500">Aucune section trouv√©e</div>';
      } else {
        sectionsHTML = sections.map(section => {
          const sectionHTML = `
          <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-slate-700/50 cursor-pointer">
            <input type="checkbox" class="section-checkbox" value="${section.id}">
            <div class="flex-1">
              <div class="font-medium">${section.sectionTitle || 'Titre manquant'}</div>
              <div class="text-sm text-gray-500">${(section.totalSurface || 0).toFixed(1)} ft¬≤</div>
            </div>
            <div class="text-sm text-blue-600 font-medium">
              ${Math.max(2, Math.ceil(((section.totalSurface || 0) / couverture) * 2 - 1))} gal
            </div>
          </label>
          `;
          log('HTML g√©n√©r√© pour section:', sectionHTML);
          return sectionHTML;
        }).join('');
      }
      
      log('HTML final des sections:', sectionsHTML);
      
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
          <h3 class="text-lg font-semibold mb-4">
            <i class="fas fa-paint-roller mr-2"></i>
            Appliquer "${produitNom}" aux sections
          </h3>
          <div class="text-sm text-white mb-4">
            Couverture: ${couverture} ft¬≤/gallon
          </div>
          
          <div class="space-y-3 max-h-64 overflow-y-auto">
            ${sectionsHTML}
          </div>
          
          <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
            <button class="btn-secondary" onclick="this.closest('.fixed').remove()">
              Annuler
            </button>
            <button class="btn-primary" onclick="appliquerSectionsAuProduit('${produitId}', '${produitNom}', ${couverture}, ${prix})">
              <i class="fas fa-check"></i> Appliquer
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Debug pour v√©rifier que la modal est bien ins√©r√©e
      log('Modal ajout√©e au DOM');
      const modalInDOM = document.getElementById('section-selector-modal');
      log('Modal trouv√©e dans DOM:', modalInDOM);
      const checkboxesInDOM = modalInDOM ? modalInDOM.querySelectorAll('.section-checkbox') : [];
      log('Checkboxes dans DOM apr√®s insertion:', checkboxesInDOM.length);
    }

    function appliquerSectionsAuProduit(produitId, productName, couverture, productPrice) {
      const modal = document.getElementById('section-selector-modal');
      const allCheckboxes = modal.querySelectorAll('.section-checkbox');
      const checkedSections = modal.querySelectorAll('.section-checkbox:checked');
      
      log('Total checkboxes trouv√©es:', allCheckboxes.length);
      log('Checkboxes coch√©es:', checkedSections.length);
      log('IDs des checkboxes coch√©es:', Array.from(checkedSections).map(cb => cb.value));
      
      if (checkedSections.length === 0) {
        showNotification('Veuillez s√©lectionner au moins une section.', 'warning');
        return;
      }
      
      const sections = getAllCreatedSections();
      
      // Ajouter chaque section s√©lectionn√©e comme un produit s√©par√©
      checkedSections.forEach(checkbox => {
        const sectionId = checkbox.value;
        const section = sections.find(s => s.id === sectionId);
        if (section) {
          // Calcul premi√®re couche
          const firstCoatGallons = section.totalSurface / couverture;
          // Calcul deuxi√®me couche avec facteur 0.7
          const params = getCurrentParameterValues();
          const secondCoatGallons = firstCoatGallons * (params.facteur_deuxieme_couche || 0.7);
          const gallonsSection = Math.ceil(firstCoatGallons + secondCoatGallons);
          // Cr√©er un ID unique pour chaque application de produit
          const applicationId = `${sectionId}_${Date.now()}`;
          // Cr√©er le nom de section pour affichage
          const sectionDisplayName = section.endroitTitle && section.sectionTitle 
            ? `${section.endroitTitle} - ${section.sectionTitle}`
            : section.sectionTitle || section.endroitTitle || 'Section';
          addProductToSection(applicationId, productName, gallonsSection, productPrice, sectionDisplayName);
        }
      });
      
      // Ne plus afficher les gallons appliqu√©s (gard√©s cach√©s)
      const gallonsContainer = document.getElementById(`${produitId}-gallons-container`);
      if (gallonsContainer) {
        gallonsContainer.classList.add('hidden');
      }
      
      
      // Cacher les sections d√©taill√©es (garder les options visibles)
      const sectionsContainer = document.getElementById(`${produitId}-sections`);
      if (sectionsContainer) {
        sectionsContainer.classList.add('hidden');
      }
      
      // Fermer la modal
      modal.remove();
      
      const totalGallons = Array.from(checkedSections).reduce((total, checkbox) => {
        const sectionId = checkbox.value;
        const section = sections.find(s => s.id === sectionId);
        if (section) {
          total += Math.max(2, Math.ceil((section.totalSurface / couverture) * 2 - 1));
        }
        return total;
      }, 0);
      
      showNotification(`Produit "${productName}" appliqu√© sur ${checkedSections.length} section(s) avec ${totalGallons} gallons au total`, 'success');
      
      // Recalculer
      updateCalculation();
    }

    function ajouterSousSection(endroitId, endroitType) {
      const select = document.getElementById(`${endroitId}-type-select`);
      const typeSpecifique = select.value;
      const typeText = select.options[select.selectedIndex].text;
      
      if (!typeSpecifique) {
        showNotification('Veuillez s√©lectionner un type sp√©cifique', 'warning');
        return;
      }
      
      const container = document.getElementById(`${endroitId}-container`);
      
      // D√©terminer l'unit√© selon le type sp√©cifique
      let unite = 'ft¬≤';
      const typesQuantite = ['fenetre_sous_sol', 'fenetre_facile_cadre', 'fenetre_moyenne', 'fenetre_difficile', 
                            'fenetre_3_6_carreaux', 'fenetre_carreaux_6plus', 'volet_plat_simple', 'volet_avec_motifs', 
                            'grande_fenetre_bay', 'lucarnes', 'porte_facile', 'porte_moyenne', 'porte_difficile', 
                            'porte_garage_simple', 'porte_garage_difficile', 'moulure_cadre_porte_facile', 
                            'moulure_cadre_porte_moyenne', 'moulure_cadre_porte_difficile', 'moulure_porte_garage_facile', 
                            'moulure_porte_garage_moyen', 'moulure_porte_garage_difficile', 'carreaux_portes_cadres', 
                            'barreaux', 'piliers', 'moulure_cadre_facile', 'moulure_cadre_moyenne', 'marches', 
                            'marches_balcon', 'rampes_barreaux_simple', 'rampes_barreaux_modere', 'rampes_barreaux_complexe',
                            'rampes_barreau_simple', 'rampes_barreau_modere', 'rampes_barreau_complexe', 'piliers_simples', 
                            'piliers_complexes', 'pergola', 'panneau_verticales_facile', 'panneau_verticales_moyenne', 
                            'panneau_verticales_difficile', 'lucarne_facile', 'lucarne_difficile', 'autre_20min', 
                            'autre_30min', 'autre_1h', 'rampe_complexe_tres_rouillee', 'rampe_complexe_moyennement_rouillee',
                            'rampe_barreaux_droits_verticaux', 'rampe_horizontale_moyenne_tres_rouillee', 
                            'rampe_horizontale_facile_moyennement_rouillee', 'marches_languettes_rouillees', 
                            'marches_languettes_tres_rouillees', 'dessous_balcon_4x8', 'planchers_industriels_marches',
                            'ornements', 'poteaux', 'fascia_sous_balcon'];
      const typesFt = ['fascia_moulure_plate', 'fascia_moulure_complexe', 'corniche_plate_1er', 'corniche_texturee_1er', 
                       'corniche_complexe_1er', 'corniche_plate_2e', 'corniche_texturee_2e', 'corniche_complexe_2e', 
                       'moulures_decoupees', 'descente_gouttiere', 'mains_courantes'];
      
      if (typesQuantite.includes(typeSpecifique)) {
        unite = 'quantit√©';
      } else if (typesFt.includes(typeSpecifique)) {
        unite = 'ft';
      }
      
      // Cr√©er un ID unique pour cette sous-section
      const sousSectionId = `${endroitId}_${typeSpecifique}_${Date.now()}`;
      
      const sousSectionDiv = document.createElement('div');
      sousSectionDiv.className = 'border-l-4 border-red-300 pl-4 pt-3 first:pt-0';
      sousSectionDiv.id = sousSectionId;
      
      // V√©rifier si c'est un travail additionnel (temps seulement)
      const travailAdditionnel = ['autre_20min', 'autre_30min', 'autre_1h'];
      
      if (travailAdditionnel.includes(typeSpecifique)) {
        // Input simple pour travail additionnel (pas de sections)
        sousSectionDiv.innerHTML = `
          <div class="mb-2 flex justify-between items-center">
            <h6 class="font-medium text-white">${typeText}</h6>
            <button class="btn-secondary text-xs px-2 py-1" onclick="retirerSousSection('${sousSectionId}')" title="Supprimer ce type">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Nombre de fois</label>
              <input type="number" class="input-field" data-${endroitType}="${endroitId}" data-type="${typeSpecifique}" placeholder="0" oninput="updateCalculation()">
              <div class="text-xs text-gray-500 mt-1">Combien de fois ce travail additionnel</div>
            </div>
          </div>
        `;
      } else {
        // Grille normale avec sections pour les autres types
        sousSectionDiv.innerHTML = `
          <div class="mb-2 flex justify-between items-center">
            <h6 class="font-medium text-white">${typeText}</h6>
            <button class="btn-secondary text-xs px-2 py-1" onclick="retirerSousSection('${sousSectionId}')" title="Supprimer ce type">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Avant (${unite})</label>
              <input type="number" class="input-field" data-${endroitType}="${endroitId}" data-type="${typeSpecifique}" data-section="avant" placeholder="0" oninput="updateSectionProductCalculation('${sousSectionId}'); updateCalculation();">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Droit (${unite})</label>
              <input type="number" class="input-field" data-${endroitType}="${endroitId}" data-type="${typeSpecifique}" data-section="droit" placeholder="0" oninput="updateSectionProductCalculation('${sousSectionId}'); updateCalculation();">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Arri√®re (${unite})</label>
              <input type="number" class="input-field" data-${endroitType}="${endroitId}" data-type="${typeSpecifique}" data-section="arriere" placeholder="0" oninput="updateSectionProductCalculation('${sousSectionId}'); updateCalculation();">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Gauche (${unite})</label>
              <input type="number" class="input-field" data-${endroitType}="${endroitId}" data-type="${typeSpecifique}" data-section="gauche" placeholder="0" oninput="updateSectionProductCalculation('${sousSectionId}'); updateCalculation();">
            </div>
          </div>
          ${endroitType !== 'fer_forge' ? generateExteriorProductsSection(sousSectionId) : ''}
        `;
      }
      
      container.appendChild(sousSectionDiv);

      // Reset du select natif au placeholder
      select.value = '';
      select.selectedIndex = 0;

      // Forcer la mise √† jour du custom dropdown
      const customSelect = select.previousElementSibling;
      if (customSelect && customSelect.classList.contains('custom-select')) {
        // Mettre √† jour le texte affich√©
        const textElement = customSelect.querySelector('.custom-select-text');
        if (textElement && select.options[0]) {
          textElement.textContent = select.options[0].textContent;
        }

        // Retirer 'selected' de toutes les options et l'ajouter seulement au placeholder
        const allOptions = customSelect.querySelectorAll('.custom-select-option');
        allOptions.forEach((opt, idx) => {
          if (idx === 0) {
            opt.classList.add('selected');
          } else {
            opt.classList.remove('selected');
          }
        });

        // Fermer le dropdown
        customSelect.classList.remove('open');
      }

      showNotification(`${typeText} ajout√©`, 'success');
      updateCalculation();
    }

    function retirerSousSection(sousSectionId) {
      const sousSection = document.getElementById(sousSectionId);
      if (sousSection) {
        // Supprimer les produits associ√©s √† cette sous-section
        Object.keys(selectedProducts).forEach(productKey => {
          if (productKey.includes(`_${sousSectionId}`) || productKey.endsWith(`_${sousSectionId}`)) {
            delete selectedProducts[productKey];
          }
        });

        sousSection.remove();
        showNotification('Type supprim√©', 'success');
        updateCalculation();
      }
    }

    function getOptionsSpecifiques(type, endroitId) {
      switch(type) {
        case 'revetement':
          return `
            <h5 class="font-medium text-gray-300 mb-3">Options sp√©cifiques - Rev√™tement</h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-white mb-1">Type de rev√™tement</label>
                <select class="input-field" id="${endroitId}_type_revetement" data-endroit="${endroitId}" data-option="type_revetement">
                  <option value="latte_4">Latte horizontale 4"</option>
                  <option value="revetement_6">Rev√™tement horizontal 6"+</option>
                  <option value="bardeau_neuf">Bardeau c√®dre neuf</option>
                  <option value="bardeau_vieux">Bardeau c√®dre vieux</option>
                  <option value="stucco_faible">Stucco faible relief</option>
                  <option value="stucco_fort">Stucco fort relief</option>
                  <option value="brique">Brique</option>
                </select>
              </div>
            </div>
          `;
        case 'corniches':
          return `
            <h5 class="font-medium text-gray-300 mb-3">Options sp√©cifiques - Corniche et moulure</h5>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm text-white mb-1">Corniches plates (ft lin.)</label>
                <input type="number" class="input-field" id="${endroitId}_corniches_plates" data-endroit="${endroitId}" data-type="lineaire" data-option="corniches_plates" placeholder="0">
              </div>
              <div>
                <label class="block text-sm text-white mb-1">Moulures d√©coup√©es (ft lin.)</label>
                <input type="number" class="input-field" id="${endroitId}_moulures_decoupees" data-endroit="${endroitId}" data-type="lineaire" data-option="moulures_decoupees" placeholder="0">
              </div>
              <div>
                <label class="block text-sm text-white mb-1">Cadres faciles (qt√©)</label>
                <input type="number" class="input-field" id="${endroitId}_cadres_faciles" data-endroit="${endroitId}" data-type="unite" data-option="cadres_faciles" placeholder="0">
              </div>
            </div>
          `;
        case 'fenetres':
          return `
            <h5 class="font-medium text-gray-300 mb-3">Options sp√©cifiques - Fen√™tre et volet</h5>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm text-white mb-1">Fen√™tres faciles (qt√©)</label>
                <input type="number" class="input-field" id="${endroitId}_fenetres_faciles" data-endroit="${endroitId}" data-type="unite" data-option="fenetres_faciles" placeholder="0">
              </div>
              <div>
                <label class="block text-sm text-white mb-1">Fen√™tres moyennes (qt√©)</label>
                <input type="number" class="input-field" id="${endroitId}_fenetres_moyennes" data-endroit="${endroitId}" data-type="unite" data-option="fenetres_moyennes" placeholder="0">
              </div>
              <div>
                <label class="block text-sm text-white mb-1">Volets simples (qt√©)</label>
                <input type="number" class="input-field" id="${endroitId}_volets_simples" data-endroit="${endroitId}" data-type="unite" data-option="volets_simples" placeholder="0">
              </div>
              <div>
                <label class="block text-sm text-white mb-1">Volets avec motifs (qt√©)</label>
                <input type="number" class="input-field" id="${endroitId}_volets_motifs" data-endroit="${endroitId}" data-type="unite" data-option="volets_motifs" placeholder="0">
              </div>
            </div>
          `;
        case 'portes':
          return `
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Portes et cadres de portes</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte facile (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_portes_faciles" data-endroit="${endroitId}" data-type="unite" data-option="portes_faciles" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">0.33 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte moyenne (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_portes_moyennes" data-endroit="${endroitId}" data-type="unite" data-option="portes_moyennes" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">0.66 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte difficile (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_porte_difficile" data-endroit="${endroitId}" data-type="unite" data-option="porte_difficile" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">1.25 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte de garage simple (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_porte_garage_simple" data-endroit="${endroitId}" data-type="unite" data-option="porte_garage_simple" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">1.50 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Porte de garage difficile (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_porte_garage_difficile" data-endroit="${endroitId}" data-type="unite" data-option="porte_garage_difficile" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">2.50 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">moulure du cadre de porte facile (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_moulure_cadre_porte_facile" data-endroit="${endroitId}" data-type="unite" data-option="moulure_cadre_porte_facile" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">0.25 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">moulure du cadre de porte moyenne (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_moulure_cadre_porte_moyenne" data-endroit="${endroitId}" data-type="unite" data-option="moulure_cadre_porte_moyenne" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">0.50 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">moulure du cadre de porte difficile (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_moulure_cadre_porte_difficile" data-endroit="${endroitId}" data-type="unite" data-option="moulure_cadre_porte_difficile" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">1.00 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">moulure porte de garage facile (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_moulure_porte_garage_facile" data-endroit="${endroitId}" data-type="unite" data-option="moulure_porte_garage_facile" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">0.66 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">moulure porte de garage moyen (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_moulure_porte_garage_moyen" data-endroit="${endroitId}" data-type="unite" data-option="moulure_porte_garage_moyen" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">1.00 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">moulure porte de garage difficile (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_moulure_porte_garage_difficile" data-endroit="${endroitId}" data-type="unite" data-option="moulure_porte_garage_difficile" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">1.50 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Carreaux de portes et de cadres de portes (si plus de 6 carreaux) (qte de carreaux)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_carreaux_portes_cadres" data-endroit="${endroitId}" data-type="unite" data-option="carreaux_portes_cadres" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">0.17 h</td>
              </tr>
            </table>
          `;
        case 'balcon':
          return `
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Balcon</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Plancher teinture semi-transparente (Pinceaux) (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_plancher_teinture_semi" data-endroit="${endroitId}" data-type="surface" data-option="plancher_teinture_semi" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">75.00 ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Plancher opaque ou peinture(Rouleau+pinceaux) (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_plancher_opaque" data-endroit="${endroitId}" data-type="surface" data-option="plancher_opaque_peinture" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">100.00 ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Mains courantes (ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_mains_courantes" data-endroit="${endroitId}" data-type="lineaire" data-option="mains_courantes" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">50 ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Marches (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_marches" data-endroit="${endroitId}" data-type="unite" data-option="marches_balcon" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">4.00 4/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Rampes (barreau simple) (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_rampes_simple" data-endroit="${endroitId}" data-type="unite" data-option="rampes_barreaux_simple" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">16.00 16/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Rampes (barreau mod√©r√©) (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_rampes_modere" data-endroit="${endroitId}" data-type="unite" data-option="rampes_barreaux_modere" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">12.00 12/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Rampes (barreau complexe) (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_rampes_complexe" data-endroit="${endroitId}" data-type="unite" data-option="rampes_barreaux_complexe" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">8.00 8/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Pilliers simples (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_piliers_simples" data-endroit="${endroitId}" data-type="unite" data-option="piliers_simples" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">3.00 3/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Pilliers complexes (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_piliers_complexes" data-endroit="${endroitId}" data-type="unite" data-option="piliers_complexes" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">1.50 1.5/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Treillis (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_treillis" data-endroit="${endroitId}" data-type="surface" data-option="treillis" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">40.00 ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Pergola (qte de piliers)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_pergola" data-endroit="${endroitId}" data-type="unite" data-option="pergola" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">2.00 qte/h</td>
              </tr>
            </table>
          `;
        case 'cloture':
          return `
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Cl√¥ture</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Panneau planches verticales facile (1 c√¥t√©) (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_panneau_facile" data-endroit="${endroitId}" data-type="unite" data-option="panneau_verticales_facile" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">0.50 h/panneau</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Panneau planches verticales moyenne(1 c√¥t√©) (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_panneau_moyenne" data-endroit="${endroitId}" data-type="unite" data-option="panneau_verticales_moyenne" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">1.25 h/panneau</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Panneau planches verticales difficile ou avec treillis (1 c√¥t√©) (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_panneau_difficile" data-endroit="${endroitId}" data-type="unite" data-option="panneau_verticales_difficile" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">2.00 h/panneau</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Treillis (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_treillis_cloture" data-endroit="${endroitId}" data-type="surface" data-option="treillis" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">40.00 ft¬≤/h</td>
              </tr>
            </table>
          `;
        case 'fer_forge':
          return `
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Fer Forg√© pr√©p. incluse</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">rampe complexe tr√®s rouill√©e 16.5$/ft (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_rampe_complexe_tres_rouillee" data-endroit="${endroitId}" data-type="unite" data-option="rampe_complexe_tres_rouillee" data-fer_forge="rampe_complexe_tres_rouillee" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters(); updateProductDetails();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">17.33 $/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">rampe complexe moyennement rouill√©e 13$/ft (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_rampe_complexe_moyennement_rouillee" data-endroit="${endroitId}" data-type="unite" data-option="rampe_complexe_moyennement_rouillee" data-fer_forge="rampe_complexe_moyennement_rouillee" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters(); updateProductDetails();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">13.65 $/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">rampe barreaux droits verticaux rouille moyenne 11$/ft (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_rampe_barreaux_droits_verticaux" data-endroit="${endroitId}" data-type="unite" data-option="rampe_barreaux_droits_verticaux" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">11.55 $/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">rampe horizontale moyenne - tr√®s rouill√©e 9$/ft (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_rampe_horizontale_moyenne_tres_rouillee" data-endroit="${endroitId}" data-type="unite" data-option="rampe_horizontale_moyenne_tres_rouillee" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">9.5 $/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">rampe horizontale facile - moyennement rouill√©e 7$/ft (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_rampe_horizontale_facile_moyennement_rouillee" data-endroit="${endroitId}" data-type="unite" data-option="rampe_horizontale_facile_moyennement_rouillee" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">7.35 $/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Marches en languettes rouill√©es LIMONS INCLUS 31$ch (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_marches_languettes_rouillees" data-endroit="${endroitId}" data-type="unite" data-option="marches_languettes_rouillees" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">31 $/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Marches en languettes tr√®s rouill√©es (ou bois) LIMONS INCLUS37.5$ch (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_marches_languettes_tres_rouillees" data-endroit="${endroitId}" data-type="unite" data-option="marches_languettes_tres_rouillees" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">37.5 $/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Dessous balcon 4x8 avec poutres qui s'entrecroisent 200$ch (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_dessous_balcon_4x8" data-endroit="${endroitId}" data-type="unite" data-option="dessous_balcon_4x8" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">210 $/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Planchers industriels 4$/ft¬≤</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_planchers_industriels_marches" data-endroit="${endroitId}" data-type="surface" data-option="planchers_industriels_marches" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">4 $/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Marches industrielles LIMONS 45$ch (checkered) (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_marches_industrielles" data-endroit="${endroitId}" data-type="unite" data-option="marches_industrielles" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">45 $/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Ornements 200$ch (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_ornements" data-endroit="${endroitId}" data-type="unite" data-option="ornements" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">200 $/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Poteaux 25$/poteau (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_poteaux" data-endroit="${endroitId}" data-type="unite" data-option="poteaux" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">25 $/unit√©</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Fascia sous balcon 2.2/$/ft (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_fascia_sous_balcon" data-endroit="${endroitId}" data-type="unite" data-option="fascia_sous_balcon" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">2.5 $/unit√©</td>
              </tr>
            </table>
          `;
        case 'autre':
        default:
          return `
            <table style="width: 100%; border-collapse: collapse; color: var(--text-light);">
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 60%; font-weight: bold;">Autres</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 15%; text-align: center; font-weight: bold;">Ratio</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); width: 25%; text-align: center; font-weight: bold;">Unit√©s</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Treillis (ft¬≤)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_treillis" data-endroit="${endroitId}" data-type="surface" data-option="treillis" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">40.00 ft¬≤/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Lucarne facile d'acc√®s (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_lucarne_facile" data-endroit="${endroitId}" data-type="unite" data-option="lucarne_facile" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">2.00 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Lucarne difficile d'acc√®s (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_lucarne_difficile" data-endroit="${endroitId}" data-type="unite" data-option="lucarne_difficile" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">3.00 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">D. Goutti√®re (ft)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_descente_gouttiere" data-endroit="${endroitId}" data-type="lineaire" data-option="descente_gouttiere" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">20.00 ft/h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Autre 20 min (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_autre_20min" data-endroit="${endroitId}" data-type="unite" data-option="autre_20min" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">0.33 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Autre 30 min (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_autre_30min" data-endroit="${endroitId}" data-type="unite" data-option="autre_30min" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">0.50 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Autre 1h (qte)</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_autre_1h" data-endroit="${endroitId}" data-type="unite" data-option="autre_1h" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">1.00 h</td>
              </tr>
              <tr>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark);">Sablage surface</td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">
                  <input type="number" id="${endroitId}_sablage_surface" data-endroit="${endroitId}" data-type="surface" data-option="sablage_surface" value="0" step="0.01" onchange="updateCalculation(); autoSaveParameters();" style="width: 60px; background: var(--bg-card); border: 1px solid var(--border-dark); color: var(--text-light); padding: 2px;">
                </td>
                <td style="padding: 4px; border-bottom: 1px solid var(--border-dark); text-align: center;">65.00 ft¬≤/h</td>
              </tr>
            </table>
          `;
      }
    }

    // === FONCTIONS GESTION DES PROJETS ===
    
    
    
    function sauvegarderProjetActuel() {
      // Collecter toutes les donn√©es du projet actuel
      const clientPrenom = document.getElementById('clientPrenom')?.value || '';
      const clientNom = document.getElementById('clientNom')?.value || '';
      const clientName = `${clientPrenom} ${clientNom}`.trim();
      const clientAddress = document.getElementById('clientAddress')?.value || '';
      const clientPhone = document.getElementById('clientPhone')?.value || '';
      
      if (!clientName.trim()) {
        showNotification('Veuillez remplir le pr√©nom et nom du client avant de sauvegarder', 'warning');
        return;
      }
      
      // D√©clencher le calcul pour obtenir les totaux actuels
      updateCalculation();
      
      // R√©cup√©rer les totaux depuis les √©l√©ments d'affichage
      const totalExt = parseFloat(document.getElementById('totalFinalDisplay')?.textContent.replace(/[^0-9.-]/g, '') || '0');
      const totalInt = parseFloat(document.getElementById('totalInterieurDisplay')?.textContent.replace(/[^0-9.-]/g, '') || '0');
      
      const projet = {
        id: Date.now(), // ID unique bas√© sur timestamp
        client: clientName,
        adresse: clientAddress,
        telephone: clientPhone,
        dateCreation: (() => {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          return `${day}/${month}/${year}`;
        })(),
        totalExterieur: totalExt,
        totalInterieur: totalInt,
        // Sauvegarder tous les champs du formulaire
        formData: collecterToutesDonnees()
      };
      
      // R√©cup√©rer les projets existants
      let projets = JSON.parse(localStorage.getItem('projetsQwota') || '[]');
      
      // V√©rifier si le projet existe d√©j√† (m√™me client et adresse)
      const existingIndex = projets.findIndex(p => 
        p.client === clientName && p.adresse === clientAddress
      );
      
      if (existingIndex >= 0) {
        if (confirm('Un projet existe d√©j√† pour ce client √† cette adresse. Le remplacer?')) {
          projets[existingIndex] = projet;
        } else {
          return;
        }
      } else {
        projets.push(projet);
      }
      
      // Sauvegarder dans localStorage
      localStorage.setItem('projetsQwota', JSON.stringify(projets));
      
      showNotification('Projet sauvegard√© avec succ√®s!', 'success');
      
      // Actualiser la liste si on est sur l'onglet projets
      if (!document.getElementById('mes-projets-tab').classList.contains('hidden')) {
        afficherListeProjets();
      }
    }
    
    function collecterToutesDonnees() {
      const data = {};

      // Collecter tous les inputs
      document.querySelectorAll('input').forEach((input, index) => {
        if (input.id) {
          if (input.type === 'checkbox') {
            data[input.id] = input.checked;
          } else {
            data[input.id] = input.value;
          }
        } else if (input.value && input.value !== '' && input.value !== '0') {
          // Pour les inputs sans ID, cr√©er un ID unique bas√© sur les data-attributes
          const section = input.getAttribute('data-section');
          const type = input.getAttribute('data-type');

          if (section && type) {
            const uniqueKey = `dynamic_${section}_${type}_${index}`;
            data[uniqueKey] = {
              value: input.value,
              section: section,
              type: type,
              inputType: input.type
            };
          }
        }
      });

      // Collecter tous les selects
      document.querySelectorAll('select').forEach(select => {
        if (select.id) {
          data[select.id] = select.value;
        }
      });

      // Collecter les donn√©es sp√©ciales (surfaces, endroits, etc.)
      data.surfaces = collectSurfaceData();
      data.endroits = collectEndroitData();
      data.piecesInterieur = piecesInterieur;

      // Collecter les produits du tableau pour les sauvegarder avec le projet
      data.produitsTable = getAllProductsFromTable();
      log('üíæ Produits tableau sauvegard√©s:', data.produitsTable);

      // NOUVEAU: Collecter les sections de lavage cr√©√©es
      data.lavagesSections = [];
      const lavagesContainer = document.getElementById('lavages-container');
      if (lavagesContainer) {
        const lavageSections = lavagesContainer.querySelectorAll('[id^="lavage_"]');
        lavageSections.forEach(section => {
          // Trouver le type de lavage depuis le premier input
          const firstInput = section.querySelector('input[data-type]');
          if (firstInput) {
            const lavageType = firstInput.getAttribute('data-type');
            const title = section.querySelector('h5')?.textContent || '';

            // Collecter les valeurs des 4 c√¥t√©s
            const inputs = section.querySelectorAll('input[data-section]');
            const valeurs = {};
            inputs.forEach(input => {
              const cote = input.getAttribute('data-section');
              const value = input.value || '0';
              if (cote) {
                valeurs[cote] = value;
              }
            });

            data.lavagesSections.push({
              type: lavageType,
              title: title,
              valeurs: valeurs
            });
          }
        });
      }

      log('üíæ Sections lavage sauvegard√©es:', data.lavagesSections);

      // NOUVEAU: Collecter les sections de pr√©paration cr√©√©es
      data.preparationsSections = [];
      const preparationsContainer = document.getElementById('preparations-container');
      if (preparationsContainer) {
        const preparationSections = preparationsContainer.querySelectorAll('[id^="preparation_"]');
        preparationSections.forEach(section => {
          // Trouver le type de pr√©paration depuis le premier input
          const firstInput = section.querySelector('input[data-type]');
          if (firstInput) {
            const preparationType = firstInput.getAttribute('data-type');
            const title = section.querySelector('h5')?.textContent || '';

            // Collecter les valeurs des 4 c√¥t√©s
            const inputs = section.querySelectorAll('input[data-section]');
            const valeurs = {};
            inputs.forEach(input => {
              const cote = input.getAttribute('data-section');
              const value = input.value || '0';
              if (cote) {
                valeurs[cote] = value;
              }
            });

            data.preparationsSections.push({
              type: preparationType,
              title: title,
              valeurs: valeurs
            });
          }
        });
      }

      log('üíæ Sections pr√©paration sauvegard√©es:', data.preparationsSections);

      // NOUVEAU: Collecter les sections de primer cr√©√©es
      data.primersSections = [];
      const primersContainer = document.getElementById('primers-container');
      if (primersContainer) {
        const primerSections = primersContainer.querySelectorAll('[id^="primer_"]');
        primerSections.forEach(section => {
          // Trouver le type de primer depuis le premier input
          const firstInput = section.querySelector('input[data-surface-type]');
          if (firstInput) {
            const primerType = firstInput.getAttribute('data-surface-type');
            const title = section.querySelector('h5')?.textContent || '';
            const sectionId = section.id;

            // Collecter les valeurs des 4 c√¥t√©s
            const inputs = section.querySelectorAll('input[data-section]');
            const valeurs = {};
            inputs.forEach(input => {
              const cote = input.getAttribute('data-section');
              const value = input.value || '0';
              if (cote) {
                valeurs[cote] = value;
              }
            });

            // NOUVEAU: Collecter les produits primers s√©lectionn√©s
            const produitsSelectionnes = [];
            const productCards = section.querySelectorAll('.product-card.selected');
            productCards.forEach(card => {
              const productName = card.querySelector('.text-sm.font-medium')?.textContent || '';
              // Cover Stain = jammer_huile, Dulux Gripper = dulux_gripper
              const trimmedName = productName.trim();
              produitsSelectionnes.push({
                nom: trimmedName,
                type: trimmedName.includes('Dulux') || trimmedName.includes('Gripper') ? 'dulux_gripper' :
                      trimmedName.includes('Jammer') || trimmedName.includes('Cover Stain') ? 'jammer_huile' : 'autre'
              });
            });

            data.primersSections.push({
              id: sectionId,
              type: primerType,
              title: title,
              valeurs: valeurs,
              produitsSelectionnes: produitsSelectionnes
            });
          }
        });
      }

      log('üíæ Sections primer sauvegard√©es:', data.primersSections);

      // NOUVEAU: Collecter les endroits √† peinturer cr√©√©s
      data.endroitsPeinturer = [];

      // Trouver toutes les boxes d'endroits (box-revetement, box-corniches, etc.)
      const allEndroitBoxes = document.querySelectorAll('[id^="box-"]');

      allEndroitBoxes.forEach(box => {
        const boxId = box.id; // ex: box-revetement
        const endroitType = boxId.replace('box-', ''); // ex: revetement

        // Trouver le titre de l'endroit
        const titleElement = box.querySelector('.box-header-title');
        const title = titleElement ? titleElement.textContent.trim() : endroitType;

        // Trouver l'endroit div √† l'int√©rieur
        const endroitDiv = box.querySelector('[id^="endroit_"]');
        if (!endroitDiv) return;

        const endroitId = endroitDiv.id; // ex: endroit_1

        // Collecter toutes les sous-sections de cet endroit
        const sousSections = [];
        const container = endroitDiv.querySelector('[id$="-container"]');

        if (container) {
          // Trouver toutes les sous-sections
          const sections = container.querySelectorAll('[id*="_"][class*="border-l-4"]');

          sections.forEach(section => {
            const sectionId = section.id;
            const sectionTitle = section.querySelector('h6')?.textContent.trim() || '';

            // Collecter les valeurs des 4 c√¥t√©s
            const inputs = section.querySelectorAll('input[data-section]');
            const valeurs = {};
            inputs.forEach(input => {
              const cote = input.getAttribute('data-section');
              const value = input.value || '0';
              if (cote) {
                valeurs[cote] = value;
              }
            });

            // Collecter les inputs "travail additionnel" (sans data-section, seulement data-type)
            // Ces inputs sont g√©n√©r√©s pour autre_20min, autre_30min, autre_1h
            let travailAdditionnelValeur = null;
            const travailAdditionnelTypes = ['autre_20min', 'autre_30min', 'autre_1h'];
            const allInputs = section.querySelectorAll('input[data-type]');
            allInputs.forEach(input => {
              const dataType = input.getAttribute('data-type');
              // Si c'est un travail additionnel ET pas de data-section (input unique)
              if (travailAdditionnelTypes.includes(dataType) && !input.hasAttribute('data-section')) {
                const value = input.value || '0';
                if (value !== '0' && value !== '') {
                  travailAdditionnelValeur = value;
                }
              }
            });

            // Collecter les selects (type de produit, etc.)
            const selects = section.querySelectorAll('select');
            const options = {};
            selects.forEach(select => {
              if (select.value) {
                const selectId = select.id || 'select';
                options[selectId] = select.value;
              }
            });

            // NOUVEAU: Collecter les produits s√©lectionn√©s dans cette sous-section
            const produitsSelectionnes = [];

            // Utiliser l'objet global selectedProducts pour trouver les produits de cette section
            if (typeof selectedProducts !== 'undefined') {
              log(`[DEBUG] Recherche de produits pour sectionId: ${sectionId}`);
              log(`[DEBUG] selectedProducts complet:`, selectedProducts);
              log(`[DEBUG] Keys de selectedProducts:`, Object.keys(selectedProducts));

              Object.keys(selectedProducts).forEach(productKey => {
                log(`[DEBUG] V√©rification cl√©: ${productKey} contient ${sectionId}?`, productKey.includes(sectionId));
                // Le productKey est du format: productType_sectionId
                // Ex: dulux_huile_st_endroit_1_latte_horizontale_4_1759773175795
                if (productKey.includes(sectionId)) {
                  const product = selectedProducts[productKey];
                  log(`[OK] Produit trouv√©:`, product);
                  produitsSelectionnes.push({
                    nom: product.name || '',
                    gallons: product.quantity || '0'
                  });
                }
              });
              log(`[PACKAGE] produitsSelectionnes final:`, produitsSelectionnes);
            }

            // Collecter l'√©tat de la 3√®me couche (checkbox)
            let troisiemeCouche = false;
            const troisiemeCoucheCheckbox = section.querySelector('input[id*="troisieme_couche"]');
            if (troisiemeCoucheCheckbox) {
              troisiemeCouche = troisiemeCoucheCheckbox.checked;
            }

            sousSections.push({
              id: sectionId,
              title: sectionTitle,
              valeurs: valeurs,
              options: options,
              produitsSelectionnes: produitsSelectionnes,
              troisiemeCouche: troisiemeCouche,
              travailAdditionnelValeur: travailAdditionnelValeur
            });
          });
        }

        // Collecter les inputs "Autres" (autre_20min, autre_30min, autre_1h, sablage_surface)
        const autresInputs = {};
        const autresInputElements = box.querySelectorAll('input[data-option]');
        autresInputElements.forEach(input => {
          const option = input.getAttribute('data-option');
          const value = input.value || '0';
          if (option && value !== '0' && value !== '') {
            autresInputs[option] = value;
          }
        });

        if (sousSections.length > 0 || Object.keys(autresInputs).length > 0) {
          data.endroitsPeinturer.push({
            boxId: boxId,
            type: endroitType,
            title: title,
            endroitId: endroitId,
            sousSections: sousSections,
            autresInputs: autresInputs
          });
        }
      });

      log('üíæ Endroits √† peinturer sauvegard√©s:', data.endroitsPeinturer);

      // NOUVEAU: Collecter les travaux additionnels int√©rieurs
      data.travauxAdditionnels = {
        portes: [],
        fenetres: [],
        divers: [],
        plafonds: []
      };

      // Collecter les portes globales
      const portesContainer = document.getElementById('listPortesGlobales');
      if (portesContainer) {
        const porteItems = portesContainer.querySelectorAll('[id^="porteGlobale_"]');
        porteItems.forEach(item => {
          const porteId = item.id.replace('porteGlobale_', '');
          const pieceSelect = document.getElementById(`piecePorteGlobal_${porteId}`);
          const typeSelect = document.getElementById(`typePorteGlobal_${porteId}`);
          const nombreInput = document.getElementById(`nombrePorteGlobal_${porteId}`);

          if (typeSelect && nombreInput) {
            data.travauxAdditionnels.portes.push({
              piece: pieceSelect?.value || '',
              type: typeSelect.value,
              nombre: nombreInput.value || '1'
            });
          }
        });
      }

      // Collecter les fen√™tres globales
      const fenetresContainer = document.getElementById('listFenetresGlobales');
      if (fenetresContainer) {
        const fenetreItems = fenetresContainer.querySelectorAll('[id^="fenetreGlobale_"]');
        fenetreItems.forEach(item => {
          const fenetreId = item.id.replace('fenetreGlobale_', '');
          const pieceSelect = document.getElementById(`pieceFenetreGlobal_${fenetreId}`);
          const typeSelect = document.getElementById(`typeFenetreGlobal_${fenetreId}`);
          const nombreInput = document.getElementById(`nombreFenetreGlobal_${fenetreId}`);

          if (typeSelect && nombreInput) {
            data.travauxAdditionnels.fenetres.push({
              piece: pieceSelect?.value || '',
              type: typeSelect.value,
              nombre: nombreInput.value || '1'
            });
          }
        });
      }

      // Collecter les divers globaux
      const diversContainer = document.getElementById('listDiversGlobaux');
      if (diversContainer) {
        const diversItems = diversContainer.querySelectorAll('[id^="diversGlobal_"]');
        diversItems.forEach(item => {
          const diversId = item.id.replace('diversGlobal_', '');
          const pieceSelect = document.getElementById(`pieceDiversGlobal_${diversId}`);
          const typeSelect = document.getElementById(`typeDiversGlobal_${diversId}`);
          const quantiteInput = document.getElementById(`quantiteDiversGlobal_${diversId}`);

          if (typeSelect && quantiteInput) {
            data.travauxAdditionnels.divers.push({
              piece: pieceSelect?.value || '',
              type: typeSelect.value,
              quantite: quantiteInput.value || '1'
            });
          }
        });
      }

      // Collecter les plafonds globaux
      const plafondsContainer = document.getElementById('listPlafondsGlobaux');
      if (plafondsContainer) {
        const plafondItems = plafondsContainer.querySelectorAll('[id^="plafondGlobal_"]');
        plafondItems.forEach(item => {
          const plafondId = item.id.replace('plafondGlobal_', '');
          const typeSelect = document.getElementById(`typePlafondGlobal_${plafondId}`);
          const surfaceInput = document.getElementById(`surfacePlafondGlobal_${plafondId}`);
          const primerSelect = document.getElementById(`primerPlafondGlobal_${plafondId}`);

          if (surfaceInput) {
            data.travauxAdditionnels.plafonds.push({
              type: typeSelect?.value || '',
              surface: surfaceInput.value || '0',
              primer: primerSelect?.value || 'non'
            });
          }
        });
      }

      // Sauvegarder l'√©tat des toggles
      data.travauxAdditionnels.toggles = {
        portes: document.getElementById('togglePorteGlobal')?.checked || false,
        fenetres: document.getElementById('toggleFenetreGlobal')?.checked || false,
        divers: document.getElementById('toggleDiversGlobal')?.checked || false,
        plafonds: document.getElementById('togglePlafondGlobal')?.checked || false,
        preparation: document.getElementById('togglePreparationGlobal')?.checked || false,
        appret: document.getElementById('toggleAppretGlobal')?.checked || false
      };

      // Collecter les pi√®ces s√©lectionn√©es pour pr√©paration avec leurs pr√©parations
      data.travauxAdditionnels.preparationPieces = [];
      const preparationPiecesContainer = document.getElementById('listPiecesPreparation');
      if (preparationPiecesContainer) {
        const pieceCheckboxes = preparationPiecesContainer.querySelectorAll('input[id^="prepGlobalPiece_"]');
        pieceCheckboxes.forEach(checkbox => {
          if (checkbox.checked) {
            const pieceId = checkbox.id.replace('prepGlobalPiece_', '');
            const preparationsList = document.getElementById(`prepGlobalList_${pieceId}`);
            const preparations = [];

            if (preparationsList) {
              const prepItems = preparationsList.querySelectorAll('[id^="prepGlobalItem_"]');
              prepItems.forEach(item => {
                const itemId = item.id; // Ex: prepGlobalItem_piece-1_0
                const parts = itemId.split('_');
                const index = parts[parts.length - 1];

                const typeSelect = document.getElementById(`prepGlobalType_${pieceId}_${index}`);
                const heuresSelect = document.getElementById(`prepGlobalHeures_${pieceId}_${index}`);

                if (typeSelect && heuresSelect) {
                  preparations.push({
                    type: typeSelect.value,
                    heures: heuresSelect.value || '1'
                  });
                }
              });
            }

            log(`üíæ Pr√©parations sauvegard√©es pour pi√®ce ${pieceId}:`, preparations);

            data.travauxAdditionnels.preparationPieces.push({
              pieceId: pieceId,
              preparations: preparations
            });
          }
        });
      }

      // Collecter les pi√®ces s√©lectionn√©es pour appr√™t avec leurs surfaces
      data.travauxAdditionnels.appretPieces = [];
      const appretPiecesContainer = document.getElementById('listPiecesAppret');
      if (appretPiecesContainer) {
        const pieceCheckboxes = appretPiecesContainer.querySelectorAll('input[id^="appretPiece_"]');
        pieceCheckboxes.forEach(checkbox => {
          if (checkbox.checked) {
            const pieceId = checkbox.id.replace('appretPiece_', '');

            data.travauxAdditionnels.appretPieces.push({
              pieceId: pieceId,
              mur1: document.getElementById(`appretMur1_${pieceId}`)?.checked || false,
              mur2: document.getElementById(`appretMur2_${pieceId}`)?.checked || false,
              mur3: document.getElementById(`appretMur3_${pieceId}`)?.checked || false,
              mur4: document.getElementById(`appretMur4_${pieceId}`)?.checked || false,
              plafond: document.getElementById(`appretPlafond_${pieceId}`)?.checked || false,
              moulures: document.getElementById(`appretMoulures_${pieceId}`)?.checked || false
            });
          }
        });
      }

      log('üíæ Appr√™t sauvegard√©:', data.travauxAdditionnels.appretPieces);

      log('üíæ Travaux additionnels sauvegard√©s:', data.travauxAdditionnels);

      // Sauvegarder les totaux calcul√©s (ext√©rieur)
      data.totaux_ext = {
        lavage: document.getElementById('costLavage')?.textContent || '0',
        preparation: document.getElementById('costPreparation')?.textContent || '0',
        mainOeuvre: document.getElementById('costMainOeuvre')?.textContent || '0',
        peinture: document.getElementById('costPeinture')?.textContent || '0',
        total: document.getElementById('subTotal')?.textContent || '0',
        heures: document.getElementById('totalHours')?.textContent || '0'
      };

      // Sauvegarder les totaux calcul√©s (int√©rieur)
      data.totaux_int = {
        lavage: document.getElementById('costLavageInt')?.textContent || '0',
        preparation: document.getElementById('costPreparationInt')?.textContent || '0',
        mainOeuvre: document.getElementById('costMainOeuvreInt')?.textContent || '0',
        peinture: document.getElementById('costPeintureInt')?.textContent || '0',
        total: document.getElementById('subTotalInt')?.textContent || '0',
        heures: document.getElementById('totalHeuresInt')?.textContent || '0'
      };

      // Sauvegarder onglet actif
      data.ongletActif = document.querySelector('.tab-content:not(.hidden)')?.id || 'estimation-tab';

      return data;
    }

    // Fonction pour restaurer les donn√©es de surfaces (ext√©rieur)
    function restoreSurfaceData(surfacesData) {
      log('üîÑ Restauration des surfaces:', surfacesData);

      // Restaurer les surfaces de base (avant, droit, arriere, gauche)
      const sections = ['avant', 'droit', 'arriere', 'gauche'];
      let restoredCount = 0;
      let notFoundCount = 0;

      sections.forEach(section => {
        if (surfacesData[section]) {
          Object.keys(surfacesData[section]).forEach(type => {
            const value = surfacesData[section][type];

            // Chercher TOUS les inputs avec ces attributs (y compris dans les endroits)
            const inputs = document.querySelectorAll(`[data-section="${section}"][data-type="${type}"]`);

            if (inputs.length > 0) {
              inputs.forEach(input => {
                input.value = value;
                restoredCount++;
              });
              log(`[OK] Surface restaur√©e: ${section} - ${type} = ${value} (${inputs.length} input(s))`);
            } else {
              notFoundCount++;
              warn(`[WARN] Input surface non trouv√©: ${section} - ${type}`);
            }
          });
        }
      });

      log(`[DATA] Surfaces: ${restoredCount} restaur√©es, ${notFoundCount} non trouv√©es`);
    }

    // Fonction pour restaurer les endroits personnalis√©s
    function restoreEndroitData(endroitsData) {
      log('üîÑ Restauration des endroits:', endroitsData);

      // IMPORTANT: Les endroits sont dynamiques et peuvent ne pas exister
      // Les valeurs dans les inputs avec IDs seront restaur√©es par la restauration g√©n√©rale
      // Cette fonction n'est l√† que pour information
      log('‚ÑπÔ∏è Les endroits dynamiques ne peuvent pas √™tre recr√©√©s automatiquement');
      log('‚ÑπÔ∏è Les valeurs des inputs avec ID ont d√©j√† √©t√© restaur√©es');
    }

    // Fonction pour restaurer les sections de lavage
    function restoreLavagesSections(lavagesSections) {
      if (!lavagesSections || lavagesSections.length === 0) {
        log('‚ÑπÔ∏è Aucune section lavage √† restaurer');
        return;
      }

      log('üîÑ Restauration des sections lavage:', lavagesSections);

      const container = document.getElementById('lavages-container');
      if (!container) {
        error('[ERROR] Container lavages-container non trouv√©');
        return;
      }

      // Vider le container existant
      container.innerHTML = '';

      // Recr√©er chaque section de lavage
      lavagesSections.forEach((lavageData, index) => {
        const lavageType = lavageData.type;
        const lavageTitle = lavageData.title;
        const valeurs = lavageData.valeurs || {};

        // D√©terminer l'unit√© selon le type
        let unite = 'ft¬≤';
        if (lavageType === 'lavage_main_lineaire') {
          unite = 'ft lin.';
        } else if (lavageType === 'lavage_portes_fenetres') {
          unite = 'unit√©s';
        }

        // Cr√©er la section
        const sectionId = `lavage_${Date.now()}_${index}`;
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'pt-4 first:pt-0';
        sectionDiv.id = sectionId;
        sectionDiv.innerHTML = `
          <div class="mb-2 flex justify-between items-center">
            <h5 class="font-medium text-gray-300">${lavageTitle}</h5>
            <button class="btn-secondary text-xs px-2 py-1" onclick="retirerLavage('${sectionId}')" title="Supprimer ce lavage">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Avant (${unite})</label>
              <input type="number" class="input-field" data-lavage="${sectionId}" data-type="${lavageType}" data-section="avant" value="${valeurs.avant || 0}" placeholder="0" oninput="updateCalculation()">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Droit (${unite})</label>
              <input type="number" class="input-field" data-lavage="${sectionId}" data-type="${lavageType}" data-section="droit" value="${valeurs.droit || 0}" placeholder="0" oninput="updateCalculation()">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Arri√®re (${unite})</label>
              <input type="number" class="input-field" data-lavage="${sectionId}" data-type="${lavageType}" data-section="arriere" value="${valeurs.arriere || 0}" placeholder="0" oninput="updateCalculation()">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Gauche (${unite})</label>
              <input type="number" class="input-field" data-lavage="${sectionId}" data-type="${lavageType}" data-section="gauche" value="${valeurs.gauche || 0}" placeholder="0" oninput="updateCalculation()">
            </div>
          </div>
        `;

        container.appendChild(sectionDiv);
        log(`[OK] Section lavage restaur√©e: ${lavageTitle} (${lavageType})`);
      });

      log(`[OK] ${lavagesSections.length} section(s) lavage restaur√©e(s)`);
    }

    // Fonction pour restaurer les sections de pr√©paration
    function restorePreparationsSections(preparationsSections) {
      if (!preparationsSections || preparationsSections.length === 0) {
        log('‚ÑπÔ∏è Aucune section pr√©paration √† restaurer');
        return;
      }

      log('üîÑ Restauration des sections pr√©paration:', preparationsSections);

      const container = document.getElementById('preparations-container');
      if (!container) {
        error('[ERROR] Container preparations-container non trouv√©');
        return;
      }

      // FORCER le vidage complet du container
      log('üßπ Vidage container pr√©parations, contenu actuel:', container.children.length);
      container.innerHTML = '';
      log('[OK] Container vid√©, nouveau contenu:', container.children.length);

      // Recr√©er chaque section de pr√©paration
      preparationsSections.forEach((prepData, index) => {
        const preparationType = prepData.type;
        const preparationTitle = prepData.title;
        const valeurs = prepData.valeurs || {};

        // D√©terminer l'unit√© selon le type de pr√©paration
        const isLinear = preparationType.includes('corniches') ||
                         preparationType.includes('lineaire') ||
                         preparationType.includes('grattage_40min') ||
                         preparationType.includes('grattage_20min') ||
                         preparationType.includes('grattage_10min');
        const unit = isLinear ? 'ft' : 'ft¬≤';

        // Cr√©er la section
        const sectionId = `preparation_${Date.now()}_${index}`;
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'pt-4 first:pt-0';
        sectionDiv.id = sectionId;
        sectionDiv.innerHTML = `
          <div class="mb-2 flex justify-between items-center">
            <h5 class="font-medium text-gray-300">${preparationTitle}</h5>
            <button class="btn-secondary text-xs px-2 py-1" onclick="retirerPreparation('${sectionId}')" title="Supprimer cette pr√©paration">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Avant (${unit})</label>
              <input type="number" class="input-field" data-preparation="${sectionId}" data-type="${preparationType}" data-section="avant" value="${valeurs.avant || 0}" placeholder="0" oninput="updateCalculation()">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Droit (${unit})</label>
              <input type="number" class="input-field" data-preparation="${sectionId}" data-type="${preparationType}" data-section="droit" value="${valeurs.droit || 0}" placeholder="0" oninput="updateCalculation()">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Arri√®re (${unit})</label>
              <input type="number" class="input-field" data-preparation="${sectionId}" data-type="${preparationType}" data-section="arriere" value="${valeurs.arriere || 0}" placeholder="0" oninput="updateCalculation()">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Gauche (${unit})</label>
              <input type="number" class="input-field" data-preparation="${sectionId}" data-type="${preparationType}" data-section="gauche" value="${valeurs.gauche || 0}" placeholder="0" oninput="updateCalculation()">
            </div>
          </div>
        `;

        container.appendChild(sectionDiv);
        log(`[OK] Section pr√©paration restaur√©e: ${preparationTitle} (${preparationType})`);
      });

      log(`[OK] ${preparationsSections.length} section(s) pr√©paration restaur√©e(s)`);
    }

    // Fonction pour restaurer les sections de primer
    function restorePrimersSections(primersSections) {
      if (!primersSections || primersSections.length === 0) {
        log('‚ÑπÔ∏è Aucune section primer √† restaurer');
        return;
      }

      log('üîÑ Restauration des sections primer:', primersSections);

      const container = document.getElementById('primers-container');
      if (!container) {
        error('[ERROR] Container primers-container non trouv√©');
        return;
      }

      // Vider le container existant
      container.innerHTML = '';

      // Recr√©er chaque section de primer (version simplifi√©e - juste les inputs de surface)
      primersSections.forEach((primerData, index) => {
        const primerType = primerData.type;
        const primerTitle = primerData.title;
        const valeurs = primerData.valeurs || {};

        // D√©terminer l'unit√©
        const isLinear = primerType.includes('lineaire');
        const unit = isLinear ? 'ft' : 'ft¬≤';

        // Cr√©er la section
        const sectionId = `primer_${Date.now()}_${index}`;
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'pt-4 first:pt-0 border-b border-gray-600 pb-4';
        sectionDiv.id = sectionId;
        sectionDiv.innerHTML = `
          <div class="mb-3 flex justify-between items-center">
            <h5 class="font-medium text-gray-300">${primerTitle}</h5>
            <button class="btn-secondary text-xs px-2 py-1" onclick="retirerPrimer('${sectionId}')" title="Supprimer cette surface">
              <i class="fas fa-trash"></i>
            </button>
          </div>

          <!-- Inputs pieds carr√©s/lin√©aires -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Avant (${unit})</label>
              <input type="number" class="input-field" data-primer="${sectionId}" data-surface-type="${primerType}" data-section="avant" value="${valeurs.avant || 0}" placeholder="0" oninput="updatePrimerCalculation('${sectionId}')">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Droit (${unit})</label>
              <input type="number" class="input-field" data-primer="${sectionId}" data-surface-type="${primerType}" data-section="droit" value="${valeurs.droit || 0}" placeholder="0" oninput="updatePrimerCalculation('${sectionId}')">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Arri√®re (${unit})</label>
              <input type="number" class="input-field" data-primer="${sectionId}" data-surface-type="${primerType}" data-section="arriere" value="${valeurs.arriere || 0}" placeholder="0" oninput="updatePrimerCalculation('${sectionId}')">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Gauche (${unit})</label>
              <input type="number" class="input-field" data-primer="${sectionId}" data-surface-type="${primerType}" data-section="gauche" value="${valeurs.gauche || 0}" placeholder="0" oninput="updatePrimerCalculation('${sectionId}')">
            </div>
          </div>

          <!-- Surface totale et heures -->
          <div class="mb-4 p-3 bg-slate-700/30 rounded-lg">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-gray-300">Surface totale :</span>
              <span id="totalSurface_${sectionId}" class="font-bold text-blue-400">0 ${unit}</span>
            </div>
            <div class="flex justify-between items-center mt-2">
              <span class="text-sm font-medium text-gray-300">Heures requises :</span>
              <span id="heuresRequises_${sectionId}" class="font-bold text-green-400">0.0h</span>
            </div>
          </div>

          <!-- S√©lection primer (products cliquables) -->
          <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-white">Primers disponibles</h4>
            </div>
            <div class="grid grid-cols-2 gap-2" id="primerProducts_${sectionId}">

              <!-- Dulux Gripper -->
              <div class="surface-card product-card p-2 cursor-pointer transition-all duration-200 hover:scale-105"
                   onclick="togglePrimerSelection('${sectionId}', 'dulux_gripper', event)"
                   style="border: 2px solid var(--border-dark) !important;"
                   onmouseover="this.style.backgroundColor='#065f46'; this.style.setProperty('border', '2px solid #10b981', 'important');"
                   onmouseout="if(!this.classList.contains('selected')) { this.style.backgroundColor=''; this.style.setProperty('border', '2px solid var(--border-dark)', 'important'); }">
                <div class="flex items-center space-x-2">
                  <div class="flex-1">
                    <div class="text-sm font-medium text-white">Dulux Gripper</div>
                    <div class="flex items-center justify-between text-xs mt-1">
                      <span class="product-badge px-1.5 py-0.5 rounded text-xs">200 ft¬≤/gal</span>
                      <span class="font-semibold text-white">$100/gal</span>
                    </div>
                    <!-- Inputs cach√©s pour stocker les valeurs -->
                    <input type="hidden" id="gallons_dulux_gripper_${sectionId}" value="0">
                    <span id="cost_dulux_gripper_${sectionId}" style="display: none;">$0.00</span>
                  </div>
                </div>
              </div>

              <!-- Cover Stain -->
              <div class="surface-card product-card p-2 cursor-pointer transition-all duration-200 hover:scale-105"
                   onclick="togglePrimerSelection('${sectionId}', 'jammer_huile', event)"
                   style="border: 2px solid var(--border-dark) !important;"
                   onmouseover="this.style.backgroundColor='#065f46'; this.style.setProperty('border', '2px solid #10b981', 'important');"
                   onmouseout="if(!this.classList.contains('selected')) { this.style.backgroundColor=''; this.style.setProperty('border', '2px solid var(--border-dark)', 'important'); }">
                <div class="flex items-center space-x-2">
                  <div class="flex-1">
                    <div class="text-sm font-medium text-white">Cover Stain</div>
                    <div class="flex items-center justify-between text-xs mt-1">
                      <span class="product-badge px-1.5 py-0.5 rounded text-xs">200 ft¬≤/gal</span>
                      <span class="font-semibold text-white">$100/gal</span>
                    </div>
                    <!-- Inputs cach√©s pour stocker les valeurs -->
                    <input type="hidden" id="gallons_jammer_huile_${sectionId}" value="0">
                    <span id="cost_jammer_huile_${sectionId}" style="display: none;">$0.00</span>
                  </div>
                </div>
              </div>

            </div>
          </div>
        `;

        container.appendChild(sectionDiv);

        // S√©lectionner automatiquement les produits qui √©taient s√©lectionn√©s
        if (primerData.produitsSelectionnes && primerData.produitsSelectionnes.length > 0) {
          setTimeout(() => {
            primerData.produitsSelectionnes.forEach(produit => {
              // Trouver le produit correspondant par nom ou type
              // Cover Stain = jammer_huile, Dulux Gripper = dulux_gripper
              let primerType = '';
              if (produit.type === 'dulux_gripper' || produit.nom.includes('Dulux') || produit.nom.includes('Gripper')) {
                primerType = 'dulux_gripper';
              } else if (produit.type === 'jammer_huile' || produit.nom.includes('Jammer') || produit.nom.includes('Cover Stain')) {
                primerType = 'jammer_huile';
              }

              if (primerType && typeof togglePrimerSelection === 'function') {
                // Trouver la carte du produit
                const productCard = document.querySelector(`#primerProducts_${sectionId} .product-card[onclick*="${primerType}"]`);
                if (productCard) {
                  // Cr√©er un faux √©v√©nement avec la carte du produit
                  const fakeEvent = {
                    target: productCard,
                    currentTarget: productCard,
                    stopPropagation: () => {},
                    preventDefault: () => {}
                  };

                  // Appeler directement la fonction togglePrimerSelection
                  togglePrimerSelection(sectionId, primerType, fakeEvent);

                  // Forcer le style vert apr√®s la s√©lection
                  setTimeout(() => {
                    if (productCard.classList.contains('selected')) {
                      productCard.style.backgroundColor = '#065f46';
                      productCard.style.setProperty('border', '2px solid #10b981', 'important');
                    }
                  }, 50);

                  log(`[OK] Produit primer auto-s√©lectionn√©: ${produit.nom}`);
                }
              }
            });
          }, 200);
        }

        // D√©clencher le calcul pour cette section
        if (typeof updatePrimerCalculation === 'function') {
          setTimeout(() => updatePrimerCalculation(sectionId), 100);
        }

        log(`[OK] Section primer restaur√©e: ${primerTitle} (${primerType})`);
      });

      log(`[OK] ${primersSections.length} section(s) primer restaur√©e(s)`);
    }

    // Fonction pour restaurer les endroits √† peinturer en utilisant les vraies fonctions
    function restoreEndroitsPeinturer(endroitsPeinturer) {
      if (!endroitsPeinturer || endroitsPeinturer.length === 0) {
        log('‚ÑπÔ∏è Aucun endroit √† peinturer √† restaurer');
        return;
      }

      log('üîÑ Restauration des endroits √† peinturer:', endroitsPeinturer);

      // Supprimer toutes les boxes existantes
      const existingBoxes = document.querySelectorAll('[id^="box-"]');
      existingBoxes.forEach(box => box.remove());

      // Pour chaque endroit sauvegard√©
      endroitsPeinturer.forEach((endroitData, endroitIndex) => {
        // Envelopper toute l'op√©ration dans un setTimeout pour √©viter que les it√©rations suivantes
        // n'√©crasent la valeur du dropdown avant que ajouterEndroit() ne soit appel√©
        // OPTIMIS√â: d√©lai r√©duit de 1000ms √† 50ms par endroit
        setTimeout(() => {
          const endroitType = endroitData.type;

          // S√©lectionner le type dans le dropdown principal
          const endroitSelect = document.getElementById('endroit-select');
          if (endroitSelect) {
            endroitSelect.value = endroitType;

            // Appeler la vraie fonction ajouterEndroit()
            if (typeof ajouterEndroit === 'function') {
              ajouterEndroit();

              // Attendre que l'endroit soit cr√©√©, puis ajouter les sous-sections
              // OPTIMIS√â: d√©lai r√©duit de 300ms √† 30ms
              setTimeout(() => {
                // Trouver l'endroit qui vient d'√™tre cr√©√© (le dernier avec ce type)
                const createdBox = document.getElementById(`box-${endroitType}`);
                if (createdBox) {
                  const endroitDiv = createdBox.querySelector('[id^="endroit_"]');
                  if (endroitDiv) {
                    const endroitId = endroitDiv.id;
                    const typeSelect = document.getElementById(`${endroitId}-type-select`);

                    // Restaurer les inputs "Autres" (autre_20min, autre_30min, autre_1h, sablage_surface)
                    if (endroitData.autresInputs && Object.keys(endroitData.autresInputs).length > 0) {
                      Object.keys(endroitData.autresInputs).forEach(option => {
                        const inputId = `${endroitId}_${option}`;
                        const input = document.getElementById(inputId);
                        if (input) {
                          input.value = endroitData.autresInputs[option];
                          log(`[OK] Input autre restaur√©: ${inputId} = ${endroitData.autresInputs[option]}`);
                        } else {
                          log(`[WARN] Input autre non trouv√©: ${inputId}`);
                        }
                      });
                    }

                    // Pour chaque sous-section
                    if (endroitData.sousSections) {
                      endroitData.sousSections.forEach((sousSection, ssSectionIndex) => {
                        // Envelopper toute l'op√©ration dans un setTimeout pour √©viter que les it√©rations suivantes
                        // n'√©crasent la valeur du typeSelect avant que ajouterSousSection() ne soit appel√©
                        setTimeout(() => {
                          // Extraire le type sp√©cifique depuis l'ID ou le title
                          // L'ID est du format: endroit_X_typeSpecifique_timestamp
                          const sousSectionIdParts = sousSection.id.split('_');
                          let typeSpecifique = '';

                          // Essayer de trouver le type depuis les data attributes dans les valeurs
                          if (typeSelect) {
                            // Chercher le bon type dans les options du select
                            const options = typeSelect.querySelectorAll('option');
                            options.forEach(option => {
                              if (option.text === sousSection.title) {
                                typeSpecifique = option.value;
                              }
                            });
                          }

                          if (typeSpecifique && typeSelect) {
                            // S√©lectionner le type sp√©cifique
                            typeSelect.value = typeSpecifique;

                            // Appeler la vraie fonction ajouterSousSection()
                            setTimeout(() => {
                              if (typeof ajouterSousSection === 'function') {
                                ajouterSousSection(endroitId, endroitType);

                                // Apr√®s cr√©ation de la sous-section, remplir les valeurs
                                setTimeout(() => {
                                  const container = document.getElementById(`${endroitId}-container`);
                                  if (container) {
                                    const lastSousSection = container.lastElementChild;
                                    if (lastSousSection) {
                                      const sousSectionId = lastSousSection.id;
                                      const valeurs = sousSection.valeurs || {};

                                      // Remplir les inputs avec les valeurs sauvegard√©es
                                      const inputs = lastSousSection.querySelectorAll('input[data-section]');
                                      inputs.forEach(input => {
                                        const section = input.getAttribute('data-section');
                                        if (valeurs[section] !== undefined) {
                                          input.value = valeurs[section];
                                        }
                                      });

                                      // Restaurer l'input "travail additionnel" (sans data-section)
                                      if (sousSection.travailAdditionnelValeur) {
                                        const travailAdditionnelTypes = ['autre_20min', 'autre_30min', 'autre_1h'];
                                        const allInputs = lastSousSection.querySelectorAll('input[data-type]');
                                        allInputs.forEach(input => {
                                          const dataType = input.getAttribute('data-type');
                                          if (travailAdditionnelTypes.includes(dataType) && !input.hasAttribute('data-section')) {
                                            input.value = sousSection.travailAdditionnelValeur;
                                            log(`[OK] Travail additionnel restaur√©: ${dataType} = ${sousSection.travailAdditionnelValeur}`);
                                          }
                                        });
                                      }

                                      // Cocher la 3√®me couche si n√©cessaire
                                      if (sousSection.troisiemeCouche) {
                                        const checkbox = lastSousSection.querySelector('input[id*="troisieme_couche"]');
                                        if (checkbox) {
                                          checkbox.checked = true;
                                        }
                                      }

                                      // D√©clencher les calculs
                                      if (typeof updateSectionProductCalculation === 'function') {
                                        updateSectionProductCalculation(sousSectionId);
                                      }
                                      if (typeof updateCalculation === 'function') {
                                        updateCalculation();
                                      }

                                      // S√©lectionner les produits sauvegard√©s
                                      log(`üîé V√©rification produits pour sous-section:`, sousSection);
                                      log(`üîé produitsSelectionnes:`, sousSection.produitsSelectionnes);

                                      if (sousSection.produitsSelectionnes && sousSection.produitsSelectionnes.length > 0) {
                                        log(`[DEBUG] Produits √† s√©lectionner pour ${sousSectionId}:`, sousSection.produitsSelectionnes);

                                        setTimeout(() => {
                                          log(`[TIME] Tentative de s√©lection des produits pour ${sousSectionId}`);

                                          sousSection.produitsSelectionnes.forEach(produit => {
                                            let productType = '';
                                            let productName = '';
                                            let coverage = 200;
                                            let price = 80;

                                            if (produit.nom.includes('Dulux huile ST')) {
                                              productType = 'dulux_huile_st';
                                              productName = 'Dulux huile ST';
                                              coverage = 200;
                                              price = 80;
                                            } else if (produit.nom.includes('Dulux Hybride OPQ') || produit.nom.includes('Dulux hybride OPQ')) {
                                              productType = 'dulux_hybride_opq';
                                              productName = 'Dulux hybride OPQ';
                                              coverage = 200;
                                              price = 80;
                                            } else if (produit.nom.includes('Dulux √©mail') || produit.nom.includes('Dulux email')) {
                                              productType = 'dulux_email_planchers';
                                              productName = 'Dulux √©mail planchers';
                                              coverage = 350;
                                              price = 80;
                                            } else if (produit.nom.includes('Sikkens ST')) {
                                              productType = 'sikkens_st';
                                              productName = 'Sikkens ST';
                                              coverage = 200;
                                              price = 140;
                                            } else if (produit.nom.includes('Diamant')) {
                                              productType = 'diamant';
                                              productName = 'Diamant';
                                              coverage = 350;
                                              price = 95;
                                            } else if (produit.nom.includes('Produit client')) {
                                              productType = 'produit_client';
                                              productName = 'Produit client';
                                              coverage = 300;
                                              price = 0;
                                            }

                                            log(`[PACKAGE] Mapping: ${produit.nom} -> ${productType}`);

                                            if (productType && typeof selectProduct === 'function') {
                                              const container = document.getElementById(`produitsExt_${sousSectionId}`);
                                              log(`üìç Container produitsExt_${sousSectionId}:`, container);

                                              const allCards = document.querySelectorAll(`#produitsExt_${sousSectionId} .product-card`);
                                              log(`üé¥ Cartes trouv√©es: ${allCards.length}`);

                                              let productCard = null;

                                              allCards.forEach(card => {
                                                const onclick = card.getAttribute('onclick');
                                                log(`üîé Checking card onclick:`, onclick);
                                                if (onclick && onclick.includes(productType)) {
                                                  productCard = card;
                                                  log(`[OK] Carte trouv√©e pour ${productType}`);
                                                }
                                              });

                                              if (productCard) {
                                                const fakeEvent = {
                                                  target: productCard,
                                                  currentTarget: productCard,
                                                  stopPropagation: () => {},
                                                  preventDefault: () => {}
                                                };

                                                log(`[LAUNCH] Appel selectProduct(${sousSectionId}, ${productType}, ...)`);
                                                selectProduct(sousSectionId, productType, productName, coverage, price, fakeEvent);
                                                log(`[OK] Produit auto-s√©lectionn√©: ${produit.nom}`);
                                              } else {
                                                warn(`[WARN] Carte non trouv√©e pour ${productType} dans ${sousSectionId}`);
                                              }
                                            }
                                          });
                                        }, 80);  // OPTIMIS√â: 800ms ‚Üí 80ms
                                      }
                                    }
                                  }
                                }, 15);  // OPTIMIS√â: 100ms ‚Üí 15ms
                              }
                            }, 15);  // OPTIMIS√â: 100ms ‚Üí 15ms
                          }
                        }, ssSectionIndex * 50);  // OPTIMIS√â: 500ms ‚Üí 50ms par sous-section
                      });
                    }
                  }
                }
              }, 30);  // OPTIMIS√â: 300ms ‚Üí 30ms
            }
          }
        }, endroitIndex * 80);  // OPTIMIS√â: 1000ms ‚Üí 80ms par endroit
      });

      log(`[OK] ${endroitsPeinturer.length} endroit(s) √† peinturer en cours de restauration avec les vraies fonctions`);
    }

    // Fonction pour restaurer les travaux additionnels int√©rieurs
    function restoreTravauxAdditionnels(travauxData) {
      if (!travauxData) {
        log('‚ÑπÔ∏è Aucun travaux additionnels √† restaurer');
        return;
      }

      log('üîÑ Restauration des travaux additionnels:', travauxData);

      // Restaurer les toggles
      if (travauxData.toggles) {
        if (travauxData.toggles.portes) {
          const togglePorte = document.getElementById('togglePorteGlobal');
          if (togglePorte && !togglePorte.checked) {
            togglePorte.click();
          }
        }

        if (travauxData.toggles.fenetres) {
          const toggleFenetre = document.getElementById('toggleFenetreGlobal');
          if (toggleFenetre && !toggleFenetre.checked) {
            toggleFenetre.click();
          }
        }

        if (travauxData.toggles.divers) {
          const toggleDivers = document.getElementById('toggleDiversGlobal');
          if (toggleDivers && !toggleDivers.checked) {
            toggleDivers.click();
          }
        }

        if (travauxData.toggles.plafonds) {
          const togglePlafond = document.getElementById('togglePlafondGlobal');
          if (togglePlafond && !togglePlafond.checked) {
            togglePlafond.click();
          }
        }

        if (travauxData.toggles.preparation) {
          const togglePreparation = document.getElementById('togglePreparationGlobal');
          if (togglePreparation && !togglePreparation.checked) {
            togglePreparation.click();
          }
        }

        if (travauxData.toggles.appret) {
          const toggleAppret = document.getElementById('toggleAppretGlobal');
          if (toggleAppret && !toggleAppret.checked) {
            toggleAppret.click();
          }
        }
      }

      // Attendre que les sections soient visibles
      setTimeout(() => {
        // Restaurer les portes
        if (travauxData.portes && travauxData.portes.length > 0) {
          log('üö™ Restauration des portes:', travauxData.portes);
          travauxData.portes.forEach((porte, index) => {
            setTimeout(() => {
              if (typeof ajouterPorteGlobale === 'function') {
                ajouterPorteGlobale();

                setTimeout(() => {
                  const portesContainer = document.getElementById('listPortesGlobales');
                  if (portesContainer) {
                    const lastPorte = portesContainer.lastElementChild;
                    if (lastPorte) {
                      const porteId = lastPorte.id.replace('porteGlobale_', '');
                      log(`[FIX] Restauration porte #${porteId}:`, porte);

                      const pieceSelect = document.getElementById(`piecePorteGlobal_${porteId}`);
                      const typeSelect = document.getElementById(`typePorteGlobal_${porteId}`);
                      const nombreInput = document.getElementById(`nombrePorteGlobal_${porteId}`);

                      log('üìç Elements trouv√©s:', {
                        pieceSelect: pieceSelect?.id,
                        typeSelect: typeSelect?.id,
                        nombreInput: nombreInput?.id
                      });

                      if (pieceSelect) {
                        pieceSelect.value = porte.piece;
                        log(`[OK] Pi√®ce assign√©e: ${porte.piece}`);
                        // Mettre √† jour l'affichage du dropdown custom
                        const pieceCustomSelect = pieceSelect.previousElementSibling;
                        if (pieceCustomSelect && pieceCustomSelect.classList.contains('custom-select')) {
                          const textElement = pieceCustomSelect.querySelector('.custom-select-text');
                          const selectedOption = pieceSelect.options[pieceSelect.selectedIndex];
                          if (textElement && selectedOption) {
                            textElement.textContent = selectedOption.textContent;
                          }
                        }
                      }
                      if (typeSelect) {
                        typeSelect.value = porte.type;
                        log(`[OK] Type assign√©: ${porte.type}`);
                        // Mettre √† jour l'affichage du dropdown custom
                        const typeCustomSelect = typeSelect.previousElementSibling;
                        if (typeCustomSelect && typeCustomSelect.classList.contains('custom-select')) {
                          const textElement = typeCustomSelect.querySelector('.custom-select-text');
                          const selectedOption = typeSelect.options[typeSelect.selectedIndex];
                          if (textElement && selectedOption) {
                            textElement.textContent = selectedOption.textContent;
                          }
                        }
                      }
                      if (nombreInput) {
                        nombreInput.value = porte.nombre;
                        log(`[OK] Nombre assign√©: ${porte.nombre}`);
                      }

                      // D√©clencher le calcul
                      setTimeout(() => {
                        if (typeof calculerPortesGlobales === 'function') {
                          calculerPortesGlobales();
                        }
                      }, 50);
                    }
                  }
                }, 200);
              }
            }, index * 300);
          });
        }

        // Restaurer les fen√™tres
        if (travauxData.fenetres && travauxData.fenetres.length > 0) {
          travauxData.fenetres.forEach((fenetre, index) => {
            setTimeout(() => {
              if (typeof ajouterFenetreGlobale === 'function') {
                ajouterFenetreGlobale();

                setTimeout(() => {
                  const fenetresContainer = document.getElementById('listFenetresGlobales');
                  if (fenetresContainer) {
                    const lastFenetre = fenetresContainer.lastElementChild;
                    if (lastFenetre) {
                      const fenetreId = lastFenetre.id.replace('fenetreGlobale_', '');
                      const pieceSelect = document.getElementById(`pieceFenetreGlobal_${fenetreId}`);
                      const typeSelect = document.getElementById(`typeFenetreGlobal_${fenetreId}`);
                      const nombreInput = document.getElementById(`nombreFenetreGlobal_${fenetreId}`);

                      if (pieceSelect) {
                        pieceSelect.value = fenetre.piece;
                        const pieceCustomSelect = pieceSelect.previousElementSibling;
                        if (pieceCustomSelect && pieceCustomSelect.classList.contains('custom-select')) {
                          const textElement = pieceCustomSelect.querySelector('.custom-select-text');
                          const selectedOption = pieceSelect.options[pieceSelect.selectedIndex];
                          if (textElement && selectedOption) textElement.textContent = selectedOption.textContent;
                        }
                      }
                      if (typeSelect) {
                        typeSelect.value = fenetre.type;
                        const typeCustomSelect = typeSelect.previousElementSibling;
                        if (typeCustomSelect && typeCustomSelect.classList.contains('custom-select')) {
                          const textElement = typeCustomSelect.querySelector('.custom-select-text');
                          const selectedOption = typeSelect.options[typeSelect.selectedIndex];
                          if (textElement && selectedOption) textElement.textContent = selectedOption.textContent;
                        }
                      }
                      if (nombreInput) nombreInput.value = fenetre.nombre;

                      setTimeout(() => {
                        if (typeof calculerFenetresGlobales === 'function') {
                          calculerFenetresGlobales();
                        }
                      }, 50);
                    }
                  }
                }, 200);
              }
            }, index * 300);
          });
        }

        // Restaurer les divers
        if (travauxData.divers && travauxData.divers.length > 0) {
          log('[FIX] Restauration des divers:', travauxData.divers);
          travauxData.divers.forEach((diversItem, index) => {
            setTimeout(() => {
              if (typeof ajouterDiversGlobal === 'function') {
                ajouterDiversGlobal();

                setTimeout(() => {
                  const diversContainer = document.getElementById('listDiversGlobaux');
                  if (diversContainer) {
                    const lastDivers = diversContainer.lastElementChild;
                    if (lastDivers) {
                      const diversId = lastDivers.id.replace('diversGlobal_', '');
                      log(`[FIX] Restauration divers #${diversId}:`, diversItem);

                      const pieceSelect = document.getElementById(`pieceDiversGlobal_${diversId}`);
                      const typeSelect = document.getElementById(`typeDiversGlobal_${diversId}`);
                      const quantiteInput = document.getElementById(`quantiteDiversGlobal_${diversId}`);

                      log('[DEBUG] √âl√©ments divers trouv√©s:', {
                        pieceSelect: pieceSelect?.id,
                        typeSelect: typeSelect?.id,
                        quantiteInput: quantiteInput?.id,
                        data: diversItem
                      });

                      if (pieceSelect) {
                        pieceSelect.value = diversItem.piece;
                        const pieceCustomSelect = pieceSelect.previousElementSibling;
                        if (pieceCustomSelect && pieceCustomSelect.classList.contains('custom-select')) {
                          const textElement = pieceCustomSelect.querySelector('.custom-select-text');
                          const selectedOption = pieceSelect.options[pieceSelect.selectedIndex];
                          if (textElement && selectedOption) textElement.textContent = selectedOption.textContent;
                        }
                      }
                      if (typeSelect) {
                        typeSelect.value = diversItem.type;
                        const typeCustomSelect = typeSelect.previousElementSibling;
                        if (typeCustomSelect && typeCustomSelect.classList.contains('custom-select')) {
                          const textElement = typeCustomSelect.querySelector('.custom-select-text');
                          const selectedOption = typeSelect.options[typeSelect.selectedIndex];
                          if (textElement && selectedOption) textElement.textContent = selectedOption.textContent;
                        }
                      }
                      if (quantiteInput) quantiteInput.value = diversItem.quantite;

                      setTimeout(() => {
                        if (typeof calculerDiversGlobaux === 'function') {
                          calculerDiversGlobaux();
                        }
                      }, 50);
                    }
                  }
                }, 200);
              }
            }, index * 300);
          });
        }

        // Restaurer les plafonds
        if (travauxData.plafonds && travauxData.plafonds.length > 0) {
          travauxData.plafonds.forEach((plafond, index) => {
            setTimeout(() => {
              if (typeof ajouterPlafondGlobal === 'function') {
                ajouterPlafondGlobal();

                setTimeout(() => {
                  const plafondsContainer = document.getElementById('listPlafondsGlobaux');
                  if (plafondsContainer) {
                    const lastPlafond = plafondsContainer.lastElementChild;
                    if (lastPlafond) {
                      const plafondId = lastPlafond.id.replace('plafondGlobal_', '');
                      const typeSelect = document.getElementById(`typePlafondGlobal_${plafondId}`);
                      const surfaceInput = document.getElementById(`surfacePlafondGlobal_${plafondId}`);
                      const primerSelect = document.getElementById(`primerPlafondGlobal_${plafondId}`);

                      if (typeSelect) {
                        typeSelect.value = plafond.type;
                        const typeCustomSelect = typeSelect.previousElementSibling;
                        if (typeCustomSelect && typeCustomSelect.classList.contains('custom-select')) {
                          const textElement = typeCustomSelect.querySelector('.custom-select-text');
                          const selectedOption = typeSelect.options[typeSelect.selectedIndex];
                          if (textElement && selectedOption) textElement.textContent = selectedOption.textContent;
                        }
                      }
                      if (surfaceInput) surfaceInput.value = plafond.surface;
                      if (primerSelect) {
                        primerSelect.value = plafond.primer;
                        const primerCustomSelect = primerSelect.previousElementSibling;
                        if (primerCustomSelect && primerCustomSelect.classList.contains('custom-select')) {
                          const textElement = primerCustomSelect.querySelector('.custom-select-text');
                          const selectedOption = primerSelect.options[primerSelect.selectedIndex];
                          if (textElement && selectedOption) textElement.textContent = selectedOption.textContent;
                        }
                      }

                      // D√©clencher le calcul
                      setTimeout(() => {
                        if (typeof calculerPlafondsGlobaux === 'function') {
                          calculerPlafondsGlobaux();
                        }
                      }, 50);
                    }
                  }
                }, 100);
              }
            }, index * 150);
          });
        }

        // Restaurer les checkboxes de pr√©paration avec leurs pr√©parations
        if (travauxData.preparationPieces && travauxData.preparationPieces.length > 0) {
          setTimeout(() => {
            log('üé® Restauration des pr√©parations:', travauxData.preparationPieces);
            travauxData.preparationPieces.forEach((pieceData, pieceIndex) => {
              setTimeout(() => {
                log(`[DEBUG] Restauration pr√©paration pour pi√®ce ${pieceData.pieceId}`);
                const checkbox = document.getElementById(`prepGlobalPiece_${pieceData.pieceId}`);
                log(`üìç Checkbox trouv√©e:`, checkbox);

                if (checkbox) {
                  // VIDER LA LISTE EXISTANTE AVANT D'AJOUTER (√©vite les doublons)
                  const prepList = document.getElementById(`prepGlobalList_${pieceData.pieceId}`);
                  if (prepList) {
                    log(`üßπ Vidage de la liste existante pour pi√®ce ${pieceData.pieceId}:`, prepList.children.length, 'items');
                    prepList.innerHTML = '';
                  }

                  // VIDER L'OBJET preparationsGlobales pour cette pi√®ce
                  if (preparationsGlobales[pieceData.pieceId]) {
                    log(`üßπ Vidage de preparationsGlobales[${pieceData.pieceId}]:`, preparationsGlobales[pieceData.pieceId].length, 'items');
                    preparationsGlobales[pieceData.pieceId] = [];
                  }

                  // Activer le checkbox et afficher la section
                  checkbox.checked = true;
                  const prepsDiv = document.getElementById(`prepGlobalPreps_${pieceData.pieceId}`);
                  if (prepsDiv) {
                    prepsDiv.style.display = 'block';
                    log(`[OK] Section pr√©parations affich√©e pour pi√®ce ${pieceData.pieceId}`);
                  }
                }

                // Ajouter les pr√©parations de cette pi√®ce
                if (pieceData.preparations && pieceData.preparations.length > 0) {
                  log(`[NOTE] ${pieceData.preparations.length} pr√©paration(s) √† restaurer pour pi√®ce ${pieceData.pieceId}`);

                  // Attendre plus longtemps pour s'assurer que le toggle est activ√©
                  setTimeout(() => {
                    // S'assurer que le div est visible avant d'ajouter les pr√©parations
                    const prepsDiv = document.getElementById(`prepGlobalPreps_${pieceData.pieceId}`);
                    if (prepsDiv) {
                      prepsDiv.style.display = 'block';
                      log(`[OK] Div pr√©parations affich√© pour pi√®ce ${pieceData.pieceId}`);
                    }

                    pieceData.preparations.forEach((prep, prepIndex) => {
                      setTimeout(() => {
                        log(`[ADD] Ajout pr√©paration ${prepIndex + 1}:`, prep);

                        // Cr√©er directement avec les bonnes valeurs au lieu de cr√©er puis modifier
                        if (!preparationsGlobales[pieceData.pieceId]) {
                          preparationsGlobales[pieceData.pieceId] = [];
                        }

                        const index = preparationsGlobales[pieceData.pieceId].length;

                        // Ajouter dans l'objet avec les bonnes valeurs
                        preparationsGlobales[pieceData.pieceId].push({
                          type: prep.type,
                          heures: parseFloat(prep.heures)
                        });
                        log(`[OK] Ajout√© dans preparationsGlobales[${pieceData.pieceId}][${index}]:`, prep);

                        // Cr√©er le HTML directement avec les bonnes valeurs
                        if (typeof ajouterPreparationGlobaleHTML === 'function') {
                          ajouterPreparationGlobaleHTML(pieceData.pieceId, index, prep.type, prep.heures);
                          log(`[OK] HTML cr√©√© avec type=${prep.type}, heures=${prep.heures}`);

                          // Recalculer
                          setTimeout(() => {
                            if (typeof calculerPreparationGlobal === 'function') {
                              calculerPreparationGlobal();
                            }
                          }, 50);
                        }
                      }, prepIndex * 200);
                    });
                  }, 300);
                }
              }, pieceIndex * 500);
            });
            log('[OK] Pi√®ces de pr√©paration restaur√©es:', travauxData.preparationPieces);
          }, 800);
        }

        // Restaurer les checkboxes d'appr√™t
        if (travauxData.appretPieces && travauxData.appretPieces.length > 0) {
          setTimeout(() => {
            log('üé® Restauration appr√™t pour pi√®ces:', travauxData.appretPieces);
            travauxData.appretPieces.forEach(pieceData => {
              const pieceId = pieceData.pieceId || pieceData; // Support ancien format
              const checkbox = document.getElementById(`appretPiece_${pieceId}`);
              log(`[DEBUG] Restauration appr√™t pour pi√®ce ${pieceId}:`, checkbox);

              if (checkbox) {
                // Toujours cocher la pi√®ce
                checkbox.checked = true;

                // Appeler toggleAppretPieceSelection pour afficher les checkboxes des murs
                if (typeof toggleAppretPieceSelection === 'function') {
                  toggleAppretPieceSelection(pieceId);
                  log(`[OK] toggleAppretPieceSelection appel√© pour ${pieceId}`);
                }

                // Restaurer les surfaces s√©lectionn√©es si c'est le nouveau format
                log(`[DEBUG] Type de pieceData:`, typeof pieceData, pieceData);
                if (typeof pieceData === 'object') {
                  log(`üîÑ D√©marrage setTimeout pour restaurer surfaces de ${pieceId}`);
                  setTimeout(() => {
                    log(`[TIME] Dans setTimeout pour ${pieceId}`);
                    const mur1Checkbox = document.getElementById(`appretMur1_${pieceId}`);
                    const mur2Checkbox = document.getElementById(`appretMur2_${pieceId}`);
                    const mur3Checkbox = document.getElementById(`appretMur3_${pieceId}`);
                    const mur4Checkbox = document.getElementById(`appretMur4_${pieceId}`);
                    const plafondCheckbox = document.getElementById(`appretPlafond_${pieceId}`);
                    const mouluressCheckbox = document.getElementById(`appretMoulures_${pieceId}`);

                    log(`[DEBUG] Checkboxes trouv√©es - Mur1:`, mur1Checkbox, `Mur2:`, mur2Checkbox, `Mur3:`, mur3Checkbox, `Mur4:`, mur4Checkbox);
                    log(`[DEBUG] Restauration surfaces pour pi√®ce ${pieceId}:`, pieceData);

                    // D'abord tout d√©cocher (toggleAppretPieceSelection coche les 4 murs par d√©faut)
                    if (mur1Checkbox) mur1Checkbox.checked = false;
                    if (mur2Checkbox) mur2Checkbox.checked = false;
                    if (mur3Checkbox) mur3Checkbox.checked = false;
                    if (mur4Checkbox) mur4Checkbox.checked = false;
                    if (plafondCheckbox) plafondCheckbox.checked = false;
                    if (mouluressCheckbox) mouluressCheckbox.checked = false;

                    // Puis cocher seulement ce qui √©tait s√©lectionn√©
                    if (pieceData.mur1 && mur1Checkbox) {
                      mur1Checkbox.checked = true;
                      log(`[OK] Mur 1 coch√©`);
                    }
                    if (pieceData.mur2 && mur2Checkbox) {
                      mur2Checkbox.checked = true;
                      log(`[OK] Mur 2 coch√©`);
                    }
                    if (pieceData.mur3 && mur3Checkbox) {
                      mur3Checkbox.checked = true;
                      log(`[OK] Mur 3 coch√©`);
                    }
                    if (pieceData.mur4 && mur4Checkbox) {
                      mur4Checkbox.checked = true;
                      log(`[OK] Mur 4 coch√©`);
                    }
                    if (pieceData.plafond && plafondCheckbox) {
                      plafondCheckbox.checked = true;
                      log(`[OK] Plafond coch√©`);
                    }
                    if (pieceData.moulures && mouluressCheckbox) {
                      mouluressCheckbox.checked = true;
                      log(`[OK] Moulures coch√©es`);
                    }

                    // D√©clencher le calcul
                    if (typeof calculerAppretGlobal === 'function') {
                      calculerAppretGlobal();
                    }

                    log(`[OK] Surfaces appr√™t restaur√©es pour pi√®ce ${pieceId}`);
                  }, 100);
                }
              }
            });
            log('[OK] Pi√®ces d\'appr√™t restaur√©es:', travauxData.appretPieces);
          }, 1000);
        }

        log('[OK] Travaux additionnels restaur√©s');
      }, 300);
    }

    function reinitialiserCalculateur() {
      log('üßπ D√âBUT R√âINITIALISATION COMPL√àTE DU CALCULATEUR');

      // R√©initialiser l'ID du projet charg√©
      currentLoadedProjectId = null;
      isAutoSaveEnabled = false;
      sectionsUnlocked = false;
      isCreatingProject = false;

      // Remettre le bouton en "Cr√©er le projet" (d√©sactiv√©)
      const createBtn = document.getElementById('createProjectBtn');
      if (createBtn) {
        createBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Cr√©er le projet';
        createBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        createBtn.onclick = createProjectFromButton;
        createBtn.disabled = true;
        createBtn.style.opacity = '0.5';
        createBtn.style.cursor = 'not-allowed';
      }

      // D√©verrouiller les champs client
      if (typeof unlockClientInfoFields === 'function') {
        unlockClientInfoFields();
      }

      // Afficher le message de validation
      const validationMsg = document.getElementById('clientInfoValidationMessage');
      if (validationMsg) {
        validationMsg.style.display = 'block';
      }

      // Cacher l'indicateur de sauvegarde
      const statusEl = document.getElementById('auto-save-status');
      if (statusEl) {
        statusEl.style.display = 'none';
      }

      // Cacher le bouton total mobile
      const mobileTotalBtn = document.getElementById('mobile-total-btn');
      if (mobileTotalBtn) {
        mobileTotalBtn.style.display = 'none';
      }

      // 1. R√âINITIALISER LES PI√àCES INT√âRIEURES
      piecesInterieur = [];
      const listePieces = document.getElementById('listePieces');
      if (listePieces) {
        listePieces.innerHTML = '';
      }

      // 2. VIDER TOUS LES CONTAINERS DE TRAVAUX ADDITIONNELS INT√âRIEURS
      const portesContainer = document.getElementById('listPortesGlobales');
      if (portesContainer) portesContainer.innerHTML = '';

      const fenetresContainer = document.getElementById('listFenetresGlobales');
      if (fenetresContainer) fenetresContainer.innerHTML = '';

      const diversContainer = document.getElementById('listDiversGlobaux');
      if (diversContainer) diversContainer.innerHTML = '';

      const plafondsContainer = document.getElementById('listPlafondsGlobaux');
      if (plafondsContainer) plafondsContainer.innerHTML = '';

      const listPiecesPreparation = document.getElementById('listPiecesPreparation');
      if (listPiecesPreparation) listPiecesPreparation.innerHTML = '';

      const listPiecesAppret = document.getElementById('listPiecesAppret');
      if (listPiecesAppret) listPiecesAppret.innerHTML = '';

      // 3. D√âCOCHER ET CACHER LES SECTIONS DE TRAVAUX ADDITIONNELS
      const togglesData = [
        { id: 'togglePorteGlobal', section: 'porteGlobalSection' },
        { id: 'toggleFenetreGlobal', section: 'fenetreGlobalSection' },
        { id: 'toggleDiversGlobal', section: 'diversGlobalSection' },
        { id: 'togglePlafondGlobal', section: 'plafondGlobalSection' },
        { id: 'togglePreparationGlobal', section: 'preparationGlobalSection' },
        { id: 'toggleAppretGlobal', section: 'appretGlobalSection' }
      ];

      togglesData.forEach(({ id, section }) => {
        const toggle = document.getElementById(id);
        const sectionDiv = document.getElementById(section);

        if (toggle) {
          toggle.checked = false;
        }
        if (sectionDiv) {
          sectionDiv.style.display = 'none';
        }
      });

      // 4. VIDER LES SECTIONS EXT√âRIEURES DYNAMIQUES
      const lavagesContainer = document.getElementById('lavages-container');
      if (lavagesContainer) {
        log('üßπ Vidage lavages-container:', lavagesContainer.children.length, '√©l√©ments');
        lavagesContainer.innerHTML = '';
      }

      const preparationsContainer = document.getElementById('preparations-container');
      if (preparationsContainer) {
        log('üßπ Vidage preparations-container:', preparationsContainer.children.length, '√©l√©ments');
        preparationsContainer.innerHTML = '';
      }

      const primersContainer = document.getElementById('primers-container');
      if (primersContainer) {
        log('üßπ Vidage primers-container:', primersContainer.children.length, '√©l√©ments');
        primersContainer.innerHTML = '';
      }

      const endroitsContainer = document.getElementById('endroits-container');
      if (endroitsContainer) {
        log('üßπ Vidage endroits-container:', endroitsContainer.children.length, '√©l√©ments');
        endroitsContainer.innerHTML = '';
      }

      // 5. R√âINITIALISER TOUS LES INPUTS ET SELECTS
      const allInputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="tel"], input[type="email"], textarea');
      allInputs.forEach(input => {
        if (input.id === 'profitMargin' || input.id === 'profitMarginInt') return; // Garder les marges de profit (valeur par d√©faut 25)
        if (input.id === 'hauteurPiece') {
          input.value = '8'; // Valeur par d√©faut
          return;
        }
        input.value = '';
      });

      const allSelects = document.querySelectorAll('select');
      allSelects.forEach(select => {
        select.selectedIndex = 0;
        // Mettre √† jour les custom selects
        const customSelect = select.nextElementSibling;
        if (customSelect && customSelect.classList.contains('custom-select')) {
          const textElement = customSelect.querySelector('.custom-select-text');
          if (textElement && select.options[0]) {
            textElement.textContent = select.options[0].textContent;
          }
        }
      });

      // 6. D√âCOCHER TOUTES LES CHECKBOXES
      const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
      allCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
      });

      // 7. R√âINITIALISER LES TOTAUX
      const totauxElements = [
        'totalFinalDisplay',
        'totalInterieurDisplay',
        'subTotal',
        'subTotalInt',
        'heuresExtTotal',
        'heuresIntTotal'
      ];

      totauxElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = '0.00 $';
        }
      });

      // 8. APPELER LES FONCTIONS DE MISE √Ä JOUR DES LISTES
      if (typeof updatePreparationGlobalList === 'function') {
        updatePreparationGlobalList();
      }
      if (typeof updateAppretGlobalList === 'function') {
        updateAppretGlobalList();
      }

      // 9. R√âINITIALISER LES AFFICHAGES DE SURFACES ET HEURES
      const surfaceElements = [
        'surfaceTotal', 'totalHours', 'totalHeuresInt',
        'surfaceLavage', 'surfacePreparation', 'surfacePrimer', 'surfacePeinture',
        'coutLavageDisplay', 'coutPreparationDisplay', 'coutPrimerDisplay', 'coutPeintureDisplay',
        'coutMateriaux', 'coutTotal'
      ];

      surfaceElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
          if (elementId.includes('cout') || elementId.includes('Total')) {
            element.textContent = '0.00 $';
          } else if (elementId.includes('surface') || elementId.includes('Surface')) {
            element.textContent = '0';
          } else if (elementId.includes('Heures') || elementId.includes('Hours')) {
            element.textContent = '0.0';
          }
        }
      });

      // 10. RECALCULER IMM√âDIATEMENT POUR REMETTRE TOUT √Ä Z√âRO
      if (typeof updateCalculation === 'function') {
        updateCalculation();
      }
      if (typeof calculerInterieur === 'function') {
        calculerInterieur();
      }
      if (typeof refreshProductSelection === 'function') {
        refreshProductSelection();
      }
      // Revalider les boutons (ils devraient √™tre d√©sactiv√©s maintenant)
      if (typeof validateCompleterButton === 'function') {
        validateCompleterButton();
      }

      // 11. VIDER TOUS LES ARRAYS/OBJECTS GLOBAUX
      if (typeof surfaces !== 'undefined') surfaces = {};
      if (typeof endroits !== 'undefined') endroits = {};

      log('üßπ Calculateur compl√®tement r√©initialis√©');
    }

    async function enregistrerProjetRapide() {
      // M√äME LOGIQUE QUE completerSoumission() mais sans redirection vers /soumissions

      // 1. R√©cup√©rer et nettoyer les totaux (m√™me logique que completerSoumission)
      const totalExtElement = document.getElementById('subTotal');
      const totalIntElement = document.getElementById('subTotalInt');
      const totalCombineElement = document.getElementById('totalCombine');

      const totalExt = totalExtElement?.textContent.replace('$', '').replace(/\s+/g, '').replace(',', '.').trim() || '0';
      const totalInt = totalIntElement?.textContent.replace('$', '').replace(/\s+/g, '').replace(',', '.').trim() || '0';
      const totalCombine = totalCombineElement?.textContent.replace('$', '').replace(/\s+/g, '').replace(',', '.').trim() || '0';

      const prixExt = parseFloat(totalExt) || 0;
      const prixInt = parseFloat(totalInt) || 0;
      const prixTotal = parseFloat(totalCombine) || 0; // Utiliser le Total des travaux (min 800$)

      if (prixTotal <= 0) {
        showNotification('Veuillez d\'abord faire un calcul avant de sauvegarder', 'warning');
        return;
      }

      // 2. V√©rifier les donn√©es client
      const clientPrenom = document.getElementById('clientPrenom')?.value || '';
      const clientNom = document.getElementById('clientNom')?.value || '';
      const clientAddress = document.getElementById('clientAddress')?.value || '';
      const clientPhone = document.getElementById('clientPhone')?.value || '';

      if (!clientPrenom || !clientNom) {
        showNotification('Veuillez remplir le pr√©nom et nom du client', 'warning');
        return;
      }

      // 3. Utiliser directement le Total des travaux (qui inclut d√©j√† le minimum de 800$)
      let prix = prixTotal;
      let typeTravauxText = '';
      let itemTravaux = '';

      if (prixExt >= 400 && prixInt >= 400) {
        typeTravauxText = ' (Ext√©rieur + Int√©rieur)';
        itemTravaux = 'Travaux ext√©rieurs et int√©rieurs';
      } else if (prixExt >= 400) {
        typeTravauxText = ' (Ext√©rieur seulement)';
        itemTravaux = 'Travaux ext√©rieurs';
      } else if (prixInt >= 400) {
        typeTravauxText = ' (Int√©rieur seulement)';
        itemTravaux = 'Travaux int√©rieurs';
      } else {
        typeTravauxText = prixExt > prixInt ? ' (Ext. - sous seuil)' : ' (Int. - sous seuil)';
        itemTravaux = prixExt > prixInt ? 'Travaux ext√©rieurs' : 'Travaux int√©rieurs';
      }

      log(`[MONEY] Calcul prix: Ext=${prixExt}$ Int=${prixInt}$ -> Final=${prix}$${typeTravauxText}`);

      // 4. Arrondir au 5 ou 10 sup√©rieur (m√™me logique que completerSoumission)
      const prixBase = Math.ceil(parseFloat(prix));
      const dernierChiffre = prixBase % 10;

      let prixArrondi;
      if (dernierChiffre === 0) {
        prixArrondi = prixBase; // D√©j√† arrondi √† 10
      } else if (dernierChiffre <= 5) {
        prixArrondi = prixBase - dernierChiffre + 5; // Arrondir au 5
      } else {
        prixArrondi = prixBase - dernierChiffre + 10; // Arrondir au 10 suivant
      }

      log(`üî¢ Prix arrondi au 5/10: ${prix} -> ${prixBase} -> ${prixArrondi}`);

      // 5. Cr√©er l'objet projet
      const username = localStorage.getItem('username') || 'default';
      const clientName = `${clientPrenom} ${clientNom}`;

      // Utiliser l'ID existant si on modifie un projet charg√©, sinon cr√©er un nouvel ID
      const projetId = currentLoadedProjectId || Date.now().toString();

      // D√©terminer le type de travaux bas√© sur les seuils
      let typeTravaux = '';
      if (prixExt >= 400 && prixInt >= 400) {
        typeTravaux = 'Ext et Int';
      } else if (prixExt >= 400) {
        typeTravaux = 'Ext';
      } else if (prixInt >= 400) {
        typeTravaux = 'Int';
      } else {
        // Sous le seuil, on indique quand m√™me le type principal
        typeTravaux = prixExt > prixInt ? 'Ext' : 'Int';
      }

      const projet = {
        id: projetId,
        client: clientName,
        adresse: clientAddress,
        telephone: clientPhone,
        dateCreation: (() => {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          return `${day}/${month}/${year}`;
        })(),
        total: prixArrondi,
        totalExt: prixExt,
        totalInt: prixInt,
        typeTravaux: typeTravaux,
        formData: collecterToutesDonnees()
      };

      // 5. Sauvegarder via API (mise √† jour si projet existant)
      try {
        const response = await fetch('/api/projets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: username,
            projet: projet,
            updateExisting: currentLoadedProjectId ? true : false
          })
        });

        if (response.ok) {
          log('[OK] Projet ' + (currentLoadedProjectId ? 'mis √† jour' : 'sauvegard√©') + ' dans le cloud');

          // Afficher l'animation de chargement
          showLoadingAnimation(currentLoadedProjectId ? 'Projet mis √† jour!' : 'Projet enregistr√©!');

          // Basculer vers l'onglet Mes Projets AVANT le refresh
          switchTab('mes-projets');

          // Actualiser la liste des projets
          setTimeout(() => {
            afficherListeProjets();
          }, 100);

          // Forcer un rechargement complet de la page apr√®s un d√©lai pour voir l'animation
          setTimeout(() => {
            window.location.reload();
          }, 800);
        } else {
          showNotification('Erreur lors de l\'enregistrement', 'error');
        }
      } catch (err) {
        console.error('[ERROR] Erreur sauvegarde projet:', err);
        showNotification('Erreur lors de l\'enregistrement', 'error');
      }
    }

    async function chargerProjet(projetId) {
      // Pour coach/direction avec entrepreneur d√©j√† s√©lectionn√©: reset + charger sans reload
      const userRole = localStorage.getItem('userRole');
      const isCoachOrDirection = userRole === 'coach' || userRole === 'direction';
      const hasSelection = document.body.classList.contains('has-selection');

      if (isCoachOrDirection && hasSelection && window.selectedEntrepreneur) {
        // R√©initialiser le formulaire puis charger directement sans reload
        log('üîÑ [CHARGEMENT] Entrepreneur d√©j√† s√©lectionn√©, reset + chargement sans reload');
        showLoadingAnimation('Chargement du projet...');

        // R√©initialiser tous les champs et sections
        resetFormFields();

        // Charger le projet
        await chargerProjetInternal(projetId);
        return;
      }

      // Sauvegarder l'ID du projet √† charger dans localStorage
      localStorage.setItem('pendingProjectLoad', String(projetId));

      // Pour coach/direction: sauvegarder l'entrepreneur s√©lectionn√© pour le restaurer apr√®s reload
      if (isCoachOrDirection && window.selectedEntrepreneur) {
        sessionStorage.setItem('selectedEntrepreneurBeforeReload', window.selectedEntrepreneur);
      }

      // Afficher l'animation IMM√âDIATEMENT avant le reload pour √©viter le flash
      showLoadingAnimation('Chargement du projet...');

      // Petit d√©lai pour que l'animation soit visible avant le reload
      setTimeout(() => {
        window.location.reload();
      }, 50);
    }

    // Fonction pour r√©initialiser tous les champs du formulaire sans reload
    function resetFormFields() {
      log('[RESET] R√©initialisation COMPL√àTE des champs du formulaire...');

      // ====== R√âINITIALISER LES VARIABLES GLOBALES ======
      currentLoadedProjectId = null;
      isAutoSaveEnabled = false;
      sectionsUnlocked = false;
      isCreatingProject = false;
      selectedProducts = {};
      preparationsGlobales = {};
      preparationPieceCounters = {};
      appretPieceCounters = {};
      heuresNettoyage = 0;

      // ====== REMETTRE LE BOUTON EN MODE "CR√âER" ======
      const createBtn = document.getElementById('createProjectBtn');
      if (createBtn) {
        createBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Cr√©er le projet';
        createBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        createBtn.onclick = createProjectFromButton;
        createBtn.disabled = true;
        createBtn.style.opacity = '0.5';
        createBtn.style.cursor = 'not-allowed';
      }

      // D√©verrouiller les champs client
      if (typeof unlockClientInfoFields === 'function') {
        unlockClientInfoFields();
      }

      // Afficher le message de validation
      const validationMsg = document.getElementById('clientInfoValidationMessage');
      if (validationMsg) {
        validationMsg.style.display = 'block';
      }

      // Cacher l'indicateur de sauvegarde
      const statusEl = document.getElementById('auto-save-status');
      if (statusEl) {
        statusEl.style.display = 'none';
      }

      // Cacher le bouton total mobile
      const mobileTotalBtn = document.getElementById('mobile-total-btn');
      if (mobileTotalBtn) {
        mobileTotalBtn.style.display = 'none';
      }

      // ====== R√âINITIALISER LES COMPTEURS ======
      pieceCounter = 0;
      porteGlobaleCounter = 0;
      fenetreGlobaleCounter = 0;
      diversGlobalCounter = 0;
      plafondGlobalCounter = 0;
      endroitCounter = 0;
      lavageCounter = 0;
      preparationCounter = 0;
      primerCounter = 0;

      // ====== R√âINITIALISER LES ARRAYS ======
      piecesInterieur = [];

      // ====== R√âINITIALISER TOUS LES INPUTS ======
      document.querySelectorAll('input[type="text"], input[type="number"], input[type="tel"], input[type="email"]').forEach(input => {
        if (input.id === 'search-input') return; // Garder la recherche
        if (input.id === 'profitMargin' || input.id === 'profitMarginInt') return; // Garder les marges de profit (valeur par d√©faut 25)
        if (input.id === 'hauteurPiece') {
          input.value = '8'; // Valeur par d√©faut
          return;
        }
        input.value = '';
      });

      // ====== R√âINITIALISER LES TEXTAREAS ======
      document.querySelectorAll('textarea').forEach(textarea => {
        textarea.value = '';
      });

      // ====== R√âINITIALISER LES CHECKBOXES ======
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });

      // ====== R√âINITIALISER LES RADIO BUTTONS ======
      document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.checked = false;
      });

      // ====== R√âINITIALISER TOUS LES SELECT ======
      document.querySelectorAll('select').forEach(select => {
        select.selectedIndex = 0; // Retourner √† la premi√®re option
      });

      // ====== SUPPRIMER TOUTES LES SECTIONS DYNAMIQUES ======
      // VIDER COMPL√àTEMENT LE CONTENEUR DE LAVAGES
      const lavagesContainer = document.getElementById('lavages-container');
      if (lavagesContainer) {
        lavagesContainer.innerHTML = '';
        log('[RESET] Conteneur lavages vid√©');
      }

      // VIDER COMPL√àTEMENT LE CONTENEUR DE PR√âPARATIONS
      const preparationsContainer = document.getElementById('preparations-container');
      if (preparationsContainer) {
        preparationsContainer.innerHTML = '';
        log('[RESET] Conteneur pr√©parations vid√©');
      }

      // VIDER COMPL√àTEMENT LE CONTENEUR DE PRIMERS
      const primersContainer = document.getElementById('primers-container');
      if (primersContainer) {
        primersContainer.innerHTML = '';
        log('[RESET] Conteneur primers vid√©');
      }

      // VIDER COMPL√àTEMENT LE CONTENEUR D'ENDROITS √Ä PEINTURER
      const endroitsContainer = document.getElementById('endroits-container');
      if (endroitsContainer) {
        endroitsContainer.innerHTML = '';
        log('[RESET] Conteneur endroits vid√©');
      }

      // VIDER COMPL√àTEMENT LA LISTE DES PI√àCES INT√âRIEURES
      const listePieces = document.getElementById('listePieces');
      if (listePieces) {
        listePieces.innerHTML = '';
        log('[RESET] Liste des pi√®ces vid√©e');
      }

      // VIDER COMPL√àTEMENT LES TRAVAUX ADDITIONNELS INT√âRIEURS
      const listPortesGlobales = document.getElementById('listPortesGlobales');
      if (listPortesGlobales) {
        listPortesGlobales.innerHTML = '';
        log('[RESET] Liste des portes globales vid√©e');
      }

      const listFenetresGlobales = document.getElementById('listFenetresGlobales');
      if (listFenetresGlobales) {
        listFenetresGlobales.innerHTML = '';
        log('[RESET] Liste des fen√™tres globales vid√©e');
      }

      const listDiversGlobaux = document.getElementById('listDiversGlobaux');
      if (listDiversGlobaux) {
        listDiversGlobaux.innerHTML = '';
        log('[RESET] Liste des divers globaux vid√©e');
      }

      const listPlafondsGlobaux = document.getElementById('listPlafondsGlobaux');
      if (listPlafondsGlobaux) {
        listPlafondsGlobaux.innerHTML = '';
        log('[RESET] Liste des plafonds globaux vid√©e');
      }

      // SUPPRIMER TOUTES LES BOXES DE TYPE DYNAMIQUES (box-revetement, box-portes, etc.)
      document.querySelectorAll('div.box[id^="box-"]').forEach(box => {
        box.remove();
        log('[RESET] Box de type supprim√©e:', box.id);
      });

      // Supprimer aussi les sections dynamiques au cas o√π (par s√©curit√©)
      document.querySelectorAll('.lavage-section, .preparation-section, .primer-section, .endroit-a-peinturer').forEach(section => {
        section.remove();
      });

      // Sections de travaux additionnels
      document.querySelectorAll('.porte-item, .fenetre-item, .divers-item, .plafond-item').forEach(item => {
        item.remove();
      });

      // Pr√©parations globales des pi√®ces
      document.querySelectorAll('[id^="prepGlobalList_"]').forEach(list => {
        list.innerHTML = '';
      });

      // ====== R√âINITIALISER LES AFFICHAGES DE R√âSULTATS ======
      // Surfaces
      const surfaceElements = [
        'surfaceTotaleInt',
        'surfaceTotaleExt'
      ];
      surfaceElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '0 ft¬≤';
      });

      // Co√ªts de produits
      const costElements = [
        'cost_appret_int',
        'cost_lifemaster_int',
        'cost_glidden_int',
        'totalProduitsInt',
        'costPreparation',
        'costPeinture',
        'costProduits',
        'fraisAdministratifs',
        'subTotal',
        'subTotalBreakdown',
        'totalCombine',
        'totalCombineInt',
        'tpsAmount',
        'tvqAmount'
      ];
      costElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '$0.00';
      });

      // Heures
      const heuresElements = [
        'totalHoursCombine',
        'appretGlobalHeures',
        'preparationGlobalHeures'
      ];
      heuresElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '0';
      });

      // Gallons
      const gallonsElements = [
        'appretGlobalGallons'
      ];
      gallonsElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '0';
      });

      // Co√ªts sp√©cifiques
      const specificCostElements = [
        'appretGlobalCoutProduit',
        'appretGlobalCoutMO',
        'preparationGlobalCoutMO'
      ];
      specificCostElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '$0.00';
      });

      // ====== R√âINITIALISER LES CONTENEURS DE PRODUITS ======
      const produitsInterieursContainer = document.querySelector('.produits-int-container');
      if (produitsInterieursContainer) {
        produitsInterieursContainer.innerHTML = '';
      }

      const produitsExterieursContainer = document.querySelector('.produits-ext-container');
      if (produitsExterieursContainer) {
        produitsExterieursContainer.innerHTML = '';
      }

      // ====== NETTOYER LE LOCALSTORAGE (sauf username/entrepreneur) ======
      const keysToKeep = ['username', 'userRole', 'selectedEntrepreneur', 'token'];
      const allKeys = Object.keys(localStorage);
      allKeys.forEach(key => {
        if (!keysToKeep.includes(key) && key.startsWith('calc_')) {
          localStorage.removeItem(key);
        }
      });

      // ====== RECALCULER POUR METTRE √Ä JOUR L'AFFICHAGE ======
      updateCalculation();

      log('[RESET] ‚úÖ Formulaire COMPL√àTEMENT r√©initialis√© - tout est √† z√©ro');
    }

    // Fonction interne pour charger un projet apr√®s le reload de la page
    async function chargerProjetInternal(projetId) {
      const username = localStorage.getItem('username') || 'default';

      try {
        // Activer le mode chargement pour d√©sactiver les notifications et le scroll
        isLoadingProject = true;
        log('[LOADING] Mode chargement activ√© - notifications et scroll d√©sactiv√©s');

        // D√©finir le projet actuellement charg√©
        currentLoadedProjectId = String(projetId);

        // Charger les projets depuis l'API
        const response = await fetch(`/api/projets/${username}`);
        if (!response.ok) {
          error('[ERROR] Erreur chargement projets:', response.status);
          alert('Erreur chargement projets');
          return;
        }

        const projets = await response.json();
        log('[PACKAGE] Projets charg√©s:', projets);

        const projet = projets.find(p => p.id === String(projetId));
        log('[TARGET] Projet trouv√©:', projet);

        if (!projet) {
          alert('Projet introuvable');
          return;
        }

        // Charger les donn√©es de base
        const formData = projet.formData;
        log('[NOTE] FormData √† restaurer:', formData);

        let restoredCount = 0;
        let notFoundCount = 0;

        // PRIORIT√â 1: Restaurer les sections dynamiques AVANT tout le reste
        // Calculer le temps total n√©cessaire pour tout charger
        let totalLoadingTime = 0;

        if (formData.lavagesSections) {
          restoreLavagesSections(formData.lavagesSections);
        }

        if (formData.preparationsSections) {
          restorePreparationsSections(formData.preparationsSections);
        }

        if (formData.primersSections) {
          restorePrimersSections(formData.primersSections);
        }

        if (formData.endroitsPeinturer) {
          // Calculer le temps n√©cessaire pour charger tous les endroits et sous-sections
          // OPTIMIS√â: d√©lais r√©duits de ~10x pour un chargement plus rapide
          formData.endroitsPeinturer.forEach((endroit, endroitIndex) => {
            const endroitTime = endroitIndex * 80 + 30; // Temps de base pour l'endroit (optimis√©)
            let maxSousSectionTime = 0;

            if (endroit.sousSections) {
              endroit.sousSections.forEach((sousSection, ssIndex) => {
                const sousSectionTime = ssIndex * 50 + 15 + 15 + 80; // Tous les setTimeout imbriqu√©s (optimis√©s)
                maxSousSectionTime = Math.max(maxSousSectionTime, sousSectionTime);
              });
            }

            totalLoadingTime = Math.max(totalLoadingTime, endroitTime + maxSousSectionTime);
          });

          // Ajouter un buffer de s√©curit√©
          totalLoadingTime += 200;

          log(`[TIMING] Temps de chargement calcul√©: ${totalLoadingTime}ms`);
          restoreEndroitsPeinturer(formData.endroitsPeinturer);
        }

        // Restaurer les pi√®ces int√©rieures AVANT les travaux additionnels
        if (formData.piecesInterieur) {
          piecesInterieur = formData.piecesInterieur;
          // Re-afficher les pi√®ces
          const listePieces = document.getElementById('listePieces');
          if (listePieces) {
            listePieces.innerHTML = '';
            piecesInterieur.forEach(piece => afficherPiece(piece));
          }
          log('[OK] Pi√®ces int√©rieures restaur√©es:', piecesInterieur.length);
        }

        // Restaurer les produits du tableau sauvegard√©s avec le projet
        if (formData.produitsTable && formData.produitsTable.length > 0) {
          populateProductsTable(formData.produitsTable);
          // Aussi sauvegarder dans localStorage pour synchroniser
          const saveKey = `estimationProducts_${username}`;
          localStorage.setItem(saveKey, JSON.stringify(formData.produitsTable));
          // Rafra√Æchir l'affichage des produits dans l'onglet Estimation
          if (typeof chargerProduitsExistants === 'function') {
            chargerProduitsExistants();
          }
          log('[OK] Produits tableau restaur√©s:', formData.produitsTable.length);
        }

        if (formData.travauxAdditionnels) {
          restoreTravauxAdditionnels(formData.travauxAdditionnels);
        }

        // Restaurer tous les champs inputs et selects
        Object.keys(formData).forEach(key => {
          if (key === 'surfaces' || key === 'endroits' || key === 'piecesInterieur' || key === 'produitsTable' || key === 'totaux_ext' || key === 'totaux_int' || key === 'ongletActif' || key === 'lavagesSections' || key === 'preparationsSections' || key === 'primersSections' || key === 'endroitsPeinturer' || key === 'travauxAdditionnels') {
            return; // Skip les donn√©es sp√©ciales, on les traite s√©par√©ment
          }

          // G√©rer les inputs dynamiques (sans ID)
          if (key.startsWith('dynamic_')) {
            const dynData = formData[key];
            if (dynData && dynData.section && dynData.type) {
              // Chercher l'input avec ces data-attributes
              const inputs = document.querySelectorAll(`[data-section="${dynData.section}"][data-type="${dynData.type}"]`);
              if (inputs.length > 0) {
                inputs.forEach(input => {
                  input.value = dynData.value;
                  restoredCount++;
                });
                log(`[OK] Input dynamique restaur√©: ${dynData.section} - ${dynData.type} = ${dynData.value}`);
              } else {
                notFoundCount++;
                warn(`[WARN] Input dynamique non trouv√©: ${dynData.section} - ${dynData.type}`);
              }
            }
            return;
          }

          const element = document.getElementById(key);
          if (element) {
            if (element.type === 'checkbox') {
              element.checked = formData[key];
            } else {
              element.value = formData[key];
            }
            restoredCount++;
          } else {
            notFoundCount++;
            warn(`[WARN] √âl√©ment non trouv√©: ${key}`);
          }
        });

        log(`[OK] √âl√©ments restaur√©s: ${restoredCount}, Non trouv√©s: ${notFoundCount}`);

        // Mettre √† jour les bordures des champs client pour qu'ils soient verts
        const clientFields = ['clientPrenom', 'clientNom', 'clientAddress', 'clientPhone'];
        clientFields.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field && field.value && field.value.trim()) {
            field.style.setProperty('border-right-color', '#4caf50', 'important');
            log(`[OK] Bordure verte appliqu√©e √† ${fieldId}`);
          }
        });

        // Mettre √† jour le message de validation client
        if (typeof updateClientValidationMessage === 'function') {
          updateClientValidationMessage();
          log('[OK] Message de validation client mis √† jour');
        }

      // Restaurer les surfaces ext√©rieures si elles existent
      if (formData.surfaces && typeof restoreSurfaceData === 'function') {
        restoreSurfaceData(formData.surfaces);
      }

      // Restaurer les endroits si ils existent
      if (formData.endroits && typeof restoreEndroitData === 'function') {
        restoreEndroitData(formData.endroits);
      }

      // Stocker les donn√©es client pour permettre "Compl√©ter soumission"
      sessionStorage.setItem('clientData', JSON.stringify({
        eventId: projet.id,
        prenom: projet.client.split(' ')[0] || '',
        nom: projet.client.split(' ').slice(1).join(' ') || '',
        adresse: projet.adresse,
        telephone: projet.telephone
      }));

      // Modifier le header pour indiquer qu'on modifie un projet existant
      const calculatorHeader = document.querySelector('.glass-card h1');
      if (calculatorHeader) {
        calculatorHeader.innerHTML = `Calculateur d'Estimation <span class="text-sm text-green-600">(modification: ${projet.client})</span>`;
      }

      // Attendre que TOUT soit compl√®tement charg√© avant de finaliser
      setTimeout(() => {
        // Recalculer tout pour mettre √† jour les totaux
        if (typeof updateCalculation === 'function') {
          updateCalculation();
        }
        if (typeof calculerInterieur === 'function') {
          calculerInterieur();
        }

        // D√©terminer l'onglet appropri√© bas√© sur les totaux du projet
        let tabName = 'estimation'; // Par d√©faut ext√©rieur

        const totalExtElement = document.getElementById('subTotal');
        const totalIntElement = document.getElementById('subTotalInt');

        const totalExt = parseFloat(totalExtElement?.textContent.replace('$', '').replace(/\s+/g, '').replace(',', '.').trim() || '0');
        const totalInt = parseFloat(totalIntElement?.textContent.replace('$', '').replace(/\s+/g, '').replace(',', '.').trim() || '0');

        log(`[DEBUG] Totaux projet apr√®s calculs: Ext=${totalExt}$, Int=${totalInt}$`);

        // Logique am√©lior√©e bas√©e sur le seuil de 400$:
        if (totalInt >= 400 && totalExt < 400) {
          tabName = 'interieur'; // Int√©rieur seulement
          log('üè† Projet int√©rieur uniquement d√©tect√© (Int >= 400$, Ext < 400$)');
        } else if (totalExt >= 400) {
          tabName = 'estimation'; // Ext√©rieur (avec ou sans int√©rieur)
          log('üèóÔ∏è Projet avec ext√©rieur d√©tect√© (Ext >= 400$)');
        } else {
          // Si les deux sont sous le seuil, aller vers le plus √©lev√©
          tabName = totalExt > totalInt ? 'estimation' : 'interieur';
          log(`üìä Projet sous seuil: ${tabName === 'estimation' ? 'Ext' : 'Int'} (plus √©lev√©)`);
        }

        log(`üîÑ Changement d'onglet vers: ${tabName}`);

        if (typeof switchTab === 'function') {
          // skipRefresh = true pour √©viter le double chargement des produits
          switchTab(tabName, true);
        }

        // Mettre √† jour automatiquement le projet avec les totaux et le type si manquants
        if (!projet.totalExt || !projet.totalInt || !projet.typeTravaux) {
          // Calculer le type
          let typeTravaux = '';
          if (totalExt >= 400 && totalInt >= 400) {
            typeTravaux = 'Ext et Int';
          } else if (totalExt >= 400) {
            typeTravaux = 'Ext';
          } else if (totalInt >= 400) {
            typeTravaux = 'Int';
          } else {
            typeTravaux = totalExt > totalInt ? 'Ext' : 'Int';
          }

          // Mettre √† jour le projet dans le backend
          const projetMisAJour = {
            ...projet,
            totalExt: totalExt,
            totalInt: totalInt,
            typeTravaux: typeTravaux
          };

          log('[AUTO-UPDATE] Mise √† jour automatique du projet avec totaux et type:', projetMisAJour);

          // Sauvegarder silencieusement
          fetch('/api/projets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: username,
              projet: projetMisAJour,
              updateExisting: true
            })
          }).then(response => {
            if (response.ok) {
              log('[AUTO-UPDATE] ‚úÖ Projet mis √† jour automatiquement avec les totaux et le type');
              // Rafra√Æchir la liste des projets si on est sur l'onglet Mes Projets
              if (typeof afficherListeProjets === 'function') {
                setTimeout(() => {
                  afficherListeProjets();
                  log('[AUTO-UPDATE] Liste des projets rafra√Æchie');
                }, 200);
              }
            }
          }).catch(err => {
            error('[AUTO-UPDATE] Erreur mise √† jour auto:', err);
          });
        }

        // Valider les boutons apr√®s le chargement des donn√©es client
        if (typeof validateCompleterButton === 'function') {
          validateCompleterButton();
        }

        log('[OK] Projet charg√© compl√®tement!');

        // D√©verrouiller les sections et activer l'auto-save puisqu'un projet est charg√©
        if (typeof unlockCalculationSections === 'function') {
          unlockCalculationSections();
        }
        isAutoSaveEnabled = true;
        sectionsUnlocked = true;

        // Verrouiller les champs client et changer le bouton en "Quitter le projet"
        if (typeof lockClientInfoFields === 'function') {
          lockClientInfoFields();
        }
        if (typeof enableCompleterButtons === 'function') {
          enableCompleterButtons();
        }
        const createBtn = document.getElementById('createProjectBtn');
        if (createBtn) {
          createBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Quitter le projet';
          createBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
          createBtn.onclick = quitProject;
          createBtn.disabled = false;
          createBtn.style.opacity = '1';
          createBtn.style.cursor = 'pointer';
        }
        // Cacher le message de validation
        const validationMsg = document.getElementById('clientInfoValidationMessage');
        if (validationMsg) {
          validationMsg.style.display = 'none';
        }
        // Afficher l'indicateur de sauvegarde
        if (typeof showAutoSaveStatus === 'function') {
          showAutoSaveStatus('saved');
        }
        // Afficher le bouton total mobile
        if (typeof updateMobileTotalButton === 'function') {
          updateMobileTotalButton();
        }

        // Forcer la position de scroll en haut (sans animation) pour √©viter tout scroll automatique
        window.scrollTo(0, 0);

        // D√©sactiver le mode chargement pour r√©activer les notifications et le scroll
        isLoadingProject = false;
        log('[LOADING] Mode chargement d√©sactiv√© - notifications et scroll r√©activ√©s');

        // Cacher l'animation de chargement SEULEMENT quand tout est termin√©
        hideLoadingAnimation();

      }, Math.max(totalLoadingTime, 300)); // OPTIMIS√â: minimum 300ms au lieu de 1000ms

      } catch (error) {
        error('[ERROR] Erreur chargement projet:', error);
        // D√©sactiver le mode chargement en cas d'erreur
        isLoadingProject = false;
        hideLoadingAnimation();
        alert('Erreur lors du chargement: ' + error.message);
      }
    }
    
    async function supprimerProjet(projetId) {
      showCustomConfirm(
        'Supprimer le projet',
        '√ätes-vous s√ªr de vouloir supprimer ce projet ? Cette action est irr√©versible.',
        'Supprimer',
        'Annuler',
        async function() {
          const username = localStorage.getItem('username') || 'default';

          try {
            const response = await fetch(`/api/projets/${username}/${projetId}`, {
              method: 'DELETE'
            });

            if (response.ok) {
              showNotification('Projet supprim√©', 'success');

              // Si le projet supprim√© est celui actuellement charg√©, r√©initialiser le calculateur
              if (currentLoadedProjectId === String(projetId)) {
                log('üßπ Projet supprim√© √©tait charg√©, r√©initialisation du calculateur');
                reinitialiserCalculateur();
                currentLoadedProjectId = null;
              }

              afficherListeProjets();
            } else {
              showNotification('Erreur lors de la suppression', 'error');
            }
          } catch (error) {
            error('Erreur suppression projet:', error);
            showNotification('Erreur lors de la suppression', 'error');
          }
        }
      );
    }
    
    function telechargerPDFProjet(projetId) {
      const username = localStorage.getItem('username') || 'default';
      const projets = JSON.parse(localStorage.getItem(`projetsQwota_${username}`) || '[]');
      const projet = projets.find(p => p.id === String(projetId));
      
      if (!projet) {
        showNotification('Projet introuvable', 'error');
        return;
      }
      
      // Sauvegarder l'√©tat actuel
      const currentData = collecterToutesDonnees();
      
      // Charger temporairement le projet
      chargerProjet(projetId);
      
      // G√©n√©rer le PDF
      setTimeout(() => {
        generatePDF();
        
        // Restaurer l'√©tat pr√©c√©dent apr√®s un d√©lai
        setTimeout(() => {
          Object.keys(currentData).forEach(key => {
            const element = document.getElementById(key);
            if (element) {
              if (element.type === 'checkbox') {
                element.checked = currentData[key];
              } else {
                element.value = currentData[key];
              }
            }
          });
          updateCalculation();
        }, 1000);
      }, 500);
    }
    
    async function afficherListeProjets() {
      const username = localStorage.getItem('username') || 'default';

      try {
        const response = await fetch(`/api/projets/${username}`);
        if (!response.ok) {
          error('Erreur chargement projets');
          return;
        }

        const projets = await response.json();
        const tbody = document.getElementById('projects-table-body');
        const mobileList = document.getElementById('projects-mobile-list');

      if (projets.length === 0) {
        // Vue desktop (tableau)
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="border: 1px solid var(--border-dark); px-4 py-8 text-center text-gray-500">
              <i class="fas fa-folder-open text-4xl mb-3 opacity-50"></i>
              <p class="text-lg font-medium">Aucun projet sauvegard√©</p>
              <p class="text-sm mt-2">Commencez par remplir les informations client pour cr√©er automatiquement un projet</p>
              <div class="flex justify-center mt-4 space-x-4 text-xs">
                <div class="flex items-center">
                  <i class="fas fa-save mr-1"></i>
                  Sauvegarder
                </div>
                <div class="flex items-center">
                  <i class="fas fa-edit mr-1"></i>
                  Modifier
                </div>
                <div class="flex items-center">
                  <i class="fas fa-file-pdf mr-1"></i>
                  Exporter PDF
                </div>
              </div>
            </td>
          </tr>
        `;

        // Vue mobile (cartes)
        mobileList.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-folder-open text-4xl mb-3 opacity-50 text-blue-400"></i>
            <p class="text-lg font-medium text-white">Aucun projet sauvegard√©</p>
            <p class="text-sm mt-2 text-gray-300">Commencez par remplir les informations client</p>
          </div>
        `;
        return;
      }

      // Vue desktop (tableau)
      tbody.innerHTML = projets.map(projet => {
        // D√©terminer le type de travaux si non existant (pour compatibilit√© avec anciens projets)
        let typeTravaux = projet.typeTravaux;

        // Si le type n'existe pas, le calculer √† partir des totaux dans formData
        if (!typeTravaux || typeTravaux === 'N/A') {
          let prixExt = parseFloat(projet.totalExt || 0);
          let prixInt = parseFloat(projet.totalInt || 0);

          // Si totalExt/totalInt n'existent pas, essayer de lire depuis formData
          if (prixExt === 0 && prixInt === 0 && projet.formData) {
            const totalExtStr = projet.formData.totaux_ext?.total || '0';
            const totalIntStr = projet.formData.totaux_int?.total || '0';

            prixExt = parseFloat(String(totalExtStr).replace(/[$\s]/g, '').replace(',', '.') || '0');
            prixInt = parseFloat(String(totalIntStr).replace(/[$\s]/g, '').replace(',', '.') || '0');
          }

          // Appliquer la m√™me logique que lors de la sauvegarde
          if (prixExt >= 400 && prixInt >= 400) {
            typeTravaux = 'Ext et Int';
          } else if (prixExt >= 400) {
            typeTravaux = 'Ext';
          } else if (prixInt >= 400) {
            typeTravaux = 'Int';
          } else if (prixExt > 0 || prixInt > 0) {
            typeTravaux = prixExt > prixInt ? 'Ext' : 'Int';
          } else {
            typeTravaux = 'N/A';
          }
        }

        return `
        <tr class="hover:bg-slate-700/50">
          <td class="border: 1px solid var(--border-dark); px-4 py-3">
            <div class="text-sm font-medium text-white">${projet.client || 'Client'}</div>
            <div class="text-xs text-gray-500">${projet.telephone || ''}</div>
          </td>
          <td class="border: 1px solid var(--border-dark); px-4 py-3 text-sm text-white">
            ${projet.dateCreation ? (projet.dateCreation.includes('/') ? projet.dateCreation : new Date(projet.dateCreation).toLocaleDateString('fr-FR')) : 'N/A'}
          </td>
          <td class="border: 1px solid var(--border-dark); px-4 py-3 text-center">
            <span class="px-3 py-1 rounded-full text-xs font-semibold" style="background: ${typeTravaux === 'Ext et Int' ? 'rgba(168, 85, 247, 0.2)' : typeTravaux === 'Ext' ? 'rgba(59, 130, 246, 0.2)' : 'rgba(16, 185, 129, 0.2)'}; color: ${typeTravaux === 'Ext et Int' ? '#a855f7' : typeTravaux === 'Ext' ? '#3b82f6' : '#10b981'}; border: 1px solid ${typeTravaux === 'Ext et Int' ? 'rgba(168, 85, 247, 0.3)' : typeTravaux === 'Ext' ? 'rgba(59, 130, 246, 0.3)' : 'rgba(16, 185, 129, 0.3)'};">
              ${typeTravaux}
            </span>
          </td>
          <td class="border: 1px solid var(--border-dark); px-4 py-3 text-sm font-medium text-white">
            ${formatCurrency(projet.total || 0)}
          </td>
          <td class="border: 1px solid var(--border-dark); px-4 py-3 text-center">
            <div class="flex justify-center gap-2">
              <button onclick="chargerProjet(${projet.id})"
                      class="btn-primary"
                      style="font-size: 11px !important; padding: 4px 8px !important;"
                      title="Charger">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="supprimerProjet(${projet.id})"
                      class="btn-secondary"
                      style="font-size: 11px !important; padding: 4px 8px !important;"
                      title="Supprimer">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `}).join('');

      // Vue mobile (cartes)
      mobileList.innerHTML = projets.map(projet => {
        let typeTravaux = projet.typeTravaux;

        // Si le type n'existe pas, le calculer √† partir des totaux dans formData
        if (!typeTravaux || typeTravaux === 'N/A') {
          let prixExt = parseFloat(projet.totalExt || 0);
          let prixInt = parseFloat(projet.totalInt || 0);

          // Si totalExt/totalInt n'existent pas, essayer de lire depuis formData
          if (prixExt === 0 && prixInt === 0 && projet.formData) {
            const totalExtStr = projet.formData.totaux_ext?.total || '0';
            const totalIntStr = projet.formData.totaux_int?.total || '0';

            prixExt = parseFloat(String(totalExtStr).replace(/[$\s]/g, '').replace(',', '.') || '0');
            prixInt = parseFloat(String(totalIntStr).replace(/[$\s]/g, '').replace(',', '.') || '0');
          }

          // Appliquer la m√™me logique que lors de la sauvegarde
          if (prixExt >= 400 && prixInt >= 400) {
            typeTravaux = 'Ext et Int';
          } else if (prixExt >= 400) {
            typeTravaux = 'Ext';
          } else if (prixInt >= 400) {
            typeTravaux = 'Int';
          } else if (prixExt > 0 || prixInt > 0) {
            typeTravaux = prixExt > prixInt ? 'Ext' : 'Int';
          } else {
            typeTravaux = 'N/A';
          }
        }

        return `
        <div class="project-mobile-card" onclick="openProjectDetails(${projet.id}, '${(projet.client || 'Client').replace(/'/g, "\\'")}', '${projet.telephone || ''}', ${projet.total || 0}, '${projet.dateCreation ? new Date(projet.dateCreation).toLocaleDateString('fr-FR') : 'N/A'}', '${typeTravaux}')">
          <div class="project-card-header">
            <div style="flex: 1;">
              <div class="project-card-title">${projet.client || 'Client'}</div>
              ${projet.telephone ? `<div class="project-card-phone"><i class="fas fa-phone mr-1"></i>${projet.telephone}</div>` : ''}
            </div>
            <div class="project-card-total">${formatCurrency(projet.total || 0)}</div>
          </div>
          <div class="project-card-info">
            <div class="project-card-date">
              <i class="fas fa-calendar mr-1"></i>${projet.dateCreation ? new Date(projet.dateCreation).toLocaleDateString('fr-FR') : 'N/A'}
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span class="px-2 py-1 rounded-full text-xs font-semibold" style="background: ${typeTravaux === 'Ext et Int' ? 'rgba(168, 85, 247, 0.2)' : typeTravaux === 'Ext' ? 'rgba(59, 130, 246, 0.2)' : 'rgba(16, 185, 129, 0.2)'}; color: ${typeTravaux === 'Ext et Int' ? '#a855f7' : typeTravaux === 'Ext' ? '#3b82f6' : '#10b981'}; border: 1px solid ${typeTravaux === 'Ext et Int' ? 'rgba(168, 85, 247, 0.3)' : typeTravaux === 'Ext' ? 'rgba(59, 130, 246, 0.3)' : 'rgba(16, 185, 129, 0.3)'};">
                ${typeTravaux}
              </span>
            </div>
            <div class="project-card-actions">
              <button class="project-action-btn edit-btn" onclick="event.stopPropagation(); chargerProjet(${projet.id})">
                <i class="fas fa-edit"></i>
              </button>
              <button class="project-action-btn delete-btn" onclick="event.stopPropagation(); supprimerProjet(${projet.id})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `}).join('');
      } catch (error) {
        error('Erreur affichage projets:', error);
      }
    }

    // Fonction pour ouvrir le popup de d√©tails du projet (mobile)
    function openProjectDetails(id, client, telephone, total, date, typeTravaux = 'N/A') {
      const overlay = document.getElementById('project-details-overlay');
      const body = document.getElementById('project-details-body');
      const title = document.getElementById('project-details-title');

      if (!overlay || !body || !title) return;

      title.textContent = client;

      body.innerHTML = `
        <div class="space-y-4">
          <div class="p-4 rounded-lg" style="background: var(--bg-card); border: 1px solid var(--border-dark);">
            <div class="flex items-center justify-between mb-3">
              <span class="text-sm text-gray-400">Total du projet</span>
              <span class="text-2xl font-bold" style="color: var(--primary-green);">${formatCurrency(total)}</span>
            </div>
            ${telephone ? `
            <div class="flex items-center gap-2 text-sm text-gray-300 mb-2">
              <i class="fas fa-phone" style="color: var(--primary-orange);"></i>
              <span>${telephone}</span>
            </div>
            ` : ''}
            <div class="flex items-center gap-2 text-sm text-gray-300 mb-2">
              <i class="fas fa-calendar" style="color: var(--primary-blue);"></i>
              <span>${date}</span>
            </div>
            <div class="flex items-center gap-2 text-sm text-gray-300">
              <i class="fas fa-briefcase" style="color: var(--primary-purple);"></i>
              <span class="px-3 py-1 rounded-full text-xs font-semibold" style="background: ${typeTravaux === 'Ext et Int' ? 'rgba(168, 85, 247, 0.2)' : typeTravaux === 'Ext' ? 'rgba(59, 130, 246, 0.2)' : 'rgba(16, 185, 129, 0.2)'}; color: ${typeTravaux === 'Ext et Int' ? '#a855f7' : typeTravaux === 'Ext' ? '#3b82f6' : '#10b981'}; border: 1px solid ${typeTravaux === 'Ext et Int' ? 'rgba(168, 85, 247, 0.3)' : typeTravaux === 'Ext' ? 'rgba(59, 130, 246, 0.3)' : 'rgba(16, 185, 129, 0.3)'};">
                ${typeTravaux}
              </span>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <button onclick="closeProjectDetails(); chargerProjet(${id})" class="btn-primary" style="width: 100%; justify-content: center;">
              <i class="fas fa-edit mr-2"></i>Charger
            </button>
            <button onclick="closeProjectDetails(); supprimerProjet(${id})" class="btn-secondary" style="width: 100%; justify-content: center; background: rgba(239, 68, 68, 0.2); border-color: #ef4444; color: #ef4444;">
              <i class="fas fa-trash mr-2"></i>Supprimer
            </button>
          </div>
        </div>
      `;

      overlay.style.display = 'flex';
      document.body.classList.add('popup-open');
    }

    // Fonction pour fermer le popup de d√©tails du projet
    function closeProjectDetails(event) {
      if (event && event.target.closest('.total-popup-content')) {
        return;
      }

      const overlay = document.getElementById('project-details-overlay');
      if (overlay) {
        overlay.style.display = 'none';
      }

      document.body.classList.remove('popup-open');
    }
    
    function mettreAJourStatistiques(projets) {
      // Total des projets
      if (document.getElementById('totalProjets')) {
        document.getElementById('totalProjets').textContent = projets.length;
      }
      
      // Valeur totale
      const valeurTotale = projets.reduce((total, projet) => 
        total + (projet.total || 0), 0
      );
      if (document.getElementById('valeurTotale')) {
        document.getElementById('valeurTotale').textContent = formatCurrency(valeurTotale);
      }
      
      // Projet le plus r√©cent
      if (projets.length > 0) {
        const projetRecent = projets.reduce((recent, projet) => {
          const projetDate = projet.dateCreation ? new Date(projet.dateCreation) : new Date(0);
          const recentDate = recent.dateCreation ? new Date(recent.dateCreation) : new Date(0);
          return projetDate > recentDate ? projet : recent;
        });
        if (document.getElementById('projetRecent')) {
          document.getElementById('projetRecent').textContent = projetRecent.client;
        }
      } else {
        if (document.getElementById('projetRecent')) {
          document.getElementById('projetRecent').textContent = '-';
        }
      }
    }
    
    async function exporterTousProjets() {
      const username = localStorage.getItem('username') || 'default';

      try {
        const response = await fetch(`/api/projets/${username}`);
        if (!response.ok) {
          showNotification('Erreur chargement projets', 'error');
          return;
        }

        const projets = await response.json();
      
      if (projets.length === 0) {
        showNotification('Aucun projet √† exporter', 'warning');
        return;
      }
      
      const dataStr = JSON.stringify(projets, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = 'projets-qwota-' + new Date().toISOString().split('T')[0] + '.json';
      link.click();
      
      URL.revokeObjectURL(url);
      showNotification('Projets export√©s avec succ√®s!', 'success');
      } catch (error) {
        error('Erreur export projets:', error);
        showNotification('Erreur lors de l\'export', 'error');
      }
    }
    
    function importerProjets() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const nouveauxProjets = JSON.parse(e.target.result);
            
            if (!Array.isArray(nouveauxProjets)) {
              alert('Format de fichier invalide');
              return;
            }
            
            // Fusionner avec les projets existants
            const projetsExistants = JSON.parse(localStorage.getItem('projetsQwota') || '[]');
            const projetsComplets = [...projetsExistants, ...nouveauxProjets];
            
            localStorage.setItem('projetsQwota', JSON.stringify(projetsComplets));
            afficherListeProjets();
            
            showNotification(`${nouveauxProjets.length} projet(s) import√©(s) avec succ√®s!`, 'success');
          } catch (error) {
            showNotification('Erreur lors de l\'import du fichier', 'error');
          }
        };
        reader.readAsText(file);
      };
      
      input.click();
    }

  </script>
  

  <!-- Script pour gestion menu actif -->
  <script>
    // Fonction pour activer le menu bas√© sur la page actuelle
    function activateCurrentPageMenu() {
      // D√©tecter la page actuelle
      const currentPath = window.location.pathname;
      log('üåê Page actuelle d√©tect√©e:', currentPath);
      
      // Enlever la classe menu-active de tous les liens
      const allMenuLinks = document.querySelectorAll('#sidebar a');
      allMenuLinks.forEach(link => {
        link.classList.remove('menu-active');
        link.removeAttribute('data-menu-state');
      });
      
      // D√©terminer quel lien activer bas√© sur la page
      let targetLink = null;
      if (currentPath === '/calcul') {
        targetLink = document.querySelector('#sidebar a[data-path="/calcul"]');
        log('[TARGET] Page Calculateur d√©tect√©e - activation du menu calculateur');
      } else if (currentPath === '/centrale') {
        targetLink = document.querySelector('#sidebar a[data-path="/centrale"]');
        log('[TARGET] Page Centrale d√©tect√©e - activation du menu admin');
      }
      
      // Activer le lien correspondant
      if (targetLink) {
        targetLink.classList.add('menu-active');
        targetLink.setAttribute('data-menu-state', 'active');
        
        log('[OK] Menu activ√© pour:', targetLink.textContent.trim());
        log('[DEBUG] Classes actuelles:', targetLink.className);
      } else {
        log('[WARN] Aucun menu trouv√© pour la page:', currentPath);
      }
    }

    // S'assurer que le menu correct reste actif selon la page
    document.addEventListener('DOMContentLoaded', function() {
      activateCurrentPageMenu();
      
      // Re-activer apr√®s un d√©lai pour contrer les autres scripts
      setTimeout(activateCurrentPageMenu, 150);
      setTimeout(activateCurrentPageMenu, 300);
    });
  </script>

  <!-- Script de gestion des clients Google Agenda -->
  <script>
  // Fonction pour r√©cup√©rer la blacklist des event IDs bannis
  async function getBlacklistedEventIds() {
    if (!window.username) return [];
    
    try {
      const response = await fetch(`${window.location.origin}/blacklist-event-ids?username=${window.username}`);
      if (response.ok) {
        const data = await response.json();
        return data.blacklisted_event_ids || [];
      }
    } catch (error) {
      error("Erreur lors du chargement de la blacklist des IDs:", error);
    }
    return [];
  }

  // Fonction pour v√©rifier si un client est banni par son ID unique
  function isEventIdBlacklisted(eventId, blacklistedEventIds) {
    return blacklistedEventIds.some(item => {
      return item.event_id === eventId;
    });
  }

  // Attendre que common.js soit initialis√©
  async function initClientsPage() {
    if (window.username) {
      // ‚ö° V√âRIFIER si on doit charger les clients (seulement pour entrepreneur ou coach/direction avec s√©lection)
      const userRole = localStorage.getItem('userRole');
      const isCoach = userRole === 'coach' || userRole === 'direction';
      const urlParams = new URLSearchParams(window.location.search);
      const userParam = urlParams.get('user');

      // V√©rifier si un entrepreneur est s√©lectionn√©
      const hasSelection = userParam && userParam !== localStorage.getItem('username');

      // ‚ö° NE PAS charger si coach/direction SANS s√©lection entrepreneur
      if (isCoach && !hasSelection) {
        log('[CALCUL] Coach/Direction sans s√©lection - clients √† compl√©ter non charg√©s');
        return; // Arr√™ter ici
      }

      try {
        // R√©cup√©rer les clients √† compl√©ter ET la blacklist des IDs en parall√®le
        const [clientsResponse, blacklistedEventIds] = await Promise.all([
          fetch(`${window.location.origin}/evenements-a-completer?username=${window.username}`),
          getBlacklistedEventIds()
        ]);

        const clientsData = await clientsResponse.json();
        log("CLIENTS DATA:", clientsData);
        log("BLACKLISTED EVENT IDS:", blacklistedEventIds);
        
        const tbody = document.getElementById("clients-body");
        const mobileList = document.getElementById("mobile-clients-list");
        tbody.innerHTML = "";
        mobileList.innerHTML = "";

        if (clientsData && clientsData.length > 0) {
          // Filtrer les clients non bannis par ID unique
          const filteredClients = clientsData.filter(ev => {
            const isBanned = isEventIdBlacklisted(ev.id, blacklistedEventIds);
            log(`[DEBUG] V√©rification client ${ev.prenom} ${ev.nom} - ID: ${ev.id} - Banni: ${isBanned}`);
            if (isBanned) {
              log(`üö´ Client banni filtr√© par ID: ${ev.id} (${ev.prenom} ${ev.nom})`);
            }
            return !isBanned;
          });

          log(`[DATA] Clients affich√©s: ${filteredClients.length}/${clientsData.length} (${clientsData.length - filteredClients.length} bannis)`);

          // Mettre √† jour le compteur de clients
          const clientCounter = document.querySelector('.px-3.py-1.rounded-full.text-xs.font-medium');
          if (clientCounter) {
            clientCounter.textContent = `${filteredClients.length} client(s)`;
          }

          if (filteredClients.length > 0) {
            filteredClients.forEach((ev, index) => {
              // Ajouter ligne tableau (desktop)
              const row = document.createElement("tr");
              row.dataset.eventId = ev.id;

              row.innerHTML = `
                <td>${ev.prenom}</td>
                <td>${ev.nom}</td>
                <td>${ev.adresse}</td>
                <td>${ev.telephone}</td>
                <td class="text-center">
                  <button class="btn-primary" onclick="startCalculationForClient('${ev.id}', '${(ev.prenom || '').replace(/'/g, '\\\'').replace(/"/g, '\\"')}', '${(ev.nom || '').replace(/'/g, '\\\'').replace(/"/g, '\\"')}', '${(ev.adresse || '').replace(/'/g, '\\\'').replace(/"/g, '\\"')}', '${(ev.telephone || '').replace(/'/g, '\\\'').replace(/"/g, '\\"')}')">
                    <i class="fas fa-play mr-1"></i>Compl√©ter
                  </button>
                </td>
              `;
              tbody.appendChild(row);

              // Ajouter item mobile
              const mobileItem = document.createElement("div");
              mobileItem.className = "mobile-client-item";
              mobileItem.dataset.clientIndex = index;
              mobileItem.onclick = function() {
                openClientSelectionPopupWithData(filteredClients);
              };

              mobileItem.innerHTML = `
                <div class="mobile-client-item-icon">
                  <i class="fas fa-user"></i>
                </div>
                <div class="mobile-client-item-info">
                  <h4>${ev.prenom} ${ev.nom}</h4>
                </div>
                <i class="fas fa-chevron-right mobile-client-item-arrow"></i>
              `;
              mobileList.appendChild(mobileItem);
            });

            // Afficher la liste mobile
            mobileList.style.display = "block";
          } else {
            // Tous les clients sont bannis
            // Mettre √† jour le compteur de clients
            const clientCounter = document.querySelector('.px-3.py-1.rounded-full.text-xs.font-medium');
            if (clientCounter) {
              clientCounter.textContent = `0 client(s)`;
            }

            tbody.innerHTML = `
              <tr>
                <td colspan="5" class="empty-state">
                  <i class="fas fa-calendar-times"></i>
                  <p>Aucun client √† compl√©ter aujourd'hui</p>
                </td>
              </tr>
            `;

            // Message pour mobile
            mobileList.innerHTML = `
              <div style="padding: 2rem 1rem; text-align: center; color: var(--text-gray);">
                <i class="fas fa-calendar-times" style="font-size: 2rem; opacity: 0.5; margin-bottom: 1rem; display: block;"></i>
                <p style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.5rem;">Aucun client √† compl√©ter aujourd'hui</p>
                <p style="font-size: 0.75rem;">Les clients de votre Google Agenda appara√Ætront ici</p>
              </div>
            `;
            mobileList.style.display = "block";
          }
        } else {
          // Afficher un message quand il n'y a aucun client (m√™me style que projets sauvegard√©s)
          // Mettre √† jour le compteur de clients
          const clientCounter = document.querySelector('.px-3.py-1.rounded-full.text-xs.font-medium');
          if (clientCounter) {
            clientCounter.textContent = `0 client(s)`;
          }

          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <p>Aucun client √† compl√©ter aujourd'hui</p>
              </td>
            </tr>
          `;

          // Message pour mobile
          mobileList.innerHTML = `
            <div style="padding: 2rem 1rem; text-align: center; color: var(--text-gray);">
              <i class="fas fa-calendar-times" style="font-size: 2rem; opacity: 0.5; margin-bottom: 1rem; display: block;"></i>
              <p style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.5rem;">Aucun client √† compl√©ter aujourd'hui</p>
              <p style="font-size: 0.75rem;">Les clients de votre Google Agenda appara√Ætront ici</p>
            </div>
          `;
          mobileList.style.display = "block";
        }
      } catch (error) {
        error("Erreur lors du chargement des clients:", error);
        // Afficher un message d'erreur dans le tableau
        const tbody = document.getElementById("clients-body");
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="empty-state" style="color: var(--primary-red);">
              <i class="fas fa-exclamation-triangle"></i>
              <p>Erreur lors du chargement des clients</p>
            </td>
          </tr>
        `;
      }
    }
  }

  function startCalculationForClient(eventId, prenom, nom, adresse, telephone) {
    // Stocker les informations client pour les utiliser apr√®s le calcul
    sessionStorage.setItem('clientData', JSON.stringify({
      eventId: eventId,
      prenom: prenom,
      nom: nom,
      adresse: adresse,
      telephone: telephone
    }));

    // Remplir automatiquement les champs du formulaire client
    const clientPrenomField = document.getElementById('clientPrenom');
    const clientNomField = document.getElementById('clientNom');
    const clientAddressField = document.getElementById('clientAddress');
    const clientPhoneField = document.getElementById('clientPhone');

    if (clientPrenomField) {
      clientPrenomField.value = prenom;
      // Mettre la bordure en vert si rempli
      if (prenom && prenom.trim()) {
        clientPrenomField.style.setProperty('border-right-color', '#4caf50', 'important');
      }
    }
    if (clientNomField) {
      clientNomField.value = nom;
      if (nom && nom.trim()) {
        clientNomField.style.setProperty('border-right-color', '#4caf50', 'important');
      }
    }
    if (clientAddressField) {
      clientAddressField.value = adresse;
      if (adresse && adresse.trim()) {
        clientAddressField.style.setProperty('border-right-color', '#4caf50', 'important');
      }
    }
    if (clientPhoneField) {
      clientPhoneField.value = telephone;
      if (telephone && telephone.trim()) {
        clientPhoneField.style.setProperty('border-right-color', '#4caf50', 'important');
      }
    }

    // Mettre √† jour le message de validation et les boutons apr√®s un petit d√©lai
    setTimeout(() => {
      if (typeof updateClientValidationMessage === 'function') {
        updateClientValidationMessage();
      }
      if (typeof validateCompleterButton === 'function') {
        validateCompleterButton();
      }
    }, 100);

    // Ajouter une indication visuelle dans le header
    const calculatorHeader = document.querySelector('.glass-card h1');
    if (calculatorHeader) {
      calculatorHeader.innerHTML = `Calculateur d'Estimation <span class="text-sm text-blue-600">(pour ${prenom} ${nom})</span>`;
    }

    // Pas de scroll - l'utilisateur reste o√π il est
  }

  function completeSubmission() {
    // V√©rifier s'il y a des donn√©es client stock√©es
    const clientData = sessionStorage.getItem('clientData');
    
    if (!clientData) {
      alert('Veuillez d\'abord s√©lectionner un client √† compl√©ter dans la liste ci-dessus.');
      return;
    }
    
    // FORCER le recalcul pour s'assurer que les totaux sont √† jour
    updateCalculation();
    
    // Attendre un petit d√©lai pour que les calculs se terminent
    setTimeout(() => {
      completeSubmissionWithCalculation(clientData);
    }, 300);
  }

  async function completeSubmissionWithCalculation(clientData) {
    // R√©cup√©rer le prix calcul√© avec logique de seuil minimum 400$
    const totalExtElement = document.getElementById('subTotal');
    const totalIntElement = document.getElementById('subTotalInt');

    log('[DEBUG] Debug √©l√©ments:', {
      totalExtElement: totalExtElement,
      totalIntElement: totalIntElement,
      totalExtText: totalExtElement?.textContent,
      totalIntText: totalIntElement?.textContent
    });

    // Nettoyer les valeurs: "401,45 $" -> "401.45"
    const totalExt = totalExtElement?.textContent.replace('$', '').replace(',', '.').replace(/\s+/g, '').trim() || '0';
    const totalInt = totalIntElement?.textContent.replace('$', '').replace(',', '.').replace(/\s+/g, '').trim() || '0';

    log('[DEBUG] Apr√®s nettoyage:', {
      totalExt: totalExt,
      totalInt: totalInt
    });

    const prixExt = parseFloat(totalExt) || 0;
    const prixInt = parseFloat(totalInt) || 0;

    log('[DEBUG] Apr√®s parseFloat:', {
      prixExt: prixExt,
      prixInt: prixInt
    });

    // Logique de seuil: seulement les travaux >= 400$ sont compt√©s
    let prix = 0;
    let typeTravauxText = '';
    let itemTravaux = '';

    if (prixExt >= 400 && prixInt >= 400) {
      // Les deux d√©passent 400$ = travaux ext√©rieur + int√©rieur
      prix = prixExt + prixInt;
      typeTravauxText = ' (Ext. + Int.)';
      itemTravaux = 'Travaux int√©rieurs et ext√©rieurs';
    } else if (prixExt >= 400) {
      // Seulement ext√©rieur d√©passe 400$ = travaux ext√©rieur uniquement
      prix = prixExt;
      typeTravauxText = ' (Ext√©rieur seulement)';
      itemTravaux = 'Travaux ext√©rieurs';
    } else if (prixInt >= 400) {
      // Seulement int√©rieur d√©passe 400$ = travaux int√©rieur uniquement
      prix = prixInt;
      typeTravauxText = ' (Int√©rieur seulement)';
      itemTravaux = 'Travaux int√©rieurs';
    } else {
      // Aucun ne d√©passe 400$ = prendre le plus √©lev√©
      prix = Math.max(prixExt, prixInt);
      typeTravauxText = prixExt > prixInt ? ' (Ext. - sous seuil)' : ' (Int. - sous seuil)';
      itemTravaux = prixExt > prixInt ? 'Travaux ext√©rieurs' : 'Travaux int√©rieurs';
    }

    log(`[MONEY] Calcul prix: Ext=${prixExt}$ Int=${prixInt}$ -> Final=${prix}$${typeTravauxText}`);

    log('[DEBUG] Prix final qui sera sauvegard√©:', prix, 'Type:', typeof prix);

    // R√©cup√©rer les donn√©es client
    const client = JSON.parse(clientData);
    const clientName = `${client.prenom} ${client.nom}`;
    const clientAddress = client.adresse;

    // NOUVEAU: Sauvegarder le projet dans "Mes Projets" (API Cloud)
    const username = localStorage.getItem('username') || 'default';
    const projet = {
      id: Date.now().toString(), // ID unique bas√© sur timestamp
      client: clientName,
      adresse: clientAddress,
      telephone: client.telephone,
      dateCreation: (() => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${day}/${month}/${year}`;
      })(),
      total: parseFloat(prix) || 0,
      // Sauvegarder tous les champs du calculateur
      formData: collecterToutesDonnees()
    };

    // Sauvegarder dans le cloud via API
    try {
      const response = await fetch('/api/projets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: username,
          projet: projet
        })
      });

      if (response.ok) {
        log('[OK] Projet sauvegard√© dans le cloud');
      } else {
        error('[ERROR] Erreur sauvegarde projet');
      }
    } catch (error) {
      error('[ERROR] Erreur API sauvegarde projet:', error);
    }
    
    // Arrondir au 5 ou 10 sup√©rieur (882.09 -> 885, 887 -> 890)
    const prixBase = Math.ceil(parseFloat(prix));
    const dernierChiffre = prixBase % 10;
    
    let prixArrondi;
    if (dernierChiffre === 0) {
      prixArrondi = prixBase; // D√©j√† arrondi √† 10
    } else if (dernierChiffre <= 5) {
      prixArrondi = prixBase - dernierChiffre + 5; // Arrondir au 5
    } else {
      prixArrondi = prixBase - dernierChiffre + 10; // Arrondir au 10 suivant
    }
    
    log(`üî¢ Prix arrondi au 5/10: ${prix} -> ${prixBase} -> ${prixArrondi}`);
    log(`üèóÔ∏è Type de travaux d√©tect√©: "${itemTravaux}"`);
    
    // Calculer la dur√©e des travaux bas√©e sur le prix (1000$ = 1 √† 1.5 jours)
    let dureeTravaux = '';
    if (prixArrondi > 0) {
      // 1 jour par tranche de 1000$ (minimum)
      const joursMin = prixArrondi / 1000;
      const joursMinArrondi = joursMin % 1 >= 0.5 ? Math.ceil(joursMin) : Math.floor(joursMin);

      // 1.5 jours par tranche de 1000$ (maximum)
      const joursMax = (prixArrondi / 1000) * 1.5;
      const joursMaxArrondi = joursMax % 1 >= 0.5 ? Math.ceil(joursMax) : Math.floor(joursMax);

      // Minimum 1 jour
      const joursMinFinal = Math.max(1, joursMinArrondi);
      const joursMaxFinal = Math.max(1, joursMaxArrondi);

      if (joursMinFinal === joursMaxFinal) {
        dureeTravaux = `${joursMinFinal} jour${joursMinFinal > 1 ? 's' : ''}`;
      } else {
        dureeTravaux = `${joursMinFinal}-${joursMaxFinal} jours`;
      }

      log(`[TIME] Calcul dur√©e: ${prixArrondi}$ -> ${joursMinFinal}j min, ${joursMaxFinal}j max -> "${dureeTravaux}"`);
    }
    
    // Stocker le prix calcul√© pour le pr√©remplissage de la soumission
    const submissionData = {
      ...client,
      prix: prixArrondi,
      temps: dureeTravaux
    };
    
    sessionStorage.setItem('submissionData', JSON.stringify(submissionData));
    
    // Programmer une r√©initialisation en background apr√®s la redirection
    // Cela permettra d'avoir un calculateur propre quand on revient
    setTimeout(() => {
      // Marquer que le calculateur doit √™tre r√©initialis√© au retour
      localStorage.setItem('shouldResetCalculator', 'true');
    }, 1000);

    // Rediriger vers la page de soumission via le routeur parent
    if (window.parent && window.parent !== window) {
      // On est dans un iframe - utiliser le hash du parent pour d√©clencher le routeur
      window.parent.location.hash = '#/soumissions';
    } else {
      // Fallback si pas dans un iframe
      window.location.href = '/soumissions';
    }
  }


  // Fonction globale pour compl√©ter soumission (appel√©e depuis le bouton)
  window.completerSoumission = async function() {
    // R√©cup√©rer les co√ªts actuels avec nettoyage correct (comme calcul.html)
    const totalExtElement = document.getElementById('subTotal');
    const totalIntElement = document.getElementById('subTotalInt');
    const totalCombineElement = document.getElementById('totalCombine');

    // Nettoyer les valeurs: "664,47 $" -> "664.47" (garder la virgule d√©cimale)
    const totalExt = totalExtElement?.textContent.replace('$', '').replace(/\s+/g, '').replace(',', '.').trim() || '0';
    const totalInt = totalIntElement?.textContent.replace('$', '').replace(/\s+/g, '').replace(',', '.').trim() || '0';
    const totalCombine = totalCombineElement?.textContent.replace('$', '').replace(/\s+/g, '').replace(',', '.').trim() || '0';

    const prixExt = parseFloat(totalExt) || 0;
    const prixInt = parseFloat(totalInt) || 0;
    const prixTotal = parseFloat(totalCombine) || 0; // Utiliser le Total des travaux (min 800$)

    log('[DEBUG] DEBUG LECTURE PRIX:', {
      extText: totalExtElement?.textContent,
      intText: totalIntElement?.textContent,
      extCleaned: totalExt,
      intCleaned: totalInt,
      prixExt: prixExt,
      prixInt: prixInt
    });

    if (prixTotal <= 0) {
      alert('Veuillez d\'abord faire un calcul avant de cr√©er une soumission.');
      return;
    }

    // R√©cup√©rer les infos client si disponibles
    const clientPrenom = document.getElementById('clientPrenom')?.value || '';
    const clientNom = document.getElementById('clientNom')?.value || '';
    const clientAddress = document.getElementById('clientAddress')?.value || '';
    const clientPhone = document.getElementById('clientPhone')?.value || '';

    // V√©rifier si l'adresse a √©t√© s√©lectionn√©e depuis Google dropdown
    // Exception: si les champs ont √©t√© pr√©-remplis depuis "Client √† compl√©ter aujourd'hui" OU depuis prospect
    const clientData = sessionStorage.getItem('clientData');
    const submissionDataStr = sessionStorage.getItem('submissionData');
    let fromProspect = false;

    if (submissionDataStr) {
      try {
        const submissionDataObj = JSON.parse(submissionDataStr);
        fromProspect = submissionDataObj.fromProspect === true;
      } catch (e) {}
    }

    // Validation d'adresse simplifi√©e: accepter si l'adresse a un format valide (contient chiffres, lettres, virgule)
    // Cela √©vite de bloquer les adresses pr√©-remplies depuis prospects/ventes
    const addressHasValidFormat = clientAddress && /\d+.*[a-zA-Z].*,/.test(clientAddress);

    const isPrefilled = clientData !== null || fromProspect; // Si clientData existe OU fromProspect=true, les champs sont pr√©-remplis

    // V√©rifier aussi si l'adresse a la bordure verte (pr√©-remplie depuis prospect/ventes)
    const addressField = document.getElementById('clientAddress');
    const hasGreenBorder = addressField && addressField.style.borderRightColor === 'rgb(76, 175, 80)';

    // Si les champs client sont tous remplis, c'est probablement un pr√©-remplissage (prospect/vente)
    const allClientFieldsFilled = clientPrenom.trim() && clientNom.trim() && clientAddress.trim();

    // Debug logging
    console.log('[VALIDATION ADRESSE]', {
      clientAddress,
      googleSelected: window.googleClientAddressSelected,
      isPrefilled,
      hasGreenBorder,
      borderRightColor: addressField?.style.borderRightColor,
      allClientFieldsFilled,
      addressHasValidFormat
    });

    // Validation: accepter si Google s√©lectionn√© OU pr√©-rempli OU bordure verte OU tous champs remplis OU format valide
    if (clientAddress && !window.googleClientAddressSelected && !isPrefilled && !hasGreenBorder && !allClientFieldsFilled && !addressHasValidFormat) {
      alert('Veuillez s√©lectionner une adresse valide dans les suggestions Google.');
      return;
    }

    // R√©cup√©rer l'eventId depuis sessionStorage si client s√©lectionn√© depuis la liste
    let eventId = null;
    try {
      const clientData = sessionStorage.getItem('clientData');
      if (clientData) {
        const parsedClientData = JSON.parse(clientData);
        eventId = parsedClientData.eventId;
        log('[DEBUG] EventId r√©cup√©r√© depuis clientData:', eventId);
      }
    } catch (e) {
      log('[WARN] Impossible de r√©cup√©rer eventId depuis clientData');
    }
    
    // Utiliser directement le Total des travaux (qui inclut d√©j√† le minimum de 800$)
    let prix = prixTotal;
    let itemTravaux = '';

    if (prixExt >= 400 && prixInt >= 400) {
      // Les deux d√©passent 400$ = travaux ext√©rieur + int√©rieur
      itemTravaux = 'Travaux int√©rieurs et ext√©rieurs';
    } else if (prixExt >= 400) {
      // Seulement ext√©rieur d√©passe 400$ = travaux ext√©rieur uniquement
      itemTravaux = 'Travaux ext√©rieurs';
    } else if (prixInt >= 400) {
      // Seulement int√©rieur d√©passe 400$ = travaux int√©rieur uniquement
      itemTravaux = 'Travaux int√©rieurs';
    } else {
      // Aucun ne d√©passe 400$ = utiliser prixTotal (minimum 800$)
      itemTravaux = prixExt > prixInt ? 'Travaux ext√©rieurs' : 'Travaux int√©rieurs';
    }
    
    log('[DEBUG] DEBUG SEUILS:', {
      prixExt: prixExt,
      prixInt: prixInt,
      extValid: prixExt >= 400,
      intValid: prixInt >= 400,
      prixFinal: prix,
      itemTravaux: itemTravaux
    });
    
    // Arrondir au 5 ou 10 sup√©rieur (EXACTE de calcul.html)
    const prixBase = Math.ceil(parseFloat(prix));
    const dernierChiffre = prixBase % 10;
    
    let prixArrondi;
    if (dernierChiffre === 0) {
      prixArrondi = prixBase; // D√©j√† arrondi √† 10
    } else if (dernierChiffre <= 5) {
      prixArrondi = prixBase - dernierChiffre + 5; // Arrondir au 5
    } else {
      prixArrondi = prixBase - dernierChiffre + 10; // Arrondir au 10 suivant
    }
    
    
    // Calculer la dur√©e des travaux bas√©e sur le prix (1000$ = 1 √† 1.5 jours)
    let dureeTravaux = '';
    if (prixArrondi > 0) {
      // 1 jour par tranche de 1000$ (minimum)
      const joursMin = prixArrondi / 1000;
      const joursMinArrondi = joursMin % 1 >= 0.5 ? Math.ceil(joursMin) : Math.floor(joursMin);

      // 1.5 jours par tranche de 1000$ (maximum)
      const joursMax = (prixArrondi / 1000) * 1.5;
      const joursMaxArrondi = joursMax % 1 >= 0.5 ? Math.ceil(joursMax) : Math.floor(joursMax);

      // Minimum 1 jour
      const joursMinFinal = Math.max(1, joursMinArrondi);
      const joursMaxFinal = Math.max(1, joursMaxArrondi);

      if (joursMinFinal === joursMaxFinal) {
        dureeTravaux = `${joursMinFinal} jour${joursMinFinal > 1 ? 's' : ''}`;
      } else {
        dureeTravaux = `${joursMinFinal}-${joursMaxFinal} jours`;
      }
    }

    // Cr√©er les nouvelles donn√©es de soumission
    const newSubmissionData = {
      prenom: clientPrenom || 'Client',
      nom: clientNom || '',
      adresse: clientAddress,
      telephone: clientPhone,
      prix: formatCurrency(prixArrondi),
      temps: dureeTravaux,
      source: 'calculateur',
      eventId: eventId // Ajouter l'eventId pour le bannissement
    };

    // V√©rifier s'il y a d√©j√† des donn√©es de prospect (pour conserver le flag de validation d'adresse)
    const existingSubmissionData = sessionStorage.getItem('submissionData');
    let finalSubmissionData = newSubmissionData;

    if (existingSubmissionData) {
      try {
        const existingData = JSON.parse(existingSubmissionData);
        // Si les donn√©es viennent d'un prospect, ajouter un flag pour bypasser validation
        if (existingData.prenom || existingData.nom || existingData.adresse) {
          finalSubmissionData = {
            ...newSubmissionData,
            fromProspect: true // Flag pour indiquer que l'adresse vient d'un prospect valid√©
          };
          log('[OK] Donn√©es prospect d√©tect√©es - flag fromProspect ajout√©');
        }
      } catch (e) {
        log('[WARN] Erreur parsing existingSubmissionData');
      }
    }

    sessionStorage.setItem('submissionData', JSON.stringify(finalSubmissionData));

    // NOUVEAU: Sauvegarder le projet dans "Mes Projets" (API Cloud)
    const username = localStorage.getItem('username') || 'default';
    const clientName = `${clientPrenom} ${clientNom}`;

    // Utiliser l'ID existant si on modifie un projet charg√©, sinon cr√©er un nouvel ID
    const projetId = currentLoadedProjectId || Date.now().toString();

    const projet = {
      id: projetId,
      client: clientName,
      adresse: clientAddress,
      telephone: clientPhone,
      dateCreation: (() => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${day}/${month}/${year}`;
      })(),
      total: parseFloat(prixArrondi) || 0,
      // Sauvegarder tous les champs du calculateur
      formData: collecterToutesDonnees()
    };

    // Sauvegarder dans le cloud via API (mise √† jour si projet existant)
    try {
      const response = await fetch('/api/projets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: username,
          projet: projet,
          updateExisting: currentLoadedProjectId ? true : false
        })
      });

      if (response.ok) {
        log('[OK] Projet ' + (currentLoadedProjectId ? 'mis √† jour' : 'sauvegard√©') + ' dans le cloud');
      } else {
        error('[ERROR] Erreur sauvegarde projet:', response.status, response.statusText);
      }
    } catch (error) {
      error('[ERROR] Erreur API sauvegarde projet:', error);
    }

    // Programmer r√©initialisation apr√®s redirection
    setTimeout(() => {
      localStorage.setItem('shouldResetCalculator', 'true');
    }, 1000);

    // Rediriger vers la page de soumission
    console.log('[REDIRECT] Redirection vers soumissions...');
    console.log('[REDIRECT] window.parent exists:', !!(window.parent && window.parent !== window));
    console.log('[REDIRECT] window.parent.loadTool exists:', !!(window.parent && window.parent.loadTool));

    if (window.parent && window.parent !== window) {
      // On est dans un iframe
      if (typeof window.parent.loadTool === 'function') {
        // Mobile: utiliser loadTool('soumissions')
        console.log('[REDIRECT] Mobile d√©tect√© - utilisation de loadTool()');
        window.parent.loadTool('soumissions');
      } else {
        // Desktop: utiliser le hash pour d√©clencher le routeur
        console.log('[REDIRECT] Desktop d√©tect√© - utilisation du hash');
        window.parent.location.hash = '#/soumissions';
      }
    } else {
      // Fallback si pas dans un iframe
      console.log('[REDIRECT] Pas dans iframe - redirection directe');
      window.location.href = '/soumissions';
    }
  }

  // Fonction pour rafra√Æchir la liste des clients (utile apr√®s bannissement)
  window.refreshClientsList = function() {
    log("üîÑ Rafra√Æchissement de la liste des clients...");
    initClientsPage();
  };

  // Global function for entrepreneur selector to reload data
  window.loadCalculData = async function() {
    log("üîÑ Rechargement COMPLET des donn√©es du calculateur pour l'entrepreneur s√©lectionn√©:", window.username);

    // Supprimer l'anti-flash CSS pour rendre le contenu visible
    const antiFlashStyle = document.getElementById('coach-anti-flash-css');
    if (antiFlashStyle) {
      antiFlashStyle.remove();
      log('[CALCUL] Anti-flash CSS supprim√©');
    }

    // 1. Vider tous les champs du formulaire (r√©initialiser le calculateur)
    if (typeof resetFormFields === 'function') {
      resetFormFields();
      log('[CALCUL] Formulaire r√©initialis√©');
    }

    // 2. Recharger les clients √† compl√©ter
    await initClientsPage();

    // 3. Recharger les produits depuis le stockage
    if (typeof loadProductsFromStorage === 'function') {
      loadProductsFromStorage();
    }

    // 4. Rafra√Æchir la s√©lection de produits
    if (typeof refreshProductSelection === 'function') {
      refreshProductSelection();
    }

    // 5. Mettre √† jour le calcul
    if (typeof updateCalculation === 'function') {
      updateCalculation();
    }

    // 6. Rafra√Æchir la liste des projets (Mes Projets)
    if (typeof afficherListeProjets === 'function') {
      afficherListeProjets();
      log('[CALCUL] Liste des projets rafra√Æchie');
    }

    log('[CALCUL] Interface COMPL√àTEMENT recharg√©e pour:', window.username);
  };

  // √âcouter les changements de localStorage pour rafra√Æchir automatiquement
  window.addEventListener('storage', function(e) {
    if (e.key === 'clientsBannedUpdate') {
      log("üì° Signal de bannissement re√ßu, rafra√Æchissement de la liste...");
      setTimeout(() => {
        window.refreshClientsList();
      }, 1000); // D√©lai pour permettre la propagation des changements
    }
  });

  // √âcouter aussi l'√©v√©nement personnalis√© pour le m√™me onglet
  window.addEventListener('clientBanned', function(e) {
    log("üì° √âv√©nement clientBanned re√ßu dans le m√™me onglet:", e.detail);
    setTimeout(() => {
      window.refreshClientsList();
    }, 500);
  });

  // V√©rifier si le calculateur doit √™tre r√©initialis√© (apr√®s retour de cr√©ation de soumission)
  function checkAndResetCalculator() {
    const shouldReset = localStorage.getItem('shouldResetCalculator');
    if (shouldReset === 'true') {
      log('üîÑ R√©initialisation du calculateur apr√®s retour de cr√©ation de soumission');
      
      // Supprimer le flag
      localStorage.removeItem('shouldResetCalculator');
      
      // R√©initialiser tous les champs sauf param√®tres
      setTimeout(() => {
        document.querySelectorAll('input[type="text"], input[type="number"], input[type="tel"]').forEach(input => {
          if (!input.id.startsWith('param_')) {
            input.value = '';
          }
        });
        
        document.querySelectorAll('select').forEach(select => {
          if (!select.id.startsWith('param_')) {
            select.selectedIndex = 0;
          }
        });
        
        // Nettoyer le sessionStorage
        sessionStorage.removeItem('clientData');
        sessionStorage.removeItem('submissionData');
        
        // Recalculer
        updateCalculation();
        
        log('[OK] Calculateur r√©initialis√© automatiquement');
      }, 100);
    }
  }

  // Initialiser les clients quand la page est pr√™te
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      checkAndResetCalculator();
      setTimeout(initClientsPage, 500);
    });
  } else {
    checkAndResetCalculator();
    setTimeout(initClientsPage, 500);
  }
  </script>

  <!-- Script pour menu accord√©on clients -->
  <script>
  // Fonction globale pour ouvrir/fermer le menu clients avec animation fluide
  function toggleClientsMenu() {
    const content = document.getElementById('clients-content');
    const arrow = document.getElementById('clients-arrow');

    if (!content || !arrow) {
      error('Elements clients-content ou clients-arrow non trouv√©s');
      return;
    }

    // V√©rifier l'√©tat actuel bas√© sur la classe
    const isCollapsed = content.classList.contains('clients-collapsed');

    if (isCollapsed) {
      // Ouvrir le menu
      content.classList.remove('clients-collapsed');

      // Temporairement mettre height √† auto et visibility visible pour calculer
      const originalTransition = content.style.transition;
      content.style.transition = 'none';
      content.style.maxHeight = 'none';
      content.style.visibility = 'visible';

      // Calculer la vraie hauteur du contenu
      const fullHeight = content.scrollHeight;
      log('[DEBUG] Hauteur calcul√©e pour ouverture:', fullHeight);

      // Remettre √† 0 avant l'animation
      content.style.maxHeight = '0px';

      // Forcer le reflow
      void content.offsetHeight;

      // Remettre la transition
      content.style.transition = originalTransition || 'all 0.3s ease-in-out';

      // Animer l'ouverture avec requestAnimationFrame
      requestAnimationFrame(() => {
        content.style.maxHeight = fullHeight + 'px';
        content.style.opacity = '1';
      });

      arrow.style.transform = 'rotate(180deg)';
    } else {
      // Fermer le menu
      content.classList.add('clients-collapsed');
      content.style.maxHeight = '0px';
      content.style.opacity = '0';
      arrow.style.transform = 'rotate(0deg)';
    }
  }
  </script>

  <script>

    // Fonction pour ouvrir le popup depuis le bouton mobile (d√©termine l'onglet actif)
    function openMobileTotalPopup() {
      // D√©terminer l'onglet actif via la classe 'hidden'
      const interieurTab = document.getElementById('interieur-tab');

      let tabType = 'estimation'; // Par d√©faut
      if (interieurTab && !interieurTab.classList.contains('hidden')) {
        tabType = 'interieur';
      }

      openTotalPopup(tabType);
    }

    // Fonction pour afficher/cacher le bouton total mobile
    function updateMobileTotalButton() {
      var btn = document.getElementById('mobile-total-btn');
      if (!btn) {
        console.log('[MOBILE-BTN] Bouton non trouv√© dans le DOM');
        return;
      }

      // D√©tecter si c'est un appareil mobile/tablette
      // M√©thode simple et fiable: √©cran tactile OU petit √©cran OU User Agent mobile
      var ua = navigator.userAgent || '';
      var hasTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
      var isSmallScreen = window.innerWidth <= 1400;
      var isMobileUA = /iPhone|iPad|iPod|Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(ua);

      var isMobileOrTablet = hasTouch || isSmallScreen || isMobileUA;

      console.log('[MOBILE-BTN] D√©tection:', {
        hasTouch: hasTouch,
        isSmallScreen: isSmallScreen,
        screenWidth: window.innerWidth,
        isMobileUA: isMobileUA,
        isMobileOrTablet: isMobileOrTablet,
        currentLoadedProjectId: currentLoadedProjectId
      });

      // Afficher uniquement si dans un projet ET sur mobile/tablette
      if (currentLoadedProjectId && isMobileOrTablet) {
        btn.style.display = 'flex';
        console.log('[MOBILE-BTN] ‚úÖ Bouton AFFICH√â');
      } else {
        btn.style.display = 'none';
        console.log('[MOBILE-BTN] ‚ùå Bouton CACH√â - projet:', !!currentLoadedProjectId, 'mobile:', isMobileOrTablet);
      }
    }

    // Mettre √† jour le bouton mobile lors du redimensionnement ou changement d'orientation
    window.addEventListener('resize', function() {
      if (typeof updateMobileTotalButton === 'function') {
        updateMobileTotalButton();
      }
    });
    window.addEventListener('orientationchange', function() {
      setTimeout(function() {
        if (typeof updateMobileTotalButton === 'function') {
          updateMobileTotalButton();
        }
      }, 100);
    });

    // Fonction pour ouvrir le popup Total/D√©tails/Configuration
    function openTotalPopup(tabType) {
      console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('üì± OUVERTURE POPUP "VOIR TOTAL" - ' + (tabType === 'estimation' ? 'EXT√âRIEUR' : 'INT√âRIEUR'));
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

      const overlay = document.getElementById('total-popup-overlay');
      const popupBody = document.getElementById('total-popup-body');
      const popupTitle = document.getElementById('total-popup-title');

      if (!overlay || !popupBody || !popupTitle) return;

      // D√©terminer le titre avant d'afficher le spinner
      const titleText = tabType === 'estimation' ? 'Total Ext√©rieur' : 'Total Int√©rieur';
      popupTitle.textContent = titleText;

      // Afficher IMM√âDIATEMENT le popup avec un spinner
      popupBody.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; min-height: 300px; flex-direction: column; gap: 1rem;">
          <div style="width: 48px; height: 48px; border: 4px solid rgba(96, 165, 250, 0.2); border-top-color: #60a5fa; border-radius: 50%; animation: spin 1s linear infinite;"></div>
          <p style="color: var(--text-light); font-size: 0.875rem;">Actualisation des totaux...</p>
        </div>
        <style>
          @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
          }
        </style>
      `;
      overlay.style.display = 'flex';
      document.body.classList.add('popup-open');

      console.log('‚è≥ Spinner affich√©, recalcul en cours...');

      // Utiliser setTimeout pour laisser le DOM se mettre √† jour visuellement
      setTimeout(() => {
        console.log('üîÑ D√©but du recalcul complet...');

        // FORCER un recalcul complet avec updateCalculation()
        if (typeof updateCalculation === 'function') {
          console.log('[POPUP] Appel de updateCalculation() pour recalculer tout...');
          updateCalculation();
        } else {
          console.warn('[POPUP] updateCalculation() non disponible');
        }

        // Attendre que updateCalculation() ait fini de mettre √† jour le DOM
        setTimeout(() => {
          console.log('[POPUP] Lecture des valeurs du DOM apr√®s recalcul...');

          // FORCER la mise √† jour des totaux AVANT de cloner le contenu
          // Cela garantit que les valeurs affich√©es sont toujours actuelles
          if (typeof updateSubtotalSync !== 'undefined') {
            updateSubtotalSync();
          } else {
            // Fallback: recalculer les totaux manuellement
            let lavage_html = 0, prep_html = 0, peinture_html = 0, produits_html = 0;

          if (document.getElementById('costLavage')) {
            const text = document.getElementById('costLavage').textContent;
            lavage_html = parseFloat(text.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
          }
          if (document.getElementById('costPreparation')) {
            const text = document.getElementById('costPreparation').textContent;
            prep_html = parseFloat(text.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
          }
          if (document.getElementById('costPeinture')) {
            const text = document.getElementById('costPeinture').textContent;
            peinture_html = parseFloat(text.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
          }
          if (document.getElementById('costProduits')) {
            const costProduitsText = document.getElementById('costProduits').textContent;
            produits_html = parseFloat(costProduitsText.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
          }

          const baseCostsWithoutAdmin = lavage_html + prep_html + peinture_html + produits_html;
          const nouveauxFraisAdmin = baseCostsWithoutAdmin * 0.01;

          if (document.getElementById('fraisAdministratifs')) {
            document.getElementById('fraisAdministratifs').textContent = formatCurrency(nouveauxFraisAdmin);
          }

          const nouveauSousTotal = lavage_html + prep_html + peinture_html + produits_html + nouveauxFraisAdmin;

          console.log('üí∞ RECALCUL DES TOTAUX:');
          console.log('  ‚îú‚îÄ Lavage:', lavage_html.toFixed(2), '$');
          console.log('  ‚îú‚îÄ Pr√©paration:', prep_html.toFixed(2), '$');
          console.log('  ‚îú‚îÄ Main d\'≈ìuvre (Peinture):', peinture_html.toFixed(2), '$');
          console.log('  ‚îú‚îÄ Produits:', produits_html.toFixed(2), '$');
          console.log('  ‚îú‚îÄ Frais administratifs (1%):', nouveauxFraisAdmin.toFixed(2), '$');
          console.log('  ‚îî‚îÄ SOUS-TOTAL:', nouveauSousTotal.toFixed(2), '$\n');

          if (document.getElementById('subTotal')) {
            document.getElementById('subTotal').textContent = formatCurrency(nouveauSousTotal);
          }

          if (document.getElementById('subTotalBreakdown')) {
            document.getElementById('subTotalBreakdown').textContent = formatCurrency(nouveauSousTotal);
          }

          // Mettre √† jour les taxes
          const tpsAmount = nouveauSousTotal * 0.05;
          const tvqAmount = nouveauSousTotal * 0.09975;

          console.log('üìä TAXES:');
          console.log('  ‚îú‚îÄ TPS (5%):', tpsAmount.toFixed(2), '$');
          console.log('  ‚îî‚îÄ TVQ (9.975%):', tvqAmount.toFixed(2), '$\n');

          if (document.getElementById('tpsAmount')) {
            document.getElementById('tpsAmount').textContent = formatCurrency(tpsAmount);
          }
          if (document.getElementById('tvqAmount')) {
            document.getElementById('tvqAmount').textContent = formatCurrency(tvqAmount);
          }

          // Mettre √† jour le total combin√©
          const totalExtText = document.getElementById('subTotal')?.textContent || '$0.00';
          const totalExt = parseFloat(totalExtText.replace(/,/g, '.').replace(/[^0-9.-]/g, '')) || 0;

          const totalIntText = document.getElementById('subTotalInt')?.textContent || '$0.00';
          const totalInt = parseFloat(totalIntText.replace(/,/g, '.').replace(/[^0-9.-]/g, '')) || 0;

          const totalCombineCalcule = totalExt + totalInt;
          const totalCombine = Math.max(800, totalCombineCalcule);

          // R√©cup√©rer les heures
          const heuresExtText = document.getElementById('totalHours')?.textContent || '0';
          const heuresExt = parseFloat(heuresExtText.replace(/,/g, '.')) || 0;

          const heuresIntText = document.getElementById('totalHeuresInt')?.textContent || '0';
          const heuresInt = parseFloat(heuresIntText.replace(/,/g, '.')) || 0;

          const heuresCombine = heuresExt + heuresInt;

          console.log('üî¢ TOTAUX COMBIN√âS (Ext + Int):');
          console.log('  ‚îú‚îÄ Total ext√©rieur:', totalExt.toFixed(2), '$');
          console.log('  ‚îú‚îÄ Total int√©rieur:', totalInt.toFixed(2), '$');
          console.log('  ‚îú‚îÄ Total calcul√©:', totalCombineCalcule.toFixed(2), '$');
          console.log('  ‚îú‚îÄ Total final (min 800$):', totalCombine.toFixed(2), '$');
          console.log('  ‚îú‚îÄ Heures ext√©rieur:', heuresExt.toFixed(1), 'h');
          console.log('  ‚îú‚îÄ Heures int√©rieur:', heuresInt.toFixed(1), 'h');
          console.log('  ‚îî‚îÄ Total heures:', heuresCombine.toFixed(1), 'h\n');

          if (document.getElementById('totalCombine')) {
            document.getElementById('totalCombine').textContent = formatCurrency(totalCombine);
          }
          if (document.getElementById('totalCombineInt')) {
            document.getElementById('totalCombineInt').textContent = formatCurrency(totalCombine);
          }
          // Mettre √† jour le bouton total mobile
          if (document.getElementById('mobile-total-value')) {
            document.getElementById('mobile-total-value').textContent = formatCurrency(totalCombine);
          }
        }

          // Attendre un peu plus pour que le DOM soit rendu avec les nouvelles valeurs
          setTimeout(() => {
            console.log('üìã Clonage du contenu apr√®s mise √† jour DOM...');

            // D√©terminer le conteneur source selon le type
            let sourceContainer = null;

            if (tabType === 'estimation') {
              sourceContainer = document.querySelector('#estimation-tab .grid > .space-y-6:last-child');
            } else if (tabType === 'interieur') {
              sourceContainer = document.querySelector('#interieur-tab .grid > .space-y-6:last-child');
            }

            if (!sourceContainer) {
              console.error('[POPUP] ‚ùå Source container not found for', tabType);
              popupBody.innerHTML = '<p style="color: var(--text-light); padding: 2rem; text-align: center;">Erreur: contenu non trouv√©</p>';
              return;
            }

            console.log('‚úÖ Container source trouv√©:', tabType);

            // Cloner le contenu (Total, D√©tails, Configuration)
            popupBody.innerHTML = '';
            const clonedContent = sourceContainer.cloneNode(true);

            // Retirer les styles qui cachent le contenu
            clonedContent.style.display = 'block';
            clonedContent.style.order = 'initial';

            popupBody.appendChild(clonedContent);

            console.log('‚úÖ Contenu clon√© et ins√©r√© dans le popup');
            console.log('‚úÖ Popup affich√© avec les valeurs actualis√©es\n');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
          }, 150); // D√©lai additionnel pour le rendu du DOM
        }, 200); // D√©lai pour laisser updateCalculation() finir
      }, 100); // D√©lai initial pour afficher le spinner
    }

    // Fonction pour fermer le popup Total/D√©tails/Configuration
    function closeTotalPopup(event) {
      // Si event est fourni, v√©rifier que c'est un clic sur l'overlay et pas sur le contenu
      if (event && event.target.closest('.total-popup-content')) {
        return;
      }

      const overlay = document.getElementById('total-popup-overlay');
      if (overlay) {
        overlay.style.display = 'none';
      }

      // R√©activer le scroll du body
      document.body.classList.remove('popup-open');
    }

  </script>

  <script>
  // Fonction pour mettre √† jour la date
  function updateCurrentDate() {
    const now = new Date();
    const options = { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    };
    const dateString = now.toLocaleDateString('fr-FR', options);
    const currentDateElement = document.getElementById('currentDate');
    if (currentDateElement) {
      currentDateElement.textContent = dateString;
    }
  }
  // Appeler la fonction de mise √† jour de date
  updateCurrentDate();
  </script>

  <script>
  // Initialisation du compte
  if (window.username && window.userRole) {
    const usernameDisplay = document.getElementById("account-username");
    const accountDisplay = document.getElementById("account-display");
    if (usernameDisplay) {
      usernameDisplay.textContent = window.username;
    }
    if (accountDisplay) {
      accountDisplay.textContent = window.username;
    }
  }

  // Gestion du menu d√©roulant compte - Updated for new header
  const accountButton = document.getElementById('account-dropdown-toggle');
  const accountDropdown = document.getElementById('account-dropdown');
  
  if (accountButton && accountDropdown) {
    accountButton.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      accountDropdown.classList.toggle('hidden');
    });
    
    // Fermer le dropdown si on clique ailleurs
    document.addEventListener('click', function(event) {
      if (!accountButton.contains(event.target) && !accountDropdown.contains(event.target)) {
        accountDropdown.classList.add('hidden');
      }
    });
  }

  // Fonction logout
  function logout() {
    localStorage.removeItem("qwotaCredentials");
    localStorage.removeItem("username");
    localStorage.removeItem("userRole");
    window.location.href = '/';
  }
  </script>

  <!-- Script de connexion avec le backend -->

  <!-- Google Maps Autocomplete pour adresse client -->
  <script>
    // Variable globale pour tracker si une adresse Google a √©t√© s√©lectionn√©e
    window.googleClientAddressSelected = false;

    window.initClientAddressAutocomplete = function() {
      const input = document.getElementById('clientAddress');
      if (!input) return;

      // Forcer la d√©sactivation de l'autocomplete navigateur
      input.setAttribute('autocomplete', 'new-password');
      input.setAttribute('autocorrect', 'off');
      input.setAttribute('autocapitalize', 'off');
      input.setAttribute('spellcheck', 'false');

      const autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['address'],
        componentRestrictions: { country: 'ca' }
      });

      // Repositionner le dropdown Google pour qu'il s'aligne avec le champ input sur mobile
      function repositionGoogleDropdown() {
        const pacContainer = document.querySelector('.pac-container');
        if (pacContainer && window.innerWidth <= 768) {
          const inputRect = input.getBoundingClientRect();
          pacContainer.style.left = inputRect.left + 'px';
          pacContainer.style.width = inputRect.width + 'px';
          pacContainer.style.maxWidth = inputRect.width + 'px';
        }
      }

      // Observer pour d√©tecter l'apparition du dropdown
      const observer = new MutationObserver(() => {
        repositionGoogleDropdown();
      });

      // Observer les changements sur le body pour d√©tecter le dropdown
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });

      // Repositionner aussi sur input et focus
      input.addEventListener('input', () => {
        window.googleClientAddressSelected = false;
        // R√©appliquer les attributs anti-autocomplete
        input.setAttribute('autocomplete', 'new-password');
        setTimeout(repositionGoogleDropdown, 50);
      });

      input.addEventListener('focus', () => {
        input.setAttribute('autocomplete', 'new-password');
        input.removeAttribute('readonly');
        setTimeout(repositionGoogleDropdown, 50);
      });

      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
          log("Adresse invalide");
          window.googleClientAddressSelected = false;
          return;
        }

        // Marquer qu'une adresse Google a √©t√© s√©lectionn√©e
        window.googleClientAddressSelected = true;

        const components = place.address_components;
        let streetNumber = '';
        let route = '';
        let city = '';
        let province = '';
        let postalCode = '';

        components.forEach(component => {
          const types = component.types;

          if (types.includes('street_number')) {
            streetNumber = component.long_name;
          }
          if (types.includes('route')) {
            route = component.long_name;
          }
          if (types.includes('locality')) {
            city = component.long_name;
          }
          if (types.includes('administrative_area_level_1')) {
            province = component.short_name;
          }
          if (types.includes('postal_code')) {
            postalCode = component.long_name;
          }
        });

        const fullAddress = `${streetNumber} ${route}, ${city}, ${province} ${postalCode}`;
        input.value = fullAddress.trim();

        // Mettre la bordure en vert quand une adresse Google est s√©lectionn√©e
        input.style.setProperty('border-right-color', '#4caf50', 'important');

        // Mettre √† jour le message de validation
        if (typeof updateClientValidationMessage === 'function') {
          updateClientValidationMessage();
        }
      });
    };
  </script>

  <!-- Script popup s√©lection client mobile -->
  <script>
    // Variables globales pour le popup
    let mobileClientsData = [];

    // Fonction pour ouvrir le popup avec donn√©es sp√©cifiques
    function openClientSelectionPopupWithData(clients) {
      const popup = document.getElementById('clientSelectionPopup');
      const list = document.getElementById('clientSelectionPopupList');

      mobileClientsData = clients;

      if (!clients || clients.length === 0) {
        list.innerHTML = `
          <div class="client-selection-empty">
            <i class="fas fa-users text-3xl mb-2" style="opacity: 0.3;"></i>
            <p>Aucun client disponible</p>
          </div>
        `;
      } else {
        let html = '';
        clients.forEach((client, index) => {
          html += `
            <div class="client-selection-popup-item" onclick="selectClientFromPopupData(${index})">
              <h4><i class="fas fa-user mr-2" style="color: #60a5fa;"></i>${client.prenom} ${client.nom}</h4>
              <p><i class="fas fa-map-marker-alt mr-2" style="color: #34d399;"></i>${client.adresse}</p>
              <p><i class="fas fa-phone mr-2" style="color: #fb923c;"></i>${client.telephone}</p>
            </div>
          `;
        });
        list.innerHTML = html;
      }

      popup.classList.add('show');
    }

    // Fonction pour ouvrir le popup de s√©lection client
    function openClientSelectionPopup() {
      // V√©rifier si on est sur mobile
      if (window.innerWidth > 768) return;

      const popup = document.getElementById('clientSelectionPopup');
      const list = document.getElementById('clientSelectionPopupList');

      // R√©cup√©rer les clients depuis le tableau
      const tbody = document.getElementById('clients-body');
      if (!tbody) return;

      const rows = tbody.querySelectorAll('tr');

      if (rows.length === 0) {
        list.innerHTML = `
          <div class="client-selection-empty">
            <i class="fas fa-users text-3xl mb-2" style="opacity: 0.3;"></i>
            <p>Aucun client disponible</p>
          </div>
        `;
      } else {
        let html = '';
        rows.forEach((row, index) => {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 4) {
            const prenom = cells[0].textContent.trim();
            const nom = cells[1].textContent.trim();
            const adresse = cells[2].textContent.trim();
            const telephone = cells[3].textContent.trim();

            html += `
              <div class="client-selection-popup-item" onclick="selectClientFromPopup(${index})">
                <h4><i class="fas fa-user mr-2" style="color: #60a5fa;"></i>${prenom} ${nom}</h4>
                <p><i class="fas fa-map-marker-alt mr-2" style="color: #34d399;"></i>${adresse}</p>
                <p><i class="fas fa-phone mr-2" style="color: #fb923c;"></i>${telephone}</p>
              </div>
            `;
          }
        });
        list.innerHTML = html;
      }

      popup.classList.add('show');
    }

    // Fonction pour s√©lectionner un client depuis les donn√©es
    function selectClientFromPopupData(index) {
      if (!mobileClientsData || index >= mobileClientsData.length) return;

      const client = mobileClientsData[index];

      // Appeler directement startCalculationForClient avec les donn√©es
      startCalculationForClient(
        client.id,
        client.prenom || '',
        client.nom || '',
        client.adresse || '',
        client.telephone || ''
      );

      // Fermer le popup
      closeClientSelectionPopup();
    }

    // Fonction pour fermer le popup
    function closeClientSelectionPopup() {
      const popup = document.getElementById('clientSelectionPopup');
      popup.classList.remove('show');
    }

    // Fonction pour s√©lectionner un client depuis le popup
    function selectClientFromPopup(index) {
      const tbody = document.getElementById('clients-body');
      const row = tbody.querySelectorAll('tr')[index];

      if (row) {
        const cells = row.querySelectorAll('td');
        const prenom = cells[0].textContent.trim();
        const nom = cells[1].textContent.trim();
        const adresse = cells[2].textContent.trim();
        const telephone = cells[3].textContent.trim();

        // Remplir les champs
        document.getElementById('clientPrenom').value = prenom;
        document.getElementById('clientNom').value = nom;
        document.getElementById('clientAddress').value = adresse;
        document.getElementById('clientPhone').value = telephone;

        // Trouver le bouton "S√©lectionner" dans la ligne et le cliquer
        const selectButton = cells[4].querySelector('button');
        if (selectButton) {
          selectButton.click();
        }

        // Fermer le popup
        closeClientSelectionPopup();
      }
    }

    // Fermer le popup si on clique en dehors
    document.addEventListener('click', function(e) {
      const popup = document.getElementById('clientSelectionPopup');
      if (e.target === popup) {
        closeClientSelectionPopup();
      }
    });

    // Listeners sur les champs pr√©nom/nom d√©sactiv√©s - permettre l'√©criture libre
    // document.addEventListener('DOMContentLoaded', function() {
    //   const prenomField = document.getElementById('clientPrenom');
    //   const nomField = document.getElementById('clientNom');

    //   if (prenomField) {
    //     prenomField.addEventListener('focus', function() {
    //       if (window.innerWidth <= 768) {
    //         this.blur(); // Enlever le focus pour √©viter le clavier
    //         openClientSelectionPopup();
    //       }
    //     });
    //   }

    //   if (nomField) {
    //     nomField.addEventListener('focus', function() {
    //       if (window.innerWidth <= 768) {
    //         this.blur();
    //         openClientSelectionPopup();
    //       }
    //     });
    //   }
    // });
  </script>

  <!-- Script de formatage du t√©l√©phone -->
  <script>
    // Formatage automatique du t√©l√©phone (000-000-0000)
    const clientPhoneInput = document.getElementById('clientPhone');

    if (clientPhoneInput) {
      clientPhoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Garder seulement les chiffres
        let formattedValue = '';

        if (value.length > 0) {
          formattedValue = value.substring(0, 3);
        }
        if (value.length >= 4) {
          formattedValue += '-' + value.substring(3, 6);
        }
        if (value.length >= 7) {
          formattedValue += '-' + value.substring(6, 10);
        }

        e.target.value = formattedValue;
      });

      clientPhoneInput.addEventListener('keydown', function(e) {
        // Si l'utilisateur appuie sur Backspace ou Delete
        if (e.key === 'Backspace' || e.key === 'Delete') {
          const cursorPos = e.target.selectionStart;
          const value = e.target.value;

          // Si le curseur est juste apr√®s un tiret, effacer le tiret + le chiffre avant
          if (e.key === 'Backspace' && cursorPos > 0 && value[cursorPos - 1] === '-') {
            e.preventDefault();
            const newValue = value.substring(0, cursorPos - 2) + value.substring(cursorPos);
            e.target.value = newValue;
            // D√©clencher l'√©v√©nement input pour reformater
            e.target.dispatchEvent(new Event('input'));
          }
        }
      });
    }
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZDi-RMHDdA4l-4sv_5H8GhsUAYXV4DVE&libraries=places&callback=initClientAddressAutocomplete&language=fr&region=CA"
    async
    defer
  ></script>

  <!-- Spinner de chargement pour navigation -->
  <div id="navigation-spinner" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0f172a; z-index: 9999; align-items: center; justify-content: center;">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
      <!-- Spinner SVG anim√© -->
      <svg width="64" height="64" viewBox="0 0 64 64" style="animation: spin 0.8s linear infinite;">
        <circle cx="32" cy="32" r="28" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="6"/>
        <circle cx="32" cy="32" r="28" fill="none" stroke="#3b82f6" stroke-width="6" stroke-dasharray="140" stroke-dashoffset="40" stroke-linecap="round" style="transform-origin: center; transform: rotate(-90deg);"/>
      </svg>
      <p style="margin-top: 1rem; color: #94a3b8; font-size: 0.875rem;">Chargement...</p>
    </div>
  </div>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <script src="/entrepreneur-selector.js"></script>
</body>
</html>
