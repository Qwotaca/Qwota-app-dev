<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Cr√©er une soumission</title>

  <!-- üö´ D√©sactiver le cache du navigateur -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- üì± PWA Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Qwota">
  <meta name="msapplication-TileColor" content="#5271ff">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Ic√¥nes PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512x512.png">
  <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

  <!-- Script Service Worker -->
  <script>
  /* Service Worker disabled */
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="/favicon" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="/base.css">
  <link rel="stylesheet" href="/entrepreneur-selector.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.min.js"></script>

<!-- Variables globales d√©finies dans common.js -->
<script>
  // Ces variables sont maintenant g√©r√©es par common.js
  // username, userRole, canEditParameters sont disponibles globalement

  // Script anti-flash pour coach/direction
  (function() {
    const userRole = localStorage.getItem('userRole');
    const isCoachOrDirection = userRole === 'coach' || userRole === 'direction';
    const urlParams = new URLSearchParams(window.location.search);
    const userParam = urlParams.get('user');
    const coachUsername = localStorage.getItem('username');

    // Afficher le s√©lecteur si c'est un coach/direction sans entrepreneur s√©lectionn√©
    const shouldShowSelector = isCoachOrDirection && (!userParam || userParam === coachUsername);

    if (shouldShowSelector) {
      // Injecter le CSS imm√©diatement pour cacher le contenu et afficher le s√©lecteur
      const style = document.createElement('style');
      style.id = 'coach-anti-flash-css';
      style.textContent = `
        .main-content {
          opacity: 0 !important;
          pointer-events: none !important;
        }
        #coach-selector-backdrop {
          display: block !important;
          opacity: 1 !important;
          pointer-events: all !important;
        }
        #coach-entrepreneur-selector {
          display: block !important;
          opacity: 1 !important;
        }
      `;
      document.head.appendChild(style);
    }
  })();
</script>

  <link rel="stylesheet" href="/soumission.css">


  <style>
    /* Titre du s√©lecteur entrepreneur */
    #coach-entrepreneur-selector .selector-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-light);
      text-align: center;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    #coach-entrepreneur-selector .selector-title i {
      color: var(--primary-blue);
    }

    #coach-entrepreneur-selector.in-header .selector-title {
      display: none;
    }

    /* Sous-titre du s√©lecteur */
    #coach-entrepreneur-selector .selector-subtitle {
      font-size: 0.9rem;
      color: var(--text-gray);
      text-align: center;
      margin-bottom: 1.5rem;
    }

    #coach-entrepreneur-selector.in-header .selector-subtitle {
      display: none;
    }

    /* Canvas de signature plus grand sur PC et tablette */
    @media (min-width: 601px) {
      #signatureContainer {
        max-width: 458px !important;
      }

      #presentationSignaturePad {
        width: 458px !important;
        height: 117px !important;
      }
    }

    /* Animation de succ√®s pour l'envoi de soumission */
    @keyframes successFadeIn {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes checkmarkDraw {
      0% {
        stroke-dashoffset: 100;
      }
      100% {
        stroke-dashoffset: 0;
      }
    }

    .success-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: successFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .success-content {
      text-align: center;
      color: white;
      animation: successFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
    }

    .success-checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      margin: 0 auto 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
    }

    .success-checkmark svg {
      stroke: white;
      stroke-width: 3;
      stroke-dasharray: 100;
      stroke-dashoffset: 100;
      animation: checkmarkDraw 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.4s forwards;
    }

    /* Zoom slider style */
    #pdfZoomSlider {
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      border-radius: 2px;
      cursor: pointer;
    }
    #pdfZoomSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    #pdfZoomSlider::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    /* Mobile & Tablette: cacher zoom slider (pinch zoom avec doigts) - footer g√©r√© via JavaScript selon le mode */
    @media (max-width: 1200px) {
      #pdfModal #zoomSliderContainer {
        display: none !important;
      }
      #signatureZoomPopup > div {
        width: auto !important;
      }
    }

    /* Tablette: dropdown d'adresse Google - texte sur plusieurs lignes */
    @media (min-width: 601px) and (max-width: 1200px) {
      .pac-item {
        white-space: normal !important;
        line-height: 1.4 !important;
        padding: 10px 12px !important;
      }

      .pac-item-query {
        font-size: 0.85rem !important;
      }

      .pac-matched {
        font-size: 0.8rem !important;
      }
    }

    /* Mobile phone only: tout en 1 colonne + boutons compacts */
    @media (max-width: 640px) {
      /* Message de validation √† gauche sur mobile */
      #validationMessage {
        text-align: left !important;
      }

      /* Boutons d'action compacts */
      #actionButtonsContainer {
        display: flex !important;
        flex-wrap: nowrap !important;
        gap: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
      }

      #actionButtonsContainer > button,
      #mainButtonsGroup > button {
        margin: 0 0.25rem !important;
      }

      #actionButtonsContainer > button:first-child {
        margin-left: 0 !important;
      }

      #mainButtonsGroup > button:last-child {
        margin-right: 0 !important;
      }

      #mainButtonsGroup {
        display: flex !important;
        gap: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      #actionButtonsContainer button {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.8rem !important;
      }

      #actionButtonsContainer .btn-text-full {
        display: none !important;
      }

      #actionButtonsContainer .btn-text-short {
        display: inline !important;
      }

      #actionButtonsContainer i {
        margin-right: 0.25rem !important;
      }

      /* Grilles en 1 colonne */
      .grid.grid-cols-4,
      .grid.grid-cols-5,
      .grid.grid-cols-3 {
        grid-template-columns: 1fr !important;
      }

      .col-span-1 {
        grid-column: span 1 !important;
      }

      /* Dropdown d'adresse Google - texte sur plusieurs lignes au lieu de ... */
      .pac-item {
        white-space: normal !important;
        line-height: 1.4 !important;
        padding: 10px 12px !important;
      }

      /* Texte des adresses plus petit pour tout afficher */
      .pac-item-query {
        font-size: 0.8rem !important;
      }

      .pac-matched {
        font-size: 0.75rem !important;
      }
    }
  </style>


  
</head>
<body class="min-h-screen" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: var(--text-light); margin: 0; padding: 0; padding-bottom: 100px; font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;">


<!-- Backdrop pour le s√©lecteur coach (√©tat centr√©) -->
<div id="coach-selector-backdrop"></div>

<!-- S√©lecteur d'entrepreneur (visible uniquement pour les coaches) -->
<div id="coach-entrepreneur-selector">
  <!-- Titre de la page avec ic√¥ne Soumission -->
  <div class="page-identity">
    <div class="page-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3), 0 0 40px rgba(245, 158, 11, 0.15);">
      <i class="fas fa-file-invoice"></i>
    </div>
    <div class="page-name" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #fbbf24 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Soumission</div>
  </div>

  <!-- Titre et sous-titre (visibles uniquement en mode centr√©) -->
  <div class="selector-title">
    <i class="fas fa-user-tie"></i>
    S√©lectionnez un entrepreneur
  </div>
  <div class="selector-subtitle">Choisissez l'entrepreneur pour lequel vous souhaitez cr√©er une soumission</div>

  <div class="selector-container">
    <div class="selector-label">
      <i class="fas fa-user-tie"></i>
      <span>Entrepreneur:</span>
    </div>
    <div class="coach-dropdown">
      <div class="coach-dropdown-toggle" id="coach-dropdown-toggle">
        <span class="placeholder">-- S√©lectionner un entrepreneur --</span>
        <input type="text" class="search-input" id="search-input" placeholder="Rechercher..." autocomplete="off" style="display: none;">
        <i class="fas fa-chevron-down chevron"></i>
      </div>
      <div class="coach-dropdown-menu" id="coach-dropdown-menu">
        <!-- Options charg√©es dynamiquement -->
      </div>
    </div>
  </div>
</div>

<div id="main-content-wrapper">









  <!-- Wrapper pour SPA - extraction du contenu uniquement -->
  <div>

  <!-- Header moderne comme newgqp.html -->
  <div class="w-full" style="width: 100%; padding: 2rem;">

    <!-- Bouton Retour -->
    <div id="back-button-container" class="mb-6">
      <button id="back-to-outils-btn" onclick="goBackToOutils()" class="back-button">
        <i class="fas fa-arrow-left"></i>
        <span class="back-button-text">Retour aux outils</span>
      </button>
    </div>

    <!-- Header -->
    <div class="mb-10" id="page-header">
      <div class="relative">
        <h1 class="text-4xl font-bold mb-3" style="color: var(--text-light);">
          Nouvelle soumission
        </h1>
<span class="absolute -bottom-2 left-0 w-20 h-1 bg-gradient-to-r from-blue-600 to-blue-400 rounded-full"></span>
        <div class="flex items-center justify-between">
          <p class="text-xl font-medium" style="color: var(--text-gray);">Cr√©ez et envoyez une soumission professionnelle √† votre client</p>
          <div class="text-sm flex items-center" style="color: var(--text-gray);">
            <i class="fas fa-calendar-alt mr-2"></i>
            <span id="currentDate">Aujourd'hui</span>
          </div>
        </div>
      </div>
    </div>

    <!-- [WARN] Avertissement profil incomplet -->
    <div id="profile-warning" style="display: none;">
      <div style="max-width: 700px; margin: 60px auto; background: var(--bg-card); padding: 50px; border-radius: 20px; box-shadow: var(--shadow-dark-strong); border: 1px solid var(--border-dark);">
        <div style="text-align: center; margin-bottom: 30px;">
          <i class="fas fa-exclamation-triangle" style="font-size: 70px; color: #fb923c; margin-bottom: 20px;"></i>
          <h2 style="font-size: 32px; font-weight: 700; color: var(--text-light); margin-bottom: 10px;">
            Profil incomplet
          </h2>
          <p style="font-size: 18px; color: var(--text-gray);">
            Veuillez compl√©ter votre profil avant de cr√©er une soumission
          </p>
        </div>

        <!-- Informations valides -->
        <div id="valid-items" style="background: rgba(52, 211, 153, 0.1); border-left: 4px solid #34d399; padding: 25px; border-radius: 12px; margin-bottom: 20px; display: none;">
          <p style="font-weight: 600; color: var(--text-light); margin-bottom: 20px; font-size: 16px;">
            <i class="fas fa-check-circle mr-2"></i>Informations valides :
          </p>
          <ul id="valid-list" style="list-style: none; padding-left: 0;">
            <!-- Liste dynamique des √©l√©ments valides -->
          </ul>
        </div>

        <!-- Informations manquantes -->
        <div id="missing-items" style="background: rgba(251, 146, 60, 0.1); border-left: 4px solid #fb923c; padding: 25px; border-radius: 12px; margin-bottom: 40px;">
          <p style="font-weight: 600; color: var(--text-light); margin-bottom: 20px; font-size: 16px;">
            <i class="fas fa-list-ul mr-2"></i>Informations manquantes :
          </p>
          <ul id="missing-list" style="list-style: none; padding-left: 0;">
            <!-- Liste dynamique des √©l√©ments manquants -->
          </ul>
        </div>

        <div style="text-align: center;">
          <a href="/connection" class="btn-parametres" style="display: inline-block; position: relative; overflow: hidden; background: linear-gradient(135deg, #fb923c 0%, #f97316 100%); color: white; padding: 14px 40px; border-radius: 28px; font-weight: 700; font-size: 16px; text-decoration: none; box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3); transition: all 0.3s ease;">
            <span style="position: relative; z-index: 1;">
              <i class="fas fa-cog mr-2"></i>Aller aux Param√®tres
            </span>
          </a>
        </div>

        
      </div>
    </div>

    <!-- Contenu principal de la page -->
    <div id="page-content">
    <!-- Formulaire moderne dans une carte comme les status cards -->
    <div class="status-cards-grid grid grid-cols-1 gap-6 mb-8">
      <div class="box">
        <div class="box-header">
          <!-- Ligne du titre -->
          <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <div class="box-header-icon" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);">
                <i class="fas fa-file-alt"></i>
              </div>
              <h2 class="box-header-title">Cr√©er une soumission</h2>
            </div>

            <!-- Toggle Province (desktop seulement - √† droite du titre) -->
            <div id="languageToggle" style="display: flex; background: rgba(71, 85, 105, 0.3); border-radius: 8px; padding: 4px; gap: 4px; cursor: pointer;">
              <div class="lang-option active" data-lang="fr" style="padding: 6px 12px; border-radius: 6px; font-size: 0.875rem; font-weight: 600; transition: all 0.3s ease; color: var(--text-light);">
                Qu√©bec
              </div>
              <div class="lang-option" data-lang="en" style="padding: 6px 12px; border-radius: 6px; font-size: 0.875rem; font-weight: 600; transition: all 0.3s ease; color: var(--text-gray);">
                Ontario
              </div>
            </div>
          </div>

          <!-- Deuxi√®me ligne: Toggle Province (mobile seulement - ligne compl√®te) -->
          <div id="languageToggleMobile" class="hidden mt-4" style="background: rgba(71, 85, 105, 0.3); border-radius: 8px; padding: 4px; gap: 4px; cursor: pointer;">
            <div class="lang-option-mobile active" data-lang="fr" style="padding: 6px 12px; border-radius: 6px; font-size: 0.875rem; font-weight: 600; transition: all 0.3s ease; color: var(--text-light);">
              Qu√©bec
            </div>
            <div class="lang-option-mobile" data-lang="en" style="padding: 6px 12px; border-radius: 6px; font-size: 0.875rem; font-weight: 600; transition: all 0.3s ease; color: var(--text-gray);">
              Ontario
            </div>
          </div>
        </div>
        <div class="box-body">

  <form id="soumissionForm" autocomplete="off">
    
    <!-- SECTION INFORMATION CLIENT -->
    <div class="form-section mb-6">
      <h2 class="section-title" style="display: flex; align-items: center; justify-content: space-between;">
        <span>
          <i class="fas fa-user mr-2 text-blue-500"></i>
          Information client
        </span>
        <span id="recuperationBadge" style="display: none; font-size: 0.75rem; padding: 4px 12px; border-radius: 6px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: 600; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);">
          <i class="fas fa-redo mr-1"></i>
          <span id="recuperationText">R√©cup√©ration de client</span>
        </span>
      </h2>

      <!-- Bouton Cr√©er le projet / Quitter le projet -->
      <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
        <p id="soumissionClientValidationMsg" class="text-sm" style="color: #e57373; margin: 0;">
          <i class="fas fa-info-circle mr-1"></i>
          Pour cr√©er un projet, remplissez les informations client ci-dessous
        </p>
        <button type="button" id="createSoumissionProjectBtn" onclick="createSoumissionProject()" disabled
                style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 14px; border: none; cursor: not-allowed; opacity: 0.5; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; margin-left: auto;">
          <i class="fas fa-plus-circle"></i>
          Cr√©er le projet
        </button>
      </div>

      <!-- Ligne 1: Pr√©nom, Nom, Adresse, T√©l√©phone -->
      <div class="grid grid-cols-4 gap-4 mb-4">
        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-id-badge mr-2 text-green-500"></i>
            Pr√©nom
          </label>
          <input type="text" name="prenom" placeholder="Ex: Jean" class="modern-input" required autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" data-lpignore="true" data-form-type="other" style="border-right: 2px solid #e57373 !important;" oninput="this.style.setProperty('border-right-color', this.value.trim() ? '#4caf50' : '#e57373', 'important'); setTimeout(() => { validateRequiredFields(); updateSoumissionClientValidation(); }, 0);">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-id-badge mr-2 text-green-500"></i>
            Nom
          </label>
          <input type="text" name="nom" placeholder="Ex: Dupont" class="modern-input" required autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" data-lpignore="true" data-form-type="other" style="border-right: 2px solid #e57373 !important;" oninput="this.style.setProperty('border-right-color', this.value.trim() ? '#4caf50' : '#e57373', 'important'); setTimeout(() => { validateRequiredFields(); updateSoumissionClientValidation(); }, 0);">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>
            Adresse
          </label>
          <input type="text"
                 id="adresseAutocomplete"
                 name="adresse"
                 placeholder="Ex: 123 Rue de la Paix, Montr√©al, QC H2T 2L2"
                 class="modern-input"
                 autocomplete="new-password"
                 autocorrect="off"
                 autocapitalize="off"
                 spellcheck="false"
                 readonly
                 onfocus="this.removeAttribute('readonly');"
                 data-form-type="other"
                 style="border-right: 2px solid #e57373 !important;">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-phone mr-2 text-purple-500"></i>
            T√©l√©phone
          </label>
          <input type="text" id="telephoneInput" name="telephone" placeholder="Ex: 514-029-2001" class="modern-input" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" data-lpignore="true" data-form-type="other" maxlength="12" style="border-right: 2px solid #e57373 !important;" oninput="const regex = /^\d{3}-\d{3}-\d{4}$/; this.style.setProperty('border-right-color', regex.test(this.value.trim()) ? '#4caf50' : '#e57373', 'important'); if(typeof validateRequiredFields === 'function') validateRequiredFields(); if(typeof updateSoumissionClientValidation === 'function') updateSoumissionClientValidation();">
        </div>
      </div>

      <!-- Ligne 2: Courriel, N¬∞ soumission, Date cr√©ation, Pay√© par -->
      <div class="grid grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-envelope mr-2 text-blue-500"></i>
            Courriel
          </label>
          <input type="email" name="courriel" placeholder="Ex: jean.dupont@email.com" class="modern-input" autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false" data-lpignore="true" data-form-type="other" style="border-right: 2px solid #e57373 !important;" oninput="const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; this.style.setProperty('border-right-color', regex.test(this.value.trim()) ? '#4caf50' : '#e57373', 'important'); if(typeof validateRequiredFields === 'function') validateRequiredFields(); if(typeof updateSoumissionClientValidation === 'function') updateSoumissionClientValidation();">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-hashtag mr-2 text-orange-500"></i>
            N¬∞ de soumission
          </label>
          <input type="text" name="num" placeholder="Chargement..." class="modern-input" autocomplete="off" value="" readonly style="background: rgba(128, 128, 128, 0.1) !important; color: rgba(255, 255, 255, 0.5) !important; cursor: not-allowed !important; border: 2px solid rgba(128, 128, 128, 0.3) !important; border-right: 2px solid #4caf50 !important; border-radius: 12px !important; padding: 12px 16px !important; font-size: 0.875rem !important;">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-calendar mr-2 text-indigo-500"></i>
            Date de cr√©ation
          </label>
          <div class="dashboard-calendar-container">
            <input type="text" name="date_creation" class="dashboard-date-display" id="autoDate" readonly placeholder="S√©lectionner une date" onclick="openCreationCalendar()" style="border-right: 2px solid #e57373 !important;">
            <i class="fas fa-calendar dashboard-date-icon" onclick="toggleCreationCalendar()"></i>
            <div class="dashboard-calendar hidden" id="creationCalendar">
              <div class="dashboard-calendar-header">
                <button type="button" class="dashboard-calendar-nav" onclick="changeCreationMonth(-1)">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <span class="dashboard-calendar-title" id="creationCalendarTitle">Mars 2024</span>
                <button type="button" class="dashboard-calendar-nav" onclick="changeCreationMonth(1)">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              <div class="dashboard-calendar-weekdays">
                <span>Dim</span><span>Lun</span><span>Mar</span><span>Mer</span><span>Jeu</span><span>Ven</span><span>Sam</span>
              </div>
              <div class="dashboard-calendar-days" id="creationCalendarDays"></div>
            </div>
          </div>
        </div>
        <div class="dropdown col-span-1">
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-credit-card mr-2 text-teal-500"></i>
            Pay√© par
          </label>
          <div class="dropdown-toggle" id="paidByToggle" style="border-right: 2px solid #4caf50 !important;">
            <span class="tag">Virement Interac</span>
          </div>
          <div class="dropdown-menu hidden bg-white" id="paidByMenu">
            <div class="dropdown-option" data-value="Virement Interac">Virement Interac</div>
            <div class="dropdown-option" data-value="Ch√®que">Ch√®que</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION DESCRIPTION DES TRAVAUX -->
    <div class="form-section mb-6" id="section-description-travaux" style="position: relative;">
      <div class="soumission-lock-overlay" id="lock-description-travaux" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 5; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: not-allowed;">
        <div style="text-align: center; color: var(--text-gray);">
          <i class="fas fa-lock" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5; display: block;"></i>
          <p style="font-size: 0.875rem; opacity: 0.7;">Cr√©ez un projet pour d√©bloquer</p>
        </div>
      </div>
      <h2 class="section-title">
        <i class="fas fa-paint-brush mr-2 text-orange-500"></i>
        Description des travaux
      </h2>
      
      <!-- 4 champs principaux avec hauteur augment√©e -->
      <div class="grid grid-cols-4 gap-4 mb-6">
        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-home mr-2 text-green-500"></i>
            Endroit √† peinturer
          </label>
          <div class="popup-trigger modern-input" id="endroitTrigger" style="min-height: 180px; max-height: 180px; height: 180px; display: flex; align-items: flex-start; cursor: pointer; padding: 12px 16px; position: relative; overflow-y: auto; font-size: 14px; box-sizing: border-box; border-right: 2px solid #e57373 !important;">
            <span id="endroitDisplay" style="color: var(--text-gray); font-size: 14px; line-height: 1.4; word-wrap: break-word; flex: 1;">Cliquez pour s√©lectionner les endroits √† peinturer...</span>
            <i class="fas fa-plus" style="position: sticky; top: 4px; margin-left: 16px; color: var(--primary-blue); align-self: flex-start;"></i>
            <input type="hidden" id="endroitHidden" name="endroit_peinture">
          </div>
        </div>

        <!-- PR√âPARATION/PRODUIT -->
        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light); display: flex; align-items: center; justify-content: space-between;">
            <span>
              <i class="fas fa-palette mr-2 text-purple-500"></i>
              Pr√©paration / Produit
            </span>
            <span id="productCounter" style="font-size: 12px; color: var(--text-gray);">0/0</span>
          </label>
          <div class="popup-trigger modern-input" id="productTrigger" style="min-height: 180px; max-height: 180px; height: 180px; display: flex; align-items: flex-start; cursor: pointer; padding: 12px 16px; position: relative; overflow-y: auto; font-size: 14px; box-sizing: border-box; border-right: 2px solid #e57373 !important;">
            <span id="productDisplay" style="color: var(--text-gray); font-size: 14px; line-height: 1.4; word-wrap: break-word; flex: 1;">Cliquez pour s√©lectionner pr√©paration et produit...</span>
            <i class="fas fa-plus" style="position: sticky; top: 4px; margin-left: 16px; color: var(--primary-blue); align-self: flex-start;"></i>
            <input type="hidden" id="produitCouleursHidden" name="produitCouleurs">
          </div>
        </div>

        <!-- ITEM -->
        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-hammer mr-2 text-orange-500"></i>
            Item
          </label>
          <div class="popup-trigger modern-input" id="itemTrigger" style="min-height: 180px; max-height: 180px; height: 180px; display: flex; align-items: flex-start; cursor: pointer; padding: 12px 16px; position: relative; overflow-y: auto; font-size: 14px; box-sizing: border-box; border-right: 2px solid #e57373 !important;">
            <span id="itemDisplay" style="color: var(--text-gray); font-size: 14px; line-height: 1.4; word-wrap: break-word; flex: 1;">Cliquez pour ajouter les items...</span>
            <i class="fas fa-plus" style="position: sticky; top: 4px; margin-left: 16px; color: var(--primary-blue); align-self: flex-start;"></i>
            <input type="hidden" id="itemHidden" name="item">
          </div>
        </div>

        <!-- PARTICULARIT√â DES TRAVAUX -->
        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-star mr-2 text-yellow-500"></i>
            Particularit√© des travaux
          </label>
          <div class="popup-trigger modern-input" id="partTravauxTrigger" style="min-height: 180px; max-height: 180px; height: 180px; display: flex; align-items: flex-start; cursor: pointer; padding: 12px 16px; position: relative; overflow-y: auto; font-size: 14px; box-sizing: border-box; border-right: 2px solid #e57373 !important;">
            <span id="partTravauxDisplay" style="color: var(--text-gray); font-size: 14px; line-height: 1.4; word-wrap: break-word; flex: 1;">Cliquez pour s√©lectionner particularit√©s des travaux...</span>
            <i class="fas fa-plus" style="position: sticky; top: 4px; margin-left: 16px; color: var(--primary-blue); align-self: flex-start;"></i>
            <input type="hidden" id="partTravauxHidden" name="partTravaux">
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION D√âTAILS DES TRAVAUX -->
    <div class="form-section mb-6" id="section-details-travaux" style="position: relative;">
      <div class="soumission-lock-overlay" id="lock-details-travaux" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 5; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: not-allowed;">
        <div style="text-align: center; color: var(--text-gray);">
          <i class="fas fa-lock" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5; display: block;"></i>
          <p style="font-size: 0.875rem; opacity: 0.7;">Cr√©ez un projet pour d√©bloquer</p>
        </div>
      </div>
      <h2 class="section-title">
        <i class="fas fa-clipboard-list mr-2 text-indigo-500"></i>
        D√©tails des travaux
      </h2>

      <!-- Deuxi√®me ligne: 4 champs sur une ligne -->
      <div class="grid grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-dollar-sign mr-2 text-green-500"></i>
            Prix
          </label>
          <input type="text" name="prix" placeholder="Ex: 850$" class="modern-input" autocomplete="off" style="border-right: 2px solid #e57373 !important;" oninput="calculerDepot(); this.style.setProperty('border-right-color', this.value.trim() ? '#4caf50' : '#e57373', 'important')">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-piggy-bank mr-2 text-yellow-500"></i>
            D√©p√¥t <span style="color: #ffd700; font-size: 0.75rem; font-weight: normal;">(25% par d√©faut)</span>
          </label>
          <input type="text" name="depot" placeholder="Auto" class="modern-input" autocomplete="off" style="border-right: 2px solid #4caf50 !important;" oninput="this.style.setProperty('border-right-color', this.value.trim() ? '#4caf50' : '#e57373', 'important')">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-clock mr-2 text-blue-500"></i>
            Dur√©e des travaux
          </label>
          <input type="text" name="temps" placeholder="Ex: 2-3 jours" class="modern-input" autocomplete="off" style="border-right: 2px solid #e57373 !important;" oninput="this.style.setProperty('border-right-color', this.value.trim() ? '#4caf50' : '#e57373', 'important')">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2" style="color: var(--text-light);">
            <i class="fas fa-calendar-alt mr-2 text-purple-500"></i>
            Date des travaux
          </label>
          <input type="text" name="date_travaux" placeholder="Ex: mi-mai" class="modern-input" autocomplete="off" style="border-right: 2px solid #e57373 !important;" oninput="this.style.setProperty('border-right-color', this.value.trim() ? '#4caf50' : '#e57373', 'important')">
        </div>
      </div>
    </div>

    <!-- Boutons d'action -->
    <div class="mt-8 pt-6" style="border-top: 1px solid var(--border-dark);">
      <p id="validationMessage" class="text-sm" style="color: #e57373; margin: 0 0 0.5rem 0; text-align: right;">
        <i class="fas fa-exclamation-circle mr-1"></i>
        Veuillez remplir toutes les cases avant de pr√©senter au client
      </p>
      <div class="flex justify-end items-center flex-wrap gap-2" id="actionButtonsContainer">
        <!-- Boutons principaux - √† droite -->
        <div class="flex space-x-4 gap-2" id="mainButtonsGroup">
          <!-- Pr√©senter au client -->
          <button type="button" class="btn-secondary px-6 py-2" id="voirPDFBtn" disabled style="opacity: 0.5; cursor: not-allowed; pointer-events: none;">
            <i class="fas fa-file-signature mr-2"></i>
            <span class="btn-text-full">Pr√©senter au client</span>
            <span class="btn-text-short" style="display: none;">Pr√©senter</span>
          </button>
          <!-- Envoyer au client -->
          <button type="submit" id="submitBtn" class="btn-primary px-6 py-2 flex items-center gap-2" disabled style="opacity: 0.5; cursor: not-allowed; pointer-events: none;">
            <span id="btnText" class="btn-text-full">Envoyer au client</span>
            <span class="btn-text-short" style="display: none;">Envoyer</span>
            <span id="btnSpinner" class="hidden absolute inset-0 flex items-center justify-center">
              <span class="w-5 h-5 border-2 border-white border-t-black rounded-full animate-spin"></span>
            </span>
          </button>
        </div>
      </div>
      <!-- Input cach√© pour le type d'envoi -->
      <input type="hidden" name="send_type" id="send-type-hidden" value="send">
    </div>
  </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Section: Soumissions - Menu √† onglets -->
  <div id="pending-soumissions-section">
    <div class="status-cards-grid grid grid-cols-1 gap-6 mb-8">
      <div class="box mb-0">
        <div class="box-header box-header-keep-flex">
          <div style="display: flex; align-items: center; gap: 2rem; flex: 1;">
            <h2 class="section-title" id="tab-a-envoyer" style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 10px; opacity: 1; transition: opacity 0.3s; font-size: 1.1rem;" onclick="showSoumissionTab('a-envoyer')" title="Soumissions √† envoyer">
              <i class="fas fa-paper-plane"></i>
              <span>√Ä envoyer</span>
              <span id="pending-count" class="px-2 py-0.5 rounded-full text-xs font-semibold" style="background: rgba(251, 146, 60, 0.2); color: #fb923c; font-size: 0.75rem;">0</span>
            </h2>
            <h2 class="section-title" id="tab-envoyees" style="margin: 0; cursor: pointer; display: flex; align-items: center; gap: 10px; opacity: 0.5; transition: opacity 0.3s; font-size: 1.1rem;" onclick="showSoumissionTab('envoyees')" title="Soumissions envoy√©es">
              <i class="fas fa-check-circle"></i>
              <span>Envoy√©es</span>
              <span id="sent-count" class="px-2 py-0.5 rounded-full text-xs font-semibold" style="background: rgba(34, 197, 94, 0.2); color: #22c55e; font-size: 0.75rem;">0</span>
            </h2>
          </div>
        </div>
        <div class="box-body">

        <!-- === TAB: √Ä envoyer === -->
        <div id="soumission-tab-a-envoyer">
          <!-- Barre de recherche -->
          <div style="margin-bottom: 1rem; max-width: 350px;">
            <div style="position: relative;">
              <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-gray); font-size: 14px;"></i>
              <input type="text" id="search-pending-soumissions" class="search-input" placeholder="Rechercher..." oninput="filterSoumissionTable('pending')" style="width: 100%; padding: 8px 14px 8px 34px !important; background: rgba(30, 41, 59, 0.6) !important; border: 1px solid var(--border-dark) !important; border-radius: 8px !important; color: var(--text-light) !important; font-size: 13px; outline: none;" onfocus="this.style.borderColor='var(--primary-blue)'" onblur="this.style.borderColor='var(--border-dark)'">
            </div>
          </div>
          <!-- Vue Desktop: Table -->
          <div class="table-container" style="height: 700px; overflow-y: auto;">
            <table class="modern-table">
              <thead style="position: sticky; top: 0; z-index: 2;">
                <tr>
                  <th style="width: 14%;">Client</th>
                  <th style="width: 12%;">N¬∞ Soumission</th>
                  <th style="width: 10%;">Date</th>
                  <th style="width: 30%;">Adresse</th>
                  <th style="width: 12%;">Montant</th>
                  <th class="text-center" style="text-align: center !important; width: 12%;">Actions</th>
                </tr>
              </thead>
              <tbody id="pending-soumissions-body">
                <tr>
                  <td colspan="6" class="empty-state">
                    <i class="fas fa-inbox" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
                    <p style="font-size: 1rem;">Aucune soumission en attente</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Vue Mobile: Cards -->
          <div id="pending-soumissions-mobile">
            <div id="pending-soumissions-mobile-list">
              <div class="soumissions-empty-mobile">
                <i class="fas fa-inbox"></i>
                <p>Aucune soumission en attente</p>
              </div>
            </div>
          </div>
        </div>

        <!-- === TAB: Envoy√©es === -->
        <div id="soumission-tab-envoyees" style="display: none;">
          <!-- Barre de recherche -->
          <div style="margin-bottom: 1rem; max-width: 350px;">
            <div style="position: relative;">
              <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-gray); font-size: 14px;"></i>
              <input type="text" id="search-sent-soumissions" class="search-input" placeholder="Rechercher..." oninput="filterSoumissionTable('sent')" style="width: 100%; padding: 8px 14px 8px 34px !important; background: rgba(30, 41, 59, 0.6) !important; border: 1px solid var(--border-dark) !important; border-radius: 8px !important; color: var(--text-light) !important; font-size: 13px; outline: none;" onfocus="this.style.borderColor='var(--primary-blue)'" onblur="this.style.borderColor='var(--border-dark)'">
            </div>
          </div>
          <!-- Vue Desktop: Table -->
          <div class="table-container" style="height: 700px; overflow-y: auto;">
            <table class="modern-table">
              <thead style="position: sticky; top: 0; z-index: 2;">
                <tr>
                  <th style="width: 14%;">Client</th>
                  <th style="width: 12%;">N¬∞ Soumission</th>
                  <th style="width: 10%;">Date</th>
                  <th style="width: 30%;">Adresse</th>
                  <th style="width: 12%;">Montant</th>
                  <th class="text-center" style="text-align: center !important; width: 12%;">Actions</th>
                </tr>
              </thead>
              <tbody id="sent-soumissions-body">
                <tr>
                  <td colspan="6" class="empty-state">
                    <i class="fas fa-check-circle" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
                    <p style="font-size: 1rem;">Aucune soumission envoy√©e</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Vue Mobile: Cards -->
          <div id="sent-soumissions-mobile">
            <div id="sent-soumissions-mobile-list">
              <div class="soumissions-empty-mobile">
                <i class="fas fa-check-circle"></i>
                <p>Aucune soumission envoy√©e</p>
              </div>
            </div>
          </div>
        </div>

        </div><!-- Fin box-body -->
      </div><!-- Fin box -->
    </div><!-- Fin status-cards-grid -->
  </div><!-- Fin pending-soumissions-section -->

  </div><!-- Fin de .main-content pour extraction SPA -->

<script>
// ‚ö° ACTIVATION DES LOGS - Pour debugging et monitoring
window.log = window.log || ((...args) => console.log('[SOUMISSION]', ...args));
window.warn = window.warn || ((...args) => console.warn('[SOUMISSION]', ...args));
window.error = window.error || ((...args) => console.error('[SOUMISSION]', ...args));
window.info = window.info || ((...args) => console.info('[SOUMISSION]', ...args));
window.debug = window.debug || ((...args) => console.debug('[SOUMISSION]', ...args));

// Fonction pour retourner √† la page Outils
function goBackToOutils() {
  // V√©rifier si on est dans une iframe (syst√®me outils-mobile.html)
  if (window.parent && window.parent !== window && typeof window.parent.returnToToolsGrid === 'function') {
    // Nouveau syst√®me: appeler la fonction du parent pour retourner √† la grille
    console.log('[SOUMISSION] Retour √† la grille via parent.returnToToolsGrid()');
    window.parent.returnToToolsGrid();
  } else if (window.parent && window.parent !== window) {
    // Ancien syst√®me: utiliser l'historique (pour compatibilit√©)
    console.log('[SOUMISSION] Retour via history.back()');
    window.history.back();
  } else if (window.top && window.top !== window) {
    // Deuxi√®me niveau d'iframe
    window.history.back();
  } else {
    // Pas dans un iframe - redirection directe
    window.location.href = 'outilsmobile.html';
  }
}

// Fonction pour assurer la visibilit√© du bouton retour - D√âSACTIV√âE (g√©r√© par CSS)
function ensureBackButtonVisible() {
  // Ne rien faire - la visibilit√© est g√©r√©e par CSS responsive
}

// Fonction pour forcer les permissions et visibilit√© des √©l√©ments selon le r√¥le
function enforceRoleBasedVisibility() {
  ensureBackButtonVisible();
  log('Role-based visibility enforced - User:', window.username);
}

// Fonction pour calculer automatiquement le d√©p√¥t bas√© sur le prix
function calculerDepot() {
  const prixInput = document.querySelector('input[name="prix"]');
  const depotInput = document.querySelector('input[name="depot"]');

  if (!prixInput || !depotInput) return;

  // Ne pas recalculer si l'utilisateur a modifi√© manuellement le d√©p√¥t
  if (depotInput.dataset.userModified === 'true') return;

  const prixValue = prixInput.value.trim();
  if (!prixValue) {
    depotInput.value = '';
    return;
  }

  // Nettoyer le prix (enlever $, espaces, etc.)
  let cleaned = prixValue.replace(/[^\d\s\u00A0.,]/g, '');
  cleaned = cleaned.replace(/[\s\u00A0]+/g, '');

  // G√©rer le format fran√ßais (virgule d√©cimale)
  const lastCommaIndex = cleaned.lastIndexOf(',');
  const lastDotIndex = cleaned.lastIndexOf('.');
  if (lastCommaIndex > lastDotIndex && lastCommaIndex === cleaned.length - 3) {
    cleaned = cleaned.substring(0, lastCommaIndex) + '.' + cleaned.substring(lastCommaIndex + 1);
  }
  cleaned = cleaned.replace(/,/g, '');

  const prix = parseFloat(cleaned);
  if (isNaN(prix)) {
    depotInput.value = '';
    return;
  }

  // Calculer les taxes (comme dans le PDF)
  const tps = Math.round(prix * 0.05 * 100) / 100;  // 5% TPS arrondi √† 2 d√©cimales
  const tvq = Math.round(prix * 0.09975 * 100) / 100;  // 9.975% TVQ arrondi √† 2 d√©cimales
  const totalAvecTaxes = prix + tps + tvq;

  // Calculer 25% du total avec taxes comme d√©p√¥t
  const depot = Math.round(totalAvecTaxes * 0.25 * 100) / 100;

  // Formater le d√©p√¥t exactement comme le prix (avec virgule et espace pour milliers)
  const depotFormate = new Intl.NumberFormat('fr-CA', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(depot);

  depotInput.value = depotFormate + ' $';
  depotInput.style.setProperty('border-right-color', '#4caf50', 'important');
}

// Marquer le d√©p√¥t comme modifi√© manuellement
document.addEventListener('DOMContentLoaded', () => {
  const depotInput = document.querySelector('input[name="depot"]');
  if (depotInput) {
    depotInput.addEventListener('input', (e) => {
      // Si l'utilisateur tape quelque chose, marquer comme modifi√© manuellement
      if (e.isTrusted) { // Seulement pour les √©v√©nements r√©els de l'utilisateur
        depotInput.dataset.userModified = 'true';
      }
    });

    // R√©initialiser le flag si le champ est vid√©
    depotInput.addEventListener('blur', () => {
      if (!depotInput.value.trim()) {
        delete depotInput.dataset.userModified;
      }
    });
  }
});

// S'assurer que le bouton est toujours visible - TOUS les √©v√©nements possibles
document.addEventListener('DOMContentLoaded', enforceRoleBasedVisibility);
window.addEventListener('load', enforceRoleBasedVisibility);
window.addEventListener('pageshow', enforceRoleBasedVisibility);

// Ex√©cution imm√©diate si le DOM est d√©j√† charg√©
if (document.readyState !== 'loading') {
  enforceRoleBasedVisibility();
}

// V√©rification r√©p√©t√©e pour s'assurer que tout reste correct
setTimeout(enforceRoleBasedVisibility, 100);
setTimeout(enforceRoleBasedVisibility, 500);
setTimeout(enforceRoleBasedVisibility, 1000);

document.getElementById("voirPDFBtn").addEventListener("click", async () => {
  // Les popups g√®rent d√©j√† les champs cach√©s, pas besoin de updateProduitCouleursHidden()
  // qui √©tait pour l'ancien syst√®me de tags
  const btn = document.getElementById("voirPDFBtn");
  const originalText = btn.innerHTML;

  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Chargement...';

  const form = document.getElementById("soumissionForm");

  const data = {
    username: window.username,
    nom: form.nom.value,
    prenom: form.prenom.value,
    telephone: form.telephone.value,
    courriel: form.courriel.value,
    date: form.date_creation.value,
    temps: form.temps.value,
    num: form.num.value,
    date2: form.date_travaux.value,
    prix: form.prix.value,
    depot: form.depot.value,
    adresse: form.adresse.value,
    endroit: form.endroit_peinture.value,
    produit: document.getElementById("produitCouleursHidden").value,
    item: document.getElementById("itemHidden").value,
    part: document.getElementById("partTravauxHidden").value,
    payer_par: window.dropdownStates?.paidBy || "Virement Interac",
  };

  // MODE PR√âSENTATION - Toujours utiliser ce mode pour "Pr√©senter au client"
  if (false) { // Ancien mode "Voir en PDF" d√©sactiv√© - utiliser le bouton "Enregistrer sans envoyer" √† la place
    try {
      const response = await fetch(`${window.location.origin}/preview-pdf?username=${window.username}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        throw new Error("Erreur lors de la cr√©ation du PDF");
      }

      const blob = await response.blob();
      const url = URL.createObjectURL(blob);

      const pdfjsLib = window['pdfjs-dist/build/pdf'];
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.worker.min.js';

      const pdf = await pdfjsLib.getDocument(url).promise;
      const numPages = pdf.numPages;

      // Chercher le conteneur du canvas
      let pdfScrollContainer = document.getElementById("pdfScrollContainer");
      if (!pdfScrollContainer && window.parent && window.parent.document) {
        pdfScrollContainer = window.parent.document.getElementById("pdfScrollContainer");
      }

      if (!pdfScrollContainer) {
        throw new Error("Container pdfScrollContainer non trouv√©");
      }

      // Vider le conteneur et cr√©er les canvas pour toutes les pages
      const canvasContainer = pdfScrollContainer.querySelector('div[style*="position: relative"]');

      // Sauvegarder le signatureOverlay s'il existe (on ne veut pas l'afficher en mode "Voir PDF")
      let signatureOverlayHTML = null;
      const existingSignature = canvasContainer.querySelector('#signatureOverlay');
      if (existingSignature) {
        existingSignature.remove(); // Le retirer pour le mode "Voir PDF"
      }

      // Vider les anciens canvas
      const oldCanvases = canvasContainer.querySelectorAll('canvas');
      oldCanvases.forEach(cnv => cnv.remove());

      // √âchelle adapt√©e selon mobile/desktop - mobile plus zoomer par d√©faut
      const isMobile = window.innerWidth <= 1200;
      let currentScale = isMobile ? 1.4 : 2;
      const minScale = 0.5;
      const maxScale = 3.0;

      // Fonction pour rendre toutes les pages au scale actuel
      const renderAllPages = async (scale) => {
        // Vider les anciens canvas
        const oldCanvases = canvasContainer.querySelectorAll('canvas');
        oldCanvases.forEach(cnv => cnv.remove());

        // Rendre toutes les pages
        for (let pageNum = 1; pageNum <= numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const viewport = page.getViewport({ scale: scale });

          // Cr√©er un nouveau canvas pour cette page
          const canvas = document.createElement('canvas');
          canvas.id = `pdfCanvas-page${pageNum}`;
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          canvas.style.display = 'block';
          canvas.style.marginBottom = pageNum < numPages ? '10px' : '0';
          canvas.tabIndex = -1;

          const context = canvas.getContext('2d');

          // Ajouter le canvas au conteneur
          canvasContainer.appendChild(canvas);

          // Rendu de la page
          await page.render({ canvasContext: context, viewport: viewport }).promise;
        }
      };

      // Rendu initial
      await renderAllPages(currentScale);

      // R√©f√©rencer le premier canvas pour la compatibilit√© avec le code existant
      const canvas = canvasContainer.querySelector('canvas');

      // Sur MOBILE uniquement: d√©placer modal vers parent pour passer au-dessus des headers
      const doc = canvas.ownerDocument;
      let pdfModal = doc.getElementById("pdfModal");
      let pdfOverlay = doc.getElementById("pdfOverlay");
      let closePdfBtn = doc.getElementById("closePdfBtn");

      if (isMobile && window.parent) {
        // Sur mobile: 2 niveaux d'iframes (soumission ‚Üí outils-mobile ‚Üí apppc)
        // Sur desktop: 1 seul niveau (soumission ‚Üí apppc)
        // D√©tecter si on est dans une iframe imbriqu√©e
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        console.log('[MODAL PDF] Niveaux iframe:', isNestedIframe ? '2 (mobile)' : '1 (desktop)');

        if (rootWindow && rootWindow.document) {
          const parentBody = rootWindow.document.body;
          const parentDoc = rootWindow.document;

          // Injecter les styles n√©cessaires dans le parent si pas d√©j√† fait
          if (!parentDoc.getElementById('soumission-modal-styles')) {
            const styleLink = parentDoc.createElement('link');
            styleLink.id = 'soumission-modal-styles';
            styleLink.rel = 'stylesheet';
            styleLink.href = '/frontend/Entrepreneurs/Outils/Soumission/soumission.css';
            parentDoc.head.appendChild(styleLink);

            const baseLink = parentDoc.createElement('link');
            baseLink.id = 'base-css-for-modal';
            baseLink.rel = 'stylesheet';
            baseLink.href = '/base.css';
            parentDoc.head.appendChild(baseLink);
          }

          // D√©placer vers le body parent si pas d√©j√† fait
          if (pdfModal && pdfModal.parentElement !== parentBody) {
            parentBody.appendChild(pdfModal);
            parentBody.appendChild(pdfOverlay);
            console.log('[MODAL PDF] D√©plac√© vers document racine (apppc.html)');
          }

          // Bloquer le scroll du parent
          parentBody.style.overflow = "hidden";
          parentBody.classList.add('modal-open');
        }
      }

      pdfModal.classList.remove("hidden");
      pdfOverlay.style.display = "block";
      closePdfBtn.classList.remove("hidden");

      // Bloquer le scroll en background
      document.body.classList.add('modal-open');

      // Sur mobile: cacher zoom slider et footer (pinch zoom avec doigts)
      if (isMobile) {
        const zoomSliderContainer = pdfModal.querySelector('#zoomSliderContainer');
        const pdfFooterActions = pdfModal.querySelector('#pdfFooterActions');
        if (zoomSliderContainer) zoomSliderContainer.style.display = 'none';
        if (pdfFooterActions) pdfFooterActions.style.display = 'none';
      }

      // ===== ZOOM AVEC PINCH-TO-ZOOM ET PAN/DRAG SUR MOBILE =====

      // Support du pinch-to-zoom ET pan/drag sur mobile
      if (isMobile) {
        let initialDistance = 0;
        let initialScale = currentScale;
        let isPanning = false;
        let startX = 0;
        let startY = 0;
        let scrollLeftStart = 0;
        let scrollTopStart = 0;

        const getDistance = (touches) => {
          const dx = touches[0].clientX - touches[1].clientX;
          const dy = touches[0].clientY - touches[1].clientY;
          return Math.sqrt(dx * dx + dy * dy);
        };

        pdfScrollContainer.addEventListener('touchstart', (e) => {
          if (e.touches.length === 2) {
            // Pinch-to-zoom avec 2 doigts
            e.preventDefault();
            isPanning = false;
            initialDistance = getDistance(e.touches);
            initialScale = currentScale;
          } else if (e.touches.length === 1) {
            // Pan/drag avec 1 doigt
            isPanning = true;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            scrollLeftStart = pdfScrollContainer.scrollLeft;
            scrollTopStart = pdfScrollContainer.scrollTop;
          }
        }, { passive: false });

        pdfScrollContainer.addEventListener('touchmove', (e) => {
          if (e.touches.length === 2) {
            // Pinch-to-zoom avec CSS transform (fluide comme le slider PC)
            e.preventDefault();
            isPanning = false;
            const distance = getDistance(e.touches);
            const scaleChange = distance / initialDistance;
            let newScale = initialScale * scaleChange;

            // Limiter le zoom (100% - 200% pour mobile)
            newScale = Math.max(1.0, Math.min(2.0, newScale));
            currentScale = newScale;

            // Utiliser CSS transform pour un zoom fluide (comme le slider PC)
            const cssScale = currentScale;
            canvasContainer.style.transform = `scale(${cssScale})`;
            canvasContainer.style.transformOrigin = 'top center';
          } else if (e.touches.length === 1 && isPanning) {
            // Pan/drag dans toutes les directions
            e.preventDefault();
            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;

            const deltaX = startX - currentX;
            const deltaY = startY - currentY;

            pdfScrollContainer.scrollLeft = scrollLeftStart + deltaX;
            pdfScrollContainer.scrollTop = scrollTopStart + deltaY;
          }
        }, { passive: false });

        pdfScrollContainer.addEventListener('touchend', (e) => {
          if (e.touches.length < 2) {
            initialDistance = 0;
          }
          if (e.touches.length === 0) {
            isPanning = false;
          }
        });

        console.log('[PDF MOBILE] Pan/drag activ√© - glissez avec 1 doigt pour bouger, 2 doigts pour zoomer');
      }

      // Support du zoom avec Ctrl+molette sur desktop
      pdfScrollContainer.addEventListener('wheel', async (e) => {
        if (e.ctrlKey) {
          e.preventDefault();

          // D√©terminer la direction du zoom
          const delta = e.deltaY > 0 ? -0.1 : 0.1;
          let newScale = currentScale + delta;

          // Limiter le zoom
          newScale = Math.max(minScale, Math.min(maxScale, newScale));

          if (newScale !== currentScale) {
            currentScale = newScale;
            await renderAllPages(currentScale);
          }
        }
      }, { passive: false });

      // Cacher les boutons de pr√©sentation (signature, accepter, annuler)
      const signatureOverlay = doc.getElementById('signatureOverlay');
      const acceptBtn = doc.getElementById('acceptPresentationBtn');
      const cancelBtn = doc.getElementById('cancelPresentationBtn');

      if (signatureOverlay) signatureOverlay.style.display = 'none';
      if (acceptBtn) acceptBtn.style.display = 'none';
      if (cancelBtn) cancelBtn.style.display = 'none';

      // Stocker rootWindow pour la fermeture (important pour mobile)
      let modalRootWindow = null;
      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        modalRootWindow = isNestedIframe ? window.parent.parent : window.parent;
      }

      // Fonction de fermeture simple
      const closePDF = () => {
        console.log('[MODAL PDF] Fermeture du modal...');

        // R√©cup√©rer les √©l√©ments depuis le bon document (apppc.html si d√©plac√©)
        let modalToClose, overlayToClose, btnToClose;

        if (modalRootWindow && modalRootWindow.document) {
          // Chercher dans le document racine (apppc.html)
          modalToClose = modalRootWindow.document.getElementById("pdfModal");
          overlayToClose = modalRootWindow.document.getElementById("pdfOverlay");
          btnToClose = modalRootWindow.document.getElementById("closePdfBtn");
          console.log('[MODAL PDF] √âl√©ments trouv√©s dans document racine (apppc.html)');
        } else {
          // Chercher dans l'iframe actuelle
          modalToClose = pdfModal;
          overlayToClose = pdfOverlay;
          btnToClose = closePdfBtn;
          console.log('[MODAL PDF] √âl√©ments trouv√©s dans iframe');
        }

        // IMPORTANT: Si mobile, ramener dans l'iframe D'ABORD avant de cacher
        if (isMobile && modalRootWindow && modalRootWindow.document) {
          const parentBody = modalRootWindow.document.body;

          // Ramener le modal dans l'iframe
          if (modalToClose && modalToClose.parentElement === parentBody) {
            document.body.appendChild(modalToClose);
            console.log('[MODAL PDF] Modal ramen√© dans iframe');
          }

          // Ramener l'overlay dans l'iframe
          if (overlayToClose && overlayToClose.parentElement === parentBody) {
            document.body.appendChild(overlayToClose);
            console.log('[MODAL PDF] Overlay ramen√© dans iframe');
          }

          // D√©bloquer le scroll du parent
          parentBody.style.overflow = "auto";
          parentBody.classList.remove('modal-open');
          console.log('[MODAL PDF] Scroll parent d√©bloqu√©');
        }

        // MAINTENANT cacher les √©l√©ments (apr√®s les avoir ramen√©s dans l'iframe)
        if (modalToClose) {
          modalToClose.classList.add("hidden");
          console.log('[MODAL PDF] Modal cach√©');
        }
        if (overlayToClose) {
          overlayToClose.style.display = "none";
          console.log('[MODAL PDF] Overlay cach√©');
        }
        if (btnToClose) {
          btnToClose.classList.add("hidden");
        }

        // Nettoyer tous les canvas
        const allCanvases = canvasContainer.querySelectorAll('canvas');
        allCanvases.forEach(cnv => {
          const ctx = cnv.getContext('2d');
          ctx.clearRect(0, 0, cnv.width, cnv.height);
          cnv.style.transform = ''; // Reset zoom
        });

        URL.revokeObjectURL(url);

        // Event listeners seront nettoy√©s automatiquement

        // D√©bloquer le scroll en background
        document.body.classList.remove('modal-open');
        document.body.style.overflow = 'auto';

        // R√©afficher les boutons et le footer pour le prochain mode pr√©sentation
        if (signatureOverlay) signatureOverlay.style.display = 'block';
        if (acceptBtn) acceptBtn.style.display = 'block';
        if (cancelBtn) cancelBtn.style.display = 'block';
        const pdfFooterActions = doc.getElementById('pdfFooterActions');
        if (pdfFooterActions) pdfFooterActions.style.display = 'flex';

        console.log('[MODAL PDF] ‚úÖ Modal ferm√© - retour √† la page');
      };

      closePdfBtn.onclick = closePDF;
      pdfOverlay.onclick = closePDF;

      // R√©initialiser le bouton
      btn.disabled = false;
      btn.innerHTML = originalText;

      return; // Sortir ici, ne pas continuer avec le mode pr√©sentation
    } catch (error) {
      error('[ERROR] Erreur g√©n√©ration PDF:', error);
      alert('Erreur lors de la g√©n√©ration du PDF');
      btn.disabled = false;
      btn.innerHTML = originalText;
      return;
    }
  }

  // MODE PR√âSENTATION (Envoyer maintenant) - Continuer avec le code existant
  // Stocker les donn√©es du formulaire pour la signature
  currentFormData = data;

  log('[DEBUG] PR√âSENTATION - Produit envoy√©:', data.produit);
  log('[DEBUG] PR√âSENTATION - Part envoy√©:', data.part);

  try {
    // Pour la pr√©sentation, on utilise juste preview-pdf (pas de cr√©ation en attente)
    // La soumission sera cr√©√©e uniquement si le client signe
    const response = await fetch(`${window.location.origin}/preview-pdf?username=${window.username}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    if (!response.ok) {
      const errText = await response.text();
      throw new Error("Erreur lors de la cr√©ation du PDF : " + errText);
    }

    const blob = await response.blob();
    const url = URL.createObjectURL(blob);

    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.worker.min.js';

    const pdf = await pdfjsLib.getDocument(url).promise;
    const numPages = pdf.numPages;

    // Stocker le PDF pour le popup zoom
    currentPdfDocument = pdf;
    currentPdfPage = await pdf.getPage(1); // Garder la r√©f√©rence √† la page 1 pour compatibilit√©

    // Chercher le conteneur
    const pdfScrollContainer = document.getElementById("pdfScrollContainer");
    if (!pdfScrollContainer) {
      throw new Error("Container pdfScrollContainer non trouv√©");
    }

    // Vider le conteneur et cr√©er les canvas pour toutes les pages
    const canvasContainer = pdfScrollContainer.querySelector('div[style*="position: relative"]');

    // Sauvegarder le signatureOverlay s'il existe (on veut le garder en mode "Pr√©senter au client")
    let savedSignatureOverlay = null;
    const existingSignature = canvasContainer.querySelector('#signatureOverlay');
    if (existingSignature) {
      savedSignatureOverlay = existingSignature.cloneNode(true); // Cloner pour le remettre apr√®s
      existingSignature.remove();
    }

    // Vider les anciens canvas
    const oldCanvases = canvasContainer.querySelectorAll('canvas');
    oldCanvases.forEach(cnv => cnv.remove());

    // √âchelle adapt√©e selon mobile/desktop - mobile plus zoomer par d√©faut
    const isMobilePresent = window.innerWidth <= 1200;
    let currentScalePresent = isMobilePresent ? 1.4 : 2;
    const minScalePresent = 0.5;
    const maxScalePresent = 3.0;

    // Fonction pour rendre toutes les pages au scale actuel
    const renderAllPagesPresent = async (scale) => {
      // Sauvegarder la signature avant de vider
      let savedSignatureOverlay = null;
      const existingSignature = canvasContainer.querySelector('#signatureOverlay');
      if (existingSignature) {
        savedSignatureOverlay = existingSignature.cloneNode(true);
        existingSignature.remove();
      }

      // Vider les anciens canvas
      const oldCanvases = canvasContainer.querySelectorAll('canvas');
      oldCanvases.forEach(cnv => cnv.remove());

      // Rendre toutes les pages
      for (let pageNum = 1; pageNum <= numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: scale });

        // Cr√©er un nouveau canvas pour cette page
        const canvas = document.createElement('canvas');
        canvas.id = `pdfCanvas-page${pageNum}`;
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        canvas.style.display = 'block';
        canvas.style.marginBottom = pageNum < numPages ? '10px' : '0';
        canvas.tabIndex = -1;

        const context = canvas.getContext('2d');

        // Ajouter le canvas au conteneur
        canvasContainer.appendChild(canvas);

        // Rendu de la page
        await page.render({ canvasContext: context, viewport: viewport }).promise;
      }

      // Remettre la signature si elle existait
      if (savedSignatureOverlay) {
        canvasContainer.appendChild(savedSignatureOverlay);

        // Positionner la signature en bas de la PREMI√àRE page seulement
        // Valeurs de base √† scale 1 (2x plus petite, plus en bas √† gauche)
        const baseLeft = 86.5;
        const baseWidth = 90;
        const baseHeight = 22;
        const baseBottomOffset = 88;

        // Appliquer le scale
        const scaledLeft = baseLeft * scale;
        const scaledWidth = baseWidth * scale;
        const scaledHeight = baseHeight * scale;
        const scaledBottomOffset = baseBottomOffset * scale;

        const firstCanvas = canvasContainer.querySelector('canvas');
        if (firstCanvas) {
          const firstPageHeight = firstCanvas.height;
          const topPosition = firstPageHeight - scaledBottomOffset - scaledHeight;

          savedSignatureOverlay.style.bottom = 'auto';
          savedSignatureOverlay.style.top = topPosition + 'px';
          savedSignatureOverlay.style.left = scaledLeft + 'px';
          savedSignatureOverlay.style.width = scaledWidth + 'px';
          savedSignatureOverlay.style.height = scaledHeight + 'px';

          // Mettre √† jour aussi la taille du signaturePreview interne
          const signaturePreview = savedSignatureOverlay.querySelector('#signaturePreview');
          if (signaturePreview) {
            signaturePreview.style.height = scaledHeight + 'px';
          }

          // R√©attacher le onclick apr√®s le clone (cloneNode ne copie pas les events)
          const isMobileCheck = window.innerWidth <= 1200;
          if (!isMobileCheck) {
            savedSignatureOverlay.onclick = () => {
              log('[DEBUG] Click sur signature overlay d√©tect√© (apr√®s zoom)!');
              window.openSignatureZoomPopup();
            };
          }
        }
      }
    };

    // Rendu initial
    await renderAllPagesPresent(currentScalePresent);

    // Remettre le signatureOverlay apr√®s les canvas (mode pr√©sentation)
    if (savedSignatureOverlay) {
      canvasContainer.appendChild(savedSignatureOverlay);

      // Positionner la signature en bas de la PREMI√àRE page seulement
      // Valeurs de base √† scale 1 (2x plus petite, plus en bas √† gauche)
      const baseLeft = 86.5;
      const baseWidth = 90;
      const baseHeight = 22;
      const baseBottomOffset = 88;

      // Appliquer le scale
      const scaledLeft = baseLeft * currentScalePresent;
      const scaledWidth = baseWidth * currentScalePresent;
      const scaledHeight = baseHeight * currentScalePresent;
      const scaledBottomOffset = baseBottomOffset * currentScalePresent;

      const firstCanvas = canvasContainer.querySelector('canvas');
      if (firstCanvas) {
        const firstPageHeight = firstCanvas.height;
        const topPosition = firstPageHeight - scaledBottomOffset - scaledHeight;

        savedSignatureOverlay.style.bottom = 'auto';
        savedSignatureOverlay.style.top = topPosition + 'px';
        savedSignatureOverlay.style.left = scaledLeft + 'px';
        savedSignatureOverlay.style.width = scaledWidth + 'px';
        savedSignatureOverlay.style.height = scaledHeight + 'px';

        // Mettre √† jour aussi la taille du signaturePreview interne
        const signaturePreview = savedSignatureOverlay.querySelector('#signaturePreview');
        if (signaturePreview) {
          signaturePreview.style.height = scaledHeight + 'px';
        }

        // R√©attacher le onclick apr√®s le clone (cloneNode ne copie pas les events)
        const isMobileCheck = window.innerWidth <= 1200;
        if (!isMobileCheck) {
          savedSignatureOverlay.onclick = () => {
            log('[DEBUG] Click sur signature overlay d√©tect√© (apr√®s init)!');
            window.openSignatureZoomPopup();
          };
        }
      }
    }

    // R√©f√©rencer le premier canvas pour la compatibilit√© avec le code existant
    const canvas = canvasContainer.querySelector('canvas');

    // Afficher modal et overlay
    document.getElementById("pdfModal").classList.remove("hidden");
    document.getElementById("pdfOverlay").style.display = "block";
    document.getElementById("closePdfBtn").classList.remove("hidden");

    // S'assurer que le footer est visible (peut avoir √©t√© cach√© par "Voir en PDF")
    const pdfFooterActions = document.getElementById("pdfFooterActions");
    if (pdfFooterActions) pdfFooterActions.style.display = "flex";

    // R√©initialiser l'√©tat de la signature
    hasPresentationSignature = false;

    // Configurer le bouton (m√™me comportement sur mobile et desktop)
    const isMobilePresentation = window.innerWidth <= 1200;
    const acceptBtn = document.getElementById('acceptPresentationBtn');
    const acceptBtnSpan = acceptBtn.querySelector('span');

    // Bouton gris d√©sactiv√© "Accepter la soumission" - la signature se fait en cliquant sur le PDF
    acceptBtn.disabled = true;
    acceptBtn.classList.remove('btn-success');
    acceptBtn.setAttribute('style', 'background-color: rgba(148, 163, 184, 0.3) !important; color: rgba(203, 213, 225, 0.5) !important; pointer-events: none !important;');
    acceptBtnSpan.textContent = 'Accepter la soumission';

    // MODE PR√âSENTATION: D√©placer modal et overlay vers parent, puis cacher AppPC
    const pdfModal = document.getElementById("pdfModal");
    const pdfOverlay = document.getElementById("pdfOverlay");
    const closePdfBtn = document.getElementById("closePdfBtn");

    // D√©tecter si iframe imbriqu√©e (mobile: 2 niveaux) ou directe (desktop: 1 niveau)
    const isNestedIframe = window.parent && window.parent.parent && window.parent.parent !== window.parent;
    const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

    console.log('[MODAL PR√âSENTATION] Niveaux iframe:', isNestedIframe ? '2 (mobile)' : '1 (desktop)');

    const parentBody = rootWindow.document.body;
    const parentDoc = rootWindow.document;

    // Injecter les styles n√©cessaires dans le parent si pas d√©j√† fait
    if (!parentDoc.getElementById('soumission-modal-styles')) {
      const styleLink = parentDoc.createElement('link');
      styleLink.id = 'soumission-modal-styles';
      styleLink.rel = 'stylesheet';
      styleLink.href = '/frontend/Entrepreneurs/Outils/Soumission/soumission.css';
      parentDoc.head.appendChild(styleLink);

      const baseLink = parentDoc.createElement('link');
      baseLink.id = 'base-css-for-modal';
      baseLink.rel = 'stylesheet';
      baseLink.href = '/base.css';
      parentDoc.head.appendChild(baseLink);
    }

    // D√©placer vers le body parent si pas d√©j√† fait
    if (pdfModal && pdfModal.parentElement !== parentBody) {
      parentBody.appendChild(pdfModal);
      parentBody.appendChild(pdfOverlay);
      console.log('[MODAL PR√âSENTATION] D√©plac√© vers document racine (apppc.html)');
    }

    // R√©cup√©rer le closePdfBtn depuis le modal d√©plac√© (important!)
    const closePdfBtnMoved = pdfModal.querySelector('#closePdfBtn');
    log('[DEBUG] closePdfBtnMoved trouv√©:', closePdfBtnMoved);
    if (closePdfBtnMoved) {
      closePdfBtnMoved.classList.remove("hidden");
      log('[DEBUG] Classe hidden retir√©e du bouton X');
    }

    // Attacher l'√©v√©nement de signature via JavaScript
    // Chercher dans l'iframe d'abord, puis dans le parent (apr√®s d√©placement)
    let signatureOverlay = document.getElementById('signatureOverlay');
    if (!signatureOverlay && pdfModal.parentElement === parentBody) {
      // Le modal a √©t√© d√©plac√©, chercher dans le modal d√©plac√©
      signatureOverlay = pdfModal.querySelector('#signatureOverlay');
    }

    log('[DEBUG] signatureOverlay trouv√©:', signatureOverlay);

    if (signatureOverlay) {
      // Cliquer sur l'overlay pour signer (mobile et desktop identique)
      signatureOverlay.onclick = () => {
        log('[DEBUG] Click sur signature overlay d√©tect√©!');

        // Cr√©er un overlay de chargement temporaire
        const loadingOverlay = document.createElement('div');
        loadingOverlay.style.cssText = `
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
        `;
        loadingOverlay.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #333;"></i>';
        signatureOverlay.appendChild(loadingOverlay);
        signatureOverlay.style.cursor = 'wait';

        // Attendre 1 seconde puis ouvrir le popup
        setTimeout(() => {
          if (loadingOverlay.parentElement) {
            loadingOverlay.remove();
          }
          signatureOverlay.style.cursor = 'pointer';
          window.openSignatureZoomPopup();
        }, 1000);
      };
      log('[DEBUG] √âv√©nement onclick attach√© √† signatureOverlay (mobile et desktop)');

      // Mettre √† jour la position de la signature apr√®s un petit d√©lai (attendre le rendu)
      setTimeout(() => {
        if (window.updateSignatureOverlayPosition) {
          window.updateSignatureOverlayPosition();
        }
      }, 100);
    } else {
      error('[ERROR] signatureOverlay non trouv√©!');
    }

    // Attacher l'√©v√©nement au bouton "Accepter" apr√®s le d√©placement
    log('[DEBUG] Appel de attachAcceptButtonEvent apr√®s d√©placement modal');
    if (window.attachAcceptButtonEvent) {
      window.attachAcceptButtonEvent();
    }

    // Maintenant cacher AppPC
    const appContainer = rootWindow.document.querySelector('#app-container');
    if (appContainer) {
      appContainer.style.display = 'none';
      console.log('[MODAL PR√âSENTATION] AppPC cach√©');
    }

    // Bloquer le scroll de l'arri√®re-plan (iframe et parent)
    document.body.style.overflow = "hidden";
    document.body.classList.add('modal-open');
    if (parentBody) {
      parentBody.style.overflow = "hidden";
      parentBody.classList.add('modal-open');
    }

    // ===== ZOOM FLUIDE AVEC PINCH-TO-ZOOM, CTRL+MOLETTE ET SLIDER (Pr√©senter au client) =====
    const pdfScrollContainerPresent = pdfModal.querySelector('#pdfScrollContainer');
    const zoomSlider = pdfModal.querySelector('#pdfZoomSlider');
    const zoomPercentage = pdfModal.querySelector('#zoomPercentage');

    // Variables de zoom globales pour cette pr√©sentation
    let currentZoomPercent = 100;
    const minZoom = 50;  // 50%
    const maxZoom = 200; // 200%

    // Fonction pour appliquer le zoom (utilis√©e par tous: slider, pinch, ctrl+molette)
    const applyZoom = (zoomPercent) => {
      // Limiter le zoom
      zoomPercent = Math.max(minZoom, Math.min(maxZoom, zoomPercent));
      currentZoomPercent = zoomPercent;

      const cssScale = zoomPercent / 100;

      // Appliquer le transform CSS (fluide)
      canvasContainer.style.transform = `scale(${cssScale})`;
      canvasContainer.style.transformOrigin = 'top left';
      canvasContainer.style.transition = 'transform 0.1s ease-out';

      // Mettre √† jour le slider et l'affichage
      if (zoomSlider) {
        // Ajuster la valeur du slider (born√© entre min et max du slider)
        const sliderValue = Math.max(parseInt(zoomSlider.min), Math.min(parseInt(zoomSlider.max), zoomPercent));
        zoomSlider.value = sliderValue;
        updateSliderGradient(sliderValue);
      }
      if (zoomPercentage) {
        zoomPercentage.textContent = Math.round(zoomPercent) + '%';
      }
    };

    // Mettre √† jour le gradient du slider
    const updateSliderGradient = (value) => {
      if (!zoomSlider) return;
      const min = parseInt(zoomSlider.min);
      const max = parseInt(zoomSlider.max);
      const percent = (value - min) / (max - min) * 100;
      zoomSlider.style.background = `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${percent}%, #475569 ${percent}%, #475569 100%)`;
    };

    // Initialiser le slider
    if (zoomSlider) {
      zoomSlider.min = 50;
      zoomSlider.max = 200;
      zoomSlider.value = 100;
      if (zoomPercentage) zoomPercentage.textContent = '100%';
      updateSliderGradient(100);

      // Zoom via slider
      zoomSlider.addEventListener('input', (e) => {
        applyZoom(parseInt(e.target.value));
      });
    }

    // Support du pinch-to-zoom ET pan/drag sur mobile/tablette (CSS transform fluide)
    let initialDistance = 0;
    let initialZoom = 100;
    let isPanning = false;
    let startX = 0;
    let startY = 0;
    let scrollLeftStart = 0;
    let scrollTopStart = 0;

    const getDistance = (touches) => {
      const dx = touches[0].clientX - touches[1].clientX;
      const dy = touches[0].clientY - touches[1].clientY;
      return Math.sqrt(dx * dx + dy * dy);
    };

    if (pdfScrollContainerPresent) {
      pdfScrollContainerPresent.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          // Pinch-to-zoom avec 2 doigts
          e.preventDefault();
          isPanning = false;
          initialDistance = getDistance(e.touches);
          initialZoom = currentZoomPercent;
          // D√©sactiver la transition pendant le pinch pour plus de fluidit√©
          canvasContainer.style.transition = 'none';
        } else if (e.touches.length === 1) {
          // Pan/drag avec 1 doigt
          isPanning = true;
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
          scrollLeftStart = pdfScrollContainerPresent.scrollLeft;
          scrollTopStart = pdfScrollContainerPresent.scrollTop;
        }
      }, { passive: false });

      pdfScrollContainerPresent.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
          // Pinch-to-zoom fluide avec CSS transform
          e.preventDefault();
          isPanning = false;
          const distance = getDistance(e.touches);
          const scaleChange = distance / initialDistance;
          const newZoom = initialZoom * scaleChange;
          applyZoom(newZoom);
        } else if (e.touches.length === 1 && isPanning) {
          // Pan/drag dans toutes les directions
          e.preventDefault();
          const currentX = e.touches[0].clientX;
          const currentY = e.touches[0].clientY;
          const deltaX = startX - currentX;
          const deltaY = startY - currentY;
          pdfScrollContainerPresent.scrollLeft = scrollLeftStart + deltaX;
          pdfScrollContainerPresent.scrollTop = scrollTopStart + deltaY;
        }
      }, { passive: false });

      pdfScrollContainerPresent.addEventListener('touchend', (e) => {
        if (e.touches.length < 2) {
          initialDistance = 0;
          // R√©activer la transition
          canvasContainer.style.transition = 'transform 0.1s ease-out';
        }
        if (e.touches.length === 0) {
          isPanning = false;
        }
      });

      // Ctrl+molette pour zoom sur desktop (fluide avec CSS transform)
      pdfScrollContainerPresent.addEventListener('wheel', (e) => {
        if (e.ctrlKey) {
          e.preventDefault();
          // Zoom in/out selon la direction de la molette
          const zoomDelta = e.deltaY > 0 ? -10 : 10; // -10% ou +10%
          applyZoom(currentZoomPercent + zoomDelta);
        }
      }, { passive: false });

      console.log('[PDF PR√âSENTATION] Zoom fluide activ√© - Pinch/Ctrl+molette/Slider synchronis√©s');
    }

    // Fonction de fermeture
    const closePDF = () => {
      log('[PR√âSENTATION] Fermeture du modal...');

      // Ramener modal et overlay dans l'iframe D'ABORD (avant de cacher)
      if (pdfModal && pdfModal.parentElement === parentBody) {
        document.body.appendChild(pdfModal);
        log('[PR√âSENTATION] Modal ramen√© dans iframe');
      }
      if (pdfOverlay && pdfOverlay.parentElement === parentBody) {
        document.body.appendChild(pdfOverlay);
        log('[PR√âSENTATION] Overlay ramen√© dans iframe');
      }

      // PUIS cacher les √©l√©ments
      if (pdfModal) {
        pdfModal.classList.add("hidden");
        log('[PR√âSENTATION] Modal cach√©');
      }
      if (pdfOverlay) {
        pdfOverlay.style.display = "none";
        log('[PR√âSENTATION] Overlay cach√©');
      }
      if (closePdfBtn) {
        closePdfBtn.classList.add("hidden");
      }

      // Nettoyer tous les canvas
      const allCanvases = canvasContainer.querySelectorAll('canvas');
      allCanvases.forEach(cnv => {
        const ctx = cnv.getContext('2d');
        ctx.clearRect(0, 0, cnv.width, cnv.height);
        cnv.style.transform = ''; // Reset zoom
      });

      URL.revokeObjectURL(url);

      // Restaurer AppPC - IMPORTANT: utiliser rootWindow pour mobile
      const appContainer = rootWindow.document.querySelector('#app-container');
      if (appContainer) {
        appContainer.style.display = '';
        log('[PR√âSENTATION] AppPC r√©affich√©');
      } else {
        error('[PR√âSENTATION] AppPC non trouv√©!');
      }

      // Restaurer le scroll de l'arri√®re-plan (iframe et parent)
      document.body.style.overflow = "";
      document.body.classList.remove('modal-open');
      if (parentBody) {
        parentBody.style.overflow = "";
        parentBody.classList.remove('modal-open');
        log('[PR√âSENTATION] Scroll parent d√©bloqu√©');
      }

      log('[PR√âSENTATION] ‚úÖ Modal ferm√© - retour √† la page');
      // Event listeners seront nettoy√©s automatiquement
    };

    // Utiliser le bouton d√©plac√© pour l'√©v√©nement onclick
    if (closePdfBtnMoved) {
      closePdfBtnMoved.onclick = () => {
        log('[DEBUG] Click sur bouton X d√©tect√©!');
        closePDF();
      };
      log('[DEBUG] √âv√©nement onclick attach√© au bouton X');
    } else {
      error('[ERROR] closePdfBtnMoved non trouv√©, impossible d\'attacher onclick');
    }
    // NE PAS fermer au clic sur l'overlay - seulement avec Annuler ou X

  } catch (error) {
    alert(error.message);
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
});
</script>







  <script>
  // ================================================================
  // CALENDRIER PERSONNALIS√â - FONCTIONS
  // ================================================================

  let creationCurrentDate = new Date();
  let creationSelectedDate = null;

  // Noms des mois en fran√ßais
  const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
    'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

  // Fonction pour ouvrir/fermer le calendrier de cr√©ation
  window.toggleCreationCalendar = function() {
    const calendar = document.getElementById('creationCalendar');
    
    if (calendar.classList.contains('hidden')) {
      calendar.classList.remove('hidden');
      renderCreationCalendar();
    } else {
      calendar.classList.add('hidden');
    }
  };

  // Fonction pour ouvrir le calendrier au clic sur l'input
  window.openCreationCalendar = function() {
    const calendar = document.getElementById('creationCalendar');
    if (calendar.classList.contains('hidden')) {
      calendar.classList.remove('hidden');
      renderCreationCalendar();
    }
  };

  // Fonction pour changer de mois
  window.changeCreationMonth = function(direction) {
    creationCurrentDate.setMonth(creationCurrentDate.getMonth() + direction);
    renderCreationCalendar();
  };

  // Fonction pour g√©n√©rer le calendrier
  function renderCreationCalendar() {
    const calendarDays = document.getElementById('creationCalendarDays');
    const calendarTitle = document.getElementById('creationCalendarTitle');
    
    if (!calendarDays || !calendarTitle) return;
    
    // Mettre √† jour le titre
    calendarTitle.textContent = `${monthNames[creationCurrentDate.getMonth()]} ${creationCurrentDate.getFullYear()}`;
    
    // G√©n√©rer les jours
    const firstDay = new Date(creationCurrentDate.getFullYear(), creationCurrentDate.getMonth(), 1);
    const lastDay = new Date(creationCurrentDate.getFullYear(), creationCurrentDate.getMonth() + 1, 0);
    const firstDayOfWeek = firstDay.getDay();
    const today = new Date();
    
    // Vider le calendrier
    calendarDays.innerHTML = '';
    
    // Ajouter les jours du mois pr√©c√©dent
    for (let i = firstDayOfWeek - 1; i >= 0; i--) {
      const prevDate = new Date(firstDay);
      prevDate.setDate(prevDate.getDate() - (i + 1));
      const dayElement = createCreationDayElement(prevDate, true, today);
      calendarDays.appendChild(dayElement);
    }
    
    // Ajouter les jours du mois actuel
    for (let day = 1; day <= lastDay.getDate(); day++) {
      const date = new Date(creationCurrentDate.getFullYear(), creationCurrentDate.getMonth(), day);
      const dayElement = createCreationDayElement(date, false, today);
      calendarDays.appendChild(dayElement);
    }
    
    // Ajouter les jours du mois suivant pour compl√©ter la grille
    const totalCells = calendarDays.children.length;
    const remainingCells = 42 - totalCells; // 6 semaines * 7 jours
    for (let day = 1; day <= remainingCells; day++) {
      const nextDate = new Date(creationCurrentDate.getFullYear(), creationCurrentDate.getMonth() + 1, day);
      const dayElement = createCreationDayElement(nextDate, true, today);
      calendarDays.appendChild(dayElement);
    }
  }

  // Fonction pour cr√©er un √©l√©ment jour
  function createCreationDayElement(date, isOtherMonth, today) {
    const dayElement = document.createElement('div');
    dayElement.className = 'dashboard-calendar-day';
    dayElement.textContent = date.getDate();
    
    if (isOtherMonth) {
      dayElement.classList.add('other-month');
    }
    
    // Marquer aujourd'hui
    if (date.toDateString() === today.toDateString()) {
      dayElement.classList.add('today');
    }
    
    // Marquer la date s√©lectionn√©e
    const currentInput = document.getElementById('autoDate');
    if (currentInput && currentInput.value) {
      const inputDate = parseCreationDisplayDate(currentInput.value);
      if (inputDate && date.toDateString() === inputDate.toDateString()) {
        dayElement.classList.add('selected');
      }
    }
    // Si aucune date n'est s√©lectionn√©e, pr√©s√©lectionner aujourd'hui
    else if (date.toDateString() === today.toDateString()) {
      dayElement.classList.add('selected');
    }
    
    // Ajouter l'√©v√©nement click
    dayElement.addEventListener('click', function() {
      selectCreationDate(date);
    });
    
    return dayElement;
  }

  // Fonction pour s√©lectionner une date
  function selectCreationDate(date) {
    const input = document.getElementById('autoDate');
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    const formattedDate = `${day}/${month}/${year}`;

    input.value = formattedDate;
    creationSelectedDate = date;

    // Bordure verte quand date s√©lectionn√©e
    input.style.setProperty('border-right-color', '#4caf50', 'important');

    // Fermer le calendrier
    document.getElementById('creationCalendar').classList.add('hidden');

    log('[DATE] Date de cr√©ation s√©lectionn√©e:', formattedDate);
  }

  // Fonction pour parser une date d'affichage (format fran√ßais)
  function parseCreationDisplayDate(dateStr) {
    if (!dateStr) return null;
    const parts = dateStr.split('/');
    if (parts.length === 3) {
      return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    return null;
  }

  // Fermer le calendrier si on clique ailleurs
  document.addEventListener('click', function(e) {
    const calendar = document.getElementById('creationCalendar');
    const container = document.querySelector('.dashboard-calendar-container');
    
    if (calendar && !calendar.classList.contains('hidden') && container && !container.contains(e.target)) {
      calendar.classList.add('hidden');
    }
  });

  function getLocalDateISO() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // Initialiser la date proprement
  function initializeCreationDate() {
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    const formattedDate = `${day}/${month}/${year}`;
    
    const autoDateElement = document.getElementById("autoDate");
    if (autoDateElement) {
      autoDateElement.value = formattedDate;
      creationSelectedDate = today;
      // Bordure verte car date initialis√©e
      autoDateElement.style.setProperty('border-right-color', '#4caf50', 'important');
    }
  }

  // Initialisation d√®s que le DOM est pr√™t
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeCreationDate);
  } else {
    initializeCreationDate();
  }

  // Protection contre les resets du formulaire
  window.addEventListener('load', () => {
    setTimeout(() => {
      const autoDateElement = document.getElementById("autoDate");
      if (autoDateElement && !autoDateElement.value) {
        initializeCreationDate();
      }
    }, 100);
  });

  // ============== G√©n√©ration automatique du num√©ro de soumission ==============
  async function genererNumeroSoumission() {
    const numField = document.querySelector('input[name="num"]');
    if (!numField) {
      warn('[NUM] Champ num√©ro non trouv√©, nouvelle tentative dans 100ms');
      setTimeout(genererNumeroSoumission, 100);
      return;
    }

    log('[NUM] G√©n√©ration du num√©ro de soumission...');

    try {
      const response = await fetch('/api/soumission/generer-numero');
      if (response.ok) {
        const data = await response.json();
        numField.value = data.numero;
        log('[NUM] Num√©ro g√©n√©r√©:', data.numero);
        log('[NUM] Champ apr√®s assignation:', numField.value);

        // V√©rifier que la valeur reste apr√®s un court d√©lai
        setTimeout(() => {
          log('[NUM] V√©rification apr√®s 500ms - Valeur:', numField.value);
          if (!numField.value || numField.value === '') {
            error('[NUM] PROBL√àME: Le champ a √©t√© vid√©! R√©assignation...');
            numField.value = data.numero;
            numField.setAttribute('value', data.numero);
          }
        }, 500);
      } else {
        // Fallback: g√©n√©rer localement si API √©choue
        const suffix = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        numField.value = `26-${suffix}`;
        warn('[NUM] Fallback - Num√©ro g√©n√©r√© localement:', numField.value);
      }
    } catch (error) {
      error('[NUM] Erreur g√©n√©ration num√©ro:', error);
      // Fallback local
      const suffix = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
      numField.value = `26-${suffix}`;
      warn('[NUM] Fallback apr√®s erreur - Num√©ro:', numField.value);
    }
  }

  // R√©server le num√©ro quand la soumission est envoy√©e ou sign√©e
  async function reserverNumeroSoumission() {
    const numField = document.querySelector('input[name="num"]');
    const username = localStorage.getItem('username') || 'unknown';
    if (!numField || !numField.value) return false;

    try {
      const response = await fetch('/api/soumission/reserver-numero', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ numero: numField.value, username: username })
      });

      if (response.status === 409) {
        // Num√©ro d√©j√† utilis√©, en g√©n√©rer un nouveau
        await genererNumeroSoumission();
        return await reserverNumeroSoumission(); // R√©essayer avec le nouveau num√©ro
      }

      return response.ok;
    } catch (error) {
      error('Erreur r√©servation num√©ro:', error);
      return true; // Continuer m√™me si erreur
    }
  }

  // Note: genererNumeroSoumission() est appel√© dans le DOMContentLoaded principal plus bas

  function setupMultiSelect(toggleId, menuId, placeholder) {
    const toggle = document.getElementById(toggleId);
    const menu = document.getElementById(menuId);
    const options = menu.querySelectorAll('.dropdown-option');
    const selected = new Set();

    toggle.addEventListener('click', () => {
      document.querySelectorAll('.dropdown-menu').forEach(m => {
        if (m !== menu) m.classList.add('hidden');
      });
      document.querySelectorAll('.dropdown-toggle').forEach(t => {
        if (t !== toggle) t.classList.remove('active');
      });
      menu.classList.toggle('hidden');
      toggle.classList.toggle('active', !menu.classList.contains('hidden'));
    });

    options.forEach(option => {
      option.addEventListener('click', () => {
        const value = option.dataset.value;
        const check = option.querySelector('.check');

        if (selected.has(value)) {
          selected.delete(value);
          check.textContent = '';
        } else {
          selected.add(value);
          check.textContent = '‚úì';
        }

        updateToggle(toggle, selected, placeholder);
      });
    });

function updateToggle() {
  toggle.innerHTML = "";
  if (selected.length > 0) {
    toggle.classList.add('has-selection');
  } else {
    toggle.classList.remove('has-selection');
  }
  selected.forEach(val => {
    const tag = document.createElement('span');
    tag.className = 'tag';
    tag.textContent = val;
    toggle.appendChild(tag);
  });
  toggle.appendChild(input);

  // üîπ Mettre √† jour le champ cach√©
  const hiddenField = document.getElementById("produitCouleursHidden");
  if (hiddenField) {
    hiddenField.value = selected.join("\n");
  }

  // Cacher le placeholder s'il y a des tags s√©lectionn√©s
  if (selected.length > 0) {
    hidePlaceholder();
  } else if (input !== document.activeElement && input.value.trim() === "") {
    showPlaceholder();
  }
}

  }

function updateProduitCouleursHidden() {
  const toggle = document.getElementById("toggleBox");
  if (!toggle) {
    warn('Element toggleBox non trouv√©');
    return;
  }
  
  const tags = toggle.querySelectorAll(".tag");
  const values = Array.from(tags).map(tag => tag.textContent.trim());

  const inputField = document.getElementById("customProductInput");
  if (inputField && inputField.value.trim() !== "") {
    values.push(inputField.value.trim());
  }

  const hidden = document.getElementById("produitCouleursHidden");
  if (hidden) {
    hidden.value = values.map(item => ` ${item}`).join("\n\n");
  }
}

function updatePartTravauxHidden() {
  const toggle = document.getElementById("partTravauxToggle");
  if (!toggle) {
    warn('Element partTravauxToggle non trouv√©');
    return;
  }
  
  const tags = toggle.querySelectorAll(".tag");
  const values = Array.from(tags).map(tag => tag.textContent.trim());

  const inputField = document.getElementById("customPartTravauxInput");
  if (inputField && inputField.value.trim() !== "") {
    values.push(inputField.value.trim());
  }

  const hidden = document.getElementById("partTravauxHidden");
  if (hidden) {
    hidden.value = values.map(item => `- ${item}`).join("\n\n");
  }
}


function setupMultiSelectWithInput(toggleId, menuId, placeholder, inputId, hiddenId) {
  const toggle = document.getElementById(toggleId);
  const menu = document.getElementById(menuId);
  const options = menu.querySelectorAll('.dropdown-option');
  const selected = [];
  const input = document.getElementById(inputId);
  const hiddenField = document.getElementById(hiddenId);

  // Ouvrir menu + focus input
  toggle.addEventListener('click', (e) => {
    if (e.target === input) return;
    
    // G√©rer la fermeture de l'autre dropdown multi-select
    document.querySelectorAll('#customProductInput, #customPartTravauxInput').forEach(otherInput => {
      if (otherInput !== input && otherInput.style.display === 'inline-block') {
        otherInput.style.display = 'none';
        const otherToggleId = otherInput.id === 'customProductInput' ? 'toggleBox' : 'partTravauxToggle';
        const otherToggle = document.getElementById(otherToggleId);
        
        // V√©rifier les selections existantes
        let hasSelections = false;
        if (otherToggleId === 'toggleBox') {
          hasSelections = otherToggle.querySelectorAll('.tag').length > 0;
        } else {
          hasSelections = otherToggle.querySelectorAll('.tag').length > 0;
        }
        
        // Restaurer placeholder si pas de s√©lections et input vide
        if (!hasSelections && otherInput.value.trim() === "") {
          const placeholderText = otherToggleId === 'toggleBox' ? 
            'Ex: Peinture, couleurs, produits...' : 
            'Ex: Assurance, garantie, √©quipement...';
          if (!otherToggle.querySelector('.placeholder')) {
            otherToggle.insertAdjacentHTML('afterbegin', `<span class="placeholder" style="color: rgb(156 163 175); font-size: 14px;">${placeholderText}</span>`);
          }
        }
      }
    });
    
    document.querySelectorAll('.dropdown-menu').forEach(m => {
      if (m !== menu) m.classList.add('hidden');
    });
    document.querySelectorAll('.dropdown-toggle').forEach(t => {
      if (t !== toggle) t.classList.remove('active');
    });
    menu.classList.toggle('hidden');
    toggle.classList.toggle('active', !menu.classList.contains('hidden'));
    hidePlaceholder();
    input.style.display = 'inline-block';
    input.focus();
    e.stopPropagation();
  });

  // S√©lection depuis la liste
  options.forEach(option => {
    option.addEventListener('click', (e) => {
      const value = option.dataset.value;
      const check = option.querySelector('.check');

      if (selected.includes(value)) {
        selected.splice(selected.indexOf(value), 1);
        check.textContent = '';
      } else {
        selected.push(value);
        check.textContent = '‚úì';
      }
      updateToggle();
      input.focus();
      e.stopPropagation();
    });
  });

  // Ajout via Enter ou suppression via Backspace/Delete
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && input.value.trim() !== "") {
      const value = input.value.trim();
      if (!selected.includes(value)) {
        selected.push(value);
      }
      input.value = "";
      updateToggle();
      input.focus();
      e.preventDefault();
    }
if (e.key === "Backspace" && input.value === "" && selected.length > 0) {
  const removed = selected.pop();
  uncheckMenuOption(removed);
  updateToggle();
  setTimeout(() => input.focus(), 0);
}

if (e.key === "Delete" && document.activeElement === input && selected.length > 0) {
  const removed = selected.pop();
  uncheckMenuOption(removed);
  updateToggle();
  setTimeout(() => input.focus(), 0);
}
  });

  // Placeholder visible seulement si vide et pas focus
  input.addEventListener("blur", () => {
    if (selected.length === 0 && input.value.trim() === "") {
      showPlaceholder();
    }
  });

  input.addEventListener("focus", () => {
    hidePlaceholder();
  });

  // Fermeture quand on clique ailleurs
  document.addEventListener("click", (e) => {
    if (!toggle.contains(e.target) && !menu.contains(e.target)) {
      menu.classList.add('hidden');
      toggle.classList.remove('active');
      input.style.display = 'none';
      if (selected.length === 0 && input.value.trim() === "") {
        showPlaceholder();
      }
    }
  });

  // Fonctions internes
  function updateToggle() {
    toggle.innerHTML = "";
    if (selected.length > 0) {
      toggle.classList.add('has-selection');
    } else {
      toggle.classList.remove('has-selection');
    }
    selected.forEach(val => {
      const tag = document.createElement('span');
      tag.className = 'tag';
      tag.textContent = val;
      toggle.appendChild(tag);
    });
    toggle.appendChild(input);

    // Mise √† jour du champ cach√© li√©
    if (hiddenField) {
      hiddenField.value = selected.map(item => ` ${item}`).join("\n\n");
    }

    // Cacher le placeholder s'il y a des tags s√©lectionn√©s
    if (selected.length > 0) {
      hidePlaceholder();
    } else if (input !== document.activeElement && input.value.trim() === "") {
      showPlaceholder();
    }
  }

  function uncheckMenuOption(value) {
    options.forEach(opt => {
      if (opt.dataset.value === value) {
        opt.querySelector('.check').textContent = '';
      }
    });
  }

  function showPlaceholder() {
    if (!toggle.querySelector('.placeholder') && input.style.display === 'none') {
      toggle.insertAdjacentHTML('afterbegin', `<span class="placeholder" style="color: rgb(156 163 175); font-size: 14px;">${placeholder}</span>`);
    }
  }

  function hidePlaceholder() {
    const ph = toggle.querySelector('.placeholder');
    if (ph) ph.remove();
  }
}


  // setupMultiSelectWithInput('toggleBox', 'productMenu', 'Ex: Peinture, couleurs, produits...', 'customProductInput', 'produitCouleursHidden');
  // setupMultiSelectWithInput('partTravauxToggle', 'partTravauxMenu', 'Ex: Assurance, garantie, √©quipement...', 'customPartTravauxInput', 'partTravauxHidden');

  // // Ajouter les placeholders de base avec exemples - COMMENT√â car remplac√© par popups
  // const toggleBox = document.getElementById('toggleBox');
  // const partTravauxToggle = document.getElementById('partTravauxToggle');
  // 
  // if (toggleBox && !toggleBox.querySelector('.placeholder')) {
  //   toggleBox.insertAdjacentHTML('afterbegin', '<span class="placeholder" style="color: rgb(156 163 175); font-size: 14px;">Ex: Peinture, couleurs, produits...</span>');
  // }
  // 
  // if (partTravauxToggle && !partTravauxToggle.querySelector('.placeholder')) {
  //   partTravauxToggle.insertAdjacentHTML('afterbegin', '<span class="placeholder" style="color: rgb(156 163 175); font-size: 14px;">Ex: Assurance, garantie, √©quipement...</span>');
  // }

  function setupSingleSelect(toggleId, menuId, placeholder) {
    const toggle = document.getElementById(toggleId);
    const menu = document.getElementById(menuId);
    const options = menu.querySelectorAll('.dropdown-option');
    let selectedValue = null;

    toggle.addEventListener('click', () => {
      document.querySelectorAll('.dropdown-menu').forEach(m => {
        if (m !== menu) m.classList.add('hidden');
      });
      document.querySelectorAll('.dropdown-toggle').forEach(t => {
        if (t !== toggle) t.classList.remove('active');
      });
      menu.classList.toggle('hidden');
      toggle.classList.toggle('active', !menu.classList.contains('hidden'));
    });

    options.forEach(option => {
      option.addEventListener('click', () => {
        const value = option.dataset.value;
        if (selectedValue === value) {
          selectedValue = null;
          toggle.classList.remove('has-selection');
          toggle.innerHTML = `<span class="placeholder" style="color: rgb(156 163 175); font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif; font-size: 14px;">${placeholder}</span>`;
          // Mettre √† jour l'√©tat global
          if (window.dropdownStates) {
            if (toggleId === 'paidByToggle') window.dropdownStates.paidBy = null;
          }
          // Bordure rouge quand d√©s√©lectionn√©
          toggle.style.setProperty('border-right-color', '#e57373', 'important');
        } else {
          selectedValue = value;
          toggle.classList.add('has-selection');
          toggle.innerHTML = `<span class="tag">${value}</span>`;
          // Mettre √† jour l'√©tat global
          if (window.dropdownStates) {
            if (toggleId === 'paidByToggle') window.dropdownStates.paidBy = value;
          }
          // Bordure verte quand s√©lectionn√©
          toggle.style.setProperty('border-right-color', '#4caf50', 'important');
        }

        // Fermer le menu apr√®s s√©lection
        menu.classList.add('hidden');
        toggle.classList.remove('active');

        // D√©clencher la validation apr√®s changement
        if (typeof validateRequiredFields === 'function') {
          validateRequiredFields();
        }
      });
    });
  }

  setupSingleSelect('paidByToggle', 'paidByMenu', 'Pay√© par');

  // Exposer les √©tats des dropdowns pour l'auto-fill
  window.dropdownStates = {
    paidBy: 'Virement Interac' // Valeur par d√©faut
  };

  document.addEventListener('click', e => {
    if (!e.target.closest('.dropdown')) {
      document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.add('hidden'));
      document.querySelectorAll('.dropdown-toggle').forEach(toggle => toggle.classList.remove('active'));
    }
  });

  // =====================================
  // ANCIEN SYST√àME SUPPRIM√â - Utilise maintenant genererNumeroSoumission()
  // qui g√©n√®re des num√©ros centralis√©s format 25-XXXX via l'API backend
  // =====================================

  // Fonction pour v√©rifier si un √©l√©ment a une bordure verte
  function hasGreenBorder(element) {
    if (!element) return false;
    // Le champ N¬∞ de soumission est toujours valide car auto-g√©n√©r√©
    if (element.name === 'num') return true;

    // D'abord v√©rifier le style inline (plus fiable car c'est ce qu'on d√©finit)
    const inlineStyle = element.style.borderRightColor;
    log(`[hasGreenBorder] ${element.name || element.id}: inlineStyle = "${inlineStyle}"`);

    // V√©rifier si le style inline contient du vert
    if (inlineStyle) {
      // #4caf50 ou rgb(76, 175, 80) = vert
      if (inlineStyle.includes('4caf50') || inlineStyle.includes('76, 175, 80') || inlineStyle === 'rgb(76, 175, 80)') {
        log(`[hasGreenBorder] => VERT (via inline style)`);
        return true;
      }
      // #e57373 ou rgb(229, 115, 115) = rouge
      if (inlineStyle.includes('e57373') || inlineStyle.includes('229, 115, 115') || inlineStyle === 'rgb(229, 115, 115)') {
        log(`[hasGreenBorder] => ROUGE (via inline style)`);
        return false;
      }
    }

    // Fallback sur getComputedStyle
    const borderColor = getComputedStyle(element).borderRightColor;
    log(`[hasGreenBorder] ${element.name || element.id}: computedStyle = ${borderColor}`);

    // V√©rifier si c'est vert (G > R et G > B)
    const match = borderColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
    if (match) {
      const r = parseInt(match[1]);
      const g = parseInt(match[2]);
      const b = parseInt(match[3]);
      const isGreen = g > r && g > b;
      log(`[hasGreenBorder] R=${r}, G=${g}, B=${b} => isGreen=${isGreen}`);
      return isGreen;
    }
    return false;
  }

  // Liste des champs facultatifs (tout sauf pr√©nom et nom)
  function getOptionalFields() {
    return [
      document.getElementById('adresseAutocomplete'),
      document.getElementById('telephoneInput'),
      document.querySelector('input[name="courriel"]'),
      document.querySelector('input[name="num"]'),
      document.getElementById('autoDate'),
      document.getElementById('paidByToggle'),
      document.getElementById('endroitTrigger'),
      document.getElementById('productTrigger'),
      document.getElementById('partTravauxTrigger'),
      document.querySelector('input[name="prix"]'),
      document.querySelector('input[name="depot"]'),
      document.querySelector('input[name="temps"]'),
      document.querySelector('input[name="date_travaux"]')
    ];
  }

  // Fonction pour recalculer la bordure d'un champ selon son contenu
  function recalculateFieldBorder(el, fieldType) {
    if (!el) return;

    let isValid = false;

    switch(fieldType) {
      case 'adresse':
        // Si l'adresse a √©t√© s√©lectionn√©e via Google, elle est valide
        if (window.googleProspectAddressSelected && el.value?.trim()) {
          isValid = true;
          console.log('[RECALCULATE] Adresse valide car Google s√©lectionn√©');
        } else {
          // Sinon, valider avec regex (accepte QC et ON)
          const adresseRegex = /^.+,\s*.+,\s*(QC|Quebec|Qu√©bec|ON|Ontario)\s+[A-Z]\d[A-Z]\s+\d[A-Z]\d\s*$/i;
          isValid = adresseRegex.test(el.value?.trim() || '');
          console.log('[RECALCULATE] Adresse valid√©e par regex:', isValid, '| Value:', el.value?.trim());
        }
        break;
      case 'telephone':
        const telRegex = /^\d{3}-\d{3}-\d{4}$/;
        isValid = telRegex.test(el.value?.trim() || '');
        break;
      case 'courriel':
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        isValid = emailRegex.test(el.value?.trim() || '');
        break;
      case 'num':
        // Le champ num est toujours valide car auto-g√©n√©r√©
        isValid = true;
        break;
      case 'dropdown':
        // Pour les dropdowns, v√©rifier s'il y a un .tag (s√©lection faite)
        isValid = el.querySelector('.tag') !== null;
        break;
      case 'popup':
        // Pour les popups, v√©rifier le champ hidden associ√©
        if (el.id === 'productTrigger') {
          // Pour productTrigger, v√©rifier si TOUS les endroits sont compl√©t√©s
          const endroitHidden = document.getElementById('endroitHidden');
          const endroitsValue = endroitHidden ? endroitHidden.value.trim() : '';
          const allEndroits = endroitsValue ? endroitsValue.split('\n').map(e => e.trim()).filter(e => e) : [];
          const totalEndroits = allEndroits.length;

          if (totalEndroits === 0) {
            isValid = false;
          } else {
            // Parser le contenu du hidden field pour compter les endroits compl√©t√©s
            const produitHiddenValue = document.getElementById('produitCouleursHidden')?.value || '';
            const endroitsWithContent = new Set();

            // Chercher tous les "=== EndroitName ===" qui ont du contenu apr√®s
            const regex = /===\s*(.+?)\s*===/g;
            let match;
            while ((match = regex.exec(produitHiddenValue)) !== null) {
              const endroitName = match[1];
              // V√©rifier s'il y a du contenu apr√®s ce header (avant le prochain === ou la fin)
              const startPos = match.index + match[0].length;
              const nextMatch = produitHiddenValue.indexOf('===', startPos);
              const contentAfter = nextMatch > -1
                ? produitHiddenValue.substring(startPos, nextMatch).trim()
                : produitHiddenValue.substring(startPos).trim();

              if (contentAfter) {
                endroitsWithContent.add(endroitName);
              }
            }

            isValid = endroitsWithContent.size === totalEndroits;
          }
        } else if (el.id === 'itemTrigger') {
          // Item est valide seulement si le reste √† distribuer = 0
          const itemHiddenVal = document.getElementById('itemHidden')?.value?.trim() || '';
          if (itemHiddenVal === '') {
            isValid = false;
          } else {
            // Calculer le reste √† distribuer
            const totalPrice = (function() {
              const prixField = document.querySelector('input[name="prix"]');
              if (!prixField) return 0;
              const prixStr = prixField.value.replace(/[^\d.,]/g, '').replace(',', '.');
              return parseFloat(prixStr) || 0;
            })();
            const distributedTotal = (function() {
              let total = 0;
              Object.values(itemData || {}).forEach(data => {
                const prixStr = (data.prix || '').replace(/[^\d.,]/g, '').replace(',', '.');
                total += parseFloat(prixStr) || 0;
              });
              return total;
            })();
            isValid = (totalPrice - distributedTotal) === 0;
          }
        } else if (el.id === 'partTravauxTrigger') {
          isValid = (document.getElementById('partTravauxHidden')?.value?.trim() || '') !== '';
        }
        break;
      case 'popup-endroit':
        // Pour endroitTrigger, v√©rifier le champ hidden
        isValid = (document.getElementById('endroitHidden')?.value?.trim() || '') !== '';
        break;
      default:
        // Pour les champs texte simples
        isValid = (el.value?.trim() || '') !== '';
    }

    el.style.setProperty('border-right-color', isValid ? '#4caf50' : '#e57373', 'important');
  }

  // Fonction pour afficher/masquer les bordures des champs facultatifs
  function toggleOptionalFieldsBorders(show) {
    const optionalFields = getOptionalFields();

    if (show) {
      // Recalculer chaque bordure selon le contenu du champ
      recalculateFieldBorder(document.getElementById('adresseAutocomplete'), 'adresse');
      recalculateFieldBorder(document.getElementById('telephoneInput'), 'telephone');
      recalculateFieldBorder(document.querySelector('input[name="courriel"]'), 'courriel');
      recalculateFieldBorder(document.querySelector('input[name="num"]'), 'num');
      recalculateFieldBorder(document.getElementById('autoDate'), 'text');
      recalculateFieldBorder(document.getElementById('paidByToggle'), 'dropdown');
      recalculateFieldBorder(document.getElementById('endroitTrigger'), 'popup-endroit');
      recalculateFieldBorder(document.getElementById('productTrigger'), 'popup');
      recalculateFieldBorder(document.getElementById('partTravauxTrigger'), 'popup');
      recalculateFieldBorder(document.querySelector('input[name="prix"]'), 'text');
      recalculateFieldBorder(document.querySelector('input[name="depot"]'), 'text');
      recalculateFieldBorder(document.querySelector('input[name="temps"]'), 'text');
      recalculateFieldBorder(document.querySelector('input[name="date_travaux"]'), 'text');
    } else {
      // Bordure normale (style par d√©faut) pour les champs facultatifs
      optionalFields.forEach(el => {
        if (el) {
          el.style.setProperty('border-right', '2px solid var(--border-dark)', 'important');
        }
      });
    }
  }

  // Fonction de validation des champs requis
  function validateRequiredFields() {
    log('[VALIDATION] ========== D√©but de validateRequiredFields ==========');

    const submitBtn = document.getElementById('submitBtn');
    const voirPDFBtn = document.getElementById('voirPDFBtn');
    const saveOnlyBtn = document.getElementById('saveOnlyBtn');
    const validationMessage = document.getElementById('validationMessage');

    log('[VALIDATION] Boutons trouv√©s:', { submitBtn: !!submitBtn, voirPDFBtn: !!voirPDFBtn, saveOnlyBtn: !!saveOnlyBtn });

    // Toujours afficher toutes les bordures
    toggleOptionalFieldsBorders(true);

    // V√©rifier nom et pr√©nom pour le bouton "Enregistrer sans envoyer"
    const prenomEl = document.querySelector('input[name="prenom"]');
    const nomEl = document.querySelector('input[name="nom"]');
    const prenomGreen = hasGreenBorder(prenomEl);
    const nomGreen = hasGreenBorder(nomEl);
    const nomPrenomValid = prenomGreen && nomGreen;

    log('[VALIDATION] Nom/Pr√©nom valides:', nomPrenomValid);

    // V√©rifier tous les champs pour les boutons principaux
    const fieldsToCheck = [
      { el: document.querySelector('input[name="prenom"]'), name: 'Pr√©nom' },
      { el: document.querySelector('input[name="nom"]'), name: 'Nom' },
      { el: document.getElementById('adresseAutocomplete'), name: 'Adresse' },
      { el: document.getElementById('telephoneInput'), name: 'T√©l√©phone' },
      { el: document.querySelector('input[name="courriel"]'), name: 'Courriel' },
      { el: document.querySelector('input[name="num"]'), name: 'N¬∞ Soumission' },
      { el: document.getElementById('autoDate'), name: 'Date cr√©ation' },
      { el: document.getElementById('paidByToggle'), name: 'Pay√© par' },
      { el: document.getElementById('endroitTrigger'), name: 'Endroit √† peinturer' },
      { el: document.getElementById('productTrigger'), name: 'Produit/Couleurs' },
      { el: document.getElementById('itemTrigger'), name: 'Item' },
      { el: document.getElementById('partTravauxTrigger'), name: 'Particularit√© travaux' },
      { el: document.querySelector('input[name="prix"]'), name: 'Prix' },
      { el: document.querySelector('input[name="temps"]'), name: 'Dur√©e' },
      { el: document.querySelector('input[name="date_travaux"]'), name: 'Date travaux' }
    ];

    let allFieldsValid = true;
    log('[VALIDATION] V√©rification des bordures vertes:');
    fieldsToCheck.forEach(field => {
      const isGreen = hasGreenBorder(field.el);
      log(`  - ${field.name}:`, isGreen ? '‚úì Vert' : '‚úó Rouge');
      if (!isGreen) allFieldsValid = false;
    });

    log('[VALIDATION] Tous les champs valides:', allFieldsValid);

    // Bouton "Enregistrer sans envoyer" - activ√© si nom/pr√©nom remplis
    if (saveOnlyBtn) {
      if (nomPrenomValid) {
        saveOnlyBtn.disabled = false;
        saveOnlyBtn.style.opacity = '1';
        saveOnlyBtn.style.cursor = 'pointer';
        saveOnlyBtn.style.pointerEvents = 'auto';
      } else {
        saveOnlyBtn.disabled = true;
        saveOnlyBtn.style.opacity = '0.5';
        saveOnlyBtn.style.cursor = 'not-allowed';
        saveOnlyBtn.style.pointerEvents = 'none';
      }
    }

    // Boutons "Pr√©senter au client" et "Envoyer au client" - activ√©s si TOUS les champs sont remplis
    if (allFieldsValid) {
      voirPDFBtn.disabled = false;
      voirPDFBtn.style.opacity = '1';
      voirPDFBtn.style.cursor = 'pointer';
      voirPDFBtn.style.pointerEvents = 'auto';
      submitBtn.disabled = false;
      submitBtn.style.opacity = '1';
      submitBtn.style.cursor = 'pointer';
      submitBtn.style.pointerEvents = 'auto';
      // Cacher le message d'avertissement
      if (validationMessage) validationMessage.style.display = 'none';
    } else {
      voirPDFBtn.disabled = true;
      voirPDFBtn.style.opacity = '0.5';
      voirPDFBtn.style.cursor = 'not-allowed';
      voirPDFBtn.style.pointerEvents = 'none';
      submitBtn.disabled = true;
      submitBtn.style.opacity = '0.5';
      submitBtn.style.cursor = 'not-allowed';
      submitBtn.style.pointerEvents = 'none';
      // Afficher le message d'avertissement
      if (validationMessage) {
        validationMessage.style.display = 'block';
        validationMessage.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i> Veuillez remplir toutes les cases avant de pr√©senter au client';
      }
    }

    log('[VALIDATION] ========== Fin de validateRequiredFields ==========');

    // D√©clencher l'auto-save si on est dans un projet
    if (typeof triggerSoumissionAutoSave === 'function') {
      triggerSoumissionAutoSave();
    }
  }

  // Initialisation au chargement de la page
  document.addEventListener('DOMContentLoaded', function() {
    genererNumeroSoumission();

    // Hook sur le bouton "Envoyer au client" quand le DOM est pr√™t
    const submitBtn = document.getElementById('submitBtn');
    log('[DEBUG] Recherche submitBtn:', submitBtn);

    if (submitBtn) {
      log('[OK] submitBtn trouv√©, ajout du listener');
      submitBtn.addEventListener('click', async function(e) {
        log('[TARGET] Clic d√©tect√© sur submitBtn');

        // S'assurer que le type d'envoi est "send" (envoi email)
        const sendTypeHidden = document.getElementById('send-type-hidden');
        if (sendTypeHidden) sendTypeHidden.value = 'send';

        const numInput = document.querySelector('input[name="num"]');
        const currentValue = numInput.value.trim();
        log('[NOTE] Valeur actuelle:', currentValue);

        // Apr√®s l'envoi, g√©n√©rer un nouveau num√©ro pour la prochaine soumission
        setTimeout(async () => {
          await genererNumeroSoumission();
          log('[OK] Nouveau num√©ro g√©n√©r√© pour prochaine soumission');
        }, 2000);
      });
    } else {
      log('[ERROR] submitBtn non trouv√© dans le DOM');
    }

    // Gestion du bouton "Enregistrer sans envoyer"
    const saveOnlyBtn = document.getElementById('saveOnlyBtn');
    if (saveOnlyBtn) {
      saveOnlyBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        log('[SAVE ONLY] Clic sur Enregistrer sans envoyer');

        // Mettre le type d'envoi √† "save" (pas d'envoi email)
        const sendTypeHidden = document.getElementById('send-type-hidden');
        if (sendTypeHidden) sendTypeHidden.value = 'save';

        // Soumettre le formulaire
        const form = document.getElementById('soumissionForm');
        if (form) {
          // D√©clencher la soumission du formulaire
          const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
          form.dispatchEvent(submitEvent);
        }
      });
    }

    // Ajouter des listeners sur tous les champs pour validation en temps r√©el
    // Tous les champs sauf l'adresse (qui utilise Google autocomplete)
    const inputs = document.querySelectorAll('input[name="nom"], input[name="prenom"], input[name="num"], input[name="telephone"], input[name="courriel"], input[name="prix"], input[name="temps"], input[name="date_travaux"], textarea[name="endroit_peinture"]');
    inputs.forEach(input => {
      input.addEventListener('input', validateRequiredFields);
    });

    // Champ adresse: √©couter 'change' et 'blur' pour capturer l'autocomplete Google
    const adresseInput = document.querySelector('input[name="adresse"]');
    if (adresseInput) {
      adresseInput.addEventListener('change', validateRequiredFields);
      adresseInput.addEventListener('blur', validateRequiredFields);
      // Aussi √©couter input pour la saisie manuelle
      adresseInput.addEventListener('input', validateRequiredFields);
      log('[VALIDATION] √âcouteurs sp√©ciaux sur adresse pour Google autocomplete');
    }

    log('[VALIDATION] √âcouteurs d\'√©v√©nements install√©s sur tous les champs visibles');
    log('[VALIDATION] Les champs cach√©s (produit/particularit√©s) seront valid√©s apr√®s fermeture des popups');

    // Validation initiale
    validateRequiredFields();

    // Initialiser les informations de l'entrepreneur pour le PDF
    initEntrepreneurInfo();

    // Charger les soumissions en attente et le compteur des envoy√©es au d√©marrage
    loadPendingSoumissions();
    loadSentCount();

    // Installer les listeners d'auto-save sur tous les champs
    setupSoumissionAutoSaveListeners();
  });

  // Fonction pour initialiser les informations de l'entrepreneur
  async function initEntrepreneurInfo() {
    try {
      // R√©cup√©rer les informations depuis l'API utilisateur
      const response = await fetch(`${window.location.origin}/api/get-user-profile?username=${window.username}`);

      if (response.ok) {
        const userData = await response.json();

        const nom = userData.nom || '';
        const prenom = userData.prenom || '';
        const telephone = userData.telephone || '';
        const courriel = userData.courriel || '';

        // Si toutes les infos sont pr√©sentes, cr√©er/mettre √† jour user_info.json
        if (nom && prenom && telephone && courriel) {
          const saveResponse = await fetch(`${window.location.origin}/api/save-user-info`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: window.username,
              nom: nom,
              prenom: prenom,
              telephone: telephone,
              courriel: courriel
            })
          });

          if (saveResponse.ok) {
            log('[OK] Informations entrepreneur sauvegard√©es pour le PDF');
          }
        } else {
          log('[INFO] Informations entrepreneur incompl√®tes dans le profil');
        }
      }
    } catch (error) {
      error('[ERROR] Erreur initialisation info entrepreneur:', error);
    }
  }
</script>





<script>

// Bannir un client de la liste "√† compl√©ter" par ID unique
async function bannirClientACompleter(soumissionData, eventId) {
  try {
    log("üö´ Tentative de bannissement du client √† compl√©ter");
    
    // Utiliser l'eventId pass√© en param√®tre directement
    log("[DEBUG] Event ID re√ßu en param√®tre:", eventId);
    
    // Si pas d'eventId, g√©n√©rer un fallback bas√© sur les donn√©es client
    if (!eventId) {
      const clientInfo = `${soumissionData.nom}_${soumissionData.prenom}_${soumissionData.telephone}`;
      eventId = btoa(clientInfo).replace(/[^a-zA-Z0-9]/g, ''); // Encode en base64 et nettoie
      log("[FIX] Fallback ID g√©n√©r√©:", eventId);
    }
    
    const banData = {
      username: window.username,
      event_id: eventId, // Envoyer l'eventId au lieu de nom/pr√©nom pour le bannissement
      client_email: soumissionData.courriel || `${soumissionData.prenom}.${soumissionData.nom}@temp.local`,
      client_nom: soumissionData.nom,
      client_prenom: soumissionData.prenom,
      adresse: soumissionData.adresse,
      telephone: soumissionData.telephone,
      bannedAt: new Date().toISOString(),
      raison: 'Soumission envoy√©e - ne plus afficher dans clients √† compl√©ter'
    };
    
    log("[BAN] Donnees de bannissement par ID unique:", banData);

    // Appel √† l'API pour bannir le client par ID unique (nouveau endpoint)
    const response = await fetch(`${window.location.origin}/bannir-client-par-id`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(banData)
    });
    
    if (response.ok) {
      log("[OK] Client banni de la liste '√† compl√©ter' avec succ√®s");
      
      // Notifier les autres onglets ouverts (calcul.html) pour rafra√Æchir leur liste
      try {
        localStorage.setItem('clientsBannedUpdate', Date.now().toString());
        log("üì° Signal de mise √† jour envoy√© aux autres onglets");

        // D√©clencher aussi un √©v√©nement personnalis√© pour le m√™me onglet
        window.dispatchEvent(new CustomEvent('clientBanned', {
          detail: { eventId: eventId, clientInfo: banData }
        }));
        log("üì° √âv√©nement clientBanned d√©clench√© pour la page actuelle");
      } catch (e) {
        log("[WARN] Impossible d'envoyer le signal de mise √† jour");
      }
    } else {
      log("[WARN] Impossible de bannir le client de la liste '√† compl√©ter'");
    }
    
  } catch (error) {
    error("[ERROR] Erreur lors du bannissement du client √† compl√©ter:", error);
  }
}

</script>

<script>
// Attendre que common.js soit initialis√©
</script>


<script>
function confirmerSuppression(prenom, nom, btn) {
  const confirmation = confirm(`√ätes-vous s√ªr de vouloir supprimer la soumission de ${prenom} ${nom} ?`);
  if (confirmation) {
    const row = btn.closest("tr");
    row.remove(); // [ERROR] Supprime la ligne de la table c√¥t√© visuel

    // Tu peux aussi appeler une API pour la suppression si n√©cessaire ici
    // Exemple :
    // fetch(/supprimer-evenement?id=xxx, { method: "DELETE" });
  }
}
</script>


<script>
</script>


<script>
// Fonction pour nettoyer uniquement les donn√©es stock√©es (pas le formulaire)
function clearStoredData() {
  log("üßπ NETTOYAGE DES DONN√âES STOCK√âES");
  
  // Nettoyer sessionStorage
  sessionStorage.removeItem('submissionData');
  
  // Nettoyer localStorage (optionnel - commenter si vous voulez garder le num√©ro)
  // localStorage.removeItem('lastSoumissionNumber');
  
  log("[OK] Donn√©es stock√©es nettoy√©es");
}

// Fonction pour nettoyer compl√®tement (donn√©es + formulaire)
function clearAllData() {
  log("üßπ NETTOYAGE COMPLET");
  
  // Nettoyer les donn√©es stock√©es
  clearStoredData();
  
  // Nettoyer tous les champs du formulaire
  setTimeout(() => {
    const inputs = document.querySelectorAll('input[type="text"], input[type="email"], textarea');
    inputs.forEach(input => {
      input.value = '';
    });
    
    // R√©initialiser les dropdowns
    const dropdowns = document.querySelectorAll('.dropdown-selected');
    dropdowns.forEach(dropdown => {
      dropdown.textContent = dropdown.getAttribute('data-placeholder') || 'S√©lectionner...';
    });
    
    log("[DELETE] Formulaire r√©initialis√©");
  }, 100);
  
  log("[OK] Nettoyage complet termin√©");
}

// Variable globale pour stocker le clientOriginalId des clients perdus r√©cup√©r√©s
window.clientOriginalId = null;

// Fonction d'auto-fill qui peut s'ex√©cuter √† tout moment
function autoFillForm() {
  log("üîÑ AUTO-FILL D√âMARR√â");

  // V√©rifier s'il y a des donn√©es √† auto-remplir (venant du calcul)
  const submissionData = sessionStorage.getItem('submissionData');
  log("[DEBUG] submissionData trouv√©:", submissionData);
  
  if (submissionData) {
    try {
      const data = JSON.parse(submissionData);
      log("[OK] Donn√©es de pr√©remplissage trouv√©es:", data);

      // Sauvegarder le clientOriginalId si c'est un client perdu r√©cup√©r√©
      if (data.clientOriginalId) {
        window.clientOriginalId = data.clientOriginalId;
        log("üíæ clientOriginalId sauvegard√©:", window.clientOriginalId);
      }

      // Attendre que les champs soient disponibles
      setTimeout(() => {
        // Remplir les champs du formulaire ET mettre les bordures en vert
        if (data.prenom) {
          const prenomField = document.querySelector('input[name="prenom"]');
          if (prenomField) {
            prenomField.value = data.prenom;
            prenomField.style.setProperty('border-right-color', '#4caf50', 'important');
          }
        }
        if (data.nom) {
          const nomField = document.querySelector('input[name="nom"]');
          if (nomField) {
            nomField.value = data.nom;
            nomField.style.setProperty('border-right-color', '#4caf50', 'important');
          }
        }
        if (data.adresse) {
          const adresseField = document.querySelector('input[name="adresse"]');
          if (adresseField) {
            adresseField.value = data.adresse;
            adresseField.style.setProperty('border-right-color', '#4caf50', 'important');
            // Marquer que l'adresse vient de calcul (donc d√©j√† valid√©e)
            window.googleProspectAddressSelected = true;
            window.initialAutofilledAddress = data.adresse; // Stocker pour comparaison
            log("[OK] Adresse auto-remplie depuis calcul - validation d√©sactiv√©e");
          }
        }
        if (data.telephone) {
          const telephoneField = document.querySelector('input[name="telephone"]');
          if (telephoneField) {
            telephoneField.value = data.telephone;
            telephoneField.style.setProperty('border-right-color', '#4caf50', 'important');
          }
        }
        if (data.prix) {
          const prixField = document.querySelector('input[name="prix"]');
          if (prixField) {
            prixField.value = data.prix;
            prixField.style.setProperty('border-right-color', '#4caf50', 'important');
            // Calculer automatiquement le d√©p√¥t bas√© sur le prix pr√©-rempli
            calculerDepot();
          }
        }
        if (data.temps) {
          const tempsField = document.querySelector('input[name="temps"]');
          if (tempsField) {
            tempsField.value = data.temps;
            tempsField.style.setProperty('border-right-color', '#4caf50', 'important');
          }
        }

        log("[OK] Formulaire pr√©rempli avec succ√®s");

        // Valider les champs apr√®s le remplissage pour mettre √† jour l'√©tat des boutons
        setTimeout(() => {
          if (typeof validateRequiredFields === 'function') {
            validateRequiredFields();
            log("[OK] Validation des champs effectu√©e apr√®s pr√©remplissage");
          }
        }, 100);

        // Stocker l'eventId AVANT de nettoyer sessionStorage
        window.storedEventId = data.eventId || data.id;
        log("üíæ EventId sauvegard√© avant nettoyage:", window.storedEventId);

        // Auto-sauvegarder comme projet dans soumissions_a_envoyer
        setTimeout(() => {
          autoSaveFromCalculateur();
        }, 800);

        // Nettoyer les donn√©es stock√©es apr√®s l'autofill pour √©viter qu'elles persistent
        setTimeout(() => {
          clearStoredData();
          log("üßπ Donn√©es nettoy√©es apr√®s autofill");
        }, 1000);
        
      }, 500);
      
    } catch (error) {
      error("[ERROR] Erreur lors du pr√©remplissage:", error);
    }
  } else {
    // V√©rifier s'il y a des donn√©es de r√©cup√©ration client (venant de Ventes - clients perdus)
    const recuperationData = localStorage.getItem('clientSoumission') || localStorage.getItem('recuperationClient');
    log("[DEBUG] clientSoumission/recuperationClient trouv√©:", recuperationData);

    if (recuperationData) {
      try {
        const data = JSON.parse(recuperationData);
        log("[OK] Donn√©es de r√©cup√©ration client trouv√©es:", data);

        setTimeout(() => {
          // Champs de base
          if (data.prenom) {
            const prenomField = document.querySelector('input[name="prenom"]');
            if (prenomField) {
              prenomField.value = data.prenom;
              prenomField.style.setProperty('border-right-color', '#4caf50', 'important');
            }
          }
          if (data.nom) {
            const nomField = document.querySelector('input[name="nom"]');
            if (nomField) {
              nomField.value = data.nom;
              nomField.style.setProperty('border-right-color', '#4caf50', 'important');
            }
          }
          if (data.adresse) {
            const adresseField = document.querySelector('input[name="adresse"]');
            if (adresseField) {
              adresseField.value = data.adresse;
              adresseField.style.setProperty('border-right-color', '#4caf50', 'important');
              window.googleProspectAddressSelected = true;
              window.initialAutofilledAddress = data.adresse;
              log("[OK] Adresse auto-remplie depuis r√©cup√©ration client");
            }
          }
          if (data.telephone) {
            const telephoneField = document.querySelector('input[name="telephone"]');
            if (telephoneField) {
              telephoneField.value = data.telephone;
              telephoneField.style.setProperty('border-right-color', '#4caf50', 'important');
            }
          }
          if (data.courriel) {
            const courrielField = document.querySelector('input[name="courriel"]');
            if (courrielField) {
              courrielField.value = data.courriel;
              courrielField.style.setProperty('border-right-color', '#4caf50', 'important');
            }
          }

          // Champs suppl√©mentaires
          if (data.endroit) {
            const endroitField = document.querySelector('textarea[name="endroit_peinture"]');
            if (endroitField) {
              endroitField.value = data.endroit;
              endroitField.style.setProperty('border-right-color', '#4caf50', 'important');
            }
          }
          if (data.temps) {
            const tempsField = document.querySelector('input[name="temps"]');
            if (tempsField) {
              tempsField.value = data.temps;
              tempsField.style.setProperty('border-right-color', '#4caf50', 'important');
            }
          }
          if (data.date2) {
            const date2Field = document.querySelector('input[name="date_travaux"]');
            if (date2Field) {
              date2Field.value = data.date2;
              date2Field.style.setProperty('border-right-color', '#4caf50', 'important');
            }
          }
          if (data.prix) {
            log("[PRIX] Prix d√©tect√© dans data:", data.prix, "Type:", typeof data.prix);
            const prixField = document.querySelector('input[name="prix"]');
            log("[PRIX] Champ prix trouv√©:", prixField ? 'Oui' : 'Non');
            if (prixField) {
              // Formater le prix: enlever .00 si pr√©sent, enlever $ si pr√©sent (le champ le formate automatiquement)
              let prixFormate = data.prix.toString();
              // Enlever le $ s'il est pr√©sent
              prixFormate = prixFormate.replace('$', '').trim();
              // Enlever .00 si pr√©sent
              if (prixFormate.endsWith('.00')) {
                prixFormate = prixFormate.replace('.00', '');
              }
              log("[PRIX] Prix format√©:", prixFormate);
              prixField.value = prixFormate;

              // D√©clencher les √©v√©nements pour activer le formatage automatique
              prixField.dispatchEvent(new Event('input', { bubbles: true }));
              prixField.dispatchEvent(new Event('blur', { bubbles: true }));
              prixField.dispatchEvent(new Event('change', { bubbles: true }));

              prixField.style.setProperty('border-right-color', '#4caf50', 'important');
              log("[OK] Prix rempli:", data.prix, "‚Üí", prixFormate, "Valeur dans champ:", prixField.value);
            }
          } else {
            log("[PRIX] ‚ö†Ô∏è Aucun prix dans les donn√©es");
          }

          // Pay√© par (dropdown toggle)
          if (data.payer_par) {
            const paidByToggle = document.getElementById('paidByToggle');
            if (paidByToggle) {
              paidByToggle.innerHTML = `<span class="tag">${data.payer_par}</span>`;
              paidByToggle.style.setProperty('border-right-color', '#4caf50', 'important');
              if (window.dropdownStates) {
                window.dropdownStates.paidBy = data.payer_par;
              }
              log("[OK] Pay√© par rempli:", data.payer_par);
            }
          }

          // Produit/Couleurs (popup with hidden field)
          if (data.produit) {
            const produitHidden = document.getElementById('produitCouleursHidden');
            const produitTrigger = document.getElementById('productTrigger');
            const produitDisplay = document.getElementById('productDisplay');
            if (produitHidden) {
              produitHidden.value = data.produit;
              if (produitDisplay) {
                produitDisplay.textContent = data.produit;
                produitDisplay.style.color = 'var(--text-light)';
              }
              // Ne pas mettre la bordure verte ici - laisser updateProductCounter d√©cider
              log("[OK] Produit rempli:", data.produit.substring(0, 50) + '...');
            }
          }

          // Particularit√©s (popup with hidden field)
          if (data.part) {
            const partHidden = document.getElementById('partTravauxHidden');
            const partTrigger = document.getElementById('partTravauxTrigger');
            const partDisplay = document.getElementById('partTravauxDisplay');
            if (partHidden) {
              partHidden.value = data.part;
              if (partDisplay) {
                partDisplay.textContent = data.part;
                partDisplay.style.color = 'var(--text-light)';
              }
              if (partTrigger) {
                partTrigger.style.setProperty('border-right-color', '#4caf50', 'important');
              }
              log("[OK] Particularit√©s remplies:", data.part.substring(0, 50) + '...');
            }
          }

          // Afficher le badge de r√©cup√©ration
          const recuperationBadge = document.getElementById('recuperationBadge');
          const recuperationText = document.getElementById('recuperationText');
          if (recuperationBadge && recuperationText && (data.prenom || data.nom)) {
            const nomComplet = `${data.prenom || ''} ${data.nom || ''}`.trim();
            recuperationText.textContent = `R√©cup√©ration de ${nomComplet}`;
            recuperationBadge.style.display = 'block';
            log("[BADGE] Badge de r√©cup√©ration affich√© pour:", nomComplet);
          }

          // Stocker l'ID du client perdu si pr√©sent
          if (data.client_perdu_id) {
            sessionStorage.setItem('client_perdu_id', data.client_perdu_id);
            log("[OK] ID client perdu stock√©:", data.client_perdu_id);
          }

          log("[OK] Formulaire pr√©rempli avec donn√©es client r√©cup√©r√©");

          // Valider les champs apr√®s le remplissage
          setTimeout(() => {
            if (typeof validateRequiredFields === 'function') {
              validateRequiredFields();
              log("[OK] Validation des champs effectu√©e");
            }
          }, 100);

          // Nettoyer les donn√©es de r√©cup√©ration
          localStorage.removeItem('clientSoumission');
          localStorage.removeItem('recuperationClient');
          log("üßπ Donn√©es de r√©cup√©ration nettoy√©es");
        }, 500);

      } catch (error) {
        error("[ERROR] Erreur lors du pr√©remplissage r√©cup√©ration:", error);
      }
    } else {
      log("‚ÑπÔ∏è Aucune donn√©e submissionData trouv√©e");
    }
  }
}

// D√©tecter si c'est un refresh ou une navigation normale
function detectRefreshAndExecute() {
  // V√©rifier s'il y a un referrer (venant d'une autre page) ou si c'est un refresh
  const isRefresh = !document.referrer || document.referrer === window.location.href;
  
  if (isRefresh) {
    log("üîÑ Refresh d√©tect√© - nettoyage complet");
    clearAllData();
  } else {
    log("üîó Navigation normale - autofill autoris√©");
    autoFillForm();
  }
}

// Ex√©cuter le syst√®me de d√©tection
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', detectRefreshAndExecute);
} else {
  // DOM d√©j√† charg√©
  detectRefreshAndExecute();
}

// Backup: essayer aussi apr√®s un d√©lai (seulement si pas un refresh)
setTimeout(() => {
  const isRefresh = !document.referrer || document.referrer === window.location.href;
  if (!isRefresh) {
    autoFillForm();
  }
}, 100);

setTimeout(() => {
  const isRefresh = !document.referrer || document.referrer === window.location.href;
  if (!isRefresh) {
    autoFillForm();
  }
}, 1000);

// ========== GESTION DES SOUMISSIONS EN ATTENTE ==========

// Sauvegarder une soumission en attente via l'API backend
async function savePendingSoumission(formEl) {
  const btn = document.getElementById("submitBtn");
  const btnText = document.getElementById("btnText");

  btn.disabled = true;
  btnText.textContent = "G√©n√©ration...";

  const form = formEl;

  // Si pas de date de cr√©ation, utiliser la date d'aujourd'hui
  let dateCreation = form.date_creation.value;
  if (!dateCreation || dateCreation.trim() === '') {
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    dateCreation = `${day}/${month}/${year}`;
  }

  const soumissionData = {
    username: window.username,
    num: form.num.value,
    nom: form.nom.value,
    prenom: form.prenom.value,
    telephone: form.telephone.value,
    courriel: form.courriel.value,
    date: dateCreation,
    temps: form.temps.value,
    date2: form.date_travaux.value,
    prix: form.prix.value,
    adresse: form.adresse.value,
    endroit: form.endroit_peinture.value,
    produit: document.getElementById("produitCouleursHidden").value,
    item: document.getElementById("itemHidden").value,
    part: document.getElementById("partTravauxHidden").value,
    payer_par: window.dropdownStates?.paidBy || "Virement Interac"
  };

  // Si on √©dite une soumission existante, ajouter l'ID pour mise √† jour
  if (window.editingSoumissionId) {
    soumissionData.soumission_id = window.editingSoumissionId;
    log('[UPDATE] Mode mise √† jour - ID:', window.editingSoumissionId);
  }

  try {
    // Sauvegarder via l'API backend
    const response = await fetch('/save-soumission-to-queue', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(soumissionData)
    });

    if (!response.ok) {
      throw new Error('Erreur lors de la sauvegarde');
    }

    const result = await response.json();
    log('[OK] Soumission sauvegard√©e en base:', result.soumission_id);

    // Rafra√Æchir l'affichage de la table
    await loadPendingSoumissions();

    // Afficher l'animation de succ√®s (comme pour l'envoi au client)
    showSuccessAnimation('enregistrement');

  } catch (error) {
    error('[ERROR] Erreur sauvegarde:', error);
    btn.disabled = false;
    btnText.textContent = "Erreur";
    alert('Erreur lors de la sauvegarde de la soumission');
    setTimeout(() => {
      btnText.textContent = "Enregistrer sans envoyer";
    }, 2000);
  }
}

// === SYST√àME DE PROJET SOUMISSION ===
// Variable globale pour tracker si on est dans un projet soumission
window.soumissionProjectActive = false;
window.soumissionSavingInProgress = false; // Emp√™cher les sauvegardes concurrentes
let soumissionAutoSaveTimeout = null;
const SOUMISSION_AUTO_SAVE_DELAY = 800;

// D√©clencher l'auto-save avec debounce
function triggerSoumissionAutoSave() {
  if (!window.soumissionProjectActive || !window.editingSoumissionId || window.soumissionSavingInProgress) return;

  if (soumissionAutoSaveTimeout) {
    clearTimeout(soumissionAutoSaveTimeout);
  }

  showSoumissionAutoSaveStatus('saving');

  soumissionAutoSaveTimeout = setTimeout(async () => {
    try {
      await autoSaveSoumissionProject();
      showSoumissionAutoSaveStatus('saved');
    } catch (err) {
      console.error('[SOUMISSION-AUTOSAVE] Erreur:', err);
      showSoumissionAutoSaveStatus('error');
    }
  }, SOUMISSION_AUTO_SAVE_DELAY);
}

// Sauvegarder le projet soumission (update dans la queue)
async function autoSaveSoumissionProject() {
  if (!window.editingSoumissionId) return;

  const form = document.getElementById('soumissionForm');
  if (!form) return;

  const soumissionData = {
    username: window.username,
    soumission_id: window.editingSoumissionId,
    num: (form.num || document.querySelector('input[name="num"]'))?.value || '',
    nom: (form.nom || document.querySelector('input[name="nom"]'))?.value || '',
    prenom: (form.prenom || document.querySelector('input[name="prenom"]'))?.value || '',
    telephone: (form.telephone || document.querySelector('input[name="telephone"]'))?.value || '',
    courriel: (form.courriel || document.querySelector('input[name="courriel"]'))?.value || '',
    date: (form.date_creation || document.querySelector('input[name="date_creation"]'))?.value || '',
    temps: (form.temps || document.querySelector('input[name="temps"]'))?.value || '',
    date2: (form.date_travaux || document.querySelector('input[name="date_travaux"]'))?.value || '',
    prix: (form.prix || document.querySelector('input[name="prix"]'))?.value || '',
    adresse: (form.adresse || document.querySelector('input[name="adresse"]'))?.value || '',
    endroit: (form.endroit_peinture || document.querySelector('input[name="endroit_peinture"]'))?.value || '',
    produit: document.getElementById("produitCouleursHidden")?.value || '',
    item: document.getElementById("itemHidden")?.value || '',
    part: document.getElementById("partTravauxHidden")?.value || '',
    payer_par: window.dropdownStates?.paidBy || "Virement Interac",
    depot: (form.depot || document.querySelector('input[name="depot"]'))?.value || ''
  };

  const response = await fetch('/save-soumission-to-queue', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(soumissionData)
  });

  if (!response.ok) {
    throw new Error(`Erreur sauvegarde: ${response.status}`);
  }

  log('[SOUMISSION-AUTOSAVE] Projet sauvegard√©');

  // Rafra√Æchir la table
  await loadPendingSoumissions();
}

// Indicateur visuel de sauvegarde
function showSoumissionAutoSaveStatus(status) {
  let statusEl = document.getElementById('soumission-auto-save-status');

  if (!statusEl) {
    statusEl = document.createElement('div');
    statusEl.id = 'soumission-auto-save-status';
    statusEl.style.cssText = 'position: fixed; top: 80px; right: 20px; padding: 10px 18px; border-radius: 8px; font-size: 14px; font-weight: 500; z-index: 9999; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);';
    document.body.appendChild(statusEl);
  }

  statusEl.style.display = 'flex';

  switch(status) {
    case 'saving':
      statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sauvegarde...';
      statusEl.style.background = 'rgba(59, 130, 246, 0.95)';
      statusEl.style.color = 'white';
      break;
    case 'saved':
      const prenom = document.querySelector('input[name="prenom"]')?.value.trim() || '';
      const nom = document.querySelector('input[name="nom"]')?.value.trim() || '';
      const clientName = `${prenom} ${nom}`.trim();
      statusEl.innerHTML = clientName
        ? `<i class="fas fa-check-circle"></i> ${clientName} - √Ä jour`
        : '<i class="fas fa-check-circle"></i> √Ä jour';
      statusEl.style.background = 'rgba(34, 197, 94, 0.95)';
      statusEl.style.color = 'white';
      break;
    case 'error':
      statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erreur';
      statusEl.style.background = 'rgba(239, 68, 68, 0.95)';
      statusEl.style.color = 'white';
      setTimeout(() => showSoumissionAutoSaveStatus('saved'), 3000);
      break;
    case 'hide':
      statusEl.style.display = 'none';
      break;
  }
}

// Attacher l'auto-save √† tous les champs du formulaire
function setupSoumissionAutoSaveListeners() {
  const form = document.getElementById('soumissionForm');
  if (!form) return;

  // Tous les inputs texte, email, tel du formulaire
  form.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="hidden"]').forEach(input => {
    input.addEventListener('input', () => triggerSoumissionAutoSave());
    input.addEventListener('change', () => triggerSoumissionAutoSave());
  });

  // Observer les hidden inputs (endroit, produit, item, part) via MutationObserver
  const hiddenInputs = [
    document.getElementById('endroitHidden'),
    document.getElementById('produitCouleursHidden'),
    document.getElementById('itemHidden'),
    document.getElementById('partTravauxHidden')
  ];

  const hiddenObserver = new MutationObserver(() => triggerSoumissionAutoSave());
  hiddenInputs.forEach(input => {
    if (input) {
      // Observer les changements de l'attribut value
      hiddenObserver.observe(input, { attributes: true, attributeFilter: ['value'] });
      // Aussi √©couter l'√©v√©nement change
      input.addEventListener('change', () => triggerSoumissionAutoSave());
    }
  });

  // Observer les dropdown (pay√© par)
  const paidByMenu = document.getElementById('paidByMenu');
  if (paidByMenu) {
    paidByMenu.addEventListener('click', () => {
      setTimeout(() => triggerSoumissionAutoSave(), 100);
    });
  }

  log('[SOUMISSION-AUTOSAVE] Listeners install√©s sur tous les champs');
}

function hasGreenBorderSoumission(el) {
  if (!el) return false;
  const style = el.style.borderRightColor;
  return style === 'rgb(76, 175, 80)' || style === '#4caf50';
}

// V√©rifier si les 4 champs client sont valides pour activer le bouton "Cr√©er le projet"
function updateSoumissionClientValidation() {
  const validationMsg = document.getElementById('soumissionClientValidationMsg');
  const createBtn = document.getElementById('createSoumissionProjectBtn');
  if (!validationMsg || !createBtn) return;

  // Si on est d√©j√† dans un projet, ne pas toucher au bouton
  if (window.soumissionProjectActive) return;

  const prenom = document.querySelector('input[name="prenom"]');
  const nom = document.querySelector('input[name="nom"]');
  const adresse = document.getElementById('adresseAutocomplete');
  const telephone = document.getElementById('telephoneInput');

  const allValid = hasGreenBorderSoumission(prenom) &&
                   hasGreenBorderSoumission(nom) &&
                   hasGreenBorderSoumission(adresse) &&
                   hasGreenBorderSoumission(telephone);

  if (allValid) {
    validationMsg.style.display = 'none';
    createBtn.disabled = false;
    createBtn.style.opacity = '1';
    createBtn.style.cursor = 'pointer';
  } else {
    validationMsg.style.display = 'block';
    createBtn.disabled = true;
    createBtn.style.opacity = '0.5';
    createBtn.style.cursor = 'not-allowed';
  }
}

// Cr√©er le projet soumission (sauvegarder + verrouiller les champs client)
async function createSoumissionProject() {
  const createBtn = document.getElementById('createSoumissionProjectBtn');
  if (!createBtn || createBtn.disabled) return;

  // Emp√™cher la double-cr√©ation
  if (window.editingSoumissionId || window.soumissionSavingInProgress) {
    log('[SOUMISSION-PROJECT] Projet d√©j√† existant ou sauvegarde en cours, ignor√©');
    return;
  }
  window.soumissionSavingInProgress = true;

  log('[SOUMISSION-PROJECT] Cr√©ation du projet soumission');

  // Sauvegarder dans la queue
  const form = document.getElementById('soumissionForm');
  const numField = form.num || document.querySelector('input[name="num"]');

  // Si pas de num√©ro encore, attendre
  if (!numField || !numField.value) {
    log('[SOUMISSION-PROJECT] Num√©ro pas encore pr√™t');
    window.soumissionSavingInProgress = false;
    return;
  }

  const soumissionData = {
    username: window.username,
    num: numField.value,
    nom: (form.nom || document.querySelector('input[name="nom"]'))?.value || '',
    prenom: (form.prenom || document.querySelector('input[name="prenom"]'))?.value || '',
    telephone: (form.telephone || document.querySelector('input[name="telephone"]'))?.value || '',
    courriel: (form.courriel || document.querySelector('input[name="courriel"]'))?.value || '',
    date: (form.date_creation || document.querySelector('input[name="date_creation"]'))?.value || '',
    temps: (form.temps || document.querySelector('input[name="temps"]'))?.value || '',
    date2: (form.date_travaux || document.querySelector('input[name="date_travaux"]'))?.value || '',
    prix: (form.prix || document.querySelector('input[name="prix"]'))?.value || '',
    adresse: (form.adresse || document.querySelector('input[name="adresse"]'))?.value || '',
    endroit: (form.endroit_peinture || document.querySelector('input[name="endroit_peinture"]'))?.value || '',
    produit: document.getElementById("produitCouleursHidden")?.value || '',
    item: document.getElementById("itemHidden")?.value || '',
    part: document.getElementById("partTravauxHidden")?.value || '',
    payer_par: window.dropdownStates?.paidBy || "Virement Interac"
  };

  try {
    const response = await fetch('/save-soumission-to-queue', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(soumissionData)
    });

    if (response.ok) {
      const result = await response.json();
      window.editingSoumissionId = result.soumission_id;
      log('[SOUMISSION-PROJECT] Projet cr√©√© - ID:', result.soumission_id);

      lockSoumissionClientFields();
      await loadPendingSoumissions();

      // Notification verte (nouveau projet)
      const notification = document.createElement('div');
      notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1rem 1.5rem; border-radius: 8px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-weight: 600;';
      notification.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Projet soumission cr√©√©';
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
  } catch (err) {
    log('[SOUMISSION-PROJECT] Erreur:', err);
  } finally {
    window.soumissionSavingInProgress = false;
  }
}

// Verrouiller les champs client apr√®s cr√©ation du projet
function lockSoumissionClientFields() {
  window.soumissionProjectActive = true;

  const fields = [
    document.querySelector('input[name="prenom"]'),
    document.querySelector('input[name="nom"]'),
    document.getElementById('adresseAutocomplete'),
    document.getElementById('telephoneInput')
  ];

  fields.forEach(field => {
    if (field) {
      field.disabled = true;
      field.style.opacity = '0.6';
      field.style.cursor = 'not-allowed';
      field.style.background = 'rgba(30, 41, 59, 0.5)';
    }
  });

  // Changer le bouton en "Quitter le projet"
  const createBtn = document.getElementById('createSoumissionProjectBtn');
  if (createBtn) {
    createBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Quitter le projet';
    createBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
    createBtn.onclick = quitSoumissionProject;
    createBtn.disabled = false;
    createBtn.style.opacity = '1';
    createBtn.style.cursor = 'pointer';
  }

  // Cacher le message de validation
  const validationMsg = document.getElementById('soumissionClientValidationMsg');
  if (validationMsg) validationMsg.style.display = 'none';

  // D√©bloquer les sections Description et D√©tails des travaux
  const lockDescription = document.getElementById('lock-description-travaux');
  const lockDetails = document.getElementById('lock-details-travaux');
  if (lockDescription) lockDescription.style.display = 'none';
  if (lockDetails) lockDetails.style.display = 'none';

  // Afficher l'indicateur "√Ä jour"
  showSoumissionAutoSaveStatus('saved');
}

// D√©verrouiller les champs client
function unlockSoumissionClientFields() {
  window.soumissionProjectActive = false;

  const fields = [
    document.querySelector('input[name="prenom"]'),
    document.querySelector('input[name="nom"]'),
    document.getElementById('adresseAutocomplete'),
    document.getElementById('telephoneInput')
  ];

  fields.forEach(field => {
    if (field) {
      field.disabled = false;
      field.style.opacity = '1';
      field.style.cursor = 'text';
      field.style.background = '';
    }
  });
}

// Quitter le projet soumission (r√©initialiser tout)
function quitSoumissionProject() {
  log('[SOUMISSION-PROJECT] Quitter le projet');

  // D√©verrouiller les champs
  unlockSoumissionClientFields();

  // R√©initialiser les champs client
  const clientFields = [
    document.querySelector('input[name="prenom"]'),
    document.querySelector('input[name="nom"]'),
    document.getElementById('adresseAutocomplete'),
    document.getElementById('telephoneInput'),
    document.querySelector('input[name="courriel"]')
  ];
  clientFields.forEach(field => {
    if (field) {
      field.value = '';
      field.style.setProperty('border-right-color', '#e57373', 'important');
    }
  });

  // R√©initialiser les champs travaux
  const form = document.getElementById('soumissionForm');
  if (form) {
    if (form.prix) { form.prix.value = ''; form.prix.style.setProperty('border-right-color', '#e57373', 'important'); }
    if (form.depot) { form.depot.value = ''; }
    if (form.temps) { form.temps.value = ''; form.temps.style.setProperty('border-right-color', '#e57373', 'important'); }
    if (form.date_travaux) { form.date_travaux.value = ''; form.date_travaux.style.setProperty('border-right-color', '#e57373', 'important'); }
  }

  // R√©initialiser endroit, produit, item, particularit√©s
  const endroitDisplay = document.getElementById('endroitDisplay');
  const endroitTrigger = document.getElementById('endroitTrigger');
  if (endroitDisplay) { endroitDisplay.innerHTML = 'Cliquez pour s√©lectionner les endroits √† peinturer...'; endroitDisplay.style.color = 'var(--text-gray)'; }
  if (endroitTrigger) endroitTrigger.style.setProperty('border-right-color', '#e57373', 'important');
  if (typeof endroitSelections !== 'undefined') endroitSelections = [];
  const endroitHidden = document.getElementById('endroitHidden');
  if (endroitHidden) endroitHidden.value = '';

  const productDisplay = document.getElementById('productDisplay');
  const productTrigger = document.getElementById('productTrigger');
  if (productDisplay) { productDisplay.innerHTML = 'Cliquez pour s√©lectionner pr√©paration et produit...'; productDisplay.style.color = 'var(--text-gray)'; }
  if (productTrigger) productTrigger.style.setProperty('border-right-color', '#e57373', 'important');
  const produitHidden = document.getElementById('produitCouleursHidden');
  if (produitHidden) produitHidden.value = '';

  const itemDisplay = document.getElementById('itemDisplay');
  const itemTrigger = document.getElementById('itemTrigger');
  if (itemDisplay) { itemDisplay.innerHTML = 'Cliquez pour ajouter les items...'; itemDisplay.style.color = 'var(--text-gray)'; }
  if (itemTrigger) itemTrigger.style.setProperty('border-right-color', '#e57373', 'important');
  const itemHidden = document.getElementById('itemHidden');
  if (itemHidden) itemHidden.value = '';
  if (typeof itemData !== 'undefined') itemData = {};

  const partDisplay = document.getElementById('partTravauxDisplay');
  const partTrigger = document.getElementById('partTravauxTrigger');
  if (partDisplay) { partDisplay.innerHTML = 'Cliquez pour s√©lectionner particularit√©s des travaux...'; partDisplay.style.color = 'var(--text-gray)'; }
  if (partTrigger) partTrigger.style.setProperty('border-right-color', '#e57373', 'important');
  const partHidden = document.getElementById('partTravauxHidden');
  if (partHidden) partHidden.value = '';

  // Reset flags
  window.editingSoumissionId = null;
  window.editingSentSoumissionId = null;
  window.googleProspectAddressSelected = false;

  // Cacher l'indicateur de sauvegarde
  showSoumissionAutoSaveStatus('hide');

  // Remettre le bouton en "Cr√©er le projet" (d√©sactiv√©)
  const createBtn = document.getElementById('createSoumissionProjectBtn');
  if (createBtn) {
    createBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Cr√©er le projet';
    createBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
    createBtn.onclick = createSoumissionProject;
    createBtn.disabled = true;
    createBtn.style.opacity = '0.5';
    createBtn.style.cursor = 'not-allowed';
  }

  // Afficher le message de validation
  const validationMsg = document.getElementById('soumissionClientValidationMsg');
  if (validationMsg) validationMsg.style.display = 'block';

  // Remettre les overlays sur les sections Description et D√©tails
  const lockDescription = document.getElementById('lock-description-travaux');
  const lockDetails = document.getElementById('lock-details-travaux');
  if (lockDescription) lockDescription.style.display = 'flex';
  if (lockDetails) lockDetails.style.display = 'flex';

  // Revalider
  if (typeof validateRequiredFields === 'function') validateRequiredFields();
}

// Auto-sauvegarder le projet soumission quand on arrive du calculateur
async function autoSaveFromCalculateur() {
  // Emp√™cher les appels multiples simultan√©s
  if (window.soumissionSavingInProgress) {
    log('[AUTO-SAVE] Sauvegarde d√©j√† en cours, ignor√©');
    return;
  }
  // Si un projet est d√©j√† li√©, ne pas en recr√©er un
  if (window.editingSoumissionId) {
    log('[AUTO-SAVE] Projet d√©j√† existant ID:', window.editingSoumissionId, '- pas de doublon');
    return;
  }

  window.soumissionSavingInProgress = true;

  try {
    const form = document.getElementById('soumissionForm') || document.querySelector('form');
    if (!form) { window.soumissionSavingInProgress = false; return; }

    // Attendre que le num√©ro de soumission soit g√©n√©r√©
    const numField = form.num || document.querySelector('input[name="num"]');
    if (!numField || !numField.value) {
      log('[AUTO-SAVE] Num√©ro pas encore g√©n√©r√©, retry dans 500ms...');
      window.soumissionSavingInProgress = false;
      setTimeout(() => autoSaveFromCalculateur(), 500);
      return;
    }

    // R√©cup√©rer les infos client du formulaire
    const clientNom = ((form.nom || document.querySelector('input[name="nom"]'))?.value || '').trim().toLowerCase();
    const clientPrenom = ((form.prenom || document.querySelector('input[name="prenom"]'))?.value || '').trim().toLowerCase();
    const clientTel = ((form.telephone || document.querySelector('input[name="telephone"]'))?.value || '').trim();

    // V√©rifier si un projet existe d√©j√† pour ce client dans la queue
    try {
      const queueRes = await fetch(`/get-soumissions-queue/${window.username}`);
      if (queueRes.ok) {
        const queueData = await queueRes.json();
        const existingQueue = queueData.soumissions || [];

        const existingProject = existingQueue.find(s => {
          const sNom = (s.nom || '').trim().toLowerCase();
          const sPrenom = (s.prenom || '').trim().toLowerCase();
          const sTel = (s.telephone || '').trim();
          return sNom === clientNom && sPrenom === clientPrenom && sTel === clientTel;
        });

        if (existingProject) {
          log('[AUTO-SAVE] Client d√©j√† dans la queue, affichage popup choix');
          // Afficher le popup de choix
          const clientFullName = `${existingProject.prenom || ''} ${existingProject.nom || ''}`.trim();
          showCalculateurDuplicatePopup(existingProject, numField.value, clientFullName);
          return; // Le popup g√®re la suite
        }
      }
    } catch (checkErr) {
      log('[AUTO-SAVE] Erreur v√©rification queue:', checkErr);
    }

    // Aucun projet existant, cr√©er un nouveau
    await createNewSoumissionFromCalculateur(numField.value);

  } catch (err) {
    log('[AUTO-SAVE] Erreur:', err);
    window.soumissionSavingInProgress = false;
  }
}

// Cr√©er une nouvelle soumission depuis le calculateur
async function createNewSoumissionFromCalculateur(numValue) {
  try {
    const form = document.getElementById('soumissionForm') || document.querySelector('form');
    if (!form) { window.soumissionSavingInProgress = false; return; }

    const soumissionData = {
      username: window.username,
      num: numValue,
      nom: (form.nom || document.querySelector('input[name="nom"]'))?.value || '',
      prenom: (form.prenom || document.querySelector('input[name="prenom"]'))?.value || '',
      telephone: (form.telephone || document.querySelector('input[name="telephone"]'))?.value || '',
      courriel: (form.courriel || document.querySelector('input[name="courriel"]'))?.value || '',
      date: (form.date_creation || document.querySelector('input[name="date_creation"]'))?.value || '',
      temps: (form.temps || document.querySelector('input[name="temps"]'))?.value || '',
      date2: (form.date_travaux || document.querySelector('input[name="date_travaux"]'))?.value || '',
      prix: (form.prix || document.querySelector('input[name="prix"]'))?.value || '',
      adresse: (form.adresse || document.querySelector('input[name="adresse"]'))?.value || '',
      endroit: (form.endroit_peinture || document.querySelector('input[name="endroit_peinture"]'))?.value || '',
      produit: document.getElementById("produitCouleursHidden")?.value || '',
      item: document.getElementById("itemHidden")?.value || '',
      part: document.getElementById("partTravauxHidden")?.value || '',
      payer_par: window.dropdownStates?.paidBy || "Virement Interac"
    };

    log('[AUTO-SAVE] Nouveau projet soumission:', numValue);

    const response = await fetch('/save-soumission-to-queue', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(soumissionData)
    });

    if (response.ok) {
      const result = await response.json();
      window.editingSoumissionId = result.soumission_id;
      log('[AUTO-SAVE] Projet cr√©√© avec succ√®s - ID:', result.soumission_id);

      lockSoumissionClientFields();
      await loadPendingSoumissions();
    } else {
      log('[AUTO-SAVE] Erreur lors de la sauvegarde automatique');
    }
  } catch (err) {
    log('[AUTO-SAVE] Erreur cr√©ation:', err);
  } finally {
    window.soumissionSavingInProgress = false;
  }
}

// Popup choix: Modifier la soumission existante ou Nouvelle soumission
function showCalculateurDuplicatePopup(existingProject, newNumValue, clientName) {
  const modal = document.createElement('div');
  modal.id = 'calculateurDuplicateModal';
  modal.className = 'fixed inset-0 flex items-center justify-center';
  modal.style.cssText = 'background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 999999; display: flex;';

  const existingNum = existingProject.num || '?';
  const existingPrix = existingProject.prix || '-';

  modal.innerHTML = `
    <div class="status-card p-6" style="width: 90%; max-width: 440px; border-radius: 16px;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold" style="color: var(--text-light);">
          <i class="fas fa-exclamation-triangle mr-2" style="color: #f59e0b;"></i>
          Soumission existante
        </h3>
      </div>
      <p style="color: var(--text-gray); margin-bottom: 6px; font-size: 14px;">
        Une soumission existe d√©j√† pour <strong style="color: var(--text-light);">${clientName}</strong>
      </p>
      <div style="background: rgba(251, 146, 60, 0.1); border: 1px solid rgba(251, 146, 60, 0.3); border-radius: 10px; padding: 10px 14px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; color: var(--text-gray); font-size: 13px;">
          <span>N¬∞ ${existingNum}</span>
          <span style="color: #22c55e; font-weight: 600;">${existingPrix}</span>
        </div>
      </div>
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <button onclick="handleDuplicateChoice('modifier', '${existingProject.id}', '${existingNum}')" style="width: 100%; padding: 13px 20px; border-radius: 12px; border: 2px solid var(--border-dark); background: rgba(251, 146, 60, 0.1); color: var(--text-light); font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(251, 146, 60, 0.2)'; this.style.borderColor='#fb923c'" onmouseout="this.style.background='rgba(251, 146, 60, 0.1)'; this.style.borderColor='var(--border-dark)'">
          <i class="fas fa-edit" style="font-size: 18px; color: #fb923c; width: 24px; text-align: center;"></i>
          <span>Modifier la soumission existante</span>
        </button>
        <button onclick="handleDuplicateChoice('nouveau', '', '${newNumValue}')" style="width: 100%; padding: 13px 20px; border-radius: 12px; border: 2px solid var(--border-dark); background: rgba(96, 165, 250, 0.1); color: var(--text-light); font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(96, 165, 250, 0.2)'; this.style.borderColor='var(--primary-blue)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.1)'; this.style.borderColor='var(--border-dark)'">
          <i class="fas fa-plus-circle" style="font-size: 18px; color: var(--primary-blue); width: 24px; text-align: center;"></i>
          <span>Nouvelle soumission pour ce client</span>
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
}

// G√©rer le choix du popup doublon calculateur
async function handleDuplicateChoice(choice, existingId, numValue) {
  // Fermer le popup
  const modal = document.getElementById('calculateurDuplicateModal');
  if (modal) modal.remove();
  document.body.style.overflow = '';

  const form = document.getElementById('soumissionForm');
  const numField = form ? (form.num || document.querySelector('input[name="num"]')) : null;

  if (choice === 'modifier') {
    // Charger le projet existant avec tous ses champs via editPendingSoumission
    window.soumissionSavingInProgress = false;
    await editPendingSoumission(existingId);

  } else {
    // Cr√©er une nouvelle soumission
    await createNewSoumissionFromCalculateur(numValue);
  }
}

// Charger et afficher les soumissions en attente depuis l'API backend
async function loadPendingSoumissions() {
  const tbody = document.getElementById('pending-soumissions-body');
  const mobileList = document.getElementById('pending-soumissions-mobile-list');
  const countBadge = document.getElementById('pending-count');

  try {
    // R√©cup√©rer depuis l'API backend
    const response = await fetch(`/get-soumissions-queue/${window.username}`);

    if (!response.ok) {
      throw new Error('Erreur lors du chargement');
    }

    const data = await response.json();
    const pendingSoumissions = data.soumissions || [];

    // Mettre √† jour le compteur
    countBadge.textContent = pendingSoumissions.length;

    if (pendingSoumissions.length === 0) {
      // Vue desktop
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center py-8" style="color: var(--text-gray);">
            <i class="fas fa-inbox text-4xl mb-2 opacity-50"></i>
            <p>Aucune soumission en attente</p>
          </td>
        </tr>
      `;

      // Vue mobile
      mobileList.innerHTML = `
        <div class="soumissions-empty-mobile">
          <i class="fas fa-inbox"></i>
          <p>Aucune soumission en attente</p>
        </div>
      `;
      return;
    }

    // G√©n√©rer les lignes de la table (desktop)
    tbody.innerHTML = pendingSoumissions.map(soumission => {
      const adresseEscaped = (soumission.adresse || '').replace(/'/g, "\\'");
      return `
        <tr data-id="${soumission.id}">
          <td style="width: 14%;">${soumission.prenom} ${soumission.nom}</td>
          <td style="width: 12%;">${soumission.num}</td>
          <td style="width: 10%;">${soumission.date || 'N/A'}</td>
          <td style="width: 30%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><a href="javascript:void(0)" onclick="ouvrirSoumissionMapsModal('${adresseEscaped}')" style="color: var(--primary-blue); text-decoration: none; cursor: pointer;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${soumission.adresse || '-'}</a></td>
          <td style="width: 12%; color: #22c55e; font-weight: 600;">${soumission.prix}</td>
          <td class="text-center" style="width: 12%;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 6px;">
              <button onclick="editPendingSoumission('${soumission.id}')"
                      class="btn-primary action-btn-send"
                      title="Modifier">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="deletePendingSoumission('${soumission.id}')"
                      class="btn-secondary action-btn-delete"
                      title="Supprimer">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');

    // G√©n√©rer les cards mobiles
    mobileList.innerHTML = pendingSoumissions.map(soumission => {
      return `
        <div class="soumission-mobile-card" data-id="${soumission.id}">
          <div class="soumission-card-header">
            <div style="flex: 1;">
              <div class="soumission-card-numero">Soumission ${soumission.num}</div>
              <div class="soumission-card-client">${soumission.prenom} ${soumission.nom}</div>
              <div class="soumission-card-adresse">
                <i class="fas fa-map-marker-alt" style="color: var(--primary-green); margin-top: 2px;"></i>
                <span>${soumission.adresse}</span>
              </div>
            </div>
            <div class="soumission-card-montant">${soumission.prix}</div>
          </div>
          <div class="soumission-card-actions">
            <button onclick="editPendingSoumission('${soumission.id}')" class="soumission-action-btn edit-btn">
              <i class="fas fa-edit"></i>
              <span>Modifier</span>
            </button>
            <button onclick="deletePendingSoumission('${soumission.id}')" class="soumission-action-btn delete-btn">
              <i class="fas fa-trash"></i>
              <span>Supprimer</span>
            </button>
          </div>
        </div>
      `;
    }).join('');

  } catch (error) {
    error('[ERROR] Erreur chargement soumissions:', error);

    // Vue desktop
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center py-8" style="color: var(--text-red);">
          <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
          <p>Erreur lors du chargement des soumissions</p>
        </td>
      </tr>
    `;

    // Vue mobile
    mobileList.innerHTML = `
      <div class="soumissions-empty-mobile" style="color: var(--text-red);">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Erreur lors du chargement des soumissions</p>
      </div>
    `;
  }
}

// Charger juste le compteur des soumissions envoy√©es (au chargement initial)
async function loadSentCount() {
  try {
    const response = await fetch(`/soumissions/${window.username}`);
    if (response.ok) {
      const all = await response.json();
      const sent = all.filter(s => !s.num?.startsWith('POT-') && s.source !== 'potentiel' && s.pdf_url);
      document.getElementById('sent-count').textContent = sent.length || 0;
    }
  } catch (e) {
    log('[SENT-COUNT] Erreur:', e);
  }
}

// Switcher entre les onglets √Ä envoyer / Envoy√©es
function showSoumissionTab(tab) {
  const tabAEnvoyer = document.getElementById('tab-a-envoyer');
  const tabEnvoyees = document.getElementById('tab-envoyees');
  const contentAEnvoyer = document.getElementById('soumission-tab-a-envoyer');
  const contentEnvoyees = document.getElementById('soumission-tab-envoyees');

  if (tab === 'a-envoyer') {
    tabAEnvoyer.style.opacity = '1';
    tabEnvoyees.style.opacity = '0.5';
    contentAEnvoyer.style.display = '';
    contentEnvoyees.style.display = 'none';
  } else {
    tabAEnvoyer.style.opacity = '0.5';
    tabEnvoyees.style.opacity = '1';
    contentAEnvoyer.style.display = 'none';
    contentEnvoyees.style.display = '';
    loadSentSoumissions();
  }
}

// Formater un prix en format fran√ßais (ex: "2000.00" -> "2 000,00 $")
function formatPrixDisplay(prix) {
  if (!prix || prix === '-') return '-';
  // Si d√©j√† format√© avec $, retourner tel quel
  if (typeof prix === 'string' && prix.includes('$')) return prix;
  // Nettoyer et convertir en nombre
  let num = parseFloat(String(prix).replace(/[^0-9.,\-]/g, '').replace(',', '.'));
  if (isNaN(num)) return prix;
  // Formater en fran√ßais
  let parts = num.toFixed(2).split('.');
  let entier = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '\u00A0');
  return entier + ',' + parts[1] + ' $';
}

// Charger et afficher les soumissions envoy√©es
async function loadSentSoumissions() {
  const tbody = document.getElementById('sent-soumissions-body');
  const mobileList = document.getElementById('sent-soumissions-mobile-list');
  const countBadge = document.getElementById('sent-count');

  try {
    const response = await fetch(`/soumissions/${window.username}`);
    if (!response.ok) throw new Error('Erreur chargement');

    const allSoumissions = await response.json();

    // Filtrer uniquement les vraies soumissions envoy√©es (avec pdf_url, pas les POT-)
    const soumissions = allSoumissions.filter(s => {
      if (s.source === 'potentiel') return false;
      if (s.num && s.num.startsWith('POT-')) return false;
      if (!s.pdf_url) return false;
      return true;
    });

    countBadge.textContent = soumissions.length;

    if (!soumissions || soumissions.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="empty-state">
            <i class="fas fa-check-circle" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
            <p style="font-size: 1rem;">Aucune soumission envoy√©e</p>
          </td>
        </tr>
      `;
      mobileList.innerHTML = `
        <div class="soumissions-empty-mobile">
          <i class="fas fa-check-circle"></i>
          <p>Aucune soumission envoy√©e</p>
        </div>
      `;
      return;
    }

    // Trier par date (plus r√©cent en premier) - format DD/MM/YYYY
    const sorted = [...soumissions].sort((a, b) => {
      const parseDate = (d) => {
        if (!d) return 0;
        const parts = d.split('/');
        if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]).getTime();
        return new Date(d).getTime() || 0;
      };
      return parseDate(b.date) - parseDate(a.date);
    });

    // Vue desktop
    tbody.innerHTML = sorted.map(s => {
      const pdfUrl = s.pdf_url || '';
      const clientName = `${s.prenom || ''} ${s.nom || ''}`.trim();
      const pdfBtn = pdfUrl ? `
        <button onclick="openSoumissionPDF('${pdfUrl}', '${clientName.replace(/'/g, "\\'")}')"
                class="btn-primary action-btn-send"
                title="Voir le PDF">
          <i class="fas fa-file-pdf"></i>
        </button>
      ` : '';

      const adresseEscaped = (s.adresse || '').replace(/'/g, "\\'");
      return `
        <tr>
          <td style="width: 14%;">${clientName || '-'}</td>
          <td style="width: 12%;">${s.num || '-'}</td>
          <td style="width: 10%;">${s.date || '-'}</td>
          <td style="width: 30%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><a href="javascript:void(0)" onclick="ouvrirSoumissionMapsModal('${adresseEscaped}')" style="color: var(--primary-blue); text-decoration: none; cursor: pointer;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${s.adresse || '-'}</a></td>
          <td style="width: 12%; color: #22c55e; font-weight: 600;">${formatPrixDisplay(s.prix)}</td>
          <td class="text-center" style="width: 12%;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 6px;">
              <button onclick="editSentSoumission('${s.id}')"
                      class="btn-primary action-btn-send"
                      title="Modifier">
                <i class="fas fa-edit"></i>
              </button>
              ${pdfBtn}
            </div>
          </td>
        </tr>
      `;
    }).join('');

    // Vue mobile
    mobileList.innerHTML = sorted.map(s => {
      const pdfUrl = s.pdf_url || '';
      const clientName = `${s.prenom || ''} ${s.nom || ''}`.trim();
      return `
        <div class="soumission-mobile-card">
          <div class="soumission-card-header">
            <div style="flex: 1;">
              <div class="soumission-card-numero">Soumission ${s.num || '-'}</div>
              <div class="soumission-card-client">${s.prenom || ''} ${s.nom || ''}</div>
              <div class="soumission-card-adresse">
                <i class="fas fa-map-marker-alt" style="color: var(--primary-green); margin-top: 2px;"></i>
                <span>${s.adresse || '-'}</span>
              </div>
            </div>
            <div class="soumission-card-montant">${formatPrixDisplay(s.prix)}</div>
          </div>
          <div class="soumission-card-actions">
            <button onclick="editSentSoumission('${s.id}')" class="soumission-action-btn edit-btn">
              <i class="fas fa-edit"></i>
              <span>Modifier</span>
            </button>
            ${pdfUrl ? `<button onclick="openSoumissionPDF('${pdfUrl}', '${clientName.replace(/'/g, "\\'")}')" class="soumission-action-btn edit-btn"><i class="fas fa-file-pdf"></i><span>PDF</span></button>` : ''}
          </div>
        </div>
      `;
    }).join('');

  } catch (err) {
    log('[ERROR] Erreur chargement soumissions envoy√©es:', err);
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="empty-state" style="color: var(--text-red);">
          <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; display: block;"></i>
          <p style="font-size: 1rem;">Erreur lors du chargement</p>
        </td>
      </tr>
    `;
  }
}

// R√©initialiser le formulaire avant de charger un nouveau projet
function resetSoumissionForm() {
  // D'abord d√©verrouiller les champs si on √©tait dans un projet
  if (window.soumissionProjectActive) {
    unlockSoumissionClientFields();
  }

  const form = document.getElementById('soumissionForm');
  if (!form) return;

  // Vider tous les champs texte
  const textInputs = form.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"]');
  textInputs.forEach(input => {
    if (input.name !== 'num') { // Garder le num pour le moment (sera √©cras√© apr√®s)
      input.value = '';
      if (!input.readOnly) {
        input.style.setProperty('border-right-color', '#e57373', 'important');
      }
    }
  });

  // R√©initialiser endroit
  const endroitDisplay = document.getElementById('endroitDisplay');
  const endroitTrigger = document.getElementById('endroitTrigger');
  if (endroitDisplay) { endroitDisplay.innerHTML = 'Cliquez pour s√©lectionner les endroits √† peinturer...'; endroitDisplay.style.color = 'var(--text-gray)'; }
  if (endroitTrigger) endroitTrigger.style.setProperty('border-right-color', '#e57373', 'important');
  if (typeof endroitSelections !== 'undefined') endroitSelections = [];
  const endroitHidden = document.getElementById('endroitHidden');
  if (endroitHidden) endroitHidden.value = '';

  // R√©initialiser produit
  const productDisplay = document.getElementById('productDisplay');
  const productTrigger = document.getElementById('productTrigger');
  if (productDisplay) { productDisplay.innerHTML = 'Cliquez pour s√©lectionner pr√©paration et produit...'; productDisplay.style.color = 'var(--text-gray)'; }
  if (productTrigger) productTrigger.style.setProperty('border-right-color', '#e57373', 'important');
  const produitHidden = document.getElementById('produitCouleursHidden');
  if (produitHidden) produitHidden.value = '';
  if (typeof productEndroitsData !== 'undefined') productEndroitsData = {};

  // R√©initialiser item
  const itemDisplay = document.getElementById('itemDisplay');
  const itemTrigger = document.getElementById('itemTrigger');
  if (itemDisplay) { itemDisplay.innerHTML = 'Cliquez pour ajouter les items...'; itemDisplay.style.color = 'var(--text-gray)'; }
  if (itemTrigger) itemTrigger.style.setProperty('border-right-color', '#e57373', 'important');
  const itemHidden = document.getElementById('itemHidden');
  if (itemHidden) itemHidden.value = '';
  if (typeof itemData !== 'undefined') itemData = {};

  // R√©initialiser particularit√©s
  const partDisplay = document.getElementById('partTravauxDisplay');
  const partTrigger = document.getElementById('partTravauxTrigger');
  if (partDisplay) { partDisplay.innerHTML = 'Cliquez pour s√©lectionner particularit√©s des travaux...'; partDisplay.style.color = 'var(--text-gray)'; }
  if (partTrigger) partTrigger.style.setProperty('border-right-color', '#e57373', 'important');
  const partHidden = document.getElementById('partTravauxHidden');
  if (partHidden) partHidden.value = '';

  // Reset flags
  window.editingSoumissionId = null;
  window.editingSentSoumissionId = null;
  window.googleProspectAddressSelected = false;
  window.soumissionProjectActive = false;

  log('[RESET] Formulaire soumission r√©initialis√©');
}

// Modifier/Compl√©ter une soumission en attente (prefill le formulaire)
async function editPendingSoumission(soumissionId) {
  log('‚úèÔ∏è √âdition de la soumission ID:', soumissionId);

  // R√©initialiser le formulaire avant de charger le nouveau projet
  resetSoumissionForm();

  try {
    // R√©cup√©rer les donn√©es de la soumission depuis la base
    const queueResponse = await fetch(`/get-soumissions-queue/${window.username}`);
    if (!queueResponse.ok) throw new Error("Erreur r√©cup√©ration queue");

    const queueData = await queueResponse.json();
    const soumission = queueData.soumissions.find(s => s.id === soumissionId);

    if (!soumission) {
      throw new Error("Soumission introuvable dans la queue");
    }

    // Scroller vers le haut du formulaire
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Attendre un peu pour le scroll
    setTimeout(() => {
      // Prefill tous les champs du formulaire
      const form = document.getElementById('soumissionForm');

      form.num.value = soumission.num || '';

      if (soumission.nom) {
        form.nom.value = soumission.nom;
        form.nom.style.setProperty('border-right-color', '#4caf50', 'important');
      }
      if (soumission.prenom) {
        form.prenom.value = soumission.prenom;
        form.prenom.style.setProperty('border-right-color', '#4caf50', 'important');
      }
      if (soumission.telephone) {
        form.telephone.value = soumission.telephone;
        form.telephone.style.setProperty('border-right-color', '#4caf50', 'important');
      }
      if (soumission.courriel) {
        form.courriel.value = soumission.courriel;
        form.courriel.style.setProperty('border-right-color', '#4caf50', 'important');
      }
      form.date_creation.value = soumission.date || '';
      if (soumission.temps) {
        form.temps.value = soumission.temps;
        form.temps.style.setProperty('border-right-color', '#4caf50', 'important');
      }
      form.date_travaux.value = soumission.date2 || '';
      if (soumission.prix) {
        form.prix.value = soumission.prix;
        form.prix.style.setProperty('border-right-color', '#4caf50', 'important');
        // Calculer automatiquement le d√©p√¥t bas√© sur le prix pr√©-rempli
        calculerDepot();
      }
      if (soumission.adresse) {
        form.adresse.value = soumission.adresse;
        form.adresse.style.setProperty('border-right-color', '#4caf50', 'important');
        // Marquer que l'adresse vient d'une soumission sauvegard√©e (donc d√©j√† valid√©e)
        window.googleProspectAddressSelected = true;
        window.initialAutofilledAddress = soumission.adresse;
      }
      if (soumission.endroit) {
        form.endroit_peinture.value = soumission.endroit;

        // Mettre √† jour l'affichage et la liste des s√©lections
        const endroitDisplay = document.getElementById('endroitDisplay');
        const endroitTrigger = document.getElementById('endroitTrigger');
        const lines = soumission.endroit.split('\n').map(e => e.trim()).filter(e => e);

        if (lines.length > 0) {
          // Mettre √† jour endroitSelections
          endroitSelections = lines;

          // Mettre √† jour l'affichage avec ic√¥ne maison
          if (endroitDisplay) {
            endroitDisplay.innerHTML = lines.map(item => '<div style="margin-bottom: 4px;"><i class="fas fa-home" style="color: var(--primary-blue); margin-right: 8px; font-size: 12px;"></i>' + item + '</div>').join('');
            endroitDisplay.style.color = 'var(--text-light)';
          }

          // Bordure verte
          if (endroitTrigger) {
            endroitTrigger.style.setProperty('border-right-color', '#4caf50', 'important');
          }
        }
      }

      // Prefill produits/couleurs
      if (soumission.produit) {
        document.getElementById('produitCouleursHidden').value = soumission.produit;
        const productDisplay = document.getElementById('productDisplay');

        // Parser les donn√©es par endroit et formater l'affichage
        if (typeof parseProductsByEndroit === 'function') {
          productEndroitsData = parseProductsByEndroit(soumission.produit);

          // Formater l'affichage avec les titres en bleu
          let displayHtml = '';
          Object.keys(productEndroitsData).forEach(endroit => {
            const text = productEndroitsData[endroit] ? productEndroitsData[endroit].trim() : '';
            if (text) {
              displayHtml += `<div style="margin-bottom: 8px;"><strong style="color: var(--primary-blue);">${endroit}:</strong><br>${text.replace(/\n/g, '<br>')}</div>`;
            }
          });

          if (productDisplay && displayHtml) {
            productDisplay.innerHTML = displayHtml;
            productDisplay.style.color = 'var(--text-light)';
          }
        } else if (productDisplay) {
          productDisplay.innerHTML = soumission.produit.replace(/\n/g, '<br>');
          productDisplay.style.color = 'var(--text-light)';
        }
      }

      // Prefill particularit√©s
      if (soumission.part) {
        document.getElementById('partTravauxHidden').value = soumission.part;
        const partDisplay = document.getElementById('partTravauxDisplay');
        if (partDisplay) {
          partDisplay.innerHTML = soumission.part.replace(/\n/g, '<br>');
          partDisplay.style.color = 'var(--text-light)';
        }
      }

      // Prefill items
      if (soumission.item) {
        document.getElementById('itemHidden').value = soumission.item;
        const itemDisplay = document.getElementById('itemDisplay');
        const itemTrigger = document.getElementById('itemTrigger');

        try {
          // Parser le JSON des items
          const items = JSON.parse(soumission.item);
          if (Array.isArray(items) && items.length > 0) {
            // Reconstruire itemData pour openItemModal
            itemData = {};
            let displayHtml = [];
            let hasCompleteItem = false;

            items.forEach((item, index) => {
              itemData[index] = { item: item.nom || '', prix: item.prix || '', duree: item.duree || '' };

              if (item.nom && item.prix && item.duree) {
                hasCompleteItem = true;
              }

              if (item.nom) {
                let html = `<div style="display: flex; align-items: center; gap: 6px; padding: 4px 0;">`;
                html += `<span style="color: var(--text-light);">${item.nom}</span>`;
                if (item.prix) {
                  html += `<span style="color: #4caf50; font-weight: 600;">- ${item.prix}</span>`;
                }
                if (item.duree) {
                  html += `<span style="color: #f59e0b;">(${item.duree})</span>`;
                }
                html += `</div>`;
                displayHtml.push(html);
              }
            });

            if (itemDisplay && displayHtml.length > 0) {
              itemDisplay.innerHTML = displayHtml.join('');
              itemDisplay.style.color = 'var(--text-light)';
            }
            if (itemTrigger) {
              itemTrigger.style.setProperty('border-right-color', hasCompleteItem ? '#4caf50' : '#e57373', 'important');
            }
          }
        } catch (e) {
          // Ancien format texte - afficher tel quel
          if (itemDisplay) {
            itemDisplay.innerHTML = soumission.item.replace(/\n/g, '<br>');
            itemDisplay.style.color = 'var(--text-light)';
          }
        }
      }

      // Stocker l'ID pour savoir qu'on √©dite une soumission existante
      window.editingSoumissionId = soumissionId;

      // Verrouiller les champs client (on est dans un projet)
      lockSoumissionClientFields();

      log('[OK] Formulaire prefilled avec les donn√©es de la soumission');

      // Revalider les champs pour activer les boutons
      if (typeof validateRequiredFields === 'function') {
        setTimeout(() => {
          // Mettre √† jour le compteur Pr√©paration/Produit
          if (typeof updateProductCounter === 'function') {
            updateProductCounter();
          }
          validateRequiredFields();
          log('[OK] Validation des champs apr√®s chargement soumission');
        }, 100);
      }

      // Notification visuelle
      const notification = document.createElement('div');
      notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #3b82f6; color: white; padding: 1rem 1.5rem; border-radius: 8px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
      notification.innerHTML = '<i class="fas fa-edit mr-2"></i>Soumission charg√©e - Vous pouvez modifier et envoyer';
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s';
        setTimeout(() => notification.remove(), 300);
      }, 3000);

    }, 300);

  } catch (error) {
    error('[ERROR] Erreur:', error);
    alert('Erreur lors du chargement de la soumission.');
  }
}

// Modifier une soumission d√©j√† envoy√©e (charger dans le formulaire pour renvoyer)
async function editSentSoumission(soumissionId) {
  log('‚úèÔ∏è √âdition de la soumission envoy√©e ID:', soumissionId);

  // R√©initialiser le formulaire avant de charger le nouveau projet
  resetSoumissionForm();

  try {
    const response = await fetch(`/soumissions/${window.username}`);
    if (!response.ok) throw new Error("Erreur r√©cup√©ration soumissions envoy√©es");

    const soumissions = await response.json();
    const soumission = soumissions.find(s => s.id === soumissionId);

    if (!soumission) {
      throw new Error("Soumission introuvable");
    }

    // Scroller vers le haut du formulaire
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Attendre un peu pour le scroll
    setTimeout(() => {
      const form = document.getElementById('soumissionForm');

      // Garder le m√™me num√©ro de soumission
      form.num.value = soumission.num || '';

      if (soumission.nom) {
        form.nom.value = soumission.nom;
        form.nom.style.setProperty('border-right-color', '#4caf50', 'important');
      }
      if (soumission.prenom) {
        form.prenom.value = soumission.prenom;
        form.prenom.style.setProperty('border-right-color', '#4caf50', 'important');
      }
      if (soumission.telephone) {
        form.telephone.value = soumission.telephone;
        form.telephone.style.setProperty('border-right-color', '#4caf50', 'important');
      }
      if (soumission.courriel) {
        form.courriel.value = soumission.courriel;
        form.courriel.style.setProperty('border-right-color', '#4caf50', 'important');
      }
      form.date_creation.value = soumission.date || '';
      if (soumission.temps) {
        form.temps.value = soumission.temps;
        form.temps.style.setProperty('border-right-color', '#4caf50', 'important');
      }
      form.date_travaux.value = soumission.date2 || '';
      if (soumission.prix) {
        form.prix.value = soumission.prix;
        form.prix.style.setProperty('border-right-color', '#4caf50', 'important');
        calculerDepot();
      }
      if (soumission.adresse) {
        form.adresse.value = soumission.adresse;
        form.adresse.style.setProperty('border-right-color', '#4caf50', 'important');
        window.googleProspectAddressSelected = true;
        window.initialAutofilledAddress = soumission.adresse;
      }
      if (soumission.endroit) {
        form.endroit_peinture.value = soumission.endroit;

        const endroitDisplay = document.getElementById('endroitDisplay');
        const endroitTrigger = document.getElementById('endroitTrigger');
        const lines = soumission.endroit.split('\n').map(e => e.trim()).filter(e => e);

        if (lines.length > 0) {
          endroitSelections = lines;

          if (endroitDisplay) {
            endroitDisplay.innerHTML = lines.map(item => '<div style="margin-bottom: 4px;"><i class="fas fa-home" style="color: var(--primary-blue); margin-right: 8px; font-size: 12px;"></i>' + item + '</div>').join('');
            endroitDisplay.style.color = 'var(--text-light)';
          }

          if (endroitTrigger) {
            endroitTrigger.style.setProperty('border-right-color', '#4caf50', 'important');
          }
        }
      }

      // Prefill produits/couleurs
      if (soumission.produit) {
        document.getElementById('produitCouleursHidden').value = soumission.produit;
        const productDisplay = document.getElementById('productDisplay');

        if (typeof parseProductsByEndroit === 'function') {
          productEndroitsData = parseProductsByEndroit(soumission.produit);

          let displayHtml = '';
          Object.keys(productEndroitsData).forEach(endroit => {
            const text = productEndroitsData[endroit] ? productEndroitsData[endroit].trim() : '';
            if (text) {
              displayHtml += `<div style="margin-bottom: 8px;"><strong style="color: var(--primary-blue);">${endroit}:</strong><br>${text.replace(/\n/g, '<br>')}</div>`;
            }
          });

          if (productDisplay && displayHtml) {
            productDisplay.innerHTML = displayHtml;
            productDisplay.style.color = 'var(--text-light)';
          }
        } else if (productDisplay) {
          productDisplay.innerHTML = soumission.produit.replace(/\n/g, '<br>');
          productDisplay.style.color = 'var(--text-light)';
        }
      }

      // Prefill particularit√©s
      if (soumission.part) {
        document.getElementById('partTravauxHidden').value = soumission.part;
        const partDisplay = document.getElementById('partTravauxDisplay');
        if (partDisplay) {
          partDisplay.innerHTML = soumission.part.replace(/\n/g, '<br>');
          partDisplay.style.color = 'var(--text-light)';
        }
      }

      // Prefill items
      if (soumission.item) {
        document.getElementById('itemHidden').value = soumission.item;
        const itemDisplay = document.getElementById('itemDisplay');
        const itemTrigger = document.getElementById('itemTrigger');

        try {
          const items = JSON.parse(soumission.item);
          if (Array.isArray(items) && items.length > 0) {
            itemData = {};
            let displayHtml = [];
            let hasCompleteItem = false;

            items.forEach((item, index) => {
              itemData[index] = { item: item.nom || '', prix: item.prix || '', duree: item.duree || '' };

              if (item.nom && item.prix && item.duree) {
                hasCompleteItem = true;
              }

              if (item.nom) {
                let html = `<div style="display: flex; align-items: center; gap: 6px; padding: 4px 0;">`;
                html += `<span style="color: var(--text-light);">${item.nom}</span>`;
                if (item.prix) {
                  html += `<span style="color: #4caf50; font-weight: 600;">- ${item.prix}</span>`;
                }
                if (item.duree) {
                  html += `<span style="color: #f59e0b;">(${item.duree})</span>`;
                }
                html += `</div>`;
                displayHtml.push(html);
              }
            });

            if (itemDisplay && displayHtml.length > 0) {
              itemDisplay.innerHTML = displayHtml.join('');
              itemDisplay.style.color = 'var(--text-light)';
            }
            if (itemTrigger) {
              itemTrigger.style.setProperty('border-right-color', hasCompleteItem ? '#4caf50' : '#e57373', 'important');
            }
          }
        } catch (e) {
          if (itemDisplay) {
            itemDisplay.innerHTML = soumission.item.replace(/\n/g, '<br>');
            itemDisplay.style.color = 'var(--text-light)';
          }
        }
      }

      // Prefill payer_par
      if (soumission.payer_par) {
        const payerSelect = form.payer_par || document.querySelector('select[name="payer_par"]');
        if (payerSelect) {
          payerSelect.value = soumission.payer_par;
        }
      }

      // Stocker l'ID de la soumission envoy√©e qu'on modifie
      // On ne set PAS editingSoumissionId (c'est pour la queue)
      // On marque qu'on √©dite une soumission envoy√©e pour la remplacer apr√®s renvoi
      window.editingSentSoumissionId = soumissionId;
      window.editingSoumissionId = null;

      // Verrouiller les champs client (on est dans un projet)
      lockSoumissionClientFields();

      log('[OK] Formulaire prefilled avec soumission envoy√©e');

      // Revalider les champs
      if (typeof validateRequiredFields === 'function') {
        setTimeout(() => {
          if (typeof updateProductCounter === 'function') {
            updateProductCounter();
          }
          validateRequiredFields();
          log('[OK] Validation des champs apr√®s chargement soumission envoy√©e');
        }, 100);
      }

      // Notification visuelle
      const notification = document.createElement('div');
      notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #f59e0b; color: #1a1a2e; padding: 1rem 1.5rem; border-radius: 8px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-weight: 600;';
      notification.innerHTML = '<i class="fas fa-edit mr-2"></i>Soumission charg√©e - Modifiez et renvoyez au client';
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s';
        setTimeout(() => notification.remove(), 300);
      }, 3000);

      // Basculer vers l'onglet √Ä envoyer pour voir le formulaire
      if (typeof showSoumissionTab === 'function') {
        showSoumissionTab('a-envoyer');
      }

    }, 300);

  } catch (error) {
    console.error('[ERROR] Erreur:', error);
    alert('Erreur lors du chargement de la soumission.');
  }
}

// Supprimer une soumission en attente depuis la base de donn√©es
async function deletePendingSoumission(soumissionId) {
  // Cr√©er le popup de confirmation
  showDeleteConfirmPopup(soumissionId);
}

// Fonction pour afficher le popup de confirmation de suppression
function showDeleteConfirmPopup(soumissionId) {
  // Cr√©er l'overlay (m√™me style que calcul.html)
  const overlay = document.createElement('div');
  overlay.id = 'deleteConfirmOverlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
  `;

  // Cr√©er la modal (m√™me style que calcul.html)
  const popup = document.createElement('div');
  popup.style.cssText = `
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: 16px;
    padding: 32px;
    max-width: 450px;
    width: 90%;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(71, 85, 105, 0.3);
    transform: scale(0.9);
    opacity: 0;
    transition: all 0.3s ease;
  `;

  popup.innerHTML = `
    <div style="text-align: center;">
      <div style="width: 64px; height: 64px; background: rgba(239, 68, 68, 0.2); border-radius: 50%; margin: 0 auto 24px; display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 28px;"></i>
      </div>
      <h3 style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 16px;">Supprimer cette soumission</h3>
      <p style="color: #cbd5e1; font-size: 16px; line-height: 1.5; margin-bottom: 32px;">√ätes-vous s√ªr de vouloir supprimer cette soumission ? Cette action est irr√©versible.</p>
      <div style="display: flex; gap: 12px; justify-content: center;">
        <button id="cancelDeleteBtn" class="btn-secondary" style="font-size: 16px;">Annuler</button>
        <button id="confirmDeleteBtn" class="btn-primary" style="
          background: #ef4444 !important;
          border-color: #ef4444 !important;
          border-radius: 24px !important;
          font-size: 16px;
        ">Supprimer</button>
      </div>
    </div>
  `;

  overlay.appendChild(popup);
  document.body.appendChild(overlay);

  // Animation d'apparition
  setTimeout(() => {
    popup.style.transform = 'scale(1)';
    popup.style.opacity = '1';
  }, 10);

  // G√©rer les clics
  document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
    overlay.remove();
  });

  document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
    try {
      const response = await fetch('/remove-soumission-from-queue', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: window.username,
          soumission_id: soumissionId
        })
      });

      if (!response.ok) {
        throw new Error('Erreur lors de la suppression');
      }

      log('[DELETE] Soumission supprim√©e:', soumissionId);

      // Fermer le popup
      overlay.remove();

      // Rafra√Æchir la table
      await loadPendingSoumissions();

    } catch (error) {
      error('[ERROR] Erreur suppression:', error);
      alert('Erreur lors de la suppression de la soumission');
      overlay.remove();
    }
  });

  // Fermer en cliquant sur l'overlay
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.remove();
    }
  });
}

// Exposer les fonctions globalement
window.editPendingSoumission = editPendingSoumission;
window.deletePendingSoumission = deletePendingSoumission;

// ========== RECHERCHE DANS LES TABLES ==========
function filterSoumissionTable(type) {
  const searchInput = document.getElementById(type === 'pending' ? 'search-pending-soumissions' : 'search-sent-soumissions');
  const tbody = document.getElementById(type === 'pending' ? 'pending-soumissions-body' : 'sent-soumissions-body');
  const mobileList = document.getElementById(type === 'pending' ? 'pending-soumissions-mobile-list' : 'sent-soumissions-mobile-list');
  if (!searchInput) return;

  const query = searchInput.value.toLowerCase().trim();

  // Filtrer les lignes desktop
  if (tbody) {
    const rows = tbody.querySelectorAll('tr');
    rows.forEach(row => {
      if (row.querySelector('.empty-state')) return;
      const text = row.textContent.toLowerCase();
      row.style.display = query === '' || text.includes(query) ? '' : 'none';
    });
  }

  // Filtrer les cards mobile
  if (mobileList) {
    const cards = mobileList.querySelectorAll('.soumission-mobile-card');
    cards.forEach(card => {
      const text = card.textContent.toLowerCase();
      card.style.display = query === '' || text.includes(query) ? '' : 'none';
    });
  }
}

// ========== MODAL GOOGLE MAPS ==========
function ouvrirSoumissionMapsModal(adresse) {
  if (!adresse) return;

  const mapsEmbedUrl = `https://www.google.com/maps?q=${encodeURIComponent(adresse)}&output=embed`;

  const modal = document.createElement('div');
  modal.id = 'soumissionMapsModal';
  modal.className = 'fixed inset-0 flex items-center justify-center';
  modal.style.cssText = 'background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 80; display: flex;';

  modal.innerHTML = `
    <div class="status-card p-6 flex flex-col" style="width: 90%; max-width: 800px; height: 70vh; max-height: 70vh;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-map-marker-alt mr-2" style="color: var(--primary-blue);"></i>
          ${adresse}
        </h3>
        <button onclick="fermerSoumissionMapsModal()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);" onmouseover="this.style.background='rgba(96, 165, 250, 0.3)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="flex-1 rounded-lg overflow-hidden" style="background: #0f172a; border: 2px solid var(--border-dark);">
        <iframe src="${mapsEmbedUrl}" style="width: 100%; height: 100%; border: none; border-radius: 8px;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
}

function fermerSoumissionMapsModal() {
  const modal = document.getElementById('soumissionMapsModal');
  if (modal) modal.remove();
  document.body.style.overflow = '';
}

// ========== VISIONNEUSE PDF EN POPUP ==========
function openSoumissionPDF(pdfUrl, clientName) {
  if (!pdfUrl || pdfUrl === '') return;

  const modal = document.createElement('div');
  modal.id = 'soumissionViewerModal';
  modal.className = 'fixed inset-0 flex items-center justify-center';
  modal.style.cssText = 'background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 80; display: flex;';

  modal.innerHTML = `
    <div class="status-card p-6 flex flex-col" style="width: 90%; max-width: 1000px; height: 85vh; max-height: 85vh;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold" style="color: var(--text-light);">
          <i class="fas fa-file-pdf mr-2" style="color: var(--primary-blue);"></i>
          Soumission - ${clientName}
        </h3>
        <button onclick="closeSoumissionViewer()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" style="background: rgba(96, 165, 250, 0.2); color: var(--primary-blue);" onmouseover="this.style.background='rgba(96, 165, 250, 0.3)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.2)'">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="flex-1 rounded-lg overflow-hidden" style="background: #0f172a; border: 2px solid var(--border-dark);">
        <iframe src="${pdfUrl}" style="width: 100%; height: 100%; border: none;"></iframe>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
}

function closeSoumissionViewer() {
  const modal = document.getElementById('soumissionViewerModal');
  if (modal) modal.remove();
  document.body.style.overflow = '';
}

// ========== FIN GESTION DES SOUMISSIONS EN ATTENTE ==========

// Initialiser le formulaire principal
function initFormulaire() {
  const formEl = document.getElementById("soumissionForm");

  if (!formEl) {
    error("Formulaire introuvable");
    return;
  }

  formEl.addEventListener("submit", async function (e) {
    // Les popups g√®rent d√©j√† les champs cach√©s
    e.preventDefault();
    log("[LAUNCH] Click sur Envoyer au client - Ouverture popup confirmation");

    // Afficher le popup de confirmation UNIQUEMENT
    const message = '√ätes-vous s√ªr de vouloir envoyer cette soumission au client?';
    window.showConfirmPopup(message, async function() {
      // L'utilisateur a cliqu√© OUI - maintenant ex√©cuter l'envoi
      log("[LAUNCH] Confirmation OUI re√ßue - D√âBUT SOUMISSION");
      log("[LAUNCH] Prix dans le form au moment du submit:", document.querySelector('input[name="prix"]').value);

      // Validation de l'adresse Google - Accepter aussi les adresses au format canadien valide
      const adresseInput = document.querySelector('input[name="adresse"]');
    log('[DEBUG] DEBUG Validation adresse:', {
      adresse: adresseInput?.value,
      googleProspectAddressSelected: window.googleProspectAddressSelected,
      initialAutofilledAddress: window.initialAutofilledAddress
    });

    if (adresseInput && adresseInput.value.trim() !== '' && !window.googleProspectAddressSelected) {
      // V√©rifier si l'adresse est au format canadien valide (QC ou ON)
      const adresse = adresseInput.value.trim();
      const formatCanadienRegex = /^.+,\s*.+,\s*(QC|Quebec|Qu√©bec|ON|Ontario)\s+[A-Za-z]\d[A-Za-z]\s+\d[A-Za-z]\d$/i;

      if (!formatCanadienRegex.test(adresse)) {
        log('[ERROR] Adresse invalide:', adresse);
        alert('Veuillez s√©lectionner une adresse valide dans les suggestions Google ou entrer une adresse au format : "123 Rue Example, Ville, QC J7E 4S9" ou "123 Queen Street, Toronto, ON M5H 3M9"');
        const btn = document.getElementById("submitBtn");
        const btnText = document.getElementById("btnText");
        btn.disabled = false;
        btnText.textContent = "Cr√©er la soumission";
        return;
      } else {
        log('[OK] Adresse au format canadien valide d√©tect√©e:', adresse);
      }
    } else {
      log('[OK] Validation adresse bypassed (auto-remplie depuis prospect/calcul)');
    }

    // username est maintenant g√©r√© par common.js
    const btn = document.getElementById("submitBtn");
    const btnText = document.getElementById("btnText");

    btn.disabled = true;
    btnText.textContent = "Envoi en cours...";

    const form = e.target;
    const eventId = form.dataset.eventId || null;

    const data = {
      username: window.username,
      nom: form.nom.value,
      prenom: form.prenom.value,
      telephone: form.telephone.value,
      courriel: form.courriel.value,
      date: form.date_creation.value,
      temps: form.temps.value,
      num: form.num.value,
      date2: form.date_travaux.value,
      prix: (() => {
        const prixValue = form.prix.value.trim();
        log('[MONEY] Prix original du form:', prixValue);
        log('[MONEY] Prix en unicode √©chapp√©:', JSON.stringify(prixValue));
        
        if (!prixValue || prixValue === '') {
          log('[MONEY] Prix vide, retour de "0"');
          return '0';
        }
        
        // Enlever tout sauf chiffres, espaces (normaux ET ins√©cables), virgules et points
        let cleaned = prixValue.replace(/[^\d\s\u00A0.,]/g, '');
        log('[MONEY] Prix apr√®s nettoyage symboles:', cleaned);
        
        // Enlever TOUS les espaces (normaux \s ET ins√©cables \u00A0)
        cleaned = cleaned.replace(/[\s\u00A0]+/g, '');
        log('[MONEY] Prix apr√®s nettoyage espaces:', cleaned);
        
        // Si on a un format fran√ßais avec virgule d√©cimale (ex: "1000,00")
        // On veut convertir "1000,00" vers "1000.00" pour le backend
        
        // D√©tecter le format: si derni√®re virgule est suivie de 2 chiffres exactement, c'est fran√ßais
        const lastCommaIndex = cleaned.lastIndexOf(',');
        const lastDotIndex = cleaned.lastIndexOf('.');
        
        if (lastCommaIndex > lastDotIndex && lastCommaIndex === cleaned.length - 3) {
          // Format fran√ßais: "1000,00" -> remplacer derni√®re virgule par point
          cleaned = cleaned.substring(0, lastCommaIndex) + '.' + cleaned.substring(lastCommaIndex + 1);
          log('[MONEY] Format fran√ßais d√©tect√©, conversion:', cleaned);
        }
        
        // Nettoyer les virgules restantes (s√©parateurs de milliers)
        cleaned = cleaned.replace(/,/g, '');
        log('[MONEY] Prix final envoy√©:', cleaned);
        
        // Validation finale
        const finalNumber = parseFloat(cleaned);
        if (isNaN(finalNumber)) {
          log('[MONEY] [ERROR] Nombre invalide, retour de "0"');
          return '0';
        }
        
        log('[MONEY] [OK] Validation r√©ussie:', finalNumber);
        return cleaned;
      })(),
      depot: form.depot.value,
      adresse: form.adresse.value,
      endroit: form.endroit_peinture.value,
      produit: document.getElementById("produitCouleursHidden").value,
      item: document.getElementById("itemHidden").value,
      part: document.getElementById("partTravauxHidden").value,
      payer_par: window.dropdownStates?.paidBy || "Virement Interac",
    };

    log("[LAUNCH] AVANT FETCH - Donn√©es √† envoyer:", data);
    log("[LAUNCH] AVANT FETCH - URL:", `/creer-pdf?username=${window.username}`);
    
    try {
      const pdfResponse = await fetch(`/creer-pdf?username=${window.username}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      if (!pdfResponse.ok) {
        const text = await pdfResponse.text();
        error("Erreur lors de la cr√©ation du PDF :", pdfResponse.status, text);
        throw new Error("Erreur PDF");
      }

      const { lien_pdf } = await pdfResponse.json();
      log("[OK] PDF cr√©√© avec succ√®s :", lien_pdf);

      const emailPayload = {
        username: window.username,
        destinataire: form.courriel.value,
        nom_client: form.nom.value,
        prenom_client: form.prenom.value,
        lien_pdf,
        prix_str: form.prix.value,
        depot_str: form.depot.value,  // NOUVEAU: Passer le d√©p√¥t saisi dans le formulaire
        adresse: form.adresse.value || " ",
        telephone: form.telephone.value || " ",
        language: currentLanguage  // NOUVEAU: Passer la langue s√©lectionn√©e
      };

      log("EMAIL PAYLOAD", emailPayload);
      log("üì§ Envoi vers /envoyer-soumission-email d√©clench√©");

      // R√©server le num√©ro de soumission avant envoi
      await reserverNumeroSoumission();

      const emailRes = await fetch(`${window.location.origin}/envoyer-soumission-email`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(emailPayload)
      });

      const errorText = await emailRes.text();
      log("EMAIL ERROR", errorText);

      if (!emailRes.ok) {
        error("Erreur email:", errorText);
        throw new Error("Erreur email");
      }

      // [OK] Email envoy√© avec succ√®s - Enregistrer la soumission pour les statistiques
      try {
        const statsResponse = await fetch(`/api/record-soumission/${window.username}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        if (statsResponse.ok) {
          log("[DATA] Soumission enregistr√©e dans les statistiques");
        } else {
          log("[WARN] Erreur enregistrement statistiques (non bloquant)");
        }
      } catch (e) {
        log("[WARN] Erreur stats (non bloquant):", e);
      }

      // [OK] Si on modifiait une soumission en attente, la supprimer de la queue
      if (window.editingSoumissionId) {
        try {
          log("[DELETE] Suppression de la soumission de la queue:", window.editingSoumissionId);
          await fetch('/remove-soumission-from-queue', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: window.username,
              soumission_id: window.editingSoumissionId
            })
          });
          log("[OK] Soumission retir√©e de la queue apr√®s envoi");
          // R√©initialiser la variable
          window.editingSoumissionId = null;
          // Rafra√Æchir la table
          await loadPendingSoumissions();
        } catch (e) {
          log("[WARN] Erreur suppression de la queue (non bloquant):", e);
        }
      }

      // [OK] Supprimer le prospect de la liste des potentiels
      try {
        const prospectData = {
          nom: form.nom.value,
          prenom: form.prenom.value,
          telephone: form.telephone.value
        };

        log("[DELETE] Tentative de suppression du prospect:", prospectData);

        const deleteResponse = await fetch(`${window.location.origin}/supprimer-prospect/${window.username}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(prospectData)
        });

        if (deleteResponse.ok) {
          const deleteResult = await deleteResponse.json();
          log("[OK] Prospect supprim√© de la liste potentiels:", deleteResult);
        } else {
          log("[WARN] Prospect non trouv√© dans la liste potentiels (normal si pas venu d'un prospect)");
        }
      } catch (prospectError) {
        log("[WARN] Erreur lors de la suppression du prospect (non critique):", prospectError);
      }

      if (eventId) {
        await fetch("/supprimer-evenement", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ event_id: eventId, username })
        });

        const rowToRemove = document.querySelector(`tr[data-event-id="${eventId}"]`);
        if (rowToRemove) rowToRemove.remove();
      }

      const oldDate = form.date_creation.value;
      form.reset();
      // Remettre la date d'aujourd'hui par d√©faut
      const today = new Date();
      const day = String(today.getDate()).padStart(2, '0');
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const year = today.getFullYear();
      const formattedDate = `${day}/${month}/${year}`;
      form.date_creation.value = formattedDate;
      form.removeAttribute("data-event-id");
      
      // Restaurer le num√©ro de soumission apr√®s reset
      genererNumeroSoumission();

      const resetDropdown = (id, placeholder) => {
        const toggle = document.getElementById(id);
        if (toggle) {
          toggle.classList.remove('has-selection');
          toggle.innerHTML = `<span class="placeholder" style="color: rgb(156 163 175); font-family: ui-sans-serif, system-ui, sans-serif; font-size: 14px;">${placeholder}</span>`;
          document.querySelectorAll(`#${id.replace("Toggle", "Menu")} .check`).forEach(c => c.textContent = "");
        } else {
          warn(`Element ${id} non trouv√© pour reset dropdown`);
        }
      };

      resetDropdown("toggleBox", "Produit/Couleurs");
      resetDropdown("partTravauxToggle", "Particularit√© des travaux");
      resetDropdown("paidByToggle", "Pay√© par");

      // R√©initialiser les champs cach√©s
      const produitHidden = document.getElementById("produitCouleursHidden");
      if (produitHidden) produitHidden.value = "";

      const partHidden = document.getElementById("partTravauxHidden");
      if (partHidden) partHidden.value = "";

      const itemHiddenReset = document.getElementById("itemHidden");
      if (itemHiddenReset) itemHiddenReset.value = "";

      // R√©initialiser l'affichage des champs produit/couleurs, item et part des travaux
      const productDisplay = document.getElementById("productDisplay");
      if (productDisplay) {
        productDisplay.textContent = "Cliquez pour s√©lectionner pr√©paration et produit...";
        productDisplay.style.color = "var(--text-gray)";
      }

      const itemDisplayReset = document.getElementById("itemDisplay");
      if (itemDisplayReset) {
        itemDisplayReset.textContent = "Cliquez pour ajouter les items...";
        itemDisplayReset.style.color = "var(--text-gray)";
      }

      const partTravauxDisplay = document.getElementById("partTravauxDisplay");
      if (partTravauxDisplay) {
        partTravauxDisplay.textContent = "Cliquez pour s√©lectionner particularit√©s des travaux...";
        partTravauxDisplay.style.color = "var(--text-gray)";
      }

      // R√©initialiser "Pay√© par" vers "Virement Interac" (s√©lection correcte)
      if (window.dropdownStates) {
        window.dropdownStates.paidBy = "Virement Interac";
      }
      const paidByToggle = document.getElementById("paidByToggle");
      if (paidByToggle) {
        paidByToggle.classList.add('has-selection');
        paidByToggle.innerHTML = `<span class="tag">Virement Interac</span>`;
      }

      log("[OK] Champs r√©initialis√©s: produit/couleurs, item, part des travaux, pay√© par");

      // Bannir le client de la liste "√† compl√©ter" du calculateur
      // Utiliser l'eventId stock√© au moment de l'autofill (avant nettoyage sessionStorage)
      let clientEventId = eventId || window.storedEventId;
      log("[DEBUG] EventId pour bannissement:", clientEventId, "(original:", eventId, ", stock√©:", window.storedEventId, ")");
      bannirClientACompleter(data, clientEventId);

      // Nettoyer les donn√©es de session apr√®s le bannissement
      sessionStorage.removeItem('submissionData');
      sessionStorage.removeItem('clientData');

      // Afficher l'animation de succ√®s puis recharger la page (√† la fin)
      showSuccessAnimation('envoi');

    } catch (error) {
      error("[ERROR] ERREUR JS COMPL√àTE :", error);
      btnText.textContent = "Erreur lors de l'envoi";
      setTimeout(() => {
        btnText.textContent = "Envoyer au client";
        btn.disabled = false;
      }, 3000);
    } finally {
      // CRITIQUE: Retirer le client de la liste des perdus M√äME si l'envoi email √©choue
      // Cela garantit que le client r√©cup√©r√© est bien retir√© des perdus
      try {
        const clientPerduId = sessionStorage.getItem('client_perdu_id') || window.clientOriginalId;
        if (clientPerduId) {
          log("üîÑ [FINALLY] Tentative de retrait du client perdu r√©cup√©r√©:", clientPerduId);

          const retirerResponse = await fetch(`${window.location.origin}/retirer-client-perdu`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: window.username,
              clientOriginalId: clientPerduId
            })
          });

          if (retirerResponse.ok) {
            const retirerResult = await retirerResponse.json();
            log("[OK] [FINALLY] Client retir√© de la liste des perdus:", retirerResult);
            // Nettoyer apr√®s avoir retir√© de perdus
            sessionStorage.removeItem('client_perdu_id');
            window.clientOriginalId = null;
          } else {
            log("[WARN] [FINALLY] Client non trouv√© dans les perdus");
          }
        } else {
          log("[INFO] [FINALLY] Pas de client perdu √† retirer (soumission normale)");
        }
      } catch (perduError) {
        log("[WARN] [FINALLY] Erreur lors du retrait du client perdu (non critique):", perduError);
      }
    }
    }, function() {
      log("[LAUNCH] Confirmation NON - envoi annul√©");
    });
  });
}

// Fonction pour mettre √† jour la date - EXACT COPY de newgqp.html
function updateCurrentDate() {
  const now = new Date();
  const options = { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  };
  const dateString = now.toLocaleDateString('fr-FR', options);
  document.getElementById('currentDate').textContent = dateString;
}

// Initialiser la date au chargement
document.addEventListener('DOMContentLoaded', function() {
  updateCurrentDate();
});

// Appeler l'initialisation du formulaire
initFormulaire();

// Formatage automatique du prix
function formatPrice(value) {
  // Enlever tout sauf les chiffres et points/virgules
  const cleanValue = value.replace(/[^\d.,]/g, '');
  
  // Convertir en nombre
  const number = parseFloat(cleanValue.replace(',', '.'));
  
  if (isNaN(number)) return '';
  
  // Formater avec espaces pour les milliers et virgule pour les d√©cimales
  const formatted = new Intl.NumberFormat('fr-CA', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(number);
  
  return formatted + ' $';
}

// Ajouter le listener sur le champ prix
document.addEventListener('DOMContentLoaded', function() {
  const prixField = document.querySelector('input[name="prix"]');

  if (prixField) {
    prixField.addEventListener('blur', function(e) {
      const value = e.target.value.trim();
      if (value && value !== '') {
        e.target.value = formatPrice(value);
      }
    });

    // Permettre seulement les chiffres, points, virgules et $
    prixField.addEventListener('input', function(e) {
      const value = e.target.value;
      // Garder seulement les caract√®res valides pour un prix
      e.target.value = value.replace(/[^0-9.,$ ]/g, '');
    });
  }

  // Ajouter le m√™me formatage sur le champ d√©p√¥t
  const depotField = document.querySelector('input[name="depot"]');

  if (depotField) {
    depotField.addEventListener('blur', function(e) {
      const value = e.target.value.trim();
      if (value && value !== '') {
        e.target.value = formatPrice(value);
      }
    });

    // Permettre seulement les chiffres, points, virgules et $
    depotField.addEventListener('input', function(e) {
      const value = e.target.value;
      // Garder seulement les caract√®res valides pour un prix
      e.target.value = value.replace(/[^0-9.,$ ]/g, '');
    });
  }
});

// Fonction de d√©connexion
window.logout = function() {
  localStorage.removeItem("qwotaCredentials");
  localStorage.removeItem("rememberMe");
  localStorage.removeItem('username');
  localStorage.removeItem('token');
  window.location.href = "/login";
};

// ===================================
// GESTION SIGNATURE PR√âSENTATION
// ===================================

let presentationSignatureCanvas = null;
let presentationSignatureCtx = null;
let isPresentationDrawing = false;
let hasPresentationSignature = false;
let presentationPoints = [];
let currentPdfUrl = null; // Pour stocker l'URL du PDF affich√©
let lastCanvasElement = null; // Pour d√©tecter si le canvas a √©t√© recr√©√©
let currentPdfDocument = null; // Pour stocker le document PDF
let currentPdfPage = null; // Pour stocker la page PDF actuelle
let currentFormData = null; // Pour stocker les donn√©es du formulaire
let currentSoumissionId = null; // Pour stocker l'ID de la soumission

// Dimensions du rectangle de signature original dans le PDF (pas zoom√©)
window.originalSignatureRect = {width: 150, height: 35};

// Positions originales de la signature (calibr√©es pour un PDF √† scale 1.5)
// Ces valeurs sont pour un PDF standard letter/A4
const ORIGINAL_SIGNATURE_POSITION = {
  bottom: 123,  // pixels depuis le bas du canvas
  left: 117,    // pixels depuis la gauche du canvas
  width: 150,   // largeur de la zone
  height: 35    // hauteur de la zone
};

// Fonction pour mettre √† jour la position du signatureOverlay sur mobile
// Note: Le zoom est maintenant d√©sactiv√© sur mobile, donc la signature reste toujours visible √† 100%
window.updateSignatureOverlayPosition = function(zoomLevel = 1) {
  let signatureOverlay = document.getElementById('signatureOverlay');
  if (!signatureOverlay) {
    signatureOverlay = window.parent.document.getElementById('signatureOverlay');
  }

  if (!signatureOverlay) return;

  // Le zoom est d√©sactiv√© sur mobile, donc on garde toujours la signature visible
  signatureOverlay.style.opacity = '1';
  signatureOverlay.style.pointerEvents = 'auto';

  log('[DEBUG] Signature overlay always visible (zoom disabled on mobile)');
};

// Mettre √† jour la position de la signature lors du resize de la fen√™tre
window.addEventListener('resize', () => {
  if (window.updateSignatureOverlayPosition) {
    window.updateSignatureOverlayPosition();
  }
});

// Aussi mettre √† jour lors du changement d'orientation
window.addEventListener('orientationchange', () => {
  setTimeout(() => {
    if (window.updateSignatureOverlayPosition) {
      window.updateSignatureOverlayPosition();
    }
  }, 100);
});

// Ouvrir le popup de signature zoom
window.openSignatureZoomPopup = async function() {
  log('[SIGNATURE] ========================================');
  log('[SIGNATURE] openSignatureZoomPopup appel√©');
  log('[SIGNATURE] ========================================');

  // RESET COMPLET - Tout remettre √† 0 avant d'ouvrir
  hasPresentationSignature = false;
  presentationPoints = [];

  // D√©tecter si iframe imbriqu√©e (mobile: 2 niveaux) ou directe (desktop: 1 niveau)
  const isNestedIframe = window.parent && window.parent.parent && window.parent.parent !== window.parent;
  const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

  log('[SIGNATURE] Niveaux iframe:', isNestedIframe ? '2 (mobile)' : '1 (desktop)');

  // Chercher dans l'iframe d'abord, puis dans le rootWindow (apppc.html sur mobile)
  let popup = document.getElementById('signatureZoomPopup');
  if (!popup && rootWindow && rootWindow.document) {
    popup = rootWindow.document.getElementById('signatureZoomPopup');
  }

  let pdfModal = document.getElementById('pdfModal');
  if (!pdfModal && rootWindow && rootWindow.document) {
    pdfModal = rootWindow.document.getElementById('pdfModal');
  }

  const parentBody = rootWindow.document.body;

  log('[SIGNATURE] Popup signature:', popup);
  log('[SIGNATURE] PDF Modal:', pdfModal);
  log('[SIGNATURE] PDF Modal display AVANT:', pdfModal ? pdfModal.style.display : 'null');
  log('[SIGNATURE] PDF Modal z-index AVANT:', pdfModal ? rootWindow.getComputedStyle(pdfModal).zIndex : 'null');
  log('[SIGNATURE] Popup parent:', popup ? popup.parentElement : 'null');

  // IMPORTANT: Supprimer tous les anciens popups dans le parent pour √©viter les doublons
  const oldPopups = rootWindow.document.querySelectorAll('#signatureZoomPopup');
  log('[SIGNATURE] Nombre de popups trouv√©s dans parent:', oldPopups.length);
  if (oldPopups.length > 0) {
    oldPopups.forEach((oldPopup, index) => {
      if (oldPopup !== popup) {
        log('[SIGNATURE] Suppression ancien popup #' + index);
        oldPopup.remove();
      }
    });
  }

  // D√©placer le popup vers le parent si pas d√©j√† fait
  if (popup && popup.parentElement !== parentBody) {
    parentBody.appendChild(popup);
    log('[SIGNATURE] Popup d√©plac√© vers rootWindow (apppc.html)');
  }

  // Cacher temporairement le modal PDF pour voir seulement le popup signature
  if (pdfModal) {
    pdfModal.style.display = 'none';
    log('[SIGNATURE] PDF Modal cach√© - display APR√àS:', pdfModal.style.display);
  } else {
    log('[SIGNATURE] ATTENTION: pdfModal non trouv√©!');
  }

  if (popup) {
    popup.style.display = 'flex';
    log('[SIGNATURE] Popup display set to flex');
    log('[SIGNATURE] Popup computed style:', {
      display: rootWindow.getComputedStyle(popup).display,
      zIndex: rootWindow.getComputedStyle(popup).zIndex,
      position: rootWindow.getComputedStyle(popup).position,
      pointerEvents: rootWindow.getComputedStyle(popup).pointerEvents
    });

    // Ajuster les dimensions du canvas et des conteneurs sur PC et tablette
    const isPC = window.innerWidth >= 601;
    if (isPC) {
      // Conteneur ext√©rieur (premier enfant du popup)
      const outerContainer = popup.querySelector('div[style*="max-width: 380px"]');
      if (outerContainer) {
        outerContainer.style.maxWidth = '458px';
      }

      // Conteneur de signature
      const signatureContainer = popup.querySelector('#signatureContainer');
      if (signatureContainer) {
        signatureContainer.style.maxWidth = '458px';
      }

      // Canvas de signature
      const canvas = popup.querySelector('#presentationSignaturePad');
      if (canvas) {
        canvas.style.width = '458px';
        canvas.style.height = '117px';
      }

      log('[SIGNATURE] Dimensions PC/tablette appliqu√©es: 458x117px');
    } else {
      log('[SIGNATURE] Dimensions mobile maintenues: 320x75px');
    }

    // Attacher les √©v√©nements des boutons du popup
    const clearBtn = popup.querySelector('button[onclick*="clearSignatureZoom"]');
    const closeBtn = popup.querySelector('button[onclick*="closeSignatureZoomPopup"]');
    const validateBtn = popup.querySelector('#validateSignatureBtn');

    if (clearBtn) {
      clearBtn.onclick = () => window.clearSignatureZoom();
    }
    if (closeBtn) {
      closeBtn.onclick = () => window.closeSignatureZoomPopup();
    }
    if (validateBtn) {
      validateBtn.onclick = () => window.validateSignature();
    }
  }

  // Initialiser le canvas de signature (sans PDF en arri√®re-plan)
  setTimeout(async () => {
    // Plus besoin de rendre le PDF zoom√© - case de signature simple
    initPresentationSignatureCanvas();

    // Effacer compl√®tement le canvas apr√®s init pour √™tre s√ªr qu'il est vide
    if (presentationSignatureCtx && presentationSignatureCanvas) {
      presentationSignatureCtx.clearRect(0, 0, presentationSignatureCanvas.width, presentationSignatureCanvas.height);
    }

    // D√©sactiver le bouton valider
    let validateBtn = document.getElementById('validateSignatureBtn');
    if (!validateBtn) validateBtn = window.parent.document.getElementById('validateSignatureBtn');
    if (validateBtn) {
      validateBtn.disabled = true;
      validateBtn.classList.remove('btn-success');
      validateBtn.setAttribute('style', 'background-color: rgba(148, 163, 184, 0.3) !important; color: rgba(203, 213, 225, 0.5) !important; pointer-events: none !important;');
    }

    // Afficher le hint
    let zoomHint = document.getElementById('signatureZoomHint');
    if (!zoomHint) zoomHint = window.parent.document.getElementById('signatureZoomHint');
    if (zoomHint) zoomHint.style.display = 'block';
  }, 100);
};

// Rendre le PDF zoom√© en arri√®re-plan du popup
async function renderZoomedPdfBackground() {
  if (!currentPdfPage) return;

  // Chercher le canvas dans l'iframe d'abord, puis dans le parent
  let zoomCanvas = document.getElementById('pdfZoomCanvas');
  if (!zoomCanvas) {
    zoomCanvas = window.parent.document.getElementById('pdfZoomCanvas');
  }

  if (!zoomCanvas) {
    error('[ERROR] pdfZoomCanvas non trouv√©!');
    return;
  }

  const zoomCtx = zoomCanvas.getContext('2d');
  log('[DEBUG] Rendu du PDF zoom√© sur canvas:', zoomCanvas);

  // √âchelle de zoom - sur mobile on utilise un zoom adapt√©
  const isMobileCheck = window.innerWidth <= 1200 || 'ontouchstart' in window;
  const zoomScale = isMobileCheck ? 3.0 : 6.0; // 2x sur mobile, 4x sur desktop
  const viewport = currentPdfPage.getViewport({ scale: zoomScale });

  // Calculer quelle partie du PDF afficher (zone de signature en bas)
  // La signature est √† bottom: 123px du bas du PDF √† √©chelle 1.5
  // √Ä √©chelle 4.5, c'est 123 * (4.5/1.5) = 369px du bas

  // Utiliser les dimensions r√©elles du canvas apr√®s application du CSS (important pour mobile)
  const zoomCanvasRect = zoomCanvas.getBoundingClientRect();
  const containerWidth = zoomCanvasRect.width > 0 ? zoomCanvasRect.width : (700 - 48);
  const containerHeight = zoomCanvasRect.height > 0 ? zoomCanvasRect.height : 300;

  log('[DEBUG] Canvas zoom dimensions:', { containerWidth, containerHeight });

  // Dimensions du canvas zoom
  zoomCanvas.width = containerWidth;
  zoomCanvas.height = containerHeight;

  // Cr√©er un canvas temporaire pour le rendu complet
  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = viewport.width;
  tempCanvas.height = viewport.height;
  const tempCtx = tempCanvas.getContext('2d');

  // Rendre le PDF complet sur le canvas temporaire
  await currentPdfPage.render({
    canvasContext: tempCtx,
    viewport: viewport
  }).promise;

  // La signature est √† bottom: 123px, left: 117px √† l'√©chelle 1.5
  // Convertir en position √† l'√©chelle 6.0:
  const signatureBottomAt1_5 = 123;
  const signatureLeftAt1_5 = 117;
  const signatureWidthAt1_5 = 150;
  const signatureHeightAt1_5 = 35;

  // Position √† l'√©chelle correspondante - sur mobile, zoom un peu moins
  const isMobile = containerHeight < 250;
  const zoomMultiplier = isMobile ? 2 : 4; // 2x sur mobile, 4x sur desktop
  const signatureBottomAtZoom = signatureBottomAt1_5 * zoomMultiplier;
  const signatureLeftAtZoom = signatureLeftAt1_5 * zoomMultiplier;
  const signatureWidthAtZoom = signatureWidthAt1_5 * zoomMultiplier;
  const signatureHeightAtZoom = signatureHeightAt1_5 * zoomMultiplier;

  log('[DEBUG] Signature zoom:', { isMobile, zoomMultiplier, signatureWidthAtZoom, signatureHeightAtZoom });

  // Position Y du haut de la zone de signature (depuis le haut du PDF)
  const signatureTopFromTop = viewport.height - signatureBottomAtZoom - signatureHeightAtZoom;

  // Centrer la zone de signature dans la vue (verticalement)
  const sourceY = signatureTopFromTop - (containerHeight - signatureHeightAtZoom) / 2;
  const sourceX = signatureLeftAtZoom - (containerWidth - signatureWidthAtZoom) / 2;

  zoomCtx.drawImage(
    tempCanvas,
    sourceX, sourceY, containerWidth, containerHeight, // Source (zone √† copier)
    0, 0, containerWidth, containerHeight // Destination (canvas zoom)
  );

  // Dessiner un rectangle pour indiquer la zone de signature
  // Position dans le canvas zoom (centr√©)
  const signatureXInZoom = (containerWidth - signatureWidthAtZoom) / 2;
  const signatureYInZoom = (containerHeight - signatureHeightAtZoom) / 2;

  // Stocker les coordonn√©es de la zone de signature pour la restriction
  window.signatureZoomBounds = {
    x: signatureXInZoom,
    y: signatureYInZoom,
    width: signatureWidthAtZoom,
    height: signatureHeightAtZoom
  };

  log('[DEBUG] signatureZoomBounds:', window.signatureZoomBounds, 'containerSize:', { containerWidth, containerHeight });

  // Dessiner un rectangle avec bordure en pointill√©s bleus
  zoomCtx.strokeStyle = 'rgba(96, 165, 250, 0.6)';
  zoomCtx.lineWidth = 3;
  zoomCtx.setLineDash([10, 5]);
  zoomCtx.strokeRect(signatureXInZoom, signatureYInZoom, signatureWidthAtZoom, signatureHeightAtZoom);
  zoomCtx.setLineDash([]); // R√©initialiser
}

// Fermer le popup de signature zoom
window.closeSignatureZoomPopup = function() {
  log('[SIGNATURE] ========================================');
  log('[SIGNATURE] closeSignatureZoomPopup appel√©');
  log('[SIGNATURE] ========================================');

  // D√©tecter si iframe imbriqu√©e (mobile: 2 niveaux) ou directe (desktop: 1 niveau)
  const isNestedIframe = window.parent && window.parent.parent && window.parent.parent !== window.parent;
  const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

  let popup = document.getElementById('signatureZoomPopup');
  if (!popup && rootWindow && rootWindow.document) {
    popup = rootWindow.document.getElementById('signatureZoomPopup');
  }

  let pdfModal = document.getElementById('pdfModal');
  if (!pdfModal && rootWindow && rootWindow.document) {
    pdfModal = rootWindow.document.getElementById('pdfModal');
  }

  log('[SIGNATURE] Popup display AVANT fermeture:', popup ? popup.style.display : 'null');
  log('[SIGNATURE] PDF Modal display AVANT r√©affichage:', pdfModal ? pdfModal.style.display : 'null');

  if (popup) {
    popup.style.display = 'none';
    log('[SIGNATURE] Popup ferm√© - display:', popup.style.display);
  }

  // R√©afficher le modal PDF
  if (pdfModal) {
    pdfModal.style.display = 'flex';
    log('[SIGNATURE] PDF Modal r√©affich√© - display:', pdfModal.style.display);
  }

  // TOUJOURS r√©initialiser quand on annule (ne pas garder l'ancienne signature)
  clearSignatureZoom();
  log('[SIGNATURE] Signature cleared');
};

// Effacer la signature dans le zoom
window.clearSignatureZoom = function() {
  clearPresentationSignature();
};

// Valider la signature et fermer le popup
window.validateSignature = function() {
  log('[SIGNATURE] ========================================');
  log('[SIGNATURE] validateSignature appel√©');
  log('[SIGNATURE] ========================================');

  if (!hasPresentationSignature) {
    log('[SIGNATURE] ATTENTION: Pas de signature √† valider!');
    return;
  }

  // D√©tecter si iframe imbriqu√©e (mobile: 2 niveaux) ou directe (desktop: 1 niveau)
  const isNestedIframe = window.parent && window.parent.parent && window.parent.parent !== window.parent;
  const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

  // Copier la signature sur le canvas preview
  let previewCanvas = document.getElementById('signaturePreviewCanvas');
  if (!previewCanvas && rootWindow && rootWindow.document) {
    previewCanvas = rootWindow.document.getElementById('signaturePreviewCanvas');
  }

  if (!previewCanvas) {
    error('[ERROR] signaturePreviewCanvas non trouv√©!');
    return;
  }

  const previewCtx = previewCanvas.getContext('2d');

  // Configurer le preview canvas avec le m√™me ratio pour √©viter pixelisation
  const ratio = Math.max(window.devicePixelRatio || 1, 2);

  // Le rectangle de signature dans le PDF original (taille r√©elle, pas zoom√©e)
  const originalSignatureRect = window.originalSignatureRect || {width: 150, height: 35};

  // Sur mobile, utiliser la taille du container parent (qui a √©t√© ajust√©e par updateSignatureOverlayPosition)
  let signaturePreviewParent = previewCanvas.parentElement;
  if (!signaturePreviewParent) {
    let sp = document.getElementById('signaturePreview');
    if (!sp) sp = window.parent.document.getElementById('signaturePreview');
    signaturePreviewParent = sp;
  }

  // Utiliser la taille affich√©e du parent ou les dimensions originales
  let previewWidth = originalSignatureRect.width;
  let previewHeight = originalSignatureRect.height;

  if (signaturePreviewParent) {
    const parentRect = signaturePreviewParent.getBoundingClientRect();
    if (parentRect.width > 0 && parentRect.height > 0) {
      previewWidth = parentRect.width;
      previewHeight = parentRect.height;
    }
  }

  previewCanvas.width = previewWidth * ratio;
  previewCanvas.height = previewHeight * ratio;
  previewCanvas.style.width = '100%';
  previewCanvas.style.height = '100%';

  previewCtx.scale(ratio, ratio);

  // Activer le lissage pour une meilleure qualit√© lors du redimensionnement
  previewCtx.imageSmoothingEnabled = true;
  previewCtx.imageSmoothingQuality = 'high';

  // Effacer d'abord
  previewCtx.clearRect(0, 0, previewWidth, previewHeight);

  // Copier la signature du canvas popup vers le preview
  // Garder l'aspect ratio pour ne pas d√©former la signature
  const sourceWidth = presentationSignatureCanvas.width;
  const sourceHeight = presentationSignatureCanvas.height;

  // Calculer le ratio d'aspect
  const sourceAspect = sourceWidth / sourceHeight;
  const targetAspect = previewWidth / previewHeight;

  let drawWidth, drawHeight, offsetX, offsetY;

  // Ajuster pour garder l'aspect ratio et centrer
  if (sourceAspect > targetAspect) {
    // Source plus large - fit par la largeur
    drawWidth = previewWidth;
    drawHeight = previewWidth / sourceAspect;
    offsetX = 0;
    offsetY = (previewHeight - drawHeight) / 2;
  } else {
    // Source plus haute - fit par la hauteur
    drawHeight = previewHeight;
    drawWidth = previewHeight * sourceAspect;
    offsetX = (previewWidth - drawWidth) / 2;
    offsetY = 0;
  }

  // Copier en gardant l'aspect ratio
  previewCtx.drawImage(
    presentationSignatureCanvas,
    0, 0, sourceWidth, sourceHeight,  // Source: tout le canvas
    offsetX, offsetY, drawWidth, drawHeight  // Destination: centr√© avec bon aspect ratio
  );

  // Afficher le preview, cacher le hint
  previewCanvas.style.display = 'block';

  let signatureHint = document.getElementById('signatureHint');
  if (!signatureHint && rootWindow && rootWindow.document) {
    signatureHint = rootWindow.document.getElementById('signatureHint');
  }
  if (signatureHint) signatureHint.style.display = 'none';

  // Effacer le canvas zoom (mais PAS le preview) pour √™tre pr√™t pour la prochaine signature
  if (presentationSignatureCtx && presentationSignatureCanvas) {
    presentationSignatureCtx.clearRect(0, 0, presentationSignatureCanvas.width, presentationSignatureCanvas.height);
  }
  // NE PAS remettre hasPresentationSignature √† false - on a besoin que ce soit true pour accepter la soumission
  // hasPresentationSignature = false;
  presentationPoints = [];

  // Fermer le popup
  let popup = document.getElementById('signatureZoomPopup');
  if (!popup && rootWindow && rootWindow.document) {
    popup = rootWindow.document.getElementById('signatureZoomPopup');
  }

  let pdfModal = document.getElementById('pdfModal');
  if (!pdfModal && rootWindow && rootWindow.document) {
    pdfModal = rootWindow.document.getElementById('pdfModal');
  }

  log('[SIGNATURE] Popup display AVANT fermeture:', popup ? popup.style.display : 'null');
  log('[SIGNATURE] PDF Modal display AVANT r√©affichage:', pdfModal ? pdfModal.style.display : 'null');

  if (popup) {
    popup.style.display = 'none';
    log('[SIGNATURE] Popup ferm√© apr√®s validation - display:', popup.style.display);
  }

  // V√©rifier si on est sur mobile
  const isMobilePresentation = window.innerWidth <= 1200;

  if (isMobilePresentation) {
    // Sur mobile: afficher le popup de confirmation APR√àS la signature
    log('[SIGNATURE] Mobile - Affichage popup confirmation');
    setTimeout(() => {
      const message = '√ätes-vous s√ªr de vouloir accepter cette soumission?';
      window.showConfirmPopup(message, function() {
        // L'utilisateur a cliqu√© OUI - maintenant accepter
        log('[SIGNATURE] Mobile - Confirmation OUI re√ßue');
        if (window.acceptPresentation) {
          window.acceptPresentation();
        }
      }, function() {
        log('[SIGNATURE] Mobile - Confirmation NON - annul√©');
      });
    }, 100);
  } else {
    // Sur desktop: activer le bouton accepter
    let acceptBtn = document.getElementById('acceptPresentationBtn');
    if (!acceptBtn) acceptBtn = window.parent.document.getElementById('acceptPresentationBtn');

    if (acceptBtn) {
      acceptBtn.disabled = false;
      acceptBtn.removeAttribute('style'); // Enlever le style inline gris
      acceptBtn.classList.add('btn-success');
      acceptBtn.style.boxShadow = 'none'; // Retirer l'ombre

      const acceptBtnSpan = acceptBtn.querySelector('span');
      if (acceptBtnSpan) {
        acceptBtnSpan.textContent = 'Accepter la soumission';
      }
    }

    // R√©afficher le modal PDF
    if (pdfModal) {
      pdfModal.style.display = 'flex';
      log('[SIGNATURE] PDF Modal r√©affich√© apr√®s validation - display:', pdfModal.style.display);
      log('[SIGNATURE] PDF Modal z-index:', window.parent.getComputedStyle(pdfModal).zIndex);
    }
  }

  log('[SIGNATURE] validateSignature termin√©');
};

// Initialiser le canvas de signature lors de l'ouverture du popup zoom
function initPresentationSignatureCanvas() {
  log('[SIGNATURE] === D√âBUT initPresentationSignatureCanvas ===');

  // D√©tecter si iframe imbriqu√©e (mobile: 2 niveaux) ou directe (desktop: 1 niveau)
  const isNestedIframe = window.parent && window.parent.parent && window.parent.parent !== window.parent;
  const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

  // Chercher le canvas dans l'iframe d'abord, puis dans le rootWindow (apppc.html sur mobile)
  presentationSignatureCanvas = document.getElementById('presentationSignaturePad');
  if (!presentationSignatureCanvas && rootWindow && rootWindow.document) {
    presentationSignatureCanvas = rootWindow.document.getElementById('presentationSignaturePad');
    log('[SIGNATURE] Canvas trouv√© dans rootWindow document');
  } else if (presentationSignatureCanvas) {
    log('[SIGNATURE] Canvas trouv√© dans iframe document');
  }

  if (!presentationSignatureCanvas) {
    error('[ERROR] presentationSignaturePad non trouv√©!');
    return;
  }

  log('[SIGNATURE] Canvas element:', presentationSignatureCanvas);

  // V√©rifier si c'est le m√™me canvas que la derni√®re fois
  const isSameCanvas = (presentationSignatureCanvas === lastCanvasElement);
  log('[SIGNATURE] Canvas identique √† la derni√®re fois?', isSameCanvas);
  log('[SIGNATURE] lastCanvasElement:', lastCanvasElement);

  if (!isSameCanvas && lastCanvasElement) {
    log('[SIGNATURE] ‚ö†Ô∏è ATTENTION: Le canvas a √©t√© RECR√â√â! Les anciens √©v√©nements ne fonctionneront plus.');
  }

  // Mettre √† jour la r√©f√©rence
  lastCanvasElement = presentationSignatureCanvas;

  log('[SIGNATURE] Canvas style AVANT fix:', {
    width: presentationSignatureCanvas.style.width,
    height: presentationSignatureCanvas.style.height,
    display: presentationSignatureCanvas.style.display
  });

  // Calculer les dimensions adapt√©es pour mobile/desktop
  // R√©cup√©rer la largeur du conteneur parent du canvas
  const canvasContainer = presentationSignatureCanvas.parentElement;
  const containerWidth = canvasContainer ? canvasContainer.offsetWidth : 320;

  // D√©terminer les dimensions selon l'appareil (PC/tablette vs mobile)
  const isPC = window.innerWidth >= 601;
  const maxWidth = isPC ? Math.min(containerWidth, 458) : Math.min(containerWidth, 320);
  const canvasWidth = isPC ? 458 : maxWidth;
  const canvasHeight = isPC ? 117 : Math.round(maxWidth / 4.27); // PC/tablette: 458x117, Mobile: ratio 4.27:1 (320/75)

  // FORCER les dimensions du canvas calcul√©es avec !important
  presentationSignatureCanvas.style.setProperty('width', canvasWidth + 'px', 'important');
  presentationSignatureCanvas.style.setProperty('height', canvasHeight + 'px', 'important');
  presentationSignatureCanvas.style.setProperty('display', 'block', 'important');

  log('[SIGNATURE] Canvas style APR√àS fix:', {
    width: presentationSignatureCanvas.style.width,
    height: presentationSignatureCanvas.style.height,
    display: presentationSignatureCanvas.style.display,
    containerWidth: containerWidth,
    calculatedWidth: canvasWidth,
    calculatedHeight: canvasHeight
  });

  presentationSignatureCtx = presentationSignatureCanvas.getContext('2d');

  // Configuration du canvas avec ratio plus √©lev√© pour √©viter pixelisation
  const ratio = Math.max(window.devicePixelRatio || 1, 2); // Minimum 2x au lieu de 1

  log('[DEBUG] Signature canvas dimensions:', { canvasWidth, canvasHeight });

  presentationSignatureCanvas.width = canvasWidth * ratio;
  presentationSignatureCanvas.height = canvasHeight * ratio;
  presentationSignatureCanvas.style.setProperty('width', canvasWidth + 'px', 'important');
  presentationSignatureCanvas.style.setProperty('height', canvasHeight + 'px', 'important');

  presentationSignatureCtx.scale(ratio, ratio);

  // Configuration du style de dessin - comme signature standard
  presentationSignatureCtx.lineCap = 'round';
  presentationSignatureCtx.lineJoin = 'round';

  // Trait plus fin sur mobile, moyen sur desktop
  const isMobile = window.innerWidth <= 1200;
  presentationSignatureCtx.lineWidth = isMobile ? 1.4 : 2.5;
  presentationSignatureCtx.strokeStyle = '#000000';

  // Qualit√© de rendu maximale pour un trait smooth
  presentationSignatureCtx.imageSmoothingEnabled = true;
  presentationSignatureCtx.imageSmoothingQuality = 'high';

  // IMPORTANT: S'assurer que le fond reste transparent
  presentationSignatureCtx.clearRect(0, 0, presentationSignatureCanvas.width, presentationSignatureCanvas.height);

  // Retirer les √©v√©nements existants pour √©viter les doublons apr√®s navigation
  presentationSignatureCanvas.removeEventListener('pointerdown', startPresentationDrawing);
  presentationSignatureCanvas.removeEventListener('pointermove', drawPresentation);
  presentationSignatureCanvas.removeEventListener('pointerup', stopPresentationDrawing);
  presentationSignatureCanvas.removeEventListener('pointercancel', stopPresentationDrawing);

  log('[SIGNATURE] √âv√©nements retir√©s, ajout de nouveaux √©v√©nements...');

  // √âv√©nements tactiles et souris
  presentationSignatureCanvas.addEventListener('pointerdown', startPresentationDrawing);
  presentationSignatureCanvas.addEventListener('pointermove', drawPresentation);
  presentationSignatureCanvas.addEventListener('pointerup', stopPresentationDrawing);
  presentationSignatureCanvas.addEventListener('pointercancel', stopPresentationDrawing);

  log('[SIGNATURE] √âv√©nements attach√©s avec succ√®s au canvas');
  log('[SIGNATURE] Canvas final dimensions:', {
    styleWidth: presentationSignatureCanvas.style.width,
    styleHeight: presentationSignatureCanvas.style.height,
    actualWidth: presentationSignatureCanvas.width,
    actualHeight: presentationSignatureCanvas.height,
    canvasWidth: canvasWidth,
    canvasHeight: canvasHeight
  });
  log('[SIGNATURE] === FIN initPresentationSignatureCanvas ===');
}

function startPresentationDrawing(e) {
  log('[SIGNATURE] startPresentationDrawing appel√© - event:', e.type, 'canvas:', !!presentationSignatureCanvas);

  if (!presentationSignatureCanvas) {
    error('[SIGNATURE] Canvas non trouv√© dans startPresentationDrawing!');
    return;
  }

  const rect = presentationSignatureCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  log('[SIGNATURE] Position:', { x, y, rectWidth: rect.width, rectHeight: rect.height });

  // Sur mobile, pas de restriction de bounds - on peut signer partout dans le canvas
  // Le rectangle bleu en pointill√©s indique la zone id√©ale mais ne bloque pas le dessin

  isPresentationDrawing = true;
  presentationPoints = [];

  // Cacher les hints (preview et zoom)
  let hint = document.getElementById('signatureHint');
  if (!hint) hint = window.parent.document.getElementById('signatureHint');
  if (hint) hint.style.display = 'none';

  let zoomHint = document.getElementById('signatureZoomHint');
  if (!zoomHint) zoomHint = window.parent.document.getElementById('signatureZoomHint');
  if (zoomHint) zoomHint.style.display = 'none';

  presentationPoints.push({ x, y });
  presentationSignatureCtx.beginPath();
  presentationSignatureCtx.moveTo(x, y);
}

function drawPresentation(e) {
  if (!isPresentationDrawing) return;
  e.preventDefault();

  const rect = presentationSignatureCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  presentationPoints.push({ x, y });

  // Dessin smooth avec courbes quadratiques
  if (presentationPoints.length >= 3) {
    const [p0, p1, p2] = presentationPoints.slice(-3);
    const cpx = (p0.x + p1.x) / 2;
    const cpy = (p0.y + p1.y) / 2;
    presentationSignatureCtx.quadraticCurveTo(p0.x, p0.y, cpx, cpy);
    presentationSignatureCtx.stroke();
    presentationSignatureCtx.beginPath();
    presentationSignatureCtx.moveTo(cpx, cpy);
  } else {
    presentationSignatureCtx.lineTo(x, y);
    presentationSignatureCtx.stroke();
  }

  // Activer le bouton d'acceptation
  hasPresentationSignature = true;

  // D√©tecter si iframe imbriqu√©e (mobile: 2 niveaux) ou directe (desktop: 1 niveau)
  const isNestedIframe = window.parent && window.parent.parent && window.parent.parent !== window.parent;
  const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

  // Activer le bouton valider dans le popup zoom
  let validateBtn = document.getElementById('validateSignatureBtn');
  if (!validateBtn && rootWindow && rootWindow.document) {
    validateBtn = rootWindow.document.getElementById('validateSignatureBtn');
  }

  if (validateBtn) {
    validateBtn.disabled = false;
    validateBtn.removeAttribute('style'); // Enlever le style inline gris
    validateBtn.classList.add('btn-success');
  }

  // Afficher le bouton effacer
  let clearBtn = document.getElementById('clearSignatureBtn');
  if (!clearBtn) clearBtn = window.parent.document.getElementById('clearSignatureBtn');
  if (clearBtn) clearBtn.style.display = 'block';
}

function stopPresentationDrawing() {
  if (!isPresentationDrawing) return;
  isPresentationDrawing = false;

  if (presentationPoints.length >= 3) {
    const lastTwoPoints = presentationPoints.slice(-2);
    presentationSignatureCtx.lineTo(lastTwoPoints[1].x, lastTwoPoints[1].y);
    presentationSignatureCtx.stroke();
  }
  presentationSignatureCtx.closePath();
}

// Fonction pour effacer la signature
window.clearPresentationSignature = function() {
  // Effacer le canvas de signature zoom
  if (presentationSignatureCtx && presentationSignatureCanvas) {
    presentationSignatureCtx.clearRect(0, 0, presentationSignatureCanvas.width, presentationSignatureCanvas.height);
  }

  // Effacer aussi le canvas preview
  let previewCanvas = document.getElementById('signaturePreviewCanvas');
  if (!previewCanvas) previewCanvas = window.parent.document.getElementById('signaturePreviewCanvas');
  if (previewCanvas) {
    const previewCtx = previewCanvas.getContext('2d');
    previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
    previewCanvas.style.display = 'none';
  }

  // R√©initialiser toutes les variables
  hasPresentationSignature = false;
  presentationPoints = [];

  // Remettre le bouton accepter en gris SEULEMENT sur desktop
  const isMobileClear = window.innerWidth <= 1200;
  let acceptBtn = document.getElementById('acceptPresentationBtn');
  if (!acceptBtn) acceptBtn = window.parent.document.getElementById('acceptPresentationBtn');

  if (acceptBtn && !isMobileClear) {
    // Sur desktop: d√©sactiver le bouton
    acceptBtn.disabled = true;
    acceptBtn.classList.remove('btn-success');
    acceptBtn.setAttribute('style', 'background-color: rgba(148, 163, 184, 0.3) !important; color: rgba(203, 213, 225, 0.5) !important; pointer-events: none !important;');
  }
  // Sur mobile: on laisse le bouton "Signer la soumission" actif

  // D√©sactiver le bouton valider dans le popup zoom
  let validateBtn = document.getElementById('validateSignatureBtn');
  if (!validateBtn) validateBtn = window.parent.document.getElementById('validateSignatureBtn');

  if (validateBtn) {
    validateBtn.disabled = true;
    validateBtn.classList.remove('btn-success');
    validateBtn.setAttribute('style', 'background-color: rgba(148, 163, 184, 0.3) !important; color: rgba(203, 213, 225, 0.5) !important; pointer-events: none !important;');
  }

  // R√©afficher les hints (preview et zoom)
  let hint = document.getElementById('signatureHint');
  if (!hint) hint = window.parent.document.getElementById('signatureHint');
  if (hint) hint.style.display = 'block';

  let zoomHint = document.getElementById('signatureZoomHint');
  if (!zoomHint) zoomHint = window.parent.document.getElementById('signatureZoomHint');
  if (zoomHint) zoomHint.style.display = 'block';

  // Cacher le bouton effacer
  let clearBtn = document.getElementById('clearSignatureBtn');
  if (!clearBtn) clearBtn = window.parent.document.getElementById('clearSignatureBtn');
  if (clearBtn) clearBtn.style.display = 'none';
};

// Fonction pour fermer le modal
window.closePdfModal = function() {
  log('[closePdfModal] Fermeture du modal...');

  // D√©tecter si iframe imbriqu√©e (mobile: 2 niveaux) ou directe (desktop: 1 niveau)
  const isNestedIframe = window.parent && window.parent.parent && window.parent.parent !== window.parent;
  const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

  log('[closePdfModal] Niveaux iframe:', isNestedIframe ? '2 (mobile)' : '1 (desktop)');

  // Chercher les √©l√©ments dans l'iframe d'abord, puis dans le rootWindow
  let pdfModal = document.getElementById("pdfModal");
  let modalWasInParent = false;
  if (!pdfModal && rootWindow && rootWindow.document) {
    pdfModal = rootWindow.document.getElementById("pdfModal");
    modalWasInParent = true;
    log('[closePdfModal] Modal trouv√© dans rootWindow');
  }

  let pdfOverlay = document.getElementById("pdfOverlay");
  if (!pdfOverlay && rootWindow && rootWindow.document) {
    pdfOverlay = rootWindow.document.getElementById("pdfOverlay");
  }

  let closePdfBtn = document.getElementById("closePdfBtn");
  if (!closePdfBtn && rootWindow && rootWindow.document) {
    closePdfBtn = rootWindow.document.getElementById("closePdfBtn");
  }

  // Ramener le modal et overlay dans l'iframe D'ABORD (avant de cacher)
  if (modalWasInParent && rootWindow && rootWindow.document) {
    if (pdfModal && pdfModal.parentElement === rootWindow.document.body) {
      document.body.appendChild(pdfModal);
      log('[closePdfModal] Modal ramen√© dans iframe');
    }
    if (pdfOverlay && pdfOverlay.parentElement === rootWindow.document.body) {
      document.body.appendChild(pdfOverlay);
      log('[closePdfModal] Overlay ramen√© dans iframe');
    }

    // D√©bloquer le scroll du parent
    rootWindow.document.body.style.overflow = "auto";
    rootWindow.document.body.classList.remove('modal-open');
    log('[closePdfModal] Scroll parent d√©bloqu√©');
  }

  // PUIS cacher les √©l√©ments
  if (pdfModal) {
    pdfModal.classList.add("hidden");
    log('[closePdfModal] Modal cach√©');
  }
  if (pdfOverlay) {
    pdfOverlay.style.display = "none";
  }
  if (closePdfBtn) {
    closePdfBtn.classList.add("hidden");
  }

  document.body.style.overflow = "auto";

  // Restaurer AppPC
  if (rootWindow && rootWindow.document) {
    const appContainer = rootWindow.document.querySelector('#app-container');
    if (appContainer) {
      appContainer.style.display = '';
      log('[closePdfModal] AppPC r√©affich√©');
    }
  }

  // R√©initialiser la signature
  clearPresentationSignature();

  log('[closePdfModal] ‚úÖ Modal ferm√©');
};

// Fonction helper pour d√©tecter la langue √† partir de l'adresse
function detectLanguageFromAddress(address) {
  if (!address) return 'fr'; // D√©faut fran√ßais

  const addressUpper = address.toUpperCase();

  // D√©tecter Ontario
  if (addressUpper.includes('ONTARIO') ||
      addressUpper.includes(', ON') ||
      addressUpper.includes(' ON ')) {
    log('[LANG] Ontario d√©tect√© ‚Üí anglais');
    return 'en';
  }

  // Toutes les autres provinces ‚Üí fran√ßais
  log('[LANG] Pas Ontario ‚Üí fran√ßais');
  return 'fr';
}

// Fonction pour accepter la soumission avec signature
window.acceptPresentation = async function() {
  log('[acceptPresentation] Fonction appel√©e');
  log('[acceptPresentation] hasPresentationSignature =', hasPresentationSignature);
  log('[acceptPresentation] currentFormData =', currentFormData);

  if (!hasPresentationSignature) {
    log('[acceptPresentation] BLOQU√â - Pas de signature');
    alert('Veuillez signer avant d\'accepter.');
    return;
  }

  if (!currentFormData) {
    log('[acceptPresentation] BLOQU√â - Pas de donn√©es');
    alert('Erreur: Donn√©es manquantes. Veuillez r√©essayer.');
    return;
  }

  // D√©tecter si iframe imbriqu√©e (mobile: 2 niveaux) ou directe (desktop: 1 niveau)
  const isNestedIframe = window.parent && window.parent.parent && window.parent.parent !== window.parent;
  const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

  // Chercher le bouton dans l'iframe d'abord, puis dans le rootWindow
  let btn = document.getElementById('acceptPresentationBtn');
  if (!btn && rootWindow && rootWindow.document) {
    btn = rootWindow.document.getElementById('acceptPresentationBtn');
    log('[acceptPresentation] Bouton trouv√© dans rootWindow (', isNestedIframe ? '2 niveaux' : '1 niveau', ')');
  }

  if (!btn) {
    error('[acceptPresentation] ERREUR - Bouton non trouv√©!');
    alert('Erreur: Bouton non trouv√©. Veuillez r√©essayer.');
    return;
  }

  log('[acceptPresentation] Bouton trouv√©:', btn);
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Cr√©ation...';

  try {
    // √âtape 1: Cr√©er la soumission (elle ira directement dans accept√©es apr√®s signature)
    const createResponse = await fetch(`${window.location.origin}/creer-pdf?username=${window.username}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(currentFormData)
    });

    if (!createResponse.ok) {
      const errText = await createResponse.text();
      throw new Error("Erreur lors de la cr√©ation de la soumission : " + errText);
    }

    const createResult = await createResponse.json();
    const pdfUrl = createResult.lien_pdf;
    const soumissionId = createResult.id;

    log('[DEBUG] ACCEPTATION - Soumission cr√©√©e:', soumissionId);

    // √âtape 2: Pr√©parer la signature
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Signature...';

    // Chercher le canvas de signature dans l'iframe d'abord, puis dans le rootWindow
    let previewCanvas = document.getElementById('signaturePreviewCanvas');
    if (!previewCanvas && rootWindow && rootWindow.document) {
      previewCanvas = rootWindow.document.getElementById('signaturePreviewCanvas');
      log('[acceptPresentation] Canvas signature trouv√© dans rootWindow (', isNestedIframe ? '2 niveaux' : '1 niveau', ')');
    }

    if (!previewCanvas) {
      error('[acceptPresentation] ERREUR - Canvas signature non trouv√©!');
      alert('Erreur: Signature non trouv√©e. Veuillez r√©essayer.');
      btn.disabled = false;
      btn.innerHTML = originalText;
      return;
    }

    log('[acceptPresentation] Canvas signature trouv√©:', previewCanvas);
    const signatureDataUrl = previewCanvas.toDataURL('image/png');

    // √âtape 3: D√©tecter la langue selon l'adresse (Ontario = anglais)
    const clientLanguage = detectLanguageFromAddress(currentFormData.adresse);
    log('[acceptPresentation] Langue d√©tect√©e:', clientLanguage, 'pour adresse:', currentFormData.adresse);

    // √âtape 4: Envoyer avec signature (va dans ventes_acceptees)
    const payload = {
      username: window.username,
      clientEmail: currentFormData.courriel,
      clientNom: currentFormData.nom,
      clientPrenom: currentFormData.prenom,
      pdfUrl: pdfUrl,
      signatureDataUrl: signatureDataUrl,
      prix_str: currentFormData.prix,
      soumission_id: soumissionId,
      num: currentFormData.num,
      adresse: currentFormData.adresse || "",
      telephone: currentFormData.telephone || "",
      language: clientLanguage  // IMPORTANT: Langue pour les courriels
    };

    log('[DEBUG] ACCEPTATION - Envoi signature:', payload);

    // R√©server le num√©ro de soumission avant envoi signature
    await reserverNumeroSoumission();

    const response = await fetch('/api/envoyer-soumission-signee', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Erreur ${response.status}: ${errorText}`);
    }

    const result = await response.json();
    log('[DEBUG] ACCEPTATION - R√©ponse:', result);

    // Si on modifiait une soumission en attente, la supprimer de la queue
    if (window.editingSoumissionId) {
      try {
        log("[DELETE] Suppression de la soumission de la queue apr√®s signature:", window.editingSoumissionId);
        await fetch('/remove-soumission-from-queue', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: window.username,
            soumission_id: window.editingSoumissionId
          })
        });
        log("[OK] Soumission retir√©e de la queue apr√®s signature");
        window.editingSoumissionId = null;
      } catch (e) {
        log("[WARN] Erreur suppression de la queue (non bloquant):", e);
      }
    }

    // IMPORTANT: Bannir le client de "clients √† compl√©ter aujourd'hui" si c'est un client de cette liste
    if (window.storedEventId) {
      log('[BAN] Client vient de "clients √† compl√©ter" - bannissement event_id:', window.storedEventId);
      try {
        await bannirClientACompleter(currentFormData, window.storedEventId);
        log('[OK] Client banni de "clients √† compl√©ter aujourd\'hui"');
        // R√©initialiser l'eventId apr√®s bannissement
        window.storedEventId = null;
      } catch (e) {
        log('[WARN] Erreur bannissement client (non bloquant):', e);
      }
    } else {
      log('[INFO] Pas de storedEventId - client ne vient pas de "clients √† compl√©ter"');
    }

    // Fermer le modal
    closePdfModal();

    // Afficher l'animation de succ√®s puis recharger la page
    showSuccessAnimation('presentation');

  } catch (err) {
    error('[ERROR] Erreur acceptation:', err);
    alert('‚ùå Erreur lors de l\'envoi: ' + err.message);
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
};

// Attacher l'√©v√©nement click au bouton apr√®s la d√©finition de la fonction
function attachAcceptButtonEvent() {
  log('[attachAcceptButtonEvent] Tentative d\'attachement');

  // Chercher le bouton dans l'iframe d'abord, puis dans le parent
  let acceptBtn = document.getElementById('acceptPresentationBtn');
  if (!acceptBtn && window.parent && window.parent.document) {
    acceptBtn = window.parent.document.getElementById('acceptPresentationBtn');
    log('[attachAcceptButtonEvent] Bouton cherch√© dans le parent');
  }

  log('[attachAcceptButtonEvent] Bouton trouv√©:', !!acceptBtn);

  if (acceptBtn) {
    // Retirer les anciens √©v√©nements si pr√©sents
    acceptBtn.onclick = null;

    // Attacher le nouvel √©v√©nement
    acceptBtn.addEventListener('click', function(e) {
      log('[acceptBtn] Click d√©tect√©');

      if (acceptBtn.disabled) {
        log('[acceptBtn] BLOQU√â - bouton disabled');
        return;
      }

      const isMobilePresentation = window.innerWidth <= 1200;

      if (isMobilePresentation) {
        // Sur mobile: ouvrir DIRECTEMENT le popup de signature (pas de confirmation ici)
        // La confirmation viendra APR√àS avoir sign√©
        log('[acceptBtn] Mobile - Ouverture popup signature');
        if (window.openSignatureZoomPopup) {
          window.openSignatureZoomPopup();
        }
      } else {
        // Sur desktop: afficher le popup de confirmation d'abord
        const message = '√ätes-vous s√ªr de vouloir accepter cette soumission?';
        window.showConfirmPopup(message, function() {
          log('[acceptBtn] Desktop - Confirmation OUI re√ßue');
          if (window.acceptPresentation) {
            window.acceptPresentation();
          }
        }, function() {
          log('[acceptBtn] Confirmation NON - annul√©');
        });
      }
    });
    log('[attachAcceptButtonEvent] √âv√©nement attach√© avec succ√®s');
  } else {
    log('[attachAcceptButtonEvent] ERREUR - Bouton non trouv√©!');
  }
}

// Attacher imm√©diatement si le DOM est d√©j√† pr√™t
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', attachAcceptButtonEvent);
} else {
  // DOM d√©j√† charg√© (cas o√π on arrive depuis calculateur)
  attachAcceptButtonEvent();
}

// Aussi exposer la fonction globalement pour pouvoir la rappeler si besoin
window.attachAcceptButtonEvent = attachAcceptButtonEvent;

// ============================================
// POPUP DE CONFIRMATION PERSONNALIS√â
// ============================================
window.showConfirmPopup = function(message, onConfirm, onCancel) {
  // Trouver la bonne fen√™tre (g√©rer les iframes)
  const isNestedIframe = window.parent && window.parent.parent && window.parent.parent !== window.parent;
  const rootWindow = isNestedIframe ? window.parent.parent : (window.parent !== window ? window.parent : window);
  const targetDoc = rootWindow.document || document;

  // Supprimer popup existant
  const existing = targetDoc.getElementById('confirmPopupOverlay');
  if (existing) existing.remove();

  // Cr√©er le popup
  const overlay = targetDoc.createElement('div');
  overlay.id = 'confirmPopupOverlay';
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:999999999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);';

  overlay.innerHTML = `
    <div style="background:linear-gradient(135deg,#1e293b,#0f172a);border-radius:16px;padding:32px;width:90%;max-width:420px;box-shadow:0 20px 60px rgba(0,0,0,0.5);border:1px solid rgba(148,163,184,0.2);text-align:center;">
      <div style="font-size:56px;margin-bottom:20px;">‚ö†Ô∏è</div>
      <h3 style="color:#e2e8f0;font-size:1.5rem;font-weight:700;margin-bottom:16px;">Confirmation</h3>
      <p style="color:#94a3b8;font-size:1.1rem;margin-bottom:28px;line-height:1.6;">${message}</p>
      <div style="display:flex;gap:16px;justify-content:center;">
        <button id="confirmPopupNo" class="btn-secondary" style="min-width:120px;padding:12px 28px !important;">
          <span>Non</span>
        </button>
        <button id="confirmPopupYes" class="btn-primary" style="min-width:120px;padding:12px 28px !important;">
          <span>Oui</span>
        </button>
      </div>
    </div>
  `;

  targetDoc.body.appendChild(overlay);

  // Bouton Oui
  targetDoc.getElementById('confirmPopupYes').onclick = function() {
    overlay.remove();
    if (onConfirm) onConfirm();
  };

  // Bouton Non
  targetDoc.getElementById('confirmPopupNo').onclick = function() {
    overlay.remove();
    if (onCancel) onCancel();
  };
};

</script>



<!-- Overlay flou -->
<div id="pdfOverlay"></div>

<!-- Modal PDF avec Signature Overlay -->
<div id="pdfModal" class="hidden" tabindex="-1" aria-hidden="true">
  <div id="pdfContent" tabindex="-1">
    <div id="pdfControls" class="pdf-header" style="display: flex; justify-content: space-between; align-items: center;">
      <span class="pdf-header-title">Aper√ßu PDF</span>
      <div style="display: flex; align-items: center; gap: 10px;">
        <div id="zoomSliderContainer" style="display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-search-minus" style="color: #94a3b8; font-size: 11px;"></i>
          <input type="range" id="pdfZoomSlider" min="50" max="200" value="100"
            style="width: 100px; height: 4px; background: linear-gradient(to right, #3b82f6 0%, #3b82f6 33%, #475569 33%, #475569 100%); border-radius: 2px;"
          >
          <i class="fas fa-search-plus" style="color: #94a3b8; font-size: 11px;"></i>
          <span id="zoomPercentage" style="color: #94a3b8; font-size: 11px; min-width: 35px;">100%</span>
        </div>
        <button id="closePdfBtn" class="close-btn hidden" tabindex="-1">√ó</button>
      </div>
    </div>

    <div id="pdfScrollContainer" style="position: relative;" tabindex="-1">
      <div style="position: relative; display: inline-block;">
        <canvas id="pdfCanvas" tabindex="-1"></canvas>

        <!-- Zone signature cliquable - ouvre popup -->
        <div id="signatureOverlay" style="position: absolute; bottom: 123px; left: 117px; width: 150px; pointer-events: auto; cursor: pointer;" tabindex="-1">
          <div style="position: relative;">
            <div id="signaturePreview" style="width: 100%; height: 35px; border-radius: 2px; background: transparent; display: flex; align-items: center; justify-content: center; border: 1px dashed rgba(96, 165, 250, 0.3);" tabindex="-1">
              <div id="signatureHint" style="color: rgba(148, 163, 184, 0.5); font-size: 8px; font-style: italic; text-align: center;">
                ‚úçÔ∏è Cliquez pour signer
              </div>
              <canvas id="signaturePreviewCanvas" style="display: none; width: 100%; height: 100%;" tabindex="-1"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer avec boutons actions (cach√© sur mobile dans "Voir en PDF") -->
    <div id="pdfFooterActions" style="padding: 12px 16px; background: transparent; border-top: none; display: flex; gap: 10px; align-items: center; justify-content: flex-end;">
      <button type="button" id="acceptPresentationBtn" class="btn-primary" disabled style="background-color: rgba(148, 163, 184, 0.3) !important; color: rgba(203, 213, 225, 0.5) !important; pointer-events: none !important; box-shadow: none !important;">
        <i class="fas fa-check-circle"></i>
        <span>Accepter la soumission</span>
      </button>
    </div>
  </div>
</div>

<!-- Popup Signature Simple -->
<div id="signatureZoomPopup" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); z-index: 10000000; align-items: center; justify-content: center; backdrop-filter: blur(8px);">
  <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 16px; padding: 20px; width: 90%; max-width: 380px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 1px solid rgba(148, 163, 184, 0.2);">
    <div style="text-align: center; margin-bottom: 16px;">
      <div style="font-size: 16px; font-weight: 600; color: #e2e8f0; margin-bottom: 6px;">
        <i class="fas fa-pen" style="color: #60a5fa; margin-right: 8px;"></i>
        Signature du client
      </div>
      <div style="font-size: 11px; color: #94a3b8;">
        Veuillez signer dans la case ci-dessous
      </div>
    </div>

    <!-- Case de signature blanche simple - m√™me ratio que la case sur le PDF (150x35 = 4.3:1) -->
    <div id="signatureContainer" style="position: relative; background: white; border-radius: 8px; padding: 0; margin-bottom: 16px; border: 3px solid #e2e8f0; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); width: 100%; max-width: 320px; margin-left: auto; margin-right: auto;">
      <!-- Canvas de signature - ratio 4.3:1 maintenu, plus grand sur PC (415x97), plus petit sur mobile (320x75) -->
      <canvas id="presentationSignaturePad" style="width: 320px !important; height: 75px !important; display: block !important; border-radius: 6px; cursor: crosshair; touch-action: none;"></canvas>

      <!-- Hint "Signez ici" -->
      <div id="signatureZoomHint" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(150, 150, 150, 0.4); font-size: 13px; pointer-events: none; font-style: italic; text-align: center;">
        ‚úçÔ∏è Signez ici
      </div>

      <!-- Ligne de signature en bas -->
      <div style="position: absolute; bottom: 15px; left: 10%; right: 10%; border-bottom: 2px dashed rgba(0,0,0,0.1); pointer-events: none;"></div>
    </div>

    <!-- Boutons -->
    <div style="display: flex; gap: 8px; justify-content: space-between; flex-wrap: wrap;">
      <button type="button" class="btn-secondary" onclick="clearSignatureZoom()" style="padding: 8px 16px; font-size: 14px;">
        <i class="fas fa-eraser"></i>
        <span>Effacer</span>
      </button>
      <div style="display: flex; gap: 8px;">
        <button type="button" class="btn-secondary" onclick="closeSignatureZoomPopup()" style="padding: 8px 16px; font-size: 14px;">
          <i class="fas fa-times"></i>
          <span>Annuler</span>
        </button>
        <button type="button" id="validateSignatureBtn" class="btn-primary" onclick="validateSignature()" disabled style="background-color: rgba(148, 163, 184, 0.3) !important; color: rgba(203, 213, 225, 0.5) !important; pointer-events: none !important; padding: 8px 16px; font-size: 14px;">
          <i class="fas fa-check"></i>
          <span>Valider</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Variable globale pour tracker si une adresse Google a √©t√© s√©lectionn√©e
  window.googleProspectAddressSelected = false;

  // Fonction globale pour mettre √† jour l'option CNESST/WSIB selon la province
  window.updateCNESSTOption = function(province) {
    log('[CNESST/WSIB] üîß D√©but updateCNESSTOption avec province:', province);

    // Chercher l'option avec CNESST ou WSIB dans le data-value OU dans le span
    let option = null;
    const allOptions = document.querySelectorAll('.popup-option');

    log('[CNESST/WSIB] üìã Nombre total d\'options trouv√©es:', allOptions.length);

    for (let opt of allOptions) {
      const dataValue = opt.getAttribute('data-value') || '';
      const spanText = opt.querySelector('span')?.textContent || '';

      log('[CNESST/WSIB] üîç V√©rification option - data-value:', dataValue, '| span:', spanText);

      if (dataValue.includes('CNESST') || dataValue.includes('WSIB') ||
          spanText.includes('CNESST') || spanText.includes('WSIB')) {
        option = opt;
        log('[CNESST/WSIB] ‚úÖ Option trouv√©e!', {dataValue, spanText});
        break;
      }
    }

    if (!option) {
      warn('[CNESST/WSIB] ‚ùå Option introuvable - aucune option avec CNESST/WSIB d√©tect√©e');
      return;
    }

    const isOntario = province === 'ON' || province === 'Ontario';
    const frenchText = isOntario
      ? 'Assurance responsabilit√© civile 2M$ + WSIB'
      : 'Assurance responsabilit√© civile 2M$ + CNESST';
    const englishText = isOntario
      ? 'Liability insurance $2M + WSIB'
      : 'Liability insurance $2M + CNESST';

    log('[CNESST/WSIB] üìù Textes g√©n√©r√©s:', {isOntario, frenchText, englishText});

    // Mettre √† jour le dictionnaire de traduction (acc√®s global via window)
    if (window.translations) {
      log('[CNESST/WSIB] üìñ Mise √† jour du dictionnaire de traduction');
      // Supprimer toutes les anciennes entr√©es possibles
      delete window.translations['Assurance responsabilit√© civile 2M$ + CNESST'];
      delete window.translations['Assurance responsabilit√© civile 2M$ + WSIB'];
      delete window.translations['Liability insurance $2M + CNESST'];
      delete window.translations['Liability insurance $2M + WSIB'];
      // Ajouter la nouvelle entr√©e
      window.translations[frenchText] = englishText;
      log('[CNESST/WSIB] ‚úÖ Traduction ajout√©e:', frenchText, '‚Üí', englishText);
    } else {
      warn('[CNESST/WSIB] ‚ö†Ô∏è window.translations est ind√©fini');
    }

    // FORCER la langue selon la province - pas de m√©lange permis
    // Ontario = TOUJOURS Anglais, Quebec = TOUJOURS Fran√ßais
    const forcedLang = isOntario ? 'en' : 'fr';
    const forcedText = isOntario ? englishText : frenchText;
    log('[CNESST/WSIB] üåê Langue FORC√âE selon province:', forcedLang, '| Texte:', forcedText);

    // Mettre √† jour l'attribut data-value
    option.setAttribute('data-value', forcedText);
    log('[CNESST/WSIB] üîÑ data-value mis √† jour:', forcedText);

    // Mettre √† jour le texte affich√©
    const spanElement = option.querySelector('span');
    if (spanElement) {
      spanElement.textContent = forcedText;
      log('[CNESST/WSIB] üîÑ Texte span mis √† jour:', forcedText);
    } else {
      warn('[CNESST/WSIB] ‚ö†Ô∏è Span element non trouv√© dans l\'option');
    }

    log('[CNESST/WSIB] ‚úÖ Fin updateCNESSTOption - R√©sultat:', {
      province: province,
      isOntario: isOntario,
      forcedLang: forcedLang,
      finalText: spanElement?.textContent
    });
  };

  window.initProspectAutocomplete = function() {
    const input = document.getElementById('adresseAutocomplete');
    if (!input) return;

    // Si un autocomplete existe d√©j√†, le supprimer
    if (window.prospectAutocompleteInstance) {
      google.maps.event.clearInstanceListeners(input);
      log('[AUTOCOMPLETE] Instance pr√©c√©dente supprim√©e');
    }

    // Retirer les anciens event listeners JavaScript si ils existent
    if (window.adresseInputListener) {
      input.removeEventListener('input', window.adresseInputListener);
      log('[AUTOCOMPLETE] Ancien listener input retir√©');
    }
    if (window.adresseFocusListener) {
      input.removeEventListener('focus', window.adresseFocusListener);
      log('[AUTOCOMPLETE] Ancien listener focus retir√©');
    }

    // Forcer la d√©sactivation de l'autocomplete navigateur
    input.setAttribute('autocomplete', 'new-password');
    input.setAttribute('autocorrect', 'off');
    input.setAttribute('autocapitalize', 'off');
    input.setAttribute('spellcheck', 'false');

    // D√©terminer la province actuelle pour biaiser les r√©sultats Google
    const currentLang = localStorage.getItem('language') || 'fr';
    const isOntario = currentLang === 'en';

    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('[AUTOCOMPLETE INIT] üåê Langue dans localStorage:', currentLang);
    console.log('[AUTOCOMPLETE INIT] üó∫Ô∏è Est Ontario?', isOntario);
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

    // Cr√©er les bounds pour biaiser les r√©sultats selon la province
    let bounds = null;
    let strictBounds = true;  // Forcer les suggestions dans les bounds

    if (isOntario) {
      // Bounds pour tout l'Ontario (pas juste Toronto)
      bounds = new google.maps.LatLngBounds(
        new google.maps.LatLng(41.7, -95.2),  // Sud-Ouest de l'Ontario
        new google.maps.LatLng(56.9, -74.3)   // Nord-Est de l'Ontario
      );
      console.log('[AUTOCOMPLETE INIT] ‚úÖ BOUNDS ONTARIO cr√©√©s');
      console.log('[AUTOCOMPLETE INIT] SW:', '41.7, -95.2');
      console.log('[AUTOCOMPLETE INIT] NE:', '56.9, -74.3');
    } else {
      // Bounds pour tout le Qu√©bec
      bounds = new google.maps.LatLngBounds(
        new google.maps.LatLng(44.99, -79.76),  // Sud-Ouest du Qu√©bec
        new google.maps.LatLng(62.58, -57.10)   // Nord-Est du Qu√©bec
      );
      console.log('[AUTOCOMPLETE INIT] ‚úÖ BOUNDS QU√âBEC cr√©√©s');
      console.log('[AUTOCOMPLETE INIT] SW:', '44.99, -79.76');
      console.log('[AUTOCOMPLETE INIT] NE:', '62.58, -57.10');
    }

    console.log('[AUTOCOMPLETE INIT] strictBounds:', strictBounds);

    const autocomplete = new google.maps.places.Autocomplete(input, {
      types: ['address'],
      componentRestrictions: { country: 'ca' },
      bounds: bounds,
      strictBounds: strictBounds  // true = sugg√®re SEULEMENT dans les bounds
    });

    // Stocker l'instance globalement pour pouvoir la supprimer plus tard
    window.prospectAutocompleteInstance = autocomplete;

    // Cr√©er et stocker le listener input
    window.adresseInputListenerCallCount = 0;
    window.adresseInputListener = (e) => {
      window.adresseInputListenerCallCount++;
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log(`üîî [INPUT EVENT #${window.adresseInputListenerCallCount}] D√âCLENCH√â`);
      console.log('[INPUT EVENT] Adresse value:', input.value);
      console.log('[INPUT EVENT] Flag googleProspectAddressSelected:', window.googleProspectAddressSelected);
      console.log('[INPUT EVENT] Bordure AVANT traitement:', input.style.borderRightColor);

      // Si une adresse Google a √©t√© s√©lectionn√©e et le champ n'est pas vide, bordure verte
      if (window.googleProspectAddressSelected && input.value.trim().length > 0) {
        console.log('[INPUT EVENT] ‚úÖ Condition Google TRUE - mise bordure VERTE');
        input.style.setProperty('border-right-color', '#4caf50', 'important');
        console.log('[INPUT EVENT] Bordure APR√àS mise en vert:', input.style.borderRightColor);
      } else {
        console.log('[INPUT EVENT] ‚ùå Condition Google FALSE - validation regex');
        console.log('[INPUT EVENT]    - Flag:', window.googleProspectAddressSelected);
        console.log('[INPUT EVENT]    - Value length:', input.value.trim().length);
        // Sinon, valider avec le regex
        const regex = /^.+,\s*.+,\s*(QC|Quebec|Qu√©bec|ON|Ontario)\s+[A-Z]\d[A-Z]\s+\d[A-Z]\d\s*$/i;
        const isValid = regex.test(input.value.trim());
        console.log('[INPUT EVENT]    - Regex match:', isValid);
        input.style.setProperty('border-right-color', isValid ? '#4caf50' : '#e57373', 'important');
        console.log('[INPUT EVENT] Bordure mise en', isValid ? 'VERT (regex)' : 'ROUGE (regex)');
        console.log('[INPUT EVENT] Bordure APR√àS:', input.style.borderRightColor);
      }

      // Si l'utilisateur modifie l'adresse auto-remplie, reset le flag
      if (window.googleProspectAddressSelected && window.initialAutofilledAddress) {
        if (input.value !== window.initialAutofilledAddress) {
          window.googleProspectAddressSelected = false;
          log('[WARN] Adresse modifi√©e manuellement, validation Google requise');
        }
      }

      // R√©appliquer les attributs anti-autocomplete
      input.setAttribute('autocomplete', 'new-password');

      // Appeler la validation globale si disponible
      if (typeof validateRequiredFields === 'function') {
        validateRequiredFields();
      }

      console.log(`üîî [INPUT EVENT #${window.adresseInputListenerCallCount}] FIN - Bordure finale:`, input.style.borderRightColor);
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    };

    // Cr√©er et stocker le listener focus
    window.adresseFocusListener = () => {
      input.setAttribute('autocomplete', 'new-password');
      input.removeAttribute('readonly');
    };

    // Ajouter les listeners
    input.addEventListener('input', window.adresseInputListener);
    input.addEventListener('focus', window.adresseFocusListener);

    autocomplete.addListener('place_changed', () => {
      const place = autocomplete.getPlace();
      if (!place.geometry) {
        log("Adresse invalide");
        window.googleProspectAddressSelected = false;
        return;
      }

      // Marquer qu'une adresse Google a √©t√© s√©lectionn√©e
      window.googleProspectAddressSelected = true;
      console.log('üéØ [PLACE_CHANGED] FLAG SET √Ä TRUE');

      const components = place.address_components;
      let streetNumber = '';
      let route = '';
      let city = '';
      let province = '';
      let postalCode = '';

      components.forEach(component => {
        const types = component.types;

        if (types.includes('street_number')) {
          streetNumber = component.long_name;
        }
        if (types.includes('route')) {
          route = component.long_name;
        }
        if (types.includes('locality')) {
          city = component.long_name;
        }
        if (types.includes('administrative_area_level_1')) {
          province = component.short_name;
        }
        if (types.includes('postal_code')) {
          postalCode = component.long_name;
        }
      });

      const fullAddress = `${streetNumber} ${route}, ${city}, ${province} ${postalCode}`;
      console.log('üìù [PLACE_CHANGED] Avant set input.value:', fullAddress.trim());
      console.log('üìù [PLACE_CHANGED] Flag AVANT set value:', window.googleProspectAddressSelected);

      input.value = fullAddress.trim();
      console.log('üìù [PLACE_CHANGED] APR√àS set input.value - ceci va d√©clencher event INPUT');

      log('[GOOGLE AUTOCOMPLETE] Adresse s√©lectionn√©e:', fullAddress.trim());
      log('[GOOGLE AUTOCOMPLETE] Province d√©tect√©e (SANS changer CNESST/WSIB):', province);

      // L'adresse NE CHANGE PAS l'option CNESST/WSIB
      // Seuls les toggles de langue contr√¥lent l'assurance

      // Mettre la bordure en vert car adresse s√©lectionn√©e via Google (format valide)
      console.log('üü¢ [PLACE_CHANGED] Mise de la bordure en VERT');
      input.style.setProperty('border-right-color', '#4caf50', 'important');
      console.log('üü¢ [PLACE_CHANGED] Bordure mise - couleur actuelle:', input.style.borderRightColor);

      // D√©clencher la validation apr√®s que Google ait rempli l'adresse
      if (typeof validateRequiredFields === 'function') {
        // Utiliser setTimeout pour s'assurer que la valeur est bien d√©finie avant validation
        console.log('‚è∞ [PLACE_CHANGED] setTimeout pour validateRequiredFields dans 100ms');
        console.log('‚è∞ [PLACE_CHANGED] Bordure actuelle AVANT setTimeout:', input.style.borderRightColor);
        setTimeout(() => {
          console.log('‚è∞ [VALIDATE] setTimeout d√©clench√© - appel de validateRequiredFields');
          console.log('‚è∞ [VALIDATE] Bordure AVANT validateRequiredFields:', input.style.borderRightColor);
          console.log('‚è∞ [VALIDATE] Flag avant validation:', window.googleProspectAddressSelected);
          validateRequiredFields();
          if (typeof updateSoumissionClientValidation === 'function') updateSoumissionClientValidation();
          console.log('‚è∞ [VALIDATE] APR√àS validateRequiredFields - bordure:', input.style.borderRightColor);
        }, 100);
      }
    });
  };
</script>

<input type="hidden" id="produitCouleursHidden" name="produitCouleurs">
<input type="hidden" id="partTravauxHidden" name="partTravaux">
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZDi-RMHDdA4l-4sv_5H8GhsUAYXV4DVE&libraries=places&callback=initProspectAutocomplete&language=fr&region=CA"
  async
  defer
></script>

  <!-- Script pour gestion menu actif -->
  <script>
    // Fonction pour activer le menu bas√© sur la page actuelle
    function activateCurrentPageMenu() {
      const currentPath = window.location.pathname;
      log('üåê Page actuelle d√©tect√©e:', currentPath);
      
      // Enlever la classe menu-active de tous les liens
      const allMenuLinks = document.querySelectorAll('#sidebar a');
      allMenuLinks.forEach(link => {
        link.classList.remove('menu-active');
        link.removeAttribute('data-menu-state');
      });
      
      // Mapping des pages vers leurs data-path correspondants
      const pageMap = {
        '/dashboard': '/dashboard',
        '/centralevue': '/centralevue', 
        '/calcul': '/calcul',
        '/soumissions': '/soumissions',
        '/gqp': '/gqp',
        '/travaux': '/travaux',
        '/facture': '/facture',
        '/avis': '/avis',
        '/centrale': '/centrale',
        '/dashboardcoach': '/dashboardcoach'
      };
      
      const targetPath = pageMap[currentPath];
      let targetLink = null;
      
      if (targetPath) {
        targetLink = document.querySelector(`#sidebar a[data-path="${targetPath}"]`);
        log('[TARGET] Page d√©tect√©e - activation du menu pour:', targetPath);
      }
      
      if (targetLink) {
        targetLink.classList.add('menu-active');
        targetLink.setAttribute('data-menu-state', 'active');
        log('[OK] Menu activ√© pour:', targetLink.textContent.trim());
      } else {
        log('[WARN] Aucun menu trouv√© pour la page:', currentPath);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      activateCurrentPageMenu();
      setTimeout(activateCurrentPageMenu, 150);
      setTimeout(activateCurrentPageMenu, 300);

      // V√©rifier si on arrive depuis Ventes avec un ID de soumission √† modifier
      const editId = sessionStorage.getItem('editSoumissionId');
      if (editId) {
        sessionStorage.removeItem('editSoumissionId');
        // Attendre que tout soit initialis√© avant de charger la soumission
        setTimeout(() => {
          if (typeof editSentSoumission === 'function') {
            editSentSoumission(editId);
          }
        }, 500);
      }
    });
  </script>

  </div> <!-- Fermeture page-content -->
  </div> <!-- Fermeture ml-[15%] mr-[15%] -->

  <!-- Popup Modal pour Produit/Couleurs -->
  <div class="popup-modal" id="productModal">
    <div class="popup-content">
      <div class="popup-left">
        <div class="popup-header" style="position: sticky; top: 0; z-index: 999999; background: var(--bg-card); border-bottom: 1px solid var(--border-dark); padding-top: 15px;">
          <div class="popup-title">
            <i class="fas fa-palette text-purple-500"></i>
            Pr√©paration / Produit
          </div>
        </div>
        <div class="popup-options" id="productOptions" style="padding-top: 20px;">
          <!-- Cat√©gorie: Pr√©paration des surfaces -->
          <div class="popup-category" style="padding: 8px 16px; background: rgba(59, 130, 246, 0.1); color: var(--primary-blue); font-weight: 600; font-size: 12px; text-transform: uppercase; margin-bottom: 8px; border-radius: 6px;">Pr√©paration des surfaces</div>
          <div class="popup-option" data-value="Lavage doux avec savon TSP">
            <span>Lavage doux avec savon TSP</span>
          </div>
          <div class="popup-option" data-value="Lavage √† pression avec savon TSP">
            <span>Lavage √† pression avec savon TSP</span>
          </div>
          <div class="popup-option" data-value="Sablage l√©ger">
            <span>Sablage l√©ger</span>
          </div>
          <div class="popup-option" data-value="Sablage mod√©r√©">
            <span>Sablage mod√©r√©</span>
          </div>
          <div class="popup-option" data-value="Sablage au bois">
            <span>Sablage au bois</span>
          </div>
          <div class="popup-option" data-value="Sablage de surface">
            <span>Sablage de surface</span>
          </div>
          <div class="popup-option" data-value="Grattage aux endroits n√©cessaires">
            <span>Grattage aux endroits n√©cessaires</span>
          </div>
          <div class="popup-option" data-value="R√©parations mineures">
            <span>R√©parations mineures</span>
          </div>
          <div class="popup-option" data-value="Protection des surfaces">
            <span>Protection des surfaces</span>
          </div>
          <div class="popup-option" data-value="Grinder la rouille sur le fer forg√©">
            <span>Grinder la rouille sur le fer forg√©</span>
          </div>
          <div class="popup-option" data-value="Grinder les √©cailles sur le fer forg√©">
            <span>Grinder les √©cailles sur le fer forg√©</span>
          </div>
          <div class="popup-option" data-value="Application d'une couche de primer sur les endroits qui ont √©t√© grind√©s">
            <span>Application d'une couche de primer sur les endroits qui ont √©t√© grind√©s</span>
          </div>
          <div class="popup-option" data-value="Application de 2 couches de peinture Alkyde (√† l'huile) Industrielle">
            <span>Application de 2 couches de peinture Alkyde (√† l'huile) Industrielle</span>
          </div>

          <!-- Cat√©gorie: Appr√™ts -->
          <div class="popup-category" style="padding: 8px 16px; background: rgba(59, 130, 246, 0.1); color: var(--primary-blue); font-weight: 600; font-size: 12px; text-transform: uppercase; margin: 16px 0 8px 0; border-radius: 6px;">Appr√™ts</div>
          <div class="popup-option" data-value="Application de une couche d'appr√™t sur les murs de couleurs">
            <span>Application de une couche d'appr√™t sur les murs de couleurs</span>
          </div>
          <div class="popup-option" data-value="Application de une couche d'appr√™t au endroits rouill√©s">
            <span>Application de une couche d'appr√™t au endroits rouill√©s</span>
          </div>
          <div class="popup-option" data-value="Application d'appr√™t par endroits, l√† o√π n√©cessaire">
            <span>Application d'appr√™t par endroits, l√† o√π n√©cessaire</span>
          </div>

          <!-- Cat√©gorie: Peintures -->
          <div class="popup-category" style="padding: 8px 16px; background: rgba(59, 130, 246, 0.1); color: var(--primary-blue); font-weight: 600; font-size: 12px; text-transform: uppercase; margin: 16px 0 8px 0; border-radius: 6px;">Peintures</div>
          <div class="popup-option" data-value="Application de 2 couches de peinture">
            <span>Application de 2 couches de peinture</span>
          </div>
          <div class="popup-option" data-value="Application de 2 couches de peinture diamant ext√©rieure">
            <span>Application de 2 couches de peinture diamant ext√©rieure</span>
          </div>
          <div class="popup-option" data-value="Ajout d'une 3e couche de finition n√©cessaire">
            <span>Ajout d'une 3e couche de finition n√©cessaire</span>
          </div>
          <div class="popup-option" data-value="Ajout d'une 3e couche de finition pourrait √™tre n√©cessaire, il en sera de la discr√©tion du client, le montant n√©cessaire √† d√©bourser sera discut√© avec le client avant de d√©cider si oui ou non, un troisi√®me couche de finition sera faite.">
            <span>Ajout d'une 3e couche de finition pourrait √™tre n√©cessaire, il en sera de la discr√©tion du client, le montant n√©cessaire √† d√©bourser sera discut√© avec le client avant de d√©cider si oui ou non, un troisi√®me couche de finition sera faite.</span>
          </div>

          <!-- Cat√©gorie: Teintures -->
          <div class="popup-category" style="padding: 8px 16px; background: rgba(59, 130, 246, 0.1); color: var(--primary-blue); font-weight: 600; font-size: 12px; text-transform: uppercase; margin: 16px 0 8px 0; border-radius: 6px;">Teintures</div>
          <div class="popup-option" data-value="Application de 2 couches de teinture opaque">
            <span>Application de 2 couches de teinture opaque</span>
          </div>
          <div class="popup-option" data-value="Application de 2 couche de teinture semi-transparente">
            <span>Application de 2 couche de teinture semi-transparente</span>
          </div>
          <div class="popup-option" data-value="Application d'une seule couche de teinture (produit monocouche ou demande du client)">
            <span>Application d'une seule couche de teinture (produit monocouche ou demande du client)</span>
          </div>
          <div class="popup-option" data-value="Application de deux couches de teinture wet on wet">
            <span>Application de deux couches de teinture wet on wet</span>
          </div>

          <!-- Cat√©gorie: Finitions par surface -->
          <div class="popup-category" style="padding: 8px 16px; background: rgba(59, 130, 246, 0.1); color: var(--primary-blue); font-weight: 600; font-size: 12px; text-transform: uppercase; margin: 16px 0 8px 0; border-radius: 6px;">Finitions par surface</div>
          <div class="popup-option" data-value="Mur: coquille d'≈ìuf">
            <span>Mur: coquille d'≈ìuf</span>
          </div>
          <div class="popup-option" data-value="Plafond: mat">
            <span>Plafond: mat</span>
          </div>
          <div class="popup-option" data-value="Portes et moulures: perle">
            <span>Portes et moulures: perle</span>
          </div>
          <div class="popup-option" data-value="Portes: perle">
            <span>Portes: perle</span>
          </div>
          <div class="popup-option" data-value="moulures: perle">
            <span>Moulures: perle</span>
          </div>
        </div>
      </div>
      <div class="popup-right">
        <h3 style="color: var(--text-light); margin-bottom: 12px; font-weight: 600; display: flex; align-items: center; justify-content: space-between;">
          <span>Description par endroit</span>
          <div id="productModalCounter" style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444;">
            <i class="fas fa-exclamation-circle" style="font-size: 11px;"></i>
            <span id="productModalCounterText">0 restant(s)</span>
          </div>
        </h3>
        <div class="custom-select" id="productEndroitSelect" style="margin-bottom: 12px;">
          <button type="button" class="custom-select-button" onclick="toggleProductEndroitDropdown()">
            <span class="custom-select-text">S√©lectionner un endroit</span>
            <i class="fas fa-chevron-down custom-select-arrow"></i>
          </button>
          <div class="custom-select-dropdown" id="productEndroitDropdown">
            <!-- Options g√©n√©r√©es dynamiquement -->
          </div>
        </div>
        <textarea id="productEndroitTextarea" class="popup-textarea" placeholder="S√©lectionnez des options √† gauche ou √©crivez ici..." style="flex: 1; min-height: 200px;"></textarea>
        <div class="popup-buttons">
          <button class="btn-secondary px-6 py-2" onclick="closeProductModal()">Annuler</button>
          <button class="btn-primary px-6 py-2" onclick="confirmProductSelection()">Confirmer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup Modal pour Endroit √† peinturer -->
  <div class="popup-modal" id="endroitModal">
    <div class="popup-content">
      <div class="popup-left">
        <div class="popup-header" style="position: sticky; top: 0; z-index: 999999; background: var(--bg-card); border-bottom: 1px solid var(--border-dark); padding-top: 15px;">
          <div class="popup-title">
            <i class="fas fa-home text-green-500"></i>
            Endroit √† peinturer
          </div>
        </div>
        <div class="popup-options" id="endroitOptions" style="padding-top: 20px;">
          <!-- Cat√©gorie: Ext√©rieur -->
          <div class="popup-category" style="padding: 8px 16px; background: rgba(59, 130, 246, 0.1); color: var(--primary-blue); font-weight: 600; font-size: 12px; text-transform: uppercase; margin-bottom: 8px; border-radius: 6px;">Ext√©rieur</div>
          <div class="popup-option" data-value="Rev√™tement">
            <span>Rev√™tement</span>
          </div>
          <div class="popup-option" data-value="Porte et fen√™tre">
            <span>Porte et fen√™tre</span>
          </div>
          <div class="popup-option" data-value="Balcon">
            <span>Balcon</span>
          </div>
          <div class="popup-option" data-value="Corniche">
            <span>Corniche</span>
          </div>
          <div class="popup-option" data-value="Cl√¥ture">
            <span>Cl√¥ture</span>
          </div>

          <!-- Cat√©gorie: Int√©rieur -->
          <div class="popup-category" style="padding: 8px 16px; background: rgba(59, 130, 246, 0.1); color: var(--primary-blue); font-weight: 600; font-size: 12px; text-transform: uppercase; margin: 16px 0 8px 0; border-radius: 6px;">Int√©rieur</div>
          <div class="popup-option" data-value="Chambre 1">
            <span>Chambre 1</span>
          </div>
          <div class="popup-option" data-value="Chambre 2">
            <span>Chambre 2</span>
          </div>
          <div class="popup-option" data-value="Chambre 3">
            <span>Chambre 3</span>
          </div>
          <div class="popup-option" data-value="Chambre 4">
            <span>Chambre 4</span>
          </div>
          <div class="popup-option" data-value="Chambre 5">
            <span>Chambre 5</span>
          </div>
          <div class="popup-option" data-value="Chambre 6">
            <span>Chambre 6</span>
          </div>
          <div class="popup-option" data-value="Chambre 7">
            <span>Chambre 7</span>
          </div>
          <div class="popup-option" data-value="Chambre 8">
            <span>Chambre 8</span>
          </div>
          <div class="popup-option" data-value="Salon 1">
            <span>Salon 1</span>
          </div>
          <div class="popup-option" data-value="Salon 2">
            <span>Salon 2</span>
          </div>
          <div class="popup-option" data-value="Salon 3">
            <span>Salon 3</span>
          </div>
          <div class="popup-option" data-value="Cuisine 1">
            <span>Cuisine 1</span>
          </div>
          <div class="popup-option" data-value="Cuisine 2">
            <span>Cuisine 2</span>
          </div>
          <div class="popup-option" data-value="Cuisine 3">
            <span>Cuisine 3</span>
          </div>
          <div class="popup-option" data-value="Cuisine 4">
            <span>Cuisine 4</span>
          </div>
          <div class="popup-option" data-value="Salle de bain 1">
            <span>Salle de bain 1</span>
          </div>
          <div class="popup-option" data-value="Salle de bain 2">
            <span>Salle de bain 2</span>
          </div>
          <div class="popup-option" data-value="Salle de bain 3">
            <span>Salle de bain 3</span>
          </div>
          <div class="popup-option" data-value="Salle de bain 4">
            <span>Salle de bain 4</span>
          </div>
          <div class="popup-option" data-value="Couloir RDC">
            <span>Couloir RDC</span>
          </div>
          <div class="popup-option" data-value="Couloir 1er √©tage">
            <span>Couloir 1er √©tage</span>
          </div>
          <div class="popup-option" data-value="Couloir sous-sol">
            <span>Couloir sous-sol</span>
          </div>
          <div class="popup-option" data-value="Entr√©e">
            <span>Entr√©e</span>
          </div>
          <div class="popup-option" data-value="Cage d'escaliers">
            <span>Cage d'escaliers</span>
          </div>
          <div class="popup-option" data-value="Salle √† manger">
            <span>Salle √† manger</span>
          </div>
          <div class="popup-option" data-value="Aire commune">
            <span>Aire commune</span>
          </div>
          <div class="popup-option" data-value="Walk-in">
            <span>Walk-in</span>
          </div>
          <div class="popup-option" data-value="Bureau">
            <span>Bureau</span>
          </div>

          <!-- Cat√©gorie: Fer forg√© -->
          <div class="popup-category" style="padding: 8px 16px; background: rgba(59, 130, 246, 0.1); color: var(--primary-blue); font-weight: 600; font-size: 12px; text-transform: uppercase; margin: 16px 0 8px 0; border-radius: 6px;">Fer forg√©</div>
          <div class="popup-option" data-value="Fer forg√©">
            <span>Fer forg√©</span>
          </div>
        </div>
      </div>
      <div class="popup-right">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="color: var(--text-light); font-weight: 600; margin: 0;">Endroits s√©lectionn√©s</h3>
          <span id="endroitCounter" style="color: var(--text-gray); font-size: 13px; font-weight: 500;">0/10</span>
        </div>
        <div id="endroitMaxNotif" style="display: none; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; padding: 8px 12px; margin-bottom: 12px; color: #ef4444; font-size: 13px; text-align: center;">
          10 maximum
        </div>
        <div style="display: flex; gap: 6px; margin-bottom: 12px;">
          <input type="text" id="endroitCustomInput" placeholder="Ajouter un endroit" style="flex: 1; height: 40px !important; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border-dark); border-radius: 6px; padding: 6px 10px; color: var(--text-light); font-size: 13px;" onkeypress="if(event.key==='Enter'){addCustomEndroit(); event.preventDefault();}">
          <button type="button" class="btn-primary" onclick="addCustomEndroit()" style="width: 40px !important; height: 40px !important; display: flex !important; align-items: center !important; justify-content: center !important; padding: 0 !important; font-size: 14px;">
            <i class="fas fa-plus"></i>
          </button>
        </div>
        <div id="endroitSelectedList" style="flex: 1; overflow-y: auto; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border-dark); border-radius: 8px; padding: 12px; margin-bottom: 16px; min-height: 200px;">
          <div id="endroitChips" style="display: flex; flex-direction: column; gap: 8px;">
            <!-- Les endroits s√©lectionn√©s appara√Ætront ici -->
          </div>
          <div id="endroitEmpty" style="color: var(--text-gray); font-size: 14px; text-align: center; padding: 20px;">
            S√©lectionnez des endroits √† gauche
          </div>
        </div>
        <div class="popup-buttons">
          <button class="btn-secondary px-6 py-2" onclick="closeEndroitModal()">Annuler</button>
          <button class="btn-primary px-6 py-2" onclick="confirmEndroitSelection()">Confirmer</button>
        </div>
        <!-- Hidden textarea pour stocker les valeurs -->
        <textarea class="popup-textarea" id="endroitTextarea" style="display: none;"></textarea>
      </div>
    </div>
  </div>

  <!-- Popup Modal pour Particularit√© des travaux -->
  <div class="popup-modal" id="partTravauxModal">
    <div class="popup-content">
      <div class="popup-left">
        <div class="popup-header" style="position: sticky; top: 0; z-index: 999999; background: var(--bg-card); padding-top: 15px; display: block !important;">
          <div class="popup-title">
            <i class="fas fa-star text-yellow-500"></i>
            Particularit√© des travaux
          </div>

          <!-- Section Templates (dans le header sticky, en dessous du titre) -->
          <div style="padding: 12px 16px; background: rgba(59, 130, 246, 0.1); border-radius: 0; border-bottom: 1px solid rgba(59, 130, 246, 0.3); margin-top: 12px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-bookmark" style="color: var(--primary-blue);"></i>
              <span style="color: var(--text-light); font-weight: 600; font-size: 13px; flex-shrink: 0;">Templates</span>
              <div style="position: relative; flex: 1;">
                <div class="dropdown-toggle" id="templateToggle" style="width: 100%; cursor: pointer; height: 40px !important; min-height: 40px !important; display: flex !important; align-items: center !important; font-size: 13px !important;">
                  <span class="placeholder" style="color: rgb(156 163 175); font-size: 13px;">-- S√©lectionner --</span>
                </div>
                <div class="dropdown-menu hidden" id="templateMenu" style="width: 100%; max-height: 200px; overflow-y: auto;">
                  <!-- Les options seront ajout√©es dynamiquement -->
                </div>
              </div>
              <button class="btn-primary" style="padding: 6px 10px !important; font-size: 12px !important; height: 32px !important; min-height: 32px !important; display: flex !important; align-items: center !important; justify-content: center !important; gap: 5px !important;" onclick="saveTemplatePrompt()" title="Nouveau template">
                <i class="fas fa-plus" style="font-size: 11px !important;"></i>
                <span style="font-size: 12px !important;">Nouveau template</span>
              </button>
            </div>
          </div>
        </div>

        <div class="popup-options" id="partTravauxOptions" style="padding-top: 8px;">
          <!-- Cat√©gorie: Assurances et certifications -->
          <div class="popup-category" style="padding: 8px 16px; background: rgba(59, 130, 246, 0.1); color: var(--primary-blue); font-weight: 600; font-size: 12px; text-transform: uppercase; margin-bottom: 8px; border-radius: 6px;">Assurances et certifications</div>
          <div class="popup-option" data-value="Assurance responsabilit√© civile 2M$ + CNESST">
            <span>Assurance responsabilit√© civile 2M$ + CNESST</span>
          </div>

          <!-- Cat√©gorie: Services -->
          <div class="popup-category" style="padding: 8px 16px; background: rgba(59, 130, 246, 0.1); color: var(--primary-blue); font-weight: 600; font-size: 12px; text-transform: uppercase; margin: 16px 0 8px 0; border-radius: 6px;">Services</div>
          <div class="popup-option" data-value="Service cl√© en main (√©quipement, main d'≈ìuvre)">
            <span>Service cl√© en main (√©quipement, main d'≈ìuvre)</span>
          </div>
          <div class="popup-option" data-value="Service cl√© en main (√©quipement, peinture, main d'≈ìuvre)">
            <span>Service cl√© en main (√©quipement, peinture, main d'≈ìuvre)</span>
          </div>
          <div class="popup-option" data-value="Produits fournis par le client">
            <span>Produits fournis par le client</span>
          </div>

          <!-- Cat√©gorie: Garanties -->
          <div class="popup-category" style="padding: 8px 16px; background: rgba(59, 130, 246, 0.1); color: var(--primary-blue); font-weight: 600; font-size: 12px; text-transform: uppercase; margin: 16px 0 8px 0; border-radius: 6px;">Garanties</div>
          <div class="popup-option" data-value="Satisfaction garantie (25/75)">
            <span>Satisfaction garantie (25/75)</span>
          </div>
          <div class="popup-option" data-value="Garantie de 2 ans sur les travaux">
            <span>Garantie de 2 ans sur les travaux</span>
          </div>
        </div>
      </div>
      <div class="popup-right">
        <h3 style="color: var(--text-light); margin-bottom: 16px; font-weight: 600;">Zone de texte</h3>
        <textarea class="popup-textarea" id="partTravauxTextarea" placeholder="Ajoutez des particularit√©s personnalis√©es..."></textarea>
        <div class="popup-buttons">
          <button class="btn-secondary px-6 py-2" onclick="closePartTravauxModal()">Annuler</button>
          <button class="btn-primary px-6 py-2" onclick="confirmPartTravauxSelection()">Confirmer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup Modal pour Item (Table avec Endroits/Prix/Dur√©e) -->
  <div class="popup-modal" id="itemModal">
    <div class="popup-content" style="max-width: 900px; height: 500px; display: flex; flex-direction: column;">
      <!-- Header -->
      <div class="popup-header" style="padding: 20px 20px 16px 20px; flex-shrink: 0;">
        <div class="popup-title">
          <i class="fas fa-hammer text-orange-500"></i>
          Item
        </div>
      </div>

      <!-- Table des items - Header fixe + Body scrollable -->
      <div id="itemTableWrapper" style="flex: 1; margin: 0 20px; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border-dark); border-radius: 8px; display: flex; flex-direction: column; overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch;">
        <!-- Header fixe (non scrollable) -->
        <div style="flex-shrink: 0; background: #1e3a5f; min-width: 500px;">
          <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
            <colgroup>
              <col style="width: auto;">
              <col style="width: 160px;">
              <col style="width: 160px;">
            </colgroup>
            <thead>
              <tr>
                <th style="padding: 12px 16px; text-align: left; color: var(--text-light); font-weight: 600; border-bottom: 1px solid var(--border-dark);">Item</th>
                <th style="padding: 12px 16px; text-align: left; color: var(--text-light); font-weight: 600; border-bottom: 1px solid var(--border-dark);">Prix</th>
                <th style="padding: 12px 16px; text-align: left; color: var(--text-light); font-weight: 600; border-bottom: 1px solid var(--border-dark);">Dur√©e approx.</th>
              </tr>
            </thead>
          </table>
        </div>
        <!-- Body scrollable -->
        <div style="flex: 1; overflow: auto; -webkit-overflow-scrolling: touch; min-width: 500px;">
          <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
            <colgroup>
              <col style="width: auto;">
              <col style="width: 160px;">
              <col style="width: 160px;">
            </colgroup>
            <tbody id="itemTableBody">
              <!-- 4 lignes vides par d√©faut -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Boutons en bas √† droite -->
      <div style="padding: 16px 20px; display: flex; justify-content: flex-end; gap: 12px; flex-shrink: 0;">
        <button class="btn-secondary px-6 py-2" onclick="closeItemModal()">Annuler</button>
        <button class="btn-primary px-6 py-2" onclick="confirmItemSelection()">Confirmer</button>
      </div>
    </div>
  </div>

  <!-- Popup pour nom du template (Nouveau) -->
  <div id="templateNameModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999999; justify-content: center; align-items: center;">
    <div style="background: var(--bg-card); border-radius: 12px; padding: 24px; width: 400px; max-width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
      <h3 style="color: var(--text-light); margin-bottom: 16px; font-size: 18px; font-weight: 600;">
        <i class="fas fa-bookmark" style="color: var(--primary-blue); margin-right: 8px;"></i>
        Nouveau template
      </h3>
      <input type="text" id="templateNameInput" placeholder="Nom du template..." class="modern-input" style="width: 100%; margin-bottom: 16px;" autocomplete="off">
      <div style="display: flex; gap: 8px; justify-content: flex-end;">
        <button class="btn-secondary px-4 py-2" onclick="closeTemplateNameModal()">Annuler</button>
        <button class="btn-primary px-4 py-2" onclick="confirmSaveTemplate()">
          <i class="fas fa-save" style="margin-right: 6px;"></i>
          Sauvegarder
        </button>
      </div>
    </div>
  </div>

  <!-- Popup pour modifier un template -->
  <div id="templateEditModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999999; justify-content: center; align-items: center;">
    <div style="background: var(--bg-card); border-radius: 12px; padding: 24px; width: 400px; max-width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
      <h3 style="color: var(--text-light); margin-bottom: 16px; font-size: 18px; font-weight: 600;">
        <i class="fas fa-pencil-alt" style="color: var(--primary-blue); margin-right: 8px;"></i>
        Modifier le template
      </h3>
      <input type="text" id="templateEditInput" placeholder="Nouveau nom..." class="modern-input" style="width: 100%; margin-bottom: 16px;" autocomplete="off">
      <div style="display: flex; gap: 8px; justify-content: flex-end;">
        <button class="btn-secondary px-4 py-2" onclick="closeTemplateEditModal()">Annuler</button>
        <button class="btn-primary px-4 py-2" onclick="confirmEditTemplate()">
          <i class="fas fa-check" style="margin-right: 6px;"></i>
          Modifier
        </button>
      </div>
    </div>
  </div>

  <!-- Popup pour supprimer un template -->
  <div id="templateDeleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999999; justify-content: center; align-items: center;">
    <div style="background: var(--bg-card); border-radius: 12px; padding: 24px; width: 400px; max-width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
      <h3 style="color: var(--text-light); margin-bottom: 16px; font-size: 18px; font-weight: 600;">
        <i class="fas fa-trash" style="color: #ef4444; margin-right: 8px;"></i>
        Supprimer le template
      </h3>
      <p id="templateDeleteMessage" style="color: var(--text-muted); margin-bottom: 16px;"></p>
      <div style="display: flex; gap: 8px; justify-content: flex-end;">
        <button class="btn-secondary px-4 py-2" onclick="closeTemplateDeleteModal()">Annuler</button>
        <button class="btn-secondary px-4 py-2" onclick="confirmDeleteTemplate()">
          <i class="fas fa-trash" style="margin-right: 6px;"></i>
          Supprimer
        </button>
      </div>
    </div>
  </div>

  <script>
    // Variables pour stocker les s√©lections
    let productSelections = [];
    let partTravauxSelections = [];
    let endroitSelections = [];
    let userTemplates = []; // Templates sauvegard√©s de l'utilisateur
    let currentEditIndex = null; // Pour stocker l'index du template en cours de modification
    let currentDeleteIndex = null; // Pour stocker l'index du template en cours de suppression

    // ===== GESTION DES TEMPLATES =====

    // Charger les templates de l'utilisateur depuis le backend
    async function loadUserTemplates() {
      const username = localStorage.getItem('username');

      if (!username) {
        // Pas de username, initialiser avec liste vide
        userTemplates = [];
        updateTemplateSelect();
        return;
      }

      try {
        const response = await fetch(`/api/templates/part-travaux/${username}`);
        if (response.ok) {
          userTemplates = await response.json();
          updateTemplateSelect();
        }
      } catch (err) {
        console.error('Erreur chargement templates:', err);
        userTemplates = [];
        updateTemplateSelect();
      }
    }

    // Variable pour stocker le template s√©lectionn√©
    let selectedTemplateIndex = null;

    // Mettre √† jour le dropdown de s√©lection
    function updateTemplateSelect() {
      // Chercher le templateMenu dans l'iframe d'abord, sinon dans le parent (si modal d√©plac√©)
      let menu = document.getElementById('templateMenu');

      // Si null, chercher dans le parent (cas mobile o√π modal d√©plac√© vers apppc.html)
      if (!menu && window.parent && window.parent.document) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
        if (rootWindow && rootWindow.document) {
          menu = rootWindow.document.getElementById('templateMenu');
        }
      }

      if (!menu) {
        console.warn('[TEMPLATES] templateMenu introuvable');
        return;
      }

      menu.innerHTML = '';

      if (userTemplates.length === 0) {
        // Si aucun template, afficher un message
        const emptyOption = document.createElement('div');
        emptyOption.className = 'dropdown-option';
        emptyOption.style.color = 'rgb(156 163 175)';
        emptyOption.style.fontStyle = 'italic';
        emptyOption.style.cursor = 'default';
        emptyOption.textContent = 'Pas de template enregistr√©';
        menu.appendChild(emptyOption);
      } else {
        userTemplates.forEach((template, index) => {
          const option = document.createElement('div');
          option.className = 'dropdown-option';
          option.style.display = 'flex';
          option.style.alignItems = 'center';
          option.style.justifyContent = 'space-between';
          option.style.gap = '8px';
          option.style.height = '40px';
          option.style.minHeight = '40px';

          const nameSpan = document.createElement('span');
          nameSpan.textContent = template.name;
          nameSpan.style.flex = '1';
          nameSpan.onclick = function(e) {
            e.stopPropagation();
            selectTemplate(index, template.name);
          };

          const actionsDiv = document.createElement('div');
          actionsDiv.style.display = 'flex';
          actionsDiv.style.gap = '4px';
          actionsDiv.style.alignItems = 'center';

          // Bouton modifier
          const editBtn = document.createElement('button');
          editBtn.innerHTML = '<i class="fas fa-pencil-alt" style="font-size: 10px !important;"></i>';
          editBtn.className = 'btn-primary';
          editBtn.style.cssText = 'padding: 3px 6px !important; font-size: 10px !important; height: 24px !important; min-height: 24px !important;';
          editBtn.title = 'Modifier';
          editBtn.onclick = function(e) {
            e.stopPropagation();
            editTemplate(index);
          };

          // Bouton supprimer
          const deleteBtn = document.createElement('button');
          deleteBtn.innerHTML = '<i class="fas fa-trash" style="font-size: 10px !important;"></i>';
          deleteBtn.className = 'btn-secondary';
          deleteBtn.style.cssText = 'padding: 3px 6px !important; font-size: 10px !important; height: 24px !important; min-height: 24px !important;';
          deleteBtn.title = 'Supprimer';
          deleteBtn.onclick = function(e) {
            e.stopPropagation();
            deleteTemplate(index);
          };

          actionsDiv.appendChild(editBtn);
          actionsDiv.appendChild(deleteBtn);

          option.appendChild(nameSpan);
          option.appendChild(actionsDiv);
          menu.appendChild(option);
        });
      }

      // Reset le toggle - chercher dans le m√™me document que menu
      let toggle = document.getElementById('templateToggle');
      if (!toggle && window.parent && window.parent.document) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
        if (rootWindow && rootWindow.document) {
          toggle = rootWindow.document.getElementById('templateToggle');
        }
      }

      if (toggle) {
        toggle.innerHTML = '<span class="placeholder" style="color: rgb(156 163 175); font-size: 13px;">-- S√©lectionner --</span>';
        toggle.classList.remove('has-selection');
      }
      selectedTemplateIndex = null;
    }

    // S√©lectionner et charger un template
    function selectTemplate(index, name) {
      // Chercher le modal o√π qu'il soit
      let partTravauxModal = document.getElementById('partTravauxModal');
      if (!partTravauxModal && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
        if (rootWindow && rootWindow.document) {
          partTravauxModal = rootWindow.document.getElementById('partTravauxModal');
        }
      }

      if (!partTravauxModal) {
        console.warn('[SELECT TEMPLATE] Modal introuvable');
        return;
      }

      // Chercher les √©l√©ments dans le modal
      const toggle = partTravauxModal.querySelector('#templateToggle');
      const menu = partTravauxModal.querySelector('#templateMenu');
      const textarea = partTravauxModal.querySelector('#partTravauxTextarea');

      // Mettre √† jour l'affichage du dropdown
      if (toggle) {
        toggle.innerHTML = `<span class="tag" style="padding: 0px 8px;">${name}</span>`;
        toggle.classList.add('has-selection');
      }
      if (menu) {
        menu.classList.add('hidden');
      }

      // Sauvegarder l'index s√©lectionn√©
      selectedTemplateIndex = index;

      // Charger le contenu du template
      const template = userTemplates[index];
      if (template && textarea) {
        textarea.value = template.content;
        // Synchroniser les checkboxes
        syncPartTravauxCheckboxes();
      }
    }

    // Toggle du dropdown - initialiser apr√®s que le DOM soit charg√©
    function initTemplateDropdown() {
      const toggle = document.getElementById('templateToggle');
      const menu = document.getElementById('templateMenu');

      if (!toggle || !menu) return;

      // Click sur le toggle pour ouvrir/fermer
      toggle.addEventListener('click', function(e) {
        e.stopPropagation();
        menu.classList.toggle('hidden');
      });

      // Click ailleurs pour fermer
      document.addEventListener('click', function(e) {
        if (!toggle.contains(e.target) && !menu.contains(e.target)) {
          menu.classList.add('hidden');
        }
      });
    }

    // Initialiser le dropdown quand le DOM est pr√™t
    setTimeout(initTemplateDropdown, 100);

    // Ouvrir le popup pour demander le nom du template
    function saveTemplatePrompt() {
      // Chercher le textarea o√π qu'il soit (iframe ou parent sur mobile)
      let textarea = document.getElementById('partTravauxTextarea');
      const isMobile = window.innerWidth <= 1200;

      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        // Si pas trouv√© dans iframe, chercher dans parent
        if (!textarea && rootWindow && rootWindow.document) {
          textarea = rootWindow.document.getElementById('partTravauxTextarea');
        }
      }

      if (!textarea) {
        console.error('[TEMPLATE] partTravauxTextarea introuvable');
        return;
      }

      const content = textarea.value.trim();

      if (!content) {
        return;
      }

      // Chercher le modal o√π qu'il soit (iframe ou parent)
      let modal = document.getElementById('templateNameModal');

      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        // Si pas trouv√© dans iframe, chercher dans parent
        if (!modal && rootWindow && rootWindow.document) {
          modal = rootWindow.document.getElementById('templateNameModal');
        }
      }

      if (!modal) {
        console.error('[TEMPLATE] templateNameModal introuvable');
        return;
      }

      // Chercher l'input dans le modal
      const input = modal.querySelector('#templateNameInput');
      if (!input) {
        console.error('[TEMPLATE] templateNameInput introuvable');
        return;
      }

      modal.style.display = 'flex';
      input.value = '';
      input.focus();
    }

    // Fermer le popup de nom
    function closeTemplateNameModal() {
      // Chercher le modal o√π qu'il soit (iframe ou parent)
      let modal = document.getElementById('templateNameModal');
      const isMobile = window.innerWidth <= 1200;

      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        // Si pas trouv√© dans iframe, chercher dans parent
        if (!modal && rootWindow && rootWindow.document) {
          modal = rootWindow.document.getElementById('templateNameModal');
        }
      }

      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Confirmer et sauvegarder le template
    async function confirmSaveTemplate() {
      // Chercher le modal o√π qu'il soit (iframe ou parent)
      let modal = document.getElementById('templateNameModal');
      const isMobile = window.innerWidth <= 1200;

      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        // Si pas trouv√© dans iframe, chercher dans parent
        if (!modal && rootWindow && rootWindow.document) {
          modal = rootWindow.document.getElementById('templateNameModal');
        }
      }

      // Chercher l'input dans le modal
      const input = modal ? modal.querySelector('#templateNameInput') : document.getElementById('templateNameInput');
      const name = input ? input.value.trim() : '';

      if (!name) {
        return;
      }

      // Chercher le textarea o√π qu'il soit (iframe ou parent sur mobile)
      let textarea = document.getElementById('partTravauxTextarea');

      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        // Si pas trouv√© dans iframe, chercher dans parent
        if (!textarea && rootWindow && rootWindow.document) {
          textarea = rootWindow.document.getElementById('partTravauxTextarea');
        }
      }

      if (!textarea) {
        console.error('[TEMPLATE] partTravauxTextarea introuvable');
        return;
      }

      const content = textarea.value.trim();
      const username = localStorage.getItem('username');

      if (!username) {
        return;
      }

      try {
        const response = await fetch('/api/templates/part-travaux', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: username,
            name: name,
            content: content
          })
        });

        if (response.ok) {
          closeTemplateNameModal();
          await loadUserTemplates();
          // S√©lectionner automatiquement le template cr√©√©
          const newIndex = userTemplates.findIndex(t => t.name === name);
          if (newIndex !== -1) {
            selectTemplate(newIndex, name);
          }
        }
      } catch (error) {
        error('Erreur sauvegarde template:', error);
      }
    }

    // Support de la touche Enter dans les modals
    document.addEventListener('DOMContentLoaded', function() {
      const nameInput = document.getElementById('templateNameInput');
      if (nameInput) {
        nameInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            confirmSaveTemplate();
          }
        });
      }

      const editInput = document.getElementById('templateEditInput');
      if (editInput) {
        editInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            confirmEditTemplate();
          }
        });
      }
    });

    // Ouvrir popup pour supprimer un template
    function deleteTemplate(index) {
      currentDeleteIndex = index;
      const template = userTemplates[index];

      // Chercher le modal o√π qu'il soit (iframe ou parent)
      let modal = document.getElementById('templateDeleteModal');
      const isMobile = window.innerWidth <= 1200;

      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        // Si pas trouv√© dans iframe, chercher dans parent
        if (!modal && rootWindow && rootWindow.document) {
          modal = rootWindow.document.getElementById('templateDeleteModal');
        }
      }

      if (!modal) {
        console.error('[TEMPLATE] templateDeleteModal introuvable');
        return;
      }

      // Chercher le message dans le modal
      const messageEl = modal.querySelector('#templateDeleteMessage');
      if (messageEl) {
        messageEl.textContent = `Voulez-vous vraiment supprimer le template "${template.name}" ?`;
      }

      modal.style.display = 'flex';
    }

    // Fermer popup de suppression
    function closeTemplateDeleteModal() {
      // Chercher le modal o√π qu'il soit (iframe ou parent)
      let modal = document.getElementById('templateDeleteModal');
      const isMobile = window.innerWidth <= 1200;

      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        // Si pas trouv√© dans iframe, chercher dans parent
        if (!modal && rootWindow && rootWindow.document) {
          modal = rootWindow.document.getElementById('templateDeleteModal');
        }
      }

      if (modal) {
        modal.style.display = 'none';
      }
      currentDeleteIndex = null;
    }

    // Confirmer la suppression
    async function confirmDeleteTemplate() {
      if (currentDeleteIndex === null) return;

      const template = userTemplates[currentDeleteIndex];
      const username = localStorage.getItem('username');

      try {
        const response = await fetch(`/api/templates/part-travaux/${username}/${encodeURIComponent(template.name)}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          closeTemplateDeleteModal();
          await loadUserTemplates();
        }
      } catch (error) {
        error('Erreur suppression template:', error);
      }
    }

    // Ouvrir popup pour modifier un template
    function editTemplate(index) {
      currentEditIndex = index;
      const template = userTemplates[index];

      // Chercher le modal o√π qu'il soit (iframe ou parent)
      let modal = document.getElementById('templateEditModal');
      const isMobile = window.innerWidth <= 1200;

      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        // Si pas trouv√© dans iframe, chercher dans parent
        if (!modal && rootWindow && rootWindow.document) {
          modal = rootWindow.document.getElementById('templateEditModal');
        }
      }

      if (!modal) {
        console.error('[TEMPLATE] templateEditModal introuvable');
        return;
      }

      // Chercher l'input dans le modal
      const input = modal.querySelector('#templateEditInput');
      if (input) {
        input.value = template.name;
      }

      modal.style.display = 'flex';

      // Focus sur l'input
      if (input) {
        setTimeout(() => input.focus(), 100);
      }
    }

    // Fermer popup de modification
    function closeTemplateEditModal() {
      // Chercher le modal o√π qu'il soit (iframe ou parent)
      let modal = document.getElementById('templateEditModal');
      const isMobile = window.innerWidth <= 1200;

      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        // Si pas trouv√© dans iframe, chercher dans parent
        if (!modal && rootWindow && rootWindow.document) {
          modal = rootWindow.document.getElementById('templateEditModal');
        }
      }

      if (modal) {
        modal.style.display = 'none';
      }
      currentEditIndex = null;
    }

    // Confirmer la modification
    async function confirmEditTemplate() {
      if (currentEditIndex === null) return;

      // Chercher le modal o√π qu'il soit (iframe ou parent)
      let modal = document.getElementById('templateEditModal');
      const isMobile = window.innerWidth <= 1200;

      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        // Si pas trouv√© dans iframe, chercher dans parent
        if (!modal && rootWindow && rootWindow.document) {
          modal = rootWindow.document.getElementById('templateEditModal');
        }
      }

      // Chercher l'input dans le modal
      const input = modal ? modal.querySelector('#templateEditInput') : document.getElementById('templateEditInput');
      const newName = input ? input.value.trim() : '';
      const template = userTemplates[currentEditIndex];

      if (!newName) {
        return;
      }

      if (newName === template.name) {
        closeTemplateEditModal();
        return;
      }

      const username = localStorage.getItem('username');

      try {
        // Supprimer l'ancien
        await fetch(`/api/templates/part-travaux/${username}/${encodeURIComponent(template.name)}`, {
          method: 'DELETE'
        });

        // Cr√©er le nouveau avec le nouveau nom
        const response = await fetch('/api/templates/part-travaux', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: username,
            name: newName,
            content: template.content
          })
        });

        if (response.ok) {
          closeTemplateEditModal();
          await loadUserTemplates();
          // S√©lectionner automatiquement le template renomm√©
          const newIndex = userTemplates.findIndex(t => t.name === newName);
          if (newIndex !== -1) {
            selectTemplate(newIndex, newName);
          }
        }
      } catch (error) {
        error('Erreur modification template:', error);
      }
    }

    // Ouvrir popup Produit/Couleurs
    function openProductModal() {
      // V√©rifier si des endroits sont s√©lectionn√©s
      const endroitHidden = document.getElementById('endroitHidden');
      const endroitsValue = endroitHidden ? endroitHidden.value.trim() : '';

      if (!endroitsValue) {
        // Afficher notification que l'utilisateur doit d'abord s√©lectionner des endroits
        showNoEndroitNotif();
        return;
      }

      const productModal = document.getElementById('productModal');

      // Sur MOBILE uniquement: d√©placer modal vers parent pour passer au-dessus des headers
      const isMobile = window.innerWidth <= 1200;
      if (isMobile && window.parent) {
        // D√©tecter si iframe imbriqu√©e (mobile: 2 niveaux) ou directe (desktop: 1 niveau)
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        console.log('[MODAL PRODUITS] Niveaux iframe:', isNestedIframe ? '2 (mobile)' : '1 (desktop)');

        if (rootWindow && rootWindow.document) {
          const parentBody = rootWindow.document.body;
          const parentDoc = rootWindow.document;

          // Injecter les styles n√©cessaires dans le parent si pas d√©j√† fait
          if (!parentDoc.getElementById('soumission-modal-styles')) {
            const styleLink = parentDoc.createElement('link');
            styleLink.id = 'soumission-modal-styles';
            styleLink.rel = 'stylesheet';
            styleLink.href = '/frontend/Entrepreneurs/Outils/Soumission/soumission.css';
            parentDoc.head.appendChild(styleLink);

            const baseLink = parentDoc.createElement('link');
            baseLink.id = 'base-css-for-modal';
            baseLink.rel = 'stylesheet';
            baseLink.href = '/base.css';
            parentDoc.head.appendChild(baseLink);
          }

          // D√©placer vers le body parent si pas d√©j√† fait
          if (productModal && productModal.parentElement !== parentBody) {
            parentBody.appendChild(productModal);
            console.log('[MODAL PRODUITS] D√©plac√© vers document racine (apppc.html)');
          }

          // Bloquer le scroll du parent
          parentBody.style.overflow = "hidden";
        }
      }

      productModal.classList.add('active');
      document.body.style.overflow = 'hidden'; // D√©sactiver le scroll de la page

      // R√©cup√©rer les endroits s√©lectionn√©s
      const endroitsList = endroitsValue.split('\n').map(e => e.trim()).filter(e => e);

      // R√©cup√©rer le contenu sauvegard√© et le parser par endroit
      const savedContent = document.getElementById('produitCouleursHidden').value;
      productEndroitsData = parseProductsByEndroit(savedContent);

      // Initialiser les endroits sans donn√©es sauvegard√©es
      endroitsList.forEach(endroit => {
        if (!(endroit in productEndroitsData)) {
          productEndroitsData[endroit] = '';
        }
      });

      // Peupler le custom dropdown
      const dropdown = productModal.querySelector('#productEndroitDropdown');
      const selectText = productModal.querySelector('#productEndroitSelect .custom-select-text');
      if (dropdown) {
        dropdown.innerHTML = '';
        endroitsList.forEach((endroit, index) => {
          const option = document.createElement('div');
          option.className = 'custom-select-option';
          option.dataset.value = endroit;
          const hasContent = productEndroitsData[endroit] && productEndroitsData[endroit].trim();
          option.innerHTML = endroit;
          option.style.background = hasContent
            ? 'rgba(34, 197, 94, 0.2)'
            : 'rgba(239, 68, 68, 0.2)';
          option.style.borderLeft = hasContent
            ? '3px solid #22c55e'
            : '3px solid #ef4444';
          option.onclick = function() { selectProductEndroitOption(endroit); };
          dropdown.appendChild(option);
        });

        // S√©lectionner le premier endroit par d√©faut
        if (endroitsList.length > 0) {
          currentSelectedProductEndroit = endroitsList[0];
          if (selectText) {
            const hasContent = productEndroitsData[endroitsList[0]] && productEndroitsData[endroitsList[0]].trim();
            selectText.innerHTML = endroitsList[0];
            selectText.parentElement.style.background = hasContent
              ? 'rgba(34, 197, 94, 0.15)'
              : 'rgba(239, 68, 68, 0.15)';
            selectText.parentElement.style.borderLeft = hasContent
              ? '3px solid #22c55e'
              : '3px solid #ef4444';
          }
          const textarea = productModal.querySelector('#productEndroitTextarea');
          if (textarea) {
            textarea.value = productEndroitsData[endroitsList[0]] || '';

            // Synchroniser les checkboxes avec le contenu du textarea
            const currentLines = textarea.value.split('\n')
              .map(line => line.replace(/^-\s*/, '').trim())
              .filter(line => line);

            productModal.querySelectorAll('#productOptions .popup-option').forEach(option => {
              const value = option.getAttribute('data-value');
              if (currentLines.includes(value)) {
                option.classList.add('selected');
              } else {
                option.classList.remove('selected');
              }
            });
          }
        }

        // Mettre √† jour le compteur dans le modal
        const modalCounter = productModal.querySelector('#productModalCounter');
        if (modalCounter) {
          let completedCount = 0;
          endroitsList.forEach(endroit => {
            if (productEndroitsData[endroit] && productEndroitsData[endroit].trim()) {
              completedCount++;
            }
          });
          updateProductModalBadge(modalCounter, completedCount, endroitsList.length);
        }
      }
    }

    // Donn√©es stock√©es pour chaque endroit
    let productEndroitsData = {};

    // Variable pour tracker l'endroit actuellement s√©lectionn√©
    let currentSelectedProductEndroit = null;

    // Fonction pour mettre √† jour le badge de notification dans le modal Produit
    function updateProductModalBadge(badgeElement, completedCount, totalCount) {
      const remaining = totalCount - completedCount;
      const isComplete = totalCount > 0 && completedCount === totalCount;
      const isEnglish = window.currentLanguage === 'en';

      if (isComplete) {
        // Tout est compl√©t√© - badge vert avec coche
        badgeElement.style.background = 'rgba(34, 197, 94, 0.15)';
        badgeElement.style.border = '1px solid rgba(34, 197, 94, 0.4)';
        badgeElement.style.color = '#22c55e';
        badgeElement.innerHTML = `
          <i class="fas fa-check-circle" style="font-size: 11px;"></i>
          <span>${isEnglish ? 'Complete' : 'Compl√©t√©'}</span>
        `;
      } else {
        // Encore des endroits √† compl√©ter - badge rouge
        badgeElement.style.background = 'rgba(239, 68, 68, 0.15)';
        badgeElement.style.border = '1px solid rgba(239, 68, 68, 0.4)';
        badgeElement.style.color = '#ef4444';
        const remainingText = isEnglish
          ? `${remaining} remaining`
          : `${remaining} restant${remaining > 1 ? 's' : ''}`;
        badgeElement.innerHTML = `
          <i class="fas fa-exclamation-circle" style="font-size: 11px;"></i>
          <span>${remainingText}</span>
        `;
      }
    }

    // Toggle le dropdown custom
    function toggleProductEndroitDropdown() {
      let productModal = document.getElementById('productModal');
      if (!productModal && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
        if (rootWindow && rootWindow.document) {
          productModal = rootWindow.document.getElementById('productModal');
        }
      }
      if (!productModal) return;

      const customSelect = productModal.querySelector('#productEndroitSelect');
      if (customSelect) {
        customSelect.classList.toggle('open');
      }
    }

    // S√©lectionner une option dans le dropdown custom
    function selectProductEndroitOption(endroit) {
      let productModal = document.getElementById('productModal');
      if (!productModal && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
        if (rootWindow && rootWindow.document) {
          productModal = rootWindow.document.getElementById('productModal');
        }
      }
      if (!productModal) return;

      const textarea = productModal.querySelector('#productEndroitTextarea');
      const selectText = productModal.querySelector('#productEndroitSelect .custom-select-text');
      const customSelect = productModal.querySelector('#productEndroitSelect');

      // Sauvegarder le contenu de l'endroit actuel avant de changer
      if (currentSelectedProductEndroit && textarea) {
        productEndroitsData[currentSelectedProductEndroit] = textarea.value;
      }

      // Charger le contenu du nouvel endroit
      currentSelectedProductEndroit = endroit;
      if (textarea) {
        textarea.value = productEndroitsData[endroit] || '';

        // Synchroniser les checkboxes avec le contenu du textarea
        const currentLines = textarea.value.split('\n')
          .map(line => line.replace(/^-\s*/, '').trim())
          .filter(line => line);

        productModal.querySelectorAll('#productOptions .popup-option').forEach(option => {
          const value = option.getAttribute('data-value');
          if (currentLines.includes(value)) {
            option.classList.add('selected');
          } else {
            option.classList.remove('selected');
          }
        });
      }

      // Mettre √† jour le texte du bouton
      if (selectText) {
        const hasContent = productEndroitsData[endroit] && productEndroitsData[endroit].trim();
        selectText.innerHTML = endroit;
        selectText.parentElement.style.background = hasContent
          ? 'rgba(34, 197, 94, 0.15)'
          : 'rgba(239, 68, 68, 0.15)';
        selectText.parentElement.style.borderLeft = hasContent
          ? '3px solid #22c55e'
          : '3px solid #ef4444';
      }

      // Fermer le dropdown
      if (customSelect) {
        customSelect.classList.remove('open');
      }

      // Mettre √† jour les indicateurs
      updateProductDropdownIndicators(productModal);
      updateModalCounter();
    }

    // Changer d'endroit dans le dropdown (legacy)
    function switchProductEndroit(newEndroit) {
      selectProductEndroitOption(newEndroit);
    }

    // Mettre √† jour les indicateurs verts dans le dropdown custom
    function updateProductDropdownIndicators(modal) {
      if (!modal) {
        modal = document.getElementById('productModal');
        if (!modal && window.parent) {
          const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
          const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
          if (rootWindow && rootWindow.document) {
            modal = rootWindow.document.getElementById('productModal');
          }
        }
      }
      if (!modal) return;

      const dropdown = modal.querySelector('#productEndroitDropdown');
      const selectText = modal.querySelector('#productEndroitSelect .custom-select-text');
      if (!dropdown) return;

      // Mettre √† jour chaque option du dropdown
      dropdown.querySelectorAll('.custom-select-option').forEach(option => {
        const endroit = option.dataset.value;
        const hasContent = productEndroitsData[endroit] && productEndroitsData[endroit].trim();
        option.innerHTML = endroit;
        option.style.background = hasContent
          ? 'rgba(34, 197, 94, 0.2)'
          : 'rgba(239, 68, 68, 0.2)';
        option.style.borderLeft = hasContent
          ? '3px solid #22c55e'
          : '3px solid #ef4444';
      });

      // Mettre √† jour le texte du bouton avec l'endroit actuel
      if (selectText && currentSelectedProductEndroit) {
        const hasContent = productEndroitsData[currentSelectedProductEndroit] && productEndroitsData[currentSelectedProductEndroit].trim();
        selectText.innerHTML = currentSelectedProductEndroit;
        selectText.parentElement.style.background = hasContent
          ? 'rgba(34, 197, 94, 0.15)'
          : 'rgba(239, 68, 68, 0.15)';
        selectText.parentElement.style.borderLeft = hasContent
          ? '3px solid #22c55e'
          : '3px solid #ef4444';
      }
    }

    // Parser le contenu sauvegard√© par endroit
    function parseProductsByEndroit(content) {
      const result = {};
      if (!content) return result;

      const lines = content.split('\n');
      let currentEndroit = null;

      lines.forEach(line => {
        // D√©tecter les lignes d'endroit (format: "=== Endroit ===")
        const endroitMatch = line.match(/^===\s*(.+?)\s*===$/);
        if (endroitMatch) {
          currentEndroit = endroitMatch[1];
          result[currentEndroit] = '';
        } else if (currentEndroit && line.trim()) {
          result[currentEndroit] += (result[currentEndroit] ? '\n' : '') + line;
        }
      });

      return result;
    }

    // Fermer popup Produit/Couleurs
    function closeProductModal() {
      console.log('[MODAL PRODUITS] Fermeture...');

      // Chercher le modal o√π qu'il soit (iframe ou parent)
      let productModal = document.getElementById('productModal');

      const isMobile = window.innerWidth <= 1200;
      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        // Si pas trouv√© dans iframe, chercher dans parent
        if (!productModal && rootWindow && rootWindow.document) {
          productModal = rootWindow.document.getElementById('productModal');
          console.log('[MODAL PRODUITS] Modal trouv√© dans parent');
        }

        if (rootWindow && rootWindow.document) {
          const parentBody = rootWindow.document.body;

          // Ramener dans iframe D'ABORD
          if (productModal && productModal.parentElement === parentBody) {
            document.body.appendChild(productModal);
            console.log('[MODAL PRODUITS] Ramen√© dans iframe');
          }

          // D√©bloquer le scroll du parent
          parentBody.style.overflow = "auto";
          parentBody.classList.remove('modal-open');
          console.log('[MODAL PRODUITS] Scroll parent d√©bloqu√©');
        }
      }

      // PUIS cacher le modal (apr√®s l'avoir ramen√©)
      if (productModal) {
        productModal.classList.remove('active');
        console.log('[MODAL PRODUITS] Modal cach√©');
      }

      document.body.style.overflow = 'auto'; // R√©activer le scroll de la page
      console.log('[MODAL PRODUITS] ‚úÖ Modal ferm√©');

      // Reset endroit s√©lectionn√© et donn√©es
      currentSelectedProductEndroit = null;
      productEndroitsData = {};

      // R√©cup√©rer le modal (il a √©t√© ramen√© dans l'iframe)
      const productModalForCleanup = document.getElementById('productModal');
      if (productModalForCleanup) {
        // D√©s√©lectionner toutes les checkboxes (le texte reste dans le display)
        productSelections = [];
        productModalForCleanup.querySelectorAll('#productOptions .popup-option').forEach(option => {
          option.classList.remove('selected');
        });

        // Vider le textarea de travail (pas le display qui contient le texte sauvegard√©)
        const productTextarea = productModalForCleanup.querySelector('#productTextarea');
        if (productTextarea) {
          productTextarea.value = '';
        }
      }
    }

    // Ouvrir popup Endroit √† peinturer
    function openEndroitModal() {
      const endroitModal = document.getElementById('endroitModal');

      // Sur MOBILE uniquement: d√©placer modal vers parent pour passer au-dessus des headers
      const isMobile = window.innerWidth <= 1200;
      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        console.log('[MODAL ENDROIT] Niveaux iframe:', isNestedIframe ? '2 (mobile)' : '1 (desktop)');

        if (rootWindow && rootWindow.document) {
          const parentBody = rootWindow.document.body;
          const parentDoc = rootWindow.document;

          // Injecter les styles n√©cessaires dans le parent si pas d√©j√† fait
          if (!parentDoc.getElementById('soumission-modal-styles')) {
            const styleLink = parentDoc.createElement('link');
            styleLink.id = 'soumission-modal-styles';
            styleLink.rel = 'stylesheet';
            styleLink.href = '/frontend/Entrepreneurs/Outils/Soumission/soumission.css';
            parentDoc.head.appendChild(styleLink);

            const baseLink = parentDoc.createElement('link');
            baseLink.id = 'base-css-for-modal';
            baseLink.rel = 'stylesheet';
            baseLink.href = '/base.css';
            parentDoc.head.appendChild(baseLink);
          }

          // D√©placer vers le body parent si pas d√©j√† fait
          if (endroitModal && endroitModal.parentElement !== parentBody) {
            parentBody.appendChild(endroitModal);
            console.log('[MODAL ENDROIT] D√©plac√© vers document racine (apppc.html)');
          }

          // Exposer les fonctions sur le parent pour que les onclick fonctionnent
          rootWindow.closeEndroitModal = window.closeEndroitModal;
          rootWindow.confirmEndroitSelection = window.confirmEndroitSelection;
          rootWindow.addCustomEndroit = window.addCustomEndroit;
          rootWindow.removeEndroitChip = window.removeEndroitChip;
          console.log('[MODAL ENDROIT] Fonctions expos√©es sur parent');

          // Bloquer le scroll du parent
          parentBody.style.overflow = "hidden";
        }
      }

      endroitModal.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Restaurer le contenu sauvegard√©
      const savedContent = document.getElementById('endroitHidden').value;

      if (savedContent) {
        // Parser les lignes sauvegard√©es pour reconstruire la liste
        const lines = savedContent.split('\n');
        endroitSelections = lines.map(line => line.replace(/^-\s*/, '').trim()).filter(line => line);
        syncEndroitCheckboxes();
        updateEndroitChips(endroitModal);
      } else {
        endroitSelections = [];
        updateEndroitChips(endroitModal);
      }
    }

    // Fermer popup Endroit √† peinturer (expos√©e globalement pour mobile)
    window.closeEndroitModal = function closeEndroitModal() {
      console.log('[MODAL ENDROIT] Fermeture...');

      let endroitModal = document.getElementById('endroitModal');

      const isMobile = window.innerWidth <= 1200;
      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        if (!endroitModal && rootWindow && rootWindow.document) {
          endroitModal = rootWindow.document.getElementById('endroitModal');
          console.log('[MODAL ENDROIT] Modal trouv√© dans parent');
        }

        if (rootWindow && rootWindow.document) {
          const parentBody = rootWindow.document.body;

          if (endroitModal && endroitModal.parentElement === parentBody) {
            document.body.appendChild(endroitModal);
            console.log('[MODAL ENDROIT] Ramen√© dans iframe');
          }

          parentBody.style.overflow = "auto";
          parentBody.classList.remove('modal-open');
          console.log('[MODAL ENDROIT] Scroll parent d√©bloqu√©');
        }
      }

      if (endroitModal) {
        endroitModal.classList.remove('active');
        console.log('[MODAL ENDROIT] Modal cach√©');
      }

      document.body.style.overflow = 'auto';
      console.log('[MODAL ENDROIT] ‚úÖ Modal ferm√©');

      const endroitModalForCleanup = document.getElementById('endroitModal');
      if (endroitModalForCleanup) {
        endroitSelections = [];
        endroitModalForCleanup.querySelectorAll('#endroitOptions .popup-option').forEach(option => {
          option.classList.remove('selected');
        });

        const endroitTextarea = endroitModalForCleanup.querySelector('#endroitTextarea');
        if (endroitTextarea) {
          endroitTextarea.value = '';
        }
      }
    }

    // Confirmer s√©lection Endroit √† peinturer (expos√©e globalement pour mobile)
    window.confirmEndroitSelection = function confirmEndroitSelection() {
      const display = document.getElementById('endroitDisplay');
      const hidden = document.getElementById('endroitHidden');
      const endroitTrigger = document.getElementById('endroitTrigger');

      log('[DEBUG] ENDROIT - S√©lections:', endroitSelections);

      if (endroitSelections.length > 0) {
        // Formater SANS tirets pour le backend/PDF
        const textForBackend = endroitSelections.join('\n');

        log('[DEBUG] ENDROIT - Contenu envoy√© au backend:', textForBackend);

        // Afficher proprement dans le trigger avec ic√¥ne maison
        display.innerHTML = endroitSelections.map(item => '<div style="margin-bottom: 4px;"><i class="fas fa-home" style="color: var(--primary-blue); margin-right: 8px; font-size: 12px;"></i>' + item + '</div>').join('');
        display.style.color = 'var(--text-light)';
        hidden.value = textForBackend;

        if (endroitTrigger) endroitTrigger.style.setProperty('border-right-color', '#4caf50', 'important');

        log('[DEBUG] ENDROIT - Contenu dans hidden field:', hidden.value);
      } else {
        display.innerHTML = 'Cliquez pour s√©lectionner les endroits √† peinturer...';
        display.style.color = 'var(--text-gray)';
        hidden.value = '';
        if (endroitTrigger) endroitTrigger.style.setProperty('border-right-color', '#e57373', 'important');
      }

      closeEndroitModal();

      // Mettre √† jour le compteur Pr√©paration/Produit quand les endroits changent
      updateProductCounter();
    }

    // Fonction pour mettre √† jour le compteur Pr√©paration/Produit
    function updateProductCounter() {
      const endroitHidden = document.getElementById('endroitHidden');
      const endroitsValue = endroitHidden ? endroitHidden.value.trim() : '';
      const allEndroits = endroitsValue ? endroitsValue.split('\n').map(e => e.trim()).filter(e => e) : [];
      const totalEndroits = allEndroits.length;

      // Parser le contenu du hidden field pour compter les endroits compl√©t√©s
      const produitHiddenValue = document.getElementById('produitCouleursHidden')?.value || '';
      const endroitsWithContent = new Set();

      // Chercher tous les "=== EndroitName ===" qui ont du contenu apr√®s
      const regex = /===\s*(.+?)\s*===/g;
      let match;
      while ((match = regex.exec(produitHiddenValue)) !== null) {
        const endroitName = match[1];
        // V√©rifier s'il y a du contenu apr√®s ce header
        const startPos = match.index + match[0].length;
        const nextMatch = produitHiddenValue.indexOf('===', startPos);
        const contentAfter = nextMatch > -1
          ? produitHiddenValue.substring(startPos, nextMatch).trim()
          : produitHiddenValue.substring(startPos).trim();

        if (contentAfter) {
          endroitsWithContent.add(endroitName);
        }
      }

      // Compter les endroits compl√©t√©s qui sont dans la liste actuelle
      let completedCount = 0;
      allEndroits.forEach(endroit => {
        if (endroitsWithContent.has(endroit)) completedCount++;
      });

      // Mettre √† jour l'affichage du compteur principal
      const productCounter = document.getElementById('productCounter');
      const counterText = `${completedCount}/${totalEndroits}`;
      const counterColor = (totalEndroits > 0 && completedCount === totalEndroits) ? '#4caf50' : '#ef4444';

      if (productCounter) {
        productCounter.textContent = counterText;
        productCounter.style.color = counterColor;
      }

      // Mettre √† jour le compteur dans le modal aussi
      let productModalCounter = document.getElementById('productModalCounter');
      if (!productModalCounter && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
        if (rootWindow && rootWindow.document) {
          productModalCounter = rootWindow.document.getElementById('productModalCounter');
        }
      }
      if (productModalCounter) {
        updateProductModalBadge(productModalCounter, completedCount, totalEndroits);
      }

      // Mettre √† jour la bordure du trigger
      const productTrigger = document.getElementById('productTrigger');
      if (productTrigger && totalEndroits > 0) {
        const allComplete = completedCount === totalEndroits;
        productTrigger.style.setProperty('border-right-color', allComplete ? '#4caf50' : '#e57373', 'important');
      }
    }

    // Synchroniser les checkboxes Endroit avec la liste des s√©lections
    function syncEndroitCheckboxes() {
      let endroitModal = document.getElementById('endroitModal');
      if (!endroitModal && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
        if (rootWindow && rootWindow.document) {
          endroitModal = rootWindow.document.getElementById('endroitModal');
        }
      }

      if (!endroitModal) return;

      const options = endroitModal.querySelectorAll('#endroitOptions .popup-option');

      options.forEach(option => {
        const value = option.getAttribute('data-value');
        if (endroitSelections.includes(value)) {
          option.classList.add('selected');
        } else {
          option.classList.remove('selected');
        }
      });
    }

    // Ouvrir popup Particularit√© des travaux
    async function openPartTravauxModal() {
      const partTravauxModal = document.getElementById('partTravauxModal');

      // Sur MOBILE uniquement: d√©placer modal vers parent pour passer au-dessus des headers
      const isMobile = window.innerWidth <= 1200;
      if (isMobile && window.parent) {
        // D√©tecter si iframe imbriqu√©e (mobile: 2 niveaux) ou directe (desktop: 1 niveau)
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        console.log('[MODAL PART TRAVAUX] Niveaux iframe:', isNestedIframe ? '2 (mobile)' : '1 (desktop)');

        if (rootWindow && rootWindow.document) {
          const parentBody = rootWindow.document.body;
          const parentDoc = rootWindow.document;

          // Injecter les styles n√©cessaires dans le parent si pas d√©j√† fait
          if (!parentDoc.getElementById('soumission-modal-styles')) {
            const styleLink = parentDoc.createElement('link');
            styleLink.id = 'soumission-modal-styles';
            styleLink.rel = 'stylesheet';
            styleLink.href = '/frontend/Entrepreneurs/Outils/Soumission/soumission.css';
            parentDoc.head.appendChild(styleLink);

            const baseLink = parentDoc.createElement('link');
            baseLink.id = 'base-css-for-modal';
            baseLink.rel = 'stylesheet';
            baseLink.href = '/base.css';
            parentDoc.head.appendChild(baseLink);
          }

          // D√©placer vers le body parent si pas d√©j√† fait
          if (partTravauxModal && partTravauxModal.parentElement !== parentBody) {
            parentBody.appendChild(partTravauxModal);
            console.log('[MODAL PART TRAVAUX] D√©plac√© vers document racine (apppc.html)');
          }

          // Bloquer le scroll du parent
          parentBody.style.overflow = "hidden";
        }
      }

      partTravauxModal.classList.add('active');
      document.body.style.overflow = 'hidden'; // D√©sactiver le scroll de la page

      // Charger les templates de l'utilisateur
      await loadUserTemplates();

      // Restaurer le contenu sauvegard√© (partTravauxHidden est dans la page principale)
      const savedContent = document.getElementById('partTravauxHidden').value;

      // Chercher le textarea dans le modal (peu importe o√π il est)
      const partTravauxTextarea = partTravauxModal.querySelector('#partTravauxTextarea');

      if (savedContent && partTravauxTextarea) {
        partTravauxTextarea.value = savedContent;

        // Synchroniser les checkboxes avec le contenu du textarea
        syncPartTravauxCheckboxes();
      } else if (partTravauxTextarea) {
        // Vider le textarea si rien n'est sauvegard√©
        partTravauxTextarea.value = '';
      }
    }

    // Fermer popup Particularit√© des travaux
    function closePartTravauxModal() {
      console.log('[MODAL PART TRAVAUX] Fermeture...');

      // Chercher le modal o√π qu'il soit (iframe ou parent)
      let partTravauxModal = document.getElementById('partTravauxModal');

      const isMobile = window.innerWidth <= 1200;
      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        // Si pas trouv√© dans iframe, chercher dans parent
        if (!partTravauxModal && rootWindow && rootWindow.document) {
          partTravauxModal = rootWindow.document.getElementById('partTravauxModal');
          console.log('[MODAL PART TRAVAUX] Modal trouv√© dans parent');
        }

        if (rootWindow && rootWindow.document) {
          const parentBody = rootWindow.document.body;

          // Ramener dans iframe D'ABORD
          if (partTravauxModal && partTravauxModal.parentElement === parentBody) {
            document.body.appendChild(partTravauxModal);
            console.log('[MODAL PART TRAVAUX] Ramen√© dans iframe');
          }

          // D√©bloquer le scroll du parent
          parentBody.style.overflow = "auto";
          parentBody.classList.remove('modal-open');
          console.log('[MODAL PART TRAVAUX] Scroll parent d√©bloqu√©');
        }
      }

      // PUIS cacher le modal (apr√®s l'avoir ramen√©)
      if (partTravauxModal) {
        partTravauxModal.classList.remove('active');
        console.log('[MODAL PART TRAVAUX] Modal cach√©');
      }

      document.body.style.overflow = 'auto'; // R√©activer le scroll de la page
      console.log('[MODAL PART TRAVAUX] ‚úÖ Modal ferm√©');

      // R√©cup√©rer le modal (il a √©t√© ramen√© dans l'iframe)
      const partTravauxModalForCleanup = document.getElementById('partTravauxModal');
      if (partTravauxModalForCleanup) {
        // D√©s√©lectionner toutes les checkboxes (le texte reste dans le display)
        partTravauxSelections = [];
        partTravauxModalForCleanup.querySelectorAll('#partTravauxOptions .popup-option').forEach(option => {
          option.classList.remove('selected');
        });

        // Vider le textarea de travail (pas le display qui contient le texte sauvegard√©)
        const partTravauxTextarea = partTravauxModalForCleanup.querySelector('#partTravauxTextarea');
        if (partTravauxTextarea) {
          partTravauxTextarea.value = '';
        }
      }
    }

    // Variable pour stocker les donn√©es des items
    let itemData = {};

    // Ouvrir popup Item
    function openItemModal() {
      console.log('[MODAL ITEM] Ouverture...');

      const itemModal = document.getElementById('itemModal');
      if (!itemModal) {
        console.error('[MODAL ITEM] Modal non trouv√©!');
        return;
      }

      // Construire le tableau avec 4 lignes vides
      const tableBody = document.getElementById('itemTableBody');
      tableBody.innerHTML = '';

      // D√©terminer la langue actuelle
      const isEnglish = window.currentLanguage === 'en';
      const placeholderItem = isEnglish ? 'E.g.: Balcony, Door...' : 'Ex: Balcon, Porte...';
      const placeholderPrix = isEnglish ? 'E.g.: $500' : 'Ex: 500 $';
      const placeholderDuree = isEnglish ? 'E.g.: 1-2 days' : 'Ex: 1-2 jours';

      for (let i = 0; i < 4; i++) {
        // R√©cup√©rer les valeurs existantes si disponibles
        const existingData = itemData[i] || { item: '', prix: '', duree: '' };

        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid var(--border-dark)';
        row.innerHTML = `
          <td style="padding: 8px;">
            <input type="text"
              class="modern-input item-name-input"
              data-index="${i}"
              placeholder="${placeholderItem}"
              value="${existingData.item || ''}"
              style="width: 100%; padding: 8px 12px; font-size: 14px;">
          </td>
          <td style="padding: 8px;">
            <input type="text"
              class="modern-input item-prix-input"
              data-index="${i}"
              placeholder="${placeholderPrix}"
              value="${existingData.prix || ''}"
              style="width: 100%; padding: 8px 12px; font-size: 14px;"
              oninput="this.value = this.value.replace(/[^0-9.,$ ]/g, '');"
              onblur="if(this.value.trim()) this.value = formatPrice(this.value);">
          </td>
          <td style="padding: 8px;">
            <input type="text"
              class="modern-input item-duree-input"
              data-index="${i}"
              placeholder="${placeholderDuree}"
              value="${existingData.duree || ''}"
              style="width: 100%; padding: 8px 12px; font-size: 14px;">
          </td>
        `;
        tableBody.appendChild(row);
      }

      itemModal.classList.add('active');
      document.body.style.overflow = 'hidden';
      console.log('[MODAL ITEM] ‚úÖ Modal ouvert');
    }

    // Fermer popup Item
    function closeItemModal() {
      console.log('[MODAL ITEM] Fermeture...');
      const itemModal = document.getElementById('itemModal');
      if (itemModal) {
        itemModal.classList.remove('active');
      }
      document.body.style.overflow = 'auto';
      console.log('[MODAL ITEM] ‚úÖ Modal ferm√©');
    }

    // Confirmer s√©lection Item
    function confirmItemSelection() {
      console.log('[MODAL ITEM] Confirmation...');

      const itemModal = document.getElementById('itemModal');
      if (!itemModal) return;

      // R√©cup√©rer toutes les valeurs des inputs
      const itemInputs = itemModal.querySelectorAll('.item-name-input');
      const prixInputs = itemModal.querySelectorAll('.item-prix-input');
      const dureeInputs = itemModal.querySelectorAll('.item-duree-input');

      let displayHtml = [];
      let itemsArray = []; // JSON array pour le backend
      let hasCompleteItem = false; // Au moins 1 item complet (nom + prix + dur√©e)

      // R√©initialiser itemData
      itemData = {};

      itemInputs.forEach((itemInput, index) => {
        const itemName = itemInput.value.trim();
        const prixInput = prixInputs[index];
        const dureeInput = dureeInputs[index];
        const prix = prixInput ? prixInput.value.trim() : '';
        const duree = dureeInput ? dureeInput.value.trim() : '';

        // Sauvegarder dans itemData par index
        itemData[index] = { item: itemName, prix, duree };

        // V√©rifier si cet item est complet
        if (itemName && prix && duree) {
          hasCompleteItem = true;
        }

        // Construire l'affichage visuel avec couleurs (seulement si item rempli)
        if (itemName) {
          let html = `<div style="display: flex; align-items: center; gap: 6px; padding: 4px 0;">`;
          html += `<span style="color: var(--text-light);">${itemName}</span>`;
          if (prix) {
            html += `<span style="color: #4caf50; font-weight: 600;">- ${prix}</span>`;
          }
          if (duree) {
            html += `<span style="color: #f59e0b;">(${duree})</span>`;
          }
          html += `</div>`;
          displayHtml.push(html);

          // Ajouter √† l'array JSON pour le backend
          itemsArray.push({
            nom: itemName,
            prix: prix,
            duree: duree
          });
        }
      });

      // Mettre √† jour l'affichage et le champ cach√©
      const itemDisplay = document.getElementById('itemDisplay');
      const itemHidden = document.getElementById('itemHidden');
      const itemTrigger = document.getElementById('itemTrigger');

      if (displayHtml.length > 0) {
        if (itemDisplay) {
          itemDisplay.innerHTML = displayHtml.join('');
          itemDisplay.style.color = 'var(--text-light)';
        }
        if (itemHidden) {
          // Stocker en JSON pour le backend
          itemHidden.value = JSON.stringify(itemsArray);
        }
        // Vert si au moins 1 item complet (nom + prix + dur√©e)
        if (itemTrigger) {
          itemTrigger.style.setProperty('border-right-color', hasCompleteItem ? '#4caf50' : '#e57373', 'important');
        }
      } else {
        if (itemDisplay) {
          itemDisplay.textContent = 'Cliquez pour ajouter les items...';
          itemDisplay.style.color = 'var(--text-gray)';
        }
        if (itemHidden) {
          itemHidden.value = '';
        }
        if (itemTrigger) {
          itemTrigger.style.setProperty('border-right-color', '#e57373', 'important');
        }
      }

      closeItemModal();

      // D√©clencher la validation
      if (typeof validateRequiredFields === 'function') {
        validateRequiredFields();
      }

      console.log('[MODAL ITEM] ‚úÖ S√©lection confirm√©e:', itemsArray, 'Item complet:', hasCompleteItem);
    }

    // Exposer les fonctions globalement pour qu'elles soient accessibles depuis apppc.html
    // (quand les modals sont d√©plac√©s vers le document parent sur mobile)
    window.openProductModal = openProductModal;
    window.closeProductModal = closeProductModal;
    window.openPartTravauxModal = openPartTravauxModal;
    window.closePartTravauxModal = closePartTravauxModal;
    window.confirmProductSelection = confirmProductSelection;
    window.confirmPartTravauxSelection = confirmPartTravauxSelection;
    window.toggleProductEndroitDropdown = toggleProductEndroitDropdown;
    window.selectProductEndroitOption = selectProductEndroitOption;
    window.updateProductCounter = updateProductCounter;
    window.openItemModal = openItemModal;
    window.closeItemModal = closeItemModal;
    window.confirmItemSelection = confirmItemSelection;

    // AUSSI exposer dans le parent (apppc.html) pour que les boutons onclick fonctionnent
    if (window.parent && window.parent !== window) {
      // D√©tecter si iframe imbriqu√©e
      const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
      const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

      if (rootWindow && rootWindow !== window) {
        rootWindow.openProductModal = openProductModal;
        rootWindow.closeProductModal = closeProductModal;
        rootWindow.openPartTravauxModal = openPartTravauxModal;
        rootWindow.closePartTravauxModal = closePartTravauxModal;
        rootWindow.confirmProductSelection = confirmProductSelection;
        rootWindow.confirmPartTravauxSelection = confirmPartTravauxSelection;
        rootWindow.toggleProductEndroitDropdown = toggleProductEndroitDropdown;
        rootWindow.selectProductEndroitOption = selectProductEndroitOption;
        rootWindow.updateProductCounter = updateProductCounter;
        rootWindow.openItemModal = openItemModal;
        rootWindow.closeItemModal = closeItemModal;
        rootWindow.confirmItemSelection = confirmItemSelection;

        // Exposer les fonctions de templates pour que les boutons onclick fonctionnent
        rootWindow.saveTemplatePrompt = saveTemplatePrompt;
        rootWindow.closeTemplateNameModal = closeTemplateNameModal;
        rootWindow.confirmSaveTemplate = confirmSaveTemplate;
        rootWindow.deleteTemplate = deleteTemplate;
        rootWindow.closeTemplateDeleteModal = closeTemplateDeleteModal;
        rootWindow.confirmDeleteTemplate = confirmDeleteTemplate;
        rootWindow.editTemplate = editTemplate;
        rootWindow.closeTemplateEditModal = closeTemplateEditModal;
        rootWindow.confirmEditTemplate = confirmEditTemplate;
        rootWindow.selectTemplate = selectTemplate;

        console.log('[MODALS] Fonctions expos√©es dans le parent (apppc.html)');
      }
    }

    // Sur MOBILE: d√©placer les modals de templates vers le parent pour passer au-dessus des headers
    document.addEventListener('DOMContentLoaded', function() {
      const isMobile = window.innerWidth <= 1200;

      if (isMobile && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;

        console.log('[TEMPLATE MODALS] Niveaux iframe:', isNestedIframe ? '2 (mobile)' : '1 (desktop)');

        if (rootWindow && rootWindow.document) {
          const parentBody = rootWindow.document.body;
          const parentDoc = rootWindow.document;

          // Injecter les styles n√©cessaires dans le parent si pas d√©j√† fait
          if (!parentDoc.getElementById('soumission-modal-styles')) {
            const styleLink = parentDoc.createElement('link');
            styleLink.id = 'soumission-modal-styles';
            styleLink.rel = 'stylesheet';
            styleLink.href = '/frontend/Entrepreneurs/Outils/Soumission/soumission.css';
            parentDoc.head.appendChild(styleLink);

            const baseLink = parentDoc.createElement('link');
            baseLink.id = 'base-css-for-modal';
            baseLink.rel = 'stylesheet';
            baseLink.href = '/base.css';
            parentDoc.head.appendChild(baseLink);
          }

          // D√©placer les 3 modals de templates vers le parent
          const templateModals = [
            'templateNameModal',
            'templateEditModal',
            'templateDeleteModal'
          ];

          templateModals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal && modal.parentElement !== parentBody) {
              parentBody.appendChild(modal);
              console.log(`[TEMPLATE MODALS] ${modalId} d√©plac√© vers document racine (apppc.html)`);
            }
          });
        }
      }
    });

    // Mettre √† jour les indicateurs quand l'utilisateur tape dans le textarea produit
    document.getElementById('productEndroitTextarea').addEventListener('input', function(e) {
      if (currentSelectedProductEndroit) {
        productEndroitsData[currentSelectedProductEndroit] = e.target.value;
        updateProductDropdownIndicators();
        updateModalCounter();
      }
    });

    // Fonction pour mettre √† jour le compteur dans le modal
    function updateModalCounter() {
      let productModal = document.getElementById('productModal');
      if (!productModal && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
        if (rootWindow && rootWindow.document) {
          productModal = rootWindow.document.getElementById('productModal');
        }
      }
      if (!productModal) return;

      const endroitHidden = document.getElementById('endroitHidden');
      const endroitsValue = endroitHidden ? endroitHidden.value.trim() : '';
      const allEndroits = endroitsValue ? endroitsValue.split('\n').map(e => e.trim()).filter(e => e) : [];

      let completedCount = 0;
      allEndroits.forEach(endroit => {
        if (productEndroitsData[endroit] && productEndroitsData[endroit].trim()) {
          completedCount++;
        }
      });

      const modalCounter = productModal.querySelector('#productModalCounter');
      if (modalCounter) {
        updateProductModalBadge(modalCounter, completedCount, allEndroits.length);
      }
    }

    // G√©rer les s√©lections d'options Produit/Couleurs
    document.getElementById('productOptions').addEventListener('click', function(e) {
      if (e.target.closest('.popup-option')) {
        const option = e.target.closest('.popup-option');
        const value = option.getAttribute('data-value');

        // V√©rifier qu'un endroit est s√©lectionn√©
        if (!currentSelectedProductEndroit) {
          console.warn('[PRODUCT OPTIONS] Aucun endroit s√©lectionn√©');
          return;
        }

        // Chercher le modal o√π qu'il soit (iframe ou parent)
        let productModal = document.getElementById('productModal');
        if (!productModal && window.parent) {
          const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
          const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
          if (rootWindow && rootWindow.document) {
            productModal = rootWindow.document.getElementById('productModal');
          }
        }

        if (!productModal) {
          console.warn('[PRODUCT OPTIONS] Modal introuvable');
          return;
        }

        // Chercher le textarea unique
        const textarea = productModal.querySelector('#productEndroitTextarea');
        if (!textarea) {
          console.warn('[PRODUCT OPTIONS] Textarea introuvable');
          return;
        }

        // Ajouter l'option au textarea (sans toggle, juste ajouter)
        const currentText = textarea.value.trim();
        if (currentText) {
          textarea.value = currentText + '\n- ' + value;
        } else {
          textarea.value = '- ' + value;
        }

        // Sauvegarder dans les donn√©es
        productEndroitsData[currentSelectedProductEndroit] = textarea.value;
        updateProductDropdownIndicators(productModal);
        updateModalCounter();
      }
    });

    // G√©rer les s√©lections d'options Endroit √† peinturer
    document.getElementById('endroitOptions').addEventListener('click', function(e) {
      if (e.target.closest('.popup-option')) {
        const option = e.target.closest('.popup-option');
        const value = option.getAttribute('data-value');

        // Chercher le modal o√π qu'il soit (iframe ou parent)
        let endroitModal = document.getElementById('endroitModal');
        if (!endroitModal && window.parent) {
          const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
          const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
          if (rootWindow && rootWindow.document) {
            endroitModal = rootWindow.document.getElementById('endroitModal');
          }
        }

        if (!endroitModal) {
          console.warn('[ENDROIT OPTIONS] Modal introuvable');
          return;
        }

        if (option.classList.contains('selected')) {
          // D√©s√©lectionner
          option.classList.remove('selected');
          endroitSelections = endroitSelections.filter(item => item !== value);
        } else {
          // V√©rifier la limite de 10 endroits
          if (endroitSelections.length >= 10) {
            showEndroitMaxNotif(endroitModal);
            return;
          }
          // S√©lectionner
          option.classList.add('selected');
          if (!endroitSelections.includes(value)) {
            endroitSelections.push(value);
          }
        }

        // Mettre √† jour l'affichage des chips
        updateEndroitChips(endroitModal);
      }
    });

    // Fonction pour mettre √† jour l'affichage des chips endroit
    function updateEndroitChips(modal) {
      if (!modal) {
        modal = document.getElementById('endroitModal');
        if (!modal && window.parent) {
          const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
          const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
          if (rootWindow && rootWindow.document) {
            modal = rootWindow.document.getElementById('endroitModal');
          }
        }
      }
      if (!modal) return;

      const chipsContainer = modal.querySelector('#endroitChips');
      const emptyMsg = modal.querySelector('#endroitEmpty');
      const textarea = modal.querySelector('#endroitTextarea');
      const counter = modal.querySelector('#endroitCounter');

      if (!chipsContainer) return;

      // Mettre √† jour le compteur
      if (counter) {
        counter.textContent = `${endroitSelections.length}/10`;
        counter.style.color = endroitSelections.length >= 10 ? '#ef4444' : 'var(--text-gray)';
      }

      // Vider le container
      chipsContainer.innerHTML = '';

      if (endroitSelections.length === 0) {
        if (emptyMsg) emptyMsg.style.display = 'block';
      } else {
        if (emptyMsg) emptyMsg.style.display = 'none';

        endroitSelections.forEach((item, index) => {
          const chip = document.createElement('div');
          chip.style.cssText = 'display: flex; align-items: center; justify-content: space-between; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; padding: 10px 14px; color: var(--text-light); font-size: 14px;';
          chip.innerHTML = `
            <span style="flex: 1;">${item}</span>
            <button type="button" onclick="removeEndroitChip(${index})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 0 0 0 12px; font-size: 16px;">
              <i class="fas fa-times"></i>
            </button>
          `;
          chipsContainer.appendChild(chip);
        });
      }

      // Mettre √† jour le textarea cach√©
      if (textarea) {
        textarea.value = endroitSelections.join('\n');
      }
    }

    // Fonction pour afficher la notification "10 maximum"
    function showEndroitMaxNotif(modal) {
      if (!modal) {
        modal = document.getElementById('endroitModal');
        if (!modal && window.parent) {
          const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
          const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
          if (rootWindow && rootWindow.document) {
            modal = rootWindow.document.getElementById('endroitModal');
          }
        }
      }
      if (!modal) return;

      const notif = modal.querySelector('#endroitMaxNotif');
      if (notif) {
        notif.style.display = 'block';
        // Auto-hide apr√®s 2 secondes
        setTimeout(() => {
          notif.style.display = 'none';
        }, 2000);
      }
    }

    // Fonction pour afficher notification "S√©lectionnez d'abord des endroits"
    function showNoEndroitNotif() {
      // Cr√©er ou r√©cup√©rer la notification
      let notif = document.getElementById('noEndroitNotif');
      if (!notif) {
        notif = document.createElement('div');
        notif.id = 'noEndroitNotif';
        notif.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(239, 68, 68, 0.95); border: 1px solid #ef4444; border-radius: 8px; padding: 12px 24px; color: white; font-size: 14px; font-weight: 500; z-index: 999999; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
        notif.textContent = 'S√©lectionnez d\'abord des endroits √† peinturer';
        document.body.appendChild(notif);
      }
      notif.style.display = 'block';
      // Auto-hide apr√®s 2.5 secondes
      setTimeout(() => {
        notif.style.display = 'none';
      }, 2500);
    }

    // Fonction pour supprimer un chip endroit
    window.removeEndroitChip = function removeEndroitChip(index) {
      const removedValue = endroitSelections[index];
      endroitSelections.splice(index, 1);

      // D√©s√©lectionner l'option correspondante
      let endroitModal = document.getElementById('endroitModal');
      if (!endroitModal && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
        if (rootWindow && rootWindow.document) {
          endroitModal = rootWindow.document.getElementById('endroitModal');
        }
      }

      if (endroitModal) {
        const options = endroitModal.querySelectorAll('#endroitOptions .popup-option');
        options.forEach(option => {
          if (option.getAttribute('data-value') === removedValue) {
            option.classList.remove('selected');
          }
        });
      }

      updateEndroitChips(endroitModal);
    }

    // Fonction pour ajouter un endroit personnalis√©
    window.addCustomEndroit = function addCustomEndroit() {
      let endroitModal = document.getElementById('endroitModal');
      if (!endroitModal && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
        if (rootWindow && rootWindow.document) {
          endroitModal = rootWindow.document.getElementById('endroitModal');
        }
      }
      if (!endroitModal) return;

      const input = endroitModal.querySelector('#endroitCustomInput');
      if (!input) return;

      const value = input.value.trim();
      if (value && !endroitSelections.includes(value)) {
        // V√©rifier la limite de 10 endroits
        if (endroitSelections.length >= 10) {
          showEndroitMaxNotif(endroitModal);
          return;
        }
        endroitSelections.push(value);
        updateEndroitChips(endroitModal);
        input.value = '';
      }
    }

    // G√©rer les s√©lections d'options Particularit√© des travaux
    document.getElementById('partTravauxOptions').addEventListener('click', function(e) {
      if (e.target.closest('.popup-option')) {
        const option = e.target.closest('.popup-option');
        const value = option.getAttribute('data-value');

        // Chercher le modal o√π qu'il soit (iframe ou parent)
        let partTravauxModal = document.getElementById('partTravauxModal');
        if (!partTravauxModal && window.parent) {
          const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
          const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
          if (rootWindow && rootWindow.document) {
            partTravauxModal = rootWindow.document.getElementById('partTravauxModal');
          }
        }

        if (!partTravauxModal) {
          console.warn('[PART TRAVAUX OPTIONS] Modal introuvable');
          return;
        }

        // Chercher le textarea dans le modal
        const textarea = partTravauxModal.querySelector('#partTravauxTextarea');
        if (!textarea) {
          console.warn('[PART TRAVAUX OPTIONS] Textarea introuvable');
          return;
        }

        if (option.classList.contains('selected')) {
          // D√©s√©lectionner
          option.classList.remove('selected');
          partTravauxSelections = partTravauxSelections.filter(item => item !== value);

          // Retirer la ligne avec tiret
          const currentLines = textarea.value.split('\n');
          const filteredLines = currentLines.filter(line => {
            const cleaned = line.replace(/^-\s*/, '').trim();
            return cleaned !== value;
          });
          textarea.value = filteredLines.join('\n');
        } else {
          // S√©lectionner
          option.classList.add('selected');
          if (!partTravauxSelections.includes(value)) {
            partTravauxSelections.push(value);
          }

          // Ajouter simplement √† la fin avec un tiret
          const currentText = textarea.value.trim();
          if (currentText) {
            textarea.value = currentText + '\n- ' + value;
          } else {
            textarea.value = '- ' + value;
          }
        }
      }
    });

    // Confirmer s√©lection Produit/Couleurs
    function confirmProductSelection() {
      // Chercher le modal o√π qu'il soit
      let productModal = document.getElementById('productModal');
      if (!productModal && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
        if (rootWindow && rootWindow.document) {
          productModal = rootWindow.document.getElementById('productModal');
        }
      }

      if (!productModal) {
        console.warn('[CONFIRM PRODUITS] Modal introuvable');
        return;
      }

      const display = document.getElementById('productDisplay');
      const hidden = document.getElementById('produitCouleursHidden');
      const productTrigger = document.getElementById('productTrigger');

      // Sauvegarder le contenu actuel du textarea avant de fermer
      const currentTextarea = productModal.querySelector('#productEndroitTextarea');
      if (currentTextarea && currentSelectedProductEndroit) {
        productEndroitsData[currentSelectedProductEndroit] = currentTextarea.value;
      }

      // R√©cup√©rer tous les endroits s√©lectionn√©s
      const endroitHidden = document.getElementById('endroitHidden');
      const endroitsValue = endroitHidden ? endroitHidden.value.trim() : '';
      const allEndroits = endroitsValue ? endroitsValue.split('\n').map(e => e.trim()).filter(e => e) : [];
      const totalEndroits = allEndroits.length;

      // Combiner toutes les donn√©es des endroits et compter les compl√©t√©s
      let combinedText = '';
      let displayHtml = '';
      let completedCount = 0;

      allEndroits.forEach(endroit => {
        const text = productEndroitsData[endroit] ? productEndroitsData[endroit].trim() : '';

        if (text) {
          completedCount++;
          // Format pour le backend: === Endroit ===
          combinedText += `=== ${endroit} ===\n${text}\n\n`;
          // Format pour l'affichage
          displayHtml += `<div style="margin-bottom: 8px;"><strong style="color: var(--primary-blue);">${endroit}:</strong><br>${text.replace(/\n/g, '<br>')}</div>`;
        }
      });

      // Mettre √† jour le compteur
      const productCounter = document.getElementById('productCounter');
      if (productCounter) {
        productCounter.textContent = `${completedCount}/${totalEndroits}`;
        // Couleur verte si tout est compl√©t√©, rouge sinon
        if (totalEndroits > 0 && completedCount === totalEndroits) {
          productCounter.style.color = '#4caf50';
        } else {
          productCounter.style.color = '#ef4444';
        }
      }

      log('[DEBUG] PRODUIT - Contenu combin√©:', combinedText);
      log('[DEBUG] PRODUIT - Compteur:', completedCount, '/', totalEndroits);

      // Bordure verte SEULEMENT si tous les endroits sont compl√©t√©s
      const allComplete = totalEndroits > 0 && completedCount === totalEndroits;

      if (completedCount > 0) {
        display.innerHTML = displayHtml;
        display.style.color = 'var(--text-light)';
        hidden.value = combinedText.trim();

        if (productTrigger) {
          productTrigger.style.setProperty('border-right-color', allComplete ? '#4caf50' : '#e57373', 'important');
        }

        log('[DEBUG] PRODUIT - Contenu dans hidden field:', hidden.value);
      } else {
        display.textContent = 'Cliquez pour s√©lectionner pr√©paration et produit...';
        display.style.color = 'var(--text-gray)';
        hidden.value = '';
        if (productTrigger) productTrigger.style.setProperty('border-right-color', '#e57373', 'important');
      }

      closeProductModal();

      // D√©clencher la validation apr√®s fermeture du modal
      if (typeof validateRequiredFields === 'function') {
        validateRequiredFields();
      }
    }

    // Confirmer s√©lection Particularit√© des travaux
    function confirmPartTravauxSelection() {
      // Chercher le modal o√π qu'il soit
      let partTravauxModal = document.getElementById('partTravauxModal');
      if (!partTravauxModal && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
        if (rootWindow && rootWindow.document) {
          partTravauxModal = rootWindow.document.getElementById('partTravauxModal');
        }
      }

      if (!partTravauxModal) {
        console.warn('[CONFIRM PART TRAVAUX] Modal introuvable');
        return;
      }

      // Chercher les √©l√©ments (display et hidden sont dans la page principale, textarea dans le modal)
      const textareaElement = partTravauxModal.querySelector('#partTravauxTextarea');
      const textarea = textareaElement ? textareaElement.value.trim() : '';
      const display = document.getElementById('partTravauxDisplay');
      const hidden = document.getElementById('partTravauxHidden');
      const partTravauxTrigger = document.getElementById('partTravauxTrigger');

      if (textarea) {
        // Envoyer avec tirets EXACTEMENT comme le textarea
        const formattedText = textarea;

        // Afficher avec tirets
        display.innerHTML = formattedText.replace(/\n/g, '<br>');
        display.style.color = 'var(--text-light)';

        // Stocker AVEC tirets
        hidden.value = formattedText;

        // Bordure verte quand rempli
        if (partTravauxTrigger) partTravauxTrigger.style.setProperty('border-right-color', '#4caf50', 'important');
      } else {
        display.textContent = 'Cliquez pour s√©lectionner particularit√©s des travaux...';
        display.style.color = 'var(--text-gray)';
        hidden.value = '';
        // Bordure rouge quand vide
        if (partTravauxTrigger) partTravauxTrigger.style.setProperty('border-right-color', '#e57373', 'important');
      }

      closePartTravauxModal();

      // D√©clencher la validation apr√®s fermeture du modal
      if (typeof validateRequiredFields === 'function') {
        validateRequiredFields();
      }
    }

    // Synchroniser les checkboxes avec le contenu du textarea Produit
    function syncProductCheckboxes() {
      // Chercher le modal o√π qu'il soit (iframe ou parent)
      let productModal = document.getElementById('productModal');
      if (!productModal && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
        if (rootWindow && rootWindow.document) {
          productModal = rootWindow.document.getElementById('productModal');
        }
      }

      if (!productModal) {
        console.warn('[SYNC PRODUITS] Modal introuvable');
        return;
      }

      // Chercher textarea dans le modal
      const textarea = productModal.querySelector('#productTextarea');
      if (!textarea) {
        console.warn('[SYNC PRODUITS] Textarea introuvable');
        return;
      }

      const currentLines = textarea.value.split('\n')
        .map(line => line.replace(/^-\s*/, '').trim())
        .filter(line => line);

      // Parcourir toutes les options dans le modal
      productModal.querySelectorAll('#productOptions .popup-option').forEach(option => {
        const value = option.getAttribute('data-value');

        if (currentLines.includes(value)) {
          // Le texte existe -> s√©lectionner
          if (!option.classList.contains('selected')) {
            option.classList.add('selected');
            if (!productSelections.includes(value)) {
              productSelections.push(value);
            }
          }
        } else {
          // Le texte n'existe pas -> d√©s√©lectionner
          if (option.classList.contains('selected')) {
            option.classList.remove('selected');
            productSelections = productSelections.filter(item => item !== value);
          }
        }
      });
    }

    // Synchroniser les checkboxes avec le contenu du textarea Particularit√©s
    function syncPartTravauxCheckboxes() {
      // Chercher le modal o√π qu'il soit (iframe ou parent)
      let partTravauxModal = document.getElementById('partTravauxModal');
      if (!partTravauxModal && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
        if (rootWindow && rootWindow.document) {
          partTravauxModal = rootWindow.document.getElementById('partTravauxModal');
        }
      }

      if (!partTravauxModal) {
        console.warn('[SYNC PART TRAVAUX] Modal introuvable');
        return;
      }

      // Chercher textarea dans le modal
      const textarea = partTravauxModal.querySelector('#partTravauxTextarea');
      if (!textarea) {
        console.warn('[SYNC PART TRAVAUX] Textarea introuvable');
        return;
      }

      const currentLines = textarea.value.split('\n')
        .map(line => line.replace(/^-\s*/, '').trim())
        .filter(line => line);

      // Parcourir toutes les options dans le modal
      partTravauxModal.querySelectorAll('#partTravauxOptions .popup-option').forEach(option => {
        const value = option.getAttribute('data-value');

        if (currentLines.includes(value)) {
          // Le texte existe -> s√©lectionner
          if (!option.classList.contains('selected')) {
            option.classList.add('selected');
            if (!partTravauxSelections.includes(value)) {
              partTravauxSelections.push(value);
            }
          }
        } else {
          // Le texte n'existe pas -> d√©s√©lectionner
          if (option.classList.contains('selected')) {
            option.classList.remove('selected');
            partTravauxSelections = partTravauxSelections.filter(item => item !== value);
          }
        }
      });
    }

    // Ajouter tiret automatiquement sur Enter pour partTravaux
    document.getElementById('partTravauxTextarea').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const textarea = e.target;
        const cursorPos = textarea.selectionStart;
        const textBefore = textarea.value.substring(0, cursorPos);
        const textAfter = textarea.value.substring(cursorPos);

        // D√©tecter si le texte contient des √©tapes num√©rot√©es (ex: "√âtape 1", "√âtape 2", etc.)
        const currentText = textarea.value;
        const etapeRegex = /[√â√©Ee]tape\s+(\d+)/gi;
        const matches = [...currentText.matchAll(etapeRegex)];

        let newText = '\n- '; // Par d√©faut: puce simple

        if (matches.length > 0) {
          // Extraire tous les num√©ros d'√©tapes existants
          const existingNumbers = matches.map(m => parseInt(m[1])).sort((a, b) => a - b);

          // Trouver le premier num√©ro manquant dans la s√©quence
          let nextEtape = 1;
          for (let i = 0; i < existingNumbers.length; i++) {
            if (existingNumbers[i] === nextEtape) {
              nextEtape++;
            } else if (existingNumbers[i] > nextEtape) {
              // On a trouv√© un trou, nextEtape est le num√©ro manquant
              break;
            }
          }

          // D√©tecter si on utilise "√âtape" ou "√©tape" (respecter la casse de la premi√®re occurrence)
          const firstMatch = matches[0][0];
          const etapeWord = firstMatch.match(/[√â√©Ee]tape/)[0];

          newText = `\n${etapeWord} ${nextEtape}: `;
        }

        textarea.value = textBefore + newText + textAfter;
        textarea.selectionStart = textarea.selectionEnd = cursorPos + newText.length;
      }
    });

    // Synchroniser apr√®s chaque modification du textarea Particularit√©s
    document.getElementById('partTravauxTextarea').addEventListener('input', function() {
      syncPartTravauxCheckboxes();
    });

    // Formatage automatique du t√©l√©phone (000-000-0000)
    const telephoneInput = document.getElementById('telephoneInput');

    telephoneInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, ''); // Garder seulement les chiffres
      let formattedValue = '';

      if (value.length > 0) {
        formattedValue = value.substring(0, 3);
      }
      if (value.length >= 4) {
        formattedValue += '-' + value.substring(3, 6);
      }
      if (value.length >= 7) {
        formattedValue += '-' + value.substring(6, 10);
      }

      e.target.value = formattedValue;
    });

    telephoneInput.addEventListener('keydown', function(e) {
      // Si l'utilisateur appuie sur Backspace ou Delete
      if (e.key === 'Backspace' || e.key === 'Delete') {
        const cursorPos = e.target.selectionStart;
        const value = e.target.value;

        // Si le curseur est juste apr√®s un tiret, effacer le tiret + le chiffre avant
        if (e.key === 'Backspace' && cursorPos > 0 && value[cursorPos - 1] === '-') {
          e.preventDefault();
          const newValue = value.substring(0, cursorPos - 2) + value.substring(cursorPos);
          e.target.value = newValue;

          // Reformater
          const cleanValue = newValue.replace(/\D/g, '');
          let formattedValue = '';
          if (cleanValue.length > 0) {
            formattedValue = cleanValue.substring(0, 3);
          }
          if (cleanValue.length >= 4) {
            formattedValue += '-' + cleanValue.substring(3, 6);
          }
          if (cleanValue.length >= 7) {
            formattedValue += '-' + cleanValue.substring(6, 10);
          }
          e.target.value = formattedValue;

          // Replacer le curseur
          const newCursorPos = cursorPos - 2;
          e.target.setSelectionRange(newCursorPos, newCursorPos);
        }
      }
    });

    // Event listeners pour ouvrir les popups
    document.getElementById('productTrigger').addEventListener('click', openProductModal);
    document.getElementById('partTravauxTrigger').addEventListener('click', openPartTravauxModal);
    document.getElementById('endroitTrigger').addEventListener('click', openEndroitModal);
    document.getElementById('itemTrigger').addEventListener('click', openItemModal);

    // Note: Click outside to close d√©sactiv√© - seul le bouton Annuler ferme les popups

    // Fermer le dropdown custom quand on clique en dehors
    document.addEventListener('click', function(e) {
      // Chercher le modal o√π qu'il soit
      let productModal = document.getElementById('productModal');
      if (!productModal && window.parent) {
        const isNestedIframe = window.parent.parent && window.parent.parent !== window.parent;
        const rootWindow = isNestedIframe ? window.parent.parent : window.parent;
        if (rootWindow && rootWindow.document) {
          productModal = rootWindow.document.getElementById('productModal');
        }
      }
      if (!productModal) return;

      const customSelect = productModal.querySelector('#productEndroitSelect');
      if (customSelect && customSelect.classList.contains('open')) {
        // Si le clic n'est pas sur le custom-select, fermer le dropdown
        if (!e.target.closest('#productEndroitSelect')) {
          customSelect.classList.remove('open');
        }
      }
    });
  </script>

  <!-- Script de v√©rification du profil -->
  <script>
    // Fonction r√©utilisable pour v√©rifier le profil
    async function checkProfileComplete(username) {
      if (!username) {
        error("[WARN] Aucun username fourni pour v√©rification");
        return;
      }

      try {
        log('[DEBUG] V√©rification du profil pour:', username);
        const response = await fetch(`/api/check-profile-complete/${username}`);
        const result = await response.json();

        log('[OK] R√©sultat v√©rification profil:', result);

        if (!result.is_complete) {
          // Afficher l'avertissement
          const warningDiv = document.getElementById('profile-warning');
          const pageContent = document.getElementById('page-content');
          const pageHeader = document.getElementById('page-header');
          const missingList = document.getElementById('missing-list');
          const validList = document.getElementById('valid-list');
          const validItems = document.getElementById('valid-items');

          // Construire la liste des √©l√©ments manquants
          missingList.innerHTML = result.missing.map(item => `
            <li style="padding: 10px 0; color: var(--text-gray); font-size: 16px;">
              <i class="fas fa-times-circle" style="color: #f87171; margin-right: 10px;"></i>
              ${item}
            </li>
          `).join('');

          // Construire la liste des √©l√©ments valides
          if (result.valid && result.valid.length > 0) {
            validList.innerHTML = result.valid.map(item => `
              <li style="padding: 10px 0; color: var(--text-gray); font-size: 16px;">
                <i class="fas fa-check-circle" style="color: #34d399; margin-right: 10px;"></i>
                ${item}
              </li>
            `).join('');
            validItems.style.display = 'block';
          }

          // Afficher l'avertissement et cacher le contenu principal + header + soumissions √† envoyer
          warningDiv.style.display = 'block';
          pageContent.style.display = 'none';
          pageHeader.style.display = 'none';

          const pendingSoumissionsSection = document.getElementById('pending-soumissions-section');
          if (pendingSoumissionsSection) {
            pendingSoumissionsSection.style.display = 'none';
          }

          log('[WARN] Profil incomplet - √âl√©ments manquants:', result.missing, 'Valides:', result.valid);
        } else {
          log('[OK] Profil complet - Acc√®s autoris√©');
        }

      } catch (error) {
        error('[ERROR] Erreur v√©rification profil:', error);
        // En cas d'erreur, on laisse l'utilisateur acc√©der (fallback)
      }
    }

    // Appeler la v√©rification au chargement pour les entrepreneurs (pas les coaches/direction)
    document.addEventListener('DOMContentLoaded', function() {
      // Forcer le scroll en haut de la page au chargement
      window.scrollTo(0, 0);

      const userRole = localStorage.getItem('userRole');
      const isCoachOrDirection = userRole === 'coach' || userRole === 'direction';

      // Si on est PAS coach/direction, v√©rifier le profil imm√©diatement
      if (!isCoachOrDirection) {
        const username = localStorage.getItem("username");
        if (username) {
          checkProfileComplete(username);
        }
      }
      // Si on est coach/direction, la v√©rification sera faite apr√®s s√©lection d'entrepreneur
    });

    // ==================== SYST√àME DE TRADUCTION FR/EN ====================

    // √âtat de la langue courante (par d√©faut: fran√ßais)
    let currentLanguage = 'fr';

    // Fonction pour afficher l'animation de succ√®s
    function showSuccessAnimation(messageKey) {
      const messages = {
        'fr': {
          'presentation': 'Soumission pr√©sent√©e avec succ√®s!',
          'envoi': 'Soumission envoy√©e avec succ√®s!',
          'enregistrement': 'Soumission enregistr√©e avec succ√®s!'
        },
        'en': {
          'presentation': 'Quote presented successfully!',
          'envoi': 'Quote sent successfully!',
          'enregistrement': 'Quote saved successfully!'
        }
      };

      const message = messages[currentLanguage][messageKey];

      const overlay = document.createElement('div');
      overlay.className = 'success-overlay';
      overlay.innerHTML = `
        <div class="success-content">
          <div class="success-checkmark">
            <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
              <path d="M8 20 L16 28 L32 12" stroke="white" stroke-width="3"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">${message}</h2>
        </div>
      `;

      document.body.appendChild(overlay);

      setTimeout(() => {
        // V√©rifier si on est coach/direction avec un entrepreneur s√©lectionn√©
        const userRole = localStorage.getItem('userRole');
        const isCoachOrDirection = userRole === 'coach' || userRole === 'direction';
        const selectedEntrepreneur = window.selectedEntrepreneurUsername;

        if (isCoachOrDirection && selectedEntrepreneur) {
          // Ne pas recharger la page, juste r√©initialiser le formulaire
          overlay.remove();

          // Vider le formulaire
          if (typeof clearAllData === 'function') {
            clearAllData();
          }

          // Recharger les soumissions en attente
          if (typeof loadPendingSoumissions === 'function') {
            loadPendingSoumissions();
          }

          // G√©n√©rer un nouveau num√©ro
          if (typeof genererNumeroSoumission === 'function') {
            genererNumeroSoumission();
          }

          // R√©activer le bouton
          const btn = document.getElementById("submitBtn");
          const btnText = document.getElementById("btnText");
          if (btn) btn.disabled = false;
          if (btnText) btnText.textContent = "Cr√©er la soumission";
        } else {
          // Comportement normal pour entrepreneur
          window.location.reload();
        }
      }, 2000);
    }

    // Objet de traduction pour tous les textes du formulaire
    const translations = {
      // Section Information Client
      'Information client': 'Client Information',
      'Pr√©nom': 'First Name',
      'Nom': 'Last Name',
      'Adresse': 'Address',
      'T√©l√©phone': 'Phone',
      'Courriel': 'Email',
      'N¬∞ de soumission': 'Quote Number',
      'Date de cr√©ation': 'Creation Date',
      'Pay√© par': 'Paid by',
      'Virement Interac': 'Interac Transfer',
      'Ch√®que': 'Cheque',

      // Section Description des Travaux
      'Description des travaux': 'Work Description',
      'Endroit √† peinturer': 'Area to Paint',
      'Produits/Couleurs': 'Products/Colors',
      'Particularit√© des travaux': 'Work Specifications',

      // Section D√©tails des Travaux
      'D√©tails des travaux': 'Work Details',
      'Prix': 'Price',
      'Dur√©e des travaux': 'Work Duration',
      'Date des travaux': 'Work Date',

      // Placeholders
      'Ex: Jean': 'E.g.: John',
      'Ex: Dupont': 'E.g.: Smith',
      'Ex: 123 Rue de la Paix, Montr√©al, QC H2T 2L2': 'E.g.: 123 Peace Street, Montreal, QC H2T 2L2',
      'Ex: 514-029-2001': 'E.g.: 514-029-2001',
      'Ex: jean.dupont@email.com': 'E.g.: john.smith@email.com',
      'Chargement...': 'Loading...',
      'S√©lectionner une date': 'Select a date',
      'Ex: Salon, cuisine, chambres...': 'E.g.: Living room, kitchen, bedrooms...',
      'Cliquez pour s√©lectionner produits et couleurs...': 'Click to select products and colors...',
      'Cliquez pour s√©lectionner particularit√©s des travaux...': 'Click to select work specifications...',
      'Ex: 850$': 'E.g.: $850',
      'Ex: 2-3 jours': 'E.g.: 2-3 days',
      'Ex: mi-mai': 'E.g.: mid-May',
      'Ajoutez des d√©tails personnalis√©s...': 'Add custom details...',
      'Ajoutez des particularit√©s personnalis√©es...': 'Add custom specifications...',
      'Nom du template...': 'Template name...',
      'Nouveau nom...': 'New name...',

      // Boutons et messages
      'Veuillez remplir toutes les cases avant de pr√©senter au client': 'Please fill all fields before presenting to client',
      'Pr√©senter au client': 'Present to Client',
      'Envoyer au client': 'Send to Client',

      // Pop-ups
      'Produits/Couleurs': 'Products/Colors',
      'Particularit√© des travaux': 'Work Specifications',
      'Zone de texte': 'Text Area',
      'Annuler': 'Cancel',
      'Confirmer': 'Confirm',
      'Templates': 'Templates',
      '-- S√©lectionner --': '-- Select --',
      'Nouveau template': 'New Template',

      // Cat√©gories Pop-up Produits
      'Pr√©paration des surfaces': 'Surface Preparation',
      'Appr√™ts': 'Primers',
      'Peintures': 'Paints',
      'Teintures': 'Stains',
      'Finitions par surface': 'Finishes by Surface',

      // Cat√©gories Pop-up Particularit√©s
      'Assurances et certifications': 'Insurance and Certifications',
      'Services': 'Services',
      'Garanties': 'Warranties',

      // Options Pop-up Produits/Couleurs - Pr√©paration des surfaces
      'Lavage doux avec savon TSP': 'Gentle wash with TSP soap',
      'Lavage √† pression avec savon TSP': 'Pressure wash with TSP soap',
      'Sablage l√©ger': 'Light sanding',
      'Sablage mod√©r√©': 'Moderate sanding',
      'Sablage au bois': 'Wood sanding',
      'Sablage de surface': 'Surface sanding',
      'Grattage aux endroits n√©cessaires': 'Scraping where needed',
      'R√©parations mineures': 'Minor repairs',
      'Protection des surfaces': 'Surface protection',

      // Options Pop-up Produits/Couleurs - Appr√™ts
      'Application de une couche d\'appr√™t sur les murs de couleurs': 'Application of one coat of primer on colored walls',
      'Application de une couche d\'appr√™t au endroits rouill√©s': 'Application of one coat of primer on rusty areas',
      'Application d\'appr√™t par endroits, l√† o√π n√©cessaire': 'Spot primer application where needed',

      // Options Pop-up Produits/Couleurs - Peintures
      'Application de 2 couches de peinture': 'Application of 2 coats of paint',
      'Application de 2 couches de peinture diamant ext√©rieure': 'Application of 2 coats of exterior diamond paint',
      'Ajout d\'une 3e couche de finition n√©cessaire': 'Addition of a 3rd finishing coat if needed',
      'Ajout d\'une 3e couche de finition pourrait √™tre n√©cessaire, il en sera de la discr√©tion du client, le montant n√©cessaire √† d√©bourser sera discut√© avec le client avant de d√©cider si oui ou non, un troisi√®me couche de finition sera faite.': 'Addition of a 3rd finishing coat may be necessary, at client\'s discretion. Cost will be discussed before deciding whether a third coat will be applied.',

      // Options Pop-up Produits/Couleurs - Teintures
      'Application de 2 couches de teinture opaque': 'Application of 2 coats of opaque stain',
      'Application de 2 couche de teinture semi-transparente': 'Application of 2 coats of semi-transparent stain',
      'Application d\'une seule couche de teinture (produit monocouche ou demande du client)': 'Application of one coat of stain (single-coat product or client request)',
      'Application de deux couches de teinture wet on wet': 'Application of two coats of stain wet on wet',

      // Options Pop-up Produits/Couleurs - Finitions par surface
      'Mur: coquille d\'≈ìuf': 'Wall: eggshell',
      'Plafond: mat': 'Ceiling: matte',
      'Portes et moulures: perle': 'Doors and moldings: pearl',
      'Portes: perle': 'Doors: pearl',
      'Moulures: perle': 'Moldings: pearl',

      // Options Pop-up Particularit√©s - Assurances
      'Assurance responsabilit√© civile 2M$ + CNESST': 'Liability insurance $2M + CNESST',
      'Assurance responsabilit√© civile 2M$ + WSIB': 'Liability insurance $2M + WSIB',

      // Options Pop-up Particularit√©s - Services
      'Service cl√© en main (√©quipement, main d\'≈ìuvre)': 'Turnkey service (equipment, labor)',
      'Service cl√© en main (√©quipement, peinture, main d\'≈ìuvre)': 'Turnkey service (equipment, paint, labor)',
      'Produits fournis par le client': 'Products supplied by client',

      // Options Pop-up Particularit√©s - Garanties
      'Satisfaction garantie (25/75)': 'Satisfaction guaranteed (25/75)',
      'Garantie de 2 ans sur les travaux': '2-year warranty on work',

      // Options Pop-up Endroits √† peinturer - Ext√©rieur
      'Ext√©rieur': 'Exterior',
      'Rev√™tement': 'Siding',
      'Porte et fen√™tre': 'Door and Window',
      'Balcon': 'Balcony',
      'Corniche': 'Cornice',
      'Cl√¥ture': 'Fence',

      // Options Pop-up Endroits √† peinturer - Int√©rieur
      'Int√©rieur': 'Interior',
      'Chambre 1': 'Bedroom 1',
      'Chambre 2': 'Bedroom 2',
      'Chambre 3': 'Bedroom 3',
      'Chambre 4': 'Bedroom 4',
      'Chambre 5': 'Bedroom 5',
      'Chambre 6': 'Bedroom 6',
      'Chambre 7': 'Bedroom 7',
      'Chambre 8': 'Bedroom 8',
      'Salon 1': 'Living Room 1',
      'Salon 2': 'Living Room 2',
      'Salon 3': 'Living Room 3',
      'Cuisine 1': 'Kitchen 1',
      'Cuisine 2': 'Kitchen 2',
      'Cuisine 3': 'Kitchen 3',
      'Cuisine 4': 'Kitchen 4',
      'Salle de bain 1': 'Bathroom 1',
      'Salle de bain 2': 'Bathroom 2',
      'Salle de bain 3': 'Bathroom 3',
      'Salle de bain 4': 'Bathroom 4',
      'Couloir RDC': 'Ground Floor Hallway',
      'Couloir 1er √©tage': '1st Floor Hallway',
      'Couloir sous-sol': 'Basement Hallway',
      'Entr√©e': 'Entrance',
      'Cage d\'escaliers': 'Stairwell',
      'Salle √† manger': 'Dining Room',
      'Aire commune': 'Common Area',
      'Walk-in': 'Walk-in Closet',
      'Bureau': 'Office',

      // Options Pop-up Endroits √† peinturer - Fer forg√©
      'Fer forg√©': 'Wrought Iron',
      'Grinder la rouille sur le fer forg√©': 'Grind rust on wrought iron',
      'Grinder les √©cailles sur le fer forg√©': 'Grind scales on wrought iron',
      'Application d\'une couche de primer sur les endroits qui ont √©t√© grind√©s': 'Application of one coat of primer on ground areas',
      'Application de 2 couches de peinture Alkyde (√† l\'huile) Industrielle': 'Application of 2 coats of industrial Alkyd (oil-based) paint',

      // Item popup
      'Item': 'Item',
      'Cliquez pour ajouter les items...': 'Click to add items...',
      'Dur√©e approx.': 'Approx. Duration',
      'Nom de l\'item': 'Item Name',
      'Description de l\'item': 'Item Description',
      'Ex: Balcon, Porte...': 'E.g.: Balcony, Door...',
      'Ex: 500 $': 'E.g.: $500',
      'Ex: 1-2 jours': 'E.g.: 1-2 days',

      // Product popup
      'Pr√©paration / Produit': 'Preparation / Product',
      'Description par endroit': 'Description by location',
      'S√©lectionnez des options √† gauche ou √©crivez ici...': 'Select options on the left or write here...',

      // Endroit popup
      'Endroit √† peinturer': 'Area to Paint',
      'Endroits s√©lectionn√©s': 'Selected Locations',
      'Ajouter un endroit personnalis√©...': 'Add a custom location...',
      'Cliquez pour s√©lectionner les endroits √† peinturer...': 'Click to select areas to paint...',

      // Modals Templates
      'Nouveau template': 'New Template',
      'Modifier le template': 'Edit Template',
      'Supprimer le template': 'Delete Template',
      'Sauvegarder': 'Save',
      'Modifier': 'Edit',
      'Supprimer': 'Delete',

      // Options d'envoi
      'Envoyer maintenant': 'Send Now',
      'Ne pas envoyer maintenant': 'Do Not Send Now',

      // Boutons d'action
      'Voir en PDF': 'View PDF',
      'Enregistrer sans envoyer': 'Save Without Sending',
      'Pr√©senter au client': 'Present to Client',

      // Popup signature et pr√©sentation
      'Zone de signature - Zoom': 'Signature Area - Zoom',
      'Signez dans la zone indiqu√©e sur le PDF': 'Sign in the indicated area on the PDF',
      '‚úçÔ∏è Signez ici': '‚úçÔ∏è Sign here',
      '‚úçÔ∏è Cliquez pour signer': '‚úçÔ∏è Click to sign',
      'Effacer': 'Clear',
      'Valider': 'Validate',
      'Accepter la soumission': 'Accept Quote'
    };

    // Fonction pour changer la langue
    function changeLanguage(lang) {
      currentLanguage = lang;
      window.currentLanguage = lang;

      // Mettre √† jour le toggle visuel
      document.querySelectorAll('.lang-option').forEach(option => {
        option.classList.remove('active');
        if (option.dataset.lang === lang) {
          option.classList.add('active');
          option.style.background = 'linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)';
          option.style.color = 'var(--text-light)';
        } else {
          option.style.background = 'transparent';
          option.style.color = 'var(--text-gray)';
        }
      });

      // Traduire tous les labels
      document.querySelectorAll('label').forEach(label => {
        const text = label.textContent.trim();
        // Extraire le texte sans l'ic√¥ne
        const textWithoutIcon = text.replace(/^[^\w\s]+\s*/, '').trim();

        if (lang === 'en' && translations[textWithoutIcon]) {
          // Conserver l'ic√¥ne et remplacer le texte
          const icon = label.querySelector('i');
          if (icon) {
            label.innerHTML = '';
            label.appendChild(icon.cloneNode(true));
            label.appendChild(document.createTextNode(' ' + translations[textWithoutIcon]));
          } else {
            label.textContent = translations[textWithoutIcon];
          }
        } else if (lang === 'fr') {
          // Revenir au fran√ßais original - on doit recharger depuis le DOM original
          // Pour simplifier, on va juste traduire dans l'autre sens
          const enText = Object.keys(translations).find(key => translations[key] === textWithoutIcon);
          if (enText) {
            const icon = label.querySelector('i');
            if (icon) {
              label.innerHTML = '';
              label.appendChild(icon.cloneNode(true));
              label.appendChild(document.createTextNode(' ' + enText));
            } else {
              label.textContent = enText;
            }
          }
        }
      });

      // Traduire tous les placeholders
      document.querySelectorAll('input[placeholder], textarea[placeholder]').forEach(input => {
        const placeholder = input.getAttribute('placeholder');
        if (lang === 'en' && translations[placeholder]) {
          input.setAttribute('placeholder', translations[placeholder]);
        } else if (lang === 'fr') {
          const frText = Object.keys(translations).find(key => translations[key] === placeholder);
          if (frText) {
            input.setAttribute('placeholder', frText);
          }
        }
      });

      // Mettre √† jour le placeholder de l'adresse selon la province
      const adresseInput = document.getElementById('adresseAutocomplete');
      if (adresseInput) {
        if (lang === 'en') {
          // Ontario - exemple Toronto
          adresseInput.setAttribute('placeholder', 'E.g.: 123 Queen Street West, Toronto, ON M5H 3M9');
        } else {
          // Qu√©bec - exemple Montr√©al
          adresseInput.setAttribute('placeholder', 'Ex: 123 Rue de la Paix, Montr√©al, QC H2T 2L2');
        }
      }

      // Traduire les titres de section (h2.section-title)
      document.querySelectorAll('h2.section-title').forEach(title => {
        const text = title.textContent.trim();
        const textWithoutIcon = text.replace(/^[^\w\s]+\s*/, '').trim();

        if (lang === 'en' && translations[textWithoutIcon]) {
          const icon = title.querySelector('i');
          if (icon) {
            title.innerHTML = '';
            title.appendChild(icon.cloneNode(true));
            title.appendChild(document.createTextNode(' ' + translations[textWithoutIcon]));
          } else {
            title.textContent = translations[textWithoutIcon];
          }
        } else if (lang === 'fr') {
          const enText = Object.keys(translations).find(key => translations[key] === textWithoutIcon);
          if (enText) {
            const icon = title.querySelector('i');
            if (icon) {
              title.innerHTML = '';
              title.appendChild(icon.cloneNode(true));
              title.appendChild(document.createTextNode(' ' + enText));
            } else {
              title.textContent = enText;
            }
          }
        }
      });

      // Traduire les spans de texte dans les champs
      const productDisplay = document.getElementById('productDisplay');
      if (productDisplay && productDisplay.textContent.includes('Cliquez pour s√©lectionner')) {
        const key = 'Cliquez pour s√©lectionner produits et couleurs...';
        productDisplay.textContent = lang === 'en' ? translations[key] : key;
      }

      const partTravauxDisplay = document.getElementById('partTravauxDisplay');
      if (partTravauxDisplay && partTravauxDisplay.textContent.includes('Cliquez pour s√©lectionner')) {
        const key = 'Cliquez pour s√©lectionner particularit√©s des travaux...';
        partTravauxDisplay.textContent = lang === 'en' ? translations[key] : key;
      }

      // Traduire le placeholder du trigger Item
      const itemDisplay = document.getElementById('itemDisplay');
      if (itemDisplay && (itemDisplay.textContent.includes('Cliquez pour ajouter') || itemDisplay.textContent.includes('Click to add'))) {
        const key = 'Cliquez pour ajouter les items...';
        itemDisplay.textContent = lang === 'en' ? translations[key] : key;
      }

      // Traduire le placeholder du trigger Endroit
      const endroitDisplay = document.getElementById('endroitDisplay');
      if (endroitDisplay && (endroitDisplay.textContent.includes('Cliquez pour s√©lectionner les endroits') || endroitDisplay.textContent.includes('Click to select areas'))) {
        const key = 'Cliquez pour s√©lectionner les endroits √† peinturer...';
        endroitDisplay.textContent = lang === 'en' ? translations[key] : key;
      }

      // Traduire les options du dropdown "Pay√© par"
      document.querySelectorAll('#paidByMenu .dropdown-option').forEach(option => {
        const text = option.textContent.trim();
        if (lang === 'en' && translations[text]) {
          option.textContent = translations[text];
          option.setAttribute('data-value', translations[text]);
        } else if (lang === 'fr') {
          const frText = Object.keys(translations).find(key => translations[key] === text);
          if (frText) {
            option.textContent = frText;
            option.setAttribute('data-value', frText);
          }
        }
      });

      // Traduire le texte affich√© dans le toggle "Pay√© par"
      const paidByToggle = document.querySelector('#paidByToggle .tag');
      if (paidByToggle) {
        const currentText = paidByToggle.textContent.trim();
        if (lang === 'en' && translations[currentText]) {
          paidByToggle.textContent = translations[currentText];
        } else if (lang === 'fr') {
          const frText = Object.keys(translations).find(key => translations[key] === currentText);
          if (frText) {
            paidByToggle.textContent = frText;
          }
        }
      }

      // Traduire le message de validation
      const validationMessage = document.getElementById('validationMessage');
      if (validationMessage) {
        const textParts = validationMessage.innerHTML.split('</i>');
        if (textParts.length > 1) {
          const text = textParts[1].trim();
          if (lang === 'en' && translations[text]) {
            validationMessage.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i>' + translations[text];
          } else if (lang === 'fr') {
            const frText = Object.keys(translations).find(key => translations[key] === text);
            if (frText) {
              validationMessage.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i>' + frText;
            }
          }
        }
      }

      // Traduire le bouton "Pr√©senter au client"
      const voirPDFBtn = document.getElementById('voirPDFBtn');
      if (voirPDFBtn) {
        const textParts = voirPDFBtn.innerHTML.split('</i>');
        if (textParts.length > 1) {
          const text = textParts[1].trim();
          if (lang === 'en' && translations[text]) {
            voirPDFBtn.innerHTML = '<i class="fas fa-file-signature mr-2"></i>' + translations[text];
          } else if (lang === 'fr') {
            const frText = Object.keys(translations).find(key => translations[key] === text);
            if (frText) {
              voirPDFBtn.innerHTML = '<i class="fas fa-file-signature mr-2"></i>' + frText;
            }
          }
        }
      }

      // Traduire le bouton "Envoyer au client"
      const btnText = document.getElementById('btnText');
      if (btnText) {
        const text = btnText.textContent.trim();
        if (lang === 'en' && translations[text]) {
          btnText.textContent = translations[text];
        } else if (lang === 'fr') {
          const frText = Object.keys(translations).find(key => translations[key] === text);
          if (frText) {
            btnText.textContent = frText;
          }
        }
      }

      // Traduire les titres des pop-ups
      document.querySelectorAll('.popup-title').forEach(title => {
        const text = title.textContent.trim();
        const textWithoutIcon = text.replace(/^[^\w\s]+\s*/, '').trim();

        if (lang === 'en' && translations[textWithoutIcon]) {
          const icon = title.querySelector('i');
          if (icon) {
            title.innerHTML = '';
            title.appendChild(icon.cloneNode(true));
            title.appendChild(document.createTextNode(' ' + translations[textWithoutIcon]));
          } else {
            title.textContent = translations[textWithoutIcon];
          }
        } else if (lang === 'fr') {
          const enText = Object.keys(translations).find(key => translations[key] === textWithoutIcon);
          if (enText) {
            const icon = title.querySelector('i');
            if (icon) {
              title.innerHTML = '';
              title.appendChild(icon.cloneNode(true));
              title.appendChild(document.createTextNode(' ' + enText));
            } else {
              title.textContent = enText;
            }
          }
        }
      });

      // Traduire les cat√©gories des pop-ups
      document.querySelectorAll('.popup-category').forEach(category => {
        const text = category.textContent.trim();
        if (lang === 'en' && translations[text]) {
          category.textContent = translations[text];
        } else if (lang === 'fr') {
          const frText = Object.keys(translations).find(key => translations[key] === text);
          if (frText) {
            category.textContent = frText;
          }
        }
      });

      // Traduire "Zone de texte"
      document.querySelectorAll('h3').forEach(h3 => {
        const text = h3.textContent.trim();
        if (lang === 'en' && translations[text]) {
          h3.textContent = translations[text];
        } else if (lang === 'fr') {
          const frText = Object.keys(translations).find(key => translations[key] === text);
          if (frText) {
            h3.textContent = frText;
          }
        }
      });

      // Traduire les boutons Annuler et Confirmer dans les pop-ups
      document.querySelectorAll('.popup-buttons button').forEach(button => {
        const text = button.textContent.trim();
        if (lang === 'en' && translations[text]) {
          button.textContent = translations[text];
        } else if (lang === 'fr') {
          const frText = Object.keys(translations).find(key => translations[key] === text);
          if (frText) {
            button.textContent = frText;
          }
        }
      });

      // Traduire "Templates"
      document.querySelectorAll('span').forEach(span => {
        const text = span.textContent.trim();
        if (text === 'Templates' || text === translations['Templates']) {
          if (lang === 'en' && translations['Templates']) {
            span.textContent = translations['Templates'];
          } else if (lang === 'fr') {
            span.textContent = 'Templates';
          }
        }
      });

      // Traduire le placeholder du template dropdown
      const templatePlaceholder = document.querySelector('#templateToggle .placeholder');
      if (templatePlaceholder) {
        const text = templatePlaceholder.textContent.trim();
        if (lang === 'en' && translations[text]) {
          templatePlaceholder.textContent = translations[text];
        } else if (lang === 'fr') {
          const frText = Object.keys(translations).find(key => translations[key] === text);
          if (frText) {
            templatePlaceholder.textContent = frText;
          }
        }
      }

      // Traduire le bouton "Nouveau template"
      document.querySelectorAll('button[onclick="saveTemplatePrompt()"] span').forEach(span => {
        const text = span.textContent.trim();
        if (text === 'Nouveau template' || text === 'New Template') {
          if (lang === 'en') {
            span.textContent = 'New Template';
          } else {
            span.textContent = 'Nouveau template';
          }
        }
      });

      // Mettre √† jour l'option CNESST/WSIB selon la province AVANT de traduire
      if (window.clientProvince) {
        updateCNESSTOption(window.clientProvince);
      }

      // Traduire toutes les options des pop-ups (.popup-option span)
      document.querySelectorAll('.popup-option span').forEach(optionSpan => {
        const text = optionSpan.textContent.trim();
        if (lang === 'en' && translations[text]) {
          optionSpan.textContent = translations[text];
          // Mettre √† jour aussi le data-value du parent
          const parentOption = optionSpan.closest('.popup-option');
          if (parentOption) {
            parentOption.setAttribute('data-value', translations[text]);
          }
        } else if (lang === 'fr') {
          const frText = Object.keys(translations).find(key => translations[key] === text);
          if (frText) {
            optionSpan.textContent = frText;
            const parentOption = optionSpan.closest('.popup-option');
            if (parentOption) {
              parentOption.setAttribute('data-value', frText);
            }
          }
        }
      });

      // Traduire les titres des modals de templates
      document.querySelectorAll('#templateNameModal h3, #templateEditModal h3, #templateDeleteModal h3').forEach(modalTitle => {
        // Extraire le texte sans l'ic√¥ne
        const textParts = modalTitle.innerHTML.split('</i>');
        if (textParts.length > 1) {
          const text = textParts[1].trim();
          if (lang === 'en' && translations[text]) {
            const iconHTML = textParts[0] + '</i>';
            modalTitle.innerHTML = iconHTML + ' ' + translations[text];
          } else if (lang === 'fr') {
            const frText = Object.keys(translations).find(key => translations[key] === text);
            if (frText) {
              const iconHTML = textParts[0] + '</i>';
              modalTitle.innerHTML = iconHTML + ' ' + frText;
            }
          }
        }
      });

      // Traduire les boutons des modals de templates
      document.querySelectorAll('#templateNameModal button, #templateEditModal button, #templateDeleteModal button').forEach(btn => {
        // Ignorer les boutons avec ic√¥nes, on traduit juste le texte
        const textParts = btn.innerHTML.split('</i>');
        if (textParts.length > 1) {
          const text = textParts[1].trim();
          if (lang === 'en' && translations[text]) {
            const iconHTML = textParts[0] + '</i>';
            btn.innerHTML = iconHTML + ' ' + translations[text];
          } else if (lang === 'fr') {
            const frText = Object.keys(translations).find(key => translations[key] === text);
            if (frText) {
              const iconHTML = textParts[0] + '</i>';
              btn.innerHTML = iconHTML + ' ' + frText;
            }
          }
        } else {
          // Bouton sans ic√¥ne
          const text = btn.textContent.trim();
          if (lang === 'en' && translations[text]) {
            btn.textContent = translations[text];
          } else if (lang === 'fr') {
            const frText = Object.keys(translations).find(key => translations[key] === text);
            if (frText) {
              btn.textContent = frText;
            }
          }
        }
      });

      // Traduire le bouton "Pr√©senter au client"
      const pdfBtn = document.getElementById('voirPDFBtn');
      if (pdfBtn) {
        // Bouton "Pr√©senter au client" - toujours en mode pr√©sentation
        const iconHTML = '<i class="fas fa-file-signature mr-2"></i>';
        if (lang === 'en') {
          pdfBtn.innerHTML = iconHTML + 'Present to Client';
        } else {
          pdfBtn.innerHTML = iconHTML + 'Pr√©senter au client';
        }
      }

      // Traduire le bouton "Enregistrer sans envoyer"
      const saveOnlyBtn = document.getElementById('saveOnlyBtn');
      if (saveOnlyBtn) {
        const btnSpan = saveOnlyBtn.querySelector('span');
        if (btnSpan) {
          if (lang === 'en') {
            btnSpan.textContent = 'Save Without Sending';
          } else {
            btnSpan.textContent = 'Enregistrer sans envoyer';
          }
        }
      }

      // Traduire les √©l√©ments du popup de signature zoom
      const signatureZoomTitle = document.querySelector('#signatureZoomPopup div[style*="font-size: 18px"]');
      if (signatureZoomTitle) {
        const textParts = signatureZoomTitle.innerHTML.split('</i>');
        if (textParts.length > 1) {
          let text = textParts[1].trim();
          // Enlever l'espace initial si pr√©sent
          text = text.replace(/^\s+/, '');
          if (lang === 'en' && translations[text]) {
            const iconHTML = textParts[0] + '</i>';
            signatureZoomTitle.innerHTML = iconHTML + '\n        ' + translations[text];
          } else if (lang === 'fr') {
            const frText = Object.keys(translations).find(key => translations[key] === text);
            if (frText) {
              const iconHTML = textParts[0] + '</i>';
              signatureZoomTitle.innerHTML = iconHTML + '\n        ' + frText;
            }
          }
        }
      }

      // Traduire le sous-titre du popup signature
      const signatureZoomSubtitle = document.querySelector('#signatureZoomPopup div[style*="font-size: 12px"]');
      if (signatureZoomSubtitle) {
        const text = signatureZoomSubtitle.textContent.trim();
        if (lang === 'en' && translations[text]) {
          signatureZoomSubtitle.textContent = translations[text];
        } else if (lang === 'fr') {
          const frText = Object.keys(translations).find(key => translations[key] === text);
          if (frText) {
            signatureZoomSubtitle.textContent = frText;
          }
        }
      }

      // Traduire le hint de signature dans le popup
      const signatureZoomHint = document.getElementById('signatureZoomHint');
      if (signatureZoomHint) {
        const text = signatureZoomHint.textContent.trim();
        if (lang === 'en' && translations[text]) {
          signatureZoomHint.textContent = translations[text];
        } else if (lang === 'fr') {
          const frText = Object.keys(translations).find(key => translations[key] === text);
          if (frText) {
            signatureZoomHint.textContent = frText;
          }
        }
      }

      // Traduire le hint "Cliquez pour signer"
      const signatureHint = document.getElementById('signatureHint');
      if (signatureHint) {
        const text = signatureHint.textContent.trim();
        if (lang === 'en' && translations[text]) {
          signatureHint.textContent = translations[text];
        } else if (lang === 'fr') {
          const frText = Object.keys(translations).find(key => translations[key] === text);
          if (frText) {
            signatureHint.textContent = frText;
          }
        }
      }

      // Traduire tous les boutons du popup signature (Effacer, Annuler, Valider)
      document.querySelectorAll('#signatureZoomPopup button span').forEach(btnSpan => {
        const text = btnSpan.textContent.trim();
        if (lang === 'en' && translations[text]) {
          btnSpan.textContent = translations[text];
        } else if (lang === 'fr') {
          const frText = Object.keys(translations).find(key => translations[key] === text);
          if (frText) {
            btnSpan.textContent = frText;
          }
        }
      });

      // Traduire le bouton "Accepter la soumission"
      const acceptPresentationBtn = document.getElementById('acceptPresentationBtn');
      if (acceptPresentationBtn) {
        const btnSpan = acceptPresentationBtn.querySelector('span');
        if (btnSpan) {
          const text = btnSpan.textContent.trim();
          if (lang === 'en' && translations[text]) {
            btnSpan.textContent = translations[text];
          } else if (lang === 'fr') {
            const frText = Object.keys(translations).find(key => translations[key] === text);
            if (frText) {
              btnSpan.textContent = frText;
            }
          }
        }
      }

      // Traduire le popup Pr√©paration/Produit
      const productModal = document.getElementById('productModal');
      if (productModal) {
        // Traduire le placeholder du textarea
        const productTextarea = productModal.querySelector('#productEndroitTextarea');
        if (productTextarea) {
          if (lang === 'en') {
            productTextarea.setAttribute('placeholder', 'Select options on the left or write here...');
          } else {
            productTextarea.setAttribute('placeholder', 'S√©lectionnez des options √† gauche ou √©crivez ici...');
          }
        }

        // Traduire "Description par endroit"
        const descSpan = productModal.querySelector('.popup-right h3 span:first-child');
        if (descSpan && !descSpan.id) {
          if (lang === 'en') {
            descSpan.textContent = 'Description by location';
          } else {
            descSpan.textContent = 'Description par endroit';
          }
        }
      }

      // Traduire le popup Item
      const itemModal = document.getElementById('itemModal');
      if (itemModal) {
        // Traduire les headers du tableau
        const headers = itemModal.querySelectorAll('thead th');
        if (headers.length >= 3) {
          if (lang === 'en') {
            headers[0].textContent = 'Item';
            headers[1].textContent = 'Price';
            headers[2].textContent = 'Approx. Duration';
          } else {
            headers[0].textContent = 'Item';
            headers[1].textContent = 'Prix';
            headers[2].textContent = 'Dur√©e approx.';
          }
        }

        // Traduire les placeholders des inputs dans le tableau
        itemModal.querySelectorAll('.item-name-input').forEach(input => {
          if (lang === 'en') {
            input.setAttribute('placeholder', 'E.g.: Balcony, Door...');
          } else {
            input.setAttribute('placeholder', 'Ex: Balcon, Porte...');
          }
        });

        itemModal.querySelectorAll('.item-prix-input').forEach(input => {
          if (lang === 'en') {
            input.setAttribute('placeholder', 'E.g.: $500');
          } else {
            input.setAttribute('placeholder', 'Ex: 500 $');
          }
        });

        itemModal.querySelectorAll('.item-duree-input').forEach(input => {
          if (lang === 'en') {
            input.setAttribute('placeholder', 'E.g.: 1-2 days');
          } else {
            input.setAttribute('placeholder', 'Ex: 1-2 jours');
          }
        });
      }

      // Traduire le popup Endroit √† peinturer
      const endroitModal = document.getElementById('endroitModal');
      if (endroitModal) {
        // Traduire "Endroits s√©lectionn√©s"
        const selectedTitle = endroitModal.querySelector('.popup-right h3');
        if (selectedTitle) {
          if (lang === 'en') {
            selectedTitle.textContent = 'Selected Locations';
          } else {
            selectedTitle.textContent = 'Endroits s√©lectionn√©s';
          }
        }

        // Traduire le placeholder de l'input personnalis√©
        const customInput = endroitModal.querySelector('#customEndroitInput');
        if (customInput) {
          if (lang === 'en') {
            customInput.setAttribute('placeholder', 'Add a custom location...');
          } else {
            customInput.setAttribute('placeholder', 'Ajouter un endroit personnalis√©...');
          }
        }
      }

      // Sauvegarder la pr√©f√©rence de langue dans le backend
      saveLanguagePreference(lang);

      log(`[LANG] Langue chang√©e vers: ${lang === 'fr' ? 'Fran√ßais' : 'English'}`);
    }

    // Fonction pour sauvegarder la pr√©f√©rence de langue
    async function saveLanguagePreference(lang) {
      try {
        const username = window.username || localStorage.getItem('username');
        if (!username) {
          warn('[LANG] Aucun username trouv√©, impossible de sauvegarder la pr√©f√©rence');
          return;
        }

        const response = await fetch(`${window.location.origin}/save-language-preference`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: username,
            language: lang
          })
        });

        if (response.ok) {
          log(`[LANG] Pr√©f√©rence de langue sauvegard√©e: ${lang}`);
        } else {
          error('[LANG] Erreur lors de la sauvegarde de la pr√©f√©rence');
        }
      } catch (error) {
        error('[LANG] Erreur lors de la sauvegarde:', error);
      }
    }

    // Fonction pour charger la pr√©f√©rence de langue
    async function loadLanguagePreference() {
      try {
        const username = window.username || localStorage.getItem('username');
        if (!username) {
          warn('[LANG] Aucun username trouv√©, utilisation de la langue par d√©faut (fran√ßais)');
          return;
        }

        const response = await fetch(`${window.location.origin}/get-language-preference?username=${username}`);

        if (response.ok) {
          const data = await response.json();
          const savedLang = data.language || 'fr';
          log(`[LANG] Pr√©f√©rence charg√©e: ${savedLang}`);

          // FORCER la province selon la langue sauvegard√©e
          // EN = Ontario (WSIB), FR = Qu√©bec (CNESST)
          const forcedProvince = savedLang === 'en' ? 'ON' : 'QC';
          window.clientProvince = forcedProvince;
          log('[LANG] Province FORC√âE selon langue:', forcedProvince, '| Langue:', savedLang);

          // Appliquer la langue sauvegard√©e
          if (savedLang !== 'fr') {
            changeLanguage(savedLang);
          }

          // Mettre √† jour l'option CNESST/WSIB selon la province forc√©e
          if (typeof window.updateCNESSTOption === 'function') {
            window.updateCNESSTOption(forcedProvince);
            log('[LANG] updateCNESSTOption appel√© avec province forc√©e:', forcedProvince);
          } else {
            warn('[LANG] updateCNESSTOption n\'est pas disponible au chargement');
          }
        }
      } catch (error) {
        error('[LANG] Erreur lors du chargement de la pr√©f√©rence:', error);
      }
    }

    // Initialiser les √©v√©nements du toggle
    document.addEventListener('DOMContentLoaded', function() {
      // Fonction commune pour g√©rer le changement de langue
      const handleLanguageChange = function(lang) {
        log('[TOGGLE LANG] üîÑ Click d√©tect√© - langue:', lang);

        // FORCER la province selon la langue s√©lectionn√©e
        // EN = Ontario (WSIB), FR = Qu√©bec (CNESST)
        const forcedProvince = lang === 'en' ? 'ON' : 'QC';
        window.clientProvince = forcedProvince;
        log('[TOGGLE LANG] üó∫Ô∏è Province FORC√âE selon langue:', forcedProvince, '| Langue:', lang);

        // Mettre √† jour l'option CNESST/WSIB selon la province forc√©e
        if (typeof window.updateCNESSTOption === 'function') {
          log('[TOGGLE LANG] ‚úÖ Appel de updateCNESSTOption avec province:', forcedProvince);
          window.updateCNESSTOption(forcedProvince);
        } else {
          error('[TOGGLE LANG] ‚ùå window.updateCNESSTOption n\'est pas une fonction!');
        }

        log('[TOGGLE LANG] üåê Appel de changeLanguage avec langue:', lang);
        changeLanguage(lang);

        // R√©initialiser Google autocomplete avec les bons bounds (selon la province forc√©e)
        if (typeof window.initProspectAutocomplete === 'function') {
          window.initProspectAutocomplete();
          log('[TOGGLE LANG] üó∫Ô∏è Google autocomplete r√©initialis√© pour', forcedProvince);
        }

        // Synchroniser les deux toggles (desktop et mobile)
        document.querySelectorAll('.lang-option, .lang-option-mobile').forEach(opt => {
          opt.classList.remove('active');
          if (opt.dataset.lang === lang) {
            opt.classList.add('active');
            opt.style.background = 'linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)';
            opt.style.color = 'var(--text-light)';
          } else {
            opt.style.background = 'transparent';
            opt.style.color = 'var(--text-gray)';
          }
        });
      };

      // Toggle desktop
      document.querySelectorAll('.lang-option').forEach(option => {
        option.addEventListener('click', function() {
          handleLanguageChange(this.dataset.lang);
        });
      });

      // Toggle mobile
      document.querySelectorAll('.lang-option-mobile').forEach(option => {
        option.addEventListener('click', function() {
          handleLanguageChange(this.dataset.lang);
        });
      });

      // Appliquer le style actif initial aux deux toggles (desktop et mobile)
      document.querySelectorAll('.lang-option.active, .lang-option-mobile.active').forEach(activeOpt => {
        activeOpt.style.background = 'linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)';
        activeOpt.style.color = 'var(--text-light)';
      });

      // Charger la pr√©f√©rence de langue sauvegard√©e
      loadLanguagePreference();
    });

    // Global function for entrepreneur selector to reload data
    window.loadSoumissionData = async function() {
      log("üîÑ Rechargement COMPLET des donn√©es Soumission pour l'entrepreneur s√©lectionn√©:", window.username);

      // Supprimer l'anti-flash CSS pour rendre le contenu visible
      const antiFlashStyle = document.getElementById('coach-anti-flash-css');
      if (antiFlashStyle) {
        antiFlashStyle.remove();
        log('[SOUMISSION] Anti-flash CSS supprim√©');
      }

      // 1. Vider tous les champs du formulaire
      if (typeof clearAllData === 'function') {
        clearAllData();
        log('[SOUMISSION] Formulaire r√©initialis√©');
      }

      // 2. Recharger les soumissions en attente
      await loadPendingSoumissions();

      // 3. G√©n√©rer un nouveau num√©ro de soumission pour l'entrepreneur
      if (typeof genererNumeroSoumission === 'function') {
        await genererNumeroSoumission();
        log('[SOUMISSION] Num√©ro de soumission r√©g√©n√©r√©');
      }

      log('[SOUMISSION] Interface COMPL√àTEMENT recharg√©e pour:', window.username);
    };

    // Charger les donn√©es du client depuis localStorage (r√©cup√©ration client perdu ou prospect)
    document.addEventListener('DOMContentLoaded', function() {
      log('[SOUMISSION] üîç DOMContentLoaded - V√©rification localStorage...');
      const clientData = localStorage.getItem('clientSoumission');
      log('[SOUMISSION] üì¶ clientSoumission trouv√©:', clientData ? 'Oui' : 'Non');

      if (clientData) {
        try {
          const data = JSON.parse(clientData);
          log('[SOUMISSION] üìã Chargement donn√©es client:', data);

          // Attendre que tous les champs soient disponibles
          setTimeout(() => {
            log('[SOUMISSION] üîÑ D√©but du remplissage des champs...');

            // Remplir les champs du formulaire en utilisant querySelector avec name
            if (data.prenom) {
              const prenomField = document.querySelector('input[name="prenom"]');
              log('[SOUMISSION] üîç Champ prenom trouv√©:', prenomField ? 'Oui' : 'Non');
              if (prenomField) {
                prenomField.value = data.prenom;
                prenomField.style.setProperty('border-right-color', '#4caf50', 'important');
                log('[SOUMISSION] ‚úÖ Prenom rempli:', data.prenom);
              }
            }
            if (data.nom) {
              const nomField = document.querySelector('input[name="nom"]');
              log('[SOUMISSION] üîç Champ nom trouv√©:', nomField ? 'Oui' : 'Non');
              if (nomField) {
                nomField.value = data.nom;
                nomField.style.setProperty('border-right-color', '#4caf50', 'important');
                log('[SOUMISSION] ‚úÖ Nom rempli:', data.nom);
              }
            }
            if (data.telephone) {
              const telephoneField = document.querySelector('input[name="telephone"]');
              log('[SOUMISSION] üîç Champ telephone trouv√©:', telephoneField ? 'Oui' : 'Non');
              if (telephoneField) {
                telephoneField.value = data.telephone;
                telephoneField.style.setProperty('border-right-color', '#4caf50', 'important');
                log('[SOUMISSION] ‚úÖ Telephone rempli:', data.telephone);
              }
            }
            if (data.adresse) {
              const adresseField = document.querySelector('input[name="adresse"]');
              log('[SOUMISSION] üîç Champ adresse trouv√©:', adresseField ? 'Oui' : 'Non');
              if (adresseField) {
                adresseField.value = data.adresse;
                adresseField.style.setProperty('border-right-color', '#4caf50', 'important');
                log('[SOUMISSION] ‚úÖ Adresse remplie:', data.adresse);

                // L'adresse est remplie mais NE CHANGE PAS l'option CNESST/WSIB
                // Seuls les toggles de langue contr√¥lent l'assurance
                log('[SOUMISSION] üìç Adresse remplie (SANS changer CNESST/WSIB):', data.adresse);
              }
            }
            if (data.courriel) {
              const courrielField = document.querySelector('input[name="courriel"]');
              log('[SOUMISSION] üîç Champ courriel trouv√©:', courrielField ? 'Oui' : 'Non');
              if (courrielField) {
                courrielField.value = data.courriel;
                courrielField.style.setProperty('border-right-color', '#4caf50', 'important');
                log('[SOUMISSION] ‚úÖ Courriel rempli:', data.courriel);
              }
            }
            if (data.date2) {
              const date2Field = document.querySelector('input[name="date_travaux"]');
              log('[SOUMISSION] üîç Champ date_travaux trouv√©:', date2Field ? 'Oui' : 'Non');
              if (date2Field) {
                date2Field.value = data.date2;
                log('[SOUMISSION] ‚úÖ Date travaux remplie:', data.date2);
              }
            }
            // Pay√© par (dropdown toggle) - Par d√©faut "Virement Interac" si non sp√©cifi√©
            const payerPar = data.payer_par || 'Virement Interac';
            const paidByToggle = document.getElementById('paidByToggle');
            log('[SOUMISSION] üîç Champ paidByToggle trouv√©:', paidByToggle ? 'Oui' : 'Non');
            if (paidByToggle) {
              paidByToggle.innerHTML = `<span class="tag">${payerPar}</span>`;
              paidByToggle.style.setProperty('border-right-color', '#4caf50', 'important');
              if (window.dropdownStates) {
                window.dropdownStates.paidBy = payerPar;
              }
              log('[SOUMISSION] ‚úÖ Pay√© par (toggle) rempli:', payerPar);
            }

            // Prix - CHAMP CRITIQUE
            if (data.prix) {
              log('[SOUMISSION] üí∞ Prix d√©tect√© dans data:', data.prix, 'Type:', typeof data.prix);
              const prixField = document.querySelector('input[name="prix"]');
              log('[SOUMISSION] üîç Champ prix trouv√©:', prixField ? 'Oui' : 'Non');
              if (prixField) {
                // Formater le prix: enlever .00 si pr√©sent, enlever $ si pr√©sent (le champ le formate automatiquement)
                let prixFormate = data.prix.toString();
                // Enlever le $ s'il est pr√©sent
                prixFormate = prixFormate.replace('$', '').trim();
                // Enlever .00 si pr√©sent
                if (prixFormate.endsWith('.00')) {
                  prixFormate = prixFormate.replace('.00', '');
                }
                log('[SOUMISSION] üí∞ Prix format√©:', prixFormate);
                prixField.value = prixFormate;

                // D√©clencher les √©v√©nements pour activer le formatage automatique
                prixField.dispatchEvent(new Event('input', { bubbles: true }));
                prixField.dispatchEvent(new Event('blur', { bubbles: true }));
                prixField.dispatchEvent(new Event('change', { bubbles: true }));

                prixField.style.setProperty('border-right-color', '#4caf50', 'important');
                log('[SOUMISSION] ‚úÖ Prix rempli:', data.prix, '‚Üí', prixFormate, 'Valeur dans champ:', prixField.value);
              }
            } else {
              log('[SOUMISSION] ‚ö†Ô∏è Aucun prix dans les donn√©es');
            }

            if (data.temps) {
              const tempsField = document.querySelector('input[name="temps"]');
              log('[SOUMISSION] üîç Champ temps trouv√©:', tempsField ? 'Oui' : 'Non');
              if (tempsField) {
                tempsField.value = data.temps;
                tempsField.style.setProperty('border-right-color', '#4caf50', 'important');
                log('[SOUMISSION] ‚úÖ Temps rempli:', data.temps);
              }
            }
            if (data.endroit) {
              const endroitField = document.querySelector('textarea[name="endroit_peinture"]');
              log('[SOUMISSION] üîç Champ endroit_peinture trouv√©:', endroitField ? 'Oui' : 'Non');
              if (endroitField) {
                endroitField.value = data.endroit;
                log('[SOUMISSION] ‚úÖ Endroit rempli:', data.endroit);
              }
            }

            // Produit/Couleurs (popup avec champ cach√©)
            if (data.produit) {
              const produitHidden = document.getElementById('produitCouleursHidden');
              const produitTrigger = document.getElementById('productTrigger');
              const produitDisplay = document.getElementById('productDisplay');
              log('[SOUMISSION] üîç Champs produit trouv√©s - Hidden:', produitHidden ? 'Oui' : 'Non', 'Trigger:', produitTrigger ? 'Oui' : 'Non', 'Display:', produitDisplay ? 'Oui' : 'Non');
              if (produitHidden) {
                produitHidden.value = data.produit;
                // METTRE √Ä JOUR L'AFFICHAGE VISIBLE
                if (produitDisplay) {
                  produitDisplay.textContent = data.produit;
                  produitDisplay.style.color = 'var(--text-light)';
                  log('[SOUMISSION] üé® Affichage produit mis √† jour');
                }
                // Ne pas mettre la bordure verte ici - laisser updateProductCounter d√©cider
                log('[SOUMISSION] ‚úÖ Produit rempli:', data.produit);
              }
            }

            // Particularit√©s travaux (popup avec champ cach√©)
            if (data.part) {
              const partHidden = document.getElementById('partTravauxHidden');
              const partTrigger = document.getElementById('partTravauxTrigger');
              const partDisplay = document.getElementById('partTravauxDisplay');
              log('[SOUMISSION] üîç Champs part trouv√©s - Hidden:', partHidden ? 'Oui' : 'Non', 'Trigger:', partTrigger ? 'Oui' : 'Non', 'Display:', partDisplay ? 'Oui' : 'Non');
              if (partHidden) {
                partHidden.value = data.part;
                // METTRE √Ä JOUR L'AFFICHAGE VISIBLE
                if (partDisplay) {
                  partDisplay.textContent = data.part;
                  partDisplay.style.color = 'var(--text-light)';
                  log('[SOUMISSION] üìã Affichage particularit√©s mis √† jour');
                }
                if (partTrigger) {
                  partTrigger.style.setProperty('border-right-color', '#4caf50', 'important');
                }
                log('[SOUMISSION] ‚úÖ Part rempli:', data.part);
              }
            }

            // Stocker l'ID du client perdu si pr√©sent (pour suppression apr√®s soumission)
            if (data.client_perdu_id) {
              sessionStorage.setItem('client_perdu_id', data.client_perdu_id);
              log('[SOUMISSION] ‚úÖ ID client perdu stock√©:', data.client_perdu_id);
            }

            // Nettoyer le localStorage apr√®s chargement
            localStorage.removeItem('clientSoumission');

            // ========== LOGS D√âTAILL√âS DE PRE-FILL COMPL√âT√â ==========
            log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            log('[SOUMISSION] ‚úÖ‚úÖ‚úÖ PRE-FILL COMPL√âT√â AVEC SUCC√àS ‚úÖ‚úÖ‚úÖ');
            log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

            // R√©sum√© des champs remplis
            const champsRemplis = [];
            const champsCritiques = {
              prix: data.prix || null,
              produit: data.produit || null,
              part: data.part || null
            };

            if (data.prenom) champsRemplis.push('‚úì Pr√©nom: ' + data.prenom);
            if (data.nom) champsRemplis.push('‚úì Nom: ' + data.nom);
            if (data.telephone) champsRemplis.push('‚úì T√©l√©phone: ' + data.telephone);
            if (data.adresse) champsRemplis.push('‚úì Adresse: ' + data.adresse);
            if (data.courriel) champsRemplis.push('‚úì Courriel: ' + data.courriel);
            if (data.date2) champsRemplis.push('‚úì Date travaux: ' + data.date2);
            if (data.payer_par) champsRemplis.push('‚úì Pay√© par: ' + data.payer_par);
            if (data.temps) champsRemplis.push('‚úì Temps: ' + data.temps);
            if (data.endroit) champsRemplis.push('‚úì Endroit: ' + data.endroit);

            // Logs pour les champs critiques
            log('[CHAMPS CRITIQUES] V√©rification des champs probl√©matiques:');
            log('  üí∞ PRIX:', champsCritiques.prix ? '‚úÖ ' + champsCritiques.prix : '‚ùå NON REMPLI');
            log('  üé® PRODUIT/COULEURS:', champsCritiques.produit ? '‚úÖ ' + (champsCritiques.produit.length > 50 ? champsCritiques.produit.substring(0, 50) + '...' : champsCritiques.produit) : '‚ùå NON REMPLI');
            log('  üìã PARTICULARIT√âS:', champsCritiques.part ? '‚úÖ ' + (champsCritiques.part.length > 50 ? champsCritiques.part.substring(0, 50) + '...' : champsCritiques.part) : '‚ùå NON REMPLI');

            // Log de tous les champs standards
            log('[CHAMPS STANDARDS] Total de champs remplis:', champsRemplis.length);
            champsRemplis.forEach(champ => log('  ' + champ));

            // V√©rifier les valeurs dans les champs DOM
            log('[V√âRIFICATION DOM] Valeurs r√©elles dans les champs:');
            const prixFieldDOM = document.querySelector('input[name="prix"]');
            const produitHiddenDOM = document.getElementById('produitCouleursHidden');
            const partHiddenDOM = document.getElementById('partTravauxHidden');

            if (prixFieldDOM) {
              log('  üí∞ Prix (DOM):', prixFieldDOM.value || '‚ùå VIDE');
            }
            if (produitHiddenDOM) {
              log('  üé® Produit (DOM):', produitHiddenDOM.value ? produitHiddenDOM.value.substring(0, 50) + '...' : '‚ùå VIDE');
            }
            if (partHiddenDOM) {
              log('  üìã Part (DOM):', partHiddenDOM.value ? partHiddenDOM.value.substring(0, 50) + '...' : '‚ùå VIDE');
            }

            // Log de l'ID client perdu si pr√©sent
            if (data.client_perdu_id) {
              log('[CLIENT PERDU] üîó ID stock√© en session:', data.client_perdu_id);
            }

            log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            log('[SOUMISSION] üßπ localStorage nettoy√©');
            log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

            // D√©clencher la validation des champs
            setTimeout(() => validateRequiredFields(), 100);
          }, 500);
        } catch (error) {
          error('[SOUMISSION] ‚ùå Erreur chargement donn√©es client:', error);
          localStorage.removeItem('clientSoumission');
        }
      } else {
        log('[SOUMISSION] ‚ÑπÔ∏è Aucune donn√©e clientSoumission √† charger');
      }
    });
  </script>

  <!-- Script commun de gestion des permissions et interface -->
  <script src="/common.js"></script>
</div> <!-- Fermeture main-content -->

  <!-- Spinner de chargement pour navigation -->
  <div id="navigation-spinner" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0f172a; z-index: 9999; align-items: center; justify-content: center;">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
      <!-- Spinner SVG anim√© -->
      <svg width="64" height="64" viewBox="0 0 64 64" style="animation: spin 0.8s linear infinite;">
        <circle cx="32" cy="32" r="28" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="6"/>
        <circle cx="32" cy="32" r="28" fill="none" stroke="#3b82f6" stroke-width="6" stroke-dasharray="140" stroke-dashoffset="40" stroke-linecap="round" style="transform-origin: center; transform: rotate(-90deg);"/>
      </svg>
      <p style="margin-top: 1rem; color: #94a3b8; font-size: 0.875rem;">Chargement...</p>
    </div>
  </div>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <script src="/entrepreneur-selector.js"></script>
</body>
</html>






